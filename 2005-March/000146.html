<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto/ecrire articles.php3,1.3,1.4 articles_versions.php3,1.2,1.3 articles_edit.php3,1.3,1.4 aide_index.php3,1.2,1.3 admin_vider.php3,1.3,1.4 auteurs_edit.php3,1.3,1.4 articles_forum.php3,1.2,1.3 auteur_infos.php3,1.3,1.4
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-March/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/ecrire%20articles.php3%2C1.3%2C1.4%20articles_versions.php3%2C1.2%2C1.3%20articles_edit.php3%2C1.3%2C1.4%20aide_index.php3%2C1.2%2C1.3%20admin_vider.php3%2C1.3%2C1.4%20auteurs_edit.php3%2C1.3%2C1.4%20articles_forum.php3%2C1.2%2C1.3%20auteur_infos.php3%2C1.3%2C1.4&In-Reply-To=%3C200503291526.j2TFQ09Y001195%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000144.html">
   <LINK REL="Next"  HREF="000145.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto/ecrire articles.php3,1.3,1.4 articles_versions.php3,1.2,1.3 articles_edit.php3,1.3,1.4 aide_index.php3,1.2,1.3 admin_vider.php3,1.3,1.4 auteurs_edit.php3,1.3,1.4 articles_forum.php3,1.2,1.3 auteur_infos.php3,1.3,1.4</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/ecrire%20articles.php3%2C1.3%2C1.4%20articles_versions.php3%2C1.2%2C1.3%20articles_edit.php3%2C1.3%2C1.4%20aide_index.php3%2C1.2%2C1.3%20admin_vider.php3%2C1.3%2C1.4%20auteurs_edit.php3%2C1.3%2C1.4%20articles_forum.php3%2C1.2%2C1.3%20auteur_infos.php3%2C1.3%2C1.4&In-Reply-To=%3C200503291526.j2TFQ09Y001195%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto/ecrire articles.php3,1.3,1.4 articles_versions.php3,1.2,1.3 articles_edit.php3,1.3,1.4 aide_index.php3,1.2,1.3 admin_vider.php3,1.3,1.4 auteurs_edit.php3,1.3,1.4 articles_forum.php3,1.2,1.3 auteur_infos.php3,1.3,1.4">stef at berlios.de
       </A><BR>
    <I>Tue Mar 29 17:26:00 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000144.html">[Spip-carto-cvs] spipcarto carto_svg2.php3,NONE,1.1 inc-compilo-index.php3,1.3,1.4 inc-compilo.php3,1.3,1.4 spip_cookie.php3,1.4,1.5 spip_admin.css,1.3,1.4 inc-compilo-api.php3,1.3,1.4 .htaccess,1.1,1.2 inc-criteres.php3,1.3,1.4 inc-messforum.php3,1.4,1.5 inc-public-global.php3,1.5,1.6 backend-breves.php3,1.3,1.4 inc-cache.php3,1.6,1.7 inc-balises.php3,1.5,1.6 inc-html-squel.php3,1.3,1.4 inc-stats.php3,1.3,1.4 backend.php3,1.3,1.4 mes_fonctions.php3,1.7,1.8 inc-calcul.php3,1.3,1.4
</A></li>
        <LI>Next message: <A HREF="000145.html">[Spip-carto-cvs] spipcarto/ecrire calendrier.css,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#146">[ date ]</a>
              <a href="thread.html#146">[ thread ]</a>
              <a href="subject.html#146">[ subject ]</a>
              <a href="author.html#146">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv1134/spipcarto/ecrire

Modified Files:
	articles.php3 articles_versions.php3 articles_edit.php3 
	aide_index.php3 admin_vider.php3 auteurs_edit.php3 
	articles_forum.php3 auteur_infos.php3 
Log Message:
1.8PR2 CVS 20050329

Index: articles.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- articles.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ articles.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -195,8 +195,8 @@
 	$varname = &quot;texte$nb_texte&quot;;
 	$texte_plus = $$varname;	// double $ pour obtenir $texte1, $texte2...
 	if ($texte_plus){
-		$texte_plus = ereg_replace(&quot;&lt;!--SPIP--&gt;[\n\r]*&quot;,&quot;\n\n\n&quot;,$texte_plus);
-		$texte_ajout .= &quot; &quot;.$texte_plus;
+		$texte_plus = ereg_replace(&quot;&lt;!--SPIP--&gt;[\n\r]*&quot;,&quot;&quot;,$texte_plus);
+		$texte_ajout .= $texte_plus;
 	} else {
 		break;
 	}
@@ -239,9 +239,9 @@
 	if ($articles_versions) {
 		include(&quot;lab_revisions.php&quot;);
 		if  ($new != 'oui') {
-			spip_log(&quot;version initiale de l'article $id_article&quot;);
 			$query = &quot;SELECT id_article FROM spip_versions WHERE id_article=$id_article LIMIT 0,1&quot;;
 			if (!spip_num_rows(spip_query($query))) {
+				spip_log(&quot;version initiale de l'article $id_article&quot;);
 				$select = join(&quot;, &quot;, $champs);
 				$query = &quot;SELECT $select FROM spip_articles WHERE id_article=$id_article&quot;;
 				$champs_originaux = spip_fetch_array(spip_query($query));
@@ -445,13 +445,14 @@
 	debut_cadre_relief(&quot;forum-interne-24.gif&quot;);
 	$visible = $change_accepter_forum || $change_petition;
 
-	echo &quot;&lt;font size='2' FACE='Verdana,Arial,Sans,sans-serif'&gt;&lt;center&gt;&lt;b&gt;&quot;;
+
+	echo &quot;&lt;div class='verdana1' style='text-align: center;'&gt;&lt;b&gt;&quot;;
 	if ($visible)
 		echo bouton_block_visible(&quot;forumpetition&quot;);
 	else
 		echo bouton_block_invisible(&quot;forumpetition&quot;);
 	echo _T('bouton_forum_petition');
-	echo &quot;&lt;/b&gt;&lt;/center&gt;&lt;/font&gt;&quot;;
+	echo &quot;&lt;/b&gt;&lt;/div&gt;&quot;;
 	if ($visible)
 		echo debut_block_visible(&quot;forumpetition&quot;);
 	else
@@ -512,7 +513,7 @@
 		echo &quot;&lt;label for='accepterforumnon'&gt; &quot;._T('info_pas_de_forum').&quot;&lt;/label&gt;&quot;;
 	}
 
-	echo &quot;&lt;div align='right'&gt;&lt;input type='submit' name='Changer' class='fondo' value='&quot;._T('bouton_changer').&quot;' STYLE='font-size:10px'&gt;&lt;/div&gt;\n&quot;;
+	echo &quot;&lt;div align='$spip_lang_right'&gt;&lt;input type='submit' name='Changer' class='fondo' value='&quot;._T('bouton_changer').&quot;' STYLE='font-size:10px'&gt;&lt;/div&gt;\n&quot;;
 	echo &quot;&lt;/form&gt;&quot;;
 
 	echo &quot;&lt;br&gt;&quot;;
@@ -604,7 +605,7 @@
 		echo &quot;&lt;label for='petitionoff'&gt;&quot;._T('bouton_radio_supprimer_petition').&quot;&lt;/label&gt;&quot;;
 	}
 
-	echo &quot;&lt;P align='right'&gt;&lt;INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='&quot;._T('bouton_changer').&quot;' STYLE='font-size:10px'&gt;&quot;;
+	echo &quot;&lt;P align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='&quot;._T('bouton_changer').&quot;' STYLE='font-size:10px'&gt;&quot;;
 	echo &quot;&lt;/FORM&gt;&quot;;
 
 	echo &quot;&lt;/font&gt;&quot;;
@@ -612,21 +613,20 @@
 
 	fin_cadre_relief();
 
-	echo &quot;&lt;br&gt;&quot;;
 
 
 	// Redirection (article virtuel)
 	debut_cadre_relief(&quot;site-24.gif&quot;);
 	$visible = ($changer_virtuel || $virtuel);
 
-	echo &quot;&lt;font size='2' FACE='Verdana,Arial,Sans,sans-serif'&gt;&lt;center&gt;&lt;b&gt;&quot;;
+	echo &quot;&lt;div class='verdana1' style='text-align: center;'&gt;&lt;b&gt;&quot;;
 	if ($visible)
 		echo bouton_block_visible(&quot;redirection&quot;);
 	else
 		echo bouton_block_invisible(&quot;redirection&quot;);
 	echo _T('bouton_redirection');
 	echo aide (&quot;artvirt&quot;);
-	echo &quot;&lt;/b&gt;&lt;/center&gt;&lt;/font&gt;&quot;;
+	echo &quot;&lt;/b&gt;&lt;/div&gt;&quot;;
 	if ($visible)
 		echo debut_block_visible(&quot;redirection&quot;);
 	else
@@ -641,7 +641,7 @@
 	echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
 	echo &quot;(&lt;b&gt;&quot;._T('texte_article_virtuel').&quot;&nbsp;:&lt;/b&gt; &quot;._T('texte_reference_mais_redirige').&quot;)&quot;;
 	echo &quot;&lt;/font&gt;&quot;;
-	echo &quot;&lt;div align='right'&gt;&lt;INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='&quot;._T('bouton_changer').&quot;' STYLE='font-size:10px'&gt;&lt;/div&gt;&quot;;
+	echo &quot;&lt;div align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='&quot;._T('bouton_changer').&quot;' STYLE='font-size:10px'&gt;&lt;/div&gt;&quot;;
 	echo &quot;&lt;/form&gt;&quot;;
 	echo fin_block();
 
@@ -749,7 +749,7 @@
 
 
 if ($descriptif OR $url_site OR $nom_site) {
-	echo &quot;&lt;p&gt;&lt;div align='left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;' $dir_lang&gt;&quot;;
+	echo &quot;&lt;p&gt;&lt;div align='$spip_lang_left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;' $dir_lang&gt;&quot;;
 	echo &quot;&lt;font size=2 face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
 	$texte_case = ($descriptif) ? &quot;{{&quot;._T('info_descriptif').&quot;}} $descriptif\n\n&quot; : '';
 	$texte_case .= ($nom_site.$url_site) ? &quot;{{&quot;._T('info_urlref').&quot;}} [&quot;.$nom_site.&quot;-&gt;&quot;.$url_site.&quot;]&quot; : '';
@@ -809,7 +809,7 @@
 
 
 echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
-echo &quot;&lt;div class='serif' align='left'&gt;&quot;;
+echo &quot;&lt;div class='serif' align='$spip_lang_left'&gt;&quot;;
 
 //
 // Affichage date redac et date publi
@@ -862,7 +862,7 @@
 		echo debut_block_invisible('dateredac');
 		echo &quot;&lt;div style='margin: 5px; margin-$spip_lang_left: 20px;'&gt;&quot;;
 		echo '&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot;&gt;';
-		echo '&lt;tr&gt;&lt;td align=&quot;left&quot;&gt;';
+		echo '&lt;tr&gt;&lt;td align=&quot;$spip_lang_left&quot;&gt;';
 		echo '&lt;input type=&quot;radio&quot; name=&quot;avec_redac&quot; value=&quot;non&quot; id=&quot;avec_redac_on&quot;';
 		if ($annee_redac.'-'.$mois_redac.'-'.$jour_redac == '0000-00-00') echo ' checked=&quot;checked&quot;';
 		echo &quot; onClick=\&quot;setvisibility('valider_date_prec', 'visible')\&quot;&quot;;
@@ -880,7 +880,7 @@
 		echo '&lt;/select&gt; &nbsp;';
 		echo &quot;&lt;input type='text' name='annee_redac' class='fondl' value='&quot;.$annee_redac.&quot;' size='5' maxlength='4' onClick=\&quot;setvisibility('valider_date_prec', 'visible')\&quot;/&gt;&quot;;
 
-		echo '&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;';
+		echo '&lt;/td&gt;&lt;td align=&quot;$spip_lang_right&quot;&gt;';
 		echo &quot;&lt;span class='visible_au_chargement' id='valider_date_prec'&gt;&quot;;
 		echo '&lt;input type=&quot;submit&quot; name=&quot;Changer&quot; class=&quot;fondo&quot; value=&quot;'._T('bouton_changer').'&quot; /&gt;';
 		echo &quot;&lt;/span&gt;&quot;;
@@ -948,7 +948,7 @@
 //
 
 if ($cherche_auteur) {
-	echo &quot;&lt;P ALIGN='left'&gt;&quot;;
+	echo &quot;&lt;P ALIGN='$spip_lang_left'&gt;&quot;;
 	$query = &quot;SELECT id_auteur, nom FROM spip_auteurs&quot;;
 	$result = spip_query($query);
 	unset($table_auteurs);
@@ -1019,6 +1019,9 @@
 		$titre = urlencode($cherche_auteur);
 		icone_horizontale(_T('icone_creer_auteur'), &quot;auteur_infos.php3?new=oui&amp;ajouter_id_article=$id_article&amp;titre=$titre&amp;redirect=$retour&quot;, &quot;redacteurs-24.gif&quot;, &quot;creer.gif&quot;);
 		echo &quot;&lt;/div&gt; &quot;;
+
+		// message pour ne pas afficher le second bouton &quot;creer un auteur&quot;
+		$supprimer_bouton_creer_auteur = true;
 	}
 
 	fin_boite_info();
@@ -1150,7 +1153,11 @@
 	
 	echo &quot;&lt;table width='100%'&gt;&quot;;
 	echo &quot;&lt;tr&gt;&quot;;
-	if ($connect_statut == '0minirezo' AND acces_rubrique($rubrique_article) AND $options == &quot;avancees&quot;) {
+
+	if ($connect_statut == '0minirezo'
+	AND acces_rubrique($rubrique_article)
+	AND $options == &quot;avancees&quot;
+	AND !$supprimer_bouton_creer_auteur) {
 		echo &quot;&lt;td width='200'&gt;&quot;;
 		$retour = urlencode($clean_link-&gt;getUrl());
 		icone_horizontale(_T('icone_creer_auteur'), &quot;auteur_infos.php3?new=oui&amp;ajouter_id_article=$id_article&amp;redirect=$retour&quot;, &quot;redacteurs-24.gif&quot;, &quot;creer.gif&quot;);
@@ -1292,7 +1299,11 @@
 			$id_trad = 0;
 		}
 
-		if ($connect_statut=='0minirezo' AND $id_trad_new &gt; 0) { // Changer article de reference de la trad
+		// Changer article de reference de la trad
+		if ($id_trad_new = intval($id_trad_new)
+		AND $id_trad_old = intval($id_trad_old)
+		AND $connect_statut=='0minirezo'
+		AND $connect_toutes_rubriques) { 
 			spip_query(&quot;UPDATE spip_articles SET id_trad = $id_trad_new WHERE id_trad = $id_trad_old&quot;);
 			$id_trad = $id_trad_new;
 		}
@@ -1357,20 +1368,23 @@
 				  $vals[] = http_img_pack('langues-12.gif', &quot;&quot;, &quot;width='12' height='12' border='0'&quot;);
 					$titre_trad = &quot;&lt;b&gt;$titre_trad&lt;/b&gt;&quot;;
 				} else {
-				  if ($connect_statut=='0minirezo') $vals[] = &quot;&lt;a href='articles.php3?id_article=$id_article&amp;id_trad_old=$id_trad&amp;id_trad_new=$id_article_trad'&gt;&quot;. 
-				    http_img_pack('langues-off-12.gif', &quot;&quot;, &quot;width='12' height='12' border='0'&quot;) . &quot;&lt;/a&gt;&quot;;
+				  if ($connect_statut=='0minirezo'
+				  AND $connect_toutes_rubriques)
+				  	$vals[] = &quot;&lt;a href='articles.php3?id_article=$id_article&amp;id_trad_old=$id_trad&amp;id_trad_new=$id_article_trad'&gt;&quot;. 
+				    http_img_pack('langues-off-12.gif', _T('trad_reference'), &quot;width='12' height='12' border='0'&quot;, _T('trad_reference')) . &quot;&lt;/a&gt;&quot;;
 				  else $vals[] = http_img_pack('langues-off-12.gif', &quot;&quot;, &quot;width='12' height='12' border='0'&quot;);
 				}
 
 				$ret .= &quot;&lt;/td&gt;&quot;;
 
-				if ($id_article_trad == $id_article) $s = &quot;$titre_trad&quot;;
-				else $s = &quot;&lt;a href='articles.php3?id_article=$id_article_trad'&gt;$titre_trad&lt;/a&gt;&quot;;
-				if ($id_article_trad == $id_trad) $s .= &quot; &quot;._T(&quot;trad_reference&quot;);
-				$vals[] = $s;
+				$s = typo($titre_trad);
+				if ($id_article_trad != $id_article) 
+					$s = &quot;&lt;a href='articles.php3?id_article=$id_article_trad'&gt;$s&lt;/a&gt;&quot;;
+				if ($id_article_trad == $id_trad)
+					$s .= &quot; &quot;._T('trad_reference');
 
+				$vals[] = $s;
 				$vals[] = traduire_nom_langue($lang_trad);
-			
 				$table[] = $vals;
 			}
 
@@ -1408,7 +1422,7 @@
 
 			echo &quot;&lt;form action='$lien' method='post' style='margin:0px; padding:0px;'&gt;&quot;;
 			echo _T('trad_lier');
-			echo &quot;&lt;div align='right'&gt;&lt;input type='text' class='fondl' name='lier_trad' size='5'&gt; &lt;INPUT TYPE='submit' NAME='Modifier' VALUE='&quot;._T('bouton_modifier').&quot;' CLASS='fondl'&gt;&lt;/div&gt;&quot;;
+			echo &quot;&lt;div align='$spip_lang_right'&gt;&lt;input type='text' class='fondl' name='lier_trad' size='5'&gt; &lt;INPUT TYPE='submit' NAME='Modifier' VALUE='&quot;._T('bouton_modifier').&quot;' CLASS='fondl'&gt;&lt;/div&gt;&quot;;
 			echo &quot;&lt;/form&gt;&quot;;
 			echo &quot;&lt;/td&gt;\n&quot;;
 			echo &quot;&lt;td background='' width='10'&gt; &nbsp; &lt;/td&gt;&quot;;
@@ -1552,7 +1566,7 @@
 //
 
 if ($flag_editable) {
-	echo &quot;\n\n&lt;div align=right&gt;&lt;br&gt;&quot;;
+	echo &quot;\n\n&lt;div align='$spip_lang_right'&gt;&lt;br&gt;&quot;;
 	
 	if ($date_diff &gt;= 0 AND $date_diff &lt; 60 AND $auteur_modif &gt; 0 AND $auteur_modif != $connect_id_auteur) {
 		$query_auteur = &quot;SELECT * FROM spip_auteurs WHERE id_auteur='$auteur_modif'&quot;;
@@ -1614,7 +1628,7 @@
 	icone(_T('icone_poster_message'), &quot;forum_envoi.php3?statut=prive&amp;adresse_retour=&quot;.$forum_retour.&quot;&amp;id_article=$id_article&amp;titre_message=&quot;.urlencode($titre), &quot;forum-interne-24.gif&quot;, &quot;creer.gif&quot;);
 echo &quot;&lt;/div&gt;&quot;;
 
-echo &quot;&lt;P align='left'&gt;&quot;;
+echo &quot;&lt;P align='$spip_lang_left'&gt;&quot;;
 
 
 $query_forum = &quot;SELECT COUNT(*) AS cnt FROM spip_forum WHERE statut='prive' AND id_article='$id_article' AND id_parent=0&quot;;

Index: articles_versions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_versions.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- articles_versions.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ articles_versions.php3	29 Mar 2005 15:25:58 -0000	1.3
@@ -107,6 +107,11 @@
 debut_gauche();
 
 
+debut_raccourcis();
+icone_horizontale(_T('icone_retour_article'), &quot;articles.php3?id_article=$id_article&quot;, &quot;article-24.gif&quot;,&quot;rien.gif&quot;);
+icone_horizontale(_T('icone_suivi_revisions'), &quot;suivi_revisions.php3&quot;, &quot;historique-24.gif&quot;,&quot;rien.gif&quot;);
+fin_raccourcis();
+
 
 //////////////////////////////////////////////////////
 // Affichage de la colonne de droite
@@ -170,7 +175,17 @@
 echo &quot;&lt;/td&gt;&quot;;
 
 echo &quot;&lt;td align='center'&gt;&quot;;
-icone(_T('icone_retour_article'), &quot;articles.php3?id_article=$id_article&quot;, &quot;&quot;, &quot;article-24.gif&quot;);
+
+// L'article est-il editable ?
+$query = &quot;SELECT * FROM spip_auteurs_articles WHERE id_article=$id_article AND id_auteur=$connect_id_auteur&quot;;
+$result_auteur = spip_query($query);
+$flag_auteur = (spip_num_rows($result_auteur) &gt; 0);
+$flag_editable = (acces_rubrique($id_rubrique)
+	OR ($flag_auteur AND ($statut_article == 'prepa' OR $statut_article == 'prop' OR $statut_article == 'poubelle')));
+
+if ($flag_editable)
+	icone(_T('icone_modifier_article'), &quot;articles_edit.php3?id_article=$id_article&quot;, &quot;article-24.gif&quot;, &quot;edit.gif&quot;);
+
 echo &quot;&lt;/td&gt;&quot;;
 
 echo &quot;&lt;/tr&gt;&lt;/table&gt;&quot;;
@@ -249,17 +264,17 @@
 	else {
 		echo &quot;&lt;div $dir_lang&gt;&lt;b&gt;&quot;;
 		$revision_nbsp = ($options == &quot;avancees&quot;);	// a regler pour relecture des nbsp dans les articles
-		echo justifier(propre($chapo));
+		echo justifier(propre_diff($chapo));
 		echo &quot;&lt;/b&gt;&lt;/div&gt;\n\n&quot;;
 	
 		echo &quot;&lt;div $dir_lang&gt;&quot;;
-		echo justifier(propre($texte));
+		echo justifier(propre_diff($texte));
 		echo &quot;&lt;/div&gt;&quot;;
 	
 		if ($ps) {
 			echo debut_cadre_enfonce();
 			echo &quot;&lt;div $dir_lang&gt;&lt;font size='2' face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
-			echo justifier(&quot;&lt;b&gt;&quot;._T('info_ps').&quot;&lt;/b&gt; &quot;.propre($ps));
+			echo justifier(&quot;&lt;b&gt;&quot;._T('info_ps').&quot;&lt;/b&gt; &quot;.propre_diff($ps));
 			echo &quot;&lt;/font&gt;&lt;/div&gt;&quot;;
 			echo fin_cadre_enfonce();
 		}

Index: articles_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_edit.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- articles_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ articles_edit.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -10,6 +10,7 @@
  *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
 \***************************************************************************/
 
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_documents.php3&quot;);
 include_ecrire (&quot;inc_barre.php3&quot;);
@@ -35,9 +36,6 @@
 //
 
 if ($id_article) {
-	spip_query(&quot;UPDATE spip_articles SET date_modif=NOW(), auteur_modif=$connect_id_auteur WHERE id_article=$id_article&quot;);
-	$id_article_bloque = $id_article;	// message pour inc_presentation
-
 	// Recuperer les donnees de l'article
 	$query = &quot;SELECT * FROM spip_articles WHERE id_article=$id_article&quot;;
 	$result = spip_query($query);
@@ -146,6 +144,13 @@
 }
 
 
+// Qui veut modifier l'article ?
+spip_query(&quot;UPDATE spip_articles SET date_modif=NOW(), auteur_modif=$connect_id_auteur WHERE id_article=$id_article&quot;);
+$id_article_bloque = $id_article;	// message pour inc_presentation
+
+
+
+
 //
 // Gestion des textes trop longs (limitation brouteurs)
 //
@@ -153,16 +158,20 @@
 function coupe_trop_long($texte){	// utile pour les textes &gt; 32ko
 	if (strlen($texte) &gt; 28*1024) {
 		$texte = str_replace(&quot;\r\n&quot;,&quot;\n&quot;,$texte);
-		$pos = strpos($texte, &quot;\n\n\n&quot;, 28*1024);	// coupe para &gt; 28 ko
+		$pos = strpos($texte, &quot;\n\n&quot;, 28*1024);	// coupe para &gt; 28 ko
 		if ($pos &gt; 0 and $pos &lt; 32 * 1024) {
-			$debut = substr($texte, 0, $pos).&quot;\n\n\n&lt;!--SPIP--&gt;\n&quot;;
-			$suite = substr($texte, $pos + 3);
+			$debut = substr($texte, 0, $pos).&quot;\n\n&lt;!--SPIP--&gt;\n&quot;;
+			$suite = substr($texte, $pos + 2);
 		} else {
 			$pos = strpos($texte, &quot; &quot;, 28*1024);	// sinon coupe espace
-			if (!($pos &gt; 0 and $pos &lt; 32 * 1024))
-				$pos = 28*1024;	// au pire
-			$debut = substr($texte,0,$pos);
-			$suite = substr($texte,$pos + 1);
+			if (!($pos &gt; 0 and $pos &lt; 32 * 1024)) {
+				$pos = 28*1024;	// au pire (pas d'espace trouv'e)
+				$decalage = 0; // si y'a pas d'espace, il ne faut pas perdre le caract`ere
+			} else {
+				$decalage = 1;
+			}
+			$debut = substr($texte,0,$pos + $decalage); // Il faut conserver l'espace s'il y en a un
+			$suite = substr($texte,$pos + $decalage);
 		}
 		return (array($debut,$suite));
 	}

Index: aide_index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/aide_index.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- aide_index.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ aide_index.php3	29 Mar 2005 15:25:58 -0000	1.3
@@ -33,6 +33,7 @@
 include_ecrire (&quot;inc_lang.php3&quot;);
 utiliser_langue_visiteur();
 if ($var_lang) changer_langue($var_lang);
+if ($lang) changer_langue($lang); # pour le cas ou on a fait appel au menu de changement de langue (aide absente dans la langue x)
 
 /////////////////////////////
 // La frame de base
@@ -110,6 +111,15 @@
 	// Recuperation du contenu de l'aide demandee
 	$html = analyse_aide($html, $aide);
 
+	if (!$html) {
+		include_ecrire('inc_presentation.php3');
+		install_debut_html(_T('forum_titre_erreur'));
+		echo &quot;&lt;div&gt;&quot;._T('aide_non_disponible').&quot;&lt;/div&gt;&quot;;
+		echo &quot;&lt;div align='right'&gt;&quot;.menu_langues('var_lang_ecrire').&quot;&lt;/div&gt;&quot;;
+		install_fin_html();
+		exit;
+	}
+
 	// Recherche des images de l'aide
 	$suite = $html;
 	$html = &quot;&quot;;
@@ -445,6 +455,7 @@
 			include_ecrire('inc_presentation.php3');
 			install_debut_html(_T('forum_titre_erreur'));
 			echo &quot;&lt;div&gt;&quot;._T('aide_non_disponible').&quot;&lt;/div&gt;&quot;;
+			echo &quot;&lt;div align='right'&gt;&quot;.menu_langues('var_lang_ecrire').&quot;&lt;/div&gt;&quot;;
 			install_fin_html();
 			exit;
 		}

Index: admin_vider.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_vider.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- admin_vider.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ admin_vider.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -71,7 +71,7 @@
 echo &quot;\n&lt;INPUT TYPE='hidden' NAME='hash' VALUE='&quot; . calculer_action_auteur(&quot;purger_cache&quot;) . &quot;'&gt;&quot;;
 echo &quot;\n&lt;INPUT TYPE='hidden' NAME='purger_cache' VALUE='oui'&gt;&quot;;
 echo &quot;\n&lt;INPUT TYPE='hidden' NAME='redirect' VALUE='&quot; . _DIR_RESTREINT_ABS . &quot;admin_vider.php3'&gt;&quot;;
-echo &quot;\n&lt;p&gt;&lt;DIV align='right'&gt;&lt;INPUT CLASS='fondo' TYPE='submit' NAME='valider' VALUE=\&quot;&quot;._T('bouton_vider_cache').&quot;\&quot;&gt;&lt;/FORM&gt;&lt;/DIV&gt;&quot;;
+echo &quot;\n&lt;p&gt;&lt;DIV align='right'&gt;&lt;INPUT CLASS='fondo' TYPE='submit' NAME='valider' VALUE=\&quot;&quot;.str_replace('&quot;', '&quot;', _T('bouton_vider_cache')).&quot;\&quot;&gt;&lt;/FORM&gt;&lt;/DIV&gt;&quot;;
 echo &quot;&lt;/TD&gt;&lt;/TR&gt;&quot;;
 echo &quot;&lt;/TABLE&gt;&quot;;
 

Index: auteurs_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteurs_edit.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- auteurs_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ auteurs_edit.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -154,6 +154,7 @@
 	// Afficher le formulaire de changement de statut (cf. inc_acces.php3)
 	if ($options == 'avancees')
 		afficher_formulaire_statut_auteur ($id_auteur,
+			$row['statut'],
 			&quot;auteurs_edit.php3?id_auteur=$id_auteur&quot;);
 
 	fin_cadre_relief();

Index: articles_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_forum.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- articles_forum.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ articles_forum.php3	29 Mar 2005 15:25:58 -0000	1.3
@@ -111,7 +111,14 @@
 $mots_cles_forums = lire_meta(&quot;mots_cles_forums&quot;);
 
 if ($connect_statut == &quot;0minirezo&quot;) {
-	$query_forum = &quot;SELECT * FROM spip_forum WHERE id_article='$id_article' AND id_parent=0 AND statut IN ('publie', 'off', 'prop') ORDER BY date_heure DESC LIMIT $debut, $pack&quot;;
+	$query_forum = &quot;SELECT pied.*, max(thread.date_heure) AS date
+		FROM spip_forum AS pied, spip_forum AS thread
+		WHERE pied.id_article='$id_article'
+		AND pied.id_parent=0
+		AND pied.statut IN ('publie', 'off', 'prop')
+		AND thread.id_thread=pied.id_forum
+		GROUP BY id_thread
+		ORDER BY date DESC LIMIT $debut, $pack&quot;;
 	$result_forum = spip_query($query_forum);
 	afficher_forum($result_forum, $forum_retour, $id_article);
 }

Index: auteur_infos.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteur_infos.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- auteur_infos.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ auteur_infos.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -70,7 +70,7 @@
 		$auteur['nom'] = filtrer_entites(_T('item_nouvel_auteur'));
 		$onfocus = &quot; onfocus=\&quot;if(!antifocus){this.value='';antifocus=true;}\&quot;&quot;;
 	}
-	$auteur['statut'] = '1comite';
+	$auteur['statut'] = '1comite'; // statut par defaut a la creation
 	$auteur['source'] = 'spip';
 }
 
@@ -405,7 +405,7 @@
 
 
 // Afficher le formulaire de changement de statut (cf. inc_acces.php3)
-afficher_formulaire_statut_auteur ($id_auteur);
+afficher_formulaire_statut_auteur ($id_auteur, $auteur['statut']);
 
 
 echo &quot;&lt;INPUT NAME='ajouter_id_article' VALUE='$ajouter_id_article' TYPE='hidden'&gt;\n&quot;;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000144.html">[Spip-carto-cvs] spipcarto carto_svg2.php3,NONE,1.1 inc-compilo-index.php3,1.3,1.4 inc-compilo.php3,1.3,1.4 spip_cookie.php3,1.4,1.5 spip_admin.css,1.3,1.4 inc-compilo-api.php3,1.3,1.4 .htaccess,1.1,1.2 inc-criteres.php3,1.3,1.4 inc-messforum.php3,1.4,1.5 inc-public-global.php3,1.5,1.6 backend-breves.php3,1.3,1.4 inc-cache.php3,1.6,1.7 inc-balises.php3,1.5,1.6 inc-html-squel.php3,1.3,1.4 inc-stats.php3,1.3,1.4 backend.php3,1.3,1.4 mes_fonctions.php3,1.7,1.8 inc-calcul.php3,1.3,1.4
</A></li>
	<LI>Next message: <A HREF="000145.html">[Spip-carto-cvs] spipcarto/ecrire calendrier.css,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#146">[ date ]</a>
              <a href="thread.html#146">[ thread ]</a>
              <a href="subject.html#146">[ subject ]</a>
              <a href="author.html#146">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
