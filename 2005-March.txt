From fxp at berlios.de  Tue Mar  1 18:36:14 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:36:14 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_carto.php3,1.7,1.8
Message-ID: <200503011736.j21HaENx009009@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv9002/ecrire

Modified Files:
	inc_carto.php3 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche

Index: inc_carto.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_carto.php3,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- inc_carto.php3	25 Feb 2005 12:01:54 -0000	1.7
+++ inc_carto.php3	1 Mar 2005 17:36:11 -0000	1.8
@@ -5,11 +5,34 @@
 if (defined("_ECRIRE_INC_CARTE")) return;
 define("_ECRIRE_INC_CARTE", "1");
 
+// TODO : Faut il rendre fixe la taille de l'interface DHTML ?
+
 // Conversion coordonn?es interface DHTML -> WKT
-function coords2wkt($selection_type,$selection_coords){
-	return $selection_type."(".str_replace (';',',',str_replace (',',' ',$selection_coords)).")";
+// 	- Modification des s?parateurs d?cimaux & s?parateurs de paires de coordonn?es
+// 	- Calcul des Y par rapport au coin inf?rieur
+//  TODO : Calcul des coordonn?es dans l'espace (pas de reprojection en terme de SIG)
+function coords2wkt(	$selection_type,
+						$selection_coords, 
+						$callageGeo = ""){
+	$GeoWidth 	= ($callageGeo['bottom_right']['x']-$callageGeo['top_left']['x']);
+	$GeoHeight 	= ($callageGeo['bottom_right']['y']-$callageGeo['top_left']['y']);
+		
+	$coordpair = explode (';',$selection_coords);
+	
+	for ($i=0; $i<sizeof($coordpair); $i++)
+	{		
+		$coord[$i] 		= explode(',',$coordpair[$i]);
+		$coord[$i][0] 	= $coord[$i][0];
+		$coord[$i][1] 	= $GeoHeight-$coord[$i][1];		// Calcul de l'Y par rapport au coin inf?rieur
+		$coordpair[$i] 	= implode(' ',$coord[$i]);
+	}
+	$wktCoords = implode(',', $coordpair);
+	
+	return $selection_type."(".$wktCoords.")";			// G?om?trie au format WKT
 }
 
+
+
 // D?finition du callage ? partir de la dimension de l'image
 function array2worldfile($mArray){	
 	return "polygon(0 0,".$mArray['largeur']." ".$mArray['hauteur'].")";
@@ -102,8 +125,13 @@
 
 
 function afficher_carte_interface($id_carte,$retour,$fichier,$callage) {
-	$width=$callage['bottom_right']['x']-$callage['top_left']['x'];
-	$height=$callage['bottom_right']['y']-$callage['top_left']['y'];
+	
+	$widthgeo=$callage['bottom_right']['x']-$callage['top_left']['x'];
+	$heightgeo=$callage['bottom_right']['y']-$callage['top_left']['y'];
+	
+	$width=$widthgeo;
+	$height=$heightgeo;
+	
 	$returned='<script type="text/javascript" src="js/x_core_nn4.js"></script>
 <script type="text/javascript" src="js/x_dom_nn4.js"></script>
 <script type="text/javascript" src="js/x_event_nn4.js"></script>



From fxp at berlios.de  Tue Mar  1 18:36:27 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:36:27 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire carte_edit.php3,1.5,1.6
Message-ID: <200503011736.j21HaRNx009226@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv9192/ecrire

Modified Files:
	carte_edit.php3 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche

Index: carte_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/carte_edit.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- carte_edit.php3	25 Feb 2005 12:02:14 -0000	1.5
+++ carte_edit.php3	1 Mar 2005 17:36:25 -0000	1.6
@@ -91,7 +91,7 @@
 
 	// Ajout d'un objet
 	if ($selection_type) {
-		$geometrie=coords2wkt($selection_type,$selection_coords);
+		$geometrie=coords2wkt($selection_type,$selection_coords, worldfile2array($row['callage'])); // Si pas de fonction de zoom le callage correspond bien ? la valeur. Sinon avec zoom, il faut passer les coordonn?es g?ographiques de la vue en cours ....
 		$objet_titre = _L("Nouvel objet");
 		$url_objet = "#";
 		//TODO : passer tout ca en spip_abstract ...



From fxp at berlios.de  Tue Mar  1 18:36:45 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:36:45 +0100
Subject: [Spip-carto-cvs] spipcarto mes_fonctions.php3,1.6,1.7
Message-ID: <200503011736.j21HajNx009739@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv9575

Modified Files:
	mes_fonctions.php3 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche

Index: mes_fonctions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/mes_fonctions.php3,v
retrieving revision 1.6
retrieving revision 1.7
diff -u -d -r1.6 -r1.7
--- mes_fonctions.php3	26 Feb 2005 10:45:20 -0000	1.6
+++ mes_fonctions.php3	1 Mar 2005 17:36:43 -0000	1.7
@@ -16,11 +16,19 @@
 }
 function worldfileULX($callage){
 	$tabcallage=worldfile2array($callage);
-	return $tabcallage['top_left']['x'];
+	return $tabcallage['bottom_right']['x'];
 }
 function worldfileULY($callage){
 	$tabcallage=worldfile2array($callage);
-	return $tabcallage['top_left']['y']*-1;
+	return $tabcallage['bottom_right']['y']*-1;
+}
+function worldfileLRX($callage){
+	$tabcallage=worldfile2array($callage);
+	return $tabcallage['top_left']['x'];
+}
+function worldfileLRY($callage){
+	$tabcallage=worldfile2array($callage);
+	return $tabcallage['top_left']['y'];
 }
 function getPropMapHeight($callage, $width){
 	$tabcallage=worldfile2array($callage);
@@ -29,37 +37,7 @@
 }
 
 
-/* +---------------------------------------------+
- *    Nom    du    Filtre : WKT to STYLE
- * +---------------------------------------------+    
- * Date : mercredi 09 avril 2003
- * Auteur :    
- * site : 
- * +---------------------------------------------+ 
- * Fonctions de ce filtre : 
- * Appelez le dans vos squellette tout simplement par :
- * [(#GEOMETRIE|wkt2style)] 
- * +--------------------------------------------- +
- *  
- * Pour toute suggestion, remarque, proposition d'ajout
- * reportez-vous au forum de l'article :
- * http://www.uzine.net/spip_contrib/
- *
- */
-function wkt2style($geometrie){
-	$wktGeomType = substr($geometrie,0,strpos($geometrie,"("));
-	
-	if (strcasecmp($wktGeomType,"POLYGON")==0)
-	{	$coordpair = explode(',',substr($geometrie,strpos($geometrie,"(")+1,-1));
-		$coord = explode (' ', $coordpair[0]);	// TODO : Le centre de gravit? du polygone serait pr?f?rable
-	}elseif (strcasecmp($wktGeomType,"POINT")==0)
-		$coord = explode(' ',substr($geometrie,strpos($geometrie,"(")+1,-1));
-	else
-		$coord = array(0,0); 
-		
-	$returned_str="left: ".$coord[0]."px;top: ".$coord[1]."px;";
-	return $returned_str;
-}
+
 
 /*
  *   +---------------------------------------------+
@@ -79,32 +57,94 @@
  * http://www.uzine.net/spip_contrib/
  *
  */
-function wkt2coords($geometrie, $format = "HTML"){
+function wkt2coords($geometrie, $format = "HTML", $callage = ""){
 	$wktGeomType = substr($geometrie,0,strpos($geometrie,"("));
+	$wktGeom 	= substr($geometrie,strpos($geometrie,"(")+1,-1);
+	
+	$callage 	= worldfile2array ($callage);
+	
+	$GeoWidth 	= ($callage['bottom_right']['x']-$callage['top_left']['x']);
+	$GeoHeight 	= ($callage['bottom_right']['y']-$callage['top_left']['y']);
+	
 	$radius		 = 5;	// TODO : Param?tre (ou fonction du callage ?) pr?f?rable car fonction des projections 5 peut ?tre bcp trop petit
 	switch ($format){
 		case "HTML":
+			// Pour obtenir des objets HTML/MAP ...
+			// 	S?parateur coordonn?es ',' / S?parateur paires de coordonn?es ','
+			$coordpair = explode (',',$wktGeom);
+			
+			for ($i=0; $i<sizeof($coordpair); $i++)
+			{		
+				$coord[$i] 		= explode(' ',$coordpair[$i]);
+				$coord[$i][0] 	= $coord[$i][0];
+				$coord[$i][1] 	= $GeoHeight-$coord[$i][1];		// Calcul de l'Y par rapport au coin inf?rieur
+				$coordpair[$i] 	= implode(',',$coord[$i]);
+			}
+			$wktGeom = implode(',', $coordpair);
+
 			if (strcasecmp($wktGeomType,"POLYGON")==0)
-				return str_replace(' ',',',substr($geometrie,strpos($geometrie,"(")+1,-1));
+				return $wktGeom;
 			if (strcasecmp($wktGeomType,"POINT")==0)
-				return str_replace(' ',',',substr($geometrie,strpos($geometrie,"(")+1,-1)).",".$radius;
+				return $wktGeom.",".$radius;
 		break;
+		case "HTMLDIV":
+			// Pour obtenir des objets HTML/DIV ...
+			// Pour les polygones, la moyenne des valeurs
+			// Pour les points, la valeur
+			$coordpair = explode (',',$wktGeom);
+			
+			for ($i=0; $i<sizeof($coordpair); $i++)
+			{		
+				$coord[$i] 		= explode(' ',$coordpair[$i]);
+				$coord[$i][0] 	= $coord[$i][0];
+				$coord[$i][1] 	= $GeoHeight-$coord[$i][1];		// Calcul de l'Y par rapport au coin inf?rieur
+				$x 				+= $coord[$i][1];
+				$y				+= $coord[$i][0];
+			}
+			return "left: ".$y/$i."px;top: ".$x/$i."px;";
+					
+		break;		
 		case "SVG":
 			// Pour obtenir des objets SVG ...
-			// Faut-il inverser les y ? Voir fonction des notions de projections
+			// Inversion des Y en mode dessin
+			// 	S?parateur coordonn?es ' ' / S?parateur paires de coordonn?es ','
+			$coordpair = explode (',',$wktGeom);
 			
-			if (strcasecmp($wktGeomType,"POLYGON")==0)
-			{  	$coord = str_replace(' ','|',substr($geometrie,strpos($geometrie,"(")+1,-1));	// Inversion des y pour coordonn?es r?elles
-				$coord = str_replace(',',' ',$coord);	// Inversion des y pour coordonn?es r?elles
-				return "points=\"".str_replace('|',',',$coord)."\"";
-		
-			}elseif (strcasecmp($wktGeomType,"LINE")==0)
-			{  	$coord = str_replace(' ','|',substr($geometrie,strpos($geometrie,"(")+1,-1));	// Inversion des y pour coordonn?es r?elles
-				$coord = str_replace(',',' ',$coord);	// Inversion des y pour coordonn?es r?elles
-				return "points=\"".str_replace('|',',',$coord)."\"";
+			for ($i=0; $i<sizeof($coordpair); $i++)
+			{		
+				$coord[$i] 		= explode(' ',$coordpair[$i]);
+				$coord[$i][0] 	= $coord[$i][0];
+				$coord[$i][1] 	= $GeoHeight-$coord[$i][1];		// Calcul de l'Y par rapport au coin inf?rieur
+				$coordpair[$i] 	= implode(' ' ,$coord[$i]);
+			}
+			$wktGeom = implode(',', $coordpair);
+
+			if (strcasecmp($wktGeomType,"POLYGON")==0 || strcasecmp($wktGeomType,"LINE")==0)
+			{  	return "points=\"".$wktGeom."\"";		
+			}elseif (strcasecmp($wktGeomType,"POINT")==0)
+			{	$coordTab = explode (" ", $wktGeom);
+				return "cx=\"".$coordTab[0]."\" cy=\"".$coordTab[1]."\" r=\"".$radius."\"";
+			}
+		break;
+		case "SVGGEO":
+			// Pour obtenir des objets SVG ...
+			// Conservation des Y selon le format WKT car en coordonn?es g?ographique
+			// S?parateur coordonn?es ' ' / S?parateur paires de coordonn?es ','
+			$coordpair = explode (',',$wktGeom);
 			
+			for ($i=0; $i<sizeof($coordpair); $i++)
+			{		
+				$coord[$i] 		= explode(' ',$coordpair[$i]);
+				$coord[$i][0] 	= $coord[$i][0];
+				$coord[$i][1] 	= $coord[$i][1]*-1;		// Y idem au WKT car gestion de la g?om?trie
+				$coordpair[$i] 	= implode(' ' ,$coord[$i]);
+			}
+			$wktGeom = implode(',', $coordpair);
+
+			if (strcasecmp($wktGeomType,"POLYGON")==0 || strcasecmp($wktGeomType,"LINE")==0)
+			{  	return "points=\"".$wktGeom."\"";		
 			}elseif (strcasecmp($wktGeomType,"POINT")==0)
-			{	$coordTab = explode (" ", substr($geometrie,strpos($geometrie,"(")+1,-1));
+			{	$coordTab = explode (" ", $wktGeom);
 				return "cx=\"".$coordTab[0]."\" cy=\"".$coordTab[1]."\" r=\"".$radius."\"";
 			}
 		break;



From fxp at berlios.de  Tue Mar  1 18:37:10 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:37:10 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_lien.html,1.1,1.2
Message-ID: <200503011737.j21HbANx009862@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv9837/squelettes

Modified Files:
	carto_lien.html 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche

Index: carto_lien.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto_lien.html,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carto_lien.html	8 Feb 2005 15:10:13 -0000	1.1
+++ carto_lien.html	1 Mar 2005 17:37:07 -0000	1.2
@@ -1 +1,22 @@
-<div style="float: left;visibility: visible; margin: 0px; padding: 0px;"><div style="position: absolute;"><BOUCLE_carte(CARTO_CARTES){id_carto_carte}><B_objets><map name="map#ID_CARTO_CARTE"><BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords)]" href="#URL_OBJET" alt="#TITRE"/></BOUCLE_objets></map></B_objets><img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="1"/><BOUCLE_objets2(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><div style="position: absolute;margin: 0px; padding: 0px;[(#GEOMETRIE|wkt2style)]border: 0px;"><a href="#URL_OBJET" alt="#TEXTE"><BOUCLE_mot(MOTS){id_carto_objet}{par titre}{0,1}>[(#LOGO_MOT)]</BOUCLE_mot> #TITRE</a></div></BOUCLE_objets2></BOUCLE_carte></div></div>
\ No newline at end of file
+<div style="float: left;visibility: visible; margin: 0px; padding: 0px;">
+	<div style="position: absolute;">
+	<BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
+		<B_objets>
+			<map name="map#ID_CARTO_CARTE">
+			<BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
+			<area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords{HTML,#CALLAGE})]" href="#URL_OBJET" alt="#TITRE"/>
+		</BOUCLE_objets>
+		</map>
+		</B_objets>
+		<img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="1"/>
+		<BOUCLE_objets2(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
+			<div style="position: absolute;margin: 0px; padding: 0px;[(#GEOMETRIE|wkt2coords{HTMLDIV,#CALLAGE})]border: 0px;">
+			<a href="#URL_OBJET" alt="#TEXTE">
+			<BOUCLE_mot(MOTS){id_carto_objet}{par titre}{0,1}>[(#LOGO_MOT)]
+			</BOUCLE_mot> #TITRE
+			</a>
+			</div>
+		</BOUCLE_objets2>
+	</BOUCLE_carte>
+	</div>
+</div>
\ No newline at end of file



From fxp at berlios.de  Tue Mar  1 18:37:24 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:37:24 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_logo.html,1.1,1.2
Message-ID: <200503011737.j21HbONx009921@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv9914/squelettes

Modified Files:
	carto_logo.html 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche

Index: carto_logo.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto_logo.html,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carto_logo.html	8 Feb 2005 15:10:13 -0000	1.1
+++ carto_logo.html	1 Mar 2005 17:37:22 -0000	1.2
@@ -1 +1,21 @@
-<div style="position: relative;visibility: visible; margin: 0px; padding: 0px;"><div style="position: absolute;"><BOUCLE_carte(CARTO_CARTES){id_carto_carte}><B_objets><map name="map#ID_CARTO_CARTE"><BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords)]" href="#URL_OBJET" alt="#TITRE"/></BOUCLE_objets></map></B_objets><img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="1"/><BOUCLE_objets2(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><a href="#URL_OBJET"><img style="position: absolute;margin: 0px; padding: 0px;[(#GEOMETRIE|wkt2style)]border: 0px;" alt="#TEXTE" src="<BOUCLE_mot(MOTS){id_carto_objet=#ID_CARTO_OBJET}{par titre}{0,1}>IMG/moton[(#ID_MOT)].gif</BOUCLE_mot>" border="0"/></a></BOUCLE_objets2></BOUCLE_carte></div></div>
\ No newline at end of file
+<div style="position: relative;visibility: visible; margin: 0px; padding: 0px;">
+	<div style="position: absolute;">
+	<BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
+		<B_objets>
+			<map name="map#ID_CARTO_CARTE">
+			<BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
+			<area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords{HTML,#CALLAGE})]" href="#URL_OBJET" alt="#TITRE"/>
+		</BOUCLE_objets>
+		</map>
+		</B_objets>
+		
+		<img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="1"/>
+		
+		<BOUCLE_objets2(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
+			<a href="#URL_OBJET">
+			<img style="position: absolute;margin: 0px; padding: 0px;[(#GEOMETRIE|wkt2coords{HTMLDIV,#CALLAGE})]border: 0px;" alt="#TEXTE" src="<BOUCLE_mot(MOTS){id_carto_objet=#ID_CARTO_OBJET}{par titre}{0,1}>IMG/moton[(#ID_MOT)].gif</BOUCLE_mot>" border="0"/>
+			</a>
+		</BOUCLE_objets2>
+	</BOUCLE_carte>
+	</div>
+</div>
\ No newline at end of file



From fxp at berlios.de  Tue Mar  1 18:37:48 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:37:48 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_logox.html,1.1,1.2
Message-ID: <200503011737.j21HbmNx010036@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv10029/squelettes

Modified Files:
	carto_logox.html 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche

Index: carto_logox.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto_logox.html,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carto_logox.html	8 Feb 2005 15:10:13 -0000	1.1
+++ carto_logox.html	1 Mar 2005 17:37:46 -0000	1.2
@@ -1 +1 @@
-<div style="float: left;visibility: visible; margin: 0px; padding: 0px;"><div style="position: absolute;"><BOUCLE_carte(CARTO_CARTES){id_carto_carte}><B_objets><map name="map#ID_CARTO_CARTE"><BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords)]" href="#URL_OBJET" alt="#TITRE"/></BOUCLE_objets></map></B_objets><img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="1"/><BOUCLE_objets2(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><BOUCLE_mot(MOTS){id_carto_objet=#ID_CARTO_OBJET}{par titre}{0,1}>[<div style="position: absolute;margin: 0px; padding: 0px;[(#GEOMETRIE|wkt2style)]border: 0px;"><a href="#URL_OBJET">(#LOGO_MOT)</a></div>]</BOUCLE_mot></BOUCLE_objets2></BOUCLE_carte></div></div>
\ No newline at end of file
+<div style="float: left;visibility: visible; margin: 0px; padding: 0px;"><div style="position: absolute;"><BOUCLE_carte(CARTO_CARTES){id_carto_carte}><B_objets><map name="map#ID_CARTO_CARTE"><BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords{HTML,#CALLAGE})]" href="#URL_OBJET" alt="#TITRE"/></BOUCLE_objets></map></B_objets><img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="1"/><BOUCLE_objets2(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><BOUCLE_mot(MOTS){id_carto_objet=#ID_CARTO_OBJET}{par titre}{0,1}>[<div style="position: absolute;margin: 0px; padding: 0px;[(#GEOMETRIE|wkt2style)]border: 0px;"><a href="#URL_OBJET">(#LOGO_MOT)</a></div>]</BOUCLE_mot></BOUCLE_objets2></BOUCLE_carte></div></div>
\ No newline at end of file



From fxp at berlios.de  Tue Mar  1 18:38:12 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:38:12 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_svg.html,1.2,1.3
Message-ID: <200503011738.j21HcCNx010103@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv10093/squelettes

Modified Files:
	carto_svg.html 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche + encodage

Index: carto_svg.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto_svg.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- carto_svg.html	26 Feb 2005 10:44:21 -0000	1.2
+++ carto_svg.html	1 Mar 2005 17:38:10 -0000	1.3
@@ -1,15 +1,3 @@
 <BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
-<!-- <object type="image/svg+xml" name="omap" data="carto_svgfile#ID_CARTO_CARTE.svg"
-width="[(#CALLAGE|worldfileWidth)]px"
-height="[(#CALLAGE|worldfileHeight)]px"/> 
-
-Probl?me sous IE avec Object 
-Pour le Callage, ces infos sont la projection pas forc?ment la largeur 
-de la carte ? l'affichage. Plut?t l'utiliser dans la viewbow SVG ...
--->
-
-
 <embed src="carto_svgfile.php3?id_carto_carte=#ID_CARTO_CARTE" width="600px" height="400px" type="image/svg+xml" name="emap"/>
-
-
 </BOUCLE_carte>



From fxp at berlios.de  Tue Mar  1 18:38:29 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:38:29 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_svgfile.html,1.2,1.3
Message-ID: <200503011738.j21HcTNx010125@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv10119/squelettes

Modified Files:
	carto_svgfile.html 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche + encodage

Index: carto_svgfile.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto_svgfile.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- carto_svgfile.html	26 Feb 2005 10:44:36 -0000	1.2
+++ carto_svgfile.html	1 Mar 2005 17:38:26 -0000	1.3
@@ -1,5 +1,6 @@
+<?php echo '<'.'?xml version="1.0" encoding="#CHARSET"?'.">\n"; ?>
 <BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
-	<svg viewBox="0 0 [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve">
+	<svg viewBox="[(#CALLAGE|worldfileLRX)] [(#CALLAGE|worldfileLRY)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve">
 		<defs>
 		 <linearGradient id="MyGradient" gradientTransform="rotate(45)">
 		  <stop offset="0%" style="stop-color:white"/>
@@ -15,8 +16,8 @@
 		 
 		<g id="mainlayer">
 		 	<BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
-		  		<a xlink:href="#URL_OBJET" alt="#TITRE"><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVG})] style="fill:url(#MyGradient);opacity:.7;"/></a>
-				<!--<a xlink:href="#URL_OBJET" alt="#TITRE"><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVG})] style="fill:none;stroke:black;opacity:.7;"/></a>-->
+		  		<a xlink:href="#URL_OBJET" alt="#TITRE"><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVG,#CALLAGE})] style="fill:url(#MyGradient);opacity:.7;"/></a>
+				<!--<a xlink:href="#URL_OBJET" alt="#TITRE"><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVG,#CALLAGE})] style="fill:none;stroke:black;opacity:.7;"/></a>-->
 		 	</BOUCLE_objets>
 		</g>
 	</svg>



From fxp at berlios.de  Tue Mar  1 18:38:47 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:38:47 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto.html,1.1,1.2
Message-ID: <200503011738.j21HclNx010165@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv10159/squelettes

Modified Files:
	carto.html 
Log Message:
Callage des Y par rapport au coin inf?rieur gauche 

Index: carto.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto.html,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carto.html	8 Feb 2005 15:10:13 -0000	1.1
+++ carto.html	1 Mar 2005 17:38:45 -0000	1.2
@@ -1 +1,4 @@
-<BOUCLE_carte(CARTO_CARTES){id_carto_carte}><img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="0"/><B_objets><map name="map#ID_CARTO_CARTE"><BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}><area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords)]" href="#URL_OBJET" alt="#TITRE"/></BOUCLE_objets></map></B_objets></BOUCLE_carte>
\ No newline at end of file
+<BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
+<img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" usemap="#map#ID_CARTO_CARTE" border="0"/><B_objets><map name="map#ID_CARTO_CARTE"><BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
+<area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords{HTML,#CALLAGE})]" href="#URL_OBJET" alt="#TITRE"/>
+</BOUCLE_objets></map></B_objets></BOUCLE_carte>
\ No newline at end of file



From fxp at berlios.de  Tue Mar  1 18:43:49 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:43:49 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_geosvg.html,NONE,1.1
Message-ID: <200503011743.j21HhnNx011018@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv10935/squelettes

Added Files:
	carto_geosvg.html 
Log Message:
Interface SVG avanc?e

--- NEW FILE: carto_geosvg.html ---
<BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
<embed src="carto_geosvgfile.php3?id_carto_carte=#ID_CARTO_CARTE" width="600px" height="400px" type="image/svg+xml" name="emap"/>
</BOUCLE_carte>


From fxp at berlios.de  Tue Mar  1 18:44:03 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:44:03 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_geosvgfile.html,NONE,1.1
Message-ID: <200503011744.j21Hi3Nx011196@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv11163/squelettes

Added Files:
	carto_geosvgfile.html 
Log Message:
Interface SVG avanc?e

--- NEW FILE: carto_geosvgfile.html ---
<?php echo '<'.'?xml version="1.0" encoding="#CHARSET"?'.">\n"; ?>
<BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
<svg width="100%" height="100%" viewBox="0 0 850 590" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:attrib="http://www.carto.net/attrib" onload="init(evt);" zoomAndPan="enable" encoding="ISO-8859-1">
	<script type="text/ecmascript" xlink:href="helper_functions.js"/>
	<script type="text/ecmascript" xlink:href="navigation.js"/>
	<script type="text/ecmascript"><![CDATA[


/* slider.js */
//slider properties
function slider(x1,y1,value1,x2,y2,value2,startVal,sliderGroupId,sliderColor,visSliderWidth,invisSliderWidth,sliderSymb,functionToCall,mouseMoveBool) {
	this.x1 = x1;
	this.y1 = y1;
	this.value1 = value1;
	this.x2 = x2;
	this.y2 = y2;
	this.value2 = value2;
	this.startVal = startVal;
	this.value = startVal;
	this.sliderGroupId = sliderGroupId;
	this.sliderGroup = document.getElementById(this.sliderGroupId);
	this.sliderColor = sliderColor;
	this.visSliderWidth = visSliderWidth;
	this.invisSliderWidth = invisSliderWidth;
	this.sliderSymb = sliderSymb;
	this.functionToCall = functionToCall;
	this.mouseMoveBool = mouseMoveBool;
	this.length = toPolarDist((this.x2 - this.x1),(this.y2 - this.y1));
	this.direction = toPolarDir((this.x2 - this.x1),(this.y2 - this.y1));
	this.createSlider();
	this.slideStatus = 0;
	this.ctm = getTransformToRootElement(this.sliderGroup).inverse();
}

//create slider
slider.prototype.createSlider = function() {
	var mySliderLine = document.createElementNS(svgNS,"line");
	mySliderLine.setAttributeNS(null,"x1",this.x1);
	mySliderLine.setAttributeNS(null,"y1",this.y1);
	mySliderLine.setAttributeNS(null,"x2",this.x2);
	mySliderLine.setAttributeNS(null,"y2",this.y2);
	mySliderLine.setAttributeNS(null,"stroke",this.sliderColor);
	mySliderLine.setAttributeNS(null,"stroke-width",this.invisSliderWidth);
	mySliderLine.setAttributeNS(null,"opacity","0");
	mySliderLine.setAttributeNS(null,"id",this.sliderGroupId+"_invisibleSliderLine");
	mySliderLine.addEventListener("mousedown",this,false);
	this.sliderGroup.appendChild(mySliderLine);
	mySliderLine = document.createElementNS(svgNS,"line");
	mySliderLine.setAttributeNS(null,"x1",this.x1);
	mySliderLine.setAttributeNS(null,"y1",this.y1);
	mySliderLine.setAttributeNS(null,"x2",this.x2);
	mySliderLine.setAttributeNS(null,"y2",this.y2);
	mySliderLine.setAttributeNS(null,"stroke",this.sliderColor);
	mySliderLine.setAttributeNS(null,"stroke-width",this.visSliderWidth);
	mySliderLine.setAttributeNS(null,"id",this.sliderGroupId+"_visibleSliderLine");
	mySliderLine.setAttributeNS(null,"pointer-events","none");
	this.sliderGroup.appendChild(mySliderLine);
	mySliderSymb = document.createElementNS(svgNS,"use");
	mySliderSymb.setAttributeNS(xlinkNS,"xlink:href","#"+this.sliderSymb);
	var myStartDistance = this.length - ((this.value2 - this.startVal) / (this.value2 - this.value1)) * this.length;
	var myPosX = this.x1 + toRectX(this.direction,myStartDistance);
	var myPosY = this.y1 + toRectY(this.direction,myStartDistance);
	var myTransformString = "translate("+myPosX+","+myPosY+") rotate(" + Math.round(this.direction / Math.PI * 180) + ")";
	mySliderSymb.setAttributeNS(null,"transform",myTransformString);
	mySliderSymb.setAttributeNS(null,"id",this.sliderGroupId+"_sliderSymbol");
	this.sliderGroup.appendChild(mySliderSymb);
}

//remove all slider elements
slider.prototype.removeSlider = function() {
    var mySliderSymb = document.getElementById(this.sliderGroup+"_sliderSymbol");
	this.sliderGroup.removeChild(mySliderSymb);
    var mySliderLine = document.getElementById(this.sliderGroup+"_visibleSliderLine");
	this.sliderGroup.removeChild(mySliderLine);
    var mySliderLine = document.getElementById(this.sliderGroup+"_invisibleSliderLine");
	this.sliderGroup.removeChild(mySliderLine);
}

//handle events
slider.prototype.handleEvent = function(evt) {
	this.drag(evt);
}

//drag slider
slider.prototype.drag = function(evt) {
	var svgroot = document.documentElement;
	if (evt.type == "mousedown" || (evt.type == "mousemove" && this.slideStatus == 1)) {
		var myCoords = myMapApp.calcCoord(evt.clientX,evt.clientY);
		//undo the effect of transformations
		var mySVGPoint = svgroot.createSVGPoint();
		mySVGPoint.x = myCoords["x"];
		mySVGPoint.y = myCoords["y"];
		mySVGPoint = mySVGPoint.matrixTransform(this.ctm);
		myCoords["x"] = mySVGPoint.x;
		myCoords["y"] = mySVGPoint.y;
	
		//draw normal line for first vertex
		var ax = this.x2 - this.x1;
		var ay = this.y2 - this.y1;
		//normal vector 1
		var px1 = parseFloat(this.x1) + ay * -1;
		var py1 = parseFloat(this.y1) + ax;
		//normal vector 2
		var px2 = parseFloat(this.x2) + ay * -1;
		var py2 = parseFloat(this.y2) + ax;
				
		if (leftOfTest(myCoords["x"],myCoords["y"],this.x1,this.y1,px1,py1) == 0 && leftOfTest(myCoords["x"],myCoords["y"],this.x2,this.y2,px2,py2) == 1) {
			if (evt.type == "mousedown" && evt.detail == 1) {
				this.slideStatus = 1;
				svgroot.addEventListener("mousemove",this,false);
				svgroot.addEventListener("mouseup",this,false);
			}
			myNewPos = intersect2lines(this.x1,this.y1,this.x2,this.y2,myCoords["x"],myCoords["y"],myCoords["x"] + ay * -1,myCoords["y"] + ax);
			var myPercentage = toPolarDist(myNewPos['x'] - this.x1,myNewPos['y'] - this.y1) / this.length;
			this.value = this.value1 + myPercentage * (this.value2 - this.value1);
		}
		else {
			var myNewPos = new Array();
			if (leftOfTest(myCoords["x"],myCoords["y"],this.x1,this.y1,px1,py1) == 0 && leftOfTest(myCoords["x"],myCoords["y"],this.x2,this.y2,px2,py2) == 0) {
				//more than max
				this.value = this.value2;
				myNewPos['x'] = this.x2;
				myNewPos['y'] = this.y2;
			}
			if (leftOfTest(myCoords["x"],myCoords["y"],this.x1,this.y1,px1,py1) == 1 && leftOfTest(myCoords["x"],myCoords["y"],this.x2,this.y2,px2,py2) == 1) {
				//less than min
				this.value = this.value1;
				myNewPos['x'] = this.x1;
				myNewPos['y'] = this.y1;
			}
		}
		var myTransformString = "translate("+myNewPos['x']+","+myNewPos['y']+") rotate(" + Math.round(this.direction / Math.PI * 180) + ")";
		document.getElementById(this.sliderGroupId+"_sliderSymbol").setAttributeNS(null,"transform",myTransformString);
		this.getValue();
	}
	if (evt.type == "mouseup" && evt.detail == 1) {
		if (this.slideStatus == 1) {
			this.slideStatus = 2;
			svgroot.removeEventListener("mousemove",this,false);
			svgroot.removeEventListener("mouseup",this,false);
			this.getValue();
		}
		this.slideStatus = 0;
	}
}

//this code is executed, after the slider is released
//you can use switch/if to detect which slider was used (use this.sliderGroup) for that
slider.prototype.getValue = function() {
	if (this.slideStatus == 1 && this.mouseMoveBool == true) {
		if (typeof(this.functionToCall) == "function") {
			this.functionToCall("change",this.sliderGroupId,this.value);
		}
		if (typeof(this.functionToCall) == "object") {
			this.functionToCall.getSliderVal("change",this.sliderGroupId,this.value);
		}
		if (typeof(this.functionToCall) == "string") {
			eval(this.functionToCall+"('change','"+this.sliderGroupId+"',"+this.value+")");
		}
	}
	if (this.slideStatus == 2) {
		if (typeof(this.functionToCall) == "function") {
			this.functionToCall("release",this.sliderGroupId,this.value);
		}
		if (typeof(this.functionToCall) == "object") {
			this.functionToCall.getSliderVal("release",this.sliderGroupId,this.value);
		}
		if (typeof(this.functionToCall) == "string") {
			eval(this.functionToCall+"('release','"+this.sliderGroupId+"',"+this.value+")");
		}
	}
}	

//this is to set the value from other scripts
slider.prototype.setValue = function(value) {
	var myPercAlLine = (value - this.value1) / (this.value2 - this.value1);
	this.value = myPercAlLine;
	var myPosX = this.x1 + toRectX(this.direction,this.length * myPercAlLine);
	var myPosY = this.y1 + toRectY(this.direction,this.length * myPercAlLine);
	var myTransformString = "translate("+myPosX+","+myPosY+") rotate(" + Math.round(this.direction / Math.PI * 180) + ")";
	document.getElementById(this.sliderGroupId+"_sliderSymbol").setAttributeNS(null,"transform",myTransformString);
}	
/* slider.js */




/* mapApp.js */	
//holds data on window size
function mapApp() {
	if (!document.documentElement.getScreenCTM) {
		//initialize ratio
		this.resetFactors();
		//add resize event to document element
		document.documentElement.addEventListener("SVGResize",this,false);
	}
}

mapApp.prototype.handleEvent = function(evt) {
	if (evt.type == "SVGResize") {
		this.resetFactors();
	}
}

mapApp.prototype.resetFactors = function() {
	if (!document.documentElement.getScreenCTM) {
		//case for viewers that don't support .getScreenCTM, such as ASV3
		//calculate ratio and offset values of app window
		var viewBoxArray = document.documentElement.getAttributeNS(null,"viewBox").split(" ");
		var myRatio = viewBoxArray[2]/viewBoxArray[3];
		if ((window.innerWidth/window.innerHeight) > myRatio) { //case window is more wide than myRatio
			this.scaleFactor = viewBoxArray[3] / window.innerHeight;
		}
		else { //case window is more tall than myRatio
			this.scaleFactor = viewBoxArray[2] / window.innerWidth;
		}
		this.offsetX = (window.innerWidth - viewBoxArray[2] * 1 / this.scaleFactor) / 2;
		this.offsetY = (window.innerHeight - viewBoxArray[3] * 1 / this.scaleFactor) / 2;
	}
}

mapApp.prototype.calcCoord = function(coordx,coordy) {
	var coords = new Array();
	if (!document.documentElement.getScreenCTM) {
		//case ASV3 a. Corel
		coords["x"] = (coordx  - this.offsetX) * this.scaleFactor;
		coords["y"] = (coordy - this.offsetY) * this.scaleFactor;
	}
	else {
		matrix=document.documentElement.getScreenCTM();
		coords["x"]= matrix.inverse().a*coordx+matrix.inverse().c*coordy+matrix.inverse().e;
		coords["y"]= matrix.inverse().b*coordx+matrix.inverse().d*coordy+matrix.inverse().f;
	}
	return coords;
}
/* mapApp.js */	
	
		
/* checkbox.js */
function checkBoxScript(evt,myLayer) { //checkBox for toggling layers an contextMenue
	var myLayerObj = document.getElementById(myLayer);
	var myCheckCrossObj = document.getElementById("checkCross"+myLayer);
	var myCheckCrossVisibility = myCheckCrossObj.getAttributeNS(null,"visibility");
	if (evt.type == "click" && evt.detail == 1) {
		if (myCheckCrossVisibility == "visible") {
			myLayerObj.setAttributeNS(null,"visibility","hidden");
			myCheckCrossObj.setAttributeNS(null,"visibility","hidden");
			//you can do if/else or switch statements to set different actions on activating a checkbox here
			//myLayer holds the currentLayer name
			/*if (myLayer == "DOQ") {
				getOrthoImage();
			}*/
		}
		else {
			myLayerObj.setAttributeNS(null,"visibility","visible");
			myCheckCrossObj.setAttributeNS(null,"visibility","visible");
		}
	}
}
/* checkbox.js */	
		
		
		
		var myMapApp = new mapApp();
		var myMainMap;
		var myRefMapDragger;
		var myZoomSlider;
		function init(evt) {
			//dynamic layer array that allow loading from database
			var dynamicLayers = new Array();
			//initialize digiLayers (layers that allow digitizing)
			var digiLayers = new Array();
			myMainMap = new map("mainMap",[(#CALLAGE|worldfileWidth)],0,0.6,0,"m",true,"coordX","coordY",dynamicLayers,digiLayers,"");
			//slider properties: x1,y1,value1,x2,y2,value2,startValue,group in which to build the slider,color of slider
			//width of slider of sliderbar,width of invisible slider bar,width of visible slider
			myZoomSlider = new slider(710,70,myMainMap.minWidth,710,170,myMainMap.maxWidth,myMainMap.maxWidth,"mapZoomSlider","dimgray",2,10,"sliderSymbol","myRefMapDragger.resizeDragger",true);
			//set constraints to draggable rect in reference map
			myRefMapDragger = new dragObj("dragRectForRefMap","referenceMap","myDragCross",4750,true,"coordX","coordY",myMainMap);
			loadProjectSpecific();
		}
		function loadProjectSpecific() {
			//adopt width and height of map extent
			document.getElementById("myScaleTextW").firstChild.nodeValue = formatNumberString(myMainMap.curWidth.toFixed(myMainMap.nrDecimals)) + myMainMap.units;
			document.getElementById("myScaleTextH").firstChild.nodeValue = formatNumberString(myMainMap.curHeight.toFixed(myMainMap.nrDecimals)) + myMainMap.units;
			//adopt line width of park boundary
			document.getElementById("spipCartoObj").setAttributeNS(null,"stroke-width",myMainMap.curWidth*0.005);	
			// Pour charger un claque WMS ... getOrthoImage();
		}
		
		function openWin (url) {
			window.open(url, "info");
		}


		//load usgs/terraserver orthoimage
		//you have to use full pixel values, otherwise an error appears
		function getOrthoImage() {
			var myRasterLayer = document.getElementById("DOQ");
			if (myRasterLayer.childNodes.length > 0) {
				var oldImage = document.getElementById("DOQImage");
				myRasterLayer.removeChild(oldImage);
			}
			if (document.getElementById("DOQ").getAttributeNS(null,"visibility") == "visible") {
				var myRasterImage = document.createElementNS(svgNS,"image");
				myRasterImage.setAttributeNS(null,"x",myMainMap.curxOrig);
				myRasterImage.setAttributeNS(null,"y",myMainMap.curyOrig);
				myRasterImage.setAttributeNS(null,"width",myMainMap.curWidth);
				myRasterImage.setAttributeNS(null,"height",myMainMap.curHeight);
				myRasterImage.setAttributeNS(null,"id","DOQImage");
				var myImageUrl = "http://www.sandre.fr/geo/wmszonage?version=1.1.1&request=GetMap&service=WMS&Layers=CIBA&Styles=&SRS=EPSG:27572&";
				myImageUrl += "BBOX=" + parseInt(myMainMap.curxOrig) + "," + (parseInt(myMainMap.curyOrig + myMainMap.curHeight) * -1);
				myImageUrl += "," + parseInt(myMainMap.curxOrig + myMainMap.curWidth) + "," + (parseInt(myMainMap.curyOrig) * -1);
				myImageUrl += "&width=" + myMainMap.pixWidth + "&height=" + myMainMap.pixHeight + "&format=image/png";
				myRasterImage.setAttributeNS(xlinkNS,"xlink:href",myImageUrl);
				myRasterLayer.appendChild(myRasterImage);
			}
		}		


]]></script>
	<defs>
	<!-- section for CSS stylesheet definitions -->
	<!-- you may globally adjust your styles here -->
	<style type="text/css"><![CDATA[
	.allText {font-family:Arial;fill:dimgray;}
	.titleText {font-size:22;font-weight:bold;}
	.subTitleText {font-size:18;font-weight:bold;}
	.normalText {font-size:15;}
	.smallText {font-size:12;}
	.boldText {font-weight:bold;}
	.centerText {text-anchor:middle;}
	.dragRect {fill:lightskyblue;stroke:none;opacity:0.4;}
	.dragSymbol {stroke:darkblue;}
	.normalLinestyle {fill:none;stroke:dimgray;}
	.background {fill:aliceblue;stroke:none;}
	.darkRectstyle {fill:dimgray;stroke:none;}
	.nofill {fill:none;}
	.whitefill {fill:white;}
	.normalfillcol {fill:dimgray;}
	.normallinecol {stroke:dimgray;}
	.nostroke {stroke:none;}
	.verythinline {stroke-width:1;}
	.thinline {stroke-width:1.5;}
	.normalline {stroke-width:2;}
	.mediumThickLine {stroke-width:5;}
  ]]></style>
		<!-- Symbols for checkboxes -->
		<symbol id="checkBoxRect" overflow="visible">
			<rect x="-6" y="-6" width="12" height="12" class="whitefill normallinecol thinline"/>
		</symbol>
		<symbol id="checkBoxCross" overflow="visible" class="normallinecol nofill verythinline" pointer-events="none">
			<line x1="-5" y1="-5" x2="5" y2="5"/>
			<line x1="-5" y1="5" x2="5" y2="-5"/>
		</symbol>
		<!-- Symbols for Zoom Magnifyer glasses -->
		<symbol id="magnifyer" overflow="visible" class="whitefill normalline normallinecol">
			<line x1="0" y1="0" x2="-8" y2="20"/>
			<circle r="8"/>
		</symbol>
		<symbol id="magnifyerZoomOut" overflow="visible" class="whitefill normalline normallinecol">
			<use xlink:href="#magnifyer"/>
			<line x1="-4" y1="0" x2="4" y2="0" style="stroke:dimgray;stroke-width:2;"/>
		</symbol>
		<symbol id="magnifyerZoomIn" overflow="visible">
			<use xlink:href="#magnifyer"/>
			<line x1="-4" y1="0" x2="4" y2="0" class="whitefill normalline normallinecol"/>
			<line x1="0" y1="-4" x2="0" y2="4" class="whitefill normalline normallinecol"/>
		</symbol>
		<symbol id="magnifyerFull" overflow="visible">
			<use xlink:href="#magnifyer"/>
			<text y="4.5" class="allText smallText centerText boldText" pointer-events="none">F</text>
		</symbol>
		<symbol id="magnifyerManual" overflow="visible">
			<line x1="0" y1="0" x2="-8" y2="20" class="whitefill normalline normallinecol"/>
			<circle r="8" class="whitefill normalline normallinecol"/>
			<rect x="-3" y="-3" width="6" height="6" class="nofill thinline normallinecol" stroke-dasharray="1.5,1.5"/>
		</symbol>
		<symbol id="magnifyerZoomInWo" overflow="visible" class="whitefill normalline normallinecol">
			<circle r="8"/>
			<line x1="-4" y1="0" x2="4" y2="0"/>
			<line x1="0" y1="-4" x2="0" y2="4"/>
		</symbol>
		<symbol id="magnifyerZoomOutWo" overflow="visible" class="whitefill normalline normallinecol">
			<circle r="8"/>
			<line x1="-4" y1="0" x2="4" y2="0" style="stroke:dimgray;stroke-width:2;"/>
		</symbol>
		<!-- hand symbol for panning -->
		<symbol id="symbPan" overflow="visible">
			<circle r="9" class="normallinecol normalline whitefill"/>
			<path class="normallinecol verythinline nofill" d="M-2 6 C -2.2 2.5 -8.0 -0 -5.7 -1.9 C -4.3 -2.5 -3.3 -0.5 -2.5 0.7 C -3.2 -2.1 -5.5 -5.2 -3.6 -5.8 C -2.1 -6.3 -1.6 -3.6 -1.1 -1.9 C -0.9 -4.2 -1.6 -6.4 -0.2 -6.6 C 1.4 -6.8 0.9 -3 1.1 -1.9 C 1.5 -3.5 1.2 -6.1 2.5 -6.1 C 3.9 -6.1 3.5 -3.2 3.6 -1.6 C 4 -2.9 4.1 -4.3 5.3 -4.4 C 7.3 -3.5 4 2.2 3 6z"/>
		</symbol>
		<!-- Symbol for Pan Arrows -->
		<symbol id="symbArrow" overflow="visible" class="nofill verythinline normallinecol" pointer-events="none">
			<polyline points="-3,-5 3,-5 3,1 5,1 0,5 -5,1 -3,1 -3,-5"/>
		</symbol>
		<!-- Symbol for Recentering Map -->
		<symbol id="symbRecenter" overflow="visible">
			<circle r="9" class="normallinecol normalline whitefill"/>
			<circle class="normalfillcol nostroke" cx="0" cy="0" r="1" pointer-events="none"/>
			<g class="normallinecol thinline nofill" pointer-events="none">
				<line x1="-7" y1="-7" x2="-3" y2="-3"/>
				<line x1="7" y1="7" x2="3" y2="3"/>
				<line x1="-7" y1="7" x2="-3" y2="3"/>
				<line x1="7" y1="-7" x2="3" y2="-3"/>
			</g>
		</symbol>
		<!-- Symbol for Slider -->
		<symbol id="sliderSymbol" overflow="visible" class="nofill mediumThickLine normallinecol" pointer-events="none">
			<line x1="0" y1="-5" x2="0" y2="5"/>
		</symbol>
		<!-- Symbol for Dragging if zoomed in far -->
		<symbol id="myDragCrossSymbol" overflow="visible" stroke-width="2000" class="nofill dragSymbol" pointer-events="none">
			<line x1="-7000" y1="0" x2="-2500" y2="0"/>
			<line x1="7000" y1="0" x2="2500" y2="0"/>
			<line x1="0" y1="-3300" x2="0" y2="-7800"/>
			<line x1="0" y1="3300" x2="0" y2="7800"/>
		</symbol>
		<!-- Marker for Extent-Arrows -->
		<marker id="myStartArrow" overflow="visible" orient="auto">
			<polyline class="nostroke normalfillcol" points="-0.5,0 8,-2 8,2"/>
		</marker>
		<marker id="myEndArrow" overflow="visible" orient="auto">
			<polyline class="nostroke normalfillcol" points="0.5,0 -8,-2 -8,2"/>
		</marker>
		<linearGradient id="MyGradient" gradientTransform="rotate(45)"> 
			<stop offset="0%" style="stop-color:white"/> 
			<stop offset="30%" style="stop-color:red"/> 
			<stop offset="100%" style="stop-color:black"/> 
		</linearGradient> 


	</defs>
	<rect x="-500" y="-500" width="3000" height="[(#CALLAGE|getPropMapHeight{3000})]" stroke="none" class="background" />
	
	
	<!-- Main Map Frame -->
	<svg id="mainMap" x="0" y="15" viewBox="[(#CALLAGE|worldfileLRX)] -[(#CALLAGE|worldfileHeight)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" width="553" height="[(#CALLAGE|getPropMapHeight{553})]">
		<!-- this group is necessary for manual panning, it temporarily gets a translate transformation which is later removed on mouseup -->
		<g id="mainMapGroup" transform="translate(0,0)">
			<!-- within this group you should place all map layers, usually, if you have more than one element in a map layer, you would use a group instead of a single element, as in this example -->
			<g id="DOQ" visibility="visible" />
			<image id="ShadedRelief" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" width="[(#CALLAGE|worldfileWidth)]px" height="[(#CALLAGE|worldfileHeight)]px" xlink:href="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" />
			
			<g id="spipCartoObj">
			
				<!-- Couche d'objets SPIP -->
				<B_objets>
				<BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
				<a target='new' xlink:href='#URL_OBJET'><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVGGEO})] style="fill:url(#MyGradient);" onmouseover="statusChange('#TEXTE');"/></a>
				</BOUCLE_objets>
				</B_objets>	
			</g>
		</g>
	</svg>
	
	
	
	<!-- this group holds navigation, title and if you like, legend information -->
	<g>
		<!-- your map title -->
		<text class="allText titleText" x="580" y="30">#TITRE</text>
		<!-- coordinate display -->
		<g class="allText normalText">
			<text id="coordX" x="730" y="145">X:</text>
			<text id="coordY" x="730" y="160">Y:</text>
		</g>
		<!-- display width and height of map extent -->
		<g>
			<!-- vertical line, displays current height of map extent -->
			<line class="normalLinestyle" style="stroke-width:1.5;marker-start:url(#myStartArrow);marker-end:url(#myEndArrow);" x1="561" y1="15" x2="561" y2="[(#CALLAGE|getPropMapHeight{575})]"/>
			<rect class="background" x="555" y="[(#CALLAGE|getPropMapHeight{230})]" width="12" height="100"/>
			<text id="myScaleTextH" class="allText normalText centerText" transform="translate(556,[(#CALLAGE|getPropMapHeight{280})]),rotate(90)">81,000 m</text>
			<!-- horizontal line, displays current width of map extent -->
			<line class="normalLinestyle" style="stroke-width:1.5;marker-start:url(#myStartArrow);marker-end:url(#myEndArrow);" x1="0" y1="[(#CALLAGE|getPropMapHeight{583})]" x2="553.1" y2="[(#CALLAGE|getPropMapHeight{583})]"/>
			<rect class="background" x="236" y="[(#CALLAGE|getPropMapHeight{580})]" width="100" height="12"/>
			<text id="myScaleTextW" class="allText normalText centerText" transform="translate(277,[(#CALLAGE|getPropMapHeight{590})])">64,000 m</text>
			<!-- small rectangle in lower right corner, onclick displays current map extent in real world coordinates -->
			<rect class="darkRectstyle" x="558.5" y="[(#CALLAGE|getPropMapHeight{580})]" width="5" height="5" onclick="showExtent()" />
		</g>
		<!-- control map layer visibility with checkBoxes -->
		<g transform="translate(590 225)">
			<text class="allText subTitleText" x="-10" y="0">Calques</text>
			<!-- first checkbox -->
			<g transform="translate(0 20)">
				<use id="checkBoxspipCartoObj" xlink:href="#checkBoxRect" onclick="checkBoxScript(evt,'spipCartoObj');"/>
				<use id="checkCrossspipCartoObj" xlink:href="#checkBoxCross" visibility="visible"/>
			</g>
			<!-- second checkbox -->
			<g transform="translate(0 40)">
				<use id="checkBoxShadedRelief" xlink:href="#checkBoxRect" onclick="checkBoxScript(evt,'ShadedRelief');"/>
				<use id="checkCrossShadedRelief" xlink:href="#checkBoxCross" visibility="visible"/>
			</g>
			<!-- third checkbox 
			<g transform="translate(0 60)">
				<use id="checkBoxDOQ" xlink:href="#checkBoxRect"
				onclick="checkBoxScript(evt,'DOQ');"/>
				<use id="checkCrossDOQ" xlink:href="#checkBoxCross"
				visibility="visible"/>
			</g>-->
			<!-- checkbox text labels -->
			<g class="allText normalText">
				<text x="12" y="26">Objet SPIP-CARTO</text>
				<text x="12" y="46">Image de fonc</text>
				<!-- Check for WMS <text x="12" y="66">Bassin versant</text>-->
			</g>
		</g>
		<!-- map impressum and status Bar -->
		<g text-rendering="optimizeLegibility">
			<!-- text with this id is required to show help texts -->
			<text id="statusText" class="allText smallText" x="1" y="[(#CALLAGE|getPropMapHeight{600})]">Info: </text>
			<text class="allText smallText" x="1" y="[(#CALLAGE|getPropMapHeight{620})]">Auteur: spip-carto, 2004</text>
			<text class="allText smallText" x="510" y="[(#CALLAGE|getPropMapHeight{620})]">Source: </text>
		</g>
	</g>
	<!-- small reference map, shares the same coordinate system than the main map -->
	<svg id="referenceMap" x="580" y="45" viewBox="[(#CALLAGE|worldfileLRX)] -[(#CALLAGE|worldfileHeight)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" width="118.52" height="[(#CALLAGE|getPropMapHeight{118.52})]" onmousedown="myRefMapDragger.drag(evt)" onmousemove="myRefMapDragger.drag(evt)" onmouseup="myRefMapDragger.drag(evt)" onmouseout="myRefMapDragger.drag(evt)">
		<image id="ShadedRelief" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" width="[(#CALLAGE|worldfileWidth)]" height="[(#CALLAGE|worldfileHeight)]" xlink:href="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" />
		<path pointer-events="none" style="fill:none;stroke:salmon;stroke-width:1000" d="M250528.8 -4218899.3l2380.5 -1305.3l1593.4 928.3l1326.1 -752.7l4218.1 -70.2l4072.3 -3965.5l5552.8 -1556.9l313 -1368.6l3042.8 -2535.6l1098.2 945.4l124.7 2135.2l2579.4 431.2l-22.8 1238l3516.2 779.5l-66.6 -1725.9l1001.7 -419l625.5 2735.2l1659.5 476.6l-330.2 1248.2l1330.8 747.9l-583.6 1341.1l1261.8 -103.1l285.3 729.8l1411.9 -2540.5l552.1 995.2l2360 129.9l1432.7 1622l2981.7 1123.5l2940.7 4333.1l-270.6 1128.2l792.4 1201.5l-1726.7 5827.8l785 2018.2l2160 2274.1l2083.2 772.6l-29.7 1587l2579.8 273.2l2903.1 2611.6l-1211.6 1736.7l-304 2424.3l1806.8 664.5l-952.3 432.8l228.8 1126.8l-1164.6 1204.8l1028.8 823.8l134.5 1768.4l-3601.7 2856.7l-1067.8 2250.5l-1294 1012.3l939.2 1643.7l-426.7 1493.5l-1730.1 1237.5l-1330.5 3254.3l-3443.5 3823l-1377.3 499.3l-1732.6 -647.3l-2658.4 9242.1l-2580.3 -63.8l-1626.7 1640.8l-11817 92.4l-111.4 4297.6l-745.7 11.6l-6670.9 -270.2l-1972.9 -5940.7l-1565.6 -523.5l821.7 -7022.1l-765 -!
 27.8l26.9 -795.4l742.7 19.8l74.1 -825.8l-2396.2 -52l748.7 -3186.1l-3846.4 -78l60.9 -5551.1l-1599 -53.4l110.1 -3306.4l-6584.6 -269.6l-573.6 -4908.1l-895.7 -69.6l-3.4 -3096.9l2384.7 -772.2l99.6 -1566.5l1598.9 3l268.3 -6583.2l-5123.5 -132.5l183.9 -10111.9l1168.6 -4214.1l-716.7 -975.6l1461.4 -2002.8l-593.4 -565.8l2659.9 -3238.9z" />
		<!-- rectangle that represents map extent -->
		<rect id="dragRectForRefMap" class="dragRect" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" width="[(#CALLAGE|worldfileWidth)]" height="[(#CALLAGE|worldfileHeight)]" pointer-events="none"/>
		<!-- if zoomed in very far, we display a cross-symbol here to indicate the map position in the reference map -->
		<use id="myDragCross" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" xlink:href="#myDragCrossSymbol" visibility="hidden" />
	</svg>
	<!-- this group holds symbol instances for navigation tools -->
	<g>
		<!-- empty group where zoomSlider is later appended -->
		<g id="mapZoomSlider"/>
		<text class="allText subTitleText" x="735" y="55">Localisation</text>
		<!-- button for zoom-in, above slider -->
		<use x="710" y="55" xlink:href="#magnifyerZoomInWo" onclick="zoomIt(evt,'in');" onmouseover="magnify(evt,1.2,'in');" onmouseout="magnify(evt,1,'in');"/>
		<!-- button for zoom-out, below slider -->
		<use x="710" y="185" xlink:href="#magnifyerZoomOutWo" onclick="zoomIt(evt,'out');" onmouseover="magnify(evt,1.2,'out');" onmouseout="magnify(evt,1,'out');"/>
		<!-- button for full view (f) -->
		<use x="740" y="85" xlink:href="#magnifyerFull" onclick="zoomIt(evt,'full');" onmouseover="magnify(evt,1.2,'full');" onmouseout="magnify(evt,1,'full');"/>
		<!-- button for manual zoom (rectangle) -->
		<use x="770" y="85" xlink:href="#magnifyerManual" onclick="myMainMap.zoomManual(evt)" onmouseover="magnify(evt,1.2,'manual');" onmouseout="magnify(evt,1,'manual');"/>
		<!-- button for manual pan -->
		<use x="800" y="85" xlink:href="#symbPan" onclick="myMainMap.panManual(evt)" onmouseover="magnify(evt,1.2,'panmanual');" onmouseout="magnify(evt,1,'panmanual');"/>
		<!-- button for redefining map center -->
		<use xlink:href="#symbRecenter" x="830" y="85" onmouseover="magnify(evt,1.2,'recenter')" onmouseout="magnify(evt,1,'recenter')" onclick="myMainMap.recenter(evt)"/>
	</g>
</svg>
</BOUCLE_carte>




From fxp at berlios.de  Tue Mar  1 18:44:20 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:44:20 +0100
Subject: [Spip-carto-cvs] spipcarto carto_geosvg.php3,NONE,1.1
Message-ID: <200503011744.j21HiKNx011452@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv11418

Added Files:
	carto_geosvg.php3 
Log Message:
Interface SVG avanc?e

--- NEW FILE: carto_geosvg.php3 ---
<?php

$fond = "carto_geosvg";
$delais = 24*3600;

include ("inc-public.php3");

?>



From fxp at berlios.de  Tue Mar  1 18:44:33 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:44:33 +0100
Subject: [Spip-carto-cvs] spipcarto carto_geosvgfile.php3,NONE,1.1
Message-ID: <200503011744.j21HiXNx011708@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv11699

Added Files:
	carto_geosvgfile.php3 
Log Message:
Interface SVG avanc?e

--- NEW FILE: carto_geosvgfile.php3 ---
<?php

$fond = "carto_geosvgfile";
$delais = 24*3600;
// cette ligne empeche l'affichage des boutons d'administration
// Et les headers !!!!
$flag_preserver = true;
@header("Content-type: image/svg+xml");

include ("inc-public.php3");

?>


From fxp at berlios.de  Tue Mar  1 18:45:07 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:45:07 +0100
Subject: [Spip-carto-cvs] spipcarto helper_functions.js,NONE,1.1
Message-ID: <200503011745.j21Hj7Nx012403@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv12243

Added Files:
	helper_functions.js 
Log Message:
Interface SVG avanc?e

--- NEW FILE: helper_functions.js ---
/*
ECMAScript helper functions
Copyright (C) <2004>  <Andreas Neumann>
Version 1.1, 2004-11-18
neumann at karto.baug.ethz.ch
http://www.carto.net/
http://www.carto.net/neumann/

Credits: numerous people on svgdevelopers at yahoogroups.com

This ECMA script library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with this library (http://www.carto.net/papers/svg/resources/lesser_gpl.txt); if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

----

original document site: http://www.carto.net/papers/svg/resources/helper_functions.js
Please contact the author in case you want to use code or ideas commercially.
If you use this code, please include this copyright header, the included full
LGPL 2.1 text and read the terms provided in the LGPL 2.1 license
(http://www.gnu.org/copyleft/lesser.txt)

-------------------------------

Please report bugs and send improvements to neumann at karto.baug.ethz.ch
If you use these scripts, please link to the original (http://www.carto.net/papers/svg/navigationTools/)
somewhere in the source-code-comment or the "about" of your project and give credits, thanks!

*/

//global variables necessary to create elements in these namespaces, do not delete them!!!!
var svgNS = "http://www.w3.org/2000/svg";
var xlinkNS = "http://www.w3.org/1999/xlink";
var cartoNS = "http://www.carto.net/attrib";

/* ----------------------- helper functions to calculate stuff ---------------- */
/* ---------------------------------------------------------------------------- */
function toPolarDir(xdiff,ydiff) { // Subroutine for calculating polar Coordinates
   direction = (Math.atan2(ydiff,xdiff));
   //result is angle in radian
   return(direction);
}

function toPolarDist(xdiff,ydiff) { // Subroutine for calculating polar Coordinates
   distance = Math.sqrt(xdiff * xdiff + ydiff * ydiff);
   return(distance);
}

function toRectX(direction,distance) { // Subroutine for calculating cartesic coordinates
   x = distance * Math.cos(direction);
   y = distance * Math.sin(direction);
   return(x);
}

function toRectY(direction,distance) { // Subroutine for calculating cartesic coordinates
   x = distance * Math.cos(direction);
   y = distance * Math.sin(direction);
   return(y);
}

//Converts degrees to radians.
function DegToRad(deg) {
     return (deg / 180.0 * Math.PI);
}

//Converts radians to degrees.
function RadToDeg(rad) {
     return (rad / Math.PI * 180.0);
}

//log functions that do not exist in Math object
function log(x,b) {
	if(b==null) b=Math.E;
	return Math.log(x)/Math.log(b);
}

//gets 4 z-values (4 corners), a position, delta x and delty and a cellsize as input and returns interpolated z-value
function intBilinear(za,zb,zc,zd,xpos,ypos,ax,ay,cellsize) { //bilinear interpolation function
	e = (xpos - ax) / cellsize;
	f = (ypos - ay) / cellsize;

	//calculation of weights
	wa = (1 - e) * (1 - f);
	wb = e * (1 - f);
	wc = e * f;
	wd = f * (1 - e);

	height_interpol = wa * zc + wb * zd + wc * za + wd * zb;

	return (height_interpol);	
}

//test if point is left of or right of, result is 1 (leftof) or 0 (rightof)
function leftOfTest(pointx,pointy,linex1,liney1,linex2,liney2) {
	result = (liney1 - pointy) * (linex2 - linex1) - (linex1 - pointx) * (liney2 - liney1);
	if (result < 0) {
		leftof = 1; //case left of
	}
	else {
		leftof = 0; //case left of	
	}
	return(leftof);
}

//input is point coordinate, and 2 line coordinates
function distFromLine(xpoint,ypoint,linex1,liney1,linex2,liney2) {
	dx = linex2 - linex1;
	dy = liney2 - liney1;
	distance = (dy * (xpoint - linex1) - dx * (ypoint - liney1)) / Math.sqrt(Math.pow(dx,2) + Math.pow(dy,2));
	return(distance);
}

//converts radian value to degrees
function radian2deg(radian) {
	deg = radian / Math.PI * 180;
	return(deg);
}

//input is two vectors (a1,a2 is vector a, b1,b2 is vector b), output is angle in radian
//Formula: Acos from  Scalaproduct of the two vectors divided by ( norm (deutsch Betrag) vector 1 by norm vector 2
//see http://www.mathe-online.at/mathint/vect2/i.html#Winkel
function angleBetwTwoLines(a1,a2,b1,b2) {
	angle = Math.acos((a1 * b1 + a2 * b2) / (Math.sqrt(Math.pow(a1,2) + Math.pow(a2,2)) * Math.sqrt(Math.pow(b1,2) + Math.pow(b2,2))));
	return(angle);
}

//input is two vectors (a1,a2 is vector a, b1,b2 is vector b), output is new vector c2 returned as array
//Formula: Vektor a divided by Norm Vector a (Betrag) plus Vektor b divided by Norm Vector b (Betrag)
//see http://www.mathe-online.at/mathint/vect1/i.html#Winkelsymmetrale
function calcBisectorVector(a1,a2,b1,b2) {
	betraga = Math.sqrt(Math.pow(a1,2) + Math.pow(a2,2));
	betragb = Math.sqrt(Math.pow(b1,2) + Math.pow(b2,2));
	c = new Array();
	c[0] = a1 / betraga + b1 / betragb;
	c[1] = a2 / betraga + b2 / betragb;
	return(c);
}

//input is two vectors (a1,a2 is vector a, b1,b2 is vector b), output is angle in radian
//Formula: Vektor a divided by Norm Vector a (Betrag) plus Vektor b divided by Norm Vector b (Betrag)
//see http://www.mathe-online.at/mathint/vect1/i.html#Winkelsymmetrale
function calcBisectorAngle(a1,a2,b1,b2) {
	betraga = Math.sqrt(Math.pow(a1,2) + Math.pow(a2,2));
	betragb = Math.sqrt(Math.pow(b1,2) + Math.pow(b2,2));
	c1 = a1 / betraga + b1 / betragb;
	c2 = a2 / betraga + b2 / betragb;
	angle = toPolarDir(c1,c2);
	return(angle);
}

function intersect2lines(line1x1,line1y1,line1x2,line1y2,line2x1,line2y1,line2x2,line2y2) {
	//formula see http://astronomy.swin.edu.au/~pbourke/geometry/lineline2d/
	var result = new Array();
	var denominator = (line2y2 - line2y1)*(line1x2 - line1x1) - (line2x2 - line2x1)*(line1y2 - line1y1);
	if (denominator == 0) {
		alert("lines are parallel");
	}
	else {
		ua = ((line2x2 - line2x1)*(line1y1 - line2y1) - (line2y2 - line2y1)*(line1x1 - line2x1)) / denominator;
		ub = ((line1x2 - line1x1)*(line1y1 - line2y1) - (line1y2 - line1y1)*(line1x1 - line2x1)) / denominator;
	}
	result["x"] = line1x1 + ua * (line1x2 - line1x1);
	result["y"] = line1y1 + ua * (line1y2 - line1y1);
	return(result);
}

/* ----------------------- helper function to sort arrays ---------------- */
/* ----------------------------------------------------------------------- */
//my own sort function, uses only first part of string (population value)
function mySort(a,b) {
	var myResulta = a.split("+");
	var myResultb = b.split("+");
	if (parseFloat(myResulta[0]) < parseFloat(myResultb[0])) {
		return 1;
	}
	else {
		return -1;
	}
}

/* ----------------------- helper function format number strings -------------- */
/* ---------------------------------------------------------------------------- */
//formatting number strings
//this function add's "'" to a number every third digit
function formatNumberString(myString) {
	//check if of type string, if number, convert it to string
	if (typeof(myString) == "number") {
		myTempString = myString.toString();
	}
	else {
		myTempString = myString;
	}
	var myNewString="";
	//if it contains a comma, it will be split
	var splitResults = myTempString.split(".");
	var myCounter= splitResults[0].length;
	if (myCounter > 3) {
		while(myCounter > 0) {
			if (myCounter > 3) {
				myNewString = "," + splitResults[0].substr(myCounter - 3,3) + myNewString;
			}
			else {
				myNewString = splitResults[0].substr(0,myCounter) + myNewString;
			}
			myCounter -= 3;
		}
	}
	else {
		myNewString = splitResults[0];
	}
	//concatenate if it contains a comma
	if (splitResults[1]) {
		myNewString = myNewString + "." + splitResults[1];
	}
	return myNewString;
}

//function for status Bar
function statusChange(statusText) {
	document.getElementById("statusText").firstChild.nodeValue = "Info: " + statusText;
}

//scale an object
function scaleObject(evt,factor) {
//reference to the currently selected object
	var element = evt.currentTarget;
	var myX = element.getAttributeNS(null,"x");
	var myY = element.getAttributeNS(null,"y");
	var newtransform = "scale(" + factor + ") translate(" + (myX * 1 / factor - myX) + " " + (myY * 1 / factor - myY) +")";
	element.setAttributeNS(null,'transform', newtransform);
}

//this code is copied from Kevin Lindsey
//http://www.kevlindev.com/tutorials/basics/transformations/toUserSpace/index.htm
function getTransformToRootElement(node) {
 	try {
		//this part is for fully conformant players
		var CTM = node.getTransformToElement(document.documentElement);
	}
	catch (ex) {
		//this part is for ASV3 or other non-conformant players
		// Initialize our CTM the node's Current Transformation Matrix
		var CTM = node.getCTM();
		// Work our way through the ancestor nodes stopping at the SVG Document
		while ( ( node = node.parentNode ) != document ) {
			// Multiply the new CTM to the one with what we have accumulated so far
			CTM = node.getCTM().multiply(CTM);
		}
	}
	return CTM;
}

//calculate HSV 2 RGB: HSV (h 0 to 360, sat and val are between 0 and 1), RGB between 0 and 255
function hsv2rgb(hue,sat,val) {
	//alert("Hue:"+hue);
	var rgbArr = new Array();
	if ( sat == 0) {
		rgbArr["red"] = Math.round(val * 255);
		rgbArr["green"] = Math.round(val * 255);
		rgbArr["blue"] = Math.round(val * 255);
	}
	else {
		var h = hue / 60;
		var i = Math.floor(h);
		var f = h - i;
		if (i % 2 == 0) {
			f = 1 - f;
		}
		var m = val * (1 - sat); 
		var n = val * (1 - sat * f);
		switch(i) {
			case 0:
				rgbArr["red"] = val;
				rgbArr["green"] = n;
				rgbArr["blue"] = m;
				break;
			case 1:
				rgbArr["red"] = n;
				rgbArr["green"] = val;
				rgbArr["blue"] = m;
				break;
			case 2:
				rgbArr["red"] = m;
				rgbArr["green"] = val;
				rgbArr["blue"] = n;
				break;
			case 3:
				rgbArr["red"] = m;
				rgbArr["green"] = n;
				rgbArr["blue"] = val;
				break;
			case 4:
				rgbArr["red"] = n;
				rgbArr["green"] = m;
				rgbArr["blue"] = val;
				break;
			case 5:
				rgbArr["red"] = val;
				rgbArr["green"] = m;
				rgbArr["blue"] = n;
				break;
			case 6:
				rgbArr["red"] = val;
				rgbArr["green"] = n;
				rgbArr["blue"] = m;
				break;
		}
		rgbArr["red"] = Math.round(rgbArr["red"] * 255);
		rgbArr["green"] = Math.round(rgbArr["green"] * 255);
		rgbArr["blue"] = Math.round(rgbArr["blue"] * 255);
	}
	return rgbArr;
}

function rgb2hsv (red,green,blue) {
	//input between 0 and 255 --> normalize to 0 to 1
	//result = 
	var hsvArr = new Array();
	red = red / 255;
	green = green / 255;
	blue = blue / 255;
	myMax = Math.max(red, Math.max(green,blue));
	myMin = Math.min(red, Math.min(green,blue));
	v = myMax;
	if (myMax > 0) {
		s = (myMax - myMin) / myMax;
	}
	else {
		s = 0;
	}
	if (s > 0) {
		myDiff = myMax - myMin;
		rc = (myMax - red) / myDiff;
		gc = (myMax - green) / myDiff;
		bc = (myMax - blue) / myDiff;
		if (red == myMax) {
			h = (bc - gc) / 6;
		}
		if (green == myMax) {
			h = (2 + rc - bc) / 6;
		}
		if (blue == myMax) {
			h = (4 + gc - rc) / 6;
		}
	}
	else {
		h = 0;
	}
	if (h < 0) {
		h += 1;
	}
	hsvArr["hue"] = Math.round(h * 360);
	hsvArr["sat"] = s;
	hsvArr["val"] = v;
	return hsvArr;
}

function assArrayPopulate(arrayKeys,arrayValues) {
	var returnArray = new Array();
	if (arrayKeys.length != arrayValues.length) {
		alert("error: arrays do not have same length!");
	}
	else {
		for (i=0;i<arrayKeys.length;i++) {
			returnArray[arrayKeys[i]] = arrayValues[i];
		}
	}
	return returnArray;
}

function replaceSpecialChars(myString) {
		for (i=161;i<256;i++) {
			re = new RegExp("&#"+i+";","g");
			myString = myString.replace(re,String.fromCharCode(i));
		}
		return myString;
}



From fxp at berlios.de  Tue Mar  1 18:45:29 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Tue, 1 Mar 2005 18:45:29 +0100
Subject: [Spip-carto-cvs] spipcarto navigation.js,NONE,1.1
Message-ID: <200503011745.j21HjTNx012860@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv12797

Added Files:
	navigation.js 
Log Message:
Interface SVG avanc?e

--- NEW FILE: navigation.js ---
/*
Scripts for SVG only webmapping application navigation tools
Copyright (C) <2004>  <Andreas Neumann>
Version 1.02, 2005-02-21
neumann at karto.baug.ethz.ch
http://www.carto.net/
http://www.carto.net/neumann/

Credits: numerous people on svgdevelopers at yahoogroups.com

This ECMA script library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with this library (http://www.carto.net/papers/svg/navigationTools/lesser_gpl.txt); if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

----

current version: 1.02

version history:
1.0 initial version
1.01 added cleanUp() method to map and dragObj objects, some fixes in the documentation
1.02 fixed problems with double clicks, the second click of a double click is now ignored, using the evt.detail property

original document site: http://www.carto.net/papers/svg/navigationTools/
Please contact the author in case you want to use code or ideas commercially.
If you use this code, please include this copyright header, the included full
LGPL 2.1 text and read the terms provided in the LGPL 2.1 license
(http://www.gnu.org/copyleft/lesser.txt)

-------------------------------

Please report bugs and send improvements to neumann at karto.baug.ethz.ch
If you use these scripts, please link to the original (http://www.carto.net/papers/svg/navigationTools/)
somewhere in the source-code-comment or the "about" of your project and give credits, thanks!

*/

//constructor: holds data on map and initializes various references
function map(mapName,maxWidth,minWidth,zoomFact,nrDecimals,units,showCoords,coordXId,coordYId,dynamicLayers,digiLayers,activeDigiLayer) {
	this.mapName = mapName; //id of svg element containing the map geometry
	this.mapSVG = document.getElementById(this.mapName); //reference to nested SVG element holding the map-graphics
	this.mainMapGroup = document.getElementById(this.mapName+"Group"); //group within mainmap - to be transformed when panning manually
	this.dynamicLayers = dynamicLayers; //an associative array holding ids of values that are loaded from the web server dynamically (.getUrl())
	this.nrLayerToLoad = 0; //statusVariable to indicate how many layers are still to load
	this.maxWidth = maxWidth; //max map width
	this.minWidth = minWidth; //min map width, after zooming in
	this.zoomFact = zoomFact; //ratio to zoom in or out in relation to previous viewBox
	this.digiLayers = digiLayers; //references to digiLayers (for digitizing tools)
	this.activeDigiLayer = activeDigiLayer; //active Digi Layer, key is final group id where geometry should be copied to after digitizing
	this.pixXOffset = parseFloat(this.mapSVG.getAttributeNS(null,"x")); //offset from left margin of outer viewBox
	this.pixYOffset = parseFloat(this.mapSVG.getAttributeNS(null,"y")); //offset from top margin of outer viewBox
	var viewBoxArray = this.mapSVG.getAttributeNS(null,"viewBox").split(" ");
	this.curxOrig = parseFloat(viewBoxArray[0]); //holds the current xOrig
	this.curyOrig = parseFloat(viewBoxArray[1]); //holds the current yOrig
	this.curWidth = parseFloat(viewBoxArray[2]); //holds the current map width
	this.curHeight = parseFloat(viewBoxArray[3]); //holds the current map height
	this.pixWidth = parseFloat(this.mapSVG.getAttributeNS(null,"width")); //holds width of the map in pixel coordinates
	this.pixHeight = parseFloat(this.mapSVG.getAttributeNS(null,"height")); //holds height of the map in pixel coordinates
	this.pixSize = this.curWidth / this.pixWidth; //size of a screen pixel in map units
	this.zoomVal = this.maxWidth / this.curWidth * 100; //zoomVal in relation to initial zoom
	this.nrDecimals = nrDecimals; //nr of decimal places to be displayed for show coordinates or accuracy when working with digitizing
	this.navStatus = "false"; //to reset status in navigation
	this.units = units; //holds a string with map units, e.g. "m", alternatively String.fromCharCode(176) for degrees
	this.showCoords = showCoords;
	//initialize coordinate display if showCoords == true
	if (this.showCoords == true) {
		//add event listener for coordinate display
		this.mapSVG.addEventListener("mousemove",this,false);
		if (typeof(coordXId) == "string") {
			this.coordXText = document.getElementById(coordXId).firstChild;
		}
		else {
			alert("Error: coordXId needs to be an id of type string");
		}
		if (typeof(coordYId) == "string") {
			this.coordYText = document.getElementById(coordYId).firstChild;
		}
		else {
			alert("Error: coordYId needs to be an id of type string");
		}
	}
	//create background-element to receive events for showing coordinates
	var myBackgroundRect = document.createElementNS(svgNS,"rect");
	myBackgroundRect.setAttributeNS(null,"x",this.curxOrig);
	myBackgroundRect.setAttributeNS(null,"y",this.curyOrig);
	myBackgroundRect.setAttributeNS(null,"width",this.curWidth);
	myBackgroundRect.setAttributeNS(null,"height",this.curHeight);
	myBackgroundRect.setAttributeNS(null,"fill","white");
	myBackgroundRect.setAttributeNS(null,"stroke","none");
	myBackgroundRect.setAttributeNS(null,"id","mapBackgroundRect");
	this.mainMapGroup.insertBefore(myBackgroundRect,this.mainMapGroup.firstChild);
}

//resets viewBox of main map after zooming and panning
map.prototype.newViewBox = function(refRectId) {
	this.checkAndRemoveTempLayer();
	var myRefRect = document.getElementById(refRectId);
	this.curxOrig = parseFloat(myRefRect.getAttributeNS(null,"x"));
	this.curyOrig = parseFloat(myRefRect.getAttributeNS(null,"y"));
	this.curWidth = parseFloat(myRefRect.getAttributeNS(null,"width"));
	this.curHeight = parseFloat(myRefRect.getAttributeNS(null,"height"));
	var myViewBoxString = this.curxOrig + " " + this.curyOrig + " " + this.curWidth + " " + this.curHeight;
	this.pixSize = this.curWidth / this.pixWidth;
	this.zoomVal = this.maxWidth / this.curWidth * 100;
	this.mapSVG.setAttributeNS(null,"viewBox",myViewBoxString);
	myZoomSlider.setValue(this.curWidth);
	loadProjectSpecific();
}

map.prototype.setNewViewBox = function(xmin,ymin,xmax,ymax) {
	//check if within constraints
	if (xmin < myRefMapDragger.constrXmin) {
		xmin = myRefMapDragger.constrXmin;
	}
	if (xmax > myRefMapDragger.constrXmax) {
		xmax = myRefMapDragger.constrXmin;
	}
	if (ymin < (myRefMapDragger.constrYmax * -1)) {
		ymin = myRefMapDragger.constrYmax * -1;
	}
	if (ymax > (myRefMapDragger.constrYmin * -1)) {
		ymax = myRefMapDragger.constrYmin * -1;
	}
	
	var origWidth = xmax - xmin;
	var origHeight = ymax - ymin;
	var myRatio = this.curWidth/this.curHeight;
	
	if (origWidth / origHeight > myRatio) { //case rect is more wide than ratio
		var newWidth = origWidth;
		var newHeight = origWidth * 1 / myRatio;
		ymin = (ymax + (newHeight - origHeight) / 2) * -1;
	}
	else {
		var newHeight = origHeight;
		var newWidth = newHeight * myRatio;
		xmin = xmin - (newWidth - origWidth) / 2;
		ymin = ymax * -1;
	}
	//check if within constraints
	if (xmin < myRefMapDragger.constrXmin) {
		xmin = myRefMapDragger.constrXmin;
	}
	if (ymin < myRefMapDragger.constrYmin) {
		ymin = myRefMapDragger.constrYmin;
	}
	if ((xmin + newWidth) > myRefMapDragger.constrXmax) {
		xmin = myRefMapDragger.constrXmax - newWidth;
	}
	if ((ymin + newHeight) > myRefMapDragger.constrYmax) {
		ymin = myRefMapDragger.constrYmax - newHeight;
	}		
	myRefMapDragger.newView(xmin,ymin,newWidth,newHeight);
	this.newViewBox(myRefMapDragger.dragId);
}

//handles events associated with navigation
map.prototype.handleEvent = function(evt) {
	var callerId = evt.currentTarget.getAttributeNS(null,"id");
	if (callerId.match(/\bzoomBgRectManual/)) {
		this.zoomManDragRect(evt);
	}
	if (callerId.match(/\bzoomBgRectRecenter/)) {
		this.recenterFinally(evt);
	}
	if (callerId.match(/\bbgPanManual/)) {
		this.panManualFinally(evt);
	}
	if (callerId == "mainMap" && evt.type == "mousemove") {
		this.showCoordinates(evt);
	}
}

//calcs coordinates; relies on myMapApp to handle different window sizes and resizing of windows
map.prototype.calcCoord = function(coordx,coordy) {
	var coords = myMapApp.calcCoord(coordx,coordy);
	var mapCoords = new Array();
	mapCoords["x"] = this.curxOrig + (coords["x"] - this.pixXOffset) * this.pixSize;
	mapCoords["y"] = (this.curyOrig + (coords["y"] - this.pixYOffset) * this.pixSize);
	return mapCoords;
}

//displays x and y coordinates in two separate text elements
map.prototype.showCoordinates = function(evt) {
	var mapCoords = this.calcCoord(evt.clientX,evt.clientY);
	this.coordXText.nodeValue = "X: " + formatNumberString(mapCoords["x"].toFixed(this.nrDecimals)) + this.units;
	this.coordYText.nodeValue = "Y: " + formatNumberString((mapCoords["y"] * -1).toFixed(this.nrDecimals)) + this.units;
}

//chekcs for and removes temporary rectangle objects
map.prototype.checkAndRemoveTempLayer = function() {
	if (this.navStatus != "false") {
		if (this.navStatus == "zoomManual") {
			this.mainMapGroup.removeChild(document.getElementById("zoomBgRectManual"));	
		}
		if (this.navStatus == "recenter") {
			this.mainMapGroup.removeChild(document.getElementById("zoomBgRectRecenter"));	
		}
		if (this.navStatus.match(/\bpanmanual/)) {
			this.mainMapGroup.removeChild(document.getElementById("bgPanManual"));	
		}
		this.navStatus = "false";
	}
}

//starts manual zooming mode
map.prototype.zoomManual = function(evt) {
	if (Math.round(myMainMap.curWidth) > myMainMap.minWidth && evt.detail == 1) {
		this.checkAndRemoveTempLayer();
		this.navStatus = "zoomManual";
		var zoomBgRect = document.createElementNS(svgNS,"rect");
		zoomBgRect.setAttributeNS(null,"x",this.curxOrig);
		zoomBgRect.setAttributeNS(null,"y",this.curyOrig);
		zoomBgRect.setAttributeNS(null,"width",this.curWidth);
		zoomBgRect.setAttributeNS(null,"height",this.curHeight);
		zoomBgRect.setAttributeNS(null,"fill","white");
		zoomBgRect.setAttributeNS(null,"fill-opacity","0.3");
		zoomBgRect.setAttributeNS(null,"stroke","none");
		zoomBgRect.setAttributeNS(null,"id","zoomBgRectManual");
		zoomBgRect.addEventListener("mousedown",this, false);
		zoomBgRect.addEventListener("mousemove",this, false);
		zoomBgRect.addEventListener("mouseup",this, false);
		zoomBgRect.addEventListener("mouseout",this,false);
		this.mainMapGroup.appendChild(zoomBgRect);
		statusChange("Click and drag rectangle (upper left to lower right) for new map extent.");
	}
}

//manages manual zooming by drawing a rectangle
map.prototype.zoomManDragRect = function(evt) {
	var mapCoords = this.calcCoord(evt.clientX,evt.clientY);
	var myX = mapCoords["x"];
	var myY = mapCoords["y"];
	var myYXFact = this.curHeight / this.curWidth;
	if (evt.type == "mousedown") {
		this.manZoomActive = 1;
		this.zoomRect = document.createElementNS(svgNS,"rect");
		var myLineWidth = this.curWidth * 0.003;
		this.zoomRect.setAttributeNS(null,"id","zoomRect");
		this.zoomRect.setAttributeNS(null,"style","fill:darksalmon;fill-opacity:0.5;stroke:dimgray;stroke-width:"+myLineWidth+";stroke-dasharray:"+(myLineWidth*3)+","+myLineWidth);
		this.zoomRect.setAttributeNS(null,"pointer-events","none");
		this.zoomRect.setAttributeNS(null,"x",myX);
		this.zoomRect.setAttributeNS(null,"y",myY);
		this.zoomRect.setAttributeNS(null,"width",this.minWidth);
		this.zoomRect.setAttributeNS(null,"height",this.minWidth * myYXFact);
		this.mainMapGroup.appendChild(this.zoomRect);
		this.zoomRectOrigX = myX;
		this.zoomRectOrigY = myY;
	}
	if (evt.type == "mousemove" && this.manZoomActive == 1) {
		var myZoomWidth = myX - this.zoomRectOrigX;
		if (myZoomWidth < 0) {
			if (Math.abs(myZoomWidth) < this.minWidth) {
				this.zoomRect.setAttributeNS(null,"x",this.zoomRectOrigX - this.minWidth);
				this.zoomRect.setAttributeNS(null,"y",this.zoomRectOrigY - this.minWidth * myYXFact);
				this.zoomRect.setAttributeNS(null,"width",this.minWidth);
				this.zoomRect.setAttributeNS(null,"height",this.minWidth * myYXFact);
			}
			else {
				this.zoomRect.setAttributeNS(null,"x",myX);
				this.zoomRect.setAttributeNS(null,"y",this.zoomRectOrigY - Math.abs(myZoomWidth) * myYXFact);
				this.zoomRect.setAttributeNS(null,"width",Math.abs(myZoomWidth));
				this.zoomRect.setAttributeNS(null,"height",Math.abs(myZoomWidth) * myYXFact);			
			}
		}
		else {
			this.zoomRect.setAttributeNS(null,"x",this.zoomRectOrigX);
			this.zoomRect.setAttributeNS(null,"y",this.zoomRectOrigY);
			if (myZoomWidth < this.minWidth) {
				this.zoomRect.setAttributeNS(null,"width",this.minWidth);
				this.zoomRect.setAttributeNS(null,"height",this.minWidth * myYXFact);		
			}
			else {
				this.zoomRect.setAttributeNS(null,"width",myZoomWidth);
				this.zoomRect.setAttributeNS(null,"height",myZoomWidth * myYXFact);
			}
		}
	}
	if ((evt.type == "mouseup" || evt.type == "mouseout") && this.manZoomActive == 1) {
		this.manZoomActive = 0;
		this.navStatus = "false";
		if (parseFloat(this.zoomRect.getAttributeNS(null,"width")) > this.curWidth * 0.02) {
			myRefMapDragger.newView(parseFloat(this.zoomRect.getAttributeNS(null,"x")),parseFloat(this.zoomRect.getAttributeNS(null,"y")),parseFloat(this.zoomRect.getAttributeNS(null,"width")),parseFloat(this.zoomRect.getAttributeNS(null,"height")));
			this.newViewBox(myRefMapDragger.dragId);
		}
		this.mainMapGroup.removeChild(this.zoomRect);
		this.mainMapGroup.removeChild(document.getElementById("zoomBgRectManual"));
		statusChange("map ready");
	}
}

//initializes recentering mode
map.prototype.recenter = function(evt) {
	if (evt.detail == 1) {
		this.checkAndRemoveTempLayer();
		this.navStatus = "recenter";
		var zoomBgRect = document.createElementNS(svgNS,"rect");
		zoomBgRect.setAttributeNS(null,"x",this.curxOrig);
		zoomBgRect.setAttributeNS(null,"y",this.curyOrig);
		zoomBgRect.setAttributeNS(null,"width",this.curWidth);
		zoomBgRect.setAttributeNS(null,"height",this.curHeight);
		zoomBgRect.setAttributeNS(null,"fill","white");
		zoomBgRect.setAttributeNS(null,"fill-opacity","0.3");
		zoomBgRect.setAttributeNS(null,"stroke","none");
		zoomBgRect.setAttributeNS(null,"id","zoomBgRectRecenter");
		zoomBgRect.addEventListener("click",this, false);
		this.mainMapGroup.appendChild(zoomBgRect);
		statusChange("Click in map to define new map center.");
	}
}

//finishes recentering after mouse-click
map.prototype.recenterFinally = function(evt) {
	if (evt.type == "click") {
		var mapCoords = this.calcCoord(evt.clientX,evt.clientY);
		var myX = mapCoords["x"];
		var myY = mapCoords["y"];
		var myNewX = myX - this.curWidth / 2;
		var myNewY = myY - this.curHeight / 2;
		
		//check if within constraints
		if (myNewX < myRefMapDragger.constrXmin) {
			myNewX = myRefMapDragger.constrXmin;
		}
		if (myNewY < myRefMapDragger.constrYmin) {
			myNewY = myRefMapDragger.constrYmin;
		}
		if ((myNewX + this.curWidth) > myRefMapDragger.constrXmax) {
			myNewX = myRefMapDragger.constrXmax - this.curWidth;
		}
		if ((myNewY + this.curHeight) > myRefMapDragger.constrYmax) {
			myNewY = myRefMapDragger.constrYmax - this.curHeight;
		}
		myRefMapDragger.newView(myNewX,myNewY,this.curWidth,this.curHeight);
		this.navStatus = "false";
		this.newViewBox(myRefMapDragger.dragId);
			
		this.mainMapGroup.removeChild(document.getElementById("zoomBgRectRecenter"));
		statusChange("map ready");
	}
}

//initializes manual panning
map.prototype.panManual = function(evt) {
	if (evt.detail == 1) {
		this.checkAndRemoveTempLayer();
		this.navStatus = "panmanual";
		//draw a temporary over whole map to avoid interference with existing events
		var myBackgroundRect = document.getElementById("mapBackgroundRect");
		var panManRect = document.createElementNS(svgNS,"rect");
		panManRect.setAttributeNS(null,"x",myBackgroundRect.getAttributeNS(null,"x"));
		panManRect.setAttributeNS(null,"y",myBackgroundRect.getAttributeNS(null,"y"));
		panManRect.setAttributeNS(null,"width",myBackgroundRect.getAttributeNS(null,"width"));
		panManRect.setAttributeNS(null,"height",myBackgroundRect.getAttributeNS(null,"height"));
		panManRect.setAttributeNS(null,"fill","white");
		panManRect.setAttributeNS(null,"fill-opacity","0.3");
		panManRect.setAttributeNS(null,"stroke","none");
		panManRect.setAttributeNS(null,"id","bgPanManual");
		panManRect.addEventListener("mousedown",this, false);
		panManRect.addEventListener("mousemove",this, false);
		panManRect.addEventListener("mouseup",this, false);
		panManRect.addEventListener("mouseout",this, false);
		this.mainMapGroup.appendChild(panManRect);
		statusChange("Mouse down and move to pan the map, up to load current view.");
	}
}

//manages and finishes manual panning
map.prototype.panManualFinally = function(evt) {
	if (evt.type == "mousedown") {
		this.navStatus = "panmanualActive";
		this.panCoords = this.calcCoord(evt.clientX,evt.clientY);
	}
	if (evt.type == "mousemove" && this.navStatus == "panmanualActive") {
		var mapCoords = this.calcCoord(evt.clientX,evt.clientY);
		var diffX = this.panCoords["x"] - mapCoords["x"];
		var diffY = this.panCoords["y"] - mapCoords["y"];
		var myNewX = this.curxOrig + diffX;
		var myNewY = this.curyOrig + diffY;
		//check if within constraints
		if (myNewX < myRefMapDragger.constrXmin) {
			var myNewXTemp = myRefMapDragger.constrXmin;
			diffX = diffX + (myNewXTemp - myNewX);
			myNewX = myNewXTemp;
		}
		if (myNewY < myRefMapDragger.constrYmin) {
			var myNewYTemp = myRefMapDragger.constrYmin;
			diffY = diffY + (myNewYTemp - myNewY);
			myNewY = myNewYTemp;
		}
		if ((myNewX + this.curWidth) > myRefMapDragger.constrXmax) {
			var myNewXTemp = myRefMapDragger.constrXmax - this.curWidth;
			diffX = diffX + (myNewXTemp - myNewX);
			myNewX = myNewXTemp;
		}
		if ((myNewY + this.curHeight) > myRefMapDragger.constrYmax) {
			var myNewYTemp = myRefMapDragger.constrYmax - this.curHeight;
			diffY = diffY + (myNewYTemp - myNewY);
			myNewY = myNewYTemp;
		}		
		var transformString = "translate("+(diffX * -1) +","+(diffY * -1)+")";
		this.mainMapGroup.setAttributeNS(null,"transform",transformString);
		myRefMapDragger.newView(myNewX,myNewY,this.curWidth,this.curHeight);
	}
	if ((evt.type == "mouseup" || evt.type == "mouseout") && this.navStatus == "panmanualActive") {
		this.navStatus = "false";
		this.mainMapGroup.setAttributeNS(null,"transform","translate(0,0)");
		this.newViewBox(myRefMapDragger.dragId);			
		this.mainMapGroup.removeChild(document.getElementById("bgPanManual"));
		statusChange("map ready");	
	}
}

//remove all temporarily added elements and event listeners
map.prototype.cleanUp = function() {
			//remove background rect
			var oldBackground = document.getElementById("mapBackgroundRect");

			oldBackground.parentNode.removeChild(oldBackground);
			//remove eventlisteners
			if (this.showCoords == true) {
				//add event listener for coordinate display
				this.mapSVG.removeEventListener("mousemove",this,false);
			}

}

//make an element (rectangle) draggable within constraints
function dragObj(dragId,referenceMap,myDragSymbol,dragSymbThreshold,showCoords,coordXId,coordYId,mainMapObj) {
	this.dragId = dragId;
	this.myDragger = document.getElementById(this.dragId);
	this.myRefMap = document.getElementById(referenceMap);
	this.myDragSymbol = document.getElementById(myDragSymbol);	
	this.dragSymbThreshold = dragSymbThreshold;
	var viewBox = this.myRefMap.getAttributeNS(null,"viewBox").split(" ");
	this.constrXmin = parseFloat(viewBox[0]);
	this.constrYmin = parseFloat(viewBox[1]);
	this.constrXmax = this.constrXmin + parseFloat(viewBox[2]);
	this.constrYmax = this.constrYmin + parseFloat(viewBox[3]);
	this.refMapX = parseFloat(this.myRefMap.getAttributeNS(null,"x"));
	this.refMapY = parseFloat(this.myRefMap.getAttributeNS(null,"y"));
	this.refMapWidth = parseFloat(this.myRefMap.getAttributeNS(null,"width"));
	this.pixSize = (this.constrXmax - this.constrXmin) / this.refMapWidth;
	this.mainMapObj = mainMapObj;
	//initialize coordinate display if showCoords == true
	this.showCoords = showCoords;
	if (this.showCoords == true) {
		//add event listener for coordinate display
		this.myRefMap.addEventListener("mousemove",this,false);
		if (typeof(coordXId) == "string") {
			this.coordXText = document.getElementById(coordXId).firstChild;
		}
		else {
			alert("Error: coordXId needs to be an id of type string");
		}
		if (typeof(coordYId) == "string") {
			this.coordYText = document.getElementById(coordYId).firstChild;
		}
		else {
			alert("Error: coordYId needs to be an id of type string");
		}
	}
	this.status = false;
}

dragObj.prototype.calcCoord = function(coordx,coordy) {
	var coords = myMapApp.calcCoord(coordx,coordy);
	var mapCoords = new Array();
	mapCoords["x"] = this.constrXmin + (coords["x"] - this.refMapX) * this.pixSize;
	mapCoords["y"] = this.constrYmin + ((coords["y"]) - this.refMapY) * this.pixSize;
	return mapCoords;
}

dragObj.prototype.handleEvent = function(evt) {
	if (evt.type == "mousemove") {
		var mapCoords = this.calcCoord(evt.clientX,evt.clientY);
		this.coordXText.nodeValue = "X: " + formatNumberString(mapCoords["x"].toFixed(this.mainMapObj.nrDecimals)) + this.mainMapObj.units;
		this.coordYText.nodeValue = "Y: " + formatNumberString((mapCoords["y"] * -1).toFixed(this.mainMapObj.nrDecimals)) + this.mainMapObj.units;
	}
}

dragObj.prototype.newView = function(x,y,width,height) {
	this.myDragger.setAttributeNS(null,"x",x);
	this.myDragger.setAttributeNS(null,"y",y);
	this.myDragger.setAttributeNS(null,"width",width);
	this.myDragger.setAttributeNS(null,"height",height);
	this.myDragSymbol.setAttributeNS(null,"x",(x + width/2));
	this.myDragSymbol.setAttributeNS(null,"y",(y + height/2));
	if (width < this.dragSymbThreshold) {
		this.myDragSymbol.setAttributeNS(null,"visibility","visible");
	}
	else {
		this.myDragSymbol.setAttributeNS(null,"visibility","hidden");	
	}
}

dragObj.prototype.resizeDragger = function(status,sliderGroupName,width) {
	var myX = parseFloat(this.myDragger.getAttributeNS(null,"x"));
	var myY = parseFloat(this.myDragger.getAttributeNS(null,"y"));
	var myWidth = parseFloat(this.myDragger.getAttributeNS(null,"width"));
	var myHeight = parseFloat(this.myDragger.getAttributeNS(null,"height"));
	var myCenterX = myX + myWidth / 2;
	var myCenterY = myY + myHeight / 2;
	var myRatio = myHeight / myWidth;
	var toMoveX = myCenterX - width / 2;
	var toMoveY = myCenterY - width * myRatio / 2;
	if (toMoveX < this.constrXmin) {
		toMoveX = this.constrXmin;
	}
	if ((toMoveX + width) > this.constrXmax) {
		toMoveX = this.constrXmax - width;
	}
	if (toMoveY < this.constrYmin) {
		toMoveY = this.constrYmin;
	}
	if ((toMoveY + width * myRatio) > this.constrYmax) {
		toMoveY = this.constrYmax - width * myRatio;
	}
	this.newView(toMoveX,toMoveY,width,width * myRatio);
	if (status == "release") {
		this.mainMapObj.newViewBox(this.dragId);
	}
}

dragObj.prototype.drag = function(evt) {
	if (evt.type == "mousedown") {
		this.status = true;
	}
	if ((evt.type == "mousemove" || evt.type == "mousedown") && this.status == true) {
		var coords = this.calcCoord(evt.clientX,evt.clientY);
		var newEvtX = coords["x"];
		var newEvtY = coords["y"];
		var myX = parseFloat(this.myDragger.getAttributeNS(null,"x"));
		var myY = parseFloat(this.myDragger.getAttributeNS(null,"y"));
		var myWidth = parseFloat(this.myDragger.getAttributeNS(null,"width"));
		var myHeight = parseFloat(this.myDragger.getAttributeNS(null,"height"));
		var toMoveX = newEvtX - myWidth / 2;
		var toMoveY = newEvtY - myHeight / 2;
		if (toMoveX < this.constrXmin) {
			toMoveX = this.constrXmin;
		}
		if ((toMoveX + myWidth) > this.constrXmax) {
			toMoveX = this.constrXmax - myWidth;
		}
		if (toMoveY < this.constrYmin) {
			toMoveY = this.constrYmin;
		}
		if ((toMoveY + myHeight) > this.constrYmax) {
			toMoveY = this.constrYmax - myHeight;
		}
		this.newView(toMoveX,toMoveY,myWidth,myHeight);
	}
	if ((evt.type == "mouseup" || evt.type == "mouseout") && this.status == true) {
		this.status = false;
		if (evt.detail == 1) { //second click is ignored
			this.mainMapObj.newViewBox('dragRectForRefMap')
		}
	}
}

dragObj.prototype.zoom = function(inOrOut) {
	var myOldX = this.myDragger.getAttributeNS(null,"x");
	var myOldY = this.myDragger.getAttributeNS(null,"y");
	var myOldWidth = this.myDragger.getAttributeNS(null,"width");
	var myOldHeight = this.myDragger.getAttributeNS(null,"height");
	switch (inOrOut) {
		case "in":
			var myNewX = parseFloat(myOldX) + myOldWidth / 2 - (myOldWidth * this.mainMapObj.zoomFact * 0.5);
			var myNewY = parseFloat(myOldY) + myOldHeight / 2 - (myOldHeight * this.mainMapObj.zoomFact * 0.5);
			var myNewWidth = myOldWidth * this.mainMapObj.zoomFact;
			var myNewHeight = myOldHeight * this.mainMapObj.zoomFact;
			if (myNewWidth < this.mainMapObj.minWidth) {
				var myYXFact = this.mainMapObj.curHeight / this.mainMapObj.curWidth;
				myNewWidth = this.mainMapObj.minWidth;
				myNewHeight = myNewWidth * myYXFact;
				myNewX = parseFloat(myOldX) + myOldWidth / 2 - (myNewWidth * 0.5);
				myNewY = parseFloat(myOldY) + myOldHeight / 2 - (myNewHeight * 0.5);
			}
			break;
		case "out":
			var myNewX = parseFloat(myOldX) + myOldWidth / 2 - (myOldWidth * (1 + this.mainMapObj.zoomFact) * 0.5);
			var myNewY = parseFloat(myOldY) + myOldHeight / 2 - (myOldHeight * (1 + this.mainMapObj.zoomFact) * 0.5);
			var myNewWidth = myOldWidth * (1 + this.mainMapObj.zoomFact);
			var myNewHeight = myOldHeight * (1 + this.mainMapObj.zoomFact);
			break;
		default:
			var myNewX = this.constrXmin;
			var myNewY = this.constrYmin;
			var myNewWidth = this.constrXmax - this.constrXmin;
			var myNewHeight = this.constrYmax - this.constrYmin;
			break;
	}	
	//check if within constraints
	if (myNewWidth > (this.constrXmax - this.constrXmin)) {
		myNewWidth = this.constrXmax - this.constrXmin;
	}
	if (myNewHeight > (this.constrYmax - this.constrYmin)) {
		myNewHeight = this.constrYmax - this.constrYmin;
	}
	if (myNewX < this.constrXmin) {
		myNewX = this.constrXmin;
	}
	if (myNewY < this.constrYmin) {
		myNewY = this.constrYmin;
	}
	if ((myNewX + myNewWidth) > this.constrXmax) {
		myNewX = this.constrXmax - myNewWidth;
	}
	if ((myNewY + myNewHeight) > this.constrYmax) {
		myNewY = this.constrYmax - myNewHeight;
	}
	//alert(myNewX+", "+myNewY+", "+myNewWidth+", "+myNewHeight);
	this.newView(myNewX,myNewY,myNewWidth,myNewHeight);
	this.mainMapObj.newViewBox(this.dragId);
}

dragObj.prototype.pan = function (myX,myY,howmuch) {
	//get values from draggable rectangle
	var xulcorner = parseFloat(this.myDragger.getAttributeNS(null,"x"));
	var yulcorner = parseFloat(this.myDragger.getAttributeNS(null,"y"));
	var width = parseFloat(this.myDragger.getAttributeNS(null,"width"));
	var height = parseFloat(this.myDragger.getAttributeNS(null,"height"));

	//set values of draggable rectangle
	var rectXulcorner = xulcorner + howmuch * width * myX;
	var rectYulcorner = yulcorner + howmuch * height * myY;
	//check if within constraints
	if (rectXulcorner < this.constrXmin) {
		rectXulcorner = this.constrXmin;
	}
	if (rectYulcorner < this.constrYmin) {
		rectYulcorner = this.constrYmin;
	}
	if ((rectXulcorner + width) > this.constrXmax) {
		rectXulcorner = this.constrXmax - width;
	}
	if ((rectYulcorner + height) > this.constrYmax) {
		rectYulcorner = this.constrYmax - height;
	}
	this.newView(rectXulcorner,rectYulcorner,width,height);

	//set viewport of main map
	if ((xulcorner != rectXulcorner) || (yulcorner != rectYulcorner)) {
		this.mainMapObj.newViewBox(this.dragId);
	}

	statusChange("map ready ...");
}

//remove all temporarily used elements and event listeners
dragObj.prototype.cleanUp = function() {
			//remove eventlisteners
			if (this.showCoords == true) {
				//add event listener for coordinate display
				this.myRefMap.removeEventListener("mousemove",this,false);
			}

}

//magnifier glass mouse-over effects
function magnify(evt,scaleFact,inOrOut) {
	if (inOrOut == "in") {
		if (Math.round(myMainMap.curWidth) > myMainMap.minWidth) {
			statusChange("click to zoom in ");
			scaleObject(evt,scaleFact);
		}
		else {
			statusChange("maximum zoom factor reached! cannot zoom in any more!");
		}
	}
	if (inOrOut == "out") {
		if (Math.round(myMainMap.curWidth) < myMainMap.maxWidth) {
			statusChange("click to zoom out");
			scaleObject(evt,scaleFact);
		}
		else {
			statusChange("Minimum zoom factor reached. Cannot zoom out any more.");
		}
	}
	if (inOrOut == "manual") {
		if (Math.round(myMainMap.curWidth) > myMainMap.minWidth) {
			statusChange("Click and Drag Rectangle in main map.");
			scaleObject(evt,scaleFact);
		}
		else {
			statusChange("Maximum zoom factor reached. Cannot zoom in any more.");
		}
	}
	if (inOrOut == "full") {
		if (Math.round(myMainMap.curWidth) < myMainMap.maxWidth) {
			statusChange("click to set full view");
			scaleObject(evt,scaleFact);
		}
		else {
			statusChange("full view already reached");
		}
	}
	if (inOrOut == "panmanual") {
			statusChange("click to start panning map");
			scaleObject(evt,scaleFact);	
	}
	if (inOrOut == "recenter") {
			statusChange('Click to define new Map center');
			scaleObject(evt,scaleFact);
	}	
	if (scaleFact == 1) {
		statusChange("map ready");
		scaleObject(evt,scaleFact);
	}
}

function zoomIt(evt,inOrOut) {
	if (evt.detail == 1) { //only react on first click, double click: second click is ignored
		if (inOrOut == "in") {
			if (Math.round(myMainMap.curWidth) > myMainMap.minWidth) {
				myRefMapDragger.zoom("in");
			}
			else {
				statusChange("Maximum zoom factor reached. Cannot zoom in any more.");
			}
		}
		if (inOrOut == "out") {
			if (Math.round(myMainMap.curWidth) < myMainMap.maxWidth) {
				myRefMapDragger.zoom("out");
			}
			else {
				statusChange("Minimum zoom factor reached. Cannot zoom out any more.");
			}
		}
		if (inOrOut == "full") {
			//if (Math.round(myMainMap.curWidth) < myMainMap.maxWidth) {
				myRefMapDragger.zoom("full");
			/*}
			else {
				statusChange("Full view already reached.");
			}*/
		}
	}
}

//alert map extent
function showExtent() {
	with(myMainMap) {
		alert("Xmin="+curxOrig.toFixed(nrDecimals)+units+"; Xmax="+(curxOrig + curWidth).toFixed(nrDecimals)+units+"\nYmin="+((curyOrig + curHeight) * -1).toFixed(nrDecimals) +units+"; Ymax="+(curyOrig*-1).toFixed(nrDecimals)+units+"\nWidth="+curWidth.toFixed(nrDecimals)+units+"; Height="+curHeight.toFixed(nrDecimals)+units);
	}
}


From stef at berlios.de  Thu Mar  3 15:53:20 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 3 Mar 2005 15:53:20 +0100
Subject: [Spip-carto-cvs] spipcarto/formulaires inc-formulaire_site.php3,1.2,1.3 formulaire_ecrire_auteur.html,1.2,1.3 inc-formulaire_forum.php3,1.2,1.3 inc-formulaire_ecrire_auteur.php3,1.2,1.3 inc-formulaire_signature.php3,1.2,1.3 formulaire_forum.html,1.2,1.3 formulaire_signature.html,1.2,1.3 inc-formulaire_inscription.php3,1.2,1.3 formulaire_admin.html,1.2,1.3 inc-login_public.php3,1.2,1.3
Message-ID: <200503031453.j23ErKNx006379@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/formulaires
In directory sheep:/tmp/cvs-serv6354/spipcarto/formulaires

Modified Files:
	inc-formulaire_site.php3 formulaire_ecrire_auteur.html 
	inc-formulaire_forum.php3 inc-formulaire_ecrire_auteur.php3 
	inc-formulaire_signature.php3 formulaire_forum.html 
	formulaire_signature.html inc-formulaire_inscription.php3 
	formulaire_admin.html inc-login_public.php3 
Log Message:
1.8pr1 cvs 20050303

Index: inc-formulaire_site.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_site.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-formulaire_site.php3	20 Feb 2005 22:13:52 -0000	1.2
+++ inc-formulaire_site.php3	3 Mar 2005 14:53:17 -0000	1.3
@@ -19,7 +19,7 @@
 	return ((lire_meta("proposer_sites") != 2) ? '' : $args);
 }
 
-function balise_FORMULAIRE_SITE_dyn($id_rubrique, $nom_site, $url_site, $description_site) {
+function balise_FORMULAIRE_SITE_dyn($id_rubrique) {
 
 	if (!_request('nom_site')) return array('formulaire_site', 0);
 

Index: formulaire_ecrire_auteur.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_ecrire_auteur.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- formulaire_ecrire_auteur.html	20 Feb 2005 22:13:52 -0000	1.2
+++ formulaire_ecrire_auteur.html	3 Mar 2005 14:53:17 -0000	1.3
@@ -1,6 +1,7 @@
 [<br />(#ENV*{sujetko})<:form_prop_indiquer_sujet:><br />&nbsp;][
 <br />(#ENV*{mailko})<:form_prop_indiquer_email:><br /><br />
-]<form action="[(#ENV{action})]" method='post'>
+]<form action="[(#ENV{action})]" method='post'>[
+<input type="hidden" name="id_formulaire_ecrire_auteur" value="(#ENV{valide})" />]
 <p><label><:form_pet_votre_email:>
 <input type="text" class="forml" name="email_message_auteur[(#ENV{id})]"
 	value="[(#ENV{mail})]" size="30" />
@@ -13,7 +14,7 @@
 <textarea name="texte_message_auteur[(#ENV{id})]" rows='10' class='forml' cols='40'>[(#ENV{texte})]</textarea>
 </p>
 <div align="right">
-	<input type="submit"  class="spip_bouton" name="valide[(#ENV{id})]"
-		 value="[(#ENV{valide})]" />
+	<input type="submit"  class="spip_bouton" name="valide"
+		 value="[(#ENV{bouton})]" />
 </div>
 </form>

Index: inc-formulaire_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_forum.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-formulaire_forum.php3	20 Feb 2005 22:13:52 -0000	1.2
+++ inc-formulaire_forum.php3	3 Mar 2005 14:53:17 -0000	1.3
@@ -40,7 +40,11 @@
 	if (!$r = sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids))
 		return '';
 
-	list($titre, $table, $forums_publics) = $r;
+	list ($titre, $table, $forums_publics) = $r;
+
+	// Attention id_rubrique est passe pour les articles => on n'en veut pas
+	if ($idr > 0 AND ($ida OR $idb OR $ids))
+		$idr = 0;
 
 	return
 		array($titre, $table, $forums_publics, $idr, $idf, $ida, $idb, $ids,
@@ -48,8 +52,15 @@
 }
 
 function balise_FORMULAIRE_FORUM_dyn($titre, $table, $forums_publics, $id_rubrique, $id_forum, $id_article, $id_breve, $id_syndic, $url) {
+	global $REMOTE_ADDR, $afficher_texte, $_COOKIE, $_POST;
 
-	global $REMOTE_ADDR, $afficher_texte, $_COOKIE;
+	// Recuperer les donnees postees du formulaire ou, a defaut, du contexte
+	foreach (array('id_article', 'id_breve', 'id_syndic',
+	'id_rubrique', 'id_forum') as $id)
+		if (isset($_POST['forum_'.$id]))
+			$$id = intval($_POST['forum_'.$id]);
+		else
+			$$id = intval($$id);
 
 	// url de reference
 	if (!$url) {
@@ -76,12 +87,6 @@
 		return array('formulaire_login_forum', 0, array());
 	}
 
-	$id_rubrique = intval($id_rubrique);
-	$id_forum = intval($id_forum);
-	$id_article = intval($id_article);
-	$id_breve = intval($id_breve);
-	$id_syndic = intval($id_syndic);
-
 	// ne pas mettre '', sinon le squelette n'affichera rien.
 	$previsu = ' ';
 
@@ -208,22 +213,33 @@
 	else
 		$table = '';
 
+	// preparer les parametres du forum en input hidden
+	$parametres_forum = '';
+	foreach (array('alea', 'hash', 'retour_forum') as $var)
+		if ($val = entites_html($$var))
+			$parametres_forum .=
+			"<input type='hidden' name='$var' value=\"$val\" />\n";
+	foreach (array(
+	'id_article', 'id_breve', 'id_syndic', 'id_rubrique', 'id_forum')
+	as $var)
+		if ($val = $$var)
+			$parametres_forum .=
+			"<input type='hidden' name='forum_$var' value='$val' />\n";
+
 	return array('formulaire_forum', 0,
 	array(
-		'alea' => $alea,
 		'auteur' => $auteur,
 		'disabled' => ($forums_publics == "abo")? " disabled='disabled'" : '',
 		'email_auteur' => $email_auteur,
-		'hash' => $hash,
 		'modere' => (($forums_publics != 'pri') ? '' : _T('forum_info_modere')),
 		'nom_site_forum' => $nom_site_forum,
 		'previsu' => $previsu,
-		'retour_forum' => $retour_forum,
 		'table' => $table,
 		'texte' => $texte,
 		'titre' => $titre,
 		'url' =>  $url,
 		'url_site' => ($url_site ? $url_site : "http://"),
+		'parametres_forum' => $parametres_forum,
 
 		## gestion des la variable de personnalisation $afficher_texte
 		# mode normal : afficher le texte en < input text >, cf. squelette
@@ -347,10 +363,7 @@
 function sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids) {
 
 	// changer la table de reference s'il y a lieu (pour afficher_groupes[] !!)
-	if ($idr) {
-		$r = "SELECT titre FROM spip_rubriques WHERE id_rubrique = $idr";
-		$table = "rubriques";
-	} else if ($ida) {
+	if ($ida) {
 		$r = "SELECT titre FROM spip_articles WHERE id_article = $ida";
 		$table = "articles";
 	} else if ($idb) {
@@ -359,6 +372,9 @@
 	} else if ($ids) {
 		$r = "SELECT nom_site AS titre FROM spip_syndic WHERE id_syndic = $ids";
 		$table = "syndic";
+	} else if ($idr) {
+		$r = "SELECT titre FROM spip_rubriques WHERE id_rubrique = $idr";
+		$table = "rubriques";
 	}
 
 	if ($idf)
@@ -366,7 +382,7 @@
 
 	if ($r) {
 		list($titre) = spip_fetch_array(spip_query($r));
-		$titre = '> ' . supprimer_numero($titre);
+		$titre = '> ' . supprimer_numero(preg_replace('/^> /', '', $titre));
 	} else {
 		$titre = _T('forum_titre_erreur');
 		$table = '';

Index: inc-formulaire_ecrire_auteur.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_ecrire_auteur.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-formulaire_ecrire_auteur.php3	20 Feb 2005 22:13:52 -0000	1.2
+++ inc-formulaire_ecrire_auteur.php3	3 Mar 2005 14:53:17 -0000	1.3
@@ -45,16 +45,18 @@
 
 	// id du formulaire (pour en avoir plusieurs sur une meme page)
 	$id = ($id_auteur ? '_'.$id_auteur : '_ar'.$id_article);
-
+	#spip_log("id formulaire = $id, "._request("valide".$id));
 	$sujet = _request('sujet_message_auteur'.$id);
 	$texte = _request('texte_message_auteur'.$id);
 	$adres = _request('email_message_auteur'.$id);
 
 	$mailko = $texte && !email_valide($adres);
+
 	$validable = $texte && $sujet && (!$mailko);
 
+	// doit-on envoyer le mail ?
 	if ($validable
-	AND (_request('valide'.$id) == _T('form_prop_confirmer_envoi'))) { 
+	AND $id == _request('id_formulaire_ecrire_auteur')) { 
 		$texte .= "\n\n-- "._T('envoi_via_le_site')." ".lire_meta('nom_site')." (".lire_meta('adresse_site')."/) --\n";
 		include_ecrire("inc_mail.php3");
 		envoyer_mail($mail, $sujet, $texte, $adres,
@@ -66,7 +68,7 @@
 	$link->delVar('sujet_message_auteur'.$id);
 	$link->delVar('texte_message_auteur'.$id);
 	$link->delVar('email_message_auteur'.$id);
-	$link->delVar('id_auteur');
+	$link->delVar('id_formulaire_ecrire_auteur');
 
 	return 
 		array('formulaire_ecrire_auteur', 0,
@@ -78,7 +80,8 @@
 			'sujetko' => ($texte && !$sujet) ? $puce : '',
 			'sujet' => $sujet,
 			'texte' => $texte,
-			'valide' => ($validable ?
+			'valide' => ($validable ? $id : ''),
+			'bouton' => ($validable ?
 				_T('form_prop_confirmer_envoi') :
 				_T('form_prop_envoyer'))
 			)

Index: inc-formulaire_signature.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_signature.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-formulaire_signature.php3	20 Feb 2005 22:13:52 -0000	1.2
+++ inc-formulaire_signature.php3	3 Mar 2005 14:53:17 -0000	1.3
@@ -30,13 +30,23 @@
 	else if (!$args[1])
 		return '';
 
-	else
+	else {
+		// aller chercher dans la base la petition associee
+		$s = spip_query("SELECT texte, site_obli, message
+			FROM spip_petitions WHERE id_article = ".intval($args[0]));
+		if ($r = spip_fetch_array($s)) {
+			$args[2] = $r['texte'];
+			// le signataire doit-il donner un site ?
+			$args[3] = ($r['site_obli'] == 'oui') ? '':' ';
+			// le signataire peut-il proposer un commentaire
+			$args[4] = ($r['message'] == 'oui') ? ' ':'';
+		}
 		return $args;
+	}
 }
 
 // Executer la balise
-function balise_FORMULAIRE_SIGNATURE_dyn($id_article, $petition) {
-	include_local(_FILE_CONNECT);
+function balise_FORMULAIRE_SIGNATURE_dyn($id_article, $petition, $texte, $site_obli, $message) {
 
 	if (_request('var_confirm')) # _GET
 		return reponse_confirmation($id_article);
@@ -44,15 +54,19 @@
 	else if (_request('nom_email') AND _request('adresse_email')) # _POST
 		return  reponse_signature($id_article,
 			_request('nom_email'), _request('adresse_email'),
-			_request('message'), _request('nom_site'),
-			_request('url_site'), _request('url_page')
+			_request('message'), _request('signature_nom_site'),
+			_request('signature_url_site'), _request('url_page')
 		);
 
 	else {
-		$s = spip_query("SELECT * FROM spip_petitions
-			WHERE id_article='$id_article'");
-		if ($row = spip_fetch_array($s))
-			return array('formulaire_signature', 0, $row);
+		return array('formulaire_signature', $GLOBALS['delais'],
+		array(
+			'id_article' => $id_article,
+			'petition' => $petition,
+			'texte' => $texte,
+			'site_obli' => $site_obli,
+			'message' => $message
+		));
 	}
 }
 
@@ -181,11 +195,11 @@
 			}
 	
 			if (strlen($nom_email) < 2) {
-				return (_T('form_indiquer_nom'));
+				return _T('form_indiquer_nom');
 			}
 	
 			if ($adresse_email == _T('info_mail_fournisseur')) {
-				return (_T('form_indiquer_email'));
+				return _T('form_indiquer_email');
 			}
 	
 			if ($email_unique == "oui") {
@@ -193,22 +207,22 @@
 				$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND ad_email='$email' AND statut='publie'";
 				$result = spip_query($query);
 				if (spip_num_rows($result) > 0) {
-					return (_T('form_pet_deja_signe'));
+					return _T('form_pet_deja_signe');
 				}
 			}
 	
 			if (!email_valide($adresse_email)) {
-				return (_T('form_email_non_valide'));
+				return _T('form_email_non_valide');
 			}
 	
 			if ($site_obli == "oui") {
 				if (!$nom_site) {
-					return (_T('form_indiquer_nom_site'));
+					return _T('form_indiquer_nom_site');
 				}
 				include_ecrire("inc_sites.php3");
 	
 				if (!recuperer_page($url_site)) {
-					return (_T('form_pet_url_invalide'));
+					return _T('form_pet_url_invalide');
 				}
 			}
 			if ($site_unique == "oui") {
@@ -216,7 +230,7 @@
 				$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND url_site='$site' AND (statut='publie' OR statut='poubelle')";
 				$result = spip_query($query);
 				if (spip_num_rows($result) > 0) {
-					return (_T('form_pet_site_deja_enregistre'));
+					return _T('form_pet_site_deja_enregistre');
 				}
 			}
 	

Index: formulaire_forum.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_forum.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- formulaire_forum.html	20 Feb 2005 22:13:52 -0000	1.2
+++ formulaire_forum.html	3 Mar 2005 14:53:17 -0000	1.3
@@ -1,7 +1,5 @@
 <form action="[(#ENV{url})]" method="post" name="formulaire">[
-<input type="hidden" name="alea" value="(#ENV{alea})" />][
-<input type="hidden" name="hash" value="(#ENV{hash})" />][
-<input type="hidden" name="retour_forum" value="(#ENV{retour_forum})" />
+(#ENV*{parametres_forum})
 ][<p>(#ENV*{modere})</p>
 ][(#ENV*{afficher_texte_hidden})
 ][(#ENV*{afficher_texte_input})
@@ -51,4 +49,3 @@
 		class="spip_bouton" /></div>
 	]
 ]</form>
-

Index: formulaire_signature.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_signature.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- formulaire_signature.html	20 Feb 2005 22:13:52 -0000	1.2
+++ formulaire_signature.html	3 Mar 2005 14:53:17 -0000	1.3
@@ -1,44 +1,52 @@
-<form method='post'
-      action='#SELF#sp[(#ENV{id_article})]' >
-      <input type="hidden" name="url_page" value="#URL_SITE_SPIP/#SELF">
-      <div class='spip_encadrer' style='color: black; font-size: 80%; font-weight: normal;'>
-	[(#ENV*{texte}|propre)]
-	<fieldset style='font-size: 110%; font-weight: bold;'>
-	  <legend></legend>
-	  <label>
-	    <:form_pet_votre_nom:>
-	    <input type="text" class="forml" name="nom_email" value="" size="20" />
-	  </label>
-	  <label>
-	    <:form_pet_votre_email:><br />
-	    <input type="text" class="forml" name="adresse_email" value="" size="20" />
-	  </label>
-	</fieldset>
-	<br />
-	<p>[(#ENV{site_obli}|=={oui}|?{'',' '})<:form_pet_votre_site:><br />]
-	<fieldset style='font-size: 110%; font-weight: bold;'>
-	  <legend></legend>
-	  <label>
-	  <:form_pet_nom_site2:><br />
-	  <input type="text" class="forml" name="signature_nom_site" value="" size="20" />
-	  </label>
-	  <label>
-	    <:form_pet_adresse_site:><br />
-	    <input type="text" class="forml" name="signature_url_site" value="http://" size="20" />
-	  </label>
-	</fieldset>[
+<form method='post' action='#SELF#sp[(#ENV{id_article})]'>
+<input type="hidden" name="url_page" value="#URL_SITE_SPIP/#SELF">
+<div class='spip_encadrer' style='color: black; font-size: 80%; font-weight: normal;'>
+[(#ENV*{texte}|propre)]
+<fieldset style='font-size: 110%; font-weight: bold;'>
+	<legend></legend>
+	<label>
+		<:form_pet_votre_nom:>
+		<input type="text" class="forml" name="nom_email"
+		value="" size="20" />
+	</label>
+	<label>
+		<:form_pet_votre_email:><br />
+		<input type="text" class="forml" name="adresse_email"
+		value="" size="20" />
+	</label>
+</fieldset>
+<br />
+<p>
+[(#ENV{site_obli})<:form_pet_votre_site:><br />]
+<fieldset style='font-size: 110%; font-weight: bold;'>
+	<legend></legend>
+	<label>
+	<:form_pet_nom_site2:><br />
+	<input type="text" class="forml" name="signature_nom_site"
+	value="" size="20" />
+	</label>
+	<label>
+		<:form_pet_adresse_site:><br />
+		<input type="text" class="forml" name="signature_url_site"
+		value="http://" size="20" />
+	</label>
+</fieldset>
+
+[
+(#ENV{message})
 	<br />
 	<fieldset style='font-weight: bold'>
-	  <legend></legend>
-	(#ENV{message}|=={oui}|?{' ',''})
-	  <label>
-	  <:form_pet_message_commentaire:><br />
-	    <textarea name="message" rows="3" class="forml" cols="20"></textarea>
-	  </label>
+		<legend></legend>
+		<label>
+		<:form_pet_message_commentaire:><br />
+			<textarea name="message" rows="3"
+			class="forml" cols="20"></textarea>
+		</label>
 	</fieldset>
-	]
-	<br />
-	<div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>" /></div>
-      </div>
-</form>
+]
 
+<br />
+	<div align="right"><input type="submit" class="spip_bouton"
+	value="<:bouton_valider:>" /></div>
+</div>
+</form>

Index: inc-formulaire_inscription.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_inscription.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-formulaire_inscription.php3	20 Feb 2005 22:13:52 -0000	1.2
+++ inc-formulaire_inscription.php3	3 Mar 2005 14:53:17 -0000	1.3
@@ -17,14 +17,17 @@
 }
 
 function balise_FORMULAIRE_INSCRIPTION_dyn($mode, $focus) {
-	if (($mode == 'redac')
-	AND (lire_meta("accepter_inscriptions") == "oui"))
-		$statut = "nouveau";
-	else if (($mode == 'forum')
-	AND ((lire_meta('accepter_visiteurs') == 'oui')
-		OR (lire_meta('forums_publics') == 'abo'))
-	)
-		$statut = "6forum";
+
+	// Si une inscription est autorisee, on enregistre le demandeur
+	// comme 'nouveau' et on lui envoie ses codes par email ; lors de
+	// sa premiere connexion il obtiendra son statut final (auth->activer())
+	if (($mode == 'redac' AND lire_meta('accepter_inscriptions') == 'oui')
+	OR ($mode == 'forum' AND (
+		lire_meta('accepter_visiteurs') == 'oui'
+		OR lire_meta('forums_publics') == 'abo'
+		)
+	))
+		$statut = 'nouveau';
 	else
 		return _T('pass_rien_a_faire_ici');
 
@@ -45,7 +48,7 @@
 				'".addslashes($mail_inscription)."', '$login', '$statut')");
 			$pass = creer_pass_pour_auteur($id_auteur);
 			$message = envoyer_inscription($mail_inscription,
-				$statut, $mode, $login, $pass);
+				$statut, $mode, $login, $pass, $nom_inscription);
 		}
 
 		else {
@@ -55,7 +58,7 @@
 				$pass = creer_pass_pour_auteur($id_auteur);
 				$message = envoyer_inscription(
 					$mail_inscription, $row['statut'], $mode,
-					$row['login'], $pass);
+					$row['login'], $pass, $nom_inscription);
 			} else {
 				// dead
 				if ($row['statut'] == '5poubelle')
@@ -94,11 +97,12 @@
 
 
 // envoyer identifiants par mail
-function envoyer_inscription($mail, $statut, $type, $login, $pass) {
+function envoyer_inscription($mail, $statut, $type, $login, $pass, $nom) {
 	$nom_site_spip = lire_meta("nom_site");
 	$adresse_site = lire_meta("adresse_site");
 	
-	$message = _T('form_forum_message_auto')."\n\n"._T('form_forum_bonjour')."\n\n";
+	$message = _T('form_forum_message_auto')."\n\n"
+	._T('form_forum_bonjour', array('nom'=>$nom))."\n\n";
 	if ($type == 'forum') {
 		$message .= _T('form_forum_voici1', array('nom_site_spip' => $nom_site_spip, 'adresse_site' => $adresse_site)) . "\n\n";
 	} else {

Index: formulaire_admin.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_admin.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- formulaire_admin.html	20 Feb 2005 22:13:52 -0000	1.2
+++ formulaire_admin.html	3 Mar 2005 14:53:17 -0000	1.3
@@ -1,6 +1,5 @@
 [<(#ENV{floatdiv}) class="spip-admin-float">]
 <div class="spip-admin-bloc" dir='#LANG_DIR'>
-<div class="spip-admin">
 	<ul>[
 	<li><a href='ecrire/articles.php3?id_article=(#ENV{id_article})' class='spip-admin-boutons'><:admin_modifier_article:> ([(#ENV{id_article})])</a></li>][
 	<li><a href='ecrire/breves_voir.php3?id_breve=(#ENV{id_breve})' class='spip-admin-boutons'><:admin_modifier_breve:> ([(#ENV{id_breve})])</a></li>][
@@ -11,6 +10,5 @@
 	<li><a href='ecrire/(#ENV{statistiques})[id_article=(#ENV{id_article})]' class='spip-admin-boutons'>[<:info_visites:>&nbsp;(#ENV{visites})][;&nbsp;<:info_popularite_5:>&nbsp;(#ENV{popularite})]</a></li>][
 	<li><a href='[(#ENV{action})]var_mode=(#ENV{debug})' class='spip-admin-boutons'><:admin_debug:></a></li>]
 	</ul>
-</div>
 </div>
 [</(#ENV{floatdiv})>]

Index: inc-login_public.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-login_public.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-login_public.php3	20 Feb 2005 22:13:52 -0000	1.2
+++ inc-login_public.php3	3 Mar 2005 14:53:17 -0000	1.3
@@ -92,6 +92,19 @@
 		$s = spip_query("SELECT * FROM spip_auteurs
 			WHERE login='" .addslashes($login) ."'");
 		$row =  spip_fetch_array($s);
+
+		// Retrouver ceux qui signent de leur nom ou email
+		if (!$row AND !$GLOBALS['ldap_present']) {
+			if ($t = spip_fetch_array(
+			spip_query(
+				"SELECT * FROM spip_auteurs
+				WHERE (nom LIKE '" .addslashes($login) ."'
+				OR email LIKE '" .addslashes($login) ."')
+				AND login<>'' AND statut<>'5poubelle'"
+			)))
+				$row = $t;
+		}
+
 		if ((!$row AND !$GLOBALS['ldap_present']) OR
 			($row['statut'] == '5poubelle') OR 
 			(($row['source'] == 'spip') AND $row['pass'] == '')) {



From stef at berlios.de  Thu Mar  3 15:54:59 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 3 Mar 2005 15:54:59 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/lang spip_en.php3,1.2,1.3 spip_ca.php3,1.2,1.3 spip_ar.php3,1.2,1.3 spip_fr.php3,1.2,1.3
Message-ID: <200503031454.j23EsxNx006588@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/lang
In directory sheep:/tmp/cvs-serv6449/spipcarto/ecrire/lang

Modified Files:
	spip_en.php3 spip_ca.php3 spip_ar.php3 spip_fr.php3 
Log Message:
1.8pr1 cvs 20050303

Index: spip_en.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lang/spip_en.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_en.php3	21 Feb 2005 13:14:05 -0000	1.2
+++ spip_en.php3	3 Mar 2005 14:54:57 -0000	1.3
@@ -1,734 +1,735 @@
-<?php
-
-// This is a SPIP language file  --  Ceci est un fichier langue de SPIP
-
-$GLOBALS[$GLOBALS['idx_lang']] = array(
-
-
-// 0
-'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
-'0_langue' => 'English [en]',
-'0_liste' => 'spip-en at rezo.net',
[...1438 lines suppressed...]
+'zbug_critere_inconnu' => 'unknown criterion @critere@',
+'zbug_distant_interdit' => 'external data forbidden',
+'zbug_erreur_boucle_double' => 'BOUCLE at id@: double definition',
+'zbug_erreur_boucle_fermant' => 'BOUCLE at id@: missing closing tag',
+'zbug_erreur_boucle_syntaxe' => 'Incorrect loop (BOUCLE) syntax ',
+'zbug_erreur_execution_page' => 'error in page calculation',
+'zbug_erreur_filtre' => 'Error - undefined filter: <b>"@filtre@"</b>',
+'zbug_erreur_meme_parent' => '{meme_parent} only applies to loops (FORUMS) and (RUBRIQUES)',
+'zbug_erreur_squelette' => 'Error(s) in template',
+'zbug_info_erreur_squelette' => '&#1615;Error in the site',
+'zbug_inversion_ordre_inexistant' => 'reversal of nonexistent order',
+'zbug_parametres_inclus_incorrects' => 'Wrong inclusion parameters',
+'zbug_resultat' => 'result',
+'zbug_serveur_indefini' => 'undefined SQL server',
+'zbug_table_inconnue' => 'Unknown SQL table "@table@"'
+
+);
+
+
+?>

Index: spip_ca.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lang/spip_ca.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_ca.php3	21 Feb 2005 13:14:05 -0000	1.2
+++ spip_ca.php3	3 Mar 2005 14:54:57 -0000	1.3
@@ -1,769 +1,770 @@
-<?php
-
-// This is a SPIP language file  --  Ceci est un fichier langue de SPIP
-
-$GLOBALS[$GLOBALS['idx_lang']] = array(
-
-
-// 0
-'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
-'0_langue' => 'Catal&agrave; [ca]',
-'0_liste' => ' spip-dev at rezo.net',
[...1508 lines suppressed...]
+'zbug_critere_inconnu' => 'criteri desconegut @critere@',
+'zbug_distant_interdit' => 'prohibit amb dades externes',
+'zbug_erreur_boucle_double' => 'BOUCLE at id@: doble definici&oacute;',
+'zbug_erreur_boucle_fermant' => ' BOUCLE at id@: falta tag que tanque',
+'zbug_erreur_boucle_syntaxe' => 'Sintaxi incorrecte del bucle',
+'zbug_erreur_execution_page' => 'error d\'execuci&oacute; de la p&agrave;gina',
+'zbug_erreur_filtre' => 'Error: filtre <b>&laquo; @filtre@ &raquo;</b> no definit',
+'zbug_erreur_meme_parent' => '{meme_parent} nom&eacute;s s\'aplica als bucles (FORUMS) o (RUBRIQUES)',
+'zbug_erreur_squelette' => 'Error(s) en l\'esquelet',
+'zbug_info_erreur_squelette' => 'Error en el lloc Web',
+'zbug_inversion_ordre_inexistant' => 'inversi&oacute; d\'un ordre inexistent',
+'zbug_parametres_inclus_incorrects' => 'Par&agrave;metres d\'inclusi&oacute; incorrectes',
+'zbug_resultat' => 'resultat',
+'zbug_serveur_indefini' => 'servidor SQL sense definir',
+'zbug_table_inconnue' => 'Taula SQL &laquo; @table@ &raquo; desconeguda'
+
+);
+
+
+?>

Index: spip_ar.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lang/spip_ar.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_ar.php3	21 Feb 2005 13:14:05 -0000	1.2
+++ spip_ar.php3	3 Mar 2005 14:54:57 -0000	1.3
@@ -1,735 +1,736 @@
-<?php
-
-// This is a SPIP language file  --  Ceci est un fichier langue de SPIP
-
-$GLOBALS[$GLOBALS['idx_lang']] = array(
-
-
-// 0
-'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
-'0_langue' => '&#1593;&#1585;&#1576;&#1610; [ar]',
-'0_liste' => 'spip-dev at rezo.net',
[...1440 lines suppressed...]
+'zbug_critere_inconnu' => '&#1605;&#1593;&#1610;&#1575;&#1585; &#1594;&#1610;&#1585; &#1605;&#1593;&#1585;&#1608;&#1601; @critere@',
+'zbug_distant_interdit' => '&#1593;&#1605;&#1604;&#1610;&#1577; &#1582;&#1575;&#1585;&#1580;&#1610;&#1577; &#1605;&#1605;&#1606;&#1608;&#1593;&#1577;',
+'zbug_erreur_boucle_double' => 'BOUCLE at id@: &#1578;&#1593;&#1585;&#1610;&#1601; &#1605;&#1578;&#1603;&#1585;&#1585;',
+'zbug_erreur_boucle_fermant' => 'BOUCLE at id@: &#1593;&#1604;&#1575;&#1605;&#1577; &#1573;&#1594;&#1604;&#1575;&#1602; &#1594;&#1575;&#1574;&#1576;&#1577;',
+'zbug_erreur_boucle_syntaxe' => '&#1578;&#1585;&#1603;&#1610;&#1576; &#1581;&#1604;&#1602;&#1577; &#1594;&#1610;&#1585; &#1589;&#1581;&#1610;&#1581;',
+'zbug_erreur_execution_page' => '&#1582;&#1591;&#1571; &#1601;&#1610; &#1578;&#1606;&#1601;&#1610;&#1584; &#1575;&#1604;&#1589;&#1601;&#1581;&#1577;',
+'zbug_erreur_filtre' => '&#1582;&#1591;&#1571;: &#1575;&#1604;&#1605;&#1585;&#1588;&#1581; <b>&laquo;@filtre@&raquo;</b> &#1594;&#1610;&#1585; &#1605;&#1593;&#1585;&#1608;&#1601; ',
+'zbug_erreur_meme_parent' => '&#1604;&#1575; &#1610;&#1606;&#1591;&#1576;&#1602; {meme_parent} &#1575;&#1604;&#1575; &#1593;&#1604;&#1609; &#1581;&#1604;&#1602;&#1578;&#1610; (FORUMS) &#1575;&#1608; (RUBRIQUES)',
+'zbug_erreur_squelette' => '&#1582;&#1591;&#1571; &#1601;&#1610; &#1575;&#1604;&#1589;&#1601;&#1581;&#1577; &#1575;&#1604;&#1606;&#1605;&#1608;&#1584;&#1580;&#1610;&#1577;',
+'zbug_info_erreur_squelette' => '&#1582;&#1591;&#1571; &#1601;&#1610; &#1575;&#1604;&#1605;&#1608;&#1601;&#1593;',
+'zbug_inversion_ordre_inexistant' => '&#1575;&#1587;&#1578;&#1582;&#1583;&#1575;&#1605; {inverse} &#1605;&#1593; &#1578;&#1585;&#1578;&#1610;&#1576; &#1594;&#1610;&#1585; &#1605;&#1608;&#1580;&#1608;&#1583;',
+'zbug_parametres_inclus_incorrects' => '&#1593;&#1608;&#1575;&#1605;&#1604; &#1575;&#1583;&#1585;&#1575;&#1580; &#1594;&#1610;&#1585; &#1589;&#1581;&#1610;&#1581;&#1577;',
+'zbug_resultat' => '&#1575;&#1604;&#1606;&#1578;&#1610;&#1580;&#1577;',
+'zbug_serveur_indefini' => '&#1582;&#1575;&#1583;&#1605; SQL &#1594;&#1610;&#1585; &#1605;&#1581;&#1583;&#1583;',
+'zbug_table_inconnue' => '&#1580;&#1583;&#1608;&#1604; SQL &#1607;&#1608; &laquo;@table@&raquo; &#1594;&#1610;&#1585; &#1605;&#1593;&#1585;&#1608;&#1601;'
+
+);
+
+
+?>

Index: spip_fr.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lang/spip_fr.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_fr.php3	21 Feb 2005 13:14:05 -0000	1.2
+++ spip_fr.php3	3 Mar 2005 14:54:57 -0000	1.3
@@ -1,735 +1,736 @@
-<?php
-
-// This is a SPIP language file  --  Ceci est un fichier langue de SPIP
-
-$GLOBALS[$GLOBALS['idx_lang']] = array(
-
-
-// 0
-'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
-'0_langue' => 'Fran&ccedil;ais [fr]',
-'0_liste' => 'spip-dev at rezo.net',
[...1440 lines suppressed...]
+'zbug_critere_inconnu' => 'crit&egrave;re inconnu @critere@',
+'zbug_distant_interdit' => 'externe interdit',
+'zbug_erreur_boucle_double' => 'BOUCLE at id@: double d&eacute;finition',
+'zbug_erreur_boucle_fermant' => 'BOUCLE at id@: tag fermant manquant',
+'zbug_erreur_boucle_syntaxe' => 'Syntaxe boucle incorrecte',
+'zbug_erreur_execution_page' => 'erreur d\'ex&eacute;cution de la page',
+'zbug_erreur_filtre' => 'Erreur : filtre <b>&laquo; @filtre@ &raquo;</b> non d&eacute;fini',
+'zbug_erreur_meme_parent' => '{meme_parent} ne s\'applique qu\'aux boucles (FORUMS) ou (RUBRIQUES)',
+'zbug_erreur_squelette' => 'Erreur(s) dans le squelette',
+'zbug_info_erreur_squelette' => 'Erreur sur le site',
+'zbug_inversion_ordre_inexistant' => 'inversion d\'un ordre inexistant',
+'zbug_parametres_inclus_incorrects' => 'Param&egrave;tres d\'inclusion incorrects',
+'zbug_resultat' => 'r&eacute;sultat',
+'zbug_serveur_indefini' => 'serveur SQL ind&eacute;fini',
+'zbug_table_inconnue' => 'Table SQL &laquo; @table@ &raquo; inconnue'
+
+);
+
+
+?>



From stef at berlios.de  Thu Mar  3 15:54:59 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 3 Mar 2005 15:54:59 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire auteur_messagerie.php3,1.2,1.3 index.php3,1.2,1.3 config-contenu.php3,1.2,1.3 inc_sites.php3,1.2,1.3 inc_filtres.php3,1.2,1.3 inc_suivi_revisions.php,1.2,1.3 mots_edit.php3,1.2,1.3 config-lang.php3,1.2,1.3 inc_auth_spip.php3,1.2,1.3 inc_version.php3,1.2,1.3 message.php3,1.2,1.3 inc_lang.php3,1.2,1.3 configuration.php3,1.2,1.3 inc_documents.php3,1.2,1.3 config-multilang.php3,1.2,1.3 inc_texte.php3,1.2,1.3 articles.php3,1.2,1.3 inc_surligne.php3,1.2,1.3 sites_edit.php3,1.2,1.3 inc_auth.php3,1.2,1.3 articles_edit.php3,1.2,1.3 rubriques_edit.php3,1.2,1.3 spip_style.php3,1.2,1.3 admin_vider.php3,1.2,1.3 inc_getdocument.php3,1.2,1.3 inc_logos.php3,1.3,1.4 inc_acces.php3,1.2,1.3 auteurs_edit.php3,1.2,1.3 auteur_infos.php3,1.2,1.3 breves_edit.php3,1.2,1.3 inc_calendrier.php,1.3,1.4
Message-ID: <200503031454.j23EsxNx006566@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv6449/spipcarto/ecrire

Modified Files:
	auteur_messagerie.php3 index.php3 config-contenu.php3 
	inc_sites.php3 inc_filtres.php3 inc_suivi_revisions.php 
	mots_edit.php3 config-lang.php3 inc_auth_spip.php3 
	inc_version.php3 message.php3 inc_lang.php3 configuration.php3 
	inc_documents.php3 config-multilang.php3 inc_texte.php3 
	articles.php3 inc_surligne.php3 sites_edit.php3 inc_auth.php3 
	articles_edit.php3 rubriques_edit.php3 spip_style.php3 
	admin_vider.php3 inc_getdocument.php3 inc_logos.php3 
	inc_acces.php3 auteurs_edit.php3 auteur_infos.php3 
	breves_edit.php3 inc_calendrier.php 
Log Message:
1.8pr1 cvs 20050303

Index: auteur_messagerie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteur_messagerie.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- auteur_messagerie.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ auteur_messagerie.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -103,15 +103,6 @@
 
 debut_droite();
 
-function mySel($varaut,$variable) {
-	$retour = " VALUE=\"$varaut\"";
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-	return $retour;
-}
-
-
 	//
 	// Editer les donnees de l'auteur
 	//

Index: index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/index.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- index.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ index.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -169,7 +169,7 @@
 		// rendez-vous personnels dans le mois
 		if (spip_num_rows(spip_query("SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.date_heure >='$annee-$mois-1' AND date_heure < DATE_ADD('$annee-$mois-1', INTERVAL 1 MONTH) AND messages.statut='publie' LIMIT 0,1"))) {
 			echo "<p />";
-			echo http_calendrier_agenda ($mois_today, $annee_today, $jour_today, $mois_today, $annee_today);
+			echo http_calendrier_agenda ($mois_today, $annee_today, $jour_today, $mois_today, $annee_today, false, 'calendrier.php3');
 		}
 		// rendez-vous personnels dans le mois
 		if (spip_num_rows(spip_query("SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien ".

Index: config-contenu.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-contenu.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- config-contenu.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ config-contenu.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -28,17 +28,6 @@
 
 lire_metas();
 
-function mySel($varaut,$variable){
-		$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-
-	return $retour;
-}
-
-
 debut_page(_T('titre_page_config_contenu'), "administration", "configuration");
 
 echo "<br><br><br>";

Index: inc_sites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_sites.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_sites.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_sites.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -74,8 +74,9 @@
 			}
 			if ($status >= 300 AND $status < 400 AND $location) $url = $location;
 			else if ($status != 200) return;
-			else break;
+			else break; # ici on est content
 			fclose($f);
+			$f = false;
 		}
 		else {
 			if (!$GLOBALS['tester_proxy'])

Index: inc_filtres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_filtres.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_filtres.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_filtres.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -236,10 +236,19 @@
 function url_var_recherche($url) {
 	if (_request('recherche')
 	AND !ereg("var_recherche", $url)) {
-		$url .= strpos($url, '?') ? '&' : '?';
-		$url .= "var_recherche=".urlencode(_request('recherche'));
+		$x = "var_recherche=".urlencode(_request('recherche'));
+		if (!strpos($url, '?'))
+		  return "$url?$x";
+		else
+		  {
+		    $p = strpos($url, '#');
+		    if (!$p)
+		      return "$url&$x";
+		    else
+		      return substr($url,0,$p) . "&$x" . substr($url,$p+1);
+		  }
 	}
-	return $url;
+	else return $url;
 }
 
 

Index: inc_suivi_revisions.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_suivi_revisions.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_suivi_revisions.php	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_suivi_revisions.php	3 Mar 2005 14:54:56 -0000	1.3
@@ -109,7 +109,7 @@
 			echo "<img src='" . _DIR_IMG_PACK . "$logo_statut' border='0'>&nbsp;";
 			echo "<a class='$statut' style='font-weight: bold;' href='articles_versions.php3?id_article=$id_article'>$titre</a>";
 			echo "</span>";
-			echo "<span class='arial1'>";
+			echo "<span class='arial1'$dir_lang>";
 			echo " $date $nom";
 			echo "</span>";
 		

Index: mots_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/mots_edit.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- mots_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ mots_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -16,15 +16,6 @@
 include_ecrire ("inc_sites.php3");
 include_ecrire ("inc_abstract_sql.php3");
 
-function mySel($varaut, $variable) {
-	$retour = " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-	return $retour;
-}
-
 
 //
 // modifications mot

Index: config-lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-lang.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- config-lang.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ config-lang.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -15,17 +15,6 @@
 
 include_ecrire ("inc_config.php3");
 
-function mySel($varaut,$variable){
-		$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-
-	return $retour;
-}
-
-
 debut_page(_T('titre_page_config_contenu'), "administration", "langues");
 
 echo "<br><br><br>";

Index: inc_auth_spip.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_auth_spip.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_auth_spip.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_auth_spip.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -64,7 +64,11 @@
 
 	function activer() {
 		if ($this->statut == 'nouveau') { // nouvel inscrit
-			spip_query("UPDATE spip_auteurs SET statut='1comite' WHERE login='".addslashes($this->login)."'");
+			$connect_statut =
+			(lire_meta('accepter_inscriptions') == 'oui') ?
+				'1comite' : '6forum';
+			spip_query("UPDATE spip_auteurs SET statut='$connect_statut'
+				WHERE login='".addslashes($this->login)."'");
 		}
 		if ($this->md5next) {
 			include_ecrire("inc_session.php3");

Index: inc_version.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_version.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_version.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_version.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -233,10 +233,6 @@
 // navigateur l'accepte (valable pour apache >= 1.3 seulement) ?
 $auto_compress = true;
 
-// compresser les fichiers du repertoire CACHE/ avec gzip ?
-// attention : apres toute modification de ce reglage il faut vider le cache
-$compresser_cache = true;
-
 // Type d'URLs
 // 'standard': article.php3?id_article=123
 // 'html': article123.html
@@ -449,6 +445,10 @@
 $flag_gd = $flag_ImageGif || $flag_ImageJpeg || $flag_ImagePng;
 $flag_revisions = ($flag_pcre AND function_exists("gzcompress"));
 
+// deux constantes pour le surlignage (cf inc_surligne et inc-balise)
+
+define("MARQUEUR_SURLIGNE",  'span class="spip_surligneconditionnel">');
+define("MARQUEUR_FSURLIGNE", '/span                                 >'); 
 
 //
 // Appliquer le prefixe cookie

Index: message.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/message.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- message.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ message.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -270,7 +270,7 @@
 	debut_gauche();
 	
 	if ($rv != 'non')
-	  echo http_calendrier_agenda ($lemois, $lannee, $lejour, $lemois, $lannee);
+	  echo http_calendrier_agenda ($lemois, $lannee, $lejour, $lemois, $lannee,false, 'calendrier.php3');
 	
 	echo "<br />";
 	

Index: inc_lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_lang.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_lang.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_lang.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -42,7 +42,7 @@
 			include_lang($fichier_lang);
 			$GLOBALS['i18n_'.$module.'_'.$lang]
 				= &$GLOBALS['i18n_'.$module.'_'.$l];
-			spip_log("module de langue : ${module}_$l.php3");
+			#spip_log("module de langue : ${module}_$l.php3");
 		}
 	}
 

Index: configuration.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/configuration.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- configuration.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ configuration.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -40,17 +40,6 @@
 lire_metas();
 
 
-function mySel($varaut,$variable){
-		$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-
-	return $retour;
-}
-
-
 debut_page(_T('titre_page_configuration'), "administration", "configuration");
 
 echo "<br><br><br>";

Index: inc_documents.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_documents.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_documents.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_documents.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -56,7 +56,7 @@
 	eregi('\.([a-z0-9]+)$', $document, $regs);
 	list($fichier, $largeur, $hauteur) =
 		vignette_par_defaut($regs[1]);
-	$doc = "<a href='$url'><img src='$fichier' border='0' /></a>";
+	$doc = "<a href='$url'><img src='$fichier' style='border-width: 0px' /></a>";
 	return $doc;
 }
 
@@ -150,7 +150,7 @@
 			$largeur_vignette = $largeur;
 			$hauteur_vignette = $hauteur;
 			if ($fichier_vignette) {
-				$vignette = "<img src='$fichier_vignette' border='0'";
+				$vignette = "<img src='$fichier_vignette' style='border-width: 0px'";
 				if ($largeur_vignette && $hauteur_vignette)
 					$vignette .= " width='$largeur_vignette' height='$hauteur_vignette'";
 				if ($titre) {
@@ -168,7 +168,7 @@
 			if ($largeur_vignette < 120) $largeur_vignette = 120;
 			$forcer_largeur = " width = '$largeur_vignette'";
 
-			$retour = "<table cellpadding='0' cellspacing='0' border='0' align='$align'>\n";
+			$retour = "<table cellpadding='0' cellspacing='0' style='border-width: 0px' align='$align'>\n";
 			$retour .= "<tr>";
 			if ($align == "right") $retour .= "<td width='10'> &nbsp; </td>";
 			$retour .= "<td align='center'$forcer_largeur>\n<div class='spip_documents'>\n";
@@ -254,7 +254,7 @@
 			= vignette_par_defaut($extension);
 
 		if ($url_fichier_vignette) {
-			$vignette = "<img src='$url_fichier_vignette' border='0'";
+			$vignette = "<img src='$url_fichier_vignette' style='border-width: 0px'";
 			if ($largeur_vignette && $hauteur_vignette)
 				$vignette .= " width='$largeur_vignette' height='$hauteur_vignette'";
 			if ($titre) {
@@ -325,11 +325,13 @@
 	$d = opendir($dir);
 
 	while ($f = readdir($d)) {
-		if (is_file("$dir/$f") AND $f != 'remove.txt') {
+		if (is_file("$dir/$f") AND is_readable("$dir/$f")
+		AND $f != 'remove.txt') {
 			$fichiers[] = "$dir/$f";
 		}
 		else
-		if (is_dir("$dir/$f") AND $f != '.' AND $f != '..') {
+		if (is_dir("$dir/$f") AND is_readable("$dir/$f")
+		AND $f != '.' AND $f != '..') {
 			$fichiers_dir = fichiers_upload("$dir/$f");
 			while (list(,$f2) = each ($fichiers_dir))
 				$fichiers[] = $f2;
@@ -554,7 +556,7 @@
 					$link_rot->addVar('redirect',
 						$redirect_url.'&show_docs='.$id_document);
 					$link_rot->addVar('ancre', $album);
-					echo http_href_img($link_rot->getUrl(), 'tourner-gauche.gif', "border='0'", _T('image_tourner_gauche'), '', 'bouton_rotation');
+					echo http_href_img($link_rot->getUrl(), 'tourner-gauche.gif', "style='border-width: 0px'", _T('image_tourner_gauche'), '', 'bouton_rotation');
 					echo "<br />";
 
 					// tourner a droite
@@ -567,7 +569,7 @@
 						$redirect_url.'&show_docs='.$id_document);
 					$link_rot->addVar('ancre', $album);
 					echo http_href_img($link_rot->getUrl(),
-						'tourner-droite.gif', "border='0'",
+						'tourner-droite.gif', "style='border-width: 0px'",
 						_T('image_tourner_droite'), '', 'bouton_rotation');
 					echo "<br />";
 
@@ -581,7 +583,7 @@
 						$redirect_url.'&show_docs='.$id_document);
 					$link_rot->addVar('ancre', $album);
 					echo http_href_img($link_rot->getUrl(),
-						'tourner-180.gif', "border='0'",
+						'tourner-180.gif', "style='border-width: 0px'",
 						_T('image_tourner_180'), '', 'bouton_rotation');
 				}
 				echo "</div>\n";
@@ -1080,7 +1082,7 @@
 			list($icone, $largeur_icone, $hauteur_icone) =
 				vignette_par_defaut($type_extension);
 			if ($icone) {
-				echo "<a href='$url'><img src='$icone' border='0' width='$largeur_icone' align='top' height='$hauteur_icone' alt='' /></a>\n";
+				echo "<a href='$url'><img src='$icone' style='border-width: 0px' width='$largeur_icone' align='top' height='$hauteur_icone' alt='' /></a>\n";
 			}
 			echo "</div>\n";
 		}

Index: config-multilang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-multilang.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- config-multilang.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ config-multilang.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -15,16 +15,6 @@
 
 include_ecrire ("inc_config.php3");
 
-function mySel($varaut,$variable){
-		$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-
-	return $retour;
-}
-
 lire_metas();
 
 debut_page(_T('titre_page_config_contenu'), "administration", "langues");

Index: inc_texte.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_texte.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_texte.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_texte.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -48,8 +48,8 @@
 // On ne prend la $puce_rtl par defaut que si $puce n'a pas ete redefinie
 
 //if (!tester_variable('puce', "<li class='spip_puce' style='list-style-image: url(puce.gif)'>")) {
-if (!tester_variable('puce', "<img class='spip_puce' src='puce.gif' alt='-' border='0'>&nbsp;")) {
-	tester_variable('puce_rtl', "<img class='spip_puce' src='puce_rtl.gif' alt='-' border='0'>&nbsp;");
+if (!tester_variable('puce', "<img class='spip_puce' src='puce.gif' alt='-'>&nbsp;")) {
+	tester_variable('puce_rtl', "<img class='spip_puce' src='puce_rtl.gif' alt='-'>&nbsp;");
 }
 
 

Index: articles.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- articles.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ articles.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -685,60 +685,41 @@
 changer_typo('','article'.$id_article);
 
 
-// qu'est-ce que c'est que ces choses ??
-
-function mySel($varaut,$variable){
-	$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-	return $retour;
-}
-
-
-function my_sel($num,$tex,$comp){
-	if ($num==$comp){
-		echo "<OPTION VALUE='$num' SELECTED>$tex\n";
-	}else{
-		echo "<OPTION VALUE='$num'>$tex\n";
-	}
-
-}
-
 function afficher_mois($mois){
-	my_sel("00",_T('mois_non_connu'),$mois);
-	my_sel("01",_T('date_mois_1'),$mois);
-	my_sel("02",_T('date_mois_2'),$mois);
-	my_sel("03",_T('date_mois_3'),$mois);
-	my_sel("04",_T('date_mois_4'),$mois);
-	my_sel("05",_T('date_mois_5'),$mois);
-	my_sel("06",_T('date_mois_6'),$mois);
-	my_sel("07",_T('date_mois_7'),$mois);
-	my_sel("08",_T('date_mois_8'),$mois);
-	my_sel("09",_T('date_mois_9'),$mois);
-	my_sel("10",_T('date_mois_10'),$mois);
-	my_sel("11",_T('date_mois_11'),$mois);
-	my_sel("12",_T('date_mois_12'),$mois);
+	echo mySel("00",$mois,_T('mois_non_connu'));
+	echo mySel("01",$mois,_T('date_mois_1'));
+	echo mySel("02",$mois,_T('date_mois_2'));
+	echo mySel("03",$mois,_T('date_mois_3'));
+	echo mySel("04",$mois,_T('date_mois_4'));
+	echo mySel("05",$mois,_T('date_mois_5'));
+	echo mySel("06",$mois,_T('date_mois_6'));
+	echo mySel("07",$mois,_T('date_mois_7'));
+	echo mySel("08",$mois,_T('date_mois_8'));
+	echo mySel("09",$mois,_T('date_mois_9'));
+	echo mySel("10",$mois,_T('date_mois_10'));
+	echo mySel("11",$mois,_T('date_mois_11'));
+	echo mySel("12",$mois,_T('date_mois_12'));
 }
 
 function afficher_annee($annee){
 	// Cette ligne permettrait de faire des articles sans date de publication
-	// my_sel("0000","n.c.",$annee);
+	// echo mySel("0000",$annee,"n.c.");
 
 	if($annee<1996 AND $annee <> 0){
-		echo "<OPTION VALUE='$annee' SELECTED>$annee\n";
+		echo mySel($annee,$annee,$annee);
 	}
 	for($i=1996;$i<date(Y)+2;$i++){
-		my_sel($i,$i,$annee);
+		echo mySel($i,$annee,$i);
 	}
 }
 
 function afficher_jour($jour){
-	my_sel("00",_T('jour_non_connu_nc'),$jour);
+	echo mySel("00",$jour,_T('jour_non_connu_nc'));
 	for($i=1;$i<32;$i++){
-		if ($i<10){$aff="&nbsp;".$i;}else{$aff=$i;}
-		my_sel($i,$aff,$jour);
+		$aff = _T('date_jnum'.$i);
+		if ($i<10)
+			$aff="&nbsp;".$aff;
+		echo mySel($i,$jour,$aff);
 	}
 }
 

Index: inc_surligne.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_surligne.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_surligne.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_surligne.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -16,13 +16,9 @@
 if (defined("_ECRIRE_INC_SURLIGNE")) return;
 define("_ECRIRE_INC_SURLIGNE", "1");
 
-
 // Balises qui ne font rien en mode normal
 // mais  vont etre substitue'es en mode recherche
 // voir les champs SURLIGNE dans inc-index-squel
-
-define("MARQUEUR_SURLIGNE", 'span class="spip_surligneconditionnel">');
-define("MARQUEUR_FSURLIGNE", '/' . MARQUEUR_SURLIGNE);
 
 function surligner_sans_accents ($mot) {
 	$accents =

Index: sites_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/sites_edit.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- sites_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ sites_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -17,16 +17,6 @@
 
 $proposer_sites = lire_meta("proposer_sites");
 
-function mySel($varaut,$variable) {
-	$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-
-	return $retour;
-}
-
 function premiere_rubrique(){
  	$query="SELECT * FROM spip_rubriques WHERE id_parent='0' ORDER BY titre LIMIT 0,1";
  	$result=spip_query($query);

Index: inc_auth.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_auth.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_auth.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_auth.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -221,16 +221,18 @@
 	}
 
 	if (!$auth_pass_ok) {
-		redirige_par_entete("../spip_login.php3?var_erreur=pass&inscription=" .
-			     ((lire_meta("accepter_inscriptions") == "oui")?
-			      ('spip_inscription.php3') : ''));
+		redirige_par_entete("../spip_login.php3?var_erreur=pass");
 	}
 
+	// Si c'est un nouvel inscrit, le passer de 'nouveau' a '1comite'
+	// (code presque mort, utilise peut-etre encore sous .htpasswd ?)
 	if ($connect_statut == 'nouveau') {
-		$query = "UPDATE spip_auteurs SET statut='1comite' WHERE id_auteur=$connect_id_auteur";
-		$result = spip_query($query);
-		$connect_statut = '1comite';
+		$connect_statut =
+		(lire_meta('accepter_inscriptions') == 'oui') ? '1comite' : '6forum';
+		spip_query("UPDATE spip_auteurs SET statut='$connect_statut'
+			WHERE id_auteur=$connect_id_auteur");
 	}
+
 	return true;
 }
 

Index: articles_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_edit.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- articles_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ articles_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -212,50 +212,6 @@
 debut_cadre_formulaire();
 
 
-function mySel($varaut,$variable) {
-	$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut) {
-		$retour.= " SELECTED";
-	}
-
-	return $retour;
-}
-
-
-
-function my_sel($num,$tex,$comp){
-	if ($num==$comp){
-		echo "<option value='$num' selected>$tex\n";
-	}else{
-		echo "<option value='$num'>$tex\n";
-	}
-
-}
-
-function afficher_mois($mois){
-	my_sel("01",_T('date_mois_1'),$mois);
-	my_sel("02",_T('date_mois_2'),$mois);
-	my_sel("03",_T('date_mois_3'),$mois);
-	my_sel("04",_T('date_mois_4'),$mois);
-	my_sel("05",_T('date_mois_5'),$mois);
-	my_sel("06",_T('date_mois_6'),$mois);
-	my_sel("07",_T('date_mois_7'),$mois);
-	my_sel("08",_T('date_mois_8'),$mois);
-	my_sel("09",_T('date_mois_9'),$mois);
-	my_sel("10",_T('date_mois_10'),$mois);
-	my_sel("11",_T('date_mois_11'),$mois);
-	my_sel("12",_T('date_mois_12'),$mois);
-}
-
-function afficher_jour($jour){
-	for($i=1;$i<32;$i++){
-		if ($i<10){$aff="&nbsp;".$i;}else{$aff=$i;}
-		my_sel($i,$aff,$jour);
-	}
-}
-
-
 function enfant($leparent){
 	global $id_parent;
 	global $id_rubrique;

Index: rubriques_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/rubriques_edit.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- rubriques_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ rubriques_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -14,16 +14,6 @@
 include ("inc.php3");
 
 
-function mySel($varaut,$variable){
-	$retour= " value=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " selected";
-	}
-
-	return $retour;
-}
-
 function enfant($leparent){
 	global $id_parent;
 	global $id_rubrique;

Index: spip_style.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/spip_style.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_style.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ spip_style.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -873,6 +873,7 @@
 	font-family: verdana, arial, helvetica, sans;
 	font-size: 12px;
 	padding: 6px;
+	position: relative;
 }
 
 .cadre-titre {

Index: admin_vider.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_vider.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- admin_vider.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ admin_vider.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -106,7 +106,7 @@
 }
 
 	echo "\n";
-	echo $compresser_cache? _T('cache_mode_compresse') :
+	echo $flag_gz ? _T('cache_mode_compresse') :
 		_T('cache_mode_non_compresse');
 	echo ' ('._T('cache_modifiable_webmestre').')</p>';
 

Index: inc_getdocument.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_getdocument.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_getdocument.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_getdocument.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -229,8 +229,10 @@
 
 	// Recopier le fichier a son emplacement definitif
 	$definitif = copier_document($ext, $nom_envoye, $source);
-	if (!$definitif)
+	if (!$definitif) {
+		spip_log("Impossible de copier_document($ext, $nom_envoye, $source)");
 		return;
+	}
 
 	// Quelques infos sur le fichier
 	if (!@file_exists($definitif)

Index: inc_logos.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_logos.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_logos.php3	25 Feb 2005 16:35:57 -0000	1.3
+++ inc_logos.php3	3 Mar 2005 14:54:56 -0000	1.4
@@ -60,7 +60,7 @@
 			     calculer_action_auteur ("reduire $w $h") .
 			     "&hash_id_auteur=$connect_id_auteur" .
 			     (!$contre ? '' : ("&".md5($contre))) .
-			     "'$taille border='0' alt='' />",
+			     "'$taille style='border-width: 0px' alt='$racine' />",
 			     $x, $y);
 	}
 	return '';
@@ -448,16 +448,25 @@
 
 	// recuperer le nom du fichier
 	if (eregi("src='([^']+)'", $img, $regs)) $logo = $regs[1];
-	if (eregi("align='([^']+)'", $img, $regs)) $align = $regs[1];
+	if (!$logo) $logo = $img;
+
+	$attributs = '';
+
+	// encore utilise ?
 	if (eregi("name='([^']+)'", $img, $regs)) $name = $regs[1];
+	if ($name) $attributs .= " name='$name'"; 
+
+	// attributs deprecies. Transformer en CSS
 	if (eregi("hspace='([^']+)'", $img, $regs)) $espace = $regs[1];
-	if (!$logo) $logo = $img;
-	
-	// Ne pas creer de valeurs vides
-	if ($align) $align = " align='$align'";
-	if ($name) $name = " name='$name'";
-	if ($espace) $espace = " hspace='$espace' vspace='$espace'";
+	if ($espace) 
+	  $attributs .= " style='margin: $espace" . "px; border-width: 0px'";
+	else 
+	  $attributs .=  " class='spip_logos'";
+	// attribut deprecie mais equivalent CSS pas clair
+	if (eregi("align='([^']+)'", $img, $regs)) $align = $regs[1];
+	if ($align)  $attributs .= " align='$align'";
 
+	$attributs .= " alt='$name'";
 	if (eregi("(.*)\.(jpg|gif|png)$", $logo, $regs)) {
 		if ($i = cherche_image_nommee($regs[1], array($regs[2]))) {
 			list(,$nom,$format) = $i;
@@ -467,11 +476,11 @@
 				$vignette = $preview['fichier'];
 				$width = $preview['width'];
 				$height = $preview['height'];
-				return "<img src='$vignette'$name border='0'$name alt=''$espace width='$width' height='$height' class='spip_logos' />";
+				return "<img src='$vignette' width='$width' height='$height'$attributs />";
 			}
 			else if ($taille_origine = @getimagesize($logo)) {
 				list ($destWidth,$destHeight) = image_ratio($taille_origine[0], $taille_origine[1], $taille, $taille_y);
-				return "<img src='$logo'$name width='$destWidth' height='$destHeight' border='0'$align alt=''$espace class='spip_logos' />";
+				return "<img src='$logo' width='$destWidth' height='$destHeight'$attributs />";
 			}
 		}
 	}

Index: inc_acces.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_acces.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_acces.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_acces.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -79,6 +79,144 @@
 }
 
 
+// Une fonction service qui affiche le statut de l'auteur dans l'espace prive
+function afficher_formulaire_statut_auteur ($id_auteur, $post='') {
+	global $connect_statut, $connect_toutes_rubriques, $connect_id_auteur;
+	global $spip_lang_right;
+
+	$s = spip_query("SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur");
+	$auteur = spip_fetch_array($s);
+	$statut = $auteur['statut'];
+
+	if ($post) {
+		$url_self = $post;
+		echo "<p />";
+		echo "<form action='$post' method='post'>\n";
+	} else
+		$url_self = "auteur_infos.php3?id_auteur=$id_auteur";
+
+
+	// S'agit-il d'un admin restreint ?
+	if ($statut == '0minirezo') {
+		$query_admin = "SELECT lien.id_rubrique, titre FROM spip_auteurs_rubriques AS lien, spip_rubriques AS rubriques WHERE lien.id_auteur=$id_auteur AND lien.id_rubrique=rubriques.id_rubrique GROUP BY lien.id_rubrique";
+		$result_admin = spip_query($query_admin);
+		$admin_restreint = (spip_num_rows($result_admin) > 0);
+	}
+
+	// Seuls les admins voient le menu 'statut' ; les admins restreints
+	// ne peuvent l'utiliser que pour mettre un auteur a la poubelle
+	if ($connect_statut == "0minirezo"
+	AND ($connect_toutes_rubriques OR $statut != "0minirezo")
+	AND $connect_id_auteur != $id_auteur) {
+		debut_cadre_relief();
+
+		if ($statut == '0minirezo') {
+			if ($admin_restreint)
+				echo bouton_block_visible("statut$id_auteur");
+			else
+				echo bouton_block_invisible("statut$id_auteur");
+		}
+
+		echo "<b>"._T('info_statut_auteur')." </b> ";
+		echo "<select name='statut' size=1 class='fondl'>";
+
+		if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques)
+			echo "<OPTION".mySel("0minirezo",$statut).">"._T('item_administrateur_2');
+
+		echo "<OPTION".mySel("1comite",$statut).">"._T('intem_redacteur');
+
+		if (($statut == '6forum') OR (lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo'))
+			echo "<OPTION".mySel("6forum",$statut).">"._T('item_visiteur');
+		echo "<OPTION".mySel("5poubelle",$statut).
+		  " style='background:url(" . _DIR_IMG_PACK . "rayures-sup.gif)'>&gt; "._T('texte_statut_poubelle');
+
+		echo "</select>\n";
+
+		//
+		// Gestion restreinte des rubriques
+		//
+		if ($statut == '0minirezo') {
+			if (!$admin_restreint) {
+				echo debut_block_invisible("statut$id_auteur");
+				echo "<p /><div style='arial2'>\n";
+				echo _T('info_admin_gere_toutes_rubriques');
+			} else {
+				echo debut_block_visible("statut$id_auteur");
+				echo "<p /><div style='arial2'>\n";
+				echo _T('info_admin_gere_rubriques')."\n";
+				echo "<ul style='list-style-image: url(" . _DIR_IMG_PACK . "rubrique-12.gif)'>";
+				while ($row_admin = spip_fetch_array($result_admin)) {
+					$id_rubrique = $row_admin["id_rubrique"];
+					$titre = typo($row_admin["titre"]);
+					echo "<li>$titre";
+					if ($connect_toutes_rubriques
+					AND $connect_id_auteur != $id_auteur) {
+						echo " <font size=1>"
+						. "[<a href='$url_self&supp_rub=$id_rubrique'>"
+						._T('lien_supprimer_rubrique')
+						."</a>]</font>";
+					}
+					$toutes_rubriques .= "$id_rubrique,";
+				}
+				echo "</ul>";
+				$toutes_rubriques = ",$toutes_rubriques";
+			}
+	
+			if ($connect_toutes_rubriques
+			AND $connect_id_auteur != $id_auteur) {
+				echo "</div><br /><div class='arial1'>";
+				if (spip_num_rows($result_admin) == 0) {
+					echo "<b>"._T('info_restreindre_rubrique')."</b><br />";
+				} else {
+					echo "<b>"._T('info_ajouter_rubrique')."</b><br />";
+				}
+				echo "<INPUT NAME='id_auteur' VALUE='$id_auteur' TYPE='hidden'>";
+				echo "<SELECT NAME='add_rub' SIZE=1 CLASS='formo'>";
+				echo "<OPTION VALUE='0'>\n";
+				afficher_auteur_rubriques("0");
+				echo "</SELECT>";
+			}
+
+			echo "</div>\n";
+			echo fin_block();
+		}
+
+
+		if ($post) {
+			echo "<div align='$spip_lang_right'><input type='submit'
+			class='fondo' name='Valider'
+			value=\""._T('bouton_valider')."\" /></div>"; 
+			echo "</form>\n";
+		}
+
+		fin_cadre_relief();
+	}
+}
+
+function modifier_statut_auteur (&$auteur) {
+	global $connect_statut, $connect_toutes_rubriques, $_GET, $_POST;
+	// changer le statut ?
+	if ($connect_statut == '0minirezo' AND $_POST['statut']) {
+		if (ereg("^(0minirezo|1comite|5poubelle|6forum)$",$_POST['statut'])) {
+			$auteur['statut'] = $_POST['statut'];
+			spip_query("UPDATE spip_auteurs SET statut='".$_POST['statut']."'
+			WHERE id_auteur=".$auteur['id_auteur']);
+		}
+	}
+	// modif auteur restreint, seulement pour les admins
+	if ($connect_toutes_rubriques) {
+		if ($add_rub=intval($_POST['add_rub']))
+			spip_query("INSERT INTO spip_auteurs_rubriques
+			(id_auteur,id_rubrique)
+			VALUES(".$auteur['id_auteur'].", $add_rub)");
+
+		if ($supp_rub=intval($_GET['supp_rub']))
+			spip_query("DELETE FROM spip_auteurs_rubriques
+			WHERE id_auteur=".$auteur['id_auteur']."
+			AND id_rubrique=$supp_rub");
+	}
+}
+
 
 function initialiser_sel() {
 	global $htsalt;
@@ -109,6 +247,8 @@
 		return;
 	}
 
+	# remarque : ici on laisse passer les "nouveau" de maniere a leur permettre
+	# de devenir "1comite" le cas echeant (auth http)... a nettoyer
 	$query = "SELECT login, htpass FROM spip_auteurs WHERE statut != '5poubelle' AND statut!='6forum'";
 	$result = spip_query_db($query);	// attention, il faut au prealable se connecter a la base (necessaire car utilise par install.php3)
 	$logins = array();

Index: auteurs_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteurs_edit.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- auteurs_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ auteurs_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -51,7 +51,11 @@
 }
 
 
-$query = "SELECT * FROM spip_auteurs WHERE id_auteur='$id_auteur'";
+if (!$id_auteur = intval($id_auteur)) {
+	die ('erreur');
+}
+
+$query = "SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur";
 $result = spip_query($query);
 
 
@@ -72,6 +76,10 @@
 	$low_sec = $row["low_sec"];
 
 
+// Appliquer des modifications de statut
+modifier_statut_auteur($row);
+
+
 if ($connect_id_auteur == $id_auteur) debut_page($nom, "auteurs", "perso");
 else debut_page($nom,"auteurs","redacteurs");
 
@@ -108,14 +116,6 @@
 
 debut_droite();
 
-function mySel($varaut,$variable) {
-	$retour = " VALUE=\"$varaut\"";
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-	return $retour;
-}
-
 	debut_cadre_relief("redacteurs-24.gif");
 	
 	
@@ -151,6 +151,10 @@
 		extra_affichage($extra, "auteurs");
 	}
 
+	// Afficher le formulaire de changement de statut (cf. inc_acces.php3)
+	if ($options == 'avancees')
+		afficher_formulaire_statut_auteur ($id_auteur,
+			"auteurs_edit.php3?id_auteur=$id_auteur");
 
 	fin_cadre_relief();
 
@@ -167,7 +171,9 @@
 }
 
 
-if ($id_auteur != $connect_id_auteur) {
+if ($id_auteur != $connect_id_auteur
+AND ($statut == '0minirezo' OR $statut == '1comite')
+) {
 	echo "<div>&nbsp;</div>";
 	debut_cadre_couleur();
 	
@@ -179,7 +185,8 @@
 		"WHERE lien.id_auteur=$connect_id_auteur AND lien2.id_auteur = $id_auteur AND statut='publie' AND type='normal' AND rv='oui' AND date_fin > NOW() AND lien.id_message=messages.id_message AND lien2.id_message=messages.id_message";
 	afficher_messages(_T('info_vos_rendez_vous'), $query_message, false, false);
 	
-	icone_horizontale(_T('info_envoyer_message_prive'),"message_edit.php3?new=oui&type=normal&dest=$id_auteur", "message.gif");
+	icone_horizontale(_T('info_envoyer_message_prive'),
+		"message_edit.php3?new=oui&type=normal&dest=$id_auteur", "message.gif");
 	fin_cadre_couleur();
 }
 

Index: auteur_infos.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteur_infos.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- auteur_infos.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ auteur_infos.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -21,14 +21,6 @@
 // securite
 $id_auteur = floor($id_auteur);
 
-// menu statuts
-function mySel($varaut,$variable) {
-	$retour = " VALUE=\"$varaut\"";
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-	return $retour;
-}
 
 //
 // Auteurs a acces restreint
@@ -59,16 +51,6 @@
 	$i=$i-1;
 }
 
-// modif auteur restreint
-if ($connect_toutes_rubriques AND $add_rub=floor($add_rub)){
-	$query = "INSERT INTO spip_auteurs_rubriques (id_auteur,id_rubrique) VALUES($id_auteur,$add_rub)";
-	$result = spip_query($query);
-}
-if ($connect_toutes_rubriques AND $supp_rub=floor($supp_rub)){
-	$query = "DELETE FROM spip_auteurs_rubriques WHERE id_auteur=$id_auteur AND id_rubrique=$supp_rub";
-	$result = spip_query($query);
-}
-
 // securite
 if ($connect_statut != "0minirezo" AND $connect_id_auteur != $id_auteur) {
 	gros_titre(_T('info_acces_interdit'));
@@ -96,12 +78,8 @@
 //
 // Modification (et creation si besoin)
 //
-if ($statut) { // si on poste un statut, c'est qu'on modifie une fiche auteur
-	if ($connect_statut == '0minirezo' AND ereg("^(0minirezo|1comite|5poubelle|6forum)$",$statut))	// changer le statut
-		$auteur['statut'] = $statut;
-
-	if ($nom)	// pas de nom vide
-		$auteur['nom'] = corriger_caracteres($nom);
+if ($nom) { // si on poste un nom, c'est qu'on modifie une fiche auteur
+	$auteur['nom'] = corriger_caracteres($nom);
 
 	// login et mot de passe
 	unset ($modif_login);
@@ -164,8 +142,6 @@
 		}
 	}
 
-
-
 	// variables sans probleme
 	$auteur['bio'] = corriger_caracteres($bio);
 	$auteur['pgp'] = corriger_caracteres($pgp);
@@ -198,7 +174,7 @@
 
 			$id_auteur = $auteur['id_auteur'];
 
-			if (settype($ajouter_id_article,'integer') AND ($ajouter_id_article>0))
+			if ($ajouter_id_article = intval($ajouter_id_article))
 				spip_query("INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES ($id_auteur, $ajouter_id_article)");
 		}
 
@@ -209,19 +185,24 @@
 			email='".addslashes($auteur['email'])."',
 			nom_site='".addslashes($auteur['nom_site'])."',
 			url_site='".addslashes($auteur['url_site'])."',
-			pgp='".addslashes($auteur['pgp'])."',
-			statut='".addslashes($auteur['statut'])."'
+			pgp='".addslashes($auteur['pgp'])."'
 			$add_extra
 			WHERE id_auteur=".$auteur['id_auteur'];
 		spip_query($query) OR die($query);
 	}
+}
+
+// Appliquer des modifications de statut
+modifier_statut_auteur($auteur);
+
 
+// Si on modifie la fiche auteur, reindexer et modifier htpasswd
+if ($nom OR $statut) {
 	if (lire_meta('activer_moteur') == 'oui') {
 		include_ecrire ("inc_index.php3");
 		indexer_auteur($id_auteur);
 	}
 
-
 	// Mettre a jour les fichiers .htpasswd et .htpasswd-admin
 	ecrire_acces();
 }
@@ -390,7 +371,7 @@
 	echo "<INPUT TYPE='password' NAME='new_pass2' CLASS='formo' VALUE=\"\" SIZE='40'><P>\n";
 }
 fin_cadre_relief();
-echo "<p>";
+echo "<p />";
 
 
 //
@@ -423,79 +404,9 @@
 }
 
 
+// Afficher le formulaire de changement de statut (cf. inc_acces.php3)
+afficher_formulaire_statut_auteur ($id_auteur);
 
-//
-// Seuls les admins voient le menu 'statut', mais les admins restreints ne
-// pourront l'utiliser que pour mettre un auteur a la poubelle
-//
-
-$statut = $auteur['statut']; // pour aller plus vite
-
-if ($connect_statut == "0minirezo"
-	AND ($connect_toutes_rubriques OR $statut != "0minirezo")
-	AND $connect_id_auteur != $id_auteur) {
-	debut_cadre_relief();
-	echo "<center><B>"._T('info_statut_auteur')." </B> ";
-	echo " <SELECT NAME='statut' SIZE=1 CLASS='fondl'>";
-
-	if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques)
-		echo "<OPTION".mySel("0minirezo",$statut).">"._T('item_administrateur_2');
-
-	echo "<OPTION".mySel("1comite",$statut).">"._T('intem_redacteur');
-
-	if (($statut == '6forum') OR (lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo'))
-		echo "<OPTION".mySel("6forum",$statut).">"._T('item_visiteur');
-	echo "<OPTION".mySel("5poubelle",$statut).
-	  " style='background:url(" . _DIR_IMG_PACK . "rayures-sup.gif)'>&gt; "._T('texte_statut_poubelle');
-
-	echo "</SELECT></center>\n";
-	fin_cadre_relief();
-}
-else {
-	echo "<INPUT TYPE='Hidden' NAME='statut' VALUE=\"$statut\">";
-}
-
-//
-// Gestion restreinte des rubriques
-//
-if ($statut == '0minirezo') {
-	debut_cadre_enfonce("secteur-24.gif");
-
-	$query_admin = "SELECT lien.id_rubrique, titre FROM spip_auteurs_rubriques AS lien, spip_rubriques AS rubriques WHERE lien.id_auteur=$id_auteur AND lien.id_rubrique=rubriques.id_rubrique GROUP BY lien.id_rubrique";
-	$result_admin = spip_query($query_admin);
-
-	if (spip_num_rows($result_admin) == 0) {
-		echo _T('info_admin_gere_toutes_rubriques');
-	} else {
-		echo _T('info_admin_gere_rubriques')."\n";
-		echo "<ul style='list-style-image: url(" . _DIR_IMG_PACK . "rubrique-12.gif)'>";
-		while ($row_admin = spip_fetch_array($result_admin)) {
-			$id_rubrique = $row_admin["id_rubrique"];
-			$titre = typo($row_admin["titre"]);
-			echo "<li>$titre";
-			if ($connect_toutes_rubriques AND $connect_id_auteur != $id_auteur) {
-				echo " <font size=1>[<a href='auteur_infos.php3?id_auteur=$id_auteur&supp_rub=$id_rubrique'>"._T('lien_supprimer_rubrique')."</a>]</font>";
-			}
-			$toutes_rubriques .= "$id_rubrique,";
-		}
-		echo "</ul>";
-		$toutes_rubriques = ",$toutes_rubriques";
-	}
-
-	if ($connect_toutes_rubriques AND $connect_id_auteur != $id_auteur) {
-		if (spip_num_rows($result_admin) == 0) {
-			echo "<p><B>"._T('info_restreindre_rubrique')."</b><BR>";
-		} else {
-			echo "<p><B>"._T('info_ajouter_rubrique')."</b><BR>";
-		}
-		echo "<INPUT NAME='id_auteur' VALUE='$id_auteur' TYPE='hidden'>";
-		echo "<SELECT NAME='add_rub' SIZE=1 CLASS='formo'>";
-		echo "<OPTION VALUE='0'>   \n";
-		afficher_auteur_rubriques("0");
-		echo "</SELECT>";
-	}
-	fin_cadre_enfonce();
-}
 
 echo "<INPUT NAME='ajouter_id_article' VALUE='$ajouter_id_article' TYPE='hidden'>\n";
 echo "<INPUT NAME='redirect' VALUE='$redirect' TYPE='hidden'>\n";

Index: breves_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/breves_edit.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- breves_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ breves_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
@@ -15,16 +15,6 @@
 include_ecrire ("inc_documents.php3");
 include_ecrire ("inc_barre.php3");
 
-function mySel($varaut,$variable){
-		$retour= " VALUE=\"$varaut\"";
-
-	if ($variable==$varaut){
-		$retour.= " SELECTED";
-	}
-
-	return $retour;
-}
-
 function enfant($leparent) {
 	global $id_parent;
 	global $id_rubrique;

Index: inc_calendrier.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_calendrier.php,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_calendrier.php	25 Feb 2005 16:35:57 -0000	1.3
+++ inc_calendrier.php	3 Mar 2005 14:54:56 -0000	1.4
@@ -608,7 +608,7 @@
 {
   global $bleu, $jaune, $vert;
   $href = "message_edit.php3?rv=$annee-$mois-$jour&new=oui";
-  $script = 'calendrier.php3' ; // ok pour espace de redac, pas pour public
+  $script =  $GLOBALS['PHP_SELF'] ;
   return "\n" .
     http_href("$script?type=jour&jour=$jour&mois=$mois&annee=$annee", $clic) .
     "\n" .
@@ -735,7 +735,8 @@
 
 function http_calendrier_agenda ($mois, $annee, $jour_ved, $mois_ved, $annee_ved, $semaine = false,  $script='', $ancre='') {
 
-  if (!$script) $script =  'calendrier.php3?' ;
+  if (!$script) $script =  $GLOBALS['PHP_SELF'] ;
+  if (!strpos($script, '?')) $script .= '?';
   if (!$mois) {$mois = 12; $annee--;}
   elseif ($mois==13) {$mois = 1; $annee++;}
   return 



From stef at berlios.de  Thu Mar  3 15:55:19 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 3 Mar 2005 15:55:19 +0100
Subject: [Spip-carto-cvs] spipcarto/dist nouveautes.html,1.2,1.3 auteur.html,1.2,1.3 plan.html,1.2,1.3 login.html,1.2,1.3 recherche.html,1.2,1.3 mot.html,1.2,1.3 site.html,1.2,1.3 sommaire_texte.html,1.2,1.3 404.html,1.2,1.3 rubrique.html,1.2,1.3 sommaire.html,1.2,1.3 article.html,1.2,1.3 forum.html,1.2,1.3 resume.html,1.2,1.3 breve.html,1.2,1.3
Message-ID: <200503031455.j23EtJNx006723@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/dist
In directory sheep:/tmp/cvs-serv6655/spipcarto/dist

Modified Files:
	nouveautes.html auteur.html plan.html login.html 
	recherche.html mot.html site.html sommaire_texte.html 404.html 
	rubrique.html sommaire.html article.html forum.html 
	resume.html breve.html 
Log Message:
1.8pr1 cvs 20050303

Index: nouveautes.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/nouveautes.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- nouveautes.html	20 Feb 2005 22:17:12 -0000	1.2
+++ nouveautes.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -32,4 +32,4 @@
 
 -> #URL_SITE_SPIP/#URL_BREVE
 
-</BOUCLE_nv2></BOUCLE0>
\ No newline at end of file
+</BOUCLE_nv2></BOUCLE0>

Index: auteur.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/auteur.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- auteur.html	20 Feb 2005 22:17:12 -0000	1.2
+++ auteur.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,6 +1,6 @@
 <BOUCLE_auteur_principal(AUTEURS) {id_auteur}
 ><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[(#NOM|textebrut)]</title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -17,7 +17,7 @@
 <link rel="stylesheet" href="impression.css" type="text/css" media="print">
 </head>
 
-<body bgcolor="white">
+<body>
 
 <div id="navigation">
 
@@ -65,7 +65,7 @@
 </div>
 
 [<p><b><:envoyer_message:></b></p>
-<div class='spip_encadrer'><b>(#FORMULAIRE_ECRIRE_AUTEUR)</b></div>]
+<div class='spip_encadrer'>(#FORMULAIRE_ECRIRE_AUTEUR)</div>]
 
 <!-- Articles de l'auteur -->
 

Index: plan.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/plan.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- plan.html	20 Feb 2005 22:17:12 -0000	1.2
+++ plan.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[#NOM_SITE_SPIP] </title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -14,7 +14,7 @@
 <link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 
 <!-- Plan du site -->

Index: login.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/login.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- login.html	20 Feb 2005 22:17:12 -0000	1.2
+++ login.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,11 +1,11 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 	<title><:login_acces_prive:></title>
 	<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
 	<link rel="stylesheet" href="spip_style.css" type="text/css">
 </head>
-<body dir="#LANG_DIR" bgcolor="#ffffff" text="#000000" link="#e86519" vlink="#6e003a" alink="#ff9900">
+<body bgcolor="#ffffff" text="#000000" link="#e86519" vlink="#6e003a" alink="#ff9900">
 
 <br><br><br><center><table width="400"><tr><td width="400">
 <div align="center">

Index: recherche.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/recherche.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- recherche.html	20 Feb 2005 22:17:12 -0000	1.2
+++ recherche.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,6 +1,6 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
 
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title><:resultats_recherche:></title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -17,7 +17,7 @@
 <link rel="stylesheet" href="impression.css" type="text/css" media="print">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 <div id="navigation">
 

Index: mot.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/mot.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- mot.html	20 Feb 2005 22:17:12 -0000	1.2
+++ mot.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,7 +1,7 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
 <BOUCLE_mot_principal(MOTS) {id_mot} {doublons}>
 
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[(#TITRE|textebrut)]</title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -18,7 +18,7 @@
 <link rel="stylesheet" href="impression.css" type="text/css" media="print">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 <div id="navigation">
 

Index: site.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/site.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- site.html	20 Feb 2005 22:17:12 -0000	1.2
+++ site.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,8 +1,6 @@
 <BOUCLE_site(SITES){id_syndic}
 ><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-
-
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[(#NOM_SITE|textebrut)]</title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -19,7 +17,7 @@
 <link rel="stylesheet" href="impression.css" type="text/css" media="print">
 </head>
 
-<body bgcolor="white">
+<body>
 
 <div id="navigation">
 

Index: sommaire_texte.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/sommaire_texte.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- sommaire_texte.html	20 Feb 2005 22:17:12 -0000	1.2
+++ sommaire_texte.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <!--
 // ACCESSIBILITE
 // la page /oo offre une lecture en mode "texte seul"
@@ -13,7 +13,7 @@
 	<meta http-equiv="AUTHOR" content="#NOM_SITE_SPIP">
 	<meta http-equiv="DESCRIPTION" content="Edition en mode texte de #NOM_SITE_SPIP">
 </head>
-<body dir="#LANG_DIR">
+<body>
 	<hr />
 	<:edition_mode_texte:> <a href="#URL_SITE_SPIP">{#NOM_SITE_SPIP}</a>
 	<hr />

Index: 404.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/404.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- 404.html	20 Feb 2005 22:17:12 -0000	1.2
+++ 404.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 	<title>[#NOM_SITE_SPIP - <:pass_erreur:> 404]</title>
 	<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -14,7 +14,7 @@
 	<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
 
 </head>
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 
 
@@ -47,4 +47,4 @@
 #SPIP_CRON
 
 </body>
-</html>
\ No newline at end of file
+</html>

Index: rubrique.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/rubrique.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- rubrique.html	20 Feb 2005 22:17:12 -0000	1.2
+++ rubrique.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,6 +1,6 @@
 <BOUCLE_rubrique_principal(RUBRIQUES) {id_rubrique}
 ><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[(#TITRE|textebrut)]</title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -20,7 +20,7 @@
 <link rel="alternate" type="application/rss+xml" title="<:syndiquer_rubrique:>" href="backend.php3?id_rubrique=#ID_RUBRIQUE">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 <div id="navigation">
 

Index: sommaire.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/sommaire.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- sommaire.html	20 Feb 2005 22:17:12 -0000	1.2
+++ sommaire.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[#NOM_SITE_SPIP] </title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -17,7 +17,7 @@
 <link rel="alternate" type="application/rss+xml" title="<:syndiquer_site:>" href="backend.php3">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 <div id="navigation">
 

Index: article.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/article.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- article.html	20 Feb 2005 22:17:12 -0000	1.2
+++ article.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,5 +1,5 @@
 <BOUCLE_article_principal(ARTICLES) {id_article}><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[(#TITRE|textebrut)]</title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -15,7 +15,7 @@
 <link rel="stylesheet" href="impression.css" type="text/css" media="print">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 <div id="navigation">
 
 <h1 class="structure"><:navigation:></h1>
@@ -202,7 +202,7 @@
 <div><hr>
 <BOUCLE_documents_portfolio(DOCUMENTS){id_article}{mode=document}{fichier==(png|jpg|gif)$}{doublons}>
 	<div style="float: left;">
-	[<a href="article.php3?id_article=#ID_ARTICLE&id_document=#ID_DOCUMENT">(#LOGO_DOCUMENT||reduire_image{1000,52})</a>][<div><b>(#TITRE)</b></div>][<div>(#DESCRIPTIF)</div>]
+	[<a href="article.php3?id_article=#ID_ARTICLE&amp;id_document=#ID_DOCUMENT">(#LOGO_DOCUMENT||reduire_image{1000,52})</a>][<div><b>(#TITRE)</b></div>][<div>(#DESCRIPTIF)</div>]
 	</div>
 </BOUCLE_documents_portfolio>
 </div>
@@ -229,9 +229,9 @@
 <table class="signatures">
 <thead class="structure">
 <tr>
-	<td><:date:></td>
-	<td><:nom:></td>
-	<td><:message:></td>
+	<th><:date:></th>
+	<th><:nom:></th>
+	<th><:message:></th>
 </tr>
 </thead>
 <tbody>]
@@ -239,7 +239,7 @@
 <BOUCLE_signatures(SIGNATURES) {id_article} {par date} {inverse} {debut_signatures,30}>
 <tr>
 	<td class="signature-date">[(#DATE|affdate_court)]</td>
-	<td class="signature-nom">#NOM[<br><a href="#URL_SITE">(#NOM_SITE)</a>]</td>
+	<td class="signature-nom">#NOM[ <a href="#URL_SITE">(#NOM_SITE)</a>]</td>
 	[<td class="signature-message">(#MESSAGE)</td>]
 </tr>
 </BOUCLE_signatures>
@@ -311,4 +311,4 @@
 
 </body>
 </html>
-</BOUCLE_article_principal>
\ No newline at end of file
+</BOUCLE_article_principal>

Index: forum.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/forum.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- forum.html	20 Feb 2005 22:17:12 -0000	1.2
+++ forum.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[#NOM_SITE_SPIP] <:poster_message:></title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -14,7 +14,7 @@
 <link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 
 <div id="navigation">

Index: resume.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/resume.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- resume.html	20 Feb 2005 22:17:12 -0000	1.2
+++ resume.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>[#NOM_SITE_SPIP] </title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -14,7 +14,7 @@
 <link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 <div id="navigation">
 

Index: breve.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/breve.html,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- breve.html	20 Feb 2005 22:17:12 -0000	1.2
+++ breve.html	3 Mar 2005 14:55:16 -0000	1.3
@@ -1,6 +1,6 @@
 <BOUCLE_breve_principal(BREVES) {id_breve}
 ><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
-<html lang="#LANG">
+<html dir="#LANG_DIR" lang="#LANG">
 <head>
 <title>#TITRE</title>
 <meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
@@ -17,7 +17,7 @@
 <link rel="stylesheet" href="impression.css" type="text/css" media="print">
 </head>
 
-<body bgcolor="white" dir="#LANG_DIR">
+<body>
 
 
 <div id="navigation">



From stef at berlios.de  Thu Mar  3 15:55:19 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 3 Mar 2005 15:55:19 +0100
Subject: [Spip-carto-cvs] spipcarto inc-admin.php3,1.3,1.4 spip_style.css,1.3,1.4 spip_cookie.php3,1.3,1.4 inc-cache.php3,1.4,1.5 habillage.css,1.4,1.5 inc-calcul-outils.php3,1.3,1.4 inc-public-global.php3,1.4,1.5 inc-balises.php3,1.3,1.4
Message-ID: <200503031455.j23EtJNx006726@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv6655/spipcarto

Modified Files:
	inc-admin.php3 spip_style.css spip_cookie.php3 inc-cache.php3 
	habillage.css inc-calcul-outils.php3 inc-public-global.php3 
	inc-balises.php3 
Log Message:
1.8pr1 cvs 20050303

Index: inc-admin.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-admin.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-admin.php3	20 Feb 2005 22:15:59 -0000	1.3
+++ inc-admin.php3	3 Mar 2005 14:55:17 -0000	1.4
@@ -16,9 +16,9 @@
 // Feuilles de style admin : d'abord la CSS officielle, puis la perso,
 
 function affiche_boutons_admin($contenu) {
-	$css = "<link rel='stylesheet' href='spip_admin.css' type='text/css' />\n";
+	$css = "<link rel='stylesheet' href='spip_admin.css' type='text/css'>\n";
 	if ($f = find_in_path('spip_admin_perso.css'))
-		$css .= "<link rel='stylesheet' href='$f' type='text/css' />\n";
+		$css .= "<link rel='stylesheet' href='$f' type='text/css'>\n";
 
 	if (preg_match('@<(/head|body)@i', $contenu, $regs)) {
 		$contenu = explode($regs[0], $contenu, 2);

Index: spip_style.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_style.css,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- spip_style.css	20 Feb 2005 22:16:48 -0000	1.3
+++ spip_style.css	3 Mar 2005 14:55:17 -0000	1.4
@@ -28,6 +28,7 @@
 
 .spip_puce {
 	list-style-position: inside;
+	border-width: 0px;
 }
 
 .spip_documents{

Index: spip_cookie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cookie.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- spip_cookie.php3	20 Feb 2005 22:16:48 -0000	1.3
+++ spip_cookie.php3	3 Mar 2005 14:55:17 -0000	1.4
@@ -121,8 +121,7 @@
 	include_local(_FILE_CONNECT); // pour savoir si ldap est present 
 	if ($ldap_present) $auths[] = 'ldap';
 	$ok = false;
-	reset($auths);
-	while (list(, $nom_auth) = each($auths)) {
+	foreach ($auths as $nom_auth) {
 		include_ecrire("inc_auth_".$nom_auth.".php3");
 		$classe_auth = "Auth_".$nom_auth;
 		$auth = new $classe_auth;
@@ -136,6 +135,8 @@
 	}
 
 	if ($ok) {
+		// Nouveau redacteur ou visiteur inscrit par mail :
+		// 'nouveau' -> '1comite' ou  '6forum'
 		$auth->activer();
 
 		if ($auth->login AND $auth->statut == '0minirezo') // force le cookie pour les admins

Index: inc-cache.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-cache.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-cache.php3	25 Feb 2005 16:35:58 -0000	1.4
+++ inc-cache.php3	3 Mar 2005 14:55:17 -0000	1.5
@@ -36,7 +36,7 @@
 //
 function generer_nom_fichier_cache($contexte='', $fond='') {
 	global $delais;
-	global $flag_gz, $compresser_cache;
+	global $flag_gz;
 
 	if ($delais == 0) return '';
 
@@ -73,7 +73,7 @@
 	include_ecrire('inc_acces.php3');
 	verifier_htaccess(_DIR_CACHE);
 
-	$gzip = $flag_gz && $compresser_cache ? '.gz' : '';
+	$gzip = $flag_gz ? '.gz' : '';
 
 	return _DIR_CACHE . $subdir.$subdir2.$fichier_cache.$gzip;
 }

Index: habillage.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/habillage.css,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- habillage.css	25 Feb 2005 16:35:58 -0000	1.4
+++ habillage.css	3 Mar 2005 14:55:17 -0000	1.5
@@ -183,12 +183,10 @@
 	margin-bottom: 0em;
 }
 
-.cartouche .spip_logos {
-	margin-left: 0px;
-	padding-left: 0px;
-	margin-right: 0.8em;
+.spip_logos {
+	margin: 3px;
+	border-width: 0px;
 }
-
 
 /*
  * Habillage du plan du site

Index: inc-calcul-outils.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-calcul-outils.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-calcul-outils.php3	20 Feb 2005 22:15:59 -0000	1.3
+++ inc-calcul-outils.php3	3 Mar 2005 14:55:17 -0000	1.4
@@ -36,28 +36,23 @@
 }
 
 // Renvoie le code html pour afficher un logo, avec ou sans survol, lien, etc.
-// utilise la globale ci-dessous pour les attributs hspace & vspace
-
-tester_variable('espace_logos',3);
 
 function affiche_logos($logos, $lien, $align) {
 	static $num_survol=0;
-	global $espace_logos;
+
 	list ($arton, $artoff) = $logos;
 
 	if (!$arton) return $artoff;
 
 	$num_survol++;
-	$milieu = "<img src='$arton'"
+	$milieu = "<img src='$arton'\nalt='image$num_survol'"
 		. ($align ? " align='$align' " : '') 
-		. " name='image$num_survol' border='0' "
-		. "alt='image$num_survol'"
-		. " hspace='$espace_logos' vspace='$espace_logos' class='spip_logos' />";
+		. " class='spip_logos' />";
 
 	if (!$artoff) return ($lien ? http_href($lien, $milieu) : $milieu);
 
-	$att =	"onmouseover=\"image$num_survol.src='$artoff'\" 
-		onmouseout=\"image$num_survol.src='$arton'\"";
+	$att =	"onmouseover=\"this.firstChild.src='$artoff'\" 
+		onmouseout=\"this.firstChild.src='$arton'\"";
 
 	return ($lien ? "<a href='$lien' $att>$milieu</a>" : "<div $att>$milieu</div>");
 

Index: inc-public-global.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-public-global.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-public-global.php3	25 Feb 2005 16:35:58 -0000	1.4
+++ inc-public-global.php3	3 Mar 2005 14:55:17 -0000	1.5
@@ -225,6 +225,7 @@
 			retire_caches($chemin_cache);
 	}
 
+
 	// Peut-on utiliser un fichier cache ?
 	determiner_cache($delais, $use_cache, $chemin_cache);
 
@@ -283,6 +284,7 @@
 		include_ecrire('inc_lang.php3');
 		include_ecrire('inc_filtres.php3');
 		lang_select($GLOBALS['auteur_session']['lang']);
+		$x = majuscules(_T('previsualisation'));
 		$page['texte'] .= '<div style="
 		display: block;
 		color: #eeeeee;
@@ -294,9 +296,9 @@
 		top: 0px;
 		left: 0px;
 		position: absolute;
-		"><img src="' . _DIR_IMG_PACK
-		. 'naviguer-site.png" align="left" border="0" />&nbsp; '
-		. majuscules(_T('previsualisation')).'</div>';
+		">' 
+		  . http_img_pack('naviguer-site.png', $x, '')
+		  ."&nbsp;$x</div>";
 	}
 
 	return $page;

Index: inc-balises.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-balises.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-balises.php3	20 Feb 2005 22:15:59 -0000	1.3
+++ inc-balises.php3	3 Mar 2005 14:55:17 -0000	1.4
@@ -395,12 +395,12 @@
 
 function balise_DEBUT_SURLIGNE_dist($p) {
 	global $flag_pcre;
-	$p->code = ($flag_pcre ? ('\'<span class="spip_surligneconditionnel">\'') : "''");
+	$p->code = ($flag_pcre ? ("'<" . MARQUEUR_SURLIGNE . "'") : "''");
 	return $p;
 }
 function balise_FIN_SURLIGNE_dist($p) {
 	global $flag_pcre;
-	$p->code = ($flag_pcre ? ('\'</span class="spip_surligneconditionnel">\'') : "''");
+	$p->code = ($flag_pcre ? ("'<" . MARQUEUR_FSURLIGNE . "'") : "''");
 	return $p;
 }
 



From stef at berlios.de  Thu Mar  3 15:58:48 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 3 Mar 2005 15:58:48 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/data remove.txt,NONE,1.1
Message-ID: <200503031458.j23EwmNx007261@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/data
In directory sheep:/tmp/cvs-serv7237/spipcarto/ecrire/data

Added Files:
	remove.txt 
Log Message:
pour repertoire non vide

--- NEW FILE: remove.txt ---
Vous pouvez effacer ce fichier sans dommages.

You can safely remove this file.



From stef at berlios.de  Thu Mar  3 15:59:25 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 3 Mar 2005 15:59:25 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/data .cvsignore,NONE,1.1
Message-ID: <200503031459.j23ExPNx007374@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/data
In directory sheep:/tmp/cvs-serv7344/spipcarto/ecrire/data

Added Files:
	.cvsignore 
Log Message:
pratique pour tester directement sur le repertoire synchronis? avec le cvs

--- NEW FILE: .cvsignore ---
session_*
.htaccess
.htpasswd
.htpasswd-admin
spip.log*
inc_meta_cache.php3
.index



From stef at berlios.de  Fri Mar  4 11:45:03 2005
From: stef at berlios.de (stef at berlios.de)
Date: Fri, 4 Mar 2005 11:45:03 +0100
Subject: [Spip-carto-cvs] spipcarto inc-cache.php3,1.5,1.6 inc-balises.php3,1.4,1.5
Message-ID: <200503041045.j24Aj3Nx013325@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv13273/spipcarto

Modified Files:
	inc-cache.php3 inc-balises.php3 
Log Message:
1.8PR1 CVS 20050304

Index: inc-cache.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-cache.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc-cache.php3	3 Mar 2005 14:55:17 -0000	1.5
+++ inc-cache.php3	4 Mar 2005 10:45:01 -0000	1.6
@@ -100,10 +100,6 @@
 function retire_caches($chemin = '') {
 	if (!_DIR_RESTREINT) return;
 
-	// signaler
-	effacer_meta('invalider');
-	ecrire_metas();
-
 	// recuperer la liste des caches voues a la suppression
 	$suppr = array();
 
@@ -116,10 +112,17 @@
 	}
 
 	// Et puis une centaine d'autres
-	$q = spip_query("SELECT fichier FROM spip_caches
-	WHERE type='x' LIMIT 0,100");
-	while ($r = spip_fetch_array($q))
-		$suppr[$r['fichier']] = true;
+	if (lire_meta('invalider_caches')) {
+		$on_efface = true;
+		effacer_meta('invalider_caches'); # concurrence
+		ecrire_metas();
+
+		$q = spip_query("SELECT fichier FROM spip_caches
+		WHERE type='x' LIMIT 0,100");
+		while ($r = spip_fetch_array($q))
+			$suppr[$r['fichier']] = true;
+	}
+
 
 	if ($n = count($suppr)) {
 		spip_log ("Retire $n caches");
@@ -127,12 +130,15 @@
 			retire_cache($cache);
 		spip_query("DELETE FROM spip_caches WHERE "
 		.calcul_mysql_in('fichier', "'".join("','",array_keys($suppr))."'") );
+	}
 
-		// signaler aux suivants
-		if ($n>99) {
-			ecrire_meta('invalider', 'oui');
-			ecrire_metas();
-		}
+	// signaler aux suivants
+	if ($on_efface) {
+		if ($n>99)
+			ecrire_meta('invalider_caches', 'oui');
+		else
+			effacer_meta('invalider');
+		ecrire_metas();
 	}
 }
 

Index: inc-balises.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-balises.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-balises.php3	3 Mar 2005 14:55:17 -0000	1.4
+++ inc-balises.php3	4 Mar 2005 10:45:01 -0000	1.5
@@ -394,11 +394,13 @@
 // flag_pcre est juste une flag signalant que preg_match est dispo.
 
 function balise_DEBUT_SURLIGNE_dist($p) {
+	include_ecrire('inc_surligne.php3');
 	global $flag_pcre;
 	$p->code = ($flag_pcre ? ("'<" . MARQUEUR_SURLIGNE . "'") : "''");
 	return $p;
 }
 function balise_FIN_SURLIGNE_dist($p) {
+	include_ecrire('inc_surligne.php3');
 	global $flag_pcre;
 	$p->code = ($flag_pcre ? ("'<" . MARQUEUR_FSURLIGNE . "'") : "''");
 	return $p;



From stef at berlios.de  Fri Mar  4 11:45:03 2005
From: stef at berlios.de (stef at berlios.de)
Date: Fri, 4 Mar 2005 11:45:03 +0100
Subject: [Spip-carto-cvs] spipcarto/dist nouveautes.html,1.3,1.4
Message-ID: <200503041045.j24Aj3Nx013321@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/dist
In directory sheep:/tmp/cvs-serv13273/spipcarto/dist

Modified Files:
	nouveautes.html 
Log Message:
1.8PR1 CVS 20050304

Index: nouveautes.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/dist/nouveautes.html,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- nouveautes.html	3 Mar 2005 14:55:16 -0000	1.3
+++ nouveautes.html	4 Mar 2005 10:45:00 -0000	1.4
@@ -1,25 +1,26 @@
 [[(#NOM_SITE_SPIP|textebrut|texte_script)]] <:nouveautes|texte_script:>
 
-<B0>
+
 <:bonjour|texte_script:>
 
 <:texte_lettre_information|texte_script:> "[(#NOM_SITE_SPIP|textebrut|texte_script)]" (#URL_SITE_SPIP).
 <:texte_lettre_information_2|texte_script:> [(#ENV{jours_neuf})] <:jours|texte_script:>.
 
-<BOUCLE0(AUTEURS){0,1}><B_nv1>
+<B_nv1>
           <:nouveaux_articles|texte_script:>
           --------------------------
 
 <BOUCLE_nv1(ARTICLES){age_relatif<=0}{par date}{inverse}{0,30}>
 [** (#TITRE|textebrut|texte_script) **]
-[par (#LESAUTEURS|textebrut|texte_script)]
-[le (#DATE|affdate|texte_script)]
+[par (#LESAUTEURS|textebrut|texte_script) ][le (#DATE|affdate|texte_script)
 
-[(#INTRODUCTION|textebrut|texte_script)]
 
--> #URL_SITE_SPIP/#URL_ARTICLE
+][(#INTRODUCTION|textebrut|texte_script)
 
-</BOUCLE_nv1><B_nv2>
+
+]-> #URL_SITE_SPIP/#URL_ARTICLE
+</BOUCLE_nv1>
+<B_nv2>
           
           <:nouvelles_breves|texte_script:>
           --------------------------
@@ -32,4 +33,4 @@
 
 -> #URL_SITE_SPIP/#URL_BREVE
 
-</BOUCLE_nv2></BOUCLE0>
+</BOUCLE_nv2>



From stef at berlios.de  Fri Mar  4 11:45:46 2005
From: stef at berlios.de (stef at berlios.de)
Date: Fri, 4 Mar 2005 11:45:46 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_presentation.php3,1.3,1.4
Message-ID: <200503041045.j24AjkNx013397@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv13371/spipcarto/ecrire

Modified Files:
	inc_presentation.php3 
Log Message:
Correction bug (fonction de selection non report?e)

Index: inc_presentation.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_presentation.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_presentation.php3	25 Feb 2005 16:35:57 -0000	1.3
+++ inc_presentation.php3	4 Mar 2005 10:45:44 -0000	1.4
@@ -2588,7 +2588,7 @@
 			$gadget .= "<table><tr>";
 			$gadget .= "<td valign='top' width='200'>";
 				$gadget .= "<div>";
-				$gadget .= http_calendrier_agenda($mois_today, $annee_today, $jour_today, $mois_today, $annee_today);
+				$gadget .= http_calendrier_agenda($mois_today, $annee_today, $jour_today, $mois_today, $annee_today, false, 'calendrier.php3');
 				$gadget .= "</div>";
 				$gadget .= "</td>";
 				if ($afficher_cal) {
@@ -3054,6 +3054,17 @@
 		echo $parents;
 		
 	}
+}
+
+// Pour construire des menu avec SELECTED
+function mySel($varaut,$variable, $option = NULL) {
+	if (!isset($option))
+		return ' value="'.$varaut.'"'
+			. (($variable==$varaut) ? ' selected' : '');
+
+	return "<option value='$varaut'"
+		. (($variable==$varaut) ? ' selected' : '')
+		. ">$option\n";
 }
 
 



From stef at berlios.de  Fri Mar  4 11:45:03 2005
From: stef at berlios.de (stef at berlios.de)
Date: Fri, 4 Mar 2005 11:45:03 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_version.php3,1.3,1.4 inc_surligne.php3,1.3,1.4 inc_invalideur.php3,1.3,1.4 inc_rubriques.php3,1.2,1.3
Message-ID: <200503041045.j24Aj3Nx013330@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv13273/spipcarto/ecrire

Modified Files:
	inc_version.php3 inc_surligne.php3 inc_invalideur.php3 
	inc_rubriques.php3 
Log Message:
1.8PR1 CVS 20050304

Index: inc_version.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_version.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_version.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_version.php3	4 Mar 2005 10:45:01 -0000	1.4
@@ -445,11 +445,6 @@
 $flag_gd = $flag_ImageGif || $flag_ImageJpeg || $flag_ImagePng;
 $flag_revisions = ($flag_pcre AND function_exists("gzcompress"));
 
-// deux constantes pour le surlignage (cf inc_surligne et inc-balise)
-
-define("MARQUEUR_SURLIGNE",  'span class="spip_surligneconditionnel">');
-define("MARQUEUR_FSURLIGNE", '/span                                 >'); 
-
 //
 // Appliquer le prefixe cookie
 //

Index: inc_surligne.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_surligne.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_surligne.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_surligne.php3	4 Mar 2005 10:45:01 -0000	1.4
@@ -16,6 +16,9 @@
 if (defined("_ECRIRE_INC_SURLIGNE")) return;
 define("_ECRIRE_INC_SURLIGNE", "1");
 
+define("MARQUEUR_SURLIGNE",  'span class="spip_surligneconditionnel">');
+define("MARQUEUR_FSURLIGNE", '/span                                 >');    
+
 // Balises qui ne font rien en mode normal
 // mais  vont etre substitue'es en mode recherche
 // voir les champs SURLIGNE dans inc-index-squel

Index: inc_invalideur.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_invalideur.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_invalideur.php3	25 Feb 2005 16:35:57 -0000	1.3
+++ inc_invalideur.php3	4 Mar 2005 10:45:01 -0000	1.4
@@ -101,12 +101,16 @@
 		spip_query("UPDATE spip_caches SET type='x'"
 		. ' WHERE ' . calcul_mysql_in('fichier', $tous));
 
-		// Si on est dans ecrire, demander a inc-public.php3
-		// de retirer les caches invalide's ; sinon le faire soi-meme
-		// ce qui evite des chevauchements dans la validation des forums
-		// [ A valide un forum, B obtient de purger les invalides, et A
-		//   trouve son cache avant que B n'ait eu le temps de le purger ]
-		ecrire_meta('invalider', 'oui');
+		// Demander a inc-public.php3 de retirer les caches
+		// invalides ;
+		// - le signal (meta='invalider') indique
+		// qu'il faut faire attention ;
+		// - le signal (meta='invalider_caches') indique qu'on
+		// peut effacer 100 caches invalides
+		// (Signaux differents pour eviter de la concurrence entre
+		// les processus d'invalidation)
+		ecrire_meta('invalider', 'oui'); // se verifier soi-meme
+		ecrire_meta('invalider_caches', 'oui'); // supprimer les autres
 		ecrire_metas();
 		if (_DIR_RESTREINT) {
 			include_local('inc-cache.php3');

Index: inc_rubriques.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_rubriques.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_rubriques.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_rubriques.php3	4 Mar 2005 10:45:01 -0000	1.3
@@ -44,7 +44,7 @@
 	$r = spip_query("SELECT rub.id_rubrique AS id, max(fille.date) AS date_h
 	FROM spip_rubriques AS rub, spip_articles AS fille
 	WHERE rub.id_rubrique = fille.id_rubrique AND fille.statut='publie'
-	$postdates GROUP BY fille.id_rubrique");
+	$postdates GROUP BY rub.id_rubrique");
 	while ($row = spip_fetch_array($r))
 		spip_query("UPDATE spip_rubriques
 		SET statut_tmp='publie', date_tmp='".$row['date_h']."'
@@ -56,7 +56,7 @@
 	FROM spip_rubriques AS rub, spip_breves AS fille
 	WHERE rub.id_rubrique = fille.id_rubrique
 	AND rub.date_tmp <= fille.date_heure AND fille.statut='publie'
-	GROUP BY fille.id_rubrique");
+	GROUP BY rub.id_rubrique");
 	while ($row = spip_fetch_array($r))
 		spip_query("UPDATE spip_rubriques
 		SET statut_tmp='publie', date_tmp='".$row['date']."'
@@ -66,7 +66,8 @@
 	$r = spip_query("SELECT rub.id_rubrique AS id, max(fille.date) AS date_h
 	FROM spip_rubriques AS rub, spip_syndic AS fille
 	WHERE rub.id_rubrique = fille.id_rubrique AND rub.date_tmp <= fille.date
-	AND fille.statut='publie' GROUP BY fille.id_rubrique");
+	AND fille.statut='publie'
+	GROUP BY rub.id_rubrique");
 	while ($row = spip_fetch_array($r))
 		spip_query("UPDATE spip_rubriques
 		SET statut_tmp='publie', date_tmp='".$row['date_h']."'
@@ -78,7 +79,7 @@
 	spip_documents_rubriques AS lien
 	WHERE rub.id_rubrique = lien.id_rubrique
 	AND lien.id_document=fille.id_document AND rub.date_tmp <= fille.date
-	GROUP BY lien.id_rubrique");
+	GROUP BY rub.id_rubrique");
 	while ($row = spip_fetch_array($r))
 		spip_query("UPDATE spip_rubriques
 		SET statut_tmp='publie', date_tmp='".$row['date_h']."'
@@ -95,7 +96,7 @@
 		WHERE rub.id_rubrique = fille.id_parent
 		AND (rub.date_tmp < fille.date_tmp OR rub.statut_tmp<>'publie')
 		AND fille.statut_tmp='publie'
-		GROUP BY fille.id_parent");
+		GROUP BY rub.id_rubrique");
 		while ($row = spip_fetch_array($r)) {
 			spip_query("UPDATE spip_rubriques
 			SET statut_tmp='publie', date_tmp='".$row['date_h']."'



From stef at berlios.de  Fri Mar  4 13:04:19 2005
From: stef at berlios.de (stef at berlios.de)
Date: Fri, 4 Mar 2005 13:04:19 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire carte_edit.php3,1.6,1.7
Message-ID: <200503041204.j24C4JNx026935@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv26908/spipcarto/ecrire

Modified Files:
	carte_edit.php3 
Log Message:
bug passage par copie dans la class link (PHP5 ?)

Index: carte_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/carte_edit.php3,v
retrieving revision 1.6
retrieving revision 1.7
diff -u -d -r1.6 -r1.7
--- carte_edit.php3	1 Mar 2005 17:36:25 -0000	1.6
+++ carte_edit.php3	4 Mar 2005 12:04:15 -0000	1.7
@@ -82,6 +82,10 @@
 $carte_link = new Link("carte_edit.php3");
 $carte_link->addVar('id_carte', $id_carte);
 if ($retour) $carte_link->addVar('retour', $retour);
+$carte_supplink = new Link("carte_edit.php3");
+$carte_supplink->addVar('id_carte', $id_carte);
+$carte_supplink->addVar('supp_carte', $id_carte);
+if ($retour) $carte_supplink->addVar('retour', $retour);
 
 //
 // Modifications des objets de la carte
@@ -166,8 +170,8 @@
 if ($supp_carte && !$supp_confirme && !$supp_rejet) {
 	echo "<p><strong>"._L("Attention :")."</strong> ";
 	echo _L("Voulez-vous vraiment supprimer cette carte ?")."</p>\n";
-	$link = $carte_link;//new Link();
-	$link->addVar('supp_carte', $supp_carte);
+	$link = $carte_supplink;//new Link();
+	//$link->addVar('supp_carte', $supp_carte);
 	echo $link->getform('GET');
 	echo "<input type='submit' name='supp_confirme' value=\""._T('item_oui')."\" class='fondl'>";
 	echo " &nbsp; ";
@@ -238,11 +242,11 @@
 if ($id_carte && carte_administrable($id_carte)) {
 	echo "<br />\n";
 	echo "<div align='$spip_lang_right'>";
-	$link = $carte_link;
-	$link->addVar('supp_carte', $id_carte);
-	if (!$retour) {
-		$link->addVar('retour', 'cartes.php3');
-	}
+	$link = $carte_supplink;
+	//$link->addVar('supp_carte', $id_carte);
+	//if (!$retour) {
+	//	$link->addVar('retour', 'cartes.php3');
+	//}
 	//if (!$nb_reponses) {
 	//	$link->addVar('supp_confirme', 'oui');
 	//}



From stef at berlios.de  Fri Mar  4 13:05:42 2005
From: stef at berlios.de (stef at berlios.de)
Date: Fri, 4 Mar 2005 13:05:42 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire spip_style.php3,1.3,1.4
Message-ID: <200503041205.j24C5gNx027970@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv27689/spipcarto/ecrire

Modified Files:
	spip_style.php3 
Log Message:
bug dans carte_edit avec cadre-padding en position relative (ligne 876)

Index: spip_style.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/spip_style.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- spip_style.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ spip_style.php3	4 Mar 2005 12:05:39 -0000	1.4
@@ -873,7 +873,7 @@
 	font-family: verdana, arial, helvetica, sans;
 	font-size: 12px;
 	padding: 6px;
-	position: relative;
+/*	position: relative;*/
 }
 
 .cadre-titre {



From fxp at berlios.de  Fri Mar  4 14:15:00 2005
From: fxp at berlios.de (fxp at berlios.de)
Date: Fri, 4 Mar 2005 14:15:00 +0100
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_geosvgfile.html,1.1,1.2
Message-ID: <200503041315.j24DF0Nx018528@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv18522/squelettes

Modified Files:
	carto_geosvgfile.html 
Log Message:


Index: carto_geosvgfile.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto_geosvgfile.html,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carto_geosvgfile.html	1 Mar 2005 17:44:01 -0000	1.1
+++ carto_geosvgfile.html	4 Mar 2005 13:14:57 -0000	1.2
@@ -434,12 +434,12 @@
 	
 	
 	<!-- Main Map Frame -->
-	<svg id="mainMap" x="0" y="15" viewBox="[(#CALLAGE|worldfileLRX)] -[(#CALLAGE|worldfileHeight)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" width="553" height="[(#CALLAGE|getPropMapHeight{553})]">
+	<svg id="mainMap" x="0" y="15" viewBox="[(#CALLAGE|worldfileLRX)] [(#CALLAGE|worldfileULY)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" width="553" height="[(#CALLAGE|getPropMapHeight{553})]">
 		<!-- this group is necessary for manual panning, it temporarily gets a translate transformation which is later removed on mouseup -->
 		<g id="mainMapGroup" transform="translate(0,0)">
 			<!-- within this group you should place all map layers, usually, if you have more than one element in a map layer, you would use a group instead of a single element, as in this example -->
 			<g id="DOQ" visibility="visible" />
-			<image id="ShadedRelief" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" width="[(#CALLAGE|worldfileWidth)]px" height="[(#CALLAGE|worldfileHeight)]px" xlink:href="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" />
+			<image id="ShadedRelief" x="[(#CALLAGE|worldfileLRX)]" y="[(#CALLAGE|worldfileULY)]" width="[(#CALLAGE|worldfileWidth)]px" height="[(#CALLAGE|worldfileHeight)]px" xlink:href="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" />
 			
 			<g id="spipCartoObj">
 			
@@ -513,11 +513,11 @@
 		</g>
 	</g>
 	<!-- small reference map, shares the same coordinate system than the main map -->
-	<svg id="referenceMap" x="580" y="45" viewBox="[(#CALLAGE|worldfileLRX)] -[(#CALLAGE|worldfileHeight)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" width="118.52" height="[(#CALLAGE|getPropMapHeight{118.52})]" onmousedown="myRefMapDragger.drag(evt)" onmousemove="myRefMapDragger.drag(evt)" onmouseup="myRefMapDragger.drag(evt)" onmouseout="myRefMapDragger.drag(evt)">
-		<image id="ShadedRelief" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" width="[(#CALLAGE|worldfileWidth)]" height="[(#CALLAGE|worldfileHeight)]" xlink:href="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" />
+	<svg id="referenceMap" x="580" y="45" viewBox="[(#CALLAGE|worldfileLRX)] [(#CALLAGE|worldfileULY)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" width="118.52" height="[(#CALLAGE|getPropMapHeight{118.52})]" onmousedown="myRefMapDragger.drag(evt)" onmousemove="myRefMapDragger.drag(evt)" onmouseup="myRefMapDragger.drag(evt)" onmouseout="myRefMapDragger.drag(evt)">
+		<image id="ShadedRelief" x="[(#CALLAGE|worldfileLRX)]" y="[(#CALLAGE|worldfileULY)]" width="[(#CALLAGE|worldfileWidth)]" height="[(#CALLAGE|worldfileHeight)]" xlink:href="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#URL_CARTE)][&amp;scale=(#ENV{scale})][&amp;x=(#ENV{x})][&amp;y=(#ENV{y})]" />
 		<path pointer-events="none" style="fill:none;stroke:salmon;stroke-width:1000" d="M250528.8 -4218899.3l2380.5 -1305.3l1593.4 928.3l1326.1 -752.7l4218.1 -70.2l4072.3 -3965.5l5552.8 -1556.9l313 -1368.6l3042.8 -2535.6l1098.2 945.4l124.7 2135.2l2579.4 431.2l-22.8 1238l3516.2 779.5l-66.6 -1725.9l1001.7 -419l625.5 2735.2l1659.5 476.6l-330.2 1248.2l1330.8 747.9l-583.6 1341.1l1261.8 -103.1l285.3 729.8l1411.9 -2540.5l552.1 995.2l2360 129.9l1432.7 1622l2981.7 1123.5l2940.7 4333.1l-270.6 1128.2l792.4 1201.5l-1726.7 5827.8l785 2018.2l2160 2274.1l2083.2 772.6l-29.7 1587l2579.8 273.2l2903.1 2611.6l-1211.6 1736.7l-304 2424.3l1806.8 664.5l-952.3 432.8l228.8 1126.8l-1164.6 1204.8l1028.8 823.8l134.5 1768.4l-3601.7 2856.7l-1067.8 2250.5l-1294 1012.3l939.2 1643.7l-426.7 1493.5l-1730.1 1237.5l-1330.5 3254.3l-3443.5 3823l-1377.3 499.3l-1732.6 -647.3l-2658.4 9242.1l-2580.3 -63.8l-1626.7 1640.8l-11817 92.4l-111.4 4297.6l-745.7 11.6l-6670.9 -270.2l-1972.9 -5940.7l-1565.6 -523.5l821.7 -7022.1l-765 !
 -27.8l26.9 -795.4l742.7 19.8l74.1 -825.8l-2396.2 -52l748.7 -3186.1l-3846.4 -78l60.9 -5551.1l-1599 -53.4l110.1 -3306.4l-6584.6 -269.6l-573.6 -4908.1l-895.7 -69.6l-3.4 -3096.9l2384.7 -772.2l99.6 -1566.5l1598.9 3l268.3 -6583.2l-5123.5 -132.5l183.9 -10111.9l1168.6 -4214.1l-716.7 -975.6l1461.4 -2002.8l-593.4 -565.8l2659.9 -3238.9z" />
 		<!-- rectangle that represents map extent -->
-		<rect id="dragRectForRefMap" class="dragRect" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" width="[(#CALLAGE|worldfileWidth)]" height="[(#CALLAGE|worldfileHeight)]" pointer-events="none"/>
+		<rect id="dragRectForRefMap" class="dragRect" x="[(#CALLAGE|worldfileLRX)]" y="[(#CALLAGE|worldfileULY)]" width="[(#CALLAGE|worldfileWidth)]" height="[(#CALLAGE|worldfileHeight)]" pointer-events="none"/>
 		<!-- if zoomed in very far, we display a cross-symbol here to indicate the map position in the reference map -->
 		<use id="myDragCross" x="[(#CALLAGE|worldfileLRX)]" y="-[(#CALLAGE|worldfileHeight)]" xlink:href="#myDragCrossSymbol" visibility="hidden" />
 	</svg>



From stef at berlios.de  Fri Mar  4 17:49:57 2005
From: stef at berlios.de (stef at berlios.de)
Date: Fri, 4 Mar 2005 17:49:57 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_mots.php3,1.2,1.3
Message-ID: <200503041649.j24GnvNx031605@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv31581/spipcarto/ecrire

Modified Files:
	inc_mots.php3 
Log Message:
Gestion des carto_objets et ancrages

Index: inc_mots.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_mots.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_mots.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_mots.php3	4 Mar 2005 16:49:55 -0000	1.3
@@ -117,6 +117,16 @@
 		$objet = 'syndic';
 		$url_base = "sites.php3?id_syndic=$id_objet";
 	}
+	/////////////////////////////////
+	//MODIFICATION
+	////////////////////////////////
+	else if ($table == 'carto_objets') {
+		$id_table = 'id_carto_objet';
+		$objet = 'carto_objet';
+		$url_base = "carte_edit.php3?id_carte=".$id_objet['id_carte']."&id_objet=".$id_objet['id_objet'];
+		$id_objet=$id_objet['id_objet'];
+	}
+	////////////////////////////////
 
 	$query = "SELECT mots.* FROM spip_mots AS mots, spip_mots_$table AS lien WHERE lien.$id_table=$id_objet AND mots.id_mot=lien.id_mot";
 	$nombre_mots = spip_num_rows(spip_query($query));
@@ -126,12 +136,12 @@
 
 	if (!$nombre_mots AND (!$nombre_groupes OR !$flag_editable)) return;
 
-	echo "<a name='mots'></a>";
+	echo "<a name='mots".$id_objet."'></a>";
 	if ($flag_editable){
 		if ($nouv_mot.$cherche_mot.$supp_mot)
-			$bouton = bouton_block_visible("lesmots");
+			$bouton = bouton_block_visible("lesmots".$id_objet);
 		else
-			$bouton =  bouton_block_invisible("lesmots");
+			$bouton =  bouton_block_invisible("lesmots".$id_objet);
 	}
 	debut_cadre_enfonce("mot-cle-24.gif", false, "", $bouton._T('titre_mots_cles').aide ("artmots"));
 
@@ -199,7 +209,7 @@
 					echo "<LI><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2><B><FONT SIZE=3>".typo($titre_mot)."</FONT></B>";
 
 					if ($type_mot) echo " ($type_mot)";
-					echo " | <A HREF=\"$url_base&nouv_mot=$id_mot#mots\">"._T('info_ajouter_mot')."</A>";
+					echo " | <A HREF=\"$url_base&nouv_mot=$id_mot#mots".$id_objet."\">"._T('info_ajouter_mot')."</A>";
 
 					if (strlen($descriptif_mot) > 1) {
 						echo "<BR><FONT SIZE=1>".propre(couper($descriptif_mot, 100))."</FONT>\n";
@@ -312,14 +322,14 @@
 				$couleur="#EDF3FE";
 			}
 	
-			$url = "mots_edit.php3?id_mot=$id_mot&redirect=".rawurlencode($url_base.'#mots');
+			$url = "mots_edit.php3?id_mot=$id_mot&redirect=".rawurlencode($url_base.'#mots'.$id_objet);
 	
 			$vals[] = "<A HREF='$url'>" . http_img_pack('petite-cle.gif', "", "width='23' height='12' border='0'") ."</A>";
 			
 	
 			// Changer
 			if ($unseul == "oui" AND $flag_groupe) {
-				$s = "<form action='$url_base#mots' method='post' style='margin:0px; padding: 0px'>";
+				$s = "<form action='$url_base#mots".$id_objet."' method='post' style='margin:0px; padding: 0px'>";
 				$s .= "<INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'>";
 				if ($table == 'rubriques') $s .= "<INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'>";
 				$s .= "<select name='nouv_mot' onChange=\"setvisibility('valider_groupe_$id_groupe', 'visible');\" CLASS='fondl' STYLE='font-size:10px; width:90px;'>";
@@ -351,7 +361,7 @@
 			if ($flag_editable){
 				$s = "";
 				if ($flag_groupe)
-				  $s .= "<A HREF=\"$url_base&supp_mot=$id_mot#mots\">"._T('info_retirer_mot')."&nbsp;" . http_img_pack('croix-rouge.gif', "X", "width='7' height='7' border='0' align='middle'") ."</A>";
+				  $s .= "<A HREF=\"$url_base&supp_mot=$id_mot#mots".$id_objet."\">"._T('info_retirer_mot')."&nbsp;" . http_img_pack('croix-rouge.gif', "X", "width='7' height='7' border='0' align='middle'") ."</A>";
 				else $s .= "&nbsp;";
 			}
 			$vals[] = $s;
@@ -387,9 +397,9 @@
 
 	if ($flag_editable) {
 		if ($nouveaux_mots.$cherche_mot.$supp_mot)
-			echo debut_block_visible("lesmots");
+			echo debut_block_visible("lesmots".$id_objet);
 		else if ($nb_groupes > 0) {
-			echo debut_block_visible("lesmots");
+			echo debut_block_visible("lesmots".$id_objet);
 			// vilain hack pour redresser un triangle
 			$couche_a_redresser = $GLOBALS['numero_block']['lesmots'];
 			if ($GLOBALS['browser_layer']) echo http_script("
@@ -397,16 +407,16 @@
 if (triangle) triangle.src = '" . _DIR_IMG_PACK . "deplierbas$spip_lang_rtl.gif';");
 		}
 		else
-			echo debut_block_invisible("lesmots");
+			echo debut_block_invisible("lesmots".$id_objet);
 
 		if ($nombre_mots_associes > 3) {
 			echo "<div align='right' class='arial1'>";
-			echo "<a href=\"$url_base&supp_mot=-1#mots\">"._T('info_retirer_mots')."</a>";
+			echo "<a href=\"$url_base&supp_mot=-1#mots".$id_objet."\">"._T('info_retirer_mots')."</a>";
 			echo "</div><br />\n";
 		}
 
 
-		$form_mot = "<FORM ACTION='$url_base#mots' METHOD='post' STYLE='margin:1px;'>"
+		$form_mot = "<FORM ACTION='$url_base#mots".$id_objet."' METHOD='post' STYLE='margin:1px;'>"
 			."<INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'>";
 
 		if ($table == 'rubriques') $form_mot .= "<INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'>";



From stef at berlios.de  Tue Mar 29 17:16:38 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:16:38 +0200
Subject: [Spip-carto-cvs] spipcarto carto_svg2.php3,NONE,1.1 inc-compilo-index.php3,1.3,1.4 inc-compilo.php3,1.3,1.4 spip_cookie.php3,1.4,1.5 spip_admin.css,1.3,1.4 inc-compilo-api.php3,1.3,1.4 .htaccess,1.1,1.2 inc-criteres.php3,1.3,1.4 inc-messforum.php3,1.4,1.5 inc-public-global.php3,1.5,1.6 backend-breves.php3,1.3,1.4 inc-cache.php3,1.6,1.7 inc-balises.php3,1.5,1.6 inc-html-squel.php3,1.3,1.4 inc-stats.php3,1.3,1.4 backend.php3,1.3,1.4 mes_fonctions.php3,1.7,1.8 inc-calcul.php3,1.3,1.4
Message-ID: <200503291516.j2TFGc9Y032743@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv32701/spipcarto

Modified Files:
	inc-compilo-index.php3 inc-compilo.php3 spip_cookie.php3 
	spip_admin.css inc-compilo-api.php3 .htaccess 
	inc-criteres.php3 inc-messforum.php3 inc-public-global.php3 
	backend-breves.php3 inc-cache.php3 inc-balises.php3 
	inc-html-squel.php3 inc-stats.php3 backend.php3 
	mes_fonctions.php3 inc-calcul.php3 
Added Files:
	carto_svg2.php3 
Log Message:
1.8PR2 CVS 20050329

--- NEW FILE: carto_svg2.php3 ---
<?php

$fond = "carto_svg2";
$delais = 24*3600;

include ("inc-public.php3");

?>

Index: inc-compilo-index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo-index.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-compilo-index.php3	20 Feb 2005 22:16:48 -0000	1.3
+++ inc-compilo-index.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -263,7 +263,7 @@
 				}
 				if (function_exists($fonc))
 				  $code = "$fonc($code$arglist)";
-				else if (strpos(" < > <= >= == <> ? ", " $fonc "))
+				else if (strpos(" < > <= >= == === != !== <> ? ", " $fonc "))
 				  $code = "($code $fonc "
 				    . substr($arglist,1)
 				    . ')';
@@ -288,9 +288,16 @@
 
 function filtres_arglist($args, $p, $sep) {
 	$arglist ='';
-	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
-		$arg = trim($regs[1]);
-		if ($arg) {
+	while (strlen($args)) {
+		if ($args[0] =='"')
+		  ereg(' *("[^"]*") *,?(.*)$', $args, $regs);
+		elseif ($args[0] =="'")
+		  ereg(" *('[^']*') *,?(.*)$", $args, $regs);
+		else
+		  ereg(' *([^,]+) *,?(.*)$', $args, $regs);
+		$arg = $regs[1];
+		spip_log("$args $arg");
+		if ($arg !== '') {
 			if ($arg[0] =='$')
 				$arg = '$Pile[0][\'' . substr($arg,1) . "']";
 			elseif ($arg[0] =='<')

Index: inc-compilo.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-compilo.php3	20 Feb 2005 22:16:48 -0000	1.3
+++ inc-compilo.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -46,19 +46,18 @@
 // Calculer un <INCLURE()>
 //
 function calculer_inclure($fichier, $params, $id_boucle, &$boucles) {
-	global $dossier_squelettes;
 
 	$l = array();
 	if ($params) {
 		foreach($params as $var => $val) {
 			if ($val) {
-			  $val = trim($val);
-			  $val = ereg_replace('^["\'](.*)["\']$', "\\1",$val);
-			  $l[] = "\'$var\' => \'" .
-				 addslashes(calculer_param_dynamique($val,
-								     $boucles,
-								     $idb)) .
-				  "\'";
+				$val = trim($val);
+				$val = ereg_replace('^["\'](.*)["\']$', "\\1",$val);
+				$l[] = "\'$var\' => \'" .
+					addslashes(calculer_param_dynamique($val,
+						$boucles,
+						$idb)) .
+					"\'";
 			}
 			else {
 			// Cas de la langue : passer $spip_lang
@@ -195,7 +194,7 @@
 	// Cas {1/3} {1,4} {n-2,1}...
 
 	$flag_cpt = $boucle->mode_partie || // pas '$compteur' a cause du cas 0
-		strpos($return,'compteur_boucle');
+	  strpos($return,'compteur_boucle');
 
 	//
 	// Creer le debut du corps de la boucle :
@@ -225,6 +224,10 @@
 		index_pile($id_boucle, $primary, $boucles)
 		. "; // doublons";
 
+
+	if (count($boucle->separateur))
+	  $code_sep = ("'" . ereg_replace("'","\'",join('',$boucle->separateur)) . "'"); 
+
 	// gestion optimale des separateurs et des boucles constantes
 
 	$corps = $debut . 
@@ -236,8 +239,7 @@
 			 (".=" . substr($return,4)) :
 			 ('= ' . $return)) .
 		  ";\n\t\t" .
-		  '$t0 .= (($t1 && $t0) ? \'' . $boucle->separateur .
-		  "' : '') . \$t1;"));
+		  '$t0 .= (($t1 && $t0) ? ' . $code_sep . " : '') . \$t1;"));
      
 	// Fin de parties
 	if ($boucle->mode_partie)
@@ -328,7 +330,6 @@
 	if ($flag_cpt)
 		$init .= "\n	\$compteur_boucle = 0;";
 
-
 	if ($boucle->mode_partie)
 		$init .= calculer_parties($boucle->partie,
 			$boucle->mode_partie,
@@ -407,7 +408,7 @@
 
 	// calcul du total boucle final
 	$retour .= "\n	"
-		.'$Numrows[\''.$id_boucle.'\'] = $fin_boucle - $debut_boucle + 1;';
+		.'$Numrows[\''.$id_boucle.'\'] = max(0,$fin_boucle - $debut_boucle + 1);';
 
 	return $retour;
 }
@@ -627,9 +628,10 @@
 		    if ($boucle->param && is_array($boucle->param)) 
 				$pretty .= " {".join("} {", $boucle->param)."}";
 			// sans oublier les parametres traites en amont
-			if ($boucle->separateur)
-			  $pretty .= '{"' . $boucle->separateur . '"}';
-			if ($boucle->tout)
+		    if ($boucle->separateur)
+		      foreach($boucle->separateur as $v)
+			$pretty .= ' {"'. htmlspecialchars($v) . '"}';
+		    if ($boucle->tout)
 			  $pretty .= '{tout}';
 			if ($boucle->plat)
 			  $pretty .= '{plat}';

Index: spip_cookie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cookie.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- spip_cookie.php3	3 Mar 2005 14:55:17 -0000	1.4
+++ spip_cookie.php3	29 Mar 2005 15:16:35 -0000	1.5
@@ -137,6 +137,7 @@
 	if ($ok) {
 		// Nouveau redacteur ou visiteur inscrit par mail :
 		// 'nouveau' -> '1comite' ou  '6forum'
+		// Si LDAP : importer l'utilisateur vers la base SPIP
 		$auth->activer();
 
 		if ($auth->login AND $auth->statut == '0minirezo') // force le cookie pour les admins

Index: spip_admin.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_admin.css,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- spip_admin.css	20 Feb 2005 22:16:48 -0000	1.3
+++ spip_admin.css	29 Mar 2005 15:16:35 -0000	1.4
@@ -29,7 +29,6 @@
 	border-left: 1px solid #cecece;
 	border-right: 1px solid #cecece;
 	text-decoration: none;
-	width: 3em;
 	text-align: center;
 	margin: 0;
 	padding: 1px .5em;
@@ -56,14 +55,22 @@
 	background-color: #f0f0f0;
 	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
 }
+
 #spip-debug ul table {
 	font-size: 80%;
 }
 
 #spip-debug fieldset {
 	background-color: #FFF;
-	font-family: "Courier New", Courier, monospace;
+	font-family: Courier, "Courier New", monospace;
 	font-size: 12px;
+	margin-bottom: 1em;
+}
+
+#spip-debug fieldset fieldset {
+	background-color: #CCF;
+	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
+	font-size: 80%;
 }
 
 #spip-debug legend {
@@ -74,10 +81,54 @@
 	font-weight: bold;
 }
 
-#spip-debug ul table a {
+#spip-debug fieldset fieldset legend {
+	border: solid 1px #00F;
+	font-weight: normal;
+}
+
+#spip-debug a {
 	text-decoration: none;
 }
 
-#spip-debug ul table a:hover {
+#spip-debug a:hover {
 	text-decoration: underline;
 }
+
+#debug_boucle fieldset {
+	background-color: #CCF;
+}
+#debug_boucle fieldset fieldset {
+	background-color: #FFF;
+	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
+	padding: 0.5em 1.5em;
+}
+
+#spip-boucles {
+	min-height: 200px;
+	max-height:50%;
+	margin: 0 0 1em 0;
+	padding: .5em 0;
+	overflow: -moz-scrollbars-vertical;
+	overflow-y: auto;
+	border-top: 1px solid #3399FF;
+	border-bottom: 2px solid #666666;
+}
+
+.spip-env fieldset {
+	background-color: #FFF;
+	border: solid 1px #008;
+	margin: 2px 2em;
+}
+
+.spip-env legend {
+	background-color: #FFF;
+	border: solid 1px #F00;
+	padding: 1px 1em;
+	font-weight: bold;
+}
+
+.spip-env fieldset div {
+	max-height: 10em;
+	overflow: auto; 
+}
+

Index: inc-compilo-api.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo-api.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-compilo-api.php3	20 Feb 2005 22:16:48 -0000	1.3
+++ inc-compilo-api.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -41,7 +41,7 @@
 	var $type_requete;
 	var $sql_serveur;
 	var $param = array();
-	var $separateur;
+	var $separateur = array();
 	var $doublons;
 	var $partie, $total_parties,$mode_partie;
 	var $externe = ''; # appel a partir d'une autre boucle (recursion)

Index: .htaccess
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/.htaccess,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- .htaccess	25 Feb 2005 23:46:18 -0000	1.1
+++ .htaccess	29 Mar 2005 15:16:35 -0000	1.2
@@ -1,2 +1,2 @@
 RewriteEngine On
-RewriteRule ^carto_svgfile([0-9]+)\.svg$	carto_svgfile.php3?id_carto_carte=$1 [QSA,L]
+RewriteRule ^carto_svgfile([0-9]+)\.svg$	carto_svgfile.php3?id_carto_carte=$1\&var_mode=recalcul [QSA,L]

Index: inc-criteres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-criteres.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-criteres.php3	20 Feb 2005 22:16:48 -0000	1.3
+++ inc-criteres.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -283,8 +283,6 @@
 
 
 function calculer_critere_parties($idb, &$boucles, $param, $not, $match) {
-  global $tables_relations, $table_date, $tables_des_serveurs_sql;
-
 	$boucle = &$boucles[$idb];
 	list(,$a1,$op,$a2) = $match;
 	list($a11,$a12) = calculer_critere_parties_aux($idb, $boucles, $a1);
@@ -293,10 +291,10 @@
 	if (($op== ',')&&(is_numeric($a11) && (is_numeric($a21))))
 		$boucle->limit = $a11 .',' . $a21;
 	else {
-	  $boucle->partie =	($a11 != 'n') ? $a11 : $a12;
+		$boucle->partie = ($a11 != 'n') ? $a11 : $a12;
 		$boucle->total_parties =  ($a21 != 'n') ? $a21 : $a22;
 		$boucle->mode_partie = (($op == '/') ? '/' :
-				(($a1=='n')?'-':'+').(($a2=='n')?'-':'+'));
+			(($a11=='n')?'-':'+').(($a21=='n')?'-':'+'));
 	}
 }
 
@@ -351,11 +349,11 @@
 	$primary = $boucle->primary;
 	$id_field = $id_table . '.' . $primary; 
 
-	if (ereg('^([0-9a-zA-Z#_\{\}]+)([,/])([0-9a-zA-Z#_\{\}]+)$', $param, $match))
+	if (ereg('^([0-9a-zA-Z#_\{\}-]+)([,/])([0-9a-zA-Z#_\{\}-]+)$', $param, $match))
 	  calculer_critere_parties($idb, $boucles, $param, $not, $match);
 
 		// Restriction de valeurs (implicite ou explicite)
-	else if (eregi('^([a-z_]+\(?[a-z_]*\)?) *(\??)((!?)(<=?|>=?|==?|IN) *"?([^<>=!"]*))?"?$', $param, $match)) {
+	else if (eregi('^(`?[a-z_]+\(?[a-z_]*\)?`?) *(\??)((!?)(<=?|>=?|==?|IN) *"?([^<>=!"]*))?"?$', $param, $match)) {
 	  		$op = $match[5] ? $match[5] : '=';
 
 			// Variable comparee
@@ -518,8 +516,11 @@
 				$boucle->plat = true;
 
 			// Operateur de comparaison
-			if ($col_table)
-				$col = "$col_table.$col";
+			if ($col_table) {
+				if ($col[0] == "`") 
+				  $col = "$col_table." . substr($col,1,-1);
+				else $col = "$col_table.$col";
+			}
 
 			if (strtoupper($op) == 'IN') {
 				// traitement special des valeurs textuelles

Index: inc-messforum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-messforum.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-messforum.php3	25 Feb 2005 16:35:58 -0000	1.4
+++ inc-messforum.php3	29 Mar 2005 15:16:35 -0000	1.5
@@ -13,22 +13,33 @@
 
 include_ecrire('inc_meta.php3');
 include_ecrire('inc_forum.php3');
+include_ecrire('inc_filtres.php3');
 include_ecrire("inc_abstract_sql.php3");
 include_local(_FILE_CONNECT);
 
 // Ce fichier inclus par inc-public a un comportement special
 // Voir commentaires dans celui-ci et dans inc-formulaire_forum
 
-function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre) {
+function prevenir_auteurs($auteur, $email_auteur, $id_forum, $id_article, $texte, $titre, $statut) {
 	include_ecrire('inc_texte.php3');
 	include_ecrire('inc_filtres.php3');
 	include_ecrire('inc_mail.php3');
 	// Gestionnaire d'URLs
 	if (@file_exists("inc-urls.php3"))
-	  include_local("inc-urls.php3");
+		include_local("inc-urls.php3");
 	else
-	  include_local("inc-urls-".$GLOBALS['type_urls'].".php3");
-	$url = ereg_replace('^/', '', generer_url_article($id_article));
+		include_local("inc-urls-".$GLOBALS['type_urls'].".php3");
+
+	if ($statut == 'prop') # forum modere
+		$url = "ecrire/controle_forum.php3?debut_id_forum=$id_forum";
+	else if (function_exists('generer_url_forum'))
+		$url = generer_url_forum($id_forum);
+	else {
+		spip_log('inc-urls personnalise : ajoutez generer_url_forum() !');
+		$url = generer_url_article($id_article);
+	}
+
+	$url = ereg_replace('^/', '', $url);
 	$adresse_site = lire_meta("adresse_site");
 	$nom_site_spip = lire_meta("nom_site");
 	$url = "$adresse_site/$url";
@@ -173,12 +184,12 @@
 	id_auteur = $id_auteur,
 	id_thread = $id_thread,
 	date_heure = NOW(),
-	titre = '".addslashes($titre)."',
-	texte = '".addslashes($texte)."',
-	nom_site = '".addslashes($nom_site_forum)."',
-	url_site = '".addslashes($url_site)."',
-	auteur = '".addslashes($auteur)."',
-	email_auteur = '".addslashes($email_auteur)."',
+	titre = '".addslashes(corriger_caracteres($titre))."',
+	texte = '".addslashes(corriger_caracteres($texte))."',
+	nom_site = '".addslashes(corriger_caracteres($nom_site_forum))."',
+	url_site = '".addslashes(corriger_caracteres($url_site))."',
+	auteur = '".addslashes(corriger_caracteres($auteur))."',
+	email_auteur = '".addslashes(corriger_caracteres($email_auteur))."',
 	ip = '$REMOTE_ADDR',
 	statut = '$statut'
 	WHERE id_forum = $id_message
@@ -191,7 +202,7 @@
 
 	// Prevenir les auteurs de l'article
 	if (lire_meta("prevenir_auteurs") == "oui" AND ($afficher_texte != "non"))
-		prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);
+		prevenir_auteurs($auteur, $email_auteur, $id_message, $id_article, $texte, $titre, $statut);
 
 	// Poser un cookie pour ne pas retaper le nom / email
 

Index: inc-public-global.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-public-global.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc-public-global.php3	3 Mar 2005 14:55:17 -0000	1.5
+++ inc-public-global.php3	29 Mar 2005 15:16:35 -0000	1.6
@@ -67,20 +67,20 @@
 		if (($GLOBALS['code_activation_debug'] == 'oui')
 		OR $auteur_session['statut'] == '0minirezo')
 			spip_log('debug !');
-		else
-			$var_mode = false; 
+		else {
+			$link = new Link();
+			$link->addvar('var_mode', 'debug');
+			redirige_par_entete('spip_login.php3?url='
+				.urlencode($link->getUrl()));
+			exit;
+		}
 	}
 
 	// est-on admin ?
-	if ($affiche_boutons_admin = (!$flag_preserver
-	AND ($GLOBALS['_COOKIE']['spip_admin']
-	OR $GLOBALS['_COOKIE']['spip_debug'])))
+	if ($affiche_boutons_admin = (
+	(!$flag_preserver AND $GLOBALS['_COOKIE']['spip_admin'])
+	OR $var_mode == 'debug'))
 		include_local(find_in_path('inc-formulaire_admin.php3'));
-		# attention, cet include ne considere pas forcement le
-		# $dossier_squelettes defini dans mes_fonctions.php3, mais si
-		# on incluait mes_fonctions.php3 on masquerait au webmestre l'erreur,
-		# courante, qui est de croire que ce fichier est toujours inclus.
-
 
 	$tableau_des_erreurs = array();
 	$page = afficher_page_globale ($fond, $delais, $use_cache);
@@ -351,6 +351,8 @@
 # (voir l'exemple de spip_inscription et spip_pass)
 # $r = complexe (fond, delais, contexte) ; $echo = faut-il faire echo ou return
 function inclure_balise_dynamique($r, $echo=true) {
+	global $contexte_inclus;	# provisoire : c'est pour le debuggueur
+
 	if (is_string($r))
 		if ($echo)
 			echo $r;

Index: backend-breves.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/backend-breves.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- backend-breves.php3	20 Feb 2005 22:15:59 -0000	1.3
+++ backend-breves.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -5,8 +5,6 @@
 // cette ligne empeche l'affichage des boutons d'administration
 $flag_preserver = true;
 
- at header("Content-type: text/xml");
-
 include ("inc-public.php3");
 
 ?>

Index: inc-cache.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-cache.php3,v
retrieving revision 1.6
retrieving revision 1.7
diff -u -d -r1.6 -r1.7
--- inc-cache.php3	4 Mar 2005 10:45:01 -0000	1.6
+++ inc-cache.php3	29 Mar 2005 15:16:35 -0000	1.7
@@ -113,14 +113,16 @@
 
 	// Et puis une centaine d'autres
 	if (lire_meta('invalider_caches')) {
-		$on_efface = true;
+		$compte = 1;
 		effacer_meta('invalider_caches'); # concurrence
 		ecrire_metas();
 
 		$q = spip_query("SELECT fichier FROM spip_caches
 		WHERE type='x' LIMIT 0,100");
-		while ($r = spip_fetch_array($q))
+		while ($r = spip_fetch_array($q)) {
+			$compte ++;	# compte le nombre de resultats vus (y compris doublons)
 			$suppr[$r['fichier']] = true;
+		}
 	}
 
 
@@ -132,9 +134,9 @@
 		.calcul_mysql_in('fichier', "'".join("','",array_keys($suppr))."'") );
 	}
 
-	// signaler aux suivants
-	if ($on_efface) {
-		if ($n>99)
+	// Si on a regarde (compte > 0), signaler s'il reste des caches invalides
+	if ($compte > 0) {
+		if ($compte > 100) # s'il y en a 101 c'est qu'on n'a pas fini
 			ecrire_meta('invalider_caches', 'oui');
 		else
 			effacer_meta('invalider');

Index: inc-balises.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-balises.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc-balises.php3	4 Mar 2005 10:45:01 -0000	1.5
+++ inc-balises.php3	29 Mar 2005 15:16:35 -0000	1.6
@@ -172,7 +172,10 @@
 // #DATE_NOUVEAUTES
 // http://www.spip.net/fr_article1971.html
 function balise_DATE_NOUVEAUTES_dist($p) {
-	$p->code = "((lire_meta('quoi_de_neuf') == 'oui' AND lire_meta('majnouv')) ? normaliser_date(lire_meta('majnouv')) : \"'0000-00-00'\")";
+	$p->code = "((lire_meta('quoi_de_neuf') == 'oui'
+	AND @file_exists(_DIR_SESSIONS . 'mail.lock')) ?
+	normaliser_date(@filemtime(_DIR_SESSIONS . 'mail.lock')) :
+	\"'0000-00-00'\")";
 	$p->statut = 'php';
 	return $p;
 }

Index: inc-html-squel.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-html-squel.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-html-squel.php3	20 Feb 2005 22:16:48 -0000	1.3
+++ inc-html-squel.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -77,7 +77,7 @@
 	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
 	  $p = strpos($texte, $regs[0]);
 
-	  if ($regs[4] || !ereg("[0-9a-z]", $regs[5][0])) {
+	  if ($regs[4] || (strpos($regs[5][0], "[0-9]") === false)) {
 		if ($p) {
 			$champ = new Texte;
 			$champ->texte = (substr($texte, 0, $p));
@@ -172,59 +172,38 @@
 	$type = $result->type_requete;
 	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
 		$params = $m[3];
-		$m[1] = trim($m[1]);
+		$param = trim($m[1]);
 		// cas d'un critere avec {...}
-		if ($m[2])
-			$params2[] = $m[1];
-		else {
-			if (strlen($m[1]) < 2)
-				$params2[] = $m[1];
-	    else {
-	      ereg('^(.)([^"}]*)(.)$', $m[1], $args);
-	      // cas syntaxique general, 
+		if ($m[2]) {
+			$params2[] = $param;
+		}
 	      // traiter qq lexemes particuliers pour faciliter la suite
-	      if ($args[3] != '"') {
-			$param = $m[1];
-			if (($param == 'tout') OR ($param == 'tous')) {
-				$result->tout = true;
-				unset ($param);
-			}
-			else if ($param == 'plat') {
-				$result->plat = true;
-				unset ($param);
-			}
-
-			// Boucle hierarchie, analyser le critere id_article - id_rubrique
-			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
-			// forcer {tout} pour avoir la rubrique mere...
-			else if ($type == 'hierarchie') {
+		else if (strlen($param) < 2)
+			$params2[] = $param;
+		else if (($param == 'tout') OR ($param == 'tous'))
+			$result->tout = true;
+		else if ($param == 'plat') 
+			$result->plat = true;
+		else if ($param == 'unique')
+			$params2[] = 'doublons';
+		else {
+			if ($type == 'hierarchie') {
+	// Boucle hierarchie, analyser le critere id_article - id_rubrique
+	// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
+	// forcer {tout} pour avoir la rubrique mere...
 				if ($param == 'id_article' OR $param == 'id_syndic') {
 					$result->tout = true;
-					unset ($param);
+					$param = "";
 				} else if ($param == 'id_rubrique')
-					unset ($param);
-			}
-
-			// synonyme
-			if ($param == 'unique') $param = 'doublons';
-
-			// l'ajouter
-			if ($param)
-				$params2[] = $param;
-	      }
-		else {
-		  // cas d'un guillemet final
-			if ($args[1] == '"') {
-			  // si tout le param est entre guillement, vite vu
-				$result->separateur = 
-					ereg_replace("'","\'",$args[2]);
+					$param = "";
 			}
+			// les separateurs (specs CSS3 aN+b a finaliser)
+			if (ereg('^"([^"}]*)"( *, *(\-?[0-9]*)n)?(\+?([0-9]+))?)?$', $param, $args))
+			  $result->separateur[] = $args[1];
 			else {
-				$params2[] = $args[1] . $args[2] . '"' . $m[1];
+			  if ($param) $params2[] = $param;
 			}
 		}
-	    }
-	  }
 	}
 	$result->param = $params2;
 }

Index: inc-stats.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-stats.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-stats.php3	20 Feb 2005 22:16:48 -0000	1.3
+++ inc-stats.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -58,7 +58,7 @@
 	if ($log_referer) {
 		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
 		$query = "INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) ".
-			"VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)";
+			"VALUES ($log_ip, '".texte_script($log_referer)."', $referer_md5, '$log_type', $log_id_num)";
 		spip_query($query);
 	}
 }

Index: backend.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/backend.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- backend.php3	20 Feb 2005 22:15:59 -0000	1.3
+++ backend.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -7,8 +7,6 @@
 
 $flag_preserver = true;
 
- at header("Content-type: text/xml");
-
 include ("inc-public.php3");
 
 ?>

Index: mes_fonctions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/mes_fonctions.php3,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- mes_fonctions.php3	1 Mar 2005 17:36:43 -0000	1.7
+++ mes_fonctions.php3	29 Mar 2005 15:16:35 -0000	1.8
@@ -1,42 +1,4 @@
 <?php
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-//FILTRES
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-
-
- function worldfileWidth($callage){	
-	$tabcallage=worldfile2array($callage);
-	return intval($tabcallage['bottom_right']['x']-$tabcallage['top_left']['x']);
-}
-function worldfileHeight($callage){	
-	$tabcallage=worldfile2array($callage);
-	return intval($tabcallage['bottom_right']['y']-$tabcallage['top_left']['y']);
-}
-function worldfileULX($callage){
-	$tabcallage=worldfile2array($callage);
-	return $tabcallage['bottom_right']['x'];
-}
-function worldfileULY($callage){
-	$tabcallage=worldfile2array($callage);
-	return $tabcallage['bottom_right']['y']*-1;
-}
-function worldfileLRX($callage){
-	$tabcallage=worldfile2array($callage);
-	return $tabcallage['top_left']['x'];
-}
-function worldfileLRY($callage){
-	$tabcallage=worldfile2array($callage);
-	return $tabcallage['top_left']['y'];
-}
-function getPropMapHeight($callage, $width){
-	$tabcallage=worldfile2array($callage);
-	// Calcul d'une hauteur relative ? un callage (proportion)
-	return $width*($tabcallage['bottom_right']['y']-$tabcallage['top_left']['y'])/($tabcallage['bottom_right']['x']-$tabcallage['top_left']['x']);
-}
-
-
 
 
 /*

Index: inc-calcul.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-calcul.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-calcul.php3	20 Feb 2005 22:15:59 -0000	1.3
+++ inc-calcul.php3	29 Mar 2005 15:16:35 -0000	1.4
@@ -31,9 +31,7 @@
 include_ecrire("inc_debug_sql.php3");
 include_local("inc-calcul-outils.php3");
 
-// Ce fichier peut contenir une affectation de $dossier_squelettes  indiquant
-// le repertoire du source des squelettes (les pseudo-html avec BOUCLE...)
-
+// NB: Ce fichier peut initialiser $dossier_squelettes (old-style)
 if ($f = find_in_path("mes_fonctions.php3"))
 	include_local ($f);
 
@@ -269,9 +267,9 @@
 					list(,$url) = extraire_lien(array('','','',
 					substr($chapo, 1)));
 					if ($url) { // sinon les navigateurs pataugent
-						$url = addslashes($url);
+						$url = texte_script(str_replace('&amp;', '&', $url));
 						$page = array('texte' => "<".
-						"?php header(\"Location: $url\"); ?" . ">",
+						"?php header('Location: $url'); ?" . ">",
 						'process_ins' => 'php');
 					}
 				}



From stef at berlios.de  Tue Mar 29 17:26:15 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:26:15 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire calendrier.css,NONE,1.1
Message-ID: <200503291526.j2TFQF9Y001261@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv1234/spipcarto/ecrire

Added Files:
	calendrier.css 
Log Message:
1.8PR2 CVS 20050329

--- NEW FILE: calendrier.css ---
/*
 * Styles du calendrier
 */
 
.calendrier-arial9 { 
	font-family: Arial, Sans, sans-serif; font-size: 9px;
}

.calendrier-arial10 { 
	font-family: Arial, Sans, sans-serif; font-size: 10px;
}

.calendrier-arial11 { 
	font-family: Arial, Sans, sans-serif; font-size: 11px;
}

.calendrier-verdana10 {
	font-family: Verdana, Arial, Sans, sans-serif; font-size: 10px;
}

.calendrier-helvetica16 {
	font-family: arial,helvetica,sans-serif;
	font-size: 16px; 
	color: black;
}

div.navigation-calendrier {
	color: white;
	font-family: verdana, arial, sans,sans-serif;
	font-weight: bold;
	font-size: 14px;
	padding: 2px;
}

div.navigation-calendrier img {
	border: 0px;
	vertical-align: middle;
	margin: 1px;
}

a.calendrier-annee {
	background-color: #aaaaaa;
	padding: 3px;
	margin: 1px;
	font-family: verdana, arial, sans,sans-serif;
	font-size: 10px;
	font-weight: bold;
	color: white;
	-moz-border-radius: 5px;
}

a.calendrier-annee:hover {
	color: black;
	background-color: white;
}

.calendrier-table-large { 
	border: 0px;
	width: 950px;
 }

.calendrier-table-etroit { 
	border: 0px;
	width: 750px;
 }

.calendrier-td-centre { 
	width: 570px;
	padding-left: 2%;
	padding-right: 2%;
  	vertical-align: top;
 }

.calendrier-table-etroit  .calendrier-td-gauche {
	width: 0px;
  	vertical-align: top;
 }

.calendrier-table-large  .calendrier-td-gauche {
	width: 180px;
  	vertical-align: top;
 }

.calendrier-table-etroit  .calendrier-td-droit {
	width: 180px;
  	vertical-align: top;
 }

.calendrier-table-large  .calendrier-td-droit {
	width: 180px;
  	vertical-align: top;
 }

.calendrier-jour { 
	color: #999999;
	background-color: white;
	border-left: 1px solid #aaaaaa;
	border-right: 1px solid #aaaaaa;
	border-bottom: 1px solid #aaaaaa;
	border-top: 1px solid #aaaaaa;
}

.calendrier-agenda { 
	margin-left: 1px;
	margin-top: 1px;
	padding: 1px;
	text-align: center; 
	background-color: white;
	-moz-border-radius: 5px;
 }

.calendrier-demiagenda { 
	margin-left: 0px;
	margin-top: 0px;
	padding: 0px;
	text-align: center; 
	background-color: white;
	-moz-border-radius: 5px;
 }

.calendrier-titre { 
	padding: 5px;
	text-align: center; 
	font-weight: bold;
 }

.calendrier-mozleft { 
	-moz-border-radius-topleft: 10px;
	-moz-border-radius-bottomleft: 10px;
 }

.calendrier-mozright { 
	-moz-border-radius-topright: 10px;
	-moz-border-radius-bottomright: 10px;
 }

.calendrier-moztop8 { 
	-moz-border-radius-topleft: 8px;
	-moz-border-radius-topright: 8px;
}

.calendrier-mozbottom8 { 
	-moz-border-radius-bottomleft: 8px; 
	-moz-border-radius-bottomright: 8px;
}

.calendrier-moztop6 { 
	-moz-border-radius-topleft: 6px; 
	-moz-border-radius-topright: 6px;
}

.calendrier-mozbottom6 { 
	-moz-border-radius-bottomleft: 6px; 
	-moz-border-radius-bottomright: 6px;
}

.calendrier-opacity { 
	-moz-opacity: 0.3;
	filter: alpha(opacity=30);
}


.calendrier-png { 
	width: 12px; 
	height: 12px;
	behavior: url(win_png.htc);
}

.calendrier-icone { 
	width: 14px;
	height: 7px;
	border: 0px;
}



From stef at berlios.de  Tue Mar 29 17:26:00 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:26:00 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire articles.php3,1.3,1.4 articles_versions.php3,1.2,1.3 articles_edit.php3,1.3,1.4 aide_index.php3,1.2,1.3 admin_vider.php3,1.3,1.4 auteurs_edit.php3,1.3,1.4 articles_forum.php3,1.2,1.3 auteur_infos.php3,1.3,1.4
Message-ID: <200503291526.j2TFQ09Y001195@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv1134/spipcarto/ecrire

Modified Files:
	articles.php3 articles_versions.php3 articles_edit.php3 
	aide_index.php3 admin_vider.php3 auteurs_edit.php3 
	articles_forum.php3 auteur_infos.php3 
Log Message:
1.8PR2 CVS 20050329

Index: articles.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- articles.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ articles.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -195,8 +195,8 @@
 	$varname = "texte$nb_texte";
 	$texte_plus = $$varname;	// double $ pour obtenir $texte1, $texte2...
 	if ($texte_plus){
-		$texte_plus = ereg_replace("<!--SPIP-->[\n\r]*","\n\n\n",$texte_plus);
-		$texte_ajout .= " ".$texte_plus;
+		$texte_plus = ereg_replace("<!--SPIP-->[\n\r]*","",$texte_plus);
+		$texte_ajout .= $texte_plus;
 	} else {
 		break;
 	}
@@ -239,9 +239,9 @@
 	if ($articles_versions) {
 		include("lab_revisions.php");
 		if  ($new != 'oui') {
-			spip_log("version initiale de l'article $id_article");
 			$query = "SELECT id_article FROM spip_versions WHERE id_article=$id_article LIMIT 0,1";
 			if (!spip_num_rows(spip_query($query))) {
+				spip_log("version initiale de l'article $id_article");
 				$select = join(", ", $champs);
 				$query = "SELECT $select FROM spip_articles WHERE id_article=$id_article";
 				$champs_originaux = spip_fetch_array(spip_query($query));
@@ -445,13 +445,14 @@
 	debut_cadre_relief("forum-interne-24.gif");
 	$visible = $change_accepter_forum || $change_petition;
 
-	echo "<font size='2' FACE='Verdana,Arial,Sans,sans-serif'><center><b>";
+
+	echo "<div class='verdana1' style='text-align: center;'><b>";
 	if ($visible)
 		echo bouton_block_visible("forumpetition");
 	else
 		echo bouton_block_invisible("forumpetition");
 	echo _T('bouton_forum_petition');
-	echo "</b></center></font>";
+	echo "</b></div>";
 	if ($visible)
 		echo debut_block_visible("forumpetition");
 	else
@@ -512,7 +513,7 @@
 		echo "<label for='accepterforumnon'> "._T('info_pas_de_forum')."</label>";
 	}
 
-	echo "<div align='right'><input type='submit' name='Changer' class='fondo' value='"._T('bouton_changer')."' STYLE='font-size:10px'></div>\n";
+	echo "<div align='$spip_lang_right'><input type='submit' name='Changer' class='fondo' value='"._T('bouton_changer')."' STYLE='font-size:10px'></div>\n";
 	echo "</form>";
 
 	echo "<br>";
@@ -604,7 +605,7 @@
 		echo "<label for='petitionoff'>"._T('bouton_radio_supprimer_petition')."</label>";
 	}
 
-	echo "<P align='right'><INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='"._T('bouton_changer')."' STYLE='font-size:10px'>";
+	echo "<P align='$spip_lang_right'><INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='"._T('bouton_changer')."' STYLE='font-size:10px'>";
 	echo "</FORM>";
 
 	echo "</font>";
@@ -612,21 +613,20 @@
 
 	fin_cadre_relief();
 
-	echo "<br>";
 
 
 	// Redirection (article virtuel)
 	debut_cadre_relief("site-24.gif");
 	$visible = ($changer_virtuel || $virtuel);
 
-	echo "<font size='2' FACE='Verdana,Arial,Sans,sans-serif'><center><b>";
+	echo "<div class='verdana1' style='text-align: center;'><b>";
 	if ($visible)
 		echo bouton_block_visible("redirection");
 	else
 		echo bouton_block_invisible("redirection");
 	echo _T('bouton_redirection');
 	echo aide ("artvirt");
-	echo "</b></center></font>";
+	echo "</b></div>";
 	if ($visible)
 		echo debut_block_visible("redirection");
 	else
@@ -641,7 +641,7 @@
 	echo "<font face='Verdana,Arial,Sans,sans-serif' size=2>";
 	echo "(<b>"._T('texte_article_virtuel')."&nbsp;:</b> "._T('texte_reference_mais_redirige').")";
 	echo "</font>";
-	echo "<div align='right'><INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='"._T('bouton_changer')."' STYLE='font-size:10px'></div>";
+	echo "<div align='$spip_lang_right'><INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='"._T('bouton_changer')."' STYLE='font-size:10px'></div>";
 	echo "</form>";
 	echo fin_block();
 
@@ -749,7 +749,7 @@
 
 
 if ($descriptif OR $url_site OR $nom_site) {
-	echo "<p><div align='left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;' $dir_lang>";
+	echo "<p><div align='$spip_lang_left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;' $dir_lang>";
 	echo "<font size=2 face='Verdana,Arial,Sans,sans-serif'>";
 	$texte_case = ($descriptif) ? "{{"._T('info_descriptif')."}} $descriptif\n\n" : '';
 	$texte_case .= ($nom_site.$url_site) ? "{{"._T('info_urlref')."}} [".$nom_site."->".$url_site."]" : '';
@@ -809,7 +809,7 @@
 
 
 echo "<div>&nbsp;</div>";
-echo "<div class='serif' align='left'>";
+echo "<div class='serif' align='$spip_lang_left'>";
 
 //
 // Affichage date redac et date publi
@@ -862,7 +862,7 @@
 		echo debut_block_invisible('dateredac');
 		echo "<div style='margin: 5px; margin-$spip_lang_left: 20px;'>";
 		echo '<table cellpadding="0" cellspacing="0" border="0" width="100%">';
-		echo '<tr><td align="left">';
+		echo '<tr><td align="$spip_lang_left">';
 		echo '<input type="radio" name="avec_redac" value="non" id="avec_redac_on"';
 		if ($annee_redac.'-'.$mois_redac.'-'.$jour_redac == '0000-00-00') echo ' checked="checked"';
 		echo " onClick=\"setvisibility('valider_date_prec', 'visible')\"";
@@ -880,7 +880,7 @@
 		echo '</select> &nbsp;';
 		echo "<input type='text' name='annee_redac' class='fondl' value='".$annee_redac."' size='5' maxlength='4' onClick=\"setvisibility('valider_date_prec', 'visible')\"/>";
 
-		echo '</td><td align="right">';
+		echo '</td><td align="$spip_lang_right">';
 		echo "<span class='visible_au_chargement' id='valider_date_prec'>";
 		echo '<input type="submit" name="Changer" class="fondo" value="'._T('bouton_changer').'" />';
 		echo "</span>";
@@ -948,7 +948,7 @@
 //
 
 if ($cherche_auteur) {
-	echo "<P ALIGN='left'>";
+	echo "<P ALIGN='$spip_lang_left'>";
 	$query = "SELECT id_auteur, nom FROM spip_auteurs";
 	$result = spip_query($query);
 	unset($table_auteurs);
@@ -1019,6 +1019,9 @@
 		$titre = urlencode($cherche_auteur);
 		icone_horizontale(_T('icone_creer_auteur'), "auteur_infos.php3?new=oui&ajouter_id_article=$id_article&titre=$titre&redirect=$retour", "redacteurs-24.gif", "creer.gif");
 		echo "</div> ";
+
+		// message pour ne pas afficher le second bouton "creer un auteur"
+		$supprimer_bouton_creer_auteur = true;
 	}
 
 	fin_boite_info();
@@ -1150,7 +1153,11 @@
 	
 	echo "<table width='100%'>";
 	echo "<tr>";
-	if ($connect_statut == '0minirezo' AND acces_rubrique($rubrique_article) AND $options == "avancees") {
+
+	if ($connect_statut == '0minirezo'
+	AND acces_rubrique($rubrique_article)
+	AND $options == "avancees"
+	AND !$supprimer_bouton_creer_auteur) {
 		echo "<td width='200'>";
 		$retour = urlencode($clean_link->getUrl());
 		icone_horizontale(_T('icone_creer_auteur'), "auteur_infos.php3?new=oui&ajouter_id_article=$id_article&redirect=$retour", "redacteurs-24.gif", "creer.gif");
@@ -1292,7 +1299,11 @@
 			$id_trad = 0;
 		}
 
-		if ($connect_statut=='0minirezo' AND $id_trad_new > 0) { // Changer article de reference de la trad
+		// Changer article de reference de la trad
+		if ($id_trad_new = intval($id_trad_new)
+		AND $id_trad_old = intval($id_trad_old)
+		AND $connect_statut=='0minirezo'
+		AND $connect_toutes_rubriques) { 
 			spip_query("UPDATE spip_articles SET id_trad = $id_trad_new WHERE id_trad = $id_trad_old");
 			$id_trad = $id_trad_new;
 		}
@@ -1357,20 +1368,23 @@
 				  $vals[] = http_img_pack('langues-12.gif', "", "width='12' height='12' border='0'");
 					$titre_trad = "<b>$titre_trad</b>";
 				} else {
-				  if ($connect_statut=='0minirezo') $vals[] = "<a href='articles.php3?id_article=$id_article&id_trad_old=$id_trad&id_trad_new=$id_article_trad'>". 
-				    http_img_pack('langues-off-12.gif', "", "width='12' height='12' border='0'") . "</a>";
+				  if ($connect_statut=='0minirezo'
+				  AND $connect_toutes_rubriques)
+				  	$vals[] = "<a href='articles.php3?id_article=$id_article&id_trad_old=$id_trad&id_trad_new=$id_article_trad'>". 
+				    http_img_pack('langues-off-12.gif', _T('trad_reference'), "width='12' height='12' border='0'", _T('trad_reference')) . "</a>";
 				  else $vals[] = http_img_pack('langues-off-12.gif', "", "width='12' height='12' border='0'");
 				}
 
 				$ret .= "</td>";
 
-				if ($id_article_trad == $id_article) $s = "$titre_trad";
-				else $s = "<a href='articles.php3?id_article=$id_article_trad'>$titre_trad</a>";
-				if ($id_article_trad == $id_trad) $s .= " "._T("trad_reference");
-				$vals[] = $s;
+				$s = typo($titre_trad);
+				if ($id_article_trad != $id_article) 
+					$s = "<a href='articles.php3?id_article=$id_article_trad'>$s</a>";
+				if ($id_article_trad == $id_trad)
+					$s .= " "._T('trad_reference');
 
+				$vals[] = $s;
 				$vals[] = traduire_nom_langue($lang_trad);
-			
 				$table[] = $vals;
 			}
 
@@ -1408,7 +1422,7 @@
 
 			echo "<form action='$lien' method='post' style='margin:0px; padding:0px;'>";
 			echo _T('trad_lier');
-			echo "<div align='right'><input type='text' class='fondl' name='lier_trad' size='5'> <INPUT TYPE='submit' NAME='Modifier' VALUE='"._T('bouton_modifier')."' CLASS='fondl'></div>";
+			echo "<div align='$spip_lang_right'><input type='text' class='fondl' name='lier_trad' size='5'> <INPUT TYPE='submit' NAME='Modifier' VALUE='"._T('bouton_modifier')."' CLASS='fondl'></div>";
 			echo "</form>";
 			echo "</td>\n";
 			echo "<td background='' width='10'> &nbsp; </td>";
@@ -1552,7 +1566,7 @@
 //
 
 if ($flag_editable) {
-	echo "\n\n<div align=right><br>";
+	echo "\n\n<div align='$spip_lang_right'><br>";
 	
 	if ($date_diff >= 0 AND $date_diff < 60 AND $auteur_modif > 0 AND $auteur_modif != $connect_id_auteur) {
 		$query_auteur = "SELECT * FROM spip_auteurs WHERE id_auteur='$auteur_modif'";
@@ -1614,7 +1628,7 @@
 	icone(_T('icone_poster_message'), "forum_envoi.php3?statut=prive&adresse_retour=".$forum_retour."&id_article=$id_article&titre_message=".urlencode($titre), "forum-interne-24.gif", "creer.gif");
 echo "</div>";
 
-echo "<P align='left'>";
+echo "<P align='$spip_lang_left'>";
 
 
 $query_forum = "SELECT COUNT(*) AS cnt FROM spip_forum WHERE statut='prive' AND id_article='$id_article' AND id_parent=0";

Index: articles_versions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_versions.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- articles_versions.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ articles_versions.php3	29 Mar 2005 15:25:58 -0000	1.3
@@ -107,6 +107,11 @@
 debut_gauche();
 
 
+debut_raccourcis();
+icone_horizontale(_T('icone_retour_article'), "articles.php3?id_article=$id_article", "article-24.gif","rien.gif");
+icone_horizontale(_T('icone_suivi_revisions'), "suivi_revisions.php3", "historique-24.gif","rien.gif");
+fin_raccourcis();
+
 
 //////////////////////////////////////////////////////
 // Affichage de la colonne de droite
@@ -170,7 +175,17 @@
 echo "</td>";
 
 echo "<td align='center'>";
-icone(_T('icone_retour_article'), "articles.php3?id_article=$id_article", "", "article-24.gif");
+
+// L'article est-il editable ?
+$query = "SELECT * FROM spip_auteurs_articles WHERE id_article=$id_article AND id_auteur=$connect_id_auteur";
+$result_auteur = spip_query($query);
+$flag_auteur = (spip_num_rows($result_auteur) > 0);
+$flag_editable = (acces_rubrique($id_rubrique)
+	OR ($flag_auteur AND ($statut_article == 'prepa' OR $statut_article == 'prop' OR $statut_article == 'poubelle')));
+
+if ($flag_editable)
+	icone(_T('icone_modifier_article'), "articles_edit.php3?id_article=$id_article", "article-24.gif", "edit.gif");
+
 echo "</td>";
 
 echo "</tr></table>";
@@ -249,17 +264,17 @@
 	else {
 		echo "<div $dir_lang><b>";
 		$revision_nbsp = ($options == "avancees");	// a regler pour relecture des nbsp dans les articles
-		echo justifier(propre($chapo));
+		echo justifier(propre_diff($chapo));
 		echo "</b></div>\n\n";
 	
 		echo "<div $dir_lang>";
-		echo justifier(propre($texte));
+		echo justifier(propre_diff($texte));
 		echo "</div>";
 	
 		if ($ps) {
 			echo debut_cadre_enfonce();
 			echo "<div $dir_lang><font size='2' face='Verdana,Arial,Sans,sans-serif'>";
-			echo justifier("<b>"._T('info_ps')."</b> ".propre($ps));
+			echo justifier("<b>"._T('info_ps')."</b> ".propre_diff($ps));
 			echo "</font></div>";
 			echo fin_cadre_enfonce();
 		}

Index: articles_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_edit.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- articles_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ articles_edit.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -10,6 +10,7 @@
  *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
 \***************************************************************************/
 
+
 include ("inc.php3");
 include_ecrire ("inc_documents.php3");
 include_ecrire ("inc_barre.php3");
@@ -35,9 +36,6 @@
 //
 
 if ($id_article) {
-	spip_query("UPDATE spip_articles SET date_modif=NOW(), auteur_modif=$connect_id_auteur WHERE id_article=$id_article");
-	$id_article_bloque = $id_article;	// message pour inc_presentation
-
 	// Recuperer les donnees de l'article
 	$query = "SELECT * FROM spip_articles WHERE id_article=$id_article";
 	$result = spip_query($query);
@@ -146,6 +144,13 @@
 }
 
 
+// Qui veut modifier l'article ?
+spip_query("UPDATE spip_articles SET date_modif=NOW(), auteur_modif=$connect_id_auteur WHERE id_article=$id_article");
+$id_article_bloque = $id_article;	// message pour inc_presentation
+
+
+
+
 //
 // Gestion des textes trop longs (limitation brouteurs)
 //
@@ -153,16 +158,20 @@
 function coupe_trop_long($texte){	// utile pour les textes > 32ko
 	if (strlen($texte) > 28*1024) {
 		$texte = str_replace("\r\n","\n",$texte);
-		$pos = strpos($texte, "\n\n\n", 28*1024);	// coupe para > 28 ko
+		$pos = strpos($texte, "\n\n", 28*1024);	// coupe para > 28 ko
 		if ($pos > 0 and $pos < 32 * 1024) {
-			$debut = substr($texte, 0, $pos)."\n\n\n<!--SPIP-->\n";
-			$suite = substr($texte, $pos + 3);
+			$debut = substr($texte, 0, $pos)."\n\n<!--SPIP-->\n";
+			$suite = substr($texte, $pos + 2);
 		} else {
 			$pos = strpos($texte, " ", 28*1024);	// sinon coupe espace
-			if (!($pos > 0 and $pos < 32 * 1024))
-				$pos = 28*1024;	// au pire
-			$debut = substr($texte,0,$pos);
-			$suite = substr($texte,$pos + 1);
+			if (!($pos > 0 and $pos < 32 * 1024)) {
+				$pos = 28*1024;	// au pire (pas d'espace trouv'e)
+				$decalage = 0; // si y'a pas d'espace, il ne faut pas perdre le caract`ere
+			} else {
+				$decalage = 1;
+			}
+			$debut = substr($texte,0,$pos + $decalage); // Il faut conserver l'espace s'il y en a un
+			$suite = substr($texte,$pos + $decalage);
 		}
 		return (array($debut,$suite));
 	}

Index: aide_index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/aide_index.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- aide_index.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ aide_index.php3	29 Mar 2005 15:25:58 -0000	1.3
@@ -33,6 +33,7 @@
 include_ecrire ("inc_lang.php3");
 utiliser_langue_visiteur();
 if ($var_lang) changer_langue($var_lang);
+if ($lang) changer_langue($lang); # pour le cas ou on a fait appel au menu de changement de langue (aide absente dans la langue x)
 
 /////////////////////////////
 // La frame de base
@@ -110,6 +111,15 @@
 	// Recuperation du contenu de l'aide demandee
 	$html = analyse_aide($html, $aide);
 
+	if (!$html) {
+		include_ecrire('inc_presentation.php3');
+		install_debut_html(_T('forum_titre_erreur'));
+		echo "<div>"._T('aide_non_disponible')."</div>";
+		echo "<div align='right'>".menu_langues('var_lang_ecrire')."</div>";
+		install_fin_html();
+		exit;
+	}
+
 	// Recherche des images de l'aide
 	$suite = $html;
 	$html = "";
@@ -445,6 +455,7 @@
 			include_ecrire('inc_presentation.php3');
 			install_debut_html(_T('forum_titre_erreur'));
 			echo "<div>"._T('aide_non_disponible')."</div>";
+			echo "<div align='right'>".menu_langues('var_lang_ecrire')."</div>";
 			install_fin_html();
 			exit;
 		}

Index: admin_vider.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_vider.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- admin_vider.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ admin_vider.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -71,7 +71,7 @@
 echo "\n<INPUT TYPE='hidden' NAME='hash' VALUE='" . calculer_action_auteur("purger_cache") . "'>";
 echo "\n<INPUT TYPE='hidden' NAME='purger_cache' VALUE='oui'>";
 echo "\n<INPUT TYPE='hidden' NAME='redirect' VALUE='" . _DIR_RESTREINT_ABS . "admin_vider.php3'>";
-echo "\n<p><DIV align='right'><INPUT CLASS='fondo' TYPE='submit' NAME='valider' VALUE=\""._T('bouton_vider_cache')."\"></FORM></DIV>";
+echo "\n<p><DIV align='right'><INPUT CLASS='fondo' TYPE='submit' NAME='valider' VALUE=\"".str_replace('"', '&quot;', _T('bouton_vider_cache'))."\"></FORM></DIV>";
 echo "</TD></TR>";
 echo "</TABLE>";
 

Index: auteurs_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteurs_edit.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- auteurs_edit.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ auteurs_edit.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -154,6 +154,7 @@
 	// Afficher le formulaire de changement de statut (cf. inc_acces.php3)
 	if ($options == 'avancees')
 		afficher_formulaire_statut_auteur ($id_auteur,
+			$row['statut'],
 			"auteurs_edit.php3?id_auteur=$id_auteur");
 
 	fin_cadre_relief();

Index: articles_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_forum.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- articles_forum.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ articles_forum.php3	29 Mar 2005 15:25:58 -0000	1.3
@@ -111,7 +111,14 @@
 $mots_cles_forums = lire_meta("mots_cles_forums");
 
 if ($connect_statut == "0minirezo") {
-	$query_forum = "SELECT * FROM spip_forum WHERE id_article='$id_article' AND id_parent=0 AND statut IN ('publie', 'off', 'prop') ORDER BY date_heure DESC LIMIT $debut, $pack";
+	$query_forum = "SELECT pied.*, max(thread.date_heure) AS date
+		FROM spip_forum AS pied, spip_forum AS thread
+		WHERE pied.id_article='$id_article'
+		AND pied.id_parent=0
+		AND pied.statut IN ('publie', 'off', 'prop')
+		AND thread.id_thread=pied.id_forum
+		GROUP BY id_thread
+		ORDER BY date DESC LIMIT $debut, $pack";
 	$result_forum = spip_query($query_forum);
 	afficher_forum($result_forum, $forum_retour, $id_article);
 }

Index: auteur_infos.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteur_infos.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- auteur_infos.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ auteur_infos.php3	29 Mar 2005 15:25:58 -0000	1.4
@@ -70,7 +70,7 @@
 		$auteur['nom'] = filtrer_entites(_T('item_nouvel_auteur'));
 		$onfocus = " onfocus=\"if(!antifocus){this.value='';antifocus=true;}\"";
 	}
-	$auteur['statut'] = '1comite';
+	$auteur['statut'] = '1comite'; // statut par defaut a la creation
 	$auteur['source'] = 'spip';
 }
 
@@ -405,7 +405,7 @@
 
 
 // Afficher le formulaire de changement de statut (cf. inc_acces.php3)
-afficher_formulaire_statut_auteur ($id_auteur);
+afficher_formulaire_statut_auteur ($id_auteur, $auteur['statut']);
 
 
 echo "<INPUT NAME='ajouter_id_article' VALUE='$ajouter_id_article' TYPE='hidden'>\n";



From stef at berlios.de  Tue Mar 29 17:27:14 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:27:14 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_auth_ldap.php3,1.2,1.3 inc_mail.php3,1.2,1.3 config-contenu.php3,1.3,1.4 inc_sites.php3,1.3,1.4 inc_filtres.php3,1.3,1.4 inc_index.php3,1.2,1.3 inc_debug_sql.php3,1.2,1.3 inc_suivi_revisions.php,1.3,1.4 carte_edit.php3,1.7,1.8 config-lang.php3,1.3,1.4 inc_import.php3,1.2,1.3 inc_lang.php3,1.3,1.4 forum_envoi.php3,1.2,1.3 calendrier.php3,1.3,1.4 inc_config.php3,1.2,1.3 inc_documents.php3,1.3,1.4 inc_texte.php3,1.3,1.4 inc_base.php3,1.2,1.3 inc_presentation.php3,1.4,1.5 controle_forum.php3,1.2,1.3 inc_charsets.php3,1.3,1.4 inc_majbase.php3,1.2,1.3 inc_cron.php3,1.2,1.3 inc_forum.php3,1.2,1.3 inc_getdocument.php3,1.3,1.4 inc_logos.php3,1.4,1.5 inc_acces.php3,1.3,1.4 inc_carto.php3,1.8,1.9 inc_rubriques.php3,1.3,1.4 inc_calendrier.php,1.4,1.5
Message-ID: <200503291527.j2TFRE9Y001475@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv1294/spipcarto/ecrire

Modified Files:
	inc_auth_ldap.php3 inc_mail.php3 config-contenu.php3 
	inc_sites.php3 inc_filtres.php3 inc_index.php3 
	inc_debug_sql.php3 inc_suivi_revisions.php carte_edit.php3 
	config-lang.php3 inc_import.php3 inc_lang.php3 
	forum_envoi.php3 calendrier.php3 inc_config.php3 
	inc_documents.php3 inc_texte.php3 inc_base.php3 
	inc_presentation.php3 controle_forum.php3 inc_charsets.php3 
	inc_majbase.php3 inc_cron.php3 inc_forum.php3 
	inc_getdocument.php3 inc_logos.php3 inc_acces.php3 
	inc_carto.php3 inc_rubriques.php3 inc_calendrier.php 
Log Message:
1.8PR2 CVS 20050329

Index: inc_auth_ldap.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_auth_ldap.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_auth_ldap.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_auth_ldap.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -72,7 +72,7 @@
 	}
 
 	function lire() {
-		global $ldap_link, $ldap_base, $flag_utf8_decode;
+		global $ldap_link, $ldap_base;
 		$this->nom = $this->email = $this->pass = $this->statut = '';
 
 		if (!$this->login) return false;
@@ -115,12 +115,11 @@
 		}
 
 		// Convertir depuis UTF-8 (jeu de caracteres par defaut)
-		if ($flag_utf8_decode) {
-			$this->nom = utf8_decode($this->nom);
-			$this->email = utf8_decode($this->email);
-			$this->login = utf8_decode($this->login);
-			$this->bio = utf8_decode($this->bio);
-		}
+		$this->nom = importer_charset($this->nom, 'utf-8');
+		$this->email = importer_charset($this->email, 'utf-8');
+		$this->login = importer_charset($this->login, 'utf-8');
+		$this->bio = importer_charset($this->bio, 'utf-8');
+
 		return true;
 	}
 

Index: inc_mail.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_mail.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_mail.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_mail.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -79,9 +79,29 @@
 	return $test_mail;
 }
 
+function nettoyer_caracteres_mail($t) {
+
+	$t = filtrer_entites($t);
+
+	if (lire_meta('charset') <> 'utf-8') {
+		$t = str_replace(
+			array("&#8217;","&#8220;","&#8221;"),
+			array("'",      '"',      '"'),
+		$t);
+	}
+
+	$t = str_replace(
+		array("&mdash;", "&endash;"),
+		array("--","-" ),
+	$t);
+
+	return $t;
+}
+
 function envoyer_mail($email, $sujet, $texte, $from = "", $headers = "") {
 	global $hebergeur, $queue_mails, $flag_wordwrap;
-	include_ecrire("inc_filtres.php3");
+	include_ecrire('inc_filtres.php3');
+	include_ecrire('inc_charsets.php3');
 
 	if (!$from) {
 		$email_envoi = lire_meta("email_envoi");
@@ -94,25 +114,26 @@
 
 	$charset = lire_meta('charset');
 
-	$headers = "From: $from\n".
+	if (strpos($headers, "Content-Type: ") === false)
+		$headers .=
 		"MIME-Version: 1.0\n".
 		"Content-Type: text/plain; charset=$charset\n".
-		"Content-Transfer-Encoding: 8bit\n$headers";
+		"Content-Transfer-Encoding: 8bit\n";
 
-	$texte = filtrer_entites($texte);
-	$sujet = filtrer_entites($sujet);
+	$headers .= "From: $from\n";
 
-	// fignoler ce qui peut l'etre...
-	if ($charset <> 'utf-8') {
-		$texte = str_replace("&#8217;", "'", $texte);
-		$sujet = str_replace("&#8217;", "'", $sujet);
-	}
-	$texte = str_replace("&mdash;", "--", $texte);
-	$sujet = str_replace("&mdash;", "--", $sujet);
+	// nettoyer les &eacute; &#8217, &emdash; etc...
+	$texte = nettoyer_caracteres_mail($texte);
+	$sujet = nettoyer_caracteres_mail($sujet);
 
 	// encoder le sujet si possible selon la RFC
-	if($GLOBALS['flag_multibyte'] AND @mb_internal_encoding($charset))
+	if (init_mb_string()) {
+		# un bug de mb_string casse mb_encode_mimeheader si l'encoding interne
+		# est UTF-8 et le charset iso-8859-1 (constate php5-mac ; php4.3-debian)
+		mb_internal_encoding($charset);
 		$sujet = mb_encode_mimeheader($sujet, $charset, 'Q');
+		mb_internal_encoding('utf-8');
+	}
 
 	if ($flag_wordwrap) $texte = wordwrap($texte);
 
@@ -188,9 +209,9 @@
 
 		if ($row = spip_fetch_array($result)) {
 
-			// selectionne langue du site
+			// selectionne langue
 			$lang_utilisateur = $GLOBALS['spip_lang'];
-			changer_langue($GLOBALS['langue_site']);
+			changer_langue($row['lang']);
 
 			$titre = nettoyer_titre_email($row['titre']);
 
@@ -215,8 +236,9 @@
 
 	if ($suivi_edito == "oui") {
 		if ($row = spip_fetch_array(spip_query("SELECT * FROM spip_articles WHERE id_article = $id_article"))) {
+
 			$lang_utilisateur = $GLOBALS['spip_lang'];
-			changer_langue($GLOBALS['langue_site']);
+			changer_langue($row['lang']);
 
 			$titre = nettoyer_titre_email($row['titre']);
 

Index: config-contenu.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-contenu.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- config-contenu.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ config-contenu.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -264,10 +264,9 @@
 	$adresse_neuf=lire_meta("adresse_neuf");
 	$jours_neuf=lire_meta("jours_neuf");
 
-	if ($envoi_now) {
-		ecrire_meta('majnouv', time()-3600*24*$jours_neuf);
-		ecrire_metas();
-	}
+	// provoquer l'envoi des nouveautes en supprimant le fichier lock
+	if ($envoi_now)
+		@unlink(_DIR_SESSIONS . 'mail.lock');
 
 	echo "<p />";
 	debut_cadre_relief("", false, "", _T('info_annonce_nouveautes'));

Index: inc_sites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_sites.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_sites.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_sites.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -17,16 +17,21 @@
 define("_INC_SITES", "1");
 
 
-if ($supprimer_lien = $GLOBALS["supprimer_lien"]) {
-	spip_query("UPDATE spip_syndic_articles SET statut='refuse' WHERE id_syndic_article='$supprimer_lien'");
-}
-
-if ($ajouter_lien = $GLOBALS["ajouter_lien"]) {
-	spip_query("UPDATE spip_syndic_articles SET statut='publie' WHERE id_syndic_article='$ajouter_lien'");
+// Moderation manuelle des liens
+if (!_DIR_RESTREINT AND $GLOBALS['connect_statut'] == '0minirezo') {
+	if ($supprimer_lien = $GLOBALS["supprimer_lien"])
+		spip_query("UPDATE spip_syndic_articles SET statut='refuse'
+		WHERE id_syndic_article='$supprimer_lien'");
+	if ($ajouter_lien = $GLOBALS["ajouter_lien"])
+		spip_query("UPDATE spip_syndic_articles SET statut='publie'
+		WHERE id_syndic_article='$ajouter_lien'");
 }
 
-
-function recuperer_page($url) {
+//
+// Recupere une page sur le net
+// et au besoin l'encode dans le charset local
+//
+function recuperer_page($url, $munge_charset=false) {
 	$http_proxy = lire_meta("http_proxy");
 	if (!eregi("^http://", $http_proxy))
 		$http_proxy = '';
@@ -38,6 +43,11 @@
 	for ($i=0;$i<10;$i++) {	// dix tentatives maximum en cas d'entetes 301...
 		$t = @parse_url($url);
 		$host = $t['host'];
+		if ($t['scheme'] == 'http') {
+			$scheme = 'http'; $scheme_fsock='';
+		} else {
+			$scheme = $t['scheme']; $scheme_fsock=$scheme.'://';
+		}
 		if (!($port = $t['port'])) $port = 80;
 		$query = $t['query'];
 		if (!($path = $t['path'])) $path = "/";
@@ -48,11 +58,11 @@
 			if (!($proxy_port = $t2['port'])) $proxy_port = 80;
 			$f = @fsockopen($proxy_host, $proxy_port);
 		} else
-			$f = @fsockopen($host, $port);
+			$f = @fsockopen($scheme_fsock.$host, $port);
 
 		if ($f) {
 			if ($http_proxy)
-				fputs($f, "GET http://$host" . (($port != 80) ? ":$port" : "") . $path . ($query ? "?$query" : "") . " HTTP/1.0\r\n");
+				fputs($f, "GET $scheme://$host" . (($port != 80) ? ":$port" : "") . $path . ($query ? "?$query" : "") . " HTTP/1.0\r\n");
 			else
 				fputs($f, "GET $path" . ($query ? "?$query" : "") . " HTTP/1.0\r\n");
 
@@ -68,8 +78,10 @@
 			}
 			else return;
 			while ($s = trim(fgets($f, 16384))) {
+				$headers .= $s."\n";
 				if (eregi('^Location: (.*)', $s, $r)) {
 					$location = $r[1];
+					spip_log($s);
 				}
 			}
 			if ($status >= 300 AND $status < 400 AND $location) $url = $location;
@@ -94,25 +106,16 @@
 		fclose($f);
 	}
 
-	return $result;
-}
-
-
-function transcoder_page($texte) {
-	include_ecrire('inc_charsets.php3');
-
-	// Si le backend precise son charset et que celui-ci est connu de SPIP,
-	// decoder puis recoder
-	if (ereg('<\\?xml[[:space:]]([^>]*[[:space:]])?encoding[[:space:]]*=[[:space:]]*[\'"]([-_a-zA-Z0-9]+)[\'"]', $texte, $regs)) {
-		$charset_page = strtolower($regs[2]);
-		$texte = importer_charset($texte, $charset_page);
+	// Faut-il l'importer dans notre charset local ?
+	if ($munge_charset) {
+		include_ecrire('inc_charsets.php3');
+		$result = transcoder_page ($result, $headers);
 	}
-	// Si le backend ne precise pas, on considere qu'il est iso-8859-1
-	else $texte = importer_charset($texte, 'iso-8859-1');
 
-	return $texte;
+	return $result;
 }
 
+
 function trouver_format($texte) {
 	$syndic_version = '';
 	
@@ -130,7 +133,7 @@
 function analyser_site($url) {
 	include_ecrire("inc_filtres.php3");
 
-	$texte = transcoder_page(recuperer_page($url));
+	$texte = recuperer_page($url, true);
 	if (!$texte) return false;
 	$result = '';
 	
@@ -223,7 +226,7 @@
 
 	spip_query("UPDATE spip_syndic SET syndication='$statut', date_syndic=NOW() WHERE id_syndic='$now_id_syndic'");
 
-	$le_retour = transcoder_page(recuperer_page($url_syndic));
+	$le_retour = recuperer_page($url_syndic, true);
 	$erreur = "";
 	$les_auteurs_du_site = "";
 
@@ -235,47 +238,47 @@
 		case "0.92" :
 		case "2.0" :
 			$syndic_regexp = array(
-				'item'           => '<item[>[:space:]]',
+				'item'           => ',<item[>[:space:]],i',
 				'itemfin'        => '</item>',
 				'link1'          => '<link[^>]*>([^<]*)</link>',
 				'link2'          => '(.*)',
-				'date1'          => '<pubDate>([^<]*)</pubDate>',
-				'date2'          => '<[[:alpha:]]{2}:date>([^<]*)</[[:alpha:]]{2}:date>',
+				'date1'          => ',<pubDate>([^<]*)</pubDate>,Uims',
+				'date2'          => ',<[[:alpha:]]{2}:date>([^<]*)</[[:alpha:]]{2}:date>,Uims',
 				'author1'        => '<[[:alpha:]]{2}:[Cc]reator>([^<]*)</[[:alpha:]]{2}:[Cc]reator>',
 				'author2'        => '(.*)',
 				'authorbis'      => '<author>([^<]*)</author>',
-				'description'    => '<description[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</description[^>]*>',
-				'descriptionbis' =>     '<content[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</content[^>]*>'
+				'description'    => ',<description[^>]*>(.*?)</description[^>]*>,ims',
+				'descriptionbis' =>     '<content[^>]*>(.*?)</content[^>]*>'
 			);
 			break;
 		case "1.0" :
 			$syndic_regexp = array(
-				'item'           => '<item[>[:space:]]',
+				'item'           => ',<item[>[:space:]],i',
 				'itemfin'        => '</item>',
 				'link1'          => '<link[^>]*>([^<]*)</link>',
 				'link2'          => '(.*)',
-				'date1'          => '<[[:alpha:]]{2}:date>([^<]*)</[[:alpha:]]{2}:date>',
-				'date2'          => '<pubDate>([^<]*)</pubDate>',
+				'date1'          => ',<[[:alpha:]]{2}:date>([^<]*)</[[:alpha:]]{2}:date>,Uims',
+				'date2'          => ',<pubDate>([^<]*)</pubDate>,Uims',
 				'author1'        => '<[[:alpha:]]{2}:[Cc]reator>([^<]*)</[[:alpha:]]{2}:[Cc]reator>',
 				'author2'        => '(.*)',
 				'authorbis'      => '<author>([^<]*)</author>',
-				'description'    => '<description[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</description[^>]*>',
-				'descriptionbis' =>     '<content[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</content[^>]*>'
+				'description'    => ',<description[^>]*>(.*?)</description[^>]*>,ims',
+				'descriptionbis' =>     ',<content[^>]*>(.*?)</content[^>]*>,ims'
 			);
 			break;
 		case "0.3" :
 			$syndic_regexp = array('channel'=>'<feed[^>]*>(.*)</feed>',
-				'item'           => '<entry[>[:space:]]',
+				'item'           => ',<entry[>[:space:]],i',
 				'itemfin'        => '</entry>',
 				'link1'          => '<link[[:space:]]([^<]*)rel[[:space:]]*=[[:space:]]*[\'"]alternate[\'"]([^<]*)/>',
 				'link2'          => 'href[[:space:]]*=[[:space:]]*[\'"]([^"|^\']+)[\'"]',
-				'date1'          => '<modified>([^<]*)</modified>',
-				'date2'          => '<issued>([^<]*)</issued>',
+				'date1'          => ',<modified>([^<]*)</modified>,Uims',
+				'date2'          => ',<issued>([^<]*)</issued>,Uims',
 				'author1'        => '<author>(.*<name>.*</name>.*)</author>',
 				'author2'        => '<name>([^<]*)</name>',
 				'authorbis'      => '<[[:alpha:]]{2}:[Cc]reator>([^<]*)</[[:alpha:]]{2}:[Cc]reator>',
-				'description'    => '<summary[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(\]{2}>)?[[:space:]]*</summary[^>]*>',
-				'descriptionbis' => '<content[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(\]{2}>)?[[:space:]]*</content[^>]*>'
+				'description'    => ',<summary[^>]*>(.*?)</summary[^>]*>,ims',
+				'descriptionbis' => ',<content[^>]*>(.*?)</content[^>]*>,ims'
 			);
 			break;
 		default :
@@ -285,126 +288,142 @@
 			break;
 	}
 
-	// chercher un auteur dans le fil au cas ou les entry n'en auraient pas
-
 	if ($le_retour) {
-		list($channel_head,$drop) = split($syndic_regexp['item'], $le_retour, 2);
+		// Echapper les CDATA
+		$echappe_cdata = array();
+		if (preg_match_all(',<!\[CDATA\[(.*)]]>,Uims', $le_retour, $regs, PREG_SET_ORDER)) {
+			foreach ($regs as $n => $reg) {
+				$echappe_cdata[$n] = $reg[1];
+				$le_retour = str_replace($reg[0], "@@@SPIP_CDATA$n@@@",
+					$le_retour);
+			}
+		}
+
+		// chercher un auteur dans le fil au cas ou les entry n'en auraient pas
+		list($channel_head) = preg_split($syndic_regexp['item'], $le_retour, 2);
 		if (ereg($syndic_regexp['author1'],$channel_head,$mat)) {
 			if (ereg($syndic_regexp['author2'],$mat[1],$match))
-				$les_auteurs_du_site = addslashes(filtrer_entites($match[1]));
-	}
-		$i = 0;
-		while (ereg($syndic_regexp['item'],$le_retour,$regs)) {
+				$les_auteurs_du_site = $match[1];
+		}
+
+
+		$items = array();
+		while (preg_match($syndic_regexp['item'],$le_retour,$regs)) {
 			$debut_item=strpos($le_retour,$regs[0]);
 			$fin_item=strpos($le_retour,$syndic_regexp['itemfin'])+strlen($syndic_regexp['itemfin']);
-			$item[$i]=substr($le_retour,$debut_item,$fin_item-$debut_item);
+			$items[]=substr($le_retour,$debut_item,$fin_item-$debut_item);
 
 			$debut_texte=substr($le_retour,"0",$debut_item);
 			$fin_texte=substr($le_retour,$fin_item,strlen($le_retour));
 			$le_retour=$debut_texte.$fin_texte;
-			$i++;
 		}
-		if (is_array($item)) {
+		if (count($items)) {
 			$now = time();
-			for ($i = 0 ; $i < count($item) ; $i++) {
+			foreach ($items as $item) {
+
+				$data = array();
 
 				// URL (obligatoire)
-				if (ereg($syndic_regexp['link1'],$item[$i],$match)) {
+				if (ereg($syndic_regexp['link1'],$item,$match)) {
 					$link_match = $match[1].$match[2];
 					if (ereg($syndic_regexp['link2'], $link_match, $mat))
-						$le_lien = addslashes(filtrer_entites($mat[1]));
+						$data['url'] = addslashes(filtrer_entites($mat[1]));
 				}
-				else if (ereg("<guid>([^<]*)</guid>",$item[$i],$match))
-					$le_lien = addslashes(filtrer_entites($match[1]));
+				// guid n'est un URL que si marque de <guid permalink="true">
+				else if (eregi("<guid.*>[[:space:]]*(https?:[^<]*)</guid>",$item,$match))
+					$data['url'] = addslashes(filtrer_entites($match[1]));
 				else continue;
 
 				// Titre (obligatoire)
 				if
-(ereg("<title>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</title>",$item[$i],$match))
-					$le_titre = addslashes(supprimer_tags(filtrer_entites($match[2])));
+(preg_match(",<title>(.*?)</title>,ims",$item,$match))
+					$data['titre'] = $match[1];
 				else if (($syndic_version==0.3) AND (strlen($letitre)==0))
 					if (ereg('title[[:space:]]*=[[:space:]]*[\'"]([^"|^\']+)[\'"]',$link_match,$mat))
-						$le_titre=$mat[1]; 
+						$data['titre']=$mat[1]; 
 				else continue;
 
 				// Date
 				$la_date = "";
-				if (ereg("<date>([^<]*)</date>",$item[$i],$match))
+				if (preg_match(",<date>([^<]*)</date>,Uims",$item,$match))
 					$la_date = $match[1];
-				if (ereg($syndic_regexp['date1'],$item[$i],$match))
+				if (preg_match($syndic_regexp['date1'],$item,$match))
 					$la_date = $match[1];
-				else if (ereg($syndic_regexp['date2'],$item[$i],$match))
+				else if (preg_match($syndic_regexp['date2'],$item,$match))
 					$la_date = $match[1];
-				if ($GLOBALS['flag_strtotime'] AND $la_date) {
+				if ($la_date) {
 					// http://www.w3.org/TR/NOTE-datetime
 					if (ereg('^([0-9]+-[0-9]+-[0-9]+T[0-9]+:[0-9]+(:[0-9]+)?)(\.[0-9]+)?(Z|([-+][0-9][0-9]):[0-9]+)$', $la_date, $match)) {
 						$la_date = str_replace("T", " ", $match[1])." GMT";
 						$la_date = strtotime($la_date) - intval($match[5]) * 3600;
 					}
-					else $la_date = strtotime($la_date);
+					else
+						$la_date = strtotime($la_date);
 				}
 				if ($la_date < $now - 365 * 24 * 3600 OR $la_date > $now + 48 * 3600)
 					$la_date = $now;
 
 				// Auteur
-				if (ereg($syndic_regexp['author1'],$item[$i],$mat)) {
+				if (ereg($syndic_regexp['author1'],$item,$mat)) {
 					if (ereg($syndic_regexp['author2'],$mat[1],$match))
-						$les_auteurs = addslashes(filtrer_entites($match[1]));
+						$data['lesauteurs'] = $match[1];
 				}
-				else if (ereg($syndic_regexp['authorbis'],$item[$i],$match))
-					$les_auteurs = addslashes(filtrer_entites($match[1]));
-				else $les_auteurs = $les_auteurs_du_site;
+				else if (ereg($syndic_regexp['authorbis'],$item,$match))
+					$data['lesauteurs'] = $match[1];
+				else $data['lesauteurs'] = $les_auteurs_du_site;
 
 				// Description
-				if (ereg($syndic_regexp['description'],$item[$i],$match)) {
-					$la_description = couper(addslashes(supprimer_tags(filtrer_entites($match[2]))),300);
-				}
-				elseif (ereg($syndic_regexp['descriptionbis'],$item[$i],$match))
-					$la_description = couper(addslashes(supprimer_tags(filtrer_entites($match[2]))),300);
-				else $la_description = "";
-				$query_deja = "SELECT * FROM spip_syndic_articles WHERE url='$le_lien' AND id_syndic=$now_id_syndic";
-				$result_deja = spip_query($query_deja);
-				if (spip_num_rows($result_deja) == 0 and !spip_sql_error()) {
-					$query_syndic = "INSERT INTO spip_syndic_articles (id_syndic, titre, url, date, lesauteurs, statut, descriptif) ".
-						"VALUES ('$now_id_syndic', '$le_titre', '$le_lien', FROM_UNIXTIME($la_date), '$les_auteurs', '$moderation', '$la_description')";
-					$result_syndic=spip_query($query_syndic);
-					$flag_ajout_lien = true;
+				if (preg_match($syndic_regexp['description'],$item,$match)) {
+					$data['descriptif'] = $match[1];
 				}
-			}
-			spip_query("UPDATE spip_syndic SET syndication='oui' WHERE id_syndic='$now_id_syndic'");
-		}
-		// syndication javascript : y a-t-il quelqu'un qui se sert de ce truc ??
-		// la question est posee
-		else if (ereg("document\.write", $le_retour)) {
-			$i = 0;
-			while ($i < 50 AND eregi("<a[[:space:]]+href[[:space:]]*=[[:space:]]*\"?([^\">]+)\"?[^>]*>(.*)",$le_retour,$reg)){ //"
-				$le_lien = addslashes(stripslashes($reg[1]));
-				$la_suite = $reg[2];
-
-				$pos_fin = strpos($la_suite, "</a");
-				$pos_fin2 = strpos($la_suite, "</A");
-				if ($pos_fin2 > $pos_fin) $pos_fin = $pos_fin2;
+				else if (preg_match($syndic_regexp['descriptionbis'],$item,$match)) {
+					$data['descriptif'] = $match[1];
+				} else $data['descriptif'] = "";
 
-				$le_titre = substr($la_suite, 0, $pos_fin);
-				$le_titre = addslashes(stripslashes($le_titre));
-				$le_titre = ereg_replace("<[^>]*>","",$le_titre);
-				$le_retour = substr($la_suite, $pos_fin + 4, strlen($le_retour));
+				// Nettoyer les donnees et remettre les CDATA en place
+				foreach ($data as $var => $val) {
+					$data[$var] = filtrer_entites($data[$var]);
+					foreach ($echappe_cdata as $n => $e)
+						$data[$var] = str_replace("@@@SPIP_CDATA$n@@@",$e, $data[$var]);
+					$data[$var] = trim(textebrut($data[$var]));
+					if ($var == 'descriptif')
+						$data[$var] = couper($data[$var], 300);
+				}
 
-				echo "<li> $le_titre / $le_lien";
+				// Creer le lien s'il est nouveau - cle=(id_syndic,url)
+				$le_lien = addslashes($data['url']);
+				if (spip_num_rows(spip_query(
+					"SELECT * FROM spip_syndic_articles
+					WHERE url='".addslashes($data['url'])."'
+					AND id_syndic=$now_id_syndic"
+				)) == 0 and !spip_sql_error()) {
+					spip_query("INSERT INTO spip_syndic_articles
+					(id_syndic, url, date, statut) VALUES
+					('$now_id_syndic', '$le_lien',
+					FROM_UNIXTIME($la_date), '$moderation')");
+					$liens_ajoutes ++;
+				}
 
-				if (strlen($la_date) < 4) $la_date=date("Y-m-j H:i:00");
+				// Mise a jour du contenu (titre,auteurs,description)
+				spip_query ("UPDATE spip_syndic_articles SET
+				titre='".addslashes($data['titre'])."',
+				lesauteurs='".addslashes($data['lesauteurs'])."',
+				descriptif='".addslashes($data['descriptif'])."'
+				WHERE id_syndic='$now_id_syndic' AND url='$le_lien'");
 
-				$query_deja="SELECT * FROM spip_syndic_articles WHERE url='$le_lien' AND id_syndic=$now_id_syndic";
-				$result_deja=spip_query($query_deja);
-				if (spip_num_rows($result_deja)==0){
-					$query_syndic = "INSERT INTO spip_syndic_articles (id_syndic, titre, url, date, lesauteurs, statut, descriptif) ".
-						"VALUES ('$now_id_syndic', '$le_titre', '$le_lien', '$la_date', '$les_auteurs', '$moderation', '$la_description')";
-					$result_syndic=spip_query($query_syndic);
-					$flag_ajout_lien = true;
+				// Honorer le <lastbuilddate> en forcant la date
+				if (preg_match(',<(lastbuilddate|modified)>([^<>]+)</\1>,i',
+				$item, $regs)
+				AND $lastbuilddate = strtotime(trim($regs[2]))
+				// pas dans le futur
+				AND $lastbuilddate < time()) {
+					spip_query("UPDATE spip_syndic_articles
+					SET date = FROM_UNIXTIME($lastbuilddate)
+					WHERE id_syndic='$now_id_syndic' AND url='$le_lien'");
 				}
-				$i++;
+				
 			}
-			spip_query("UPDATE spip_syndic SET syndication='oui', date_syndic=NOW() WHERE id_syndic='$now_id_syndic'");
+			spip_query("UPDATE spip_syndic SET syndication='oui' WHERE id_syndic='$now_id_syndic'");
 		}
 		else $erreur = _T('avis_echec_syndication_01');
 	}
@@ -413,7 +432,8 @@
 	// Ne pas oublier de liberer le verrou
 	spip_release_lock($url_syndic);
 
-	if ($flag_ajout_lien) {
+	if ($liens_ajoutes) {
+		spip_log("Syndication: $liens_ajoutes nouveau(x) lien(s)");
 		include_ecrire('inc_rubriques.php3');
 		calculer_rubriques();
 	}
@@ -571,9 +591,7 @@
 	global $flag_editable;
 
 	static $n_liste_sites;
-
-	$n_liste_sites++;
-	if (!$debut_liste_sites[$n_liste_sites]) $debut_liste_sites[$n_liste_sites] = 0;
+	global $spip_lang_rtl;
 
 	$adresse_page = substr($REQUEST_URI, strpos($REQUEST_URI, "/ecrire")+8, strlen($REQUEST_URI));
 	$adresse_page = ereg_replace("\&?debut\_liste\_sites\[$n_liste_sites\]\=[0-9]+","",$adresse_page);
@@ -584,131 +602,123 @@
 
 	$lien_url .= "debut_liste_sites[".$n_liste_sites."]=".$debut_liste_sites[$n_liste_sites]."&";
 
+	$cols = 2;
+	if ($connect_statut == '0minirezo') $cols ++;
+	if ($afficher_site) $cols ++;
 
-	$nombre_aff = 10;
-
- 	$result = spip_query($requete);
-	$num_rows = spip_num_rows($result);
+	$tranches = afficher_tranches_requete($requete, $cols);
 
-	// Ne pas couper pour trop peu
-	if ($num_rows <= 1.5 * $nombre_aff) $nombre_aff = $num_rows;
+	if (strlen($tranches)) {
 
-		if ($num_rows > 0) {
-			echo "<p><table width='100%' cellpadding='0' cellspacing='0' border='0'><tr><td width='100%' background=''>";
-			echo "<table width='100%' cellpadding='3' cellspacing='0' border='0'>";
+		if ($titre_table) echo "<div style='height: 12px;'></div>";
+		echo "<div class='liste'>";
+		//debut_cadre_relief("rubrique-24.gif");
 
-			bandeau_titre_boite($titre_table, true);
+		if ($titre_table) {
+			bandeau_titre_boite2($titre_table, "site-24.gif", "#999999", "white");
+		}
+		echo "<table width=100% cellpadding=3 cellspacing=0 border=0 background=''>";
 
-			if ($num_rows > $nombre_aff) {
-				echo "<tr><td background='' class='arial2' colspan='4'>";
-				for ($i = 0; $i < $num_rows; $i = $i + $nombre_aff){
-					$deb = $i + 1;
-					$fin = $i + $nombre_aff;
-					if ($fin > $num_rows) $fin = $num_rows;
-					if ($debut_liste_sites[$n_liste_sites] == $i) {
-						echo "[<b>$deb-$fin</b>] ";
-					} else {
-						echo "[<a href='".$adresse_page.$lien_url."debut_liste_sites[$n_liste_sites]=$i'>$deb-$fin</a>] ";
-					}
-				}
-				echo "</td></tr>";
-			}
-		
-			$ifond = 0;
-			$premier = true;
-			
-			$compteur_liste = 0;
+		echo $tranches;
 
-			while ($row = spip_fetch_array($result)) {
-				if ($compteur_liste >= $debut_liste_sites[$n_liste_sites] AND $compteur_liste < $debut_liste_sites[$n_liste_sites] + $nombre_aff) {
-					$ifond = $ifond ^ 1;
-					$couleur = ($ifond) ? '#FFFFFF' : $couleur_claire;
+		$result = spip_query($requete);
 
-					$id_syndic_article=$row["id_syndic_article"];
-					$id_syndic=$row["id_syndic"];
-					$titre=typo($row["titre"]);
-					$url=$row["url"];
-					$date=$row["date"];
-					$lesauteurs=propre($row["lesauteurs"]);
-					$statut=$row["statut"];
-					$descriptif=$row["descriptif"];
+		$table = '';
+		while ($row = spip_fetch_array($result)) {
+			$vals = '';
 
-					echo "<tr bgcolor='$couleur'>";
-					
-					echo "<td class='arial1'>";
-					echo "<a href='$url'>";
-					if ($statut=='publie') {
-						if (acces_restreint_rubrique($id_rubrique))
-							$puce = 'puce-verte-anim.gif';
-						else
-							$puce='puce-verte.gif';
-					}
-					else if ($statut == "refuse") {
-							$puce = 'puce-poubelle.gif';
-					}
+			$id_syndic_article=$row["id_syndic_article"];
+			$id_syndic=$row["id_syndic"];
+			$titre=typo($row["titre"]);
+			$url=$row["url"];
+			$date=$row["date"];
+			$lesauteurs=propre($row["lesauteurs"]);
+			$statut=$row["statut"];
+			$descriptif=propre($row["descriptif"]);
 
-					else if ($statut == "dispo") { // moderation : a valider
-							$puce = 'puce-rouge.gif';
-					}
+			
+			if ($statut=='publie') {
+				if (acces_restreint_rubrique($id_rubrique))
+					$puce = 'puce-verte-anim.gif';
+				else
+					$puce='puce-verte.gif';
+			}
+			else if ($statut == "refuse") {
+					$puce = 'puce-poubelle.gif';
+			}
 
-					else if ($statut == "off") { // vieillerie
-							$puce = 'puce-rouge-anim.gif';
-					}
+			else if ($statut == "dispo") { // moderation : a valider
+					$puce = 'puce-rouge.gif';
+			}
 
-					echo http_img_pack($puce, "", "width='7' height='7' border='0'");
+			else if ($statut == "off") { // vieillerie
+					$puce = 'puce-rouge-anim.gif';
+			}
 
-					if ($statut == "refuse")
-						echo "<font color='black'>&nbsp;&nbsp;$titre</font>";
-					else
-						echo "&nbsp;&nbsp;".$titre;
+			$s = http_img_pack($puce, "", "width='7' height='7' border='0'");
+			$vals[] = $s;
 
-					echo "</a>";
+			$s = "<a href='$url'>$titre</a>";
+			if (strlen($lesauteurs) > 0) $s .= " ($lesauteurs)";
+			if (strlen($descriptif) > 0) $s .= "<div class='arial1'>$descriptif</div>";
+			$vals[] = $s;
 
-					if (strlen($lesauteurs)>0) echo "<br />"._T('info_auteurs_nombre')." <font color='#336666'>$lesauteurs</font>";
-					if (strlen($descriptif)>0) echo "<br />"._T('info_descriptif_nombre')." <font color='#336666'>$descriptif</font>";
-					
-					echo "</td>";
-					
-					// $my_sites cache les resultats des requetes sur les sites
-					if ($afficher_site) {
-						if (!$my_sites[$id_syndic])
-							$my_sites[$id_syndic] = spip_fetch_array(spip_query(
-								"SELECT * FROM spip_syndic WHERE id_syndic=$id_syndic"));
-						echo "<td class='arial1' align='left'>";
-						$aff = $my_sites[$id_syndic]['nom_site'];
-						if ($my_sites[$id_syndic]['moderation'] == 'oui')
-							echo "<i>$aff</i>";
-						else
-							echo $aff;
-						echo "</td>";
-					} else echo "<td></td>";
+			// $my_sites cache les resultats des requetes sur les sites
+			if ($afficher_site) {
+				if (!$my_sites[$id_syndic])
+					$my_sites[$id_syndic] = spip_fetch_array(spip_query(
+						"SELECT * FROM spip_syndic WHERE id_syndic=$id_syndic"));
 
-					echo "<td class='arial1' align='right'>";
+				$aff = $my_sites[$id_syndic]['nom_site'];
+				if ($my_sites[$id_syndic]['moderation'] == 'oui')
+					$s = "<i>$aff</i>";
+				else
+					$s = $aff;
 					
-					if ($connect_statut == '0minirezo'){
-						if ($statut == "publie"){
-							echo "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&supprimer_lien=$id_syndic_article'><font color='black'>"._T('info_bloquer_lien')."</font></a>]";
-						
-						}
-						else if ($statut == "refuse"){
-							echo "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&ajouter_lien=$id_syndic_article'>"._T('info_retablir_lien')."</a>]";
-						}
-						else if ($statut == "dispo") {
-							echo "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&ajouter_lien=$id_syndic_article'>"._T('info_valider_lien')."</a>]";
-						}
-					} else {
-						echo "&nbsp;";
-					}
+				$s = "<a href='sites.php3?id_syndic=$id_syndic'>$aff</a>";
 
-					echo "</td>";
-					echo "</tr></n>";
+				$vals[] = $s;
+			}
 
+			
+			if ($connect_statut == '0minirezo'){
+				if ($statut == "publie"){
+					$s =  "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&supprimer_lien=$id_syndic_article'><font color='black'>"._T('info_bloquer_lien')."</font></a>]";
+				
+				}
+				else if ($statut == "refuse"){
+					$s =  "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&ajouter_lien=$id_syndic_article'>"._T('info_retablir_lien')."</a>]";
+				}
+				else if ($statut == "dispo") {
+					$s = "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&ajouter_lien=$id_syndic_article'>"._T('info_valider_lien')."</a>]";
+				}
+				$vals[] = $s;
 			}
-			$compteur_liste++;
+					
+			$table[] = $vals;
+		}
+		spip_free_result($result);
 
+		
+		if ($afficher_site) {
+			$largeurs = array(7, '', '100');
+			$styles = array('','arial11', 'arial1');
+		} else {
+			$largeurs = array(7, '');
+			$styles = array('','arial11');
 		}
-		echo "</table></td></tr></table></p>";
+		if ($connect_statut == '0minirezo') {
+			$largeurs[] = '80';
+			$styles[] = 'arial1';
+		}
+		
+		afficher_liste($largeurs, $table, $styles);
+
+		echo "</TABLE>";
+		//fin_cadre_relief();
+		echo "</div>";
 	}
+	return $tous_id;
 }
 
 

Index: inc_filtres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_filtres.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_filtres.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_filtres.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -47,6 +47,50 @@
 	return charset2unicode($texte);
 }
 
+// caracteres de controle - http://www.w3.org/TR/REC-xml/#charsets
+function supprimer_caracteres_illegaux($texte) {
+	$from = "\x0\x1\x2\x3\x4\x5\x6\x7\x8\xB\xC\xE\xF\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F";
+	$to = str_repeat('-', strlen($from));
+	return strtr($texte, $from, $to);
+}
+
+// Corrige les caracteres degoutants utilises par les Windozeries
+function corriger_caracteres_windows($texte) {
+	static $trans;
+	if (!$trans) {
+		// 145,146,180 = simple quote ; 147,148 = double quote ; 150,151 = tiret long
+		$trans['iso-8859-1'] = array(
+			chr(146) => "'",
+			chr(180) => "'",
+			chr(147) => '&#8220;',
+			chr(148) => '&#8221;',
+			chr(150) => '-',
+			chr(151) => '-',
+			chr(133) => '...'
+		);
+		$trans['utf-8'] = array(
+			chr(194).chr(146) => "'",
+			chr(194).chr(180) => "'",
+			chr(194).chr(147) => '&#8220;',
+			chr(194).chr(148) => '&#8221;',
+			chr(194).chr(150) => '-',
+			chr(194).chr(151) => '-',
+			chr(194).chr(133) => '...'
+		);
+	}
+	$charset = lire_meta('charset');
+	if (!$trans[$charset]) return $texte;
+	return strtr($texte, $trans[$charset]);
+}
+
+// Supprimer caracteres windows et les caracteres de controle ILLEGAUX
+function corriger_caracteres ($texte) {
+	$texte = corriger_caracteres_windows($texte);
+	$texte = supprimer_caracteres_illegaux($texte);
+	return $texte;
+}
+
+
 // Nettoyer les backend
 function texte_backend($texte) {
 
@@ -79,9 +123,9 @@
 
 // Suppression basique et brutale de tous les <...>
 function supprimer_tags($texte, $rempl = "") {
-	// super gavant : la regexp ci-dessous plante sous php3, genre boucle infinie !
-	// $texte = ereg_replace("<([^>\"']*|\"[^\"]*\"|'[^']*')*>", $rempl, $texte);
-	$texte = ereg_replace("<[^>]*>", $rempl, $texte);
+	$texte = preg_replace(",<([^>\"']*|\"[^>\"]*\"|'[^>']*')*>,", $rempl, $texte);
+	// ne pas oublier un < final non ferme
+	$texte = str_replace('<', ' ', $texte);
 	return $texte;
 }
 
@@ -93,13 +137,13 @@
 
 // Convertit un texte HTML en texte brut
 function textebrut($texte) {
-	$texte = ereg_replace("[\n\r]+", " ", $texte);
-	$texte = eregi_replace("<(p|br)([[:space:]][^>]*)?".">", "\n\n", $texte);
-	$texte = ereg_replace("^\n+", "", $texte);
-	$texte = ereg_replace("\n+$", "", $texte);
-	$texte = ereg_replace("\n +", "\n", $texte);
+	$texte = preg_replace("/[[:space:]]+/", " ", $texte);
+	$texte = preg_replace("/<(p|br)( [^>]*)?".">/i", "\n\n", $texte);
+	$texte = preg_replace("/^\n+/", "", $texte);
+	$texte = preg_replace("/\n+$/", "", $texte);
+	$texte = preg_replace("/\n +/", "\n", $texte);
 	$texte = supprimer_tags($texte);
-	$texte = ereg_replace("(&nbsp;| )+", " ", $texte);
+	$texte = preg_replace("/(&nbsp;| )+/", " ", $texte);
 	// nettoyer l'apostrophe curly qui pose probleme a certains rss-readers, lecteurs de mail...
 	$texte = str_replace("&#8217;","'",$texte);
 	return $texte;
@@ -130,45 +174,18 @@
 // produit une balise img avec un champ alt d'office (et different) si vide
 // attention le htmlentities et la traduction doivent etre appliques avant.
 
-function http_img_pack($img, $alt, $att) {
-  static $num = 0;
-  return "<img src='" . _DIR_IMG_PACK . $img .
-    ("'\nalt=\"" . ($alt ? $alt : ('img_pack' . $num++)) . '" ') .
-    $att . " />";
+function http_img_pack($img, $alt, $att, $title='') {
+	static $num = 0;
+	return "<img src='" . _DIR_IMG_PACK . $img
+		. ("'\nalt=\"" . ($alt ? $alt : ('img_pack' . $num++)) . '" ')
+		. ($title ? " title=\"$title\"" : '')
+		. $att . " />";
 }
 
 function http_href_img($href, $img, $att, $title='', $style='', $class='', $evt='') {
 	return  http_href($href, http_img_pack($img, $title, $att), $title, $style, $class, $evt);
 }
 
-// Corrige les caracteres degoutants utilises par les Windozeries
-function corriger_caracteres($texte) {
-	static $trans;
-	if (!$trans) {
-		// 145,146,180 = simple quote ; 147,148 = double quote ; 150,151 = tiret long
-		$trans['iso-8859-1'] = array(
-			chr(146) => "'",
-			chr(180) => "'",
-			chr(147) => '&#8220;',
-			chr(148) => '&#8221;',
-			chr(150) => '-',
-			chr(151) => '-',
-			chr(133) => '...'
-		);
-		$trans['utf-8'] = array(
-			chr(194).chr(146) => "'",
-			chr(194).chr(180) => "'",
-			chr(194).chr(147) => '&#8220;',
-			chr(194).chr(148) => '&#8221;',
-			chr(194).chr(150) => '-',
-			chr(194).chr(151) => '-',
-			chr(194).chr(133) => '...'
-		);
-	}
-	$charset = lire_meta('charset');
-	if (!$trans[$charset]) return $texte;
-	return strtr($texte, $trans[$charset]);
-}
 
 // Transformer les sauts de paragraphe en simples passages a la ligne
 function PtoBR($texte){
@@ -275,15 +292,14 @@
 }
 
 // |choixsivide{vide,pasvide} affiche pasvide si la chaine n'est pas vide...
-
-function choixsivide($a, $vide, $pasvide)
-{
-  spip_log("choix '$a'" . $a ? $pasvide : $vide);
-  return $a ? $pasvide : $vide;
+function choixsivide($a, $vide, $pasvide) {
+	return $a ? $pasvide : $vide;
 }
 
 // |choixsiegal{aquoi,oui,non} affiche oui si la chaine est egal a aquoi ...
-function choixsiegal($a1,$a2,$v,$f) {return ($a1 == $a2) ? $v : $f;}
+function choixsiegal($a1,$a2,$v,$f) {
+	return ($a1 == $a2) ? $v : $f;
+}
 
 
 //
@@ -299,10 +315,8 @@
 			$date = $regs[1]."-01-01".$regs[3];
 		else if (ereg("^([12][0-9]{3}[-/][01]?[0-9])([-/]00)?( [-0-9:]+)?$", $date, $regs))
 			$date = ereg_replace("/","-",$regs[1])."-01".$regs[3];
-		else if ($GLOBALS['flag_strtotime']) {
+		else
 			$date = date("Y-m-d H:i:s", strtotime($date));
-		}
-		else $date = ereg_replace('[^-0-9/: ]', '', $date);
 	}
 	return $date;
 }
@@ -379,6 +393,7 @@
 
 function date_relative($date) {
 	
+	if (!$date) return;
 	$decal = date("U") - date("U", strtotime($date));
 	
 	if ($decal < 0) {
@@ -503,9 +518,12 @@
 
 	case 'annee':
 		return $annee;
-	}
 
-	return "<blink>"._T('info_format_non_defini')."</blink>";
+	// Cas d'une vue non definie : retomber sur le format
+	// de date propose par http://www.php.net/date
+	default:
+		return date($vue, strtotime($numdate));
+	}
 }
 
 function nom_jour($numdate) {
@@ -536,8 +554,8 @@
 	return affdate_base($numdate, 'saison');
 }
 
-function affdate($numdate) {
-	return affdate_base($numdate, 'entier');
+function affdate($numdate, $format='entier') {
+	return affdate_base($numdate, $format);
 }
 
 function affdate_court($numdate) {
@@ -615,12 +633,29 @@
 	return gmdate("Y-m-d\TH:i:s\Z", $time);
 }
 
+//
+// Fonctions graphiques
+//
+
 function reduire_image($img, $taille = 120, $taille_y=0) {
 	if (!$img) return;
 	include_ecrire('inc_logos.php3');
 	return reduire_image_logo($img, $taille, $taille_y);
 }
 
+function largeur($img) {
+	if (!$img) return;
+	include_ecrire('inc_logos.php3');
+	list ($h,$l) = taille_image($img);
+	return $l;
+}
+function hauteur($img) {
+	if (!$img) return;
+	include_ecrire('inc_logos.php3');
+	list ($h,$l) = taille_image($img);
+	return $h;
+}
+
 //
 // Recuperation de donnees dans le champ extra
 // Ce filtre n'a de sens qu'avec la balise #EXTRA
@@ -739,6 +774,38 @@
 	return $texte;
 }
 
+// Raccourci ancre [#ancre<-]
+function avant_propre_ancres($texte) {
+	$regexp = "|\[#?([^][]*)<-\]|";
+	if (preg_match_all($regexp, $texte, $matches, PREG_SET_ORDER))
+	foreach ($matches as $regs)
+		$texte = str_replace($regs[0],
+		'<a name="'.entites_html($regs[1]).'"></a>', $texte);
+	return $texte;
+}
+
+// Raccourci typographique <sc></sc>
+function avant_typo_smallcaps($texte) {
+	$texte = str_replace("<sc>", "<span style=\"font-variant: small-caps\">", $texte);
+	$texte = str_replace("</sc>", "</span>", $texte);
+	
+	return $texte;
+}
+
+//
+// Ce filtre retourne la donnee si c'est la premiere fois qu'il la voit ;
+// possibilite de gerer differentes "familles" de donnees |unique{famille}
+# ameliorations possibles :
+# 1) si la donnee est grosse, mettre son md5 comme cle
+# 2) purger $mem quand on change de squelette (sinon bug inclusions)
+//
+// http://www.spip.net/@unique
+function unique($donnee, $famille='') {
+	static $mem;
+	if (!($mem[$famille][$donnee]++))
+		return $donnee;
+}
+
 
 function extraire_attribut($balise, $attribut) {
 # la mise en facteur ne marche pas....
@@ -751,6 +818,7 @@
 }
 
 // fabrique un bouton de type $t de Name $n, de Value $v et autres attributs $a
+# a placer ailleurs que dans inc_filtres
 function boutonne($t, $n, $v, $a='') {
   return "\n<input type='$t'" .
     (!$n ? '' : " name='$n'") .
@@ -777,6 +845,16 @@
 		default:
 			return '';
 	}
+}
+function calendrier($date='', $type='mois', $echelle='', $partie_cal='', $script='')
+{
+   include_ecrire("inc_calendrier.php");
+   include_ecrire("inc_layer.php3");
+   if (!isset($GLOBALS['spip_ecran'])) $GLOBALS['spip_ecran'] = 'large';
+   return
+     $GLOBALS['browser_layer'] .
+     http_script('',_DIR_RESTREINT . 'presentation.js') .
+     http_calendrier_init($date, $type, $echelle, $partie_cal, $script);
 }
 
 ?>

Index: inc_index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_index.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_index.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_index.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -224,7 +224,7 @@
 			if (lire_meta("visiter_sites") == "oui") {
 				include_ecrire ("inc_sites.php3");
 				spip_log ("indexation contenu syndic ".$row['url_site']);
-				indexer_chaine(supprimer_tags(substr(recuperer_page($row['url_site']), 0, 50000)), 1);
+				indexer_chaine(supprimer_tags(substr(recuperer_page($row['url_site'], true), 0, 50000)), 1);
 			}
 		}
 		break;

Index: inc_debug_sql.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_debug_sql.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_debug_sql.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_debug_sql.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -16,6 +16,30 @@
 if (defined("_INC_DEBUG_SQL")) return;
 define("_INC_DEBUG_SQL", "1");
 
+function afficher_debug_contexte($env) {
+	static $n;
+	$n++;
+
+	if (is_array($env_tab = @unserialize($env)))
+		$env = $env_tab;
+
+	$env_texte="";
+	if (count($env)>0) {
+		$env_texte="<div class='spip-env'>"
+			. "<fieldset><legend>#ENV</legend>\n"
+			. "<div><table>\n";
+		foreach ($env as $nom => $valeur) {
+			$env_texte .= "<tr><td><strong>".nl2br(entites_html($nom))
+				. "</strong></td>";
+			$env_texte .= "<td>:&nbsp;".nl2br(entites_html($valeur))
+				. "</td></tr>\n";
+		}
+		$env_texte .= "\n</table></div>\n";
+		$env_texte .= "</fieldset></div>\n";
+	}
+	return $env_texte;
+}
+
 // Si le code php produit des erreurs, on les affiche en surimpression
 // sauf pour un visiteur non admin (lui ne voit rien de special)
 // ajouter &var_mode=debug pour voir les erreurs et en parler sur spip at rezo.net
@@ -28,6 +52,7 @@
 	}
 	return "<div id='spip-debug' style='"
 	. "position: absolute; top: 20px; left: 20px; z-index: 1000;"
+	. "filter:alpha(opacity=60); -moz-opacity:0.6; opacity: 0.6;"
 	. "'><ul><li>"
 	. _T('zbug_erreur_squelette')
 ## aide locale courte a ecrire, avec lien vers une grosse page de documentation
@@ -147,6 +172,11 @@
 	global $debug_objets;
 	$debug_objets['squelettes'][$nom] = $squelette;
 	$debug_objets['sourcefile'][$nom] = $sourcefile;
+
+	if (is_array($GLOBALS['contexte_inclus']))
+		$debug_objets['contexte'][$nom] = $GLOBALS['contexte_inclus'];
+	else
+		$debug_objets['contexte'][$nom] = $GLOBALS['contexte'];
 }
 
 // appelee a chaque analyse syntaxique de squelette (inc-parser)
@@ -177,18 +207,24 @@
 // - ca fait 2 headers !
 	ob_end_clean();
 
+	@header('Content-Type: text/html; charset='.lire_meta('charset'));
+
 	echo debut_entete('Spip ' . _T('admin_debug')), 
 	  "<link rel='stylesheet' href='spip_admin.css' type='text/css' />",
-	  "</head>\n<body>",
-	  "<div id='spip-debug' style='position: absolute; top: 20px; z-index: 1000;'><ul>\n"; 
+	  "</head>\n<body style='margin:0 10px;'>",
+	  "<div id='spip-debug' style='position: absolute; top: 22px; z-index: 1000;height:97%;left:10px;right:10px;'><div id='spip-boucles'>\n"; 
 
 	foreach ($debug_objets['sourcefile'] as $nom_skel => $sourcefile) {
-		echo "<li><b>",$sourcefile,"</b>";
-		echo " <a href='",$self, "&var_mode_objet=$nom_skel&var_mode_affiche=resultat'>"._T('zbug_resultat')."</a>";
-		echo " <a href='", $self, "&var_mode_objet=$nom_skel&var_mode_affiche=code'>"._T('zbug_code')."</a>";
+		echo "<fieldset><legend>",$sourcefile,"&nbsp;: ";
+		echo " <a href='",$self, "&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=resultat'>"._T('zbug_resultat')."</a>";
+		echo " <a href='", $self, "&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=code'>"._T('zbug_code')."</a></legend>";
+
+		if (is_array($contexte = $debug_objets['contexte'][$nom_skel]))
+			echo afficher_debug_contexte($contexte);
+
 		echo "<table width='100%'>\n";
 		$i = 0;
-		$colors = array('#c0c0c0', '#c0cad4');
+		$colors = array('#e0e0f0', '#f8f8ff');
 		if (is_array($debug_objets['pretty']))
 		foreach ($debug_objets['pretty'] as $nom => $pretty)
 			if (substr($nom, 0, strlen($nom_skel)) == $nom_skel) {
@@ -196,18 +232,18 @@
 				$aff = "&lt;".$pretty."&gt;";
 				if ($var_mode_objet == $nom)
 					$aff = "<b>$aff</b>";
-				echo "<tr bgcolor='" . $colors[$i%2] . "'><td  align='right'>$i</td><td><a href='",$self,"&var_mode_objet=$nom&var_mode_affiche=boucle' class='debug_link_boucle'>"._T('zbug_boucle')."</a></td><td><a href='",$self, "&var_mode_objet=$nom&var_mode_affiche=resultat' class='debug_link_resultat'>"._T('zbug_resultat')."</a></td><td><a href='", $self, "&var_mode_objet=$nom&var_mode_affiche=code' class='debug_link_code'>"._T('zbug_code')."</a></td><td>$aff</td></tr>";
+				echo "<tr bgcolor='" . $colors[$i%2] . "'><td  align='right'>$i</td><td><a href='",$self,"&amp;var_mode_objet=$nom&amp;var_mode_affiche=boucle' class='debug_link_boucle'>"._T('zbug_boucle')."</a></td><td><a href='",$self, "&amp;var_mode_objet=$nom&amp;var_mode_affiche=resultat' class='debug_link_resultat'>"._T('zbug_resultat')."</a></td><td><a href='", $self, "&amp;var_mode_objet=$nom&amp;var_mode_affiche=code' class='debug_link_code'>"._T('zbug_code')."</a></td><td>$aff</td></tr>";
 			}
-		echo "</table>\n</li>\n";
+		echo "</table>\n</fieldset>\n";
 	}
-	echo "</ul>\n";
+	echo "</div>\n";
 	if ($var_mode_objet && ($res = $debug_objets[$var_mode_affiche][$var_mode_objet])) {
 	  if ($var_mode_affiche == 'resultat') {
 		echo "<div id=\"debug_boucle\"><fieldset><legend>",$debug_objets['pretty'][$var_mode_objet],"</legend>";
 		highlight_string($debug_objets['requete'][$var_mode_objet]);
 #		echo "<p class='spip-admin-bloc'>les premiers appels &agrave; cette boucle ont donn&eacute;&nbsp;:</p>";
 		foreach ($res as $view) 
-			if ($res) echo "<br><fieldset>",interdire_scripts($view),"</fieldset>";
+			if ($res) echo "<br /><fieldset>",interdire_scripts($view),"</fieldset>";
 		echo "</fieldset></div>";
 
       } else if ($var_mode_affiche == 'code') {

Index: inc_suivi_revisions.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_suivi_revisions.php,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_suivi_revisions.php	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_suivi_revisions.php	29 Mar 2005 15:27:12 -0000	1.4
@@ -18,9 +18,6 @@
 
 include_ecrire("inc_lab.php");
 include_spip("ecrire.php");
-include_spip("revisions.php");
-include_spip("diff.php");
-
 
 function afficher_para_modifies ($texte, $court = false) {
 	// Limiter la taille de l'affichage
@@ -29,7 +26,7 @@
 	
 	$paras = explode ("\n",$texte);
 	for ($i = 0; $i < count($paras) AND strlen($texte_ret) < $max; $i++) {
-		if (ereg("diff-", $paras[$i])) $texte_ret .= $paras[$i]."\n\n";
+		if (strpos($paras[$i], '"diff-')) $texte_ret .= $paras[$i]."\n\n";
 	}
 	$texte = $texte_ret;
 	return $texte;
@@ -81,7 +78,7 @@
 			echo "</div>";
 		}
 	
-		while ($row = mysql_fetch_array($result)) {
+		while ($row = spip_fetch_array($result)) {
 			$id_version = $row['id_version'];
 			$id_auteur = $row['id_auteur'];
 			$date = date_relative($row['date']);
@@ -95,7 +92,7 @@
 				WHERE id_auteur = $id_auteur";
 			$result_auteur = spip_query($query_auteur);
 			if ($row_auteur = spip_fetch_array($result_auteur)) {
-				$nom = propre($row_auteur["nom"]);
+				$nom = typo($row_auteur["nom"]);
 				if (strlen($nom) > 0) $nom = "($nom)";
 			}
 	
@@ -105,7 +102,7 @@
 			echo "<div class='tr_liste' style='padding: 5px; border-top: 1px solid #aaaaaa;'>";
 	
 			echo "<span class='arial2'>";
-			if (!$court) echo bouton_block_invisible("$id_version-$id_article-$id_auteur");
+			if (!$court) echo bouton_block_visible("$id_version-$id_article-$id_auteur");
 			echo "<img src='" . _DIR_IMG_PACK . "$logo_statut' border='0'>&nbsp;";
 			echo "<a class='$statut' style='font-weight: bold;' href='articles_versions.php3?id_article=$id_article'>$titre</a>";
 			echo "</span>";
@@ -120,7 +117,7 @@
 					WHERE id_article=$id_article AND id_version<$id_version 
 					ORDER BY id_version DESC LIMIT 0,1";
 					if ($result_diff = spip_query($query_diff)) {
-						$row_diff = mysql_fetch_array($result_diff);
+						$row_diff = spip_fetch_array($result_diff);
 						$id_diff = $row_diff['id_version'];
 				}
 		
@@ -160,18 +157,22 @@
 					}		
 					$textes = array();			
 					foreach ($champs as $champ) {
-						if (!$new[$champ] && !$old[$champ]) continue;			
+						if (!$new[$champ] && !$old[$champ]) continue;
 						$diff = new Diff(new DiffTexte);
 						$textes[$champ] = afficher_para_modifies(afficher_diff($diff->comparer(preparer_diff($new[$champ]), preparer_diff($old[$champ]))), $court);
 					}
-				}	
+				}
 				
-				echo debut_block_invisible("$id_version-$id_article-$id_auteur");
+				echo debut_block_visible("$id_version-$id_article-$id_auteur");
 				if (is_array($textes))
 				foreach ($textes as $var => $t) {
 					if (strlen($t) > 0) {
-						echo "<blockquote class='spip serif1'>";
-						echo propre($t)."";
+						echo "<blockquote class='serif1'>";
+						echo propre_diff($t);
+						if ($GLOBALS['les_notes']) {
+							echo '<p>'.$GLOBALS['les_notes'];
+							$GLOBALS['les_notes'] = '';
+						}
 						echo "</blockquote>";
 					}		
 				}		

Index: carte_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/carte_edit.php3,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- carte_edit.php3	4 Mar 2005 12:04:15 -0000	1.7
+++ carte_edit.php3	29 Mar 2005 15:27:12 -0000	1.8
@@ -152,6 +152,9 @@
 if ($url_carte && ($new!="oui")) icone_horizontale( _T('previsualiser'), "../carto.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
 if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec logos'), "../carto_logo.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
 if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec liens'), "../carto_lien.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
+if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec svg'), "../carto_svg.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
+//if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec svg'), "../carto_svg2.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
+if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec geosvg'), "../carto_geosvg.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
 
 echo "</div>\n";
 
@@ -193,6 +196,7 @@
 	}
 	
 	if ($url_carte!="") {
+		
 		echo "<br />";
 		debut_cadre_relief();
 		
@@ -203,7 +207,7 @@
 		echo "</div>\n";
 		
 		echo debut_block_visible("dhtml_carte");
-		
+				
 		//echo "<div style='margin: 10px; padding: 10px; border: 1px dashed $couleur_foncee;'>";
 		
 		//remplacer id par appel ? spip_carte
@@ -212,7 +216,12 @@
 		//else $leurl_carte=$url_carte;
 		$lurl_carte="../spip_carto.php?fond_carte=".urlencode($url_carte);
 		$tabcallage=worldfile2array($callage);
-		echo afficher_carte_interface($id_carte,$retour,$lurl_carte,$tabcallage);
+   	
+   		echo afficher_carte_interface($id_carte,$retour,$lurl_carte,$tabcallage);
+		
+		//$lurl_carte="../carto_svgfile".$id_carte.".svg";
+		//echo afficher_carte_interface($id_carte,$retour,$lurl_carte,$tabcallage);
+		//echo afficher_interface($id_carte,$retour,$tabcallage);
 		
 		echo fin_block();
 		echo "</div>\n";

Index: config-lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-lang.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- config-lang.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ config-lang.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -55,7 +55,7 @@
 
 debut_cadre_couleur("langues-24.gif", false, "", _T('info_langue_principale'));
 
-$langues_prop = split(",",lire_meta("langues_proposees"));
+$langues_prop = split(",",$all_langs);
 $langue_site = lire_meta('langue_site');
 
 echo _T('texte_selection_langue_principale');

Index: inc_import.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_import.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_import.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_import.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -349,10 +349,13 @@
 
 function import_all($f, $gz=false) {
 	global $import_ok;
-	global $meta;
 	global $auth_htaccess;
 	global $connect_id_auteur;
 	$_fseek = ($gz) ? gzseek : fseek;
+
+	// utiliser une version fraiche des metas (ie pas le cache)
+	include_ecrire('inc_meta.php3');
+	lire_metas();
 
 	$my_date = lire_meta_maj("debut_restauration");
 	if (!$my_date) return false;

Index: inc_lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_lang.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_lang.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_lang.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -201,7 +201,7 @@
 	'cpf_dom' => "Krey&ograve;l",
 	'cpf_hat' => "Krey&ograve;l ayisyen",
 	'cs' => "&#269;e&#353;tina",
-	'cy' => "Welsh",
+	'cy' => "Cymraeg",	# welsh, gallois
 	'da' => "dansk",
 	'de' => "Deutsch",
 	'dz' => "Bhutani",
@@ -214,7 +214,7 @@
 	'et' => "eesti",
 	'eu' => "euskara",
 	'fa' => "&#1601;&#1575;&#1585;&#1587;&#1609;",
-	'ff' => "Fulah", /* Peul */
+	'ff' => "Fulah", // peul
 	'fi' => "suomi",
 	'fj' => "Fiji",
 	'fo' => "f&#248;royskt",
@@ -337,7 +337,7 @@
 	'wo' => "Wolof",
 	'xh' => "Xhosa",
 	'yi' => "Yiddish",
-	'yor' => "Yoruba",
+	'yo' => "Yoruba",
 	'za' => "Zhuang",
 	'zh' => "&#20013;&#25991;",
 	'zu' => "Zulu");
@@ -551,7 +551,8 @@
 	global $all_langs, $langue_site;
 	global $pile_langues, $lang_typo, $lang_dir;
 
-	$all_langs = lire_meta('langues_proposees');
+	$all_langs = lire_meta('langues_proposees')
+		.lire_meta('langues_proposees2');
 	$langue_site = lire_meta('langue_site');
 	$pile_langues = array();
 	$lang_typo = '';
@@ -579,7 +580,15 @@
 					ecrire_meta('langue_site', $langue_site);
 			}
 			if (defined("_ECRIRE_INC_META")) {
-				ecrire_meta('langues_proposees', $all_langs);
+				# sur spip.net le nombre de langues proposees fait exploser
+				# ce champ limite a 255 caracteres ; a revoir...
+				if (strlen($all_langs) <= 255) {
+					ecrire_meta('langues_proposees', $all_langs);
+					effacer_meta('langues_proposees2');
+				} else {
+					ecrire_meta('langues_proposees', substr($all_langs,0,255));
+					ecrire_meta('langues_proposees2', substr($all_langs,255));
+				}
 				ecrire_metas();
 			}
 		}

Index: forum_envoi.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/forum_envoi.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- forum_envoi.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ forum_envoi.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -16,25 +16,38 @@
 include_ecrire ("inc_forum.php3");
 
 
-if ($modif_forum != "oui") $titre_message = ereg_replace("^([^>])", "> \\1", $titre_message);
-$nom = addslashes(corriger_caracteres($connect_nom));
+if ($modif_forum != "oui")
+	$titre_message = ereg_replace("^([^>])", "> \\1", $titre_message);
+
+$nom = corriger_caracteres($connect_nom);
 $adresse_retour = rawurldecode($adresse_retour);
 
 if ($valider_forum AND ($statut!='')) {
-	$titre_message = addslashes(corriger_caracteres($titre_message));
-	$texte = addslashes(corriger_caracteres($texte));
-	$query = "INSERT 
-		INTO spip_forum (titre, texte, date_heure, nom_site, url_site, statut, id_auteur, auteur, email_auteur, id_rubrique, id_parent, id_article, id_breve, id_message, id_syndic) ".
-		"VALUES (\"$titre_message\", \"$texte\", NOW(), \"$nom_site\", \"$url_site\", \"$statut\", \"$connect_id_auteur\", \"$nom\", '$connect_email', '$id_rubrique', '$id_parent', '$id_article', '$id_breve', '$id_message', '$id_syndic')";
+	$titre_message = corriger_caracteres($titre_message);
+	$texte = corriger_caracteres($texte);
+	$query = "INSERT INTO spip_forum
+	(titre, texte, date_heure, nom_site, url_site, statut, id_auteur,
+	auteur, email_auteur, id_rubrique, id_parent, id_article, id_breve,
+	id_message, id_syndic)
+	VALUES ('".texte_script($titre_message)."',
+	'".texte_script($texte)."', NOW(),
+	'".texte_script($nom_site)."',
+	'".texte_script($url_site)."',
+	'".texte_script($statut)."',
+	$connect_id_auteur,
+	'".texte_script($nom)."',
+	'$connect_email',
+	'$id_rubrique', '$id_parent', '$id_article', '$id_breve',
+	'$id_message', '$id_syndic')";
 	$result = spip_query($query);
 
 	calculer_threads();
 
 	if ($id_message > 0) {
-		$query = "UPDATE spip_auteurs_messages SET vu = 'non' WHERE id_message='$id_message'";
+		$query = "UPDATE spip_auteurs_messages SET vu = 'non'
+			WHERE id_message='$id_message'";
 		$result = spip_query($query);
 	}
-
 	redirige_par_entete($adresse_retour);
 }
 
@@ -155,11 +168,11 @@
 	echo "<B>"._T('info_lien_hypertexte')."</B><BR>";
 	echo _T('texte_lien_hypertexte')."<BR>";
 	echo _T('texte_titre_02')."<BR>";
-	echo "<INPUT TYPE='text' CLASS='forml' NAME='nom_site' VALUE=\"$nom_site\" SIZE='40'><BR>";
+	echo "<INPUT TYPE='text' CLASS='forml' NAME='nom_site' VALUE=\"".entites_html($nom_site)."\" SIZE='40'><BR>";
 
 	$lien_url="http://";
 	echo _T('info_url')."<BR>";
-	echo "<INPUT TYPE='text' CLASS='forml' NAME='url_site' VALUE=\"$url_site\" SIZE='40'><P>";
+	echo "<INPUT TYPE='text' CLASS='forml' NAME='url_site' VALUE=\"".entites_html($url_site)."\" SIZE='40'><P>";
 }
 
 echo "<DIV ALIGN='right'><INPUT CLASS='fondo' TYPE='submit' NAME='Valider' VALUE='"._T('bouton_voir_message')."'></div>";

Index: calendrier.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/calendrier.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- calendrier.php3	25 Feb 2005 16:35:57 -0000	1.3
+++ calendrier.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -10,12 +10,13 @@
  *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
 \***************************************************************************/
 
-
   // ce script peut etre recopie a la racine pour obtenir le calendrier
   // a partir de l'espace public. 
   // Evidemment les messages internes a la redaction seront absents.
 
-include((@is_dir("ecrire") ? 'ecrire/' : '') . "inc_version.php3");
+if (!defined("_ECRIRE_INC_VERSION")) {
+	include((@is_dir("ecrire") ? 'ecrire/' : '') . "inc_version.php3");
+}
 
 if (!_DIR_RESTREINT)
 	include ("inc.php3");
@@ -26,55 +27,7 @@
 	include_ecrire("inc_layer.php3");
  }
 
-$today=getdate(time());
-$jour_today = $today["mday"];
-$mois_today = $today["mon"];
-$annee_today = $today["year"];
-
-// sans arguments => mois courant
-if (!$mois){
-  $jour=$jour_today;
-  $mois=$mois_today;
-  $annee=$annee_today;
- } else {if (!isset($jour)) $jour = 1;}
-
-$date = date("Y-m-d", mktime(0,0,0,$mois, $jour, $annee));
-$jour = journum($date);
-$mois = mois($date);
-$annee = annee($date);
-
-if (!isset($type)) $type = 'mois';
-
 $afficher_bandeau_calendrier = true;
-
-if ($type == 'semaine') {
-	$afficher_bandeau_calendrier_semaine = true;
-
-	$titre = _T('titre_page_calendrier',
-		    array('nom_mois' => nom_mois($date), 'annee' => $annee));
-	  }
-elseif ($type == 'jour') {
-	$titre = nom_jour("$annee-$mois-$jour")." ".
-	  affdate_jourcourt("$annee-$mois-$jour");
-	$jour = $jour_today;
-	$mois = $mois_today;
-	$annee = $annee_today;
- }
- else {
-	$type = 'mois';
-	$jour = '01';
-	$titre = _T('titre_page_calendrier',
-		    array('nom_mois' => nom_mois($annee . '-' . sprintf("%02d", $mois) . '-01'), 
-			  'annee' => $annee));
-	  }
-
-if (!_DIR_RESTREINT) 
-  debut_page($titre,  "redacteurs", "calendrier");
- else debut_html($titre);
-
-$f = 'http_calendrier_init_' . $type;
-echo $f($jour,$mois,$annee, $date, $GLOBALS['PHP_SELF']);
-
-if (!_DIR_RESTREINT) fin_page(); else 	echo "</body></html>\n";
-
+echo http_calendrier_init('', $type);
+if (!_DIR_RESTREINT) fin_page();
 ?>

Index: inc_config.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_config.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_config.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_config.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -20,9 +20,6 @@
 include_ecrire ("inc_admin.php3");
 include_ecrire ("inc_mail.php3");
 
-// Peut-etre a deplacer par la suite
-include_ecrire ("inc_config_plug.php3");
-installer_plugins();
 
 
 //
@@ -181,7 +178,7 @@
 			exit;
 		} else {
 			include_ecrire("inc_sites.php3");
-			$page = recuperer_page($test_proxy);
+			$page = recuperer_page($test_proxy, true);
 			if ($page)
 				echo "<pre>".entites_html($page)."</pre>";
 			else

Index: inc_documents.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_documents.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_documents.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_documents.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -326,16 +326,12 @@
 
 	while ($f = readdir($d)) {
 		if (is_file("$dir/$f") AND is_readable("$dir/$f")
-		AND $f != 'remove.txt') {
+		AND $f != 'remove.txt')
 			$fichiers[] = "$dir/$f";
-		}
 		else
 		if (is_dir("$dir/$f") AND is_readable("$dir/$f")
-		AND $f != '.' AND $f != '..') {
-			$fichiers_dir = fichiers_upload("$dir/$f");
-			while (list(,$f2) = each ($fichiers_dir))
-				$fichiers[] = $f2;
-		}
+		AND $f != '.' AND $f != '..')
+			$fichiers = array_merge($fichiers, fichiers_upload("$dir/$f"));
 
 	}
 	closedir($d);
@@ -353,7 +349,7 @@
 	$fichiers = fichiers_upload($dir);
 	$exts = array();
 
-	while (list(, $f) = each($fichiers)) {
+	foreach ($fichiers as $f) {
 		$f = ereg_replace("^$dir/","",$f);
 		if (ereg("\.([^.]+)$", $f, $match)) {
 			$ext = strtolower($match[1]);
@@ -366,11 +362,12 @@
 			}
 			
 			$ledossier = substr($f, 0, strrpos($f,"/"));
-			if (strlen($ledossier) > 0) $ledossier = "$ledossier";
 			$lefichier = substr($f, strrpos($f, "/"), strlen($f));
 			
 			if ($ledossier != $ledossier_prec) {
-				$texte_upload .= "\n<option value=\"$ledossier\" style='font-weight: bold;'>Tout le dossier $ledossier</option>";
+				$texte_upload .= "\n<option value=\"$ledossier\" style='font-weight: bold;'>"
+				._T('tout_dossier_upload', array('upload' => $ledossier))
+				."</option>";
 			}
 			
 			$ledossier_prec = $ledossier;
@@ -379,6 +376,12 @@
 		}
 	}
 
+	if ($texte_upload) {
+		$texte_upload = "\n<option value=\"/\" style='font-weight: bold;'>"
+				._T('info_installer_tous_documents')
+				."</option>" . $texte_upload;
+	}
+
 	return $texte_upload;
 }
 
@@ -392,7 +395,7 @@
 	$h = $taille[1];
 	$hash = calculer_action_auteur ("reduire $w $h");
 	
-	$image = "<img src='../spip_image_reduite.php3?img=$fichier_vignette&taille_x=$w&taille_y=$h&hash=$hash&hash_id_auteur=$connect_id_auteur' width='$w' height='$h' />";
+	$image = "<img src='../spip_image_reduite.php3?img=$fichier_vignette&taille_x=$w&taille_y=$h&hash=$hash&hash_id_auteur=$connect_id_auteur' width='$w' height='$h' style='border-width: 0px' />";
 	
 
 # Ca ne marche pas toujours car fichier_vignette peut etre n'importe quoi
@@ -405,6 +408,30 @@
 }		
 
 
+// Bloc d'edition de la taille du doc (pour embed)
+function afficher_formulaire_taille($document, $type_inclus='AUTO') {
+
+	// (on ne le propose pas pour les images qu'on sait
+	// lire, id_type<=3)
+	if ($document['id_type'] <= 3)
+		return '';
+
+	// Si on n'a pas le type_inclus, on va le chercher dans spip_types_documents
+	if ($type_inclus == 'AUTO'
+	AND $r = spip_query("SELECT * FROM spip_types_documents
+	WHERE id_type=".$document['id_type'])
+	AND $type = @spip_fetch_array($r))
+			$type_inclus = $type['inclus'];
+
+	if (($type_inclus == "embed"
+	OR $type_inclus == "image")) {
+		echo "<br /><b>"._T('entree_dimensions')."</b><br />\n";
+		echo "<input type='text' name='largeur_document' class='fondl' style='font-size:9px;' value=\"".$document['largeur']."\" size='5'>";
+		echo " &#215; <input type='text' name='hauteur_document' class='fondl' style='font-size:9px;' value=\"".$document['hauteur']."\" size='5'> "._T('info_pixels');
+	}
+}
+
+
 //
 // Afficher un formulaire d'upload
 //
@@ -519,8 +546,8 @@
 		if ($case == 0) {
 			echo "<tr style='border-top: 1px solid black;'>";
 		}
-		$style = "border-left: 1px solid $couleur; border-bottom: 1px solid $couleur;";
-		if ($case == $bord_droit) $style .= " border-right: 1px solid $couleur;";
+		$style = "border-$spip_lang_left: 1px solid $couleur; border-bottom: 1px solid $couleur;";
+		if ($case == $bord_droit) $style .= " border-$spip_lang_right: 1px solid $couleur;";
 		echo "<td width='33%' style='text-align: $spip_lang_left; $style' valign='top'>";
 
 			// bloc vignette + rotation
@@ -685,6 +712,10 @@
 					echo "<textarea name='descriptif_document' rows='4' class='forml' style='font-size:10px;' cols='*' wrap='soft' onFocus=\"changeVisible(true, 'valider_doc$id_document', 'block', 'block');\">";
 					echo entites_html($descriptif);
 					echo "</textarea>\n";
+
+					if ($options == "avancees")
+						afficher_formulaire_taille($document);
+
 				} else {
 					echo "<input type='hidden' name='descriptif_document' value=\"".entites_html($descriptif)."\" />\n";
 				}
@@ -731,7 +762,7 @@
 
 		// fermer la derniere ligne
 		if ($case > 0) {
-			echo "<td style='border-left: 1px solid $couleur;'>&nbsp;</td>";
+			echo "<td style='border-$spip_lang_left: 1px solid $couleur;'>&nbsp;</td>";
 			echo "</tr>";
 		}
 
@@ -876,7 +907,7 @@
 		echo "<p>&nbsp;</p>";
 
 		echo "<div align='right'>";
-		echo "<table width='50%' cellpadding=0 cellspacing=0 border=0><tr><td style='text-align:left;'>";
+		echo "<table width='50%' cellpadding=0 cellspacing=0 border=0><tr><td style='text-align: $spip_lang_left;'>";
 		
 		echo debut_cadre_relief("image-24.gif", false, "", _T('titre_joindre_document'));
 		
@@ -1156,15 +1187,8 @@
 			echo "</textarea>\n";
 		}
 
-		// Bloc d'edition de la taille du doc (pour embed)
-		// (on ne le propose pas pour les images qu'on sait lire, id_type<=3
-		if (($type_inclus == "embed" OR $type_inclus == "image")
-		AND $options == "avancees"
-		AND $id_type > 3) {
-			echo "<br /><b>"._T('entree_dimensions')."</b><br />\n";
-			echo "<input type='text' name='largeur_document' class='fondl' style='font-size:9px;' value=\"$largeur\" size='5'>";
-			echo " &#215; <input type='text' name='hauteur_document' class='fondl' style='font-size:9px;' value=\"$hauteur\" size='5'> "._T('info_pixels');
-		}
+		if ($options == "avancees")
+			afficher_formulaire_taille($document, $type_inclus);
 
 		echo "<div align='".$GLOBALS['spip_lang_right']."'>";
 		echo "<input TYPE='submit' class='fondo' style='font-size:9px;' NAME='Valider' VALUE='"._T('bouton_valider')."'>";

Index: inc_texte.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_texte.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_texte.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_texte.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -54,15 +54,6 @@
 
 
 //
-// Trouver une locale qui marche
-//
-$lang2 = strtoupper($GLOBALS['spip_lang']);
-setlocale(LC_CTYPE, $GLOBALS['spip_lang']) ||
-setlocale(LC_CTYPE, $lang2.'_'.$GLOBALS['spip_lang']) ||
-setlocale(LC_CTYPE, $GLOBALS['spip_lang'].'_'.$lang2);
-
-
-//
 // Diverses fonctions essentielles
 //
 
@@ -76,17 +67,30 @@
 
 // points d'entree de pre- et post-traitement pour propre() et typo()
 function spip_avant_propre ($letexte) {
+	$letexte = avant_propre_ancres($letexte);
 	$letexte = extraire_multi($letexte);
-	return appliquer_fonction ("avant_propre", $letexte);
+
+	if (function_exists('avant_propre'))
+		$letexte = avant_propre($letexte);
+
+	return $letexte;
 }
 
 function spip_apres_propre ($letexte) {
-	return appliquer_fonction ("apres_propre", $letexte);
+	if (function_exists('apres_propre'))
+		$letexte = apres_propre($letexte);
+
+	return $letexte;
 }
 
 function spip_avant_typo ($letexte) {
 	$letexte = extraire_multi($letexte);
-	return appliquer_fonction ("avant_typo", $letexte);
+	$letexte = avant_typo_smallcaps($letexte);
+
+	if (function_exists('avant_typo'))
+		$letexte = avant_typo($letexte);
+
+	return $letexte;
 }
 
 function spip_apres_typo ($letexte) {
@@ -99,7 +103,10 @@
 	if (!_DIR_RESTREINT AND $GLOBALS['revision_nbsp'])
 		$letexte = ereg_replace('&nbsp;', '<span class="spip-nbsp">&nbsp;</span>', $letexte);
 
-	return appliquer_fonction ("apres_typo", $letexte);
+	if (function_exists('apres_typo'))
+		$letexte = apres_typo($letexte);
+
+	return $letexte;
 }
 
 
@@ -248,7 +255,7 @@
 }
 
 # il y a 3 couples de fonctions homonymes au prefixe _doublons pres
-# pour ?viter ? tous les appels de se trimbaler ce qui concerne les squelettes
+# pour eviter a tous les appels de se trimbaler ce qui concerne les squelettes
 
 function echappe_retour_doublon($letexte, $les_echap, $source, &$doublons)
 {
@@ -261,6 +268,37 @@
   return echappe_retour($letexte, $les_echap, $source);
 }
 
+//
+// Gerer les outils mb_string
+//
+function spip_substr($c, $start=0, $end='') {
+	include_ecrire('inc_charsets.php3');
+	if (init_mb_string()) {
+		if ($end)
+			return mb_substr($c, $start, $end);
+		else
+			return mb_substr($c, $start);
+	}
+
+	// methode substr normale
+	else {
+		if ($end)
+			return substr($c, $start, $end);
+		else
+			return substr($c, $start);
+	}
+}
+
+function spip_strlen($c) {
+	include_ecrire('inc_charsets.php3');
+	if (init_mb_string())
+		return mb_strlen($c);
+	else
+		return strlen($c);
+}
+// fin mb_string
+
+
 function couper($texte, $taille=50) {
 	$texte = substr($texte, 0, 400 + 2*$taille); /* eviter de travailler sur 10ko pour extraire 150 caracteres */
 
@@ -297,17 +335,17 @@
 	$texte = ereg_replace("(^|\r)\|.*\|\r", "\r", $texte);
 
 	// couper au mot precedent
-	$long = substr($texte, 0, max($taille-4,1));
+	$long = spip_substr($texte, 0, max($taille-4,1));
 	$court = ereg_replace("([^[:space:]][[:space:]]+)[^[:space:]]*\n?$", "\\1", $long);
 	$points = '&nbsp;(...)';
 
 	// trop court ? ne pas faire de (...)
-	if (strlen($court) < max(0.75 * $taille,2)) {
+	if (spip_strlen($court) < max(0.75 * $taille,2)) {
 		$points = '';
-		$long = ereg_replace("&#?[a-z0-9]*;?$", "", substr($texte, 0, $taille));
+		$long = spip_substr($texte, 0, $taille);
 		$texte = ereg_replace("([^[:space:]][[:space:]]+)[^[:space:]]*$", "\\1", $long);
 		// encore trop court ? couper au caractere
-		if (strlen($texte) < 0.75 * $taille)
+		if (spip_strlen($texte) < 0.75 * $taille)
 			$texte = $long;
 	} else
 		$texte = $court;
@@ -318,6 +356,9 @@
 	// remettre les paragraphes
 	$texte = ereg_replace("\r+", "\n\n", $texte);
 
+	// supprimer l'eventuelle entite finale mal coupee
+	$texte = preg_replace('/&#?[a-z0-9]*$/', '', $texte);
+
 	return trim($texte).$points;
 }
 
@@ -485,7 +526,6 @@
 // de la regexp ci-dessous, et elle retourne le texte a inserer a la place
 // et le lien "brut" a usage eventuel de redirection...
 function extraire_lien ($regs) {
-
 	$lien_texte = $regs[1];
 
 	$lien_url = entites_html(trim($regs[3]));
@@ -698,9 +738,6 @@
 
 	// Appeler la fonction de pre_traitement
 	$letexte = spip_avant_propre ($letexte);
-	// Appeler les fonctions complementaires
-	$letexte = appliquer_fonction_avant("propre", $letexte);
-
 
 	// Puce
 	if (!$lang_dir) {
@@ -919,9 +956,6 @@
 	$letexte = ereg_replace('(<p class="spip">)?[[:space:]]*<ul', "<ul", $letexte);
 	$letexte = ereg_replace('</ul>[[:space:]]*(</p>)?', '</ul>', $letexte);
 
-	// Appeler les fonctions complementaires
-	$letexte = appliquer_fonction_apres("propre", $letexte);
-
 	// Appeler la fonction de post-traitement
 	$letexte = spip_apres_propre ($letexte);
 
@@ -931,7 +965,7 @@
 function traiter_les_notes($mes_notes, $les_echap) {
 	list($mes_notes,) = traiter_raccourcis_generale($mes_notes);
 	if (ereg('<p class="spip">',$mes_notes))
-		$mes_notes = ereg_replace('<p class="spip">', '<p class="spip_note">', $mes_notes);
+		$mes_notes = str_replace('<p class="spip">', '<p class="spip_note">', $mes_notes);
 	else
 		$mes_notes = '<p class="spip_note">'.$mes_notes."</p>\n";
 	$mes_notes = echappe_retour($mes_notes, $les_echap, "SOURCEPROPRE");

Index: inc_base.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_base.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_base.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_base.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -19,6 +19,7 @@
 include_ecrire("inc_acces.php3");
 include_ecrire("inc_serialbase.php3");
 include_ecrire("inc_auxbase.php3");
+include_ecrire("inc_typebase.php3");
 include_ecrire("inc_majbase.php3");
 
 // Fonction de creation d'une table SQL nommee $nom
@@ -53,9 +54,8 @@
 }
 
 
-
 function creer_base() {
-	global $tables_principales, $tables_auxiliaires;
+  global $tables_principales, $tables_auxiliaires, $tables_images, $tables_sequences, $tables_documents, $tables_mime;
 
 	// ne pas revenir plusieurs fois (si, au contraire, il faut pouvoir
 	// le faire car certaines mises a jour le demandent explicitement)
@@ -64,76 +64,26 @@
 
 	foreach($tables_principales as $k => $v)
 		spip_create_table($k, $v['field'], $v['key'], true);
+
 	foreach($tables_auxiliaires as $k => $v)
 		spip_create_table($k, $v['field'], $v['key'], false);
 
-	// Images reconnues par PHP
-	$query = "INSERT IGNORE spip_types_documents (id_type, extension, titre, inclus) VALUES ".
-		"(1, 'jpg', 'JPEG', 'image'), ".
-		"(2, 'png', 'PNG', 'image'), ".
-		"(3, 'gif', 'GIF', 'image')";
-	spip_query_db($query);
+	foreach($tables_images as $k => $v)
+		spip_query_db("INSERT IGNORE spip_types_documents (extension, inclus, titre, id_type) VALUES ('$k', 'image', '" .
+			      (is_numeric($v) ?
+			       (strtoupper($k) . "', $v") :
+			       "$v', 0") .
+			      ")");
 
-	// Autres images (peuvent utiliser le tag <img>)
-	$query = "INSERT IGNORE spip_types_documents (extension, titre, inclus) VALUES ".
-		"('bmp', 'BMP', 'image'), ".
-		"('psd', 'Photoshop', 'image'), ".
-		"('tif', 'TIFF', 'image')";
-	spip_query_db($query);
+	foreach($tables_sequences as $k => $v)
+		spip_query_db("INSERT IGNORE spip_types_documents (extension, titre, inclus) VALUES ('$k', '$v', 'embed')");
 
-	// Multimedia (peuvent utiliser le tag <embed>)
-	$query = "INSERT IGNORE spip_types_documents (extension, titre, inclus) VALUES ".
-		"('aiff', 'AIFF', 'embed'), ".
-		"('asf', 'Windows Media', 'embed'), ".
-		"('avi', 'Windows Media', 'embed'), ".
-		"('mid', 'Midi', 'embed'), ".
-		"('mng', 'MNG', 'embed'), ".
-		"('mov', 'QuickTime', 'embed'), ".
-		"('mp3', 'MP3', 'embed'), ".
-		"('mpg', 'MPEG', 'embed'), ".
-		"('ogg', 'Ogg', 'embed'), ".
-		"('qt', 'QuickTime', 'embed'), ".
-		"('ra', 'RealAudio', 'embed'), ".
-		"('ram', 'RealAudio', 'embed'), ".
-		"('rm', 'RealAudio', 'embed'), ".
-		"('swf', 'Flash', 'embed'), ".
-		"('wav', 'WAV', 'embed'), ".
-		"('wmv', 'Windows Media', 'embed')";
-	spip_query_db($query);
+	foreach($tables_documents as $k => $v)
+		spip_query_db("INSERT IGNORE spip_types_documents (extension, titre, inclus) VALUES ('$k', '$v', 'non')");
 
-	// Documents varies
-	$query = "INSERT IGNORE spip_types_documents (extension, titre, inclus) VALUES ".
-		"('ai', 'Adobe Illustrator', 'non'), ".
-		"('bz2', 'BZip', 'non'), ".
-		"('c', 'C source', 'non'), ".
-		"('deb', 'Debian', 'non'), ".
-		"('doc', 'Word', 'non'), ".
-		"('djvu', 'DjVu', 'non'), ".
-		"('dvi', 'LaTeX DVI', 'non'), ".
-		"('eps', 'PostScript', 'non'), ".
-		"('gz', 'GZ', 'non'), ".
-		"('h', 'C header', 'non'), ".
-		"('html', 'HTML', 'non'), ".
-		"('pas', 'Pascal', 'non'), ".
-		"('pdf', 'PDF', 'non'), ".
-		"('ppt', 'PowerPoint', 'non'), ".
-		"('ps', 'PostScript', 'non'), ".
-		"('rpm', 'RedHat/Mandrake/SuSE', 'non'), ".
-		"('rtf', 'RTF', 'non'), ".
-		"('sdd', 'StarOffice', 'non'), ".
-		"('sdw', 'StarOffice', 'non'), ".
-		"('sit', 'Stuffit', 'non'), ".
-		"('sxc', 'OpenOffice Calc', 'non'), ".
-		"('sxi', 'OpenOffice Impress', 'non'), ".
-		"('sxw', 'OpenOffice', 'non'), ".
-		"('tex', 'LaTeX', 'non'), ".
-		"('tgz', 'TGZ', 'non'), ".
-		"('txt', 'texte', 'non'), ".
-		"('xcf', 'GIMP multi-layer', 'non'), ".
-		"('xls', 'Excel', 'non'), ".
-		"('xml', 'XML', 'non'), ".
-		"('zip', 'Zip', 'non')";
-	spip_query_db($query);
+	foreach ($tables_mime as $extension => $type_mime)
+	  spip_query_db("UPDATE spip_types_documents
+		SET mime_type='$type_mime' WHERE extension='$extension'");
 }
 
 function stripslashes_base($table, $champs) {

Index: inc_presentation.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_presentation.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc_presentation.php3	4 Mar 2005 10:45:44 -0000	1.4
+++ inc_presentation.php3	29 Mar 2005 15:27:12 -0000	1.5
@@ -28,13 +28,16 @@
 
 	if (!$aide OR $spip_display == 4) return;
 
-	return "&nbsp;&nbsp;<a class='aide' href=\"". _DIR_RESTREINT .
-	  "aide_index.php3?aide=$aide&amp;var_lang=$spip_lang\" target=\"spip_aide\" ".
-		"onclick=\"javascript:window.open(this.href, 'spip_aide', 'scrollbars=yes, ".
-		"resizable=yes, width=740, height=580'); return false;\">" .
-	  http_img_pack("aide.gif" ,_T('info_image_aide'),
-			"title=\""._T('titre_image_aide')."\" width=\"12\" height=\"12\" border=\"0\" align=\"middle\"") .
-	  "</a>";
+	return "&nbsp;&nbsp;<a class='aide' href=\"". _DIR_RESTREINT
+		. "aide_index.php3?aide=$aide&amp;"
+		. "var_lang=$spip_lang\" target=\"spip_aide\" "
+		. "onclick=\"javascript:window.open(this.href,"
+		. "'spip_aide', 'scrollbars=yes, resizable=yes, width=740, "
+		. "height=580'); return false;\">"
+		. http_img_pack("aide".$spip_lang_rtl.".gif",
+			_T('info_image_aide'), "title=\""._T('titre_image_aide')
+			. "\" width=\"12\" height=\"12\" border=\"0\" align=\"middle\"")
+		. "</a>";
 }
 
 
@@ -105,8 +108,11 @@
 	}
 	
 	// accesskey pour accessibilite espace prive
-	$accesskey_c = chr($accesskey++);
-	$ret = "<a name='access-$accesskey_c' href='#access-$accesskey_c' accesskey='$accesskey_c'></a>";
+	if ($accesskey <= 122) // z
+	{
+		$accesskey_c = chr($accesskey++);
+		$ret = "<a name='access-$accesskey_c' href='#access-$accesskey_c' accesskey='$accesskey_c'></a>";
+	}
 
 	if ($style == "e") {
 		$ret .= "<div class='cadre-e-noir'$style_cadre><div class='cadre-$style'>";
@@ -771,7 +777,7 @@
 
 			if ($afficher_auteurs) {
 				$les_auteurs = "";
-				$query2 = "SELECT auteurs.id_auteur, nom, messagerie, login, en_ligne ".
+				$query2 = "SELECT auteurs.id_auteur, nom, messagerie, login, bio ".
 					"FROM spip_auteurs AS auteurs, spip_auteurs_articles AS lien ".
 					"WHERE lien.id_article=$id_article AND auteurs.id_auteur=lien.id_auteur";
 				$result_auteurs = spip_query($query2);
@@ -780,8 +786,12 @@
 					$id_auteur = $row['id_auteur'];
 					$nom_auteur = typo($row['nom']);
 					$auteur_messagerie = $row['messagerie'];
-					
-					$les_auteurs .= ", <a href='auteurs_edit.php3?id_auteur=$id_auteur'>$nom_auteur</a>";
+
+					if ($bio = texte_backend(supprimer_tags(couper($row['bio'],50))))
+						$bio = " title=\"$bio\"";
+
+
+					$les_auteurs .= ", <a href='auteurs_edit.php3?id_auteur=$id_auteur'$bio>$nom_auteur</a>";
 					if ($id_auteur != $connect_id_auteur AND $auteur_messagerie != "non") {
 						$les_auteurs .= "&nbsp;".bouton_imessage($id_auteur, $row);
 					}
@@ -1444,31 +1454,10 @@
 				if ($bouton) echo "&nbsp;".$bouton;
 			}
 
-			if ($controle_id_article) {
-				if ($statut != "off") {
-					echo controle_cache_forum('supp_forum',
-						$id_forum,
-						_T('icone_supprimer_message'), 
-						"articles_forum.php3?id_article=$controle_id_article&debut=$debut#$id_forum",
-						$logo,
-						"supprimer.gif");
-				}
-				else {
-					echo "<br><font color='red'><b>"._T('info_message_supprime')." $ip</b></font>";
-					if ($id_auteur) {
-						echo " - <a href='auteurs_edit.php3?id_auteur=$id_auteur'>"._T('lien_voir_auteur')."</a>";
-					}
-				}
-				if ($statut == "prop" OR $statut == "off") {
-					$appelant= "forum.php3?$type=$valeur&id_forum=$id_forum";
-					echo controle_cache_forum('valid_forum',
-						$id_forum,
-						_T('icone_valider_message'),
-						"articles_forum.php3?id_article=$id_article&debut=$debut#$id_forum",
-						$logo,
-						"creer.gif");
-				}
-			}
+			// boutons de moderation
+			if ($controle_id_article)
+				echo boutons_controle_forum($id_forum, $statut, $id_auteur, "id_article=$controle_id_article");
+
 			echo justifier(propre($texte));
 
 			if (strlen($url_site) > 10 AND $nom_site) {
@@ -1585,7 +1574,6 @@
 	$link->addVar('couleur_claire', $couleur_claire);
 	$link->addVar('couleur_foncee', $couleur_foncee);
 	$link->addVar('left', $GLOBALS['spip_lang_left']);
-	$link->addVar('right', $GLOBALS['spip_lang_right']);
 	echo $link->getUrl()."\">\n";
 
 	if ($code) echo $code."\n";
@@ -1597,15 +1585,29 @@
 
 	debut_javascript($connect_statut == "0minirezo" AND $connect_toutes_rubriques, (lire_meta("activer_statistiques") != 'non'));
 
+	// CSS calendrier
+	echo '<link rel="stylesheet" href="', _DIR_RESTREINT, 'calendrier.css" type="text/css">', "\n";
+
+	// CSS imprimante (masque des trucs, a completer)
+	echo '<link rel="stylesheet" href="', _DIR_RESTREINT, 'spip_style_print.css" type="text/css" media="print">', "\n";
+
+	// CSS "visible au chargement", hack necessaire pour garder un depliement
+	// sympathique meme sans javascript (on exagere ?)
+	// Pour l'explication voir http://www.alistapart.com/articles/alternate/
 	echo '<link rel="alternate stylesheet" href="', _DIR_RESTREINT, 'spip_style_invisible.css" type="text/css" title="invisible" />', "\n",
-		'<link rel="stylesheet" href="', _DIR_RESTREINT, 'spip_style_visible.css" type="text/css" title="visible" />', "\n",
-		'<link rel="stylesheet" href="', _DIR_RESTREINT, 'spip_style_print.css" type="text/css" media="print">', "\n",
-		"</head>\n<body text='#000000' bgcolor='#f8f7f3' link='$couleur_lien' vlink='$couleur_lien_off' alink='$couleur_lien_off' topmargin='0' leftmargin='0' marginwidth='0' marginheight='0' frameborder='0'";
+		'<link rel="stylesheet" href="', _DIR_RESTREINT, 'spip_style_visible.css" type="text/css" title="visible" />', "\n";
+	$onLoadInvisible = " onLoad=\"setActiveStyleSheet('invisible'); ";
+
+	// favicon.ico
+	echo '<link rel="shortcut icon" href="', _DIR_IMG_PACK, 'favicon.ico" />';
+
+	// Fin des entetes
+	echo "\n</head>\n<body text='#000000' bgcolor='#f8f7f3' link='$couleur_lien' vlink='$couleur_lien_off' alink='$couleur_lien_off' topmargin='0' leftmargin='0' marginwidth='0' marginheight='0' frameborder='0'";
 
 	if ($spip_lang_rtl)
 		echo " dir='rtl'";
 	//if ($mode == "wysiwyg") echo " onLoad='debut_editor();'";
-	echo " onLoad=\"setActiveStyleSheet('invisible'); ";
+	echo $onLoadInvisible;
 
 	// Hack pour forcer largeur des formo/forml sous Mozilla >= 1.7
 	// meme principe que le behavior win_width.htc pour MSIE
@@ -2063,15 +2065,16 @@
 	echo "</ul>";
 }
 else {
-	// Icones principales
-	
+
+	// iframe permettant de passer les changements de statut rapides
 	echo "<iframe id='iframe_action' name='iframe_action' width='1' height='1' style='position: absolute; visibility: hidden;'></iframe>";
-	
-	
-	echo "<div class='invisible_au_chargement' style='position: absolute; height: 0px;'><a href='oo'>"._T("access_mode_texte")."</a></div>";
+
+	// Lien oo
+	echo "<div class='invisible_au_chargement' style='position: absolute; height: 0px; visibility: hidden;'><a href='oo'>"._T("access_mode_texte")."</a></div>";
 	
 	echo "<div id='haut-page'>";
 
+	// Icones principales
 	echo "<div class='bandeau-principal' align='center'>\n";
 	echo "<div class='bandeau-icones'>\n";
 	echo "<table width='$largeur' cellpadding='0' cellspacing='0' border='0' align='center'><tr>\n";
@@ -2220,7 +2223,7 @@
 	$decal = $decal + largeur_icone_bandeau_principal(_T('icone_auteurs'));
 
 	// decalage pour barre verticale
-	//$decal = $decal + 11;
+	// $decal = $decal + 11;
 
 	if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques AND lire_meta("activer_statistiques") != 'non') {
 		if ($rubrique == "suivi") {
@@ -2315,7 +2318,7 @@
 		if (!($connect_statut == "0minirezo" AND $connect_toutes_rubriques)) {
 			echo http_img_pack("rien.gif", "", "width='10'");
 			echo "<a href='auteurs_edit.php3?id_auteur=$connect_id_auteur' class='icone26' onMouseOver=\"changestyle('bandeauinfoperso','visibility','visible');\">" .
-			  http_img_pack("fiche-perso.png", "", "border='0' onMouseOver=\")changestyle('bandeauvide','visibility', 'visible';\"");
+			  http_img_pack("fiche-perso.png", "", "border='0' onMouseOver=\"changestyle('bandeauvide','visibility', 'visible');\"");
 			echo "</a>";
 		}
 		

Index: controle_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/controle_forum.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- controle_forum.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ controle_forum.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -139,12 +139,6 @@
 	
 	$controle = "\n<br /><br /><a id='$id_forum'></a>";
 	
-//	$controle.=  "[$forum_stat]";
-	if ($forum_stat == "prive") $logo = "forum-interne-24.gif";
-	else if ($forum_stat == "privadm") $logo = "forum-admin-24.gif";
-	else if ($forum_stat == "privrac") $logo = "forum-interne-24.gif";
-	else $logo = "forum-public-24.gif";
-
 	$controle .= debut_cadre_thread_forum("", true, "", typo($forum_titre));
 
 	if ($forum_stat=="off" OR $forum_stat == "privoff") {
@@ -166,51 +160,8 @@
 		$controle .= "<span class='arial2'> / <B>$forum_auteur</B></span>";
 	}
 
-	if ($forum_stat != "off" AND $forum_stat != "privoff") {
-		if ($forum_stat == "publie" OR $forum_stat == "prop")
-			$controle .= 
-		  controle_cache_forum('supp_forum',
-				       $id_forum,
-				       _T('icone_supprimer_message'), 
-				       "controle_forum.php3?$rappel#$id_forum",
-				       $logo,
-				       "supprimer.gif");
-		else if ($forum_stat == "prive" OR $forum_stat == "privrac" OR $forum_stat == "privadm")
-			$controle .= 
-		  controle_cache_forum('supp_forum_priv',
-				       $id_forum,
-				       _T('icone_supprimer_message'), 
-				       "controle_forum.php3?$rappel#$id_forum",
-				       $logo,
-				       "supprimer.gif");
-		    }
-	else {
-		$controle .= "<BR><FONT COLOR='red'><B>"._T('info_message_supprime')." $forum_ip</B></FONT>";
-		if($forum_id_auteur>0)
-			$controle .= " - <A HREF='auteurs_edit.php3?id_auteur=$forum_id_auteur'>"._T('lien_voir_auteur')."</A>";
-	}
+	$controle .= boutons_controle_forum($id_forum, $forum_stat, $forum_id_auteur, "$type=$valeur");
 
-	if ($forum_stat=="prop")
-	  {
-		$appelant= "forum.php3?$type=$valeur&id_forum=$id_forum";
-		$controle .=
-		  controle_cache_forum('valid_forum',
-				       $id_forum,
-				       _T('icone_valider_message'), 
-				       "controle_forum.php3?$rappel&#$id_forum",
-				       $logo,
-				       "creer.gif") .
-		  controle_cache_forum('valid_forum',
-				       $id_forum,
-				       _T('icone_valider_message') . " &amp; " .
-				       _T('lien_repondre_message'),
-				       "../$appelant&url=" .
-				       rawurlencode($appelant) . 
-				       "&retour=" .
-				       rawurlencode(_DIR_RESTREINT_ABS . "controle_forum.php3?$rappel&#$id_forum"), 
-				       _DIR_IMG_PACK . "messagerie-24.gif",
-				       "creer.gif");
-	  }
 	$controle .= "<br />$avant<B>$pref <A HREF='$url'>$titre</A></B>" .
 	  "<P align='justify'>".propre($forum_texte);
 

Index: inc_charsets.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_charsets.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_charsets.php3	25 Feb 2005 16:35:57 -0000	1.3
+++ inc_charsets.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -17,9 +17,9 @@
 define("_ECRIRE_INC_CHARSETS", "1");
 
 
-/* charsets supportes :
+/* charsets supportes en natif (les autres via mb_string) :
 	utf-8 ;
-	iso-8859-1 ; iso-8859-15 ;
+	iso-8859-1 ; iso-8859-9 ; iso-8859-15 ;
 	windows-1251  = CP1251 ;
 */
 function load_charset ($charset = 'AUTO', $langue_site = 'AUTO') {
@@ -60,6 +60,20 @@
 		return $charset;
 
 
+	// iso latin 9 - Turc <alexis at nds.k12.tr>
+	case 'iso-8859-9':
+		load_charset('iso-8859-1');
+		$trans = $GLOBALS['CHARSET']['iso-8859-1'];
+		$trans[240]=287; //gbreve
+		$trans[208]=286; //Gbreve
+		$trans[221]=304; //Idot
+		$trans[253]=305; //inodot
+		$trans[254]=351; //scedil
+		$trans[222]=350; //Scedil
+		$GLOBALS['CHARSET'][$charset] = $trans;
+		return $charset;
+
+
 	// iso latin 15 - Gaetan Ryckeboer <gryckeboer at virtual-net.fr>
 	case 'iso-8859-15':
 		load_charset('iso-8859-1');
@@ -1898,6 +1912,9 @@
 		239=>'i', 241=>'n', 242=>'o', 243=>'o', 244=>'o', 245=>'o', 246=>'o',
 		248=>'o', 249=>'u', 250=>'u', 251=>'u', 252=>'u', 255=>'y',
 
+		// turc
+		286=>'G', 287=>'g', 304=>'I', 305=>'i', 350=>'S', 351=>'s',
+
 		// esperanto
 		264 => 'Cx',265 => 'cx',
 		284 => 'Gx',285 => 'gx',
@@ -1990,19 +2007,45 @@
 
 
 	default:
-		spip_log("erreur charset $charset non supporte");
 		$GLOBALS['CHARSET'][$charset] = array();
 		return $charset;
 	}
 }
 
+//
+// Verifier qu'on peut utiliser mb_string
+//
+function init_mb_string() {
+	static $mb;
+
+	// verifier que tout est present (fonctions mb_string pour php >= 4.0.6)
+	// et que le charset interne est connu de mb_string
+	if (!$mb) {
+		if (function_exists('mb_internal_encoding')
+		AND function_exists('mb_detect_order')
+		AND function_exists('mb_substr')
+		AND function_exists('mb_strlen')
+		AND function_exists('mb_encode_mimeheader')
+		AND function_exists('mb_encode_numericentity')
+		AND function_exists('mb_decode_numericentity')
+		AND mb_detect_order(lire_meta('charset'))
+		) {
+			mb_internal_encoding('utf-8');
+			$mb = 1;
+		} else
+			$mb = -1;
+	}
+
+	return ($mb == 1);
+}
 
 // Detecter les versions buggees d'iconv
 function test_iconv() {
 	static $iconv_ok;
 
 	if (!$iconv_ok) {
-		if (!$GLOBALS['flag_iconv']) $iconv_ok = -1;
+		if (!function_exists('iconv'))
+			$iconv_ok = -1;
 		else {
 			if (utf_32_to_unicode(@iconv('utf-8', 'utf-32', 'chaine de test')) == 'chaine de test')
 				$iconv_ok = 1;
@@ -2010,7 +2053,7 @@
 				$iconv_ok = -1;
 		}
 	}
-	return $iconv_ok == 1;
+	return ($iconv_ok == 1);
 }
 
 // Test de fonctionnement du support UTF-8 dans PCRE
@@ -2089,7 +2132,6 @@
 // Transforme une chaine en entites unicode &#129;
 //
 function charset2unicode($texte, $charset='AUTO', $forcer = false) {
-	global $flag_multibyte;
 	static $trans;
 
 	if ($charset == 'AUTO')
@@ -2097,16 +2139,6 @@
 
 	switch ($charset) {
 	case 'utf-8':
-		// Le passage par utf-32 devrait etre plus rapide
-		// (traitements PHP reduits au minimum)
-		if (test_iconv()) {
-			$s = iconv('utf-8', 'utf-32le', $texte);
-			if ($s) return utf_32_to_unicode($s);
-		}
-		if ($flag_multibyte) {
-			$s = @mb_convert_encoding($texte, 'utf-32le', 'utf-8');
-			if ($s && $s != $texte) return utf_32_to_unicode($s);
-		}
 		return utf_8_to_unicode($texte);
 
 	case 'iso-8859-1':
@@ -2126,26 +2158,37 @@
 		if (!$forcer) return $texte;
 
 	default:
-		if (test_iconv()) {
-			$s = iconv($charset, 'utf-32le', $texte);
-			if ($s) return utf_32_to_unicode($s);
-		}
-		if ($flag_multibyte) {
-			$s = @mb_convert_encoding($texte, 'utf-32le', $charset);
-			if ($s && $s != $texte) return utf_32_to_unicode($s);
+		// mbstring presente ?
+		if (init_mb_string()) {
+			if ($order = mb_detect_order() # mb_string connait-il $charset?
+			AND mb_detect_order($charset)) {
+				$s = mb_convert_encoding($texte, 'utf-8', $charset);
+				if ($s && $s != $texte) return utf_8_to_unicode($s);
+			}
+			mb_detect_order($order); # remettre comme precedemment
 		}
 
-		if (!$trans[$charset]) {
+		// Sinon, peut-etre connaissons-nous ce charset ?
+		if (!isset($trans[$charset])) {
 			global $CHARSET;
 			load_charset($charset);
 			foreach ($CHARSET[$charset] as $key => $val) {
 				$trans[$charset][chr($key)] = '&#'.$val.';';
 			}
 		}
+		if (count($trans[$charset]))
+			return strtr($texte, $trans[$charset]);
 
-		if ($trans[$charset])
-			$texte = strtr($texte, $trans[$charset]);
+		// Sinon demander a iconv (malgre le fait qu'il coupe quand un
+		// caractere n'appartient pas au charset, mais c'est un probleme
+		// surtout en utf-8, gere ci-dessus)
+		if (test_iconv()) {
+			$s = iconv($charset, 'utf-32le', $texte);
+			if ($s) return utf_32_to_unicode($s);
+		}
 
+		// Au pire ne rien faire
+		spip_log("erreur charset $charset non supporte");
 		return $texte;
 	}
 }
@@ -2203,6 +2246,14 @@
 
 // UTF-8
 function utf_8_to_unicode($source) {
+
+	// mb_string : methode rapide
+	if (init_mb_string()) {
+		$convmap = array(0x7F, 0xFFFFFF, 0x0, 0xFFFFFF);
+		return mb_encode_numericentity($source, $convmap, 'UTF-8');
+	}
+
+	// Sinon methode pas a pas
 	static $decrement;
 	static $shift;
 
@@ -2281,44 +2332,35 @@
 	return $encodedString;
 }
 
-// UTF-32 : utilise en interne car plus rapide qu'UTF-8
+// UTF-32 ne sert plus que si on passe par iconv, c'est-a-dire quand
+// mb_string est absente ou ne connait pas notre charset
+// mais on l'optimise quand meme par mb_string
+// => tout ca sera osolete quand on sera surs d'avoir mb_string
 function utf_32_to_unicode($source) {
-	/*while ($source) {
+
+	// mb_string : methode rapide
+	if (init_mb_string()) {
+		$convmap = array(0x7F, 0xFFFFFF, 0x0, 0xFFFFFF);
+		$source = mb_encode_numericentity($source, $convmap, 'UTF-32LE');
+		return str_replace(chr(0), '', $source);
+	}
+
+	// Sinon methode lente
+	$texte = '';
+	while ($source) {
 		$words = unpack("V*", substr($source, 0, 1024));
 		$source = substr($source, 1024);
 		foreach ($words as $word) {
-			if ($word < 128) $texte .= chr($word);
-			else if ($word != 65279) $texte .= '&#'.$word.';';
+			if ($word < 128)
+				$texte .= chr($word);
+			// ignorer le BOM - http://www.unicode.org/faq/utf_bom.html
+			else if ($word != 65279)
+				$texte .= '&#'.$word.';';
 		}
-	}*/
-
-	// Attention, cette implementation peut produire des erreurs dans de tres rares cas :
-	// caracteres multiples de 256 et superieurs a 0x900
-	$chars = array();
-	$len = strlen($source);
-	$chunk_len = 16384;
-	// Extraire la liste des caracteres utilises
-	// (plusieurs iterations pour eviter l'explosion memoire)
-	for ($i = 0; $i <= $len; $i += $chunk_len) {
-		$chars = $chars + array_flip(unpack("V*", substr($source, $i, $chunk_len)));
 	}
-	$cherche = $remplace = array();
-	foreach ($chars as $c => $v) {
-		$from = pack("V", $c);
-		if ($c < 128)
-			$to = chr($c);
-		else if ($c != 65279)
-			$to = '&#'.$c.';';
-		else 
-			$to = '';
-		$cherche[] = $from;
-		$remplace[] = $to;
-	}
-	$texte = str_replace($cherche, $remplace, $source);
-	
 	return $texte;
-}
 
+}
 
 // Ce bloc provient de php.net, auteur Ronen
 function caractere_utf_8($num) {
@@ -2388,24 +2430,41 @@
 			$trans[$complexe][caractere_utf_8($key)] = $val;
 	}
 
-	$texte = strtr($texte, $trans[$complexe]);
-
-/*
-	// Le probleme d'iconv c'est qu'il risque de nous renvoyer des ? alors qu'on
-	// prefere garder l'utf-8 pour que la chaine soit indexable.
-	// 3. Translitterer grace a iconv
-	if ($GLOBALS['flag_iconv'] && ereg('&#0*([0-9]+);', $texte)) {
-		$texte = iconv('utf-8', 'ascii//translit', $texte);
-	}
-*/
-
-	return $texte;
+	return strtr($texte, $trans[$complexe]);
 }
 
 function translitteration_complexe($texte) {
 	return translitteration($texte,'AUTO','complexe');
 }
 
+// Transcode une page (probablement attrapee sur le web) en essayant
+// par tous les moyens de deviner son charset (y compris headers HTTP)
+function transcoder_page($texte, $headers='') {
+
+	// charset precise par le contenu (xml)
+	if (preg_match(',<[?]xml[^>]*encoding[^>]*=[^>]*([-_a-z0-9]+?),Uims', $texte, $regs))
+		$charset = trim(strtolower($regs[1]));
+	// charset precise par le contenu (html)
+	else if (preg_match(',<(meta|html|body)[^>]*charset[^>]*=[^>]*([-_a-z0-9]+?),Uims', $texte, $regs))
+		$charset = trim(strtolower($regs[2]));
+	// charset de la reponse http
+	else if (preg_match(',charset=([-_a-z0-9]+),i', $headers, $regs))
+		$charset = trim(strtolower($regs[1]));
+
+	// normaliser les noms du shif-jis japonais
+	if (preg_match(',^(x|shift)[_-]s?jis$,i', $charset))
+		$charset = 'shift-jis';
+
+	if ($charset) {
+		spip_log("charset source detecte : $charset");
+	} else {
+		// valeur par defaut
+		$charset = 'iso-8859-1';
+		spip_log("pas de charset detecte, on suppose : $charset");
+	}
+
+	return importer_charset($texte, $charset);
+}
 
 // Initialisation
 $GLOBALS['CHARSET'] = Array();

Index: inc_majbase.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_majbase.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_majbase.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_majbase.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -965,6 +965,12 @@
 		maj_version(1.812);
 	}
 
+	// Mise a jour des types MIME
+	if ($version_installee < 1.813) {
+		# rien a faire car c'est creer_base() qui s'en charge
+		maj_version(1.813);
+	}
+
 	return true;
 }
 

Index: inc_cron.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_cron.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_cron.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_cron.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -215,6 +215,8 @@
 function cron_mail($t) {
 	$adresse_neuf = lire_meta('adresse_neuf');
 	$jours_neuf = lire_meta('jours_neuf');
+	// $t = 0 si le fichier de lock a ete detruit
+	if (!$t) $t = time() - (3600 * 24 * $jours_neuf);
 
 	include_local("inc-calcul.php3");
 	$page= cherche_page('',
@@ -236,18 +238,21 @@
 # 1ere ligne = sujet
 # lignes suivantes jusqu'a la premiere blanche: headers SMTP
 
-				$page = stripslashes($page);
+				$page = stripslashes(trim($page));
 				$p = strpos($page,"\n\n");
 				$s = strpos($page,"\n");
-				$headers = substr($page,$s+1,$p-$s);
-				$sujet_nouveautes = substr($page,0,$s);
-				$mail_nouveautes = substr($page,$p+2);
+				if ($p AND $s) {
+					if ($p>$s)
+						$headers = substr($page,$s+1,$p-$s);
+					$sujet_nouveautes = substr($page,0,$s);
+					$mail_nouveautes = trim(substr($page,$p+2));
+				}
 	}
 
-	$n = strlen($mail_nouveautes);
-	if ($n > 10)
-	  envoyer_mail($adresse_neuf, $sujet_nouveautes, $mail_nouveautes, '', $headers);
-	spip_log("$n nouveautes depuis $jours_neuf jours");
+	if (strlen($mail_nouveautes) > 10)
+		envoyer_mail($adresse_neuf, $sujet_nouveautes, $mail_nouveautes, '', $headers);
+	else
+		spip_log("mail nouveautes : rien de neuf depuis $jours_neuf jours");
 	return 1;
 }
 

Index: inc_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_forum.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_forum.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_forum.php3	29 Mar 2005 15:27:12 -0000	1.3
@@ -56,17 +56,122 @@
 }
 
 // Installer un bouton de moderation (securise) dans l'espace prive
-function controle_cache_forum($action, $id, $texte, $lien, $fond, $fonction) {
-	$link = $GLOBALS['clean_link'];
+function controle_cache_forum($action, $id, $texte, $fond, $fonction, $redirect='') {
+	$link = new Link();
+
 	$link->addvar('controle_forum', $action);
 	$link->addvar('id_controle_forum', $id);
 	$link->addvar('hash', calculer_action_auteur("$action$id"));
+
+	if ($redirect)
+		$link->addvar('redirect', $redirect);
+
 	return icone($texte,
 		$link->geturl(),
 		$fond,
 		$fonction,
 		"right",
 		'non');
+}
+
+// tous les boutons de controle d'un forum
+function boutons_controle_forum($id_forum, $forum_stat, $forum_id_auteur=0, $ref) {
+	$controle = '';
+
+	// selection du logo et des boutons correspondant a l'etat du forum
+	switch ($forum_stat) {
+		# forum sous un article dans l'espace prive
+		case "prive":
+			$logo = "forum-interne-24.gif";
+			$valider = false;
+			$valider_repondre = false;
+			$supprimer = 'supp_forum_priv';
+			break;
+		# forum des administrateurs
+		case "privadmin":
+			$logo = "forum-admin-24.gif";
+			$valider = false;
+			$valider_repondre = false;
+			$supprimer = false;
+			break;
+		# forum de l'espace prive, supprime (non revalidable,
+		# d'ailleurs on ne sait plus a quel type de forum il appartenait)
+		case "privoff":
+			$logo = "forum-interne-24.gif";
+			$valider = false;
+			$valider_repondre = false;
+			$supprimer = false;
+			break;
+		# forum general de l'espace prive
+		case "privrac":
+			$logo = "forum-interne-24.gif";
+			$valider = false;
+			$valider_repondre = false;
+			$supprimer = 'supp_forum_priv';
+			break;
+
+		# forum publie sur le site public
+		case "publie":
+			$logo = "forum-public-24.gif";
+			$valider = false;
+			$valider_repondre = false;
+			$supprimer = 'supp_forum';
+			break;
+		# forum supprime sur le site public
+		case "off":
+			$logo = "forum-public-24.gif";
+			$valider = 'valid_forum';
+			$valider_repondre = false;
+			$supprimer = false;
+			$message = "<BR><FONT COLOR='red'><B>"._T('info_message_supprime')." $forum_ip</B></FONT>";
+			if($forum_id_auteur)
+				$message .= " - <A HREF='auteurs_edit.php3?id_auteur="
+				.$forum_id_auteur."'>" ._T('lien_voir_auteur'). "</A>";
+			break;
+		# forum propose (a moderer) sur le site public
+		case "prop":
+			$logo = "forum-public-24.gif";
+			$valider = 'valid_forum';
+			$valider_repondre = true;
+			$supprimer = true;
+			break;
+		default:
+			return;
+	}
+
+	if ($message)
+		$controle .= $message;
+
+	if ($supprimer)
+		$controle .= controle_cache_forum($supprimer,
+			$id_forum,
+			_T('icone_supprimer_message'), 
+			$logo,
+			"supprimer.gif");
+
+	if ($valider)
+		$controle .= controle_cache_forum($valider,
+			$id_forum,
+			_T('icone_valider_message'), 
+			$logo,
+			"creer.gif");
+
+	if ($valider_repondre) {
+		$link = new Link();
+		$redirect = "../forum.php3?$ref&id_forum=$id_forum&retour=ecrire/"
+			.urlencode($link->getUrl());
+
+		$controle .= controle_cache_forum($valider,
+			$id_forum,
+			_T('icone_valider_message') . " &amp; " .
+			_T('lien_repondre_message'),
+			$logo,
+			"creer.gif",
+			$redirect
+		);
+	}
+
+	return $controle;
 }
 
 // Index d'invalidation des forums

Index: inc_getdocument.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_getdocument.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_getdocument.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_getdocument.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -239,13 +239,11 @@
 	OR !$taille = @filesize($definitif))
 		return;
 
-	// Est-ce une image ?
+	// Si c'est une image, recuperer sa taille et son type (detecte aussi swf)
 	$size_image = @getimagesize($definitif);
+	$largeur = intval($size_image[0]);
+	$hauteur = intval($size_image[1]);
 	$type_image = decoder_type_image($size_image[2]);
-	if ($type_image) {
-		$largeur = $size_image[0];
-		$hauteur = $size_image[1];
-	}
 
 	// Si on veut uploader une vignette, il faut qu'elle ait ete bien lue
 	if ($mode == 'vignette' AND !($largeur * $hauteur)) {
@@ -633,15 +631,44 @@
 // Faire tourner une image
 //
 function gdRotate ($imagePath,$rtt){
-	if(preg_match("/\.(png)/i", $imagePath))
-		$src_img=ImageCreateFromPNG($imagePath);
-	else if(preg_match("/\.(jpg)/i", $imagePath))
-		$src_img=ImageCreateFromJPEG($imagePath);
-	else if(preg_match("/\.(bmp)/i", $imagePath))
-		$src_img=ImageCreateFromWBMP($imagePath);
+	if(preg_match("/\.(png|gif|jpe?g|bmp)$/i", $imagePath, $regs)) {
+		switch($regs[1]) {
+			case 'png':
+				$src_img=ImageCreateFromPNG($imagePath);
+				$save = 'imagepng';
+				break;
+			case 'gif':
+				$src_img=ImageCreateFromGIF($imagePath);
+				$save = 'imagegif';
+				break;
+			case 'jpeg':
+			case 'jpg':
+				$src_img=ImageCreateFromJPEG($imagePath);
+				$save = 'Imagejpeg';
+				break;
+			case 'bmp':
+				$src_img=ImageCreateFromWBMP($imagePath);
+				$save = 'imagewbmp';
+				break;
+			default:
+				return false;
+		}
+	}
+
+	if (!$src_img) {
+		spip_log("gdrotate: image non lue, $imagePath");
+		return false;
+	}
+
 	$size=@getimagesize($imagePath);
+	if (!($size[0] * $size[1])) return false;
 
-	// Sous GD2 : ImageCreateTrueColor
+	if (function_exists('imagerotate')) {
+		$dst_img = imagerotate($src_img, -$rtt, 0);
+	} else {
+
+	// Creer l'image destination (hauteur x largeur) et la parcourir
+	// pixel par pixel (un truc de fou)
 	$process = lire_meta('image_process');
 	if ($process == "gd2")
 		$dst_img=ImageCreateTrueColor($size[1],$size[0]);
@@ -684,9 +711,13 @@
 			$b--;
 		}
 	}
+	}
 	ImageDestroy($src_img);
 	ImageInterlace($dst_img,0);
-	ImageJPEG($dst_img,$imagePath);
+
+	# obligatoire d'enregistrer dans le meme format, puisque c'est
+	# dans le fichier de depart...
+	$save($dst_img,$imagePath);
 }
 
 function tourner_document($var_rot, $doc_rotate, $convert_command) {

Index: inc_logos.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_logos.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc_logos.php3	3 Mar 2005 14:54:56 -0000	1.4
+++ inc_logos.php3	29 Mar 2005 15:27:12 -0000	1.5
@@ -438,6 +438,36 @@
 
 
 //
+// Retourner taille d'une image
+// pour les filtres |largeur et |hauteur
+//
+function taille_image($img) {
+
+	if (eregi("width *= *['\"]?( *[0-9]+ *)", $img, $regs))
+		$srcWidth = intval(trim($regs[1]));
+	if (eregi("height *= *['\"]?( *[0-9]+ *)", $img, $regs))
+		$srcHeight = intval(trim($regs[1]));
+
+	// recuperer le nom du fichier
+	if (eregi("src='([^']+)'", $img, $regs)) $logo = $regs[1];
+	if (!$logo) $logo = $img;
+
+	if (!$srcWidth
+	AND $srcsize = @getimagesize($logo))
+		$srcWidth = $srcsize[0];
+
+	if (!$srcHeight
+	AND $srcsize = @getimagesize($logo))
+		$srcHeight = $srcsize[1];
+
+	return array($srcHeight, $srcWidth);
+	
+}
+
+
+
+
+//
 // Reduire la taille d'un logo
 // [(#LOGO_ARTICLE||reduire_image{100,60})]
 //

Index: inc_acces.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_acces.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_acces.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ inc_acces.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -80,13 +80,9 @@
 
 
 // Une fonction service qui affiche le statut de l'auteur dans l'espace prive
-function afficher_formulaire_statut_auteur ($id_auteur, $post='') {
+function afficher_formulaire_statut_auteur ($id_auteur, $statut, $post='') {
 	global $connect_statut, $connect_toutes_rubriques, $connect_id_auteur;
 	global $spip_lang_right;
-
-	$s = spip_query("SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur");
-	$auteur = spip_fetch_array($s);
-	$statut = $auteur['statut'];
 
 	if ($post) {
 		$url_self = $post;

Index: inc_carto.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_carto.php3,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -d -r1.8 -r1.9
--- inc_carto.php3	1 Mar 2005 17:36:11 -0000	1.8
+++ inc_carto.php3	29 Mar 2005 15:27:12 -0000	1.9
@@ -38,20 +38,6 @@
 	return "polygon(0 0,".$mArray['largeur']." ".$mArray['hauteur'].")";
 }
 
-function worldfile2array($callage){	
-	$tabcallage['shape']=substr($callage,0,strpos($callage,"("));
-	
-	$coordpair = explode(',',substr($callage,strpos($callage,"(")+1,-1));
-	$UL = explode (' ', $coordpair[0]);
-	$LR = explode (' ', $coordpair[1]);
-	
-	$tabcallage['top_left']['x']=$UL[0];
-	$tabcallage['top_left']['y']=$UL[1];
-	$tabcallage['bottom_right']['x']=$LR[0];
-	$tabcallage['bottom_right']['y']=$LR[1];
-	
-	return $tabcallage;
-}
 
 function embed_carto_url($id_carte, $url_parse) {
 	$lURL = $url_parse['path']."/carto.php3?id_carte=".$id_carte."&scale=".$_GET['scale']."&x=".$_GET['x']."&y=".$_GET['y'];
@@ -167,6 +153,125 @@
     dhtmlDivs += \'<td align="right" width="50%"><div id="displayMeasureDiv" class="dhtmlDisplay"></div></td>\';
     dhtmlDivs += \'</tr></table></div>\';
     document.write(dhtmlDivs);
+                  
+    function dboxInit()
+    {
+      myform = document.forms[\'carto_form\'];
+      // DHTML drawing and navigating tools
+      dhtmlBox = new dhtmlBox();
+          
+      //DHTML parameters
+      dhtmlBox.dispPos = \'bottom\';
+      dhtmlBox.thickness = 2;
+      dhtmlBox.cursorsize = 4;
+      dhtmlBox.jitter = 10; // minimum size of a box dimension
+      dhtmlBox.d2pts = 3;   // the distance between two points (measure tools);
+      dhtmlBox.nbPts = 5;   // number of points for the last vertex
+      
+      // map units values
+	  // dynamically given by the server
+      dhtmlBox.mapHeight = '.$height.';
+      dhtmlBox.boxx = 470000;
+      dhtmlBox.boxy = 46300;
+      dhtmlBox.pixel_size = 924.83333333334;
+      dhtmlBox.dist_msg = \'Approx. distance: \';
+      dhtmlBox.dist_unit = \' m.\';
+      dhtmlBox.surf_msg = \'Approx. surface: \';
+      dhtmlBox.surf_unit = \' m??.\';
+      dhtmlBox.coord_msg = \'Coords (m): \';
+  
+          
+      dhtmlBox.initialize();
+    }
+      
+    window.onload = function() {
+      dboxInit();
+      xHide(xGetElementById(\'mapAnchorDiv\')); 
+    }
+	/*]]>*/
+  </script>
+    <input type="hidden" name="id_carte" value="'.$id_carte.'"/>
+	<input type="hidden" name="retour" value="'.$retour.'"/>
+	<input type="hidden" name="selection_type" />
+	<input type="hidden" name="selection_coords" />
+	<div id="mapAnchorDiv" style="position:relative; width:'.$width.'px; height:'.$height.'px;"> 
+     <table>
+      <tr> 
+       <td align="center" valign="middle" width="'.$width.'px" height="'.$height.'px">
+		<div id="loadbar">Loading message</div>
+	   </td>
+      </tr>
+     </table>
+    </div>
+   </td>
+  </tr>
+  <tr>
+   <td> 
+    <input type="radio" name="tool" value="rectangle,submit,crossHair,zoom_in"  id="zoom_in" onclick="dhtmlBox.changeTool()" />
+          zoom_in<br />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="point,submit,crossHair,zoom_out"  id="zoom_out" onclick="dhtmlBox.changeTool()" />
+          zoom out<br />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="pan,submit,move,pan"  id="pan" onclick="dhtmlBox.changeTool()" />
+          pan<br />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="rectangle,submit,help,query"  id="query" onclick="dhtmlBox.changeTool()" />
+          query<br />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="point,submit,crossHair,point"   id="point" onclick="dhtmlBox.changeTool()" />
+          point submit<br />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="line,submit,crossHair,line"   id="line" onclick="dhtmlBox.changeTool()" />
+          line submit<br />
+          </td><td><input type="radio" name="tool" value="polygon,submit,crossHair,polygon"   checked="checked"  id="polygon" onclick="dhtmlBox.changeTool()" />
+          polygon submit<br />
+   </td>
+  </tr>
+ </table>
+</form>';
+	return $returned;
+}
+function afficher_interface($id_carte,$retour,$callage) {
+	
+	$widthgeo=$callage['bottom_right']['x']-$callage['top_left']['x'];
+	$heightgeo=$callage['bottom_right']['y']-$callage['top_left']['y'];
+	
+	$width=$widthgeo;
+	$height=$heightgeo;
+	$returned='<script type="text/javascript" src="js/x_core_nn4.js"></script>
+<script type="text/javascript" src="js/x_dom_nn4.js"></script>
+<script type="text/javascript" src="js/x_event_nn4.js"></script>
+<script type="text/javascript" src="js/navTools.js"></script>
+<script type="text/javascript" src="js/graphTools.js"></script>
+<form method="get" action="#nouveau_objet" name="carto_form">
+ <table border="1">
+  <tr> 
+   <td colspan="7">
+<script type="text/javascript">
+/*<![CDATA[*/ 
+    var dhtmlDivs = new String();
+    document.image = new Image;
+    document.image.src = \''.$fichier.'\';
+       dhtmlDivs += \'<div id="mapImageDiv" class="dhtmldiv" style="position: absolute;visibility:hidden;z-index: 1;">\';      
+      dhtmlDivs +=\'<embed src="../carto_svgfile'.$id_carte.'.svg" width="'.$width.'px" height='.$height.'px" type="image/svg+xml" name="emap"/>\';
+	  dhtmlDivs +=\'</div>\';
+  
+    
+    dhtmlDivs += \'<div id="myCanvasDiv" class="dhtmldiv"></div>\';
+    dhtmlDivs += \'<div id="myCanvas2Div" class="dhtmldiv"></div>\';
+    dhtmlDivs += \'<div id="mainDHTMLDiv" class="dhtmldiv"></div>\';
+    dhtmlDivs += \'<div id="diplayContainerDiv" class="dhtmldiv">\';
+    dhtmlDivs += \'<table border="0" width="100%" cellspacing="0" cellpadding="0"><tr>\';
+    dhtmlDivs += \'<td width="50%"><div id="displayCoordsDiv" class="dhtmlDisplay"></div></td>\';
+    dhtmlDivs += \'<td align="right" width="50%"><div id="displayMeasureDiv" class="dhtmlDisplay"></div></td>\';
+    dhtmlDivs += \'</tr></table></div>\';
+     document.write(dhtmlDivs);
                   
     function dboxInit()
     {

Index: inc_rubriques.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_rubriques.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_rubriques.php3	4 Mar 2005 10:45:01 -0000	1.3
+++ inc_rubriques.php3	29 Mar 2005 15:27:12 -0000	1.4
@@ -152,6 +152,7 @@
 	
 	// Sauver la date de la derniere mise a jour (pour menu_rubriques)
 	ecrire_meta("date_calcul_rubriques", date("U"));
+	ecrire_metas();
 
 }
 

Index: inc_calendrier.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_calendrier.php,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc_calendrier.php	3 Mar 2005 14:54:56 -0000	1.4
+++ inc_calendrier.php	29 Mar 2005 15:27:12 -0000	1.5
@@ -15,6 +15,8 @@
 if (defined("_ECRIRE_INC_CALENDRIER")) return;
 define("_ECRIRE_INC_CALENDRIER", "1");
 
+# Typographie generale des calendriers de 3 type: jour/semaine/mois(ou plus)
+
 define(DEFAUT_D_ECHELLE,120); # 1 pixel = 2 minutes
 
 // Ecrire cookies
@@ -31,16 +33,141 @@
 } else 
 	$GLOBALS['partie_cal'] = $GLOBALS['_COOKIE']['spip_partie_cal'];
[...1768 lines suppressed...]
-  $categ = $evenement['CATEGORIES'];
-
-  if (!is_int($categ))
-    return "";
-  else 
-    { 
-      if ($categ >= 0) {$f=0;$b=1;$i=$categ;}else{$f=1;$b=0;$i=0-$categ;}
-      $i %= count($contrastes);
-      return array($contrastes[$i][$b], $contrastes[$i][$f]);
+      if (!is_int($categ))
+	return "";
+      else 
+	{ 
+	  if ($categ >= 0) {$f=0;$b=1;$i=$categ;}else{$f=1;$b=0;$i=0-$categ;}
+	  $i %= count($contrastes);
+	  return array($contrastes[$i][$b], $contrastes[$i][$f]);
+	}
     }
 }
 ?>



From stef at berlios.de  Tue Mar 29 17:27:37 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:27:37 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_typebase.php3,NONE,1.1
Message-ID: <200503291527.j2TFRb9Y001608@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv1576/spipcarto/ecrire

Added Files:
	inc_typebase.php3 
Log Message:
1.8PR2 CVS 20050329

--- NEW FILE: inc_typebase.php3 ---
<?php

/***************************************************************************\
 *  SPIP, Systeme de publication pour l'internet                           *
 *                                                                         *
 *  Copyright (c) 2001-2005                                                *
 *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
 *                                                                         *
 *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
 *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
\***************************************************************************/


//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_TYPEBASE")) return;
define("_ECRIRE_INC_TYPEBASE", "1");

global $tables_images, $tables_sequences, $tables_documents, $tables_mime;

$tables_images = array(
		       // Images reconnues par PHP
		       'jpg' => 1, 
		       'png' => 2, 
		       'gif' => 3,

		       // Autres images (peuvent utiliser le tag <img>)
		       'bmp' => 'BMP',
		       'psd' => 'Photoshop',
		       'tif' => 'TIFF'
		       );

// Multimedia (peuvent utiliser le tag <embed>)

$tables_sequences = array(
			  'aiff' => 'AIFF',
			  'asf' => 'Windows Media',
			  'avi' => 'Windows Media',
			  'mid' => 'Midi',
			  'mng' => 'MNG',
			  'mov' => 'QuickTime',
			  'mp3' => 'MP3',
			  'mpg' => 'MPEG',
			  'ogg' => 'Ogg',
			  'qt' => 'QuickTime',
			  'ra' => 'RealAudio',
			  'ram' => 'RealAudio',
			  'rm' => 'RealAudio',
			  'swf' => 'Flash',
			  'wav' => 'WAV',
			  'wmv' => 'Windows Media'
			  );

// Documents varies
$tables_documents = array(
			  'ai' => 'Adobe Illustrator',
			  'bz2' => 'BZip',
			  'c' => 'C source',
			  'css' => 'Cascading Style Sheet',
			  'deb' => 'Debian',
			  'doc' => 'Word',
			  'djvu' => 'DjVu',
			  'dvi' => 'LaTeX DVI',
			  'eps' => 'PostScript',
			  'gz' => 'GZ',
			  'h' => 'C header',
			  'html' => 'HTML',
			  'pas' => 'Pascal',
			  'pdf' => 'PDF',
			  'pgn' => 'Portable Game Notation',
			  'ppt' => 'PowerPoint',
			  'ps' => 'PostScript',
			  'rpm' => 'RedHat/Mandrake/SuSE',
			  'rtf' => 'RTF',
			  'sdd' => 'StarOffice',
			  'sdw' => 'StarOffice',
			  'sit' => 'Stuffit',
			  'sxc' => 'OpenOffice Calc',
			  'sxi' => 'OpenOffice Impress',
			  'sxw' => 'OpenOffice',
			  'tex' => 'LaTeX',
			  'tgz' => 'TGZ',
			  'txt' => 'texte',
			  'xcf' => 'GIMP multi-layer',
			  'xls' => 'Excel',
			  'xml' => 'XML',
			  'zip' => 'Zip'
			  );

$tables_mime = array(
		// Images reconnues par PHP
		'jpg'=>'image/jpeg',
		'png'=>'image/png',
		'gif'=>'image/gif',

		// Autres images (peuvent utiliser le tag <img>)
		'bmp'=>'image/x-ms-bmp', // pas enregistre par IANA, variante: image/bmp
		'psd'=>'image/x-photoshop',	// pas IANA
		'tif'=>'image/tiff',

		// Multimedia (peuvent utiliser le tag <embed>)
		'aiff'=>'audio/x-aiff',
		'asf'=>'video/x-ms-asf',
		'avi'=>'video/x-msvideo',
		'mid'=>'audio/midi',
		'mng'=>'video/x-mng',
		'mov'=>'video/quicktime',
		'mp3'=>'audio/mpeg',
		'mpg'=>'video/mpeg',
		'ogg'=>'application/ogg',
		'qt' =>'video/quicktime',
		'ra' =>'audio/x-pn-realaudio',
		'ram'=>'audio/x-pn-realaudio',
		'rm' =>'audio/x-pn-realaudio',
		'swf'=>'application/x-shockwave-flash',
		'wav'=>'audio/x-wav',
		'wmv'=>'video/x-ms-wmv',

		// Documents varies
		'ai' =>'application/illustrator',
		'bz2'=>'application/x-bzip2',
		'c'  =>'text/x-csrc',
		'css'=>'text/css',
		'deb'=>'application/x-debian-package',
		'doc'=>'application/msword',
		'djvu'=>'image/vnd.djvu',
		'dvi'=>'application/x-dvi',
		'eps'=>'application/postscript',
		'gz' =>'application/x-gzip',
		'h'  =>'text/x-chdr',
		'html'=>'text/html',
		'pas'=>'text/x-pascal',
		'pdf'=>'application/pdf',
		'pgn' =>'application/x-chess-pgn',
		'ppt'=>'application/vnd.ms-powerpoint',
		'ps' =>'application/postscript',
		'rpm'=>'application/x-redhat-package-manager',
		'rtf'=>'application/rtf',
		'sdd'=>'application/vnd.stardivision.impress',
		'sdw'=>'application/vnd.stardivision.writer',
		'sit'=>'application/x-stuffit',
		'sxc'=>'application/vnd.sun.xml.calc',
		'sxi'=>'application/vnd.sun.xml.impress',
		'sxw'=>'application/vnd.sun.xml.writer',
		'tex'=>'text/x-tex',
		'tgz'=>'application/x-gtar',
		'txt'=>'text/plain',
		'xcf'=>'application/x-xcf',
		'xls'=>'application/vnd.ms-excel',
		'xml'=>'application/xml',
		'zip'=>'application/zip'
	);
?>



From stef at berlios.de  Tue Mar 29 17:28:13 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:28:13 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire lab_revisions.php,1.2,1.3 install.php3,1.2,1.3 inc_version.php3,1.4,1.5 message.php3,1.3,1.4 index.php3,1.3,1.4 messagerie.php3,1.2,1.3 lab_diff.php,1.2,1.3 naviguer.php3,1.2,1.3 inc.php3,1.2,1.3 mes_options.php3,1.2,1.3 spip_style.php3,1.4,1.5 lang_raccourcis.php3,1.2,1.3 suivi_revisions.php3,1.2,1.3
Message-ID: <200503291528.j2TFSD9Y001720@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv1655/spipcarto/ecrire

Modified Files:
	lab_revisions.php install.php3 inc_version.php3 message.php3 
	index.php3 messagerie.php3 lab_diff.php naviguer.php3 inc.php3 
	mes_options.php3 spip_style.php3 lang_raccourcis.php3 
	suivi_revisions.php3 
Log Message:
1.8PR2 CVS 20050329

Index: lab_revisions.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lab_revisions.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- lab_revisions.php	20 Feb 2005 22:19:26 -0000	1.2
+++ lab_revisions.php	29 Mar 2005 15:28:11 -0000	1.3
@@ -459,4 +459,47 @@
 	return $id_version_new;
 }
 
+// les textes "diff" ne peuvent pas passer dans propre directement,
+// car ils contiennent des <span> et <div> parfois mal places
+function propre_diff($texte) {
+
+	$span_diff = array();
+	if (preg_match_all(',</?(span|div) (class|rem)="diff-[^>]+>,', $texte, $regs, PREG_SET_ORDER)) {
+		foreach ($regs as $c => $reg)
+			$texte = str_replace($reg[0], '@@@SPIP_DIFF'.$c.'@@@', $texte);
+	}
+
+	// [ ...<span diff> -> lien ]
+	// < tag <span diff> >
+	$texte = preg_replace(',<([^>]*@@@SPIP_DIFF[0-9]+@@@),',
+		'&lt;\1', $texte);
+	# attention ici astuce seulement deux @@ finals car on doit eviter
+	# deux patterns a suivre, afin de pouvoir prendre [ mais eviter [[
+	$texte = preg_replace(',(^|[^[])[[]([^[\]]*@@@SPIP_DIFF[0-9]+@@),',
+		'\1&#91;\2', $texte);
+
+	$texte = propre($texte);
+
+	// un blockquote mal ferme peut gener l'affichage, et title plante safari
+	$texte = preg_replace(',<(/?(blockquote|title)[^>]*)>,i', '&lt;\1>', $texte);
+
+	// Dans les <cadre> c'est un peu plus complique
+	if (preg_match_all(',<textarea (.*)</textarea>,Uims', $texte, $area, PREG_SET_ORDER)) {
+		foreach ($area as $reg) {
+			$remplace = preg_replace(',@@@SPIP_DIFF[0-9]+@@@,', '**', $reg[0]);
+			if ($remplace <> $reg[0])
+				$texte = str_replace($reg[0], $remplace, $texte);
+		}
+	}
+
+	// replacer les valeurs des <span> et <div> diff-
+	if (is_array($regs))
+	foreach ($regs as $c => $reg) {
+		$texte = str_replace('@@@SPIP_DIFF'.$c.'@@@', $reg[0], $texte);
+		$GLOBALS['les_notes'] = str_replace('@@@SPIP_DIFF'.$c.'@@@', $reg[0], $GLOBALS['les_notes']);
+	}
+
+	return $texte;
+}
+
 ?>

Index: install.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/install.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- install.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ install.php3	29 Mar 2005 15:28:11 -0000	1.3
@@ -53,12 +53,33 @@
 include_ecrire ("inc_base.php3");
 define('_FILE_TMP', '_install');
 
+
+// Sur tous les formulaires on peut cliquer "return" pour passer a la suite
+define ('_VALIDE_CLAVIER', '');
+/*
+define ('_VALIDE_CLAVIER', "<script><!--
+	window.onkeypress = enterSubmit;
+	function enterSubmit(){
+		// si on appuie sur enter ou return
+		if ((event.keyCode==13) || (event.keyCode==3)) {
+			// a l'etape 1 ne pas valider formulaire var_lang
+			a = 0;
+			if ((document.forms(0).action != 'install.php3')
+			&& (document.forms(0).action != 'index.php3'))
+				a = 1;
+			document.forms(a).submit();
+		}
+	}
+// --></script>\n");
+*/
+
 //
 // Etapes de l'installation standard
 //
 
 if ($etape == 6) {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	echo "<BR><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_derniere_etape')."</B></FONT>";
 	echo "<P>";
@@ -119,6 +140,7 @@
 
 else if ($etape == 5) {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	include(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
 
@@ -171,6 +193,7 @@
 else if ($etape == 4) {
 
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	// Necessaire pour appeler les fonctions SQL wrappees
 	include_ecrire("inc_db_mysql.php3");
@@ -249,6 +272,7 @@
 else if ($etape == 3) {
 
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_choix_base')." <B>"._T('menu_aide_installation_choix_base')."</B></FONT>";
 
@@ -289,13 +313,24 @@
 		echo "<B>"._T('avis_lecture_noms_bases_1')."</B>
 		"._T('avis_lecture_noms_bases_2')."<P>";
 		if ($login_db) {
-			echo _T('avis_lecture_noms_bases_3');
-			echo "<UL>";
-			echo "<INPUT NAME=\"choix_db\" VALUE=\"".$login_db."\" TYPE=Radio id='stand' CHECKED>";
-			echo "<label for='stand'>".$login_db."</label><BR />\n";
-			echo "</UL>";
-			echo _T('info_ou')." ";
-			$checked = true;
+			// Si un login comporte un point, le nom de la base est plus
+			// probablement le login sans le point -- testons pour savoir
+			$test_base = $login_db;
+			$ok = @mysql_select_db($test_base);
+			if (!$ok) {
+				$test_base = str_replace('.', '_', $test_base);
+				$ok = @mysql_select_db($test_base);
+			}
+			
+			if ($ok) {
+				echo _T('avis_lecture_noms_bases_3');
+				echo "<UL>";
+				echo "<INPUT NAME=\"choix_db\" VALUE=\"".$test_base."\" TYPE=Radio id='stand' CHECKED>";
+				echo "<label for='stand'>".$test_base."</label><BR />\n";
+				echo "</UL>";
+				echo _T('info_ou')." ";
+				$checked = true;
+			}
 		}
 	}
 	echo "<INPUT NAME=\"choix_db\" VALUE=\"new_spip\" TYPE=Radio id='nou'";
@@ -315,6 +350,9 @@
 else if ($etape == 2) {
 
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
+
+
 
 	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_connexion_base')."</FONT>";
 
@@ -348,6 +386,7 @@
 }
 else if ($etape == 1) {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_connexion_mysql')."</FONT>";
 
@@ -405,6 +444,7 @@
 		header("Location: ../spip_test_dirs.php3");
 	else {
 		install_debut_html();
+		echo _VALIDE_CLAVIER;
 
 		echo "<p align='center'><img src='" . _DIR_IMG_PACK . "logo-spip.gif'></p>";
 		
@@ -431,6 +471,7 @@
 
 else if ($etape == 'ldap5') {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	include_local(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
 	include_ecrire('inc_meta.php3');
@@ -450,6 +491,7 @@
 
 else if ($etape == 'ldap4') {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	if (!$base_ldap) $base_ldap = $base_ldap_text;
 
@@ -510,6 +552,7 @@
 
 else if ($etape == 'ldap3') {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_chemin_acces_1')."</FONT>";
 
@@ -572,6 +615,7 @@
 
 else if ($etape == 'ldap2') {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('titre_connexion_ldap')."</FONT>";
 
@@ -605,6 +649,7 @@
 
 else if ($etape == 'ldap1') {
 	install_debut_html();
+	echo _VALIDE_CLAVIER;
 
 	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('titre_connexion_ldap')."</FONT>";
 

Index: inc_version.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_version.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc_version.php3	4 Mar 2005 10:45:01 -0000	1.4
+++ inc_version.php3	29 Mar 2005 15:28:11 -0000	1.5
@@ -68,13 +68,15 @@
 
 // Recuperer les superglobales $_GET si non definies
 // (en theorie c'est impossible depuis PHP 4.0.3, cf. track_vars)
+// et les identifier aux $HTTP_XX_VARS
 foreach (array('_GET', '_POST', '_COOKIE', '_SERVER') as $_table) {
+	$http_table_vars = 'HTTP'.$_table.'_VARS';
 	if (!is_array($GLOBALS[$_table])) {
 		$GLOBALS[$_table] = array();
 		if (is_array($GLOBALS[$http_table_vars]))
 			$GLOBALS[$_table] = & $GLOBALS[$http_table_vars];
-	} /* else
-	$GLOBALS[$http_table_vars] = & $GLOBALS[$_table]; */
+	}
+		$GLOBALS[$http_table_vars] = & $GLOBALS[$_table];
 }
 
 
@@ -246,7 +248,7 @@
 
 // creation des vignettes avec pnmscale
 // Note: plus facile a installer par FTP,
-// voir http://gallery.menalto.com/modules.php?op=modload&name=GalleryFAQ&file=index&myfaq=yes&id_cat=2
+// voir http://gallery.menalto.com/modules.php?op=modload&name=GalleryFAQ&file=index&myfaq=yes&id_cat=2#43
 $pnmscale_command = 'pnmscale';
 
 // faut-il passer les connexions MySQL en mode debug ?
@@ -336,8 +338,7 @@
 define_once('_DIR_PREFIX1', (_DIR_RESTREINT ? "" : "../"));
 define_once('_DIR_PREFIX2', _DIR_RESTREINT);
 
-// les repertoires des logos, des pieces rapportees, du CACHE et des sessions
-
+// les repertoires des logos, des documents joints, du CACHE et des sessions
 define_once('_DIR_IMG', _DIR_PREFIX1 ."IMG/");
 define_once('_DIR_DOC', _DIR_PREFIX1 ."IMG/");
 define_once('_DIR_CACHE', _DIR_PREFIX1 ."CACHE/");
@@ -346,11 +347,6 @@
 define_once('_DIR_TRANSFERT', _DIR_PREFIX2 . "upload/");
 
 
-## c'est tres bete de charger ce fichier a chaque hit sur le serveur !
-if (@file_exists(_DIR_SESSIONS . 'inc_plugins.php3')) {
-	include(_DIR_SESSIONS . 'inc_plugins.php3');
-}
-
 // exemples de redefinition possible, 
 // SOUS RESERVE QUE php.ini N'AIT PAS pas openbasedir=. !!!!!!
 // il est recommande de mettre les deux premiers en dehors de l'arbo http
@@ -396,10 +392,10 @@
 // (utilise pour les modifs de la base de donnees)
 
 // version de la base
-$spip_version = 1.812;
+$spip_version = 1.813;
 
 // version de spip
-$spip_version_affichee = "1.8 PR1 CVS";
+$spip_version_affichee = "1.8 PR2 CVS";
 
 // version de spip / tag cvs
 if (ereg('Name: v(.*) ','$Name$', $regs)) $spip_version_affichee = $regs[1];
@@ -438,9 +434,6 @@
 $flag_ImageJpeg = function_exists("ImageJpeg");
 $flag_ImagePng = function_exists("ImagePng");
 $flag_imagick = function_exists("imagick_readimage");	// http://pear.sourceforge.net/en/packages.imagick.php
-$flag_multibyte = function_exists("mb_encode_mimeheader");
-$flag_iconv = function_exists("iconv");
-$flag_strtotime = function_exists("strtotime");
 
 $flag_gd = $flag_ImageGif || $flag_ImageJpeg || $flag_ImagePng;
 $flag_revisions = ($flag_pcre AND function_exists("gzcompress"));
@@ -570,61 +563,6 @@
 	return spip_query_db($query);
 }
 
-function appliquer_fonction($lafonction, $entree) {
-
-	$sortie = $entree;
-	
-	if (isset($GLOBALS["fonctions"]["$lafonction"]["avant"])) {
-		foreach ($GLOBALS["fonctions"]["$lafonction"]["avant"] as $key => $value) {
-			if (@function_exists($value)) $sortie = $value($sortie);
-		}
-	}
-	
-	if (@function_exists($lafonction)) $sortie = $lafonction($sortie);
-
-	if (isset($GLOBALS["fonctions"]["$lafonction"]["apres"])) {
-		foreach ($GLOBALS["fonctions"]["$lafonction"]["apres"] as $key => $value) {
-			if (@function_exists($value)) $sortie = $value($sortie);
-		}
-	}	
-	return $sortie;
-}
-
-function appliquer_fonction_avant($lafonction, $entree) {
-	$sortie = $entree;
-	
-	if (isset($GLOBALS["fonctions"]["$lafonction"]["avant"])) {
-		foreach ($GLOBALS["fonctions"]["$lafonction"]["avant"] as $key => $value) {
-			if (@function_exists($value)) $sortie = $value($sortie);
-		}
-	}
-			
-	return $sortie;
-}
-
-function appliquer_fonction_apres($lafonction, $entree) {
-
-	$sortie = $entree;
-	
-	if (isset($GLOBALS["fonctions"]["$lafonction"]["apres"])) {
-		foreach ($GLOBALS["fonctions"]["$lafonction"]["apres"] as $key => $value) {
-			if (@function_exists($value)) $sortie = $value($sortie);
-		}
-	}	
-		
-	return $sortie;
-}
-
-
-// Destine a "completer" une fonction
-function completer_fonction($fonction_base, $fonction_avant="", $fonction_apres="") {
-	if (strlen($fonction_avant) > 0) 
-		$GLOBALS["fonctions"]["$fonction_base"]["avant"][] = $fonction_avant;
-		
-	if (strlen($fonction_apres) > 0) 
-		$GLOBALS["fonctions"]["$fonction_base"]["apres"][] = $fonction_apres;	
-}
-
 
 //
 // Infos de config PHP
@@ -920,7 +858,7 @@
 			// "Marie Toto <Marie at toto.com>"
 			$adresse = eregi_replace("^[^<>\"]*<([^<>\"]+)>$", "\\1", $adresse);
 			// RFC 822
-			if (!eregi('^[^()<>@,;:\\"/[:space:]]+(@([-_0-9a-z]+\.)*[-_0-9a-z]+)?$', trim($adresse)))
+			if (!eregi('^[^()<>@,;:\\"/[:space:]]+(@([-_0-9a-z]+\.)*[-_0-9a-z]+)$', trim($adresse)))
 				return false;
 		}
 		return true;

Index: message.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/message.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- message.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ message.php3	29 Mar 2005 15:28:11 -0000	1.4
@@ -280,7 +280,7 @@
 
 	if ($rv != "non") {
 	  creer_colonne_droite();	
-	  echo http_calendrier_jour($lejour,$lemois,$lannee, "col", $id_message);
+	  echo http_calendrier_jour($lejour,$lemois,$lannee, 90, $partie_cal, $echelle, $id_message);
 	}
 	debut_droite();
 

Index: index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/index.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- index.php3	3 Mar 2005 14:54:56 -0000	1.3
+++ index.php3	29 Mar 2005 15:28:11 -0000	1.4
@@ -176,7 +176,7 @@
 				"WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') ".
 					     "AND messages.rv='oui' AND messages.date_heure >='$annee_today-$mois_today-$jour_today' AND messages.date_heure < DATE_ADD('$annee_today-$mois_today-$jour_today', INTERVAL 1 DAY) AND messages.statut='publie' LIMIT 0,1"))) {
 			echo "<p />";
-			echo http_calendrier_jour($jour_today,$mois_today,$annee_today, "col");
+			echo http_calendrier_jour($jour_today,$mois_today,$annee_today, 90, $partie_cal, $echelle);
 		}
 }
 
@@ -351,40 +351,12 @@
 
 
 //
-// Verifier les boucles a mettre en relief
+// On utilise ob_start pour ne pas afficher de bloc vide (sinon tant pis)
 //
-
-$relief = false;
-
-if (!$relief) {
-	$result = spip_query("SELECT id_article FROM spip_articles AS articles WHERE statut='prop'$vos_articles LIMIT 0,1");
-
-	$relief = (spip_num_rows($result) > 0);
-}
-
-if (!$relief) {
-	$result = spip_query("SELECT id_breve FROM spip_breves WHERE statut='prop' LIMIT 0,1");
-
-	$relief = (spip_num_rows($result) > 0);
-}
-
-if (!$relief AND lire_meta('activer_syndic') != 'non') {
-	$result = spip_query("SELECT id_syndic FROM spip_syndic WHERE statut='prop' LIMIT 0,1");
-	
-	$relief = (spip_num_rows($result) > 0);
-}
-
-if (!$relief AND lire_meta('activer_syndic') != 'non' AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
-	$result = spip_query("SELECT id_syndic FROM spip_syndic WHERE syndication='off' LIMIT 0,1");
-
-	$relief = (spip_num_rows($result) > 0);
-}
-
-
-if ($relief) {
+if ($flag_ob)
+	ob_start();
+else
 	debut_cadre_couleur_foncee("",false, "", _T('texte_en_cours_validation'));
-	
-	//echo "<div class='verdana2' style='color: black;'><b>"._T('texte_en_cours_validation')."</b></div><p>";
 
 	//
 	// Les articles a valider
@@ -416,24 +388,35 @@
 	if ($connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
 		$result = spip_query ("SELECT COUNT(*) AS compte FROM spip_syndic_articles WHERE statut='dispo'");
 		if (($row = spip_fetch_array($result)) AND $row['compte'])
-			echo "<br><small><a href='sites_tous.php3'>".$row['compte']." "._T('info_liens_syndiques_1')."</a> "._T('info_liens_syndiques_2')."</small>";
+			echo "<br><small><a href='sites_tous.php3' style='color: black;'>".$row['compte']." "._T('info_liens_syndiques_1')." "._T('info_liens_syndiques_2')."</a></small>";
 	}
 
 	// Les forums en attente de moderation
 	if ($connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
 		$result = spip_query ("SELECT COUNT(*) AS compte FROM spip_forum WHERE statut='prop'");
 		if (($row = spip_fetch_array($result)) AND $row['compte']) {
-			echo "<br><small> <a href='controle_forum.php3'>".$row['compte'];
+			echo "<br><small> <a href='controle_forum.php3' style='color: black;'>".$row['compte'];
 			if ($row['compte']>1)
-				echo " "._T('info_liens_syndiques_3')."</a> "._T('info_liens_syndiques_4');
+				echo " "._T('info_liens_syndiques_3')
+				." "._T('info_liens_syndiques_4');
 			else
-				echo " "._T('info_liens_syndiques_5')."</a> "._T('info_liens_syndiques_6');
-			echo " "._T('info_liens_syndiques_7')."</small>.";
+				echo " "._T('info_liens_syndiques_5')
+				." "._T('info_liens_syndiques_6');
+			echo " "._T('info_liens_syndiques_7').".</a></small>";
 		}
 	}
 
+
+if ($flag_ob) {
+	$a = ob_get_contents();
+	ob_end_clean();
+	if ($a) {
+		debut_cadre_couleur_foncee("",false, "", _T('texte_en_cours_validation'));
+		echo $a;
+		fin_cadre_couleur_foncee();
+	}
+} else
 	fin_cadre_couleur_foncee();
-}
 
 
 if ($options == 'avancees') {

Index: messagerie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/messagerie.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- messagerie.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ messagerie.php3	29 Mar 2005 15:28:11 -0000	1.3
@@ -13,7 +13,6 @@
 
 include ("inc.php3");
 include_ecrire ("inc_acces.php3");
-include_ecrire ("inc_calendrier.php");
 
 if ($supp_dest) {
 	spip_query("DELETE FROM spip_auteurs_messages WHERE id_message=$id_message AND id_auteur=$supp_dest");
@@ -65,13 +64,22 @@
 fin_cadre_relief();
 
 
+# Affiche l'encadre "lien iCal"
 
-echo	http_calendrier_ical($connect_id_auteur);
+echo
+    debut_cadre_enfonce('',true) .
+    "<div class='verdana1'>"._T("calendrier_synchro") .
+    "<a href='synchro.php3' class='cellule-h'><table cellpadding='0' valign='middle'><tr>\n" .
+    "<td><a href='synchro.php3'><div class='cell-i'>"
+    . http_img_pack("rien.gif", '', http_style_background('synchro-24.gif', "; background-repeat: no-repeat; background-position: center center;"))
+    . "</div></a></td>\n"
+    . "<td class='cellule-h-lien'><a href='synchro.php3' class='cellule-h'>" 
+    . _T("icone_suivi_activite")
+    . "</a></td>\n</tr></table></a>\n" ."</div>" .
+    fin_cadre_enfonce(true);
 
 
 debut_droite("messagerie");
-
-
 
 
 $messages_vus = '';

Index: lab_diff.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lab_diff.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- lab_diff.php	20 Feb 2005 22:19:26 -0000	1.2
+++ lab_diff.php	29 Mar 2005 15:28:11 -0000	1.3
@@ -228,16 +228,19 @@
 		return separer_paras($texte);
 	}
 
+	// NB :  rem=\"diff-\" est un signal pour la fonction "afficher_para_modifies"
 	function ajouter($p) {
-		$this->r .= "\n\n\n<div class=\"diff-para-ajoute\" title=\""._T('diff_para_ajoute')."\">".$p."</div>";
+		$p = trim($p);
+		$this->r .= "\n\n\n<div class=\"diff-para-ajoute\" title=\""._T('diff_para_ajoute')."\">".$p."</div rem=\"diff-\">";
 	}
 	function supprimer($p_old) {
-		$this->r .= "\n\n\n<div class=\"diff-para-supprime\" title=\""._T('diff_para_supprime')."\">".$p_old."</div>";
+		$p_old = trim($p_old);
+		$this->r .= "\n\n\n<div class=\"diff-para-supprime\" title=\""._T('diff_para_supprime')."\">".$p_old."</div rem=\"diff-\">";
 	}
 	function deplacer($p, $p_old) {
 		$this->r .= "\n\n\n<div class=\"diff-para-deplace\" title=\""._T('diff_para_deplace')."\">";
-		$this->r .= $this->_diff($p, $p_old);
-		$this->r .= "</div>";
+		$this->r .= trim($this->_diff($p, $p_old));
+		$this->r .= "</div rem=\"diff-\">";
 	}
 	function comparer($p, $p_old) {
 		$this->r .= "\n\n\n".$this->_diff($p, $p_old);
@@ -276,13 +279,13 @@
 	}
 
 	function ajouter($p) {
-		$this->r .= "<span class=\"diff-ajoute\" title=\""._T('diff_texte_ajoute')."\">".$p."</span>";
+		$this->r .= "<span class=\"diff-ajoute\" title=\""._T('diff_texte_ajoute')."\">".$p."</span rem=\"diff-\">";
 	}
 	function supprimer($p_old) {
-		$this->r .= "<span class=\"diff-supprime\" title=\""._T('diff_texte_supprime')."\">".$p_old."</span>";
+		$this->r .= "<span class=\"diff-supprime\" title=\""._T('diff_texte_supprime')."\">".$p_old."</span rem=\"diff-\">";
 	}
 	function deplacer($p, $p_old) {
-		$this->r .= "<span class=\"diff-deplace\" title=\""._T('diff_texte_deplace')."\">".$this->_diff($p, $p_old)."</span>";
+		$this->r .= "<span class=\"diff-deplace\" title=\""._T('diff_texte_deplace')."\">".$this->_diff($p, $p_old)."</span rem=\"diff-\">";
 	}
 	function comparer($p, $p_old) {
 		$this->r .= $this->_diff($p, $p_old);
@@ -350,10 +353,10 @@
 	}
 
 	function ajouter($p) {
-		$this->r .= "<span class=\"diff-ajoute\" title=\""._T('diff_texte_ajoute')."\">".$p."</span> ";
+		$this->r .= "<span class=\"diff-ajoute\" title=\""._T('diff_texte_ajoute')."\">".$p."</span rem=\"diff-\"> ";
 	}
 	function supprimer($p_old) {
-		$this->r .= "<span class=\"diff-supprime\" title=\""._T('diff_texte_supprime')."\">".$p_old."</span> ";
+		$this->r .= "<span class=\"diff-supprime\" title=\""._T('diff_texte_supprime')."\">".$p_old."</span rem=\"diff-\"> ";
 	}
 	function comparer($p, $p_old) {
 		$this->r .= $p;

Index: naviguer.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/naviguer.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- naviguer.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ naviguer.php3	29 Mar 2005 15:28:11 -0000	1.3
@@ -65,10 +65,7 @@
 				$fid = $logo[2];
 				$hash = calculer_action_auteur ("reduire $w $h");
 
-				$les_enfants.= "<img src='../spip_image_reduite.php3?img="._DIR_IMG."$fichier&taille_x=$w&taille_y=$h&hash=$hash&hash_id_auteur=$connect_id_auteur' width='$w' height='$h' align='right' style='margin-right: -6px; margin-top: -6px;' />";
-//				$les_enfants.= "<div style='position: absolute; $spip_lang_right: 0px; top: 0px; width: ".$w."px;'><img src='../spip_image_reduite.php3?img="._DIR_IMG."$fichier&taille_x=$w&taille_y=$h&hash=$hash&hash_id_auteur=$connect_id_auteur' width='$w' height='$h' /></div>";
-//				$les_enfants.= "<img src='" . _DIR_IMG_PACK . "rien.gif' width='$w' height='$h' align='$spip_lang_right' />";
-				
+				$les_enfants.= "<img src='../spip_image_reduite.php3?img="._DIR_IMG."$fichier&taille_x=$w&taille_y=$h&hash=$hash&hash_id_auteur=$connect_id_auteur' width='$w' height='$h' align='$spip_lang_right' style='margin-$spip_lang_right: -6px; margin-top: -6px;' />";
 			}
 		}
 
@@ -379,7 +376,7 @@
 
 if ($id_rubrique > 0 AND $flag_editable) {
 	echo "<td><img src='" . _DIR_IMG_PACK . "rien.gif' alt='' width=5></td>\n";
-	echo "<td  align='right' valign='top'>";
+	echo "<td  align='$spip_lang_right' valign='top'>";
 	icone(_T('icone_modifier_rubrique'), "rubriques_edit.php3?id_rubrique=$id_rubrique&retour=nav", $ze_logo, "edit.gif");
 	echo "</td>";
 }
@@ -474,7 +471,7 @@
 if (strlen($les_enfants2) > 0) echo "<p>";
 echo "</td></tr>";
 
-echo "<tr><td style='text-align: right;' valign='bottom'><div align='right'>";
+echo "<tr><td style='text-align: $spip_lang_right;' valign='bottom'><div align='$spip_lang_right'>";
 if ($flag_editable) {
 	if ($id_rubrique == "0") icone(_T('icone_creer_rubrique'), "rubriques_edit.php3?new=oui&retour=nav", "secteur-24.gif", "creer.gif");
 	else  icone(_T('icone_creer_sous_rubrique'), "rubriques_edit.php3?new=oui&retour=nav&id_parent=$id_rubrique", "rubrique-24.gif", "creer.gif");
@@ -587,7 +584,7 @@
 	"WHERE statut=\"publie\" AND id_rubrique='$id_rubrique' ORDER BY date DESC", true);
 
 if ($id_rubrique > 0){
-	echo "<div align='right'>";
+	echo "<div align='$spip_lang_right'>";
 	icone(_T('icone_ecrire_article'), "articles_edit.php3?id_rubrique=$id_rubrique&new=oui", "article-24.gif", "creer.gif");
 	echo "</div><p>";
 }
@@ -599,7 +596,7 @@
 $activer_breves=lire_meta("activer_breves");
 
 if ($id_parent == "0" AND $id_rubrique != "0" AND $activer_breves!="non"){
-	echo "<div align='right'>";
+	echo "<div align='$spip_lang_right'>";
 	icone(_T('icone_nouvelle_breve'), "breves_edit.php3?id_rubrique=$id_rubrique&new=oui", "breve-24.gif", "creer.gif");
 	echo "</div><p>";
 }
@@ -619,7 +616,7 @@
 		$link->addVar('target', 'sites.php3');
 		$link->addVar('redirect', $clean_link->getUrl());
 	
-		echo "<div align='right'>";
+		echo "<div align='$spip_lang_right'>";
 		icone(_T('info_sites_referencer'), $link->getUrl(), "site-24.gif", "creer.gif");
 		echo "</div><p>";
 	}

Index: inc.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc.php3	29 Mar 2005 15:28:11 -0000	1.3
@@ -11,7 +11,10 @@
 \***************************************************************************/
 
 
-include ("inc_version.php3");
+if (!defined('_ECRIRE_INC_VERSION')) {
+	include ("inc_version.php3");
+}
+
 include_ecrire("inc_auth.php3");
 include_ecrire("inc_presentation.php3");
 include_ecrire("inc_calendrier.php");
@@ -224,7 +227,13 @@
 			case 'valid_forum':
 				changer_statut_forum($id_controle_forum, 'publie');
 				break;
+			// nb : les forums prives (privrac ou prive), une fois effaces
+			// (privoff), ne sont pas revalidables ; le forum d'admin (privadm)
+			// n'est pas effacable
 		}
+
+		if ($redirect)
+			redirige_par_entete($redirect);
 	}
 }
 

Index: mes_options.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/mes_options.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- mes_options.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ mes_options.php3	29 Mar 2005 15:28:11 -0000	1.3
@@ -7,6 +7,57 @@
 //////////////////////////////////////////////////
 //////////////////////////////////////////////////
 //////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//FILTRES
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+
+function worldfileWidth($callage){	
+	$tabcallage=worldfile2array($callage);
+	return intval($tabcallage['bottom_right']['x']-$tabcallage['top_left']['x']);
+}
+function worldfileHeight($callage){	
+	$tabcallage=worldfile2array($callage);
+	return intval($tabcallage['bottom_right']['y']-$tabcallage['top_left']['y']);
+}
+function worldfileULX($callage){
+	$tabcallage=worldfile2array($callage);
+	return $tabcallage['bottom_right']['x'];
+}
+function worldfileULY($callage){
+	$tabcallage=worldfile2array($callage);
+	return $tabcallage['bottom_right']['y']*-1;
+}
+function worldfileLRX($callage){
+	$tabcallage=worldfile2array($callage);
+	return $tabcallage['top_left']['x'];
+}
+function worldfileLRY($callage){
+	$tabcallage=worldfile2array($callage);
+	return $tabcallage['top_left']['y'];
+}
+function getPropMapHeight($callage, $width){
+	$tabcallage=worldfile2array($callage);
+	// Calcul d'une hauteur relative ? un callage (proportion)
+	return $width*($tabcallage['bottom_right']['y']-$tabcallage['top_left']['y'])/($tabcallage['bottom_right']['x']-$tabcallage['top_left']['x']);
+}
+
+
+function worldfile2array($callage){	
+	$tabcallage['shape']=substr($callage,0,strpos($callage,"("));
+	
+	$coordpair = explode(',',substr($callage,strpos($callage,"(")+1,-1));
+	$UL = explode (' ', $coordpair[0]);
+	$LR = explode (' ', $coordpair[1]);
+	
+	$tabcallage['top_left']['x']=$UL[0];
+	$tabcallage['top_left']['y']=$UL[1];
+	$tabcallage['bottom_right']['x']=$LR[0];
+	$tabcallage['bottom_right']['y']=$LR[1];
+	
+	return $tabcallage;
+}
 
 //////////////////////////////////////////////////
 //////////////////////////////////////////////////
@@ -159,4 +210,9 @@
 	$boucle->from[] =  "spip_carto_objets AS " . $boucle->type_requete;
 	return calculer_boucle($id_boucle, $boucles); 
 }
+function avant_propre($texte) {
+	include_ecrire('plugins/plug_carto.php');
+    return avant_typo_carto($texte);
+}
+
 ?>

Index: spip_style.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/spip_style.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- spip_style.php3	4 Mar 2005 12:05:39 -0000	1.4
+++ spip_style.php3	29 Mar 2005 15:28:11 -0000	1.5
@@ -23,14 +23,21 @@
 	@Header ("Content-Type: text/css; charset=iso-8859-1");
 
 	// parano XSS
-	eregi("^([#0-9a-z]*).*-([#0-9a-z]*).*-([0-9a-z]*).*-([0-9a-z]*).*", "$couleur_claire-$couleur_foncee-$left-$right", $regs);
-	list (,$couleur_claire,$couleur_foncee,$left,$right) = $regs;
+	eregi("^([#0-9a-z]*).*-([#0-9a-z]*).*-([0-9a-z]*).*", "$couleur_claire-$couleur_foncee-$left", $regs);
+	list (,$couleur_claire,$couleur_foncee,$left) = $regs;
+
+	// Sommes-nous en rtl ou ltr ?
 	$ltr = ($left == 'left');
-	$rtl = ($right == 'left');
-	
-	if ($left == 'left') $_rtl = "";
-	else $_rtl = "_rtl";
-	
+	if ($ltr) {
+		$left = 'left';
+		$right = 'right';
+		$_rtl = '';
+	} else {
+		$left = 'right';
+		$right = 'left';
+		$_rtl = '_rtl';
+	}
+
 	// Envoyer la feuille de style
 	if (!isset($couleur_claire))
 		$couleur_claire = "#EDF3FE";
@@ -851,21 +858,6 @@
 
 
 /*
- * Dessus-dessous calendrier
- */
- 
-.dessous {
-	z-index : 1;
-	-moz-opacity: 0.6; filter: alpha(opacity=60);
-}
-.dessus, .dessous.hover {
-	z-index : 3; 
-	-moz-opacity: 1; filter: alpha(opacity=100);
-	cursor: pointer;
-}
-
-
-/*
 * Cadre couleur foncee
 */
 
@@ -1227,46 +1219,6 @@
 	z-index: 1;
 }
 
-/*
- * Styles du calendrier
- */
- 
-div.navigation-calendrier {
-	background-color: <?php echo $couleur_foncee; ?>;
-	color: white;
-	font-family: verdana, arial, sans,sans-serif;
-	font-size: 14px;
-	padding: 2px;
-	-moz-border-radius-topleft: 8px;
-	-moz-border-radius-topright: 8px;
-}
-
-div.navigation-calendrier img {
-	border: 0px;
-	vertical-align: middle;
-	margin: 1px;
-}
-
-.navigation-bouton-desactive {
-	-moz-opacity: 0.3;
-	filter: alpha(opacity=30);
-}
-
-a.calendrier-annee {
-	background-color: #aaaaaa;
-	padding: 3px;
-	margin: 1px;
-	font-family: verdana, arial, sans,sans-serif;
-	font-size: 10px;
-	font-weight: bold;
-	color: white;
-	-moz-border-radius: 5px;
-}
-a.calendrier-annee:hover {
-	color: black;
-	background-color: white;
-}
-
 
 /*
  * Styles generes par les raccourcis de mis en page
@@ -1283,18 +1235,21 @@
 }
 
 
-a.spip_in  {
+a.spip_in {
 	border-bottom: 1px dashed;
 }
 a.spip_out {
-	background: url(<?php echo http_img_pack('spip_out.gif'), ')', $right; ?> center no-repeat;
+	background: url(<?php echo http_img_pack('spip_out.gif'), ') ', $right; ?> center no-repeat;
 	padding-<?php echo $right; ?>: 10px;
 	border-bottom: 1px solid;
 }
+a.spip_url {
+}
+
+
 a.spip_note {
 	background-color:#eeeeee;
 }
-a.spip_url {}
 a.spip_glossaire:hover {text-decoration: underline overline;}
 
 .spip_recherche {

Index: lang_raccourcis.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lang_raccourcis.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- lang_raccourcis.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ lang_raccourcis.php3	29 Mar 2005 15:28:11 -0000	1.3
@@ -35,7 +35,7 @@
 while ($f = readdir($d)) {
 	if (ereg('^([a-z_]+)\.php3?$', $f, $regs))
 		$nom_module = $regs[1];
-		if (!ereg('^spip\_', $nom_module) && ereg("^([a-zA-Z]+)\_".$spip_lang."$", $nom_module, $reps))
+		if (!ereg('^(spip|ecrire)\_', $nom_module) && ereg("^([a-zA-Z]+)\_".$spip_lang."$", $nom_module, $reps))
 			$modules[] = $reps[1];
 }
 closedir($d);

Index: suivi_revisions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/suivi_revisions.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- suivi_revisions.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ suivi_revisions.php3	29 Mar 2005 15:28:11 -0000	1.3
@@ -40,6 +40,9 @@
 
 echo "<p>";
 
+
+debut_cadre_relief();
+
 echo "<div class='arial11'><ul>";
 echo "<p>";
 
@@ -91,7 +94,10 @@
 }
 
 
-echo "</ul></div>";
+echo "</ul></div>\n";
+
+fin_cadre_relief();
+
 
 
 //////////////////////////////////////////////////////



From stef at berlios.de  Tue Mar 29 17:29:39 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:29:39 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire/plugins plug_carto.php,1.1,1.2
Message-ID: <200503291529.j2TFTd9Y001925@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/plugins
In directory sheep:/tmp/cvs-serv1901/spipcarto/ecrire/plugins

Modified Files:
	plug_carto.php 
Log Message:
1.8PR2 CVS 20050329

Index: plug_carto.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/plugins/plug_carto.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- plug_carto.php	20 Feb 2005 22:13:32 -0000	1.1
+++ plug_carto.php	29 Mar 2005 15:29:37 -0000	1.2
@@ -70,6 +70,6 @@
 	return $texte;
 }
 
-completer_fonction("propre", "avant_typo_carto", "");
+//completer_fonction("propre", "avant_typo_carto", "");
 
 ?>



From stef at berlios.de  Tue Mar 29 17:29:53 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:29:53 +0200
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_svg2.html,NONE,1.1
Message-ID: <200503291529.j2TFTr9Y001973@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv1947/spipcarto/squelettes

Added Files:
	carto_svg2.html 
Log Message:
1.8PR2 CVS 20050329

--- NEW FILE: carto_svg2.html ---
<BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
<embed src="carto_svgfile#ID_CARTO_CARTE.svg" width="600px" height="400px" type="image/svg+xml" name="emap"/>
</BOUCLE_carte>



From stef at berlios.de  Tue Mar 29 17:30:05 2005
From: stef at berlios.de (stef at berlios.de)
Date: Tue, 29 Mar 2005 17:30:05 +0200
Subject: [Spip-carto-cvs] spipcarto/squelettes carto_svgfile.html,1.3,1.4
Message-ID: <200503291530.j2TFU59Y002055@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/squelettes
In directory sheep:/tmp/cvs-serv2027/spipcarto/squelettes

Modified Files:
	carto_svgfile.html 
Log Message:
1.8PR2 CVS 20050329

Index: carto_svgfile.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/squelettes/carto_svgfile.html,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- carto_svgfile.html	1 Mar 2005 17:38:26 -0000	1.3
+++ carto_svgfile.html	29 Mar 2005 15:30:03 -0000	1.4
@@ -2,7 +2,7 @@
 <BOUCLE_carte(CARTO_CARTES){id_carto_carte}>
 	<svg viewBox="[(#CALLAGE|worldfileLRX)] [(#CALLAGE|worldfileLRY)] [(#CALLAGE|worldfileWidth)] [(#CALLAGE|worldfileHeight)]" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve">
 		<defs>
-		 <linearGradient id="MyGradient" gradientTransform="rotate(45)">
+		 <linearGradient id="myGradient" gradientTransform="rotate(45)">
 		  <stop offset="0%" style="stop-color:white"/>
 		  <stop offset="30%" style="stop-color:red"/>
 		  <stop offset="100%" style="stop-color:black"/>
@@ -16,8 +16,7 @@
 		 
 		<g id="mainlayer">
 		 	<BOUCLE_objets(CARTO_OBJETS){id_carto_carte=#ID_CARTO_CARTE}>
-		  		<a xlink:href="#URL_OBJET" alt="#TITRE"><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVG,#CALLAGE})] style="fill:url(#MyGradient);opacity:.7;"/></a>
-				<!--<a xlink:href="#URL_OBJET" alt="#TITRE"><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVG,#CALLAGE})] style="fill:none;stroke:black;opacity:.7;"/></a>-->
+		  		<a xlink:href="#URL_OBJET" alt="#TITRE"><[(#GEOMETRIE|wkt2shape{SVG})] [(#GEOMETRIE|wkt2coords{SVG,#CALLAGE})] style="fill:url(#myGradient);opacity:.7;"/></a>
 		 	</BOUCLE_objets>
 		</g>
 	</svg>



From stef at berlios.de  Thu Mar 31 17:57:22 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 31 Mar 2005 17:57:22 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_carto.php3,1.9,1.10 carte_edit.php3,1.8,1.9
Message-ID: <200503311557.j2VFvM9Y026826@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv26775/spipcarto/ecrire

Modified Files:
	inc_carto.php3 carte_edit.php3 
Log Message:
dessin des objets sur l'interface DHTML

Index: inc_carto.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_carto.php3,v
retrieving revision 1.9
retrieving revision 1.10
diff -u -d -r1.9 -r1.10
--- inc_carto.php3	29 Mar 2005 15:27:12 -0000	1.9
+++ inc_carto.php3	31 Mar 2005 15:57:20 -0000	1.10
@@ -146,6 +146,7 @@
     }
     dhtmlDivs += \'<div id="myCanvasDiv" class="dhtmldiv"></div>\';
     dhtmlDivs += \'<div id="myCanvas2Div" class="dhtmldiv"></div>\';
+    dhtmlDivs += \'<div id="myCanvas3Div" class="dhtmldiv"></div>\';
     dhtmlDivs += \'<div id="mainDHTMLDiv" class="dhtmldiv"></div>\';
     dhtmlDivs += \'<div id="diplayContainerDiv" class="dhtmldiv">\';
     dhtmlDivs += \'<table border="0" width="100%" cellspacing="0" cellpadding="0"><tr>\';
@@ -154,6 +155,16 @@
     dhtmlDivs += \'</tr></table></div>\';
     document.write(dhtmlDivs);
                   
+    var polys= new Array();
+    var polycount= 0;
+    var rects= new Array();
+    var rectcount= 0;
+    var lines= new Array();
+    var linecount= 0;
+    var circles= new Array();
+    var circlecount= 0;
+    var points= new Array();
+    var pointcount= 0;
     function dboxInit()
     {
       myform = document.forms[\'carto_form\'];
@@ -182,127 +193,13 @@
   
           
       dhtmlBox.initialize();
+	  for (var i=0; i<polys.length; i++) dhtmlBox.drawPoly(polys[i],1);
+	  for (var i=0; i<rects.length; i++) dhtmlBox.drawRect(rects[i],1);
+	  for (var i=0; i<lines.length; i++) dhtmlBox.drawLine(lines[i],1);
+	  for (var i=0; i<circles.length; i++) dhtmlBox.drawCircle(circles[i],1);
+	  for (var i=0; i<points.length; i++) dhtmlBox.drawPoint(points[i],1);
     }
-      
-    window.onload = function() {
-      dboxInit();
-      xHide(xGetElementById(\'mapAnchorDiv\')); 
-    }
-	/*]]>*/
-  </script>
-    <input type="hidden" name="id_carte" value="'.$id_carte.'"/>
-	<input type="hidden" name="retour" value="'.$retour.'"/>
-	<input type="hidden" name="selection_type" />
-	<input type="hidden" name="selection_coords" />
-	<div id="mapAnchorDiv" style="position:relative; width:'.$width.'px; height:'.$height.'px;"> 
-     <table>
-      <tr> 
-       <td align="center" valign="middle" width="'.$width.'px" height="'.$height.'px">
-		<div id="loadbar">Loading message</div>
-	   </td>
-      </tr>
-     </table>
-    </div>
-   </td>
-  </tr>
-  <tr>
-   <td> 
-    <input type="radio" name="tool" value="rectangle,submit,crossHair,zoom_in"  id="zoom_in" onclick="dhtmlBox.changeTool()" />
-          zoom_in<br />
-   </td>
-   <td>
-    <input type="radio" name="tool" value="point,submit,crossHair,zoom_out"  id="zoom_out" onclick="dhtmlBox.changeTool()" />
-          zoom out<br />
-   </td>
-   <td>
-    <input type="radio" name="tool" value="pan,submit,move,pan"  id="pan" onclick="dhtmlBox.changeTool()" />
-          pan<br />
-   </td>
-   <td>
-    <input type="radio" name="tool" value="rectangle,submit,help,query"  id="query" onclick="dhtmlBox.changeTool()" />
-          query<br />
-   </td>
-   <td>
-    <input type="radio" name="tool" value="point,submit,crossHair,point"   id="point" onclick="dhtmlBox.changeTool()" />
-          point submit<br />
-   </td>
-   <td>
-    <input type="radio" name="tool" value="line,submit,crossHair,line"   id="line" onclick="dhtmlBox.changeTool()" />
-          line submit<br />
-          </td><td><input type="radio" name="tool" value="polygon,submit,crossHair,polygon"   checked="checked"  id="polygon" onclick="dhtmlBox.changeTool()" />
-          polygon submit<br />
-   </td>
-  </tr>
- </table>
-</form>';
-	return $returned;
-}
-function afficher_interface($id_carte,$retour,$callage) {
-	
-	$widthgeo=$callage['bottom_right']['x']-$callage['top_left']['x'];
-	$heightgeo=$callage['bottom_right']['y']-$callage['top_left']['y'];
-	
-	$width=$widthgeo;
-	$height=$heightgeo;
-	$returned='<script type="text/javascript" src="js/x_core_nn4.js"></script>
-<script type="text/javascript" src="js/x_dom_nn4.js"></script>
-<script type="text/javascript" src="js/x_event_nn4.js"></script>
-<script type="text/javascript" src="js/navTools.js"></script>
-<script type="text/javascript" src="js/graphTools.js"></script>
-<form method="get" action="#nouveau_objet" name="carto_form">
- <table border="1">
-  <tr> 
-   <td colspan="7">
-<script type="text/javascript">
-/*<![CDATA[*/ 
-    var dhtmlDivs = new String();
-    document.image = new Image;
-    document.image.src = \''.$fichier.'\';
-       dhtmlDivs += \'<div id="mapImageDiv" class="dhtmldiv" style="position: absolute;visibility:hidden;z-index: 1;">\';      
-      dhtmlDivs +=\'<embed src="../carto_svgfile'.$id_carte.'.svg" width="'.$width.'px" height='.$height.'px" type="image/svg+xml" name="emap"/>\';
-	  dhtmlDivs +=\'</div>\';
-  
-    
-    dhtmlDivs += \'<div id="myCanvasDiv" class="dhtmldiv"></div>\';
-    dhtmlDivs += \'<div id="myCanvas2Div" class="dhtmldiv"></div>\';
-    dhtmlDivs += \'<div id="mainDHTMLDiv" class="dhtmldiv"></div>\';
-    dhtmlDivs += \'<div id="diplayContainerDiv" class="dhtmldiv">\';
-    dhtmlDivs += \'<table border="0" width="100%" cellspacing="0" cellpadding="0"><tr>\';
-    dhtmlDivs += \'<td width="50%"><div id="displayCoordsDiv" class="dhtmlDisplay"></div></td>\';
-    dhtmlDivs += \'<td align="right" width="50%"><div id="displayMeasureDiv" class="dhtmlDisplay"></div></td>\';
-    dhtmlDivs += \'</tr></table></div>\';
-     document.write(dhtmlDivs);
-                  
-    function dboxInit()
-    {
-      myform = document.forms[\'carto_form\'];
-      // DHTML drawing and navigating tools
-      dhtmlBox = new dhtmlBox();
-          
-      //DHTML parameters
-      dhtmlBox.dispPos = \'bottom\';
-      dhtmlBox.thickness = 2;
-      dhtmlBox.cursorsize = 4;
-      dhtmlBox.jitter = 10; // minimum size of a box dimension
-      dhtmlBox.d2pts = 3;   // the distance between two points (measure tools);
-      dhtmlBox.nbPts = 5;   // number of points for the last vertex
-      
-      // map units values
-	  // dynamically given by the server
-      dhtmlBox.mapHeight = '.$height.';
-      dhtmlBox.boxx = 470000;
-      dhtmlBox.boxy = 46300;
-      dhtmlBox.pixel_size = 924.83333333334;
-      dhtmlBox.dist_msg = \'Approx. distance: \';
-      dhtmlBox.dist_unit = \' m.\';
-      dhtmlBox.surf_msg = \'Approx. surface: \';
-      dhtmlBox.surf_unit = \' m??.\';
-      dhtmlBox.coord_msg = \'Coords (m): \';
-  
-          
-      dhtmlBox.initialize();
-    }
-      
+
     window.onload = function() {
       dboxInit();
       xHide(xGetElementById(\'mapAnchorDiv\')); 
@@ -356,6 +253,7 @@
 </form>';
 	return $returned;
 }
+
 function carte_editable() {
 	return true;
 }

Index: carte_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/carte_edit.php3,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -d -r1.8 -r1.9
--- carte_edit.php3	29 Mar 2005 15:27:12 -0000	1.8
+++ carte_edit.php3	31 Mar 2005 15:57:20 -0000	1.9
@@ -152,8 +152,7 @@
 if ($url_carte && ($new!="oui")) icone_horizontale( _T('previsualiser'), "../carto.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
 if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec logos'), "../carto_logo.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
 if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec liens'), "../carto_lien.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
-if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec svg'), "../carto_svg.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
-//if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec svg'), "../carto_svg2.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
+if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec svg'), "../carto_svg2.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
 if ($url_carte && ($new!="oui")) icone_horizontale( _L('pr?visualiser avec geosvg'), "../carto_geosvg.php3?id_carto_carte=".$id_carte."&var_mode=recalcul", "racine-24.gif", "rien.gif");
 
 echo "</div>\n";
@@ -208,6 +207,7 @@
 		
 		echo debut_block_visible("dhtml_carte");
 				
+		
 		//echo "<div style='margin: 10px; padding: 10px; border: 1px dashed $couleur_foncee;'>";
 		
 		//remplacer id par appel ? spip_carte
@@ -218,11 +218,7 @@
 		$tabcallage=worldfile2array($callage);
    	
    		echo afficher_carte_interface($id_carte,$retour,$lurl_carte,$tabcallage);
-		
-		//$lurl_carte="../carto_svgfile".$id_carte.".svg";
-		//echo afficher_carte_interface($id_carte,$retour,$lurl_carte,$tabcallage);
-		//echo afficher_interface($id_carte,$retour,$tabcallage);
-		
+				
 		echo fin_block();
 		echo "</div>\n";
 		
@@ -405,6 +401,49 @@
 				echo "<input type='submit' name='Valider' value='"._T('bouton_valider')."' class='fondo verdana2'></div>\n";
 				echo "</div>\n";
 				echo "</form>";
+				
+				$geoArray= explode(',',substr($geometrie,strpos($geometrie,"(")+1,-1));
+				echo "<script type=\"text/javascript\">/*<![CDATA[*/";
+		  		echo "geoArray_".$id_objet."=new Array();\n";
+		  		for ($i=0; $i<count($geoArray) ; $i++) {
+					$pointArray=explode(' ',$geoArray[$i]);
+					echo "var geoPoint_".$id_objet."_".$i."=new Array(".$pointArray[0].",".$pointArray[1].");\n";
+					echo "geoArray_".$id_objet."[".$i."]=geoPoint_".$id_objet."_".$i.";\n";
+		  		}
+		  		$geoTypex= explode('(',$geometrie);
+		  		$geoType= $geoTypex[0];
+//		  		echo "alert('".$geometrie."=>".$geoType."');\n";
+		  		switch ($geoType){
+		  			case 'circle':
+		  			case 'CIRCLE':
+		  						$geoType='circle';
+		  						break;
+		  			case 'rect':
+		  			case 'RECT':
+		  			case 'rectangle':
+		  			case 'RECTANGLE':
+		  						$geoType='rect';
+		  						break;
+		  			case 'line':
+		  			case 'LINE':
+		  						$geoType='line';
+		  						break;
+		  			case 'point':
+		  			case 'POINT':
+		  						$geoType='point';
+		  						break;
+					case 'poly':
+		  			case 'POLY':
+		  			case 'polygon':
+		  			case 'POLYGON':
+		  			default:
+		  						$geoType='poly';
+		  						break;
+		  		}
+				
+				echo $geoType."s[".$geoType."count++]=geoArray_".$id_objet.";";
+      			echo "</script>";
+				
 				
 				if ($flag_mots!='non' AND $options == 'avancees') {
 					$tab_id['id_carte']=$id_carte;



From stef at berlios.de  Thu Mar 31 17:57:22 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 31 Mar 2005 17:57:22 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire/js navTools.js,1.1,1.2
Message-ID: <200503311557.j2VFvM9Y026822@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/js
In directory sheep:/tmp/cvs-serv26775/spipcarto/ecrire/js

Modified Files:
	navTools.js 
Log Message:
dessin des objets sur l'interface DHTML

Index: navTools.js
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/js/navTools.js,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- navTools.js	20 Feb 2005 22:05:59 -0000	1.1
+++ navTools.js	31 Mar 2005 15:57:20 -0000	1.2
@@ -7,6 +7,7 @@
   this.image = xGetElementById("mapImageDiv");
   this.canvas = xGetElementById("myCanvasDiv");
   this.canvas2 = xGetElementById("myCanvas2Div");
+  this.canvas3 = xGetElementById("myCanvas3Div");
   this.displayContainer = xGetElementById("diplayContainerDiv");
   this.displayCoords = xGetElementById("displayCoordsDiv");
   this.displayMeasure = xGetElementById("displayMeasureDiv");
@@ -22,6 +23,7 @@
 function dhtmlBox_initialize() {
   jg = new jsGraphics(this.canvas.id); // a drawing canvas for the lines and points
   jg2 = new jsGraphics(this.canvas2.id); // a drawing canvas for the last moving vertex
+  jg3 = new jsGraphics(this.canvas3.id); // a drawing canvas for the last moving vertex
 
   dhtmlBox.changeTool() //make the previous tool selected the current one
   
@@ -54,6 +56,9 @@
 
   xClip(this.target,0,this.width,this.height,0)
   xClip(this.image,0,this.width,this.height,0)
+  xResizeTo(this.canvas3,this.width,this.height)
+  xMoveTo(this.canvas3,xPageX(this.anchor),xPageY(this.anchor))
+  
 }
 
 // the mouse events are managed in this function according to the mapping tool selected
@@ -144,6 +149,41 @@
   }
 }
 
+function dhtmlBox_drawPoly(points_array,d) {
+	
+	for (var i=0; i<points_array.length - 1 ; i++) {
+		jg3.drawLinePts(points_array[i][0], this.height-points_array[i][1], points_array[i+1][0], this.height-points_array[i+1][1], d);
+	}
+	jg3.drawLinePts(points_array[i][0],this.height-points_array[i][1],points_array[0][0],this.height-points_array[0][1],d);
+	jg3.paint();	
+}
+function dhtmlBox_drawRect(points_array,d) {
+	jg3.drawLinePts(points_array[0][0],this.height-points_array[0][1],points_array[0][0],this.height-points_array[1][1],d);
+	jg3.drawLinePts(points_array[0][0],this.height-points_array[1][1],points_array[1][0],this.height-points_array[1][1],d);
+	jg3.drawLinePts(points_array[1][0],this.height-points_array[1][1],points_array[1][0],this.height-points_array[0][1],d);
+	jg3.drawLinePts(points_array[1][0],this.height-points_array[0][1],points_array[0][0],this.height-points_array[0][1],d);
+		jg3.paint();
+}
+function dhtmlBox_drawLine(points_array,d) {
+	for (var i=0; i<points_array.length - 1 ; i++) {
+		jg3.drawLinePts(points_array[i][0], this.height-points_array[i][1], points_array[i+1][0], this.height-points_array[i+1][1], d);
+	}
+	jg3.paint();
+}
+function dhtmlBox_drawCircle(points_array,d) {
+//TODO : implement !
+		jg3.paint();
+}
+function dhtmlBox_drawPoint(points_array,d) {
+	jg3.drawLinePts(points_array[0][0]-2,this.height-points_array[0][1],points_array[0][0]+2,this.height-points_array[0][1],d);
+	jg3.drawLinePts(points_array[0][0],this.height-points_array[0][1]-2,points_array[0][0],this.height-points_array[0][1]+2,d);
+	jg3.paint();
+}
+
+function dhtmlBox_clear() {
+	jg3.clear();
+}
+
 function dhtmlBox_mousemove(evt) {
   var e = new xEvent(evt);
 
@@ -424,3 +464,8 @@
 dhtmlBox.prototype.changeTool = dhtmlBox_changetool
 dhtmlBox.prototype.submitForm = dhtmlBox_submitForm
 dhtmlBox.prototype.measureShape = dhtmlBox_measureShape
+dhtmlBox.prototype.drawPoly= dhtmlBox_drawPoly
+dhtmlBox.prototype.drawLine= dhtmlBox_drawLine
+dhtmlBox.prototype.drawRect= dhtmlBox_drawRect
+dhtmlBox.prototype.drawPoint= dhtmlBox_drawPoint
+dhtmlBox.prototype.clear= dhtmlBox_clear



From stef at berlios.de  Thu Mar 31 23:18:09 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 31 Mar 2005 23:18:09 +0200
Subject: [Spip-carto-cvs] spipcarto/ecrire md5.js,1.2,1.3 inc_import.php3,1.3,1.4 inc_version.php3,1.5,1.6 inc_lab.php,1.2,1.3 inc_lang.php3,1.4,1.5 index.php3,1.4,1.5 inc_texte.php3,1.4,1.5 inc_meta.php3,1.2,1.3 articles_versions.php3,1.3,1.4 statistiques_visites.php3,1.2,1.3 inc_forum.php3,1.3,1.4 presentation.js,1.1,1.2 pclzip.lib.php,1.2,1.3 inc_math.php3,1.2,1.3 calendrier.css,1.1,1.2 inc_calendrier.php,1.5,1.6
Message-ID: <200503312118.j2VLI99Y010158@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv10067/spipcarto/ecrire

Modified Files:
	md5.js inc_import.php3 inc_version.php3 inc_lab.php 
	inc_lang.php3 index.php3 inc_texte.php3 inc_meta.php3 
	articles_versions.php3 statistiques_visites.php3 
	inc_forum.php3 presentation.js pclzip.lib.php inc_math.php3 
	calendrier.css inc_calendrier.php 
Log Message:
1.8PR3 CVS 20050331

Index: md5.js
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/md5.js,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- md5.js	20 Feb 2005 22:19:26 -0000	1.2
+++ md5.js	31 Mar 2005 21:18:06 -0000	1.3
@@ -19,7 +19,6 @@
  * - 2003/06/09 by Antoine Pitrou (unicode compatibility)
  *
  *
- * $Id$
  *
  */
 

Index: inc_import.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_import.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_import.php3	29 Mar 2005 15:27:12 -0000	1.3
+++ inc_import.php3	31 Mar 2005 21:18:06 -0000	1.4
@@ -405,29 +405,29 @@
 
 	// Destruction des entrees non restaurees
 
-	$query = "DELETE FROM spip_rubriques WHERE maj < $my_date";
+	$query = "DELETE FROM spip_rubriques WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_breves WHERE maj < $my_date";
+	$query = "DELETE FROM spip_breves WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_auteurs WHERE maj < $my_date";
+	$query = "DELETE FROM spip_auteurs WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_articles WHERE maj < $my_date";
+	$query = "DELETE FROM spip_articles WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_documents WHERE maj < $my_date";
+	$query = "DELETE FROM spip_documents WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_types_documents WHERE maj < $my_date";
+	$query = "DELETE FROM spip_types_documents WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_forum WHERE maj < $my_date";
+	$query = "DELETE FROM spip_forum WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_mots WHERE maj < $my_date";
+	$query = "DELETE FROM spip_mots WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_groupes_mots WHERE maj < $my_date";
+	$query = "DELETE FROM spip_groupes_mots WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_petitions WHERE maj < $my_date";
+	$query = "DELETE FROM spip_petitions WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_signatures WHERE maj < $my_date";
+	$query = "DELETE FROM spip_signatures WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
-	$query = "DELETE FROM spip_visites WHERE maj < $my_date";
+	$query = "DELETE FROM spip_visites WHERE UNIX_TIMESTAMP(maj) < $my_date";
 	spip_query($query);
 
 	import_fin();

Index: inc_version.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_version.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc_version.php3	29 Mar 2005 15:28:11 -0000	1.5
+++ inc_version.php3	31 Mar 2005 21:18:06 -0000	1.6
@@ -395,7 +395,7 @@
 $spip_version = 1.813;
 
 // version de spip
-$spip_version_affichee = "1.8 PR2 CVS";
+$spip_version_affichee = "1.8 PR3 CVS";
 
 // version de spip / tag cvs
 if (ereg('Name: v(.*) ','$Name$', $regs)) $spip_version_affichee = $regs[1];
@@ -594,7 +594,9 @@
 }
 function http_last_modified($lastmodified, $expire = 0) {
 	$gmoddate = http_gmoddate($lastmodified);
-	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE']) {
+	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE']
+	AND !preg_match(',IIS/,', $_SERVER['SERVER_SOFTWARE'])) # MSoft IIS is dumb
+	{
 		$if_modified_since = ereg_replace(';.*$', '', $GLOBALS['HTTP_IF_MODIFIED_SINCE']);
 		$if_modified_since = trim(str_replace('GMT', '', $if_modified_since));
 		if ($if_modified_since == $gmoddate) {

Index: inc_lab.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_lab.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_lab.php	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_lab.php	31 Mar 2005 21:18:06 -0000	1.3
@@ -38,6 +38,10 @@
 					else
 						if (@file_exists(_DIR_RESTREINT.'inc_'.$fichier.'3'))
 							include_ecrire('inc_'.$fichier.'3');
+					// mais peut-etre avons nous une version '.php' de la version stable
+					else
+						if (@file_exists(_DIR_RESTREINT.'inc_'.$fichier))
+							include_ecrire('inc_'.$fichier);
 					else
 						die ("Fichier SPIP-Lab \"$fichier\" manquant.");
 					break;

Index: inc_lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_lang.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc_lang.php3	29 Mar 2005 15:27:12 -0000	1.4
+++ inc_lang.php3	31 Mar 2005 21:18:06 -0000	1.5
@@ -419,7 +419,11 @@
 		$post = $lien->getUrl();
 		$cible = '';
 	} else {
-		$site = lire_meta("adresse_site");
+		// eviter un bug a l'installation ; mais, dans le cas general,
+		// pourquoi aurait-on besoin ici d'une URL absolue ?
+		if (!defined('_ECRIRE_INSTALL')
+		AND !defined('_TEST_DIRS'))
+			$site = lire_meta("adresse_site");
 		if (!$site)
 			if (_DIR_RESTREINT)
 				$site = '.';

Index: index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/index.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- index.php3	29 Mar 2005 15:28:11 -0000	1.4
+++ index.php3	31 Mar 2005 21:18:06 -0000	1.5
@@ -167,16 +167,17 @@
 		$jour = jour($date);
 	
 		// rendez-vous personnels dans le mois
-		if (spip_num_rows(spip_query("SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.date_heure >='$annee-$mois-1' AND date_heure < DATE_ADD('$annee-$mois-1', INTERVAL 1 MONTH) AND messages.statut='publie' LIMIT 0,1"))) {
+		$evt = sql_calendrier_agenda($mois, $annee);
+		if ($evt) {
 			echo "<p />";
-			echo http_calendrier_agenda ($mois_today, $annee_today, $jour_today, $mois_today, $annee_today, false, 'calendrier.php3');
+			echo http_calendrier_agenda ($mois_today, $annee_today, $jour_today, $mois_today, $annee_today, false, 'calendrier.php3', $evt);
 		}
-		// rendez-vous personnels dans le mois
+		// et ceux du jour
 		if (spip_num_rows(spip_query("SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien ".
 				"WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') ".
 					     "AND messages.rv='oui' AND messages.date_heure >='$annee_today-$mois_today-$jour_today' AND messages.date_heure < DATE_ADD('$annee_today-$mois_today-$jour_today', INTERVAL 1 DAY) AND messages.statut='publie' LIMIT 0,1"))) {
 			echo "<p />";
-			echo http_calendrier_jour($jour_today,$mois_today,$annee_today, 90, $partie_cal, $echelle);
+			echo http_calendrier_jour($jour_today,$mois_today,$annee_today, "col", $partie_cal, $echelle);
 		}
 }
 

Index: inc_texte.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_texte.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc_texte.php3	29 Mar 2005 15:27:12 -0000	1.4
+++ inc_texte.php3	31 Mar 2005 21:18:06 -0000	1.5
@@ -219,27 +219,24 @@
 
 // Traitement final des echappements
 function echappe_retour($letexte, $les_echap, $source='') {
-  $cherche = "@@SPIP_$source";
-  $n = strlen($cherche);
-  $debut = '';
-  while(($pos = strpos($letexte, $cherche)) !== false) {
-    ereg("^([0-9]+)@@(.*)$",substr($letexte,$pos+$n),$regs);
-    $rempl = $les_echap[$regs[1]];
-# si $rempl est un tableau, c'est le r?sultat (cf echappe_html) de eregi sur :
+	$expr = ",@@SPIP_$source([0-9]+)@@,";
+	if (preg_match_all($expr, $letexte, $regs, PREG_SET_ORDER)) {
+		foreach ($regs as $reg) {
+			$rempl = $les_echap[$reg[1]];
+# si $rempl est un tableau, c'est le resultat (cf echappe_html) de eregi sur :
 # <(IMG|DOC|EMB)([0-9]+)(\|([^\>]*))?
-    if (is_array($rempl))
-	  {
-		    include_ecrire("inc_documents.php3");
-		    $type = strtoupper($rempl[1]);
-		    if ($type == 'EMB')
-		      $rempl = embed_document($rempl[2], $rempl[4]);
-		    else
-		      $rempl = integre_image($rempl[2], $rempl[4], $type);
-	  }
-    $debut .= substr($letexte,0,$pos) . $rempl;
-    $letexte = $regs[2];
-  }
-  return $debut . $letexte;
+			if (is_array($rempl)) {
+				include_ecrire("inc_documents.php3");
+				$type = strtoupper($rempl[1]);
+				if ($type == 'EMB')
+					$rempl = embed_document($rempl[2], $rempl[4]);
+				else
+					$rempl = integre_image($rempl[2], $rempl[4], $type);
+			}
+			$letexte = str_replace($reg[0], $rempl, $letexte);
+		}
+	}
+	return $letexte;
 }
 
 

Index: inc_meta.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_meta.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_meta.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_meta.php3	31 Mar 2005 21:18:06 -0000	1.3
@@ -21,12 +21,12 @@
 
 	$meta = '';
 	$meta_maj = '';
-	$query = 'SELECT * FROM spip_meta';
+	$query = 'SELECT nom,valeur,UNIX_TIMESTAMP(maj) AS d FROM spip_meta';
 	$result = spip_query($query);
 	while ($row = spip_fetch_array($result)) {
 		$nom = $row['nom'];
 		$meta[$nom] = $row['valeur'];
-		$meta_maj[$nom] = $row['maj'];
+		$meta_maj[$nom] = $row['d'];
 	}
 }
 

Index: articles_versions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_versions.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- articles_versions.php3	29 Mar 2005 15:25:58 -0000	1.3
+++ articles_versions.php3	31 Mar 2005 21:18:06 -0000	1.4
@@ -51,7 +51,7 @@
 	$query = "SELECT id_version FROM spip_versions WHERE id_article=$id_article ".
 		"AND id_version<$id_version ORDER BY id_version DESC LIMIT 0,1";
 	if ($result = spip_query($query)) {
-		$row = mysql_fetch_array($result);
+		$row = spip_fetch_array($result);
 		$id_diff = $row['id_version'];
 	}
 }

Index: statistiques_visites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/statistiques_visites.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- statistiques_visites.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ statistiques_visites.php3	31 Mar 2005 21:18:06 -0000	1.3
@@ -464,7 +464,7 @@
 				$prevision = (1 - (date("H")*60 - date("i"))/(24*60)) * $val_popularite;
 				$hauteurprevision = ceil($prevision * $rapport);
 				$prevision = round($prevision,0)+$visites_today; // Pour affichage harmonieux
-#				$tagtitle= attribut_html(supprimer_tags(_T('info_aujourdhui')." $visites_today &rarr; $prevision"));
+				$tagtitle= attribut_html(supprimer_tags(_T('info_aujourdhui')." $visites_today &rarr; $prevision"));
 				echo http_img_rien($largeur, $hauteurprevision,'background-color:#eeeeee;', $tagtitle);
 	
 				echo http_img_rien($largeur, $hauteur, 'background-color:#cccccc;', $tagtitle);

Index: inc_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_forum.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc_forum.php3	29 Mar 2005 15:27:12 -0000	1.3
+++ inc_forum.php3	31 Mar 2005 21:18:06 -0000	1.4
@@ -133,7 +133,7 @@
 			$logo = "forum-public-24.gif";
 			$valider = 'valid_forum';
 			$valider_repondre = true;
-			$supprimer = true;
+			$supprimer = 'supp_forum';
 			break;
 		default:
 			return;

Index: presentation.js
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/presentation.js,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- presentation.js	20 Feb 2005 22:19:26 -0000	1.1
+++ presentation.js	31 Mar 2005 21:18:06 -0000	1.2
@@ -42,10 +42,12 @@
 function decalerCouche(id_couche) {
 	if (!(layer = findObj(id_couche))) return;
 	if (bug_offsetwidth && ( parseInt(layer.style.left) > 0)) {
-
+		demilargeur = Math.floor( layer.offsetWidth / 2 );
+		if (demilargeur == 0) demilargeur = 100; // bug offsetwidth MSIE, on fixe une valeur arbitraire
 		gauche = parseInt(layer.style.left)
-		  - Math.floor( layer.offsetWidth / 2 )
+		  - demilargeur
 		  + Math.floor(largeur_icone / 2);
+		  		  
 		if (gauche < 0) gauche = 0;
 
 		layer.style.left = gauche+"px";

Index: pclzip.lib.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/pclzip.lib.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- pclzip.lib.php	20 Feb 2005 22:19:26 -0000	1.2
+++ pclzip.lib.php	31 Mar 2005 21:18:06 -0000	1.3
@@ -22,7 +22,6 @@
 //   The use of this software is at the risk of the user.
 //
 // --------------------------------------------------------------------------------
-// $Id$
 // --------------------------------------------------------------------------------
 
   // ----- Constants

Index: inc_math.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_math.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc_math.php3	20 Feb 2005 22:19:26 -0000	1.2
+++ inc_math.php3	31 Mar 2005 21:18:06 -0000	1.3
@@ -69,7 +69,7 @@
 		else {
 			list(,,,$size) = @getimagesize($fichier);
 			$alt = "alt=\"$tex\" title=\"$tex\""; 
-			return "<img src=\"$fichier\" align=\"middle\" $size $alt />";
+			return "<img src=\"$fichier\" style=\"vertical-align:middle;\" $size $alt />";
 		}
 
 	}

Index: calendrier.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/calendrier.css,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- calendrier.css	29 Mar 2005 15:26:13 -0000	1.1
+++ calendrier.css	31 Mar 2005 21:18:06 -0000	1.2
@@ -29,7 +29,6 @@
 	font-family: verdana, arial, sans,sans-serif;
 	font-weight: bold;
 	font-size: 14px;
-	padding: 2px;
 }
 
 div.navigation-calendrier img {
@@ -56,7 +55,7 @@
 
 .calendrier-table-large { 
 	border: 0px;
-	width: 950px;
+	width: 900px;
  }
 
 .calendrier-table-etroit { 
@@ -65,9 +64,9 @@
  }
 
 .calendrier-td-centre { 
-	width: 570px;
-	padding-left: 2%;
-	padding-right: 2%;
+	width: 550px;
+	padding-left: 25px;
+	padding-right: 25px;
   	vertical-align: top;
  }
 
@@ -77,17 +76,17 @@
  }
 
 .calendrier-table-large  .calendrier-td-gauche {
-	width: 180px;
+	width: 150px;
   	vertical-align: top;
  }
 
 .calendrier-table-etroit  .calendrier-td-droit {
-	width: 180px;
+	width: 150px;
   	vertical-align: top;
  }
 
 .calendrier-table-large  .calendrier-td-droit {
-	width: 180px;
+	width: 150px;
   	vertical-align: top;
  }
 
@@ -116,6 +115,22 @@
 	text-align: center; 
 	background-color: white;
 	-moz-border-radius: 5px;
+ }
+
+
+.calendrier-tripleagenda { 
+	vertical-align: top;
+	width: 33%;  
+ }
+
+.calendrier-cadreagenda { 
+	visibility: hidden;
+	width: 100%;
+	padding-top: 5px;
+	padding-bottom: 5px;
+	border: 0px;
+	-moz-border-radius-bottomleft: 8px;
+	-moz-border-radius-bottomright: 8px;
  }
 
 .calendrier-titre { 

Index: inc_calendrier.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_calendrier.php,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc_calendrier.php	29 Mar 2005 15:27:12 -0000	1.5
+++ inc_calendrier.php	31 Mar 2005 21:18:06 -0000	1.6
@@ -47,19 +47,17 @@
 {
 	global $mois, $annee, $jour, $type, $echelle, $partie_cal;
 
-	if (!$type
-	AND !($type = $ltype))
-		$type = 'mois';
-	if (!isset($echelle)) $echelle = $lechelle;
-	if (!isset($lpartie_cal)) $partie_cal = $lpartie_cal;
 	if (!$mois){
 		$today=getdate($date ? strtotime($date) : time());
 		$jour = $today["mday"];
 		$mois = $today["mon"];
 		$annee = $today["year"];
 	    } else {if (!isset($jour)) {$jour = 1; $type= 'mois';}}
-	    $date = date("Y-m-d", mktime(0,0,0,$mois, $jour, $annee));
+	if (!$date) $date = date("Y-m-d", mktime(0,0,0,$mois, $jour, $annee));
 	if (!$script) $script = $GLOBALS['REQUEST_URI']; 
+	if (!$type AND !($type = $ltype)) $type = 'mois';
+	if (!isset($echelle)) $echelle = $lechelle;
+	if (!isset($lpartie_cal)) $partie_cal = $lpartie_cal;
 	$script = http_calendrier_retire_args($script);
 	if (!_DIR_RESTREINT) http_calendrier_titre($date, $type);
 	$f = 'http_calendrier_init_' . $type;
@@ -245,21 +243,23 @@
 					$opacity = "";
 				}
 
-				$c = calendrier_div_style($evenement);
-				if (!$c) 
-				  {
-					$c = "color: black";
-					$radius_top = "";
-					$radius_bottom = "";
-				  } else {
-					list($b,$c) = $c;
-					$c = "padding: 2px; margin-top: 2px;
-$opacity background-color: $b; color: $c; border: 1px solid $c";
-				}
 				$e = $date_affichee .
 				  (!$url ? "$sum $desc" : http_href($url, $sum, $desc));
 				if (trim($e))
+				  {
+					$c = calendrier_div_style($evenement);
+					if (!$c) 
+					  {
+					    $c = "color: black";
+					    $radius_top = "";
+					    $radius_bottom = "";
+					  } else {
+					  list($b,$c) = $c;
+					  $c = "padding: 2px; margin-top: 2px;
+$opacity background-color: $b; color: $c; border: 1px solid $c";
+					}
 				  $res .= "\n<div class='calendrier-arial10$radius_top$radius_bottom' style='$c'>$e\n</div>\n"; 
+				  }
 			}
 		}
 	}
@@ -334,7 +334,7 @@
 		$script .= (strpos($script,'?') ? '&' : '?');
 	$args = "jour=$jour&mois=$mois&annee=$annee$ancre";
 	  
-  	$retour = "<div class='navigation-calendrier calendrier-moztop8'\nstyle='background-color: $couleur_foncee;'>";
+  	$retour = "";
 
 
    	if ($type != "mois") {
@@ -404,11 +404,14 @@
 
 	$id = 'nav-agenda' .ereg_replace('[^A-Za-z0-9]', '', $ancre);
 	$arguments = "jour=$jour_today&mois=$mois_today&annee=$annee_today$ancre" ;
-	return $retour .
+	return 
+	  "<div class='navigation-calendrier calendrier-moztop8'\nstyle='background-color: $couleur_foncee;'>" .
+	  $retour .
 	  "&nbsp;&nbsp;" .
 	  http_href_img($script . "type=$type&echelle=$echelle&$arguments",
 			"cal-today.gif",
 			(" onmouseover=\"montrer('$id');\"" .
+			 " onmouseout=\"cacher('$id');\"" .
 			 ($condition ? " class='calendrier-opacity'" : "")),
 			_T("info_aujourdhui")) .
 	  "&nbsp;" .
@@ -428,12 +431,9 @@
 {
 	global $spip_lang_right, $spip_lang_left, $couleur_claire;
 	if (!isset($couleur_claire)) $couleur_claire = 'white';
-	$gadget = "<div
-id='$id' style='position: relative; visibility: hidden;z-index: 1000; '
-onmouseover=\"montrer('$id');\" onmouseout=\"cacher('$id');\"><div 
-style='position: absolute; padding: 5px; background-color: $couleur_claire; margin-bottom: 5px; -moz-border-radius-bottomleft: 8px; -moz-border-radius-bottomright: 8px;'>";
+	$gadget = "<div style='position: relative;z-index: 1000;'>";
 
-	$gadget .= "<table cellpadding='0' cellspacing='5' border='0' width='100%'>";
+	$gadget .= "<table id='$id' class='calendrier-cadreagenda' style='position: absolute; background-color: $couleur_claire'>";
 	$gadget .= "\n<tr><td colspan='3' style='text-align:$spip_lang_left;'>";
 
 	$annee_avant = $annee - 1;
@@ -448,11 +448,11 @@
 					nom_mois("$annee-$i-1"),'','', 'calendrier-annee');
 			}
 	$gadget .= "</td></tr>"
-		. "\n<tr><td valign='top' style='width: 33%'>"
+		. "\n<tr><td class='calendrier-tripleagenda'>"
 		. http_calendrier_agenda($mois-1, $annee, $jour, $mois, $annee, $GLOBALS['afficher_bandeau_calendrier_semaine'], $script,$ancre) 
-		. "</td>\n<td valign='top' style='width: 33%'>"
+		. "</td>\n<td class='calendrier-tripleagenda'>"
 		. http_calendrier_agenda($mois, $annee, $jour, $mois, $annee, $GLOBALS['afficher_bandeau_calendrier_semaine'], $script,$ancre) 
-		. "</td>\n<td valign='top' style='width: 33%'>"
+		. "</td>\n<td class='calendrier-tripleagenda'>"
 		. http_calendrier_agenda($mois+1, $annee, $jour, $mois, $annee, $GLOBALS['afficher_bandeau_calendrier_semaine'], $script,$ancre) 
 		. "</td>"
 		. "</tr>"
@@ -465,7 +465,7 @@
 		$gadget .= http_href($script . "mois=$i&annee=$annee_apres$ancre",
 					nom_mois("$annee_apres-$i-1"),'','', 'calendrier-annee');
 			}
-	return $gadget . "</td></tr></table></div></div>";
+	return $gadget . "</td></tr></table></div>";
 }
 
 
@@ -776,12 +776,13 @@
 
 // agenda mensuel 
 
-function http_calendrier_agenda ($mois, $annee, $jour_ved, $mois_ved, $annee_ved, $semaine = false,  $script='', $ancre='') {
+function http_calendrier_agenda ($mois, $annee, $jour_ved, $mois_ved, $annee_ved, $semaine = false,  $script='', $ancre='', $evt='') {
 
   if (!$script) $script =  $GLOBALS['PHP_SELF'] ;
   if (!strpos($script, '?')) $script .= '?';
   if (!$mois) {$mois = 12; $annee--;}
   elseif ($mois==13) {$mois = 1; $annee++;}
+  if (!$evt) $evt = sql_calendrier_agenda($mois, $annee);
   return 
     "<div class='calendrier-titre calendrier-arial10'>" .
     http_href($script . "mois=$mois&annee=$annee$ancre",
@@ -789,8 +790,7 @@
 	      '',
 	      'color: black;') .
     "<table width='100%' cellspacing='0' cellpadding='0'>" .
-    http_calendrier_agenda_rv ($annee, $mois, 
-				sql_calendrier_agenda($mois, $annee),
+    http_calendrier_agenda_rv ($annee, $mois, $evt,				
 			        'http_jour_clic', array($script, $ancre),
 			        $jour_ved, $mois_ved, $annee_ved, 
 				$semaine) .
@@ -1123,12 +1123,12 @@
 	$gauche = (_DIR_RESTREINT  || ($spip_ecran != "large"));
 	return 	
 	  "<div>&nbsp;</div>" .
-	  "\n<table cols='7' class='calendrier-table-$spip_ecran'>" .
+	  "\n<table class='calendrier-table-$spip_ecran'>" .
 	  "\n<tr><td class='calendrier-td-gauche'> " .
 	  "</td><td colspan='5' class='calendrier-td-centre'>" .
 	   http_calendrier_navigation_jour($jour,$mois,$annee, $partie_cal, $echelle, $script, $ancre) .
 	  "</td><td class='calendrier-td-droit calendrier-arial10'> " .
-	  "</td></tr><tr>" .
+	  "</td></tr>" .
 	  "\n<tr><td class='calendrier-td-gauche'>" .
 	  ($gauche ? '' :
 	   http_calendrier_entetecol($script, $jour-1,$mois,$annee)) .



From stef at berlios.de  Thu Mar 31 23:18:09 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 31 Mar 2005 23:18:09 +0200
Subject: [Spip-carto-cvs] spipcarto inc-messforum.php3,1.5,1.6 inc-cache.php3,1.7,1.8
Message-ID: <200503312118.j2VLI99Y010178@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv10067/spipcarto

Modified Files:
	inc-messforum.php3 inc-cache.php3 
Log Message:
1.8PR3 CVS 20050331

Index: inc-messforum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-messforum.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc-messforum.php3	29 Mar 2005 15:16:35 -0000	1.5
+++ inc-messforum.php3	31 Mar 2005 21:18:07 -0000	1.6
@@ -21,6 +21,7 @@
 // Voir commentaires dans celui-ci et dans inc-formulaire_forum
 
 function prevenir_auteurs($auteur, $email_auteur, $id_forum, $id_article, $texte, $titre, $statut) {
+	global $nom_site_forum, $url_site;
 	include_ecrire('inc_texte.php3');
 	include_ecrire('inc_filtres.php3');
 	include_ecrire('inc_mail.php3');
@@ -39,33 +40,38 @@
 		$url = generer_url_article($id_article);
 	}
 
-	$url = ereg_replace('^/', '', $url);
 	$adresse_site = lire_meta("adresse_site");
 	$nom_site_spip = lire_meta("nom_site");
-	$url = "$adresse_site/$url";
-	$parauteur = (strlen($auteur) <= 2) ? '' :
-	  (" "
-	   ._T('forum_par_auteur',
-	       array('auteur' => $auteur)) .
-	   (!$email_auteur ? '' : (' <' . $email_auteur . '>')));
-	$courr =  _T('form_forum_message_auto')."\n\n"
-		. _T('forum_poste_par',
-		     array('parauteur' => $parauteur))."\n"
-		. _T('forum_ne_repondez_pas')."\n"
+	$url = $adresse_site .'/' .  ereg_replace('^/', '', $url);
+	$corps = "\n"
 		. $url
 		. "\n\n\n".$titre."\n\n".textebrut(propre($texte))
 		. "\n\n$nom_site_forum\n$url_site\n";
-	$sujet = "[$nom_site_spip] ["._T('forum_forum')."] $titre";
-	$result = spip_query("SELECT auteurs.email FROM spip_auteurs AS auteurs,
+	if ($email_auteur) 
+		$email_auteur = ' <' . $email_auteur . '>';
+	$result = spip_query("SELECT auteurs.email, auteurs.lang FROM spip_auteurs AS auteurs,
 				spip_auteurs_articles AS lien
 				WHERE lien.id_article='$id_article'
 				AND auteurs.id_auteur=lien.id_auteur");
 
-	while (list($email) = spip_fetch_array($result)) {
+	$old_lang = $GLOBALS['spip_lang'];
+	while (list($email, $salangue) = spip_fetch_array($result)) {
 		$email = trim($email);
 		if (strlen($email) < 3) continue;
+		$GLOBALS['spip_lang'] = ($salangue ? $salangue : $old_lang);
+		$parauteur = (strlen($auteur) <= 2) ? '' :
+		  (" "
+		   ._T('forum_par_auteur',
+		       array('auteur' => $auteur))
+		   . $email_auteur);
+		$courr =  _T('form_forum_message_auto')."\n\n"
+		  . _T('forum_poste_par', array('parauteur' => $parauteur))."\n"
+		  . _T('forum_ne_repondez_pas')
+		  . $corps ;
+		$sujet = "[$nom_site_spip] ["._T('forum_forum')."] $titre";
 		envoyer_mail($email, $sujet, $courr);
 	}
+	$GLOBALS['spip_lang'] = $old_lang;	
 }
 
 
@@ -117,7 +123,6 @@
 	  $afficher_texte, $ajouter_mot, $alea, $hash,
 	  $auteur, $confirmer_forum, $email_auteur, $id_auteur,
 	  $nom_site_forum, $retour_forum, $texte, $titre, $url_site;
-
 	$retour_forum = rawurldecode($retour_forum);
 
 	// Recuperer les donnees postees du formulaire ou stocker '0'

Index: inc-cache.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-cache.php3,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- inc-cache.php3	29 Mar 2005 15:16:35 -0000	1.7
+++ inc-cache.php3	31 Mar 2005 21:18:07 -0000	1.8
@@ -30,7 +30,7 @@
 }
 
 //
-// Le format souhaite : "CACHE/a/(8400/)bout-d-url.md5(.gz)"
+// Le format souhaite : "CACHE/a/bout-d-url.md5(.gz)"
 // Attention a modifier simultanement le sanity check de
 // la fonction retire_cache()
 //
@@ -48,8 +48,6 @@
 			$fichier_requete .= "&$var=$val";
 	}
 
-	$md_cache = md5($fichier_requete);
-
 	$fichier_cache = ereg_replace('^/+', '', $fichier_requete);
 	$fichier_cache = ereg_replace('\.[a-zA-Z0-9]*', '', $fichier_cache);
 	$fichier_cache = ereg_replace('&[^&]+=([^&]+)', '&\1', $fichier_cache);
@@ -62,20 +60,19 @@
 	if (!$fichier_cache)
 		$fichier_cache = 'INDEX-';
 
-	// morceau de md5
+	// morceau de md5 selon HOST et $fond
+	$md_cache = md5($fichier_requete . $GLOBALS['HTTP_HOST'] . $fond);
 	$fichier_cache .= '.'.substr($md_cache, 1, 8);
 
 	// Sous-repertoires 0...9a..f/
 	$subdir = creer_repertoire(_DIR_CACHE, substr($md_cache, 0, 1));
-	// Sous-sous-repertoires delais/ (inutile avec l'invalidation par 't')
-	# $subdir2 = creer_repertoire("CACHE/$subdir", $delais);
 
 	include_ecrire('inc_acces.php3');
 	verifier_htaccess(_DIR_CACHE);
 
 	$gzip = $flag_gz ? '.gz' : '';
 
-	return _DIR_CACHE . $subdir.$subdir2.$fichier_cache.$gzip;
+	return _DIR_CACHE . $subdir.$fichier_cache.$gzip;
 }
 
 //



