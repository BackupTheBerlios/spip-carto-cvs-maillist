<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto/formulaires formulaire_signature.html,1.4,1.5 formulaire_inscription.html,1.3,1.4 formulaire_site.html,1.3,1.4 formulaire_login.html,1.3,1.4 formulaire_forum_previsu.html,1.1,1.2 inc-formulaire_forum.php3,1.4,1.5 formulaire_admin.html,1.4,1.5 inc-formulaire_site.php3,1.3,1.4 inc-formulaire_signature.php3,1.3,1.4 inc-formulaire_admin.php3,1.3,1.4 inc-formulaire_inscription.php3,1.4,1.5 inc-login_public.php3,1.4,1.5
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-July/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/formulaires%20formulaire_signature.html%2C1.4%2C1.5%20formulaire_inscription.html%2C1.3%2C1.4%20formulaire_site.html%2C1.3%2C1.4%20formulaire_login.html%2C1.3%2C1.4%20formulaire_forum_previsu.html%2C1.1%2C1.2%20inc-formulaire_forum.php3%2C1.4%2C1.5%20formulaire_admin.html%2C1.4%2C1.5%20inc-formulaire_site.php3%2C1.3%2C1.4%20inc-formulaire_signature.php3%2C1.3%2C1.4%20inc-formulaire_admin.php3%2C1.3%2C1.4%20inc-formulaire_inscription.php3%2C1.4%2C1.5%20inc-login_public.php3%2C1.4%2C1.5&In-Reply-To=%3C200507212147.j6LLlEqX023935%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000200.html">
   <LINK REL="Next"  HREF="000201.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto/formulaires formulaire_signature.html,1.4,1.5 formulaire_inscription.html,1.3,1.4 formulaire_site.html,1.3,1.4 formulaire_login.html,1.3,1.4 formulaire_forum_previsu.html,1.1,1.2 inc-formulaire_forum.php3,1.4,1.5 formulaire_admin.html,1.4,1.5 inc-formulaire_site.php3,1.3,1.4 inc-formulaire_signature.php3,1.3,1.4 inc-formulaire_admin.php3,1.3,1.4 inc-formulaire_inscription.php3,1.4,1.5 inc-login_public.php3,1.4,1.5</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/formulaires%20formulaire_signature.html%2C1.4%2C1.5%20formulaire_inscription.html%2C1.3%2C1.4%20formulaire_site.html%2C1.3%2C1.4%20formulaire_login.html%2C1.3%2C1.4%20formulaire_forum_previsu.html%2C1.1%2C1.2%20inc-formulaire_forum.php3%2C1.4%2C1.5%20formulaire_admin.html%2C1.4%2C1.5%20inc-formulaire_site.php3%2C1.3%2C1.4%20inc-formulaire_signature.php3%2C1.3%2C1.4%20inc-formulaire_admin.php3%2C1.3%2C1.4%20inc-formulaire_inscription.php3%2C1.4%2C1.5%20inc-login_public.php3%2C1.4%2C1.5&In-Reply-To=%3C200507212147.j6LLlEqX023935%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto/formulaires formulaire_signature.html,1.4,1.5 formulaire_inscription.html,1.3,1.4 formulaire_site.html,1.3,1.4 formulaire_login.html,1.3,1.4 formulaire_forum_previsu.html,1.1,1.2 inc-formulaire_forum.php3,1.4,1.5 formulaire_admin.html,1.4,1.5 inc-formulaire_site.php3,1.3,1.4 inc-formulaire_signature.php3,1.3,1.4 inc-formulaire_admin.php3,1.3,1.4 inc-formulaire_inscription.php3,1.4,1.5 inc-login_public.php3,1.4,1.5">stef at berlios.de
       </A><BR>
    <I>Thu Jul 21 23:47:14 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000200.html">[Spip-carto-cvs] spipcarto/dist mot.html,1.4,1.5 login.html,1.4,1.5 backend.html,1.3,1.4 article.html,1.4,1.5
</A></li>
        <LI>Next message: <A HREF="000201.html">[Spip-carto-cvs] spipcarto inc-html-squel.php3,1.6,1.7 inc-urls-propres.php3,1.4,1.5 inc-balises.php3,1.7,1.8 inc-criteres.php3,1.5,1.6 inc-public.php3,1.4,1.5 carto.php3,1.5,1.6 inc-cache.php3,1.9,1.10 inc-boucles.php3,1.5,1.6 inc-compilo.php3,1.6,1.7 inc-calcul-outils.php3,1.5,1.6 inc-compilo-api.php3,1.5,1.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#202">[ date ]</a>
              <a href="thread.html#202">[ thread ]</a>
              <a href="subject.html#202">[ subject ]</a>
              <a href="author.html#202">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto/formulaires
In directory sheep:/tmp/cvs-serv22230/formulaires

Modified Files:
	formulaire_signature.html formulaire_inscription.html 
	formulaire_site.html formulaire_login.html 
	formulaire_forum_previsu.html inc-formulaire_forum.php3 
	formulaire_admin.html inc-formulaire_site.php3 
	inc-formulaire_signature.php3 inc-formulaire_admin.php3 
	inc-formulaire_inscription.php3 inc-login_public.php3 
Log Message:
synchro CVS 20050719

Index: formulaire_signature.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_signature.html,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- formulaire_signature.html	30 Jun 2005 10:09:35 -0000	1.4
+++ formulaire_signature.html	21 Jul 2005 21:47:12 -0000	1.5
@@ -1,4 +1,4 @@
-&lt;form method='post' action='#SELF#sp[(#ENV{id_article})]'&gt;
+&lt;form method='post' action=&quot;[(#ENV{self})][#sp(#ENV{id_article})]&quot;&gt;
 &lt;input type=&quot;hidden&quot; name=&quot;url_page&quot; value=&quot;#URL_SITE_SPIP/#SELF&quot; /&gt;
 &lt;div class='spip_encadrer' style='color: black; font-size: 80%; font-weight: normal;'&gt;
 [(#ENV*{texte}|propre)]

Index: formulaire_inscription.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_inscription.html,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- formulaire_inscription.html	30 Jun 2005 10:09:35 -0000	1.3
+++ formulaire_inscription.html	21 Jul 2005 21:47:12 -0000	1.4
@@ -8,7 +8,7 @@
  (#ENV{mode}|=={redac}|?{' ',''})
 	&lt;:pass_espace_prive_bla:&gt;&lt;br /&gt;&lt;br /&gt;
 ]&lt;:form_forum_indiquer_nom_email:&gt;
- &lt;form	id=&quot;inscription&quot; method='post' action='#SELF'
+ &lt;form	id=&quot;inscription&quot; method='post' action=&quot;[(#ENV{self})]&quot;
 	style='border: 0px; margin: 0px;'&gt; 
       &lt;fieldset style=&quot;border: none; font-weight: bold&quot;&gt;
 	&lt;legend&gt;&lt;:form_forum_identifiants:&gt;&lt;/legend&gt;

Index: formulaire_site.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_site.html,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- formulaire_site.html	30 Jun 2005 10:09:35 -0000	1.3
+++ formulaire_site.html	21 Jul 2005 21:47:12 -0000	1.4
@@ -1,4 +1,4 @@
-&lt;form action=&quot;#SELF&quot; method=&quot;post&quot;&gt;
+&lt;form action=&quot;[(#ENV{self})]&quot; method=&quot;post&quot;&gt;
       &lt;br /&gt;
       &lt;fieldset	class='spip_encadrer' style='color: black; font-size: 90%'&gt;
 	&lt;legend&gt;&lt;:info_site:&gt;&lt;/legend&gt;

Index: formulaire_login.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_login.html,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- formulaire_login.html	30 Jun 2005 10:09:35 -0000	1.3
+++ formulaire_login.html	21 Jul 2005 21:47:12 -0000	1.4
@@ -27,7 +27,7 @@
 	alt=&quot;[(#ENV{login_alt})]&quot; /&gt;&lt;/div&gt;]
 	&lt;input type=&quot;hidden&quot; name=&quot;session_login_hidden&quot; value=&quot;(#ENV{login})&quot; /&gt;
 &lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
-document.write(&quot;&lt;:login_login:&gt;&nbsp;&lt;strong&gt;[(#ENV{login_alt})]&lt;&quot; + &quot;/strong&gt;&lt;br /&gt;&#91;&lt;a style='color: #e86519' href='spip_cookie.php3?cookie_admin=non[&amp;url=(#ENV{url})][&amp;retour=(#SELF|urlencode)]'&gt;&lt;font size='2'&gt;&lt;:login_autre_identifiant:&gt;&lt;&quot; + &quot;/font&gt;&lt;&quot; + &quot;/a&gt;&#93;&quot;)
+document.write(&quot;&lt;:login_login:&gt;&nbsp;&lt;strong&gt;[(#ENV{login_alt})]&lt;&quot; + &quot;/strong&gt;&lt;br /&gt;&#91;&lt;a style='color: #e86519' href='spip_cookie.php3?cookie_admin=non[&amp;url=(#ENV{url})][&amp;retour=(#ENV{self}|urlencode)]'&gt;&lt;font size='2'&gt;&lt;:login_autre_identifiant:&gt;&lt;&quot; + &quot;/font&gt;&lt;&quot; + &quot;/a&gt;&#93;&quot;)
 //--&gt;&lt;/script&gt;
 &lt;noscript&gt;
 	&lt;p class='notes' style='font-size: 130%'&gt;

Index: formulaire_forum_previsu.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_forum_previsu.html,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- formulaire_forum_previsu.html	20 Feb 2005 22:13:52 -0000	1.1
+++ formulaire_forum_previsu.html	21 Jul 2005 21:47:12 -0000	1.2
@@ -8,7 +8,7 @@
 
 [&lt;p /&gt;(#ENV*{texte})]
 
-[&lt;p /&gt;&lt;a [href=&quot;(#ENV{url_site}|urlencode)&quot;]&gt;(#ENV*{nom_site_forum})&lt;/a&gt;]
+[&lt;p /&gt;&lt;a [href=&quot;(#ENV{url_site}|attribut_html)&quot;]&gt;(#ENV*{nom_site_forum})&lt;/a&gt;]
 
 [(#ENV*{mots_forum})]
 

Index: inc-formulaire_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_forum.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-formulaire_forum.php3	30 Jun 2005 10:09:35 -0000	1.4
+++ inc-formulaire_forum.php3	21 Jul 2005 21:47:12 -0000	1.5
@@ -296,7 +296,7 @@
 	$in_group = &quot; AND id_groupe IN (&quot; . join($afficher_groupe, &quot;, &quot;) .&quot;)&quot;;
 
 	$result_groupe = spip_query(&quot;SELECT * FROM spip_groupes_mots
-	WHERE 6forum = 'oui' AND $table = 'oui'&quot;. $in_group);
+	WHERE forum = 'oui' AND $table = 'oui'&quot;. $in_group);
 
 	$ret = '';
 	while ($row_groupe = spip_fetch_array($result_groupe)) {

Index: formulaire_admin.html
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/formulaire_admin.html,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- formulaire_admin.html	30 Jun 2005 10:09:35 -0000	1.4
+++ formulaire_admin.html	21 Jul 2005 21:47:12 -0000	1.5
@@ -1,5 +1,5 @@
 &lt;div [class=&quot;(#ENV{divclass})&quot; ]dir='#LANG_DIR'&gt;[
-	&lt;a href='(#ENV{analyser})' class='spip-admin-boutons'&gt;&lt;:Analyser:&gt;[(#ENV{xhtml_error}?{' *',''})]&lt;/a&gt;][
+	&lt;a href='(#ENV{analyser})' class='spip-admin-boutons'&gt;&lt;:analyse_xml:&gt;[(#ENV{xhtml_error}?{' *',''})]&lt;/a&gt;][
 	&lt;a href='ecrire/articles.php3?id_article=(#ENV{id_article})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_article:&gt; ([(#ENV{id_article})])&lt;/a&gt;][
 	&lt;a href='ecrire/breves_voir.php3?id_breve=(#ENV{id_breve})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_breve:&gt; ([(#ENV{id_breve})])&lt;/a&gt;][
 	&lt;a href='ecrire/naviguer.php3?id_rubrique=(#ENV{id_rubrique})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_rubrique:&gt; ([(#ENV{id_rubrique})])&lt;/a&gt;][

Index: inc-formulaire_site.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_site.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-formulaire_site.php3	3 Mar 2005 14:53:17 -0000	1.3
+++ inc-formulaire_site.php3	21 Jul 2005 21:47:12 -0000	1.4
@@ -21,7 +21,10 @@
 
 function balise_FORMULAIRE_SITE_dyn($id_rubrique) {
 
-	if (!_request('nom_site')) return array('formulaire_site', 0);
+	if (!_request('nom_site'))
+		return array('formulaire_site', $GLOBALS['delais'],
+			array('self' =&gt; $GLOBALS[&quot;clean_link&quot;]-&gt;getUrl()
+		));
 
 	// Tester le nom du site
 	if (strlen (_request('nom_site')) &lt; 2){

Index: inc-formulaire_signature.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_signature.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-formulaire_signature.php3	3 Mar 2005 14:53:17 -0000	1.3
+++ inc-formulaire_signature.php3	21 Jul 2005 21:47:12 -0000	1.4
@@ -65,7 +65,8 @@
 			'petition' =&gt; $petition,
 			'texte' =&gt; $texte,
 			'site_obli' =&gt; $site_obli,
-			'message' =&gt; $message
+			'message' =&gt; $message,
+			'self' =&gt; $GLOBALS[&quot;clean_link&quot;]-&gt;getUrl()
 		));
 	}
 }

Index: inc-formulaire_admin.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_admin.php3,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- inc-formulaire_admin.php3	30 Jun 2005 10:09:35 -0000	1.3
+++ inc-formulaire_admin.php3	21 Jul 2005 21:47:12 -0000	1.4
@@ -93,7 +93,7 @@
 	$analyser = !$xhtml ? &quot;&quot; :
 	  (($xhtml === 'spip_sax') ?
 	   ($action . &quot;var_mode=debug&amp;var_mode_affiche=validation&quot;) :
-	   $xhtml_check); // cas tidy
+	   $GLOBALS['xhtml_check']); // cas tidy
 	// hack - ne pas avoir la rubrique si un autre bouton est deja present
 	if ($id_article OR $id_breve) unset ($id_rubrique);
 

Index: inc-formulaire_inscription.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-formulaire_inscription.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-formulaire_inscription.php3	30 Jun 2005 10:09:35 -0000	1.4
+++ inc-formulaire_inscription.php3	21 Jul 2005 21:47:12 -0000	1.5
@@ -21,99 +21,102 @@
 	// Si une inscription est autorisee, on enregistre le demandeur
 	// comme 'nouveau' et on lui envoie ses codes par email ; lors de
 	// sa premiere connexion il obtiendra son statut final (auth-&gt;activer())
-	if (($mode == 'redac' AND lire_meta('accepter_inscriptions') == 'oui')
+	if (!(($mode == 'redac' AND lire_meta('accepter_inscriptions') == 'oui')
 	OR ($mode == 'forum' AND (
 		lire_meta('accepter_visiteurs') == 'oui'
 		OR lire_meta('forums_publics') == 'abo'
 		)
-	))
-		$statut = 'nouveau';
-	else
+	    )))
 		return _T('pass_rien_a_faire_ici');
 
 	// recuperer les donnees envoyees
-	$mail_inscription = _request('mail_inscription');
+	$mail_inscription = trim(_request('mail_inscription'));
 	$nom_inscription = _request('nom_inscription');
 
-	if (test_mail_ins($mode, $mail_inscription)
-	AND _request('nom_inscription')) {
-		// envoyer les identifiants si l'abonne n'existe pas deja.
-		$s = spip_query(&quot;SELECT statut, id_auteur, login, pass
-		FROM spip_auteurs WHERE email='&quot;.addslashes($mail_inscription).&quot;'&quot;);
-		if (!$row = spip_fetch_array($s)) {
-			$login = test_login($nom_inscription, $mail_inscription);
-			$id_auteur = spip_abstract_insert('spip_auteurs', 
-				'(nom, email, login, statut)',
-				&quot;('&quot;.addslashes($nom_inscription).&quot;',
-				'&quot;.addslashes($mail_inscription).&quot;', '$login', '$statut')&quot;);
-			$pass = creer_pass_pour_auteur($id_auteur);
-			$message = envoyer_inscription($mail_inscription,
-				$statut, $mode, $login, $pass, $nom_inscription);
-		}
-
-		else {
-			// existant mais encore muet, renvoyer les infos
-			if ($row['statut'] == 'nouveau') {
-				// recreer le pass
-				$pass = creer_pass_pour_auteur($row['id_auteur']);
-				$message = envoyer_inscription(
-					$mail_inscription, $row['statut'], $mode,
-					$row['login'], $pass, $nom_inscription);
-			} else {
-				// dead
-				if ($row['statut'] == '5poubelle')
-					$message = _T('form_forum_access_refuse');
-				// deja inscrit
-				else
-					$message = _T('form_forum_email_deja_enregistre');
-			}
-		}
-	}
-
-	// demande du formulaire
-	else {
-		if (!$nom_inscription) 
-			$message = '';
-		else {
-			spip_log(&quot;Mail incorrect: '$mail_inscription'&quot;);
-			$message = _T('info_email_invalide');
-		}
-	}
+	if (!$nom_inscription) 
+		$message = '';
+	elseif (!test_mail_ins($mode, $mail_inscription))
+		$message = _T('info_email_invalide');
+	else	$message = message_inscription($mail_inscription,
+					       $nom_inscription,
+					       false,
+					       ($mode == 'forum')  ?
+					       'form_forum_voici1' :
+					       'form_forum_voici2');
 
-	return array(&quot;formulaire_inscription&quot;, 0,
-		array('focus' =&gt; $focus,
-			'target' =&gt; _request('target'),
-			'message' =&gt; $message,
-			'mode' =&gt; $mode));
+	return array(&quot;formulaire_inscription&quot;, $GLOBALS['delais'],
+			array('focus' =&gt; $focus,
+				'target' =&gt; _request('target'),
+				'message' =&gt; $message,
+				'mode' =&gt; $mode,
+				'self' =&gt; $GLOBALS[&quot;clean_link&quot;]-&gt;getUrl()
+				));
 }
 
 // fonction qu'on peut redefinir pour filtrer selon l'adresse mail
 // cas general: controler juste que l'adresse n'est pas vide et est valide
 
 function test_mail_ins($mode, $mail) {
-	if ($mail = trim($mail))
-		return email_valide($mail);
+	return  ($mail = trim($mail)) AND email_valide($mail);
+}
+
+// creer un nouvel utilisateur et lui envoyer un mail avec ses identifiants
+
+function message_inscription($mail_inscription, $nom_inscription, $force, $mode)
+{
+
+  $row = spip_fetch_array(spip_query(&quot;SELECT statut, id_auteur, login
+FROM spip_auteurs WHERE email='&quot;.addslashes($mail_inscription).&quot;'&quot;));
+
+  if (!$row) {
+  // il n'existe pas, creer les identifiants 
+    $login = test_login($nom_inscription, $mail_inscription);
+    $pass = creer_pass_pour_auteur(spip_abstract_insert('spip_auteurs', 
+				'(nom, email, login, statut)',
+				&quot;('&quot;.
+				addslashes($nom_inscription) .
+				&quot;', '&quot;.
+				addslashes($mail_inscription) .
+				&quot;', '&quot; .
+				$login .
+				&quot;', 'nouveau')&quot;));
+
+    return envoyer_inscription($mail_inscription, 'nouveau', $mode, $login, $pass, $nom_inscription);
+  } else {
+	// existant mais encore muet, ou ressucite: renvoyer les infos
+    if ((($row['statut'] == 'nouveau') &amp;&amp; !$force) ||
+	(($row['statut'] == '5poubelle') &amp;&amp; $force)) {
+      // recreer le pass
+      $pass = creer_pass_pour_auteur($row['id_auteur']);
+      return envoyer_inscription($mail_inscription, $row['statut'], $mode,
+				     $row['login'], $pass, $nom_inscription);
+    } else {
+      // irrecuperable
+      if ($row['statut'] == '5poubelle')
+	return_T('form_forum_access_refuse');
+      else
+      // deja inscrit
+	return _T('form_forum_email_deja_enregistre');
+    }
+  }
 }
 
 
 // envoyer identifiants par mail
-function envoyer_inscription($mail, $statut, $type, $login, $pass, $nom) {
+function envoyer_inscription($mail, $statut, $mode, $login, $pass, $nom) {
 	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
 	$adresse_site = lire_meta(&quot;adresse_site&quot;);
 	
 	$message = _T('form_forum_message_auto').&quot;\n\n&quot;
-	._T('form_forum_bonjour', array('nom'=&gt;$nom)).&quot;\n\n&quot;;
-	if ($type == 'forum') {
-		$message .= _T('form_forum_voici1', array('nom_site_spip' =&gt; $nom_site_spip, 'adresse_site' =&gt; $adresse_site)) . &quot;\n\n&quot;;
-	} else {
-		$message .= _T('form_forum_voici2', array('nom_site_spip' =&gt; $nom_site_spip, 'adresse_site' =&gt; $adresse_site)) . &quot;\n\n&quot;;
-	}
-	$message .= &quot;- &quot;._T('form_forum_login').&quot; $login\n&quot;;
-	$message .= &quot;- &quot;._T('form_forum_pass').&quot; $pass\n\n&quot;;
+	  . _T('form_forum_bonjour', array('nom'=&gt;$nom)).&quot;\n\n&quot;
+	  . _T($mode, array('nom_site_spip' =&gt; $nom_site_spip, 'adresse_site' =&gt; $adresse_site)) . &quot;\n\n&quot;
+	  . &quot;- &quot;._T('form_forum_login').&quot; $login\n&quot;
+	  . &quot;- &quot;._T('form_forum_pass').&quot; $pass\n\n&quot;;
 
 	include_ecrire(&quot;inc_mail.php3&quot;);
 	if (envoyer_mail($mail,
-	&quot;[$nom_site_spip] &quot;._T('form_forum_identifiants'), $message))
+			 &quot;[$nom_site_spip] &quot;._T('form_forum_identifiants'),
+			 $message))
 		return _T('form_forum_identifiant_mail');
 	else
 		return _T('form_forum_probleme_mail');
@@ -142,9 +145,7 @@
 	$login = $login_base;
 
 	for ($i = 1; ; $i++) {
-		$s = spip_query(&quot;SELECT id_auteur FROM spip_auteurs
-		WHERE login='$login'&quot;);
-		if (!spip_num_rows($s))
+	  if (!spip_num_rows(spip_query(&quot;SELECT id_auteur FROM spip_auteurs WHERE login='$login' LIMIT 1&quot;)))
 			return $login;
 		$login = $login_base.$i;
 	}

Index: inc-login_public.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/formulaires/inc-login_public.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-login_public.php3	30 Jun 2005 10:09:35 -0000	1.4
+++ inc-login_public.php3	21 Jul 2005 21:47:12 -0000	1.5
@@ -128,7 +128,7 @@
 	if (_request('var_erreur') == 'pass')
 		$erreur = _T('login_erreur_pass');
 
-	return array('formulaire_login', 0, 
+	return array('formulaire_login', $GLOBALS['delais'],
 		array_merge(
 				array_map('texte_script', $row),
 				array(
@@ -139,7 +139,8 @@
 					'auth_http' =&gt; $auth_http,
 					'echec_cookie' =&gt; ($echec_cookie ? ' ' : ''),
 					'login' =&gt; $login,
-					'login_alt' =&gt; ($login_alt ? $login_alt : $login)
+					'login_alt' =&gt; ($login_alt ? $login_alt : $login),
+					'self' =&gt; $GLOBALS[&quot;clean_link&quot;]-&gt;getUrl()
 					)
 				)
 			);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000200.html">[Spip-carto-cvs] spipcarto/dist mot.html,1.4,1.5 login.html,1.4,1.5 backend.html,1.3,1.4 article.html,1.4,1.5
</A></li>
	<LI>Next message: <A HREF="000201.html">[Spip-carto-cvs] spipcarto inc-html-squel.php3,1.6,1.7 inc-urls-propres.php3,1.4,1.5 inc-balises.php3,1.7,1.8 inc-criteres.php3,1.5,1.6 inc-public.php3,1.4,1.5 carto.php3,1.5,1.6 inc-cache.php3,1.9,1.10 inc-boucles.php3,1.5,1.6 inc-compilo.php3,1.6,1.7 inc-calcul-outils.php3,1.5,1.6 inc-compilo-api.php3,1.5,1.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#202">[ date ]</a>
              <a href="thread.html#202">[ thread ]</a>
              <a href="subject.html#202">[ subject ]</a>
              <a href="author.html#202">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
