<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto inc-chercher-squelette.php3,NONE,1.1 spip_cal.php3,1.2,1.3 sommaire.php3,1.2,1.3 index.php3,1.2,1.3 inc-public.php3,1.2,1.3 typographie.css,1.2,1.3 spip_pass.php3,1.2,1.3 spip_cache.php3,1.2,1.3 spip_background.php3,1.2,1.3 inc-urls-standard.php3,1.2,1.3 inc-compilo.php3,1.2,1.3 inc-urls-html.php3,1.2,1.3 inc-html-squel.php3,1.2,1.3 resume.php3,1.2,1.3 spip_admin.css,1.2,1.3 spip_image.php3,1.2,1.3 inc-stats.php3,1.2,1.3 rubrique.php3,1.2,1.3 spip_redirect.php3,1.2,1.3 index.php,1.2,1.3 inc-compilo-api.php3,1.2,1.3 inc-compilo-index.php3,1.2,1.3 mot.php3,1.2,1.3 mes_fonctions.php3,1.2,1.3 recherche.php3,1.2,1.3 site.php3,1.2,1.3 spip_acces_doc.php3,1.2,1.3 plan.php3,1.2,1.3 spip_style.css,1.2,1.3 spip_inscription.php3,1.2,1.3 spip_barre.js,1.2,1.3 sommaire_texte.php3,1.2,1.3 spip_login.php3,1.2,1.3 inc-messforum.php3,1.2,1.3 spip_carto.php,1.2,1.3 inc-criteres.php3,1.2,1.3 spip_image_reduite.php3,1.2,1.3 inc-public-global.php3,1.2,1.3 inc-urls-propres.php3! ,1.2,1.3 spip_test_dirs.php3,1.2,1.3 spip_cookie.php3,1.2,1.3
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-February/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20inc-chercher-squelette.php3%2CNONE%2C1.1%20spip_cal.php3%2C1.2%2C1.3%20sommaire.php3%2C1.2%2C1.3%20index.php3%2C1.2%2C1.3%20inc-public.php3%2C1.2%2C1.3%20typographie.css%2C1.2%2C1.3%20spip_pass.php3%2C1.2%2C1.3%20spip_cache.php3%2C1.2%2C1.3%20spip_background.php3%2C1.2%2C1.3%20inc-urls-standard.php3%2C1.2%2C1.3%20inc-compilo.php3%2C1.2%2C1.3%20inc-urls-html.php3%2C1.2%2C1.3%20inc-html-squel.php3%2C1.2%2C1.3%20resume.php3%2C1.2%2C1.3%20spip_admin.css%2C1.2%2C1.3%20spip_image.php3%2C1.2%2C1.3%20inc-stats.php3%2C1.2%2C1.3%20rubrique.php3%2C1.2%2C1.3%20spip_redirect.php3%2C1.2%2C1.3%20index.php%2C1.2%2C1.3%20inc-compilo-api.php3%2C1.2%2C1.3%20inc-compilo-index.php3%2C1.2%2C1.3%20mot.php3%2C1.2%2C1.3%20mes_fonctions.php3%2C1.2%2C1.3%20recherche.php3%2C1.2%2C1.3%20site.php3%2C1.2%2C1.3%20spip_acces_doc.php3%2C1.2%2C1.3%20plan.php3%2C1.2%2C1.3%20spip_style.css%2C1.2%2C1.3%20spip_inscription.php3%2C1.2%2C1.3%20spip_barre.js%2C1.2%2C1.3%20sommaire_texte.php3%2C1.2%2C1.3%20spip_login.php3%2C1.2%2C1.3%20inc-messforum.php3%2C1.2%2C1.3%20spip_carto.php%2C1.2%2C1.3%20inc-criteres.php3%2C1.2%2C1.3%20spip_image_reduite.php3%2C1.2%2C1.3%20inc-public-global.php3%2C1.2%2C1.3%20inc-urls-propres.php3%21%0A%20%2C1.2%2C1.3%20spip_test_dirs.php3%2C1.2%2C1.3%20spip_cookie.php3%2C1.2%2C1.3&In-Reply-To=%3C200502202216.j1KMGo8Y027659%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000088.html">
   <LINK REL="Next"  HREF="000090.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto inc-chercher-squelette.php3,NONE,1.1 spip_cal.php3,1.2,1.3 sommaire.php3,1.2,1.3 index.php3,1.2,1.3 inc-public.php3,1.2,1.3 typographie.css,1.2,1.3 spip_pass.php3,1.2,1.3 spip_cache.php3,1.2,1.3 spip_background.php3,1.2,1.3 inc-urls-standard.php3,1.2,1.3 inc-compilo.php3,1.2,1.3 inc-urls-html.php3,1.2,1.3 inc-html-squel.php3,1.2,1.3 resume.php3,1.2,1.3 spip_admin.css,1.2,1.3 spip_image.php3,1.2,1.3 inc-stats.php3,1.2,1.3 rubrique.php3,1.2,1.3 spip_redirect.php3,1.2,1.3 index.php,1.2,1.3 inc-compilo-api.php3,1.2,1.3 inc-compilo-index.php3,1.2,1.3 mot.php3,1.2,1.3 mes_fonctions.php3,1.2,1.3 recherche.php3,1.2,1.3 site.php3,1.2,1.3 spip_acces_doc.php3,1.2,1.3 plan.php3,1.2,1.3 spip_style.css,1.2,1.3 spip_inscription.php3,1.2,1.3 spip_barre.js,1.2,1.3 sommaire_texte.php3,1.2,1.3 spip_login.php3,1.2,1.3 inc-messforum.php3,1.2,1.3 spip_carto.php,1.2,1.3 inc-criteres.php3,1.2,1.3 spip_image_reduite.php3,1.2,1.3 inc-public-global.php3,1.2,1.3 inc-urls-propres.php3! ,1.2,1.3 spip_test_dirs.php3,1.2,1.3 spip_cookie.php3,1.2,1.3</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20inc-chercher-squelette.php3%2CNONE%2C1.1%20spip_cal.php3%2C1.2%2C1.3%20sommaire.php3%2C1.2%2C1.3%20index.php3%2C1.2%2C1.3%20inc-public.php3%2C1.2%2C1.3%20typographie.css%2C1.2%2C1.3%20spip_pass.php3%2C1.2%2C1.3%20spip_cache.php3%2C1.2%2C1.3%20spip_background.php3%2C1.2%2C1.3%20inc-urls-standard.php3%2C1.2%2C1.3%20inc-compilo.php3%2C1.2%2C1.3%20inc-urls-html.php3%2C1.2%2C1.3%20inc-html-squel.php3%2C1.2%2C1.3%20resume.php3%2C1.2%2C1.3%20spip_admin.css%2C1.2%2C1.3%20spip_image.php3%2C1.2%2C1.3%20inc-stats.php3%2C1.2%2C1.3%20rubrique.php3%2C1.2%2C1.3%20spip_redirect.php3%2C1.2%2C1.3%20index.php%2C1.2%2C1.3%20inc-compilo-api.php3%2C1.2%2C1.3%20inc-compilo-index.php3%2C1.2%2C1.3%20mot.php3%2C1.2%2C1.3%20mes_fonctions.php3%2C1.2%2C1.3%20recherche.php3%2C1.2%2C1.3%20site.php3%2C1.2%2C1.3%20spip_acces_doc.php3%2C1.2%2C1.3%20plan.php3%2C1.2%2C1.3%20spip_style.css%2C1.2%2C1.3%20spip_inscription.php3%2C1.2%2C1.3%20spip_barre.js%2C1.2%2C1.3%20sommaire_texte.php3%2C1.2%2C1.3%20spip_login.php3%2C1.2%2C1.3%20inc-messforum.php3%2C1.2%2C1.3%20spip_carto.php%2C1.2%2C1.3%20inc-criteres.php3%2C1.2%2C1.3%20spip_image_reduite.php3%2C1.2%2C1.3%20inc-public-global.php3%2C1.2%2C1.3%20inc-urls-propres.php3%21%0A%20%2C1.2%2C1.3%20spip_test_dirs.php3%2C1.2%2C1.3%20spip_cookie.php3%2C1.2%2C1.3&In-Reply-To=%3C200502202216.j1KMGo8Y027659%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto inc-chercher-squelette.php3,NONE,1.1 spip_cal.php3,1.2,1.3 sommaire.php3,1.2,1.3 index.php3,1.2,1.3 inc-public.php3,1.2,1.3 typographie.css,1.2,1.3 spip_pass.php3,1.2,1.3 spip_cache.php3,1.2,1.3 spip_background.php3,1.2,1.3 inc-urls-standard.php3,1.2,1.3 inc-compilo.php3,1.2,1.3 inc-urls-html.php3,1.2,1.3 inc-html-squel.php3,1.2,1.3 resume.php3,1.2,1.3 spip_admin.css,1.2,1.3 spip_image.php3,1.2,1.3 inc-stats.php3,1.2,1.3 rubrique.php3,1.2,1.3 spip_redirect.php3,1.2,1.3 index.php,1.2,1.3 inc-compilo-api.php3,1.2,1.3 inc-compilo-index.php3,1.2,1.3 mot.php3,1.2,1.3 mes_fonctions.php3,1.2,1.3 recherche.php3,1.2,1.3 site.php3,1.2,1.3 spip_acces_doc.php3,1.2,1.3 plan.php3,1.2,1.3 spip_style.css,1.2,1.3 spip_inscription.php3,1.2,1.3 spip_barre.js,1.2,1.3 sommaire_texte.php3,1.2,1.3 spip_login.php3,1.2,1.3 inc-messforum.php3,1.2,1.3 spip_carto.php,1.2,1.3 inc-criteres.php3,1.2,1.3 spip_image_reduite.php3,1.2,1.3 inc-public-global.php3,1.2,1.3 inc-urls-propres.php3! ,1.2,1.3 spip_test_dirs.php3,1.2,1.3 spip_cookie.php3,1.2,1.3">stef at berlios.de
       </A><BR>
    <I>Sun Feb 20 23:16:50 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000088.html">[Spip-carto-cvs] spipcarto COPYING.txt,NONE,1.1
</A></li>
        <LI>Next message: <A HREF="000090.html">[Spip-carto-cvs] spipcarto/dist ical.html,1.1,1.2 resume.html,1.1,1.2 site.html,1.1,1.2 login.html,1.1,1.2 breve.html,1.1,1.2 sommaire.html,1.1,1.2 404.html,1.1,1.2 sommaire_texte.html,1.1,1.2 nouveautes.html,1.1,1.2 404.php3,1.1,1.2 rubrique.html,1.1,1.2 distrib.html,1.1,1.2 forum.html,1.1,1.2 recherche.html,1.1,1.2 auteur.html,1.1,1.2 article.html,1.1,1.2 mot.html,1.1,1.2 plan.html,1.1,1.2 backend-breves.html,1.1,1.2 backend.html,1.1,1.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#92">[ date ]</a>
              <a href="thread.html#92">[ thread ]</a>
              <a href="subject.html#92">[ subject ]</a>
              <a href="author.html#92">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv27631

Modified Files:
	spip_cal.php3 sommaire.php3 index.php3 inc-public.php3 
	typographie.css spip_pass.php3 spip_cache.php3 
	spip_background.php3 inc-urls-standard.php3 inc-compilo.php3 
	inc-urls-html.php3 inc-html-squel.php3 resume.php3 
	spip_admin.css spip_image.php3 inc-stats.php3 rubrique.php3 
	spip_redirect.php3 index.php inc-compilo-api.php3 
	inc-compilo-index.php3 mot.php3 mes_fonctions.php3 
	recherche.php3 site.php3 spip_acces_doc.php3 plan.php3 
	spip_style.css spip_inscription.php3 spip_barre.js 
	sommaire_texte.php3 spip_login.php3 inc-messforum.php3 
	spip_carto.php inc-criteres.php3 spip_image_reduite.php3 
	inc-public-global.php3 inc-urls-propres.php3 
	spip_test_dirs.php3 spip_cookie.php3 
Added Files:
	inc-chercher-squelette.php3 
Log Message:
1.8pr1

--- NEW FILE: inc-chercher-squelette.php3 ---
&lt;?php

/***************************************************************************\
 *  SPIP, Systeme de publication pour l'internet                           *
 *                                                                         *
 *  Copyright (c) 2001-2005                                                *
 *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
 *                                                                         *
 *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
 *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
\***************************************************************************/


// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_CHERCHER&quot;)) return;
define(&quot;_INC_CHERCHER&quot;, &quot;1&quot;);

// Ce fichier doit imperativement contenir la fonction chercher-squelette
// (cf commentaires dans inc-calcul)

function chercher_squelette($fond, $id_rubrique, $lang) {
	$ext = $GLOBALS['extension_squelette'];

	// Accrocher un squelette de base dans le chemin
	if (!$base = find_in_path(&quot;$fond.$ext&quot;)) {
		// erreur webmaster : $fond ne correspond a rien
		erreur_squelette(_T('info_erreur_squelette2',
			 array('fichier'=&gt;$fond)),
			 $dossier);
		return '';
	}

	// supprimer le &quot;.html&quot; pour pouvoir affiner par id_rubrique ou par langue
	$squelette = substr($base, 0, - strlen(&quot;.$ext&quot;));

	// On selectionne, dans l'ordre :
	// fond=10
	$f = &quot;$squelette=$id_rubrique&quot;;
	if (($id_rubrique &gt; 0) AND (@file_exists(&quot;$f.$ext&quot;)))
		$squelette = $f;
	else {
		// fond-10 fond-&lt;rubriques parentes&gt;
		while ($id_rubrique &gt; 0) {
			$f = &quot;$squelette-$id_rubrique&quot;;
			if (@file_exists(&quot;$f.$ext&quot;)) {
				$squelette = $f;
				break;
			}
			else
				$id_rubrique = sql_parent($id_rubrique);
		}
	}

	// Affiner par lang
	if ($lang) {
		lang_select($lang);
		$f = &quot;$squelette.$lang&quot;;
		if (@file_exists(&quot;$f.$ext&quot;))
			$squelette = $f;
	}

	return $squelette;
}

?&gt;

Index: spip_cal.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cal.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_cal.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_cal.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,324 +1,335 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_filtres.php3&quot;);
-include_ecrire(&quot;inc_lang.php3&quot;);
-include_ecrire(&quot;inc_texte.php3&quot;);
-include_ecrire(&quot;inc_charsets.php3&quot;);
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_admin.php3&quot;);
-include_ecrire(&quot;inc_acces.php3&quot;);
-
-/*
-function ligne_x ($texte) {
-	if (ereg(&quot;^BEGIN&quot;, $texte)) echo &quot;&lt;br&gt;&quot;;
-	echo $texte.&quot;&lt;br&gt;&quot;;
-}
-*/
-function ligne ($texte) {
-	echo filtrer_ical($texte).&quot;\n&quot;;
-}
-
-$nom_site = lire_meta(&quot;nom_site&quot;);
-$adresse_site = lire_meta(&quot;adresse_site&quot;);
-
-// securite
-unset($id_utilisateur);
-$id_auteur = intval($id);
-
-// verifier la cle
-if (verifier_low_sec($id_auteur, $cle, 'ical')) {
-	$query = &quot;SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur&quot;;
-	$result = spip_query($query);
-
-	if ($row = spip_fetch_array($result)) {
-		$id_utilisateur=$row['id_auteur'];
-		$nom_utilisateur=$row['nom'];
-		$statut_utilisateur=$row['statut'];
-		$langue_utilisateur=$row['lang'];
-	}
-}
-if (!$id_utilisateur) {
-	echo _T('info_acces_interdit');
-	exit;
-}
-
-lang_select($langue_utilisateur);
-
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at header</A>(&quot;content-type:text/calendar; charset=utf-8&quot;);
-
-ligne (&quot;BEGIN:VCALENDAR&quot;);
-ligne (&quot;CALSCALE:GREGORIAN&quot;);
-ligne (&quot;X-WR-CALNAME;VALUE=TEXT:$nom_site / $nom_utilisateur&quot;);
-ligne (&quot;X-WR-RELCALID:cal$id_utilisateur @ $adresse_site&quot;);
-
-
-// rendez-vous
-$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
-while($row=spip_fetch_array($result_messages)){
-	$id_message=$row['id_message'];
-	$date_heure=$row[&quot;date_heure&quot;];
-	$date_heure_fin=$row[&quot;date_fin&quot;];
-	//$titre=typo($row[&quot;titre&quot;]);
-	$titre = $row[&quot;titre&quot;];
-	$texte = $row[&quot;texte&quot;];
-	$type=$row[&quot;type&quot;];
-
-	if ($type == 'normal') {
-		$le_type = _T('info_message_2');
-		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
-		while($row_auteur=spip_fetch_array($result_auteurs)){
-			$id_auteur=$row_auteur['id_auteur'];
-			$nom_auteur=$row_auteur['nom'];
-			$email = $row_auteur ['email'];
-
-			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
-			
-			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
-			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
-		}
-	}
-	else if ($type == 'pb') {
-		$le_type = _T('info_pense_bete');
-	}
-	else if ($type == 'affich') {
-		$le_type = _T('info_annonce');
-		$titre = &quot;[$nom_site] $titre&quot;;
-	}
-
-	ligne (&quot;BEGIN:VEVENT&quot;);
-	ligne (&quot;SUMMARY:&quot;.$titre);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
-	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
-	if ($date_heure_fin &gt; $date_heure) ligne (&quot;DTEND:&quot;.date_ical($date_heure_fin));
-
-	ligne (&quot;CATEGORIES:$le_type&quot;);
-	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
-	
-	ligne (&quot;END:VEVENT&quot;);
-	
-}
-
-// todo
-$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message AND messages.type='pb' AND messages.rv!='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
-while($row=spip_fetch_array($result_messages)){
-	$id_message=$row['id_message'];
-	$date_heure=$row[&quot;date_heure&quot;];
-	$titre = $row[&quot;titre&quot;];
-	$texte = $row[&quot;texte&quot;];
-	$type=$row[&quot;type&quot;];
-
-	if ($type == 'normal') {
-		$le_type = _T('info_message_2');
-		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
-		while($row_auteur=spip_fetch_array($result_auteurs)){
-			$id_auteur=$row_auteur['id_auteur'];
-			$nom_auteur=$row_auteur['nom'];
-			$email = $row_auteur ['email'];
-
-			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
-			
-			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
-			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
-		}
-	}
-	else if ($type == 'pb') {
-		$le_type = _T('info_pense_bete');
-	}
-	else if ($type == 'affich') {
-		$le_type = _T('info_annonce');
-		$titre = &quot;[$nom_site] $titre&quot;;
-	}
-	
-	ligne (&quot;BEGIN:VTODO&quot;);
-	ligne (&quot;SUMMARY:&quot;.$titre);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
-	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
-	ligne (&quot;CATEGORIES:$le_type&quot;);
-	ligne (&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
-	ligne (&quot;END:VTODO&quot;);
-
-}
-
-// Articles et breves proposes
-$titres = Array();
-$result_articles = spip_query(&quot;SELECT id_article, titre, date FROM spip_articles WHERE statut = 'prop'&quot;);
-while($row=spip_fetch_array($result_articles)){
-	$id_article=$row['id_article'];
-	$titre = supprimer_numero($row['titre']);
-	$titres[] = $titre;
-	$date_heure = $row['date'];
-	$nb_articles ++;
-	ligne (&quot;BEGIN:VEVENT&quot;);
-	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('info_article_propose').&quot;)&quot;);
-	ligne (&quot;UID:article$id_article @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;CATEGORIES:&quot;._T('info_article_propose'));
-	ligne(&quot;URL:$adresse_site/ecrire/articles.php3?id_article=$id_article&quot;);
-	ligne (&quot;END:VEVENT&quot;);
-}
-
-$result_articles = spip_query(&quot;SELECT id_breve, titre, date_heure FROM spip_breves WHERE statut = 'prop'&quot;);
-while($row=spip_fetch_array($result_articles)){
-	$id_breve=$row['id_breve'];
-	$titre = supprimer_numero($row['titre']);
-	$titres[] = $titre;
-	$date_heure = $row['date_heure'];
-	$nb_breves++;
-	ligne (&quot;BEGIN:VEVENT&quot;);
-	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('item_breve_proposee').&quot;)&quot;);
-	ligne (&quot;UID:breve$id_breve @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;CATEGORIES:&quot;._T('item_breve_proposee'));
-	ligne (&quot;URL:$adresse_site/ecrire/breves_voir.php3?id_breve=$id_breve&quot;);
-	ligne (&quot;END:VEVENT&quot;);
-
-}
-
-if ($nb_articles + $nb_breves &gt; 0) {
-	if ($nb_articles &gt; 0) $titre_prop[] = _T('info_articles_proposes').&quot;: &quot;.$nb_articles;
-	if ($nb_breves &gt; 0) $titre_prop[] = _T('info_breves_valider').&quot;: &quot;.$nb_breves;
-	$titre = join($titre_prop,&quot; / &quot;);
-	ligne (&quot;BEGIN:VTODO&quot;);
-	ligne (&quot;SUMMARY:[$nom_site] $titre&quot;);
-	ligne (&quot;UID:prop @ $adresse_site&quot;);
-	$texte = join($titres,&quot; / &quot;);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	
-	$today=getdate(time());
-	$jour = $today[&quot;mday&quot;];
-	$mois=$today[&quot;mon&quot;];
-	$annee=$today[&quot;year&quot;];
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-	ligne (&quot;CATEGORIES:&quot;._T('icone_a_suivre'));
-	ligne (&quot;URL:$adresse_site/ecrire/&quot;);
-	ligne (&quot;END:VTODO&quot;);
-}
-
-
-// Nouveaux messages
-
-$result_messages = spip_query(&quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur=$id_utilisateur AND vu='non' AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message&quot;);
-while($row=spip_fetch_array($result_messages)){
-	$id_message=$row['id_message'];
-	$date_heure=$row[&quot;date_heure&quot;];
-	$titre = $row[&quot;titre&quot;];
-	$texte = $row[&quot;texte&quot;];
-	$type=$row[&quot;type&quot;];
-
-	if ($type == 'normal') {
-		$le_type = _T('info_message_2');
-		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
-		while($row_auteur=spip_fetch_array($result_auteurs)){
-			$id_auteur=$row_auteur['id_auteur'];
-			$nom_auteur = $row_auteur['nom'];
-			$email = $row_auteur ['email'];
-
-			if ($id_auteur != $id_utilisateur) $titre = $nom_auteur.&quot; - &quot;.$titre;
-			
-			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
-			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
-		}
-		$query_forum = &quot;SELECT * FROM spip_forum WHERE statut='perso' AND id_message='$id_message' ORDER BY date_heure DESC LIMIT 0,1&quot;;
-		$result_forum = spip_query($query_forum);
-		if ($row_forum = spip_fetch_array($result_forum)) {
-			$date_heure = $row_forum[&quot;date_heure&quot;];
-			$texte = $row_forum[&quot;texte&quot;];
-			$titre = $row_forum[&quot;titre&quot;];
-			$id_auteur = $row_forum[&quot;id_auteur&quot;];
-
-			$result_auteurs2 = spip_query(&quot;SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur&quot;);
-			if ($row_auteur2 = spip_fetch_array($result_auteurs2)){
-				$nom_auteur = $row_auteur2['nom'];
-				$email = $row_auteur2 ['email'];
-				
-				$titre = $nom_auteur.&quot; - &quot;.$titre;
-			}
-		}
-	}
-	else if ($type == 'pb') {
-		$le_type = _T('info_pense_bete');
-	}
-	else if ($type == 'affich') {
-		$le_type = _T('info_annonce');
-		$titre = &quot;[$nom_site] $titre&quot;;
-	}
-
-	
-	
-	ligne (&quot;BEGIN:VTODO&quot;);
-	ligne (&quot;SUMMARY:&quot;.$titre);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	ligne (&quot;UID:nouv_mess$id_message @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;CATEGORIES:$le_type&quot;);
-	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
-	ligne (&quot;END:VTODO&quot;);
-	
-}
-
-// Messages de forum a valider
-if ($statut_utilisateur == &quot;0minirezo&quot;) {
-
-	$query_forum = &quot;SELECT * FROM spip_forum WHERE statut = 'prop'&quot;;
-	$result_forum = spip_query($query_forum);
-
-	while($row=spip_fetch_array($result_forum)){
-		$nb_forum ++;
-	
-		$id_forum=$row['id_forum'];
-		$date_heure = $row['date_heure'];
-		$titre = $row['titre'];
-		$texte = $row['texte'];
-		$auteur = $row['auteur'];
-		$email_auteur = $row['email_auteur'];
-		if ($email_auteur) $email_auteur = &quot;&lt;$email_auteur&gt;&quot;;
-		
-		ligne (&quot;BEGIN:VEVENT&quot;);
-		ligne (&quot;SUMMARY:[$nom_site] $titre &quot;._T('icone_forum_suivi'));
-		ligne (&quot;DESCRIPTION:$texte\r$auteur $email_auteur&quot;);
-		ligne (&quot;UID:forum$id_forum @ $adresse_site&quot;);
-		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-		ligne (&quot;DTEND:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure)+60,0,mois($date_heure),jour($date_heure),annee($date_heure))));
-		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
-		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
-		ligne (&quot;END:VEVENT&quot;);
-
-
-		
-	}
-
-	if ($nb_forum &gt; 0) {
-		ligne (&quot;BEGIN:VTODO&quot;);
-		ligne (&quot;SUMMARY:[$nom_site] &quot;._T('icone_forum_suivi').&quot;: $nb_forum&quot;);
-		ligne (&quot;UID:forum @ $adresse_site&quot;);
-		
-		$today=getdate(time());
-		$jour = $today[&quot;mday&quot;];
-		$mois=$today[&quot;mon&quot;];
-		$annee=$today[&quot;year&quot;];
-		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
-		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
-		ligne (&quot;END:VTODO&quot;);
-	}
-}
-
-
-
-
-ligne (&quot;END:VCALENDAR&quot;);
-
-
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+include (&quot;ecrire/inc_version.php3&quot;);
+
+include_ecrire(&quot;inc_filtres.php3&quot;);
+include_ecrire(&quot;inc_lang.php3&quot;);
+include_ecrire(&quot;inc_texte.php3&quot;);
+include_ecrire(&quot;inc_charsets.php3&quot;);
+include_ecrire(&quot;inc_meta.php3&quot;);
+include_ecrire(&quot;inc_admin.php3&quot;);
+include_ecrire(&quot;inc_acces.php3&quot;);
+
+/*
+function ligne_x ($texte) {
+	if (ereg(&quot;^BEGIN&quot;, $texte)) echo &quot;&lt;br&gt;&quot;;
+	echo $texte.&quot;&lt;br&gt;&quot;;
+}
+*/
+function ligne ($texte) {
+	echo filtrer_ical($texte).&quot;\n&quot;;
+}
+
+$nom_site = lire_meta(&quot;nom_site&quot;);
+$adresse_site = lire_meta(&quot;adresse_site&quot;);
+
+// securite
+unset($id_utilisateur);
+$id_auteur = intval($id);
+
+// verifier la cle
+if (verifier_low_sec($id_auteur, $cle, 'ical')) {
+	$query = &quot;SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur&quot;;
+	$result = spip_query($query);
+
+	if ($row = spip_fetch_array($result)) {
+		$id_utilisateur=$row['id_auteur'];
+		$nom_utilisateur=$row['nom'];
+		$statut_utilisateur=$row['statut'];
+		$langue_utilisateur=$row['lang'];
+	}
+}
+if (!$id_utilisateur) {
+	echo _T('info_acces_interdit');
+	exit;
+}
+
+lang_select($langue_utilisateur);
+
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A>(&quot;content-type:text/calendar; charset=utf-8&quot;);
+
+ligne (&quot;BEGIN:VCALENDAR&quot;);
+ligne (&quot;CALSCALE:GREGORIAN&quot;);
+ligne (&quot;X-WR-CALNAME;VALUE=TEXT:$nom_site / $nom_utilisateur&quot;);
+ligne (&quot;X-WR-RELCALID:cal$id_utilisateur @ $adresse_site&quot;);
+
+
+// rendez-vous
+$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
+while($row=spip_fetch_array($result_messages)){
+	$id_message=$row['id_message'];
+	$date_heure=$row[&quot;date_heure&quot;];
+	$date_heure_fin=$row[&quot;date_fin&quot;];
+	//$titre=typo($row[&quot;titre&quot;]);
+	$titre = $row[&quot;titre&quot;];
+	$texte = $row[&quot;texte&quot;];
+	$type=$row[&quot;type&quot;];
+
+	if ($type == 'normal') {
+		$le_type = _T('info_message_2');
+		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
+		while($row_auteur=spip_fetch_array($result_auteurs)){
+			$id_auteur=$row_auteur['id_auteur'];
+			$nom_auteur=$row_auteur['nom'];
+			$email = $row_auteur ['email'];
+
+			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
+			
+			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
+			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
+		}
+	}
+	else if ($type == 'pb') {
+		$le_type = _T('info_pense_bete');
+	}
+	else if ($type == 'affich') {
+		$le_type = _T('info_annonce');
+		$titre = &quot;[$nom_site] $titre&quot;;
+	}
+
+	ligne (&quot;BEGIN:VEVENT&quot;);
+	ligne (&quot;SUMMARY:&quot;.$titre);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
+	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
+	if ($date_heure_fin &gt; $date_heure) ligne (&quot;DTEND:&quot;.date_ical($date_heure_fin));
+
+	ligne (&quot;CATEGORIES:$le_type&quot;);
+	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
+	
+	ligne (&quot;END:VEVENT&quot;);
+	
+}
+
+// todo
+$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message AND messages.type='pb' AND messages.rv!='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
+while($row=spip_fetch_array($result_messages)){
+	$id_message=$row['id_message'];
+	$date_heure=$row[&quot;date_heure&quot;];
+	$titre = $row[&quot;titre&quot;];
+	$texte = $row[&quot;texte&quot;];
+	$type=$row[&quot;type&quot;];
+
+	if ($type == 'normal') {
+		$le_type = _T('info_message_2');
+		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
+		while($row_auteur=spip_fetch_array($result_auteurs)){
+			$id_auteur=$row_auteur['id_auteur'];
+			$nom_auteur=$row_auteur['nom'];
+			$email = $row_auteur ['email'];
+
+			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
+			
+			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
+			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
+		}
+	}
+	else if ($type == 'pb') {
+		$le_type = _T('info_pense_bete');
+	}
+	else if ($type == 'affich') {
+		$le_type = _T('info_annonce');
+		$titre = &quot;[$nom_site] $titre&quot;;
+	}
+	
+	ligne (&quot;BEGIN:VTODO&quot;);
+	ligne (&quot;SUMMARY:&quot;.$titre);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
+	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
+	ligne (&quot;CATEGORIES:$le_type&quot;);
+	ligne (&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
+	ligne (&quot;END:VTODO&quot;);
+
+}
+
+// Articles et breves proposes
+$titres = Array();
+$result_articles = spip_query(&quot;SELECT id_article, titre, date FROM spip_articles WHERE statut = 'prop'&quot;);
+while($row=spip_fetch_array($result_articles)){
+	$id_article=$row['id_article'];
+	$titre = supprimer_numero($row['titre']);
+	$titres[] = $titre;
+	$date_heure = $row['date'];
+	$nb_articles ++;
+	ligne (&quot;BEGIN:VEVENT&quot;);
+	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('info_article_propose').&quot;)&quot;);
+	ligne (&quot;UID:article$id_article @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;CATEGORIES:&quot;._T('info_article_propose'));
+	ligne(&quot;URL:$adresse_site/ecrire/articles.php3?id_article=$id_article&quot;);
+	ligne (&quot;END:VEVENT&quot;);
+}
+
+$result_articles = spip_query(&quot;SELECT id_breve, titre, date_heure FROM spip_breves WHERE statut = 'prop'&quot;);
+while($row=spip_fetch_array($result_articles)){
+	$id_breve=$row['id_breve'];
+	$titre = supprimer_numero($row['titre']);
+	$titres[] = $titre;
+	$date_heure = $row['date_heure'];
+	$nb_breves++;
+	ligne (&quot;BEGIN:VEVENT&quot;);
+	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('item_breve_proposee').&quot;)&quot;);
+	ligne (&quot;UID:breve$id_breve @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;CATEGORIES:&quot;._T('item_breve_proposee'));
+	ligne (&quot;URL:$adresse_site/ecrire/breves_voir.php3?id_breve=$id_breve&quot;);
+	ligne (&quot;END:VEVENT&quot;);
+
+}
+
+if ($nb_articles + $nb_breves &gt; 0) {
+	if ($nb_articles &gt; 0) $titre_prop[] = _T('info_articles_proposes').&quot;: &quot;.$nb_articles;
+	if ($nb_breves &gt; 0) $titre_prop[] = _T('info_breves_valider').&quot;: &quot;.$nb_breves;
+	$titre = join($titre_prop,&quot; / &quot;);
+	ligne (&quot;BEGIN:VTODO&quot;);
+	ligne (&quot;SUMMARY:[$nom_site] $titre&quot;);
+	ligne (&quot;UID:prop @ $adresse_site&quot;);
+	$texte = join($titres,&quot; / &quot;);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	
+	$today=getdate(time());
+	$jour = $today[&quot;mday&quot;];
+	$mois=$today[&quot;mon&quot;];
+	$annee=$today[&quot;year&quot;];
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+	ligne (&quot;CATEGORIES:&quot;._T('icone_a_suivre'));
+	ligne (&quot;URL:$adresse_site/ecrire/&quot;);
+	ligne (&quot;END:VTODO&quot;);
+}
+
+
+// Nouveaux messages
+
+$result_messages = spip_query(&quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur=$id_utilisateur AND vu='non' AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message&quot;);
+while($row=spip_fetch_array($result_messages)){
+	$id_message=$row['id_message'];
+	$date_heure=$row[&quot;date_heure&quot;];
+	$titre = $row[&quot;titre&quot;];
+	$texte = $row[&quot;texte&quot;];
+	$type=$row[&quot;type&quot;];
+
+	if ($type == 'normal') {
+		$le_type = _T('info_message_2');
+		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
+		while($row_auteur=spip_fetch_array($result_auteurs)){
+			$id_auteur=$row_auteur['id_auteur'];
+			$nom_auteur = $row_auteur['nom'];
+			$email = $row_auteur ['email'];
+
+			if ($id_auteur != $id_utilisateur) $titre = $nom_auteur.&quot; - &quot;.$titre;
+			
+			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
+			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
+		}
+		$query_forum = &quot;SELECT * FROM spip_forum WHERE statut='perso' AND id_message='$id_message' ORDER BY date_heure DESC LIMIT 0,1&quot;;
+		$result_forum = spip_query($query_forum);
+		if ($row_forum = spip_fetch_array($result_forum)) {
+			$date_heure = $row_forum[&quot;date_heure&quot;];
+			$texte = $row_forum[&quot;texte&quot;];
+			$titre = $row_forum[&quot;titre&quot;];
+			$id_auteur = $row_forum[&quot;id_auteur&quot;];
+
+			$result_auteurs2 = spip_query(&quot;SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur&quot;);
+			if ($row_auteur2 = spip_fetch_array($result_auteurs2)){
+				$nom_auteur = $row_auteur2['nom'];
+				$email = $row_auteur2 ['email'];
+				
+				$titre = $nom_auteur.&quot; - &quot;.$titre;
+			}
+		}
+	}
+	else if ($type == 'pb') {
+		$le_type = _T('info_pense_bete');
+	}
+	else if ($type == 'affich') {
+		$le_type = _T('info_annonce');
+		$titre = &quot;[$nom_site] $titre&quot;;
+	}
+
+	
+	
+	ligne (&quot;BEGIN:VTODO&quot;);
+	ligne (&quot;SUMMARY:&quot;.$titre);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	ligne (&quot;UID:nouv_mess$id_message @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;CATEGORIES:$le_type&quot;);
+	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
+	ligne (&quot;END:VTODO&quot;);
+	
+}
+
+// Messages de forum a valider
+if ($statut_utilisateur == &quot;0minirezo&quot;) {
+
+	$query_forum = &quot;SELECT * FROM spip_forum WHERE statut = 'prop'&quot;;
+	$result_forum = spip_query($query_forum);
+
+	while($row=spip_fetch_array($result_forum)){
+		$nb_forum ++;
+	
+		$id_forum=$row['id_forum'];
+		$date_heure = $row['date_heure'];
+		$titre = $row['titre'];
+		$texte = $row['texte'];
+		$auteur = $row['auteur'];
+		$email_auteur = $row['email_auteur'];
+		if ($email_auteur) $email_auteur = &quot;&lt;$email_auteur&gt;&quot;;
+		
+		ligne (&quot;BEGIN:VEVENT&quot;);
+		ligne (&quot;SUMMARY:[$nom_site] $titre &quot;._T('icone_forum_suivi'));
+		ligne (&quot;DESCRIPTION:$texte\r$auteur $email_auteur&quot;);
+		ligne (&quot;UID:forum$id_forum @ $adresse_site&quot;);
+		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+		ligne (&quot;DTEND:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure)+60,0,mois($date_heure),jour($date_heure),annee($date_heure))));
+		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
+		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
+		ligne (&quot;END:VEVENT&quot;);
+
+
+		
+	}
+
+	if ($nb_forum &gt; 0) {
+		ligne (&quot;BEGIN:VTODO&quot;);
+		ligne (&quot;SUMMARY:[$nom_site] &quot;._T('icone_forum_suivi').&quot;: $nb_forum&quot;);
+		ligne (&quot;UID:forum @ $adresse_site&quot;);
+		
+		$today=getdate(time());
+		$jour = $today[&quot;mday&quot;];
+		$mois=$today[&quot;mon&quot;];
+		$annee=$today[&quot;year&quot;];
+		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
+		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
+		ligne (&quot;END:VTODO&quot;);
+	}
+}
+
+
+
+
+ligne (&quot;END:VCALENDAR&quot;);
+
+
 ?&gt;

Index: sommaire.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/sommaire.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- sommaire.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ sommaire.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,7 +1,7 @@
-&lt;?php
-$fond = &quot;sommaire&quot;;
-$delais = 2 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;sommaire&quot;;
+$delais = 2 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/index.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- index.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ index.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1 +1 @@
-&lt;?php include (&quot;sommaire.php3&quot;); ?&gt;
+&lt;?php include (&quot;sommaire.php3&quot;); ?&gt;

Index: inc-public.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-public.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-public.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-public.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,87 +1,98 @@
-&lt;?php
-
-// Distinguer une inclusion d'un appel initial
-if (defined(&quot;_INC_PUBLIC&quot;)) {
-	$page = inclure_page($fond, $delais, $contexte_inclus);
-	if ($page['process_ins'] == 'html')
-		echo $page['texte'];
-	else
-		eval('?' . '&gt;' . $page['texte']);
-
-	if ($page['lang_select'])
-		lang_dselect();
-
-} else {
-	define (&quot;_INC_PUBLIC&quot;, 1);
-	include (&quot;ecrire/inc_version.php3&quot;);
-	include_local('inc-public-global.php3');
-
-	// Calculer la page sans evaluer le php qu'elle contient
-	$page = calcule_header_et_page ($fond, $delais);
-
-	// Execution de la page calculee
-
-	// 1. Cas d'une page contenant uniquement du HTML :
-	if ($page['process_ins'] == 'html') {
-		$page = $page['texte'];
-	}
-
-	// 2. Cas d'une page contenant du PHP :
-	// Attention cette partie eval() doit imperativement
-	// etre declenchee dans l'espace des globales (donc pas
-	// dans une fonction).
-	else {
-	
-		// Une page &quot;normale&quot; va s'afficher ici
-		if (!($flag_ob AND ($var_mode == 'debug'
-		OR $var_recherche OR $affiche_boutons_admin))) {
-			eval('?' . '&gt;' . $page['texte']);
-			$page = '';
-		}
-
-		// Certains cas demandent un ob_start() de plus
-		else {
-			ob_start(); 
-			$res = eval('?' . '&gt;' . $page['texte']);
-			$page = ob_get_contents(); 
-			ob_end_clean();
-
-			// en cas d'erreur lors du eval,
-			// la memoriser dans le tableau des erreurs
-			// On ne revient pas ici si le nb d'erreurs &gt; 4
-			if ($res === false AND $affiche_boutons_admin
-			AND $auteur_session['statut'] == '0minirezo') {
-				include_ecrire('inc_debug_sql.php3');
-				erreur_squelette(_T('zbug_erreur_execution_page'));
-			}
-		}
-	}
-
-	// Passer la main au debuggueur le cas echeant 
-	if ($var_mode == 'debug') {
-		include_ecrire(&quot;inc_debug_sql.php3&quot;);
-		debug_dumpfile('',$var_mode_objet,$var_mode_affiche);
-	} 
-	if (count($tableau_des_erreurs) &gt; 0 AND $affiche_boutons_admin)
-	  $page = affiche_erreurs_page($tableau_des_erreurs) . $page;
-
-	// Traiter var_recherche pour surligner les mots
-	if ($var_recherche) {
-		include_ecrire(&quot;inc_surligne.php3&quot;);
-		$page = surligner_mots($page, $var_recherche);
-	}
-
-	// Inserer au besoin les boutons admins
-	if ($affiche_boutons_admin) {
-		include_local(&quot;inc-admin.php3&quot;);
-		$page = affiche_boutons_admin($page);
-	}
-
-	// Affichage final s'il en reste
-	echo $page;
-
-	// Taches de fond ?
-	terminer_public_global();
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// Distinguer une inclusion d'un appel initial
+if (defined(&quot;_INC_PUBLIC&quot;)) {
+	$page = inclure_page($fond, $delais, $contexte_inclus);
+	if ($page['process_ins'] == 'html')
+		echo $page['texte'];
+	else
+		eval('?' . '&gt;' . $page['texte']);
+
+	if ($page['lang_select'])
+		lang_dselect();
+
+} else {
+	define (&quot;_INC_PUBLIC&quot;, 1);
+	include (&quot;ecrire/inc_version.php3&quot;);
+	include_local('inc-public-global.php3');
+
+	// Calculer la page sans evaluer le php qu'elle contient
+	$page = calcule_header_et_page ($fond, $delais);
+
+	// Execution de la page calculee
+
+	// 1. Cas d'une page contenant uniquement du HTML :
+	if ($page['process_ins'] == 'html') {
+		$page = $page['texte'];
+	}
+
+	// 2. Cas d'une page contenant du PHP :
+	// Attention cette partie eval() doit imperativement
+	// etre declenchee dans l'espace des globales (donc pas
+	// dans une fonction).
+	else {
+	
+		// Une page &quot;normale&quot; va s'afficher ici
+		if (!($flag_ob AND ($var_mode == 'debug'
+		OR $var_recherche OR $affiche_boutons_admin))) {
+			eval('?' . '&gt;' . $page['texte']);
+			$page = '';
+		}
+
+		// Certains cas demandent un ob_start() de plus
+		else {
+			ob_start(); 
+			$res = eval('?' . '&gt;' . $page['texte']);
+			$page = ob_get_contents(); 
+			ob_end_clean();
+
+			// en cas d'erreur lors du eval,
+			// la memoriser dans le tableau des erreurs
+			// On ne revient pas ici si le nb d'erreurs &gt; 4
+			if ($res === false AND $affiche_boutons_admin
+			AND $auteur_session['statut'] == '0minirezo') {
+				include_ecrire('inc_debug_sql.php3');
+				erreur_squelette(_T('zbug_erreur_execution_page'));
+			}
+		}
+	}
+
+	// Passer la main au debuggueur le cas echeant 
+	if ($var_mode == 'debug') {
+		include_ecrire(&quot;inc_debug_sql.php3&quot;);
+		debug_dumpfile('',$var_mode_objet,$var_mode_affiche);
+	} 
+	if (count($tableau_des_erreurs) &gt; 0 AND $affiche_boutons_admin)
+		$page = affiche_erreurs_page($tableau_des_erreurs) . $page;
+
+	// Traiter var_recherche pour surligner les mots
+	if ($var_recherche) {
+		include_ecrire(&quot;inc_surligne.php3&quot;);
+		$page = surligner_mots($page, $var_recherche);
+	}
+
+	// Inserer au besoin les boutons admins
+	if ($affiche_boutons_admin) {
+		include_local(&quot;inc-admin.php3&quot;);
+		$page = affiche_boutons_admin($page);
+	}
+
+	// Affichage final s'il en reste
+	echo $page;
+
+	// Taches de fond ?
+	terminer_public_global();
+}
+
+?&gt;

Index: typographie.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/typographie.css,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- typographie.css	8 Feb 2005 15:10:11 -0000	1.2
+++ typographie.css	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,100 +1,100 @@
-
-/*
- * Correction des styles HTML par defaut
- */
-
-.structure {
-	display: none;
-}
-h1,h2,h3,h4 {
-	margin-top: 0em;
-	margin-bottom: 0em;
-	font-size: 100%;
-	font-weight: normal;
-}
-
-/*
- * Styles generaux
- */
-
-/* bien regler la marge (bugs IE) */
-body { background: white; margin: 10px; }
-a { text-decoration: none; color: #505050; }
-a:hover { text-decoration: none; color: #303030; background: #e8e8e8; }
-a.spip_out { text-decoration: none; color: #a02020; }
-a.spip_in, a.spip_url { text-decoration: none; color: #2020a0; }
-a.spip_glossaire { text-decoration: none; color: #20a020; }
-
-.chapo {
-	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
-	font-weight: bold;
-	text-align: justify;
-	font-size: 105%;
-}
-.texte, .texte p.spip {
-	font-family: Georgia, Garamond, Times, serif;
-	text-align: justify;
-}
-.ps {
-	font-family: Georgia, Garamond, Times, serif;
-	text-align: justify;
-	font-size: 85%;
-}
-.notes {
-	font-family: Georgia, Garamond, Times, serif;
-	text-align: left;
-	font-size: 80%;
-}
-
-/*
- * Ici les styles pour le contenu
- */
-
-.contenu h1,h2 {
-	font-size: 120%;
-	font-weight: bold;
-}
-.contenu h1,h2.titre-extrait {
-	font-size: 160%;
-	font-weight: bold;
-}
-.contenu h1,h2.titre-texte {
-	font-size: 190%;
-	font-weight: bold;
-}
-.contenu .surtitre {
-	font-size: 110%;
-	font-weight: bold;
-	font-variant: small-caps;
-}
-.contenu .detail {
-	font-size: 80%;
-	color: #303030;
-}
-.extrait {
-	border: groove 2px #a0a0a0;
-	padding: 1em;
-	font-size: 85%;
-}
-
-
-/*
- * Disposition a l'ecran
- */
-
-#principal {
-	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
-}
-
-#plan {
-	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
-}
-
-#navigation {
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-}
-
-.encart {
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-}
-
+
+/*
+ * Correction des styles HTML par defaut
+ */
+
+.structure {
+	display: none;
+}
+h1,h2,h3,h4 {
+	margin-top: 0em;
+	margin-bottom: 0em;
+	font-size: 100%;
+	font-weight: normal;
+}
+
+/*
+ * Styles generaux
+ */
+
+/* bien regler la marge (bugs IE) */
+body { background: white; margin: 10px; }
+a { text-decoration: none; color: #505050; }
+a:hover { text-decoration: none; color: #303030; background: #e8e8e8; }
+a.spip_out { text-decoration: none; color: #a02020; }
+a.spip_in, a.spip_url { text-decoration: none; color: #2020a0; }
+a.spip_glossaire { text-decoration: none; color: #20a020; }
+
+.chapo {
+	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
+	font-weight: bold;
+	text-align: justify;
+	font-size: 105%;
+}
+.texte, .texte p.spip {
+	font-family: Georgia, Garamond, Times, serif;
+	text-align: justify;
+}
+.ps {
+	font-family: Georgia, Garamond, Times, serif;
+	text-align: justify;
+	font-size: 85%;
+}
+.notes {
+	font-family: Georgia, Garamond, Times, serif;
+	text-align: left;
+	font-size: 80%;
+}
+
+/*
+ * Ici les styles pour le contenu
+ */
+
+.contenu h1,h2 {
+	font-size: 120%;
+	font-weight: bold;
+}
+.contenu h1,h2.titre-extrait {
+	font-size: 160%;
+	font-weight: bold;
+}
+.contenu h1,h2.titre-texte {
+	font-size: 190%;
+	font-weight: bold;
+}
+.contenu .surtitre {
+	font-size: 110%;
+	font-weight: bold;
+	font-variant: small-caps;
+}
+.contenu .detail {
+	font-size: 80%;
+	color: #303030;
+}
+.extrait {
+	border: groove 2px #a0a0a0;
+	padding: 1em;
+	font-size: 85%;
+}
+
+
+/*
+ * Disposition a l'ecran
+ */
+
+#principal {
+	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
+}
+
+#plan {
+	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
+}
+
+#navigation {
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+}
+
+.encart {
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+}
+

Index: spip_pass.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_pass.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_pass.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_pass.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,73 +1,84 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire(&quot;inc_presentation.php3&quot;); # pour install_debut
-include_ecrire(&quot;inc_session.php3&quot;); # pour creer_uniq_id
-include_ecrire(&quot;inc_mail.php3&quot;); # pour envoyer_mail
-include_ecrire(&quot;inc_acces.php3&quot;); # pour generer_htpass
-include_local(&quot;inc-public-global.php3&quot;); # pour calculer la page
-include_local (&quot;inc-cache.php3&quot;); # ici c'est pour tester la connexion SQL
-
-// Ce fichier est celui d'une balise dynamique qui s'ignore.
-
-function formulaire_oubli_dyn($p, $oubli)
-{
-
-$message = '';
-
-// au 3e appel la variable P est positionnee par le script lui-meme
-// et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
-if ($p = addslashes($p)) {
-	$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut&lt;&gt;'5poubelle' AND pass&lt;&gt;''&quot;);
-	if (!$row = spip_fetch_array($res)) 
-		$message = _T('pass_erreur_code_inconnu');
-	else {
-		if ($oubli) {
-			$mdpass = md5($oubli);
-			$htpass = generer_htpass($oubli);
-			spip_query(&quot;UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
-				cookie_oubli='' WHERE cookie_oubli='$p'&quot;);
-
-			$login = $row['login'];
-			$message = &quot;&lt;b&gt;&quot; . _T('pass_nouveau_enregistre') . &quot;&lt;/b&gt;&quot;.
-			&quot;&lt;p&gt;&quot; . _T('pass_rappel_login', array('login' =&gt; $login));
-		}
-	}
- } else { 
-  // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
-  if ($oubli) {
-	if ( email_valide($oubli) ) {
-		$email = addslashes($oubli);
-		$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE email ='$email'&quot;);
-		if ($row = spip_fetch_array($res)) {
-			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
-				$message = _T('pass_erreur_acces_refuse');
-			else {
-				$cookie = creer_uniqid();
-				spip_query(&quot;UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'&quot;);
-
-				if ( envoyer_mail($email,
-						 &quot;[&quot; . lire_meta(&quot;nom_site&quot;) .'] ' .  _T('pass_oubli_mot'),
-						 _T('pass_mail_passcookie',
-						    array('nom_site_spip' =&gt; lire_meta(&quot;nom_site&quot;),
-							  'adresse_site' =&gt; lire_meta(&quot;adresse_site&quot;), 
-							  'cookie' =&gt; $cookie))))
-					$message = _T('pass_recevoir_mail');
-				else
-					$message = _T('pass_erreur_probleme_technique');
-			}
-		}
-		else
-			$message = _T('pass_erreur_non_enregistre', array('email_oubli' =&gt; htmlspecialchars($oubli)));
-	} else {
-		$message = _T('pass_erreur_non_valide', array('email_oubli' =&gt; htmlspecialchars($oubli)));
-	}
-  }
- }
- return array('formulaire_oubli', 0, array('p' =&gt; $p, 'message' =&gt; $message));
-}
-
-install_debut_html(_T('pass_mot_oublie'));
-inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
-install_fin_html();
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire(&quot;inc_presentation.php3&quot;); # pour install_debut
+include_ecrire(&quot;inc_session.php3&quot;); # pour creer_uniq_id
+include_ecrire(&quot;inc_mail.php3&quot;); # pour envoyer_mail
+include_ecrire(&quot;inc_acces.php3&quot;); # pour generer_htpass
+include_local(&quot;inc-public-global.php3&quot;); # pour calculer la page
+include_local (&quot;inc-cache.php3&quot;); # ici c'est pour tester la connexion SQL
+
+// Ce fichier est celui d'une balise dynamique qui s'ignore.
+
+function formulaire_oubli_dyn($p, $oubli)
+{
+
+$message = '';
+
+// au 3e appel la variable P est positionnee par le script lui-meme
+// et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
+if ($p = addslashes($p)) {
+	$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut&lt;&gt;'5poubelle' AND pass&lt;&gt;''&quot;);
+	if (!$row = spip_fetch_array($res)) 
+		$message = _T('pass_erreur_code_inconnu');
+	else {
+		if ($oubli) {
+			$mdpass = md5($oubli);
+			$htpass = generer_htpass($oubli);
+			spip_query(&quot;UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
+				cookie_oubli='' WHERE cookie_oubli='$p'&quot;);
+
+			$login = $row['login'];
+			$message = &quot;&lt;b&gt;&quot; . _T('pass_nouveau_enregistre') . &quot;&lt;/b&gt;&quot;.
+			&quot;&lt;p&gt;&quot; . _T('pass_rappel_login', array('login' =&gt; $login));
+		}
+	}
+ } else { 
+  // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
+  if ($oubli) {
+	if ( email_valide($oubli) ) {
+		$email = addslashes($oubli);
+		$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE email ='$email'&quot;);
+		if ($row = spip_fetch_array($res)) {
+			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
+				$message = _T('pass_erreur_acces_refuse');
+			else {
+				$cookie = creer_uniqid();
+				spip_query(&quot;UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'&quot;);
+
+				if ( envoyer_mail($email,
+						 &quot;[&quot; . lire_meta(&quot;nom_site&quot;) .'] ' .  _T('pass_oubli_mot'),
+						 _T('pass_mail_passcookie',
+						    array('nom_site_spip' =&gt; lire_meta(&quot;nom_site&quot;),
+							  'adresse_site' =&gt; lire_meta(&quot;adresse_site&quot;), 
+							  'cookie' =&gt; $cookie))))
+					$message = _T('pass_recevoir_mail');
+				else
+					$message = _T('pass_erreur_probleme_technique');
+			}
+		}
+		else
+			$message = _T('pass_erreur_non_enregistre', array('email_oubli' =&gt; htmlspecialchars($oubli)));
+	} else {
+		$message = _T('pass_erreur_non_valide', array('email_oubli' =&gt; htmlspecialchars($oubli)));
+	}
+  }
+ }
+ return array('formulaire_oubli', 0, array('p' =&gt; $p, 'message' =&gt; $message));
+}
+
+install_debut_html(_T('pass_mot_oublie'));
+inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
+install_fin_html();
+?&gt;

Index: spip_cache.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cache.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_cache.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_cache.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,20 +1,31 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_admin.php3&quot;);
-include_local(&quot;inc-cache.php3&quot;);
-
-if ($purger_cache == &quot;oui&quot;) {
-	if (verifier_action_auteur(&quot;purger_cache&quot;, $hash, $id_auteur))
-		purger_cache();
-}
-
-if ($purger_squelettes == &quot;oui&quot;) {
-	if (verifier_action_auteur(&quot;purger_squelettes&quot;, $hash, $id_auteur))
-	  purger_squelettes();
-}
-redirige_par_entete($redirect);
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+include (&quot;ecrire/inc_version.php3&quot;);
+
+include_ecrire(&quot;inc_meta.php3&quot;);
+include_ecrire(&quot;inc_admin.php3&quot;);
+include_local(&quot;inc-cache.php3&quot;);
+
+if ($purger_cache == &quot;oui&quot;) {
+	if (verifier_action_auteur(&quot;purger_cache&quot;, $hash, $id_auteur))
+		purger_cache();
+}
+
+if ($purger_squelettes == &quot;oui&quot;) {
+	if (verifier_action_auteur(&quot;purger_squelettes&quot;, $hash, $id_auteur))
+	  purger_squelettes();
+}
+redirige_par_entete($redirect);
+
+?&gt;

Index: spip_background.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_background.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_background.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_background.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,22 +1,33 @@
-&lt;?php
-
-// Du cote de la page HTML, utiliser un background-image en feuille de style
-// plutot qu'un &lt;img&gt;, c'est plus discret notamment sous navigateur texte
-$image = pack(&quot;H*&quot;, &quot;47494638396118001800800000ffffff00000021f90401000000002c0000000018001800000216848fa9cbed0fa39cb4da8bb3debcfb0f86e248965301003b&quot;);
-$size = strlen($image);
-
-Header(&quot;Content-Type: image/gif&quot;);
-Header(&quot;Content-Length: &quot;.$size);
-Header(&quot;Cache-Control: no-cache,no-store&quot;);
-Header(&quot;Pragma: no-cache&quot;);
-Header(&quot;Connection: close&quot;);
-
-echo $image;
-
-flush();
-
-include('ecrire/inc_version.php3');
-
-cron(1); // acces gourmand (on veut bosser, nous, pas comme inc-public.php3 !)
-
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// Du cote de la page HTML, utiliser un background-image en feuille de style
+// plutot qu'un &lt;img&gt;, c'est plus discret notamment sous navigateur texte
+$image = pack(&quot;H*&quot;, &quot;47494638396118001800800000ffffff00000021f90401000000002c0000000018001800000216848fa9cbed0fa39cb4da8bb3debcfb0f86e248965301003b&quot;);
+$size = strlen($image);
+
+Header(&quot;Content-Type: image/gif&quot;);
+Header(&quot;Content-Length: &quot;.$size);
+Header(&quot;Cache-Control: no-cache,no-store&quot;);
+Header(&quot;Pragma: no-cache&quot;);
+Header(&quot;Connection: close&quot;);
+
+echo $image;
+
+flush();
+
+include('ecrire/inc_version.php3');
+
+cron(1); // acces gourmand (on veut bosser, nous, pas comme inc-public.php3 !)
+
 ?&gt;

Index: inc-urls-standard.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-urls-standard.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-urls-standard.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-urls-standard.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,82 +1,93 @@
-&lt;?php
-
-// executer une seule fois
-if (defined(&quot;_INC_URLS2&quot;)) return;
-define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
-
-function generer_url_article($id_article) {
-	return &quot;article.php3?id_article=$id_article&quot;;
-}
-
-function generer_url_rubrique($id_rubrique) {
-	return &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
-}
-
-function generer_url_breve($id_breve) {
-	return &quot;breve.php3?id_breve=$id_breve&quot;;
-}
-
-function generer_url_mot($id_mot) {
-	return &quot;mot.php3?id_mot=$id_mot&quot;;
-}
-
-function generer_url_auteur($id_auteur) {
-	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
-}
-
-function generer_url_document($id_document) {
-	if (intval($id_document) &lt;= 0)
-		return '';
-	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
-		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
-	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
-		return ($row['fichier']);
-	return '';
-}
-
-function recuperer_parametres_url($fond, $url) {
-	global $contexte;
-	return;
-}
-
-//
-// URLs des forums
-//
-
-// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
-function racine_forum($id_forum){
-	if (!$id_forum = intval($id_forum)) return;
-	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
-	$result = spip_query($query);
-	if($row = spip_fetch_array($result)){
-		if($row['id_parent']) {
-			return racine_forum($row['id_parent']);
-		}
-		else {
-			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
- 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
-			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
-		}
-	}
-} 
-
-function generer_url_forum($id_forum, $show_thread=false) {
-	list($type, $id, $id_thread) = racine_forum($id_forum);
-	if ($id_thread&gt;0 AND $show_thread)
-		$id_forum = $id_thread;
-	switch($type) {
-		case 'article':
-			return generer_url_article($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'breve':
-			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'rubrique':
-			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
-			break;
-		default:
-			return &quot;forum.php3?id_forum=&quot;.$id_forum;
-	}
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// executer une seule fois
+if (defined(&quot;_INC_URLS2&quot;)) return;
+define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
+
+function generer_url_article($id_article) {
+	return &quot;article.php3?id_article=$id_article&quot;;
+}
+
+function generer_url_rubrique($id_rubrique) {
+	return &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
+}
+
+function generer_url_breve($id_breve) {
+	return &quot;breve.php3?id_breve=$id_breve&quot;;
+}
+
+function generer_url_mot($id_mot) {
+	return &quot;mot.php3?id_mot=$id_mot&quot;;
+}
+
+function generer_url_auteur($id_auteur) {
+	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
+}
+
+function generer_url_document($id_document) {
+	if (intval($id_document) &lt;= 0)
+		return '';
+	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
+		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
+	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
+		return ($row['fichier']);
+	return '';
+}
+
+function recuperer_parametres_url($fond, $url) {
+	global $contexte;
+	return;
+}
+
+//
+// URLs des forums
+//
+
+// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
+function racine_forum($id_forum){
+	if (!$id_forum = intval($id_forum)) return;
+	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
+	$result = spip_query($query);
+	if($row = spip_fetch_array($result)){
+		if($row['id_parent']) {
+			return racine_forum($row['id_parent']);
+		}
+		else {
+			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
+ 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
+			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
+		}
+	}
+} 
+
+function generer_url_forum($id_forum, $show_thread=false) {
+	list($type, $id, $id_thread) = racine_forum($id_forum);
+	if ($id_thread&gt;0 AND $show_thread)
+		$id_forum = $id_thread;
+	switch($type) {
+		case 'article':
+			return generer_url_article($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'breve':
+			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'rubrique':
+			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
+			break;
+		default:
+			return &quot;forum.php3?id_forum=&quot;.$id_forum;
+	}
+}
+
+?&gt;

Index: inc-compilo.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-compilo.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-compilo.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,700 +1,702 @@
-&lt;?php
-
-//
-// Fichier principal du compilateur de squelettes
-//
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_COMPILO&quot;)) return;
-define(&quot;_INC_COMPILO&quot;, &quot;1&quot;);
-
-
[...1371 lines suppressed...]
+function $nom (\$Cache, \$Pile, \$doublons=array(), \$Numrows='', \$SP=0) {
+\$t0 = $corps;
+
+	return array(
+		'texte' =&gt; \$t0,
+		'squelette' =&gt; '$nom',
+		'process_ins' =&gt; ((strpos(\$t0,'&lt;'.'?')=== false) ? 'html' : 'php'),
+		'invalideurs' =&gt; \$Cache
+	);
+}
+
+?&quot;.&quot;&gt;&quot;;
+
+	if ($GLOBALS['var_mode'] == 'debug')
+		squelette_debug_compile($nom, $sourcefile, $squelette_compile);
+	return $squelette_compile;
+
+}
+
+?&gt;

Index: inc-urls-html.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-urls-html.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-urls-html.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-urls-html.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,83 +1,94 @@
-&lt;?php
-
-// executer une seule fois
-if (defined(&quot;_INC_URLS2&quot;)) return;
-define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
-
-function generer_url_article($id_article) {
-	return &quot;article$id_article.html&quot;;
-}
-
-function generer_url_rubrique($id_rubrique) {
-	return &quot;rubrique$id_rubrique.html&quot;;
-}
-
-function generer_url_breve($id_breve) {
-	return &quot;breve$id_breve.html&quot;;
-}
-
-function generer_url_mot($id_mot) {
-	return &quot;mot$id_mot.html&quot;;
-}
-
-function generer_url_auteur($id_auteur) {
-	return &quot;auteur$id_auteur.html&quot;;
-}
-
-function generer_url_document($id_document) {
-	if (intval($id_document) &lt;= 0)
-		return '';
-	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
-		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
-	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
-		return ($row['fichier']);
-	return '';
-}
-
-function recuperer_parametres_url($fond, $url) {
-	global $contexte;
-	return;
-}
-
-
-//
-// URLs des forums
-//
-
-// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
-function racine_forum($id_forum){
-	if (!$id_forum = intval($id_forum)) return;
-	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
-	$result = spip_query($query);
-	if($row = spip_fetch_array($result)){
-		if($row['id_parent']) {
-			return racine_forum($row['id_parent']);
-		}
-		else {
-			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
- 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
-			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
-		}
-	}
-} 
-
-function generer_url_forum($id_forum, $show_thread=false) {
-	list($type, $id, $id_thread) = racine_forum($id_forum);
-	if ($id_thread&gt;0 AND $show_thread)
-		$id_forum = $id_thread;
-	switch($type) {
-		case 'article':
-			return generer_url_article($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'breve':
-			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'rubrique':
-			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
-			break;
-		default:
-			return &quot;forum$id_forum.html&quot;;
-	}
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// executer une seule fois
+if (defined(&quot;_INC_URLS2&quot;)) return;
+define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
+
+function generer_url_article($id_article) {
+	return &quot;article$id_article.html&quot;;
+}
+
+function generer_url_rubrique($id_rubrique) {
+	return &quot;rubrique$id_rubrique.html&quot;;
+}
+
+function generer_url_breve($id_breve) {
+	return &quot;breve$id_breve.html&quot;;
+}
+
+function generer_url_mot($id_mot) {
+	return &quot;mot$id_mot.html&quot;;
+}
+
+function generer_url_auteur($id_auteur) {
+	return &quot;auteur$id_auteur.html&quot;;
+}
+
+function generer_url_document($id_document) {
+	if (intval($id_document) &lt;= 0)
+		return '';
+	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
+		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
+	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
+		return ($row['fichier']);
+	return '';
+}
+
+function recuperer_parametres_url($fond, $url) {
+	global $contexte;
+	return;
+}
+
+
+//
+// URLs des forums
+//
+
+// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
+function racine_forum($id_forum){
+	if (!$id_forum = intval($id_forum)) return;
+	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
+	$result = spip_query($query);
+	if($row = spip_fetch_array($result)){
+		if($row['id_parent']) {
+			return racine_forum($row['id_parent']);
+		}
+		else {
+			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
+ 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
+			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
+		}
+	}
+} 
+
+function generer_url_forum($id_forum, $show_thread=false) {
+	list($type, $id, $id_thread) = racine_forum($id_forum);
+	if ($id_thread&gt;0 AND $show_thread)
+		$id_forum = $id_thread;
+	switch($type) {
+		case 'article':
+			return generer_url_article($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'breve':
+			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'rubrique':
+			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
+			break;
+		default:
+			return &quot;forum$id_forum.html&quot;;
+	}
+}
+
+?&gt;

Index: inc-html-squel.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-html-squel.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-html-squel.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-html-squel.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,339 +1,350 @@
-&lt;?php
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_HTML_SQUEL&quot;)) return;
-define(&quot;_INC_HTML_SQUEL&quot;, &quot;1&quot;);
-
-# Ce fichier doit IMPERATIVEMENT contenir la fonction &quot;parser&quot;
-# qui transforme un squelette en un tableau d'objets de classe Boucle
-# il est charge par un include calcule dans inc-calcul-squel
-# pour permettre differentes syntaxes en entree
-
-define('NOM_DE_BOUCLE', &quot;[0-9]+|[-_][-_.a-zA-Z0-9]*&quot;);
-define('NOM_DE_CHAMP', &quot;#((&quot; . NOM_DE_BOUCLE . &quot;):)?([A-Z_]+)(\*?)&quot;);
-define('CHAMP_ETENDU', '\[([^]\[]*)\(' . NOM_DE_CHAMP . '([^]\[)]*)\)([^]\[]*)\]');
-define('PARAM_DE_BOUCLE','[[:space:]]*\{[[:space:]]*([^{}]*(\{[^\}]*\}[^\}]*)*)[[:space:]]*\}');
-define('TYPE_DE_BOUCLE', &quot;[^)]*&quot;);
-define('BALISE_DE_BOUCLE',
-	&quot;^&lt;BOUCLE(&quot; .
-	NOM_DE_BOUCLE .
-	')[[:space:]]*\((' .
-	TYPE_DE_BOUCLE .
-	')\)((' .
-	PARAM_DE_BOUCLE .
-	')*)[[:space:]]*&gt;');
-define('PARAM_INCLURE','[[:space:]]*\{[[:space:]]*([_0-9a-zA-Z]+)[[:space:]]*(=[[:space:]]*([^\{\}]*(\{[^\}]*\}[^\} ]*)?))?[[:space:]]*\}');
-define('BALISE_INCLURE',&quot;&lt;INCLU[DR]E[[:space:]]*\(&quot; .
-       '([-_0-9a-zA-Z./ ]+)' .
-	'\)((' .
-	PARAM_INCLURE .
-	')*)[[:space:]]*&gt;');
-define('DEBUT_DE_BOUCLE','/&lt;B('.NOM_DE_BOUCLE.')&gt;.*?&lt;BOUCLE\1[^-_.a-zA-Z0-9]|&lt;BOUCLE('.NOM_DE_BOUCLE.')/ms');	# preg
-
-
-function parser_inclure($texte, $result) {
-	while (($p=strpos($texte, '&lt;INCLU')) !== false) {
-		$fin = substr($texte, $p);
-
-		if (!ereg('^' . BALISE_INCLURE, $fin, $match)) break;
-		$s = $match[0];
-		$debut = substr($texte, 0, $p);
-		$texte = substr($fin, strlen($s));
-
-		if ($debut) $result = parser_champs($debut, $result);
-
-		$champ = new Inclure;
-		$champ-&gt;fichier = $match[1];
-		$champ-&gt;params = array();
-		$p = trim($match[2]);
-		if ($p) {
-			while (ereg('^' . PARAM_INCLURE . '(.*)$', $p, $m)) {
-				$champ-&gt;params[$m[1]] = $m[3];
-				$p = $m[5];
-			}
-			
-			if ($p)
-				erreur_squelette(_T('zbug_parametres_inclus_incorrects'),
-				$s);
-		}
-		$result[] = $champ;
-	}
-
-	return (!$texte ? $result : parser_champs($texte, $result));
-}
-
-function parser_champs($texte,$result) {
-	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
-	  $p = strpos($texte, $regs[0]);
-
-	  if ($regs[4] || !ereg(&quot;[0-9a-z]&quot;, $regs[5][0])) {
-		if ($p) {
-			$champ = new Texte;
-			$champ-&gt;texte = (substr($texte, 0, $p));
-			$result[] = $champ;
-		}
-		  
-		$champ = new Champ;
-		$champ-&gt;nom_boucle = $regs[2];
-		$champ-&gt;nom_champ = $regs[3];
-		$champ-&gt;etoile = $regs[4];
-		$texte = $regs[5];
-		$result[] = $champ;
-	  } else {
-	    // faux champ
-	    $champ = new Texte;
-	    $champ-&gt;texte = (substr($texte, 0, $p+1));
-	    $result[] = $champ;
-	    $texte = (substr($texte, $p+1));
-	  }
-	}
-	if ($texte) {
-	  
-		$champ = new Texte;
-		$champ-&gt;texte = $texte;
-		$result[] = $champ;
-	}
-	return $result;
-}
-
-// Gestion des imbrications:
-// on cherche les [..] les plus internes et on les remplace par une chaine
-// %###N@ ou N indexe un tableau comportant le resultat de leur phrase
-// on recommence tant qu'il y a des [...] en substituant a l'appel suivant
-
-function parser_champs_etendus($texte, $result) {
-	if (!$texte) return $result;
-	$sep = '##';
-	while (strpos($texte,$sep)!== false)
-		$sep .= '#';
-	return array_merge($result, parser_champs_interieurs($texte, $sep, array()));
-}
-
-
-function parser_champs_exterieurs($debut, $sep, $nested) {
-	$res = array();
-	while (($p=strpos($debut, &quot;%$sep&quot;))!==false) {
-	    if ($p) $res = parser_inclure(substr($debut,0,$p), $res);
-	    ereg(&quot;^%$sep([0-9]+)@(.*)$&quot;, substr($debut,$p),$m);
-	    $res[]= $nested[$m[1]];
-	    $debut = $m[2];
-	}
-	return (!$debut ?  $res : parser_inclure($debut, $res));
-
-}
-
-function parser_champs_interieurs($texte, $sep, $result) {
-	$i = 1;
-	while (true) {	  $j=$i;
-	  while (ereg(CHAMP_ETENDU . '(.*)$', $texte, $regs)) {
-		$champ = new Champ;
-		$champ-&gt;nom_boucle = $regs[3];
-		$champ-&gt;nom_champ = $regs[4];
-		$champ-&gt;etoile = $regs[5];
-		$champ-&gt;cond_avant = parser_champs_exterieurs($regs[1],$sep,$result);
-		$champ-&gt;cond_apres = parser_champs_exterieurs($regs[7],$sep,$result);
-		$fonctions = $regs[6];
-		if ($fonctions) {
-			$fonctions = explode('|', ereg_replace(&quot;^\|&quot;, &quot;&quot;, $fonctions));
-			foreach($fonctions as $f) $champ-&gt;fonctions[]= $f;
-		}
-
-		$p = strpos($texte, $regs[0]);
-		if ($p) {$result[$i] = substr($texte,0,$p);$i++; }
-		$result[$i] = $champ;
-		$i++;
-		$texte = $regs[8];
-	  }
-	  if ($texte) {$result[$i] = $texte; $i++;}
-	  $x ='';
-
-	  while($j &lt; $i) 
-	    { $z= $result[$j]; 
-	      if (is_object($z)) $x .= &quot;%$sep$j@&quot; ; else $x.=$z ;
-	      $j++;}
-	  if (ereg(CHAMP_ETENDU, $x)) $texte = $x;
-	  else return parser_champs_exterieurs($x, $sep, $result);}
-}
-
-
-function parser_param($params, &amp;$result) {
-	$params2 = array();
-	$type = $result-&gt;type_requete;
-	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
-		$params = $m[3];
-		$m[1] = trim($m[1]);
-		// cas d'un critere avec {...}
-		if ($m[2])
-			$params2[] = $m[1];
-		else {
-			if (strlen($m[1]) &lt; 2)
-				$params2[] = $m[1];
-	    else {
-	      ereg('^(.)([^&quot;}]*)(.)$', $m[1], $args);
-	      // cas syntaxique general, 
-	      // traiter qq lexemes particuliers pour faciliter la suite
-	      if ($args[3] != '&quot;') {
-			$param = $m[1];
-			if (($param == 'tout') OR ($param == 'tous')) {
-				$result-&gt;tout = true;
-				unset ($param);
-			}
-			else if ($param == 'plat') {
-				$result-&gt;plat = true;
-				unset ($param);
-			}
-
-			// Boucle hierarchie, analyser le critere id_article - id_rubrique
-			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
-			// forcer {tout} pour avoir la rubrique mere...
-			else if ($type == 'hierarchie') {
-				if ($param == 'id_article' OR $param == 'id_syndic') {
-					$result-&gt;tout = true;
-					unset ($param);
-				} else if ($param == 'id_rubrique')
-					unset ($param);
-			}
-
-			// synonyme
-			if ($param == 'unique') $param = 'doublons';
-
-			// l'ajouter
-			if ($param)
-				$params2[] = $param;
-	      }
-		else {
-		  // cas d'un guillemet final
-			if ($args[1] == '&quot;') {
-			  // si tout le param est entre guillement, vite vu
-				$result-&gt;separateur = 
-					ereg_replace(&quot;'&quot;,&quot;\'&quot;,$args[2]);
-			}
-			else {
-				$params2[] = $args[1] . $args[2] . '&quot;' . $m[1];
-			}
-		}
-	    }
-	  }
-	}
-	$result-&gt;param = $params2;
-}
-
-function parser($texte, $id_parent, &amp;$boucles, $nom) {
-
-	$all_res = array();
-
-	while (preg_match(DEBUT_DE_BOUCLE, $texte, $regs)) {
-		$nom_boucle = $regs[1].$regs[2];
-		$p = strpos($texte, '&lt;BOUCLE'.$nom_boucle);
-
-		// envoyer la boucle au debugueur
-		if ($GLOBALS['var_mode']== 'debug') {
-			$preg = &quot;@&lt;B($nom_boucle|OUCLE${nom_boucle}[^-_.a-zA-Z0-9][^&gt;]*)&gt;&quot;
-				. &quot;.*&lt;/(BOUCLE|/?B)$nom_boucle&gt;@ms&quot;;
-			preg_match($preg, $texte, $match);
-			boucle_debug ($nom_boucle, $nom, $match[0]);
-		}
-
-		//
-		// Recuperer la partie principale de la boucle
-		//
-		$debut = substr($texte, 0, $p);
-		$milieu = substr($texte, $p);
-
-		if (!ereg(BALISE_DE_BOUCLE, $milieu, $match)) {
-			erreur_squelette((_T('zbug_erreur_boucle_syntaxe')), $milieu);
-		}
-		$id_boucle = $match[1];
-
-		$result = new Boucle;
-		$result-&gt;id_parent = $id_parent;
-		$result-&gt;id_boucle = $id_boucle;
-
-		$type = $match[2];
-		if ($p =strpos($type, ':'))
-		  {
-		    $result-&gt;sql_serveur = substr($type,0,$p);
-		    $type = substr($type,$p+1);
-		  }
-		$type = strtolower($type);
-		if ($type == 'sites') $type = 'syndication'; # alias
-
-		//
-		// Recuperer les criteres de la boucle (sauf boucle recursive)
-		//
-		if (substr($type, 0, 6) == 'boucle') {
-			$result-&gt;type_requete = 'boucle';
-			$result-&gt;param = substr($match[2], 6);
-		} else {
-			$result-&gt;type_requete = $type;
-			parser_param($match[3], $result);
-		}
-
-		//
-		// Recuperer la partie conditionnelle avant
-		//
-		$s = &quot;&lt;B$id_boucle&gt;&quot;;
-		$p = strpos($debut, $s);
-		if ($p !== false) {
-			$result-&gt;cond_avant = substr($debut, $p + strlen($s));
-			$debut = substr($debut, 0, $p);
-		}
-		$milieu = substr($milieu, strlen($match[0]));
-		if (strpos($milieu, $s)) {
-			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
-				$id_boucle . 
-				_T('zbug_balise_b_aval'));
-		}
-
-		//
-		// Recuperer la fin :
-		//
-		$s = &quot;&lt;/BOUCLE$id_boucle&gt;&quot;;
-		$p = strpos($milieu, $s);
-		if ($p === false) {
-			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
-					 _T('zbug_erreur_boucle_fermant',
-						array('id'=&gt;$id_boucle)));
-		}
-		$texte = substr($milieu, $p + strlen($s));
-		$milieu = substr($milieu, 0, $p);
-
-		//
-		// 1. Recuperer la partie conditionnelle apres
-		//
-		$s = &quot;&lt;/B$id_boucle&gt;&quot;;
-		$p = strpos($texte, $s);
-		if ($p !== false) {
-			$result-&gt;cond_fin = substr($texte, 0, $p);
-			$texte = substr($texte, $p + strlen($s));
-		}
-
-		//
-		// 2. Recuperer la partie alternative
-		//
-		$s = &quot;&lt;//B$id_boucle&gt;&quot;;
-		$p = strpos($texte, $s);
-		if ($p !== false) {
-			$result-&gt;cond_altern = substr($texte, 0, $p);
-			$texte = substr($texte, $p + strlen($s));
-		}
-
-		$result-&gt;cond_avant = parser($result-&gt;cond_avant, $id_parent,$boucles, $nom);
-		$result-&gt;cond_apres = parser($result-&gt;cond_fin, $id_parent,$boucles, $nom);
-		$result-&gt;cond_altern = parser($result-&gt;cond_altern,$id_parent,$boucles, $nom);
-		$result-&gt;milieu = parser($milieu, $id_boucle,$boucles, $nom);
-
-		$all_res = parser_champs_etendus($debut, $all_res);
-		$all_res[] = $result;
-		if ($boucles[$id_boucle]) {
-			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
-					 _T('zbug_erreur_boucle_double',
-					 	array('id'=&gt;$id_boucle)));
-		} else
-			$boucles[$id_boucle] = $result;
-	}
-
-	return parser_champs_etendus($texte, $all_res);
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_HTML_SQUEL&quot;)) return;
+define(&quot;_INC_HTML_SQUEL&quot;, &quot;1&quot;);
+
+# Ce fichier doit IMPERATIVEMENT contenir la fonction &quot;parser&quot;
+# qui transforme un squelette en un tableau d'objets de classe Boucle
+# il est charge par un include calcule dans inc-calcul-squel
+# pour permettre differentes syntaxes en entree
+
+define('NOM_DE_BOUCLE', &quot;[0-9]+|[-_][-_.a-zA-Z0-9]*&quot;);
+define('NOM_DE_CHAMP', &quot;#((&quot; . NOM_DE_BOUCLE . &quot;):)?([A-Z_]+)(\*?)&quot;);
+define('CHAMP_ETENDU', '\[([^]\[]*)\(' . NOM_DE_CHAMP . '([^]\[)]*)\)([^]\[]*)\]');
+define('PARAM_DE_BOUCLE','[[:space:]]*\{[[:space:]]*([^{}]*(\{[^\}]*\}[^\}]*)*)[[:space:]]*\}');
+define('TYPE_DE_BOUCLE', &quot;[^)]*&quot;);
+define('BALISE_DE_BOUCLE',
+	&quot;^&lt;BOUCLE(&quot; .
+	NOM_DE_BOUCLE .
+	')[[:space:]]*\((' .
+	TYPE_DE_BOUCLE .
+	')\)((' .
+	PARAM_DE_BOUCLE .
+	')*)[[:space:]]*&gt;');
+define('PARAM_INCLURE','[[:space:]]*\{[[:space:]]*([_0-9a-zA-Z]+)[[:space:]]*(=[[:space:]]*([^\{\}]*(\{[^\}]*\}[^\} ]*)?))?[[:space:]]*\}');
+define('BALISE_INCLURE',&quot;&lt;INCLU[DR]E[[:space:]]*\(&quot; .
+       '([-_0-9a-zA-Z./ ]+)' .
+	'\)((' .
+	PARAM_INCLURE .
+	')*)[[:space:]]*&gt;');
+define('DEBUT_DE_BOUCLE','/&lt;B('.NOM_DE_BOUCLE.')&gt;.*?&lt;BOUCLE\1[^-_.a-zA-Z0-9]|&lt;BOUCLE('.NOM_DE_BOUCLE.')/ms');	# preg
+
+
+function parser_inclure($texte, $result) {
+	while (($p=strpos($texte, '&lt;INCLU')) !== false) {
+		$fin = substr($texte, $p);
+
+		if (!ereg('^' . BALISE_INCLURE, $fin, $match)) break;
+		$s = $match[0];
+		$debut = substr($texte, 0, $p);
+		$texte = substr($fin, strlen($s));
+
+		if ($debut) $result = parser_champs($debut, $result);
+
+		$champ = new Inclure;
+		$champ-&gt;fichier = $match[1];
+		$champ-&gt;params = array();
+		$p = trim($match[2]);
+		if ($p) {
+			while (ereg('^' . PARAM_INCLURE . '(.*)$', $p, $m)) {
+				$champ-&gt;params[$m[1]] = $m[3];
+				$p = $m[5];
+			}
+			
+			if ($p)
+				erreur_squelette(_T('zbug_parametres_inclus_incorrects'),
+				$s);
+		}
+		$result[] = $champ;
+	}
+
+	return (!$texte ? $result : parser_champs($texte, $result));
+}
+
+function parser_champs($texte,$result) {
+	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
+	  $p = strpos($texte, $regs[0]);
+
+	  if ($regs[4] || !ereg(&quot;[0-9a-z]&quot;, $regs[5][0])) {
+		if ($p) {
+			$champ = new Texte;
+			$champ-&gt;texte = (substr($texte, 0, $p));
+			$result[] = $champ;
+		}
+		  
+		$champ = new Champ;
+		$champ-&gt;nom_boucle = $regs[2];
+		$champ-&gt;nom_champ = $regs[3];
+		$champ-&gt;etoile = $regs[4];
+		$texte = $regs[5];
+		$result[] = $champ;
+	  } else {
+	    // faux champ
+	    $champ = new Texte;
+	    $champ-&gt;texte = (substr($texte, 0, $p+1));
+	    $result[] = $champ;
+	    $texte = (substr($texte, $p+1));
+	  }
+	}
+	if ($texte) {
+	  
+		$champ = new Texte;
+		$champ-&gt;texte = $texte;
+		$result[] = $champ;
+	}
+	return $result;
+}
+
+// Gestion des imbrications:
+// on cherche les [..] les plus internes et on les remplace par une chaine
+// %###N@ ou N indexe un tableau comportant le resultat de leur phrase
+// on recommence tant qu'il y a des [...] en substituant a l'appel suivant
+
+function parser_champs_etendus($texte, $result) {
+	if (!$texte) return $result;
+	$sep = '##';
+	while (strpos($texte,$sep)!== false)
+		$sep .= '#';
+	return array_merge($result, parser_champs_interieurs($texte, $sep, array()));
+}
+
+
+function parser_champs_exterieurs($debut, $sep, $nested) {
+	$res = array();
+	while (($p=strpos($debut, &quot;%$sep&quot;))!==false) {
+	    if ($p) $res = parser_inclure(substr($debut,0,$p), $res);
+	    ereg(&quot;^%$sep([0-9]+)@(.*)$&quot;, substr($debut,$p),$m);
+	    $res[]= $nested[$m[1]];
+	    $debut = $m[2];
+	}
+	return (!$debut ?  $res : parser_inclure($debut, $res));
+
+}
+
+function parser_champs_interieurs($texte, $sep, $result) {
+	$i = 1;
+	while (true) {	  $j=$i;
+	  while (ereg(CHAMP_ETENDU . '(.*)$', $texte, $regs)) {
+		$champ = new Champ;
+		$champ-&gt;nom_boucle = $regs[3];
+		$champ-&gt;nom_champ = $regs[4];
+		$champ-&gt;etoile = $regs[5];
+		$champ-&gt;cond_avant = parser_champs_exterieurs($regs[1],$sep,$result);
+		$champ-&gt;cond_apres = parser_champs_exterieurs($regs[7],$sep,$result);
+		$fonctions = $regs[6];
+		if ($fonctions) {
+			$fonctions = explode('|', ereg_replace(&quot;^\|&quot;, &quot;&quot;, $fonctions));
+			foreach($fonctions as $f) $champ-&gt;fonctions[]= $f;
+		}
+
+		$p = strpos($texte, $regs[0]);
+		if ($p) {$result[$i] = substr($texte,0,$p);$i++; }
+		$result[$i] = $champ;
+		$i++;
+		$texte = $regs[8];
+	  }
+	  if ($texte) {$result[$i] = $texte; $i++;}
+	  $x ='';
+
+	  while($j &lt; $i) 
+	    { $z= $result[$j]; 
+	      if (is_object($z)) $x .= &quot;%$sep$j@&quot; ; else $x.=$z ;
+	      $j++;}
+	  if (ereg(CHAMP_ETENDU, $x)) $texte = $x;
+	  else return parser_champs_exterieurs($x, $sep, $result);}
+}
+
+
+function parser_param($params, &amp;$result) {
+	$params2 = array();
+	$type = $result-&gt;type_requete;
+	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
+		$params = $m[3];
+		$m[1] = trim($m[1]);
+		// cas d'un critere avec {...}
+		if ($m[2])
+			$params2[] = $m[1];
+		else {
+			if (strlen($m[1]) &lt; 2)
+				$params2[] = $m[1];
+	    else {
+	      ereg('^(.)([^&quot;}]*)(.)$', $m[1], $args);
+	      // cas syntaxique general, 
+	      // traiter qq lexemes particuliers pour faciliter la suite
+	      if ($args[3] != '&quot;') {
+			$param = $m[1];
+			if (($param == 'tout') OR ($param == 'tous')) {
+				$result-&gt;tout = true;
+				unset ($param);
+			}
+			else if ($param == 'plat') {
+				$result-&gt;plat = true;
+				unset ($param);
+			}
+
+			// Boucle hierarchie, analyser le critere id_article - id_rubrique
+			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
+			// forcer {tout} pour avoir la rubrique mere...
+			else if ($type == 'hierarchie') {
+				if ($param == 'id_article' OR $param == 'id_syndic') {
+					$result-&gt;tout = true;
+					unset ($param);
+				} else if ($param == 'id_rubrique')
+					unset ($param);
+			}
+
+			// synonyme
+			if ($param == 'unique') $param = 'doublons';
+
+			// l'ajouter
+			if ($param)
+				$params2[] = $param;
+	      }
+		else {
+		  // cas d'un guillemet final
+			if ($args[1] == '&quot;') {
+			  // si tout le param est entre guillement, vite vu
+				$result-&gt;separateur = 
+					ereg_replace(&quot;'&quot;,&quot;\'&quot;,$args[2]);
+			}
+			else {
+				$params2[] = $args[1] . $args[2] . '&quot;' . $m[1];
+			}
+		}
+	    }
+	  }
+	}
+	$result-&gt;param = $params2;
+}
+
+function parser($texte, $id_parent, &amp;$boucles, $nom) {
+
+	$all_res = array();
+
+	while (preg_match(DEBUT_DE_BOUCLE, $texte, $regs)) {
+		$nom_boucle = $regs[1].$regs[2];
+		$p = strpos($texte, '&lt;BOUCLE'.$nom_boucle);
+
+		// envoyer la boucle au debugueur
+		if ($GLOBALS['var_mode']== 'debug') {
+			$preg = &quot;@&lt;B($nom_boucle|OUCLE${nom_boucle}[^-_.a-zA-Z0-9][^&gt;]*)&gt;&quot;
+				. &quot;.*&lt;/(BOUCLE|/?B)$nom_boucle&gt;@ms&quot;;
+			preg_match($preg, $texte, $match);
+			boucle_debug ($nom_boucle, $nom, $match[0]);
+		}
+
+		//
+		// Recuperer la partie principale de la boucle
+		//
+		$debut = substr($texte, 0, $p);
+		$milieu = substr($texte, $p);
+
+		if (!ereg(BALISE_DE_BOUCLE, $milieu, $match)) {
+			erreur_squelette((_T('zbug_erreur_boucle_syntaxe')), $milieu);
+		}
+		$id_boucle = $match[1];
+
+		$result = new Boucle;
+		$result-&gt;id_parent = $id_parent;
+		$result-&gt;id_boucle = $id_boucle;
+
+		$type = $match[2];
+		if ($p =strpos($type, ':'))
+		  {
+		    $result-&gt;sql_serveur = substr($type,0,$p);
+		    $type = substr($type,$p+1);
+		  }
+		$type = strtolower($type);
+		if ($type == 'sites') $type = 'syndication'; # alias
+
+		//
+		// Recuperer les criteres de la boucle (sauf boucle recursive)
+		//
+		if (substr($type, 0, 6) == 'boucle') {
+			$result-&gt;type_requete = 'boucle';
+			$result-&gt;param = substr($match[2], 6);
+		} else {
+			$result-&gt;type_requete = $type;
+			parser_param($match[3], $result);
+		}
+
+		//
+		// Recuperer la partie conditionnelle avant
+		//
+		$s = &quot;&lt;B$id_boucle&gt;&quot;;
+		$p = strpos($debut, $s);
+		if ($p !== false) {
+			$result-&gt;cond_avant = substr($debut, $p + strlen($s));
+			$debut = substr($debut, 0, $p);
+		}
+		$milieu = substr($milieu, strlen($match[0]));
+		if (strpos($milieu, $s)) {
+			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
+				$id_boucle . 
+				_T('zbug_balise_b_aval'));
+		}
+
+		//
+		// Recuperer la fin :
+		//
+		$s = &quot;&lt;/BOUCLE$id_boucle&gt;&quot;;
+		$p = strpos($milieu, $s);
+		if ($p === false) {
+			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
+					 _T('zbug_erreur_boucle_fermant',
+						array('id'=&gt;$id_boucle)));
+		}
+		$texte = substr($milieu, $p + strlen($s));
+		$milieu = substr($milieu, 0, $p);
+
+		//
+		// 1. Recuperer la partie conditionnelle apres
+		//
+		$s = &quot;&lt;/B$id_boucle&gt;&quot;;
+		$p = strpos($texte, $s);
+		if ($p !== false) {
+			$result-&gt;cond_fin = substr($texte, 0, $p);
+			$texte = substr($texte, $p + strlen($s));
+		}
+
+		//
+		// 2. Recuperer la partie alternative
+		//
+		$s = &quot;&lt;//B$id_boucle&gt;&quot;;
+		$p = strpos($texte, $s);
+		if ($p !== false) {
+			$result-&gt;cond_altern = substr($texte, 0, $p);
+			$texte = substr($texte, $p + strlen($s));
+		}
+
+		$result-&gt;cond_avant = parser($result-&gt;cond_avant, $id_parent,$boucles, $nom);
+		$result-&gt;cond_apres = parser($result-&gt;cond_fin, $id_parent,$boucles, $nom);
+		$result-&gt;cond_altern = parser($result-&gt;cond_altern,$id_parent,$boucles, $nom);
+		$result-&gt;milieu = parser($milieu, $id_boucle,$boucles, $nom);
+
+		$all_res = parser_champs_etendus($debut, $all_res);
+		$all_res[] = $result;
+		if ($boucles[$id_boucle]) {
+			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
+					 _T('zbug_erreur_boucle_double',
+					 	array('id'=&gt;$id_boucle)));
+		} else
+			$boucles[$id_boucle] = $result;
+	}
+
+	return parser_champs_etendus($texte, $all_res);
+}
+
+?&gt;

Index: resume.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/resume.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- resume.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ resume.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,7 +1,7 @@
-&lt;?php
-$fond = &quot;resume&quot;;
-$delais = 2 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;resume&quot;;
+$delais = 2 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: spip_admin.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_admin.css,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_admin.css	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_admin.css	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,83 +1,83 @@
-/* Les boutons d'admin survolent la page (sauf #FORMULAIRE_ADMIN) */
-.spip-admin-float {
-	top: 0px;
-	right: 20px;
-	position: absolute;
-	z-index: 100;
-}
-
-
-/* Couleurs et design des boutons d'admin */
-.spip-admin-bloc {
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	background-color: transparent;
-	font-size: 10px;
-}
-
-.spip-admin-bloc li {
-	padding: 0 2px;
-	display: inline;
-}
-
-.spip-admin-bloc ul {
-	display: inline;
-}
-
-a.spip-admin-boutons {
-	border-top: 1px solid #cecece;
-	border-bottom: 2px solid #4a4a4a;
-	border-left: 1px solid #cecece;
-	border-right: 1px solid #cecece;
-	text-decoration: none;
-	width: 3em;
-	text-align: center;
-	margin: 0;
-	padding: 1px .5em;
-	font-family: helvetica,arial,sans-serif;
-	font-size: 10px;
-	font-weight: bold;
-	background-color: #fff;
-	color: #0c479d;
-}
-
-a:hover.spip-admin-boutons {
-	background-color: #fc3;
-	border-bottom: 2px solid #36f;
-}
-
-a:active.spip-admin-boutons {
-	background-color: #ccc;
-	border-bottom: 2px solid #f00;
-}
-
-
-/* Style pour le mode debug */
-#spip-debug {
-	background-color: #f0f0f0;
-	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
-}
-#spip-debug ul table {
-	font-size: 80%;
-}
-
-#spip-debug fieldset {
-	background-color: #FFF;
-	font-family: &quot;Courier New&quot;, Courier, monospace;
-	font-size: 12;
-}
-
-#spip-debug legend {
-	background-color: #FFF;
-	border: solid 1px #F00;
-	padding: 1px 1em;
-	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
-	font-weight: bold;
-}
-
-#spip-debug ul table a {
-	text-decoration: none;
-}
-
-#spip-debug ul table a:hover {
-	text-decoration: underline;
-}
+/* Les boutons d'admin survolent la page (sauf #FORMULAIRE_ADMIN) */
+.spip-admin-float {
+	top: 0px;
+	right: 20px;
+	position: absolute;
+	z-index: 100;
+}
+
+
+/* Couleurs et design des boutons d'admin */
+.spip-admin-bloc {
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	background-color: transparent;
+	font-size: 10px;
+}
+
+.spip-admin-bloc li {
+	padding: 0 2px;
+	display: inline;
+}
+
+.spip-admin-bloc ul {
+	display: inline;
+}
+
+a.spip-admin-boutons {
+	border-top: 1px solid #cecece;
+	border-bottom: 2px solid #4a4a4a;
+	border-left: 1px solid #cecece;
+	border-right: 1px solid #cecece;
+	text-decoration: none;
+	width: 3em;
+	text-align: center;
+	margin: 0;
+	padding: 1px .5em;
+	font-family: helvetica,arial,sans-serif;
+	font-size: 10px;
+	font-weight: bold;
+	background-color: #fff;
+	color: #0c479d;
+}
+
+a:hover.spip-admin-boutons {
+	background-color: #fc3;
+	border-bottom: 2px solid #36f;
+}
+
+a:active.spip-admin-boutons {
+	background-color: #ccc;
+	border-bottom: 2px solid #f00;
+}
+
+
+/* Style pour le mode debug */
+#spip-debug {
+	background-color: #f0f0f0;
+	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
+}
+#spip-debug ul table {
+	font-size: 80%;
+}
+
+#spip-debug fieldset {
+	background-color: #FFF;
+	font-family: &quot;Courier New&quot;, Courier, monospace;
+	font-size: 12px;
+}
+
+#spip-debug legend {
+	background-color: #FFF;
+	border: solid 1px #F00;
+	padding: 1px 1em;
+	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
+	font-weight: bold;
+}
+
+#spip-debug ul table a {
+	text-decoration: none;
+}
+
+#spip-debug ul table a:hover {
+	text-decoration: underline;
+}

Index: spip_image.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_image.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_image.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_image.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,247 +1,259 @@
-&lt;?php
-
-// Uploader un document, une image ou un logo,
-// supprimer cet element, creer les vignettes, etc.
-
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire('inc_presentation.php3');	# regler la langue en cas d'erreur
-include_ecrire('inc_getdocument.php3');		# diverses fonctions de ce fichier
-include_ecrire(&quot;inc_charsets.php3&quot;);		# pour le nom de fichier
-include_ecrire(&quot;inc_meta.php3&quot;);			# ne pas faire confiance au cache
-											# (alea_ephemere a peut-etre change)
-include_ecrire(&quot;inc_admin.php3&quot;);			# verifier_action_auteur
-include_ecrire(&quot;inc_abstract_sql.php3&quot;);	# spip_insert
-include_ecrire('inc_documents.php3');		# fichiers_upload()
-
-
-// Recuperer les variables d'upload
-if (!$_FILES)
-	$_FILES = &amp;$HTTP_POST_FILES;
-if (!is_array($_FILES))
-	$_FILES = array();
-foreach ($_FILES as $id =&gt; $file) {
-	if ($file['error'] == 4 /* UPLOAD_ERR_NO_FILE */)
-		unset ($_FILES[$id]);
-}
-
-
-// Si on est en mode 'document', les images doivent etre installees
-// comme documents dans le portfolio
-if ($forcer_document) $mode = 'document';
-
-
-//
-// Le switch principal : quelle est l'action demandee
-//
-
-
-// appel de config-fonction
-if ($test_vignette)
-	$retour_image = tester_vignette($test_vignette);
-
-// Creation de vignette depuis le portfolio (ou autre)
-else if ($vignette) {
-	if ($creer_vignette == 'oui' AND
-	verifier_action_auteur(&quot;vign $vignette&quot;,
-	$hash, $hash_id_auteur))
-		creer_fichier_vignette($vignette);
-	else
-		$retour_image = creer_fichier_vignette($vignette, true); # obsolete
-}
-
-
-//
-// Ajout d'un document ou d'une image
-//
-else if ($ajout_doc == 'oui') {
-
-	// Autorisation ?
-	if (!verifier_action_auteur(&quot;ajout_doc&quot;, $hash, $hash_id_auteur))
-		die ('Interdit');
-
-	//
-	// Cas d'un fichier ou d'un repertoire installe dans ecrire/upload/
-	//
-	if ($_POST['image2']
-	AND !strstr($_POST['image2'], '..')
-	AND $_POST['ok_ftp']
-	) {
-		$upload = _DIR_TRANSFERT.$_POST['image2'];
-
-		// lire le repertoire upload et remplir $_FILES
-		if (is_dir($upload)) {
-			$fichiers = fichiers_upload($upload);
-
-			$_FILES = array();
-			foreach ($fichiers as $fichier) {
-				$_FILES[] = array (
-					'name' =&gt; basename($fichier),
-					'tmp_name' =&gt; $fichier
-				);
-			}
-		}
-
-		// seul un fichier est demande
-		else
-			$_FILES = array(
-				array ('name' =&gt; basename($upload),
-				'tmp_name' =&gt; $upload)
-			);
-	}
-
-	//
-	// Upload d'un ZIP
-	//
-
-	// traiter la reponse de l'utilisateur
-	if (preg_match('@^IMG/zip/[^. ]+\.zip$@i', $_POST['source_zip'])) {
-		$_FILES = array(
-			array('name' =&gt; basename($_POST['source_zip']),
-				'tmp_name' =&gt; $_POST['source_zip'])
-		);
-	}
-
-	// traiter le zip si c'en est un tout seul
-	if (count($_FILES) == 1
-	AND $action_zip!='telquel') {
-		$desc = array_pop($_FILES); # recuperer la description
-		$_FILES = array($desc);
-
-		if (preg_match('/\.zip$/i', $desc['name'])
-		OR ($desc['type'] == 'application/zip')) {
-
-			// on pose le fichier dans le repertoire zip et on met
-			// a jour $_FILES (nota : copier_document n'ecrase pas
-			// un fichier avec lui-meme : ca autorise a boucler)
-			$zip = copier_document(&quot;zip&quot;,
-				$desc['name'],
-				$desc['tmp_name']
-			);
-			if (!$zip) die ('Erreur upload zip'); # pathologique
-			$desc['tmp_name'] = $zip;	# nouvel emplacement du fichier
-			$_FILES = array($desc);
-
-			// Est-ce qu'on sait le lire ?
-			require_once(_DIR_RESTREINT . 'pclzip.lib.php');
-			$archive = new PclZip($zip);
-			$contenu = verifier_compactes($archive);
-
-			// si non, on le force comme document
-			if (!$contenu) {
-				$forcer_document = 'oui';
-			}
-
-			// si le deballage est demande
-			else if ($action_zip == 'decompacter') {
-				// 1. on deballe
-				define('_tmp_dir', creer_repertoire_documents($hash));
-				$archive-&gt;extract(PCLZIP_OPT_PATH,
-					_tmp_dir,
-					PCLZIP_OPT_REMOVE_ALL_PATH);
-				// 2. on supprime le fichier temporaire
-				$contenu = verifier_compactes($archive);
-				@unlink($zip);
-
-				$_FILES = array();
-				foreach ($contenu as $fichier) {
-					$_FILES[] = array(
-						'name' =&gt; basename($fichier),
-						'tmp_name' =&gt; _tmp_dir.$fichier);
-				}
-			}
-
-			// sinon on demande une reponse
-			else {
-				$link = new Link('spip_image.php3');
-				$link-&gt;addVar('ajout_doc', 'oui');
-				$link-&gt;addVar('redirect', $redirect);
-				$link-&gt;addVar('id_article', $id_article);
-				$link-&gt;addVar('mode', $mode);
-				$link-&gt;addVar('type', $type);
-				$link-&gt;addVar('hash', $hash);
-				$link-&gt;addVar('hash_id_auteur', $hash_id_auteur);
-				$link-&gt;addVar('source_zip', $zip);
-				afficher_compactes($desc, $contenu, $link);
-				exit;
-			}
-		}
-	}
-	// Fin du bloc ZIP
-
-
-	//
-	// Traiter la liste des fichiers
-	//
-	$documents_actifs = array();
-
-	foreach ($_FILES as $file) {
-
-		// afficher l'erreur 'fichier trop gros' ou autre
-		check_upload_error($file['error']);
-
-		spip_log (&quot;ajout du document &quot;.$file['name'].&quot;, $mode ($type $id_article)&quot;);
-		ajouter_un_document (
-			$file['tmp_name'],	# le fichier sur le serveur (/var/tmp/xyz34)
-			$file['name'],		# son nom chez le client (portequoi.pdf)
-			$type,				# lie a un article, une breve ou une rubrique ?
-			$id_article,		# identifiant de l'article (ou rubrique) lie
-			$mode,				# 'vignette' =&gt; vignette personnalisee
-			$id_document,		# pour une vignette, l'id_document de maman
-			$documents_actifs	# tableau des id_document &quot;actifs&quot; (par ref)
-		);
-	}	// foreach $_FILES
-
-	// Nettoyer le repertoire temporaire d'extraction des fichiers
-	if (defined('_tmp_dir'))
-		effacer_repertoire_temporaire(_tmp_dir);
-}
-
-// Ajout d'un logo
-else if ($ajout_logo == &quot;oui&quot; and $logo) {
-	if ($desc = array_pop($_FILES)
-	AND verifier_action_auteur(&quot;ajout_logo $logo&quot;,
-	$hash, $hash_id_auteur))
-		ajout_logo($desc, $logo);
-}
-
-// Suppression d'un logo
-else if ($image_supp) {
-	if (verifier_action_auteur(&quot;supp_logo $image_supp&quot;,
-	$hash, $hash_id_auteur))
-		effacer_logo($image_supp);
-}
-
-// Suppression d'un document et de sa vignette
-else if ($doc_supp) {
-	if (verifier_action_auteur(&quot;supp_doc $doc_supp&quot;,
-	$hash, $hash_id_auteur))
-		supprime_document_et_vignette($doc_supp);
-}
-
-// Rotation d'une image
-else if ($doc_rotate) {
-	if (verifier_action_auteur(&quot;rotate $doc_rotate&quot;,
-	$hash, $hash_id_auteur))
-		tourner_document($var_rot, $doc_rotate, $convert_command);
-}
-
-
-//
-// Retour a l'envoyeur
-//
-
-// si nous sommes diriges vers une vignette
-if ($retour_image) {
-	redirige_par_entete($retour_image);
-
-} else {
-	$link = new Link(_DIR_RESTREINT_ABS . $redirect);
-	if ($documents_actifs) {
-		$show_docs = join('-',$documents_actifs);
-		$link-&gt;addVar('show_docs',$show_docs);
-	}
-
-	redirige_par_entete($link-&gt;getUrl($ancre));
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// Uploader un document, une image ou un logo,
+// supprimer cet element, creer les vignettes, etc.
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire('inc_presentation.php3');	# regler la langue en cas d'erreur
+include_ecrire('inc_getdocument.php3');		# diverses fonctions de ce fichier
+include_ecrire(&quot;inc_charsets.php3&quot;);		# pour le nom de fichier
+include_ecrire(&quot;inc_meta.php3&quot;);			# ne pas faire confiance au cache
+											# (alea_ephemere a peut-etre change)
+include_ecrire(&quot;inc_admin.php3&quot;);			# verifier_action_auteur
+include_ecrire(&quot;inc_abstract_sql.php3&quot;);	# spip_insert
+include_ecrire('inc_documents.php3');		# fichiers_upload()
+
+
+// Recuperer les variables d'upload
+if (!$_FILES)
+	$_FILES = &amp;$HTTP_POST_FILES;
+if (!is_array($_FILES))
+	$_FILES = array();
+foreach ($_FILES as $id =&gt; $file) {
+	if ($file['error'] == 4 /* UPLOAD_ERR_NO_FILE */)
+		unset ($_FILES[$id]);
+}
+
+// Si on est en mode 'document', les images doivent etre installees
+// comme documents dans le portfolio
+if ($forcer_document) $mode = 'document';
+
+
+//
+// Le switch principal : quelle est l'action demandee
+//
+
+
+// appel de config-fonction
+if ($test_vignette)
+	$retour_image = tester_vignette($test_vignette);
+
+// Creation de vignette depuis le portfolio (ou autre)
+else if ($vignette) {
+	if ($creer_vignette == 'oui' AND
+	verifier_action_auteur(&quot;vign $vignette&quot;,
+	$hash, $hash_id_auteur))
+		creer_fichier_vignette($vignette);
+	else
+		$retour_image = creer_fichier_vignette($vignette, true); # obsolete
+}
+
+
+//
+// Ajout d'un document ou d'une image
+//
+else if ($ajout_doc == 'oui') {
+
+	// Autorisation ?
+	if (!verifier_action_auteur(&quot;ajout_doc&quot;, $hash, $hash_id_auteur))
+		die ('Interdit');
+
+	//
+	// Cas d'un fichier ou d'un repertoire installe dans ecrire/upload/
+	//
+	if ($_POST['image2']
+	AND !strstr($_POST['image2'], '..')
+	AND $_POST['ok_ftp']
+	) {
+		$upload = _DIR_TRANSFERT.$_POST['image2'];
+
+		// lire le repertoire upload et remplir $_FILES
+		if (is_dir($upload)) {
+			$fichiers = fichiers_upload($upload);
+
+			$_FILES = array();
+			foreach ($fichiers as $fichier) {
+				$_FILES[] = array (
+					'name' =&gt; basename($fichier),
+					'tmp_name' =&gt; $fichier
+				);
+			}
+		}
+
+		// seul un fichier est demande
+		else
+			$_FILES = array(
+				array ('name' =&gt; basename($upload),
+				'tmp_name' =&gt; $upload)
+			);
+	}
+
+	//
+	// Upload d'un ZIP
+	//
+
+	// traiter la reponse de l'utilisateur ('telquel' ou 'decompacter')
+	if ($_POST['source_zip']
+	AND !strstr($_POST['source_zip'], '..')) # securite
+	{
+		$_FILES = array(
+			array('name' =&gt; basename($_POST['source_zip']),
+				'tmp_name' =&gt; $_POST['source_zip'])
+		);
+	}
+
+	// traiter le zip si c'en est un tout seul
+	if (count($_FILES) == 1
+	AND $action_zip!='telquel') {
+		$desc = array_pop($_FILES); # recuperer la description
+		$_FILES = array($desc);
+
+		if (preg_match('/\.zip$/i', $desc['name'])
+		OR ($desc['type'] == 'application/zip')) {
+
+			// on pose le fichier dans le repertoire zip et on met
+			// a jour $_FILES (nota : copier_document n'ecrase pas
+			// un fichier avec lui-meme : ca autorise a boucler)
+			$zip = copier_document(&quot;zip&quot;,
+				$desc['name'],
+				$desc['tmp_name']
+			);
+			if (!$zip) die ('Erreur upload zip'); # pathologique
+			$desc['tmp_name'] = $zip;	# nouvel emplacement du fichier
+			$_FILES = array($desc);
+
+			// Est-ce qu'on sait le lire ?
+			require_once(_DIR_RESTREINT . 'pclzip.lib.php');
+			$archive = new PclZip($zip);
+			$contenu = verifier_compactes($archive);
+
+			// si non, on le force comme document
+			if (!$contenu) {
+				$forcer_document = 'oui';
+			}
+
+			// si le deballage est demande
+			else if ($action_zip == 'decompacter') {
+				// 1. on deballe
+				define('_tmp_dir', creer_repertoire_documents($hash));
+				$archive-&gt;extract(PCLZIP_OPT_PATH,
+					_tmp_dir,
+					PCLZIP_OPT_REMOVE_ALL_PATH);
+				// 2. on supprime le fichier temporaire
+				$contenu = verifier_compactes($archive);
+				@unlink($zip);
+
+				$_FILES = array();
+				foreach ($contenu as $fichier) {
+					$_FILES[] = array(
+						'name' =&gt; basename($fichier),
+						'tmp_name' =&gt; _tmp_dir.$fichier);
+				}
+			}
+
+			// sinon on demande une reponse
+			else {
+				$link = new Link('spip_image.php3');
+				$link-&gt;addVar('ajout_doc', 'oui');
+				$link-&gt;addVar('redirect', $redirect);
+				$link-&gt;addVar('id_article', $id_article);
+				$link-&gt;addVar('mode', $mode);
+				$link-&gt;addVar('type', $type);
+				$link-&gt;addVar('hash', $hash);
+				$link-&gt;addVar('hash_id_auteur', $hash_id_auteur);
+				$link-&gt;addVar('source_zip', $zip);
+				afficher_compactes($desc, $contenu, $link);
+				exit;
+			}
+		}
+	}
+	// Fin du bloc ZIP
+
+
+	//
+	// Traiter la liste des fichiers
+	//
+	$documents_actifs = array();
+
+	foreach ($_FILES as $file) {
+
+		// afficher l'erreur 'fichier trop gros' ou autre
+		check_upload_error($file['error']);
+
+		spip_log (&quot;ajout du document &quot;.$file['name'].&quot;, $mode ($type $id_article)&quot;);
+		ajouter_un_document (
+			$file['tmp_name'],	# le fichier sur le serveur (/var/tmp/xyz34)
+			$file['name'],		# son nom chez le client (portequoi.pdf)
+			$type,				# lie a un article, une breve ou une rubrique ?
+			$id_article,		# identifiant de l'article (ou rubrique) lie
+			$mode,				# 'vignette' =&gt; vignette personnalisee
+			$id_document,		# pour une vignette, l'id_document de maman
+			$documents_actifs	# tableau des id_document &quot;actifs&quot; (par ref)
+		);
+	}	// foreach $_FILES
+
+	// Nettoyer le repertoire temporaire d'extraction des fichiers
+	if (defined('_tmp_dir'))
+		effacer_repertoire_temporaire(_tmp_dir);
+}
+
+// Ajout d'un logo
+else if ($ajout_logo == &quot;oui&quot; and $logo) {
+	if ($desc = array_pop($_FILES)
+	AND verifier_action_auteur(&quot;ajout_logo $logo&quot;,
+	$hash, $hash_id_auteur))
+		ajout_logo($desc, $logo);
+}
+
+// Suppression d'un logo
+else if ($image_supp) {
+	if (verifier_action_auteur(&quot;supp_logo $image_supp&quot;,
+	$hash, $hash_id_auteur))
+		effacer_logo($image_supp);
+}
+
+// Suppression d'un document et de sa vignette
+else if ($doc_supp) {
+	if (verifier_action_auteur(&quot;supp_doc $doc_supp&quot;,
+	$hash, $hash_id_auteur))
+		supprime_document_et_vignette($doc_supp);
+}
+
+// Rotation d'une image
+else if ($doc_rotate) {
+	if (verifier_action_auteur(&quot;rotate $doc_rotate&quot;,
+	$hash, $hash_id_auteur))
+		tourner_document($var_rot, $doc_rotate, $convert_command);
+}
+
+
+//
+// Retour a l'envoyeur
+//
+
+// si nous sommes diriges vers une vignette
+if ($retour_image) {
+	redirige_par_entete($retour_image);
+
+} else {
+	$link = new Link(_DIR_RESTREINT_ABS . $redirect);
+	if ($documents_actifs) {
+		$show_docs = join('-',$documents_actifs);
+		$link-&gt;addVar('show_docs',$show_docs);
+	}
+
+	redirige_par_entete($link-&gt;getUrl($ancre));
+}
+
+?&gt;

Index: inc-stats.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-stats.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-stats.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-stats.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,73 +1,84 @@
-&lt;?php
-
-//
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_STATS&quot;)) return;
-define(&quot;_INC_STATS&quot;, &quot;1&quot;);
-
-function ecrire_stats() {
-	global $id_article, $id_breve, $id_rubrique;
-
-	if ($GLOBALS['HTTP_X_FORWARDED_FOR'])
-		$log_ip = $GLOBALS['HTTP_X_FORWARDED_FOR'];
-	else
-		$log_ip = $GLOBALS['REMOTE_ADDR'];
-
-	if ($log_id_num = intval($id_rubrique))
-		$log_type = &quot;rubrique&quot;;
-	else if ($log_id_num = intval($id_article))
-		$log_type = &quot;article&quot;;
-	else if ($log_id_num = intval($id_breve))
-		$log_type = &quot;breve&quot;;
-	else
-		$log_type = &quot;autre&quot;;
-
-	// Conversion IP 4 octets -&gt; entier 32 bits
-	if (ereg(&quot;^(::ffff:)?([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$&quot;, $log_ip, $r)) {
-		$log_ip = sprintf(&quot;0x%02x%02x%02x%02x&quot;, $r[2], $r[3], $r[4], $r[5]);
-	}
-	else return;
-
-	//
-	// Loguer la visite dans la base si possible
-	//
-	if ($log_type != &quot;autre&quot;) {
-		$query = &quot;INSERT IGNORE INTO spip_visites_temp (ip, type, id_objet) &quot;.
-			&quot;VALUES ($log_ip, '$log_type', $log_id_num)&quot;;
-		spip_query($query);
-	}
-
-	//
-	// Loguer le referer
-	//
-	$url_site_spip = lire_meta('adresse_site');
-	$url_site_spip = eregi_replace(&quot;^((https?|ftp)://)?(www\.)?&quot;, &quot;&quot;, $url_site_spip);
-	$log_referer = $GLOBALS['HTTP_REFERER'];
-	if (($url_site_spip&lt;&gt;'') AND strpos('-'.strtolower($log_referer), strtolower($url_site_spip)) AND !$GLOBALS['var_recherche']) $log_referer = &quot;&quot;;
-	if ($log_referer) {
-		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
-		$query = &quot;INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) &quot;.
-			&quot;VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)&quot;;
-		spip_query($query);
-	}
-}
-
-
-function afficher_raccourci_stats($id_article) {
-	$query = &quot;SELECT visites, popularite FROM spip_articles WHERE id_article=$id_article AND statut='publie'&quot;;
-	$result = spip_query($query);
-	if ($row = @spip_fetch_array($result)) {
-		$visites = intval($row['visites']);
-		$popularite = ceil($row['popularite']);
-
-		$query = &quot;SELECT COUNT(DISTINCT ip) AS c FROM spip_visites_temp WHERE type='article' AND id_objet=$id_article&quot;;
-		$result = spip_query($query);
-		if ($row = @spip_fetch_array($result)) {
-			$visites = $visites + $row['c'];
-		}
-
-		return array('visites' =&gt; $visites, 'popularite' =&gt; $popularite);
-	}
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+//
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_STATS&quot;)) return;
+define(&quot;_INC_STATS&quot;, &quot;1&quot;);
+
+function ecrire_stats() {
+	global $id_article, $id_breve, $id_rubrique;
+
+	if ($GLOBALS['HTTP_X_FORWARDED_FOR'])
+		$log_ip = $GLOBALS['HTTP_X_FORWARDED_FOR'];
+	else
+		$log_ip = $GLOBALS['REMOTE_ADDR'];
+
+	if ($log_id_num = intval($id_rubrique))
+		$log_type = &quot;rubrique&quot;;
+	else if ($log_id_num = intval($id_article))
+		$log_type = &quot;article&quot;;
+	else if ($log_id_num = intval($id_breve))
+		$log_type = &quot;breve&quot;;
+	else
+		$log_type = &quot;autre&quot;;
+
+	// Conversion IP 4 octets -&gt; entier 32 bits
+	if (ereg(&quot;^(::ffff:)?([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$&quot;, $log_ip, $r)) {
+		$log_ip = sprintf(&quot;0x%02x%02x%02x%02x&quot;, $r[2], $r[3], $r[4], $r[5]);
+	}
+	else return;
+
+	//
+	// Loguer la visite dans la base si possible
+	//
+	if ($log_type != &quot;autre&quot;) {
+		$query = &quot;INSERT IGNORE INTO spip_visites_temp (ip, type, id_objet) &quot;.
+			&quot;VALUES ($log_ip, '$log_type', $log_id_num)&quot;;
+		spip_query($query);
+	}
+
+	//
+	// Loguer le referer
+	//
+	$url_site_spip = lire_meta('adresse_site');
+	$url_site_spip = eregi_replace(&quot;^((https?|ftp)://)?(www\.)?&quot;, &quot;&quot;, $url_site_spip);
+	$log_referer = $GLOBALS['HTTP_REFERER'];
+	if (($url_site_spip&lt;&gt;'') AND strpos('-'.strtolower($log_referer), strtolower($url_site_spip)) AND !$GLOBALS['var_recherche']) $log_referer = &quot;&quot;;
+	if ($log_referer) {
+		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
+		$query = &quot;INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) &quot;.
+			&quot;VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)&quot;;
+		spip_query($query);
+	}
+}
+
+
+function afficher_raccourci_stats($id_article) {
+	$query = &quot;SELECT visites, popularite FROM spip_articles WHERE id_article=$id_article AND statut='publie'&quot;;
+	$result = spip_query($query);
+	if ($row = @spip_fetch_array($result)) {
+		$visites = intval($row['visites']);
+		$popularite = ceil($row['popularite']);
+
+		$query = &quot;SELECT COUNT(DISTINCT ip) AS c FROM spip_visites_temp WHERE type='article' AND id_objet=$id_article&quot;;
+		$result = spip_query($query);
+		if ($row = @spip_fetch_array($result)) {
+			$visites = $visites + $row['c'];
+		}
+
+		return array('visites' =&gt; $visites, 'popularite' =&gt; $popularite);
+	}
+}
+
+?&gt;

Index: rubrique.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/rubrique.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- rubrique.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ rubrique.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,8 +1,8 @@
-&lt;?php
-$fond = &quot;rubrique&quot;;
-$delais = 2 * 3600;
-
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;rubrique&quot;;
+$delais = 2 * 3600;
+
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: spip_redirect.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_redirect.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_redirect.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_redirect.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,44 +1,55 @@
-&lt;?php
-// redirige vers l'URL canonique de l'article,
-// en indiquant recalcul et previsu
-
-include (&quot;ecrire/inc_version.php3&quot;);
-
-// Gestionnaire d'URLs
-if (@file_exists(&quot;inc-urls.php3&quot;))
-	include_local(&quot;inc-urls.php3&quot;);
-else
-	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
-
-if ($id_article) {
-	$url = generer_url_article($id_article);
-}
-else if ($id_breve) {
-	$url = generer_url_breve($id_breve);
-}
-else if ($id_forum) {
-	$url = generer_url_forum($id_forum);
-}
-else if ($id_rubrique) {
-	$url = generer_url_rubrique($id_rubrique);
-}
-else if ($id_mot) {
-	$url = generer_url_mot($id_mot);
-}
-else if ($id_auteur) {
-	$url = generer_url_auteur($id_auteur);
-}
-else {
-	$url = _DIR_RESTREINT_ABS;
-}
-if (strpos($url,'?')) {
-	$super='&amp;';
-}
-else {
-	$super='?';
-}
-if ($recalcul) $url .= $super.&quot;var_mode=recalcul&quot;;
-else if ($preview) $url .= $super.&quot;var_mode=preview&quot;;
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at header</A>(&quot;Location: $url&quot;);
-
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+// redirige vers l'URL canonique de l'article,
+// en indiquant recalcul et previsu
+
+include (&quot;ecrire/inc_version.php3&quot;);
+
+// Gestionnaire d'URLs
+if (@file_exists(&quot;inc-urls.php3&quot;))
+	include_local(&quot;inc-urls.php3&quot;);
+else
+	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
+
+if ($id_article) {
+	$url = generer_url_article($id_article);
+}
+else if ($id_breve) {
+	$url = generer_url_breve($id_breve);
+}
+else if ($id_forum) {
+	$url = generer_url_forum($id_forum);
+}
+else if ($id_rubrique) {
+	$url = generer_url_rubrique($id_rubrique);
+}
+else if ($id_mot) {
+	$url = generer_url_mot($id_mot);
+}
+else if ($id_auteur) {
+	$url = generer_url_auteur($id_auteur);
+}
+else {
+	$url = _DIR_RESTREINT_ABS;
+}
+if (strpos($url,'?')) {
+	$super='&amp;';
+}
+else {
+	$super='?';
+}
+if ($recalcul) $url .= $super.&quot;var_mode=recalcul&quot;;
+else if ($preview) $url .= $super.&quot;var_mode=preview&quot;;
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A>(&quot;Location: $url&quot;);
+
 ?&gt;

Index: index.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/index.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- index.php	8 Feb 2005 15:10:10 -0000	1.2
+++ index.php	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,4 +1,4 @@
-&lt;?php
-	// pour hebergeurs ayant oublie de configurer DirectoryIndex index.php3
-	include (&quot;index.php3&quot;);
-?&gt;
+&lt;?php
+	// pour hebergeurs ayant oublie de configurer DirectoryIndex index.php3
+	include (&quot;index.php3&quot;);
+?&gt;

Index: inc-compilo-api.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo-api.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-compilo-api.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-compilo-api.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,249 +1,201 @@
-&lt;?php
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_COMPILO_API&quot;)) return;
-define(&quot;_INC_COMPILO_API&quot;, &quot;1&quot;);
-
-
-// Definition des classes Boucle, Texte, Inclure, Champ
-
-class Texte {
-	var $type = 'texte';
-	var $texte;
-}
-
-class Inclure {
-	var $type = 'include';
-	var $fichier;
-	var $params;
-}
-
-//
-// encodage d'une boucle SPIP en un objet PHP
-//
-class Boucle {
-	var $type = 'boucle';
-	var $id_boucle;
-	var $id_parent ='';
-	var $cond_avant, $milieu, $cond_apres, $cond_altern;
-	var $lang_select;
-	var $type_requete;
-	var $sql_serveur;
-	var $param = array();
-	var $separateur;
-	var $doublons;
-	var $partie, $total_parties,$mode_partie;
-	var $externe = ''; # appel a partir d'une autre boucle (recursion)
-	// champs pour la construction de la requete SQL
-	var $tout = false;
-	var $plat = false;
-	var $select;
-	var $from;
-	var $where;
-	var $limit;
-	var $group = '';
-	var $order = '';
-	var $default_order = '';
-	var $date = 'date' ;
-	var $hash = false ;
-	var $lien = false;
-	var $sous_requete = false;
-	var $compte_requete = 1;
-	var $hierarchie = '';
-	// champs pour la construction du corps PHP
-	var $id_table;
-	var $primary;
-	var $return;
-	var $numrows = false; 
-}
-
-class Champ {
-	var $type = 'champ';
-	var $nom_champ;
-	var $nom_boucle= ''; // seulement si boucle explicite
-	var $cond_avant, $cond_apres; // tableaux d'objets
-	var $fonctions;  // filtre explicites
-	var $etoile;
-	// champs pour la production de code
-	var $id_boucle;
-	var $boucles;
-	var $type_requete;
-	var $code;	// code du calcul
-	var $statut;	// 'numerique, 'h'=texte (html) ou 'p'=script (php) ?
-			// -&gt; definira les pre et post-traitements obligatoires
-	// champs pour la production de code dependant du contexte
-	var $id_mere;    // pour TOTAL_BOUCLE hors du corps
-	var $document;   // pour embed et img dans les textes
-}
-
-
-//
-// Globales de description de la base
-
-global $tables_des_serveurs_sql, $tables_principales; // (voir inc_serialbase)
-global $exceptions_des_tables, $table_des_tables;
-global $tables_relations,  $table_primary, $table_date;
-
-$tables_des_serveurs_sql = array('localhost' =&gt; &amp;$tables_principales);
-	
-
-	// champ principal des tables SQL
-	$table_primary = array(
-		'articles' =&gt; &quot;id_article&quot;,
-		'auteurs' =&gt; &quot;id_auteur&quot;,
-		'breves' =&gt; &quot;id_breve&quot;,
-		'documents' =&gt; &quot;id_document&quot;,
-		'forums' =&gt; &quot;id_forum&quot;,
-		'groupes_mots' =&gt; &quot;id_groupe&quot;,
-		'hierarchie' =&gt; &quot;id_rubrique&quot;,
-		'mots' =&gt; &quot;id_mot&quot;,
-		'rubriques' =&gt; &quot;id_rubrique&quot;,
-		'signatures' =&gt; &quot;id_signature&quot;,
-		'syndication' =&gt; &quot;id_syndic&quot;,
-		'syndic_articles' =&gt; &quot;id_syndic_article&quot;,
-		'types_documents' =&gt; &quot;id_type&quot;
-		////////////////////////////
-		//MODIFICATION
-		///////////////////////////
-		,'carto_objets' =&gt; &quot;id_carto_objet&quot;
-		,'carto_cartes' =&gt; &quot;id_carto_carte&quot;
-		///////////////////////////
-	);
-	
-	# cf. fonction table_objet dans inc_version
-	$table_des_tables = array(
-		'articles' =&gt; 'articles',
-		'auteurs' =&gt; 'auteurs',
-		'breves' =&gt; 'breves',
-		'forums' =&gt; 'forum',
-		'signatures' =&gt; 'signatures',
-		'documents' =&gt; 'documents',
-		'types_documents' =&gt; 'types_documents',
-		'mots' =&gt; 'mots',
-		'groupes_mots' =&gt; 'groupes_mots',
-		'rubriques' =&gt; 'rubriques',
-		'syndication' =&gt; 'syndic',
-		'syndic_articles' =&gt; 'syndic_articles',
-		'hierarchie' =&gt; 'rubriques'
-		////////////////////////////
-		//MODIFICATION
-		///////////////////////////
-		,'carto_objets' =&gt; &quot;carto_objets&quot;
-		,'carto_cartes' =&gt; &quot;carto_cartes&quot;
-		///////////////////////////
-	);
-	
-	$exceptions_des_tables = array(
-		'breves' =&gt; array(
-			'id_secteur' =&gt; 'id_rubrique',
-			'date' =&gt; 'date_heure',
-			'nom_site' =&gt; 'lien_titre',
-			'url_site' =&gt; 'lien_url'
-			),
-		'forums' =&gt; array(
-			'date' =&gt; 'date_heure',
-			'nom' =&gt; 'auteur',
-			'email' =&gt; 'email_auteur'
-			),
-		'signatures' =&gt; array(
-			'date' =&gt; 'date_time',
-			'nom' =&gt; 'nom_email',
-			'email' =&gt; 'ad_email'
-		),
-		'documents' =&gt; array(
-			'type_document' =&gt; array('types_documents', 'titre'),
-			'extension_document' =&gt; array('types_documents', 'extension')
-		),
-		'syndic_articles' =&gt; array(
-			'url_article' =&gt; 'url',		  # ne sert pas ? cf balise_URL_ARTICLE
-			'lesauteurs' =&gt; 'lesauteurs', # ne sert pas ? cf balise_LESAUTEURS
-			'url_site' =&gt; array('syndic', 'url_site'),
-			'nom_site' =&gt; array('syndic', 'nom_site')
-		)
-	);
-	
-	$table_date = array (
-		'articles' =&gt; 'date',
-		'auteurs' =&gt;  'date',
-		'breves' =&gt;  'date_heure',
-		'forums' =&gt;  'date_heure',
-		'signatures' =&gt; 'date_time',
-		'documents' =&gt; 'date',
-		'types_documents' =&gt; 'date',
-		'groupes_mots' =&gt; 'date',
-		'mots' =&gt; 'date',
-		'rubriques' =&gt; 'date',
-		'syndication' =&gt; 'date',
-		'syndic_articles' =&gt; 'date'
-	);
-
-
-//
-// tableau des tables de relations,
-// Ex: gestion du critere {id_mot} dans la boucle(ARTICLES)
-//
-
-$tables_relations = array(
-	'articles' =&gt; array (
-		'id_mot' =&gt; 'mots_articles',
-		'id_auteur' =&gt; 'auteurs_articles',
-		'id_document' =&gt; 'documents_articles'
-		),
-
-	'auteurs' =&gt; array (
-		'id_article' =&gt; 'auteurs_articles'
-		),
-
-	'breves' =&gt; array (
-		'id_mot' =&gt; 'mots_breves',
-		'id_document' =&gt; 'documents_breves'
-		),
-
-	'documents' =&gt; array (
-		'id_article' =&gt; 'documents_articles',
-		'id_rubrique' =&gt; 'documents_rubriques',
-		'id_breve' =&gt; 'documents_breves'
-		////////////////////////////
-		//MODIFICATION
-		///////////////////////////
-		,'id_carto_carte' =&gt; 'documents_carto_cartes'
-		///////////////////////////
-		),
-
-	'forums' =&gt; array (
-		'id_mot' =&gt; 'mots_forum',
-		),
-
-	'mots' =&gt; array (
-		'id_article' =&gt; 'mots_articles',
-		'id_breve' =&gt; 'mots_breves',
-		'id_forum' =&gt; 'mots_forum',
-		'id_rubrique' =&gt; 'mots_rubriques',
-		'id_syndic' =&gt; 'mots_syndic'
-		////////////////////////////
-		//MODIFICATION
-		///////////////////////////
-		,'id_carto_objet' =&gt; 'mots_carto_objets'
-		),
-	'carto_objets' =&gt; array (
-		'id_mot' =&gt; 'mots_carto_objets',
-		),
-	'carto_cartes' =&gt; array (
-		'id_document' =&gt; 'mots_carto_cartes',
-		///////////////////////////
-		),
-
-	'groupes_mots' =&gt; array (
-		'id_groupe' =&gt; 'mots'
-		),
-
-	'rubriques' =&gt; array (
-		'id_mot' =&gt; 'mots_rubriques',
-		'id_document' =&gt; 'documents_rubriques'
-		),
-
-	'syndication' =&gt; array (
-		'id_mot' =&gt; 'mots_syndic'
-		)
-	);
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_COMPILO_API&quot;)) return;
+define(&quot;_INC_COMPILO_API&quot;, &quot;1&quot;);
+
+
+// Definition des classes Boucle, Texte, Inclure, Champ
+
+class Texte {
+	var $type = 'texte';
+	var $texte;
+}
+
+class Inclure {
+	var $type = 'include';
+	var $fichier;
+	var $params;
+}
+
+//
+// encodage d'une boucle SPIP en un objet PHP
+//
+class Boucle {
+	var $type = 'boucle';
+	var $id_boucle;
+	var $id_parent ='';
+	var $cond_avant, $milieu, $cond_apres, $cond_altern;
+	var $lang_select;
+	var $type_requete;
+	var $sql_serveur;
+	var $param = array();
+	var $separateur;
+	var $doublons;
+	var $partie, $total_parties,$mode_partie;
+	var $externe = ''; # appel a partir d'une autre boucle (recursion)
+	// champs pour la construction de la requete SQL
+	var $tout = false;
+	var $plat = false;
+	var $select;
+	var $from;
+	var $where;
+	var $limit;
+	var $group = '';
+	var $order = '';
+	var $default_order = '';
+	var $date = 'date' ;
+	var $hash = false ;
+	var $lien = false;
+	var $sous_requete = false;
+	var $compte_requete = 1;
+	var $hierarchie = '';
+	// champs pour la construction du corps PHP
+	var $id_table;
+	var $primary;
+	var $return;
+	var $numrows = false; 
+}
+
+class Champ {
+	var $type = 'champ';
+	var $nom_champ;
+	var $nom_boucle= ''; // seulement si boucle explicite
+	var $cond_avant, $cond_apres; // tableaux d'objets
+	var $fonctions;  // filtre explicites
+	var $etoile;
+	// champs pour la production de code
+	var $id_boucle;
+	var $boucles;
+	var $type_requete;
+	var $code;	// code du calcul
+	var $statut;	// 'numerique, 'h'=texte (html) ou 'p'=script (php) ?
+			// -&gt; definira les pre et post-traitements obligatoires
+	// champs pour la production de code dependant du contexte
+	var $id_mere;    // pour TOTAL_BOUCLE hors du corps
+	var $document;   // pour embed et img dans les textes
+}
+
+
+//
+// Globales de description de la base
+
+global $tables_des_serveurs_sql, $tables_principales; // (voir inc_serialbase)
+global $exceptions_des_tables, $table_des_tables;
+global $tables_relations,  $table_primary, $table_date;
+
+$tables_des_serveurs_sql = array('localhost' =&gt; &amp;$tables_principales);
+	
+
+	// champ principal des tables SQL
+$table_primary['articles']=&quot;id_article&quot;;
+$table_primary['auteurs']=&quot;id_auteur&quot;;
+$table_primary['breves']=&quot;id_breve&quot;;
+$table_primary['documents']=&quot;id_document&quot;;
+$table_primary['forums']=&quot;id_forum&quot;;
+$table_primary['groupes_mots']=&quot;id_groupe&quot;;
+$table_primary['hierarchie']=&quot;id_rubrique&quot;;
+$table_primary['mots']=&quot;id_mot&quot;;
+$table_primary['rubriques']=&quot;id_rubrique&quot;;
+$table_primary['signatures']=&quot;id_signature&quot;;
+$table_primary['syndication']=&quot;id_syndic&quot;;
+$table_primary['syndic_articles']=&quot;id_syndic_article&quot;;
+$table_primary['types_documents']=&quot;id_type&quot;;
+	
+	# cf. fonction table_objet dans inc_version
+$table_des_tables['articles']='articles';
+$table_des_tables['auteurs']='auteurs';
+$table_des_tables['breves']='breves';
+$table_des_tables['forums']='forum';
+$table_des_tables['signatures']='signatures';
+$table_des_tables['documents']='documents';
+$table_des_tables['types_documents']='types_documents';
+$table_des_tables['mots']='mots';
+$table_des_tables['groupes_mots']='groupes_mots';
+$table_des_tables['rubriques']='rubriques';
+$table_des_tables['syndication']='syndic';
+$table_des_tables['syndic_articles']='syndic_articles';
+$table_des_tables['hierarchie']='rubriques';
+	
+$exceptions_des_tables['breves']['id_secteur']='id_rubrique';
+$exceptions_des_tables['breves']['date']='date_heure';
+$exceptions_des_tables['breves']['nom_site']='lien_titre';
+$exceptions_des_tables['breves']['url_site']='lien_url';
+
+$exceptions_des_tables['forums']['date']='date_heure';
+$exceptions_des_tables['forums']['nom']='auteur';
+$exceptions_des_tables['forums']['email']='email_auteur';
+
+$exceptions_des_tables['signatures']['date']='date_time';
+$exceptions_des_tables['signatures']['nom']='nom_email';
+$exceptions_des_tables['signatures']['email']='ad_email';
+
+$exceptions_des_tables['documents']['type_document']=array('types_documents', 'titre');
+$exceptions_des_tables['documents']['extension_document']=array('types_documents', 'extension');
+
+$exceptions_des_tables['syndic_articles']['url_article']='url';		  # ne sert pas ? cf balise_URL_ARTICLE
+$exceptions_des_tables['syndic_articles']['lesauteurs']='lesauteurs'; # ne sert pas ? cf balise_LESAUTEURS
+$exceptions_des_tables['syndic_articles']['url_site']=array('syndic', 'url_site');
+$exceptions_des_tables['syndic_articles']['nom_site']=array('syndic', 'nom_site');
+
+
+$table_date['articles']='date';
+$table_date['auteurs']='date';
+$table_date['breves']='date_heure';
+$table_date['forums']='date_heure';
+$table_date['signatures']='date_time';
+$table_date['documents']='date';
+$table_date['types_documents']='date';
+$table_date['groupes_mots']='date';
+$table_date['mots']='date';
+$table_date['rubriques']='date';
+$table_date['syndication']='date';
+$table_date['syndic_articles']='date';
+
+
+//
+// tableau des tables de relations,
+// Ex: gestion du critere {id_mot} dans la boucle(ARTICLES)
+//
+$tables_relations['articles']['id_mot']='mots_articles';
+$tables_relations['articles']['id_auteur']='auteurs_articles';
+$tables_relations['articles']['id_document']='documents_articles';
+
+$tables_relations['auteurs']['id_article']='auteurs_articles';
+
+$tables_relations['breves']['id_mot']='mots_breves';
+$tables_relations['breves']['id_document']='documents_breves';
+
+$tables_relations['documents']['id_article']='documents_articles';
+$tables_relations['documents']['id_rubrique']='documents_rubriques';
+$tables_relations['documents']['id_breve']='documents_breves';
+
+$tables_relations['forums']['id_mot']='mots_forum';
+
+$tables_relations['mots']['id_article']='mots_articles';
+$tables_relations['mots']['id_breve']='mots_breves';
+$tables_relations['mots']['id_forum']='mots_forum';
+$tables_relations['mots']['id_rubrique']='mots_rubriques';
+$tables_relations['mots']['id_syndic']='mots_syndic';
+
+$tables_relations['groupes_mots']['id_groupe']='mots';
+
+$tables_relations['rubriques']['id_mot']='mots_rubriques';
+$tables_relations['rubriques']['id_document']='documents_rubriques';
+
+$tables_relations['syndication']['id_mot']='mots_syndic';
+
+
+
+?&gt;

Index: inc-compilo-index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo-index.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-compilo-index.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-compilo-index.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,344 +1,357 @@
-&lt;?php
-
-
-// fonctions de recherche et de reservation
-// dans l'arborescence des boucles
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_COMPILO_INDEX&quot;)) return;
-define(&quot;_INC_COMPILO_INDEX&quot;, &quot;1&quot;);
-
-// index_pile retourne la position dans la pile du champ SQL $nom_champ 
-// en prenant la boucle la plus proche du sommet de pile (indique par $idb).
-// Si on ne trouve rien, on considere que ca doit provenir du contexte 
-// (par l'URL ou l'include) qui a ete recopie dans Pile[0]
-// (un essai d'affinage a debouche sur un bug vicieux)
-// Si ca reference un champ SQL, on le memorise dans la structure $boucles
-// afin de construire un requete SQL minimale (plutot qu'un brutal 'SELECT *')
-
-function index_pile($idb, $nom_champ, &amp;$boucles, $explicite='') {
-  global $exceptions_des_tables, $table_des_tables, $tables_des_serveurs_sql;
-
-	$i = 0;
-	if (strlen($explicite)) {
-	// Recherche d'un champ dans un etage superieur
-	  while (($idb != $explicite) &amp;&amp; ($idb !='')) {
-#		spip_log(&quot;Cherchexpl: $nom_champ '$explicite' '$idb' '$i'&quot;);
-			$i++;
-			$idb = $boucles[$idb]-&gt;id_parent;
-		}
-	}
-
-	$c = strtolower($nom_champ);
-	// attention: entre la boucle nommee 0, &quot;&quot; et le tableau vide,
-	// il y a incoherences qu'il vaut mieux eviter
-	while ($boucles[$idb]) {
-#		spip_log(&quot;Cherche: $nom_champ '$idb' '$c'&quot;);
-		$r = $boucles[$idb]-&gt;type_requete;
-		$s = $boucles[$idb]-&gt;sql_serveur;
-		if (!$s) 
-		  { $s = 'localhost';
-    // indirection (pour les rares cas ou le nom de la table!=type)
-		    $t = $table_des_tables[$r];
-		  }
-		// pour les tables non Spip
-		if (!$t) {$nom_table = $t = $r; }
-		else $nom_table = 'spip_' . $t;
-
-		#spip_log(&quot;Go: idb='$idb' r='$r' c='$c' nom='$nom_champ' s=$s t=$t&quot;);
-		$desc = $tables_des_serveurs_sql[$s][$nom_table];
-		if (!$desc) {
-			erreur_squelette(_T('zbug_table_inconnue', array('table' =&gt; $r)),
-				&quot;'$idb'&quot;);
-			# continuer pour chercher l'erreur suivante
-			return  &quot;'#&quot; . $r . ':' . $nom_champ . &quot;'&quot;;
-		}
-		$excep = $exceptions_des_tables[$r][$c];
-		if ($excep) {
-			// entite SPIP alias d'un champ SQL
-			if (!is_array($excep)) {
-				$e = $excep;
-				$c = $excep;
-			} 
-			// entite SPIP alias d'un champ dans une autre table SQL
-			else {
-				$t = $excep[0];
-				$e = $excep[1].' AS '.$c;
-			}
-		}
-		else {
-			// $e est le type SQL de l'entree
-			// entite SPIP homonyme au champ SQL
-			if ($desc['field'][$c])
-				$e = $c;
-			else
-				unset($e);
-		}
-
-#		spip_log(&quot;Dans $idb ('$t' '$e'): $desc&quot;);
-
-		// On l'a trouve
-		if ($e) {
-			$boucles[$idb]-&gt;select[] = $t . &quot;.&quot; . $e;
-			return '$Pile[$SP' . ($i ? &quot;-$i&quot; : &quot;&quot;) . '][\'' . $c . '\']';
-		}
-
-		// Sinon on remonte d'un cran
-		$idb = $boucles[$idb]-&gt;id_parent;
-		$i++;
-	}
-
-#	spip_log(&quot;Pas vu $nom_champ dans les &quot; . count($boucles) . &quot; boucles&quot;);
-	// esperons qu'il y sera
-	return('$Pile[0][\''.$nom_champ.'\']');
-}
-
-# calculer_champ genere le code PHP correspondant a une balise Spip
-# Retourne une EXPRESSION php 
-function calculer_champ($p) {
-	$p = calculer_balise($p-&gt;nom_champ, $p);
-
-	// definir le type et les traitements
-	// si ca ramene le choix par defaut, ce n'est pas un champ 
-
-	if (($p-&gt;code) &amp;&amp; ($p-&gt;code != '$Pile[0][\''.$nom.'\']')) {
-		// Par defaut basculer en numerique pour les #ID_xxx
-		if (substr($nom,0,3) == 'ID_') $p-&gt;statut = 'num';
-	}
-
-	else {
-	// on renvoie la forme initiale '#TOTO'
-	$p-&gt;code = &quot;'#&quot; . $nom . &quot;'&quot;;
-	$p-&gt;statut = 'php';	// pas de traitement
-	
-	}
-
-	// Retourner l'expression php correspondant au champ + ses filtres
-	return applique_filtres($p);
-}
-
-// cette fonction sert d'API pour demander le champ '$champ' dans la pile
-function champ_sql($champ, $p) {
-	return index_pile($p-&gt;id_boucle, $champ, $p-&gt;boucles, $p-&gt;nom_boucle);
-}
-
-// cette fonction sert d'API pour demander une balise quelconque sans filtre
-function calculer_balise($nom, $p) {
-
-	// regarder s'il existe une fonction personnalisee balise_NOM()
-	$f = 'balise_' . $nom;
-	if (function_exists($f))
-		return $f($p);
-
-	// regarder s'il existe une fonction standard balise_NOM_dist()
-	$f = 'balise_' . $nom . '_dist';
-	if (function_exists($f))
-		return $f($p);
-
-	// regarder s'il existe un fichier d'inclusion au nom de la balise
-	// et contenant un tableau balise_NOM_collecte
-	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
-	if ($file = find_in_path($file)) {
-		include_local($file);
-		$f = $GLOBALS['balise_' . $nom . '_collecte'];
-		if (is_array($f))
-			return calculer_balise_dynamique($p, $nom, $f);
-	}
-
-	// S'agit-il d'un logo ? Une fonction speciale les traite tous
-	if (ereg('^LOGO_', $nom))
-		return calculer_balise_logo($p);
-
-	// ca pourrait etre un champ SQL homonyme,
-	$p-&gt;code = index_pile($p-&gt;id_boucle, $nom, $p-&gt;boucles, $p-&gt;nom_boucle);
-
-	// Compatibilite ascendante avec les couleurs html (#FEFEFE) :
-	// SI le champ SQL n'est pas trouve
-	// ET si la balise a une forme de couleur
-	// ET s'il n'y a ni filtre ni etoile
-	// ALORS retourner la couleur.
-	// Ca permet si l'on veut vraiment de recuperer [(#ACCEDE*)]
-	if (ereg(&quot;^[\$]Pile[[]0[]][[]'([A-F]{1,6})'[]]$&quot;, $p-&gt;code, $match)
-	AND !$p-&gt;etoile
-	AND !$p-&gt;fonctions) {
-		$p-&gt;code = &quot;'#&quot;. $match[1].&quot;'&quot;;
-		$p-&gt;statut = 'php';
-	}
-
-	return $p;
-}
-
-//
-// Traduction des balises dynamiques, notamment les &quot;formulaire_*&quot;
-// Inclusion du fichier associe a son nom.
-// Ca donne les arguments a chercher dans la pile,on compile leur localisation
-// Ensuite on delegue a une fonction generale definie dans inc-calcul-outils
-// qui recevra a l'execution la valeurs des arguments, 
-// ainsi que les filtres (qui ne sont donc pas traites a la compil)
-
-function calculer_balise_dynamique($p, $nom, $l) {
-	balise_distante_interdite($p);
-	$param = param_balise($p);
-	$p-&gt;code = &quot;executer_balise_dynamique('&quot; . $nom . &quot;',\n\tarray(&quot;
-	  . join(',',collecter_balise_dynamique($l, $p))
-	  . filtres_arglist($param, $p, ',')
-	  . &quot;),\n\tarray(&quot;
-	  . (!$p-&gt;fonctions ? '' : (&quot;'&quot; . join(&quot;','&quot;, $p-&gt;fonctions) . &quot;'&quot;))
-	  . &quot;), \$GLOBALS['spip_lang'])&quot;;
-	$p-&gt;statut = 'php';
-	$p-&gt;fonctions = '';
-
-	// Cas particulier de #FORMULAIRE_FORUM : inserer l'invalideur
-	if ($nom == 'FORMULAIRE_FORUM')
-		$p-&gt;code = code_invalideur_forums($p, $p-&gt;code);
-
-	return $p;
-}
-
-function param_balise(&amp;$p) {
-	$a = $p-&gt;fonctions;
-	if ($a) list(,$nom) = each($a) ; else $nom = '';
-	if (!ereg(' *\{ *([^}]+) *\} *',$nom, $m))
-	  return '';
-	else {
-		$filtres= array();
-		while (list(, $f) = each($a)) if ($f) $filtres[] = $f;
-		$p-&gt;fonctions = $filtres;
-		return $m[1];
-	}
-}
-
-// construire un tableau des valeurs interessant un formulaire
-
-function collecter_balise_dynamique($l, $p) {
-	$args = array();
-	foreach($l as $c) { $x = calculer_balise($c, $p); $args[] = $x-&gt;code;}
-	return $args;
-}
-
-// Genere l'application d'une liste de filtres
-function applique_filtres($p) {
-
-	$statut = $p-&gt;statut;
-	$fonctions = $p-&gt;fonctions;
-	$p-&gt;fonctions = ''; # pour r&#233;utiliser la structure si r&#233;cursion
-
-	// pretraitements standards
-	switch ($statut) {
-		case 'num':
-			$code = &quot;intval($code)&quot;;
-			break;
-		case 'php':
-			break;
-		case 'html':
-		default:
-			$code = &quot;trim($code)&quot;;
-			break;
-	}
-
-//  processeurs standards (cf inc-balises.php3)
-	$code = ($p-&gt;etoile ? $p-&gt;code : champs_traitements($p));
-	// Appliquer les filtres perso
-	if ($fonctions) {
-		foreach($fonctions as $fonc) {
-			if ($fonc) {
-
-				$arglist = '';
-				if (ereg('([^\{\}]+)\{(.+)\}$', $fonc, $regs)) {
-					$fonc = $regs[1];
-
-				        $arglist = filtres_arglist($regs[2],$p, ($fonc == '?' ? ':' : ','));
-				}
-				if (function_exists($fonc))
-				  $code = &quot;$fonc($code$arglist)&quot;;
-				else if (strpos(&quot; &lt; &gt; &lt;= &gt;= == &lt;&gt; ? &quot;, &quot; $fonc &quot;))
-				  $code = &quot;($code $fonc &quot;
-				    . substr($arglist,1)
-				    . ')';
-				else 
-				  $code = &quot;erreur_squelette('&quot;.
-					  texte_script(
-						_T('zbug_erreur_filtre', array('filtre' =&gt; $fonc))
-					).&quot;','&quot; . $p-&gt;id_boucle . &quot;')&quot;;
-			}
-		}
-	}
-
-	// post-traitement securite
-	if ($statut == 'html')
-		$code = &quot;interdire_scripts($code)&quot;;
-	return $code;
-}
-
-// analyse des parametres d'un champ etendu
-// [...(#CHAMP{parametres})...] ou [...(#CHAMP|filtre{parametres})...]
-// retourne une suite de N references aux N valeurs indiqu&#233;es avec N virgules
-
-function filtres_arglist($args, $p, $sep) {
-	$arglist ='';
-	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
-		$arg = trim($regs[1]);
-		if ($arg) {
-			if ($arg[0] =='$')
-				$arg = '$Pile[0][\'' . substr($arg,1) . &quot;']&quot;;
-			elseif ($arg[0] =='&lt;')
-			  $arg = calculer_texte($arg, $p-&gt;id_boucle, $p-&gt;boucles, $p-&gt;id_mere);
-			elseif (ereg(&quot;^&quot; . NOM_DE_CHAMP .&quot;(.*)$&quot;, $arg, $r2)) {
-				$p-&gt;nom_boucle = $r2[2];
-				$p-&gt;nom_champ = $r2[3];
-				# faudrait verifier !trim(r2[5])
-				$arg = calculer_champ($p);
-			} 
-
-			$arglist .= $sep . $arg;
-		}
-		$args=$regs[2];
-	}
-	return $arglist;
-}
-
-//
-// Reserve les champs necessaires a la comparaison avec le contexte donne par
-// la boucle parente ; attention en recursif il faut les reserver chez soi-meme
-// ET chez sa maman
-// 
-function calculer_argument_precedent($idb, $nom_champ, &amp;$boucles) {
-
-	// recursif ?
-	if ($boucles[$idb]-&gt;externe)
-		index_pile ($idb, $nom_champ, $boucles); // reserver chez soi-meme
-	// reserver chez le parent et renvoyer l'habituel $Pile[$SP]['nom_champ']
-#	spip_log(&quot;boucles[$idb]-&gt;id_parent &quot; . $boucles[$idb]-&gt;id_parent);
-	return index_pile ($boucles[$idb]-&gt;id_parent, $nom_champ, $boucles);
-}
-
-function rindex_pile($p, $champ, $motif) 
-{
-	$n = 0;
-	$b = $p-&gt;id_boucle;
-	$p-&gt;code = '';
-	while ($b != '') {
-	if ($s = $p-&gt;boucles[$b]-&gt;param) {
-	  foreach($s as $v) {
-		if (strpos($v,$motif) !== false) {
-		  $p-&gt;code = '$Pile[$SP' . (($n==0) ? &quot;&quot; : &quot;-$n&quot;) .
-			&quot;]['$champ']&quot;;
-		  $b = '';
-		  break;
-		}
-	  }
-	}
-	$n++;
-	$b = $p-&gt;boucles[$b]-&gt;id_parent;
-	}
-	if (!$p-&gt;code) {
-		erreur_squelette(_T('zbug_champ_hors_motif',
-			array('champ' =&gt; '#' . strtoupper($champ),
-				'motif' =&gt; $motif)
-		), $p-&gt;id_boucle);
-	}
-	$p-&gt;statut = 'php';
-	return $p;
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+
+// fonctions de recherche et de reservation
+// dans l'arborescence des boucles
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_COMPILO_INDEX&quot;)) return;
+define(&quot;_INC_COMPILO_INDEX&quot;, &quot;1&quot;);
+
+// index_pile retourne la position dans la pile du champ SQL $nom_champ 
+// en prenant la boucle la plus proche du sommet de pile (indique par $idb).
+// Si on ne trouve rien, on considere que ca doit provenir du contexte 
+// (par l'URL ou l'include) qui a ete recopie dans Pile[0]
+// (un essai d'affinage a debouche sur un bug vicieux)
+// Si ca reference un champ SQL, on le memorise dans la structure $boucles
+// afin de construire un requete SQL minimale (plutot qu'un brutal 'SELECT *')
+
+function index_pile($idb, $nom_champ, &amp;$boucles, $explicite='') {
+  global $exceptions_des_tables, $table_des_tables, $tables_des_serveurs_sql;
+
+	$i = 0;
+	if (strlen($explicite)) {
+	// Recherche d'un champ dans un etage superieur
+	  while (($idb != $explicite) &amp;&amp; ($idb !='')) {
+#		spip_log(&quot;Cherchexpl: $nom_champ '$explicite' '$idb' '$i'&quot;);
+			$i++;
+			$idb = $boucles[$idb]-&gt;id_parent;
+		}
+	}
+
+#	spip_log(&quot;Cherche: $nom_champ a partir de '$idb'&quot;);
+	$c = strtolower($nom_champ);
+	// attention: entre la boucle nommee 0, &quot;&quot; et le tableau vide,
+	// il y a incoherences qu'il vaut mieux eviter
+	while ($boucles[$idb]) {
+		$r = $boucles[$idb]-&gt;type_requete;
+		$s = $boucles[$idb]-&gt;sql_serveur;
+		if (!$s) 
+		  { $s = 'localhost';
+    // indirection (pour les rares cas ou le nom de la table!=type)
+		    $t = $table_des_tables[$r];
+		  }
+		// pour les tables non Spip
+		if (!$t) {$nom_table = $t = $r; }
+		else $nom_table = 'spip_' . $t;
+
+#		spip_log(&quot;Go: idb='$idb' r='$r' c='$c' nom='$nom_champ' s=$s t=$t&quot;);
+		$desc = $tables_des_serveurs_sql[$s][$nom_table];
+		if (!$desc) {
+			erreur_squelette(_T('zbug_table_inconnue', array('table' =&gt; $r)),
+				&quot;'$idb'&quot;);
+			# continuer pour chercher l'erreur suivante
+			return  &quot;'#&quot; . $r . ':' . $nom_champ . &quot;'&quot;;
+		}
+		$excep = $exceptions_des_tables[$r][$c];
+		if ($excep) {
+			// entite SPIP alias d'un champ SQL
+			if (!is_array($excep)) {
+				$e = $excep;
+				$c = $excep;
+			} 
+			// entite SPIP alias d'un champ dans une autre table SQL
+			else {
+				$t = $excep[0];
+				$e = $excep[1].' AS '.$c;
+			}
+		}
+		else {
+			// $e est le type SQL de l'entree
+			// entite SPIP homonyme au champ SQL
+			if ($desc['field'][$c])
+				$e = $c;
+			else
+				unset($e);
+		}
+
+#		spip_log(&quot;Dans $idb ('$t' '$e'): $desc&quot;);
+
+		// On l'a trouve
+		if ($e) {
+			$boucles[$idb]-&gt;select[] = $t . &quot;.&quot; . $e;
+			return '$Pile[$SP' . ($i ? &quot;-$i&quot; : &quot;&quot;) . '][\'' . $c . '\']';
+		}
+#		spip_log(&quot;On remonte vers $i&quot;);
+		// Sinon on remonte d'un cran
+		$idb = $boucles[$idb]-&gt;id_parent;
+		$i++;
+	}
+
+#	spip_log(&quot;Pas vu $nom_champ&quot;);
+	// esperons qu'il y sera
+	return('$Pile[0][\''.$nom_champ.'\']');
+}
+
+# calculer_champ genere le code PHP correspondant a une balise Spip
+# Retourne une EXPRESSION php 
+function calculer_champ($p) {
+	$p = calculer_balise($p-&gt;nom_champ, $p);
+
+	// definir le type et les traitements
+	// si ca ramene le choix par defaut, ce n'est pas un champ 
+
+	if (($p-&gt;code) &amp;&amp; ($p-&gt;code != '$Pile[0][\''.$nom.'\']')) {
+		// Par defaut basculer en numerique pour les #ID_xxx
+		if (substr($nom,0,3) == 'ID_') $p-&gt;statut = 'num';
+	}
+
+	else {
+	// on renvoie la forme initiale '#TOTO'
+	$p-&gt;code = &quot;'#&quot; . $nom . &quot;'&quot;;
+	$p-&gt;statut = 'php';	// pas de traitement
+	
+	}
+
+	// Retourner l'expression php correspondant au champ + ses filtres
+	return applique_filtres($p);
+}
+
+// cette fonction sert d'API pour demander le champ '$champ' dans la pile
+function champ_sql($champ, $p) {
+	return index_pile($p-&gt;id_boucle, $champ, $p-&gt;boucles, $p-&gt;nom_boucle);
+}
+
+// cette fonction sert d'API pour demander une balise quelconque sans filtre
+function calculer_balise($nom, $p) {
+
+	// regarder s'il existe une fonction personnalisee balise_NOM()
+	$f = 'balise_' . $nom;
+	if (function_exists($f))
+		return $f($p);
+
+	// regarder s'il existe une fonction standard balise_NOM_dist()
+	$f = 'balise_' . $nom . '_dist';
+	if (function_exists($f))
+		return $f($p);
+
+	// regarder s'il existe un fichier d'inclusion au nom de la balise
+	// contenant une fonction balise_NOM_collecte
+	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
+	if ($file = find_in_path($file)) {
+		include_local($file);
+		# une globale ?? defined ou function_exists(..._dyn) serait mieux ?
+		$f = $GLOBALS['balise_' . $nom . '_collecte'];
+		if (is_array($f))
+			return calculer_balise_dynamique($p, $nom, $f);
+	}
+
+	// S'agit-il d'un logo ? Une fonction speciale les traite tous
+	if (ereg('^LOGO_', $nom))
+		return calculer_balise_logo($p);
+
+	// ca pourrait etre un champ SQL homonyme,
+	$p-&gt;code = index_pile($p-&gt;id_boucle, $nom, $p-&gt;boucles, $p-&gt;nom_boucle);
+
+	// Compatibilite ascendante avec les couleurs html (#FEFEFE) :
+	// SI le champ SQL n'est pas trouve
+	// ET si la balise a une forme de couleur
+	// ET s'il n'y a ni filtre ni etoile
+	// ALORS retourner la couleur.
+	// Ca permet si l'on veut vraiment de recuperer [(#ACCEDE*)]
+	if (ereg(&quot;^[\$]Pile[[]0[]][[]'([A-F]{1,6})'[]]$&quot;, $p-&gt;code, $match)
+	AND !$p-&gt;etoile
+	AND !$p-&gt;fonctions) {
+		$p-&gt;code = &quot;'#&quot;. $match[1].&quot;'&quot;;
+		$p-&gt;statut = 'php';
+	}
+
+	return $p;
+}
+
+//
+// Traduction des balises dynamiques, notamment les &quot;formulaire_*&quot;
+// Inclusion du fichier associe a son nom.
+// Ca donne les arguments a chercher dans la pile,on compile leur localisation
+// Ensuite on delegue a une fonction generale definie dans inc-calcul-outils
+// qui recevra a l'execution la valeurs des arguments, 
+// ainsi que les filtres (qui ne sont donc pas traites a la compil)
+
+function calculer_balise_dynamique($p, $nom, $l) {
+	balise_distante_interdite($p);
+	$param = param_balise($p);
+	$p-&gt;code = &quot;executer_balise_dynamique('&quot; . $nom . &quot;',\n\tarray(&quot;
+	  . join(',',collecter_balise_dynamique($l, $p))
+	  . filtres_arglist($param, $p, ',')
+	  . &quot;),\n\tarray(&quot;
+	  . (!$p-&gt;fonctions ? '' : (&quot;'&quot; . join(&quot;','&quot;, $p-&gt;fonctions) . &quot;'&quot;))
+	  . &quot;), \$GLOBALS['spip_lang'])&quot;;
+	$p-&gt;statut = 'php';
+	$p-&gt;fonctions = '';
+
+	// Cas particulier de #FORMULAIRE_FORUM : inserer l'invalideur
+	if ($nom == 'FORMULAIRE_FORUM')
+		$p-&gt;code = code_invalideur_forums($p, $p-&gt;code);
+
+	return $p;
+}
+
+function param_balise(&amp;$p) {
+	$a = $p-&gt;fonctions;
+	if ($a) list(,$nom) = each($a) ; else $nom = '';
+	if (!ereg(' *\{ *([^}]+) *\} *',$nom, $m))
+	  return '';
+	else {
+		$filtres= array();
+		while (list(, $f) = each($a)) if ($f) $filtres[] = $f;
+		$p-&gt;fonctions = $filtres;
+		return $m[1];
+	}
+}
+
+// construire un tableau des valeurs interessant un formulaire
+
+function collecter_balise_dynamique($l, $p) {
+	$args = array();
+	foreach($l as $c) { $x = calculer_balise($c, $p); $args[] = $x-&gt;code;}
+	return $args;
+}
+
+// Genere l'application d'une liste de filtres
+function applique_filtres($p) {
+
+	$statut = $p-&gt;statut;
+	$fonctions = $p-&gt;fonctions;
+	$p-&gt;fonctions = ''; # pour r&#233;utiliser la structure si r&#233;cursion
+
+	// pretraitements standards
+	switch ($statut) {
+		case 'num':
+			$code = &quot;intval($code)&quot;;
+			break;
+		case 'php':
+			break;
+		case 'html':
+		default:
+			$code = &quot;trim($code)&quot;;
+			break;
+	}
+
+//  processeurs standards (cf inc-balises.php3)
+	$code = ($p-&gt;etoile ? $p-&gt;code : champs_traitements($p));
+	// Appliquer les filtres perso
+	if ($fonctions) {
+		foreach($fonctions as $fonc) {
+			if ($fonc) {
+
+				$arglist = '';
+				if (ereg('([^\{\}]+)\{(.+)\}$', $fonc, $regs)) {
+					$fonc = $regs[1];
+
+				        $arglist = filtres_arglist($regs[2],$p, ($fonc == '?' ? ':' : ','));
+				}
+				if (function_exists($fonc))
+				  $code = &quot;$fonc($code$arglist)&quot;;
+				else if (strpos(&quot; &lt; &gt; &lt;= &gt;= == &lt;&gt; ? &quot;, &quot; $fonc &quot;))
+				  $code = &quot;($code $fonc &quot;
+				    . substr($arglist,1)
+				    . ')';
+				else 
+				  $code = &quot;erreur_squelette('&quot;.
+					  texte_script(
+						_T('zbug_erreur_filtre', array('filtre' =&gt; $fonc))
+					).&quot;','&quot; . $p-&gt;id_boucle . &quot;')&quot;;
+			}
+		}
+	}
+
+	// post-traitement securite
+	if ($statut == 'html')
+		$code = &quot;interdire_scripts($code)&quot;;
+	return $code;
+}
+
+// analyse des parametres d'un champ etendu
+// [...(#CHAMP{parametres})...] ou [...(#CHAMP|filtre{parametres})...]
+// retourne une suite de N references aux N valeurs indiqu&#233;es avec N virgules
+
+function filtres_arglist($args, $p, $sep) {
+	$arglist ='';
+	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
+		$arg = trim($regs[1]);
+		if ($arg) {
+			if ($arg[0] =='$')
+				$arg = '$Pile[0][\'' . substr($arg,1) . &quot;']&quot;;
+			elseif ($arg[0] =='&lt;')
+			  $arg = calculer_texte($arg, $p-&gt;id_boucle, $p-&gt;boucles, $p-&gt;id_mere);
+			elseif (ereg(&quot;^&quot; . NOM_DE_CHAMP .&quot;(.*)$&quot;, $arg, $r2)) {
+				$p-&gt;nom_boucle = $r2[2];
+				$p-&gt;nom_champ = $r2[3];
+				# faudrait verifier !trim(r2[5])
+				$arg = calculer_champ($p);
+			} 
+
+			$arglist .= $sep . $arg;
+		}
+		$args=$regs[2];
+	}
+	return $arglist;
+}
+
+//
+// Reserve les champs necessaires a la comparaison avec le contexte donne par
+// la boucle parente ; attention en recursif il faut les reserver chez soi-meme
+// ET chez sa maman
+// 
+function calculer_argument_precedent($idb, $nom_champ, &amp;$boucles) {
+
+	// si recursif, forcer l'extraction du champ SQL mais ignorer le code
+	if ($boucles[$idb]-&gt;externe)
+		index_pile ($idb, $nom_champ, $boucles); 
+	// retourner $Pile[$SP] et pas $Pile[0] (bug recursion en 1ere boucle)
+	$prec = $boucles[$idb]-&gt;id_parent;
+	return (!$prec ? ('$Pile[$SP][\''.$nom_champ.'\']') : 
+		index_pile($prec, $nom_champ, $boucles));
+}
+
+function rindex_pile($p, $champ, $motif) 
+{
+	$n = 0;
+	$b = $p-&gt;id_boucle;
+	$p-&gt;code = '';
+	while ($b != '') {
+	if ($s = $p-&gt;boucles[$b]-&gt;param) {
+	  foreach($s as $v) {
+		if (strpos($v,$motif) !== false) {
+		  $p-&gt;code = '$Pile[$SP' . (($n==0) ? &quot;&quot; : &quot;-$n&quot;) .
+			&quot;]['$champ']&quot;;
+		  $b = '';
+		  break;
+		}
+	  }
+	}
+	$n++;
+	$b = $p-&gt;boucles[$b]-&gt;id_parent;
+	}
+	if (!$p-&gt;code) {
+		erreur_squelette(_T('zbug_champ_hors_motif',
+			array('champ' =&gt; '#' . strtoupper($champ),
+				'motif' =&gt; $motif)
+		), $p-&gt;id_boucle);
+	}
+	$p-&gt;statut = 'php';
+	return $p;
+}
+
+?&gt;

Index: mot.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/mot.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- mot.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ mot.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,9 +1,9 @@
-&lt;?php
-$fond = &quot;mot&quot;;
-$delais = 24 * 3600;
-
-
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+$fond = &quot;mot&quot;;
+$delais = 24 * 3600;
+
+
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: mes_fonctions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/mes_fonctions.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- mes_fonctions.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ mes_fonctions.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,234 +1,83 @@
-&lt;?php
-
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-//          MODULE CARTO
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-// PARAMETRAGE
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-
-//////////////////////////////////////////////////
-// CARTO_CARTES
-//////////////////////////////////////////////////
-$spip_carto_cartes = array(
-	&quot;id_carto_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
-	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
-	&quot;texte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;url_carte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;callage&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;id_srs&quot; =&gt; &quot;bigint(21) NOT NULL&quot;);
-
-$spip_carto_cartes_key = array(
-	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carto_carte&quot;,
-	&quot;KEY id_carto_carte&quot; =&gt; &quot;id_carto_carte&quot;);
-
-
-//////////////////////////////////////////////////
-// CARTO_OBJETS
-//////////////////////////////////////////////////
-
-$spip_carto_objets = array(
-	&quot;id_carto_objet&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
-	&quot;id_carto_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
-	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
-	&quot;texte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;url_objet&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;url_logo&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;geometrie&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;);
-	
-$spip_carto_objets_key = array(
-	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carto_objet&quot;,
-	&quot;KEY id_carto_carte&quot; =&gt; &quot;id_carto_carte&quot;,
-	&quot;KEY titre&quot; =&gt; &quot;titre&quot;);
-
-//////////////////////////////////////////////////
-// CARTO_CARTES_ARTICLES
-//////////////////////////////////////////////////
-
-$spip_carto_cartes_articles = array(
-	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
-	&quot;id_article&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
-
-$spip_carto_cartes_articles_key = array(
-	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
-	&quot;KEY id_article&quot; =&gt; &quot;id_article&quot;);
-
-
-//////////////////////////////////////////////////
-// CARTO_CARTES_ARTICLES
-//////////////////////////////////////////////////
-
-$spip_carto_cartes_articles = array(
-	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
-	&quot;id_article&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
-
-$spip_carto_cartes_articles_key = array(
-	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
-	&quot;KEY id_article&quot; =&gt; &quot;id_article&quot;);
-
-
-$tables_auxiliaires['spip_carto_cartes_articles'] = array(
-	'field' =&gt; &amp;$spip_carto_cartes_articles,
-	'key' =&gt; &amp;$spip_carto_cartes_articles_key);
-
-//////////////////////////////////////////////////
-// MOTS_CARTO_OBJETS
-//////////////////////////////////////////////////
-
-$spip_mots_carto_objets= array(
-	&quot;id_carto_objet&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
-	&quot;id_mot&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
-
-$spip_mots_carto_objets_key = array(
-	&quot;KEY id_carto_objet&quot; 	=&gt; &quot;id_carto_objet&quot;,
-	&quot;KEY id_mot&quot; =&gt; &quot;id_mot&quot;);
-
-//////////////////////////////////////////////////
-// DOCUMENTS_CARTO_OBJETS
-//////////////////////////////////////////////////
-
-$spip_documents_carto_cartes= array(
-	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
-	&quot;id_document&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
-
-$spip_documents_carto_cartes_key = array(
-	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
-	&quot;KEY id_document&quot; =&gt; &quot;id_document&quot;);
-
-
-//////////////////////////////////////////////////
-// DECLARATION
-//////////////////////////////////////////////////
-
-global $tables_principales,$table_primary,$tables_auxiliaires,$tables_relations;
-
-
-$tables_principales['spip_carto_cartes'] =
-	array('field' =&gt; &amp;$spip_carto_cartes, 'key' =&gt; &amp;$spip_carto_cartes_key);
-
-$tables_principales['spip_carto_objets'] =
-	array('field' =&gt; &amp;$spip_carto_objets, 'key' =&gt; &amp;$spip_carto_objets_key);
-
-//Relation avec les articles
-$tables_auxiliaires['spip_carto_cartes_articles'] = array(
-	'field' =&gt; &amp;$spip_carto_cartes_articles,
-	'key' =&gt; &amp;$spip_carto_cartes_articles_key);
-
-
-//La, ca se discute ...
-//Ca devrait etre une table secondaire
-//mais comme on n'utilise que l'id_mot dans la boucle
-//on gagne une jointure dans la requete
-
-//$tables_principales['spip_mots_carto_objets'] = array(
-//	'field' =&gt; &amp;$spip_mots_carto_objets,
-//	'key' =&gt; &amp;$spip_mots_carto_objets_key);
-
-$tables_auxiliaires['spip_mots_carto_objets'] = array(
-	'field' =&gt; &amp;$spip_mots_carto_objets,
-	'key' =&gt; &amp;$spip_mots_carto_objets_key);
-	
-//Relation pour boucle CARTO_OBJETS par crit&#232;re mot
-//$tables_relations['mots']['id_carto_objet']= 'mots_carto_objets';
-//$tables_relations['carto_objets']['id_mot']= 'mots_carto_objets';
-
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-//FILTRES
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-/* +---------------------------------------------+
- *    Nom    du    Filtre : WKT to STYLE
- * +---------------------------------------------+    
- * Date : mercredi 09 avril 2003
- * Auteur :    
- * site : 
- * +---------------------------------------------+ 
- * Fonctions de ce filtre : 
- * Appelez le dans vos squellette tout simplement par :
- * [(#GEOMETRIE|wkt2style)] 
- * +--------------------------------------------- +
- *  
- * Pour toute suggestion, remarque, proposition d'ajout
- * reportez-vous au forum de l'article :
- * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
- *
- */
-function wkt2style($geometrie){
-	$debut=strpos($geometrie,&quot;(&quot;);
-	$milieu=strpos($geometrie,&quot;,&quot;);
-	$fin=strpos($geometrie,&quot;;&quot;);
-	$returned_str=&quot;top: &quot;.substr($geometrie,$milieu+1,$fin-$milieu-1).&quot;px;left: &quot;.substr($geometrie,$debut+1,$milieu-$debut-1).&quot;px;&quot;;
-	return $returned_str;
-}
-
-/*
- *   +---------------------------------------------+
- *    Nom du Filtre : WKT to COORDS
- *   +---------------------------------------------+
- *    Date : mercredi 09 avril 2003
- *    Auteur : 
- *    site :  
- *   +---------------------------------------------+
- *    Fonctions de ce filtre :
- *     Appelez le dans vos squellette tout simplement
- *     par : [(#GEOMETRIE|wkt2coords)]
- *   +---------------------------------------------+
- *  
- * Pour toute suggestion, remarque, proposition d'ajout
- * reportez-vous au forum de l'article :
- * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
- *
- */
-function wkt2coords($geometrie){
-	
-	return str_replace(';',',',substr($geometrie,8,-1));
-}
-
-/*
- *   +---------------------------------------------+
- *    Nom du Filtre : WKT to SHAPE 
- *   +---------------------------------------------+
- *    Date : mercredi 09 avril 2003
- *    Auteur : 
- *    site :  
- *   +---------------------------------------------+
- *    Fonctions de ce filtre :
- *     Appelez le dans vos squellette tout simplement
- *     par : [(#GEOMETRIE|wkt2shape)]
- *   +---------------------------------------------+
- *  
- * Pour toute suggestion, remarque, proposition d'ajout
- * reportez-vous au forum de l'article :
- * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
- *
- */
-function wkt2shape($geometrie){
-	
-	return substr($geometrie,0,4);
-}
-
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-//			FIN MODULE CARTO
-//////////////////////////////////////////////////
-//////////////////////////////////////////////////
-
-
-/*/ Filtre SECU - 
-function supprimer_la_securite($texte){
-$texte=ereg_replace (&quot;&lt;php&gt;&quot;,&quot;&lt;?php&quot;,$texte);
-$texte=ereg_replace (&quot;&lt;/php&gt;&quot;,&quot;?&gt;&quot;,$texte);
-return $texte;
-}
-*/
-
-
-?&gt;
+&lt;?php
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//FILTRES
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+/* +---------------------------------------------+
+ *    Nom    du    Filtre : WKT to STYLE
+ * +---------------------------------------------+    
+ * Date : mercredi 09 avril 2003
+ * Auteur :    
+ * site : 
+ * +---------------------------------------------+ 
+ * Fonctions de ce filtre : 
+ * Appelez le dans vos squellette tout simplement par :
+ * [(#GEOMETRIE|wkt2style)] 
+ * +--------------------------------------------- +
+ *  
+ * Pour toute suggestion, remarque, proposition d'ajout
+ * reportez-vous au forum de l'article :
+ * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
+ *
+ */
+function wkt2style($geometrie){
+	$debut=strpos($geometrie,&quot;(&quot;);
+	$milieu=strpos($geometrie,&quot;,&quot;);
+	$fin=strpos($geometrie,&quot;;&quot;);
+	$returned_str=&quot;top: &quot;.substr($geometrie,$milieu+1,$fin-$milieu-1).&quot;px;left: &quot;.substr($geometrie,$debut+1,$milieu-$debut-1).&quot;px;&quot;;
+	return $returned_str;
+}
+
+/*
+ *   +---------------------------------------------+
+ *    Nom du Filtre : WKT to COORDS
+ *   +---------------------------------------------+
+ *    Date : mercredi 09 avril 2003
+ *    Auteur : 
+ *    site :  
+ *   +---------------------------------------------+
+ *    Fonctions de ce filtre :
+ *     Appelez le dans vos squellette tout simplement
+ *     par : [(#GEOMETRIE|wkt2coords)]
+ *   +---------------------------------------------+
+ *  
+ * Pour toute suggestion, remarque, proposition d'ajout
+ * reportez-vous au forum de l'article :
+ * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
+ *
+ */
+function wkt2coords($geometrie){
+	
+	return str_replace(';',',',substr($geometrie,8,-1));
+}
+
+/*
+ *   +---------------------------------------------+
+ *    Nom du Filtre : WKT to SHAPE 
+ *   +---------------------------------------------+
+ *    Date : mercredi 09 avril 2003
+ *    Auteur : 
+ *    site :  
+ *   +---------------------------------------------+
+ *    Fonctions de ce filtre :
+ *     Appelez le dans vos squellette tout simplement
+ *     par : [(#GEOMETRIE|wkt2shape)]
+ *   +---------------------------------------------+
+ *  
+ * Pour toute suggestion, remarque, proposition d'ajout
+ * reportez-vous au forum de l'article :
+ * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
+ *
+ */
+function wkt2shape($geometrie){
+	
+	return substr($geometrie,0,4);
+}
+
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//			FIN MODULE CARTO
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+?&gt;
\ No newline at end of file

Index: recherche.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/recherche.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- recherche.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ recherche.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,8 +1,8 @@
-&lt;?php
-$fond = &quot;recherche&quot;;
-$delais = 0;
-
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+$fond = &quot;recherche&quot;;
+$delais = 0;
+
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: site.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/site.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- site.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ site.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,9 +1,9 @@
-&lt;?php
-$fond = &quot;site&quot;;
-$delais = 24 * 3600;
-
-
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+$fond = &quot;site&quot;;
+$delais = 24 * 3600;
+
+
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: spip_acces_doc.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_acces_doc.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_acces_doc.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_acces_doc.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,75 +1,86 @@
-&lt;?
-# script d'acces aux documents joints
-# doit etre appele avec un de ces 2 parametres de GET:
-# - id_document 
-# - file 
-# il verifie soit que le demandeur est authentifie
-# soit que le fichier est joint &#224; au moins 1 article, breve ou rubrique
-
-$id_document = ($_GET['id_document']);
-$file = urldecode($_GET['file']);
-if (strpos($file,'../') !== false)
-  $refus = 1;
-else
-  {
-    $refus = false;
-    include (&quot;ecrire/inc_version.php3&quot;);
-    include_local(_FILE_CONNECT);
-    include_ecrire(&quot;inc_meta.php3&quot;);
-    include_ecrire(&quot;inc_session.php3&quot;);
-
-    global $auteur_session;
-    if ($cookie_session = $_COOKIE['spip_session']) 
-      {
-	if (verifier_session($cookie_session)) 
-	  {
-	    if ($auteur_session['statut'] == '0minirezo' 
-		OR $auteur_session['statut'] == '1comite') 
-	      $auth_login = $auteur_session['login'];
-	  }
-      }
-
-    if (!$id_document) {
-      $id_document = @spip_fetch_array(spip_query(&quot;select id_document from spip_documents as documents where documents.fichier='&quot;.$file.&quot;'&quot;));
-      if (!$id_document) $refus = 2;
-      $id_document = $id_document['id_document'];
-    } else {
-      $file = @spip_fetch_array(spip_query(&quot;select fichier from spip_documents as documents where id_document='&quot;. $id_document .&quot;'&quot;));
-      if (!$file) $refus = 3;
-      $file = $file['fichier'];
-    }
-  }
-
-if (!$auth_login &amp;&amp; !$refus) { 
-    if (!spip_num_rows(spip_query(&quot;select articles.id_article
-from spip_documents_articles as rel_articles, spip_articles as articles 
-where rel_articles.id_article = articles.id_article AND
-articles.statut = 'publie' AND rel_articles.id_document ='&quot;.
-			       $id_document .
-				&quot;' LIMIT 1&quot;))) {
-      if (!spip_num_rows(spip_query(&quot;select rubriques.id_rubrique
-from spip_documents_rubriques as rel_rubriques, spip_rubriques as rubriques 
-where rel_rubriques.id_rubrique = rubriques.id_rubrique AND
-rubriques.statut = 'publie' AND rel_rubriques.id_document ='&quot;.
-			       $id_document .
-				  &quot;' LIMIT 1&quot;))) {
-	if (!spip_num_rows(spip_query(&quot;select breves.id_breve
-from spip_documents_breves as rel_breves, spip_breves as breves 
-where rel_breves.id_breve = breves.id_breve AND
-breves.statut = 'publie' AND rel_breves.id_document ='&quot;.
-			       $id_document .
-				  &quot;' LIMIT 1&quot;)))
-	  $refus = 4; } } }
-
-if (!$refus)
-  {
-     header(&quot;Content-Type: &quot;. mime_content_type($file));
-     header(&quot;Content-Length: &quot;. filesize($file));
-     header(&quot;Content-Disposition: attachment; filename=\&quot;&quot;. basename($file) .&quot;\&quot;;&quot;);
-     header(&quot;Content-Transfer-Encoding: binary&quot;);
-     readfile($file);
-   }
- else
-   spip_log(&quot;Acces refuse ($refus) au document &quot; . ($_GET['id_document']) . ': ' .($_GET['file']));
-
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+# script d'acces aux documents joints
+# doit etre appele avec un de ces 2 parametres de GET:
+# - id_document 
+# - file 
+# il verifie soit que le demandeur est authentifie
+# soit que le fichier est joint &#224; au moins 1 article, breve ou rubrique
+
+$id_document = ($_GET['id_document']);
+$file = urldecode($_GET['file']);
+if (strpos($file,'../') !== false)
+  $refus = 1;
+else
+  {
+    $refus = false;
+    include (&quot;ecrire/inc_version.php3&quot;);
+    include_local(_FILE_CONNECT);
+    include_ecrire(&quot;inc_meta.php3&quot;);
+    include_ecrire(&quot;inc_session.php3&quot;);
+
+    global $auteur_session;
+    if ($cookie_session = $_COOKIE['spip_session']) 
+      {
+	if (verifier_session($cookie_session)) 
+	  {
+	    if ($auteur_session['statut'] == '0minirezo' 
+		OR $auteur_session['statut'] == '1comite') 
+	      $auth_login = $auteur_session['login'];
+	  }
+      }
+
+    if (!$id_document) {
+      $id_document = @spip_fetch_array(spip_query(&quot;select id_document from spip_documents as documents where documents.fichier='&quot;.$file.&quot;'&quot;));
+      if (!$id_document) $refus = 2;
+      $id_document = $id_document['id_document'];
+    } else {
+      $file = @spip_fetch_array(spip_query(&quot;select fichier from spip_documents as documents where id_document='&quot;. $id_document .&quot;'&quot;));
+      if (!$file) $refus = 3;
+      $file = $file['fichier'];
+    }
+  }
+
+if (!$auth_login &amp;&amp; !$refus) { 
+    if (!spip_num_rows(spip_query(&quot;select articles.id_article
+from spip_documents_articles as rel_articles, spip_articles as articles 
+where rel_articles.id_article = articles.id_article AND
+articles.statut = 'publie' AND rel_articles.id_document ='&quot;.
+			       $id_document .
+				&quot;' LIMIT 1&quot;))) {
+      if (!spip_num_rows(spip_query(&quot;select rubriques.id_rubrique
+from spip_documents_rubriques as rel_rubriques, spip_rubriques as rubriques 
+where rel_rubriques.id_rubrique = rubriques.id_rubrique AND
+rubriques.statut = 'publie' AND rel_rubriques.id_document ='&quot;.
+			       $id_document .
+				  &quot;' LIMIT 1&quot;))) {
+	if (!spip_num_rows(spip_query(&quot;select breves.id_breve
+from spip_documents_breves as rel_breves, spip_breves as breves 
+where rel_breves.id_breve = breves.id_breve AND
+breves.statut = 'publie' AND rel_breves.id_document ='&quot;.
+			       $id_document .
+				  &quot;' LIMIT 1&quot;)))
+	  $refus = 4; } } }
+
+if (!$refus)
+  {
+     header(&quot;Content-Type: &quot;. mime_content_type($file));
+     header(&quot;Content-Length: &quot;. filesize($file));
+     header(&quot;Content-Disposition: attachment; filename=\&quot;&quot;. basename($file) .&quot;\&quot;;&quot;);
+     header(&quot;Content-Transfer-Encoding: binary&quot;);
+     readfile($file);
+   }
+ else
+   spip_log(&quot;Acces refuse ($refus) au document &quot; . ($_GET['id_document']) . ': ' .($_GET['file']));
+
 ?&gt;

Index: plan.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/plan.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- plan.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ plan.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,8 +1,8 @@
-&lt;?php
-
-$fond = &quot;plan&quot;;
-$delais = 2 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+$fond = &quot;plan&quot;;
+$delais = 2 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: spip_style.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_style.css,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_style.css	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_style.css	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,139 +1,139 @@
-a {
-	text-decoration: none;
-}
-
-a:hover {
-	color:#FF9900;
-	text-decoration: underline;
-}
-
-a.spip_url { }
-a.spip_in { }
-a.spip_out { }
-a.spip_glossaire { }
-
-.spip_code { }
-
-p.spip_note { }
-
-h3.spip {
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	font-weight: bold;
-	font-size: 120%;
-	text-align: center;
-	margin-top : 40px;
-	margin-bottom : 40px;
-	padding: 0em;
-}
-
-.spip_puce {
-	list-style-position: inside;
-}
-
-.spip_documents{
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	font-size : 70%;
-}
-
-
-table.spip {
-}
-
-table.spip tr.row_first {
-	background-color: #FCF4D0;
-}
-
-table.spip tr.row_odd {
-	background-color: #C0C0C0;
-}
-
-table.spip tr.row_even {
-	background-color: #F0F0F0;
-}
-
-table.spip td {
-	padding: 1px;
-	text-align: left;
-	vertical-align: middle;
-}
-
-hr.spip { }
-b.spip { }
-i.spip { }
-blockquote.spip {
-	margin-left : 40px;
-	margin-top : 10px;
-	margin-bottom : 10px;
-	margin-right: 0px;
-	border : solid 1px #aaaaaa;
-	background-color: #ffffff;
-	padding-left: 10px;
-	padding-right: 10px;
-}
-
-.forml { width: 100% ; background-color: #FFDDAA;}
-
-.spip_encadrer {
-	font-family: helvetica, arial, sans-serif;
-	width : 95%;
-	background-color: #FFFFFF;
-	padding: 5px;
-	border: 1px #666666 solid;
-}
-
-.spip_cadre {
-	width : 95%;
-	background-color: #FFFFFF;
-	padding: 5px;
-	margin-top: 10px;
-}
-
-div.spip_poesie {
-	margin-bottom: 5px;
-	margin-left: 10px;
-	padding-left: 10px;
-	border-left: 1px solid #999999;
-}
-div.spip_poesie div {
-	text-indent: -60px;
-	margin-left: 60px;
-}
-
-.spip_bouton { background-color: #FFCC00;}
-
-form.formrecherche { 
-	margin-top: 5px;
-	margin-bottom: 5px;
-}
-input.formrecherche {
-	width: 95%;
-	background-color: #FFDDAA;
-}
-
-.reponse_formulaire {
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	font-weight: bold;
-	font-size: 110%;
-	color: red;
-}
-
-.spip_surligne { background-color: #FFFF66; }
-
-
-/*
- * Barre de raccourcis
- */
-
-a.spip_barre img {
-	border-left: 1px solid #ffffff;
-	border-top: 1px solid #ffffff;
-	border-right: 1px solid #aa9966;
-	border-bottom: 1px solid #aa9966;
-	padding: 3px;
-	background-color: #FFDDAA;
-}
-a.spip_barre:hover img {
-	border: 1px solid #808080;
-	padding: 3px;
-	background-color: #f8f8f4;
-}
+a {
+	text-decoration: none;
+}
+
+a:hover {
+	color:#FF9900;
+	text-decoration: underline;
+}
+
+a.spip_url { }
+a.spip_in { }
+a.spip_out { }
+a.spip_glossaire { }
+
+.spip_code { }
+
+p.spip_note { }
+
+h3.spip {
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	font-weight: bold;
+	font-size: 120%;
+	text-align: center;
+	margin-top : 40px;
+	margin-bottom : 40px;
+	padding: 0em;
+}
+
+.spip_puce {
+	list-style-position: inside;
+}
+
+.spip_documents{
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	font-size : 70%;
+}
+
+
+table.spip {
+}
+
+table.spip tr.row_first {
+	background-color: #FCF4D0;
+}
+
+table.spip tr.row_odd {
+	background-color: #C0C0C0;
+}
+
+table.spip tr.row_even {
+	background-color: #F0F0F0;
+}
+
+table.spip td {
+	padding: 1px;
+	text-align: left;
+	vertical-align: middle;
+}
+
+hr.spip { }
+b.spip { }
+i.spip { }
+blockquote.spip {
+	margin-left : 40px;
+	margin-top : 10px;
+	margin-bottom : 10px;
+	margin-right: 0px;
+	border : solid 1px #aaaaaa;
+	background-color: #ffffff;
+	padding-left: 10px;
+	padding-right: 10px;
+}
+
+.forml { width: 100% ; background-color: #FFDDAA;}
+
+.spip_encadrer {
+	font-family: helvetica, arial, sans-serif;
+	width : 95%;
+	background-color: #FFFFFF;
+	padding: 5px;
+	border: 1px #666666 solid;
+}
+
+.spip_cadre {
+	width : 95%;
+	background-color: #FFFFFF;
+	padding: 5px;
+	margin-top: 10px;
+}
+
+div.spip_poesie {
+	margin-bottom: 5px;
+	margin-left: 10px;
+	padding-left: 10px;
+	border-left: 1px solid #999999;
+}
+div.spip_poesie div {
+	text-indent: -60px;
+	margin-left: 60px;
+}
+
+.spip_bouton { background-color: #FFCC00;}
+
+form.formrecherche { 
+	margin-top: 5px;
+	margin-bottom: 5px;
+}
+input.formrecherche {
+	width: 95%;
+	background-color: #FFDDAA;
+}
+
+.reponse_formulaire {
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	font-weight: bold;
+	font-size: 110%;
+	color: red;
+}
+
+.spip_surligne { background-color: #FFFF66; }
+
+
+/*
+ * Barre de raccourcis
+ */
+
+a.spip_barre img {
+	border-left: 1px solid #ffffff;
+	border-top: 1px solid #ffffff;
+	border-right: 1px solid #aa9966;
+	border-bottom: 1px solid #aa9966;
+	padding: 3px;
+	background-color: #FFDDAA;
+}
+a.spip_barre:hover img {
+	border: 1px solid #808080;
+	padding: 3px;
+	background-color: #f8f8f4;
+}

Index: spip_inscription.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_inscription.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_inscription.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_inscription.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,12 +1,23 @@
-&lt;?php
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire(&quot;inc_presentation.php3&quot;);
-include_local(find_in_path(&quot;inc-formulaire_inscription.php3&quot;));
-include_local(&quot;inc-public-global.php3&quot;); 
-include_local (&quot;inc-cache.php3&quot;);
-
-install_debut_html(_T('pass_vousinscrire'));
-inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus, $target));
-# echo http_script_window_close(); # fait dans le squelette a present
-install_fin_html();
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire(&quot;inc_presentation.php3&quot;);
+include_local(find_in_path(&quot;inc-formulaire_inscription.php3&quot;));
+include_local(&quot;inc-public-global.php3&quot;); 
+include_local (&quot;inc-cache.php3&quot;);
+
+install_debut_html(_T('pass_vousinscrire'));
+inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus, $target));
+# echo http_script_window_close(); # fait dans le squelette a present
+install_fin_html();
+?&gt;

Index: spip_barre.js
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_barre.js,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_barre.js	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_barre.js	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,186 +1,188 @@
-// Barre de raccourcis
-// derive du:
-// bbCode control by subBlue design : www.subBlue.com
-
-// Startup variables
-var theSelection = false;
-
-// Check for Browser &amp; Platform for PC &amp; IE specific bits
-// More details from: <A HREF="http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html">http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html</A>
-var clientPC = navigator.userAgent.toLowerCase(); // Get client info
-var clientVer = parseInt(navigator.appVersion); // Get browser version
-
-var is_ie = ((clientPC.indexOf(&quot;msie&quot;) != -1) &amp;&amp; (clientPC.indexOf(&quot;opera&quot;) == -1));
-var is_nav = ((clientPC.indexOf('mozilla')!=-1) &amp;&amp; (clientPC.indexOf('spoofer')==-1)
-                &amp;&amp; (clientPC.indexOf('compatible') == -1) &amp;&amp; (clientPC.indexOf('opera')==-1)
-                &amp;&amp; (clientPC.indexOf('webtv')==-1) &amp;&amp; (clientPC.indexOf('hotjava')==-1));
-var is_moz = 0;
-
-var is_win = ((clientPC.indexOf(&quot;win&quot;)!=-1) || (clientPC.indexOf(&quot;16bit&quot;) != -1));
-var is_mac = (clientPC.indexOf(&quot;mac&quot;)!=-1);
-
-
-function barre_raccourci(debut,fin,champ) {
-	var txtarea = champ;
-
-	txtarea.focus();
-	donotinsert = false;
-	theSelection = false;
-	bblast = 0;
-
-	if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win)
-	{
-		theSelection = document.selection.createRange().text; // Get text selection
-		if (theSelection) {
-
-			while (theSelection.substring(theSelection.length-1, theSelection.length) == ' ')
-			{
-				theSelection = theSelection.substring(0, theSelection.length-1);
-				fin = fin + &quot; &quot;;
-			}
-			if (theSelection.substring(0,1) == '{' &amp;&amp; debut.substring(0,1) == '{')
-			{
-				debut = debut + &quot; &quot;;
-			}
-			if (theSelection.substring(theSelection.length-1, theSelection.length) == '}' &amp;&amp; fin.substring(0,1) == '}')
-			{
-				fin = &quot; &quot; + fin;
-			}
-
-			// Add tags around selection
-			document.selection.createRange().text = debut + theSelection + fin;
-			txtarea.focus();
-			theSelection = '';
-			return;
-		}
-	}
-	else if (txtarea.selectionEnd &amp;&amp; (txtarea.selectionEnd - txtarea.selectionStart &gt; 0))
-	{
-		mozWrap(txtarea, debut, fin);
-		return;
-	}
-}
-
-function barre_demande(debut,milieu,fin,affich,champ) {
-	var inserer = prompt(affich);
-
-	if (inserer != null) {
-		if (inserer == &quot;&quot;) {inserer = &quot;xxx&quot;; }
-
-		barre_raccourci(debut, milieu+inserer+fin, champ);
-	}
-}
-
-function barre_inserer(text,champ) {
-	var txtarea = champ;
-	
-	if (txtarea.createTextRange &amp;&amp; txtarea.caretPos) {
-		var caretPos = txtarea.caretPos;
-		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
-		txtarea.focus();
-	} else {
-		//txtarea.value  += text;
-		//txtarea.focus();
-		mozWrap(txtarea, '', text);
-		return;
-	}
-}
-
-
-// D'apres Nicolas Hoizey 
-function barre_tableau(toolbarfield)
-{
-	var txtarea = toolbarfield;
-	txtarea.focus();
-	var cols = prompt(&quot;Nombre de colonnes du tableau :&quot;, &quot;&quot;);
-	var rows = prompt(&quot;Nombre de lignes du tableau :&quot;, &quot;&quot;);
-	if (cols != null &amp;&amp; rows != null) {
-		var tbl = '';
-		var ligne = '|';
-		var entete = '|';
-		for(i = 0; i &lt; cols; i++) {
-			ligne = ligne + ' valeur |';
-			entete = entete + ' {{entete}} |';
-		}
-		for (i = 0; i &lt; rows; i++) {
-			tbl = tbl + ligne + '\n';
-		}
-		if (confirm('Voulez vous ajouter une ligne d\'en-t&#234;te ?')) {
-			tbl = entete + '\n' + tbl;
-		}
-		if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win) {
-			var str = document.selection.createRange().text;
-			var sel = document.selection.createRange();
-			sel.text = str + '\n\n' + tbl + '\n\n';
-		} else {
-			mozWrap(txtarea, '', &quot;\n\n&quot; + tbl + &quot;\n\n&quot;);
-		}
-	}
-	return;
-}
-
-
-
-// Shows the help messages in the helpline window
-function helpline(help, champ) {
-	champ.value = help;
-}
-
-
-function setCaretToEnd (input) {
-  setSelectionRange(input, input.value.length, input.value.length);
-}
-
-
-function setSelectionRange(input, selectionStart, selectionEnd) {
-  if (input.setSelectionRange) {
-    input.focus();
-    input.setSelectionRange(selectionStart, selectionEnd);
-  }
-  else if (input.createTextRange) {
-    var range = input.createTextRange();
-    range.collapse(true);
-    range.moveEnd('character', selectionEnd);
-    range.moveStart('character', selectionStart);
-    range.select();
-  }
-}
-
-// From <A HREF="http://www.massless.org/mozedit/">http://www.massless.org/mozedit/</A>
-function mozWrap(txtarea, open, close)
-{
-	var selLength = txtarea.textLength;
-	var selStart = txtarea.selectionStart;
-	var selEnd = txtarea.selectionEnd;
-	if (selEnd == 1 || selEnd == 2)
-		selEnd = selLength;
-	
-	// Raccourcir la selection par double-clic si dernier caractere est espace	
-	if (selEnd - selStart &gt; 0 &amp;&amp; (txtarea.value).substring(selEnd-1,selEnd) == ' ') selEnd = selEnd-1;
-	
-	var s1 = (txtarea.value).substring(0,selStart);
-	var s2 = (txtarea.value).substring(selStart, selEnd)
-	var s3 = (txtarea.value).substring(selEnd, selLength);
-
-	// Eviter melange bold-italic-intertitre
-	if ((txtarea.value).substring(selEnd,selEnd+1) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = close + &quot; &quot;;
-	if ((txtarea.value).substring(selEnd-1,selEnd) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = &quot; &quot; + close;
-	if ((txtarea.value).substring(selStart-1,selStart) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = &quot; &quot; + open;
-	if ((txtarea.value).substring(selStart,selStart+1) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = open + &quot; &quot;;
-
-	txtarea.value = s1 + open + s2 + close + s3;
-	selDeb = selStart + open.length;
-	selFin = selEnd + close.length;
-	window.setSelectionRange(txtarea, selDeb, selFin);
-	txtarea.focus();
-	
-	return;
-}
-
-// Insert at Claret position. Code from
-// <A HREF="http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130">http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130</A>
-     function storeCaret (textEl) {
-       if (textEl.createTextRange) 
-         textEl.caretPos = document.selection.createRange().duplicate();
-     }
-
+// Barre de raccourcis
+// derive du:
+// bbCode control by subBlue design : www.subBlue.com
+
+// Startup variables
+var theSelection = false;
+
+// Check for Browser &amp; Platform for PC &amp; IE specific bits
+// More details from: <A HREF="http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html">http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html</A>
+var clientPC = navigator.userAgent.toLowerCase(); // Get client info
+var clientVer = parseInt(navigator.appVersion); // Get browser version
+
+var is_ie = ((clientPC.indexOf(&quot;msie&quot;) != -1) &amp;&amp; (clientPC.indexOf(&quot;opera&quot;) == -1));
+var is_nav = ((clientPC.indexOf('mozilla')!=-1) &amp;&amp; (clientPC.indexOf('spoofer')==-1)
+                &amp;&amp; (clientPC.indexOf('compatible') == -1) &amp;&amp; (clientPC.indexOf('opera')==-1)
+                &amp;&amp; (clientPC.indexOf('webtv')==-1) &amp;&amp; (clientPC.indexOf('hotjava')==-1));
+var is_moz = 0;
+
+var is_win = ((clientPC.indexOf(&quot;win&quot;)!=-1) || (clientPC.indexOf(&quot;16bit&quot;) != -1));
+var is_mac = (clientPC.indexOf(&quot;mac&quot;)!=-1);
+
+
+function barre_raccourci(debut,fin,champ) {
+	var txtarea = champ;
+
+	txtarea.focus();
+	donotinsert = false;
+	theSelection = false;
+	bblast = 0;
+
+	if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win)
+	{
+		theSelection = document.selection.createRange().text; // Get text selection
+		if (theSelection) {
+
+			while (theSelection.substring(theSelection.length-1, theSelection.length) == ' ')
+			{
+				theSelection = theSelection.substring(0, theSelection.length-1);
+				fin = fin + &quot; &quot;;
+			}
+			if (theSelection.substring(0,1) == '{' &amp;&amp; debut.substring(0,1) == '{')
+			{
+				debut = debut + &quot; &quot;;
+			}
+			if (theSelection.substring(theSelection.length-1, theSelection.length) == '}' &amp;&amp; fin.substring(0,1) == '}')
+			{
+				fin = &quot; &quot; + fin;
+			}
+
+			// Add tags around selection
+			document.selection.createRange().text = debut + theSelection + fin;
+			txtarea.focus();
+			theSelection = '';
+			return;
+		}
+	}
+	else if (txtarea.selectionEnd &amp;&amp; (txtarea.selectionEnd - txtarea.selectionStart &gt; 0))
+	{
+		mozWrap(txtarea, debut, fin);
+		return;
+	}
+}
+
+function barre_demande(debut,milieu,fin,affich,champ) {
+	var inserer = prompt(affich);
+
+	if (inserer != null) {
+		if (inserer == &quot;&quot;) {inserer = &quot;xxx&quot;; }
+
+		barre_raccourci(debut, milieu+inserer+fin, champ);
+	}
+}
+
+function barre_inserer(text,champ) {
+	var txtarea = champ;
+	
+	if (txtarea.createTextRange &amp;&amp; txtarea.caretPos) {
+		var caretPos = txtarea.caretPos;
+		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
+		txtarea.focus();
+	} else {
+		//txtarea.value  += text;
+		//txtarea.focus();
+		mozWrap(txtarea, '', text);
+		return;
+	}
+}
+
+
+// D'apres Nicolas Hoizey 
+function barre_tableau(toolbarfield)
+{
+	var txtarea = toolbarfield;
+	txtarea.focus();
+	var cols = prompt(&quot;Nombre de colonnes du tableau :&quot;, &quot;&quot;);
+	var rows = prompt(&quot;Nombre de lignes du tableau :&quot;, &quot;&quot;);
+	if (cols != null &amp;&amp; rows != null) {
+		var tbl = '';
+		var ligne = '|';
+		var entete = '|';
+		for(i = 0; i &lt; cols; i++) {
+			ligne = ligne + ' valeur |';
+			entete = entete + ' {{entete}} |';
+		}
+		for (i = 0; i &lt; rows; i++) {
+			tbl = tbl + ligne + '\n';
+		}
+		if (confirm('Voulez vous ajouter une ligne d\'en-t&#234;te ?')) {
+			tbl = entete + '\n' + tbl;
+		}
+		if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win) {
+			var str = document.selection.createRange().text;
+			var sel = document.selection.createRange();
+			sel.text = str + '\n\n' + tbl + '\n\n';
+		} else {
+			mozWrap(txtarea, '', &quot;\n\n&quot; + tbl + &quot;\n\n&quot;);
+		}
+	}
+	return;
+}
+
+
+
+// Shows the help messages in the helpline window
+function helpline(help, champ) {
+	champ.value = help;
+}
+
+
+function setCaretToEnd (input) {
+  setSelectionRange(input, input.value.length, input.value.length);
+}
+
+
+function setSelectionRange(input, selectionStart, selectionEnd) {
+  if (input.setSelectionRange) {
+    input.focus();
+    input.setSelectionRange(selectionStart, selectionEnd);
+  }
+  else if (input.createTextRange) {
+    var range = input.createTextRange();
+    range.collapse(true);
+    range.moveEnd('character', selectionEnd);
+    range.moveStart('character', selectionStart);
+    range.select();
+  }
+}
+
+// From <A HREF="http://www.massless.org/mozedit/">http://www.massless.org/mozedit/</A>
+function mozWrap(txtarea, open, close)
+{
+	var selLength = txtarea.textLength;
+	var selStart = txtarea.selectionStart;
+	var selEnd = txtarea.selectionEnd;
+	if (selEnd == 1 || selEnd == 2)
+		selEnd = selLength;
+	var selTop = txtarea.scrollTop;
+
+	// Raccourcir la selection par double-clic si dernier caractere est espace	
+	if (selEnd - selStart &gt; 0 &amp;&amp; (txtarea.value).substring(selEnd-1,selEnd) == ' ') selEnd = selEnd-1;
+	
+	var s1 = (txtarea.value).substring(0,selStart);
+	var s2 = (txtarea.value).substring(selStart, selEnd)
+	var s3 = (txtarea.value).substring(selEnd, selLength);
+
+	// Eviter melange bold-italic-intertitre
+	if ((txtarea.value).substring(selEnd,selEnd+1) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = close + &quot; &quot;;
+	if ((txtarea.value).substring(selEnd-1,selEnd) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = &quot; &quot; + close;
+	if ((txtarea.value).substring(selStart-1,selStart) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = &quot; &quot; + open;
+	if ((txtarea.value).substring(selStart,selStart+1) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = open + &quot; &quot;;
+
+	txtarea.value = s1 + open + s2 + close + s3;
+	selDeb = selStart + open.length;
+	selFin = selEnd + close.length;
+	window.setSelectionRange(txtarea, selDeb, selFin);
+	txtarea.scrollTop = selTop;
+	txtarea.focus();
+	
+	return;
+}
+
+// Insert at Claret position. Code from
+// <A HREF="http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130">http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130</A>
+     function storeCaret (textEl) {
+       if (textEl.createTextRange) 
+         textEl.caretPos = document.selection.createRange().duplicate();
+     }
+

Index: sommaire_texte.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/sommaire_texte.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- sommaire_texte.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ sommaire_texte.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,12 +1,12 @@
-&lt;?php
-
-// ACCESSIBILITE
-// cette page offre une lecture en mode &quot;texte seul&quot;
-// des 3 articles les plus recents.
-
-$fond = &quot;sommaire_texte&quot;;
-$delais = 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+// ACCESSIBILITE
+// cette page offre une lecture en mode &quot;texte seul&quot;
+// des 3 articles les plus recents.
+
+$fond = &quot;sommaire_texte&quot;;
+$delais = 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: spip_login.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_login.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_login.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_login.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,10 +1,21 @@
-&lt;?php
-$fond = &quot;login&quot;;
-$delais = 3600;
-$flag_dynamique = true;
-$flag_preserver = true;
-$forcer_lang = true;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+$fond = &quot;login&quot;;
+$delais = 3600;
+$flag_dynamique = true;
+$flag_preserver = true;
+$forcer_lang = true;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: inc-messforum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-messforum.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-messforum.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-messforum.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,201 +1,216 @@
-&lt;?php
-
-include_ecrire('inc_meta.php3');
-include_ecrire('inc_forum.php3');
-include_ecrire(&quot;inc_abstract_sql.php3&quot;);
-include_local(_FILE_CONNECT);
-
-// Ce fichier inclus par inc-public a un comportement special
-// Voir commentaires dans celui-ci et dans inc-formulaire_forum
-
-function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre) {
-	include_ecrire('inc_texte.php3');
-	include_ecrire('inc_filtres.php3');
-	include_ecrire('inc_mail.php3');
-	// Gestionnaire d'URLs
-	if (@file_exists(&quot;inc-urls.php3&quot;))
-	  include_local(&quot;inc-urls.php3&quot;);
-	else
-	  include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
-	$url = ereg_replace('^/', '', generer_url_article($id_article));
-	$adresse_site = lire_meta(&quot;adresse_site&quot;);
-	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
-	$url = &quot;$adresse_site/$url&quot;;
-	$parauteur = (strlen($auteur) &lt;= 2) ? '' :
-	  (&quot; &quot;
-	   ._T('forum_par_auteur',
-	       array('auteur' =&gt; $auteur)) .
-	   (!$email_auteur ? '' : (' &lt;' . $email_auteur . '&gt;')));
-	$courr =  _T('form_forum_message_auto').&quot;\n\n&quot;
-		. _T('forum_poste_par',
-		     array('parauteur' =&gt; $parauteur)).&quot;\n&quot;
-		. _T('forum_ne_repondez_pas').&quot;\n&quot;
-		. $url
-		. &quot;\n\n\n&quot;.$titre.&quot;\n\n&quot;.textebrut(propre($texte))
-		. &quot;\n\n$nom_site_forum\n$url_site\n&quot;;
-	$sujet = &quot;[$nom_site_spip] [&quot;._T('forum_forum').&quot;] $titre&quot;;
-	$result = spip_query(&quot;SELECT auteurs.email FROM spip_auteurs AS auteurs,
-				spip_auteurs_articles AS lien
-				WHERE lien.id_article='$id_article'
-				AND auteurs.id_auteur=lien.id_auteur&quot;);
-
-	while (list($email) = spip_fetch_array($result)) {
-		$email = trim($email);
-		if (strlen($email) &lt; 3) continue;
-		envoyer_mail($email, $sujet, $courr);
-	}
-}
-
-
-function controler_forum($id_article, $retour) {
-	global $auteur_session;
-
-	// Reglage forums d'article
-	if ($id_article) {
-		$q = spip_query(&quot;SELECT accepter_forum FROM spip_articles
-			WHERE id_article=$id_article&quot;);
-		if ($r = spip_fetch_array($q))
-			$forums_publics = $r['accepter_forum'];
-	}
-
-	// Valeur par defaut
-	if (!$forums_publics)
-		$forums_publics = substr(lire_meta(&quot;forums_publics&quot;),0,3);
-
-	if ($forums_publics == &quot;abo&quot;) {
-		if ($auteur_session) {
-			$statut = $auteur_session['statut'];
-			if (!$statut OR $statut == '5poubelle') {
-				ask_php_auth(_T('forum_acces_refuse'),
-					     _T('forum_cliquer_retour',
-						array('retour_forum' =&gt; $retour)));
-				exit;
-			}
-		} else {
-			ask_php_auth(_T('forum_non_inscrit'),
-				     _T('forum_cliquer_retour',
-					array('retour_forum' =&gt; $retour)));
-			exit;
-		}
-	}
-
-	return $forums_publics;
-}
-
-function mots_du_forum($ajouter_mot, $id_message)
-{
-	foreach ($ajouter_mot as $id_mot)
-		if ($id_mot = intval($id_mot))
-			spip_query(&quot;INSERT INTO spip_mots_forum (id_mot, id_forum)
-				VALUES ($id_mot, $id_message)&quot;);
-}
-
-function enregistre_forum() {
-	global $REMOTE_ADDR, $auteur_session,
-	  $afficher_texte, $ajouter_mot, $alea, $hash,
-	  $auteur, $confirmer_forum, $email_auteur,
-	  $id_article, $id_auteur, $id_breve, $id_forum, $id_rubrique, $id_syndic,
-	  $nom_site_forum, $retour_forum, $texte, $titre, $url_site;
-
-	$retour_forum = rawurldecode($retour_forum);
-	$id_article = intval($id_article);
-	$id_rubrique = intval($id_rubrique);
-	$id_forum = intval($id_forum);
-	$id_breve = intval($id_breve);
-	$id_syndic = intval($id_syndic);
-
-// initialisation de l'eventuel visiteur connecte
-	if (!$id_auteur)
-	$id_auteur = intval($auteur_session['id_auteur']);
-
-	$statut = controler_forum($id_article, $retour_forum);
-
-// Ne pas autoriser de changement de nom si forum sur abonnement
-
-	if ($statut == 'abo') {
-		$auteur = $auteur_session['nom'];
-		$email_auteur = $auteur_session['email'];
-	}
-
-// trop court ?
-	if ((strlen($texte) + strlen($titre) + strlen($nom_site_forum) + strlen($url_site) + strlen($auteur) + strlen($email_auteur)) &gt; 20 * 1024) {
-		ask_php_auth(_T('forum_message_trop_long'),
-			     _T('forum_cliquer_retour',
-				array('retour_forum' =&gt; $retour_forum)));
-		exit;
-	}
-
-	// Verifier hash securite
-	include_ecrire(&quot;inc_admin.php3&quot;);
-	if (!verifier_action_auteur(&quot;ajout_forum $id_rubrique&quot;.
-	&quot; $id_forum $id_article $id_breve&quot;.
-	&quot; $id_syndic $alea&quot;, $hash))
-		exit; 	# echec silencieux du POST
-
-	// verifier fichier lock
-	$alea = preg_replace('/[^0-9]/', '', $alea);
-	if (!file_exists($hash = _DIR_SESSIONS.&quot;forum_$alea.lck&quot;))
-		exit; # echec silencieux du POST
-	unlink($hash);
-
-	// Entrer le message dans la base
-	$id_message = spip_abstract_insert('spip_forum', '(date_heure)', '(NOW())');
-
-	if ($id_forum)
-		list($id_thread) = spip_fetch_array(spip_query(
-		&quot;SELECT id_thread FROM spip_forum WHERE id_forum = $id_forum&quot;));
-	else
-		$id_thread = $id_message; # id_thread oblige INSERT puis UPDATE.
-
-	$statut = ($statut == 'non') ? 'off' : (($statut == 'pri') ? 'prop' :
-						'publie');
-
-	spip_query(&quot;UPDATE spip_forum SET id_parent = $id_forum,
-	id_rubrique = $id_rubrique,
-	id_article = $id_article,
-	id_breve = $id_breve,
-	id_syndic = $id_syndic,
-	id_auteur = $id_auteur,
-	id_thread = $id_thread,
-	date_heure = NOW(),
-	titre = '&quot;.addslashes($titre).&quot;',
-	texte = '&quot;.addslashes($texte).&quot;',
-	nom_site = '&quot;.addslashes($nom_site_forum).&quot;',
-	url_site = '&quot;.addslashes($url_site).&quot;',
-	auteur = '&quot;.addslashes($auteur).&quot;',
-	email_auteur = '&quot;.addslashes($email_auteur).&quot;',
-	ip = '$REMOTE_ADDR',
-	statut = '$statut'
-	WHERE id_forum = $id_message
-	&quot;);
-
-	// calculer_threads();
-
-	// Entrer les mots-cles associes
-	if (is_array($ajouter_mot)) mots_du_forum($ajouter_mot, $id_message);
-
-	// Prevenir les auteurs de l'article
-	if (lire_meta(&quot;prevenir_auteurs&quot;) == &quot;oui&quot; AND ($afficher_texte != &quot;non&quot;))
-		prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);
-
-	// Poser un cookie pour ne pas retaper le nom / email
-
-	spip_setcookie('spip_forum_user',
-		       serialize(array('nom' =&gt; $auteur, 'email' =&gt; $email_auteur)));
-
-	if ($statut == 'publie') {
-	//
-	// INVALIDATION DES CACHES LIES AUX FORUMS
-	//
-		include_ecrire('inc_invalideur.php3');
-		suivre_invalideur (&quot;id='id_forum/&quot; .
-			calcul_index_forum($id_article,
-				$id_breve,
-				$id_rubrique,
-				$id_syndic) . &quot;'&quot;);
-	}
-
-	return $retour_forum;
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+include_ecrire('inc_meta.php3');
+include_ecrire('inc_forum.php3');
+include_ecrire(&quot;inc_abstract_sql.php3&quot;);
+include_local(_FILE_CONNECT);
+
+// Ce fichier inclus par inc-public a un comportement special
+// Voir commentaires dans celui-ci et dans inc-formulaire_forum
+
+function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre) {
+	include_ecrire('inc_texte.php3');
+	include_ecrire('inc_filtres.php3');
+	include_ecrire('inc_mail.php3');
+	// Gestionnaire d'URLs
+	if (@file_exists(&quot;inc-urls.php3&quot;))
+	  include_local(&quot;inc-urls.php3&quot;);
+	else
+	  include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
+	$url = ereg_replace('^/', '', generer_url_article($id_article));
+	$adresse_site = lire_meta(&quot;adresse_site&quot;);
+	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
+	$url = &quot;$adresse_site/$url&quot;;
+	$parauteur = (strlen($auteur) &lt;= 2) ? '' :
+	  (&quot; &quot;
+	   ._T('forum_par_auteur',
+	       array('auteur' =&gt; $auteur)) .
+	   (!$email_auteur ? '' : (' &lt;' . $email_auteur . '&gt;')));
+	$courr =  _T('form_forum_message_auto').&quot;\n\n&quot;
+		. _T('forum_poste_par',
+		     array('parauteur' =&gt; $parauteur)).&quot;\n&quot;
+		. _T('forum_ne_repondez_pas').&quot;\n&quot;
+		. $url
+		. &quot;\n\n\n&quot;.$titre.&quot;\n\n&quot;.textebrut(propre($texte))
+		. &quot;\n\n$nom_site_forum\n$url_site\n&quot;;
+	$sujet = &quot;[$nom_site_spip] [&quot;._T('forum_forum').&quot;] $titre&quot;;
+	$result = spip_query(&quot;SELECT auteurs.email FROM spip_auteurs AS auteurs,
+				spip_auteurs_articles AS lien
+				WHERE lien.id_article='$id_article'
+				AND auteurs.id_auteur=lien.id_auteur&quot;);
+
+	while (list($email) = spip_fetch_array($result)) {
+		$email = trim($email);
+		if (strlen($email) &lt; 3) continue;
+		envoyer_mail($email, $sujet, $courr);
+	}
+}
+
+
+function controler_forum($id_article, $retour) {
+	global $auteur_session;
+
+	// Reglage forums d'article
+	if ($id_article) {
+		$q = spip_query(&quot;SELECT accepter_forum FROM spip_articles
+			WHERE id_article=$id_article&quot;);
+		if ($r = spip_fetch_array($q))
+			$forums_publics = $r['accepter_forum'];
+	}
+
+	// Valeur par defaut
+	if (!$forums_publics)
+		$forums_publics = substr(lire_meta(&quot;forums_publics&quot;),0,3);
+
+	if ($forums_publics == &quot;abo&quot;) {
+		if ($auteur_session) {
+			$statut = $auteur_session['statut'];
+			if (!$statut OR $statut == '5poubelle') {
+				ask_php_auth(_T('forum_acces_refuse'),
+					     _T('forum_cliquer_retour',
+						array('retour_forum' =&gt; $retour)));
+				exit;
+			}
+		} else {
+			ask_php_auth(_T('forum_non_inscrit'),
+				     _T('forum_cliquer_retour',
+					array('retour_forum' =&gt; $retour)));
+			exit;
+		}
+	}
+
+	return $forums_publics;
+}
+
+function mots_du_forum($ajouter_mot, $id_message)
+{
+	foreach ($ajouter_mot as $id_mot)
+		if ($id_mot = intval($id_mot))
+			spip_query(&quot;INSERT INTO spip_mots_forum (id_mot, id_forum)
+				VALUES ($id_mot, $id_message)&quot;);
+}
+
+function enregistre_forum() {
+	global $REMOTE_ADDR, $auteur_session,
+	  $afficher_texte, $ajouter_mot, $alea, $hash,
+	  $auteur, $confirmer_forum, $email_auteur, $id_auteur,
+	  $nom_site_forum, $retour_forum, $texte, $titre, $url_site;
+
+	$retour_forum = rawurldecode($retour_forum);
+
+	// Recuperer les donnees postees du formulaire ou stocker '0'
+	foreach (array('id_article', 'id_breve', 'id_syndic',
+	'id_rubrique', 'id_forum') as $id)
+		if (isset($_POST['forum_'.$id]))
+			$$id = intval($_POST['forum_'.$id]);
+		else
+			$$id = 0;
+
+	// initialisation de l'eventuel visiteur connecte
+	if (!$id_auteur)
+	$id_auteur = intval($auteur_session['id_auteur']);
+
+	$statut = controler_forum($id_article, $retour_forum);
+
+	// Ne pas autoriser de changement de nom si forum sur abonnement
+	if ($statut == 'abo') {
+		$auteur = $auteur_session['nom'];
+		$email_auteur = $auteur_session['email'];
+	}
+
+	// trop court ?
+	if ((strlen($texte) + strlen($titre) + strlen($nom_site_forum) +
+	strlen($url_site) + strlen($auteur) + strlen($email_auteur)) &gt; 20 * 1024) {
+		ask_php_auth(_T('forum_message_trop_long'),
+			_T('forum_cliquer_retour',
+				array('retour_forum' =&gt; $retour_forum)));
+		exit;
+	}
+
+	// Verifier hash securite
+	include_ecrire(&quot;inc_admin.php3&quot;);
+	if (!verifier_action_auteur(&quot;ajout_forum $id_rubrique&quot;.
+	&quot; $id_forum $id_article $id_breve&quot;.
+	&quot; $id_syndic $alea&quot;, $hash)) {
+		spip_log('erreur hash forum');
+		die (_T('forum_titre_erreur')); 	# echec du POST
+	}
+
+	// verifier fichier lock
+	$alea = preg_replace('/[^0-9]/', '', $alea);
+	if (!file_exists($hash = _DIR_SESSIONS.&quot;forum_$alea.lck&quot;))
+		exit; # echec silencieux du POST
+	unlink($hash);
+
+	// Entrer le message dans la base
+	$id_message = spip_abstract_insert('spip_forum', '(date_heure)', '(NOW())');
+
+	if ($id_forum)
+		list($id_thread) = spip_fetch_array(spip_query(
+		&quot;SELECT id_thread FROM spip_forum WHERE id_forum = $id_forum&quot;));
+	else
+		$id_thread = $id_message; # id_thread oblige INSERT puis UPDATE.
+
+	$statut = ($statut == 'non') ? 'off' : (($statut == 'pri') ? 'prop' :
+						'publie');
+
+	spip_query(&quot;UPDATE spip_forum SET id_parent = $id_forum,
+	id_rubrique = $id_rubrique,
+	id_article = $id_article,
+	id_breve = $id_breve,
+	id_syndic = $id_syndic,
+	id_auteur = $id_auteur,
+	id_thread = $id_thread,
+	date_heure = NOW(),
+	titre = '&quot;.addslashes($titre).&quot;',
+	texte = '&quot;.addslashes($texte).&quot;',
+	nom_site = '&quot;.addslashes($nom_site_forum).&quot;',
+	url_site = '&quot;.addslashes($url_site).&quot;',
+	auteur = '&quot;.addslashes($auteur).&quot;',
+	email_auteur = '&quot;.addslashes($email_auteur).&quot;',
+	ip = '$REMOTE_ADDR',
+	statut = '$statut'
+	WHERE id_forum = $id_message
+	&quot;);
+
+	// calculer_threads();
+
+	// Entrer les mots-cles associes
+	if (is_array($ajouter_mot)) mots_du_forum($ajouter_mot, $id_message);
+
+	// Prevenir les auteurs de l'article
+	if (lire_meta(&quot;prevenir_auteurs&quot;) == &quot;oui&quot; AND ($afficher_texte != &quot;non&quot;))
+		prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);
+
+	// Poser un cookie pour ne pas retaper le nom / email
+
+	spip_setcookie('spip_forum_user',
+		       serialize(array('nom' =&gt; $auteur, 'email' =&gt; $email_auteur)));
+
+	if ($statut == 'publie') {
+	//
+	// INVALIDATION DES CACHES LIES AUX FORUMS
+	//
+		include_ecrire('inc_invalideur.php3');
+		suivre_invalideur (&quot;id='id_forum/&quot; .
+			calcul_index_forum($id_article,
+				$id_breve,
+				$id_rubrique,
+				$id_syndic) . &quot;'&quot;);
+	}
+
+	return $retour_forum;
+}
+
+?&gt;

Index: spip_carto.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_carto.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_carto.php	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_carto.php	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,43 +1,25 @@
-&lt;?php
-include (&quot;ecrire/inc_version.php3&quot;);
-include (&quot;ecrire/inc_connect.php3&quot;);
-//include (&quot;ecrire/inc_meta.php3&quot;);
-//include (&quot;ecrire/inc_session.php3&quot;);
-
-include(&quot;downloadfile.class.php&quot;);
-
-if (isset($_GET[&quot;fond_carte&quot;]) &amp;&amp; !empty($_GET[&quot;fond_carte&quot;])) 
-{
-	$lid_carte=intval($_GET[&quot;fond_carte&quot;]);
-	//echo $lid_carte;
-	//exit;
-	if ($lid_carte)
-	{
-		$query=&quot;select fichier from spip_documents where id_document=&quot;.$lid_carte;
-		
-		$result = @spip_query($query);
-		if ($result) 
-		{
-			$row = @spip_fetch_array($result); 
-			$downloadfile = new DOWNLOADFILE($row[0],&quot;inline&quot;);
-			//si c'est un probleme de document supprim&#233; : &quot;!!!&quot; ... bof !
-			$lError=&quot;document OK&quot;;
-		}
-		else {
-			$downloadfile = new DOWNLOADFILE(&quot;ecrire/img_pack/carte-24.png&quot;,&quot;inline&quot;);
-			$lError=&quot;pas de document&quot;;
-		}
-		if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
-		//echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
-			
-	}
-	else {
-		//$downloadfile = new DOWNLOADFILE(&quot;/ecrire/img_pack/carte-24.png&quot;,&quot;inline&quot;);
-		//$downloadfile = new DOWNLOADFILE($_GET[&quot;fond_carte&quot;],&quot;inline&quot;);
-		redirige_par_entete($_GET[&quot;fond_carte&quot;]);
-		$lError=&quot;chemin&quot;;
-	}
-	//if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
-	//else exit();
-}
+&lt;?php
+include (&quot;ecrire/inc_version.php3&quot;);
+include (&quot;ecrire/inc_connect.php3&quot;);
+
+if (isset($_GET[&quot;fond_carte&quot;]) &amp;&amp; !empty($_GET[&quot;fond_carte&quot;])) 
+{
+	$lid_carte=intval($_GET[&quot;fond_carte&quot;]);
+	if ($lid_carte)
+	{
+		$query=&quot;select fichier from spip_documents where id_document=&quot;.$lid_carte;
+		
+		$result = @spip_query($query);
+		if ($result) 
+		{
+			$row = @spip_fetch_array($result); 
+			redirige_par_entete($row[0]);
+		}
+	}
+	else 
+	{
+		redirige_par_entete($_GET[&quot;fond_carte&quot;]);
+	}
+}
+redirige_par_entete(&quot;404.php3&quot;);
 ?&gt;

Index: inc-criteres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-criteres.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-criteres.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-criteres.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,642 +1,653 @@
-&lt;?php
-
-//
-// Definition des {criteres} d'une boucle
-//
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_CRITERES&quot;)) return;
-define(&quot;_INC_CRITERES&quot;, &quot;1&quot;);
-
-
[...1264 lines suppressed...]
+	foreach (split(&quot; *, *&quot;, $reg[1]) as $v) {
+	  $v = calculer_param_dynamique($v, $boucles, $idb);
+	  if (is_array($v)) erreur_squelette($v);
+	  if (strpos('0123456789',$v[0]) !== false)
+	    $res[] = $v;
+	  else if ($v[0]=='&quot;')
+	    $res[] = &quot;'&quot; . $v . &quot;'&quot;;
+	  else
+	    $res[] = &quot;'$v'&quot;;
+	}
+	return join(',', $res);
+}
+
+function simplifie_param_dynamique($val, &amp;$boucles, $idb)
+{
+	$a = calculer_param_dynamique($val, $boucles, $idb);
+	if (!ereg('&quot; \. *(.*)\. &quot;', $a, $m)) return $a;
+	return $m[1];
+}	
+?&gt;

Index: spip_image_reduite.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_image_reduite.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_image_reduite.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_image_reduite.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,37 +1,52 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire(&quot;inc_admin.php3&quot;);
-include_ecrire(&quot;inc_logos.php3&quot;);
-
-$img = $_GET['img'];
-$logo = $img;
-
-if (!$taille_y)
-	$taille_y = $taille_x;
-	
-if (eregi(&quot;(.*)\.(jpg|gif|png)$&quot;, $logo, $regs)) {
-	if ($i = cherche_image_nommee($regs[1], array($regs[2]))
-		AND verifier_action_auteur(&quot;reduire $taille_x $taille_y&quot;, $hash, $hash_id_auteur))
-	{
-		list($dir,$nom,$format) = $i;
-		$logo = $dir . $nom . '.' . $format;
-		
-		include_ecrire(&quot;inc_logos.php3&quot;);
-		$suffixe = '-'.$taille_x.'x'.$taille_y;
-		$preview = creer_vignette($logo, $taille_x, $taille_y, $format,('cache'.$suffixe), $nom.$suffixe);
-		if ($preview) {
-			$vignette = $preview['fichier'];
-			$width = $preview['width'];
-			$height = $preview['height'];
-			$retour = $vignette;
-		}
-		else if ($taille_origine = @getimagesize($logo)) {
-			$retour = $logo;
-		}
-
-		redirige_par_entete($retour);
-	}
-}
-
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire(&quot;inc_admin.php3&quot;);
+include_ecrire(&quot;inc_logos.php3&quot;);
+
+if (!$taille_y)
+	$taille_y = $taille_x;
+
+// Chercher l'image dans le repertoire IMG/
+if (eregi(&quot;(\.\./)?(.*)\.(jpg|gif|png)$&quot;, $img, $regs)
+AND $i = cherche_image_nommee($regs[2], array($regs[3])) # hu ?
+) {
+	$img = $i[0].$i[1].'.'.$i[2];
+	// si on a deja la bonne taille, pas la peine de se fatiguer
+	$taille = @getimagesize($img);
+	if ($taille_x == $taille[0] AND $taille_y == $taille[1])
+		$stop = true;
+}
+
+if (lire_meta('creer_preview') &lt;&gt; 'oui')
+	$stop = true;
+
+if (!$stop
+AND verifier_action_auteur(&quot;reduire $taille_x $taille_y&quot;, $hash, $hash_id_auteur))
+	{
+		list($dir,$nom,$format) = $i;
+		$logo = $dir . $nom . '.' . $format;
+		
+		include_ecrire(&quot;inc_logos.php3&quot;);
+		$suffixe = '-'.$taille_x.'x'.$taille_y;
+		$preview = creer_vignette($logo, $taille_x, $taille_y, $format,('cache'.$suffixe), $nom.$suffixe);
+		if ($preview)
+			$img = $preview['fichier'];
+}
+
+// Envoie le navigateur vers l'image cible
+redirige_par_entete($img);
+
+
 ?&gt;

Index: inc-public-global.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-public-global.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-public-global.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-public-global.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,409 +1,417 @@
-&lt;?php
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_PUBLIC_GLOBAL&quot;)) return;
-define(&quot;_INC_PUBLIC_GLOBAL&quot;, &quot;1&quot;);
-
-// fonction principale declenchant tout le service
-function calcule_header_et_page ($fond, $delais) {
-	  global $affiche_boutons_admin, $auteur_session, $flag_dynamique,
-	  $flag_ob, $flag_preserver, $forcer_lang, $ignore_auth_http,
-	  $lastmodified, $recherche, $use_cache, $val_confirm, $var_mode,
-	  $var_recherche, $tableau_des_erreurs;
-
-	// Regler le $delais par defaut
-	if (!isset($delais))
-		$delais = 1 * 3600;
-	if ($recherche)
-		$delais = 0;
-
-	// authentification du visiteur
-	if ($GLOBALS['_COOKIE']['spip_session'] OR
-	($GLOBALS['_SERVER']['PHP_AUTH_USER']  AND !$ignore_auth_http)) {
-		include_ecrire (&quot;inc_session.php3&quot;);
-		verifier_visiteur();
-	}
-	// multilinguisme
-	if ($forcer_lang AND ($forcer_lang!=='non') AND empty($GLOBALS['_POST'])) {
-		include_ecrire('inc_lang.php3');
-		verifier_lang_url();
-	}
-	if ($GLOBALS['_GET']['lang']) {
-		include_ecrire('inc_lang.php3');
-		lang_select($GLOBALS['_GET']['lang']);
-	}
-
-	// Si envoi pour un forum, enregistrer puis rediriger
-
-	if (strlen($GLOBALS['_POST']['confirmer_forum']) &gt; 0
-	OR ($GLOBALS['_POST']['afficher_texte']=='non'
-		AND $GLOBALS['_POST']['ajouter_mot'])) {
-		include('inc-messforum.php3');
-		redirige_par_entete(enregistre_forum());
-	}
-
-	// si signature de petition, l'enregistrer avant d'afficher la page
-	// afin que celle-ci contienne la signature
-
-	if ($GLOBALS['_GET']['val_confirm']) {
-		include_local(find_in_path('inc-formulaire_signature.php3'));
-		reponse_confirmation($GLOBALS['_GET']['id_article'], $val_confirm);
-	}
-
-	//  refus du debug si pas dans les options generales ni admin connecte
-	if ($var_mode=='debug') {
-		if (($GLOBALS['code_activation_debug'] == 'oui')
-		OR $auteur_session['statut'] == '0minirezo')
-			spip_log('debug !');
-		else
-			$var_mode = false; 
-	}
-
-	// est-on admin ?
-	if ($affiche_boutons_admin = (!$flag_preserver
-	AND ($GLOBALS['_COOKIE']['spip_admin']
-	OR $GLOBALS['_COOKIE']['spip_debug'])))
-		include_local(find_in_path('inc-formulaire_admin.php3'));
-
-	$tableau_des_erreurs = array();
-	$page = afficher_page_globale ($fond, $delais, $use_cache);
-
-
-	//
-	// Envoyer les entetes appropries
-	// a condition d'etre sur de pouvoir le faire
-	//
-	if (!$flag_preserver
-	AND $flag_ob AND !strlen(@ob_get_contents())) {
-
-		// Si la page est vide, gerer l'erreur 404
-		if (preg_match('/^[[:space:]]*$/', $page['texte'])
-		AND $var_mode != 'debug') {
-			header(&quot;HTTP/1.0 404&quot;);
-			header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-			$contexte_inclus = array(
-				'erreur_aucun' =&gt; message_erreur_404()
-			);
-			include(find_in_path('404.php3'));
-		}
-		// Interdire au client de cacher un login, un admin ou un recalcul
-		else if ($flag_dynamique OR $var_mode
-		OR $GLOBALS['_COOKIE']['spip_admin']) {
-			header(&quot;Cache-Control: no-cache,must-revalidate&quot;);
-			header(&quot;Pragma: no-cache&quot;);
-		}
-		// Pour les autres donner l'heure de modif
-		else if ($lastmodified) {
-			header(&quot;Last-Modified: &quot;.http_gmoddate($lastmodified).&quot; GMT&quot;);
-			header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-		}
-	}
-
-	return $page;
-}
-
-
-//
-// Aller chercher la page dans le cache ou pas
-//
-function obtenir_page ($contexte, $chemin_cache, $delais, &amp;$use_cache, $fond, $inclusion=false) {
-	global $lastmodified;
-
-	if (!$use_cache) {
-		include_local('inc-calcul.php3');
-
-		// page globale ? calculer le contexte
-		if (!$contexte)
-			$contexte = calculer_contexte();
-
-		spip_timer('calculer_page');
-		$page = calculer_page($chemin_cache,
-			array('fond' =&gt; $fond,
-				'contexte' =&gt; $contexte),
-			$delais,
-			$inclusion);
-
-		$lastmodified = time();
-
-		// log
-		if (!$log = $chemin_cache) $log = &quot;($fond, delais=$delais, &quot;
-		. $GLOBALS['_SERVER']['REQUEST_METHOD'].&quot;)&quot;;
-		spip_log (($inclusion ? 'calcul inclus':'calcul').' ('
-		.spip_timer('calculer_page').&quot;): $log&quot;);
-
-		// Nouveau cache : creer un invalideur 't' fixant la date
-		// d'expiration et la taille du fichier
-		if (@file_exists($chemin_cache)) {
-			// Ici on ajoute 3600s pour eviter toute concurrence
-			// entre un invalideur et un appel public de page
-			$bedtime = time() + $delais + 3600;
-			$taille = @filesize($chemin_cache);
-			$fichier = addslashes($chemin_cache);
-			spip_query(&quot;INSERT IGNORE INTO spip_caches (fichier,id,type,taille)
-			VALUES ('$fichier','$bedtime','t','$taille')&quot;);
-		}
-
-	} else {
-
-		//
-		// Lire le fichier cache
-		//
-		lire_fichier ($chemin_cache, $page['texte']);
-		$lastmodified = max($lastmodified, @filemtime($chemin_cache));
-		# spip_log (&quot;cache $chemin_cache $lastmodified&quot;);
-
-		//
-		// Lire sa carte d'identite &amp; fixer le contexte global
-		//
-		if (preg_match(&quot;/^&lt;!-- ([^\n]*) --&gt;\n(.*)/ms&quot;, $page['texte'], $match)
-		AND is_array($meta_donnees = unserialize($match[1]))) {
-			foreach ($meta_donnees as $var=&gt;$val)
-				$page[$var] = $val;
-
-			$page['texte'] = $match[2];
-
-			// Remplir les globals pour les boutons d'admin
-			if (!$inclusion AND is_array($page['contexte']))
-				foreach ($page['contexte'] as $var=&gt;$val)
-					$GLOBALS[$var] = $val;
-		}
-
-	}
-
-	return $page;
-}
-
-
-//
-// Appeler cette fonction pour obtenir la page principale
-//
-function afficher_page_globale ($fond, $delais, &amp;$use_cache) {
-	global $flag_preserver, $flag_dynamique, $lastmodified;
-	global $var_preview, $var_mode;
-	include_local (&quot;inc-cache.php3&quot;);
-
-	// demande de previsualisation ?
-	// -&gt; inc-calcul.php3 n'enregistrera pas les fichiers caches
-	// -&gt; inc-reqsql-squel.php3 acceptera les objets non 'publie'
-	if ($var_mode == 'preview') {
-		// Verifier qu'on a le droit de previsualisation
-		$statut = $GLOBALS['auteur_session']['statut'];
-		if ($statut=='0minirezo' OR
-		(lire_meta('preview')=='1comite' AND $statut=='1comite')) {
-			$var_mode = 'recalcul';
-			$delais = 0;
-			$var_preview = true;
-			spip_log('preview !');
-		} else
-			$var_preview = false;
-	}
-
-	// Faut-il effacer des pages invalidees ?
-	if (lire_meta('invalider')) {
-		include_ecrire('inc_meta.php3');
-		lire_metas();
-		if (lire_meta('invalider'))
-			retire_caches();
-	}
-
-	// Calculer le chemin putatif du cache
-	$chemin_cache = generer_nom_fichier_cache('', $fond);
-
-	// Peut-on utiliser un fichier cache ?
-	determiner_cache($delais, $use_cache, $chemin_cache);
-
-	// Repondre gentiment aux requetes sympas
-	// (ici on ne tient pas compte d'une obsolence du cache ou des
-	// eventuels fichiers inclus modifies depuis la date
-	// HTTP_IF_MODIFIED_SINCE du client)
-	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE'] AND !$var_mode
-	AND $chemin_cache AND !$flag_dynamique) {
-		$lastmodified = @filemtime($chemin_cache);
-		$headers_only = http_last_modified($lastmodified);
-	}
-	$headers_only |= ($GLOBALS['_SERVER']['REQUEST_METHOD'] == 'HEAD');
-
-	if ($headers_only) {
-		if ($chemin_cache)
-			$t = @filemtime($chemin_cache);
-		else
-			$t = time();
-		@header('Last-Modified: '.http_gmoddate($t).' GMT');
-		@header('Connection: close');
-		// Pas de bouton admin pour un HEAD
-		$flag_preserver = true;
-	}
-	else {
-		// Obtenir la page
-		$page = obtenir_page ('', $chemin_cache, $delais, $use_cache,
-		$fond, false);
-
-		if (!$flag_preserver) {
-		// Entete content-type: xml ou html ; charset
-			if ($xhtml) {
-			// Si Mozilla et tidy actif, passer en &quot;application/xhtml+xml&quot;
-			// extremement risque: Mozilla passe en mode debugueur strict
-			// mais permet d'afficher du MathML directement dans le texte
-			// (et sauf erreur, c'est la bonne facon de declarer du xhtml)
-				include_ecrire(&quot;inc_tidy.php&quot;);
-				if (version_tidy() &gt; 0) {
-					if (ereg(&quot;application/xhtml\+xml&quot;, $GLOBALS['HTTP_ACCEPT'])) 
-						@header(&quot;Content-Type: application/xhtml+xml; charset=&quot;.lire_meta('charset'));
-					else 
-						@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-					echo '&lt;'.'?xml version=&quot;1.0&quot; encoding=&quot;'. lire_meta('charset').'&quot;?'.&quot;&gt;\n&quot;;
-				} else {
-					@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-				}
-			} else {
-				@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-			}
-		}
-	}
-
-	if ($chemin_cache) $page['cache'] = $chemin_cache;
-
-	if ($var_preview AND !$flag_preserver) {
-		include_ecrire('inc_lang.php3');
-		include_ecrire('inc_filtres.php3');
-		lang_select($GLOBALS['auteur_session']['lang']);
-		$page['texte'] .= '&lt;div style=&quot;
-		display: block;
-		color: #eeeeee;
-		background-color: #111111;
-		padding-right: 5px;
-		padding-top: 2px;
-		padding-bottom: 5px;
-		font-size: 20px;
-		top: 0px;
-		left: 0px;
-		position: absolute;
-		&quot;&gt;&lt;img src=&quot;' . _DIR_IMG_PACK
-		. 'naviguer-site.png&quot; align=&quot;left&quot; border=&quot;0&quot; /&gt;&nbsp; '
-		. majuscules(_T('previsualisation')).'&lt;/div&gt;';
-	}
-
-	return $page;
-}
-
-
-function terminer_public_global() {
-
-	// Gestion des statistiques du site public
-	if (lire_meta(&quot;activer_statistiques&quot;) != &quot;non&quot;) {
-		include_local (&quot;inc-stats.php3&quot;);
-		ecrire_stats();
-	}
-
-	// Effectuer une tache de fond ?
-	cron();
-}
-
-
-function inclure_page($fond, $delais_inclus, $contexte_inclus, $cache_incluant='') {
-
-	$contexte_inclus['fond'] = $fond;
-
-	$chemin_cache = generer_nom_fichier_cache($contexte_inclus, $fond);
-
-	// Peut-on utiliser un fichier cache ?
-	determiner_cache($delais_inclus, $use_cache, $chemin_cache);
-
-	// Si on a inclus sans fixer le critere de lang, de deux choses l'une :
-	// - on est dans la langue du site, et pas besoin d'inclure inc_lang
-	// - on n'y est pas, et alors il faut revenir dans la langue par defaut
-	if (($lang = $contexte_inclus['lang'])
-	|| ($GLOBALS['spip_lang'] != ($lang = lire_meta('langue_site')))) {
-		include_ecrire('inc_lang.php3');
-		lang_select($lang);
-		$lang_select = true; // pour lang_dselect en sortie
-	}
-	
-	// Si on est inclus en POST, il faut ajouter les variables _POST dans
-	// le contexte inclus, sinon les formulaires ne marchent pas...
-	if ($_SERVER['REQUEST_METHOD'] == 'POST') {
-		include_local('inc-calcul.php3');
-		$contexte_inclus = array_merge(calculer_contexte(), $contexte_inclus);
-	}
-
-	$page = obtenir_page ($contexte_inclus, $chemin_cache, $delais_inclus,
-	$use_cache, $fond, true);
-
-	$page['lang_select'] = $lang_select;
-
-	// Retourner le contenu...
-	return $page;
-}
-
-// equivalente a texte_script dans inc_filtre.
-
-function securise_script($texte) {
-	return str_replace('\'', '\\\'', str_replace('\\', '\\\\', $texte));
-}
-
-# les balises dynamiques sont traitees comme des inclusions
-
-function synthetiser_balise_dynamique($nom, $args, $file, $lang) {
-	return
-		('&lt;'.'?php 
-include_ecrire(\'inc_lang.php3\');
-lang_select(&quot;'.$lang.'&quot;);
-include_local(&quot;'
-		. $file
-		. '&quot;);
-inclure_balise_dynamique(balise_'
-		. $nom
-		. '_dyn(\''
-		. join(&quot;', '&quot;, array_map(&quot;securise_script&quot;, $args))
-		. '\'));
-	lang_dselect();
-?'
-		.&quot;&gt;&quot;);
-}
-
-# Attention, un appel explicite a cette fonction suppose certains include
-# (voir l'exemple de spip_inscription et spip_pass)
-
-function inclure_balise_dynamique($r) {
-	if (is_string($r))
-		echo $r;
-	else {
-		list($fond, $delais, $contexte_inclus) = $r;
-
-		if ((!$contexte_inclus['lang']) AND
-		($GLOBALS['spip_lang'] != lire_meta('langue_site')))
-			$contexte_inclus['lang'] = $GLOBALS['spip_lang'];
-
-
-		// Appeler la page
-		$page = inclure_page($fond, $delais, $contexte_inclus);
-		if ($page['process_ins'] == 'html')
-			echo $page['texte'];
-		else
-			eval('?' . '&gt;' . $page['texte']);
-
-		if ($page['lang_select'])
-			lang_dselect();
-
-	}
-}
-
-
-function message_erreur_404 () {
-	if ($GLOBALS['id_article'])
-		$erreur = 'aucun_article';
-	else if ($GLOBALS['id_rubrique'])
-		$erreur = 'aucune_rubrique';
-	else if ($GLOBALS['id_breve'])
-		$erreur = 'aucune_breve';
-	else if ($GLOBALS['id_auteur'])
-		$erreur = 'aucun_auteur';
-	else if ($GLOBALS['id_syndic'])
-		$erreur = 'aucun_site';
-	else
-		$erreur = '';
-
-	return _T(&quot;public:&quot;.$erreur);
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_PUBLIC_GLOBAL&quot;)) return;
+define(&quot;_INC_PUBLIC_GLOBAL&quot;, &quot;1&quot;);
+
+// fonction principale declenchant tout le service
+function calcule_header_et_page ($fond, $delais) {
+	  global $affiche_boutons_admin, $auteur_session, $flag_dynamique,
+	  $flag_ob, $flag_preserver, $forcer_lang, $ignore_auth_http,
+	  $lastmodified, $recherche, $use_cache, $var_confirm, $var_mode,
+	  $var_recherche, $tableau_des_erreurs;
+	  global $_GET, $_POST;
+
+	// Regler le $delais par defaut
+	if (!isset($delais))
+		$delais = 1 * 3600;
+	if ($recherche)
+		$delais = 0;
+
+	// authentification du visiteur
+	if ($GLOBALS['_COOKIE']['spip_session'] OR
+	($GLOBALS['_SERVER']['PHP_AUTH_USER']  AND !$ignore_auth_http)) {
+		include_ecrire (&quot;inc_session.php3&quot;);
+		verifier_visiteur();
+	}
+	// multilinguisme
+	if ($forcer_lang AND ($forcer_lang!=='non') AND !count($_POST)) {
+		include_ecrire('inc_lang.php3');
+		verifier_lang_url();
+	}
+	if ($_GET['lang']) {
+		include_ecrire('inc_lang.php3');
+		lang_select($_GET['lang']);
+	}
+
+	// Si envoi pour un forum, enregistrer puis rediriger
+
+	if (strlen($_POST['confirmer_forum']) &gt; 0
+	OR ($_POST['afficher_texte']=='non'
+		AND $_POST['ajouter_mot'])) {
+		include('inc-messforum.php3');
+		redirige_par_entete(enregistre_forum());
+	}
+
+	// si signature de petition, l'enregistrer avant d'afficher la page
+	// afin que celle-ci contienne la signature
+
+	if ($_GET['var_confirm']) {
+		include_local(find_in_path('inc-formulaire_signature.php3'));
+		reponse_confirmation($_GET['id_article'], $var_confirm);
+	}
+
+	//  refus du debug si pas dans les options generales ni admin connecte
+	if ($var_mode=='debug') {
+		if (($GLOBALS['code_activation_debug'] == 'oui')
+		OR $auteur_session['statut'] == '0minirezo')
+			spip_log('debug !');
+		else
+			$var_mode = false; 
+	}
+
+	// est-on admin ?
+	if ($affiche_boutons_admin = (!$flag_preserver
+	AND ($GLOBALS['_COOKIE']['spip_admin']
+	OR $GLOBALS['_COOKIE']['spip_debug'])))
+		include_local(find_in_path('inc-formulaire_admin.php3'));
+		# attention, cet include ne considere pas forcement le
+		# $dossier_squelettes defini dans mes_fonctions.php3, mais si
+		# on incluait mes_fonctions.php3 on masquerait au webmestre l'erreur,
+		# courante, qui est de croire que ce fichier est toujours inclus.
+
+
+	$tableau_des_erreurs = array();
+	$page = afficher_page_globale ($fond, $delais, $use_cache);
+
+	//
+	// Envoyer les entetes appropries
+	// a condition d'etre sur de pouvoir le faire
+	//
+	if (!$flag_preserver
+	AND $flag_ob AND !headers_sent()) {
+
+		// Si la page est vide, gerer l'erreur 404
+		if (preg_match('/^[[:space:]]*$/', $page['texte'])
+		AND $var_mode != 'debug') {
+			header(&quot;HTTP/1.0 404&quot;);
+			header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+			$contexte_inclus = array(
+				'erreur_aucun' =&gt; message_erreur_404()
+			);
+			include(find_in_path('404.php3'));
+		}
+		// Interdire au client de cacher un login, un admin ou un recalcul
+		else if ($flag_dynamique OR $var_mode
+		OR $GLOBALS['_COOKIE']['spip_admin']) {
+			header(&quot;Cache-Control: no-cache,must-revalidate&quot;);
+			header(&quot;Pragma: no-cache&quot;);
+		}
+		// Pour les autres donner l'heure de modif
+		else if ($lastmodified) {
+			header(&quot;Last-Modified: &quot;.http_gmoddate($lastmodified).&quot; GMT&quot;);
+			header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+		}
+	}
+
+	return $page;
+}
+
+
+//
+// Aller chercher la page dans le cache ou pas
+//
+function obtenir_page ($contexte, $chemin_cache, $delais, &amp;$use_cache, $fond, $inclusion=false) {
+	global $lastmodified;
+
+	if (!$use_cache) {
+		include_local('inc-calcul.php3');
+
+		// page globale ? calculer le contexte
+		if (!$contexte)
+			$contexte = calculer_contexte();
+
+		spip_timer('calculer_page');
+		$page = calculer_page($chemin_cache,
+			array('fond' =&gt; $fond,
+				'contexte' =&gt; $contexte),
+			$delais,
+			$inclusion);
+
+		$lastmodified = time();
+
+		// log
+		if (!$log = $chemin_cache) $log = &quot;($fond, delais=$delais, &quot;
+		. $GLOBALS['_SERVER']['REQUEST_METHOD'].&quot;)&quot;;
+		spip_log (($inclusion ? 'calcul inclus':'calcul').' ('
+		.spip_timer('calculer_page').&quot;): $log&quot;);
+
+		// Nouveau cache : creer un invalideur 't' fixant la date
+		// d'expiration et la taille du fichier
+		if (@file_exists($chemin_cache)) {
+			// Ici on ajoute 3600s pour eviter toute concurrence
+			// entre un invalideur et un appel public de page
+			$bedtime = time() + $delais + 3600;
+			$taille = @filesize($chemin_cache);
+			$fichier = addslashes($chemin_cache);
+			spip_query(&quot;INSERT IGNORE INTO spip_caches (fichier,id,type,taille)
+			VALUES ('$fichier','$bedtime','t','$taille')&quot;);
+		}
+
+	} else {
+
+		//
+		// Lire le fichier cache
+		//
+		lire_fichier ($chemin_cache, $page['texte']);
+		$lastmodified = max($lastmodified, @filemtime($chemin_cache));
+		# spip_log (&quot;cache $chemin_cache $lastmodified&quot;);
+
+		//
+		// Lire sa carte d'identite &amp; fixer le contexte global
+		//
+		if (preg_match(&quot;/^&lt;!-- ([^\n]*) --&gt;\n(.*)/ms&quot;, $page['texte'], $match)
+		AND is_array($meta_donnees = unserialize($match[1]))) {
+			foreach ($meta_donnees as $var=&gt;$val)
+				$page[$var] = $val;
+
+			$page['texte'] = $match[2];
+
+			// Remplir les globals pour les boutons d'admin
+			if (!$inclusion AND is_array($page['contexte']))
+				foreach ($page['contexte'] as $var=&gt;$val)
+					$GLOBALS[$var] = $val;
+		}
+
+	}
+
+	return $page;
+}
+
+
+//
+// Appeler cette fonction pour obtenir la page principale
+//
+function afficher_page_globale ($fond, $delais, &amp;$use_cache) {
+	global $flag_preserver, $flag_dynamique, $lastmodified;
+	global $var_preview, $var_mode;
+	include_local (&quot;inc-cache.php3&quot;);
+
+	// demande de previsualisation ?
+	// -&gt; inc-calcul.php3 n'enregistrera pas les fichiers caches
+	// -&gt; inc-reqsql-squel.php3 acceptera les objets non 'publie'
+	if ($var_mode == 'preview') {
+		// Verifier qu'on a le droit de previsualisation
+		$statut = $GLOBALS['auteur_session']['statut'];
+		if ($statut=='0minirezo' OR
+		(lire_meta('preview')=='1comite' AND $statut=='1comite')) {
+			$var_mode = 'recalcul';
+			$delais = 0;
+			$var_preview = true;
+			spip_log('preview !');
+		} else
+			$var_preview = false;
+	}
+
+	// Faut-il effacer des pages invalidees ?
+	if (lire_meta('invalider')) {
+		include_ecrire('inc_meta.php3');
+		lire_metas();
+		if (lire_meta('invalider'))
+			retire_caches();
+	}
+
+	// Calculer le chemin putatif du cache
+	$chemin_cache = generer_nom_fichier_cache('', $fond);
+
+	// Peut-on utiliser un fichier cache ?
+	determiner_cache($delais, $use_cache, $chemin_cache);
+
+	// Repondre gentiment aux requetes sympas
+	// (ici on ne tient pas compte d'une obsolence du cache ou des
+	// eventuels fichiers inclus modifies depuis la date
+	// HTTP_IF_MODIFIED_SINCE du client)
+	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE'] AND !$var_mode
+	AND $chemin_cache AND !$flag_dynamique) {
+		$lastmodified = @filemtime($chemin_cache);
+		$headers_only = http_last_modified($lastmodified);
+	}
+	$headers_only |= ($GLOBALS['_SERVER']['REQUEST_METHOD'] == 'HEAD');
+
+	if ($headers_only) {
+		if ($chemin_cache)
+			$t = @filemtime($chemin_cache);
+		else
+			$t = time();
+		@header('Last-Modified: '.http_gmoddate($t).' GMT');
+		@header('Connection: close');
+		// Pas de bouton admin pour un HEAD
+		$flag_preserver = true;
+	}
+	else {
+		// Obtenir la page
+		$page = obtenir_page ('', $chemin_cache, $delais, $use_cache,
+		$fond, false);
+
+		if (!$flag_preserver) {
+		// Entete content-type: xml ou html ; charset
+			if ($xhtml) {
+			// Si Mozilla et tidy actif, passer en &quot;application/xhtml+xml&quot;
+			// extremement risque: Mozilla passe en mode debugueur strict
+			// mais permet d'afficher du MathML directement dans le texte
+			// (et sauf erreur, c'est la bonne facon de declarer du xhtml)
+				include_ecrire(&quot;inc_tidy.php&quot;);
+				if (version_tidy() &gt; 0) {
+					if (ereg(&quot;application/xhtml\+xml&quot;, $GLOBALS['HTTP_ACCEPT'])) 
+						@header(&quot;Content-Type: application/xhtml+xml; charset=&quot;.lire_meta('charset'));
+					else 
+						@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+					echo '&lt;'.'?xml version=&quot;1.0&quot; encoding=&quot;'. lire_meta('charset').'&quot;?'.&quot;&gt;\n&quot;;
+				} else {
+					@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+				}
+			} else {
+				@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+			}
+		}
+	}
+
+	if ($chemin_cache) $page['cache'] = $chemin_cache;
+
+	if ($var_preview AND !$flag_preserver) {
+		include_ecrire('inc_lang.php3');
+		include_ecrire('inc_filtres.php3');
+		lang_select($GLOBALS['auteur_session']['lang']);
+		$page['texte'] .= '&lt;div style=&quot;
+		display: block;
+		color: #eeeeee;
+		background-color: #111111;
+		padding-right: 5px;
+		padding-top: 2px;
+		padding-bottom: 5px;
+		font-size: 20px;
+		top: 0px;
+		left: 0px;
+		position: absolute;
+		&quot;&gt;&lt;img src=&quot;' . _DIR_IMG_PACK
+		. 'naviguer-site.png&quot; align=&quot;left&quot; border=&quot;0&quot; /&gt;&nbsp; '
+		. majuscules(_T('previsualisation')).'&lt;/div&gt;';
+	}
+
+	return $page;
+}
+
+
+function terminer_public_global() {
+
+	// Gestion des statistiques du site public
+	if (lire_meta(&quot;activer_statistiques&quot;) != &quot;non&quot;) {
+		include_local (&quot;inc-stats.php3&quot;);
+		ecrire_stats();
+	}
+
+	// Effectuer une tache de fond ?
+	cron();
+}
+
+
+function inclure_page($fond, $delais_inclus, $contexte_inclus, $cache_incluant='') {
+
+	$contexte_inclus['fond'] = $fond;
+
+	$chemin_cache = generer_nom_fichier_cache($contexte_inclus, $fond);
+
+	// Peut-on utiliser un fichier cache ?
+	determiner_cache($delais_inclus, $use_cache, $chemin_cache);
+
+	// Si on a inclus sans fixer le critere de lang, de deux choses l'une :
+	// - on est dans la langue du site, et pas besoin d'inclure inc_lang
+	// - on n'y est pas, et alors il faut revenir dans la langue par defaut
+	if (($lang = $contexte_inclus['lang'])
+	|| ($GLOBALS['spip_lang'] != ($lang = lire_meta('langue_site')))) {
+		include_ecrire('inc_lang.php3');
+		lang_select($lang);
+		$lang_select = true; // pour lang_dselect en sortie
+	}
+	
+	$page = obtenir_page ($contexte_inclus, $chemin_cache, $delais_inclus,
+	$use_cache, $fond, true);
+
+	$page['lang_select'] = $lang_select;
+
+	// Retourner le contenu...
+	return $page;
+}
+
+
+# Attention, un appel explicite a cette fonction suppose certains include
+# (voir l'exemple de spip_inscription et spip_pass)
+# $r = complexe (fond, delais, contexte) ; $echo = faut-il faire echo ou return
+function inclure_balise_dynamique($r, $echo=true) {
+	if (is_string($r))
+		if ($echo)
+			echo $r;
+		else
+			return $r;
+	else {
+		list($fond, $delais, $contexte_inclus) = $r;
+
+		if ((!$contexte_inclus['lang']) AND
+		($GLOBALS['spip_lang'] != lire_meta('langue_site')))
+			$contexte_inclus['lang'] = $GLOBALS['spip_lang'];
+
+
+		// Appeler la page
+		$page = inclure_page($fond, $delais, $contexte_inclus);
+
+		if ($page['process_ins'] == 'html') {
+			if ($echo)
+				echo $page['texte'];
+			else
+				$texte = $page['texte'];
+		} else {
+			if ($echo)
+				eval('?' . '&gt;' . $page['texte']);
+			else {
+				ob_start();
+				eval('?' . '&gt;' . $page['texte']);
+				$texte = ob_get_contents();
+				ob_end_clean();
+			}
+		}
+
+		if ($page['lang_select'])
+			lang_dselect();
+
+		return $texte;
+	}
+}
+
+
+function message_erreur_404 () {
+	if ($GLOBALS['id_article'])
+		$erreur = 'aucun_article';
+	else if ($GLOBALS['id_rubrique'])
+		$erreur = 'aucune_rubrique';
+	else if ($GLOBALS['id_breve'])
+		$erreur = 'aucune_breve';
+	else if ($GLOBALS['id_auteur'])
+		$erreur = 'aucun_auteur';
+	else if ($GLOBALS['id_syndic'])
+		$erreur = 'aucun_site';
+	else
+		$erreur = '';
+
+	return _T(&quot;public:&quot;.$erreur);
+}
+
+// Renvoie le _GET ou le _POST emis par l'utilisateur
+function _request($var) {
+	global $_GET, $_POST;
+	if (isset($_GET[$var])) return $_GET[$var];
+	if (isset($_POST[$var])) return $_POST[$var];
+	return NULL;
+}
+
+?&gt;

Index: inc-urls-propres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-urls-propres.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- inc-urls-propres.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ inc-urls-propres.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,172 +1,183 @@
-&lt;?php
-
-// executer une seule fois
-if (defined(&quot;_INC_URLS2&quot;)) return;
-define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
-
-
-/*
-
-- Comment utiliser ce jeu d'URLs ?
-
-Il faut recopier le fichier htaccess-propres.txt sous le nom .htaccess
-dans le repertoire de base du site SPIP (attention a ne pas ecraser
-d'autres reglages que vous pourriez avoir mis dans ce fichier)
-
-*/
-
-
-function _generer_url_propre($type, $id_objet) {
-	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
-	$col_id = &quot;id_&quot;.$type;
-
-	// D'abord, essayer de recuperer l'URL existante si possible
-	$query = &quot;SELECT url_propre, titre FROM $table WHERE $col_id=$id_objet&quot;;
-	$result = spip_query($query);
-	if (!($row = spip_fetch_array($result))) return &quot;&quot;;
-	if ($row['url_propre']) return $row['url_propre'];
-
-	// Sinon, creer l'URL
-	include_ecrire(&quot;inc_filtres.php3&quot;);
-	include_ecrire(&quot;inc_charsets.php3&quot;);
-	$url = translitteration(corriger_caracteres(
-		supprimer_tags(supprimer_numero(extraire_multi($row['titre'])))
-		));
-	$url = @preg_replace(',[[:punct:][:space:]]+,u', ' ', $url);
-	// S'il reste des caracteres non latins, utiliser l'id a la place
-	if (preg_match(&quot;,[^a-zA-Z0-9 ],&quot;, $url)) {
-		$url = $type.$id_objet;
-	}
-	else {
-		$mots = explode(' ', $url);
-		$url = '';
-		foreach ($mots as $mot) {
-			if (!$mot) continue;
-			$url2 = $url.'-'.$mot;
-			if (strlen($url2) &gt; 35) {
-				break;
-			}
-			$url = $url2;
-		}
-		$url = substr($url, 1);
-		//echo &quot;$url&lt;br&gt;&quot;;
-		if (strlen($url) &lt; 2) $url = $type.$id_objet;
-	}
-
-	// Verifier les eventuels doublons et mettre a jour
-	$lock = &quot;url $type $id_objet&quot;;
-	spip_get_lock($lock, 10);
-	$query = &quot;SELECT $col_id FROM $table
-		WHERE url_propre='&quot;.addslashes($url).&quot;'&quot;;
-	if (spip_num_rows(spip_query($query)) &gt; 0) {
-		$url = $url.','.$id_objet;
-	}
-	$query = &quot;UPDATE $table SET url_propre='&quot;.addslashes($url).&quot;' WHERE $col_id=$id_objet&quot;;
-	spip_query($query);
-	spip_release_lock($lock);
-
-	return $url;
-}
-
-function generer_url_article($id_article) {
-	$url = _generer_url_propre('article', $id_article);
-	if (!$url) $url = &quot;article.php3?id_article=$id_article&quot;;
-	return $url;
-}
-
-function generer_url_rubrique($id_rubrique) {
-	$url = _generer_url_propre('rubrique', $id_rubrique);
-	if (!$url) $url = &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
-	else $url = '-'.$url.'-';
-	return $url;
-}
-
-function generer_url_breve($id_breve) {
-	$url = _generer_url_propre('breve', $id_breve);
-	if (!$url) $url = &quot;breve.php3?id_breve=$id_breve&quot;;
-	else $url = '+'.$url.'+';
-	return $url;
-}
-
-function generer_url_forum($id_forum) {
-	return &quot;forum.php3?id_forum=$id_forum&quot;;
-}
-
-function generer_url_mot($id_mot) {
-	$url = _generer_url_propre('mot', $id_mot);
-	if (!$url) $url = &quot;mot.php3?id_mot=$id_mot&quot;;
-	else $url = '+-'.$url.'-+';
-	return $url;
-}
-
-function generer_url_auteur($id_auteur) {
-	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
-}
-
-function generer_url_document($id_document) {
-	if (intval($id_document) &lt;= 0)
-		return '';
-	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
-		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
-	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
-		return ($row['fichier']);
-	return '';
-}
-
-function recuperer_parametres_url($fond, $url) {
-	global $contexte;
-
-	// Migration depuis anciennes URLs ?
-	if ($GLOBALS['_SERVER']['REQUEST_METHOD'] != 'POST' &amp;&amp;
-		preg_match(',(^|/)((article|breve|rubrique|mot)\.php3?([\?&amp;].*)?)$,', $url, $regs)) {
-		$type = $regs[3];
-		$id_objet = intval($GLOBALS['id_'.$type]);
-		if ($id_objet) {
-			$func = &quot;generer_url_$type&quot;;
-			$url_propre = $func($id_objet);
-			if ($url_propre
-			AND ($url_propre&lt;&gt;$regs[2])) {
-				http_status(301);
-				Header(&quot;Location: $url_propre&quot;);
-				exit;
-			}
-		}
-		return;
-	}
-
-	$url_propre = $GLOBALS['_SERVER']['REDIRECT_url_propre'];
-	if (!$url_propre) $url_propre = $GLOBALS['HTTP_ENV_VARS']['url_propre'];
-	if (!$url_propre) $url_propre = substr($url, strrpos($url, '/') + 1);
-	if (!$url_propre) return;
-
-	// Detecter les differents types d'objets demandes
-	if (preg_match(',^\+-(.*)-\+$,', $url_propre, $regs)) {
-		$type = 'mot';
-		$url_propre = $regs[1];
-	}
-	else if (preg_match(',^-(.*)-$,', $url_propre, $regs)) {
-		$type = 'rubrique';
-		$url_propre = $regs[1];
-	}
-	else if (preg_match(',^\+(.*)\+$,', $url_propre, $regs)) {
-		$type = 'breve';
-		$url_propre = $regs[1];
-	}
-	else {
-		$type = 'article';
-	}
-
-	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
-	$col_id = &quot;id_&quot;.$type;
-	$query = &quot;SELECT $col_id FROM $table
-		WHERE url_propre='&quot;.addslashes($url_propre).&quot;'&quot;;
-	$result = spip_query($query);
-	if (spip_num_rows($result) == 1) {
-		$row = spip_fetch_array($result);
-		$contexte[$col_id] = $row[$col_id];
-	}
-
-	return;
-}
-
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+// executer une seule fois
+if (defined(&quot;_INC_URLS2&quot;)) return;
+define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
+
+
+/*
+
+- Comment utiliser ce jeu d'URLs ?
+
+Il faut recopier le fichier htaccess-propres.txt sous le nom .htaccess
+dans le repertoire de base du site SPIP (attention a ne pas ecraser
+d'autres reglages que vous pourriez avoir mis dans ce fichier)
+
+*/
+
+
+function _generer_url_propre($type, $id_objet) {
+	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
+	$col_id = &quot;id_&quot;.$type;
+
+	// D'abord, essayer de recuperer l'URL existante si possible
+	$query = &quot;SELECT url_propre, titre FROM $table WHERE $col_id=$id_objet&quot;;
+	$result = spip_query($query);
+	if (!($row = spip_fetch_array($result))) return &quot;&quot;;
+	if ($row['url_propre']) return $row['url_propre'];
+
+	// Sinon, creer l'URL
+	include_ecrire(&quot;inc_filtres.php3&quot;);
+	include_ecrire(&quot;inc_charsets.php3&quot;);
+	$url = translitteration(corriger_caracteres(
+		supprimer_tags(supprimer_numero(extraire_multi($row['titre'])))
+		));
+	$url = @preg_replace(',[[:punct:][:space:]]+,u', ' ', $url);
+	// S'il reste des caracteres non latins, utiliser l'id a la place
+	if (preg_match(&quot;,[^a-zA-Z0-9 ],&quot;, $url)) {
+		$url = $type.$id_objet;
+	}
+	else {
+		$mots = explode(' ', $url);
+		$url = '';
+		foreach ($mots as $mot) {
+			if (!$mot) continue;
+			$url2 = $url.'-'.$mot;
+			if (strlen($url2) &gt; 35) {
+				break;
+			}
+			$url = $url2;
+		}
+		$url = substr($url, 1);
+		//echo &quot;$url&lt;br&gt;&quot;;
+		if (strlen($url) &lt; 2) $url = $type.$id_objet;
+	}
+
+	// Verifier les eventuels doublons et mettre a jour
+	$lock = &quot;url $type $id_objet&quot;;
+	spip_get_lock($lock, 10);
+	$query = &quot;SELECT $col_id FROM $table
+		WHERE url_propre='&quot;.addslashes($url).&quot;'&quot;;
+	if (spip_num_rows(spip_query($query)) &gt; 0) {
+		$url = $url.','.$id_objet;
+	}
+	$query = &quot;UPDATE $table SET url_propre='&quot;.addslashes($url).&quot;' WHERE $col_id=$id_objet&quot;;
+	spip_query($query);
+	spip_release_lock($lock);
+
+	return $url;
+}
+
+function generer_url_article($id_article) {
+	$url = _generer_url_propre('article', $id_article);
+	if (!$url) $url = &quot;article.php3?id_article=$id_article&quot;;
+	return $url;
+}
+
+function generer_url_rubrique($id_rubrique) {
+	$url = _generer_url_propre('rubrique', $id_rubrique);
+	if (!$url) $url = &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
+	else $url = '-'.$url.'-';
+	return $url;
+}
+
+function generer_url_breve($id_breve) {
+	$url = _generer_url_propre('breve', $id_breve);
+	if (!$url) $url = &quot;breve.php3?id_breve=$id_breve&quot;;
+	else $url = '+'.$url.'+';
+	return $url;
+}
+
+function generer_url_forum($id_forum) {
+	return &quot;forum.php3?id_forum=$id_forum&quot;;
+}
+
+function generer_url_mot($id_mot) {
+	$url = _generer_url_propre('mot', $id_mot);
+	if (!$url) $url = &quot;mot.php3?id_mot=$id_mot&quot;;
+	else $url = '+-'.$url.'-+';
+	return $url;
+}
+
+function generer_url_auteur($id_auteur) {
+	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
+}
+
+function generer_url_document($id_document) {
+	if (intval($id_document) &lt;= 0)
+		return '';
+	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
+		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
+	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
+		return ($row['fichier']);
+	return '';
+}
+
+function recuperer_parametres_url($fond, $url) {
+	global $contexte;
+
+	// Migration depuis anciennes URLs ?
+	if ($GLOBALS['_SERVER']['REQUEST_METHOD'] != 'POST' &amp;&amp;
+		preg_match(',(^|/)((article|breve|rubrique|mot)\.php3?([\?&amp;].*)?)$,', $url, $regs)) {
+		$type = $regs[3];
+		$id_objet = intval($GLOBALS['id_'.$type]);
+		if ($id_objet) {
+			$func = &quot;generer_url_$type&quot;;
+			$url_propre = $func($id_objet);
+			if ($url_propre
+			AND ($url_propre&lt;&gt;$regs[2])) {
+				http_status(301);
+				Header(&quot;Location: $url_propre&quot;);
+				exit;
+			}
+		}
+		return;
+	}
+
+	$url_propre = $GLOBALS['_SERVER']['REDIRECT_url_propre'];
+	if (!$url_propre) $url_propre = $GLOBALS['HTTP_ENV_VARS']['url_propre'];
+	if (!$url_propre) $url_propre = substr($url, strrpos($url, '/') + 1);
+	if (!$url_propre) return;
+
+	// Detecter les differents types d'objets demandes
+	if (preg_match(',^\+-(.*)-\+$,', $url_propre, $regs)) {
+		$type = 'mot';
+		$url_propre = $regs[1];
+	}
+	else if (preg_match(',^-(.*)-$,', $url_propre, $regs)) {
+		$type = 'rubrique';
+		$url_propre = $regs[1];
+	}
+	else if (preg_match(',^\+(.*)\+$,', $url_propre, $regs)) {
+		$type = 'breve';
+		$url_propre = $regs[1];
+	}
+	else {
+		$type = 'article';
+	}
+
+	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
+	$col_id = &quot;id_&quot;.$type;
+	$query = &quot;SELECT $col_id FROM $table
+		WHERE url_propre='&quot;.addslashes($url_propre).&quot;'&quot;;
+	$result = spip_query($query);
+	if (spip_num_rows($result) == 1) {
+		$row = spip_fetch_array($result);
+		$contexte[$col_id] = $row[$col_id];
+	}
+
+	return;
+}
+
 ?&gt;

Index: spip_test_dirs.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_test_dirs.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_test_dirs.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_test_dirs.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,106 +1,117 @@
-&lt;?php
-if (defined(&quot;_TEST_DIRS&quot;)) return;
-define(&quot;_TEST_DIRS&quot;, &quot;1&quot;);
-
-include(&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_presentation.php3&quot;);
-
-utiliser_langue_visiteur();
-
-
-//
-// Tente d'ecrire
-//
-function test_ecrire($my_dir) {
-	$ok = true;
-	$nom_fich = &quot;$my_dir/test.txt&quot;;
-	$f = @fopen($nom_fich, &quot;w&quot;);
-	if (!$f) $ok = false;
-	else if (!@fclose($f)) $ok = false;
-	else if (!@unlink($nom_fich)) $ok = false;
-	return $ok;
-}
-
-//
-// teste les droits sur les repertoires $test_dirs declares dans inc_version
-//
-
-// rajouter celui passer dans l'url ou celui du source (a l'installation)
-
-if ($test_dir) {
-  if (!ereg(&quot;/$&quot;, $test_dir)) $test_dir .= '/';
-  if (!in_array($test_dir, $test_dirs)) $test_dirs[] = $test_dir;
- }
-else {
-	if (!_FILE_CONNECT)
-	  $test_dirs[] = dirname(_FILE_CONNECT_INS);
-}
-
-unset($bad_dirs);
-unset($absent_dirs);
-
-while (list(, $my_dir) = each($test_dirs)) {
-	if (!test_ecrire($my_dir)) {
-		@umask(0);
-		if (@file_exists($my_dir)) {
-			@chmod($my_dir, 0777);
-			// ???
-			if (!test_ecrire($my_dir))
-				@chmod($my_dir, 0775);
-			if (!test_ecrire($my_dir))
-				@chmod($my_dir, 0755);
-			if (!test_ecrire($my_dir))
-				$bad_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
-		} else
-			$absent_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
-	}
-}
-
-if ($bad_dirs OR $absent_dirs) {
-	install_debut_html();
-
-	if (!_FILE_CONNECT) {
-		$titre = _T('dirs_preliminaire');
-		$continuer = ' '._T('dirs_commencer');
-	} else
-		$titre = _T('dirs_probleme_droits');
-
-	$bad_url = &quot;spip_test_dirs.php3&quot;;
-	if ($test_dir) $bad_url .= '?test_dir='.$test_dir;
-
-	echo &quot;&lt;FONT FACE=\&quot;Verdana,Arial,Helvetica,sans-serif\&quot; SIZE=3&gt;$titre&lt;/FONT&gt;\n&lt;p&gt;&quot;;
-	echo &quot;&lt;div align='right'&gt;&quot;. menu_langues('var_lang_ecrire').&quot;&lt;/div&gt;\n&quot;;
-
-	if ($bad_dirs) {
-		echo &quot;&lt;p&gt;&quot;;
-		echo _T('dirs_repertoires_suivants',
-			array('bad_dirs' =&gt; join(&quot; &quot;, $bad_dirs)));
-		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
-	}
-
-	if ($absent_dirs) {
-		echo &quot;&lt;p&gt;&quot;;
-		echo _T('dirs_repertoires_absents',
-			array('bad_dirs' =&gt; join(&quot; &quot;, $absent_dirs)));
-		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
-	}
-
-	echo $continuer.'. ';
-	echo aide (&quot;install0&quot;);
-	echo &quot;&lt;p&gt;&quot;;
-
-	echo &quot;&lt;FORM ACTION='$bad_urls' METHOD='GET'&gt;\n&quot;;
-	echo &quot;&lt;DIV align='right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl' VALUE='&quot;. _T('login_recharger').&quot;'&gt;&lt;/DIV&gt;&quot;;
-	echo &quot;&lt;/FORM&gt;&quot;;
-
-	install_fin_html();
-
-} else {
-	if (!_FILE_CONNECT)
-		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS . &quot;install.php3?etape=1&quot;);
-	else
-		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS);
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+if (defined(&quot;_TEST_DIRS&quot;)) return;
+define(&quot;_TEST_DIRS&quot;, &quot;1&quot;);
+
+include(&quot;ecrire/inc_version.php3&quot;);
+
+include_ecrire(&quot;inc_presentation.php3&quot;);
+
+utiliser_langue_visiteur();
+
+
+//
+// Tente d'ecrire
+//
+function test_ecrire($my_dir) {
+	$ok = true;
+	$nom_fich = &quot;$my_dir/test.txt&quot;;
+	$f = @fopen($nom_fich, &quot;w&quot;);
+	if (!$f) $ok = false;
+	else if (!@fclose($f)) $ok = false;
+	else if (!@unlink($nom_fich)) $ok = false;
+	return $ok;
+}
+
+//
+// teste les droits sur les repertoires $test_dirs declares dans inc_version
+//
+
+// rajouter celui passer dans l'url ou celui du source (a l'installation)
+
+if ($test_dir) {
+  if (!ereg(&quot;/$&quot;, $test_dir)) $test_dir .= '/';
+  if (!in_array($test_dir, $test_dirs)) $test_dirs[] = $test_dir;
+ }
+else {
+	if (!_FILE_CONNECT)
+	  $test_dirs[] = dirname(_FILE_CONNECT_INS);
+}
+
+unset($bad_dirs);
+unset($absent_dirs);
+
+while (list(, $my_dir) = each($test_dirs)) {
+	if (!test_ecrire($my_dir)) {
+		@umask(0);
+		if (@file_exists($my_dir)) {
+			@chmod($my_dir, 0777);
+			// ???
+			if (!test_ecrire($my_dir))
+				@chmod($my_dir, 0775);
+			if (!test_ecrire($my_dir))
+				@chmod($my_dir, 0755);
+			if (!test_ecrire($my_dir))
+				$bad_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
+		} else
+			$absent_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
+	}
+}
+
+if ($bad_dirs OR $absent_dirs) {
+	install_debut_html();
+
+	if (!_FILE_CONNECT) {
+		$titre = _T('dirs_preliminaire');
+		$continuer = ' '._T('dirs_commencer');
+	} else
+		$titre = _T('dirs_probleme_droits');
+
+	$bad_url = &quot;spip_test_dirs.php3&quot;;
+	if ($test_dir) $bad_url .= '?test_dir='.$test_dir;
+
+	echo &quot;&lt;FONT FACE=\&quot;Verdana,Arial,Helvetica,sans-serif\&quot; SIZE=3&gt;$titre&lt;/FONT&gt;\n&lt;p&gt;&quot;;
+	echo &quot;&lt;div align='right'&gt;&quot;. menu_langues('var_lang_ecrire').&quot;&lt;/div&gt;\n&quot;;
+
+	if ($bad_dirs) {
+		echo &quot;&lt;p&gt;&quot;;
+		echo _T('dirs_repertoires_suivants',
+			array('bad_dirs' =&gt; join(&quot; &quot;, $bad_dirs)));
+		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
+	}
+
+	if ($absent_dirs) {
+		echo &quot;&lt;p&gt;&quot;;
+		echo _T('dirs_repertoires_absents',
+			array('bad_dirs' =&gt; join(&quot; &quot;, $absent_dirs)));
+		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
+	}
+
+	echo $continuer.'. ';
+	echo aide (&quot;install0&quot;);
+	echo &quot;&lt;p&gt;&quot;;
+
+	echo &quot;&lt;FORM ACTION='$bad_urls' METHOD='GET'&gt;\n&quot;;
+	echo &quot;&lt;DIV align='right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl' VALUE='&quot;. _T('login_recharger').&quot;'&gt;&lt;/DIV&gt;&quot;;
+	echo &quot;&lt;/FORM&gt;&quot;;
+
+	install_fin_html();
+
+} else {
+	if (!_FILE_CONNECT)
+		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS . &quot;install.php3?etape=1&quot;);
+	else
+		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS);
+}
+
+?&gt;

Index: spip_cookie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cookie.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- spip_cookie.php3	8 Feb 2005 15:10:10 -0000	1.2
+++ spip_cookie.php3	20 Feb 2005 22:16:48 -0000	1.3
@@ -1,238 +1,238 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire (&quot;inc_session.php3&quot;);
-
-
-// gerer l'auth http
-function auth_http($url, $essai_auth_http) {
-	global $_SERVER;
-	if ($essai_auth_http == 'oui') {
-		if (verifier_php_auth())
-			redirige_par_entete($url);
-		else {
-			$url = quote_amp(urlencode($url));
-			ask_php_auth(_T('login_connexion_refusee'),
-			_T('login_login_pass_incorrect'), _T('login_retour_site'),
-			&quot;url=$url&quot;, _T('login_nouvelle_tentative'),
-			(ereg(_DIR_RESTREINT_ABS, $url)));
-			exit;
-		}
-	}
-	// si demande logout auth_http
-	else if ($essai_auth_http == 'logout') {
-		ask_php_auth(_T('login_deconnexion_ok'),
-		_T('login_verifiez_navigateur'), _T('login_retour_public'),
-		&quot;redirect=&quot;._DIR_RESTREINT_ABS, _T('login_test_navigateur'), true);
-		exit;
-	}
-}
-
-// rejoue le cookie pour renouveler spip_session
-if ($change_session == 'oui') {
-	if (verifier_session($spip_session)) {
-		// Attention : seul celui qui a le bon IP a le droit de rejouer,
-		// ainsi un eventuel voleur de cookie ne pourrait pas deconnecter
-		// sa victime, mais se ferait deconnecter par elle.
-		if ($auteur_session['hash_env'] == hash_env()) {
-			$auteur_session['ip_change'] = false;
-			$cookie = creer_cookie_session($auteur_session);
-			supprimer_session($spip_session);
-			spip_setcookie('spip_session', $cookie);
-		}
-		@header('Content-Type: image/gif');
-		@header('Expires: 0');
-		@header(&quot;Cache-Control: no-store, no-cache, must-revalidate&quot;);
-		@header('Pragma: no-cache');
-		@header(&quot;Last-Modified: &quot; . gmdate(&quot;D, d M Y H:i:s&quot;) . &quot; GMT&quot;);
-		@readfile(_DIR_IMG_PACK . 'rien.gif');
-		exit;
-	}
-}
-
-if ($url)  $url = urldecode($url);
-
-// tentative de connexion en auth_http
-if ($essai_auth_http AND !$ignore_auth_http) {
-	auth_http(($url ? $url : _DIR_RESTREINT_ABS), $essai_auth_http);
-	exit;
-}
-
-// cas particulier, logout dans l'espace public
-if ($logout_public) {
-	$logout = $logout_public;
-	if (!$url)
-		$url = 'index.php3';
-}
-// tentative de logout
-if ($logout) {
-	verifier_visiteur();
-	if ($auteur_session['login'] == $logout) {
-		spip_query(&quot;UPDATE spip_auteurs SET en_ligne = DATE_SUB(NOW(),INTERVAL 6 MINUTE) WHERE id_auteur = &quot;.$auteur_session['id_auteur']);
-		if ($spip_session) {
-			zap_sessions($auteur_session['id_auteur'], true);
-			spip_setcookie('spip_session', $spip_session, time() - 3600 * 24);
-		}
-		
-		if ($_SERVER['PHP_AUTH_USER']
-		AND !$ignore_auth_http
-		AND verifier_php_auth()) {
-			auth_http(($url ? $url : _DIR_RESTREINT_ABS), 'logout');
-		}
-		unset ($auteur_session);
-	}
-
-	redirige_par_entete($url ? $url :
-			    (&quot;spip_login.php3?url=$url&amp;inscription=&quot; .
-			     ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)?
-			      'spip_inscription.php3' : '')));
-}
-
-// en cas de login sur bonjour=oui, on tente de poser un cookie
-// puis de passer a spip_login qui diagnostiquera l'echec de cookie
-// le cas echeant.
-if ($test_echec_cookie == 'oui') {
-	spip_setcookie('spip_session', 'test_echec_cookie');
-	redirige_par_entete(&quot;spip_login.php3?var_echec_cookie=oui&amp;url=&quot; .
-			    ($url ? $url : _DIR_RESTREINT_ABS) .
-			    &quot;&amp;inscription=&quot; .
-			     ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)?
-			      'spip_inscription.php3' : ''));
-}
-
-// Tentative de login
-unset ($cookie_session);
-$redirect = ($url ? $url : _DIR_RESTREINT_ABS);
-if ($essai_login == &quot;oui&quot;) {
-	// Recuperer le login en champ hidden
-	if ($session_login_hidden AND !$session_login)
-		$session_login = $session_login_hidden;
-
-	$login = $session_login;
-	$pass = $session_password;
-
-	// Essayer differentes methodes d'authentification
-	$auths = array('spip');
-	include_local(_FILE_CONNECT); // pour savoir si ldap est present 
-	if ($ldap_present) $auths[] = 'ldap';
-	$ok = false;
-	reset($auths);
-	while (list(, $nom_auth) = each($auths)) {
-		include_ecrire(&quot;inc_auth_&quot;.$nom_auth.&quot;.php3&quot;);
-		$classe_auth = &quot;Auth_&quot;.$nom_auth;
-		$auth = new $classe_auth;
-		if ($auth-&gt;init()) {
-			// Essayer les mots de passe md5
-			$ok = $auth-&gt;verifier_challenge_md5($login, $session_password_md5, $next_session_password_md5);
-			// Sinon essayer avec le mot de passe en clair
-			if (!$ok &amp;&amp; $session_password) $ok = $auth-&gt;verifier($login, $session_password);
-			if ($ok)  { $auth-&gt;lire(); break; }
-		}
-	}
-
-	if ($ok) {
-		$auth-&gt;activer();
-
-		if ($auth-&gt;login AND $auth-&gt;statut == '0minirezo') // force le cookie pour les admins
-			$cookie_admin = &quot;@&quot;.$auth-&gt;login;
-
-		$query = &quot;SELECT * FROM spip_auteurs WHERE login='&quot;.addslashes($auth-&gt;login).&quot;'&quot;;
-		$result = spip_query($query);
-		if ($row_auteur = spip_fetch_array($result))
-			$cookie_session = creer_cookie_session($row_auteur);
-
-		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
-		      $redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . 'bonjour=oui';
-		}
-	}
-	else {
-		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
-			$redirect = &quot;spip_login.php3?inscription=&quot; .
-			     ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)?
-			      'spip_inscription.php3' : '');
-		}
-		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=$login&quot;;
-		if ($session_password || $session_password_md5)
-			$redirect .= '&amp;var_erreur=pass';
-		$redirect .= '&amp;url=' . urlencode($url);
-	}
- }
-
-// cookie d'admin ?
-if ($cookie_admin == &quot;non&quot;) {
-	if (!$retour)
-	  $retour = 'spip_login.php3?var_url='.urlencode($url) .
-	     &quot;&amp;inscription=&quot;  .
-	    ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)? 'spip_inscription.php3' : '');
-
-	spip_setcookie('spip_admin', $spip_admin, time() - 3600 * 24);
-	$redirect = ereg_replace(&quot;[?&amp;]var_login=[^&amp;]*&quot;, '', $retour);
-	$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=-1&quot;;
-}
-else if ($cookie_admin AND $spip_admin != $cookie_admin) {
-	spip_setcookie('spip_admin', $cookie_admin, time() + 3600 * 24 * 14);
-}
-
-// cookie de session ?
-if ($cookie_session) {
-	if ($session_remember == 'oui')
-		spip_setcookie('spip_session', $cookie_session, time() + 3600 * 24 * 14);
-	else
-		spip_setcookie('spip_session', $cookie_session);
-
-	$prefs = ($row_auteur['prefs']) ? unserialize($row_auteur['prefs']) : array();
-	$prefs['cnx'] = ($session_remember == 'oui') ? 'perma' : '';
-	spip_query (&quot;UPDATE spip_auteurs SET prefs = '&quot;.addslashes(serialize($prefs)).&quot;' WHERE id_auteur = &quot;.$row_auteur['id_auteur']);
-
-}
-
-// changement de langue espace public
-if ($var_lang) {
-	include_ecrire('inc_lang.php3');
-
-	if (changer_langue($var_lang)) {
-		spip_setcookie('spip_lang', $var_lang, time() + 365 * 24 * 3600);
-		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
-		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang&quot;;
-	}
-}
-
-// changer de langue espace prive (ou login)
-if ($var_lang_ecrire) {
-	include_ecrire('inc_lang.php3');
-	verifier_visiteur();
-
-	if (changer_langue($var_lang_ecrire)) {
-		spip_setcookie('spip_lang_ecrire', $var_lang_ecrire, time() + 365 * 24 * 3600);
-		spip_setcookie('spip_lang', $var_lang_ecrire, time() + 365 * 24 * 3600);
-
-		if (_FILE_CONNECT) {
-			include_ecrire('inc_admin.php3');
-			if (verifier_action_auteur('var_lang_ecrire', $valeur, $id_auteur)) {
-				spip_query (&quot;UPDATE spip_auteurs SET lang = '&quot;.addslashes($var_lang_ecrire).&quot;' WHERE id_auteur = &quot;.$id_auteur);
-				$auteur_session['lang'] = $var_lang_ecrire;
-				ajouter_session($auteur_session, $spip_session);	// enregistrer dans le fichier de session
-			}
-		}
-
-		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
-		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang_ecrire&quot;;
-	}
-}
-
-// Redirection
-// Sous Apache, les cookies avec une redirection fonctionnent
-// Sinon, on fait un refresh HTTP
-
-if (ereg(&quot;^Apache&quot;, $SERVER_SOFTWARE)) {
-	redirige_par_entete($redirect);
-}
-else {
-	@header(&quot;Refresh: 0; url=&quot; . $redirect);
-	echo &quot;&lt;html&gt;&lt;head&gt;&quot;;
-	echo &quot;&lt;meta http-equiv='Refresh' content='0; url=&quot;.$redirect.&quot;'&gt;&quot;;
-	echo &quot;&lt;/head&gt;\n&quot;;
-	echo &quot;&lt;body&gt;&lt;a href='&quot;.$redirect.&quot;'&gt;&quot;._T('navigateur_pas_redirige').&quot;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
-}
-
-?&gt;
+&lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire (&quot;inc_session.php3&quot;);
+
+
+// gerer l'auth http
+function auth_http($url, $essai_auth_http) {
+	global $_SERVER;
+	if ($essai_auth_http == 'oui') {
+		if (verifier_php_auth())
+			redirige_par_entete($url);
+		else {
+			$url = quote_amp(urlencode($url));
+			ask_php_auth(_T('login_connexion_refusee'),
+			_T('login_login_pass_incorrect'), _T('login_retour_site'),
+			&quot;url=$url&quot;, _T('login_nouvelle_tentative'),
+			(ereg(_DIR_RESTREINT_ABS, $url)));
+			exit;
+		}
+	}
+	// si demande logout auth_http
+	else if ($essai_auth_http == 'logout') {
+		ask_php_auth(_T('login_deconnexion_ok'),
+		_T('login_verifiez_navigateur'), _T('login_retour_public'),
+		&quot;redirect=&quot;._DIR_RESTREINT_ABS, _T('login_test_navigateur'), true);
+		exit;
+	}
+}
+
+// rejoue le cookie pour renouveler spip_session
+if ($change_session == 'oui') {
+	if (verifier_session($spip_session)) {
+		// Attention : seul celui qui a le bon IP a le droit de rejouer,
+		// ainsi un eventuel voleur de cookie ne pourrait pas deconnecter
+		// sa victime, mais se ferait deconnecter par elle.
+		if ($auteur_session['hash_env'] == hash_env()) {
+			$auteur_session['ip_change'] = false;
+			$cookie = creer_cookie_session($auteur_session);
+			supprimer_session($spip_session);
+			spip_setcookie('spip_session', $cookie);
+		}
+		@header('Content-Type: image/gif');
+		@header('Expires: 0');
+		@header(&quot;Cache-Control: no-store, no-cache, must-revalidate&quot;);
+		@header('Pragma: no-cache');
+		@header(&quot;Last-Modified: &quot; . gmdate(&quot;D, d M Y H:i:s&quot;) . &quot; GMT&quot;);
+		@readfile(_DIR_IMG_PACK . 'rien.gif');
+		exit;
+	}
+}
+
+if ($url)  $url = urldecode($url);
+
+// tentative de connexion en auth_http
+if ($essai_auth_http AND !$ignore_auth_http) {
+	auth_http(($url ? $url : _DIR_RESTREINT_ABS), $essai_auth_http);
+	exit;
+}
+
+// cas particulier, logout dans l'espace public
+if ($logout_public) {
+	$logout = $logout_public;
+	if (!$url)
+		$url = 'index.php3';
+}
+// tentative de logout
+if ($logout) {
+	verifier_visiteur();
+	if ($auteur_session['login'] == $logout) {
+		spip_query(&quot;UPDATE spip_auteurs SET en_ligne = DATE_SUB(NOW(),INTERVAL 6 MINUTE) WHERE id_auteur = &quot;.$auteur_session['id_auteur']);
+		if ($spip_session) {
+			zap_sessions($auteur_session['id_auteur'], true);
+			spip_setcookie('spip_session', $spip_session, time() - 3600 * 24);
+		}
+		
+		if ($_SERVER['PHP_AUTH_USER']
+		AND !$ignore_auth_http
+		AND verifier_php_auth()) {
+			auth_http(($url ? $url : _DIR_RESTREINT_ABS), 'logout');
+		}
+		unset ($auteur_session);
+	}
+
+	redirige_par_entete($url ? $url : &quot;spip_login.php3&quot;);
+}
+
+// en cas de login sur bonjour=oui, on tente de poser un cookie
+// puis de passer a spip_login qui diagnostiquera l'echec de cookie
+// le cas echeant.
+if ($test_echec_cookie == 'oui') {
+	spip_setcookie('spip_session', 'test_echec_cookie');
+	redirige_par_entete(&quot;spip_login.php3?var_echec_cookie=oui&amp;url=&quot;
+		. ($url ? $url : _DIR_RESTREINT_ABS));
+}
+
+// Tentative de login
+unset ($cookie_session);
+$redirect = ($url ? $url : _DIR_RESTREINT_ABS);
+if ($essai_login == &quot;oui&quot;) {
+	// Recuperer le login en champ hidden
+	if ($session_login_hidden AND !$session_login)
+		$session_login = $session_login_hidden;
+
+	$login = $session_login;
+	$pass = $session_password;
+
+	// Essayer differentes methodes d'authentification
+	$auths = array('spip');
+	include_local(_FILE_CONNECT); // pour savoir si ldap est present 
+	if ($ldap_present) $auths[] = 'ldap';
+	$ok = false;
+	reset($auths);
+	while (list(, $nom_auth) = each($auths)) {
+		include_ecrire(&quot;inc_auth_&quot;.$nom_auth.&quot;.php3&quot;);
+		$classe_auth = &quot;Auth_&quot;.$nom_auth;
+		$auth = new $classe_auth;
+		if ($auth-&gt;init()) {
+			// Essayer les mots de passe md5
+			$ok = $auth-&gt;verifier_challenge_md5($login, $session_password_md5, $next_session_password_md5);
+			// Sinon essayer avec le mot de passe en clair
+			if (!$ok &amp;&amp; $session_password) $ok = $auth-&gt;verifier($login, $session_password);
+			if ($ok)  { $auth-&gt;lire(); break; }
+		}
+	}
+
+	if ($ok) {
+		$auth-&gt;activer();
+
+		if ($auth-&gt;login AND $auth-&gt;statut == '0minirezo') // force le cookie pour les admins
+			$cookie_admin = &quot;@&quot;.$auth-&gt;login;
+
+		$query = &quot;SELECT * FROM spip_auteurs WHERE login='&quot;.addslashes($auth-&gt;login).&quot;'&quot;;
+		$result = spip_query($query);
+		if ($row_auteur = spip_fetch_array($result))
+			$cookie_session = creer_cookie_session($row_auteur);
+
+		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
+		      $redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . 'bonjour=oui';
+		}
+	}
+	else {
+		if (ereg(_DIR_RESTREINT_ABS, $redirect))
+			$redirect = &quot;spip_login.php3&quot;;
+		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=$login&quot;;
+		if ($session_password || $session_password_md5)
+			$redirect .= '&amp;var_erreur=pass';
+		$redirect .= '&amp;url=' . urlencode($url);
+	}
+ }
+
+// cookie d'admin ?
+if ($cookie_admin == &quot;non&quot;) {
+	if (!$retour)
+	  $retour = 'spip_login.php3?var_url='.urlencode($url);
+
+	spip_setcookie('spip_admin', $spip_admin, time() - 3600 * 24);
+	$redirect = ereg_replace(&quot;([?&amp;])var_login=[^&amp;]*&quot;, '\1', urldecode($retour));
+	$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=-1&quot;;
+}
+else if ($cookie_admin AND $spip_admin != $cookie_admin) {
+	spip_setcookie('spip_admin', $cookie_admin, time() + 3600 * 24 * 14);
+}
+
+// cookie de session ?
+if ($cookie_session) {
+	if ($session_remember == 'oui')
+		spip_setcookie('spip_session', $cookie_session, time() + 3600 * 24 * 14);
+	else
+		spip_setcookie('spip_session', $cookie_session);
+
+	$prefs = ($row_auteur['prefs']) ? unserialize($row_auteur['prefs']) : array();
+	$prefs['cnx'] = ($session_remember == 'oui') ? 'perma' : '';
+	spip_query (&quot;UPDATE spip_auteurs SET prefs = '&quot;.addslashes(serialize($prefs)).&quot;' WHERE id_auteur = &quot;.$row_auteur['id_auteur']);
+
+}
+
+// changement de langue espace public
+if ($var_lang) {
+	include_ecrire('inc_lang.php3');
+
+	if (changer_langue($var_lang)) {
+		spip_setcookie('spip_lang', $var_lang, time() + 365 * 24 * 3600);
+		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
+		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang&quot;;
+	}
+}
+
+// changer de langue espace prive (ou login)
+if ($var_lang_ecrire) {
+	include_ecrire('inc_lang.php3');
+	verifier_visiteur();
+
+	if (changer_langue($var_lang_ecrire)) {
+		spip_setcookie('spip_lang_ecrire', $var_lang_ecrire, time() + 365 * 24 * 3600);
+		spip_setcookie('spip_lang', $var_lang_ecrire, time() + 365 * 24 * 3600);
+
+		if (_FILE_CONNECT) {
+			include_ecrire('inc_admin.php3');
+			if (verifier_action_auteur('var_lang_ecrire', $valeur, $id_auteur)) {
+				spip_query (&quot;UPDATE spip_auteurs SET lang = '&quot;.addslashes($var_lang_ecrire).&quot;' WHERE id_auteur = &quot;.$id_auteur);
+				$auteur_session['lang'] = $var_lang_ecrire;
+				ajouter_session($auteur_session, $spip_session);	// enregistrer dans le fichier de session
+			}
+		}
+
+		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
+		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang_ecrire&quot;;
+	}
+}
+
+// Redirection
+// Sous Apache, les cookies avec une redirection fonctionnent
+// Sinon, on fait un refresh HTTP
+
+if (ereg(&quot;^Apache&quot;, $SERVER_SOFTWARE)) {
+	redirige_par_entete($redirect);
+}
+else {
+	@header(&quot;Refresh: 0; url=&quot; . $redirect);
+	echo &quot;&lt;html&gt;&lt;head&gt;&quot;;
+	echo &quot;&lt;meta http-equiv='Refresh' content='0; url=&quot;.$redirect.&quot;'&gt;&quot;;
+	echo &quot;&lt;/head&gt;\n&quot;;
+	echo &quot;&lt;body&gt;&lt;a href='&quot;.$redirect.&quot;'&gt;&quot;._T('navigateur_pas_redirige').&quot;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
+}
+
+?&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000088.html">[Spip-carto-cvs] spipcarto COPYING.txt,NONE,1.1
</A></li>
	<LI>Next message: <A HREF="000090.html">[Spip-carto-cvs] spipcarto/dist ical.html,1.1,1.2 resume.html,1.1,1.2 site.html,1.1,1.2 login.html,1.1,1.2 breve.html,1.1,1.2 sommaire.html,1.1,1.2 404.html,1.1,1.2 sommaire_texte.html,1.1,1.2 nouveautes.html,1.1,1.2 404.php3,1.1,1.2 rubrique.html,1.1,1.2 distrib.html,1.1,1.2 forum.html,1.1,1.2 recherche.html,1.1,1.2 auteur.html,1.1,1.2 article.html,1.1,1.2 mot.html,1.1,1.2 plan.html,1.1,1.2 backend-breves.html,1.1,1.2 backend.html,1.1,1.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#92">[ date ]</a>
              <a href="thread.html#92">[ thread ]</a>
              <a href="subject.html#92">[ subject ]</a>
              <a href="author.html#92">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
