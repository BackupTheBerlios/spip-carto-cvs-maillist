<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto carto-proto1.1.sql,NONE,1.1 article.php3,1.1,1.2 auteur.php3,1.1,1.2 backend-breves.php3,1.1,1.2 backend.php3,1.1,1.2 breve.php3,1.1,1.2 carto.php3,1.1,1.2 distrib.php3,1.1,1.2 downloadfile.class.php,1.1,1.2 forum.php3,1.1,1.2 habillage.css,1.1,1.2 htaccess-html.txt,1.1,1.2 htaccess-propres.txt,1.1,1.2 ical.php3,1.1,1.2 impression.css,1.1,1.2 inc-admin.php3,1.1,1.2 inc-balises.php3,1.1,1.2 inc-boucles.php3,1.1,1.2 inc-cache.php3,1.1,1.2 inc-calcul-outils.php3,1.1,1.2 inc-calcul.php3,1.1,1.2 inc-compilo-api.php3,1.1,1.2 inc-compilo-index.php3,1.1,1.2 inc-compilo.php3,1.1,1.2 inc-criteres.php3,1.1,1.2 inc-html-squel.php3,1.1,1.2 inc-messforum.php3,1.1,1.2 inc-public-global.php3,1.1,1.2 inc-public.php3,1.1,1.2 inc-stats.php3,1.1,1.2 inc-urls-html.php3,1.1,1.2 inc-urls-propres.php3,1.1,1.2 inc-urls-standard.php3,1.1,1.2 index.php,1.1,1.2 index.php3,1.1,1.2 mes_fonctions.php3,1.1,1.2 mot.php3,1.1,1.2 plan.php3,1.1,1.2 recherche.php3,1.1,1.2 resume.php3,1.1,1.2 ! rubrique.php3,1.1,1.2 site.php3,1.1,1.2 sommaire.php3,1.1,1.2 sommaire_texte.php3,1.1,1.2 spip_acces_doc.php3,1.1,1.2 spip_admin.css,1.1,1.2 spip_background.php3,1.1,1.2 spip_barre.js,1.1,1.2 spip_cache.php3,1.1,1.2 spip_cal.php3,1.1,1.2 spip_carto.php,1.1,1.2 spip_cookie.php3,1.1,1.2 spip_image.php3,1.1,1.2 spip_image_reduite.php3,1.1,1.2 spip_inscription.php3,1.1,1.2 spip_login.php3,1.1,1.2 spip_pass.php3,1.1,1.2 spip_redirect.php3,1.1,1.2 spip_style.css,1.1,1.2 spip_test_dirs.php3,1.1,1.2 typographie.css,1.1,1.2 .project,1.1,NONE article-dist.html,1.1,NONE auteur-dist.html,1.1,NONE backend-breves-dist.html,1.1,NONE backend-dist.html,1.1,NONE breve-dist.html,1.1,NONE carto-proto.sql,1.1,NONE carto.html,1.1,NONE distrib-dist.html,1.1,NONE formulaire_admin-dist.html,1.1,NONE formulaire_ecrire_auteur-dist.html,1.1,NONE formulaire_forum-dist.html,1.1,NONE formulaire_inscription-dist.html,1.1,NONE formulaire_login-dist.html,1.1,NONE formulaire_menu_lang-dist.html,1.1,NONE form! ulaire_oubli-dist.html,1.1,NONE formulaire_recherche-dist.html,1.1,NON
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-February/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20carto-proto1.1.sql%2CNONE%2C1.1%20article.php3%2C1.1%2C1.2%20auteur.php3%2C1.1%2C1.2%20backend-breves.php3%2C1.1%2C1.2%20backend.php3%2C1.1%2C1.2%20breve.php3%2C1.1%2C1.2%20carto.php3%2C1.1%2C1.2%20distrib.php3%2C1.1%2C1.2%20downloadfile.class.php%2C1.1%2C1.2%20forum.php3%2C1.1%2C1.2%20habillage.css%2C1.1%2C1.2%20htaccess-html.txt%2C1.1%2C1.2%20htaccess-propres.txt%2C1.1%2C1.2%20ical.php3%2C1.1%2C1.2%20impression.css%2C1.1%2C1.2%20inc-admin.php3%2C1.1%2C1.2%20inc-balises.php3%2C1.1%2C1.2%20inc-boucles.php3%2C1.1%2C1.2%20inc-cache.php3%2C1.1%2C1.2%20inc-calcul-outils.php3%2C1.1%2C1.2%20inc-calcul.php3%2C1.1%2C1.2%20inc-compilo-api.php3%2C1.1%2C1.2%20inc-compilo-index.php3%2C1.1%2C1.2%20inc-compilo.php3%2C1.1%2C1.2%20inc-criteres.php3%2C1.1%2C1.2%20inc-html-squel.php3%2C1.1%2C1.2%20inc-messforum.php3%2C1.1%2C1.2%20inc-public-global.php3%2C1.1%2C1.2%20inc-public.php3%2C1.1%2C1.2%20inc-stats.php3%2C1.1%2C1.2%20inc-urls-html.php3%2C1.1%2C1.2%20inc-urls-propres.php3%2C1.1%2C1.2%20inc-urls-standard.php3%2C1.1%2C1.2%20index.php%2C1.1%2C1.2%20index.php3%2C1.1%2C1.2%20mes_fonctions.php3%2C1.1%2C1.2%20mot.php3%2C1.1%2C1.2%20plan.php3%2C1.1%2C1.2%20recherche.php3%2C1.1%2C1.2%20resume.php3%2C1.1%2C1.2%20%21%0A%20rubrique.php3%2C1.1%2C1.2%20site.php3%2C1.1%2C1.2%20sommaire.php3%2C1.1%2C1.2%20sommaire_texte.php3%2C1.1%2C1.2%20spip_acces_doc.php3%2C1.1%2C1.2%20spip_admin.css%2C1.1%2C1.2%20spip_background.php3%2C1.1%2C1.2%20spip_barre.js%2C1.1%2C1.2%20spip_cache.php3%2C1.1%2C1.2%20spip_cal.php3%2C1.1%2C1.2%20spip_carto.php%2C1.1%2C1.2%20spip_cookie.php3%2C1.1%2C1.2%20spip_image.php3%2C1.1%2C1.2%20spip_image_reduite.php3%2C1.1%2C1.2%20spip_inscription.php3%2C1.1%2C1.2%20spip_login.php3%2C1.1%2C1.2%20spip_pass.php3%2C1.1%2C1.2%20spip_redirect.php3%2C1.1%2C1.2%20spip_style.css%2C1.1%2C1.2%20spip_test_dirs.php3%2C1.1%2C1.2%20typographie.css%2C1.1%2C1.2%20.project%2C1.1%2CNONE%20article-dist.html%2C1.1%2CNONE%20auteur-dist.html%2C1.1%2CNONE%20backend-breves-dist.html%2C1.1%2CNONE%20backend-dist.html%2C1.1%2CNONE%20breve-dist.html%2C1.1%2CNONE%20carto-proto.sql%2C1.1%2CNONE%20carto.html%2C1.1%2CNONE%20distrib-dist.html%2C1.1%2CNONE%20formulaire_admin-dist.html%2C1.1%2CNONE%20formulaire_ecrire_auteur-dist.html%2C1.1%2CNONE%20formulaire_forum-dist.html%2C1.1%2CNONE%20formulaire_inscription-dist.html%2C1.1%2CNONE%20formulaire_login-dist.html%2C1.1%2CNONE%20formulaire_menu_lang-dist.html%2C1.1%2CNONE%20form%21%0A%20ulaire_oubli-dist.html%2C1.1%2CNONE%20formulaire_recherche-dist.html%2C1.1%2CNON&In-Reply-To=%3C200502081510.j18FAD8Y005808%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000069.html">
   <LINK REL="Next"  HREF="000070.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto carto-proto1.1.sql,NONE,1.1 article.php3,1.1,1.2 auteur.php3,1.1,1.2 backend-breves.php3,1.1,1.2 backend.php3,1.1,1.2 breve.php3,1.1,1.2 carto.php3,1.1,1.2 distrib.php3,1.1,1.2 downloadfile.class.php,1.1,1.2 forum.php3,1.1,1.2 habillage.css,1.1,1.2 htaccess-html.txt,1.1,1.2 htaccess-propres.txt,1.1,1.2 ical.php3,1.1,1.2 impression.css,1.1,1.2 inc-admin.php3,1.1,1.2 inc-balises.php3,1.1,1.2 inc-boucles.php3,1.1,1.2 inc-cache.php3,1.1,1.2 inc-calcul-outils.php3,1.1,1.2 inc-calcul.php3,1.1,1.2 inc-compilo-api.php3,1.1,1.2 inc-compilo-index.php3,1.1,1.2 inc-compilo.php3,1.1,1.2 inc-criteres.php3,1.1,1.2 inc-html-squel.php3,1.1,1.2 inc-messforum.php3,1.1,1.2 inc-public-global.php3,1.1,1.2 inc-public.php3,1.1,1.2 inc-stats.php3,1.1,1.2 inc-urls-html.php3,1.1,1.2 inc-urls-propres.php3,1.1,1.2 inc-urls-standard.php3,1.1,1.2 index.php,1.1,1.2 index.php3,1.1,1.2 mes_fonctions.php3,1.1,1.2 mot.php3,1.1,1.2 plan.php3,1.1,1.2 recherche.php3,1.1,1.2 resume.php3,1.1,1.2 ! rubrique.php3,1.1,1.2 site.php3,1.1,1.2 sommaire.php3,1.1,1.2 sommaire_texte.php3,1.1,1.2 spip_acces_doc.php3,1.1,1.2 spip_admin.css,1.1,1.2 spip_background.php3,1.1,1.2 spip_barre.js,1.1,1.2 spip_cache.php3,1.1,1.2 spip_cal.php3,1.1,1.2 spip_carto.php,1.1,1.2 spip_cookie.php3,1.1,1.2 spip_image.php3,1.1,1.2 spip_image_reduite.php3,1.1,1.2 spip_inscription.php3,1.1,1.2 spip_login.php3,1.1,1.2 spip_pass.php3,1.1,1.2 spip_redirect.php3,1.1,1.2 spip_style.css,1.1,1.2 spip_test_dirs.php3,1.1,1.2 typographie.css,1.1,1.2 .project,1.1,NONE article-dist.html,1.1,NONE auteur-dist.html,1.1,NONE backend-breves-dist.html,1.1,NONE backend-dist.html,1.1,NONE breve-dist.html,1.1,NONE carto-proto.sql,1.1,NONE carto.html,1.1,NONE distrib-dist.html,1.1,NONE formulaire_admin-dist.html,1.1,NONE formulaire_ecrire_auteur-dist.html,1.1,NONE formulaire_forum-dist.html,1.1,NONE formulaire_inscription-dist.html,1.1,NONE formulaire_login-dist.html,1.1,NONE formulaire_menu_lang-dist.html,1.1,NONE form! ulaire_oubli-dist.html,1.1,NONE formulaire_recherche-dist.html,1.1,NON</H1>
    <B>mose at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20carto-proto1.1.sql%2CNONE%2C1.1%20article.php3%2C1.1%2C1.2%20auteur.php3%2C1.1%2C1.2%20backend-breves.php3%2C1.1%2C1.2%20backend.php3%2C1.1%2C1.2%20breve.php3%2C1.1%2C1.2%20carto.php3%2C1.1%2C1.2%20distrib.php3%2C1.1%2C1.2%20downloadfile.class.php%2C1.1%2C1.2%20forum.php3%2C1.1%2C1.2%20habillage.css%2C1.1%2C1.2%20htaccess-html.txt%2C1.1%2C1.2%20htaccess-propres.txt%2C1.1%2C1.2%20ical.php3%2C1.1%2C1.2%20impression.css%2C1.1%2C1.2%20inc-admin.php3%2C1.1%2C1.2%20inc-balises.php3%2C1.1%2C1.2%20inc-boucles.php3%2C1.1%2C1.2%20inc-cache.php3%2C1.1%2C1.2%20inc-calcul-outils.php3%2C1.1%2C1.2%20inc-calcul.php3%2C1.1%2C1.2%20inc-compilo-api.php3%2C1.1%2C1.2%20inc-compilo-index.php3%2C1.1%2C1.2%20inc-compilo.php3%2C1.1%2C1.2%20inc-criteres.php3%2C1.1%2C1.2%20inc-html-squel.php3%2C1.1%2C1.2%20inc-messforum.php3%2C1.1%2C1.2%20inc-public-global.php3%2C1.1%2C1.2%20inc-public.php3%2C1.1%2C1.2%20inc-stats.php3%2C1.1%2C1.2%20inc-urls-html.php3%2C1.1%2C1.2%20inc-urls-propres.php3%2C1.1%2C1.2%20inc-urls-standard.php3%2C1.1%2C1.2%20index.php%2C1.1%2C1.2%20index.php3%2C1.1%2C1.2%20mes_fonctions.php3%2C1.1%2C1.2%20mot.php3%2C1.1%2C1.2%20plan.php3%2C1.1%2C1.2%20recherche.php3%2C1.1%2C1.2%20resume.php3%2C1.1%2C1.2%20%21%0A%20rubrique.php3%2C1.1%2C1.2%20site.php3%2C1.1%2C1.2%20sommaire.php3%2C1.1%2C1.2%20sommaire_texte.php3%2C1.1%2C1.2%20spip_acces_doc.php3%2C1.1%2C1.2%20spip_admin.css%2C1.1%2C1.2%20spip_background.php3%2C1.1%2C1.2%20spip_barre.js%2C1.1%2C1.2%20spip_cache.php3%2C1.1%2C1.2%20spip_cal.php3%2C1.1%2C1.2%20spip_carto.php%2C1.1%2C1.2%20spip_cookie.php3%2C1.1%2C1.2%20spip_image.php3%2C1.1%2C1.2%20spip_image_reduite.php3%2C1.1%2C1.2%20spip_inscription.php3%2C1.1%2C1.2%20spip_login.php3%2C1.1%2C1.2%20spip_pass.php3%2C1.1%2C1.2%20spip_redirect.php3%2C1.1%2C1.2%20spip_style.css%2C1.1%2C1.2%20spip_test_dirs.php3%2C1.1%2C1.2%20typographie.css%2C1.1%2C1.2%20.project%2C1.1%2CNONE%20article-dist.html%2C1.1%2CNONE%20auteur-dist.html%2C1.1%2CNONE%20backend-breves-dist.html%2C1.1%2CNONE%20backend-dist.html%2C1.1%2CNONE%20breve-dist.html%2C1.1%2CNONE%20carto-proto.sql%2C1.1%2CNONE%20carto.html%2C1.1%2CNONE%20distrib-dist.html%2C1.1%2CNONE%20formulaire_admin-dist.html%2C1.1%2CNONE%20formulaire_ecrire_auteur-dist.html%2C1.1%2CNONE%20formulaire_forum-dist.html%2C1.1%2CNONE%20formulaire_inscription-dist.html%2C1.1%2CNONE%20formulaire_login-dist.html%2C1.1%2CNONE%20formulaire_menu_lang-dist.html%2C1.1%2CNONE%20form%21%0A%20ulaire_oubli-dist.html%2C1.1%2CNONE%20formulaire_recherche-dist.html%2C1.1%2CNON&In-Reply-To=%3C200502081510.j18FAD8Y005808%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto carto-proto1.1.sql,NONE,1.1 article.php3,1.1,1.2 auteur.php3,1.1,1.2 backend-breves.php3,1.1,1.2 backend.php3,1.1,1.2 breve.php3,1.1,1.2 carto.php3,1.1,1.2 distrib.php3,1.1,1.2 downloadfile.class.php,1.1,1.2 forum.php3,1.1,1.2 habillage.css,1.1,1.2 htaccess-html.txt,1.1,1.2 htaccess-propres.txt,1.1,1.2 ical.php3,1.1,1.2 impression.css,1.1,1.2 inc-admin.php3,1.1,1.2 inc-balises.php3,1.1,1.2 inc-boucles.php3,1.1,1.2 inc-cache.php3,1.1,1.2 inc-calcul-outils.php3,1.1,1.2 inc-calcul.php3,1.1,1.2 inc-compilo-api.php3,1.1,1.2 inc-compilo-index.php3,1.1,1.2 inc-compilo.php3,1.1,1.2 inc-criteres.php3,1.1,1.2 inc-html-squel.php3,1.1,1.2 inc-messforum.php3,1.1,1.2 inc-public-global.php3,1.1,1.2 inc-public.php3,1.1,1.2 inc-stats.php3,1.1,1.2 inc-urls-html.php3,1.1,1.2 inc-urls-propres.php3,1.1,1.2 inc-urls-standard.php3,1.1,1.2 index.php,1.1,1.2 index.php3,1.1,1.2 mes_fonctions.php3,1.1,1.2 mot.php3,1.1,1.2 plan.php3,1.1,1.2 recherche.php3,1.1,1.2 resume.php3,1.1,1.2 ! rubrique.php3,1.1,1.2 site.php3,1.1,1.2 sommaire.php3,1.1,1.2 sommaire_texte.php3,1.1,1.2 spip_acces_doc.php3,1.1,1.2 spip_admin.css,1.1,1.2 spip_background.php3,1.1,1.2 spip_barre.js,1.1,1.2 spip_cache.php3,1.1,1.2 spip_cal.php3,1.1,1.2 spip_carto.php,1.1,1.2 spip_cookie.php3,1.1,1.2 spip_image.php3,1.1,1.2 spip_image_reduite.php3,1.1,1.2 spip_inscription.php3,1.1,1.2 spip_login.php3,1.1,1.2 spip_pass.php3,1.1,1.2 spip_redirect.php3,1.1,1.2 spip_style.css,1.1,1.2 spip_test_dirs.php3,1.1,1.2 typographie.css,1.1,1.2 .project,1.1,NONE article-dist.html,1.1,NONE auteur-dist.html,1.1,NONE backend-breves-dist.html,1.1,NONE backend-dist.html,1.1,NONE breve-dist.html,1.1,NONE carto-proto.sql,1.1,NONE carto.html,1.1,NONE distrib-dist.html,1.1,NONE formulaire_admin-dist.html,1.1,NONE formulaire_ecrire_auteur-dist.html,1.1,NONE formulaire_forum-dist.html,1.1,NONE formulaire_inscription-dist.html,1.1,NONE formulaire_login-dist.html,1.1,NONE formulaire_menu_lang-dist.html,1.1,NONE form! ulaire_oubli-dist.html,1.1,NONE formulaire_recherche-dist.html,1.1,NON">mose at berlios.de
       </A><BR>
    <I>Tue Feb  8 16:10:13 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000069.html">[Spip-carto-cvs] spipcarto/dist - New directory
</A></li>
        <LI>Next message: <A HREF="000070.html">[Spip-carto-cvs] spipcarto/CACHE .cvsignore,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#76">[ date ]</a>
              <a href="thread.html#76">[ thread ]</a>
              <a href="subject.html#76">[ subject ]</a>
              <a href="author.html#76">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv5765

Modified Files:
	article.php3 auteur.php3 backend-breves.php3 backend.php3 
	breve.php3 carto.php3 distrib.php3 downloadfile.class.php 
	forum.php3 habillage.css htaccess-html.txt 
	htaccess-propres.txt ical.php3 impression.css inc-admin.php3 
	inc-balises.php3 inc-boucles.php3 inc-cache.php3 
	inc-calcul-outils.php3 inc-calcul.php3 inc-compilo-api.php3 
	inc-compilo-index.php3 inc-compilo.php3 inc-criteres.php3 
	inc-html-squel.php3 inc-messforum.php3 inc-public-global.php3 
	inc-public.php3 inc-stats.php3 inc-urls-html.php3 
	inc-urls-propres.php3 inc-urls-standard.php3 index.php 
	index.php3 mes_fonctions.php3 mot.php3 plan.php3 
	recherche.php3 resume.php3 rubrique.php3 site.php3 
	sommaire.php3 sommaire_texte.php3 spip_acces_doc.php3 
	spip_admin.css spip_background.php3 spip_barre.js 
	spip_cache.php3 spip_cal.php3 spip_carto.php spip_cookie.php3 
	spip_image.php3 spip_image_reduite.php3 spip_inscription.php3 
	spip_login.php3 spip_pass.php3 spip_redirect.php3 
	spip_style.css spip_test_dirs.php3 typographie.css 
Added Files:
	carto-proto1.1.sql 
Removed Files:
	.project article-dist.html auteur-dist.html 
	backend-breves-dist.html backend-dist.html breve-dist.html 
	carto-proto.sql carto.html distrib-dist.html 
	formulaire_admin-dist.html formulaire_ecrire_auteur-dist.html 
	formulaire_forum-dist.html formulaire_inscription-dist.html 
	formulaire_login-dist.html formulaire_menu_lang-dist.html 
	formulaire_oubli-dist.html formulaire_recherche-dist.html 
	formulaire_signature-dist.html formulaire_site-dist.html 
	forum-dist.html ical-dist.html inc-chercher.php3 
	inc-formulaire_admin.php3 inc-formulaire_ecrire_auteur.php3 
	inc-formulaire_forum.php3 inc-formulaire_inscription.php3 
	inc-formulaire_recherche.php3 inc-formulaire_signature.php3 
	inc-formulaire_site.php3 inc-login_prive.php3 
	inc-login_public.php3 inc-menu_lang.php3 
	inc-menu_lang_ecrire.php3 inc-url_logout.php3 login-dist.html 
	mot-dist.html nouveautes-dist.html plan-dist.html 
	project.index recherche-dist.html resume-dist.html 
	rubrique-dist.html site-dist.html sommaire-dist.html 
	sommaire_texte-dist.html spipcarto.zip 
Log Message:
update a partir de spipcarto_proto1.3.zip

--- NEW FILE: carto-proto1.1.sql ---
#
# Table structure for table 'spip_carto_cartes'
#

CREATE TABLE `spip_carto_cartes` (
  `id_carto_carte` smallint(5) unsigned NOT NULL auto_increment,
  `url_carte` varchar(255) NOT NULL default '',
  `titre` varchar(255) NOT NULL default '',
  `texte` text NOT NULL,
  `callage` text NOT NULL,
  `id_srs` smallint(5) unsigned default NULL,
  `idx` enum('','1','non','oui','idx') NOT NULL default '',
  PRIMARY KEY  (`id_carto_carte`),
  KEY `titre` (`titre`)
) TYPE=MyISAM;



#
# Table structure for table 'spip_carto_cartes_articles'
#

CREATE TABLE `spip_carto_cartes_articles` (
  `id_carto_carte` smallint(5) unsigned NOT NULL default '0',
  `id_article` smallint(5) unsigned NOT NULL default '0',
  PRIMARY KEY  (`id_carto_carte`,`id_article`)
) TYPE=MyISAM;



#
# Table structure for table 'spip_carto_objets'
#

CREATE TABLE `spip_carto_objets` (
  `id_carto_objet` smallint(5) unsigned NOT NULL auto_increment,
  `id_carto_carte` smallint(5) unsigned NOT NULL default '0',
  `titre` varchar(255) NOT NULL default '',
  `texte` text NOT NULL,
  `url_objet` text,
  `url_logo` text,
  `geometrie` text,
  `idx` enum('','1','non','oui','idx') NOT NULL default '',
  PRIMARY KEY  (`id_carto_objet`),
  KEY `id_carte` (`id_carto_carte`),
  KEY `titre` (`titre`)
) TYPE=MyISAM;



#
# Table structure for table 'spip_carto_srs'
#

CREATE TABLE `spip_carto_srs` (
  `id_carto_srs` smallint(5) unsigned NOT NULL auto_increment,
  `label` varchar(30) NOT NULL default '',
  `code` smallint(6) NOT NULL default '0',
  PRIMARY KEY  (`id_carto_srs`)
) TYPE=MyISAM;



#
# Table structure for table 'spip_documents_carto_cartes'
#

CREATE TABLE `spip_documents_carto_cartes` (
  `id_carto_carte` smallint(5) unsigned NOT NULL default '0',
  `id_document` smallint(5) unsigned NOT NULL default '0',
  `callage` text,
  PRIMARY KEY  (`id_carto_carte`,`id_document`)
) TYPE=MyISAM;



#
# Table structure for table 'spip_mots_carto_objets'
#

CREATE TABLE `spip_mots_carto_objets` (
  `id_carto_objet` smallint(5) unsigned NOT NULL default '0',
  `id_mot` smallint(5) unsigned NOT NULL default '0',
  `ordre` tinyint(3) unsigned NOT NULL default '0',
  PRIMARY KEY  (`id_carto_objet`,`id_mot`),
  KEY `ordre` (`ordre`)
) TYPE=MyISAM;


ALTER TABLE `spip_groupes_mots` ADD `carto_objets` CHAR( 3 ) NOT NULL AFTER `syndic` ;

ALTER TABLE `spip_groupes_mots` ADD INDEX ( `carto_objets` ) ;


INSERT INTO spip_meta(nom, valeur, maj) VALUES ('activer_carto','oui',now());
INSERT INTO spip_meta(nom, valeur, maj) VALUES ('carto_mots','oui',now());
Index: article.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/article.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- article.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ article.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,8 +1,8 @@
-&lt;?php
-
-$fond = &quot;article&quot;;
-$delais = 24 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+$fond = &quot;article&quot;;
+$delais = 24 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: auteur.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/auteur.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- auteur.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ auteur.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,7 +1,7 @@
-&lt;?php
-$fond = &quot;auteur&quot;;
-$delais = 24 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;auteur&quot;;
+$delais = 24 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: backend-breves.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/backend-breves.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- backend-breves.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ backend-breves.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,12 +1,12 @@
-&lt;?php
-$fond = &quot;backend-breves&quot;;
-$delais = 3600;
-
-// cette ligne empeche l'affichage des boutons d'administration
-$flag_preserver = true;
-
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at header</A>(&quot;Content-type: text/xml&quot;);
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;backend-breves&quot;;
+$delais = 3600;
+
+// cette ligne empeche l'affichage des boutons d'administration
+$flag_preserver = true;
+
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A>(&quot;Content-type: text/xml&quot;);
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: backend.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/backend.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- backend.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ backend.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,14 +1,14 @@
-&lt;?php
-$fond = &quot;backend&quot;;
-$delais = 3600;
-
-// cette ligne empeche l'affichage des boutons d'administration
-// Et les headers !!!!
-
-$flag_preserver = true;
-
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at header</A>(&quot;Content-type: text/xml&quot;);
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;backend&quot;;
+$delais = 3600;
+
+// cette ligne empeche l'affichage des boutons d'administration
+// Et les headers !!!!
+
+$flag_preserver = true;
+
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A>(&quot;Content-type: text/xml&quot;);
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: breve.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/breve.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- breve.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ breve.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,8 +1,8 @@
-&lt;?php
-$fond = &quot;breve&quot;;
-$delais = 12 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+$fond = &quot;breve&quot;;
+$delais = 12 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: carto.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/carto.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carto.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ carto.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,8 +1,8 @@
-&lt;?php
-
-$fond = &quot;carto&quot;;
-$delais = 24*3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+$fond = &quot;carto&quot;;
+$delais = 24*3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: distrib.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/distrib.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- distrib.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ distrib.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,10 +1,10 @@
-&lt;?php
-$fond = &quot;distrib&quot;;
-$delais = 3600;
-
-// cette ligne empeche l'affichage des boutons d'administration
-$flag_preserver = true;
-
-include (&quot;inc-public.php3&quot;);
-
+&lt;?php
+$fond = &quot;distrib&quot;;
+$delais = 3600;
+
+// cette ligne empeche l'affichage des boutons d'administration
+$flag_preserver = true;
+
+include (&quot;inc-public.php3&quot;);
+
 ?&gt;

Index: downloadfile.class.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/downloadfile.class.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- downloadfile.class.php	13 Jan 2005 15:37:14 -0000	1.1
+++ downloadfile.class.php	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,72 +1,72 @@
-&lt;?
-/*
- * Class has simple interface to download any file from a server
- * without displaying the location of the file
- *
- * Author: Viatcheslav Ivanov, E-Witness Inc., Canada;
- * mail: <A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">ivanov at e-witness.ca</A>;
- * web: www.e-witness.ca; www.coolwater.ca; www.strongpost.net;
- * version: 1.1 /08.19.2002
- *
- */
-
-if ( !defined(&quot;DOWNLOADFILE_H&quot;) ) {
-
-	define(&quot;DOWNLOADFILE_H&quot;,1);
-
-	class DOWNLOADFILE {
-		var $df_path = &quot;&quot;;
-		var $df_contenttype = &quot;&quot;;
-		var $df_contentdisposition = &quot;&quot;;
-		var $df_filename = &quot;&quot;;
-
-		function DOWNLOADFILE($df_path, $df_contentdisposition = &quot;attachment&quot;, $df_filename = &quot;&quot;) {
-			$this-&gt;df_path = $df_path;
-			if (!function_exists (&quot;mime_content_type&quot;)) {
- 					function mime_content_type ($file) {
-  					return exec (&quot;file -bi &quot; . escapeshellcmd($file));
- 				}
-			}
-			$df_contenttype=@mime_content_type($df_path);
-			if ($df_contenttype) $this-&gt;df_contenttype = $df_contenttype;
-			else $this-&gt;df_contenttype =&quot;&quot;;// &quot;application/octet-stream&quot;;
-			$this-&gt;df_contentdisposition = $df_contentdisposition;
-			$this-&gt;df_filename = ($df_filename)? $df_filename : basename($df_path);
-		}
-
-		// check is specified file exists?
-		function df_exists() {
-			if(@file_exists($this-&gt;df_path)) return true;
-			return false;
-		}
-
-		// get file size
-		function df_size() {
-			if($this-&gt;df_exists()) return filesize($this-&gt;df_path);
-			return false;
-		}
-
-		// return permission number for user 'other'
-		function df_permitother() {
-			return substr(decoct(fileperms($this-&gt;df_path)),-1);
-		}
-
-		// download file
-		function df_download() {
-			if($this-&gt;df_exists() &amp;&amp; $this-&gt;df_permitother() &gt;= 4) {
-				header(&quot;Content-type: &quot;.$this-&gt;df_contenttype);
-				header(&quot;Content-Length: &quot;.$this-&gt;df_size());
-				header(&quot;Content-Disposition: &quot;.$this-&gt;df_contentdisposition.&quot;; filename=\&quot;&quot;.$this-&gt;df_filename.&quot;\&quot;;&quot;);
-				header(&quot;Content-Transfer-Encoding: binary&quot;);
-				$fp = readfile($this-&gt;df_path, &quot;r&quot;);
-				return $fp;
-				//echo &quot;Content-type: &quot;.$this-&gt;df_contenttype.&quot;Content-Length: &quot;.$this-&gt;df_size().&quot;Content-Disposition: &quot;.$this-&gt;df_contentdisposition.&quot;; filename=\&quot;&quot;.$this-&gt;df_filename.&quot;\&quot;;&quot;;
-			}
-			else return false;
-		}
-
-	}
-
-}
-
+&lt;?
+/*
+ * Class has simple interface to download any file from a server
+ * without displaying the location of the file
+ *
+ * Author: Viatcheslav Ivanov, E-Witness Inc., Canada;
+ * mail: <A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">ivanov at e-witness.ca</A>;
+ * web: www.e-witness.ca; www.coolwater.ca; www.strongpost.net;
+ * version: 1.1 /08.19.2002
+ *
+ */
+
+if ( !defined(&quot;DOWNLOADFILE_H&quot;) ) {
+
+	define(&quot;DOWNLOADFILE_H&quot;,1);
+
+	class DOWNLOADFILE {
+		var $df_path = &quot;&quot;;
+		var $df_contenttype = &quot;&quot;;
+		var $df_contentdisposition = &quot;&quot;;
+		var $df_filename = &quot;&quot;;
+
+		function DOWNLOADFILE($df_path, $df_contentdisposition = &quot;attachment&quot;, $df_filename = &quot;&quot;) {
+			$this-&gt;df_path = $df_path;
+			if (!function_exists (&quot;mime_content_type&quot;)) {
+ 					function mime_content_type ($file) {
+  					return exec (&quot;file -bi &quot; . escapeshellcmd($file));
+ 				}
+			}
+			$df_contenttype=@mime_content_type($df_path);
+			if ($df_contenttype) $this-&gt;df_contenttype = $df_contenttype;
+			else $this-&gt;df_contenttype =&quot;&quot;;// &quot;application/octet-stream&quot;;
+			$this-&gt;df_contentdisposition = $df_contentdisposition;
+			$this-&gt;df_filename = ($df_filename)? $df_filename : basename($df_path);
+		}
+
+		// check is specified file exists?
+		function df_exists() {
+			if(@file_exists($this-&gt;df_path)) return true;
+			return false;
+		}
+
+		// get file size
+		function df_size() {
+			if($this-&gt;df_exists()) return filesize($this-&gt;df_path);
+			return false;
+		}
+
+		// return permission number for user 'other'
+		function df_permitother() {
+			return substr(decoct(fileperms($this-&gt;df_path)),-1);
+		}
+
+		// download file
+		function df_download() {
+			if($this-&gt;df_exists() &amp;&amp; $this-&gt;df_permitother() &gt;= 4) {
+				header(&quot;Content-type: &quot;.$this-&gt;df_contenttype);
+				header(&quot;Content-Length: &quot;.$this-&gt;df_size());
+				header(&quot;Content-Disposition: &quot;.$this-&gt;df_contentdisposition.&quot;; filename=\&quot;&quot;.$this-&gt;df_filename.&quot;\&quot;;&quot;);
+				header(&quot;Content-Transfer-Encoding: binary&quot;);
+				$fp = readfile($this-&gt;df_path, &quot;r&quot;);
+				return $fp;
+				//echo &quot;Content-type: &quot;.$this-&gt;df_contenttype.&quot;Content-Length: &quot;.$this-&gt;df_size().&quot;Content-Disposition: &quot;.$this-&gt;df_contentdisposition.&quot;; filename=\&quot;&quot;.$this-&gt;df_filename.&quot;\&quot;;&quot;;
+			}
+			else return false;
+		}
+
+	}
+
+}
+
 ?&gt;

Index: forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/forum.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- forum.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ forum.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,7 +1,20 @@
-&lt;?php
-$fond = &quot;forum&quot;;
-$delais = 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+$fond = &quot;forum&quot;;
+$delais = 3600;
+
+// Exemples de personnalisation :
+// @ <A HREF="http://www.spip.net/fr_article1825.html">http://www.spip.net/fr_article1825.html</A>
+//
+// 1. seuls les mots-cles du groupe de mots numero 1 doivent s'afficher
+// $afficher_groupe = array(1);
+//
+// 2. faire des forums uniquement pour affecter des mots-cles
+// $afficher_texte = &quot;non&quot;;
+
+// En ca de forums sur abonnement, on a un panneau de login
+$flag_dynamique = true;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: habillage.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/habillage.css,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- habillage.css	13 Jan 2005 15:37:14 -0000	1.1
+++ habillage.css	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,420 +1,420 @@
-
-
-/*
- * Mise en page des textes (bordures...)
- */
-
-.chapo {
-	line-height: 1.4em;
-	margin-top: 1em;
-}
-.texte {
-}
-.ps {
-	padding-top: 0.6em;
-	margin-top: 0.6em;
-	border-top: 1px dashed #404040;
-}
-.notes {
-	margin-top: 0.6em;
-	margin-bottom: 0.6em;
-	border-top: 1px solid #a0a0a0;
-	padding: 1.5em;
-}
-
-/*
- * Habillage des menus et de la navigation
- */
-
-.menu {
-	border: 1px solid #a0a0a0;
-	border-top: 0px;
-	padding: 0px;
-	margin: 0px;
-	margin-bottom: 16px;
-}
-.menu ul {
-	display: block;
-	margin: 0px;
-	padding: 0px;
-	padding-bottom: 4px;
-	list-style: none;
-}
-.menu ol {
-	display: block;
-	margin: 0px;
-	padding: 0px;
-	padding-bottom: 4px;
-	list-style: none;
-}
-.menu-titre {
-	border-top: 1px solid #a0a0a0;
-	border-bottom: 1px dashed #d0d0d0;
-	margin: 0px;
-	padding-left: 4px;
-	padding-right: 4px;
-	padding-top: 3px;
-	padding-bottom: 2px;
-	font-size: 90%;
-}
-.menu-item {
-	margin: 0px;
-	padding-left: 4px;
-	padding-right: 4px;
-	padding-top: 1px;
-	padding-bottom: 1px;
-	font-size: 80%;
-}
-
-/* Des couleurs specifiques selon les types de menus */
-
-.general		{ background-color: #f8f8e8; text-align:center; }
-.general .menu-titre 	{ background-color: #fcfcf0; }
-
-.rubriques 		{ background-color: #eaffea; text-align:center; }
-.rubriques .menu-titre	{ background-color: #f2fff2; }
-
-.breves 		{ background-color: #ffeaea; }
-.breves .menu-titre	{ background-color: #fff2f2; text-align:center; }
-
-.divers 		{ background-color: #eaeaff; }
-.divers .menu-titre	{ background-color: #f2f2ff; text-align:center; }
-
-.forums 		{ background-color: #e8f8f8; }
-.forums .menu-titre	{ background-color: #f0fcfc; text-align:center; }
-
-
-/*
- * Styles pour le contenu (c-a-d. la colonne principale)
- */
-
-.contenu {
-	margin: 15px;
-}
-.contenu h2.titre-extrait {
-}
-.contenu h2.titre-texte {
-}
-.contenu .surtitre {
-	margin-top: 0em;
-	margin-bottom: 0em;
-}
-.contenu .detail {
-	margin-left: 2em;
-}
-.contenu .detail .important {
-	color: #a02020;
-}
-.extrait {
-	margin: 0.1em;
-	margin-top: 0.5em;
-	margin-bottom: 0.5em;
-	margin-left: 2em;
-	margin-right: 0.1em;
-	line-height: 1.4em;
-}
-.liste-articles {
-	margin-top: 1em;
-	margin-bottom: 1em;
-	clear: left;
-}
-.contenu .forum-repondre {
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-	text-align: left;
-	font-size: 90%;
-	font-weight: bold;
-	margin-top: 0.6em;
-}
-
-
-/*
- * Disposition a l'ecran : colonnes, encarts, cartouches
- */
-
-#principal {
-	position: absolute;
-	left: 30%;
-	/*left: 18em;*/
-	top: 0px;
-	margin: 0px;
-	padding: 0px;
-	/*margin-right: 2em;*/
-	margin-right: 3%;
-	margin-top: 1.5em;
-}
-
-#plan {
-	position: absolute;
-	left: 2em;
-	top: 0px;
-	margin: 0px;
-	padding: 0px;
-	margin-right: 2em;
-	margin-top: 2em;
-}
-
-#navigation {
-	position: absolute;
-	left: 0px;
-	top: 0px;
-	width: 24%;
-	/*width: 14em;*/
-	padding: 0px;
-	margin: 0px;
-	/*margin-left: 1.8em;*/
-	margin-left: 3%;
-	margin-top: 1.5em;
-}
-
-.encart {
-	float: right;
-	/*width: 14em;*/
-	width: 34%;
-	margin-left: 4%;
-	/*margin-left: 2em;*/
-	margin-top: 1em;
-	margin-bottom: 0em;
-	margin-right: 0px;
-}
-
-.cartouche {
-	padding-top: 1em;
-	border-top: 2px solid #404040;
-	margin-bottom: 0em;
-}
-
-.cartouche .spip_logos {
-	margin-left: 0px;
-	padding-left: 0px;
-	margin-right: 0.8em;
-}
-
-
-/*
- * Habillage du plan du site
- */
-
-.plan-secteur {
-	margin-top: 0em;
-	margin-bottom: 3em;
-	clear: right;
-}
-
-.plan-secteur h1 {
-	display: block;
-	border: 1px solid #a0a0a0;
-	margin: 0px;
-	padding: 8px;
-	font-size: 150%;
-	font-weight: bold;
-	background-color: #e0ffe0;
-	text-align:center;
-}
-.plan-rubriques {
-	clear: left;
-	display: block;
-	list-style: none;
-}
-.plan-rubrique {
-	display: inline;
-	border: 1px solid #a0a0a0;
-	padding: 3px;
-	font-weight: bold;
-}
-.plan-articles {
-	clear: left;
-	margin-top: 0.5em;
-	margin-bottom: 1em;
-	list-style: square;
-}
-
-/* Eclaircissement progressif des rubriques en fonction de la profondeur */
-
-ul .plan-rubrique {
-	background-color: #e0ffe0;
-	border-color: #b8b8b8;
-}
-ul ul .plan-rubrique {
-	background-color: #eaffea;
-	border-color: #d0d0d0;
-}
-ul ul ul .plan-rubrique {
-	background-color: #f4fff4;
-	border-color: #e8e8e8;
-}
-
-
-/*
- * Habillage des forums
- */
-
-ul.forum-total {
-	display: block;
-	padding: 0px;
-	margin: 0px;
-	list-style: none;
-}
-.forum-fil {
-	margin-top: 3em;
-}
-.forum-fil ul {
-	display: block;
-	margin: 0px;
-	margin-left: 2em;
-	padding: 0px;
-	list-style: none;
-}
-.forum-titre {
-	font-weight: bold;
-	font-size: 120%;
-}
-.forum-item {
-	margin: 0px;
-	padding: 1em;
-	padding-top: 0.5em;
-	padding-bottom: 0em;
-	text-align: justify;
-	color: #303030;
-	font-size: 80%;
-}
-.forum-repondre-message {
-	text-align: right;
-}
-
-/* Boite d'un forum : eclaircissement progressif des bords */
-
-ul .forum {
-	border: 1px solid #909090;
-	padding: 0px;
-	margin: 0px;
-	margin-bottom: 1em;
-}
-ul ul .forum {
-	border: 1px solid #a4a4a4;
-}
-ul ul ul .forum {
-	border: 1px solid #b8b8b8;
-}
-ul ul ul ul .forum {
-	border: 1px solid #cccccc;
-}
-ul ul ul ul ul .forum {
-	border: 1px solid #e0e0e0;
-}
-ul ul ul ul ul ul .forum {
-	border: 1px dashed #e0e0e0;
-}
-
-/* Boite de titre d'un forum : mise en couleur selon la profondeur du forum */
-
-ul .forum-chapo {
-	border: 0px;
-	border-bottom: 1px dashed #b8b8b8;
-	margin: 0px;
-	padding-left: 6px;
-	padding-right: 6px;
-	padding-top: 3px;
-	padding-bottom: 2px;
-	font-size: 90%;
-	background: #c4e0e0;
-}
-ul ul .forum-chapo {
-	background: #d4e8e8;
-}
-ul ul ul .forum-chapo {
-	background: #e4f0f0;
-}
-ul ul ul ul .forum-chapo {
-	background: #f4f8f8;
-}
-ul ul ul ul ul .forum-chapo {
-	background: #ffffff;
-}
-
-
-/*
- * Habillage des petitions
- */
-
-.signatures {
-	margin-left: 0px;
-	margin-right: 0px;
-	margin-top: 1em;
-	margin-bottom: 1em;
-	width: 100%;
-}
-.signatures td {
-	-moz-border-radius: 0.4em;
-}
-.signatures-titre {
-	clear: right;
-	font-weight: bold;
-	font-size: 120%;
-	text-align: center;
-	padding: 0.5em;
-	margin: 0px;
-}
-.signature-date {
-	white-space: nowrap;
-	background: #e4f0f0;
-	padding: 0.5em;
-}
-.signature-nom {
-	font-weight: bold;
-	background: #ecf4f4;
-	padding: 0.2em;
-	text-align: center;
-}
-.signature-message {
-	font-size: 85%;
-	background: #f4f8f8;
-	padding: 0.4em;
-	text-align: justify;
-}
-
-
-/*
- * Formulaires
- */
-
-.formrecherche {
-	background-color: #f2f2f2;
-	color: #505030;
-	margin: 0px;
-	padding: 2px;
-	border: solid 1px #909090;
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-	font-size: 80%;
-	font-weight: normal;
-}
-
-.formulaire {
-	color: black;
-	margin: 0px;
-	margin-bottom: 16px;
-	padding: 4px;
-	border: 1px solid #a0a0a0;
-	background-color: #f6f6f6;
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-	font-size: 80%;
-	font-weight: normal;
-}
-.forml {
-	background-color: #ececec;
-	margin: 4px;
-	padding: 1px;
-	border: dashed 1px #909090;
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-	font-size: 90%;
-}
-.spip_bouton {
-	border: 2px solid #404040;
-	padding: 3px;
-	background: #d0d0d0;
-	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
-}
-
-.spip-admin {
-}
-
-
+
+
+/*
+ * Mise en page des textes (bordures...)
+ */
+
+.chapo {
+	line-height: 1.4em;
+	margin-top: 1em;
+}
+.texte {
+}
+.ps {
+	padding-top: 0.6em;
+	margin-top: 0.6em;
+	border-top: 1px dashed #404040;
+}
+.notes {
+	margin-top: 0.6em;
+	margin-bottom: 0.6em;
+	border-top: 1px solid #a0a0a0;
+	padding: 1.5em;
+}
+
+/*
+ * Habillage des menus et de la navigation
+ */
+
+.menu {
+	border: 1px solid #a0a0a0;
+	border-top: 0px;
+	padding: 0px;
+	margin: 0px;
+	margin-bottom: 16px;
+}
+.menu ul {
+	display: block;
+	margin: 0px;
+	padding: 0px;
+	padding-bottom: 4px;
+	list-style: none;
+}
+.menu ol {
+	display: block;
+	margin: 0px;
+	padding: 0px;
+	padding-bottom: 4px;
+	list-style: none;
+}
+.menu-titre {
+	border-top: 1px solid #a0a0a0;
+	border-bottom: 1px dashed #d0d0d0;
+	margin: 0px;
+	padding-left: 4px;
+	padding-right: 4px;
+	padding-top: 3px;
+	padding-bottom: 2px;
+	font-size: 90%;
+}
+.menu-item {
+	margin: 0px;
+	padding-left: 4px;
+	padding-right: 4px;
+	padding-top: 1px;
+	padding-bottom: 1px;
+	font-size: 80%;
+}
+
+/* Des couleurs specifiques selon les types de menus */
+
+.general		{ background-color: #f8f8e8; text-align:center; }
+.general .menu-titre 	{ background-color: #fcfcf0; }
+
+.rubriques 		{ background-color: #eaffea; text-align:center; }
+.rubriques .menu-titre	{ background-color: #f2fff2; }
+
+.breves 		{ background-color: #ffeaea; }
+.breves .menu-titre	{ background-color: #fff2f2; text-align:center; }
+
+.divers 		{ background-color: #eaeaff; }
+.divers .menu-titre	{ background-color: #f2f2ff; text-align:center; }
+
+.forums 		{ background-color: #e8f8f8; }
+.forums .menu-titre	{ background-color: #f0fcfc; text-align:center; }
+
+
+/*
+ * Styles pour le contenu (c-a-d. la colonne principale)
+ */
+
+.contenu {
+	margin: 15px;
+}
+.contenu h2.titre-extrait {
+}
+.contenu h2.titre-texte {
+}
+.contenu .surtitre {
+	margin-top: 0em;
+	margin-bottom: 0em;
+}
+.contenu .detail {
+	margin-left: 2em;
+}
+.contenu .detail .important {
+	color: #a02020;
+}
+.extrait {
+	margin: 0.1em;
+	margin-top: 0.5em;
+	margin-bottom: 0.5em;
+	margin-left: 2em;
+	margin-right: 0.1em;
+	line-height: 1.4em;
+}
+.liste-articles {
+	margin-top: 1em;
+	margin-bottom: 1em;
+	clear: left;
+}
+.contenu .forum-repondre {
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+	text-align: left;
+	font-size: 90%;
+	font-weight: bold;
+	margin-top: 0.6em;
+}
+
+
+/*
+ * Disposition a l'ecran : colonnes, encarts, cartouches
+ */
+
+#principal {
+	position: absolute;
+	left: 30%;
+	/*left: 18em;*/
+	top: 0px;
+	margin: 0px;
+	padding: 0px;
+	/*margin-right: 2em;*/
+	margin-right: 3%;
+	margin-top: 1.5em;
+}
+
+#plan {
+	position: absolute;
+	left: 2em;
+	top: 0px;
+	margin: 0px;
+	padding: 0px;
+	margin-right: 2em;
+	margin-top: 2em;
+}
+
+#navigation {
+	position: absolute;
+	left: 0px;
+	top: 0px;
+	width: 24%;
+	/*width: 14em;*/
+	padding: 0px;
+	margin: 0px;
+	/*margin-left: 1.8em;*/
+	margin-left: 3%;
+	margin-top: 1.5em;
+}
+
+.encart {
+	float: right;
+	/*width: 14em;*/
+	width: 34%;
+	margin-left: 4%;
+	/*margin-left: 2em;*/
+	margin-top: 1em;
+	margin-bottom: 0em;
+	margin-right: 0px;
+}
+
+.cartouche {
+	padding-top: 1em;
+	border-top: 2px solid #404040;
+	margin-bottom: 0em;
+}
+
+.cartouche .spip_logos {
+	margin-left: 0px;
+	padding-left: 0px;
+	margin-right: 0.8em;
+}
+
+
+/*
+ * Habillage du plan du site
+ */
+
+.plan-secteur {
+	margin-top: 0em;
+	margin-bottom: 3em;
+	clear: right;
+}
+
+.plan-secteur h1 {
+	display: block;
+	border: 1px solid #a0a0a0;
+	margin: 0px;
+	padding: 8px;
+	font-size: 150%;
+	font-weight: bold;
+	background-color: #e0ffe0;
+	text-align:center;
+}
+.plan-rubriques {
+	clear: left;
+	display: block;
+	list-style: none;
+}
+.plan-rubrique {
+	display: inline;
+	border: 1px solid #a0a0a0;
+	padding: 3px;
+	font-weight: bold;
+}
+.plan-articles {
+	clear: left;
+	margin-top: 0.5em;
+	margin-bottom: 1em;
+	list-style: square;
+}
+
+/* Eclaircissement progressif des rubriques en fonction de la profondeur */
+
+ul .plan-rubrique {
+	background-color: #e0ffe0;
+	border-color: #b8b8b8;
+}
+ul ul .plan-rubrique {
+	background-color: #eaffea;
+	border-color: #d0d0d0;
+}
+ul ul ul .plan-rubrique {
+	background-color: #f4fff4;
+	border-color: #e8e8e8;
+}
+
+
+/*
+ * Habillage des forums
+ */
+
+ul.forum-total {
+	display: block;
+	padding: 0px;
+	margin: 0px;
+	list-style: none;
+}
+.forum-fil {
+	margin-top: 3em;
+}
+.forum-fil ul {
+	display: block;
+	margin: 0px;
+	margin-left: 2em;
+	padding: 0px;
+	list-style: none;
+}
+.forum-titre {
+	font-weight: bold;
+	font-size: 120%;
+}
+.forum-item {
+	margin: 0px;
+	padding: 1em;
+	padding-top: 0.5em;
+	padding-bottom: 0em;
+	text-align: justify;
+	color: #303030;
+	font-size: 80%;
+}
+.forum-repondre-message {
+	text-align: right;
+}
+
+/* Boite d'un forum : eclaircissement progressif des bords */
+
+ul .forum {
+	border: 1px solid #909090;
+	padding: 0px;
+	margin: 0px;
+	margin-bottom: 1em;
+}
+ul ul .forum {
+	border: 1px solid #a4a4a4;
+}
+ul ul ul .forum {
+	border: 1px solid #b8b8b8;
+}
+ul ul ul ul .forum {
+	border: 1px solid #cccccc;
+}
+ul ul ul ul ul .forum {
+	border: 1px solid #e0e0e0;
+}
+ul ul ul ul ul ul .forum {
+	border: 1px dashed #e0e0e0;
+}
+
+/* Boite de titre d'un forum : mise en couleur selon la profondeur du forum */
+
+ul .forum-chapo {
+	border: 0px;
+	border-bottom: 1px dashed #b8b8b8;
+	margin: 0px;
+	padding-left: 6px;
+	padding-right: 6px;
+	padding-top: 3px;
+	padding-bottom: 2px;
+	font-size: 90%;
+	background: #c4e0e0;
+}
+ul ul .forum-chapo {
+	background: #d4e8e8;
+}
+ul ul ul .forum-chapo {
+	background: #e4f0f0;
+}
+ul ul ul ul .forum-chapo {
+	background: #f4f8f8;
+}
+ul ul ul ul ul .forum-chapo {
+	background: #ffffff;
+}
+
+
+/*
+ * Habillage des petitions
+ */
+
+.signatures {
+	margin-left: 0px;
+	margin-right: 0px;
+	margin-top: 1em;
+	margin-bottom: 1em;
+	width: 100%;
+}
+.signatures td {
+	-moz-border-radius: 0.4em;
+}
+.signatures-titre {
+	clear: right;
+	font-weight: bold;
+	font-size: 120%;
+	text-align: center;
+	padding: 0.5em;
+	margin: 0px;
+}
+.signature-date {
+	white-space: nowrap;
+	background: #e4f0f0;
+	padding: 0.5em;
+}
+.signature-nom {
+	font-weight: bold;
+	background: #ecf4f4;
+	padding: 0.2em;
+	text-align: center;
+}
+.signature-message {
+	font-size: 85%;
+	background: #f4f8f8;
+	padding: 0.4em;
+	text-align: justify;
+}
+
+
+/*
+ * Formulaires
+ */
+
+.formrecherche {
+	background-color: #f2f2f2;
+	color: #505030;
+	margin: 0px;
+	padding: 2px;
+	border: solid 1px #909090;
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+	font-size: 80%;
+	font-weight: normal;
+}
+
+.formulaire {
+	color: black;
+	margin: 0px;
+	margin-bottom: 16px;
+	padding: 4px;
+	border: 1px solid #a0a0a0;
+	background-color: #f6f6f6;
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+	font-size: 80%;
+	font-weight: normal;
+}
+.forml {
+	background-color: #ececec;
+	margin: 4px;
+	padding: 1px;
+	border: dashed 1px #909090;
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+	font-size: 90%;
+}
+.spip_bouton {
+	border: 2px solid #404040;
+	padding: 3px;
+	background: #d0d0d0;
+	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
+}
+
+.spip-admin {
+}
+
+

Index: htaccess-html.txt
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/htaccess-html.txt,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- htaccess-html.txt	13 Jan 2005 15:37:14 -0000	1.1
+++ htaccess-html.txt	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,17 +1,17 @@
-###########################################################
-# Fichier .htaccess pour les URLs 'html' ; a installer    #
-# si vous reglez $type_urls='html'                        #
-# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
-# (fichier associe : inc-urls-html.php3)                  #
-###########################################################
-
-RewriteEngine On
-
-### si votre site est en sous-domaine, preciser ci-dessous
-# RewriteBase /sous/domaine/
-
-RewriteRule ^rubrique([0-9]+)\.html$	rubrique.php3?id_rubrique=$1 [QSA,L]
-RewriteRule ^article([0-9]+)\.html$		article.php3?id_article=$1 [QSA,L]
-RewriteRule ^breve([0-9]+)\.html$		breve.php3?id_breve=$1 [QSA,L]
-RewriteRule ^mot([0-9]+)\.html$			mot.php3?id_mot=$1 [QSA,L]
-RewriteRule ^auteur([0-9]+)\.html$		auteur.php3?id_auteur=$1 [QSA,L]
+###########################################################
+# Fichier .htaccess pour les URLs 'html' ; a installer    #
+# si vous reglez $type_urls='html'                        #
+# dans ecrire/mes_options.php3                            #
+# (fichier associe : inc-urls-html.php3)                  #
+###########################################################
+
+RewriteEngine On
+
+### si votre site est en sous-domaine, preciser ci-dessous
+# RewriteBase /sous/domaine/
+
+RewriteRule ^rubrique([0-9]+)\.html$	rubrique.php3?id_rubrique=$1 [QSA,L]
+RewriteRule ^article([0-9]+)\.html$		article.php3?id_article=$1 [QSA,L]
+RewriteRule ^breve([0-9]+)\.html$		breve.php3?id_breve=$1 [QSA,L]
+RewriteRule ^mot([0-9]+)\.html$			mot.php3?id_mot=$1 [QSA,L]
+RewriteRule ^auteur([0-9]+)\.html$		auteur.php3?id_auteur=$1 [QSA,L]

Index: htaccess-propres.txt
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/htaccess-propres.txt,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- htaccess-propres.txt	13 Jan 2005 15:37:14 -0000	1.1
+++ htaccess-propres.txt	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,36 +1,36 @@
-###########################################################
-# Fichier .htaccess pour les URLs propres ; a installer   #
-# si vous reglez $type_urls='propre'                      #
-# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
-# (fichier associe : inc-urls-propres.php3)               #
-###########################################################
-
-RewriteEngine On
-
-### si votre site est en sous-domaine, preciser ci-dessous
-# RewriteBase /sous/domaine/
-
-# Rediriger les mots et breves sans le &quot;+&quot; final
-RewriteCond %{REQUEST_FILENAME} !-f
-RewriteCond %{REQUEST_FILENAME} !-d
-RewriteRule ^(\+[^/\.\+]+)$ /$1+ [QSA,R]
-
-# Les mots-cles
-RewriteCond %{REQUEST_FILENAME} !-f
-RewriteCond %{REQUEST_FILENAME} !-d
-RewriteRule ^\+-[^/\.]+-\+$ mot.php3 [QSA,E=url_propre:$0]
-
-# Les breves
-RewriteCond %{REQUEST_FILENAME} !-f
-RewriteCond %{REQUEST_FILENAME} !-d
-RewriteRule ^\+[^/\.]+\+$ breve.php3 [QSA,E=url_propre:$0]
-
-# Les rubriques
-RewriteCond %{REQUEST_FILENAME} !-f
-RewriteCond %{REQUEST_FILENAME} !-d
-RewriteRule ^-[^/\.]+-$ rubrique.php3 [QSA,E=url_propre:$0]
-
-# Les articles
-RewriteCond %{REQUEST_FILENAME} !-f
-RewriteCond %{REQUEST_FILENAME} !-d
-RewriteRule ^[^/\.]+$ article.php3 [QSA,E=url_propre:$0]
+###########################################################
+# Fichier .htaccess pour les URLs propres ; a installer   #
+# si vous reglez $type_urls='propres'                     #
+# dans ecrire/mes_options.php3                            #
+# (fichier associe : inc-urls-propres.php3)               #
+###########################################################
+
+RewriteEngine On
+
+### si votre site est en sous-domaine, preciser ci-dessous
+# RewriteBase /sous/domaine/
+
+# Rediriger les mots et breves sans le &quot;+&quot; final
+RewriteCond %{REQUEST_FILENAME} !-f
+RewriteCond %{REQUEST_FILENAME} !-d
+RewriteRule ^(\+[^/\.\+]+)$ /$1+ [QSA,R]
+
+# Les mots-cles
+RewriteCond %{REQUEST_FILENAME} !-f
+RewriteCond %{REQUEST_FILENAME} !-d
+RewriteRule ^\+-[^/\.]+-\+$ mot.php3 [QSA,E=url_propre:$0]
+
+# Les breves
+RewriteCond %{REQUEST_FILENAME} !-f
+RewriteCond %{REQUEST_FILENAME} !-d
+RewriteRule ^\+[^/\.]+\+$ breve.php3 [QSA,E=url_propre:$0]
+
+# Les rubriques
+RewriteCond %{REQUEST_FILENAME} !-f
+RewriteCond %{REQUEST_FILENAME} !-d
+RewriteRule ^-[^/\.]+-$ rubrique.php3 [QSA,E=url_propre:$0]
+
+# Les articles
+RewriteCond %{REQUEST_FILENAME} !-f
+RewriteCond %{REQUEST_FILENAME} !-d
+RewriteRule ^[^/\.]+$ article.php3 [QSA,E=url_propre:$0]

Index: ical.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ical.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- ical.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ ical.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,12 +1,12 @@
-&lt;?php
-
-$fond = &quot;ical&quot;;
-$delais = 3600;
-
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at header</A> (&quot;content-type:text/calendar&quot;);
-
-$flag_preserver=true;
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+
+$fond = &quot;ical&quot;;
+$delais = 3600;
+
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A> (&quot;content-type:text/calendar&quot;);
+
+$flag_preserver=true;
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: impression.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/impression.css,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- impression.css	13 Jan 2005 15:37:14 -0000	1.1
+++ impression.css	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,114 +1,114 @@
-
-/*
- * Feuille de style specifique a l'impression
- */
- 
-/* Pour les liens, on desactive les couleurs
-   et on affiche l'URL cible a la suite du lien (!) */
-
-a { color: black; text-decoration: underline; }
-a:visited { color: black; text-decoration: underline; }
-a.spip_in { color: black; text-decoration: underline; }
-a.spip_out { color: black; text-decoration: underline; }
-a:after {
-	display: inline;
-	border: 1px solid dotted;
-	content: &quot; [&quot; attr(href) &quot;]&quot;;
-}
-
-/*
- * Un peu de coquetterie
- */
-
-.chapo {
-	line-height: 1.4em;
-	margin-top: 1em;
-}
-.texte {
-}
-.ps {
-	padding-top: 0.6em;
-	margin-top: 0.6em;
-	border-top: 1px dashed #404040;
-}
-.notes {
-	margin-top: 0.6em;
-	margin-bottom: 0.6em;
-	border-top: 1px solid #707070;
-}
-.structure {
-	display: none;
-}
-.spip-admin {
-	display: none;
-}
-
-
-.contenu {
-	margin: 10px;
-}
-.contenu h1 {
-	margin-top: 0em;
-	margin-bottom: 0em;
-}
-.contenu h1.titre-extrait {
-}
-.contenu h1.titre-texte {
-}
-.contenu .surtitre {
-	margin-top: 0em;
-	margin-bottom: 0em;
-}
-.contenu .detail {
-	margin-left: 2em;
-}
-.extrait {
-	margin-top: 0.5em;
-	margin-bottom: 0.5em;
-	margin-left: 2em;
-	margin-right: 0em;
-	line-height: 1.4em;
-}
-
-
-/*
- * Disposition : on elimine les elements de navigation (display: none)
- * et on choisit un affichage de base pour le principal
- */
-
-#principal {
-	margin: 10px;
-}
-
-#navigation {
-	display: none;
-}
-
-.encart {
-	display: none;
-}
-
-.cartouche {
-	margin-top: 0.5em;
-	padding-top: 1em;
-	margin-bottom: 1em;
-}
-
-.cartouche .spip_logos {
-	margin-left: 0px;
-	padding-left: 0px;
-	margin-right: 0.8em;
-}
-
-
-/*
- * Forums
- */
-
-.forum-repondre {
-	display: none;
-}
-.forum-repondre-message {
-	display: none;
-}
-
+
+/*
+ * Feuille de style specifique a l'impression
+ */
+ 
+/* Pour les liens, on desactive les couleurs
+   et on affiche l'URL cible a la suite du lien (!) */
+
+a { color: black; text-decoration: underline; }
+a:visited { color: black; text-decoration: underline; }
+a.spip_in { color: black; text-decoration: underline; }
+a.spip_out { color: black; text-decoration: underline; }
+a:after {
+	display: inline;
+	border: 1px solid dotted;
+	content: &quot; [&quot; attr(href) &quot;]&quot;;
+}
+
+/*
+ * Un peu de coquetterie
+ */
+
+.chapo {
+	line-height: 1.4em;
+	margin-top: 1em;
+}
+.texte {
+}
+.ps {
+	padding-top: 0.6em;
+	margin-top: 0.6em;
+	border-top: 1px dashed #404040;
+}
+.notes {
+	margin-top: 0.6em;
+	margin-bottom: 0.6em;
+	border-top: 1px solid #707070;
+}
+.structure {
+	display: none;
+}
+.spip-admin {
+	display: none;
+}
+
+
+.contenu {
+	margin: 10px;
+}
+.contenu h1 {
+	margin-top: 0em;
+	margin-bottom: 0em;
+}
+.contenu h1.titre-extrait {
+}
+.contenu h1.titre-texte {
+}
+.contenu .surtitre {
+	margin-top: 0em;
+	margin-bottom: 0em;
+}
+.contenu .detail {
+	margin-left: 2em;
+}
+.extrait {
+	margin-top: 0.5em;
+	margin-bottom: 0.5em;
+	margin-left: 2em;
+	margin-right: 0em;
+	line-height: 1.4em;
+}
+
+
+/*
+ * Disposition : on elimine les elements de navigation (display: none)
+ * et on choisit un affichage de base pour le principal
+ */
+
+#principal {
+	margin: 10px;
+}
+
+#navigation {
+	display: none;
+}
+
+.encart {
+	display: none;
+}
+
+.cartouche {
+	margin-top: 0.5em;
+	padding-top: 1em;
+	margin-bottom: 1em;
+}
+
+.cartouche .spip_logos {
+	margin-left: 0px;
+	padding-left: 0px;
+	margin-right: 0.8em;
+}
+
+
+/*
+ * Forums
+ */
+
+.forum-repondre {
+	display: none;
+}
+.forum-repondre-message {
+	display: none;
+}
+

Index: inc-admin.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-admin.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-admin.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-admin.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,17 +1,50 @@
-&lt;?php
-
-// Inserer la feuille de style selon les normes, dans le &lt;head&gt;
-// Feuilles de style admin : d'abord la CSS officielle, puis la perso,
-function perso_admin($texte) {
-	$css = &quot;&lt;link rel='stylesheet' href='spip_admin.css' type='text/css' /&gt;\n&quot;;
-	if (@file_exists('spip_admin_perso.css'))
-		$css2 = &quot;&lt;link rel='stylesheet' href='spip_admin_perso.css' type='text/css' /&gt;\n&quot;;
-
-	if (eregi('&lt;(/head|body)', $texte, $regs)) {
-		$texte = explode($regs[0], $texte, 2);
-		return $texte[0] . $css. $css2 . $regs[0] . $texte[1];
-	} else
-		return $css . $css2 . $texte;
-}
-
-?&gt;
+&lt;?php
+
+// Inserer la feuille de style selon les normes, dans le &lt;head&gt;
+// puis les boutons
+// Feuilles de style admin : d'abord la CSS officielle, puis la perso,
+
+function affiche_boutons_admin($contenu) {
+	$css = &quot;&lt;link rel='stylesheet' href='spip_admin.css' type='text/css' /&gt;\n&quot;;
+	if ($f = find_in_path('spip_admin_perso.css'))
+		$css2 = &quot;&lt;link rel='stylesheet' href='$f' type='text/css' /&gt;\n&quot;;
+
+	if (preg_match('@&lt;(/head|body)@i', $contenu, $regs)) {
+		$contenu = explode($regs[0], $contenu, 2);
+		$contenu = $contenu[0] . $css. $css2 . $regs[0] . $contenu[1];
+	} else
+		$contenu = $css . $css2 . $contenu;
+
+	if (preg_match('@&lt;(/body|/html)@i', $contenu, $regs)) {
+		$split = explode($regs[0], $contenu, 2);
+		$contenu = $split[0];
+		$suite = $regs[0].$split[1];
+	}
+
+	echo $contenu;
+
+	//
+	// Regler les boutons dans la langue de l'admin (sinon tant pis)
+	//
+	include_local(_FILE_CONNECT);
+	include_ecrire (&quot;inc_lang.php3&quot;);
+	$login = addslashes(ereg_replace('^@','',$GLOBALS['spip_admin']));
+	if ($row = spip_fetch_array(spip_query(&quot;SELECT lang FROM spip_auteurs WHERE login='$login'&quot;))) {
+		$lang = $row['lang'];
+	}
+	lang_select($lang);
+
+	// Afficher la balise #FORMULAIRE_ADMIN mais en float
+	inclure_balise_dynamique(
+		balise_formulaire_admin_dyn(
+		$GLOBALS['id_article'], $GLOBALS['id_breve'],
+		$GLOBALS['id_rubrique'], $GLOBALS['id_mot'],
+		$GLOBALS['id_auteur'], 'div'
+	));
+
+	lang_dselect();
+
+	return $suite;
+}
+
+?&gt;

Index: inc-balises.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-balises.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-balises.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-balises.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,684 +1,732 @@
-&lt;?php
-
-//
-// Ce fichier regroupe la quasi totalite des definitions de #BALISES de spip
-// Pour chaque balise, il est possible de surcharger, dans mes_fonctions.php3,
-// la fonction balise_TOTO_dist par une fonction balise_TOTO() respectant la
-// meme API : 
-// elle recoit en entree un objet de classe CHAMP, le modifie et le retourne.
-// Cette classe est definie dans inc-compilo-index.php3
-//
-
[...1385 lines suppressed...]
+// La syntaxe #ENV{toto, rempl} renverra 'rempl' si $toto est vide
+//
+function balise_ENV_dist($p) {
+	$nom = param_balise($p);
+	if (!$nom) {
+		// cas de #ENV sans argument : on retourne le serialize() du tableau
+		// une belle fonction [(#ENV|affiche_env)] serait pratique
+		$p-&gt;code = 'serialize($Pile[0])';
+		$p-&gt;statut = 'html';
+	} else {
+		// admet deux arguments : nom de variable, valeur par defaut si vide
+		$nom = split(',', $nom, 2);
+		$p-&gt;code = 'sinon($Pile[0][&quot;' . addslashes($nom[0]) . '&quot;],
+			\''. texte_script($nom[1]) .'\')';
+		$p-&gt;statut = 'php';
+	}
+	return $p;
+}
+
+?&gt;

Index: inc-boucles.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-boucles.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-boucles.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-boucles.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,232 +1,232 @@
-&lt;?php
-
-//
-// Ce fichier definit les boucles standard de SPIP
-//
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_BOUCLES&quot;)) return;
-define(&quot;_INC_BOUCLES&quot;, &quot;1&quot;);
-
-
-//
-// Boucle sur une table hors SPIP
-//
-function boucle_DEFAUT($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$boucle-&gt;from[] =  $boucle-&gt;type_requete . &quot; AS &quot; . $boucle-&gt;type_requete;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(BOUCLE)&gt; boucle dite recursive
-//
-function boucle_BOUCLE_dist($id_boucle, &amp;$boucles) {
-
-	    return &quot;\n	\$t0 = &quot; . $boucles[$id_boucle]-&gt;return . &quot;;&quot;;
-}
-
-//
-// &lt;BOUCLE(ARTICLES)&gt;
-//
-function boucle_ARTICLES_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;articles AS $id_table&quot;;
-	if (!$GLOBALS['var_preview']) {
-		$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
-		if (lire_meta(&quot;post_dates&quot;) == 'non')
-			$boucle-&gt;where[] = &quot;$id_table.date &lt; NOW()&quot;;
-	} else
-		$boucle-&gt;where[] = &quot;$id_table.statut IN ('publie','prop')&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-//
-// &lt;BOUCLE(AUTEURS)&gt;
-//
-function boucle_AUTEURS_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;auteurs AS $id_table&quot;;
-	// Si pas de lien avec un article, selectionner
-	// uniquement les auteurs d'un article publie
-	if (!$GLOBALS['var_preview'])
-	if (!$boucle-&gt;lien AND !$boucle-&gt;tout) {
-		$boucle-&gt;from[] =  &quot;auteurs_articles AS lien&quot;;
-		$boucle-&gt;from[] =  &quot;articles AS articles&quot;;
-		$boucle-&gt;where[] = &quot;lien.id_auteur=$id_table.id_auteur&quot;;
-		$boucle-&gt;where[] = 'lien.id_article=articles.id_article';
-		$boucle-&gt;where[] = &quot;articles.statut='publie'&quot;;
-		$boucle-&gt;group =  $boucle-&gt;id_table . '.' . $boucle-&gt;primary;
-	}
-	// pas d'auteurs poubellises
-	$boucle-&gt;where[] = &quot;NOT($id_table.statut='5poubelle')&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-//
-// &lt;BOUCLE(BREVES)&gt;
-//
-function boucle_BREVES_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;breves AS $id_table&quot;;
-	if (!$GLOBALS['var_preview'])
-		$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
-	else
-		$boucle-&gt;where[] = &quot;$id_table.statut IN ('publie','prop')&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(FORUMS)&gt;
-//
-function boucle_FORUMS_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;forum AS $id_table&quot;;
-	// Par defaut, selectionner uniquement les forums sans pere
-	if (!$boucle-&gt;tout AND !$boucle-&gt;plat) 
-		{
-	$boucle-&gt;where[] = &quot;$id_table.id_parent=0&quot;;
-		}
-	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(SIGNATURES)&gt;
-//
-function boucle_SIGNATURES_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;signatures AS $id_table&quot;;
-	$boucle-&gt;from[] =  &quot;petitions AS petitions&quot;;
-	$boucle-&gt;from[] =  &quot;articles articles&quot;;
-	$boucle-&gt;where[] = &quot;petitions.id_article=articles.id_article&quot;;
-	$boucle-&gt;where[] = &quot;petitions.id_article=$id_table.id_article&quot;;
-	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
-	$boucle-&gt;group =  $boucle-&gt;id_table . '.' . $boucle-&gt;primary;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(DOCUMENTS)&gt;
-//
-function boucle_DOCUMENTS_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;documents AS $id_table&quot;;
-	$boucle-&gt;from[] =  &quot;types_documents AS types_documents&quot;;
-	$boucle-&gt;where[] = &quot;$id_table.id_type=types_documents.id_type&quot;;
-	$boucle-&gt;where[] = &quot;$id_table.taille &gt; 0&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(TYPES_DOCUMENTS)&gt;
-//
-function boucle_TYPES_DOCUMENTS_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;types_documents AS $id_table&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(GROUPES_MOTS)&gt;
-//
-function boucle_GROUPES_MOTS_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;groupes_mots AS $id_table&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(MOTS)&gt;
-//
-function boucle_MOTS_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;mots AS $id_table&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(RUBRIQUES)&gt;
-//
-function boucle_RUBRIQUES_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;rubriques AS $id_table&quot;;
-	if (!$GLOBALS['var_preview'])
-		if (!$boucle-&gt;tout) $boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(HIERARCHIE)&gt;
-//
-function boucle_HIERARCHIE_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;rubriques AS $id_table&quot;;
-
-	// Si la boucle mere est une boucle RUBRIQUES il faut ignorer la feuille
-	// sauf si le critere {tout} est present (cf. inc-html-squel)
-	$exclure_feuille = ($boucle-&gt;tout ? 'false' : 'true');
-
-	// $hierarchie sera calculee par une fonction de inc-calcul-outils
-	$boucle-&gt;where[] = 'id_rubrique IN ($hierarchie)';
-	$boucle-&gt;select[] = 'FIND_IN_SET(id_rubrique, \'$hierarchie\')-1 AS rang';
-	$boucle-&gt;order = 'rang';
-	$boucle-&gt;hierarchie = '$hierarchie = calculer_hierarchie('
-	. calculer_argument_precedent($boucle-&gt;id_boucle, 'id_rubrique', $boucles)
-	. ', '
-	. $exclure_feuille
-	. ');';
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(SYNDICATION)&gt;
-//
-function boucle_SYNDICATION_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;syndic AS $id_table&quot;;
-	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-//
-// &lt;BOUCLE(SYNDIC_ARTICLES)&gt;
-//
-function boucle_SYNDIC_ARTICLES_dist($id_boucle, &amp;$boucles) {
-	$boucle = &amp;$boucles[$id_boucle];
-	$id_table = $boucle-&gt;id_table;
-	$boucle-&gt;from[] =  &quot;syndic_articles  AS $id_table&quot;;
-	$boucle-&gt;from[] =  &quot;syndic AS syndic&quot;;
-	$boucle-&gt;where[] = &quot;$id_table.id_syndic=syndic.id_syndic&quot;;
-	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
-	$boucle-&gt;where[] = &quot;syndic.statut='publie'&quot;;
-	$boucle-&gt;select[]='syndic.nom_site AS nom_site'; # derogation zarbi
-	$boucle-&gt;select[]='syndic.url_site AS url_site'; # idem
-	return calculer_boucle($id_boucle, $boucles); 
-}
-
-
-?&gt;
+&lt;?php
+
+//
+// Ce fichier definit les boucles standard de SPIP
+//
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_BOUCLES&quot;)) return;
+define(&quot;_INC_BOUCLES&quot;, &quot;1&quot;);
+
+
+//
+// Boucle sur une table hors SPIP
+//
+function boucle_DEFAUT($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$boucle-&gt;from[] =  $boucle-&gt;type_requete . &quot; AS &quot; . $boucle-&gt;type_requete;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(BOUCLE)&gt; boucle dite recursive
+//
+function boucle_BOUCLE_dist($id_boucle, &amp;$boucles) {
+
+	    return &quot;\n	\$t0 = &quot; . $boucles[$id_boucle]-&gt;return . &quot;;&quot;;
+}
+
+//
+// &lt;BOUCLE(ARTICLES)&gt;
+//
+function boucle_ARTICLES_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_articles AS $id_table&quot;;
+	if (!$GLOBALS['var_preview']) {
+		$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
+		if (lire_meta(&quot;post_dates&quot;) == 'non')
+			$boucle-&gt;where[] = &quot;$id_table.date &lt; NOW()&quot;;
+	} else
+		$boucle-&gt;where[] = &quot;$id_table.statut IN ('publie','prop')&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+//
+// &lt;BOUCLE(AUTEURS)&gt;
+//
+function boucle_AUTEURS_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_auteurs AS $id_table&quot;;
+	// Si pas de lien avec un article, selectionner
+	// uniquement les auteurs d'un article publie
+	if (!$GLOBALS['var_preview'])
+	if (!$boucle-&gt;lien AND !$boucle-&gt;tout) {
+		$boucle-&gt;from[] =  &quot;spip_auteurs_articles AS lien&quot;;
+		$boucle-&gt;from[] =  &quot;spip_articles AS articles&quot;;
+		$boucle-&gt;where[] = &quot;lien.id_auteur=$id_table.id_auteur&quot;;
+		$boucle-&gt;where[] = 'lien.id_article=articles.id_article';
+		$boucle-&gt;where[] = &quot;articles.statut='publie'&quot;;
+		$boucle-&gt;group =  $boucle-&gt;id_table . '.' . $boucle-&gt;primary;
+	}
+	// pas d'auteurs poubellises
+	$boucle-&gt;where[] = &quot;NOT($id_table.statut='5poubelle')&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+//
+// &lt;BOUCLE(BREVES)&gt;
+//
+function boucle_BREVES_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_breves AS $id_table&quot;;
+	if (!$GLOBALS['var_preview'])
+		$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
+	else
+		$boucle-&gt;where[] = &quot;$id_table.statut IN ('publie','prop')&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(FORUMS)&gt;
+//
+function boucle_FORUMS_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_forum AS $id_table&quot;;
+	// Par defaut, selectionner uniquement les forums sans pere
+	if (!$boucle-&gt;tout AND !$boucle-&gt;plat) 
+		{
+	$boucle-&gt;where[] = &quot;$id_table.id_parent=0&quot;;
+		}
+	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(SIGNATURES)&gt;
+//
+function boucle_SIGNATURES_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_signatures AS $id_table&quot;;
+	$boucle-&gt;from[] =  &quot;spip_petitions AS petitions&quot;;
+	$boucle-&gt;from[] =  &quot;spip_articles articles&quot;;
+	$boucle-&gt;where[] = &quot;petitions.id_article=articles.id_article&quot;;
+	$boucle-&gt;where[] = &quot;petitions.id_article=$id_table.id_article&quot;;
+	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
+	$boucle-&gt;group =  $boucle-&gt;id_table . '.' . $boucle-&gt;primary;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(DOCUMENTS)&gt;
+//
+function boucle_DOCUMENTS_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_documents AS $id_table&quot;;
+	$boucle-&gt;from[] =  &quot;spip_types_documents AS types_documents&quot;;
+	$boucle-&gt;where[] = &quot;$id_table.id_type=types_documents.id_type&quot;;
+	$boucle-&gt;where[] = &quot;$id_table.taille &gt; 0&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(TYPES_DOCUMENTS)&gt;
+//
+function boucle_TYPES_DOCUMENTS_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_types_documents AS $id_table&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(GROUPES_MOTS)&gt;
+//
+function boucle_GROUPES_MOTS_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_groupes_mots AS $id_table&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(MOTS)&gt;
+//
+function boucle_MOTS_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_mots AS $id_table&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(RUBRIQUES)&gt;
+//
+function boucle_RUBRIQUES_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_rubriques AS $id_table&quot;;
+	if (!$GLOBALS['var_preview'])
+		if (!$boucle-&gt;tout) $boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(HIERARCHIE)&gt;
+//
+function boucle_HIERARCHIE_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_rubriques AS $id_table&quot;;
+
+	// Si la boucle mere est une boucle RUBRIQUES il faut ignorer la feuille
+	// sauf si le critere {tout} est present (cf. inc-html-squel)
+	$exclure_feuille = ($boucle-&gt;tout ? 'false' : 'true');
+
+	// $hierarchie sera calculee par une fonction de inc-calcul-outils
+	$boucle-&gt;where[] = 'id_rubrique IN ($hierarchie)';
+	$boucle-&gt;select[] = 'FIND_IN_SET(id_rubrique, \'$hierarchie\')-1 AS rang';
+	$boucle-&gt;default_order = 'rang';
+	$boucle-&gt;hierarchie = '$hierarchie = calculer_hierarchie('
+	. calculer_argument_precedent($boucle-&gt;id_boucle, 'id_rubrique', $boucles)
+	. ', '
+	. $exclure_feuille
+	. ');';
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(SYNDICATION)&gt;
+//
+function boucle_SYNDICATION_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_syndic AS $id_table&quot;;
+	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+//
+// &lt;BOUCLE(SYNDIC_ARTICLES)&gt;
+//
+function boucle_SYNDIC_ARTICLES_dist($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$id_table = $boucle-&gt;id_table;
+	$boucle-&gt;from[] =  &quot;spip_syndic_articles  AS $id_table&quot;;
+	$boucle-&gt;from[] =  &quot;spip_syndic AS syndic&quot;;
+	$boucle-&gt;where[] = &quot;$id_table.id_syndic=syndic.id_syndic&quot;;
+	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
+	$boucle-&gt;where[] = &quot;syndic.statut='publie'&quot;;
+	$boucle-&gt;select[]='syndic.nom_site AS nom_site'; # derogation zarbi
+	$boucle-&gt;select[]='syndic.url_site AS url_site'; # idem
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+
+?&gt;

Index: inc-cache.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-cache.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-cache.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-cache.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,202 +1,202 @@
-&lt;?php
-
-//
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_CACHE&quot;)) return;
-define(&quot;_INC_CACHE&quot;, &quot;1&quot;);
-
-
-//
-// Calcul du nom du fichier cache
-//
-
-function nettoyer_uri() {
-	$fichier_requete = $GLOBALS['REQUEST_URI'];
-	$fichier_requete = eregi_replace
-		('[?&amp;](PHPSESSID|(var_[^=&amp;]*))=[^&amp;]*',
-		'', $fichier_requete);
-	return $fichier_requete;
-}
-
-//
-// Le format souhaite : &quot;CACHE/a/(8400/)bout-d-url.md5(.gz)&quot;
-// Attention a modifier simultanement le sanity check de
-// la fonction retire_cache()
-//
-function generer_nom_fichier_cache($contexte='', $fond='') {
-	global $delais;
-	global $flag_gz, $compresser_cache;
-
-	if ($delais == 0) return '';
-
-	if (!$contexte) {
-		$fichier_requete = nettoyer_uri();
-	} else {
-		$fichier_requete = $fond;
-		foreach ($contexte as $var=&gt;$val)
-			$fichier_requete .= &quot;&amp;$var=$val&quot;;
-	}
-
-	$md_cache = md5($fichier_requete);
-
-	$fichier_cache = ereg_replace('^/+', '', $fichier_requete);
-	$fichier_cache = ereg_replace('\.[a-zA-Z0-9]*', '', $fichier_cache);
-	$fichier_cache = ereg_replace('&amp;[^&amp;]+=([^&amp;]+)', '&amp;\1', $fichier_cache);
-	$fichier_cache = rawurlencode(strtr($fichier_cache, '/&amp;-', '--_'));
-	if (strlen($fichier_cache) &gt; 24)
-		$fichier_cache = substr(ereg_replace('([a-zA-Z]{1,3})[^-]*-',
-		'\1-', $fichier_cache), -22);
-
-	// Pour la page d'accueil
-	if (!$fichier_cache)
-		$fichier_cache = 'INDEX-';
-
-	// morceau de md5
-	$fichier_cache .= '.'.substr($md_cache, 1, 8);
-
-	// Sous-repertoires 0...9a..f/
-	$subdir = creer_repertoire(_DIR_CACHE, substr($md_cache, 0, 1));
-	// Sous-sous-repertoires delais/ (inutile avec l'invalidation par 't')
-	# $subdir2 = creer_repertoire(&quot;CACHE/$subdir&quot;, $delais);
-
-	include_ecrire('inc_acces.php3');
-	verifier_htaccess(_DIR_CACHE);
-
-	$gzip = $flag_gz &amp;&amp; $compresser_cache ? '.gz' : '';
-
-	return _DIR_CACHE . $subdir.$subdir2.$fichier_cache.$gzip;
-}
-
-//
-// Destruction des fichiers caches invalides
-//
-// NE PAS appeler ces fonctions depuis l'espace prive 
-// car openbase_dir peut leur interdire l'acces au repertoire de cache
-
-// Securite : est sur que c'est un cache
-function retire_cache($cache) {
-	if ($GLOBALS['flag_ecrire']) return;
-	if (preg_match('|^' . _DIR_CACHE .
-		&quot;([0-9a-f]/)?([0-9]+/)?[^.][\-_\%0-9a-z]+\.[0-9a-f]+(\.gz)?$|i&quot;,
-		       $cache)) {
-		// supprimer le fichier (de facon propre)
-		supprimer_fichier($cache);
-	} else
-		spip_log(&quot;Impossible de retirer $cache&quot;);
-}
-
-// Supprimer les caches marques &quot;x&quot;
-function retire_caches() {
-	if ($GLOBALS['flag_ecrire']) return;
-
-	// signaler
-	effacer_meta('invalider');
-	ecrire_metas();
-
-	// recuperer la liste des caches voues a la suppression
-	$suppr = array();
-	$q = spip_query(&quot;SELECT fichier FROM spip_caches WHERE type='x'&quot;);
-	while ($r = spip_fetch_array($q))
-		$suppr[$r['fichier']] = true;
-
-	if ($n = count($suppr)) {
-		spip_log (&quot;Retire $n caches&quot;);
-		foreach ($suppr as $cache =&gt; $ignore)
-			retire_cache($cache);
-		spip_query(&quot;DELETE FROM spip_caches WHERE &quot;
-		.calcul_mysql_in('fichier', &quot;'&quot;.join(&quot;','&quot;,$suppr).&quot;'&quot;) );
-	}
-}
-
-//
-// Retourne 0 s'il faut calculer le cache, 1 si on peut l'utiliser
-//
-function utiliser_cache($chemin_cache, $delais) {
-	global $HTTP_SERVER_VARS;
-
-	// ne jamais calculer pour les moteurs de recherche, proxies...
-	if ($HTTP_SERVER_VARS['REQUEST_METHOD'] == 'HEAD')
-		return 1;
-
-	//  calcul par forcage
-	if ($GLOBALS['var_mode'] &amp;&amp;
-		($GLOBALS['HTTP_COOKIE_VARS']['spip_session']
-		|| $GLOBALS['HTTP_COOKIE_VARS']['spip_admin']
-		|| @file_exists(_ACCESS_FILE_NAME))) # insuffisant...
-		return 0;
-
-	// calcul par absence
-	if (!@file_exists($chemin_cache)) return 0;
-
-	// calcul par obsolescence
-	return ((time() - @filemtime($chemin_cache)) &gt; $delais) ? 0 : 1;
-}
-
-
-// Obsolete ?  Utilisee pour vider le cache depuis l'espace prive
-// (ou juste les squelettes si un changement de config le necessite)
-function purger_repertoire($dir, $age='ignore', $regexp = '') {
-	$handle = @opendir($dir);
-	if (!$handle) return;
-
-	while (($fichier = @readdir($handle)) != '') {
-		// Eviter &quot;.&quot;, &quot;..&quot;, &quot;.htaccess&quot;, etc.
-		if ($fichier[0] == '.') continue;
-		if ($regexp AND !ereg($regexp, $fichier)) continue;
-		$chemin = &quot;$dir/$fichier&quot;;
-		if (is_file($chemin))
-			@unlink($chemin);
-		else if (is_dir($chemin))
-			if ($fichier != 'CVS')
-				purger_repertoire($chemin);
-	}
-	closedir($handle);
-}
-
-function purger_cache() {
-	spip_log('vider le cache');
-	include_ecrire('inc_invalideur.php3');
-	supprime_invalideurs();
-	purger_repertoire(_DIR_CACHE, 0);
-}
-
-function purger_squelettes() {
-	spip_log('effacer les squelettes compiles');
-	purger_repertoire(_DIR_CACHE, 0, '^skel_');
-}
-
-
-// Determination du fichier cache (si besoin)
-function determiner_cache($delais, &amp;$use_cache, &amp;$chemin_cache) {
-
-	// Le fichier cache est-il valide ?
-	if ($delais == 0 OR !empty($GLOBALS['HTTP_POST_VARS'])) {
-		$use_cache = 0;
-		$chemin_cache = '';
-	} else {
-		$use_cache = utiliser_cache($chemin_cache, $delais);
-	}
-
-	// Sinon, tester qu'on a la connexion a la base
-	if (!$use_cache) {
-		include_local(_FILE_CONNECT);
-		if (!$GLOBALS['db_ok']) {
-			if ($chemin_cache AND @file_exists($chemin_cache)) {
-				$use_cache = 1;
-			}
-			else {
-				spip_log(&quot;Erreur base de donnees &amp; &quot;
-					. &quot;impossible utiliser $chemin_cache&quot;);
-				if (!$GLOBALS['flag_preserver']) {
-					include_ecrire('inc_presentation.php3');
-					install_debut_html(_T('info_travaux_titre'));
-					echo _T('titre_probleme_technique');
-					install_fin_html();
-				}
-				exit;
-			}
-		}
-	}
-}
-
-?&gt;
+&lt;?php
+
+//
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_CACHE&quot;)) return;
+define(&quot;_INC_CACHE&quot;, &quot;1&quot;);
+
+
+//
+// Calcul du nom du fichier cache
+//
+
+function nettoyer_uri() {
+	$fichier_requete = $GLOBALS['REQUEST_URI'];
+	$fichier_requete = eregi_replace
+		('[?&amp;](PHPSESSID|(var_[^=&amp;]*))=[^&amp;]*',
+		'', $fichier_requete);
+	return $fichier_requete;
+}
+
+//
+// Le format souhaite : &quot;CACHE/a/(8400/)bout-d-url.md5(.gz)&quot;
+// Attention a modifier simultanement le sanity check de
+// la fonction retire_cache()
+//
+function generer_nom_fichier_cache($contexte='', $fond='') {
+	global $delais;
+	global $flag_gz, $compresser_cache;
+
+	if ($delais == 0) return '';
+
+	if (!$contexte) {
+		$fichier_requete = nettoyer_uri();
+	} else {
+		$fichier_requete = $fond;
+		foreach ($contexte as $var=&gt;$val)
+			$fichier_requete .= &quot;&amp;$var=$val&quot;;
+	}
+
+	$md_cache = md5($fichier_requete);
+
+	$fichier_cache = ereg_replace('^/+', '', $fichier_requete);
+	$fichier_cache = ereg_replace('\.[a-zA-Z0-9]*', '', $fichier_cache);
+	$fichier_cache = ereg_replace('&amp;[^&amp;]+=([^&amp;]+)', '&amp;\1', $fichier_cache);
+	$fichier_cache = rawurlencode(strtr($fichier_cache, '/&amp;-', '--_'));
+	if (strlen($fichier_cache) &gt; 24)
+		$fichier_cache = substr(ereg_replace('([a-zA-Z]{1,3})[^-]*-',
+		'\1-', $fichier_cache), -22);
+
+	// Pour la page d'accueil
+	if (!$fichier_cache)
+		$fichier_cache = 'INDEX-';
+
+	// morceau de md5
+	$fichier_cache .= '.'.substr($md_cache, 1, 8);
+
+	// Sous-repertoires 0...9a..f/
+	$subdir = creer_repertoire(_DIR_CACHE, substr($md_cache, 0, 1));
+	// Sous-sous-repertoires delais/ (inutile avec l'invalidation par 't')
+	# $subdir2 = creer_repertoire(&quot;CACHE/$subdir&quot;, $delais);
+
+	include_ecrire('inc_acces.php3');
+	verifier_htaccess(_DIR_CACHE);
+
+	$gzip = $flag_gz &amp;&amp; $compresser_cache ? '.gz' : '';
+
+	return _DIR_CACHE . $subdir.$subdir2.$fichier_cache.$gzip;
+}
+
+//
+// Destruction des fichiers caches invalides
+//
+// NE PAS appeler ces fonctions depuis l'espace prive 
+// car openbase_dir peut leur interdire l'acces au repertoire de cache
+
+// Securite : est sur que c'est un cache
+function retire_cache($cache) {
+	if (!_DIR_RESTREINT) return;
+	if (preg_match('|^' . _DIR_CACHE .
+		&quot;([0-9a-f]/)?([0-9]+/)?[^.][\-_\%0-9a-z]+\.[0-9a-f]+(\.gz)?$|i&quot;,
+		       $cache)) {
+		// supprimer le fichier (de facon propre)
+		supprimer_fichier($cache);
+	} else
+		spip_log(&quot;Impossible de retirer $cache&quot;);
+}
+
+// Supprimer les caches marques &quot;x&quot;
+function retire_caches() {
+	if (!_DIR_RESTREINT) return;
+
+	// signaler
+	effacer_meta('invalider');
+	ecrire_metas();
+
+	// recuperer la liste des caches voues a la suppression
+	$suppr = array();
+	$q = spip_query(&quot;SELECT fichier FROM spip_caches WHERE type='x'&quot;);
+	while ($r = spip_fetch_array($q))
+		$suppr[$r['fichier']] = true;
+
+	if ($n = count($suppr)) {
+		spip_log (&quot;Retire $n caches&quot;);
+		foreach ($suppr as $cache =&gt; $ignore)
+			retire_cache($cache);
+		spip_query(&quot;DELETE FROM spip_caches WHERE &quot;
+		.calcul_mysql_in('fichier', &quot;'&quot;.join(&quot;','&quot;,array_keys($suppr)).&quot;'&quot;) );
+	}
+}
+
+//
+// Retourne 0 s'il faut calculer le cache, 1 si on peut l'utiliser
+//
+function utiliser_cache($chemin_cache, $delais) {
+	global $_SERVER;
+
+	// ne jamais calculer pour les moteurs de recherche, proxies...
+	if ($_SERVER['REQUEST_METHOD'] == 'HEAD')
+		return 1;
+
+	//  calcul par forcage
+	if ($GLOBALS['var_mode'] &amp;&amp;
+		($GLOBALS['_COOKIE']['spip_session']
+		|| $GLOBALS['_COOKIE']['spip_admin']
+		|| @file_exists(_ACCESS_FILE_NAME))) # insuffisant...
+		return 0;
+
+	// calcul par absence
+	if (!@file_exists($chemin_cache)) return 0;
+
+	// calcul par obsolescence
+	return ((time() - @filemtime($chemin_cache)) &gt; $delais) ? 0 : 1;
+}
+
+
+// Obsolete ?  Utilisee pour vider le cache depuis l'espace prive
+// (ou juste les squelettes si un changement de config le necessite)
+function purger_repertoire($dir, $age='ignore', $regexp = '') {
+	$handle = @opendir($dir);
+	if (!$handle) return;
+
+	while (($fichier = @readdir($handle)) != '') {
+		// Eviter &quot;.&quot;, &quot;..&quot;, &quot;.htaccess&quot;, etc.
+		if ($fichier[0] == '.') continue;
+		if ($regexp AND !ereg($regexp, $fichier)) continue;
+		$chemin = &quot;$dir/$fichier&quot;;
+		if (is_file($chemin))
+			@unlink($chemin);
+		else if (is_dir($chemin))
+			if ($fichier != 'CVS')
+				purger_repertoire($chemin);
+	}
+	closedir($handle);
+}
+
+function purger_cache() {
+	spip_log('vider le cache');
+	include_ecrire('inc_invalideur.php3');
+	supprime_invalideurs();
+	purger_repertoire(_DIR_CACHE, 0);
+}
+
+function purger_squelettes() {
+	spip_log('effacer les squelettes compiles');
+	purger_repertoire(_DIR_CACHE, 0, '^skel_');
+}
+
+
+// Determination du fichier cache (si besoin)
+function determiner_cache($delais, &amp;$use_cache, &amp;$chemin_cache) {
+
+	// Le fichier cache est-il valide ?
+	if ($delais == 0 OR !empty($GLOBALS['_POST'])) {
+		$use_cache = 0;
+		$chemin_cache = '';
+	} else {
+		$use_cache = utiliser_cache($chemin_cache, $delais);
+	}
+
+	// Sinon, tester qu'on a la connexion a la base
+	if (!$use_cache) {
+		include_local(_FILE_CONNECT);
+		if (!$GLOBALS['db_ok']) {
+			if ($chemin_cache AND @file_exists($chemin_cache)) {
+				$use_cache = 1;
+			}
+			else {
+				spip_log(&quot;Erreur base de donnees &amp; &quot;
+					. &quot;impossible utiliser $chemin_cache&quot;);
+				if (!$GLOBALS['flag_preserver']) {
+					include_ecrire('inc_presentation.php3');
+					install_debut_html(_T('info_travaux_titre'));
+					echo _T('titre_probleme_technique');
+					install_fin_html();
+				}
+				exit;
+			}
+		}
+	}
+}
+
+?&gt;

Index: inc-calcul-outils.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-calcul-outils.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-calcul-outils.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-calcul-outils.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,410 +1,403 @@
-&lt;?php
-
-//
-// Des fonctions diverses utilisees lors du calcul d'une page ; ces fonctions
-// bien pratiques n'ont guere de logique organisationnelle ; elles sont
-// appelees par certaines balises au moment du calcul des pages. (Peut-on
-// trouver un modele de donnees qui les associe physiquement au fichier
-// definissant leur balise ???
-//
-
-// ON TROUVERA EN QUEUE DE FICHIER LES FONCTIONS FAISANT DES APPELS SQL
-
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_CALCUL_OUTILS&quot;)) return;
-define(&quot;_INC_CALCUL_OUTILS&quot;, &quot;1&quot;);
-
-// Pour les documents comme pour les logos, le filtre |fichier donne
-// le chemin du fichier apres 'IMG/' ;  peut-etre pas d'une purete
-// remarquable, mais a conserver pour compatibilite ascendante.
-// -&gt; <A HREF="http://www.spip.net/fr_article901.html">http://www.spip.net/fr_article901.html</A>
-function calcule_fichier_logo($on) {
-	$r = ereg_replace(&quot;^&quot; . _DIR_IMG, &quot;&quot;, $on);
-	return $r;
-}
-
-// Renvoie le code html pour afficher un logo, avec ou sans survol, lien, etc.
-// utilise la globale ci-dessous pour les attributs hspace &amp; vspace
-
-tester_variable('espace_logos',3);
-
-function affiche_logos($logos, $lien, $align) {
-	static $num_survol=0;
-	global $espace_logos;
-	list ($arton, $artoff) = $logos;
-
-	if (!$arton) return $artoff;
-
-	$num_survol++;
-	$milieu = &quot;&lt;img src='$arton'&quot;
-		. ($align ? &quot; align='$align' &quot; : '') 
-		. &quot; name='image$num_survol' border='0' &quot;
-		. &quot;alt='image$num_survol'&quot;
-		. &quot; hspace='$espace_logos' vspace='$espace_logos' class='spip_logos' /&gt;&quot;;
-
-	if (!$artoff) return ($lien ? http_href($lien, $milieu) : $milieu);
-
-	$att =	&quot;onmouseover=\&quot;image$num_survol.src='$artoff'\&quot; 
-		onmouseout=\&quot;image$num_survol.src='$arton'\&quot;&quot;;
-
-	return ($lien ? &quot;&lt;a href='$lien' $att&gt;$milieu&lt;/a&gt;&quot; : &quot;&lt;div $att&gt;$milieu&lt;/div&gt;&quot;);
-
-}
-
-//
-// Retrouver le logo d'un objet (et son survol)
-//
-
-function calcule_logo($type, $onoff, $id, $id_rubrique, $ff) {
-	include_ecrire('inc_logos.php3');
-
-	$table_logos = array (
-	'ARTICLE' =&gt; 'art',
-	'AUTEUR' =&gt;  'aut',
-	'BREVE' =&gt;  'breve',
-	'MOT' =&gt; 'mot',
-	'RUBRIQUE' =&gt; 'rub',
-	'SITE' =&gt; 'site'
-	);
-	$type = $table_logos[$type];
-	$nom = strtolower($onoff);
-	# attention au cas $id = '0' pour LOGO_SITE_SPIP : utiliser intval()
-	while (1) {
-		$on = cherche_image_nommee($type . $nom . intval($id));
-		if ($on) {
-			if ($ff)
-			  return  (array('', &quot;$on[1].$on[2]&quot;));
-			else {
-				$off = ($onoff != 'ON') ? '' :
-					cherche_image_nommee($type . 'off' . $id);
-				return array (&quot;$on[0]$on[1].$on[2]&quot;,
-					      ($off ? (&quot;$off[0]$off[1].$off[2]&quot;) : ''));
-			}
-		}
-		else if ($id_rubrique) {
-			$type = 'rub';
-			$id = $id_rubrique;
-			$id_rubrique = 0;
-		} else if ($id AND $type == 'rub')
-			$id = sql_parent($id);
-		else return array('','');
-	}
-}
-
-//
-// fonction standard de calcul de la balise #INTRODUCTION
-// on peut la surcharger en definissant dans mes_fonctions.php3 :
-// function introduction($type,$texte,$chapo,$descriptif) {...}
-//
-function calcul_introduction ($type, $texte, $chapo='', $descriptif='') {
-	if (function_exists(&quot;introduction&quot;))
-		return introduction ($type, $texte, $chapo, $descriptif);
-
-	switch ($type) {
-		case 'articles':
-			if ($descriptif)
-				return propre($descriptif);
-			else if (substr($chapo, 0, 1) == '=')	// article virtuel
-				return '';
-			else
-				return PtoBR(propre(supprimer_tags(couper_intro($chapo.&quot;\n\n\n&quot;.$texte, 500))));
-			break;
-		case 'breves':
-			return PtoBR(propre(supprimer_tags(couper_intro($texte, 300))));
-			break;
-		case 'forums':
-			return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
-			break;
-		case 'rubriques':
-			if ($descriptif)
-				return propre($descriptif);
-			else
-				return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
-			break;
-	}
-}
-
-function executer_balise_dynamique($nom, $args, $filtres) {
-	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
-	include_local($file);
-
-	$f = 'balise_' . $nom . '_stat';
-	$r = $f($args, $filtres);
-	if (!is_array($r))
-		return $r;
-	else { 
-		return
-		('&lt;'.'?php 
-include_ecrire(\'inc_lang.php3\');
-lang_select($GLOBALS[&quot;spip_lang&quot;]);
-include_local(&quot;'
-		. $file
-		. '&quot;);
-inclure_balise_dynamique(balise_'
-		. $nom
-		. '_dyn(\''
-		. join(&quot;', '&quot;, array_map(&quot;addslashes&quot;, $r))
-		. '\'));
-	lang_dselect();
-?'
-		.&quot;&gt;&quot;);
-	}
-}
-
-//
-// FONCTIONS FAISANT DES APPELS SQL
-//
-
-# NB : a l'exception des fonctions pour les balises dynamiques
-
-function calcul_exposer ($id, $type, $reference) {
-	static $exposer;
-	static $ref_precedente;
-
-	// Que faut-il exposer ? Tous les elements de $reference
-	// ainsi que leur hierarchie ; on ne fait donc ce calcul
-	// qu'une fois (par squelette) et on conserve le resultat
-	// en static.
-	if ($reference&lt;&gt;$ref_precedente) {
-		$ref_precedente = $reference;
-
-		$exposer = array();
-		foreach ($reference as $element=&gt;$id_element) {
-			if ($element == 'id_secteur') $element = 'id_rubrique';
-			if ($x = table_from_primary($element)) {
-				list($table,$hierarchie) = $x;
-				$exposer[$element][$id_element] = true;
-				if ($hierarchie) {
-					list ($id_rubrique) = spip_abstract_fetsel(
-array('id_rubrique'), 
-array($table),
-array(&quot;$element=$id_element&quot;));
-				$hierarchie = substr(calculer_hierarchie($id_rubrique), 2);
-				foreach (split(',',$hierarchie) as $id_rubrique)
-					$exposer['id_rubrique'][$id_rubrique] = true;
-				}
-			}
-		}
-	}
-
-	// And the winner is...
-	return $exposer[$type][$id];
-}
-
-function table_from_primary($id) {
-	global $tables_principales;
-	include_ecrire('inc_serialbase.php3');
-	foreach ($tables_principales as $k =&gt; $v) {
-		if ($v['key']['PRIMARY KEY'] == $id)
-			return array($k, array_key_exists('id_rubrique', $v['field']));
-	}
-	return '';
-}
-
-function calcul_generation ($generation) {
-	$lesfils = array();
-	$result = spip_abstract_select(array('id_rubrique'),
-				array('rubriques AS rubriques'),
-				array(calcul_mysql_in('id_parent', 
-					$generation,
-					'')),
-				'','','','','','','');
-	while ($row = spip_abstract_fetch($result))
-		$lesfils[] = $row['id_rubrique'];
-	return join(&quot;,&quot;,$lesfils);
-}
-
-function calcul_branche ($generation) {
-	if (!$generation) 
-		return '0';
-	else {
-		$branche[] = $generation;
-		while ($generation = calcul_generation ($generation))
-			$branche[] = $generation;
-		return join(&quot;,&quot;,$branche);
-	}
-}
-
-// fonction appelee par la balise #LOGO_DOCUMENT
-function calcule_document($id_document, $doubdoc, &amp;$doublons) {
-	if (!$id_document) return '';
-	if ($doubdoc &amp;&amp; $id_document) $doublons[&quot;documents&quot;] .= ', ' . $id_document;
-
-	if (!($row = spip_abstract_select(array('id_type', 'id_vignette', 'fichier', 'mode'), array('documents AS documents'), array(&quot;id_document = $id_document&quot;))))
-// pas de document. Ne devrait pas arriver
-		return ''; 
-
-	list($id_type, $id_vignette, $fichier, $mode) = spip_abstract_fetch($row);
-	if ($id_vignette) {
-		if ($res = spip_abstract_select(array('fichier'), array('documents AS documents'), array(&quot;id_document = $id_vignette&quot;))) {
-			list($vignette) = spip_abstract_fetch($res);
-			if (@file_exists($vignette))
-				return generer_url_document($id_vignette);
-				# return ($fichier); # en std g_u_d fait ca
-		}
-	} else if ($mode == 'vignette') 
-		return generer_url_document($id_document);
-		# return $fichier; # en std g_u_d fait ca
-
-// calcul de l'extension par tous les moyens
-	if ($id_type) {
-		list($ext) = spip_abstract_fetch(spip_abstract_select(array('extension'), array('types_documents AS documents'), array(&quot;id_type = &quot; . intval($id_type))));
-	} else {
-		eregi('\.([a-z0-9]+)$', $fichier, $regs);
-		$ext = $regs[1];
-	}
-// Pas de vignette mais une extension:
-// prendre la vignette de celle-ci dans IMG/icones sauf si on peut faire mieux
-	$formats = ','.lire_meta('formats_graphiques').',';
-	if ((strpos($formats, &quot;,$ext,&quot;) === false) OR
-	!$fichier OR (lire_meta(&quot;creer_preview&quot;) != 'oui')) {
-		return vignette_par_defaut($ext ? $ext : 'txt', false);
-	}
-// on peut faire mieux dans le cas des images: une previsualisation
-// on devrait verifier que le fichier existe dans IMG/vignette
-// et sinon lancer creer_vignette (qui fera un UPDATE sur spip_documents)
-// mais on risque de d&#233;passer le temps alloue au processus
-	return 'spip_image.php3?vignette='.rawurlencode(
-		str_replace('../', '', $fichier));
-}
-
-
-// fonction appelee par la balise #EMBED
-function calcule_embed_document($id_document, $filtres, &amp;$doublons, $doubdoc) {
-	if ($doubdoc &amp;&amp; $id_document) $doublons[&quot;documents&quot;] .= ', ' . $id_document;
-	return embed_document($id_document, $filtres, false);
-}
-
-// fonction appelee par la balise #NOTES
-function calculer_notes() {
-	$r = $GLOBALS[&quot;les_notes&quot;];
-	$GLOBALS[&quot;les_notes&quot;] = &quot;&quot;;
-	$GLOBALS[&quot;compt_note&quot;] = 0;
-	$GLOBALS[&quot;marqueur_notes&quot;] ++;
-	return $r;
-}
-
-# retourne la profondeur d'une rubrique
-
-function sql_profondeur($id) {
-	$n = 0;
-	while ($id) {
-		$n++;
-		$id = sql_parent($id);
-	}
-	return $n;
-}
-
-
-function sql_parent($id_rubrique) {
-	$row = spip_abstract_fetsel(array(id_parent), 
-			array('rubriques'), 
-			array(&quot;id_rubrique=&quot; . intval($id_rubrique)));
-	return $row['id_parent'];
-}
-
-function sql_rubrique($id_article) {
-	$row = spip_abstract_fetsel(array('id_rubrique'),
-			array('articles'),
-			array(&quot;id_article=&quot; . intval($id_article)));
-	return $row['id_rubrique'];
-}
-
-function sql_auteurs($id_article, $table, $id_boucle, $serveur='') {
-	$auteurs = &quot;&quot;;
-	if ($id_article) {
-		$result_auteurs = spip_abstract_select(array('auteurs.nom', 'auteurs.email'),
-			array('auteurs AS auteurs',
-				'auteurs_articles AS lien'), 
-			array(&quot;lien.id_article=$id_article&quot;,
-				&quot;auteurs.id_auteur=lien.id_auteur&quot;),
-			'','','','',1, 
-			$table, $id_boucle, $serveur);
-
-		while($row_auteur = spip_abstract_fetch($result_auteurs, $serveur)) {
-			$nom_auteur = typo($row_auteur[&quot;nom&quot;]);
-			$email_auteur = $row_auteur[&quot;email&quot;];
-			if ($email_auteur) {
-				$auteurs[] = &quot;&lt;a href=\&quot;mailto:$email_auteur\&quot;&gt;$nom_auteur&lt;/a&gt;&quot;;
-			} else {
-				$auteurs[] = &quot;$nom_auteur&quot;;
-			}
-		}
-	}
-	return (!$auteurs) ? &quot;&quot; : join($auteurs, &quot;, &quot;);
-}
-
-function sql_petitions($id_article, $table, $id_boucle, $serveur, &amp;$Cache) {
-	$retour = spip_abstract_fetsel(
-			array('id_article'),
-			array('petitions'),
-			array(&quot;id_article=&quot;.intval($id_article)),
-			'','','','',1, 
-			$table, $id_boucle, $serveur);
-
-	# cette page est invalidee par toute petition
-	if ($retour AND $Cache)
-		$Cache['petition']['petition'] = 1;
-
-	return ($retour ? $id_article : '');
-}
-
-# retourne le chapeau d'un article, et seulement s'il est publie
-
-function sql_chapo($id_article) {
-	return spip_abstract_fetsel(array('chapo'),
-		array('articles'),
-		array(&quot;id_article=&quot;.intval($id_article),
-		&quot;statut='publie'&quot;));
-}
-
-// Calcul de la rubrique associee a la requete
-// (selection de squelette specifique par id_rubrique &amp; lang)
-
-function sql_rubrique_fond($contexte, $lang) {
-
-	if ($id = intval($contexte['id_rubrique'])) {
-		$row = spip_abstract_fetsel(array('lang'),
-					    array('rubriques'),
-					    array(&quot;id_rubrique=$id&quot;));
-		if ($row['lang'])
-			$lang = $row['lang'];
-		return array ($id, $lang);
-	}
-
-	if ($id  = intval($contexte['id_breve'])) {
-		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
-			array('breves'), 
-			array(&quot;id_breve=$id&quot;));
-		$id_rubrique_fond = $row['id_rubrique'];
-		if ($row['lang'])
-			$lang = $row['lang'];
-		return array($id_rubrique_fond, $lang);
-	}
-
-	if ($id = intval($contexte['id_syndic'])) {
-		$row = spip_abstract_fetsel(array('id_rubrique'),
-			array('syndic'),
-			array(&quot;id_syndic=$id&quot;));
-		$id_rubrique_fond = $row['id_rubrique'];
-		$row = spip_abstract_fetsel(array('lang'),
-			array('rubriques'),
-			array(&quot;id_rubrique='$id_rubrique_fond'&quot;));
-		if ($row['lang'])
-			$lang = $row['lang'];
-		return array($id_rubrique_fond, $lang);
-	}
-
-	if ($id = intval($contexte['id_article'])) {
-		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
-			array('articles'),
-			array(&quot;id_article=$id&quot;));
-		$id_rubrique_fond = $row['id_rubrique'];
-		if ($row['lang'])
-			$lang = $row['lang'];
-		return array($id_rubrique_fond, $lang);
-	}
-}
-
+&lt;?php
+
+//
+// Des fonctions diverses utilisees lors du calcul d'une page ; ces fonctions
+// bien pratiques n'ont guere de logique organisationnelle ; elles sont
+// appelees par certaines balises au moment du calcul des pages. (Peut-on
+// trouver un modele de donnees qui les associe physiquement au fichier
+// definissant leur balise ???
+//
+
+// ON TROUVERA EN QUEUE DE FICHIER LES FONCTIONS FAISANT DES APPELS SQL
+
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_CALCUL_OUTILS&quot;)) return;
+define(&quot;_INC_CALCUL_OUTILS&quot;, &quot;1&quot;);
+
+// Pour les documents comme pour les logos, le filtre |fichier donne
+// le chemin du fichier apres 'IMG/' ;  peut-etre pas d'une purete
+// remarquable, mais a conserver pour compatibilite ascendante.
+// -&gt; <A HREF="http://www.spip.net/fr_article901.html">http://www.spip.net/fr_article901.html</A>
+function calcule_fichier_logo($on) {
+	$r = ereg_replace(&quot;^&quot; . _DIR_IMG, &quot;&quot;, $on);
+	return $r;
+}
+
+// Renvoie le code html pour afficher un logo, avec ou sans survol, lien, etc.
+// utilise la globale ci-dessous pour les attributs hspace &amp; vspace
+
+tester_variable('espace_logos',3);
+
+function affiche_logos($logos, $lien, $align) {
+	static $num_survol=0;
+	global $espace_logos;
+	list ($arton, $artoff) = $logos;
+
+	if (!$arton) return $artoff;
+
+	$num_survol++;
+	$milieu = &quot;&lt;img src='$arton'&quot;
+		. ($align ? &quot; align='$align' &quot; : '') 
+		. &quot; name='image$num_survol' border='0' &quot;
+		. &quot;alt='image$num_survol'&quot;
+		. &quot; hspace='$espace_logos' vspace='$espace_logos' class='spip_logos' /&gt;&quot;;
+
+	if (!$artoff) return ($lien ? http_href($lien, $milieu) : $milieu);
+
+	$att =	&quot;onmouseover=\&quot;image$num_survol.src='$artoff'\&quot; 
+		onmouseout=\&quot;image$num_survol.src='$arton'\&quot;&quot;;
+
+	return ($lien ? &quot;&lt;a href='$lien' $att&gt;$milieu&lt;/a&gt;&quot; : &quot;&lt;div $att&gt;$milieu&lt;/div&gt;&quot;);
+
+}
+
+//
+// Retrouver le logo d'un objet (et son survol)
+//
+
+function calcule_logo($type, $onoff, $id, $id_rubrique, $ff) {
+	include_ecrire('inc_logos.php3');
+
+	$table_logos = array (
+	'ARTICLE' =&gt; 'art',
+	'AUTEUR' =&gt;  'aut',
+	'BREVE' =&gt;  'breve',
+	'MOT' =&gt; 'mot',
+	'RUBRIQUE' =&gt; 'rub',
+	'SITE' =&gt; 'site'
+	);
+	$type = $table_logos[$type];
+	$nom = strtolower($onoff);
+	# attention au cas $id = '0' pour LOGO_SITE_SPIP : utiliser intval()
+	while (1) {
+		$on = cherche_image_nommee($type . $nom . intval($id));
+		if ($on) {
+			if ($ff)
+			  return  (array('', &quot;$on[1].$on[2]&quot;));
+			else {
+				$off = ($onoff != 'ON') ? '' :
+					cherche_image_nommee($type . 'off' . $id);
+				return array (&quot;$on[0]$on[1].$on[2]&quot;,
+					      ($off ? (&quot;$off[0]$off[1].$off[2]&quot;) : ''));
+			}
+		}
+		else if ($id_rubrique) {
+			$type = 'rub';
+			$id = $id_rubrique;
+			$id_rubrique = 0;
+		} else if ($id AND $type == 'rub')
+			$id = sql_parent($id);
+		else return array('','');
+	}
+}
+
+//
+// fonction standard de calcul de la balise #INTRODUCTION
+// on peut la surcharger en definissant dans mes_fonctions.php3 :
+// function introduction($type,$texte,$chapo,$descriptif) {...}
+//
+function calcul_introduction ($type, $texte, $chapo='', $descriptif='') {
+	if (function_exists(&quot;introduction&quot;))
+		return introduction ($type, $texte, $chapo, $descriptif);
+
+	switch ($type) {
+		case 'articles':
+			if ($descriptif)
+				return propre($descriptif);
+			else if (substr($chapo, 0, 1) == '=')	// article virtuel
+				return '';
+			else
+				return PtoBR(propre(supprimer_tags(couper_intro($chapo.&quot;\n\n\n&quot;.$texte, 500))));
+			break;
+		case 'breves':
+			return PtoBR(propre(supprimer_tags(couper_intro($texte, 300))));
+			break;
+		case 'forums':
+			return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
+			break;
+		case 'rubriques':
+			if ($descriptif)
+				return propre($descriptif);
+			else
+				return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
+			break;
+	}
+}
+
+function executer_balise_dynamique($nom, $args, $filtres, $lang) {
+	if ($file = find_in_path('inc-' . strtolower($nom) . _EXTENSION_PHP))
+		include_local($file);
+	else
+		die (&quot;pas de balise dynamique pour #&quot;. strtolower($nom).&quot; !&quot;);
+
+	$f = 'balise_' . $nom . '_stat';
+	$r = $f($args, $filtres);
+	return (!is_array($r)) ? $r : synthetiser_balise_dynamique($nom, $r, $file, $lang);
+}
+
+//
+// FONCTIONS FAISANT DES APPELS SQL
+//
+
+# NB : a l'exception des fonctions pour les balises dynamiques
+
+function calcul_exposer ($id, $type, $reference) {
+	static $exposer;
+	static $ref_precedente;
+
+	// Que faut-il exposer ? Tous les elements de $reference
+	// ainsi que leur hierarchie ; on ne fait donc ce calcul
+	// qu'une fois (par squelette) et on conserve le resultat
+	// en static.
+	if ($reference&lt;&gt;$ref_precedente) {
+		$ref_precedente = $reference;
+
+		$exposer = array();
+		foreach ($reference as $element=&gt;$id_element) {
+			if ($element == 'id_secteur') $element = 'id_rubrique';
+			if ($x = table_from_primary($element)) {
+				list($table,$hierarchie) = $x;
+				$exposer[$element][$id_element] = true;
+				if ($hierarchie) {
+					list ($id_rubrique) = spip_abstract_fetsel(
+array('id_rubrique'), 
+array($table),
+array(&quot;$element=$id_element&quot;));
+				$hierarchie = substr(calculer_hierarchie($id_rubrique), 2);
+				foreach (split(',',$hierarchie) as $id_rubrique)
+					$exposer['id_rubrique'][$id_rubrique] = true;
+				}
+			}
+		}
+	}
+
+	// And the winner is...
+	return $exposer[$type][$id];
+}
+
+function table_from_primary($id) {
+	global $tables_principales;
+	include_ecrire('inc_serialbase.php3');
+	foreach ($tables_principales as $k =&gt; $v) {
+		if ($v['key']['PRIMARY KEY'] == $id)
+			return array($k, array_key_exists('id_rubrique', $v['field']));
+	}
+	return '';
+}
+
+function calcul_generation ($generation) {
+	$lesfils = array();
+	$result = spip_abstract_select(array('id_rubrique'),
+				array('spip_rubriques AS rubriques'),
+				array(calcul_mysql_in('id_parent', 
+					$generation,
+					'')),
+				'','','','','','','');
+	while ($row = spip_abstract_fetch($result))
+		$lesfils[] = $row['id_rubrique'];
+	return join(&quot;,&quot;,$lesfils);
+}
+
+function calcul_branche ($generation) {
+	if (!$generation) 
+		return '0';
+	else {
+		$branche[] = $generation;
+		while ($generation = calcul_generation ($generation))
+			$branche[] = $generation;
+		return join(&quot;,&quot;,$branche);
+	}
+}
+
+// fonction appelee par la balise #LOGO_DOCUMENT
+function calcule_document($id_document, $doubdoc, &amp;$doublons) {
+	if (!$id_document) return '';
+	if ($doubdoc &amp;&amp; $id_document) $doublons[&quot;documents&quot;] .= ', ' . $id_document;
+
+	if (!($row = spip_abstract_select(array('id_type', 'id_vignette', 'fichier', 'mode'), array('spip_documents AS documents'), array(&quot;id_document = $id_document&quot;))))
+// pas de document. Ne devrait pas arriver
+		return ''; 
+
+	list($id_type, $id_vignette, $fichier, $mode) = spip_abstract_fetch($row);
+	if ($id_vignette) {
+		if ($res = spip_abstract_select(array('fichier'), array('spip_documents AS documents'), array(&quot;id_document = $id_vignette&quot;))) {
+			list($vignette) = spip_abstract_fetch($res);
+			if (@file_exists($vignette))
+				return generer_url_document($id_vignette);
+				# return ($fichier); # en std g_u_d fait ca
+		}
+	} else if ($mode == 'vignette') 
+		return generer_url_document($id_document);
+		# return $fichier; # en std g_u_d fait ca
+
+	// calcul de l'extension par tous les moyens
+	if ($id_type) {
+		list($ext) = spip_abstract_fetch(spip_abstract_select(array('extension'), array('spip_types_documents AS documents'), array(&quot;id_type = &quot; . intval($id_type))));
+	} else {
+		eregi('\.([a-z0-9]+)$', $fichier, $regs);
+		$ext = $regs[1];
+	}
+
+	// Pas de vignette mais une extension :
+	// envoyer une vignette par defaut
+	return vignette_par_defaut($ext ? $ext : 'txt', false);
+}
+
+
+// fonction appelee par la balise #EMBED
+function calcule_embed_document($id_document, $filtres, &amp;$doublons, $doubdoc) {
+	if ($doubdoc &amp;&amp; $id_document) $doublons[&quot;documents&quot;] .= ', ' . $id_document;
+	return embed_document($id_document, $filtres, false);
+}
+
+// fonction appelee par la balise #NOTES
+function calculer_notes() {
+	$r = $GLOBALS[&quot;les_notes&quot;];
+	$GLOBALS[&quot;les_notes&quot;] = &quot;&quot;;
+	$GLOBALS[&quot;compt_note&quot;] = 0;
+	$GLOBALS[&quot;marqueur_notes&quot;] ++;
+	return $r;
+}
+
+# retourne la profondeur d'une rubrique
+
+function sql_profondeur($id) {
+	$n = 0;
+	while ($id) {
+		$n++;
+		$id = sql_parent($id);
+	}
+	return $n;
+}
+
+
+function sql_parent($id_rubrique) {
+	$row = spip_abstract_fetsel(array(id_parent), 
+			array('spip_rubriques'), 
+			array(&quot;id_rubrique=&quot; . intval($id_rubrique)));
+	return $row['id_parent'];
+}
+
+function sql_rubrique($id_article) {
+	$row = spip_abstract_fetsel(array('id_rubrique'),
+			array('spip_articles'),
+			array(&quot;id_article=&quot; . intval($id_article)));
+	return $row['id_rubrique'];
+}
+
+function sql_auteurs($id_article, $table, $id_boucle, $serveur='') {
+	$auteurs = &quot;&quot;;
+	if ($id_article) {
+		$result_auteurs = spip_abstract_select(array('auteurs.nom', 'auteurs.email'),
+			array('spip_auteurs AS auteurs',
+				'spip_auteurs_articles AS lien'), 
+			array(&quot;lien.id_article=$id_article&quot;,
+				&quot;auteurs.id_auteur=lien.id_auteur&quot;),
+			'','','','',1, 
+			$table, $id_boucle, $serveur);
+
+		while($row_auteur = spip_abstract_fetch($result_auteurs, $serveur)) {
+			$nom_auteur = typo($row_auteur[&quot;nom&quot;]);
+			$email_auteur = $row_auteur[&quot;email&quot;];
+			if ($email_auteur) {
+				$auteurs[] = &quot;&lt;a href=\&quot;mailto:$email_auteur\&quot;&gt;$nom_auteur&lt;/a&gt;&quot;;
+			} else {
+				$auteurs[] = &quot;$nom_auteur&quot;;
+			}
+		}
+	}
+	return (!$auteurs) ? &quot;&quot; : join($auteurs, &quot;, &quot;);
+}
+
+function sql_petitions($id_article, $table, $id_boucle, $serveur, &amp;$Cache) {
+	$retour = spip_abstract_fetsel(
+			array('texte'),
+			array('spip_petitions'),
+			array(&quot;id_article=&quot;.intval($id_article)),
+			'','','','',1, 
+			$table, $id_boucle, $serveur);
+
+	if (!$retour) return '';
+	# cette page est invalidee par toute petition
+	if ($Cache) $Cache['petition']['petition'] = 1;
+	# ne pas retourner '' car le texte sert aussi de pr&#233;sence
+	return ($retour['texte'] ? $retour['texte'] : ' ');
+}
+
+# retourne le chapeau d'un article, et seulement s'il est publie
+
+function sql_chapo($id_article) {
+	if ($id_article)
+	return spip_abstract_fetsel(array('chapo'),
+		array('spip_articles'),
+		array(&quot;id_article=&quot;.intval($id_article),
+		&quot;statut='publie'&quot;));
+}
+
+# retourne le champ 'accepter_forum' d'un article
+function sql_accepter_forum($id_article) {
+	static $cache = array();
+
+	if (!$id_article) return;
+
+	if (!isset($cache[$id_article])) {
+		$row = spip_abstract_fetsel(array('accepter_forum'),
+			array('spip_articles'),
+			array(&quot;id_article=&quot;.intval($id_article)));
+		$cache[$id_article] = $row['accepter_forum'];
+	}
+
+	return $cache[$id_article];
+}
+
+
+// Calcul de la rubrique associee a la requete
+// (selection de squelette specifique par id_rubrique &amp; lang)
+
+function sql_rubrique_fond($contexte) {
+
+	if ($id = intval($contexte['id_rubrique'])) {
+		$row = spip_abstract_fetsel(array('lang'),
+					    array('spip_rubriques'),
+					    array(&quot;id_rubrique=$id&quot;));
+		if ($row['lang'])
+			$lang = $row['lang'];
+		return array ($id, $lang);
+	}
+
+	if ($id  = intval($contexte['id_breve'])) {
+		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
+			array('spip_breves'), 
+			array(&quot;id_breve=$id&quot;));
+		$id_rubrique_fond = $row['id_rubrique'];
+		if ($row['lang'])
+			$lang = $row['lang'];
+		return array($id_rubrique_fond, $lang);
+	}
+
+	if ($id = intval($contexte['id_syndic'])) {
+		$row = spip_abstract_fetsel(array('id_rubrique'),
+			array('spip_syndic'),
+			array(&quot;id_syndic=$id&quot;));
+		$id_rubrique_fond = $row['id_rubrique'];
+		$row = spip_abstract_fetsel(array('lang'),
+			array('spip_rubriques'),
+			array(&quot;id_rubrique='$id_rubrique_fond'&quot;));
+		if ($row['lang'])
+			$lang = $row['lang'];
+		return array($id_rubrique_fond, $lang);
+	}
+
+	if ($id = intval($contexte['id_article'])) {
+		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
+			array('spip_articles'),
+			array(&quot;id_article=$id&quot;));
+		$id_rubrique_fond = $row['id_rubrique'];
+		if ($row['lang'])
+			$lang = $row['lang'];
+		return array($id_rubrique_fond, $lang);
+	}
+}
+
 ?&gt;

Index: inc-calcul.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-calcul.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-calcul.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-calcul.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,284 +1,284 @@
-&lt;?php
-
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_CALCUL&quot;)) return;
-define(&quot;_INC_CALCUL&quot;, &quot;1&quot;);
-
-//
-// Ce fichier calcule une page en executant un squelette.
-//
-
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_index.php3&quot;);
-include_ecrire(&quot;inc_texte.php3&quot;);
-include_ecrire(&quot;inc_filtres.php3&quot;);
-include_ecrire(&quot;inc_lang.php3&quot;);
-include_ecrire(&quot;inc_documents.php3&quot;);
-include_ecrire(&quot;inc_abstract_sql.php3&quot;);
-include_ecrire(&quot;inc_forum.php3&quot;);
-include_ecrire(&quot;inc_debug_sql.php3&quot;);
-include_local(&quot;inc-calcul-outils.php3&quot;);
-
-// Ce fichier peut contenir une affectation de $dossier_squelettes  indiquant
-// le repertoire du source des squelettes (les pseudo-html avec BOUCLE...)
-
-if (@file_exists(&quot;mes_fonctions.php3&quot;)) 
-    include_local (&quot;mes_fonctions.php3&quot;);
-
-
-// Gestionnaire d'URLs
-if (@file_exists(&quot;inc-urls.php3&quot;))
-	include_local(&quot;inc-urls.php3&quot;);
-else
-	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
-
-
-// Le squelette compile est-il trop vieux ?
-function squelette_obsolete($skel, $squelette) {
-	return (
-		$GLOBALS['var_mode']
-		OR !@file_exists($skel)
-		OR (@filemtime($squelette) &gt; ($date = @filemtime($skel)))
-		OR (@filemtime('mes_fonctions.php3') &gt; $date)
-		OR (@filemtime(_FILE_OPTIONS) &gt; $date)
-	);
-}
-
-
-# Charge un squelette (au besoin le compile) 
-# et retoune le nom de sa fonction principale, ou '' s'il est indefini
-# Charge egalement un fichier homonyme de celui du squelette
-# mais de suffixe '_fonctions.php3' pouvant contenir:
-# - des filtres
-# - des fonctions de traduction de balise, de critere et de boucle
-# - des declaration de tables SQL supplementaires
-
-function charger_squelette ($squelette) {
-	$ext = $GLOBALS['extension_squelette'];
-	$nom = $ext . '_' . md5($squelette);
-	$sourcefile = $squelette . &quot;.$ext&quot;;
-
-	// le squelette est-il deja en memoire (INCLURE  a repetition)
-	if (function_exists($nom))
-		return $nom;
-
-	$phpfile = _DIR_CACHE . 'skel_' . $nom . '.php';
-
-	// le squelette est-il deja compile et perenne ?
-	if (!squelette_obsolete($phpfile, $sourcefile)
-	AND lire_fichier ($phpfile, $contenu,
-	array('critique' =&gt; 'oui', 'phpcheck' =&gt; 'oui'))) 
-		eval('?'.'&gt;'.$contenu);
-
-	// sinon, charger le compilateur et verifier que le source est lisible
-	if (!function_exists($nom)) {
-		include_local(&quot;inc-compilo.php3&quot;);
-		lire_fichier ($sourcefile, $skel);
-	}
-
-	// Le fichier suivant peut contenir entre autres:
-	// 1. les filtres utilises par le squelette
-	// 2. des ajouts au compilateur
-	// Le point 1 exige qu'il soit lu dans tous les cas.
-	// Le point 2 exige qu'il soit lu apres inc-compilo
-	// (car celui-ci initialise $tables_principales) mais avant la compil
-	$f = $squelette . '_fonctions.php3';
-	if (@file_exists($f)) include($f);
-
-	if (function_exists($nom)) return $nom;
-
-	$skel_code = calculer_squelette($skel, $nom, $ext, $sourcefile);
-
-	// Tester si le compilateur renvoie une erreur
-	if (is_array($skel_code))
-		erreur_squelette($skel_code[0], $skel_code[1]);
-	else {
-		if ($GLOBALS['var_mode'] == 'debug') {
-			include_ecrire(&quot;inc_debug_sql.php3&quot;);
-			debug_dumpfile ($skel_code, $nom, 'code');
-		}
-		eval('?'.'&gt;'.$skel_code);
-		if (function_exists($nom)) {
-			ecrire_fichier ($phpfile, $skel_code);
-			return $nom;
-		}
-	}
-}
-
-# Provoque la recherche du squelette $fond d'une $lang donnee,
-# et l'applique sur un $contexte pour un certain $cache.
-# Retourne un tableau de 3 elements:
-# 'texte' =&gt; la page calculee
-# 'process_ins' =&gt; 'html' ou 'php' si presence d'un '&lt; ?php'
-# 'invalideurs' =&gt; les invalideurs (cf inc-calcul-squel)
-
-# En cas d'erreur process_ins est absent et texte est un tableau de 2 chaines
-
-# La recherche est assuree par la fonction chercher_squelette,
-# definie dans inc-chercher, fichier non charge si elle est deja definie
-# (typiquement dans mes_fonctions.php3)
-
-function cherche_page ($cache, $contexte, $fond)  {
-	global $dossier_squelettes, $delais;
-
-	if (!function_exists('chercher_squelette'))
-		include_local(&quot;inc-chercher.php3&quot;); # a renommer ?
-
-	// Choisir entre $fond-dist.html, $fond=7.html, etc?
-	$id_rubrique_fond = 0;
-	// Si inc-urls veut fixer la langue, on la recupere ici
-	$lang = $contexte['lang'];
-	// Chercher le fond qui va servir de squelette
-	if ($r = sql_rubrique_fond($contexte,
-	$lang ? $lang : lire_meta('langue_site')))
-		list($id_rubrique_fond, $lang) = $r;
-
-	if (!$GLOBALS['forcer_lang'])
-		lang_select($lang);
-
-	$skel = chercher_squelette($fond,
-			$id_rubrique_fond,
-			$dossier_squelettes ? &quot;$dossier_squelettes/&quot; :'',
-			$GLOBALS['spip_lang']);
-
-	// Charger le squelette et recuperer sa fonction principale
-	// (compilation automatique au besoin) et calculer
-
-	$page = array();
-
-	if ($skel) {
-		if ($fonc = charger_squelette($skel))
-		  $page = $fonc(array('cache' =&gt; $cache), array($contexte));
-
-		// Passer la main au debuggueur)
-		if ($GLOBALS['var_mode'] == 'debug')
-		  {
-			include_ecrire(&quot;inc_debug_sql.php3&quot;);
-			debug_dumpfile ($page['texte'], $fonc, 'resultat');
-		  }
-	}
-
-	// Nettoyer le resultat si on est fou de XML
-	if ($GLOBALS['xhtml']) {
-		include_ecrire(&quot;inc_tidy.php&quot;);
-		$page['texte'] = xhtml($page['texte']);
-	}
-
-	// Entrer les invalideurs dans la base
-	if ($delais&gt;0) {
-		include_ecrire('inc_invalideur.php3');
-		maj_invalideurs($cache, $page['invalideurs'], $delais);
-	}
-
-	// Retourner la structure de la page
-
-	return $page;
-}
-
-
-//
-// Contexte : lors du calcul d'une page spip etablit le contexte a partir
-// des variables $HTTP_GET_VARS et $HTTP_POST_VARS, et leur ajoute la date
-// Note : pour hacker le contexte depuis le fichier d'appel (article.php3),
-// il est recommande de modifier $HTTP_GET_VARS['toto'] (meme si la page est
-// appelee avec la methode POST).
-//
-function calculer_contexte() {
-	foreach($GLOBALS['HTTP_GET_VARS'] as $var =&gt; $val) {
-		if (strpos($var, 'var_') !== 0)
-			$contexte[$var] = $val;
-	}
-	foreach($GLOBALS['HTTP_POST_VARS'] as $var =&gt; $val) {
-		if (strpos($var, 'var_') !== 0)
-			$contexte[$var] = $val;
-	}
-
-	if ($GLOBALS['date'])
-		$contexte['date'] = $contexte['date_redac'] = normaliser_date($GLOBALS['date']);
-	else
-		$contexte['date'] = $contexte['date_redac'] = date(&quot;Y-m-d H:i:s&quot;);
-
-	return $contexte;
-}
-
-function calculer_page_globale($cache, $contexte_local, $fond) {
-
-	// Gestion des URLs personnalises - sale mais historique
-	if (function_exists(&quot;recuperer_parametres_url&quot;)) {
-		global $contexte;
-		$contexte = $contexte_local;
-		recuperer_parametres_url($fond, nettoyer_uri());
-
-		// remettre les globales pour le bouton &quot;Modifier cet article&quot;
-		if (is_array($contexte))
-			foreach ($contexte as $var=&gt;$val)
-				if (substr($var,0,3) == 'id_')
-					$GLOBALS[$var] = $val;
-		$contexte_local = $contexte;
-	}
-
-	// Go to work !
-	$page = cherche_page($cache, $contexte_local, $fond);
-
-	$signal = array();
-	foreach(array('id_parent', 'id_rubrique', 'id_article', 'id_auteur',
-	'id_breve', 'id_forum', 'id_secteur', 'id_syndic', 'id_syndic_article',
-	'id_mot', 'id_groupe', 'id_document') as $val) {
-		if ($contexte_local[$val])
-			$signal['contexte'][$val] = intval($contexte_local[$val]);
-	}
-
-	$page['signal'] = $signal;
-
-	return $page;
-}
-
-
-// Cf ramener_page +cherche_page_incluante+ cherche_page_incluse chez ESJ
-function calculer_page($chemin_cache, $elements, $delais, $inclusion=false) {
-
-	// Inclusion
-	if ($inclusion) {
-		$contexte_inclus = $elements['contexte'];
-		$page = cherche_page($chemin_cache,
-			$contexte_inclus, $elements['fond']);
-	}
-	else {
-
-		// Page globale
-		// si le champ chapo commence par '=' c'est une redirection.
-		if ($id_article = intval($GLOBALS['id_article'])) {
-			if ($art = sql_chapo($id_article)) {
-				$chapo = $art['chapo'];
-				if (substr($chapo, 0, 1) == '=') {
-					include_ecrire('inc_texte.php3');
-					list(,$url) = extraire_lien(array('','','',
-					substr($chapo, 1)));
-					if ($url) { // sinon les navigateurs pataugent
-						$url = addslashes($url);
-						$page = array('texte' =&gt; &quot;&lt;&quot;.
-						&quot;?php header(\&quot;Location: $url\&quot;); ?&quot; . &quot;&gt;&quot;,
-						'process_ins' =&gt; 'php');
-					}
-				}
-			}
-		}
-		if (!$page)
-			$page = calculer_page_globale($chemin_cache,
-				$elements['contexte'],
-				$elements['fond']);
-	}
-
-	$page['signal']['process_ins'] = $page['process_ins'];
-	$signal = &quot;&lt;!-- &quot;.str_replace(&quot;\n&quot;, &quot; &quot;,
-	serialize($page['signal'])).&quot; --&gt;\n&quot;;
-
-	// Enregistrer le fichier cache
-	if ($delais &gt; 0 AND $GLOBALS['var_mode'] != 'debug'
-	AND empty($GLOBALS['HTTP_POST_VARS']))
-		ecrire_fichier($chemin_cache, $signal.$page['texte']);
-
-	return $page;
-}
-?&gt;
+&lt;?php
+
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_CALCUL&quot;)) return;
+define(&quot;_INC_CALCUL&quot;, &quot;1&quot;);
+
+//
+// Ce fichier calcule une page en executant un squelette.
+//
+
+include_ecrire(&quot;inc_meta.php3&quot;);
+include_ecrire(&quot;inc_index.php3&quot;);
+include_ecrire(&quot;inc_texte.php3&quot;);
+include_ecrire(&quot;inc_filtres.php3&quot;);
+include_ecrire(&quot;inc_lang.php3&quot;);
+include_ecrire(&quot;inc_documents.php3&quot;);
+include_ecrire(&quot;inc_abstract_sql.php3&quot;);
+include_ecrire(&quot;inc_forum.php3&quot;);
+include_ecrire(&quot;inc_debug_sql.php3&quot;);
+include_local(&quot;inc-calcul-outils.php3&quot;);
+
+// Ce fichier peut contenir une affectation de $dossier_squelettes  indiquant
+// le repertoire du source des squelettes (les pseudo-html avec BOUCLE...)
+
+if ($f = find_in_path(&quot;mes_fonctions.php3&quot;))
+	include_local ($f);
+
+
+// Gestionnaire d'URLs
+if (@file_exists(&quot;inc-urls.php3&quot;))
+	include_local(&quot;inc-urls.php3&quot;);
+else
+	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
+
+
+// Le squelette compile est-il trop vieux ?
+function squelette_obsolete($skel, $squelette) {
+	return (
+		$GLOBALS['var_mode']
+		OR !@file_exists($skel)
+		OR (@filemtime($squelette) &gt; ($date = @filemtime($skel)))
+		OR (@filemtime('mes_fonctions.php3') &gt; $date)
+		OR (@filemtime(_FILE_OPTIONS) &gt; $date)
+	);
+}
+
+
+# Charge un squelette (au besoin le compile) 
+# et retoune le nom de sa fonction principale, ou '' s'il est indefini
+# Charge egalement un fichier homonyme de celui du squelette
+# mais de suffixe '_fonctions.php3' pouvant contenir:
+# - des filtres
+# - des fonctions de traduction de balise, de critere et de boucle
+# - des declaration de tables SQL supplementaires
+
+function charger_squelette ($squelette) {
+	$ext = $GLOBALS['extension_squelette'];
+	$nom = $ext . '_' . md5($squelette);
+	$sourcefile = $squelette . &quot;.$ext&quot;;
+
+	// le squelette est-il deja en memoire (INCLURE  a repetition)
+	if (function_exists($nom))
+		return $nom;
+
+	$phpfile = _DIR_CACHE . 'skel_' . $nom . '.php';
+
+	// le squelette est-il deja compile et perenne ?
+	if (!squelette_obsolete($phpfile, $sourcefile)
+	AND lire_fichier ($phpfile, $contenu,
+	array('critique' =&gt; 'oui', 'phpcheck' =&gt; 'oui'))) 
+		eval('?'.'&gt;'.$contenu);
+
+	// sinon, charger le compilateur et verifier que le source est lisible
+	if (!function_exists($nom)) {
+		include_local(&quot;inc-compilo.php3&quot;);
+		lire_fichier ($sourcefile, $skel);
+	}
+
+	// Le fichier suivant peut contenir entre autres:
+	// 1. les filtres utilises par le squelette
+	// 2. des ajouts au compilateur
+	// Le point 1 exige qu'il soit lu dans tous les cas.
+	// Le point 2 exige qu'il soit lu apres inc-compilo
+	// (car celui-ci initialise $tables_principales) mais avant la compil
+	$f = $squelette . '_fonctions.php3';
+	if (@file_exists($f)) include($f);
+
+	if (function_exists($nom)) return $nom;
+
+	$skel_code = calculer_squelette($skel, $nom, $ext, $sourcefile);
+
+	// Tester si le compilateur renvoie une erreur
+	if (is_array($skel_code))
+		erreur_squelette($skel_code[0], $skel_code[1]);
+	else {
+		if ($GLOBALS['var_mode'] == 'debug') {
+			include_ecrire(&quot;inc_debug_sql.php3&quot;);
+			debug_dumpfile ($skel_code, $nom, 'code');
+		}
+		eval('?'.'&gt;'.$skel_code);
+		if (function_exists($nom)) {
+			ecrire_fichier ($phpfile, $skel_code);
+			return $nom;
+		}
+	}
+}
+
+# Provoque la recherche du squelette $fond d'une $lang donnee,
+# et l'applique sur un $contexte pour un certain $cache.
+# Retourne un tableau de 3 elements:
+# 'texte' =&gt; la page calculee
+# 'process_ins' =&gt; 'html' ou 'php' si presence d'un '&lt; ?php'
+# 'invalideurs' =&gt; les invalideurs (cf inc-calcul-squel)
+
+# En cas d'erreur process_ins est absent et texte est un tableau de 2 chaines
+
+# La recherche est assuree par la fonction chercher_squelette,
+# definie dans inc-chercher, fichier non charge si elle est deja definie
+# (typiquement dans mes_fonctions.php3)
+
+function cherche_page ($cache, $contexte, $fond)  {
+	global $delais;
+
+	if (!function_exists('chercher_squelette'))
+		include_local(&quot;inc-chercher-squelette.php3&quot;);
+
+	// Choisir entre $fond-dist.html, $fond=7.html, etc?
+	$id_rubrique_fond = 0;
+	// Chercher le fond qui va servir de squelette
+	if ($r = sql_rubrique_fond($contexte))
+		list($id_rubrique_fond, $lang) = $r;
+	if (!$lang)
+		$lang = lire_meta('langue_site');
+	// Si inc-urls ou un appel dynamique veut fixer la langue, la recuperer
+	$lang = $contexte['lang'];
+
+	if (!$GLOBALS['forcer_lang'])
+		lang_select($lang);
+
+	$skel = chercher_squelette($fond,
+			$id_rubrique_fond,
+			$GLOBALS['spip_lang']);
+
+	// Charger le squelette et recuperer sa fonction principale
+	// (compilation automatique au besoin) et calculer
+
+	$page = array();
+
+	if ($skel) {
+		if ($fonc = charger_squelette($skel))
+		  $page = $fonc(array('cache' =&gt; $cache), array($contexte));
+
+		// Passer la main au debuggueur)
+		if ($GLOBALS['var_mode'] == 'debug')
+		  {
+			include_ecrire(&quot;inc_debug_sql.php3&quot;);
+			debug_dumpfile ($page['texte'], $fonc, 'resultat');
+		  }
+	}
+
+	// Nettoyer le resultat si on est fou de XML
+	if ($GLOBALS['xhtml']) {
+		include_ecrire(&quot;inc_tidy.php&quot;);
+		$page['texte'] = xhtml($page['texte']);
+	}
+
+	// Entrer les invalideurs dans la base
+	if ($delais&gt;0) {
+		include_ecrire('inc_invalideur.php3');
+		maj_invalideurs($cache, $page['invalideurs'], $delais);
+	}
+
+	// Retourner la structure de la page
+
+	return $page;
+}
+
+
+//
+// Contexte : lors du calcul d'une page spip etablit le contexte a partir
+// des variables $_GET et $_POST, et leur ajoute la date
+// Note : pour hacker le contexte depuis le fichier d'appel (article.php3),
+// il est recommande de modifier $_GET['toto'] (meme si la page est
+// appelee avec la methode POST).
+//
+function calculer_contexte() {
+	foreach($GLOBALS['_GET'] as $var =&gt; $val) {
+		if (strpos($var, 'var_') !== 0)
+			$contexte[$var] = $val;
+	}
+	foreach($GLOBALS['_POST'] as $var =&gt; $val) {
+		if (strpos($var, 'var_') !== 0)
+			$contexte[$var] = $val;
+	}
+
+	if ($GLOBALS['date'])
+		$contexte['date'] = $contexte['date_redac'] = normaliser_date($GLOBALS['date']);
+	else
+		$contexte['date'] = $contexte['date_redac'] = date(&quot;Y-m-d H:i:s&quot;);
+
+	return $contexte;
+}
+
+function calculer_page_globale($cache, $contexte_local, $fond) {
+
+	// Gestion des URLs personnalises - sale mais historique
+	if (function_exists(&quot;recuperer_parametres_url&quot;)) {
+		global $contexte;
+		$contexte = $contexte_local;
+		recuperer_parametres_url($fond, nettoyer_uri());
+
+		// remettre les globales pour le bouton &quot;Modifier cet article&quot;
+		if (is_array($contexte))
+			foreach ($contexte as $var=&gt;$val)
+				if (substr($var,0,3) == 'id_')
+					$GLOBALS[$var] = $val;
+		$contexte_local = $contexte;
+	}
+
+	// Go to work !
+	$page = cherche_page($cache, $contexte_local, $fond);
+
+	$signal = array();
+	foreach(array('id_parent', 'id_rubrique', 'id_article', 'id_auteur',
+	'id_breve', 'id_forum', 'id_secteur', 'id_syndic', 'id_syndic_article',
+	'id_mot', 'id_groupe', 'id_document') as $val) {
+		if ($contexte_local[$val])
+			$signal['contexte'][$val] = intval($contexte_local[$val]);
+	}
+
+	$page['signal'] = $signal;
+
+	return $page;
+}
+
+
+
+function calculer_page($chemin_cache, $elements, $delais, $inclusion=false) {
+
+	// Inclusion
+	if ($inclusion) {
+		$contexte_inclus = $elements['contexte'];
+		$page = cherche_page($chemin_cache,
+			$contexte_inclus, $elements['fond']);
+	}
+	else {
+
+		// Page globale
+		// si le champ chapo commence par '=' c'est une redirection.
+		if ($id_article = intval($GLOBALS['id_article'])) {
+			if ($art = sql_chapo($id_article)) {
+				$chapo = $art['chapo'];
+				if (substr($chapo, 0, 1) == '=') {
+					include_ecrire('inc_texte.php3');
+					list(,$url) = extraire_lien(array('','','',
+					substr($chapo, 1)));
+					if ($url) { // sinon les navigateurs pataugent
+						$url = addslashes($url);
+						$page = array('texte' =&gt; &quot;&lt;&quot;.
+						&quot;?php header(\&quot;Location: $url\&quot;); ?&quot; . &quot;&gt;&quot;,
+						'process_ins' =&gt; 'php');
+					}
+				}
+			}
+		}
+		if (!$page)
+			$page = calculer_page_globale($chemin_cache,
+				$elements['contexte'],
+				$elements['fond']);
+	}
+
+	$page['signal']['process_ins'] = $page['process_ins'];
+	$signal = &quot;&lt;!-- &quot;.str_replace(&quot;\n&quot;, &quot; &quot;,
+	serialize($page['signal'])).&quot; --&gt;\n&quot;;
+
+	// Enregistrer le fichier cache
+	if ($delais &gt; 0 AND $GLOBALS['var_mode'] != 'debug'
+	AND empty($GLOBALS['_POST']))
+		ecrire_fichier($chemin_cache, $signal.$page['texte']);
+
+	return $page;
+}
+?&gt;

Index: inc-compilo-api.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo-api.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-compilo-api.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-compilo-api.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,220 +1,249 @@
-&lt;?php
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_COMPILO_API&quot;)) return;
-define(&quot;_INC_COMPILO_API&quot;, &quot;1&quot;);
-
-
-// Definition des classes Boucle, Texte, Inclure, Champ
-
-class Texte {
-	var $type = 'texte';
-	var $texte;
-}
-
-class Inclure {
-	var $type = 'include';
-	var $fichier;
-	var $params;
-}
-
-//
-// encodage d'une boucle SPIP en un objet PHP
-//
-class Boucle {
-	var $type = 'boucle';
-	var $id_boucle;
-	var $id_parent ='';
-	var $cond_avant, $milieu, $cond_apres, $cond_altern;
-	var $lang_select;
-	var $type_requete;
-	var $sql_serveur;
-	var $param = array();
-	var $separateur;
-	var $doublons;
-	var $partie, $total_parties,$mode_partie;
-	var $externe = ''; # appel a partir d'une autre boucle (recursion)
-	// champs pour la construction de la requete SQL
-	var $tout = false;
-	var $plat = false;
-	var $select;
-	var $from;
-	var $where;
-	var $limit;
-	var $group = '';
-	var $order = '';
-	var $date = 'date' ;
-	var $hash = false ;
-	var $lien = false;
-	var $sous_requete = false;
-	var $compte_requete = 1;
-	var $hierarchie = '';
-	// champs pour la construction du corps PHP
-	var $id_table;
-	var $primary;
-	var $return;
-	var $numrows = false; 
-}
-
-class Champ {
-	var $type = 'champ';
-	var $nom_champ;
-	var $nom_boucle= ''; // seulement si boucle explicite
-	var $cond_avant, $cond_apres; // tableaux d'objets
-	var $fonctions;  // filtre explicites
-	var $etoile;
-	// champs pour la production de code
-	var $id_boucle;
-	var $boucles;
-	var $type_requete;
-	var $code;	// code du calcul
-	var $statut;	// 'numerique, 'h'=texte (html) ou 'p'=script (php) ?
-			// -&gt; definira les pre et post-traitements obligatoires
-	// champs pour la production de code dependant du contexte
-	var $id_mere;    // pour TOTAL_BOUCLE hors du corps
-	var $document;   // pour embed et img dans les textes
-}
-
-
-//
-// Globales de description de la base
-
-global $tables_des_serveurs_sql, $tables_principales; // (voir inc_serialbase)
-global $exceptions_des_tables, $table_des_tables;
-global $tables_relations,  $table_primary, $table_date;
-
-$tables_des_serveurs_sql = array('localhost' =&gt; &amp;$tables_principales);
-	
-
-	// champ principal des tables SQL
-	$table_primary = array(
-		'articles' =&gt; &quot;id_article&quot;,
-		'auteurs' =&gt; &quot;id_auteur&quot;,
-		'breves' =&gt; &quot;id_breve&quot;,
-		'documents' =&gt; &quot;id_document&quot;,
-		'forums' =&gt; &quot;id_forum&quot;,
-		'groupes_mots' =&gt; &quot;id_groupe&quot;,
-		'hierarchie' =&gt; &quot;id_rubrique&quot;,
-		'mots' =&gt; &quot;id_mot&quot;,
-		'rubriques' =&gt; &quot;id_rubrique&quot;,
-		'signatures' =&gt; &quot;id_signature&quot;,
-		'syndication' =&gt; &quot;id_syndic&quot;,
-		'syndic_articles' =&gt; &quot;id_syndic_article&quot;,
-		'types_documents' =&gt; &quot;id_type&quot;
-	);
-	
-	# cf. fonction table_objet dans inc_version
-	$table_des_tables = array(
-		'articles' =&gt; 'articles',
-		'auteurs' =&gt; 'auteurs',
-		'breves' =&gt; 'breves',
-		'forums' =&gt; 'forum',
-		'signatures' =&gt; 'signatures',
-		'documents' =&gt; 'documents',
-		'types_documents' =&gt; 'types_documents',
-		'mots' =&gt; 'mots',
-		'groupes_mots' =&gt; 'groupes_mots',
-		'rubriques' =&gt; 'rubriques',
-		'syndication' =&gt; 'syndic',
-		'syndic_articles' =&gt; 'syndic_articles',
-		'hierarchie' =&gt; 'rubriques'
-	);
-	
-	$exceptions_des_tables = array(
-		'breves' =&gt; array(
-			'id_secteur' =&gt; 'id_rubrique',
-			'date' =&gt; 'date_heure',
-			'nom_site' =&gt; 'lien_titre',
-			'url_site' =&gt; 'lien_url'
-			),
-		'forums' =&gt; array(
-			'date' =&gt; 'date_heure',
-			'nom' =&gt; 'auteur',
-			'email' =&gt; 'email_auteur'
-			),
-		'signatures' =&gt; array(
-			'date' =&gt; 'date_time',
-			'nom' =&gt; 'nom_email',
-			'email' =&gt; 'ad_email'
-		),
-		'documents' =&gt; array(
-			'type_document' =&gt; array('types_documents', 'titre'),
-			'extension_document' =&gt; array('types_documents', 'extension')
-		),
-		'syndic_articles' =&gt; array(
-			'url_article' =&gt; 'url',		  # ne sert pas ? cf balise_URL_ARTICLE
-			'lesauteurs' =&gt; 'lesauteurs', # ne sert pas ? cf balise_LESAUTEURS
-			'url_site' =&gt; array('syndic', 'url_site'),
-			'nom_site' =&gt; array('syndic', 'nom_site')
-		)
-	);
-	
-	$table_date = array (
-		'articles' =&gt; 'date',
-		'auteurs' =&gt;  'date',
-		'breves' =&gt;  'date_heure',
-		'forums' =&gt;  'date_heure',
-		'signatures' =&gt; 'date_time',
-		'documents' =&gt; 'date',
-		'types_documents' =&gt; 'date',
-		'groupes_mots' =&gt; 'date',
-		'mots' =&gt; 'date',
-		'rubriques' =&gt; 'date',
-		'syndication' =&gt; 'date',
-		'syndic_articles' =&gt; 'date'
-	);
-
-
-//
-// tableau des tables de relations,
-// Ex: gestion du critere {id_mot} dans la boucle(ARTICLES)
-//
-
-$tables_relations = array(
-	'articles' =&gt; array (
-		'id_mot' =&gt; 'mots_articles',
-		'id_auteur' =&gt; 'auteurs_articles',
-		'id_document' =&gt; 'documents_articles'
-		),
-
-	'auteurs' =&gt; array (
-		'id_article' =&gt; 'auteurs_articles'
-		),
-
-	'breves' =&gt; array (
-		'id_mot' =&gt; 'mots_breves',
-		'id_document' =&gt; 'documents_breves'
-		),
-
-	'documents' =&gt; array (
-		'id_article' =&gt; 'documents_articles',
-		'id_rubrique' =&gt; 'documents_rubriques',
-		'id_breve' =&gt; 'documents_breves'
-		),
-
-	'forums' =&gt; array (
-		'id_mot' =&gt; 'mots_forum',
-		),
-
-	'mots' =&gt; array (
-		'id_article' =&gt; 'mots_articles',
-		'id_breve' =&gt; 'mots_breves',
-		'id_forum' =&gt; 'mots_forum',
-		'id_rubrique' =&gt; 'mots_rubriques',
-		'id_syndic' =&gt; 'mots_syndic'
-		),
-
-	'groupes_mots' =&gt; array (
-		'id_groupe' =&gt; 'mots'
-		),
-
-	'rubriques' =&gt; array (
-		'id_mot' =&gt; 'mots_rubriques',
-		'id_document' =&gt; 'documents_rubriques'
-		),
-
-	'syndication' =&gt; array (
-		'id_mot' =&gt; 'mots_syndic'
-		)
-	);
-?&gt;
+&lt;?php
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_COMPILO_API&quot;)) return;
+define(&quot;_INC_COMPILO_API&quot;, &quot;1&quot;);
+
+
+// Definition des classes Boucle, Texte, Inclure, Champ
+
+class Texte {
+	var $type = 'texte';
+	var $texte;
+}
+
+class Inclure {
+	var $type = 'include';
+	var $fichier;
+	var $params;
+}
+
+//
+// encodage d'une boucle SPIP en un objet PHP
+//
+class Boucle {
+	var $type = 'boucle';
+	var $id_boucle;
+	var $id_parent ='';
+	var $cond_avant, $milieu, $cond_apres, $cond_altern;
+	var $lang_select;
+	var $type_requete;
+	var $sql_serveur;
+	var $param = array();
+	var $separateur;
+	var $doublons;
+	var $partie, $total_parties,$mode_partie;
+	var $externe = ''; # appel a partir d'une autre boucle (recursion)
+	// champs pour la construction de la requete SQL
+	var $tout = false;
+	var $plat = false;
+	var $select;
+	var $from;
+	var $where;
+	var $limit;
+	var $group = '';
+	var $order = '';
+	var $default_order = '';
+	var $date = 'date' ;
+	var $hash = false ;
+	var $lien = false;
+	var $sous_requete = false;
+	var $compte_requete = 1;
+	var $hierarchie = '';
+	// champs pour la construction du corps PHP
+	var $id_table;
+	var $primary;
+	var $return;
+	var $numrows = false; 
+}
+
+class Champ {
+	var $type = 'champ';
+	var $nom_champ;
+	var $nom_boucle= ''; // seulement si boucle explicite
+	var $cond_avant, $cond_apres; // tableaux d'objets
+	var $fonctions;  // filtre explicites
+	var $etoile;
+	// champs pour la production de code
+	var $id_boucle;
+	var $boucles;
+	var $type_requete;
+	var $code;	// code du calcul
+	var $statut;	// 'numerique, 'h'=texte (html) ou 'p'=script (php) ?
+			// -&gt; definira les pre et post-traitements obligatoires
+	// champs pour la production de code dependant du contexte
+	var $id_mere;    // pour TOTAL_BOUCLE hors du corps
+	var $document;   // pour embed et img dans les textes
+}
+
+
+//
+// Globales de description de la base
+
+global $tables_des_serveurs_sql, $tables_principales; // (voir inc_serialbase)
+global $exceptions_des_tables, $table_des_tables;
+global $tables_relations,  $table_primary, $table_date;
+
+$tables_des_serveurs_sql = array('localhost' =&gt; &amp;$tables_principales);
+	
+
+	// champ principal des tables SQL
+	$table_primary = array(
+		'articles' =&gt; &quot;id_article&quot;,
+		'auteurs' =&gt; &quot;id_auteur&quot;,
+		'breves' =&gt; &quot;id_breve&quot;,
+		'documents' =&gt; &quot;id_document&quot;,
+		'forums' =&gt; &quot;id_forum&quot;,
+		'groupes_mots' =&gt; &quot;id_groupe&quot;,
+		'hierarchie' =&gt; &quot;id_rubrique&quot;,
+		'mots' =&gt; &quot;id_mot&quot;,
+		'rubriques' =&gt; &quot;id_rubrique&quot;,
+		'signatures' =&gt; &quot;id_signature&quot;,
+		'syndication' =&gt; &quot;id_syndic&quot;,
+		'syndic_articles' =&gt; &quot;id_syndic_article&quot;,
+		'types_documents' =&gt; &quot;id_type&quot;
+		////////////////////////////
+		//MODIFICATION
+		///////////////////////////
+		,'carto_objets' =&gt; &quot;id_carto_objet&quot;
+		,'carto_cartes' =&gt; &quot;id_carto_carte&quot;
+		///////////////////////////
+	);
+	
+	# cf. fonction table_objet dans inc_version
+	$table_des_tables = array(
+		'articles' =&gt; 'articles',
+		'auteurs' =&gt; 'auteurs',
+		'breves' =&gt; 'breves',
+		'forums' =&gt; 'forum',
+		'signatures' =&gt; 'signatures',
+		'documents' =&gt; 'documents',
+		'types_documents' =&gt; 'types_documents',
+		'mots' =&gt; 'mots',
+		'groupes_mots' =&gt; 'groupes_mots',
+		'rubriques' =&gt; 'rubriques',
+		'syndication' =&gt; 'syndic',
+		'syndic_articles' =&gt; 'syndic_articles',
+		'hierarchie' =&gt; 'rubriques'
+		////////////////////////////
+		//MODIFICATION
+		///////////////////////////
+		,'carto_objets' =&gt; &quot;carto_objets&quot;
+		,'carto_cartes' =&gt; &quot;carto_cartes&quot;
+		///////////////////////////
+	);
+	
+	$exceptions_des_tables = array(
+		'breves' =&gt; array(
+			'id_secteur' =&gt; 'id_rubrique',
+			'date' =&gt; 'date_heure',
+			'nom_site' =&gt; 'lien_titre',
+			'url_site' =&gt; 'lien_url'
+			),
+		'forums' =&gt; array(
+			'date' =&gt; 'date_heure',
+			'nom' =&gt; 'auteur',
+			'email' =&gt; 'email_auteur'
+			),
+		'signatures' =&gt; array(
+			'date' =&gt; 'date_time',
+			'nom' =&gt; 'nom_email',
+			'email' =&gt; 'ad_email'
+		),
+		'documents' =&gt; array(
+			'type_document' =&gt; array('types_documents', 'titre'),
+			'extension_document' =&gt; array('types_documents', 'extension')
+		),
+		'syndic_articles' =&gt; array(
+			'url_article' =&gt; 'url',		  # ne sert pas ? cf balise_URL_ARTICLE
+			'lesauteurs' =&gt; 'lesauteurs', # ne sert pas ? cf balise_LESAUTEURS
+			'url_site' =&gt; array('syndic', 'url_site'),
+			'nom_site' =&gt; array('syndic', 'nom_site')
+		)
+	);
+	
+	$table_date = array (
+		'articles' =&gt; 'date',
+		'auteurs' =&gt;  'date',
+		'breves' =&gt;  'date_heure',
+		'forums' =&gt;  'date_heure',
+		'signatures' =&gt; 'date_time',
+		'documents' =&gt; 'date',
+		'types_documents' =&gt; 'date',
+		'groupes_mots' =&gt; 'date',
+		'mots' =&gt; 'date',
+		'rubriques' =&gt; 'date',
+		'syndication' =&gt; 'date',
+		'syndic_articles' =&gt; 'date'
+	);
+
+
+//
+// tableau des tables de relations,
+// Ex: gestion du critere {id_mot} dans la boucle(ARTICLES)
+//
+
+$tables_relations = array(
+	'articles' =&gt; array (
+		'id_mot' =&gt; 'mots_articles',
+		'id_auteur' =&gt; 'auteurs_articles',
+		'id_document' =&gt; 'documents_articles'
+		),
+
+	'auteurs' =&gt; array (
+		'id_article' =&gt; 'auteurs_articles'
+		),
+
+	'breves' =&gt; array (
+		'id_mot' =&gt; 'mots_breves',
+		'id_document' =&gt; 'documents_breves'
+		),
+
+	'documents' =&gt; array (
+		'id_article' =&gt; 'documents_articles',
+		'id_rubrique' =&gt; 'documents_rubriques',
+		'id_breve' =&gt; 'documents_breves'
+		////////////////////////////
+		//MODIFICATION
+		///////////////////////////
+		,'id_carto_carte' =&gt; 'documents_carto_cartes'
+		///////////////////////////
+		),
+
+	'forums' =&gt; array (
+		'id_mot' =&gt; 'mots_forum',
+		),
+
+	'mots' =&gt; array (
+		'id_article' =&gt; 'mots_articles',
+		'id_breve' =&gt; 'mots_breves',
+		'id_forum' =&gt; 'mots_forum',
+		'id_rubrique' =&gt; 'mots_rubriques',
+		'id_syndic' =&gt; 'mots_syndic'
+		////////////////////////////
+		//MODIFICATION
+		///////////////////////////
+		,'id_carto_objet' =&gt; 'mots_carto_objets'
+		),
+	'carto_objets' =&gt; array (
+		'id_mot' =&gt; 'mots_carto_objets',
+		),
+	'carto_cartes' =&gt; array (
+		'id_document' =&gt; 'mots_carto_cartes',
+		///////////////////////////
+		),
+
+	'groupes_mots' =&gt; array (
+		'id_groupe' =&gt; 'mots'
+		),
+
+	'rubriques' =&gt; array (
+		'id_mot' =&gt; 'mots_rubriques',
+		'id_document' =&gt; 'documents_rubriques'
+		),
+
+	'syndication' =&gt; array (
+		'id_mot' =&gt; 'mots_syndic'
+		)
+	);
+?&gt;

Index: inc-compilo-index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo-index.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-compilo-index.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-compilo-index.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,310 +1,344 @@
-&lt;?php
-
-
-// fonctions de recherche et de reservation
-// dans l'arborescence des boucles
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_COMPILO_INDEX&quot;)) return;
-define(&quot;_INC_COMPILO_INDEX&quot;, &quot;1&quot;);
-
-// index_pile retourne la position dans la pile du champ SQL $nom_champ 
-// en prenant la boucle la plus proche du sommet de pile (indique par $idb).
-// Si on ne trouve rien, on considere que ca doit provenir du contexte 
-// (par l'URL ou l'include) qui a ete recopie dans Pile[0]
-// (un essai d'affinage a debouche sur un bug vicieux)
-// Si ca reference un champ SQL, on le memorise dans la structure $boucles
-// afin de construire un requete SQL minimale (plutot qu'un brutal 'SELECT *')
-
-function index_pile($idb, $nom_champ, &amp;$boucles, $explicite='') {
-  global $exceptions_des_tables, $table_des_tables, $tables_des_serveurs_sql;
-
-	$i = 0;
-	if (strlen($explicite)) {
-	// Recherche d'un champ dans un etage superieur
-	  while (($idb != $explicite) &amp;&amp; ($idb !='')) {
-#		spip_log(&quot;Cherchexpl: $nom_champ '$explicite' '$idb' '$i'&quot;);
-			$i++;
-			$idb = $boucles[$idb]-&gt;id_parent;
-		}
-	}
-
-	$c = strtolower($nom_champ);
-	// attention: entre la boucle nommee 0, &quot;&quot; et le tableau vide,
-	// il y a incoherences qu'il vaut mieux eviter
-	while ($boucles[$idb]) {
-#		spip_log(&quot;Cherche: $nom_champ '$idb' '$c'&quot;);
-		$r = $boucles[$idb]-&gt;type_requete;
-		$s = $boucles[$idb]-&gt;sql_serveur;
-		if (!$s) 
-		  { $s = 'localhost';
-    // indirection (pour les rares cas ou le nom de la table!=type)
-		    $t = $table_des_tables[$r];
-		  }
-		if (!$t) $t = $r; // pour les tables non Spip
-		// $t est le nom PHP de cette table 
-#		spip_log(&quot;Go: idb='$idb' r='$r' c='$c' nom='$nom_champ' s=$s&quot;);
-		$desc = $tables_des_serveurs_sql[$s][$t];
-		if (!$desc) {
-			erreur_squelette(_L(&quot;Table SQL \&quot;$r\&quot; inconnue&quot;), &quot;'$idb'&quot;);
-			# continuer pour chercher l'erreur suivante
-			return  &quot;'#&quot; . $r . ':' . $nom_champ . &quot;'&quot;;
-		}
-		$excep = $exceptions_des_tables[$r][$c];
-		if ($excep) {
-			// entite SPIP alias d'un champ SQL
-			if (!is_array($excep)) {
-				$e = $excep;
-				$c = $excep;
-			} 
-			// entite SPIP alias d'un champ dans une autre table SQL
-			else {
-				$t = $excep[0];
-				$e = $excep[1].' AS '.$c;
-			}
-		}
-		else {
-			// $e est le type SQL de l'entree
-			// entite SPIP homonyme au champ SQL
-			if ($desc['field'][$c])
-				$e = $c;
-			else
-				unset($e);
-		}
-
-#		spip_log(&quot;Dans $idb ('$t' '$e'): $desc&quot;);
-
-		// On l'a trouve
-		if ($e) {
-			$boucles[$idb]-&gt;select[] = $t . &quot;.&quot; . $e;
-			return '$Pile[$SP' . ($i ? &quot;-$i&quot; : &quot;&quot;) . '][\'' . $c . '\']';
-		}
-
-		// Sinon on remonte d'un cran
-		$idb = $boucles[$idb]-&gt;id_parent;
-		$i++;
-	}
-
-#	spip_log(&quot;Pas vu $nom_champ dans les &quot; . count($boucles) . &quot; boucles&quot;);
-	// esperons qu'il y sera
-	return('$Pile[0][\''.$nom_champ.'\']');
-}
-
-# calculer_champ genere le code PHP correspondant a une balise Spip
-# Retourne une EXPRESSION php 
-function calculer_champ($p) {
-	$p = calculer_balise($p-&gt;nom_champ, $p);
-
-	// definir le type et les traitements
-	// si ca ramene le choix par defaut, ce n'est pas un champ 
-
-	if (($p-&gt;code) &amp;&amp; ($p-&gt;code != '$Pile[0][\''.$nom.'\']')) {
-		// Par defaut basculer en numerique pour les #ID_xxx
-		if (substr($nom,0,3) == 'ID_') $p-&gt;statut = 'num';
-	}
-
-	else {
-	// on renvoie la forme initiale '#TOTO'
-	$p-&gt;code = &quot;'#&quot; . $nom . &quot;'&quot;;
-	$p-&gt;statut = 'php';	// pas de traitement
-	
-	}
-
-	// Retourner l'expression php correspondant au champ + ses filtres
-	return applique_filtres($p);
-}
-
-// cette fonction sert d'API pour demander le champ '$champ' dans la pile
-function champ_sql($champ, $p) {
-	return index_pile($p-&gt;id_boucle, $champ, $p-&gt;boucles, $p-&gt;nom_boucle);
-}
-
-// cette fonction sert d'API pour demander une balise quelconque sans filtre
-function calculer_balise($nom, $p) {
-
-	// regarder s'il existe une fonction personnalisee balise_NOM()
-	$f = 'balise_' . $nom;
-	if (function_exists($f))
-		return $f($p);
-
-	// regarder s'il existe une fonction standard balise_NOM_dist()
-	$f = 'balise_' . $nom . '_dist';
-	if (function_exists($f))
-		return $f($p);
-
-	// regarder s'il existe un fichier d'inclusion au nom de la balise
-	// et contenant un tableau balise_NOM_collecte
-	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
-	if (@file_exists($file)) {
-		include_local($file);
-		$f = $GLOBALS['balise_' . $nom . '_collecte'];
-		if (is_array($f))
-			return calculer_balise_dynamique($p, $nom, $f);
-	}
-
-	// S'agit-il d'un logo ? Une fonction speciale les traite tous
-	if (ereg('^LOGO_', $nom))
-		return calculer_balise_logo($p);
-
-	// ca doit etre un champ SQL homonyme,
-	$p-&gt;code = index_pile($p-&gt;id_boucle, $nom, $p-&gt;boucles, $p-&gt;nom_boucle);
-	return $p;
-}
-
-//
-// Traduction des balises dynamiques, notamment les &quot;formulaire_*&quot;
-// Inclusion du fichier associe a son nom.
-// Ca donne les arguments a chercher dans la pile,on compile leur localisation
-// Ensuite on delegue a une fonction generale definie dans inc-calcul-outils
-// qui recevra a l'execution la valeurs des arguments, 
-// ainsi que les filtres (qui ne sont donc pas traites &#224; la compil)
-
-function calculer_balise_dynamique($p, $nom, $l) {
-	balise_distante_interdite($p);
-	$param = param_balise($p);
-	$p-&gt;code = &quot;executer_balise_dynamique('&quot; . $nom . &quot;',\n\tarray(&quot;
-	  . join(',',collecter_balise_dynamique($l, $p))
-	  . filtres_arglist($param, $p)
-	  . &quot;),\n\tarray(&quot;
-	  . (!$p-&gt;fonctions ? '' : (&quot;'&quot; . join(&quot;','&quot;, $p-&gt;fonctions) . &quot;'&quot;))
-	  . &quot;))&quot;;
-	$p-&gt;statut = 'php';
-	$p-&gt;fonctions = '';
-	return $p;
-}
-
-function param_balise(&amp;$p) 
-{
-	$a = $p-&gt;fonctions;
-	if ($a) list(,$nom) = each($a) ; else $nom = '';
-	if (!ereg(' *\{ *([^}]+) *\} *',$nom, $m))
-	  return '';
-	else {
-		$filtres= array();
-		while (list(, $f) = each($a)) if ($f) $filtres[] = $f;
-		$p-&gt;fonctions = $filtres;
-		return $m[1];
-	}
-}
-
-// construire un tableau des valeurs interessant un formulaire
-
-function collecter_balise_dynamique($l, $p) {
-	$args = array();
-	foreach($l as $c) { $x = calculer_balise($c, $p); $args[] = $x-&gt;code;}
-	return $args;
-}
-
-// Genere l'application d'une liste de filtres
-function applique_filtres($p) {
-	$statut = $p-&gt;statut;
-	$fonctions = $p-&gt;fonctions;
-	$p-&gt;fonctions = ''; # pour r&#233;utiliser la structure si r&#233;cursion
-
-	// pretraitements standards
-	switch ($statut) {
-		case 'num':
-			$code = &quot;intval($code)&quot;;
-			break;
-		case 'php':
-			break;
-		case 'html':
-		default:
-			$code = &quot;trim($code)&quot;;
-			break;
-	}
-
-//  processeurs standards (cf inc-balises.php3)
-	$code = ($p-&gt;etoile ? $p-&gt;code : champs_traitements($p));
-	// Appliquer les filtres perso
-	if ($fonctions) {
-		foreach($fonctions as $fonc) {
-			if ($fonc) {
-				$arglist = '';
-				if (ereg('([^\{\}]*)\{(.+)\}$', $fonc, $regs)) {
-					$fonc = $regs[1];
-				        $arglist = filtres_arglist($regs[2],$p);
-				}
-				if (function_exists($fonc))
-				  $code = &quot;$fonc($code$arglist)&quot;;
-				else if (strpos(&quot; &lt; &gt; &lt;= &gt;= == &lt;&gt; &quot;, &quot; $fonc &quot;))
-				  $code = &quot;$code $fonc &quot; . substr($arglist,1);
-				else 
-				  $code = &quot;erreur_squelette('&quot;.
-					  texte_script(
-						_T('erreur_filtre', array('filtre' =&gt; $fonc))
-					).&quot;','&quot; . $p-&gt;id_boucle . &quot;')&quot;;
-			}
-		}
-	}
-
-	// post-traitement securite
-	if ($statut == 'html')
-		$code = &quot;interdire_scripts($code)&quot;;
-	return $code;
-}
-
-// analyse des parametres d'un champ etendu
-// [...(#CHAMP{parametres})...] ou [...(#CHAMP|filtre{parametres})...]
-// retourne une suite de N references aux N valeurs indiqu&#233;es avec N virgules
-
-function filtres_arglist($args, $p) {
-	$arglist ='';;
-	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
-		$arg = trim($regs[1]);
-		if ($arg) {
-		  if (ereg(&quot;^&quot; . NOM_DE_CHAMP, $arg, $regs2)) {
-				$p-&gt;nom_boucle = $regs2[2];
-				$p-&gt;nom_champ = $regs2[3];
-				$arg = calculer_champ($p);
-			} else if ($arg[0] =='$')
-				$arg = '$Pile[0][\'' . substr($arg,1) . &quot;']&quot;;
-			$arglist .= ','.$arg;
-		}
-		$args=$regs[2];
-	}
-	return $arglist;
-}
-
-//
-// Reserve les champs necessaires a la comparaison avec le contexte donne par
-// la boucle parente ; attention en recursif il faut les reserver chez soi-meme
-// ET chez sa maman
-// 
-function calculer_argument_precedent($idb, $nom_champ, &amp;$boucles) {
-
-	// recursif ?
-	if ($boucles[$idb]-&gt;externe)
-		index_pile ($idb, $nom_champ, $boucles); // reserver chez soi-meme
-	// reserver chez le parent et renvoyer l'habituel $Pile[$SP]['nom_champ']
-#	spip_log(&quot;boucles[$idb]-&gt;id_parent &quot; . $boucles[$idb]-&gt;id_parent);
-	return index_pile ($boucles[$idb]-&gt;id_parent, $nom_champ, $boucles);
-}
-
-function rindex_pile($p, $champ, $motif) 
-{
-	$n = 0;
-	$b = $p-&gt;id_boucle;
-	$p-&gt;code = '';
-	while ($b != '') {
-	if ($s = $p-&gt;boucles[$b]-&gt;param) {
-	  foreach($s as $v) {
-		if (strpos($v,$motif) !== false) {
-		  $p-&gt;code = '$Pile[$SP' . (($n==0) ? &quot;&quot; : &quot;-$n&quot;) .
-			&quot;]['$champ']&quot;;
-		  $b = '';
-		  break;
-		}
-	  }
-	}
-	$n++;
-	$b = $p-&gt;boucles[$b]-&gt;id_parent;
-	}
-	if (!$p-&gt;code) {
-	  erreur_squelette(_L(&quot;Champ #&quot; . strtoupper($champ) . &quot; hors d'une boucle de motif $motif&quot;), $p-&gt;id_boucle);
-	}
-	$p-&gt;statut = 'php';
-	return $p;
-}
-
-?&gt;
+&lt;?php
+
+
+// fonctions de recherche et de reservation
+// dans l'arborescence des boucles
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_COMPILO_INDEX&quot;)) return;
+define(&quot;_INC_COMPILO_INDEX&quot;, &quot;1&quot;);
+
+// index_pile retourne la position dans la pile du champ SQL $nom_champ 
+// en prenant la boucle la plus proche du sommet de pile (indique par $idb).
+// Si on ne trouve rien, on considere que ca doit provenir du contexte 
+// (par l'URL ou l'include) qui a ete recopie dans Pile[0]
+// (un essai d'affinage a debouche sur un bug vicieux)
+// Si ca reference un champ SQL, on le memorise dans la structure $boucles
+// afin de construire un requete SQL minimale (plutot qu'un brutal 'SELECT *')
+
+function index_pile($idb, $nom_champ, &amp;$boucles, $explicite='') {
+  global $exceptions_des_tables, $table_des_tables, $tables_des_serveurs_sql;
+
+	$i = 0;
+	if (strlen($explicite)) {
+	// Recherche d'un champ dans un etage superieur
+	  while (($idb != $explicite) &amp;&amp; ($idb !='')) {
+#		spip_log(&quot;Cherchexpl: $nom_champ '$explicite' '$idb' '$i'&quot;);
+			$i++;
+			$idb = $boucles[$idb]-&gt;id_parent;
+		}
+	}
+
+	$c = strtolower($nom_champ);
+	// attention: entre la boucle nommee 0, &quot;&quot; et le tableau vide,
+	// il y a incoherences qu'il vaut mieux eviter
+	while ($boucles[$idb]) {
+#		spip_log(&quot;Cherche: $nom_champ '$idb' '$c'&quot;);
+		$r = $boucles[$idb]-&gt;type_requete;
+		$s = $boucles[$idb]-&gt;sql_serveur;
+		if (!$s) 
+		  { $s = 'localhost';
+    // indirection (pour les rares cas ou le nom de la table!=type)
+		    $t = $table_des_tables[$r];
+		  }
+		// pour les tables non Spip
+		if (!$t) {$nom_table = $t = $r; }
+		else $nom_table = 'spip_' . $t;
+
+		#spip_log(&quot;Go: idb='$idb' r='$r' c='$c' nom='$nom_champ' s=$s t=$t&quot;);
+		$desc = $tables_des_serveurs_sql[$s][$nom_table];
+		if (!$desc) {
+			erreur_squelette(_T('zbug_table_inconnue', array('table' =&gt; $r)),
+				&quot;'$idb'&quot;);
+			# continuer pour chercher l'erreur suivante
+			return  &quot;'#&quot; . $r . ':' . $nom_champ . &quot;'&quot;;
+		}
+		$excep = $exceptions_des_tables[$r][$c];
+		if ($excep) {
+			// entite SPIP alias d'un champ SQL
+			if (!is_array($excep)) {
+				$e = $excep;
+				$c = $excep;
+			} 
+			// entite SPIP alias d'un champ dans une autre table SQL
+			else {
+				$t = $excep[0];
+				$e = $excep[1].' AS '.$c;
+			}
+		}
+		else {
+			// $e est le type SQL de l'entree
+			// entite SPIP homonyme au champ SQL
+			if ($desc['field'][$c])
+				$e = $c;
+			else
+				unset($e);
+		}
+
+#		spip_log(&quot;Dans $idb ('$t' '$e'): $desc&quot;);
+
+		// On l'a trouve
+		if ($e) {
+			$boucles[$idb]-&gt;select[] = $t . &quot;.&quot; . $e;
+			return '$Pile[$SP' . ($i ? &quot;-$i&quot; : &quot;&quot;) . '][\'' . $c . '\']';
+		}
+
+		// Sinon on remonte d'un cran
+		$idb = $boucles[$idb]-&gt;id_parent;
+		$i++;
+	}
+
+#	spip_log(&quot;Pas vu $nom_champ dans les &quot; . count($boucles) . &quot; boucles&quot;);
+	// esperons qu'il y sera
+	return('$Pile[0][\''.$nom_champ.'\']');
+}
+
+# calculer_champ genere le code PHP correspondant a une balise Spip
+# Retourne une EXPRESSION php 
+function calculer_champ($p) {
+	$p = calculer_balise($p-&gt;nom_champ, $p);
+
+	// definir le type et les traitements
+	// si ca ramene le choix par defaut, ce n'est pas un champ 
+
+	if (($p-&gt;code) &amp;&amp; ($p-&gt;code != '$Pile[0][\''.$nom.'\']')) {
+		// Par defaut basculer en numerique pour les #ID_xxx
+		if (substr($nom,0,3) == 'ID_') $p-&gt;statut = 'num';
+	}
+
+	else {
+	// on renvoie la forme initiale '#TOTO'
+	$p-&gt;code = &quot;'#&quot; . $nom . &quot;'&quot;;
+	$p-&gt;statut = 'php';	// pas de traitement
+	
+	}
+
+	// Retourner l'expression php correspondant au champ + ses filtres
+	return applique_filtres($p);
+}
+
+// cette fonction sert d'API pour demander le champ '$champ' dans la pile
+function champ_sql($champ, $p) {
+	return index_pile($p-&gt;id_boucle, $champ, $p-&gt;boucles, $p-&gt;nom_boucle);
+}
+
+// cette fonction sert d'API pour demander une balise quelconque sans filtre
+function calculer_balise($nom, $p) {
+
+	// regarder s'il existe une fonction personnalisee balise_NOM()
+	$f = 'balise_' . $nom;
+	if (function_exists($f))
+		return $f($p);
+
+	// regarder s'il existe une fonction standard balise_NOM_dist()
+	$f = 'balise_' . $nom . '_dist';
+	if (function_exists($f))
+		return $f($p);
+
+	// regarder s'il existe un fichier d'inclusion au nom de la balise
+	// et contenant un tableau balise_NOM_collecte
+	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
+	if ($file = find_in_path($file)) {
+		include_local($file);
+		$f = $GLOBALS['balise_' . $nom . '_collecte'];
+		if (is_array($f))
+			return calculer_balise_dynamique($p, $nom, $f);
+	}
+
+	// S'agit-il d'un logo ? Une fonction speciale les traite tous
+	if (ereg('^LOGO_', $nom))
+		return calculer_balise_logo($p);
+
+	// ca pourrait etre un champ SQL homonyme,
+	$p-&gt;code = index_pile($p-&gt;id_boucle, $nom, $p-&gt;boucles, $p-&gt;nom_boucle);
+
+	// Compatibilite ascendante avec les couleurs html (#FEFEFE) :
+	// SI le champ SQL n'est pas trouve
+	// ET si la balise a une forme de couleur
+	// ET s'il n'y a ni filtre ni etoile
+	// ALORS retourner la couleur.
+	// Ca permet si l'on veut vraiment de recuperer [(#ACCEDE*)]
+	if (ereg(&quot;^[\$]Pile[[]0[]][[]'([A-F]{1,6})'[]]$&quot;, $p-&gt;code, $match)
+	AND !$p-&gt;etoile
+	AND !$p-&gt;fonctions) {
+		$p-&gt;code = &quot;'#&quot;. $match[1].&quot;'&quot;;
+		$p-&gt;statut = 'php';
+	}
+
+	return $p;
+}
+
+//
+// Traduction des balises dynamiques, notamment les &quot;formulaire_*&quot;
+// Inclusion du fichier associe a son nom.
+// Ca donne les arguments a chercher dans la pile,on compile leur localisation
+// Ensuite on delegue a une fonction generale definie dans inc-calcul-outils
+// qui recevra a l'execution la valeurs des arguments, 
+// ainsi que les filtres (qui ne sont donc pas traites a la compil)
+
+function calculer_balise_dynamique($p, $nom, $l) {
+	balise_distante_interdite($p);
+	$param = param_balise($p);
+	$p-&gt;code = &quot;executer_balise_dynamique('&quot; . $nom . &quot;',\n\tarray(&quot;
+	  . join(',',collecter_balise_dynamique($l, $p))
+	  . filtres_arglist($param, $p, ',')
+	  . &quot;),\n\tarray(&quot;
+	  . (!$p-&gt;fonctions ? '' : (&quot;'&quot; . join(&quot;','&quot;, $p-&gt;fonctions) . &quot;'&quot;))
+	  . &quot;), \$GLOBALS['spip_lang'])&quot;;
+	$p-&gt;statut = 'php';
+	$p-&gt;fonctions = '';
+
+	// Cas particulier de #FORMULAIRE_FORUM : inserer l'invalideur
+	if ($nom == 'FORMULAIRE_FORUM')
+		$p-&gt;code = code_invalideur_forums($p, $p-&gt;code);
+
+	return $p;
+}
+
+function param_balise(&amp;$p) {
+	$a = $p-&gt;fonctions;
+	if ($a) list(,$nom) = each($a) ; else $nom = '';
+	if (!ereg(' *\{ *([^}]+) *\} *',$nom, $m))
+	  return '';
+	else {
+		$filtres= array();
+		while (list(, $f) = each($a)) if ($f) $filtres[] = $f;
+		$p-&gt;fonctions = $filtres;
+		return $m[1];
+	}
+}
+
+// construire un tableau des valeurs interessant un formulaire
+
+function collecter_balise_dynamique($l, $p) {
+	$args = array();
+	foreach($l as $c) { $x = calculer_balise($c, $p); $args[] = $x-&gt;code;}
+	return $args;
+}
+
+// Genere l'application d'une liste de filtres
+function applique_filtres($p) {
+
+	$statut = $p-&gt;statut;
+	$fonctions = $p-&gt;fonctions;
+	$p-&gt;fonctions = ''; # pour r&#233;utiliser la structure si r&#233;cursion
+
+	// pretraitements standards
+	switch ($statut) {
+		case 'num':
+			$code = &quot;intval($code)&quot;;
+			break;
+		case 'php':
+			break;
+		case 'html':
+		default:
+			$code = &quot;trim($code)&quot;;
+			break;
+	}
+
+//  processeurs standards (cf inc-balises.php3)
+	$code = ($p-&gt;etoile ? $p-&gt;code : champs_traitements($p));
+	// Appliquer les filtres perso
+	if ($fonctions) {
+		foreach($fonctions as $fonc) {
+			if ($fonc) {
+
+				$arglist = '';
+				if (ereg('([^\{\}]+)\{(.+)\}$', $fonc, $regs)) {
+					$fonc = $regs[1];
+
+				        $arglist = filtres_arglist($regs[2],$p, ($fonc == '?' ? ':' : ','));
+				}
+				if (function_exists($fonc))
+				  $code = &quot;$fonc($code$arglist)&quot;;
+				else if (strpos(&quot; &lt; &gt; &lt;= &gt;= == &lt;&gt; ? &quot;, &quot; $fonc &quot;))
+				  $code = &quot;($code $fonc &quot;
+				    . substr($arglist,1)
+				    . ')';
+				else 
+				  $code = &quot;erreur_squelette('&quot;.
+					  texte_script(
+						_T('zbug_erreur_filtre', array('filtre' =&gt; $fonc))
+					).&quot;','&quot; . $p-&gt;id_boucle . &quot;')&quot;;
+			}
+		}
+	}
+
+	// post-traitement securite
+	if ($statut == 'html')
+		$code = &quot;interdire_scripts($code)&quot;;
+	return $code;
+}
+
+// analyse des parametres d'un champ etendu
+// [...(#CHAMP{parametres})...] ou [...(#CHAMP|filtre{parametres})...]
+// retourne une suite de N references aux N valeurs indiqu&#233;es avec N virgules
+
+function filtres_arglist($args, $p, $sep) {
+	$arglist ='';
+	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
+		$arg = trim($regs[1]);
+		if ($arg) {
+			if ($arg[0] =='$')
+				$arg = '$Pile[0][\'' . substr($arg,1) . &quot;']&quot;;
+			elseif ($arg[0] =='&lt;')
+			  $arg = calculer_texte($arg, $p-&gt;id_boucle, $p-&gt;boucles, $p-&gt;id_mere);
+			elseif (ereg(&quot;^&quot; . NOM_DE_CHAMP .&quot;(.*)$&quot;, $arg, $r2)) {
+				$p-&gt;nom_boucle = $r2[2];
+				$p-&gt;nom_champ = $r2[3];
+				# faudrait verifier !trim(r2[5])
+				$arg = calculer_champ($p);
+			} 
+
+			$arglist .= $sep . $arg;
+		}
+		$args=$regs[2];
+	}
+	return $arglist;
+}
+
+//
+// Reserve les champs necessaires a la comparaison avec le contexte donne par
+// la boucle parente ; attention en recursif il faut les reserver chez soi-meme
+// ET chez sa maman
+// 
+function calculer_argument_precedent($idb, $nom_champ, &amp;$boucles) {
+
+	// recursif ?
+	if ($boucles[$idb]-&gt;externe)
+		index_pile ($idb, $nom_champ, $boucles); // reserver chez soi-meme
+	// reserver chez le parent et renvoyer l'habituel $Pile[$SP]['nom_champ']
+#	spip_log(&quot;boucles[$idb]-&gt;id_parent &quot; . $boucles[$idb]-&gt;id_parent);
+	return index_pile ($boucles[$idb]-&gt;id_parent, $nom_champ, $boucles);
+}
+
+function rindex_pile($p, $champ, $motif) 
+{
+	$n = 0;
+	$b = $p-&gt;id_boucle;
+	$p-&gt;code = '';
+	while ($b != '') {
+	if ($s = $p-&gt;boucles[$b]-&gt;param) {
+	  foreach($s as $v) {
+		if (strpos($v,$motif) !== false) {
+		  $p-&gt;code = '$Pile[$SP' . (($n==0) ? &quot;&quot; : &quot;-$n&quot;) .
+			&quot;]['$champ']&quot;;
+		  $b = '';
+		  break;
+		}
+	  }
+	}
+	$n++;
+	$b = $p-&gt;boucles[$b]-&gt;id_parent;
+	}
+	if (!$p-&gt;code) {
+		erreur_squelette(_T('zbug_champ_hors_motif',
+			array('champ' =&gt; '#' . strtoupper($champ),
+				'motif' =&gt; $motif)
+		), $p-&gt;id_boucle);
+	}
+	$p-&gt;statut = 'php';
+	return $p;
+}
+
+?&gt;

Index: inc-compilo.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-compilo.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-compilo.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,684 +1,700 @@
-&lt;?php
-
-//
-// Fichier principal du compilateur de squelettes
-//
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_COMPILO&quot;)) return;
-define(&quot;_INC_COMPILO&quot;, &quot;1&quot;);
-
-
[...1353 lines suppressed...]
+function $nom (\$Cache, \$Pile, \$doublons=array(), \$Numrows='', \$SP=0) {
+\$t0 = $corps;
+
+	return array(
+		'texte' =&gt; \$t0,
+		'squelette' =&gt; '$nom',
+		'process_ins' =&gt; ((strpos(\$t0,'&lt;'.'?')=== false) ? 'html' : 'php'),
+		'invalideurs' =&gt; \$Cache
+	);
+}
+
+?&quot;.&quot;&gt;&quot;;
+
+	if ($GLOBALS['var_mode'] == 'debug')
+		squelette_debug_compile($nom, $sourcefile, $squelette_compile);
+	return $squelette_compile;
+
+}
+
+?&gt;

Index: inc-criteres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-criteres.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-criteres.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-criteres.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,623 +1,642 @@
-&lt;?php
-
-//
-// Definition des {criteres} d'une boucle
-//
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_CRITERES&quot;)) return;
-define(&quot;_INC_CRITERES&quot;, &quot;1&quot;);
-
-
[...1234 lines suppressed...]
+	foreach (split(&quot; *, *&quot;, $reg[1]) as $v) {
+	  $v = calculer_param_dynamique($v, $boucles, $idb);
+	  if (is_array($v)) erreur_squelette($v);
+	  if (strpos('0123456789',$v[0]) !== false)
+	    $res[] = $v;
+	  else if ($v[0]=='&quot;')
+	    $res[] = &quot;'&quot; . $v . &quot;'&quot;;
+	  else
+	    $res[] = &quot;'$v'&quot;;
+	}
+	return join(',', $res);
+}
+
+function simplifie_param_dynamique($val, &amp;$boucles, $idb)
+{
+	$a = calculer_param_dynamique($val, $boucles, $idb);
+	if (!ereg('&quot; \. *(.*)\. &quot;', $a, $m)) return $a;
+	return $m[1];
+}	
+?&gt;

Index: inc-html-squel.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-html-squel.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-html-squel.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-html-squel.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,337 +1,339 @@
-&lt;?php
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_HTML_SQUEL&quot;)) return;
-define(&quot;_INC_HTML_SQUEL&quot;, &quot;1&quot;);
-
-# Ce fichier doit IMPERATIVEMENT contenir la fonction &quot;parser&quot;
-# qui transforme un squelette en un tableau d'objets de classe Boucle
-# il est charge par un include calcule dans inc-calcul-squel
-# pour permettre differentes syntaxes en entree
-
-define('NOM_DE_BOUCLE', &quot;[0-9]+|[-_][-_.a-zA-Z0-9]*&quot;);
-define('NOM_DE_CHAMP', &quot;#((&quot; . NOM_DE_BOUCLE . &quot;):)?([A-Z_]+)(\*?)&quot;);
-define('CHAMP_ETENDU', '\[([^]\[]*)\(' . NOM_DE_CHAMP . '([^]\[)]*)\)([^]\[]*)\]');
-define('PARAM_DE_BOUCLE','[[:space:]]*\{[[:space:]]*([^{}]*(\{[^\}]*\}[^\}]*)*)[[:space:]]*\}');
-define('TYPE_DE_BOUCLE', &quot;[^)]*&quot;);
-define('BALISE_DE_BOUCLE',
-	&quot;^&lt;BOUCLE(&quot; .
-	NOM_DE_BOUCLE .
-	')[[:space:]]*\((' .
-	TYPE_DE_BOUCLE .
-	')\)((' .
-	PARAM_DE_BOUCLE .
-	')*)[[:space:]]*&gt;');
-define('PARAM_INCLURE','[[:space:]]*\{[[:space:]]*([_0-9a-zA-Z]+)[[:space:]]*(=[[:space:]]*([^\{\}]*(\{[^\}]*\}[^\} ]*)?))?[[:space:]]*\}');
-define('BALISE_INCLURE',&quot;&lt;INCLU[DR]E[[:space:]]*\(&quot; .
-       '([-_0-9a-zA-Z./ ]+)' .
-	'\)((' .
-	PARAM_INCLURE .
-	')*)[[:space:]]*&gt;');
-define('DEBUT_DE_BOUCLE','/&lt;B('.NOM_DE_BOUCLE.')&gt;.*?&lt;BOUCLE\1[^-_.a-zA-Z0-9]|&lt;BOUCLE('.NOM_DE_BOUCLE.')/ms');	# preg
-
-
-function parser_inclure($texte, $result) {
-	while (($p=strpos($texte, '&lt;INCLU')) !== false) {
-		$fin = substr($texte, $p);
-
-		if (!ereg('^' . BALISE_INCLURE, $fin, $match)) break;
-		$s = $match[0];
-		$debut = substr($texte, 0, $p);
-		$texte = substr($fin, strlen($s));
-
-		if ($debut) $result = parser_champs($debut, $result);
-
-		$champ = new Inclure;
-		$champ-&gt;fichier = $match[1];
-		$champ-&gt;params = array();
-		$p = trim($match[2]);
-		if ($p) {
-			while (ereg('^' . PARAM_INCLURE . '(.*)$', $p, $m)) {
-				$champ-&gt;params[$m[1]] = $m[3];
-				$p = $m[5];
-			}
-			
-			if ($p)	erreur_squelette(_L(&quot;Param&egrave;tres d'inclusion incorrects&quot;), $s);
-		}
-		$result[] = $champ;
-	}
-
-	return (!$texte ? $result : parser_champs($texte, $result));
-}
-
-function parser_champs($texte,$result) {
-	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
-	  $p = strpos($texte, $regs[0]);
-
-	  if ($regs[4] || !ereg(&quot;[0-9a-z]&quot;, $regs[5][0])) {
-		if ($p) {
-			$champ = new Texte;
-			$champ-&gt;texte = (substr($texte, 0, $p));
-			$result[] = $champ;
-		}
-		  
-		$champ = new Champ;
-		$champ-&gt;nom_boucle = $regs[2];
-		$champ-&gt;nom_champ = $regs[3];
-		$champ-&gt;etoile = $regs[4];
-		$texte = $regs[5];
-		$result[] = $champ;
-	  } else {
-	    // faux champ
-	    $champ = new Texte;
-	    $champ-&gt;texte = (substr($texte, 0, $p+1));
-	    $result[] = $champ;
-	    $texte = (substr($texte, $p+1));
-	  }
-	}
-	if ($texte) {
-	  
-		$champ = new Texte;
-		$champ-&gt;texte = $texte;
-		$result[] = $champ;
-	}
-	return $result;
-}
-
-// Gestion des imbrications:
-// on cherches les [..] les plus internes et on les remplace par une  chaine
-// %###N@ o&#249; N indexe un tableau comportant le r&#233;sultat de leur phras&#233;
-// on recommence tant qu'il y a des [...] en substituant &#224; l'appel suivant
-
-function parser_champs_etendus($texte, $result) {
-	if (!$texte) return $result;
-	$sep = '##';
-	while (strpos($texte,$sep)!== false)
-		$sep .= '#';
-	return array_merge($result, parser_champs_interieurs($texte, $sep, array()));
-}
-
-
-function parser_champs_exterieurs($debut, $sep, $nested) {
-	$res = array();
-	while (($p=strpos($debut, &quot;%$sep&quot;))!==false) {
-	    if ($p) $res = parser_inclure(substr($debut,0,$p), $res);
-	    ereg(&quot;^%$sep([0-9]+)@(.*)$&quot;, substr($debut,$p),$m);
-	    $res[]= $nested[$m[1]];
-	    $debut = $m[2];
-	}
-	return (!$debut ?  $res : parser_inclure($debut, $res));
-
-}
-
-function parser_champs_interieurs($texte, $sep, $result) {
-	$i = 1;
-	while (true) {	  $j=$i;
-	  while (ereg(CHAMP_ETENDU . '(.*)$', $texte, $regs)) {
-		$champ = new Champ;
-		$champ-&gt;nom_boucle = $regs[3];
-		$champ-&gt;nom_champ = $regs[4];
-		$champ-&gt;etoile = $regs[5];
-		$champ-&gt;cond_avant = parser_champs_exterieurs($regs[1],$sep,$result);
-		$champ-&gt;cond_apres = parser_champs_exterieurs($regs[7],$sep,$result);
-		$fonctions = $regs[6];
-		if ($fonctions) {
-			$fonctions = explode('|', ereg_replace(&quot;^\|&quot;, &quot;&quot;, $fonctions));
-			foreach($fonctions as $f) $champ-&gt;fonctions[]= $f;
-		}
-
-		$p = strpos($texte, $regs[0]);
-		if ($p) {$result[$i] = substr($texte,0,$p);$i++; }
-		$result[$i] = $champ;
-		$i++;
-		$texte = $regs[8];
-	  }
-	  if ($texte) {$result[$i] = $texte; $i++;}
-	  $x ='';
-
-	  while($j &lt; $i) 
-	    { $z= $result[$j]; 
-	      if (is_object($z)) $x .= &quot;%$sep$j@&quot; ; else $x.=$z ;
-	      $j++;}
-	  if (ereg(CHAMP_ETENDU, $x)) $texte = $x;
-	  else return parser_champs_exterieurs($x, $sep, $result);}
-}
-
-
-function parser_param($params, &amp;$result) {
-	$params2 = array();
-	$type = $result-&gt;type_requete;
-	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
-		$params = $m[3];
-		$m[1] = trim($m[1]);
-		// cas d'un critere avec {...}
-		if ($m[2])
-			$params2[] = $m[1];
-		else {
-			if (strlen($m[1]) &lt; 2)
-				$params2[] = $m[1];
-	    else {
-	      ereg('^(.)([^&quot;}]*)(.)$', $m[1], $args);
-	      // cas syntaxique general, 
-	      // traiter qq lexemes particuliers pour faciliter la suite
-	      if ($args[3] != '&quot;') {
-			$param = $m[1];
-			if (($param == 'tout') OR ($param == 'tous')) {
-				$result-&gt;tout = true;
-				unset ($param);
-			}
-			else if ($param == 'plat') {
-				$result-&gt;plat = true;
-				unset ($param);
-			}
-
-			// Boucle hierarchie, analyser le critere id_article - id_rubrique
-			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
-			// forcer {tout} pour avoir la rubrique mere...
-			else if ($type == 'hierarchie') {
-				if ($param == 'id_article' OR $param == 'id_syndic') {
-					$result-&gt;tout = true;
-					unset ($param);
-				} else if ($param == 'id_rubrique')
-					unset ($param);
-			}
-
-			// synonyme
-			if ($param == 'unique') $param = 'doublons';
-
-			// l'ajouter
-			if ($param)
-				$params2[] = $param;
-	      }
-		else {
-		  // cas d'un guillemet final
-			if ($args[1] == '&quot;') {
-			  // si tout le param est entre guillement, vite vu
-				$result-&gt;separateur = 
-					ereg_replace(&quot;'&quot;,&quot;\'&quot;,$args[2]);
-			}
-			else {
-				$params2[] = $args[1] . $args[2] . '&quot;' . $m[1];
-			}
-		}
-	    }
-	  }
-	}
-	$result-&gt;param = $params2;
-}
-
-function parser($texte, $id_parent, &amp;$boucles, $nom) {
-
-	$all_res = array();
-
-	while (preg_match(DEBUT_DE_BOUCLE, $texte, $regs)) {
-		$nom_boucle = $regs[1].$regs[2];
-		$p = strpos($texte, '&lt;BOUCLE'.$nom_boucle);
-
-		// envoyer la boucle au debugueur
-		if ($GLOBALS['var_mode']== 'debug') {
-			$preg = &quot;@&lt;B($nom_boucle|OUCLE${nom_boucle}[^-_.a-zA-Z0-9][^&gt;]*)&gt;&quot;
-				. &quot;.*&lt;/(BOUCLE|/?B)$nom_boucle&gt;@ms&quot;;
-			preg_match($preg, $texte, $match);
-			boucle_debug ($nom_boucle, $nom, $match[0]);
-		}
-
-		//
-		// Recuperer la partie principale de la boucle
-		//
-		$debut = substr($texte, 0, $p);
-		$milieu = substr($texte, $p);
-
-		if (!ereg(BALISE_DE_BOUCLE, $milieu, $match)) {
-			erreur_squelette((_T('erreur_boucle_syntaxe')), $milieu);
-		}
-		$id_boucle = $match[1];
-
-		$result = new Boucle;
-		$result-&gt;id_parent = $id_parent;
-		$result-&gt;id_boucle = $id_boucle;
-
-		$type = $match[2];
-		if ($p =strpos($type, ':'))
-		  {
-		    $result-&gt;sql_serveur = substr($type,0,$p);
-		    $type = substr($type,$p+1);
-		  }
-		$type = strtolower($type);
-		if ($type == 'sites') $type = 'syndication'; # alias
-
-		//
-		// Recuperer les criteres de la boucle (sauf boucle recursive)
-		//
-		if (substr($type, 0, 6) == 'boucle') {
-			$result-&gt;type_requete = 'boucle';
-			$result-&gt;param = substr($match[2], 6);
-		} else {
-			$result-&gt;type_requete = $type;
-			parser_param($match[3], $result);
-		}
-
-		//
-		// Recuperer la partie conditionnelle avant
-		//
-		$s = &quot;&lt;B$id_boucle&gt;&quot;;
-		$p = strpos($debut, $s);
-		if ($p !== false) {
-			$result-&gt;cond_avant = substr($debut, $p + strlen($s));
-			$debut = substr($debut, 0, $p);
-		}
-		$milieu = substr($milieu, strlen($match[0]));
-		if (strpos($milieu, $s)) {
-			erreur_squelette(_T('erreur_boucle_syntaxe'),
-				$id_boucle . 
-				_L('&nbsp;: balise B en aval'));
-		}
-
-		//
-		// Recuperer la fin :
-		//
-		$s = &quot;&lt;/BOUCLE$id_boucle&gt;&quot;;
-		$p = strpos($milieu, $s);
-		if ($p === false) {
-			erreur_squelette(_T('erreur_boucle_syntaxe'),
-					 _T('erreur_boucle_fermant',
-						array('id'=&gt;$id_boucle)));
-		}
-		$texte = substr($milieu, $p + strlen($s));
-		$milieu = substr($milieu, 0, $p);
-
-		//
-		// 1. Recuperer la partie conditionnelle apres
-		//
-		$s = &quot;&lt;/B$id_boucle&gt;&quot;;
-		$p = strpos($texte, $s);
-		if ($p !== false) {
-			$result-&gt;cond_fin = substr($texte, 0, $p);
-			$texte = substr($texte, $p + strlen($s));
-		}
-
-		//
-		// 2. Recuperer la partie alternative
-		//
-		$s = &quot;&lt;//B$id_boucle&gt;&quot;;
-		$p = strpos($texte, $s);
-		if ($p !== false) {
-			$result-&gt;cond_altern = substr($texte, 0, $p);
-			$texte = substr($texte, $p + strlen($s));
-		}
-
-		$result-&gt;cond_avant = parser($result-&gt;cond_avant, $id_parent,$boucles, $nom);
-		$result-&gt;cond_apres = parser($result-&gt;cond_fin, $id_parent,$boucles, $nom);
-		$result-&gt;cond_altern = parser($result-&gt;cond_altern,$id_parent,$boucles, $nom);
-		$result-&gt;milieu = parser($milieu, $id_boucle,$boucles, $nom);
-
-		$all_res = parser_champs_etendus($debut, $all_res);
-		$all_res[] = $result;
-		if ($boucles[$id_boucle]) {
-			erreur_squelette(_T('erreur_boucle_syntaxe'),
-					 _T('erreur_boucle_double',
-					 	array('id'=&gt;$id_boucle)));
-		} else
-			$boucles[$id_boucle] = $result;
-	}
-
-	return parser_champs_etendus($texte, $all_res);
-}
-
-?&gt;
+&lt;?php
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_HTML_SQUEL&quot;)) return;
+define(&quot;_INC_HTML_SQUEL&quot;, &quot;1&quot;);
+
+# Ce fichier doit IMPERATIVEMENT contenir la fonction &quot;parser&quot;
+# qui transforme un squelette en un tableau d'objets de classe Boucle
+# il est charge par un include calcule dans inc-calcul-squel
+# pour permettre differentes syntaxes en entree
+
+define('NOM_DE_BOUCLE', &quot;[0-9]+|[-_][-_.a-zA-Z0-9]*&quot;);
+define('NOM_DE_CHAMP', &quot;#((&quot; . NOM_DE_BOUCLE . &quot;):)?([A-Z_]+)(\*?)&quot;);
+define('CHAMP_ETENDU', '\[([^]\[]*)\(' . NOM_DE_CHAMP . '([^]\[)]*)\)([^]\[]*)\]');
+define('PARAM_DE_BOUCLE','[[:space:]]*\{[[:space:]]*([^{}]*(\{[^\}]*\}[^\}]*)*)[[:space:]]*\}');
+define('TYPE_DE_BOUCLE', &quot;[^)]*&quot;);
+define('BALISE_DE_BOUCLE',
+	&quot;^&lt;BOUCLE(&quot; .
+	NOM_DE_BOUCLE .
+	')[[:space:]]*\((' .
+	TYPE_DE_BOUCLE .
+	')\)((' .
+	PARAM_DE_BOUCLE .
+	')*)[[:space:]]*&gt;');
+define('PARAM_INCLURE','[[:space:]]*\{[[:space:]]*([_0-9a-zA-Z]+)[[:space:]]*(=[[:space:]]*([^\{\}]*(\{[^\}]*\}[^\} ]*)?))?[[:space:]]*\}');
+define('BALISE_INCLURE',&quot;&lt;INCLU[DR]E[[:space:]]*\(&quot; .
+       '([-_0-9a-zA-Z./ ]+)' .
+	'\)((' .
+	PARAM_INCLURE .
+	')*)[[:space:]]*&gt;');
+define('DEBUT_DE_BOUCLE','/&lt;B('.NOM_DE_BOUCLE.')&gt;.*?&lt;BOUCLE\1[^-_.a-zA-Z0-9]|&lt;BOUCLE('.NOM_DE_BOUCLE.')/ms');	# preg
+
+
+function parser_inclure($texte, $result) {
+	while (($p=strpos($texte, '&lt;INCLU')) !== false) {
+		$fin = substr($texte, $p);
+
+		if (!ereg('^' . BALISE_INCLURE, $fin, $match)) break;
+		$s = $match[0];
+		$debut = substr($texte, 0, $p);
+		$texte = substr($fin, strlen($s));
+
+		if ($debut) $result = parser_champs($debut, $result);
+
+		$champ = new Inclure;
+		$champ-&gt;fichier = $match[1];
+		$champ-&gt;params = array();
+		$p = trim($match[2]);
+		if ($p) {
+			while (ereg('^' . PARAM_INCLURE . '(.*)$', $p, $m)) {
+				$champ-&gt;params[$m[1]] = $m[3];
+				$p = $m[5];
+			}
+			
+			if ($p)
+				erreur_squelette(_T('zbug_parametres_inclus_incorrects'),
+				$s);
+		}
+		$result[] = $champ;
+	}
+
+	return (!$texte ? $result : parser_champs($texte, $result));
+}
+
+function parser_champs($texte,$result) {
+	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
+	  $p = strpos($texte, $regs[0]);
+
+	  if ($regs[4] || !ereg(&quot;[0-9a-z]&quot;, $regs[5][0])) {
+		if ($p) {
+			$champ = new Texte;
+			$champ-&gt;texte = (substr($texte, 0, $p));
+			$result[] = $champ;
+		}
+		  
+		$champ = new Champ;
+		$champ-&gt;nom_boucle = $regs[2];
+		$champ-&gt;nom_champ = $regs[3];
+		$champ-&gt;etoile = $regs[4];
+		$texte = $regs[5];
+		$result[] = $champ;
+	  } else {
+	    // faux champ
+	    $champ = new Texte;
+	    $champ-&gt;texte = (substr($texte, 0, $p+1));
+	    $result[] = $champ;
+	    $texte = (substr($texte, $p+1));
+	  }
+	}
+	if ($texte) {
+	  
+		$champ = new Texte;
+		$champ-&gt;texte = $texte;
+		$result[] = $champ;
+	}
+	return $result;
+}
+
+// Gestion des imbrications:
+// on cherche les [..] les plus internes et on les remplace par une chaine
+// %###N@ ou N indexe un tableau comportant le resultat de leur phrase
+// on recommence tant qu'il y a des [...] en substituant a l'appel suivant
+
+function parser_champs_etendus($texte, $result) {
+	if (!$texte) return $result;
+	$sep = '##';
+	while (strpos($texte,$sep)!== false)
+		$sep .= '#';
+	return array_merge($result, parser_champs_interieurs($texte, $sep, array()));
+}
+
+
+function parser_champs_exterieurs($debut, $sep, $nested) {
+	$res = array();
+	while (($p=strpos($debut, &quot;%$sep&quot;))!==false) {
+	    if ($p) $res = parser_inclure(substr($debut,0,$p), $res);
+	    ereg(&quot;^%$sep([0-9]+)@(.*)$&quot;, substr($debut,$p),$m);
+	    $res[]= $nested[$m[1]];
+	    $debut = $m[2];
+	}
+	return (!$debut ?  $res : parser_inclure($debut, $res));
+
+}
+
+function parser_champs_interieurs($texte, $sep, $result) {
+	$i = 1;
+	while (true) {	  $j=$i;
+	  while (ereg(CHAMP_ETENDU . '(.*)$', $texte, $regs)) {
+		$champ = new Champ;
+		$champ-&gt;nom_boucle = $regs[3];
+		$champ-&gt;nom_champ = $regs[4];
+		$champ-&gt;etoile = $regs[5];
+		$champ-&gt;cond_avant = parser_champs_exterieurs($regs[1],$sep,$result);
+		$champ-&gt;cond_apres = parser_champs_exterieurs($regs[7],$sep,$result);
+		$fonctions = $regs[6];
+		if ($fonctions) {
+			$fonctions = explode('|', ereg_replace(&quot;^\|&quot;, &quot;&quot;, $fonctions));
+			foreach($fonctions as $f) $champ-&gt;fonctions[]= $f;
+		}
+
+		$p = strpos($texte, $regs[0]);
+		if ($p) {$result[$i] = substr($texte,0,$p);$i++; }
+		$result[$i] = $champ;
+		$i++;
+		$texte = $regs[8];
+	  }
+	  if ($texte) {$result[$i] = $texte; $i++;}
+	  $x ='';
+
+	  while($j &lt; $i) 
+	    { $z= $result[$j]; 
+	      if (is_object($z)) $x .= &quot;%$sep$j@&quot; ; else $x.=$z ;
+	      $j++;}
+	  if (ereg(CHAMP_ETENDU, $x)) $texte = $x;
+	  else return parser_champs_exterieurs($x, $sep, $result);}
+}
+
+
+function parser_param($params, &amp;$result) {
+	$params2 = array();
+	$type = $result-&gt;type_requete;
+	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
+		$params = $m[3];
+		$m[1] = trim($m[1]);
+		// cas d'un critere avec {...}
+		if ($m[2])
+			$params2[] = $m[1];
+		else {
+			if (strlen($m[1]) &lt; 2)
+				$params2[] = $m[1];
+	    else {
+	      ereg('^(.)([^&quot;}]*)(.)$', $m[1], $args);
+	      // cas syntaxique general, 
+	      // traiter qq lexemes particuliers pour faciliter la suite
+	      if ($args[3] != '&quot;') {
+			$param = $m[1];
+			if (($param == 'tout') OR ($param == 'tous')) {
+				$result-&gt;tout = true;
+				unset ($param);
+			}
+			else if ($param == 'plat') {
+				$result-&gt;plat = true;
+				unset ($param);
+			}
+
+			// Boucle hierarchie, analyser le critere id_article - id_rubrique
+			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
+			// forcer {tout} pour avoir la rubrique mere...
+			else if ($type == 'hierarchie') {
+				if ($param == 'id_article' OR $param == 'id_syndic') {
+					$result-&gt;tout = true;
+					unset ($param);
+				} else if ($param == 'id_rubrique')
+					unset ($param);
+			}
+
+			// synonyme
+			if ($param == 'unique') $param = 'doublons';
+
+			// l'ajouter
+			if ($param)
+				$params2[] = $param;
+	      }
+		else {
+		  // cas d'un guillemet final
+			if ($args[1] == '&quot;') {
+			  // si tout le param est entre guillement, vite vu
+				$result-&gt;separateur = 
+					ereg_replace(&quot;'&quot;,&quot;\'&quot;,$args[2]);
+			}
+			else {
+				$params2[] = $args[1] . $args[2] . '&quot;' . $m[1];
+			}
+		}
+	    }
+	  }
+	}
+	$result-&gt;param = $params2;
+}
+
+function parser($texte, $id_parent, &amp;$boucles, $nom) {
+
+	$all_res = array();
+
+	while (preg_match(DEBUT_DE_BOUCLE, $texte, $regs)) {
+		$nom_boucle = $regs[1].$regs[2];
+		$p = strpos($texte, '&lt;BOUCLE'.$nom_boucle);
+
+		// envoyer la boucle au debugueur
+		if ($GLOBALS['var_mode']== 'debug') {
+			$preg = &quot;@&lt;B($nom_boucle|OUCLE${nom_boucle}[^-_.a-zA-Z0-9][^&gt;]*)&gt;&quot;
+				. &quot;.*&lt;/(BOUCLE|/?B)$nom_boucle&gt;@ms&quot;;
+			preg_match($preg, $texte, $match);
+			boucle_debug ($nom_boucle, $nom, $match[0]);
+		}
+
+		//
+		// Recuperer la partie principale de la boucle
+		//
+		$debut = substr($texte, 0, $p);
+		$milieu = substr($texte, $p);
+
+		if (!ereg(BALISE_DE_BOUCLE, $milieu, $match)) {
+			erreur_squelette((_T('zbug_erreur_boucle_syntaxe')), $milieu);
+		}
+		$id_boucle = $match[1];
+
+		$result = new Boucle;
+		$result-&gt;id_parent = $id_parent;
+		$result-&gt;id_boucle = $id_boucle;
+
+		$type = $match[2];
+		if ($p =strpos($type, ':'))
+		  {
+		    $result-&gt;sql_serveur = substr($type,0,$p);
+		    $type = substr($type,$p+1);
+		  }
+		$type = strtolower($type);
+		if ($type == 'sites') $type = 'syndication'; # alias
+
+		//
+		// Recuperer les criteres de la boucle (sauf boucle recursive)
+		//
+		if (substr($type, 0, 6) == 'boucle') {
+			$result-&gt;type_requete = 'boucle';
+			$result-&gt;param = substr($match[2], 6);
+		} else {
+			$result-&gt;type_requete = $type;
+			parser_param($match[3], $result);
+		}
+
+		//
+		// Recuperer la partie conditionnelle avant
+		//
+		$s = &quot;&lt;B$id_boucle&gt;&quot;;
+		$p = strpos($debut, $s);
+		if ($p !== false) {
+			$result-&gt;cond_avant = substr($debut, $p + strlen($s));
+			$debut = substr($debut, 0, $p);
+		}
+		$milieu = substr($milieu, strlen($match[0]));
+		if (strpos($milieu, $s)) {
+			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
+				$id_boucle . 
+				_T('zbug_balise_b_aval'));
+		}
+
+		//
+		// Recuperer la fin :
+		//
+		$s = &quot;&lt;/BOUCLE$id_boucle&gt;&quot;;
+		$p = strpos($milieu, $s);
+		if ($p === false) {
+			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
+					 _T('zbug_erreur_boucle_fermant',
+						array('id'=&gt;$id_boucle)));
+		}
+		$texte = substr($milieu, $p + strlen($s));
+		$milieu = substr($milieu, 0, $p);
+
+		//
+		// 1. Recuperer la partie conditionnelle apres
+		//
+		$s = &quot;&lt;/B$id_boucle&gt;&quot;;
+		$p = strpos($texte, $s);
+		if ($p !== false) {
+			$result-&gt;cond_fin = substr($texte, 0, $p);
+			$texte = substr($texte, $p + strlen($s));
+		}
+
+		//
+		// 2. Recuperer la partie alternative
+		//
+		$s = &quot;&lt;//B$id_boucle&gt;&quot;;
+		$p = strpos($texte, $s);
+		if ($p !== false) {
+			$result-&gt;cond_altern = substr($texte, 0, $p);
+			$texte = substr($texte, $p + strlen($s));
+		}
+
+		$result-&gt;cond_avant = parser($result-&gt;cond_avant, $id_parent,$boucles, $nom);
+		$result-&gt;cond_apres = parser($result-&gt;cond_fin, $id_parent,$boucles, $nom);
+		$result-&gt;cond_altern = parser($result-&gt;cond_altern,$id_parent,$boucles, $nom);
+		$result-&gt;milieu = parser($milieu, $id_boucle,$boucles, $nom);
+
+		$all_res = parser_champs_etendus($debut, $all_res);
+		$all_res[] = $result;
+		if ($boucles[$id_boucle]) {
+			erreur_squelette(_T('zbug_erreur_boucle_syntaxe'),
+					 _T('zbug_erreur_boucle_double',
+					 	array('id'=&gt;$id_boucle)));
+		} else
+			$boucles[$id_boucle] = $result;
+	}
+
+	return parser_champs_etendus($texte, $all_res);
+}
+
+?&gt;

Index: inc-messforum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-messforum.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-messforum.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-messforum.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,181 +1,201 @@
-&lt;?php
-
-include_ecrire('inc_meta.php3');
-include_ecrire('inc_forum.php3');
-
-// Ce fichier inclus par inc-public a un comportement special
-// Voir commentaires dans celui-ci et dans inc-formulaire_forum
-
-function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre)
-{
-	include_ecrire('inc_texte.php3');
-	include_ecrire('inc_filtres.php3');
-	include_ecrire('inc_mail.php3');
-	// Gestionnaire d'URLs
-	if (@file_exists(&quot;inc-urls.php3&quot;))
-	  include_local(&quot;inc-urls.php3&quot;);
-	else
-	  include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
-	$url = ereg_replace('^/', '', generer_url_article($id_article));
-	$adresse_site = lire_meta(&quot;adresse_site&quot;);
-	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
-	$url = &quot;$adresse_site/$url&quot;;
-	$parauteur = (strlen($auteur) &lt;= 2) ? '' :
-	  (&quot; &quot;
-	   ._T('forum_par_auteur',
-	       array('auteur' =&gt; $auteur)) .
-	   (!$email_auteur ? '' : (' &lt;' . $email_auteur . '&gt;')));
-	$courr =  _T('form_forum_message_auto').&quot;\n\n&quot;
-		. _T('forum_poste_par',
-		     array('parauteur' =&gt; $parauteur)).&quot;\n&quot;
-		. _T('forum_ne_repondez_pas').&quot;\n&quot;
-		. $url
-		. &quot;\n\n\n&quot;.$titre.&quot;\n\n&quot;.textebrut(propre($texte))
-		. &quot;\n\n$nom_site_forum\n$url_site\n&quot;;
-	$sujet = &quot;[$nom_site_spip] [&quot;._T('forum_forum').&quot;] $titre&quot;;
-	$result = spip_query(&quot;SELECT auteurs.email FROM spip_auteurs AS auteurs,
-				spip_auteurs_articles AS lien
-				WHERE lien.id_article='$id_article'
-				AND auteurs.id_auteur=lien.id_auteur&quot;);
-
-	while (list($email) = spip_fetch_array($result)) {
-		$email = trim($email);
-		if (strlen($email) &lt; 3) continue;
-		envoyer_mail($email, $sujet, $courr);
-	}
-}	
-
-$retour_forum = rawurldecode($retour);
-$forum_id_article = intval($id_article);
-$forum_id_rubrique = intval($id_rubrique);
-$forum_id_forum = intval($id_forum);
-$forum_id_breve = intval($id_breve);
-$forum_id_syndic = intval($id_syndic);
-$slash_texte = addslashes($texte);
-$slash_titre = addslashes($titre);
-$slash_nom_site_forum = addslashes($nom_site_forum);
-$slash_url_site = addslashes($url_site);
-$id_message = intval($id_message);
-
-if (!$id_auteur)
-	$id_auteur = intval($auteur_session['id_auteur']);
-
-if ($forum_id_article) {
-	$r = spip_query(&quot;SELECT accepter_forum FROM spip_articles WHERE id_article=$forum_id_article&quot;);
-	$r = spip_fetch_array($r);
-	if ($r)
-		$forums_publics = $r['accepter_forum'];
-	else
-		$forums_publics = lire_meta(&quot;forums_publics&quot;);
-} else {
-	$forums_publics = substr(lire_meta(&quot;forums_publics&quot;),0,3);
-}
-
-if ($forums_publics == &quot;abo&quot;) {
-	if ($auteur_session) {
-		$statut = $auteur_session['statut'];
-		if (!$statut OR $statut == '5poubelle') {
-			ask_php_auth(_T('forum_acces_refuse'),
-				     _T('forum_cliquer_retour',
-					array('retour_forum' =&gt; $retour_forum)));
-			exit;		  
-		}
-	}
-	else {
-		ask_php_auth(_T('forum_non_inscrit'),
-			     _T('forum_cliquer_retour',
-				array('retour_forum' =&gt; $retour_forum)));
-		exit;		  
-	}
-
-	// Ne pas autoriser de changement de nom si forum sur abonnement
-	$auteur = $auteur_session['nom'];
-	$email_auteur = $auteur_session['email'];
- } 
-
-$slash_auteur = addslashes($auteur);
-$slash_email_auteur = addslashes($email_auteur);
-
-if ((strlen($slash_texte) + strlen($slash_titre) + strlen($slash_nom_site_forum) + strlen($slash_url_site) + strlen($slash_auteur) + strlen($slash_email_auteur)) &gt; 20 * 1024) {
-	ask_php_auth(_T('forum_message_trop_long'),
-		     _T('forum_cliquer_retour',
-			array('retour_forum' =&gt; $retour_forum)));
-			exit;		  
-}
-
-spip_query(&quot;DELETE FROM spip_mots_forum WHERE id_forum='$id_message'&quot;);
-if ($ajouter_mot) {
-	for (reset($ajouter_mot);$key=key($ajouter_mot);next($ajouter_mot))
-		$les_mots .= &quot;,&quot;.join($ajouter_mot[$key],&quot;,&quot;);
-	$les_mots = explode(&quot;,&quot;, $les_mots);
-	for ($index = 0; $index &lt; count($les_mots); $index++){
-		$le_mot = $les_mots[$index];
-		if ($le_mot &gt; 0)
-		spip_query(&quot;INSERT INTO spip_mots_forum (id_mot, id_forum)
-		VALUES ('$le_mot', '$id_message')&quot;);
-	}
-}
-
-$validation_finale = (strlen($confirmer) &gt; 0 OR
-	($afficher_texte=='non' AND $ajouter_mot));
-$statut = ((!$validation_finale) ? 'redac' : 
-	(($forums_publics == 'non') ? 'off' :
-	(($forums_publics == 'pri') ? 'prop' : 'publie')));
-
-if ($forum_id_forum &gt; 0) $id_thread = $forum_id_forum;
-else $id_thread = $id_message;
-
-spip_query(&quot;UPDATE spip_forum SET id_parent = $forum_id_forum,
-	id_rubrique =$forum_id_rubrique,
-	id_article = $forum_id_article,
-	id_breve = $forum_id_breve,
-	id_syndic = $forum_id_syndic,
-	id_auteur = $id_auteur,
-	id_thread = $id_thread,
-	date_heure = NOW(),
-	titre = \&quot;$slash_titre\&quot;,
-	texte = \&quot;$slash_texte\&quot;,
-	nom_site = \&quot;$slash_nom_site_forum\&quot;,
-	url_site = \&quot;$slash_url_site\&quot;,
-	auteur = \&quot;$slash_auteur\&quot;,
-	email_auteur = \&quot;$slash_email_auteur\&quot;,
-	ip = \&quot;$REMOTE_ADDR\&quot;,
-	statut = \&quot;$statut\&quot;
-	WHERE id_forum = '$id_message'
-&quot;);
-
-//calculer_threads();
-
-if ($validation_finale) {
-	include_ecrire(&quot;inc_admin.php3&quot;);
-	if (!(verifier_action_auteur(&quot;ajout_forum $forum_id_rubrique&quot;.
-	&quot; $forum_id_forum $forum_id_article $forum_id_breve&quot;.
-	&quot; $forum_id_syndic $alea&quot;, $hash))) {
-		header(&quot;Status: 404&quot;);
-		exit;
-	} else {
-	  if (lire_meta(&quot;prevenir_auteurs&quot;) == &quot;oui&quot; AND ($afficher_texte != &quot;non&quot;) AND ($id_article = $forum_id_article)) {
-			prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);
-
-		}
-		// Poser un cookie pour ne pas retaper le nom / email
-		$cookie_user = array('nom' =&gt; $auteur, 'email' =&gt; $email_auteur);
-		spip_setcookie('spip_forum_user', serialize($cookie_user));
-
-		//
-		// INVALIDATION DES CACHES LIES AUX FORUMS
-		//
-		include_ecrire('inc_invalideur.php3');
-		if ($statut == 'publie') {
-			suivre_invalideur (&quot;id='id_forum/&quot; .
-				calcul_index_forum($forum_id_article,
-					$forum_id_breve,
-					$forum_id_rubrique,
-					$forum_id_syndic) . &quot;'&quot;);
-		}
-
-		$redirect = $retour_forum;
-	}
-}
-
-?&gt;
+&lt;?php
+
+include_ecrire('inc_meta.php3');
+include_ecrire('inc_forum.php3');
+include_ecrire(&quot;inc_abstract_sql.php3&quot;);
+include_local(_FILE_CONNECT);
+
+// Ce fichier inclus par inc-public a un comportement special
+// Voir commentaires dans celui-ci et dans inc-formulaire_forum
+
+function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre) {
+	include_ecrire('inc_texte.php3');
+	include_ecrire('inc_filtres.php3');
+	include_ecrire('inc_mail.php3');
+	// Gestionnaire d'URLs
+	if (@file_exists(&quot;inc-urls.php3&quot;))
+	  include_local(&quot;inc-urls.php3&quot;);
+	else
+	  include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
+	$url = ereg_replace('^/', '', generer_url_article($id_article));
+	$adresse_site = lire_meta(&quot;adresse_site&quot;);
+	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
+	$url = &quot;$adresse_site/$url&quot;;
+	$parauteur = (strlen($auteur) &lt;= 2) ? '' :
+	  (&quot; &quot;
+	   ._T('forum_par_auteur',
+	       array('auteur' =&gt; $auteur)) .
+	   (!$email_auteur ? '' : (' &lt;' . $email_auteur . '&gt;')));
+	$courr =  _T('form_forum_message_auto').&quot;\n\n&quot;
+		. _T('forum_poste_par',
+		     array('parauteur' =&gt; $parauteur)).&quot;\n&quot;
+		. _T('forum_ne_repondez_pas').&quot;\n&quot;
+		. $url
+		. &quot;\n\n\n&quot;.$titre.&quot;\n\n&quot;.textebrut(propre($texte))
+		. &quot;\n\n$nom_site_forum\n$url_site\n&quot;;
+	$sujet = &quot;[$nom_site_spip] [&quot;._T('forum_forum').&quot;] $titre&quot;;
+	$result = spip_query(&quot;SELECT auteurs.email FROM spip_auteurs AS auteurs,
+				spip_auteurs_articles AS lien
+				WHERE lien.id_article='$id_article'
+				AND auteurs.id_auteur=lien.id_auteur&quot;);
+
+	while (list($email) = spip_fetch_array($result)) {
+		$email = trim($email);
+		if (strlen($email) &lt; 3) continue;
+		envoyer_mail($email, $sujet, $courr);
+	}
+}
+
+
+function controler_forum($id_article, $retour) {
+	global $auteur_session;
+
+	// Reglage forums d'article
+	if ($id_article) {
+		$q = spip_query(&quot;SELECT accepter_forum FROM spip_articles
+			WHERE id_article=$id_article&quot;);
+		if ($r = spip_fetch_array($q))
+			$forums_publics = $r['accepter_forum'];
+	}
+
+	// Valeur par defaut
+	if (!$forums_publics)
+		$forums_publics = substr(lire_meta(&quot;forums_publics&quot;),0,3);
+
+	if ($forums_publics == &quot;abo&quot;) {
+		if ($auteur_session) {
+			$statut = $auteur_session['statut'];
+			if (!$statut OR $statut == '5poubelle') {
+				ask_php_auth(_T('forum_acces_refuse'),
+					     _T('forum_cliquer_retour',
+						array('retour_forum' =&gt; $retour)));
+				exit;
+			}
+		} else {
+			ask_php_auth(_T('forum_non_inscrit'),
+				     _T('forum_cliquer_retour',
+					array('retour_forum' =&gt; $retour)));
+			exit;
+		}
+	}
+
+	return $forums_publics;
+}
+
+function mots_du_forum($ajouter_mot, $id_message)
+{
+	foreach ($ajouter_mot as $id_mot)
+		if ($id_mot = intval($id_mot))
+			spip_query(&quot;INSERT INTO spip_mots_forum (id_mot, id_forum)
+				VALUES ($id_mot, $id_message)&quot;);
+}
+
+function enregistre_forum() {
+	global $REMOTE_ADDR, $auteur_session,
+	  $afficher_texte, $ajouter_mot, $alea, $hash,
+	  $auteur, $confirmer_forum, $email_auteur,
+	  $id_article, $id_auteur, $id_breve, $id_forum, $id_rubrique, $id_syndic,
+	  $nom_site_forum, $retour_forum, $texte, $titre, $url_site;
+
+	$retour_forum = rawurldecode($retour_forum);
+	$id_article = intval($id_article);
+	$id_rubrique = intval($id_rubrique);
+	$id_forum = intval($id_forum);
+	$id_breve = intval($id_breve);
+	$id_syndic = intval($id_syndic);
+
+// initialisation de l'eventuel visiteur connecte
+	if (!$id_auteur)
+	$id_auteur = intval($auteur_session['id_auteur']);
+
+	$statut = controler_forum($id_article, $retour_forum);
+
+// Ne pas autoriser de changement de nom si forum sur abonnement
+
+	if ($statut == 'abo') {
+		$auteur = $auteur_session['nom'];
+		$email_auteur = $auteur_session['email'];
+	}
+
+// trop court ?
+	if ((strlen($texte) + strlen($titre) + strlen($nom_site_forum) + strlen($url_site) + strlen($auteur) + strlen($email_auteur)) &gt; 20 * 1024) {
+		ask_php_auth(_T('forum_message_trop_long'),
+			     _T('forum_cliquer_retour',
+				array('retour_forum' =&gt; $retour_forum)));
+		exit;
+	}
+
+	// Verifier hash securite
+	include_ecrire(&quot;inc_admin.php3&quot;);
+	if (!verifier_action_auteur(&quot;ajout_forum $id_rubrique&quot;.
+	&quot; $id_forum $id_article $id_breve&quot;.
+	&quot; $id_syndic $alea&quot;, $hash))
+		exit; 	# echec silencieux du POST
+
+	// verifier fichier lock
+	$alea = preg_replace('/[^0-9]/', '', $alea);
+	if (!file_exists($hash = _DIR_SESSIONS.&quot;forum_$alea.lck&quot;))
+		exit; # echec silencieux du POST
+	unlink($hash);
+
+	// Entrer le message dans la base
+	$id_message = spip_abstract_insert('spip_forum', '(date_heure)', '(NOW())');
+
+	if ($id_forum)
+		list($id_thread) = spip_fetch_array(spip_query(
+		&quot;SELECT id_thread FROM spip_forum WHERE id_forum = $id_forum&quot;));
+	else
+		$id_thread = $id_message; # id_thread oblige INSERT puis UPDATE.
+
+	$statut = ($statut == 'non') ? 'off' : (($statut == 'pri') ? 'prop' :
+						'publie');
+
+	spip_query(&quot;UPDATE spip_forum SET id_parent = $id_forum,
+	id_rubrique = $id_rubrique,
+	id_article = $id_article,
+	id_breve = $id_breve,
+	id_syndic = $id_syndic,
+	id_auteur = $id_auteur,
+	id_thread = $id_thread,
+	date_heure = NOW(),
+	titre = '&quot;.addslashes($titre).&quot;',
+	texte = '&quot;.addslashes($texte).&quot;',
+	nom_site = '&quot;.addslashes($nom_site_forum).&quot;',
+	url_site = '&quot;.addslashes($url_site).&quot;',
+	auteur = '&quot;.addslashes($auteur).&quot;',
+	email_auteur = '&quot;.addslashes($email_auteur).&quot;',
+	ip = '$REMOTE_ADDR',
+	statut = '$statut'
+	WHERE id_forum = $id_message
+	&quot;);
+
+	// calculer_threads();
+
+	// Entrer les mots-cles associes
+	if (is_array($ajouter_mot)) mots_du_forum($ajouter_mot, $id_message);
+
+	// Prevenir les auteurs de l'article
+	if (lire_meta(&quot;prevenir_auteurs&quot;) == &quot;oui&quot; AND ($afficher_texte != &quot;non&quot;))
+		prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);
+
+	// Poser un cookie pour ne pas retaper le nom / email
+
+	spip_setcookie('spip_forum_user',
+		       serialize(array('nom' =&gt; $auteur, 'email' =&gt; $email_auteur)));
+
+	if ($statut == 'publie') {
+	//
+	// INVALIDATION DES CACHES LIES AUX FORUMS
+	//
+		include_ecrire('inc_invalideur.php3');
+		suivre_invalideur (&quot;id='id_forum/&quot; .
+			calcul_index_forum($id_article,
+				$id_breve,
+				$id_rubrique,
+				$id_syndic) . &quot;'&quot;);
+	}
+
+	return $retour_forum;
+}
+
+?&gt;

Index: inc-public-global.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-public-global.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-public-global.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-public-global.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,256 +1,409 @@
-&lt;?php
-
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_PUBLIC_GLOBAL&quot;)) return;
-define(&quot;_INC_PUBLIC_GLOBAL&quot;, &quot;1&quot;);
-
-//
-// Aller chercher la page dans le cache ou pas
-//
-function obtenir_page ($contexte, $chemin_cache, $delais, &amp;$use_cache, $fond, $inclusion=false) {
-	global $lastmodified;
-
-	if (!$use_cache) {
-		include_local('inc-calcul.php3');
-
-		// page globale ? calculer le contexte
-		if (!$contexte)
-			$contexte = calculer_contexte();
-
-		spip_timer('calculer_page');
-		$page = calculer_page($chemin_cache,
-			array('fond' =&gt; $fond,
-				'contexte' =&gt; $contexte),
-			$delais,
-			$inclusion);
-
-		$lastmodified = time();
-
-		// log
-		if (!$log = $chemin_cache) $log = &quot;($fond, delais=$delais, &quot;
-		. $GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'].&quot;)&quot;;
-		spip_log (($inclusion ? 'calcul inclus':'calcul').' ('
-		.spip_timer('calculer_page').&quot;): $log&quot;);
-
-		// Nouveau cache : creer un invalideur 't' fixant la date
-		// d'expiration et la taille du fichier
-		if (@file_exists($chemin_cache)) {
-			// Ici on ajoute 3600s pour eviter toute concurrence
-			// entre un invalideur et un appel public de page
-			$bedtime = time() + $delais + 3600;
-			$taille = @filesize($chemin_cache);
-			$fichier = addslashes($chemin_cache);
-			spip_query(&quot;INSERT IGNORE INTO spip_caches (fichier,id,type,taille)
-			VALUES ('$fichier','$bedtime','t','$taille')&quot;);
-		}
-
-	} else {
-
-		//
-		// Lire le fichier cache
-		//
-		lire_fichier ($chemin_cache, $page['texte']);
-		$lastmodified = max($lastmodified, @filemtime($chemin_cache));
-		# spip_log (&quot;cache $chemin_cache $lastmodified&quot;);
-
-		//
-		// Lire sa carte d'identite &amp; fixer le contexte global
-		//
-		if (preg_match(&quot;/^&lt;!-- ([^\n]*) --&gt;\n(.*)/ms&quot;, $page['texte'], $match)
-		AND is_array($meta_donnees = unserialize($match[1]))) {
-			foreach ($meta_donnees as $var=&gt;$val)
-				$page[$var] = $val;
-
-			$page['texte'] = $match[2];
-
-			// Remplir les globals pour les boutons d'admin
-			if (!$inclusion AND is_array($page['contexte']))
-				foreach ($page['contexte'] as $var=&gt;$val)
-					$GLOBALS[$var] = $val;
-		}
-
-	}
-
-	return $page;
-}
-
-
-//
-// Appeler cette fonction pour obtenir la page principale
-//
-function afficher_page_globale ($fond, $delais, &amp;$use_cache) {
-	global $flag_preserver, $flag_dynamique, $lastmodified;
-	global $var_preview, $var_mode;
-	include_local (&quot;inc-cache.php3&quot;);
-
-	// demande de previsualisation ?
-	// -&gt; inc-calcul.php3 n'enregistrera pas les fichiers caches
-	// -&gt; inc-reqsql-squel.php3 acceptera les objets non 'publie'
-	if ($var_preview == 'oui') {
-		// Verifier qu'on a le droit de previsualisation
-		$statut = $GLOBALS['auteur_session']['statut'];
-		if ($statut=='0minirezo' OR
-		(lire_meta('preview')=='1comite' AND $statut=='1comite')) {
-			$var_mode = 'recalcul';
-			$delais = 0;
-			$var_preview = true;
-			spip_log('preview !');
-		}
-	}
-
-	// Faut-il effacer des pages invalidees ?
-	if (lire_meta('invalider')) {
-		include_ecrire('inc_meta.php3');
-		lire_metas();
-		if (lire_meta('invalider'))
-			retire_caches();
-	}
-
-	// Calculer le chemin putatif du cache
-	$chemin_cache = generer_nom_fichier_cache('', $fond);
-
-	// Peut-on utiliser un fichier cache ?
-	determiner_cache($delais, $use_cache, $chemin_cache);
-
-	// Repondre gentiment aux requetes sympas
-	// (ici on ne tient pas compte d'une obsolence du cache ou des
-	// eventuels fichiers inclus modifies depuis la date
-	// HTTP_IF_MODIFIED_SINCE du client)
-	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE'] AND !$var_mode
-	AND $chemin_cache AND !$flag_dynamique) {
-		$lastmodified = @filemtime($chemin_cache);
-		$headers_only = http_last_modified($lastmodified);
-	}
-	$headers_only |= ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] == 'HEAD');
-
-	if ($headers_only) {
-		if ($chemin_cache)
-			$t = @filemtime($chemin_cache);
-		else
-			$t = time();
-		@header('Last-Modified: '.http_gmoddate($t).' GMT');
-		@header('Connection: close');
-		// Pas de bouton admin pour un HEAD
-		$flag_preserver = true;
-	}
-	else {
-		// Obtenir la page
-		$page = obtenir_page ('', $chemin_cache, $delais, $use_cache,
-		$fond, false);
-		if (!$flag_preserver) {
-		// Entete content-type: xml ou html ; charset
-			if ($xhtml) {
-			// Si Mozilla et tidy actif, passer en &quot;application/xhtml+xml&quot;
-			// extremement risque: Mozilla passe en mode debugueur strict
-			// mais permet d'afficher du MathML directement dans le texte
-			// (et sauf erreur, c'est la bonne facon de declarer du xhtml)
-				include_ecrire(&quot;inc_tidy.php&quot;);
-				if (version_tidy() &gt; 0) {
-					if (ereg(&quot;application/xhtml\+xml&quot;, $GLOBALS['HTTP_ACCEPT'])) 
-						@header(&quot;Content-Type: application/xhtml+xml; charset=&quot;.lire_meta('charset'));
-					else 
-						@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-					echo '&lt;'.'?xml version=&quot;1.0&quot; encoding=&quot;'. lire_meta('charset').'&quot;?'.&quot;&gt;\n&quot;;
-				} else {
-					@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-				}
-			} else {
-				@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-			}
-		}
-	}
-
-	if ($chemin_cache) $page['cache'] = $chemin_cache;
-
-	if ($var_preview AND !$flag_preserver) {
-		$url = $GLOBALS['clean_link'];
-		$url-&gt;delvar('var_preview');
-		$url = $url-&gt;geturl();
-		include_ecrire('inc_lang.php3');
-		lang_select($GLOBALS['auteur_session']['lang']);
-		$page['texte'] .= '&lt;div style=&quot;
-		display: block;
-		color: #eeeeee;
-		background-color: #111111;
-		padding-right: 5px;
-		padding-top: 2px;
-		padding-bottom: 5px;
-		font-size: 20px;
-		top: 0px;
-		left: 0px;
-		position: absolute;
-		&quot;&gt;&lt;a href=&quot;'.$url.'&quot;&gt;&lt;img src=&quot;' . _DIR_IMG_PACK . 'naviguer-site.png&quot; align=&quot;left&quot; border=&quot;0&quot; /&gt;&lt;/a&gt;
-&nbsp; '.majuscules(_T('previsualisation')).'&lt;/div&gt;';
-	}
-
-	return $page;
-}
-
-
-function terminer_public_global() {
-
-	// Mise a jour des fichiers langues de l'espace public
-	if ($GLOBALS['cache_lang_modifs']) {
-		include_ecrire('inc_lang.php3');
-		ecrire_caches_langues();
-	}
-
-	// Gestion des statistiques du site public
-
-	if (lire_meta(&quot;activer_statistiques&quot;) != &quot;non&quot;) {
-		include_local (&quot;inc-stats.php3&quot;);
-		ecrire_stats();
-	}
-
-	// Effectuer une tache de fond ?
-	cron();
-}
-
-// Cette fonction sert au dernier ob_start() de inc-public : elle
-// va absorber les eventuels messages d'erreur de inc_cron(), permettant
-// de ne pas planter le content-length qu'on a annonce ; decommenter la ligne
-// pour afficher les bugs
-function masquer_les_bugs ($bugs) {
-	# return $bugs;
-}
-
-function inclure_page($fond, $delais_inclus, $contexte_inclus, $cache_incluant='') {
-
-	$contexte_inclus['fond'] = $fond;
-
-	$chemin_cache = generer_nom_fichier_cache($contexte_inclus, $fond);
-
-	// Peut-on utiliser un fichier cache ?
-	determiner_cache($delais_inclus, $use_cache, $chemin_cache);
-
-	// Si on a inclus sans fixer le critere de lang, de deux choses l'une :
-	// - on est dans la langue du site, et pas besoin d'inclure inc_lang
-	// - on n'y est pas, et alors il faut revenir dans la langue par defaut
-	if (($lang = $contexte_inclus['lang'])
-	|| ($GLOBALS['spip_lang'] != ($lang = lire_meta('langue_site')))) {
-		include_ecrire('inc_lang.php3');
-		lang_select($lang);
-		$lang_select = true; // pour lang_dselect en sortie
-	}
-
-	$page = obtenir_page ($contexte_inclus, $chemin_cache, $delais_inclus,
-	$use_cache, $fond, true);
-
-	$page['lang_select'] = $lang_select;
-
-	// Retourner le contenu...
-	return $page;
-}
-
-function inclure_balise_dynamique($r) {
-	if (is_string($r))
-		echo $r;
-	else {
-		list($fond, $delais, $contexte_inclus) = $r;
-		if ((!$contexte_inclus['lang']) AND
-		($GLOBALS['spip_lang'] != lire_meta('langue_site')))
-			$contexte_inclus['lang'] = $GLOBALS['spip_lang']; 
-		include('inc-public.php3');
-	}
-}
-?&gt;
+&lt;?php
+
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_PUBLIC_GLOBAL&quot;)) return;
+define(&quot;_INC_PUBLIC_GLOBAL&quot;, &quot;1&quot;);
+
+// fonction principale declenchant tout le service
+function calcule_header_et_page ($fond, $delais) {
+	  global $affiche_boutons_admin, $auteur_session, $flag_dynamique,
+	  $flag_ob, $flag_preserver, $forcer_lang, $ignore_auth_http,
+	  $lastmodified, $recherche, $use_cache, $val_confirm, $var_mode,
+	  $var_recherche, $tableau_des_erreurs;
+
+	// Regler le $delais par defaut
+	if (!isset($delais))
+		$delais = 1 * 3600;
+	if ($recherche)
+		$delais = 0;
+
+	// authentification du visiteur
+	if ($GLOBALS['_COOKIE']['spip_session'] OR
+	($GLOBALS['_SERVER']['PHP_AUTH_USER']  AND !$ignore_auth_http)) {
+		include_ecrire (&quot;inc_session.php3&quot;);
+		verifier_visiteur();
+	}
+	// multilinguisme
+	if ($forcer_lang AND ($forcer_lang!=='non') AND empty($GLOBALS['_POST'])) {
+		include_ecrire('inc_lang.php3');
+		verifier_lang_url();
+	}
+	if ($GLOBALS['_GET']['lang']) {
+		include_ecrire('inc_lang.php3');
+		lang_select($GLOBALS['_GET']['lang']);
+	}
+
+	// Si envoi pour un forum, enregistrer puis rediriger
+
+	if (strlen($GLOBALS['_POST']['confirmer_forum']) &gt; 0
+	OR ($GLOBALS['_POST']['afficher_texte']=='non'
+		AND $GLOBALS['_POST']['ajouter_mot'])) {
+		include('inc-messforum.php3');
+		redirige_par_entete(enregistre_forum());
+	}
+
+	// si signature de petition, l'enregistrer avant d'afficher la page
+	// afin que celle-ci contienne la signature
+
+	if ($GLOBALS['_GET']['val_confirm']) {
+		include_local(find_in_path('inc-formulaire_signature.php3'));
+		reponse_confirmation($GLOBALS['_GET']['id_article'], $val_confirm);
+	}
+
+	//  refus du debug si pas dans les options generales ni admin connecte
+	if ($var_mode=='debug') {
+		if (($GLOBALS['code_activation_debug'] == 'oui')
+		OR $auteur_session['statut'] == '0minirezo')
+			spip_log('debug !');
+		else
+			$var_mode = false; 
+	}
+
+	// est-on admin ?
+	if ($affiche_boutons_admin = (!$flag_preserver
+	AND ($GLOBALS['_COOKIE']['spip_admin']
+	OR $GLOBALS['_COOKIE']['spip_debug'])))
+		include_local(find_in_path('inc-formulaire_admin.php3'));
+
+	$tableau_des_erreurs = array();
+	$page = afficher_page_globale ($fond, $delais, $use_cache);
+
+
+	//
+	// Envoyer les entetes appropries
+	// a condition d'etre sur de pouvoir le faire
+	//
+	if (!$flag_preserver
+	AND $flag_ob AND !strlen(@ob_get_contents())) {
+
+		// Si la page est vide, gerer l'erreur 404
+		if (preg_match('/^[[:space:]]*$/', $page['texte'])
+		AND $var_mode != 'debug') {
+			header(&quot;HTTP/1.0 404&quot;);
+			header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+			$contexte_inclus = array(
+				'erreur_aucun' =&gt; message_erreur_404()
+			);
+			include(find_in_path('404.php3'));
+		}
+		// Interdire au client de cacher un login, un admin ou un recalcul
+		else if ($flag_dynamique OR $var_mode
+		OR $GLOBALS['_COOKIE']['spip_admin']) {
+			header(&quot;Cache-Control: no-cache,must-revalidate&quot;);
+			header(&quot;Pragma: no-cache&quot;);
+		}
+		// Pour les autres donner l'heure de modif
+		else if ($lastmodified) {
+			header(&quot;Last-Modified: &quot;.http_gmoddate($lastmodified).&quot; GMT&quot;);
+			header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+		}
+	}
+
+	return $page;
+}
+
+
+//
+// Aller chercher la page dans le cache ou pas
+//
+function obtenir_page ($contexte, $chemin_cache, $delais, &amp;$use_cache, $fond, $inclusion=false) {
+	global $lastmodified;
+
+	if (!$use_cache) {
+		include_local('inc-calcul.php3');
+
+		// page globale ? calculer le contexte
+		if (!$contexte)
+			$contexte = calculer_contexte();
+
+		spip_timer('calculer_page');
+		$page = calculer_page($chemin_cache,
+			array('fond' =&gt; $fond,
+				'contexte' =&gt; $contexte),
+			$delais,
+			$inclusion);
+
+		$lastmodified = time();
+
+		// log
+		if (!$log = $chemin_cache) $log = &quot;($fond, delais=$delais, &quot;
+		. $GLOBALS['_SERVER']['REQUEST_METHOD'].&quot;)&quot;;
+		spip_log (($inclusion ? 'calcul inclus':'calcul').' ('
+		.spip_timer('calculer_page').&quot;): $log&quot;);
+
+		// Nouveau cache : creer un invalideur 't' fixant la date
+		// d'expiration et la taille du fichier
+		if (@file_exists($chemin_cache)) {
+			// Ici on ajoute 3600s pour eviter toute concurrence
+			// entre un invalideur et un appel public de page
+			$bedtime = time() + $delais + 3600;
+			$taille = @filesize($chemin_cache);
+			$fichier = addslashes($chemin_cache);
+			spip_query(&quot;INSERT IGNORE INTO spip_caches (fichier,id,type,taille)
+			VALUES ('$fichier','$bedtime','t','$taille')&quot;);
+		}
+
+	} else {
+
+		//
+		// Lire le fichier cache
+		//
+		lire_fichier ($chemin_cache, $page['texte']);
+		$lastmodified = max($lastmodified, @filemtime($chemin_cache));
+		# spip_log (&quot;cache $chemin_cache $lastmodified&quot;);
+
+		//
+		// Lire sa carte d'identite &amp; fixer le contexte global
+		//
+		if (preg_match(&quot;/^&lt;!-- ([^\n]*) --&gt;\n(.*)/ms&quot;, $page['texte'], $match)
+		AND is_array($meta_donnees = unserialize($match[1]))) {
+			foreach ($meta_donnees as $var=&gt;$val)
+				$page[$var] = $val;
+
+			$page['texte'] = $match[2];
+
+			// Remplir les globals pour les boutons d'admin
+			if (!$inclusion AND is_array($page['contexte']))
+				foreach ($page['contexte'] as $var=&gt;$val)
+					$GLOBALS[$var] = $val;
+		}
+
+	}
+
+	return $page;
+}
+
+
+//
+// Appeler cette fonction pour obtenir la page principale
+//
+function afficher_page_globale ($fond, $delais, &amp;$use_cache) {
+	global $flag_preserver, $flag_dynamique, $lastmodified;
+	global $var_preview, $var_mode;
+	include_local (&quot;inc-cache.php3&quot;);
+
+	// demande de previsualisation ?
+	// -&gt; inc-calcul.php3 n'enregistrera pas les fichiers caches
+	// -&gt; inc-reqsql-squel.php3 acceptera les objets non 'publie'
+	if ($var_mode == 'preview') {
+		// Verifier qu'on a le droit de previsualisation
+		$statut = $GLOBALS['auteur_session']['statut'];
+		if ($statut=='0minirezo' OR
+		(lire_meta('preview')=='1comite' AND $statut=='1comite')) {
+			$var_mode = 'recalcul';
+			$delais = 0;
+			$var_preview = true;
+			spip_log('preview !');
+		} else
+			$var_preview = false;
+	}
+
+	// Faut-il effacer des pages invalidees ?
+	if (lire_meta('invalider')) {
+		include_ecrire('inc_meta.php3');
+		lire_metas();
+		if (lire_meta('invalider'))
+			retire_caches();
+	}
+
+	// Calculer le chemin putatif du cache
+	$chemin_cache = generer_nom_fichier_cache('', $fond);
+
+	// Peut-on utiliser un fichier cache ?
+	determiner_cache($delais, $use_cache, $chemin_cache);
+
+	// Repondre gentiment aux requetes sympas
+	// (ici on ne tient pas compte d'une obsolence du cache ou des
+	// eventuels fichiers inclus modifies depuis la date
+	// HTTP_IF_MODIFIED_SINCE du client)
+	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE'] AND !$var_mode
+	AND $chemin_cache AND !$flag_dynamique) {
+		$lastmodified = @filemtime($chemin_cache);
+		$headers_only = http_last_modified($lastmodified);
+	}
+	$headers_only |= ($GLOBALS['_SERVER']['REQUEST_METHOD'] == 'HEAD');
+
+	if ($headers_only) {
+		if ($chemin_cache)
+			$t = @filemtime($chemin_cache);
+		else
+			$t = time();
+		@header('Last-Modified: '.http_gmoddate($t).' GMT');
+		@header('Connection: close');
+		// Pas de bouton admin pour un HEAD
+		$flag_preserver = true;
+	}
+	else {
+		// Obtenir la page
+		$page = obtenir_page ('', $chemin_cache, $delais, $use_cache,
+		$fond, false);
+
+		if (!$flag_preserver) {
+		// Entete content-type: xml ou html ; charset
+			if ($xhtml) {
+			// Si Mozilla et tidy actif, passer en &quot;application/xhtml+xml&quot;
+			// extremement risque: Mozilla passe en mode debugueur strict
+			// mais permet d'afficher du MathML directement dans le texte
+			// (et sauf erreur, c'est la bonne facon de declarer du xhtml)
+				include_ecrire(&quot;inc_tidy.php&quot;);
+				if (version_tidy() &gt; 0) {
+					if (ereg(&quot;application/xhtml\+xml&quot;, $GLOBALS['HTTP_ACCEPT'])) 
+						@header(&quot;Content-Type: application/xhtml+xml; charset=&quot;.lire_meta('charset'));
+					else 
+						@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+					echo '&lt;'.'?xml version=&quot;1.0&quot; encoding=&quot;'. lire_meta('charset').'&quot;?'.&quot;&gt;\n&quot;;
+				} else {
+					@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+				}
+			} else {
+				@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
+			}
+		}
+	}
+
+	if ($chemin_cache) $page['cache'] = $chemin_cache;
+
+	if ($var_preview AND !$flag_preserver) {
+		include_ecrire('inc_lang.php3');
+		include_ecrire('inc_filtres.php3');
+		lang_select($GLOBALS['auteur_session']['lang']);
+		$page['texte'] .= '&lt;div style=&quot;
+		display: block;
+		color: #eeeeee;
+		background-color: #111111;
+		padding-right: 5px;
+		padding-top: 2px;
+		padding-bottom: 5px;
+		font-size: 20px;
+		top: 0px;
+		left: 0px;
+		position: absolute;
+		&quot;&gt;&lt;img src=&quot;' . _DIR_IMG_PACK
+		. 'naviguer-site.png&quot; align=&quot;left&quot; border=&quot;0&quot; /&gt;&nbsp; '
+		. majuscules(_T('previsualisation')).'&lt;/div&gt;';
+	}
+
+	return $page;
+}
+
+
+function terminer_public_global() {
+
+	// Gestion des statistiques du site public
+	if (lire_meta(&quot;activer_statistiques&quot;) != &quot;non&quot;) {
+		include_local (&quot;inc-stats.php3&quot;);
+		ecrire_stats();
+	}
+
+	// Effectuer une tache de fond ?
+	cron();
+}
+
+
+function inclure_page($fond, $delais_inclus, $contexte_inclus, $cache_incluant='') {
+
+	$contexte_inclus['fond'] = $fond;
+
+	$chemin_cache = generer_nom_fichier_cache($contexte_inclus, $fond);
+
+	// Peut-on utiliser un fichier cache ?
+	determiner_cache($delais_inclus, $use_cache, $chemin_cache);
+
+	// Si on a inclus sans fixer le critere de lang, de deux choses l'une :
+	// - on est dans la langue du site, et pas besoin d'inclure inc_lang
+	// - on n'y est pas, et alors il faut revenir dans la langue par defaut
+	if (($lang = $contexte_inclus['lang'])
+	|| ($GLOBALS['spip_lang'] != ($lang = lire_meta('langue_site')))) {
+		include_ecrire('inc_lang.php3');
+		lang_select($lang);
+		$lang_select = true; // pour lang_dselect en sortie
+	}
+	
+	// Si on est inclus en POST, il faut ajouter les variables _POST dans
+	// le contexte inclus, sinon les formulaires ne marchent pas...
+	if ($_SERVER['REQUEST_METHOD'] == 'POST') {
+		include_local('inc-calcul.php3');
+		$contexte_inclus = array_merge(calculer_contexte(), $contexte_inclus);
+	}
+
+	$page = obtenir_page ($contexte_inclus, $chemin_cache, $delais_inclus,
+	$use_cache, $fond, true);
+
+	$page['lang_select'] = $lang_select;
+
+	// Retourner le contenu...
+	return $page;
+}
+
+// equivalente a texte_script dans inc_filtre.
+
+function securise_script($texte) {
+	return str_replace('\'', '\\\'', str_replace('\\', '\\\\', $texte));
+}
+
+# les balises dynamiques sont traitees comme des inclusions
+
+function synthetiser_balise_dynamique($nom, $args, $file, $lang) {
+	return
+		('&lt;'.'?php 
+include_ecrire(\'inc_lang.php3\');
+lang_select(&quot;'.$lang.'&quot;);
+include_local(&quot;'
+		. $file
+		. '&quot;);
+inclure_balise_dynamique(balise_'
+		. $nom
+		. '_dyn(\''
+		. join(&quot;', '&quot;, array_map(&quot;securise_script&quot;, $args))
+		. '\'));
+	lang_dselect();
+?'
+		.&quot;&gt;&quot;);
+}
+
+# Attention, un appel explicite a cette fonction suppose certains include
+# (voir l'exemple de spip_inscription et spip_pass)
+
+function inclure_balise_dynamique($r) {
+	if (is_string($r))
+		echo $r;
+	else {
+		list($fond, $delais, $contexte_inclus) = $r;
+
+		if ((!$contexte_inclus['lang']) AND
+		($GLOBALS['spip_lang'] != lire_meta('langue_site')))
+			$contexte_inclus['lang'] = $GLOBALS['spip_lang'];
+
+
+		// Appeler la page
+		$page = inclure_page($fond, $delais, $contexte_inclus);
+		if ($page['process_ins'] == 'html')
+			echo $page['texte'];
+		else
+			eval('?' . '&gt;' . $page['texte']);
+
+		if ($page['lang_select'])
+			lang_dselect();
+
+	}
+}
+
+
+function message_erreur_404 () {
+	if ($GLOBALS['id_article'])
+		$erreur = 'aucun_article';
+	else if ($GLOBALS['id_rubrique'])
+		$erreur = 'aucune_rubrique';
+	else if ($GLOBALS['id_breve'])
+		$erreur = 'aucune_breve';
+	else if ($GLOBALS['id_auteur'])
+		$erreur = 'aucun_auteur';
+	else if ($GLOBALS['id_syndic'])
+		$erreur = 'aucun_site';
+	else
+		$erreur = '';
+
+	return _T(&quot;public:&quot;.$erreur);
+}
+
+?&gt;

Index: inc-public.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-public.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-public.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-public.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,162 +1,87 @@
-&lt;?php
-
-// Page inclue ?
-if (defined(&quot;_INC_PUBLIC&quot;)) {
-	$page = inclure_page($fond, $delais, $contexte_inclus, $fichier_inclus);
-
-	if ($page['process_ins'] == 'html')
-		echo $page['texte'];
-	else
-		eval('?' . '&gt;' . $page['texte']);
-
-	if ($page['lang_select'])
-		lang_dselect();
-}
-// Premier appel inc-public
-else {
-	define(&quot;_INC_PUBLIC&quot;, &quot;1&quot;);
-	include (&quot;ecrire/inc_version.php3&quot;);
-
-	//
-	// Initialisations
-	//
-
-	// Regler le $delais par defaut
-	if ($INSECURE['fond'] || $INSECURE['delais'])
-		exit;
-	if (!isset($delais))
-		$delais = 1 * 3600;
-	if ($recherche)
-		$delais = 0;
-
-	// authentification du visiteur
-	if ($HTTP_COOKIE_VARS['spip_session'] OR
-	($PHP_AUTH_USER AND !$ignore_auth_http)) {
-		include_ecrire (&quot;inc_session.php3&quot;);
-		verifier_visiteur();
-	}
-	// multilinguisme
-	if ($forcer_lang AND ($forcer_lang!=='non') AND empty($HTTP_POST_VARS)) {
-		include_ecrire('inc_lang.php3');
-		verifier_lang_url();
-	}
-	if ($HTTP_GET_VARS['lang']) {
-		include_ecrire('inc_lang.php3');
-		lang_select($HTTP_GET_VARS['lang']);
-	}
-	// Ajout_forum (pour les forums) et $val_confirm signalent des modifications
-	// a faire avant d'afficher la page
-	if ($ajout_forum) {
-		$redirect = '';
-		include('inc-messforum.php3');
-		if ($redirect) redirige_par_entete($redirect);
-	}
-	if ($val_confirm) {
-		include_local('inc-formulaire_signature.php3');
-		reponse_confirmation($id_article, $val_confirm);
-	}
-
-	include_local ('inc-public-global.php3');
-
-	//  refus du debug si pas dans les options generales ni admin connecte
-	if ($var_mode=='debug') {
-		if (($code_activation_debug == 'oui')
-		OR $auteur_session['statut'] == '0minirezo')
-			spip_log('debug !');
-		else
-			$var_mode = false; 
-	}
-
-	// est-on admin ?
-	if ($affiche_boutons_admin = (!$flag_preserver
-	AND ($HTTP_COOKIE_VARS['spip_admin']
-	OR $HTTP_COOKIE_VARS['spip_debug'])))
-		include_local('inc-formulaire_admin.php3');
-
-	$tableau_des_erreurs = array();
-	$page = afficher_page_globale ($fond, $delais, $use_cache);
-
-	if (!$flag_preserver) {
-	// Interdire au client de cacher un login, un admin ou un recalcul
-		if ($flag_dynamique OR $var_mode
-		OR $HTTP_COOKIE_VARS['spip_admin']) {
-			@header(&quot;Cache-Control: no-cache,must-revalidate&quot;);
-			@header(&quot;Pragma: no-cache&quot;);
-	// Pour les autres donner l'heure de modif
-		} else if ($lastmodified)
-			@Header (&quot;Last-Modified: &quot;.http_gmoddate($lastmodified).&quot; GMT&quot;);
-
-	// si le squelette est nul se rabattre sur l'entete standard
-		if ($page['texte']) 
-			@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
-		else
-			echo debut_entete($fond);
-	}
-	define('spip_active_ob', $flag_ob AND
-		($var_mode == 'debug' OR $var_recherche OR $affiche_boutons_admin));
-
-	// Cas d'une page contenant uniquement du HTML :
-	if ($page['process_ins'] == 'html') {
-		if (!spip_active_ob) {
-			echo $page['texte'];
-			$contenu = '';
-		} else
-			$contenu = $page['texte'];
-	}
-
-	// Cas d'une page contenant du PHP :
-	else {
-		// Evaluer la page
-		if (!spip_active_ob) {
-			eval('?' . '&gt;' . $page['texte']);
-			$contenu = '';
-		} else {
-			ob_start(); 
-			$res = eval('?' . '&gt;' . $page['texte']);
-			$contenu = ob_get_contents(); 
-			ob_end_clean();
-
-			// en cas d'erreur lors du eval, afficher un message
-			// et forcer les boutons de debug
-			if ($res === false AND $affiche_boutons_admin
-			AND $auteur_session['statut'] == '0minirezo') {
-				include_ecrire('inc_debug_sql.php3');
-				erreur_squelette(_L('erreur d\'execution de la page'));
-			}
-		}
-	}
-
-	// Passer la main au debuggueur le cas echeant 
-	if ($var_mode == 'debug') {
-		include_ecrire(&quot;inc_debug_sql.php3&quot;);
-		debug_dumpfile('',$var_mode_objet,$var_mode_affiche);
-		exit;
-	} else if (count($tableau_des_erreurs) &gt; 0
-	AND $affiche_boutons_admin)
-		affiche_erreurs_page ($tableau_des_erreurs);
-
-	// Traiter var_recherche pour surligner les mots
-	if ($var_recherche) {
-		include_ecrire(&quot;inc_surligne.php3&quot;);
-		$contenu = surligner_mots($contenu, $var_recherche);
-	}
-
-	// Ajouter au besoin la CSS des boutons admins
-	if ($affiche_boutons_admin) {
-		include_local(&quot;inc-admin.php3&quot;);
-		$contenu = perso_admin($contenu);
-	}
-
-	// Afficher le resultat final
-	echo $contenu;
-
-	// Ajouter les boutons admins (les normaux) si absents
-	// (ce sera apres la balise /html mais tant pis)
-	if ($affiche_boutons_admin)
-		inclure_balise_dynamique(balise_formulaire_admin_dyn($id_article, $id_breve, $id_rubrique, $id_mot, $id_auteur));
-
-	// Taches de fin
-	terminer_public_global();
- }
-
-?&gt;
+&lt;?php
+
+// Distinguer une inclusion d'un appel initial
+if (defined(&quot;_INC_PUBLIC&quot;)) {
+	$page = inclure_page($fond, $delais, $contexte_inclus);
+	if ($page['process_ins'] == 'html')
+		echo $page['texte'];
+	else
+		eval('?' . '&gt;' . $page['texte']);
+
+	if ($page['lang_select'])
+		lang_dselect();
+
+} else {
+	define (&quot;_INC_PUBLIC&quot;, 1);
+	include (&quot;ecrire/inc_version.php3&quot;);
+	include_local('inc-public-global.php3');
+
+	// Calculer la page sans evaluer le php qu'elle contient
+	$page = calcule_header_et_page ($fond, $delais);
+
+	// Execution de la page calculee
+
+	// 1. Cas d'une page contenant uniquement du HTML :
+	if ($page['process_ins'] == 'html') {
+		$page = $page['texte'];
+	}
+
+	// 2. Cas d'une page contenant du PHP :
+	// Attention cette partie eval() doit imperativement
+	// etre declenchee dans l'espace des globales (donc pas
+	// dans une fonction).
+	else {
+	
+		// Une page &quot;normale&quot; va s'afficher ici
+		if (!($flag_ob AND ($var_mode == 'debug'
+		OR $var_recherche OR $affiche_boutons_admin))) {
+			eval('?' . '&gt;' . $page['texte']);
+			$page = '';
+		}
+
+		// Certains cas demandent un ob_start() de plus
+		else {
+			ob_start(); 
+			$res = eval('?' . '&gt;' . $page['texte']);
+			$page = ob_get_contents(); 
+			ob_end_clean();
+
+			// en cas d'erreur lors du eval,
+			// la memoriser dans le tableau des erreurs
+			// On ne revient pas ici si le nb d'erreurs &gt; 4
+			if ($res === false AND $affiche_boutons_admin
+			AND $auteur_session['statut'] == '0minirezo') {
+				include_ecrire('inc_debug_sql.php3');
+				erreur_squelette(_T('zbug_erreur_execution_page'));
+			}
+		}
+	}
+
+	// Passer la main au debuggueur le cas echeant 
+	if ($var_mode == 'debug') {
+		include_ecrire(&quot;inc_debug_sql.php3&quot;);
+		debug_dumpfile('',$var_mode_objet,$var_mode_affiche);
+	} 
+	if (count($tableau_des_erreurs) &gt; 0 AND $affiche_boutons_admin)
+	  $page = affiche_erreurs_page($tableau_des_erreurs) . $page;
+
+	// Traiter var_recherche pour surligner les mots
+	if ($var_recherche) {
+		include_ecrire(&quot;inc_surligne.php3&quot;);
+		$page = surligner_mots($page, $var_recherche);
+	}
+
+	// Inserer au besoin les boutons admins
+	if ($affiche_boutons_admin) {
+		include_local(&quot;inc-admin.php3&quot;);
+		$page = affiche_boutons_admin($page);
+	}
+
+	// Affichage final s'il en reste
+	echo $page;
+
+	// Taches de fond ?
+	terminer_public_global();
+}
+
+?&gt;

Index: inc-stats.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-stats.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-stats.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-stats.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,73 +1,73 @@
-&lt;?php
-
-//
-// Ce fichier ne sera execute qu'une fois
-if (defined(&quot;_INC_STATS&quot;)) return;
-define(&quot;_INC_STATS&quot;, &quot;1&quot;);
-
-function ecrire_stats() {
-	global $id_article, $id_breve, $id_rubrique;
-
-	if ($GLOBALS['HTTP_X_FORWARDED_FOR'])
-		$log_ip = $GLOBALS['HTTP_X_FORWARDED_FOR'];
-	else
-		$log_ip = $GLOBALS['REMOTE_ADDR'];
-
-	if ($log_id_num = intval($id_rubrique))
-		$log_type = &quot;rubrique&quot;;
-	else if ($log_id_num = intval($id_article))
-		$log_type = &quot;article&quot;;
-	else if ($log_id_num = intval($id_breve))
-		$log_type = &quot;breve&quot;;
-	else
-		$log_type = &quot;autre&quot;;
-
-	// Conversion IP 4 octets -&gt; entier 32 bits
-	if (ereg(&quot;^(::ffff:)?([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$&quot;, $log_ip, $r)) {
-		$log_ip = sprintf(&quot;0x%02x%02x%02x%02x&quot;, $r[2], $r[3], $r[4], $r[5]);
-	}
-	else return;
-
-	//
-	// Loguer la visite dans la base si possible
-	//
-	if ($log_type != &quot;autre&quot;) {
-		$query = &quot;INSERT IGNORE INTO spip_visites_temp (ip, type, id_objet) &quot;.
-			&quot;VALUES ($log_ip, '$log_type', $log_id_num)&quot;;
-		spip_query($query);
-	}
-
-	//
-	// Loguer le referer
-	//
-	$url_site_spip = lire_meta('adresse_site');
-	$url_site_spip = eregi_replace(&quot;^((https?|ftp)://)?(www\.)?&quot;, &quot;&quot;, $url_site_spip);
-	$log_referer = $GLOBALS['HTTP_REFERER'];
-	if (($url_site_spip&lt;&gt;'') AND strpos('-'.strtolower($log_referer), strtolower($url_site_spip)) AND !$GLOBALS['var_recherche']) $log_referer = &quot;&quot;;
-	if ($log_referer) {
-		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
-		$query = &quot;INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) &quot;.
-			&quot;VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)&quot;;
-		spip_query($query);
-	}
-}
-
-
-function afficher_raccourci_stats($id_article) {
-	$query = &quot;SELECT visites, popularite FROM spip_articles WHERE id_article=$id_article AND statut='publie'&quot;;
-	$result = spip_query($query);
-	if ($row = @spip_fetch_array($result)) {
-		$visites = intval($row['visites']);
-		$popularite = ceil($row['popularite']);
-
-		$query = &quot;SELECT COUNT(DISTINCT ip) AS c FROM spip_visites_temp WHERE type='article' AND id_objet=$id_article&quot;;
-		$result = spip_query($query);
-		if ($row = @spip_fetch_array($result)) {
-			$visites = $visites + $row['c'];
-		}
-
-		return array('visites' =&gt; $visites, 'popularite' =&gt; $popularite);
-	}
-}
-
-?&gt;
+&lt;?php
+
+//
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_INC_STATS&quot;)) return;
+define(&quot;_INC_STATS&quot;, &quot;1&quot;);
+
+function ecrire_stats() {
+	global $id_article, $id_breve, $id_rubrique;
+
+	if ($GLOBALS['HTTP_X_FORWARDED_FOR'])
+		$log_ip = $GLOBALS['HTTP_X_FORWARDED_FOR'];
+	else
+		$log_ip = $GLOBALS['REMOTE_ADDR'];
+
+	if ($log_id_num = intval($id_rubrique))
+		$log_type = &quot;rubrique&quot;;
+	else if ($log_id_num = intval($id_article))
+		$log_type = &quot;article&quot;;
+	else if ($log_id_num = intval($id_breve))
+		$log_type = &quot;breve&quot;;
+	else
+		$log_type = &quot;autre&quot;;
+
+	// Conversion IP 4 octets -&gt; entier 32 bits
+	if (ereg(&quot;^(::ffff:)?([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$&quot;, $log_ip, $r)) {
+		$log_ip = sprintf(&quot;0x%02x%02x%02x%02x&quot;, $r[2], $r[3], $r[4], $r[5]);
+	}
+	else return;
+
+	//
+	// Loguer la visite dans la base si possible
+	//
+	if ($log_type != &quot;autre&quot;) {
+		$query = &quot;INSERT IGNORE INTO spip_visites_temp (ip, type, id_objet) &quot;.
+			&quot;VALUES ($log_ip, '$log_type', $log_id_num)&quot;;
+		spip_query($query);
+	}
+
+	//
+	// Loguer le referer
+	//
+	$url_site_spip = lire_meta('adresse_site');
+	$url_site_spip = eregi_replace(&quot;^((https?|ftp)://)?(www\.)?&quot;, &quot;&quot;, $url_site_spip);
+	$log_referer = $GLOBALS['HTTP_REFERER'];
+	if (($url_site_spip&lt;&gt;'') AND strpos('-'.strtolower($log_referer), strtolower($url_site_spip)) AND !$GLOBALS['var_recherche']) $log_referer = &quot;&quot;;
+	if ($log_referer) {
+		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
+		$query = &quot;INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) &quot;.
+			&quot;VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)&quot;;
+		spip_query($query);
+	}
+}
+
+
+function afficher_raccourci_stats($id_article) {
+	$query = &quot;SELECT visites, popularite FROM spip_articles WHERE id_article=$id_article AND statut='publie'&quot;;
+	$result = spip_query($query);
+	if ($row = @spip_fetch_array($result)) {
+		$visites = intval($row['visites']);
+		$popularite = ceil($row['popularite']);
+
+		$query = &quot;SELECT COUNT(DISTINCT ip) AS c FROM spip_visites_temp WHERE type='article' AND id_objet=$id_article&quot;;
+		$result = spip_query($query);
+		if ($row = @spip_fetch_array($result)) {
+			$visites = $visites + $row['c'];
+		}
+
+		return array('visites' =&gt; $visites, 'popularite' =&gt; $popularite);
+	}
+}
+
+?&gt;

Index: inc-urls-html.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-urls-html.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-urls-html.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-urls-html.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,83 +1,83 @@
-&lt;?php
-
-// executer une seule fois
-if (defined(&quot;_INC_URLS2&quot;)) return;
-define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
-
-function generer_url_article($id_article) {
-	return &quot;article$id_article.html&quot;;
-}
-
-function generer_url_rubrique($id_rubrique) {
-	return &quot;rubrique$id_rubrique.html&quot;;
-}
-
-function generer_url_breve($id_breve) {
-	return &quot;breve$id_breve.html&quot;;
-}
-
-function generer_url_mot($id_mot) {
-	return &quot;mot$id_mot.html&quot;;
-}
-
-function generer_url_auteur($id_auteur) {
-	return &quot;auteur$id_auteur.html&quot;;
-}
-
-function generer_url_document($id_document) {
-	if (intval($id_document) &lt;= 0)
-		return '';
-	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
-		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
-	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
-		return ($row['fichier']);
-	return '';
-}
-
-function recuperer_parametres_url($fond, $url) {
-	global $contexte;
-	return;
-}
-
-
-//
-// URLs des forums
-//
-
-// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
-function racine_forum($id_forum){
-	if (!$id_forum = intval($id_forum)) return;
-	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
-	$result = spip_query($query);
-	if($row = spip_fetch_array($result)){
-		if($row['id_parent']) {
-			return racine_forum($row['id_parent']);
-		}
-		else {
-			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
- 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
-			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
-		}
-	}
-} 
-
-function generer_url_forum($id_forum, $show_thread=false) {
-	list($type, $id, $id_thread) = racine_forum($id_forum);
-	if ($id_thread&gt;0 AND $show_thread)
-		$id_forum = $id_thread;
-	switch($type) {
-		case 'article':
-			return generer_url_article($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'breve':
-			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'rubrique':
-			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
-			break;
-		default:
-			return &quot;forum$id_forum.html&quot;;
-	}
-}
-
-?&gt;
+&lt;?php
+
+// executer une seule fois
+if (defined(&quot;_INC_URLS2&quot;)) return;
+define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
+
+function generer_url_article($id_article) {
+	return &quot;article$id_article.html&quot;;
+}
+
+function generer_url_rubrique($id_rubrique) {
+	return &quot;rubrique$id_rubrique.html&quot;;
+}
+
+function generer_url_breve($id_breve) {
+	return &quot;breve$id_breve.html&quot;;
+}
+
+function generer_url_mot($id_mot) {
+	return &quot;mot$id_mot.html&quot;;
+}
+
+function generer_url_auteur($id_auteur) {
+	return &quot;auteur$id_auteur.html&quot;;
+}
+
+function generer_url_document($id_document) {
+	if (intval($id_document) &lt;= 0)
+		return '';
+	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
+		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
+	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
+		return ($row['fichier']);
+	return '';
+}
+
+function recuperer_parametres_url($fond, $url) {
+	global $contexte;
+	return;
+}
+
+
+//
+// URLs des forums
+//
+
+// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
+function racine_forum($id_forum){
+	if (!$id_forum = intval($id_forum)) return;
+	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
+	$result = spip_query($query);
+	if($row = spip_fetch_array($result)){
+		if($row['id_parent']) {
+			return racine_forum($row['id_parent']);
+		}
+		else {
+			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
+ 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
+			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
+		}
+	}
+} 
+
+function generer_url_forum($id_forum, $show_thread=false) {
+	list($type, $id, $id_thread) = racine_forum($id_forum);
+	if ($id_thread&gt;0 AND $show_thread)
+		$id_forum = $id_thread;
+	switch($type) {
+		case 'article':
+			return generer_url_article($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'breve':
+			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'rubrique':
+			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
+			break;
+		default:
+			return &quot;forum$id_forum.html&quot;;
+	}
+}
+
+?&gt;

Index: inc-urls-propres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-urls-propres.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-urls-propres.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-urls-propres.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,167 +1,172 @@
-&lt;?php
-
-// executer une seule fois
-if (defined(&quot;_INC_URLS2&quot;)) return;
-define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
-
-
-/*
-
-- Comment utiliser ce jeu d'URLs ?
-
-Il faut recopier le fichier htaccess-propre.txt sous le nom .htaccess
-dans le repertoire de base du site SPIP (attention a ne pas ecraser
-d'autres reglages que vous pourriez avoir mis dans ce fichier)
-
-*/
-
-
-function _generer_url_propre($type, $id_objet) {
-	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
-	$col_id = &quot;id_&quot;.$type;
-
-	// D'abord, essayer de recuperer l'URL existante si possible
-	$query = &quot;SELECT url_propre, titre FROM $table WHERE $col_id=$id_objet&quot;;
-	$result = spip_query($query);
-	if (!($row = spip_fetch_array($result))) return &quot;&quot;;
-	if ($row['url_propre']) return $row['url_propre'];
-
-	// Sinon, creer l'URL
-	include_ecrire(&quot;inc_filtres.php3&quot;);
-	include_ecrire(&quot;inc_charsets.php3&quot;);
-	$url = translitteration(corriger_caracteres(supprimer_tags(supprimer_numero($row['titre']))));
-	$url = @preg_replace(',[[:punct:][:space:]]+,u', ' ', $url);
-	// S'il reste des caracteres non latins, utiliser l'id a la place
-	if (preg_match(&quot;,[^a-zA-Z0-9 ],&quot;, $url)) {
-		$url = $type.$id_objet;
-	}
-	else {
-		$mots = explode(' ', $url);
-		$url = '';
-		foreach ($mots as $mot) {
-			if (!$mot) continue;
-			$url2 = $url.'-'.$mot;
-			if (strlen($url2) &gt; 35) {
-				break;
-			}
-			$url = $url2;
-		}
-		$url = substr($url, 1);
-		//echo &quot;$url&lt;br&gt;&quot;;
-		if (strlen($url) &lt; 2) $url = $type.$id_objet;
-	}
-
-	// Verifier les eventuels doublons et mettre a jour
-	$lock = &quot;url $type $id_objet&quot;;
-	spip_get_lock($lock, 10);
-	$query = &quot;SELECT $col_id FROM $table WHERE url_propre='&quot;.addslashes($url).&quot;'&quot;;
-	if (spip_num_rows(spip_query($query)) &gt; 0) {
-		$url = $url.','.$id_objet;
-	}
-	$query = &quot;UPDATE $table SET url_propre='&quot;.addslashes($url).&quot;' WHERE $col_id=$id_objet&quot;;
-	spip_query($query);
-	spip_release_lock($lock);
-
-	return $url;
-}
-
-function generer_url_article($id_article) {
-	$url = _generer_url_propre('article', $id_article);
-	if (!$url) $url = &quot;article.php3?id_article=$id_article&quot;;
-	return $url;
-}
-
-function generer_url_rubrique($id_rubrique) {
-	$url = _generer_url_propre('rubrique', $id_rubrique);
-	if (!$url) $url = &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
-	else $url = '-'.$url.'-';
-	return $url;
-}
-
-function generer_url_breve($id_breve) {
-	$url = _generer_url_propre('breve', $id_breve);
-	if (!$url) $url = &quot;breve.php3?id_breve=$id_breve&quot;;
-	else $url = '+'.$url.'+';
-	return $url;
-}
-
-function generer_url_forum($id_forum) {
-	return &quot;forum.php3?id_forum=$id_forum&quot;;
-}
-
-function generer_url_mot($id_mot) {
-	$url = _generer_url_propre('mot', $id_mot);
-	if (!$url) $url = &quot;mot.php3?id_mot=$id_mot&quot;;
-	else $url = '+-'.$url.'-+';
-	return $url;
-}
-
-function generer_url_auteur($id_auteur) {
-	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
-}
-
-function generer_url_document($id_document) {
-	if (intval($id_document) &lt;= 0)
-		return '';
-	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
-		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
-	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
-		return ($row['fichier']);
-	return '';
-}
-
-function recuperer_parametres_url($fond, $url) {
-	global $contexte;
-
-	// Migration depuis anciennes URLs ?
-	if ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] != 'POST' &amp;&amp;
-		preg_match(',(^|/)(article|breve|rubrique|mot)\.php3?([\?&amp;].*)?$,', $url, $regs)) {
-		$type = $regs[2];
-		$id_objet = intval($GLOBALS['id_'.$type]);
-		if ($id_objet) {
-			$func = &quot;generer_url_$type&quot;;
-			$url_propre = $func($id_objet);
-			if ($url_propre) {
-				http_status(301);
-				Header(&quot;Location: $url_propre&quot;);
-				exit;
-			}
-		}
-		return;
-	}
-
-	$url_propre = $GLOBALS['HTTP_SERVER_VARS']['REDIRECT_url_propre'];
-	if (!$url_propre) $url_propre = $GLOBALS['HTTP_ENV_VARS']['url_propre'];
-	if (!$url_propre) $url_propre = substr($url, strrpos($url, '/') + 1);
-	if (!$url_propre) return;
-
-	// Detecter les differents types d'objets demandes
-	if (preg_match(',^\+-(.*)-\+$,', $url_propre, $regs)) {
-		$type = 'mot';
-		$url_propre = $regs[1];
-	}
-	else if (preg_match(',^-(.*)-$,', $url_propre, $regs)) {
-		$type = 'rubrique';
-		$url_propre = $regs[1];
-	}
-	else if (preg_match(',^\+(.*)\+$,', $url_propre, $regs)) {
-		$type = 'breve';
-		$url_propre = $regs[1];
-	}
-	else {
-		$type = 'article';
-	}
-
-	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
-	$col_id = &quot;id_&quot;.$type;
-	$query = &quot;SELECT $col_id FROM $table WHERE url_propre='&quot;.addslashes($url_propre).&quot;'&quot;;
-	$result = spip_query($query);
-	if (spip_num_rows($result) == 1) {
-		$row = spip_fetch_array($result);
-		$contexte[$col_id] = $row[$col_id];
-	}
-
-	return;
-}
-
+&lt;?php
+
+// executer une seule fois
+if (defined(&quot;_INC_URLS2&quot;)) return;
+define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
+
+
+/*
+
+- Comment utiliser ce jeu d'URLs ?
+
+Il faut recopier le fichier htaccess-propres.txt sous le nom .htaccess
+dans le repertoire de base du site SPIP (attention a ne pas ecraser
+d'autres reglages que vous pourriez avoir mis dans ce fichier)
+
+*/
+
+
+function _generer_url_propre($type, $id_objet) {
+	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
+	$col_id = &quot;id_&quot;.$type;
+
+	// D'abord, essayer de recuperer l'URL existante si possible
+	$query = &quot;SELECT url_propre, titre FROM $table WHERE $col_id=$id_objet&quot;;
+	$result = spip_query($query);
+	if (!($row = spip_fetch_array($result))) return &quot;&quot;;
+	if ($row['url_propre']) return $row['url_propre'];
+
+	// Sinon, creer l'URL
+	include_ecrire(&quot;inc_filtres.php3&quot;);
+	include_ecrire(&quot;inc_charsets.php3&quot;);
+	$url = translitteration(corriger_caracteres(
+		supprimer_tags(supprimer_numero(extraire_multi($row['titre'])))
+		));
+	$url = @preg_replace(',[[:punct:][:space:]]+,u', ' ', $url);
+	// S'il reste des caracteres non latins, utiliser l'id a la place
+	if (preg_match(&quot;,[^a-zA-Z0-9 ],&quot;, $url)) {
+		$url = $type.$id_objet;
+	}
+	else {
+		$mots = explode(' ', $url);
+		$url = '';
+		foreach ($mots as $mot) {
+			if (!$mot) continue;
+			$url2 = $url.'-'.$mot;
+			if (strlen($url2) &gt; 35) {
+				break;
+			}
+			$url = $url2;
+		}
+		$url = substr($url, 1);
+		//echo &quot;$url&lt;br&gt;&quot;;
+		if (strlen($url) &lt; 2) $url = $type.$id_objet;
+	}
+
+	// Verifier les eventuels doublons et mettre a jour
+	$lock = &quot;url $type $id_objet&quot;;
+	spip_get_lock($lock, 10);
+	$query = &quot;SELECT $col_id FROM $table
+		WHERE url_propre='&quot;.addslashes($url).&quot;'&quot;;
+	if (spip_num_rows(spip_query($query)) &gt; 0) {
+		$url = $url.','.$id_objet;
+	}
+	$query = &quot;UPDATE $table SET url_propre='&quot;.addslashes($url).&quot;' WHERE $col_id=$id_objet&quot;;
+	spip_query($query);
+	spip_release_lock($lock);
+
+	return $url;
+}
+
+function generer_url_article($id_article) {
+	$url = _generer_url_propre('article', $id_article);
+	if (!$url) $url = &quot;article.php3?id_article=$id_article&quot;;
+	return $url;
+}
+
+function generer_url_rubrique($id_rubrique) {
+	$url = _generer_url_propre('rubrique', $id_rubrique);
+	if (!$url) $url = &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
+	else $url = '-'.$url.'-';
+	return $url;
+}
+
+function generer_url_breve($id_breve) {
+	$url = _generer_url_propre('breve', $id_breve);
+	if (!$url) $url = &quot;breve.php3?id_breve=$id_breve&quot;;
+	else $url = '+'.$url.'+';
+	return $url;
+}
+
+function generer_url_forum($id_forum) {
+	return &quot;forum.php3?id_forum=$id_forum&quot;;
+}
+
+function generer_url_mot($id_mot) {
+	$url = _generer_url_propre('mot', $id_mot);
+	if (!$url) $url = &quot;mot.php3?id_mot=$id_mot&quot;;
+	else $url = '+-'.$url.'-+';
+	return $url;
+}
+
+function generer_url_auteur($id_auteur) {
+	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
+}
+
+function generer_url_document($id_document) {
+	if (intval($id_document) &lt;= 0)
+		return '';
+	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
+		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
+	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
+		return ($row['fichier']);
+	return '';
+}
+
+function recuperer_parametres_url($fond, $url) {
+	global $contexte;
+
+	// Migration depuis anciennes URLs ?
+	if ($GLOBALS['_SERVER']['REQUEST_METHOD'] != 'POST' &amp;&amp;
+		preg_match(',(^|/)((article|breve|rubrique|mot)\.php3?([\?&amp;].*)?)$,', $url, $regs)) {
+		$type = $regs[3];
+		$id_objet = intval($GLOBALS['id_'.$type]);
+		if ($id_objet) {
+			$func = &quot;generer_url_$type&quot;;
+			$url_propre = $func($id_objet);
+			if ($url_propre
+			AND ($url_propre&lt;&gt;$regs[2])) {
+				http_status(301);
+				Header(&quot;Location: $url_propre&quot;);
+				exit;
+			}
+		}
+		return;
+	}
+
+	$url_propre = $GLOBALS['_SERVER']['REDIRECT_url_propre'];
+	if (!$url_propre) $url_propre = $GLOBALS['HTTP_ENV_VARS']['url_propre'];
+	if (!$url_propre) $url_propre = substr($url, strrpos($url, '/') + 1);
+	if (!$url_propre) return;
+
+	// Detecter les differents types d'objets demandes
+	if (preg_match(',^\+-(.*)-\+$,', $url_propre, $regs)) {
+		$type = 'mot';
+		$url_propre = $regs[1];
+	}
+	else if (preg_match(',^-(.*)-$,', $url_propre, $regs)) {
+		$type = 'rubrique';
+		$url_propre = $regs[1];
+	}
+	else if (preg_match(',^\+(.*)\+$,', $url_propre, $regs)) {
+		$type = 'breve';
+		$url_propre = $regs[1];
+	}
+	else {
+		$type = 'article';
+	}
+
+	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
+	$col_id = &quot;id_&quot;.$type;
+	$query = &quot;SELECT $col_id FROM $table
+		WHERE url_propre='&quot;.addslashes($url_propre).&quot;'&quot;;
+	$result = spip_query($query);
+	if (spip_num_rows($result) == 1) {
+		$row = spip_fetch_array($result);
+		$contexte[$col_id] = $row[$col_id];
+	}
+
+	return;
+}
+
 ?&gt;

Index: inc-urls-standard.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-urls-standard.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc-urls-standard.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ inc-urls-standard.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,82 +1,82 @@
-&lt;?php
-
-// executer une seule fois
-if (defined(&quot;_INC_URLS2&quot;)) return;
-define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
-
-function generer_url_article($id_article) {
-	return &quot;article.php3?id_article=$id_article&quot;;
-}
-
-function generer_url_rubrique($id_rubrique) {
-	return &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
-}
-
-function generer_url_breve($id_breve) {
-	return &quot;breve.php3?id_breve=$id_breve&quot;;
-}
-
-function generer_url_mot($id_mot) {
-	return &quot;mot.php3?id_mot=$id_mot&quot;;
-}
-
-function generer_url_auteur($id_auteur) {
-	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
-}
-
-function generer_url_document($id_document) {
-	if (intval($id_document) &lt;= 0)
-		return '';
-	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
-		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
-	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
-		return ($row['fichier']);
-	return '';
-}
-
-function recuperer_parametres_url($fond, $url) {
-	global $contexte;
-	return;
-}
-
-//
-// URLs des forums
-//
-
-// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
-function racine_forum($id_forum){
-	if (!$id_forum = intval($id_forum)) return;
-	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
-	$result = spip_query($query);
-	if($row = spip_fetch_array($result)){
-		if($row['id_parent']) {
-			return racine_forum($row['id_parent']);
-		}
-		else {
-			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
- 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
-			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
-		}
-	}
-} 
-
-function generer_url_forum($id_forum, $show_thread=false) {
-	list($type, $id, $id_thread) = racine_forum($id_forum);
-	if ($id_thread&gt;0 AND $show_thread)
-		$id_forum = $id_thread;
-	switch($type) {
-		case 'article':
-			return generer_url_article($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'breve':
-			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
-			break;
-		case 'rubrique':
-			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
-			break;
-		default:
-			return &quot;forum.php3?id_forum=&quot;.$id_forum;
-	}
-}
-
-?&gt;
+&lt;?php
+
+// executer une seule fois
+if (defined(&quot;_INC_URLS2&quot;)) return;
+define(&quot;_INC_URLS2&quot;, &quot;1&quot;);
+
+function generer_url_article($id_article) {
+	return &quot;article.php3?id_article=$id_article&quot;;
+}
+
+function generer_url_rubrique($id_rubrique) {
+	return &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
+}
+
+function generer_url_breve($id_breve) {
+	return &quot;breve.php3?id_breve=$id_breve&quot;;
+}
+
+function generer_url_mot($id_mot) {
+	return &quot;mot.php3?id_mot=$id_mot&quot;;
+}
+
+function generer_url_auteur($id_auteur) {
+	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
+}
+
+function generer_url_document($id_document) {
+	if (intval($id_document) &lt;= 0)
+		return '';
+	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
+		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
+	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
+		return ($row['fichier']);
+	return '';
+}
+
+function recuperer_parametres_url($fond, $url) {
+	global $contexte;
+	return;
+}
+
+//
+// URLs des forums
+//
+
+// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
+function racine_forum($id_forum){
+	if (!$id_forum = intval($id_forum)) return;
+	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
+	$result = spip_query($query);
+	if($row = spip_fetch_array($result)){
+		if($row['id_parent']) {
+			return racine_forum($row['id_parent']);
+		}
+		else {
+			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
+ 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
+			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
+		}
+	}
+} 
+
+function generer_url_forum($id_forum, $show_thread=false) {
+	list($type, $id, $id_thread) = racine_forum($id_forum);
+	if ($id_thread&gt;0 AND $show_thread)
+		$id_forum = $id_thread;
+	switch($type) {
+		case 'article':
+			return generer_url_article($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'breve':
+			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
+			break;
+		case 'rubrique':
+			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
+			break;
+		default:
+			return &quot;forum.php3?id_forum=&quot;.$id_forum;
+	}
+}
+
+?&gt;

Index: index.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/index.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- index.php	13 Jan 2005 15:37:14 -0000	1.1
+++ index.php	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,4 +1,4 @@
-&lt;?php
-	// pour hebergeurs ayant oublie de configurer DirectoryIndex index.php3
-	include (&quot;index.php3&quot;);
-?&gt;
+&lt;?php
+	// pour hebergeurs ayant oublie de configurer DirectoryIndex index.php3
+	include (&quot;index.php3&quot;);
+?&gt;

Index: index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/index.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- index.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ index.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1 +1 @@
-&lt;?php include (&quot;sommaire.php3&quot;); ?&gt;
+&lt;?php include (&quot;sommaire.php3&quot;); ?&gt;

Index: mes_fonctions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/mes_fonctions.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- mes_fonctions.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ mes_fonctions.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,108 +1,234 @@
-&lt;?php
-
-/////////////////////////////
-//CARTO
-/////////////////////////////
-global $tables_principales;
-
-$spip_carto_carte = array(
-	&quot;id_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
-	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
-	&quot;commentaire&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;fichier&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;callage&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;id_srs&quot; =&gt; &quot;bigint(21) NOT NULL&quot;);
-
-$spip_carto_carte_key = array(
-	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carte&quot;,
-	&quot;KEY id_carte&quot; =&gt; &quot;id_carte&quot;);
-
-$spip_carto_objet = array(
-	&quot;id_objet&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
-	&quot;id_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
-	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
-	&quot;commentaire&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
-	&quot;lien&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
-	&quot;logo&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
-	&quot;geometrie&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;);
-	
-$spip_carto_objet_key = array(
-	&quot;PRIMARY KEY&quot; =&gt; &quot;id_objet&quot;,
-	&quot;KEY id_carte&quot; =&gt; &quot;id_carte&quot;,
-	&quot;KEY titre&quot; =&gt; &quot;titre&quot;);
-
-$tables_principales['carto_objet'] =
-	array('field' =&gt; &amp;$spip_carto_objet, 'key' =&gt; &amp;$spip_carto_objet_key);
-$tables_principales['carto_carte'] =
-	array('field' =&gt; &amp;$spip_carto_carte, 'key' =&gt; &amp;$spip_carto_carte_key);
-global $table_primary;
-$table_primary['carto_carte']=&quot;id_carte&quot;;
-
-
-/*
- *   +---------------------------------------------+
- *    Nom du Filtre : WKT to COORDS
- *   +---------------------------------------------+
- *    Date : mercredi 09 avril 2003
- *    Auteur : 
- *    site :  
- *   +---------------------------------------------+
- *    Fonctions de ce filtre :
- *     Appelez le dans vos squellette tout simplement
- *     par : [(#GEOMETRIE|wkt2coords)]
- *   +---------------------------------------------+
- *  
- * Pour toute suggestion, remarque, proposition d'ajout
- * reportez-vous au forum de l'article :
- * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
- *
- */
-function wkt2coords($geometrie){
-	
-	return str_replace(';',',',substr($geometrie,8,-1));
-}
-/*
- *   +---------------------------------------------+
- *    Nom du Filtre : WKT to SHAPE 
- *   +---------------------------------------------+
- *    Date : mercredi 09 avril 2003
- *    Auteur : 
- *    site :  
- *   +---------------------------------------------+
- *    Fonctions de ce filtre :
- *     Appelez le dans vos squellette tout simplement
- *     par : [(#GEOMETRIE|wkt2shape)]
- *   +---------------------------------------------+
- *  
- * Pour toute suggestion, remarque, proposition d'ajout
- * reportez-vous au forum de l'article :
- * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
- *
- */
-function wkt2shape($geometrie){
-	
-	return substr($geometrie,0,4);
-}
-
-/*
- *   +---------------------------------------------+
- *    Nom du Filtre : Nombre de messages 
- *   +---------------------------------------------+
- *    Date : mercredi 09 avril 2003
- *    Auteur : BoOz Email:<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">booz.bloog at laposte.net</A>
- *    site : <A HREF="http://bloog.net">http://bloog.net</A>
- *   +---------------------------------------------+
- *    Fonctions de ce filtre :
- *    Compte le nombre de messages d'un auteur
- *     Appelez le dans vos squellette tout simplement
- *     par : [(#ID_AUTEUR|nb_messages)]
- *   +---------------------------------------------+
- *  
- * Pour toute suggestion, remarque, proposition d'ajout
- * reportez-vous au forum de l'article :
- * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
- *
- */
-
-
-?&gt;
+&lt;?php
+
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//          MODULE CARTO
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+// PARAMETRAGE
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+
+//////////////////////////////////////////////////
+// CARTO_CARTES
+//////////////////////////////////////////////////
+$spip_carto_cartes = array(
+	&quot;id_carto_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
+	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
+	&quot;texte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;url_carte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;callage&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;id_srs&quot; =&gt; &quot;bigint(21) NOT NULL&quot;);
+
+$spip_carto_cartes_key = array(
+	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_carto_carte&quot; =&gt; &quot;id_carto_carte&quot;);
+
+
+//////////////////////////////////////////////////
+// CARTO_OBJETS
+//////////////////////////////////////////////////
+
+$spip_carto_objets = array(
+	&quot;id_carto_objet&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
+	&quot;id_carto_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
+	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
+	&quot;texte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;url_objet&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;url_logo&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;geometrie&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;);
+	
+$spip_carto_objets_key = array(
+	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carto_objet&quot;,
+	&quot;KEY id_carto_carte&quot; =&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY titre&quot; =&gt; &quot;titre&quot;);
+
+//////////////////////////////////////////////////
+// CARTO_CARTES_ARTICLES
+//////////////////////////////////////////////////
+
+$spip_carto_cartes_articles = array(
+	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_article&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
+
+$spip_carto_cartes_articles_key = array(
+	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_article&quot; =&gt; &quot;id_article&quot;);
+
+
+//////////////////////////////////////////////////
+// CARTO_CARTES_ARTICLES
+//////////////////////////////////////////////////
+
+$spip_carto_cartes_articles = array(
+	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_article&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
+
+$spip_carto_cartes_articles_key = array(
+	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_article&quot; =&gt; &quot;id_article&quot;);
+
+
+$tables_auxiliaires['spip_carto_cartes_articles'] = array(
+	'field' =&gt; &amp;$spip_carto_cartes_articles,
+	'key' =&gt; &amp;$spip_carto_cartes_articles_key);
+
+//////////////////////////////////////////////////
+// MOTS_CARTO_OBJETS
+//////////////////////////////////////////////////
+
+$spip_mots_carto_objets= array(
+	&quot;id_carto_objet&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_mot&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
+
+$spip_mots_carto_objets_key = array(
+	&quot;KEY id_carto_objet&quot; 	=&gt; &quot;id_carto_objet&quot;,
+	&quot;KEY id_mot&quot; =&gt; &quot;id_mot&quot;);
+
+//////////////////////////////////////////////////
+// DOCUMENTS_CARTO_OBJETS
+//////////////////////////////////////////////////
+
+$spip_documents_carto_cartes= array(
+	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_document&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
+
+$spip_documents_carto_cartes_key = array(
+	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_document&quot; =&gt; &quot;id_document&quot;);
+
+
+//////////////////////////////////////////////////
+// DECLARATION
+//////////////////////////////////////////////////
+
+global $tables_principales,$table_primary,$tables_auxiliaires,$tables_relations;
+
+
+$tables_principales['spip_carto_cartes'] =
+	array('field' =&gt; &amp;$spip_carto_cartes, 'key' =&gt; &amp;$spip_carto_cartes_key);
+
+$tables_principales['spip_carto_objets'] =
+	array('field' =&gt; &amp;$spip_carto_objets, 'key' =&gt; &amp;$spip_carto_objets_key);
+
+//Relation avec les articles
+$tables_auxiliaires['spip_carto_cartes_articles'] = array(
+	'field' =&gt; &amp;$spip_carto_cartes_articles,
+	'key' =&gt; &amp;$spip_carto_cartes_articles_key);
+
+
+//La, ca se discute ...
+//Ca devrait etre une table secondaire
+//mais comme on n'utilise que l'id_mot dans la boucle
+//on gagne une jointure dans la requete
+
+//$tables_principales['spip_mots_carto_objets'] = array(
+//	'field' =&gt; &amp;$spip_mots_carto_objets,
+//	'key' =&gt; &amp;$spip_mots_carto_objets_key);
+
+$tables_auxiliaires['spip_mots_carto_objets'] = array(
+	'field' =&gt; &amp;$spip_mots_carto_objets,
+	'key' =&gt; &amp;$spip_mots_carto_objets_key);
+	
+//Relation pour boucle CARTO_OBJETS par crit&#232;re mot
+//$tables_relations['mots']['id_carto_objet']= 'mots_carto_objets';
+//$tables_relations['carto_objets']['id_mot']= 'mots_carto_objets';
+
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//FILTRES
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+/* +---------------------------------------------+
+ *    Nom    du    Filtre : WKT to STYLE
+ * +---------------------------------------------+    
+ * Date : mercredi 09 avril 2003
+ * Auteur :    
+ * site : 
+ * +---------------------------------------------+ 
+ * Fonctions de ce filtre : 
+ * Appelez le dans vos squellette tout simplement par :
+ * [(#GEOMETRIE|wkt2style)] 
+ * +--------------------------------------------- +
+ *  
+ * Pour toute suggestion, remarque, proposition d'ajout
+ * reportez-vous au forum de l'article :
+ * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
+ *
+ */
+function wkt2style($geometrie){
+	$debut=strpos($geometrie,&quot;(&quot;);
+	$milieu=strpos($geometrie,&quot;,&quot;);
+	$fin=strpos($geometrie,&quot;;&quot;);
+	$returned_str=&quot;top: &quot;.substr($geometrie,$milieu+1,$fin-$milieu-1).&quot;px;left: &quot;.substr($geometrie,$debut+1,$milieu-$debut-1).&quot;px;&quot;;
+	return $returned_str;
+}
+
+/*
+ *   +---------------------------------------------+
+ *    Nom du Filtre : WKT to COORDS
+ *   +---------------------------------------------+
+ *    Date : mercredi 09 avril 2003
+ *    Auteur : 
+ *    site :  
+ *   +---------------------------------------------+
+ *    Fonctions de ce filtre :
+ *     Appelez le dans vos squellette tout simplement
+ *     par : [(#GEOMETRIE|wkt2coords)]
+ *   +---------------------------------------------+
+ *  
+ * Pour toute suggestion, remarque, proposition d'ajout
+ * reportez-vous au forum de l'article :
+ * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
+ *
+ */
+function wkt2coords($geometrie){
+	
+	return str_replace(';',',',substr($geometrie,8,-1));
+}
+
+/*
+ *   +---------------------------------------------+
+ *    Nom du Filtre : WKT to SHAPE 
+ *   +---------------------------------------------+
+ *    Date : mercredi 09 avril 2003
+ *    Auteur : 
+ *    site :  
+ *   +---------------------------------------------+
+ *    Fonctions de ce filtre :
+ *     Appelez le dans vos squellette tout simplement
+ *     par : [(#GEOMETRIE|wkt2shape)]
+ *   +---------------------------------------------+
+ *  
+ * Pour toute suggestion, remarque, proposition d'ajout
+ * reportez-vous au forum de l'article :
+ * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
+ *
+ */
+function wkt2shape($geometrie){
+	
+	return substr($geometrie,0,4);
+}
+
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//			FIN MODULE CARTO
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+
+
+/*/ Filtre SECU - 
+function supprimer_la_securite($texte){
+$texte=ereg_replace (&quot;&lt;php&gt;&quot;,&quot;&lt;?php&quot;,$texte);
+$texte=ereg_replace (&quot;&lt;/php&gt;&quot;,&quot;?&gt;&quot;,$texte);
+return $texte;
+}
+*/
+
+
+?&gt;

Index: mot.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/mot.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- mot.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ mot.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,9 +1,9 @@
-&lt;?php
-$fond = &quot;mot&quot;;
-$delais = 24 * 3600;
-
-
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+$fond = &quot;mot&quot;;
+$delais = 24 * 3600;
+
+
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: plan.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/plan.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- plan.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ plan.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,8 +1,8 @@
-&lt;?php
-
-$fond = &quot;plan&quot;;
-$delais = 2 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+$fond = &quot;plan&quot;;
+$delais = 2 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: recherche.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/recherche.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- recherche.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ recherche.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,8 +1,8 @@
-&lt;?php
-$fond = &quot;recherche&quot;;
-$delais = 0;
-
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+$fond = &quot;recherche&quot;;
+$delais = 0;
+
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: resume.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/resume.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- resume.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ resume.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,7 +1,7 @@
-&lt;?php
-$fond = &quot;resume&quot;;
-$delais = 2 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;resume&quot;;
+$delais = 2 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: rubrique.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/rubrique.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- rubrique.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ rubrique.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,8 +1,8 @@
-&lt;?php
-$fond = &quot;rubrique&quot;;
-$delais = 2 * 3600;
-
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;rubrique&quot;;
+$delais = 2 * 3600;
+
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: site.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/site.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- site.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ site.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,9 +1,9 @@
-&lt;?php
-$fond = &quot;site&quot;;
-$delais = 24 * 3600;
-
-
-include (&quot;inc-public.php3&quot;);
-
-
-?&gt;
+&lt;?php
+$fond = &quot;site&quot;;
+$delais = 24 * 3600;
+
+
+include (&quot;inc-public.php3&quot;);
+
+
+?&gt;

Index: sommaire.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/sommaire.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- sommaire.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ sommaire.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,7 +1,7 @@
-&lt;?php
-$fond = &quot;sommaire&quot;;
-$delais = 2 * 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;sommaire&quot;;
+$delais = 2 * 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: sommaire_texte.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/sommaire_texte.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- sommaire_texte.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ sommaire_texte.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,12 +1,12 @@
-&lt;?php
-
-// ACCESSIBILITE
-// cette page offre une lecture en mode &quot;texte seul&quot;
-// des 3 articles les plus recents.
-
-$fond = &quot;sommaire_texte&quot;;
-$delais = 3600;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+
+// ACCESSIBILITE
+// cette page offre une lecture en mode &quot;texte seul&quot;
+// des 3 articles les plus recents.
+
+$fond = &quot;sommaire_texte&quot;;
+$delais = 3600;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: spip_acces_doc.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_acces_doc.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_acces_doc.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_acces_doc.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,75 +1,75 @@
-&lt;?
-# script d'acces aux documents joints
-# doit etre appele avec un de ces 2 parametres de GET:
-# - id_document 
-# - file 
-# il verifie soit que le demandeur est authentifie
-# soit que le fichier est joint &#224; au moins 1 article, breve ou rubrique
-
-$id_document = ($_GET['id_document']);
-$file = urldecode($_GET['file']);
-if (strpos($file,'../') !== false)
-  $refus = 1;
-else
-  {
-    $refus = false;
-    include (&quot;ecrire/inc_version.php3&quot;);
-    include_local(_FILE_CONNECT);
-    include_ecrire(&quot;inc_meta.php3&quot;);
-    include_ecrire(&quot;inc_session.php3&quot;);
-
-    global $auteur_session;
-    if ($cookie_session = $HTTP_COOKIE_VARS['spip_session']) 
-      {
-	if (verifier_session($cookie_session)) 
-	  {
-	    if ($auteur_session['statut'] == '0minirezo' 
-		OR $auteur_session['statut'] == '1comite') 
-	      $auth_login = $auteur_session['login'];
-	  }
-      }
-
-    if (!$id_document) {
-      $id_document = @spip_fetch_array(spip_query(&quot;select id_document from spip_documents as documents where documents.fichier='&quot;.$file.&quot;'&quot;));
-      if (!$id_document) $refus = 2;
-      $id_document = $id_document['id_document'];
-    } else {
-      $file = @spip_fetch_array(spip_query(&quot;select fichier from spip_documents as documents where id_document='&quot;. $id_document .&quot;'&quot;));
-      if (!$file) $refus = 3;
-      $file = $file['fichier'];
-    }
-  }
-
-if (!$auth_login &amp;&amp; !$refus) { 
-    if (!spip_num_rows(spip_query(&quot;select articles.id_article
-from spip_documents_articles as rel_articles, spip_articles as articles 
-where rel_articles.id_article = articles.id_article AND
-articles.statut = 'publie' AND rel_articles.id_document ='&quot;.
-			       $id_document .
-				&quot;' LIMIT 1&quot;))) {
-      if (!spip_num_rows(spip_query(&quot;select rubriques.id_rubrique
-from spip_documents_rubriques as rel_rubriques, spip_rubriques as rubriques 
-where rel_rubriques.id_rubrique = rubriques.id_rubrique AND
-rubriques.statut = 'publie' AND rel_rubriques.id_document ='&quot;.
-			       $id_document .
-				  &quot;' LIMIT 1&quot;))) {
-	if (!spip_num_rows(spip_query(&quot;select breves.id_breve
-from spip_documents_breves as rel_breves, spip_breves as breves 
-where rel_breves.id_breve = breves.id_breve AND
-breves.statut = 'publie' AND rel_breves.id_document ='&quot;.
-			       $id_document .
-				  &quot;' LIMIT 1&quot;)))
-	  $refus = 4; } } }
-
-if (!$refus)
-  {
-     header(&quot;Content-Type: &quot;. mime_content_type($file));
-     header(&quot;Content-Length: &quot;. filesize($file));
-     header(&quot;Content-Disposition: attachment; filename=\&quot;&quot;. basename($file) .&quot;\&quot;;&quot;);
-     header(&quot;Content-Transfer-Encoding: binary&quot;);
-     readfile($file);
-   }
- else
-   spip_log(&quot;Acces refuse ($refus) au document &quot; . ($_GET['id_document']) . ': ' .($_GET['file']));
-
+&lt;?
+# script d'acces aux documents joints
+# doit etre appele avec un de ces 2 parametres de GET:
+# - id_document 
+# - file 
+# il verifie soit que le demandeur est authentifie
+# soit que le fichier est joint &#224; au moins 1 article, breve ou rubrique
+
+$id_document = ($_GET['id_document']);
+$file = urldecode($_GET['file']);
+if (strpos($file,'../') !== false)
+  $refus = 1;
+else
+  {
+    $refus = false;
+    include (&quot;ecrire/inc_version.php3&quot;);
+    include_local(_FILE_CONNECT);
+    include_ecrire(&quot;inc_meta.php3&quot;);
+    include_ecrire(&quot;inc_session.php3&quot;);
+
+    global $auteur_session;
+    if ($cookie_session = $_COOKIE['spip_session']) 
+      {
+	if (verifier_session($cookie_session)) 
+	  {
+	    if ($auteur_session['statut'] == '0minirezo' 
+		OR $auteur_session['statut'] == '1comite') 
+	      $auth_login = $auteur_session['login'];
+	  }
+      }
+
+    if (!$id_document) {
+      $id_document = @spip_fetch_array(spip_query(&quot;select id_document from spip_documents as documents where documents.fichier='&quot;.$file.&quot;'&quot;));
+      if (!$id_document) $refus = 2;
+      $id_document = $id_document['id_document'];
+    } else {
+      $file = @spip_fetch_array(spip_query(&quot;select fichier from spip_documents as documents where id_document='&quot;. $id_document .&quot;'&quot;));
+      if (!$file) $refus = 3;
+      $file = $file['fichier'];
+    }
+  }
+
+if (!$auth_login &amp;&amp; !$refus) { 
+    if (!spip_num_rows(spip_query(&quot;select articles.id_article
+from spip_documents_articles as rel_articles, spip_articles as articles 
+where rel_articles.id_article = articles.id_article AND
+articles.statut = 'publie' AND rel_articles.id_document ='&quot;.
+			       $id_document .
+				&quot;' LIMIT 1&quot;))) {
+      if (!spip_num_rows(spip_query(&quot;select rubriques.id_rubrique
+from spip_documents_rubriques as rel_rubriques, spip_rubriques as rubriques 
+where rel_rubriques.id_rubrique = rubriques.id_rubrique AND
+rubriques.statut = 'publie' AND rel_rubriques.id_document ='&quot;.
+			       $id_document .
+				  &quot;' LIMIT 1&quot;))) {
+	if (!spip_num_rows(spip_query(&quot;select breves.id_breve
+from spip_documents_breves as rel_breves, spip_breves as breves 
+where rel_breves.id_breve = breves.id_breve AND
+breves.statut = 'publie' AND rel_breves.id_document ='&quot;.
+			       $id_document .
+				  &quot;' LIMIT 1&quot;)))
+	  $refus = 4; } } }
+
+if (!$refus)
+  {
+     header(&quot;Content-Type: &quot;. mime_content_type($file));
+     header(&quot;Content-Length: &quot;. filesize($file));
+     header(&quot;Content-Disposition: attachment; filename=\&quot;&quot;. basename($file) .&quot;\&quot;;&quot;);
+     header(&quot;Content-Transfer-Encoding: binary&quot;);
+     readfile($file);
+   }
+ else
+   spip_log(&quot;Acces refuse ($refus) au document &quot; . ($_GET['id_document']) . ': ' .($_GET['file']));
+
 ?&gt;

Index: spip_admin.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_admin.css,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_admin.css	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_admin.css	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,83 +1,83 @@
-/* Les boutons d'admin survolent la page (sauf #FORMULAIRE_ADMIN) */
-.spip-admin-float {
-	top: 0px;
-	right: 20px;
-	position: absolute;
-	z-index: 100;
-}
-
-
-/* Couleurs et design des boutons d'admin */
-.spip-admin-bloc {
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	background-color: transparent;
-	font-size: 10px;
-}
-
-.spip-admin-bloc li {
-	padding: 0 2px;
-	display: inline;
-}
-
-.spip-admin-bloc ul {
-	display: inline;
-}
-
-a.spip-admin-boutons {
-	border-top: 1px solid #cecece;
-	border-bottom: 2px solid #4a4a4a;
-	border-left: 1px solid #cecece;
-	border-right: 1px solid #cecece;
-	text-decoration: none;
-	width: 3em;
-	text-align: center;
-	margin: 0;
-	padding: 1px .5em;
-	font-family: helvetica,arial,sans-serif;
-	font-size: 10px;
-	font-weight: bold;
-	background-color: #fff;
-	color: #0c479d;
-}
-
-a:hover.spip-admin-boutons {
-	background-color: #fc3;
-	border-bottom: 2px solid #36f;
-}
-
-a:active.spip-admin-boutons {
-	background-color: #ccc;
-	border-bottom: 2px solid #f00;
-}
-
-
-/* Style pour le mode debug */
-#spip-debug {
-	background-color: #f0f0f0;
-	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
-}
-#spip-debug ul table {
-	font-size: 80%;
-}
-
-#spip-debug fieldset {
-	background-color: #FFF;
-	font-family: &quot;Courier New&quot;, Courier, monospace;
-	font-size: 12;
-}
-
-#spip-debug legend {
-	background-color: #FFF;
-	border: solid 1px #F00;
-	padding: 1px 1em;
-	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
-	font-weight: bold;
-}
-
-#spip-debug ul table a {
-	text-decoration: none;
-}
-
-#spip-debug ul table a:hover {
-	text-decoration: underline;
-}
+/* Les boutons d'admin survolent la page (sauf #FORMULAIRE_ADMIN) */
+.spip-admin-float {
+	top: 0px;
+	right: 20px;
+	position: absolute;
+	z-index: 100;
+}
+
+
+/* Couleurs et design des boutons d'admin */
+.spip-admin-bloc {
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	background-color: transparent;
+	font-size: 10px;
+}
+
+.spip-admin-bloc li {
+	padding: 0 2px;
+	display: inline;
+}
+
+.spip-admin-bloc ul {
+	display: inline;
+}
+
+a.spip-admin-boutons {
+	border-top: 1px solid #cecece;
+	border-bottom: 2px solid #4a4a4a;
+	border-left: 1px solid #cecece;
+	border-right: 1px solid #cecece;
+	text-decoration: none;
+	width: 3em;
+	text-align: center;
+	margin: 0;
+	padding: 1px .5em;
+	font-family: helvetica,arial,sans-serif;
+	font-size: 10px;
+	font-weight: bold;
+	background-color: #fff;
+	color: #0c479d;
+}
+
+a:hover.spip-admin-boutons {
+	background-color: #fc3;
+	border-bottom: 2px solid #36f;
+}
+
+a:active.spip-admin-boutons {
+	background-color: #ccc;
+	border-bottom: 2px solid #f00;
+}
+
+
+/* Style pour le mode debug */
+#spip-debug {
+	background-color: #f0f0f0;
+	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
+}
+#spip-debug ul table {
+	font-size: 80%;
+}
+
+#spip-debug fieldset {
+	background-color: #FFF;
+	font-family: &quot;Courier New&quot;, Courier, monospace;
+	font-size: 12;
+}
+
+#spip-debug legend {
+	background-color: #FFF;
+	border: solid 1px #F00;
+	padding: 1px 1em;
+	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
+	font-weight: bold;
+}
+
+#spip-debug ul table a {
+	text-decoration: none;
+}
+
+#spip-debug ul table a:hover {
+	text-decoration: underline;
+}

Index: spip_background.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_background.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_background.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_background.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,23 +1,22 @@
-&lt;?php
-
-// Du cote de la page HTML, utiliser un background-image en feuille de style
-// plutot qu'un &lt;img&gt;, c'est plus discret notamment sous navigateur texte
-$image = pack(&quot;H*&quot;, &quot;47494638396118001800800000ffffff00000021f90401000000002c0000000018001800000216848fa9cbed0fa39cb4da8bb3debcfb0f86e248965301003b&quot;);
-$size = strlen($image);
-
-Header(&quot;Content-Type: image/gif&quot;);
-Header(&quot;Content-Length: &quot;.$size);
-Header(&quot;Cache-Control: no-cache,no-store&quot;);
-Header(&quot;Pragma: no-cache&quot;);
-Header(&quot;Connection: close&quot;);
-
-echo $image;
-
-flush();
-
-include('ecrire/inc_version.php3');
-
-cron(1);	// toutes les 1 seconde (gourmand)
-
-
+&lt;?php
+
+// Du cote de la page HTML, utiliser un background-image en feuille de style
+// plutot qu'un &lt;img&gt;, c'est plus discret notamment sous navigateur texte
+$image = pack(&quot;H*&quot;, &quot;47494638396118001800800000ffffff00000021f90401000000002c0000000018001800000216848fa9cbed0fa39cb4da8bb3debcfb0f86e248965301003b&quot;);
+$size = strlen($image);
+
+Header(&quot;Content-Type: image/gif&quot;);
+Header(&quot;Content-Length: &quot;.$size);
+Header(&quot;Cache-Control: no-cache,no-store&quot;);
+Header(&quot;Pragma: no-cache&quot;);
+Header(&quot;Connection: close&quot;);
+
+echo $image;
+
+flush();
+
+include('ecrire/inc_version.php3');
+
+cron(1); // acces gourmand (on veut bosser, nous, pas comme inc-public.php3 !)
+
 ?&gt;

Index: spip_barre.js
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_barre.js,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_barre.js	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_barre.js	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,186 +1,186 @@
-// Barre de raccourcis
-// derive du:
-// bbCode control by subBlue design : www.subBlue.com
-
-// Startup variables
-var theSelection = false;
-
-// Check for Browser &amp; Platform for PC &amp; IE specific bits
-// More details from: <A HREF="http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html">http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html</A>
-var clientPC = navigator.userAgent.toLowerCase(); // Get client info
-var clientVer = parseInt(navigator.appVersion); // Get browser version
-
-var is_ie = ((clientPC.indexOf(&quot;msie&quot;) != -1) &amp;&amp; (clientPC.indexOf(&quot;opera&quot;) == -1));
-var is_nav = ((clientPC.indexOf('mozilla')!=-1) &amp;&amp; (clientPC.indexOf('spoofer')==-1)
-                &amp;&amp; (clientPC.indexOf('compatible') == -1) &amp;&amp; (clientPC.indexOf('opera')==-1)
-                &amp;&amp; (clientPC.indexOf('webtv')==-1) &amp;&amp; (clientPC.indexOf('hotjava')==-1));
-var is_moz = 0;
-
-var is_win = ((clientPC.indexOf(&quot;win&quot;)!=-1) || (clientPC.indexOf(&quot;16bit&quot;) != -1));
-var is_mac = (clientPC.indexOf(&quot;mac&quot;)!=-1);
-
-
-function barre_raccourci(debut,fin,champ) {
-	var txtarea = champ;
-
-	txtarea.focus();
-	donotinsert = false;
-	theSelection = false;
-	bblast = 0;
-
-	if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win)
-	{
-		theSelection = document.selection.createRange().text; // Get text selection
-		if (theSelection) {
-
-			while (theSelection.substring(theSelection.length-1, theSelection.length) == ' ')
-			{
-				theSelection = theSelection.substring(0, theSelection.length-1);
-				fin = fin + &quot; &quot;;
-			}
-			if (theSelection.substring(0,1) == '{' &amp;&amp; debut.substring(0,1) == '{')
-			{
-				debut = debut + &quot; &quot;;
-			}
-			if (theSelection.substring(theSelection.length-1, theSelection.length) == '}' &amp;&amp; fin.substring(0,1) == '}')
-			{
-				fin = &quot; &quot; + fin;
-			}
-
-			// Add tags around selection
-			document.selection.createRange().text = debut + theSelection + fin;
-			txtarea.focus();
-			theSelection = '';
-			return;
-		}
-	}
-	else if (txtarea.selectionEnd &amp;&amp; (txtarea.selectionEnd - txtarea.selectionStart &gt; 0))
-	{
-		mozWrap(txtarea, debut, fin);
-		return;
-	}
-}
-
-function barre_demande(debut,milieu,fin,affich,champ) {
-	var inserer = prompt(affich);
-
-	if (inserer != null) {
-		if (inserer == &quot;&quot;) {inserer = &quot;xxx&quot;; }
-
-		barre_raccourci(debut, milieu+inserer+fin, champ);
-	}
-}
-
-function barre_inserer(text,champ) {
-	var txtarea = champ;
-	
-	if (txtarea.createTextRange &amp;&amp; txtarea.caretPos) {
-		var caretPos = txtarea.caretPos;
-		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
-		txtarea.focus();
-	} else {
-		//txtarea.value  += text;
-		//txtarea.focus();
-		mozWrap(txtarea, '', text);
-		return;
-	}
-}
-
-
-// D'apres Nicolas Hoizey 
-function barre_tableau(toolbarfield)
-{
-	var txtarea = toolbarfield;
-	txtarea.focus();
-	var cols = prompt(&quot;Nombre de colonnes du tableau :&quot;, &quot;&quot;);
-	var rows = prompt(&quot;Nombre de lignes du tableau :&quot;, &quot;&quot;);
-	if (cols != null &amp;&amp; rows != null) {
-		var tbl = '';
-		var ligne = '|';
-		var entete = '|';
-		for(i = 0; i &lt; cols; i++) {
-			ligne = ligne + ' valeur |';
-			entete = entete + ' {{entete}} |';
-		}
-		for (i = 0; i &lt; rows; i++) {
-			tbl = tbl + ligne + '\n';
-		}
-		if (confirm('Voulez vous ajouter une ligne d\'en-t&#234;te ?')) {
-			tbl = entete + '\n' + tbl;
-		}
-		if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win) {
-			var str = document.selection.createRange().text;
-			var sel = document.selection.createRange();
-			sel.text = str + '\n\n' + tbl + '\n\n';
-		} else {
-			mozWrap(txtarea, '', &quot;\n\n&quot; + tbl + &quot;\n\n&quot;);
-		}
-	}
-	return;
-}
-
-
-
-// Shows the help messages in the helpline window
-function helpline(help, champ) {
-	champ.value = help;
-}
-
-
-function setCaretToEnd (input) {
-  setSelectionRange(input, input.value.length, input.value.length);
-}
-
-
-function setSelectionRange(input, selectionStart, selectionEnd) {
-  if (input.setSelectionRange) {
-    input.focus();
-    input.setSelectionRange(selectionStart, selectionEnd);
-  }
-  else if (input.createTextRange) {
-    var range = input.createTextRange();
-    range.collapse(true);
-    range.moveEnd('character', selectionEnd);
-    range.moveStart('character', selectionStart);
-    range.select();
-  }
-}
-
-// From <A HREF="http://www.massless.org/mozedit/">http://www.massless.org/mozedit/</A>
-function mozWrap(txtarea, open, close)
-{
-	var selLength = txtarea.textLength;
-	var selStart = txtarea.selectionStart;
-	var selEnd = txtarea.selectionEnd;
-	if (selEnd == 1 || selEnd == 2)
-		selEnd = selLength;
-	
-	// Raccourcir la selection par double-clic si dernier caractere est espace	
-	if (selEnd - selStart &gt; 0 &amp;&amp; (txtarea.value).substring(selEnd-1,selEnd) == ' ') selEnd = selEnd-1;
-	
-	var s1 = (txtarea.value).substring(0,selStart);
-	var s2 = (txtarea.value).substring(selStart, selEnd)
-	var s3 = (txtarea.value).substring(selEnd, selLength);
-
-	// Eviter melange bold-italic-intertitre
-	if ((txtarea.value).substring(selEnd,selEnd+1) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = close + &quot; &quot;;
-	if ((txtarea.value).substring(selEnd-1,selEnd) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = &quot; &quot; + close;
-	if ((txtarea.value).substring(selStart-1,selStart) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = &quot; &quot; + open;
-	if ((txtarea.value).substring(selStart,selStart+1) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = open + &quot; &quot;;
-
-	txtarea.value = s1 + open + s2 + close + s3;
-	selDeb = selStart + open.length;
-	selFin = selEnd + close.length;
-	window.setSelectionRange(txtarea, selDeb, selFin);
-	txtarea.focus();
-	
-	return;
-}
-
-// Insert at Claret position. Code from
-// <A HREF="http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130">http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130</A>
-     function storeCaret (textEl) {
-       if (textEl.createTextRange) 
-         textEl.caretPos = document.selection.createRange().duplicate();
-     }
-
+// Barre de raccourcis
+// derive du:
+// bbCode control by subBlue design : www.subBlue.com
+
+// Startup variables
+var theSelection = false;
+
+// Check for Browser &amp; Platform for PC &amp; IE specific bits
+// More details from: <A HREF="http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html">http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html</A>
+var clientPC = navigator.userAgent.toLowerCase(); // Get client info
+var clientVer = parseInt(navigator.appVersion); // Get browser version
+
+var is_ie = ((clientPC.indexOf(&quot;msie&quot;) != -1) &amp;&amp; (clientPC.indexOf(&quot;opera&quot;) == -1));
+var is_nav = ((clientPC.indexOf('mozilla')!=-1) &amp;&amp; (clientPC.indexOf('spoofer')==-1)
+                &amp;&amp; (clientPC.indexOf('compatible') == -1) &amp;&amp; (clientPC.indexOf('opera')==-1)
+                &amp;&amp; (clientPC.indexOf('webtv')==-1) &amp;&amp; (clientPC.indexOf('hotjava')==-1));
+var is_moz = 0;
+
+var is_win = ((clientPC.indexOf(&quot;win&quot;)!=-1) || (clientPC.indexOf(&quot;16bit&quot;) != -1));
+var is_mac = (clientPC.indexOf(&quot;mac&quot;)!=-1);
+
+
+function barre_raccourci(debut,fin,champ) {
+	var txtarea = champ;
+
+	txtarea.focus();
+	donotinsert = false;
+	theSelection = false;
+	bblast = 0;
+
+	if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win)
+	{
+		theSelection = document.selection.createRange().text; // Get text selection
+		if (theSelection) {
+
+			while (theSelection.substring(theSelection.length-1, theSelection.length) == ' ')
+			{
+				theSelection = theSelection.substring(0, theSelection.length-1);
+				fin = fin + &quot; &quot;;
+			}
+			if (theSelection.substring(0,1) == '{' &amp;&amp; debut.substring(0,1) == '{')
+			{
+				debut = debut + &quot; &quot;;
+			}
+			if (theSelection.substring(theSelection.length-1, theSelection.length) == '}' &amp;&amp; fin.substring(0,1) == '}')
+			{
+				fin = &quot; &quot; + fin;
+			}
+
+			// Add tags around selection
+			document.selection.createRange().text = debut + theSelection + fin;
+			txtarea.focus();
+			theSelection = '';
+			return;
+		}
+	}
+	else if (txtarea.selectionEnd &amp;&amp; (txtarea.selectionEnd - txtarea.selectionStart &gt; 0))
+	{
+		mozWrap(txtarea, debut, fin);
+		return;
+	}
+}
+
+function barre_demande(debut,milieu,fin,affich,champ) {
+	var inserer = prompt(affich);
+
+	if (inserer != null) {
+		if (inserer == &quot;&quot;) {inserer = &quot;xxx&quot;; }
+
+		barre_raccourci(debut, milieu+inserer+fin, champ);
+	}
+}
+
+function barre_inserer(text,champ) {
+	var txtarea = champ;
+	
+	if (txtarea.createTextRange &amp;&amp; txtarea.caretPos) {
+		var caretPos = txtarea.caretPos;
+		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
+		txtarea.focus();
+	} else {
+		//txtarea.value  += text;
+		//txtarea.focus();
+		mozWrap(txtarea, '', text);
+		return;
+	}
+}
+
+
+// D'apres Nicolas Hoizey 
+function barre_tableau(toolbarfield)
+{
+	var txtarea = toolbarfield;
+	txtarea.focus();
+	var cols = prompt(&quot;Nombre de colonnes du tableau :&quot;, &quot;&quot;);
+	var rows = prompt(&quot;Nombre de lignes du tableau :&quot;, &quot;&quot;);
+	if (cols != null &amp;&amp; rows != null) {
+		var tbl = '';
+		var ligne = '|';
+		var entete = '|';
+		for(i = 0; i &lt; cols; i++) {
+			ligne = ligne + ' valeur |';
+			entete = entete + ' {{entete}} |';
+		}
+		for (i = 0; i &lt; rows; i++) {
+			tbl = tbl + ligne + '\n';
+		}
+		if (confirm('Voulez vous ajouter une ligne d\'en-t&#234;te ?')) {
+			tbl = entete + '\n' + tbl;
+		}
+		if ((clientVer &gt;= 4) &amp;&amp; is_ie &amp;&amp; is_win) {
+			var str = document.selection.createRange().text;
+			var sel = document.selection.createRange();
+			sel.text = str + '\n\n' + tbl + '\n\n';
+		} else {
+			mozWrap(txtarea, '', &quot;\n\n&quot; + tbl + &quot;\n\n&quot;);
+		}
+	}
+	return;
+}
+
+
+
+// Shows the help messages in the helpline window
+function helpline(help, champ) {
+	champ.value = help;
+}
+
+
+function setCaretToEnd (input) {
+  setSelectionRange(input, input.value.length, input.value.length);
+}
+
+
+function setSelectionRange(input, selectionStart, selectionEnd) {
+  if (input.setSelectionRange) {
+    input.focus();
+    input.setSelectionRange(selectionStart, selectionEnd);
+  }
+  else if (input.createTextRange) {
+    var range = input.createTextRange();
+    range.collapse(true);
+    range.moveEnd('character', selectionEnd);
+    range.moveStart('character', selectionStart);
+    range.select();
+  }
+}
+
+// From <A HREF="http://www.massless.org/mozedit/">http://www.massless.org/mozedit/</A>
+function mozWrap(txtarea, open, close)
+{
+	var selLength = txtarea.textLength;
+	var selStart = txtarea.selectionStart;
+	var selEnd = txtarea.selectionEnd;
+	if (selEnd == 1 || selEnd == 2)
+		selEnd = selLength;
+	
+	// Raccourcir la selection par double-clic si dernier caractere est espace	
+	if (selEnd - selStart &gt; 0 &amp;&amp; (txtarea.value).substring(selEnd-1,selEnd) == ' ') selEnd = selEnd-1;
+	
+	var s1 = (txtarea.value).substring(0,selStart);
+	var s2 = (txtarea.value).substring(selStart, selEnd)
+	var s3 = (txtarea.value).substring(selEnd, selLength);
+
+	// Eviter melange bold-italic-intertitre
+	if ((txtarea.value).substring(selEnd,selEnd+1) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = close + &quot; &quot;;
+	if ((txtarea.value).substring(selEnd-1,selEnd) == '}' &amp;&amp; close.substring(0,1) == &quot;}&quot;) close = &quot; &quot; + close;
+	if ((txtarea.value).substring(selStart-1,selStart) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = &quot; &quot; + open;
+	if ((txtarea.value).substring(selStart,selStart+1) == '{' &amp;&amp; open.substring(0,1) == &quot;{&quot;) open = open + &quot; &quot;;
+
+	txtarea.value = s1 + open + s2 + close + s3;
+	selDeb = selStart + open.length;
+	selFin = selEnd + close.length;
+	window.setSelectionRange(txtarea, selDeb, selFin);
+	txtarea.focus();
+	
+	return;
+}
+
+// Insert at Claret position. Code from
+// <A HREF="http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130">http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130</A>
+     function storeCaret (textEl) {
+       if (textEl.createTextRange) 
+         textEl.caretPos = document.selection.createRange().duplicate();
+     }
+

Index: spip_cache.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cache.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_cache.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_cache.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,20 +1,20 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_admin.php3&quot;);
-include_local(&quot;inc-cache.php3&quot;);
-
-if ($purger_cache == &quot;oui&quot;) {
-	if (verifier_action_auteur(&quot;purger_cache&quot;, $hash, $id_auteur))
-		purger_cache();
-}
-
-if ($purger_squelettes == &quot;oui&quot;) {
-	if (verifier_action_auteur(&quot;purger_squelettes&quot;, $hash, $id_auteur))
-	  purger_squelettes();
-}
-redirige_par_entete($redirect);
-
-?&gt;
+&lt;?php
+
+include (&quot;ecrire/inc_version.php3&quot;);
+
+include_ecrire(&quot;inc_meta.php3&quot;);
+include_ecrire(&quot;inc_admin.php3&quot;);
+include_local(&quot;inc-cache.php3&quot;);
+
+if ($purger_cache == &quot;oui&quot;) {
+	if (verifier_action_auteur(&quot;purger_cache&quot;, $hash, $id_auteur))
+		purger_cache();
+}
+
+if ($purger_squelettes == &quot;oui&quot;) {
+	if (verifier_action_auteur(&quot;purger_squelettes&quot;, $hash, $id_auteur))
+	  purger_squelettes();
+}
+redirige_par_entete($redirect);
+
+?&gt;

Index: spip_cal.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cal.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_cal.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_cal.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,324 +1,324 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_filtres.php3&quot;);
-include_ecrire(&quot;inc_lang.php3&quot;);
-include_ecrire(&quot;inc_texte.php3&quot;);
-include_ecrire(&quot;inc_charsets.php3&quot;);
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_admin.php3&quot;);
-include_ecrire(&quot;inc_acces.php3&quot;);
-
-/*
-function ligne_x ($texte) {
-	if (ereg(&quot;^BEGIN&quot;, $texte)) echo &quot;&lt;br&gt;&quot;;
-	echo $texte.&quot;&lt;br&gt;&quot;;
-}
-*/
-function ligne ($texte) {
-	echo filtrer_ical($texte).&quot;\n&quot;;
-}
-
-$nom_site = lire_meta(&quot;nom_site&quot;);
-$adresse_site = lire_meta(&quot;adresse_site&quot;);
-
-// securite
-unset($id_utilisateur);
-$id_auteur = intval($id);
-
-// verifier la cle
-if (verifier_low_sec($id_auteur, $cle, 'ical')) {
-	$query = &quot;SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur&quot;;
-	$result = spip_query($query);
-
-	if ($row = spip_fetch_array($result)) {
-		$id_utilisateur=$row['id_auteur'];
-		$nom_utilisateur=$row['nom'];
-		$statut_utilisateur=$row['statut'];
-		$langue_utilisateur=$row['lang'];
-	}
-}
-if (!$id_utilisateur) {
-	echo _T('info_acces_interdit');
-	exit;
-}
-
-lang_select($langue_utilisateur);
-
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at header</A>(&quot;content-type:text/calendar; charset=utf-8&quot;);
-
-ligne (&quot;BEGIN:VCALENDAR&quot;);
-ligne (&quot;CALSCALE:GREGORIAN&quot;);
-ligne (&quot;X-WR-CALNAME;VALUE=TEXT:$nom_site / $nom_utilisateur&quot;);
-ligne (&quot;X-WR-RELCALID:cal$id_utilisateur @ $adresse_site&quot;);
-
-
-// rendez-vous
-$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
-while($row=spip_fetch_array($result_messages)){
-	$id_message=$row['id_message'];
-	$date_heure=$row[&quot;date_heure&quot;];
-	$date_heure_fin=$row[&quot;date_fin&quot;];
-	//$titre=typo($row[&quot;titre&quot;]);
-	$titre = $row[&quot;titre&quot;];
-	$texte = $row[&quot;texte&quot;];
-	$type=$row[&quot;type&quot;];
-
-	if ($type == 'normal') {
-		$le_type = _T('info_message_2');
-		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
-		while($row_auteur=spip_fetch_array($result_auteurs)){
-			$id_auteur=$row_auteur['id_auteur'];
-			$nom_auteur=$row_auteur['nom'];
-			$email = $row_auteur ['email'];
-
-			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
-			
-			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
-			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
-		}
-	}
-	else if ($type == 'pb') {
-		$le_type = _T('info_pense_bete');
-	}
-	else if ($type == 'affich') {
-		$le_type = _T('info_annonce');
-		$titre = &quot;[$nom_site] $titre&quot;;
-	}
-
-	ligne (&quot;BEGIN:VEVENT&quot;);
-	ligne (&quot;SUMMARY:&quot;.$titre);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
-	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
-	if ($date_heure_fin &gt; $date_heure) ligne (&quot;DTEND:&quot;.date_ical($date_heure_fin));
-
-	ligne (&quot;CATEGORIES:$le_type&quot;);
-	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
-	
-	ligne (&quot;END:VEVENT&quot;);
-	
-}
-
-// todo
-$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message AND messages.type='pb' AND messages.rv!='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
-while($row=spip_fetch_array($result_messages)){
-	$id_message=$row['id_message'];
-	$date_heure=$row[&quot;date_heure&quot;];
-	$titre = $row[&quot;titre&quot;];
-	$texte = $row[&quot;texte&quot;];
-	$type=$row[&quot;type&quot;];
-
-	if ($type == 'normal') {
-		$le_type = _T('info_message_2');
-		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
-		while($row_auteur=spip_fetch_array($result_auteurs)){
-			$id_auteur=$row_auteur['id_auteur'];
-			$nom_auteur=$row_auteur['nom'];
-			$email = $row_auteur ['email'];
-
-			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
-			
-			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
-			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
-		}
-	}
-	else if ($type == 'pb') {
-		$le_type = _T('info_pense_bete');
-	}
-	else if ($type == 'affich') {
-		$le_type = _T('info_annonce');
-		$titre = &quot;[$nom_site] $titre&quot;;
-	}
-	
-	ligne (&quot;BEGIN:VTODO&quot;);
-	ligne (&quot;SUMMARY:&quot;.$titre);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
-	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
-	ligne (&quot;CATEGORIES:$le_type&quot;);
-	ligne (&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
-	ligne (&quot;END:VTODO&quot;);
-
-}
-
-// Articles et breves proposes
-$titres = Array();
-$result_articles = spip_query(&quot;SELECT id_article, titre, date FROM spip_articles WHERE statut = 'prop'&quot;);
-while($row=spip_fetch_array($result_articles)){
-	$id_article=$row['id_article'];
-	$titre = supprimer_numero($row['titre']);
-	$titres[] = $titre;
-	$date_heure = $row['date'];
-	$nb_articles ++;
-	ligne (&quot;BEGIN:VEVENT&quot;);
-	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('info_article_propose').&quot;)&quot;);
-	ligne (&quot;UID:article$id_article @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;CATEGORIES:&quot;._T('info_article_propose'));
-	ligne(&quot;URL:$adresse_site/ecrire/articles.php3?id_article=$id_article&quot;);
-	ligne (&quot;END:VEVENT&quot;);
-}
-
-$result_articles = spip_query(&quot;SELECT id_breve, titre, date_heure FROM spip_breves WHERE statut = 'prop'&quot;);
-while($row=spip_fetch_array($result_articles)){
-	$id_breve=$row['id_breve'];
-	$titre = supprimer_numero($row['titre']);
-	$titres[] = $titre;
-	$date_heure = $row['date_heure'];
-	$nb_breves++;
-	ligne (&quot;BEGIN:VEVENT&quot;);
-	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('item_breve_proposee').&quot;)&quot;);
-	ligne (&quot;UID:breve$id_breve @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;CATEGORIES:&quot;._T('item_breve_proposee'));
-	ligne (&quot;URL:$adresse_site/ecrire/breves_voir.php3?id_breve=$id_breve&quot;);
-	ligne (&quot;END:VEVENT&quot;);
-
-}
-
-if ($nb_articles + $nb_breves &gt; 0) {
-	if ($nb_articles &gt; 0) $titre_prop[] = _T('info_articles_proposes').&quot;: &quot;.$nb_articles;
-	if ($nb_breves &gt; 0) $titre_prop[] = _T('info_breves_valider').&quot;: &quot;.$nb_breves;
-	$titre = join($titre_prop,&quot; / &quot;);
-	ligne (&quot;BEGIN:VTODO&quot;);
-	ligne (&quot;SUMMARY:[$nom_site] $titre&quot;);
-	ligne (&quot;UID:prop @ $adresse_site&quot;);
-	$texte = join($titres,&quot; / &quot;);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	
-	$today=getdate(time());
-	$jour = $today[&quot;mday&quot;];
-	$mois=$today[&quot;mon&quot;];
-	$annee=$today[&quot;year&quot;];
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-	ligne (&quot;CATEGORIES:&quot;._T('icone_a_suivre'));
-	ligne (&quot;URL:$adresse_site/ecrire/&quot;);
-	ligne (&quot;END:VTODO&quot;);
-}
-
-
-// Nouveaux messages
-
-$result_messages = spip_query(&quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur=$id_utilisateur AND vu='non' AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message&quot;);
-while($row=spip_fetch_array($result_messages)){
-	$id_message=$row['id_message'];
-	$date_heure=$row[&quot;date_heure&quot;];
-	$titre = $row[&quot;titre&quot;];
-	$texte = $row[&quot;texte&quot;];
-	$type=$row[&quot;type&quot;];
-
-	if ($type == 'normal') {
-		$le_type = _T('info_message_2');
-		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
-		while($row_auteur=spip_fetch_array($result_auteurs)){
-			$id_auteur=$row_auteur['id_auteur'];
-			$nom_auteur = $row_auteur['nom'];
-			$email = $row_auteur ['email'];
-
-			if ($id_auteur != $id_utilisateur) $titre = $nom_auteur.&quot; - &quot;.$titre;
-			
-			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
-			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
-		}
-		$query_forum = &quot;SELECT * FROM spip_forum WHERE statut='perso' AND id_message='$id_message' ORDER BY date_heure DESC LIMIT 0,1&quot;;
-		$result_forum = spip_query($query_forum);
-		if ($row_forum = spip_fetch_array($result_forum)) {
-			$date_heure = $row_forum[&quot;date_heure&quot;];
-			$texte = $row_forum[&quot;texte&quot;];
-			$titre = $row_forum[&quot;titre&quot;];
-			$id_auteur = $row_forum[&quot;id_auteur&quot;];
-
-			$result_auteurs2 = spip_query(&quot;SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur&quot;);
-			if ($row_auteur2 = spip_fetch_array($result_auteurs2)){
-				$nom_auteur = $row_auteur2['nom'];
-				$email = $row_auteur2 ['email'];
-				
-				$titre = $nom_auteur.&quot; - &quot;.$titre;
-			}
-		}
-	}
-	else if ($type == 'pb') {
-		$le_type = _T('info_pense_bete');
-	}
-	else if ($type == 'affich') {
-		$le_type = _T('info_annonce');
-		$titre = &quot;[$nom_site] $titre&quot;;
-	}
-
-	
-	
-	ligne (&quot;BEGIN:VTODO&quot;);
-	ligne (&quot;SUMMARY:&quot;.$titre);
-	ligne (&quot;DESCRIPTION:$texte&quot;);
-	ligne (&quot;UID:nouv_mess$id_message @ $adresse_site&quot;);
-	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-	ligne (&quot;CATEGORIES:$le_type&quot;);
-	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
-	ligne (&quot;END:VTODO&quot;);
-	
-}
-
-// Messages de forum a valider
-if ($statut_utilisateur == &quot;0minirezo&quot;) {
-
-	$query_forum = &quot;SELECT * FROM spip_forum WHERE statut = 'prop'&quot;;
-	$result_forum = spip_query($query_forum);
-
-	while($row=spip_fetch_array($result_forum)){
-		$nb_forum ++;
-	
-		$id_forum=$row['id_forum'];
-		$date_heure = $row['date_heure'];
-		$titre = $row['titre'];
-		$texte = $row['texte'];
-		$auteur = $row['auteur'];
-		$email_auteur = $row['email_auteur'];
-		if ($email_auteur) $email_auteur = &quot;&lt;$email_auteur&gt;&quot;;
-		
-		ligne (&quot;BEGIN:VEVENT&quot;);
-		ligne (&quot;SUMMARY:[$nom_site] $titre &quot;._T('icone_forum_suivi'));
-		ligne (&quot;DESCRIPTION:$texte\r$auteur $email_auteur&quot;);
-		ligne (&quot;UID:forum$id_forum @ $adresse_site&quot;);
-		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
-		ligne (&quot;DTEND:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure)+60,0,mois($date_heure),jour($date_heure),annee($date_heure))));
-		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
-		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
-		ligne (&quot;END:VEVENT&quot;);
-
-
-		
-	}
-
-	if ($nb_forum &gt; 0) {
-		ligne (&quot;BEGIN:VTODO&quot;);
-		ligne (&quot;SUMMARY:[$nom_site] &quot;._T('icone_forum_suivi').&quot;: $nb_forum&quot;);
-		ligne (&quot;UID:forum @ $adresse_site&quot;);
-		
-		$today=getdate(time());
-		$jour = $today[&quot;mday&quot;];
-		$mois=$today[&quot;mon&quot;];
-		$annee=$today[&quot;year&quot;];
-		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
-		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
-		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
-		ligne (&quot;END:VTODO&quot;);
-	}
-}
-
-
-
-
-ligne (&quot;END:VCALENDAR&quot;);
-
-
+&lt;?php
+
+include (&quot;ecrire/inc_version.php3&quot;);
+
+include_ecrire(&quot;inc_filtres.php3&quot;);
+include_ecrire(&quot;inc_lang.php3&quot;);
+include_ecrire(&quot;inc_texte.php3&quot;);
+include_ecrire(&quot;inc_charsets.php3&quot;);
+include_ecrire(&quot;inc_meta.php3&quot;);
+include_ecrire(&quot;inc_admin.php3&quot;);
+include_ecrire(&quot;inc_acces.php3&quot;);
+
+/*
+function ligne_x ($texte) {
+	if (ereg(&quot;^BEGIN&quot;, $texte)) echo &quot;&lt;br&gt;&quot;;
+	echo $texte.&quot;&lt;br&gt;&quot;;
+}
+*/
+function ligne ($texte) {
+	echo filtrer_ical($texte).&quot;\n&quot;;
+}
+
+$nom_site = lire_meta(&quot;nom_site&quot;);
+$adresse_site = lire_meta(&quot;adresse_site&quot;);
+
+// securite
+unset($id_utilisateur);
+$id_auteur = intval($id);
+
+// verifier la cle
+if (verifier_low_sec($id_auteur, $cle, 'ical')) {
+	$query = &quot;SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur&quot;;
+	$result = spip_query($query);
+
+	if ($row = spip_fetch_array($result)) {
+		$id_utilisateur=$row['id_auteur'];
+		$nom_utilisateur=$row['nom'];
+		$statut_utilisateur=$row['statut'];
+		$langue_utilisateur=$row['lang'];
+	}
+}
+if (!$id_utilisateur) {
+	echo _T('info_acces_interdit');
+	exit;
+}
+
+lang_select($langue_utilisateur);
+
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A>(&quot;content-type:text/calendar; charset=utf-8&quot;);
+
+ligne (&quot;BEGIN:VCALENDAR&quot;);
+ligne (&quot;CALSCALE:GREGORIAN&quot;);
+ligne (&quot;X-WR-CALNAME;VALUE=TEXT:$nom_site / $nom_utilisateur&quot;);
+ligne (&quot;X-WR-RELCALID:cal$id_utilisateur @ $adresse_site&quot;);
+
+
+// rendez-vous
+$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
+while($row=spip_fetch_array($result_messages)){
+	$id_message=$row['id_message'];
+	$date_heure=$row[&quot;date_heure&quot;];
+	$date_heure_fin=$row[&quot;date_fin&quot;];
+	//$titre=typo($row[&quot;titre&quot;]);
+	$titre = $row[&quot;titre&quot;];
+	$texte = $row[&quot;texte&quot;];
+	$type=$row[&quot;type&quot;];
+
+	if ($type == 'normal') {
+		$le_type = _T('info_message_2');
+		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
+		while($row_auteur=spip_fetch_array($result_auteurs)){
+			$id_auteur=$row_auteur['id_auteur'];
+			$nom_auteur=$row_auteur['nom'];
+			$email = $row_auteur ['email'];
+
+			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
+			
+			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
+			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
+		}
+	}
+	else if ($type == 'pb') {
+		$le_type = _T('info_pense_bete');
+	}
+	else if ($type == 'affich') {
+		$le_type = _T('info_annonce');
+		$titre = &quot;[$nom_site] $titre&quot;;
+	}
+
+	ligne (&quot;BEGIN:VEVENT&quot;);
+	ligne (&quot;SUMMARY:&quot;.$titre);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
+	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
+	if ($date_heure_fin &gt; $date_heure) ligne (&quot;DTEND:&quot;.date_ical($date_heure_fin));
+
+	ligne (&quot;CATEGORIES:$le_type&quot;);
+	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
+	
+	ligne (&quot;END:VEVENT&quot;);
+	
+}
+
+// todo
+$result_messages=spip_query(&quot;SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message AND messages.type='pb' AND messages.rv!='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure&quot;);
+while($row=spip_fetch_array($result_messages)){
+	$id_message=$row['id_message'];
+	$date_heure=$row[&quot;date_heure&quot;];
+	$titre = $row[&quot;titre&quot;];
+	$texte = $row[&quot;texte&quot;];
+	$type=$row[&quot;type&quot;];
+
+	if ($type == 'normal') {
+		$le_type = _T('info_message_2');
+		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
+		while($row_auteur=spip_fetch_array($result_auteurs)){
+			$id_auteur=$row_auteur['id_auteur'];
+			$nom_auteur=$row_auteur['nom'];
+			$email = $row_auteur ['email'];
+
+			if ($id_auteur != $id_utilisateur) $titre = $titre.&quot; - &quot;.$nom_auteur;
+			
+			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
+			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
+		}
+	}
+	else if ($type == 'pb') {
+		$le_type = _T('info_pense_bete');
+	}
+	else if ($type == 'affich') {
+		$le_type = _T('info_annonce');
+		$titre = &quot;[$nom_site] $titre&quot;;
+	}
+	
+	ligne (&quot;BEGIN:VTODO&quot;);
+	ligne (&quot;SUMMARY:&quot;.$titre);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	ligne (&quot;UID:mess$id_message @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date_ical($date_heure));
+	ligne (&quot;DTSTART:&quot;.date_ical($date_heure));
+	ligne (&quot;CATEGORIES:$le_type&quot;);
+	ligne (&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
+	ligne (&quot;END:VTODO&quot;);
+
+}
+
+// Articles et breves proposes
+$titres = Array();
+$result_articles = spip_query(&quot;SELECT id_article, titre, date FROM spip_articles WHERE statut = 'prop'&quot;);
+while($row=spip_fetch_array($result_articles)){
+	$id_article=$row['id_article'];
+	$titre = supprimer_numero($row['titre']);
+	$titres[] = $titre;
+	$date_heure = $row['date'];
+	$nb_articles ++;
+	ligne (&quot;BEGIN:VEVENT&quot;);
+	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('info_article_propose').&quot;)&quot;);
+	ligne (&quot;UID:article$id_article @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;CATEGORIES:&quot;._T('info_article_propose'));
+	ligne(&quot;URL:$adresse_site/ecrire/articles.php3?id_article=$id_article&quot;);
+	ligne (&quot;END:VEVENT&quot;);
+}
+
+$result_articles = spip_query(&quot;SELECT id_breve, titre, date_heure FROM spip_breves WHERE statut = 'prop'&quot;);
+while($row=spip_fetch_array($result_articles)){
+	$id_breve=$row['id_breve'];
+	$titre = supprimer_numero($row['titre']);
+	$titres[] = $titre;
+	$date_heure = $row['date_heure'];
+	$nb_breves++;
+	ligne (&quot;BEGIN:VEVENT&quot;);
+	ligne (&quot;SUMMARY:[$nom_site] $titre (&quot;._T('item_breve_proposee').&quot;)&quot;);
+	ligne (&quot;UID:breve$id_breve @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;DTSTART;VALUE=DATE:&quot;.date (&quot;Ymd&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;CATEGORIES:&quot;._T('item_breve_proposee'));
+	ligne (&quot;URL:$adresse_site/ecrire/breves_voir.php3?id_breve=$id_breve&quot;);
+	ligne (&quot;END:VEVENT&quot;);
+
+}
+
+if ($nb_articles + $nb_breves &gt; 0) {
+	if ($nb_articles &gt; 0) $titre_prop[] = _T('info_articles_proposes').&quot;: &quot;.$nb_articles;
+	if ($nb_breves &gt; 0) $titre_prop[] = _T('info_breves_valider').&quot;: &quot;.$nb_breves;
+	$titre = join($titre_prop,&quot; / &quot;);
+	ligne (&quot;BEGIN:VTODO&quot;);
+	ligne (&quot;SUMMARY:[$nom_site] $titre&quot;);
+	ligne (&quot;UID:prop @ $adresse_site&quot;);
+	$texte = join($titres,&quot; / &quot;);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	
+	$today=getdate(time());
+	$jour = $today[&quot;mday&quot;];
+	$mois=$today[&quot;mon&quot;];
+	$annee=$today[&quot;year&quot;];
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+	ligne (&quot;CATEGORIES:&quot;._T('icone_a_suivre'));
+	ligne (&quot;URL:$adresse_site/ecrire/&quot;);
+	ligne (&quot;END:VTODO&quot;);
+}
+
+
+// Nouveaux messages
+
+$result_messages = spip_query(&quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur=$id_utilisateur AND vu='non' AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message&quot;);
+while($row=spip_fetch_array($result_messages)){
+	$id_message=$row['id_message'];
+	$date_heure=$row[&quot;date_heure&quot;];
+	$titre = $row[&quot;titre&quot;];
+	$texte = $row[&quot;texte&quot;];
+	$type=$row[&quot;type&quot;];
+
+	if ($type == 'normal') {
+		$le_type = _T('info_message_2');
+		$result_auteurs=spip_query(&quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)&quot;);
+		while($row_auteur=spip_fetch_array($result_auteurs)){
+			$id_auteur=$row_auteur['id_auteur'];
+			$nom_auteur = $row_auteur['nom'];
+			$email = $row_auteur ['email'];
+
+			if ($id_auteur != $id_utilisateur) $titre = $nom_auteur.&quot; - &quot;.$titre;
+			
+			if ($id_auteur == $id_utilisateur) ligne (&quot;ORGANIZER:$nom_auteur &lt;$email&gt;&quot;);
+			else  ligne (&quot;ATTENDEE:$nom_auteur &lt;$email&gt;&quot;);
+		}
+		$query_forum = &quot;SELECT * FROM spip_forum WHERE statut='perso' AND id_message='$id_message' ORDER BY date_heure DESC LIMIT 0,1&quot;;
+		$result_forum = spip_query($query_forum);
+		if ($row_forum = spip_fetch_array($result_forum)) {
+			$date_heure = $row_forum[&quot;date_heure&quot;];
+			$texte = $row_forum[&quot;texte&quot;];
+			$titre = $row_forum[&quot;titre&quot;];
+			$id_auteur = $row_forum[&quot;id_auteur&quot;];
+
+			$result_auteurs2 = spip_query(&quot;SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur&quot;);
+			if ($row_auteur2 = spip_fetch_array($result_auteurs2)){
+				$nom_auteur = $row_auteur2['nom'];
+				$email = $row_auteur2 ['email'];
+				
+				$titre = $nom_auteur.&quot; - &quot;.$titre;
+			}
+		}
+	}
+	else if ($type == 'pb') {
+		$le_type = _T('info_pense_bete');
+	}
+	else if ($type == 'affich') {
+		$le_type = _T('info_annonce');
+		$titre = &quot;[$nom_site] $titre&quot;;
+	}
+
+	
+	
+	ligne (&quot;BEGIN:VTODO&quot;);
+	ligne (&quot;SUMMARY:&quot;.$titre);
+	ligne (&quot;DESCRIPTION:$texte&quot;);
+	ligne (&quot;UID:nouv_mess$id_message @ $adresse_site&quot;);
+	ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+	ligne (&quot;CATEGORIES:$le_type&quot;);
+	ligne(&quot;URL:$adresse_site/ecrire/message.php3?id_message=$id_message&quot;);
+	ligne (&quot;END:VTODO&quot;);
+	
+}
+
+// Messages de forum a valider
+if ($statut_utilisateur == &quot;0minirezo&quot;) {
+
+	$query_forum = &quot;SELECT * FROM spip_forum WHERE statut = 'prop'&quot;;
+	$result_forum = spip_query($query_forum);
+
+	while($row=spip_fetch_array($result_forum)){
+		$nb_forum ++;
+	
+		$id_forum=$row['id_forum'];
+		$date_heure = $row['date_heure'];
+		$titre = $row['titre'];
+		$texte = $row['texte'];
+		$auteur = $row['auteur'];
+		$email_auteur = $row['email_auteur'];
+		if ($email_auteur) $email_auteur = &quot;&lt;$email_auteur&gt;&quot;;
+		
+		ligne (&quot;BEGIN:VEVENT&quot;);
+		ligne (&quot;SUMMARY:[$nom_site] $titre &quot;._T('icone_forum_suivi'));
+		ligne (&quot;DESCRIPTION:$texte\r$auteur $email_auteur&quot;);
+		ligne (&quot;UID:forum$id_forum @ $adresse_site&quot;);
+		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
+		ligne (&quot;DTEND:&quot;.date (&quot;Ymd\THis&quot;, mktime (heures($date_heure),minutes($date_heure)+60,0,mois($date_heure),jour($date_heure),annee($date_heure))));
+		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
+		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
+		ligne (&quot;END:VEVENT&quot;);
+
+
+		
+	}
+
+	if ($nb_forum &gt; 0) {
+		ligne (&quot;BEGIN:VTODO&quot;);
+		ligne (&quot;SUMMARY:[$nom_site] &quot;._T('icone_forum_suivi').&quot;: $nb_forum&quot;);
+		ligne (&quot;UID:forum @ $adresse_site&quot;);
+		
+		$today=getdate(time());
+		$jour = $today[&quot;mday&quot;];
+		$mois=$today[&quot;mon&quot;];
+		$annee=$today[&quot;year&quot;];
+		ligne (&quot;DTSTAMP:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+		ligne (&quot;DTSTART:&quot;.date (&quot;Ymd\THis&quot;, mktime (12,0,0,$mois,$jour,$annee)));
+		ligne (&quot;CATEGORIES:&quot;._T('icone_forum_suivi'));
+		ligne(&quot;URL:$adresse_site/ecrire/controle_forum.php3&quot;);
+		ligne (&quot;END:VTODO&quot;);
+	}
+}
+
+
+
+
+ligne (&quot;END:VCALENDAR&quot;);
+
+
 ?&gt;

Index: spip_carto.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_carto.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_carto.php	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_carto.php	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,23 +1,43 @@
-&lt;?php
-include (&quot;ecrire/inc_version.php3&quot;);
-include (&quot;ecrire/inc_connect.php3&quot;);
-//include (&quot;ecrire/inc_meta.php3&quot;);
-//include (&quot;ecrire/inc_session.php3&quot;);
-
-include(&quot;downloadfile.class.php&quot;);
-
-if (isset($_GET[&quot;id_carte&quot;]) &amp;&amp; !empty($_GET[&quot;id_carte&quot;])) 
-{
-	$query=&quot;select fichier from spip_documents where id_document=&quot;.$_GET[&quot;id_carte&quot;];
-		
-	$result = @spip_query($query);
-	if ($result) 
-	{
-		$row = @spip_fetch_array($result); 
-		$downloadfile = new DOWNLOADFILE($row[0],&quot;inline&quot;);
-		//si c'est un probleme de document supprim&#233; : &quot;!!!&quot; ... bof !
-		if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;;
-		//else exit();
-	}
-}
+&lt;?php
+include (&quot;ecrire/inc_version.php3&quot;);
+include (&quot;ecrire/inc_connect.php3&quot;);
+//include (&quot;ecrire/inc_meta.php3&quot;);
+//include (&quot;ecrire/inc_session.php3&quot;);
+
+include(&quot;downloadfile.class.php&quot;);
+
+if (isset($_GET[&quot;fond_carte&quot;]) &amp;&amp; !empty($_GET[&quot;fond_carte&quot;])) 
+{
+	$lid_carte=intval($_GET[&quot;fond_carte&quot;]);
+	//echo $lid_carte;
+	//exit;
+	if ($lid_carte)
+	{
+		$query=&quot;select fichier from spip_documents where id_document=&quot;.$lid_carte;
+		
+		$result = @spip_query($query);
+		if ($result) 
+		{
+			$row = @spip_fetch_array($result); 
+			$downloadfile = new DOWNLOADFILE($row[0],&quot;inline&quot;);
+			//si c'est un probleme de document supprim&#233; : &quot;!!!&quot; ... bof !
+			$lError=&quot;document OK&quot;;
+		}
+		else {
+			$downloadfile = new DOWNLOADFILE(&quot;ecrire/img_pack/carte-24.png&quot;,&quot;inline&quot;);
+			$lError=&quot;pas de document&quot;;
+		}
+		if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
+		//echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
+			
+	}
+	else {
+		//$downloadfile = new DOWNLOADFILE(&quot;/ecrire/img_pack/carte-24.png&quot;,&quot;inline&quot;);
+		//$downloadfile = new DOWNLOADFILE($_GET[&quot;fond_carte&quot;],&quot;inline&quot;);
+		redirige_par_entete($_GET[&quot;fond_carte&quot;]);
+		$lError=&quot;chemin&quot;;
+	}
+	//if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
+	//else exit();
+}
 ?&gt;

Index: spip_cookie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_cookie.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_cookie.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_cookie.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,216 +1,238 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire (&quot;inc_session.php3&quot;);
-
-// gerer l'auth http
-function auth_http($url, $essai_auth_http) {
-	if ($essai_auth_http == 'oui') {
-		if (!verifier_php_auth()) {
-		  $url = quote_amp(urlencode($url));
-		  ask_php_auth(_T('login_connexion_refusee'),_T('login_login_pass_incorrect'),_T('login_retour_site'), &quot;url=$url&quot;,_T('login_nouvelle_tentative'), (ereg(_DIR_RESTREINT_ABS, $url)));
-		  exit;
-		}
-		else
-			redirige_par_entete($url);
-	}
-	// si demande logout auth_http
-	else if ($essai_auth_http == 'logout') {
-		ask_php_auth(_T('login_deconnexion_ok'),_T('login_verifiez_navigateur'),_T('login_retour_public'),&quot;redirect=ecrire&quot;,_T('login_test_navigateur'), true);
-		exit;
-	}
-}
-
-// rejoue le cookie pour renouveler spip_session
-if ($change_session == 'oui') {
-	if (verifier_session($spip_session)) {
-		// Attention : seul celui qui a le bon IP a le droit de rejouer,
-		// ainsi un eventuel voleur de cookie ne pourrait pas deconnecter
-		// sa victime, mais se ferait deconnecter par elle.
-		if ($auteur_session['hash_env'] == hash_env()) {
-			$auteur_session['ip_change'] = false;
-			$cookie = creer_cookie_session($auteur_session);
-			supprimer_session($spip_session);
-			spip_setcookie('spip_session', $cookie);
-		}
-		@header('Content-Type: image/gif');
-		@header('Expires: 0');
-		@header(&quot;Cache-Control: no-store, no-cache, must-revalidate&quot;);
-		@header('Pragma: no-cache');
-		@header(&quot;Last-Modified: &quot; . gmdate(&quot;D, d M Y H:i:s&quot;) . &quot; GMT&quot;);
-		@readfile(_DIR_IMG_PACK . 'rien.gif');
-		exit;
-	}
-}
-#spip_log(&quot;cookie: $url&quot;);
-
-if ($url)  $url = urldecode($url);
-
-// tentative de connexion en auth_http
-if ($essai_auth_http AND !$ignore_auth_http) {
-	auth_http(($url ? $url : _DIR_RESTREINT_ABS), $essai_auth_http);
-	exit;
-}
-
-// cas particulier, logout dans l'espace public
-if ($logout_public) {
-	$logout = $logout_public;
-	if (!$url)
-		$url = 'index.php3';
-}
-// tentative de logout
-if ($logout) {
-	verifier_visiteur();
-	if ($auteur_session['login'] == $logout) {
-		spip_query(&quot;UPDATE spip_auteurs SET en_ligne = DATE_SUB(NOW(),INTERVAL 6 MINUTE) WHERE id_auteur = &quot;.$auteur_session['id_auteur']);
-		if ($spip_session) {
-			zap_sessions($auteur_session['id_auteur'], true);
-			spip_setcookie('spip_session', $spip_session, time() - 3600 * 24);
-		}
-		if ($PHP_AUTH_USER AND !$ignore_auth_http) {
-			auth_http(($url ? $url : _DIR_RESTREINT_ABS), 'logout');
-		}
-		unset ($auteur_session);
-	}
-
-	redirige_par_entete($url ? $url : &quot;spip_login.php3&quot;);
-}
-
-// en cas de login sur bonjour=oui, on tente de poser un cookie
-// puis de passer a spip_login qui diagnostiquera l'echec de cookie
-// le cas echeant.
-if ($test_echec_cookie == 'oui') {
-	spip_setcookie('spip_session', 'test_echec_cookie');
-	redirige_par_entete(&quot;spip_login.php3?var_echec_cookie=oui&amp;url=&quot; .
-			    ($url ? $url : _DIR_RESTREINT_ABS));
-}
-
-// Tentative de login
-unset ($cookie_session);
-$redirect = ($url ? $url : _DIR_RESTREINT_ABS);
-if ($essai_login == &quot;oui&quot;) {
-	// Recuperer le login en champ hidden
-	if ($session_login_hidden AND !$session_login)
-		$session_login = $session_login_hidden;
-
-	$login = $session_login;
-	$pass = $session_password;
-
-	// Essayer differentes methodes d'authentification
-	$auths = array('spip');
-	include_local(_FILE_CONNECT); // pour savoir si ldap est present 
-	if ($ldap_present) $auths[] = 'ldap';
-	$ok = false;
-	reset($auths);
-	while (list(, $nom_auth) = each($auths)) {
-		include_ecrire(&quot;inc_auth_&quot;.$nom_auth.&quot;.php3&quot;);
-		$classe_auth = &quot;Auth_&quot;.$nom_auth;
-		$auth = new $classe_auth;
-		if ($auth-&gt;init()) {
-			// Essayer les mots de passe md5
-			$ok = $auth-&gt;verifier_challenge_md5($login, $session_password_md5, $next_session_password_md5);
-			// Sinon essayer avec le mot de passe en clair
-			if (!$ok &amp;&amp; $session_password) $ok = $auth-&gt;verifier($login, $session_password);
-			if ($ok)  { $auth-&gt;lire(); break; }
-		}
-	}
-
-	if ($ok) {
-		$auth-&gt;activer();
-
-		if ($auth-&gt;login AND $auth-&gt;statut == '0minirezo') // force le cookie pour les admins
-			$cookie_admin = &quot;@&quot;.$auth-&gt;login;
-
-		$query = &quot;SELECT * FROM spip_auteurs WHERE login='&quot;.addslashes($auth-&gt;login).&quot;'&quot;;
-		$result = spip_query($query);
-		if ($row_auteur = spip_fetch_array($result))
-			$cookie_session = creer_cookie_session($row_auteur);
-
-		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
-		      $redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . 'bonjour=oui';
-		}
-	}
-	else {
-		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
-			$redirect = &quot;spip_login.php3&quot;;
-		}
-		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=$login&quot;;
-		if ($session_password || $session_password_md5)
-			$redirect .= '&amp;var_erreur=pass';
-		$redirect .= '&amp;url=' . urlencode($url);
-	}
- }
-
-// cookie d'admin ?
-if ($cookie_admin == &quot;non&quot;) {
-	spip_setcookie('spip_admin', $spip_admin, time() - 3600 * 24);
-	$redirect = ereg_replace(&quot;[?&amp;]var_login=[^&amp;]*&quot;, '', $redirect);
-	$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=-1&quot;;
-}
-else if ($cookie_admin AND $spip_admin != $cookie_admin) {
-	spip_setcookie('spip_admin', $cookie_admin, time() + 3600 * 24 * 14);
-}
-
-// cookie de session ?
-if ($cookie_session) {
-	if ($session_remember == 'oui')
-		spip_setcookie('spip_session', $cookie_session, time() + 3600 * 24 * 14);
-	else
-		spip_setcookie('spip_session', $cookie_session);
-
-	$prefs = ($row_auteur['prefs']) ? unserialize($row_auteur['prefs']) : array();
-	$prefs['cnx'] = ($session_remember == 'oui') ? 'perma' : '';
-	spip_query (&quot;UPDATE spip_auteurs SET prefs = '&quot;.addslashes(serialize($prefs)).&quot;' WHERE id_auteur = &quot;.$row_auteur['id_auteur']);
-
-}
-
-// changement de langue espace public
-if ($var_lang) {
-	include_ecrire('inc_lang.php3');
-
-	if (changer_langue($var_lang)) {
-		spip_setcookie('spip_lang', $var_lang, time() + 365 * 24 * 3600);
-		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
-		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang&quot;;
-	}
-}
-
-// changer de langue espace prive (ou login)
-if ($var_lang_ecrire) {
-	include_ecrire('inc_lang.php3');
-	verifier_visiteur();
-
-	if (changer_langue($var_lang_ecrire)) {
-		spip_setcookie('spip_lang_ecrire', $var_lang_ecrire, time() + 365 * 24 * 3600);
-		spip_setcookie('spip_lang', $var_lang_ecrire, time() + 365 * 24 * 3600);
-
-		if (_FILE_CONNECT) {
-			include_ecrire('inc_admin.php3');
-			if (verifier_action_auteur('var_lang_ecrire', $valeur, $id_auteur)) {
-				spip_query (&quot;UPDATE spip_auteurs SET lang = '&quot;.addslashes($var_lang_ecrire).&quot;' WHERE id_auteur = &quot;.$id_auteur);
-				$auteur_session['lang'] = $var_lang_ecrire;
-				ajouter_session($auteur_session, $spip_session);	// enregistrer dans le fichier de session
-			}
-		}
-
-		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
-		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang_ecrire&quot;;
-	}
-}
-
-// Redirection
-// Sous Apache, les cookies avec une redirection fonctionnent
-// Sinon, on fait un refresh HTTP
-
-if (ereg(&quot;^Apache&quot;, $SERVER_SOFTWARE)) {
-	redirige_par_entete($redirect);
-}
-else {
-	@header(&quot;Refresh: 0; url=&quot; . $redirect);
-	echo &quot;&lt;html&gt;&lt;head&gt;&quot;;
-	echo &quot;&lt;meta http-equiv='Refresh' content='0; url=&quot;.$redirect.&quot;'&gt;&quot;;
-	echo &quot;&lt;/head&gt;\n&quot;;
-	echo &quot;&lt;body&gt;&lt;a href='&quot;.$redirect.&quot;'&gt;&quot;._T('navigateur_pas_redirige').&quot;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
-}
-
-?&gt;
+&lt;?php
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire (&quot;inc_session.php3&quot;);
+
+
+// gerer l'auth http
+function auth_http($url, $essai_auth_http) {
+	global $_SERVER;
+	if ($essai_auth_http == 'oui') {
+		if (verifier_php_auth())
+			redirige_par_entete($url);
+		else {
+			$url = quote_amp(urlencode($url));
+			ask_php_auth(_T('login_connexion_refusee'),
+			_T('login_login_pass_incorrect'), _T('login_retour_site'),
+			&quot;url=$url&quot;, _T('login_nouvelle_tentative'),
+			(ereg(_DIR_RESTREINT_ABS, $url)));
+			exit;
+		}
+	}
+	// si demande logout auth_http
+	else if ($essai_auth_http == 'logout') {
+		ask_php_auth(_T('login_deconnexion_ok'),
+		_T('login_verifiez_navigateur'), _T('login_retour_public'),
+		&quot;redirect=&quot;._DIR_RESTREINT_ABS, _T('login_test_navigateur'), true);
+		exit;
+	}
+}
+
+// rejoue le cookie pour renouveler spip_session
+if ($change_session == 'oui') {
+	if (verifier_session($spip_session)) {
+		// Attention : seul celui qui a le bon IP a le droit de rejouer,
+		// ainsi un eventuel voleur de cookie ne pourrait pas deconnecter
+		// sa victime, mais se ferait deconnecter par elle.
+		if ($auteur_session['hash_env'] == hash_env()) {
+			$auteur_session['ip_change'] = false;
+			$cookie = creer_cookie_session($auteur_session);
+			supprimer_session($spip_session);
+			spip_setcookie('spip_session', $cookie);
+		}
+		@header('Content-Type: image/gif');
+		@header('Expires: 0');
+		@header(&quot;Cache-Control: no-store, no-cache, must-revalidate&quot;);
+		@header('Pragma: no-cache');
+		@header(&quot;Last-Modified: &quot; . gmdate(&quot;D, d M Y H:i:s&quot;) . &quot; GMT&quot;);
+		@readfile(_DIR_IMG_PACK . 'rien.gif');
+		exit;
+	}
+}
+
+if ($url)  $url = urldecode($url);
+
+// tentative de connexion en auth_http
+if ($essai_auth_http AND !$ignore_auth_http) {
+	auth_http(($url ? $url : _DIR_RESTREINT_ABS), $essai_auth_http);
+	exit;
+}
+
+// cas particulier, logout dans l'espace public
+if ($logout_public) {
+	$logout = $logout_public;
+	if (!$url)
+		$url = 'index.php3';
+}
+// tentative de logout
+if ($logout) {
+	verifier_visiteur();
+	if ($auteur_session['login'] == $logout) {
+		spip_query(&quot;UPDATE spip_auteurs SET en_ligne = DATE_SUB(NOW(),INTERVAL 6 MINUTE) WHERE id_auteur = &quot;.$auteur_session['id_auteur']);
+		if ($spip_session) {
+			zap_sessions($auteur_session['id_auteur'], true);
+			spip_setcookie('spip_session', $spip_session, time() - 3600 * 24);
+		}
+		
+		if ($_SERVER['PHP_AUTH_USER']
+		AND !$ignore_auth_http
+		AND verifier_php_auth()) {
+			auth_http(($url ? $url : _DIR_RESTREINT_ABS), 'logout');
+		}
+		unset ($auteur_session);
+	}
+
+	redirige_par_entete($url ? $url :
+			    (&quot;spip_login.php3?url=$url&amp;inscription=&quot; .
+			     ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)?
+			      'spip_inscription.php3' : '')));
+}
+
+// en cas de login sur bonjour=oui, on tente de poser un cookie
+// puis de passer a spip_login qui diagnostiquera l'echec de cookie
+// le cas echeant.
+if ($test_echec_cookie == 'oui') {
+	spip_setcookie('spip_session', 'test_echec_cookie');
+	redirige_par_entete(&quot;spip_login.php3?var_echec_cookie=oui&amp;url=&quot; .
+			    ($url ? $url : _DIR_RESTREINT_ABS) .
+			    &quot;&amp;inscription=&quot; .
+			     ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)?
+			      'spip_inscription.php3' : ''));
+}
+
+// Tentative de login
+unset ($cookie_session);
+$redirect = ($url ? $url : _DIR_RESTREINT_ABS);
+if ($essai_login == &quot;oui&quot;) {
+	// Recuperer le login en champ hidden
+	if ($session_login_hidden AND !$session_login)
+		$session_login = $session_login_hidden;
+
+	$login = $session_login;
+	$pass = $session_password;
+
+	// Essayer differentes methodes d'authentification
+	$auths = array('spip');
+	include_local(_FILE_CONNECT); // pour savoir si ldap est present 
+	if ($ldap_present) $auths[] = 'ldap';
+	$ok = false;
+	reset($auths);
+	while (list(, $nom_auth) = each($auths)) {
+		include_ecrire(&quot;inc_auth_&quot;.$nom_auth.&quot;.php3&quot;);
+		$classe_auth = &quot;Auth_&quot;.$nom_auth;
+		$auth = new $classe_auth;
+		if ($auth-&gt;init()) {
+			// Essayer les mots de passe md5
+			$ok = $auth-&gt;verifier_challenge_md5($login, $session_password_md5, $next_session_password_md5);
+			// Sinon essayer avec le mot de passe en clair
+			if (!$ok &amp;&amp; $session_password) $ok = $auth-&gt;verifier($login, $session_password);
+			if ($ok)  { $auth-&gt;lire(); break; }
+		}
+	}
+
+	if ($ok) {
+		$auth-&gt;activer();
+
+		if ($auth-&gt;login AND $auth-&gt;statut == '0minirezo') // force le cookie pour les admins
+			$cookie_admin = &quot;@&quot;.$auth-&gt;login;
+
+		$query = &quot;SELECT * FROM spip_auteurs WHERE login='&quot;.addslashes($auth-&gt;login).&quot;'&quot;;
+		$result = spip_query($query);
+		if ($row_auteur = spip_fetch_array($result))
+			$cookie_session = creer_cookie_session($row_auteur);
+
+		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
+		      $redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . 'bonjour=oui';
+		}
+	}
+	else {
+		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
+			$redirect = &quot;spip_login.php3?inscription=&quot; .
+			     ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)?
+			      'spip_inscription.php3' : '');
+		}
+		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=$login&quot;;
+		if ($session_password || $session_password_md5)
+			$redirect .= '&amp;var_erreur=pass';
+		$redirect .= '&amp;url=' . urlencode($url);
+	}
+ }
+
+// cookie d'admin ?
+if ($cookie_admin == &quot;non&quot;) {
+	if (!$retour)
+	  $retour = 'spip_login.php3?var_url='.urlencode($url) .
+	     &quot;&amp;inscription=&quot;  .
+	    ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)? 'spip_inscription.php3' : '');
+
+	spip_setcookie('spip_admin', $spip_admin, time() - 3600 * 24);
+	$redirect = ereg_replace(&quot;[?&amp;]var_login=[^&amp;]*&quot;, '', $retour);
+	$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;var_login=-1&quot;;
+}
+else if ($cookie_admin AND $spip_admin != $cookie_admin) {
+	spip_setcookie('spip_admin', $cookie_admin, time() + 3600 * 24 * 14);
+}
+
+// cookie de session ?
+if ($cookie_session) {
+	if ($session_remember == 'oui')
+		spip_setcookie('spip_session', $cookie_session, time() + 3600 * 24 * 14);
+	else
+		spip_setcookie('spip_session', $cookie_session);
+
+	$prefs = ($row_auteur['prefs']) ? unserialize($row_auteur['prefs']) : array();
+	$prefs['cnx'] = ($session_remember == 'oui') ? 'perma' : '';
+	spip_query (&quot;UPDATE spip_auteurs SET prefs = '&quot;.addslashes(serialize($prefs)).&quot;' WHERE id_auteur = &quot;.$row_auteur['id_auteur']);
+
+}
+
+// changement de langue espace public
+if ($var_lang) {
+	include_ecrire('inc_lang.php3');
+
+	if (changer_langue($var_lang)) {
+		spip_setcookie('spip_lang', $var_lang, time() + 365 * 24 * 3600);
+		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
+		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang&quot;;
+	}
+}
+
+// changer de langue espace prive (ou login)
+if ($var_lang_ecrire) {
+	include_ecrire('inc_lang.php3');
+	verifier_visiteur();
+
+	if (changer_langue($var_lang_ecrire)) {
+		spip_setcookie('spip_lang_ecrire', $var_lang_ecrire, time() + 365 * 24 * 3600);
+		spip_setcookie('spip_lang', $var_lang_ecrire, time() + 365 * 24 * 3600);
+
+		if (_FILE_CONNECT) {
+			include_ecrire('inc_admin.php3');
+			if (verifier_action_auteur('var_lang_ecrire', $valeur, $id_auteur)) {
+				spip_query (&quot;UPDATE spip_auteurs SET lang = '&quot;.addslashes($var_lang_ecrire).&quot;' WHERE id_auteur = &quot;.$id_auteur);
+				$auteur_session['lang'] = $var_lang_ecrire;
+				ajouter_session($auteur_session, $spip_session);	// enregistrer dans le fichier de session
+			}
+		}
+
+		$redirect = ereg_replace(&quot;[?&amp;]lang=[^&amp;]*&quot;, '', $redirect);
+		$redirect .= (strpos($redirect, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) . &quot;lang=$var_lang_ecrire&quot;;
+	}
+}
+
+// Redirection
+// Sous Apache, les cookies avec une redirection fonctionnent
+// Sinon, on fait un refresh HTTP
+
+if (ereg(&quot;^Apache&quot;, $SERVER_SOFTWARE)) {
+	redirige_par_entete($redirect);
+}
+else {
+	@header(&quot;Refresh: 0; url=&quot; . $redirect);
+	echo &quot;&lt;html&gt;&lt;head&gt;&quot;;
+	echo &quot;&lt;meta http-equiv='Refresh' content='0; url=&quot;.$redirect.&quot;'&gt;&quot;;
+	echo &quot;&lt;/head&gt;\n&quot;;
+	echo &quot;&lt;body&gt;&lt;a href='&quot;.$redirect.&quot;'&gt;&quot;._T('navigateur_pas_redirige').&quot;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
+}
+
+?&gt;

Index: spip_image.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_image.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_image.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_image.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,443 +1,247 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire(&quot;inc_charsets.php3&quot;);
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_admin.php3&quot;);
-include_ecrire(&quot;inc_abstract_sql.php3&quot;);
-
-function effacer_image($nom) {
-	global $hash_id_auteur, $hash;
-
-	if ((!strstr($nom, &quot;..&quot;)) AND
-	    verifier_action_auteur(&quot;supp_image $nom&quot;, $hash, $hash_id_auteur))
-		@unlink(_DIR_IMG . $nom);
-}
-
-function tester_vignette ($test_vignette) {
-	global $djpeg_command, $cjpeg_command, $pnmscale_command;
-	// verifier les formats acceptes par GD
-	if ($test_vignette == &quot;gd1&quot;) {
-		$gd_formats = Array();
-		if (function_exists('ImageCreateFromJPEG')) {
-			$srcImage = @ImageCreateFromJPEG(_DIR_IMG . &quot;test.jpg&quot;);
-			if ($srcImage) {
-				$gd_formats[] = &quot;jpg&quot;;
-				ImageDestroy( $srcImage );
-			}
-		}
-		if (function_exists('ImageCreateFromGIF')) {
-			$srcImage = @ImageCreateFromGIF(_DIR_IMG . &quot;test.gif&quot;);
-			if ($srcImage) {
-				$gd_formats[] = &quot;gif&quot;;
-				ImageDestroy( $srcImage );
-			}
-		}
-		if (function_exists('ImageCreateFromPNG')) {
-			$srcImage = @ImageCreateFromPNG(_DIR_IMG . &quot;test.png&quot;);
-			if ($srcImage) {
-				$gd_formats[] = &quot;png&quot;;
-				ImageDestroy( $srcImage );
-			}
-		}
-
-		if ($gd_formats) $gd_formats = join(&quot;,&quot;, $gd_formats);
-		ecrire_meta(&quot;gd_formats&quot;, $gd_formats);
-		ecrire_metas();
-	}
-	// verifier les formats netpbm
-	else if ($test_vignette == &quot;netpbm&quot;) {
-		$netpbm_formats= Array();
-
-		$jpegtopnm_command = ereg_replace(&quot;pnmscale&quot;, &quot;jpegtopnm&quot;, $pnmscale_command);
-		$pnmtojpeg_command = ereg_replace(&quot;pnmscale&quot;, &quot;pnmtojpeg&quot;, $pnmscale_command);
-
-		$vignette = _DIR_IMG . &quot;test.jpg&quot;;
-		$dest = _DIR_IMG . &quot;test-jpg.jpg&quot;;
-		exec(&quot;$jpegtopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command &gt; $dest&quot;);
-		if ($taille = @getimagesize($dest)) {
-			if ($taille[1] == 10) $netpbm_formats[] = &quot;jpg&quot;;
-		}	
-		
-		$giftopnm_command = ereg_replace(&quot;pnmscale&quot;, &quot;giftopnm&quot;, $pnmscale_command);
-		$pnmtojpeg_command = ereg_replace(&quot;pnmscale&quot;, &quot;pnmtojpeg&quot;, $pnmscale_command);
-		$vignette = _DIR_IMG . &quot;test.gif&quot;;
-		$dest = _DIR_IMG . &quot;test-gif.jpg&quot;;
-		exec(&quot;$giftopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command &gt; $dest&quot;);
-		if ($taille = @getimagesize($dest)) {
-			if ($taille[1] == 10) $netpbm_formats[] = &quot;gif&quot;;
-		}
-
-		$pngtopnm_command = ereg_replace(&quot;pnmscale&quot;, &quot;pngtopnm&quot;, $pnmscale_command);
-		$vignette = _DIR_IMG . &quot;test.png&quot;;
-		$dest = _DIR_IMG . &quot;test-gif.jpg&quot;;
-		exec(&quot;$pngtopnm_command $vignette | $pnmscale_command -width 10 | $cjpeg_command -outfile $dest&quot;);
-		if ($taille = @getimagesize($dest)) {
-			if ($taille[1] == 10) $netpbm_formats[] = &quot;png&quot;;
-		}
-		
-
-		if ($netpbm_formats) $netpbm_formats = join(&quot;,&quot;, $netpbm_formats);
-		ecrire_meta(&quot;netpbm_formats&quot;, $netpbm_formats);
-		ecrire_metas();
-	}
-
-	// et maintenant envoyer la vignette de tests
-	if (ereg(&quot;^(gd1|gd2|imagick|convert|netpbm)$&quot;, $test_vignette)) {
-		include_ecrire('inc_logos.php3');
-		//$taille_preview = lire_meta(&quot;taille_preview&quot;);
-		if ($taille_preview &lt; 10) $taille_preview = 120;
-		if ($preview = creer_vignette(_DIR_IMG . 'test_image.jpg', $taille_preview, $taille_preview, 'jpg', '', &quot;test_$test_vignette&quot;, $test_vignette, true))
-
-			return ($preview['fichier']);
-	}
-	return '';
-}
-
-
-//
-// Deplacer un fichier
-//
-
-function deplacer_fichier_upload($source, $dest) {
-	// Securite
-	if (strstr($dest, &quot;..&quot;)) {
-		exit;
-	}
-
-	$ok = @copy($source, $dest);
-	if (!$ok) $ok = @move_uploaded_file($source, $dest);
-	if ($ok)
-		@chmod($dest, 0666);
-	else {
-		$f = @fopen($dest,'w');
-		if ($f)
-			fclose ($f);
-		else {
-			redirige_par_entete(&quot;spip_test_dirs.php3?test_dir=&quot;.
-					    dirname($dest));
-		}
-		@unlink($dest);
-
-		if (($GLOBALS['_FILES']['size'] == 0) AND !$GLOBALS['action_zip']) {
-			include_ecrire('inc_presentation.php3');
-			install_debut_html(_T('forum_titre_erreur'));
-			echo &quot;&lt;p&gt;&quot;._T('upload_limit',
-				array('max' =&gt; ini_get('upload_max_filesize')));
-			install_fin_html();
-			exit;
-		}
-	}
-
-	return $ok;
-}
-
-
-//
-// Convertit le type numerique retourne par getimagesize() en extension fichier
-//
-
-function decoder_type_image($type, $strict = false) {
-	switch ($type) {
-	case 1:
-		return &quot;gif&quot;;
-	case 2:
-		return &quot;jpg&quot;;
-	case 3:
-		return &quot;png&quot;;
-	case 4:
-		return $strict ? &quot;&quot; : &quot;swf&quot;;
-	case 5:
-		return &quot;psd&quot;;
-	case 6:
-		return &quot;bmp&quot;;
-	case 7:
-	case 8:
-		return &quot;tif&quot;;
-	default:
-		return &quot;&quot;;
-	}
-}
-
-
-//
-// Corrige l'extension du fichier dans quelques cas particuliers
-//
-
-function corriger_extension($ext) {
-	switch ($ext) {
-	case 'htm':
-		return 'html';
-	case 'jpeg':
-		return 'jpg';
-	case 'tiff':
-		return 'tif';
-	default:
-		return $ext;
-	}
-}
-
-
-//
-// Ajouter une image (logo)
-//
-
-function ajout_image($source, $dest) {
-	global $redirect_url, $hash_id_auteur, $hash, $num_img, $dossier_squelettes;
-
-	// Securite
-	if (!(verifier_action_auteur(&quot;ajout_image $dest&quot;, $hash, $hash_id_auteur)
-	      AND _DIR_DOC != $dossier_squelettes)) {
-	  spip_log(&quot;interdiction ajout_image($source, $dest)&quot;);
-	  return;
-	}
-
-	// analyse le type de l'image (on ne fait pas confiance au nom de
-	// fichier envoye par le browser : pour les Macs c'est plus sur)
-
-	$f =_DIR_DOC . $dest . '.tmp';
-	deplacer_fichier_upload($source, $f);
-	$size = @getimagesize($f);
-	$type = decoder_type_image($size[2], true);
-	if ($type)
-		@rename ($f, _DIR_DOC . $dest . &quot;.$type&quot;);
-	else
-		@unlink ($f);
-}
-
-//
-// Faire tourner une image
-//
-
-//$imagePath - path to your image; function will save rotated image overwriting the old one
-//$rtt - should be 90 or -90 - cw/ccw
-function gdRotate($imagePath,$rtt){
-	if(preg_match(&quot;/\.(png)/i&quot;, $imagePath)) $src_img=ImageCreateFromPNG($imagePath);
-	elseif(preg_match(&quot;/\.(jpg)/i&quot;, $imagePath)) $src_img=ImageCreateFromJPEG($imagePath);
-	elseif(preg_match(&quot;/\.(bmp)/i&quot;, $imagePath)) $src_img=ImageCreateFromWBMP($imagePath);
-	$size=@getimagesize($imagePath);
-	//note: to make it work on GD 2.xx properly change ImageCreate to ImageCreateTrueColor
-
-	$process = lire_meta('image_process');
-	if ($process == &quot;gd2&quot;) $dst_img=ImageCreateTrueColor($size[1],$size[0]);
-	else  $dst_img=ImageCreate($size[1],$size[0]);
-	if($rtt==90){
-		$t=0;
-		$b=$size[1]-1;
-		while($t&lt;=$b){
-			$l=0;
-			$r=$size[0]-1;
-			while($l&lt;=$r){
-				imagecopy($dst_img,$src_img,$t,$r,$r,$b,1,1);
-				imagecopy($dst_img,$src_img,$t,$l,$l,$b,1,1);
-				imagecopy($dst_img,$src_img,$b,$r,$r,$t,1,1);
-				imagecopy($dst_img,$src_img,$b,$l,$l,$t,1,1);
-				$l++;
-				$r--;
-			}
-			$t++;
-			$b--;
-		}
-	}
-	elseif($rtt==-90){
-		$t=0;
-		$b=$size[1]-1;
-		while($t&lt;=$b){
-			$l=0;
-			$r=$size[0]-1;
-			while($l&lt;=$r){
-				imagecopy($dst_img,$src_img,$t,$l,$r,$t,1,1);
-				imagecopy($dst_img,$src_img,$t,$r,$l,$t,1,1);
-				imagecopy($dst_img,$src_img,$b,$l,$r,$b,1,1);
-				imagecopy($dst_img,$src_img,$b,$r,$l,$b,1,1);
-				$l++;
-				$r--;
-			}
-			$t++;
-			$b--;
-		}
-	}
-	ImageDestroy($src_img);
-	ImageInterlace($dst_img,0);
-	ImageJPEG($dst_img,$imagePath);
-}
-
-//
-// Creation automatique de vignette new style
-// Normalement le test est v&#233;rifi&#233; donc on ne rend rien sinon
-
-function creer_fichier_vignette($vignette) {
-	if ($vignette &amp;&amp; lire_meta(&quot;creer_preview&quot;) == 'oui') {
-		eregi('\.([a-z0-9]+)$', $vignette, $regs);
-		$ext = $regs[1];
-		$taille_preview = lire_meta(&quot;taille_preview&quot;);
-		if ($taille_preview &lt; 10) $taille_preview = 120;
-		include_ecrire('inc_logos.php3');
-
-		if ($preview = creer_vignette($vignette, $taille_preview, $taille_preview, $ext, 'vignettes', basename($vignette).'-s'))
-		{
-			inserer_vignette_base($vignette, $preview['fichier']);
-			return $preview['fichier'];
-		}
-		include_ecrire('inc_documents.php3');
-		return vignette_par_defaut($ext ? $ext : 'txt', false);
-	}
-}
-
-function supprime_document_et_vignette($doc_supp) {
-	global $hash_id_auteur, $hash;
-	// Securite
-	if (verifier_action_auteur(&quot;supp_doc $doc_supp&quot;, $hash, $hash_id_auteur)) {
-		$query = &quot;SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$doc_supp&quot;;
-		$result = spip_query($query);
-		if ($row = spip_fetch_array($result)) {
-			$fichier = $row['fichier'];
-			$id_vignette = $row['id_vignette'];
-			spip_query(&quot;DELETE FROM spip_documents WHERE id_document=$doc_supp&quot;);
-			spip_query(&quot;UPDATE spip_documents SET id_vignette=0 WHERE id_vignette=$doc_supp&quot;);
-			spip_query(&quot;DELETE FROM spip_documents_articles WHERE id_document=$doc_supp&quot;);
-			spip_query(&quot;DELETE FROM spip_documents_rubriques WHERE id_document=$doc_supp&quot;);
-			spip_query(&quot;DELETE FROM spip_documents_breves WHERE id_document=$doc_supp&quot;);
-			@unlink($fichier);
-			
-			if ($id_vignette &gt; 0) {
-			  $query = &quot;SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$id_vignette&quot;;
-			  $result = spip_query($query);
-			  if ($row = spip_fetch_array($result)) {
-			    $fichier = $row['fichier'];
-			    @unlink($fichier);
-			  }
-			  spip_query(&quot;DELETE FROM spip_documents WHERE id_document=$id_vignette&quot;);
-			  spip_query(&quot;DELETE FROM spip_documents_articles WHERE id_document=$id_vignette&quot;);
-			  spip_query(&quot;DELETE FROM spip_documents_rubriques WHERE id_document=$id_vignette&quot;);
-			  spip_query(&quot;DELETE FROM spip_documents_breves WHERE id_document=$id_vignette&quot;);
-			}
-		}
-	}
-}
-
-function tourner_document($var_rot, $doc_rotate, $convert_command) {
-	global $hash_id_auteur, $hash;
-	// Securite
-	if (!verifier_action_auteur(&quot;rotate $doc_rotate&quot;, $hash, $hash_id_auteur)) {
-		return '';
-	}
-	
-	if (!$var_rot) $var_rot = 0;
-
-	$query = &quot;SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$doc_rotate&quot;;
-	$result = spip_query($query);
-	if ($row = spip_fetch_array($result)) {
-		$id_vignette = $row['id_vignette'];
-		$image = $row['fichier'];
-
-		$process = lire_meta('image_process');
-
-		 // imagick (php4-imagemagick)
-		 if ($process == 'imagick') {
-			$handle = imagick_readimage($image);
-			imagick_rotate($handle, $var_rot);
-			imagick_write($handle, $image);
-			if (!@file_exists($image)) return;	// echec imagick
-		}
-		else if ($process == &quot;gd2&quot;) { // theoriquement compatible gd1, mais trop forte degradation d'image
-			if ($var_rot == 180) { // 180 = 90+90
-				gdRotate ($image, 90);
-				gdRotate ($image, 90);
-			} else {
-				gdRotate ($image, $var_rot);
-			}
-		}
-		else if ($process = &quot;convert&quot;) {
-			$commande = &quot;$convert_command -rotate $var_rot ./&quot;
-				. escapeshellcmd($image).' ./'.escapeshellcmd($image);
-#			spip_log($commande);
-			exec($commande);
-		}
-
-		$size_image = @getimagesize($image);
-		$largeur = $size_image[0];
-		$hauteur = $size_image[1];
-
-		if ($id_vignette &gt; 0) {
-			creer_fichier_vignette($image);
-/*			$query = &quot;SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$id_vignette&quot;;
-			$result = spip_query($query);
-			if ($row = spip_fetch_array($result)) {
-				$fichier = $row['fichier'];
-				@unlink($fichier);
-			}
-			spip_query(&quot;DELETE FROM spip_documents WHERE id_document=$id_vignette&quot;);
-			spip_query(&quot;DELETE FROM spip_documents_articles WHERE id_document=$id_vignette&quot;);
-			spip_query(&quot;DELETE FROM spip_documents_rubriques WHERE id_document=$id_vignette&quot;);
-			spip_query(&quot;DELETE FROM spip_documents_breves WHERE id_document=$id_vignette&quot;);
-*/		}
-
-
-		spip_query(&quot;UPDATE spip_documents SET largeur=$largeur, hauteur=$hauteur WHERE id_document=$doc_rotate&quot;);
-
-	}
-}
-
-if ($test_vignette) // appel de config-fonction
-	$redirect = tester_vignette($test_vignette);
-elseif ($vignette) // appels de inc_logo
-	$redirect = creer_fichier_vignette($vignette);
-else {
-   $retour = $redirect;
-   $redirect = '';
-   if ($ajout_doc == 'oui') {
-	include_ecrire('inc_getdocument.php3');
-	if (!$image_name AND $image2) {
-		$image = _DIR_TRANSFERT . $image2;
-		$image_name = $image;
-	} 
-	if (!eregi(&quot;\.zip$&quot;,$image_name))
-	  ajout_doc_s($image, $image_name, $mode, $forcer_document, $id_document, $hash);
-	else {
-	  // bizarre: clean_link ne recupere pas les variables
-	  $link = new Link('spip_image.php3');
-	  $link-&gt;addVar(&quot;ajout_doc&quot;, &quot;oui&quot;);
-	  $link-&gt;addVar(&quot;redirect&quot;, $retour);
-	  $link-&gt;addVar('id_document', $id_document);
-	  $link-&gt;addVar('id_article', $id_article);
-	  $link-&gt;addVar('mode', $mode);
-	  $link-&gt;addVar('type', $type);
-	  $link-&gt;addVar('hash', $hash);
-	  $link-&gt;addVar('hash_id_auteur', $hash_id_auteur);
-	  ajout_doc_zip($image, $image_name, $mode, $forcer_document, $action_zip, $id_document, $hash, $link);
-	}
-   }
-   elseif ($ajout_logo == &quot;oui&quot;)
-	ajout_image($image, $logo);
-   elseif ($image_supp)
-	effacer_image($image_supp);
-   elseif ($doc_supp) // appels de inc_document
-	supprime_document_et_vignette($doc_supp);
-   elseif ($doc_rotate)
-	tourner_document($var_rot, $doc_rotate, $convert_command);
- }
-
-if (!($redirect)) {
-	if ($HTTP_POST_VARS) $vars = $HTTP_POST_VARS;
-	else $vars = $HTTP_GET_VARS;
-	$redirect = $vars[&quot;redirect&quot;];
-	$link = new Link(_DIR_RESTREINT_ABS . $redirect);
-	reset($vars);
-	while (list ($key, $val) = each ($vars)) {
-	  if (!ereg(&quot;^(redirect|image.*|hash.*|ajout.*|doc.*|transformer.*|modifier_.*|ok|type|forcer_.*|var_rot|action_zip)$&quot;, $key)) {
-	    $link-&gt;addVar($key, $val);
-	  }
-	}
-	if ($id_document)
-	  $link-&gt;addVar('id_document',$id_document);
-	if ($type == 'rubrique')
-	  $link-&gt;delVar('id_article');
-	
-	$redirect = $link-&gt;getUrl();
- }
-
-
-redirige_par_entete($redirect);
-
-?&gt;
+&lt;?php
+
+// Uploader un document, une image ou un logo,
+// supprimer cet element, creer les vignettes, etc.
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire('inc_presentation.php3');	# regler la langue en cas d'erreur
+include_ecrire('inc_getdocument.php3');		# diverses fonctions de ce fichier
+include_ecrire(&quot;inc_charsets.php3&quot;);		# pour le nom de fichier
+include_ecrire(&quot;inc_meta.php3&quot;);			# ne pas faire confiance au cache
+											# (alea_ephemere a peut-etre change)
+include_ecrire(&quot;inc_admin.php3&quot;);			# verifier_action_auteur
+include_ecrire(&quot;inc_abstract_sql.php3&quot;);	# spip_insert
+include_ecrire('inc_documents.php3');		# fichiers_upload()
+
+
+// Recuperer les variables d'upload
+if (!$_FILES)
+	$_FILES = &amp;$HTTP_POST_FILES;
+if (!is_array($_FILES))
+	$_FILES = array();
+foreach ($_FILES as $id =&gt; $file) {
+	if ($file['error'] == 4 /* UPLOAD_ERR_NO_FILE */)
+		unset ($_FILES[$id]);
+}
+
+
+// Si on est en mode 'document', les images doivent etre installees
+// comme documents dans le portfolio
+if ($forcer_document) $mode = 'document';
+
+
+//
+// Le switch principal : quelle est l'action demandee
+//
+
+
+// appel de config-fonction
+if ($test_vignette)
+	$retour_image = tester_vignette($test_vignette);
+
+// Creation de vignette depuis le portfolio (ou autre)
+else if ($vignette) {
+	if ($creer_vignette == 'oui' AND
+	verifier_action_auteur(&quot;vign $vignette&quot;,
+	$hash, $hash_id_auteur))
+		creer_fichier_vignette($vignette);
+	else
+		$retour_image = creer_fichier_vignette($vignette, true); # obsolete
+}
+
+
+//
+// Ajout d'un document ou d'une image
+//
+else if ($ajout_doc == 'oui') {
+
+	// Autorisation ?
+	if (!verifier_action_auteur(&quot;ajout_doc&quot;, $hash, $hash_id_auteur))
+		die ('Interdit');
+
+	//
+	// Cas d'un fichier ou d'un repertoire installe dans ecrire/upload/
+	//
+	if ($_POST['image2']
+	AND !strstr($_POST['image2'], '..')
+	AND $_POST['ok_ftp']
+	) {
+		$upload = _DIR_TRANSFERT.$_POST['image2'];
+
+		// lire le repertoire upload et remplir $_FILES
+		if (is_dir($upload)) {
+			$fichiers = fichiers_upload($upload);
+
+			$_FILES = array();
+			foreach ($fichiers as $fichier) {
+				$_FILES[] = array (
+					'name' =&gt; basename($fichier),
+					'tmp_name' =&gt; $fichier
+				);
+			}
+		}
+
+		// seul un fichier est demande
+		else
+			$_FILES = array(
+				array ('name' =&gt; basename($upload),
+				'tmp_name' =&gt; $upload)
+			);
+	}
+
+	//
+	// Upload d'un ZIP
+	//
+
+	// traiter la reponse de l'utilisateur
+	if (preg_match('@^IMG/zip/[^. ]+\.zip$@i', $_POST['source_zip'])) {
+		$_FILES = array(
+			array('name' =&gt; basename($_POST['source_zip']),
+				'tmp_name' =&gt; $_POST['source_zip'])
+		);
+	}
+
+	// traiter le zip si c'en est un tout seul
+	if (count($_FILES) == 1
+	AND $action_zip!='telquel') {
+		$desc = array_pop($_FILES); # recuperer la description
+		$_FILES = array($desc);
+
+		if (preg_match('/\.zip$/i', $desc['name'])
+		OR ($desc['type'] == 'application/zip')) {
+
+			// on pose le fichier dans le repertoire zip et on met
+			// a jour $_FILES (nota : copier_document n'ecrase pas
+			// un fichier avec lui-meme : ca autorise a boucler)
+			$zip = copier_document(&quot;zip&quot;,
+				$desc['name'],
+				$desc['tmp_name']
+			);
+			if (!$zip) die ('Erreur upload zip'); # pathologique
+			$desc['tmp_name'] = $zip;	# nouvel emplacement du fichier
+			$_FILES = array($desc);
+
+			// Est-ce qu'on sait le lire ?
+			require_once(_DIR_RESTREINT . 'pclzip.lib.php');
+			$archive = new PclZip($zip);
+			$contenu = verifier_compactes($archive);
+
+			// si non, on le force comme document
+			if (!$contenu) {
+				$forcer_document = 'oui';
+			}
+
+			// si le deballage est demande
+			else if ($action_zip == 'decompacter') {
+				// 1. on deballe
+				define('_tmp_dir', creer_repertoire_documents($hash));
+				$archive-&gt;extract(PCLZIP_OPT_PATH,
+					_tmp_dir,
+					PCLZIP_OPT_REMOVE_ALL_PATH);
+				// 2. on supprime le fichier temporaire
+				$contenu = verifier_compactes($archive);
+				@unlink($zip);
+
+				$_FILES = array();
+				foreach ($contenu as $fichier) {
+					$_FILES[] = array(
+						'name' =&gt; basename($fichier),
+						'tmp_name' =&gt; _tmp_dir.$fichier);
+				}
+			}
+
+			// sinon on demande une reponse
+			else {
+				$link = new Link('spip_image.php3');
+				$link-&gt;addVar('ajout_doc', 'oui');
+				$link-&gt;addVar('redirect', $redirect);
+				$link-&gt;addVar('id_article', $id_article);
+				$link-&gt;addVar('mode', $mode);
+				$link-&gt;addVar('type', $type);
+				$link-&gt;addVar('hash', $hash);
+				$link-&gt;addVar('hash_id_auteur', $hash_id_auteur);
+				$link-&gt;addVar('source_zip', $zip);
+				afficher_compactes($desc, $contenu, $link);
+				exit;
+			}
+		}
+	}
+	// Fin du bloc ZIP
+
+
+	//
+	// Traiter la liste des fichiers
+	//
+	$documents_actifs = array();
+
+	foreach ($_FILES as $file) {
+
+		// afficher l'erreur 'fichier trop gros' ou autre
+		check_upload_error($file['error']);
+
+		spip_log (&quot;ajout du document &quot;.$file['name'].&quot;, $mode ($type $id_article)&quot;);
+		ajouter_un_document (
+			$file['tmp_name'],	# le fichier sur le serveur (/var/tmp/xyz34)
+			$file['name'],		# son nom chez le client (portequoi.pdf)
+			$type,				# lie a un article, une breve ou une rubrique ?
+			$id_article,		# identifiant de l'article (ou rubrique) lie
+			$mode,				# 'vignette' =&gt; vignette personnalisee
+			$id_document,		# pour une vignette, l'id_document de maman
+			$documents_actifs	# tableau des id_document &quot;actifs&quot; (par ref)
+		);
+	}	// foreach $_FILES
+
+	// Nettoyer le repertoire temporaire d'extraction des fichiers
+	if (defined('_tmp_dir'))
+		effacer_repertoire_temporaire(_tmp_dir);
+}
+
+// Ajout d'un logo
+else if ($ajout_logo == &quot;oui&quot; and $logo) {
+	if ($desc = array_pop($_FILES)
+	AND verifier_action_auteur(&quot;ajout_logo $logo&quot;,
+	$hash, $hash_id_auteur))
+		ajout_logo($desc, $logo);
+}
+
+// Suppression d'un logo
+else if ($image_supp) {
+	if (verifier_action_auteur(&quot;supp_logo $image_supp&quot;,
+	$hash, $hash_id_auteur))
+		effacer_logo($image_supp);
+}
+
+// Suppression d'un document et de sa vignette
+else if ($doc_supp) {
+	if (verifier_action_auteur(&quot;supp_doc $doc_supp&quot;,
+	$hash, $hash_id_auteur))
+		supprime_document_et_vignette($doc_supp);
+}
+
+// Rotation d'une image
+else if ($doc_rotate) {
+	if (verifier_action_auteur(&quot;rotate $doc_rotate&quot;,
+	$hash, $hash_id_auteur))
+		tourner_document($var_rot, $doc_rotate, $convert_command);
+}
+
+
+//
+// Retour a l'envoyeur
+//
+
+// si nous sommes diriges vers une vignette
+if ($retour_image) {
+	redirige_par_entete($retour_image);
+
+} else {
+	$link = new Link(_DIR_RESTREINT_ABS . $redirect);
+	if ($documents_actifs) {
+		$show_docs = join('-',$documents_actifs);
+		$link-&gt;addVar('show_docs',$show_docs);
+	}
+
+	redirige_par_entete($link-&gt;getUrl($ancre));
+}
+
+?&gt;

Index: spip_image_reduite.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_image_reduite.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_image_reduite.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_image_reduite.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,42 +1,37 @@
-&lt;?php
-
-$img = $_GET['img'];
-$logo = $img;
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire(&quot;inc_admin.php3&quot;);
-include_ecrire(&quot;inc_logos.php3&quot;);
-
-if (!$taille_y)
-	$taille_y = $taille_x;
-	
-if (eregi(&quot;(.*)\.(jpg|gif|png)$&quot;, $logo, $regs)) {
-	if ($i = cherche_image_nommee($regs[1], array($regs[2]))
-	    AND verifier_action_auteur(&quot;reduire $taille_x $taille_y&quot;, $hash, $hash_id_auteur))
-	{
-		list($dir,$nom,$format) = $i;
-		$logo = $dir . $nom . '.' . $format;
-		
-		include_ecrire(&quot;inc_logos.php3&quot;);
-		$suffixe = '-'.$taille_x.'x'.$taille_y;
-		$preview = creer_vignette($logo, $taille_x, $taille_y, $format,('cache'.$suffixe), $nom.$suffixe);
-		if ($preview) {
-			$vignette = $preview['fichier'];
-			$width = $preview['width'];
-			$height = $preview['height'];
-			//echo &quot;&lt;img src='$vignette' name='$name' border='0' align='$align' alt='' hspace='$espace' vspace='$espace' width='$width' height='$height' class='spip_logos' /&gt;&quot;;
-			$retour = $vignette;
-		}
-		else if ($taille_origine = @getimagesize($logo)) {
-			//list ($destWidth,$destHeight) = image_ratio($taille_origine[0], $taille_origine[1], $taille_x, $taille_y);
-			$retour = $logo;
-		}	
-
-	// Afficher l'image resultante, meme grande...
-//	header(&quot;Content-type: image/$format&quot;);
-//	echo implode ('', file ($retour));
-
-	redirige_par_entete($retour);
-	}
- }
-
+&lt;?php
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire(&quot;inc_admin.php3&quot;);
+include_ecrire(&quot;inc_logos.php3&quot;);
+
+$img = $_GET['img'];
+$logo = $img;
+
+if (!$taille_y)
+	$taille_y = $taille_x;
+	
+if (eregi(&quot;(.*)\.(jpg|gif|png)$&quot;, $logo, $regs)) {
+	if ($i = cherche_image_nommee($regs[1], array($regs[2]))
+		AND verifier_action_auteur(&quot;reduire $taille_x $taille_y&quot;, $hash, $hash_id_auteur))
+	{
+		list($dir,$nom,$format) = $i;
+		$logo = $dir . $nom . '.' . $format;
+		
+		include_ecrire(&quot;inc_logos.php3&quot;);
+		$suffixe = '-'.$taille_x.'x'.$taille_y;
+		$preview = creer_vignette($logo, $taille_x, $taille_y, $format,('cache'.$suffixe), $nom.$suffixe);
+		if ($preview) {
+			$vignette = $preview['fichier'];
+			$width = $preview['width'];
+			$height = $preview['height'];
+			$retour = $vignette;
+		}
+		else if ($taille_origine = @getimagesize($logo)) {
+			$retour = $logo;
+		}
+
+		redirige_par_entete($retour);
+	}
+}
+
 ?&gt;

Index: spip_inscription.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_inscription.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_inscription.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_inscription.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,12 +1,12 @@
-&lt;?php
-include (&quot;ecrire/inc_version.php3&quot;);
-include_ecrire(&quot;inc_presentation.php3&quot;);
-include_local(&quot;inc-formulaire_inscription.php3&quot;);
-include_local(&quot;inc-public-global.php3&quot;); 
-include_ecrire(&quot;inc_lang.php3&quot;); 
-utiliser_langue_site();
-utiliser_langue_visiteur();
-install_debut_html(_T('pass_vousinscrire'));
-inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus));
-install_fin_html();
-?&gt;
+&lt;?php
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire(&quot;inc_presentation.php3&quot;);
+include_local(find_in_path(&quot;inc-formulaire_inscription.php3&quot;));
+include_local(&quot;inc-public-global.php3&quot;); 
+include_local (&quot;inc-cache.php3&quot;);
+
+install_debut_html(_T('pass_vousinscrire'));
+inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus, $target));
+# echo http_script_window_close(); # fait dans le squelette a present
+install_fin_html();
+?&gt;

Index: spip_login.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_login.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_login.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_login.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,10 +1,10 @@
-&lt;?php
-$fond = &quot;login&quot;;
-$delais = 3600;
-$flag_dynamique = true;
-$flag_preserver = true;
-$forcer_lang = true;
-
-include (&quot;inc-public.php3&quot;);
-
-?&gt;
+&lt;?php
+$fond = &quot;login&quot;;
+$delais = 3600;
+$flag_dynamique = true;
+$flag_preserver = true;
+$forcer_lang = true;
+
+include (&quot;inc-public.php3&quot;);
+
+?&gt;

Index: spip_pass.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_pass.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_pass.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_pass.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,79 +1,73 @@
-&lt;?php
-
-include (&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_presentation.php3&quot;);
-include_ecrire(&quot;inc_session.php3&quot;);
-include_ecrire(&quot;inc_filtres.php3&quot;);
-include_ecrire(&quot;inc_texte.php3&quot;);
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_mail.php3&quot;);
-include_ecrire(&quot;inc_acces.php3&quot;);
-include_local(&quot;inc-public-global.php3&quot;); 
-
-// Ce fichier est celui d'une balise dynamique qui s'ignore.
-
-function formulaire_oubli_dyn($p, $oubli)
-{
-
-$erreur = '';
-
-// au 3e appel la variable P est positionnee par le script lui-meme
-// et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
-if ($p = addslashes($p)) {
-	$res = spip_query (&quot;SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut&lt;&gt;'5poubelle' AND pass&lt;&gt;''&quot;);
-	if (!$row = spip_fetch_array($res)) 
-		$erreur = _T('pass_erreur_code_inconnu');
-	else {
-		if ($oubli) {
-			$mdpass = md5($oubli);
-			$htpass = generer_htpass($oubli);
-			spip_query (&quot;UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
-				cookie_oubli='' WHERE cookie_oubli='$p'&quot;);
-
-			$login = $row['login'];
-			$erreur = &quot;&lt;b&gt;&quot;._T('pass_nouveau_enregistre').&quot;&lt;/b&gt;&quot;.
-			&quot;&lt;p&gt;&quot;._T('pass_rappel_login', array('login' =&gt; $login));
-		}
-	}
- } else { 
-  // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
-  if ($oubli) {
-	if (email_valide($oubli)) {
-		$email = addslashes($oubli);
-		$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE email ='$email'&quot;);
-		if ($row = spip_fetch_array($res)) {
-			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
-				$erreur = _T('pass_erreur_acces_refuse');
-			else {
-				$cookie = creer_uniqid();
-				spip_query(&quot;UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'&quot;);
-
-				if (envoyer_mail($email,
-						 &quot;[&quot; . lire_meta(&quot;nom_site&quot;) .'] ' ._T('pass_oubli_mot'),
-						 _T('pass_mail_passcookie',
-						    array('nom_site_spip' =&gt; lire_meta(&quot;nom_site&quot;),
-							  'adresse_site' =&gt; lire_meta(&quot;adresse_site&quot;), 
-							  'cookie' =&gt; $cookie))))
-					$erreur = _T('pass_recevoir_mail');
-				else
-					$erreur = _T('pass_erreur_probleme_technique');
-			}
-		}
-		else
-			$erreur = _T('pass_erreur_non_enregistre', array('email_oubli' =&gt; htmlspecialchars($oubli)));
-	} else {
-		$erreur = _T('pass_erreur_non_valide', array('email_oubli' =&gt; htmlspecialchars($oubli)));
-	}
-  }
- }
- return $erreur ? $erreur : array('formulaire_oubli', 0, array('p' =&gt; $p));
-}
-
-utiliser_langue_site();
-utiliser_langue_visiteur();
-install_debut_html(_T('pass_mot_oublie'));
-inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
-install_fin_html();
-?&gt;
+&lt;?php
+
+include (&quot;ecrire/inc_version.php3&quot;);
+include_ecrire(&quot;inc_presentation.php3&quot;); # pour install_debut
+include_ecrire(&quot;inc_session.php3&quot;); # pour creer_uniq_id
+include_ecrire(&quot;inc_mail.php3&quot;); # pour envoyer_mail
+include_ecrire(&quot;inc_acces.php3&quot;); # pour generer_htpass
+include_local(&quot;inc-public-global.php3&quot;); # pour calculer la page
+include_local (&quot;inc-cache.php3&quot;); # ici c'est pour tester la connexion SQL
+
+// Ce fichier est celui d'une balise dynamique qui s'ignore.
+
+function formulaire_oubli_dyn($p, $oubli)
+{
+
+$message = '';
+
+// au 3e appel la variable P est positionnee par le script lui-meme
+// et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
+if ($p = addslashes($p)) {
+	$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut&lt;&gt;'5poubelle' AND pass&lt;&gt;''&quot;);
+	if (!$row = spip_fetch_array($res)) 
+		$message = _T('pass_erreur_code_inconnu');
+	else {
+		if ($oubli) {
+			$mdpass = md5($oubli);
+			$htpass = generer_htpass($oubli);
+			spip_query(&quot;UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
+				cookie_oubli='' WHERE cookie_oubli='$p'&quot;);
+
+			$login = $row['login'];
+			$message = &quot;&lt;b&gt;&quot; . _T('pass_nouveau_enregistre') . &quot;&lt;/b&gt;&quot;.
+			&quot;&lt;p&gt;&quot; . _T('pass_rappel_login', array('login' =&gt; $login));
+		}
+	}
+ } else { 
+  // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
+  if ($oubli) {
+	if ( email_valide($oubli) ) {
+		$email = addslashes($oubli);
+		$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE email ='$email'&quot;);
+		if ($row = spip_fetch_array($res)) {
+			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
+				$message = _T('pass_erreur_acces_refuse');
+			else {
+				$cookie = creer_uniqid();
+				spip_query(&quot;UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'&quot;);
+
+				if ( envoyer_mail($email,
+						 &quot;[&quot; . lire_meta(&quot;nom_site&quot;) .'] ' .  _T('pass_oubli_mot'),
+						 _T('pass_mail_passcookie',
+						    array('nom_site_spip' =&gt; lire_meta(&quot;nom_site&quot;),
+							  'adresse_site' =&gt; lire_meta(&quot;adresse_site&quot;), 
+							  'cookie' =&gt; $cookie))))
+					$message = _T('pass_recevoir_mail');
+				else
+					$message = _T('pass_erreur_probleme_technique');
+			}
+		}
+		else
+			$message = _T('pass_erreur_non_enregistre', array('email_oubli' =&gt; htmlspecialchars($oubli)));
+	} else {
+		$message = _T('pass_erreur_non_valide', array('email_oubli' =&gt; htmlspecialchars($oubli)));
+	}
+  }
+ }
+ return array('formulaire_oubli', 0, array('p' =&gt; $p, 'message' =&gt; $message));
+}
+
+install_debut_html(_T('pass_mot_oublie'));
+inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
+install_fin_html();
+?&gt;

Index: spip_redirect.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_redirect.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_redirect.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_redirect.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,44 +1,44 @@
-&lt;?php
-// redirige vers l'URL canonique de l'article,
-// en indiquant recalcul et previsu
-
-include (&quot;ecrire/inc_version.php3&quot;);
-
-// Gestionnaire d'URLs
-if (@file_exists(&quot;inc-urls.php3&quot;))
-	include_local(&quot;inc-urls.php3&quot;);
-else
-	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
-
-if ($id_article) {
-	$url = generer_url_article($id_article);
-}
-else if ($id_breve) {
-	$url = generer_url_breve($id_breve);
-}
-else if ($id_forum) {
-	$url = generer_url_forum($id_forum);
-}
-else if ($id_rubrique) {
-	$url = generer_url_rubrique($id_rubrique);
-}
-else if ($id_mot) {
-	$url = generer_url_mot($id_mot);
-}
-else if ($id_auteur) {
-	$url = generer_url_auteur($id_auteur);
-}
-else {
-	$url = _DIR_RESTREINT_ABS;
-}
-if (strpos($url,'?')) {
-	$super='&amp;';
-}
-else {
-	$super='?';
-}
-if ($recalcul) $url .= $super.&quot;var_mode=recalcul&quot;;
-else if ($preview) $url .= $super.&quot;var_preview=oui&quot;;
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at header</A>(&quot;Location: $url&quot;);
-
+&lt;?php
+// redirige vers l'URL canonique de l'article,
+// en indiquant recalcul et previsu
+
+include (&quot;ecrire/inc_version.php3&quot;);
+
+// Gestionnaire d'URLs
+if (@file_exists(&quot;inc-urls.php3&quot;))
+	include_local(&quot;inc-urls.php3&quot;);
+else
+	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
+
+if ($id_article) {
+	$url = generer_url_article($id_article);
+}
+else if ($id_breve) {
+	$url = generer_url_breve($id_breve);
+}
+else if ($id_forum) {
+	$url = generer_url_forum($id_forum);
+}
+else if ($id_rubrique) {
+	$url = generer_url_rubrique($id_rubrique);
+}
+else if ($id_mot) {
+	$url = generer_url_mot($id_mot);
+}
+else if ($id_auteur) {
+	$url = generer_url_auteur($id_auteur);
+}
+else {
+	$url = _DIR_RESTREINT_ABS;
+}
+if (strpos($url,'?')) {
+	$super='&amp;';
+}
+else {
+	$super='?';
+}
+if ($recalcul) $url .= $super.&quot;var_mode=recalcul&quot;;
+else if ($preview) $url .= $super.&quot;var_mode=preview&quot;;
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A>(&quot;Location: $url&quot;);
+
 ?&gt;

Index: spip_style.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_style.css,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_style.css	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_style.css	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,139 +1,139 @@
-a {
-	text-decoration: none;
-}
-
-a:hover {
-	color:#FF9900;
-	text-decoration: underline;
-}
-
-a.spip_url { }
-a.spip_in { }
-a.spip_out { }
-a.spip_glossaire { }
-
-.spip_code { }
-
-p.spip_note { }
-
-h3.spip {
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	font-weight: bold;
-	font-size: 120%;
-	text-align: center;
-	margin-top : 40px;
-	margin-bottom : 40px;
-	padding: 0em;
-}
-
-.spip_puce {
-	list-style-position: inside;
-}
-
-.spip_documents{
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	font-size : 70%;
-}
-
-
-table.spip {
-}
-
-table.spip tr.row_first {
-	background-color: #FCF4D0;
-}
-
-table.spip tr.row_odd {
-	background-color: #C0C0C0;
-}
-
-table.spip tr.row_even {
-	background-color: #F0F0F0;
-}
-
-table.spip td {
-	padding: 1px;
-	text-align: left;
-	vertical-align: middle;
-}
-
-hr.spip { }
-b.spip { }
-i.spip { }
-blockquote.spip {
-	margin-left : 40px;
-	margin-top : 10px;
-	margin-bottom : 10px;
-	margin-right: 0px;
-	border : solid 1px #aaaaaa;
-	background-color: #ffffff;
-	padding-left: 10px;
-	padding-right: 10px;
-}
-
-.forml { width: 100% ; background-color: #FFDDAA;}
-
-.spip_encadrer {
-	font-family: helvetica, arial, sans-serif;
-	width : 95%;
-	background-color: #FFFFFF;
-	padding: 5px;
-	border: 1px #666666 solid;
-}
-
-.spip_cadre {
-	width : 95%;
-	background-color: #FFFFFF;
-	padding: 5px;
-	margin-top: 10px;
-}
-
-div.spip_poesie {
-	margin-bottom: 5px;
-	margin-left: 10px;
-	padding-left: 10px;
-	border-left: 1px solid #999999;
-}
-div.spip_poesie div {
-	text-indent: -60px;
-	margin-left: 60px;
-}
-
-.spip_bouton { background-color: #FFCC00;}
-
-form.formrecherche { 
-	margin-top: 5px;
-	margin-bottom: 5px;
-}
-input.formrecherche {
-	width: 95%;
-	background-color: #FFDDAA;
-}
-
-.reponse_formulaire {
-	font-family: Verdana,Arial,Helvetica,sans-serif;
-	font-weight: bold;
-	font-size: 110%;
-	color: red;
-}
-
-.spip_surligne { background-color: #FFFF66; }
-
-
-/*
- * Barre de raccourcis
- */
-
-a.spip_barre img {
-	border-left: 1px solid #ffffff;
-	border-top: 1px solid #ffffff;
-	border-right: 1px solid #aa9966;
-	border-bottom: 1px solid #aa9966;
-	padding: 3px;
-	background-color: #FFDDAA;
-}
-a.spip_barre:hover img {
-	border: 1px solid #808080;
-	padding: 3px;
-	background-color: #f8f8f4;
-}
+a {
+	text-decoration: none;
+}
+
+a:hover {
+	color:#FF9900;
+	text-decoration: underline;
+}
+
+a.spip_url { }
+a.spip_in { }
+a.spip_out { }
+a.spip_glossaire { }
+
+.spip_code { }
+
+p.spip_note { }
+
+h3.spip {
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	font-weight: bold;
+	font-size: 120%;
+	text-align: center;
+	margin-top : 40px;
+	margin-bottom : 40px;
+	padding: 0em;
+}
+
+.spip_puce {
+	list-style-position: inside;
+}
+
+.spip_documents{
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	font-size : 70%;
+}
+
+
+table.spip {
+}
+
+table.spip tr.row_first {
+	background-color: #FCF4D0;
+}
+
+table.spip tr.row_odd {
+	background-color: #C0C0C0;
+}
+
+table.spip tr.row_even {
+	background-color: #F0F0F0;
+}
+
+table.spip td {
+	padding: 1px;
+	text-align: left;
+	vertical-align: middle;
+}
+
+hr.spip { }
+b.spip { }
+i.spip { }
+blockquote.spip {
+	margin-left : 40px;
+	margin-top : 10px;
+	margin-bottom : 10px;
+	margin-right: 0px;
+	border : solid 1px #aaaaaa;
+	background-color: #ffffff;
+	padding-left: 10px;
+	padding-right: 10px;
+}
+
+.forml { width: 100% ; background-color: #FFDDAA;}
+
+.spip_encadrer {
+	font-family: helvetica, arial, sans-serif;
+	width : 95%;
+	background-color: #FFFFFF;
+	padding: 5px;
+	border: 1px #666666 solid;
+}
+
+.spip_cadre {
+	width : 95%;
+	background-color: #FFFFFF;
+	padding: 5px;
+	margin-top: 10px;
+}
+
+div.spip_poesie {
+	margin-bottom: 5px;
+	margin-left: 10px;
+	padding-left: 10px;
+	border-left: 1px solid #999999;
+}
+div.spip_poesie div {
+	text-indent: -60px;
+	margin-left: 60px;
+}
+
+.spip_bouton { background-color: #FFCC00;}
+
+form.formrecherche { 
+	margin-top: 5px;
+	margin-bottom: 5px;
+}
+input.formrecherche {
+	width: 95%;
+	background-color: #FFDDAA;
+}
+
+.reponse_formulaire {
+	font-family: Verdana,Arial,Helvetica,sans-serif;
+	font-weight: bold;
+	font-size: 110%;
+	color: red;
+}
+
+.spip_surligne { background-color: #FFFF66; }
+
+
+/*
+ * Barre de raccourcis
+ */
+
+a.spip_barre img {
+	border-left: 1px solid #ffffff;
+	border-top: 1px solid #ffffff;
+	border-right: 1px solid #aa9966;
+	border-bottom: 1px solid #aa9966;
+	padding: 3px;
+	background-color: #FFDDAA;
+}
+a.spip_barre:hover img {
+	border: 1px solid #808080;
+	padding: 3px;
+	background-color: #f8f8f4;
+}

Index: spip_test_dirs.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_test_dirs.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_test_dirs.php3	13 Jan 2005 15:37:14 -0000	1.1
+++ spip_test_dirs.php3	8 Feb 2005 15:10:10 -0000	1.2
@@ -1,106 +1,106 @@
-&lt;?php
-if (defined(&quot;_TEST_DIRS&quot;)) return;
-define(&quot;_TEST_DIRS&quot;, &quot;1&quot;);
-
-include(&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_presentation.php3&quot;);
-
-utiliser_langue_visiteur();
-
-
-//
-// Tente d'ecrire
-//
-function test_ecrire($my_dir) {
-	$ok = true;
-	$nom_fich = &quot;$my_dir/test.txt&quot;;
-	$f = @fopen($nom_fich, &quot;w&quot;);
-	if (!$f) $ok = false;
-	else if (!@fclose($f)) $ok = false;
-	else if (!@unlink($nom_fich)) $ok = false;
-	return $ok;
-}
-
-//
-// teste les droits sur les repertoires $test_dirs declares dans inc_version
-//
-
-// rajouter celui passer dans l'url ou celui du source (a l'installation)
-
-if ($test_dir) {
-  if (!ereg(&quot;/$&quot;, $test_dir)) $test_dir .= '/';
-  if (!in_array($test_dir, $test_dirs)) $test_dirs[] = $test_dir;
- }
-else {
-	if (!_FILE_CONNECT)
-	  $test_dirs[] = dirname(_FILE_CONNECT_INS);
-}
-
-unset($bad_dirs);
-unset($absent_dirs);
-
-while (list(, $my_dir) = each($test_dirs)) {
-	if (!test_ecrire($my_dir)) {
-		@umask(0);
-		if (@file_exists($my_dir)) {
-			@chmod($my_dir, 0777);
-			// ???
-			if (!test_ecrire($my_dir))
-				@chmod($my_dir, 0775);
-			if (!test_ecrire($my_dir))
-				@chmod($my_dir, 0755);
-			if (!test_ecrire($my_dir))
-				$bad_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
-		} else
-			$absent_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
-	}
-}
-
-if ($bad_dirs OR $absent_dirs) {
-	install_debut_html();
-
-	if (!_FILE_CONNECT) {
-		$titre = _T('dirs_preliminaire');
-		$continuer = ' '._T('dirs_commencer');
-	} else
-		$titre = _T('dirs_probleme_droits');
-
-	$bad_url = &quot;spip_test_dirs.php3&quot;;
-	if ($test_dir) $bad_url .= '?test_dir='.$test_dir;
-
-	echo &quot;&lt;FONT FACE=\&quot;Verdana,Arial,Helvetica,sans-serif\&quot; SIZE=3&gt;$titre&lt;/FONT&gt;\n&lt;p&gt;&quot;;
-	echo &quot;&lt;div align='right'&gt;&quot;. menu_langues('var_lang_ecrire').&quot;&lt;/div&gt;\n&quot;;
-
-	if ($bad_dirs) {
-		echo &quot;&lt;p&gt;&quot;;
-		echo _T('dirs_repertoires_suivants',
-			array('bad_dirs' =&gt; join(&quot; &quot;, $bad_dirs)));
-		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
-	}
-
-	if ($absent_dirs) {
-		echo &quot;&lt;p&gt;&quot;;
-		echo _T('dirs_repertoires_absents',
-			array('bad_dirs' =&gt; join(&quot; &quot;, $absent_dirs)));
-		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
-	}
-
-	echo $continuer.'. ';
-	echo aide (&quot;install0&quot;);
-	echo &quot;&lt;p&gt;&quot;;
-
-	echo &quot;&lt;FORM ACTION='$bad_urls' METHOD='GET'&gt;\n&quot;;
-	echo &quot;&lt;DIV align='right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl' VALUE='&quot;. _T('login_recharger').&quot;'&gt;&lt;/DIV&gt;&quot;;
-	echo &quot;&lt;/FORM&gt;&quot;;
-
-	install_fin_html();
-
-} else {
-	if (!_FILE_CONNECT)
-		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS . &quot;install.php3?etape=1&quot;);
-	else
-		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS);
-}
-
-?&gt;
+&lt;?php
+if (defined(&quot;_TEST_DIRS&quot;)) return;
+define(&quot;_TEST_DIRS&quot;, &quot;1&quot;);
+
+include(&quot;ecrire/inc_version.php3&quot;);
+
+include_ecrire(&quot;inc_presentation.php3&quot;);
+
+utiliser_langue_visiteur();
+
+
+//
+// Tente d'ecrire
+//
+function test_ecrire($my_dir) {
+	$ok = true;
+	$nom_fich = &quot;$my_dir/test.txt&quot;;
+	$f = @fopen($nom_fich, &quot;w&quot;);
+	if (!$f) $ok = false;
+	else if (!@fclose($f)) $ok = false;
+	else if (!@unlink($nom_fich)) $ok = false;
+	return $ok;
+}
+
+//
+// teste les droits sur les repertoires $test_dirs declares dans inc_version
+//
+
+// rajouter celui passer dans l'url ou celui du source (a l'installation)
+
+if ($test_dir) {
+  if (!ereg(&quot;/$&quot;, $test_dir)) $test_dir .= '/';
+  if (!in_array($test_dir, $test_dirs)) $test_dirs[] = $test_dir;
+ }
+else {
+	if (!_FILE_CONNECT)
+	  $test_dirs[] = dirname(_FILE_CONNECT_INS);
+}
+
+unset($bad_dirs);
+unset($absent_dirs);
+
+while (list(, $my_dir) = each($test_dirs)) {
+	if (!test_ecrire($my_dir)) {
+		@umask(0);
+		if (@file_exists($my_dir)) {
+			@chmod($my_dir, 0777);
+			// ???
+			if (!test_ecrire($my_dir))
+				@chmod($my_dir, 0775);
+			if (!test_ecrire($my_dir))
+				@chmod($my_dir, 0755);
+			if (!test_ecrire($my_dir))
+				$bad_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
+		} else
+			$absent_dirs[] = &quot;&lt;LI&gt;&quot;.$my_dir;
+	}
+}
+
+if ($bad_dirs OR $absent_dirs) {
+	install_debut_html();
+
+	if (!_FILE_CONNECT) {
+		$titre = _T('dirs_preliminaire');
+		$continuer = ' '._T('dirs_commencer');
+	} else
+		$titre = _T('dirs_probleme_droits');
+
+	$bad_url = &quot;spip_test_dirs.php3&quot;;
+	if ($test_dir) $bad_url .= '?test_dir='.$test_dir;
+
+	echo &quot;&lt;FONT FACE=\&quot;Verdana,Arial,Helvetica,sans-serif\&quot; SIZE=3&gt;$titre&lt;/FONT&gt;\n&lt;p&gt;&quot;;
+	echo &quot;&lt;div align='right'&gt;&quot;. menu_langues('var_lang_ecrire').&quot;&lt;/div&gt;\n&quot;;
+
+	if ($bad_dirs) {
+		echo &quot;&lt;p&gt;&quot;;
+		echo _T('dirs_repertoires_suivants',
+			array('bad_dirs' =&gt; join(&quot; &quot;, $bad_dirs)));
+		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
+	}
+
+	if ($absent_dirs) {
+		echo &quot;&lt;p&gt;&quot;;
+		echo _T('dirs_repertoires_absents',
+			array('bad_dirs' =&gt; join(&quot; &quot;, $absent_dirs)));
+		echo &quot;&lt;B&gt;&quot;. _T('login_recharger').&quot;&lt;/b&gt;&quot;;
+	}
+
+	echo $continuer.'. ';
+	echo aide (&quot;install0&quot;);
+	echo &quot;&lt;p&gt;&quot;;
+
+	echo &quot;&lt;FORM ACTION='$bad_urls' METHOD='GET'&gt;\n&quot;;
+	echo &quot;&lt;DIV align='right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl' VALUE='&quot;. _T('login_recharger').&quot;'&gt;&lt;/DIV&gt;&quot;;
+	echo &quot;&lt;/FORM&gt;&quot;;
+
+	install_fin_html();
+
+} else {
+	if (!_FILE_CONNECT)
+		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS . &quot;install.php3?etape=1&quot;);
+	else
+		header(&quot;Location: &quot; . _DIR_RESTREINT_ABS);
+}
+
+?&gt;

Index: typographie.css
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/typographie.css,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- typographie.css	13 Jan 2005 15:37:14 -0000	1.1
+++ typographie.css	8 Feb 2005 15:10:11 -0000	1.2
@@ -1,100 +1,100 @@
-
-/*
- * Correction des styles HTML par defaut
- */
-
-.structure {
-	display: none;
-}
-h1,h2,h3,h4 {
-	margin-top: 0em;
-	margin-bottom: 0em;
-	font-size: 100%;
-	font-weight: normal;
-}
-
-/*
- * Styles generaux
- */
-
-/* bien regler la marge (bugs IE) */
-body { background: white; margin: 10px; }
-a { text-decoration: none; color: #505050; }
-a:hover { text-decoration: none; color: #303030; background: #e8e8e8; }
-a.spip_out { text-decoration: none; color: #a02020; }
-a.spip_in, a.spip_url { text-decoration: none; color: #2020a0; }
-a.spip_glossaire { text-decoration: none; color: #20a020; }
-
-.chapo {
-	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
-	font-weight: bold;
-	text-align: justify;
-	font-size: 105%;
-}
-.texte, .texte p.spip {
-	font-family: Georgia, Garamond, Times, serif;
-	text-align: justify;
-}
-.ps {
-	font-family: Georgia, Garamond, Times, serif;
-	text-align: justify;
-	font-size: 85%;
-}
-.notes {
-	font-family: Georgia, Garamond, Times, serif;
-	text-align: left;
-	font-size: 80%;
-}
-
-/*
- * Ici les styles pour le contenu
- */
-
-.contenu h1,h2 {
-	font-size: 120%;
-	font-weight: bold;
-}
-.contenu h1,h2.titre-extrait {
-	font-size: 160%;
-	font-weight: bold;
-}
-.contenu h1,h2.titre-texte {
-	font-size: 190%;
-	font-weight: bold;
-}
-.contenu .surtitre {
-	font-size: 110%;
-	font-weight: bold;
-	font-variant: small-caps;
-}
-.contenu .detail {
-	font-size: 80%;
-	color: #303030;
-}
-.extrait {
-	border: groove 2px #a0a0a0;
-	padding: 1em;
-	font-size: 85%;
-}
-
-
-/*
- * Disposition a l'ecran
- */
-
-#principal {
-	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
-}
-
-#plan {
-	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
-}
-
-#navigation {
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-}
-
-.encart {
-	font-family: Verdana, Arial, Helvetica, sans-serif;
-}
-
+
+/*
+ * Correction des styles HTML par defaut
+ */
+
+.structure {
+	display: none;
+}
+h1,h2,h3,h4 {
+	margin-top: 0em;
+	margin-bottom: 0em;
+	font-size: 100%;
+	font-weight: normal;
+}
+
+/*
+ * Styles generaux
+ */
+
+/* bien regler la marge (bugs IE) */
+body { background: white; margin: 10px; }
+a { text-decoration: none; color: #505050; }
+a:hover { text-decoration: none; color: #303030; background: #e8e8e8; }
+a.spip_out { text-decoration: none; color: #a02020; }
+a.spip_in, a.spip_url { text-decoration: none; color: #2020a0; }
+a.spip_glossaire { text-decoration: none; color: #20a020; }
+
+.chapo {
+	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
+	font-weight: bold;
+	text-align: justify;
+	font-size: 105%;
+}
+.texte, .texte p.spip {
+	font-family: Georgia, Garamond, Times, serif;
+	text-align: justify;
+}
+.ps {
+	font-family: Georgia, Garamond, Times, serif;
+	text-align: justify;
+	font-size: 85%;
+}
+.notes {
+	font-family: Georgia, Garamond, Times, serif;
+	text-align: left;
+	font-size: 80%;
+}
+
+/*
+ * Ici les styles pour le contenu
+ */
+
+.contenu h1,h2 {
+	font-size: 120%;
+	font-weight: bold;
+}
+.contenu h1,h2.titre-extrait {
+	font-size: 160%;
+	font-weight: bold;
+}
+.contenu h1,h2.titre-texte {
+	font-size: 190%;
+	font-weight: bold;
+}
+.contenu .surtitre {
+	font-size: 110%;
+	font-weight: bold;
+	font-variant: small-caps;
+}
+.contenu .detail {
+	font-size: 80%;
+	color: #303030;
+}
+.extrait {
+	border: groove 2px #a0a0a0;
+	padding: 1em;
+	font-size: 85%;
+}
+
+
+/*
+ * Disposition a l'ecran
+ */
+
+#principal {
+	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
+}
+
+#plan {
+	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
+}
+
+#navigation {
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+}
+
+.encart {
+	font-family: Verdana, Arial, Helvetica, sans-serif;
+}
+

--- .project DELETED ---

--- article-dist.html DELETED ---

--- auteur-dist.html DELETED ---

--- backend-breves-dist.html DELETED ---

--- backend-dist.html DELETED ---

--- breve-dist.html DELETED ---

--- carto-proto.sql DELETED ---

--- carto.html DELETED ---

--- distrib-dist.html DELETED ---

--- formulaire_admin-dist.html DELETED ---

--- formulaire_ecrire_auteur-dist.html DELETED ---

--- formulaire_forum-dist.html DELETED ---

--- formulaire_inscription-dist.html DELETED ---

--- formulaire_login-dist.html DELETED ---

--- formulaire_menu_lang-dist.html DELETED ---

--- formulaire_oubli-dist.html DELETED ---

--- formulaire_recherche-dist.html DELETED ---

--- formulaire_signature-dist.html DELETED ---

--- formulaire_site-dist.html DELETED ---

--- forum-dist.html DELETED ---

--- ical-dist.html DELETED ---

--- inc-chercher.php3 DELETED ---

--- inc-formulaire_admin.php3 DELETED ---

--- inc-formulaire_ecrire_auteur.php3 DELETED ---

--- inc-formulaire_forum.php3 DELETED ---

--- inc-formulaire_inscription.php3 DELETED ---

--- inc-formulaire_recherche.php3 DELETED ---

--- inc-formulaire_signature.php3 DELETED ---

--- inc-formulaire_site.php3 DELETED ---

--- inc-login_prive.php3 DELETED ---

--- inc-login_public.php3 DELETED ---

--- inc-menu_lang.php3 DELETED ---

--- inc-menu_lang_ecrire.php3 DELETED ---

--- inc-url_logout.php3 DELETED ---

--- login-dist.html DELETED ---

--- mot-dist.html DELETED ---

--- nouveautes-dist.html DELETED ---

--- plan-dist.html DELETED ---

--- project.index DELETED ---

--- recherche-dist.html DELETED ---

--- resume-dist.html DELETED ---

--- rubrique-dist.html DELETED ---

--- site-dist.html DELETED ---

--- sommaire-dist.html DELETED ---

--- sommaire_texte-dist.html DELETED ---

--- spipcarto.zip DELETED ---


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000069.html">[Spip-carto-cvs] spipcarto/dist - New directory
</A></li>
	<LI>Next message: <A HREF="000070.html">[Spip-carto-cvs] spipcarto/CACHE .cvsignore,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#76">[ date ]</a>
              <a href="thread.html#76">[ thread ]</a>
              <a href="subject.html#76">[ subject ]</a>
              <a href="author.html#76">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
