<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto/ecrire inc_optimiser.php3,NONE,1.1 presentation.js,NONE,1.1 inc_cron.php3,1.1,1.2 configuration.php3,1.1,1.2 inc_math.php3,1.1,1.2 inc_export.php3,1.1,1.2 inc_acces.php3,1.1,1.2 inc_logos.php3,1.1,1.2 statistiques_lang.php3,1.1,1.2 mots_tous.php3,1.1,1.2 carte_edit.php3,1.1,1.2 inc_visites.php3,1.1,1.2 md5.js,1.1,1.2 synchro.php3,1.1,1.2 inc_texte.php3,1.1,1.2 statistiques_referers.php3,1.1,1.2 import_all.php3,1.1,1.2 inc_surligne.php3,1.1,1.2 inc_presentation.php3,1.1,1.2 inc_tidy.php,1.1,1.2 iframe_action.php3,1.1,1.2 admin_vider.php3,1.1,1.2 naviguer.php3,1.1,1.2 inc_auth_spip.php3,1.1,1.2 articles.php3,1.1,1.2 upgrade.php3,1.1,1.2 calendrier_semaine.php3,1.1,1.2 auteurs_edit.php3,1.1,1.2 lang_raccourcis.php3,1.1,1.2 aide_index.php3,1.1,1.2 articles_forum.php3,1.1,1.2 inc_objet.php3,1.1,1.2 auteur_messagerie.php3,1.1,1.2 auteurs.php3,1.1,1.2 inc_flock.php3,1.1,1.2 admin_index.php3,1.1,1.2 inc_auxbase.php3,1.1,1.2 inc_db_mysql.php3,1.1,1.2 inc_lab.php,1.! 1,1.2 inc_suivi_revisions.php,1.1,1.2 articles_page.php3,1.1,1.2 delete_all.php3,1.1,1.2 inc_documents.php3,1.1,1.2 documents_liste.php3,1.1,1.2 calendrier.php3,1.1,1.2 inc_layer.php3,1.1,1.2 inc_rubriques.php3,1.1,1.2 inc_version.php3,1.1,1.2 inc_lang.php3,1.1,1.2 unpack.php3,1.1,1.2 sites_edit.php3,1.1,1.2 inc_extra.php3,1.1,1.2 inc_index.php3,1.1,1.2 forum.php3,1.1,1.2 controle_forum.php3,1.1,1.2 js_menu_rubriques.php,1.1,1.2 mes_options.php3,1.1,1.2 brouteur_frame.php3,1.1,1.2 messagerie.php3,1.1,1.2 inc_config_plug.php3,1.1,1.2 forum_envoi.php3,1.1,1.2 calendrier_jour.php3,1.1,1.2 inc_filtres.php3,1.1,1.2 admin_effacer.php3,1.1,1.2 inc_calendrier.php,1.1,1.2 inc_abstract_sql.php3,1.1,1.2 inc_base.php3,1.1,1.2 lab_revisions.php,1.1,1.2 inc_statistiques.php3,1.1,1.2 config-multilang.php3,1.1,1.2 inc_charsets.php3,1.1,1.2 articles_versions.php3,1.1,1.2 inc_forum.php3,1.1,1.2 inc_getdocument.php3,1.1,1.2 inc_mots.php3,1.1,1.2 message_edit.php3,1.1,1.2 sites_tous.php3,1.1,1! .2 admin_tech.php3,1.1,1.2 inc_mail.php3,1.1,1.2 inc.php3,1.1,1.2 conf
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-February/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/ecrire%20inc_optimiser.php3%2CNONE%2C1.1%20presentation.js%2CNONE%2C1.1%20inc_cron.php3%2C1.1%2C1.2%20configuration.php3%2C1.1%2C1.2%20inc_math.php3%2C1.1%2C1.2%20inc_export.php3%2C1.1%2C1.2%20inc_acces.php3%2C1.1%2C1.2%20inc_logos.php3%2C1.1%2C1.2%20statistiques_lang.php3%2C1.1%2C1.2%20mots_tous.php3%2C1.1%2C1.2%20carte_edit.php3%2C1.1%2C1.2%20inc_visites.php3%2C1.1%2C1.2%20md5.js%2C1.1%2C1.2%20synchro.php3%2C1.1%2C1.2%20inc_texte.php3%2C1.1%2C1.2%20statistiques_referers.php3%2C1.1%2C1.2%20import_all.php3%2C1.1%2C1.2%20inc_surligne.php3%2C1.1%2C1.2%20inc_presentation.php3%2C1.1%2C1.2%20inc_tidy.php%2C1.1%2C1.2%20iframe_action.php3%2C1.1%2C1.2%20admin_vider.php3%2C1.1%2C1.2%20naviguer.php3%2C1.1%2C1.2%20inc_auth_spip.php3%2C1.1%2C1.2%20articles.php3%2C1.1%2C1.2%20upgrade.php3%2C1.1%2C1.2%20calendrier_semaine.php3%2C1.1%2C1.2%20auteurs_edit.php3%2C1.1%2C1.2%20lang_raccourcis.php3%2C1.1%2C1.2%20aide_index.php3%2C1.1%2C1.2%20articles_forum.php3%2C1.1%2C1.2%20inc_objet.php3%2C1.1%2C1.2%20auteur_messagerie.php3%2C1.1%2C1.2%20auteurs.php3%2C1.1%2C1.2%20inc_flock.php3%2C1.1%2C1.2%20admin_index.php3%2C1.1%2C1.2%20inc_auxbase.php3%2C1.1%2C1.2%20inc_db_mysql.php3%2C1.1%2C1.2%20inc_lab.php%2C1.%21%0A%201%2C1.2%20inc_suivi_revisions.php%2C1.1%2C1.2%20articles_page.php3%2C1.1%2C1.2%20delete_all.php3%2C1.1%2C1.2%20inc_documents.php3%2C1.1%2C1.2%20documents_liste.php3%2C1.1%2C1.2%20calendrier.php3%2C1.1%2C1.2%20inc_layer.php3%2C1.1%2C1.2%20inc_rubriques.php3%2C1.1%2C1.2%20inc_version.php3%2C1.1%2C1.2%20inc_lang.php3%2C1.1%2C1.2%20unpack.php3%2C1.1%2C1.2%20sites_edit.php3%2C1.1%2C1.2%20inc_extra.php3%2C1.1%2C1.2%20inc_index.php3%2C1.1%2C1.2%20forum.php3%2C1.1%2C1.2%20controle_forum.php3%2C1.1%2C1.2%20js_menu_rubriques.php%2C1.1%2C1.2%20mes_options.php3%2C1.1%2C1.2%20brouteur_frame.php3%2C1.1%2C1.2%20messagerie.php3%2C1.1%2C1.2%20inc_config_plug.php3%2C1.1%2C1.2%20forum_envoi.php3%2C1.1%2C1.2%20calendrier_jour.php3%2C1.1%2C1.2%20inc_filtres.php3%2C1.1%2C1.2%20admin_effacer.php3%2C1.1%2C1.2%20inc_calendrier.php%2C1.1%2C1.2%20inc_abstract_sql.php3%2C1.1%2C1.2%20inc_base.php3%2C1.1%2C1.2%20lab_revisions.php%2C1.1%2C1.2%20inc_statistiques.php3%2C1.1%2C1.2%20config-multilang.php3%2C1.1%2C1.2%20inc_charsets.php3%2C1.1%2C1.2%20articles_versions.php3%2C1.1%2C1.2%20inc_forum.php3%2C1.1%2C1.2%20inc_getdocument.php3%2C1.1%2C1.2%20inc_mots.php3%2C1.1%2C1.2%20message_edit.php3%2C1.1%2C1.2%20sites_tous.php3%2C1.1%2C1%21%0A%20.2%20admin_tech.php3%2C1.1%2C1.2%20inc_mail.php3%2C1.1%2C1.2%20inc.php3%2C1.1%2C1.2%20conf&In-Reply-To=%3C200502202219.j1KMJS8Y027990%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000091.html">
   <LINK REL="Next"  HREF="000094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto/ecrire inc_optimiser.php3,NONE,1.1 presentation.js,NONE,1.1 inc_cron.php3,1.1,1.2 configuration.php3,1.1,1.2 inc_math.php3,1.1,1.2 inc_export.php3,1.1,1.2 inc_acces.php3,1.1,1.2 inc_logos.php3,1.1,1.2 statistiques_lang.php3,1.1,1.2 mots_tous.php3,1.1,1.2 carte_edit.php3,1.1,1.2 inc_visites.php3,1.1,1.2 md5.js,1.1,1.2 synchro.php3,1.1,1.2 inc_texte.php3,1.1,1.2 statistiques_referers.php3,1.1,1.2 import_all.php3,1.1,1.2 inc_surligne.php3,1.1,1.2 inc_presentation.php3,1.1,1.2 inc_tidy.php,1.1,1.2 iframe_action.php3,1.1,1.2 admin_vider.php3,1.1,1.2 naviguer.php3,1.1,1.2 inc_auth_spip.php3,1.1,1.2 articles.php3,1.1,1.2 upgrade.php3,1.1,1.2 calendrier_semaine.php3,1.1,1.2 auteurs_edit.php3,1.1,1.2 lang_raccourcis.php3,1.1,1.2 aide_index.php3,1.1,1.2 articles_forum.php3,1.1,1.2 inc_objet.php3,1.1,1.2 auteur_messagerie.php3,1.1,1.2 auteurs.php3,1.1,1.2 inc_flock.php3,1.1,1.2 admin_index.php3,1.1,1.2 inc_auxbase.php3,1.1,1.2 inc_db_mysql.php3,1.1,1.2 inc_lab.php,1.! 1,1.2 inc_suivi_revisions.php,1.1,1.2 articles_page.php3,1.1,1.2 delete_all.php3,1.1,1.2 inc_documents.php3,1.1,1.2 documents_liste.php3,1.1,1.2 calendrier.php3,1.1,1.2 inc_layer.php3,1.1,1.2 inc_rubriques.php3,1.1,1.2 inc_version.php3,1.1,1.2 inc_lang.php3,1.1,1.2 unpack.php3,1.1,1.2 sites_edit.php3,1.1,1.2 inc_extra.php3,1.1,1.2 inc_index.php3,1.1,1.2 forum.php3,1.1,1.2 controle_forum.php3,1.1,1.2 js_menu_rubriques.php,1.1,1.2 mes_options.php3,1.1,1.2 brouteur_frame.php3,1.1,1.2 messagerie.php3,1.1,1.2 inc_config_plug.php3,1.1,1.2 forum_envoi.php3,1.1,1.2 calendrier_jour.php3,1.1,1.2 inc_filtres.php3,1.1,1.2 admin_effacer.php3,1.1,1.2 inc_calendrier.php,1.1,1.2 inc_abstract_sql.php3,1.1,1.2 inc_base.php3,1.1,1.2 lab_revisions.php,1.1,1.2 inc_statistiques.php3,1.1,1.2 config-multilang.php3,1.1,1.2 inc_charsets.php3,1.1,1.2 articles_versions.php3,1.1,1.2 inc_forum.php3,1.1,1.2 inc_getdocument.php3,1.1,1.2 inc_mots.php3,1.1,1.2 message_edit.php3,1.1,1.2 sites_tous.php3,1.1,1! .2 admin_tech.php3,1.1,1.2 inc_mail.php3,1.1,1.2 inc.php3,1.1,1.2 conf</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/ecrire%20inc_optimiser.php3%2CNONE%2C1.1%20presentation.js%2CNONE%2C1.1%20inc_cron.php3%2C1.1%2C1.2%20configuration.php3%2C1.1%2C1.2%20inc_math.php3%2C1.1%2C1.2%20inc_export.php3%2C1.1%2C1.2%20inc_acces.php3%2C1.1%2C1.2%20inc_logos.php3%2C1.1%2C1.2%20statistiques_lang.php3%2C1.1%2C1.2%20mots_tous.php3%2C1.1%2C1.2%20carte_edit.php3%2C1.1%2C1.2%20inc_visites.php3%2C1.1%2C1.2%20md5.js%2C1.1%2C1.2%20synchro.php3%2C1.1%2C1.2%20inc_texte.php3%2C1.1%2C1.2%20statistiques_referers.php3%2C1.1%2C1.2%20import_all.php3%2C1.1%2C1.2%20inc_surligne.php3%2C1.1%2C1.2%20inc_presentation.php3%2C1.1%2C1.2%20inc_tidy.php%2C1.1%2C1.2%20iframe_action.php3%2C1.1%2C1.2%20admin_vider.php3%2C1.1%2C1.2%20naviguer.php3%2C1.1%2C1.2%20inc_auth_spip.php3%2C1.1%2C1.2%20articles.php3%2C1.1%2C1.2%20upgrade.php3%2C1.1%2C1.2%20calendrier_semaine.php3%2C1.1%2C1.2%20auteurs_edit.php3%2C1.1%2C1.2%20lang_raccourcis.php3%2C1.1%2C1.2%20aide_index.php3%2C1.1%2C1.2%20articles_forum.php3%2C1.1%2C1.2%20inc_objet.php3%2C1.1%2C1.2%20auteur_messagerie.php3%2C1.1%2C1.2%20auteurs.php3%2C1.1%2C1.2%20inc_flock.php3%2C1.1%2C1.2%20admin_index.php3%2C1.1%2C1.2%20inc_auxbase.php3%2C1.1%2C1.2%20inc_db_mysql.php3%2C1.1%2C1.2%20inc_lab.php%2C1.%21%0A%201%2C1.2%20inc_suivi_revisions.php%2C1.1%2C1.2%20articles_page.php3%2C1.1%2C1.2%20delete_all.php3%2C1.1%2C1.2%20inc_documents.php3%2C1.1%2C1.2%20documents_liste.php3%2C1.1%2C1.2%20calendrier.php3%2C1.1%2C1.2%20inc_layer.php3%2C1.1%2C1.2%20inc_rubriques.php3%2C1.1%2C1.2%20inc_version.php3%2C1.1%2C1.2%20inc_lang.php3%2C1.1%2C1.2%20unpack.php3%2C1.1%2C1.2%20sites_edit.php3%2C1.1%2C1.2%20inc_extra.php3%2C1.1%2C1.2%20inc_index.php3%2C1.1%2C1.2%20forum.php3%2C1.1%2C1.2%20controle_forum.php3%2C1.1%2C1.2%20js_menu_rubriques.php%2C1.1%2C1.2%20mes_options.php3%2C1.1%2C1.2%20brouteur_frame.php3%2C1.1%2C1.2%20messagerie.php3%2C1.1%2C1.2%20inc_config_plug.php3%2C1.1%2C1.2%20forum_envoi.php3%2C1.1%2C1.2%20calendrier_jour.php3%2C1.1%2C1.2%20inc_filtres.php3%2C1.1%2C1.2%20admin_effacer.php3%2C1.1%2C1.2%20inc_calendrier.php%2C1.1%2C1.2%20inc_abstract_sql.php3%2C1.1%2C1.2%20inc_base.php3%2C1.1%2C1.2%20lab_revisions.php%2C1.1%2C1.2%20inc_statistiques.php3%2C1.1%2C1.2%20config-multilang.php3%2C1.1%2C1.2%20inc_charsets.php3%2C1.1%2C1.2%20articles_versions.php3%2C1.1%2C1.2%20inc_forum.php3%2C1.1%2C1.2%20inc_getdocument.php3%2C1.1%2C1.2%20inc_mots.php3%2C1.1%2C1.2%20message_edit.php3%2C1.1%2C1.2%20sites_tous.php3%2C1.1%2C1%21%0A%20.2%20admin_tech.php3%2C1.1%2C1.2%20inc_mail.php3%2C1.1%2C1.2%20inc.php3%2C1.1%2C1.2%20conf&In-Reply-To=%3C200502202219.j1KMJS8Y027990%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto/ecrire inc_optimiser.php3,NONE,1.1 presentation.js,NONE,1.1 inc_cron.php3,1.1,1.2 configuration.php3,1.1,1.2 inc_math.php3,1.1,1.2 inc_export.php3,1.1,1.2 inc_acces.php3,1.1,1.2 inc_logos.php3,1.1,1.2 statistiques_lang.php3,1.1,1.2 mots_tous.php3,1.1,1.2 carte_edit.php3,1.1,1.2 inc_visites.php3,1.1,1.2 md5.js,1.1,1.2 synchro.php3,1.1,1.2 inc_texte.php3,1.1,1.2 statistiques_referers.php3,1.1,1.2 import_all.php3,1.1,1.2 inc_surligne.php3,1.1,1.2 inc_presentation.php3,1.1,1.2 inc_tidy.php,1.1,1.2 iframe_action.php3,1.1,1.2 admin_vider.php3,1.1,1.2 naviguer.php3,1.1,1.2 inc_auth_spip.php3,1.1,1.2 articles.php3,1.1,1.2 upgrade.php3,1.1,1.2 calendrier_semaine.php3,1.1,1.2 auteurs_edit.php3,1.1,1.2 lang_raccourcis.php3,1.1,1.2 aide_index.php3,1.1,1.2 articles_forum.php3,1.1,1.2 inc_objet.php3,1.1,1.2 auteur_messagerie.php3,1.1,1.2 auteurs.php3,1.1,1.2 inc_flock.php3,1.1,1.2 admin_index.php3,1.1,1.2 inc_auxbase.php3,1.1,1.2 inc_db_mysql.php3,1.1,1.2 inc_lab.php,1.! 1,1.2 inc_suivi_revisions.php,1.1,1.2 articles_page.php3,1.1,1.2 delete_all.php3,1.1,1.2 inc_documents.php3,1.1,1.2 documents_liste.php3,1.1,1.2 calendrier.php3,1.1,1.2 inc_layer.php3,1.1,1.2 inc_rubriques.php3,1.1,1.2 inc_version.php3,1.1,1.2 inc_lang.php3,1.1,1.2 unpack.php3,1.1,1.2 sites_edit.php3,1.1,1.2 inc_extra.php3,1.1,1.2 inc_index.php3,1.1,1.2 forum.php3,1.1,1.2 controle_forum.php3,1.1,1.2 js_menu_rubriques.php,1.1,1.2 mes_options.php3,1.1,1.2 brouteur_frame.php3,1.1,1.2 messagerie.php3,1.1,1.2 inc_config_plug.php3,1.1,1.2 forum_envoi.php3,1.1,1.2 calendrier_jour.php3,1.1,1.2 inc_filtres.php3,1.1,1.2 admin_effacer.php3,1.1,1.2 inc_calendrier.php,1.1,1.2 inc_abstract_sql.php3,1.1,1.2 inc_base.php3,1.1,1.2 lab_revisions.php,1.1,1.2 inc_statistiques.php3,1.1,1.2 config-multilang.php3,1.1,1.2 inc_charsets.php3,1.1,1.2 articles_versions.php3,1.1,1.2 inc_forum.php3,1.1,1.2 inc_getdocument.php3,1.1,1.2 inc_mots.php3,1.1,1.2 message_edit.php3,1.1,1.2 sites_tous.php3,1.1,1! .2 admin_tech.php3,1.1,1.2 inc_mail.php3,1.1,1.2 inc.php3,1.1,1.2 conf">stef at berlios.de
       </A><BR>
    <I>Sun Feb 20 23:19:28 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000091.html">[Spip-carto-cvs] spipcarto/ecrire accents.php3,1.1,1.2
</A></li>
        <LI>Next message: <A HREF="000094.html">[Spip-carto-cvs] spipcarto/ecrire http.class.php,1.1,1.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#93">[ date ]</a>
              <a href="thread.html#93">[ thread ]</a>
              <a href="subject.html#93">[ subject ]</a>
              <a href="author.html#93">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv27760/ecrire

Modified Files:
	inc_cron.php3 configuration.php3 inc_math.php3 inc_export.php3 
	inc_acces.php3 inc_logos.php3 statistiques_lang.php3 
	mots_tous.php3 carte_edit.php3 inc_visites.php3 md5.js 
	synchro.php3 inc_texte.php3 statistiques_referers.php3 
	import_all.php3 inc_surligne.php3 inc_presentation.php3 
	inc_tidy.php iframe_action.php3 admin_vider.php3 naviguer.php3 
	inc_auth_spip.php3 articles.php3 upgrade.php3 
	calendrier_semaine.php3 auteurs_edit.php3 lang_raccourcis.php3 
	aide_index.php3 articles_forum.php3 inc_objet.php3 
	auteur_messagerie.php3 auteurs.php3 inc_flock.php3 
	admin_index.php3 inc_auxbase.php3 inc_db_mysql.php3 
	inc_lab.php inc_suivi_revisions.php articles_page.php3 
	delete_all.php3 inc_documents.php3 documents_liste.php3 
	calendrier.php3 inc_layer.php3 inc_rubriques.php3 
	inc_version.php3 inc_lang.php3 unpack.php3 sites_edit.php3 
	inc_extra.php3 inc_index.php3 forum.php3 controle_forum.php3 
	js_menu_rubriques.php mes_options.php3 brouteur_frame.php3 
	messagerie.php3 inc_config_plug.php3 forum_envoi.php3 
	calendrier_jour.php3 inc_filtres.php3 admin_effacer.php3 
	inc_calendrier.php inc_abstract_sql.php3 inc_base.php3 
	lab_revisions.php inc_statistiques.php3 config-multilang.php3 
	inc_charsets.php3 articles_versions.php3 inc_forum.php3 
	inc_getdocument.php3 inc_mots.php3 message_edit.php3 
	sites_tous.php3 admin_tech.php3 inc_mail.php3 inc.php3 
	config-fonctions.php3 inc_urls.php3 statistiques_visites.php3 
	brouteur.php3 export.php3 forum_admin.php3 config-contenu.php3 
	inc_sites.php3 inc_popularites.php3 inc_serialbase.php3 
	articles_tous.php3 inc_barre.php3 export_all.php3 
	spip_style.php3 cartes.php3 inc_majbase.php3 inc_import.php3 
	inc_auth_ldap.php3 install.php3 suivi_revisions.php3 
	inc_invalideur.php3 info.php3 win_png.htc mots_edit.php3 
	pclzip.lib.php layer.js statistiques.php3 auteur_infos.php3 
	inc_debug_sql.php3 rubriques_edit.php3 articles_edit.php3 
	articles_ortho.php inc_carto.php3 breves_voir.php3 
	inc_session.php3 statistiques_svg.php3 admin_repair.php3 
	controle_petition.php3 inc_auth.php3 inc_meta.php3 sites.php3 
	breves.php3 breves_edit.php3 win_width.htc recherche.php3 
	inc_admin.php3 inc_config.php3 lab_diff.php index.php3 
	inc_objet_base.php3 message.php3 lab_ortho.php mots_type.php3 
	config-lang.php3 
Added Files:
	inc_optimiser.php3 presentation.js 
Log Message:
1.8pr1

--- NEW FILE: inc_optimiser.php3 ---
&lt;?php

/***************************************************************************\
 *  SPIP, Systeme de publication pour l'internet                           *
 *                                                                         *
 *  Copyright (c) 2001-2005                                                *
 *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
 *                                                                         *
 *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
 *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
\***************************************************************************/


//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_OPTIMISER&quot;)) return;
define(&quot;_ECRIRE_OPTIMISER&quot;, &quot;1&quot;);


function optimiser_base() {
	spip_log (&quot;optimisation de la base&quot;);

	$mydate = date(&quot;YmdHis&quot;, time() - 24 * 3600);

	//
	// Rubriques
	//

	$query = &quot;SELECT id_rubrique FROM spip_rubriques&quot;;
	$result = spip_query($query);
	$rubriques = '0';
	while ($row = spip_fetch_array($result)) $rubriques .= ','.$row['id_rubrique'];

	if ($rubriques) {
		$query = &quot;DELETE FROM spip_articles WHERE id_rubrique NOT IN ($rubriques) AND maj &lt; $mydate&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_breves WHERE id_rubrique NOT IN ($rubriques) AND maj &lt; $mydate&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_rubrique NOT IN (0,$rubriques)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_auteurs_rubriques WHERE id_rubrique NOT IN ($rubriques)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_documents_rubriques WHERE id_rubrique NOT IN ($rubriques)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_rubriques WHERE id_rubrique NOT IN ($rubriques)&quot;;
		spip_query($query);
	}


	//
	// Articles
	//

	$query = &quot;DELETE FROM spip_articles WHERE statut='poubelle' AND maj &lt; $mydate&quot;;
	spip_query($query);
	$query = &quot;SELECT id_article FROM spip_articles&quot;;
	$result = spip_query($query);
	$articles = '0';
	while ($row = spip_fetch_array($result)) $articles .= ','.$row['id_article'];

	if ($articles) {
		$query = &quot;DELETE FROM spip_auteurs_articles WHERE id_article NOT IN ($articles)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_documents_articles WHERE id_article NOT IN ($articles)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_articles WHERE id_article NOT IN ($articles)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_article NOT IN (0,$articles)&quot;;
		spip_query($query);
	}


	//
	// Breves
	//

	$query = &quot;DELETE FROM spip_breves WHERE statut='refuse' AND maj &lt; $mydate&quot;;
	spip_query($query);
	$breves = '0';
	$query = &quot;SELECT id_breve FROM spip_breves&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $breves .= ','.$row['id_breve'];

	if ($breves) {
		$query = &quot;DELETE FROM spip_documents_breves WHERE id_breve NOT IN ($breves)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_breves WHERE id_breve NOT IN ($breves)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_breve NOT IN (0,$breves)&quot;;
		spip_query($query);
	}


	//
	// Sites
	//

	$query = &quot;DELETE FROM spip_syndic WHERE maj &lt; $mydate AND statut = 'refuse'&quot;;
	spip_query($query);

	$syndic = '0';
	$query = &quot;SELECT id_syndic FROM spip_syndic&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $syndic .= ','.$row['id_syndic'];

	if ($syndic) {
		$query = &quot;DELETE FROM spip_syndic_articles WHERE id_syndic NOT IN (0,$syndic)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_syndic WHERE id_syndic NOT IN ($syndic)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_syndic NOT IN (0,$syndic)&quot;;
		spip_query($query);
	}


	//
	// Auteurs
	//

	$auteurs = '0';
	$query = &quot;SELECT id_auteur FROM spip_auteurs&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $auteurs .= ','.$row['id_auteur'];

	if ($auteurs) {
		$query = &quot;DELETE FROM spip_auteurs_articles WHERE id_auteur NOT IN ($auteurs)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_auteurs_messages WHERE id_auteur NOT IN ($auteurs)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_auteurs_rubriques WHERE id_auteur NOT IN ($auteurs)&quot;;
		spip_query($query);
	}

	$query = &quot;SELECT id_auteur,nom,email FROM spip_auteurs WHERE statut='5poubelle' AND maj &lt; $mydate&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$id_auteur = $row['id_auteur'];
		$nom = $row['nom'];
		$email = $row['email'];

		$query2 = &quot;SELECT * FROM spip_auteurs_articles WHERE id_auteur=$id_auteur&quot;;
		$result2 = spip_query($query2);
		if (!spip_num_rows($result2)) {
			$query3 = &quot;DELETE FROM spip_auteurs WHERE id_auteur=$id_auteur&quot;;
			$result3 = spip_query($query3);
			spip_log (&quot;suppression auteur $id_auteur ($nom, $email)&quot;);
		}
	}


	//
	// Messages prives
	//

	$query = &quot;SELECT m.id_message FROM spip_messages AS m, spip_auteurs_messages AS lien &quot;.
		&quot;WHERE m.id_message = lien.id_message GROUP BY m.id_message&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $messages[] = $row['id_message'];

	$query = &quot;SELECT id_message FROM spip_messages &quot;.
		&quot;WHERE type ='affich'&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $messages[] = $row['id_message'];

	if ($messages) {
		$messages = join(&quot;,&quot;, $messages);

		$query = &quot;DELETE FROM spip_messages WHERE id_message NOT IN ($messages)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_message NOT IN (0,$messages)&quot;;
		spip_query($query);
	}


	//
	// Mots-cles
	//

	$query = &quot;DELETE FROM spip_mots WHERE titre='' AND maj &lt; $mydate&quot;;
	$result = spip_query($query);

	$mots = '0';
	$query = &quot;SELECT id_mot FROM spip_mots&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $mots .= ','.$row['id_mot'];

	if ($mots) {
		$query = &quot;DELETE FROM spip_mots_articles WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_breves WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_forum WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_rubriques WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_syndic WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
	}


	//
	// Forums
	//

	$query = &quot;DELETE FROM spip_forum WHERE statut='redac' AND maj &lt; $mydate&quot;;
	spip_query($query);

	$forums = '0';
	$query = &quot;SELECT id_forum FROM spip_forum&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $forums .= ','.$row[0];

	if ($forums) {
		$query = &quot;DELETE FROM spip_forum WHERE id_parent NOT IN (0,$forums)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_forum WHERE id_forum NOT IN ($forums)&quot;;
		spip_query($query);
	}


	//
	// Indexation
	//

	// les objets inutiles
	$types = array('article','auteur','breve','mot','rubrique','forum','signature','syndic');
	while (list(,$type) = each($types)) {
		$table_objet = 'spip_'.table_objet($type);
		$table_index = 'spip_index_'.table_objet($type);
		
		// limiter aux objets publies
		switch ($type) {
			case 'article':
			case 'breve':
			case 'rubrique':
			case 'syndic':
			case 'forum':
			case 'signature':
				$critere = &quot;AND statut&lt;&gt;'publie'&quot;;
				break;
			case 'auteur':
				$critere = &quot;AND statut NOT IN ('0minirezo', '1comite')&quot;;
				break;
			case 'mot':
			default:
				$critere = 'AND 1=0';	// ne jamais desindexer un mot
				break;
		}

		spip_query(&quot;UPDATE $table_objet SET idx='' WHERE idx&lt;&gt;'non' $critere&quot;);

		$suppr = '';
		$s = spip_query(&quot;SELECT id_$type FROM $table_objet WHERE idx='' $critere&quot;);
		while ($t = spip_fetch_array($s))
			$suppr .= ','.$t[0];
		$s = spip_query(&quot;SELECT id_$type FROM $table_objet WHERE idx='non'&quot;);
		while ($t = spip_fetch_array($s))
			$suppr .= ','.$t[0];
		if ($suppr)
			spip_query(&quot;DELETE FROM $table_index WHERE id_$type IN (0$suppr)&quot;);
	}

	//
	// MySQL
	//
	if ($GLOBALS['table_prefix']) $table_pref = $GLOBALS['table_prefix'].&quot;_&quot;;
	else $table_pref = &quot;&quot;;

	$query = &quot;SHOW TABLES LIKE '$table_pref%'&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $tables[] = $row[0];

	if ($tables) {
		$tables = join(&quot;,&quot;, $tables);
		$query = &quot;OPTIMIZE TABLE &quot;.$tables;
		spip_query($query);
	}

	spip_log(&quot;optimisation ok&quot;);
}

	## debug
	if ($GLOBALS['auteur_session']['statut'] == '0minirezo'
	AND $_GET['optimiser'] == 'oui')
		optimiser_base();

?&gt;

--- NEW FILE: presentation.js ---
var init_gauche = true;

function changestyle(id_couche, element, style) {

  if (admin) {
		hide_obj(&quot;bandeaudocuments&quot;);
		hide_obj(&quot;bandeauredacteurs&quot;);
		hide_obj(&quot;bandeauauteurs&quot;);
		if (stat) {  hide_obj(&quot;bandeausuivi&quot;); } 
		hide_obj(&quot;bandeauadministration&quot;); 
  }
	hide_obj(&quot;bandeaudeconnecter&quot;);
	hide_obj(&quot;bandeautoutsite&quot;);
	hide_obj(&quot;bandeaunavrapide&quot;);
	hide_obj(&quot;bandeauagenda&quot;);
	hide_obj(&quot;bandeaumessagerie&quot;);
	hide_obj(&quot;bandeausynchro&quot;);
	hide_obj(&quot;bandeaurecherche&quot;);
	hide_obj(&quot;bandeauinfoperso&quot;);
	hide_obj(&quot;bandeaudisplay&quot;);
	hide_obj(&quot;bandeauecran&quot;);
	hide_obj(&quot;bandeauinterface&quot;);
	
	
	if (init_gauche) {
	   if (admin) {
		decalerCouche('bandeaudocuments');
		decalerCouche('bandeauredacteurs');
		decalerCouche('bandeauauteurs');
		if (stat) decalerCouche('bandeausuivi');
		decalerCouche('bandeauadministration');
		} 
		init_gauche = false;
	}
	
	
	if (!(layer = findObj(id_couche))) return;

	layer.style[element] = style;
}

function decalerCouche(id_couche) {
	if (!(layer = findObj(id_couche))) return;
	if (bug_offsetwidth &amp;&amp; ( parseInt(layer.style.left) &gt; 0)) {

		gauche = parseInt(layer.style.left)
		  - Math.floor( layer.offsetWidth / 2 )
		  + Math.floor(largeur_icone / 2);
		if (gauche &lt; 0) gauche = 0;

		layer.style.left = gauche+&quot;px&quot;;
	}

}	

var accepter_change_statut;
	
function selec_statut(id, type, decal, puce, statut) {

	if (!accepter_change_statut) {
	  accepter_change_statut = confirm(confirm_changer_statut)
	}

	if (accepter_change_statut) {
		changestyle ('statutdecal'+type+id, 'marginLeft', decal+'px');
		cacher ('statutdecal'+type+id);

		findObj('imgstatut'+type+id).src = puce;
		frames['iframe_action'].location.href = 
  'iframe_action.php3?action=statut_'+ type +'&amp;id='+id+'&amp;statut='+statut;

	}
}

function changeclass(objet, myClass)
{
		objet.className = myClass;
}
function changesurvol(iddiv, myClass)
{
		document.getElementById(iddiv).className = myClass;
}
function setActiveStyleSheet(title) {
   var i, a, main;
   for(i=0; (a = document.getElementsByTagName(&quot;link&quot;)[i]); i++) {
	 if(a.getAttribute(&quot;rel&quot;).indexOf(&quot;style&quot;) != -1
		&amp;&amp; a.getAttribute(&quot;title&quot;)) {
	   a.disabled = true;
	   if(a.getAttribute(&quot;title&quot;) == title) a.disabled = false;
	 }
   }
}

function setvisibility (objet, statut) {
	element = findObj(objet);
	if (element.style.visibility != statut) element.style.visibility = statut;
}

function montrer(objet) {
	setvisibility(objet, 'visible');
}
function cacher(objet) {
	setvisibility(objet, 'hidden');
}



function getHeight(obj) {
	if (obj == &quot;window&quot;) {
		return hauteur_fenetre();
	}
	else
	{
		obj = document.getElementById(obj);
		if (obj.offsetHeight) return obj.offsetHeight;
	}
}
function hauteur_fenetre() {
	var myWidth = 0, myHeight = 0;
	if( typeof( window.innerWidth ) == 'number' ) {
		//Non-IE
		myHeight = window.innerHeight;
	} else {
		if( document.documentElement &amp;&amp;
			( document.documentElement.clientWidth || document.documentElement.clientHeight ) ) {
			//IE 6+ in 'standards compliant mode'
			myHeight = document.documentElement.clientHeight;
		} else {
			if( document.body &amp;&amp; ( document.body.clientWidth || document.body.clientHeight ) ) {
				//IE 4 compatible
				myHeight = document.body.clientHeight;
			}
		}
	}
	return myHeight;
}


function hauteurFrame(nbCol) {
	hauteur = hauteur_fenetre() - 40;
	hauteur = hauteur - getHeight('haut-page');
	
	if (findObj('brouteur_hierarchie')) hauteur = hauteur - getHeight('brouteur_hierarchie');
		
	for (i=0; i&lt;nbCol; i++) {
		source = document.getElementById(&quot;iframe&quot; + i);
		source.style.height = hauteur + 'px';
	}
}

function hauteurTextarea() {
	hauteur = hauteur_fenetre() - 80;
	
	source = document.getElementById(&quot;text_area&quot;);
	source.style.height = hauteur + 'px';
}

function changeVisible(input, id, select, nonselect) {
	if (input) {
		element = findObj(id);
		if (element.style.display != select)  element.style.display = select;
	} else {
		element = findObj(id);
		if (element.style.display != nonselect)  element.style.display = nonselect;
	}
	
}





// pour MOzilla &gt;= 1.7
function verifForm() {
	/* if (pluginlist.indexOf(&quot;SVG&quot;)!=-1)
		document.cookie = &quot;spip_svg_plugin=oui&quot;;
	else
		document.cookie = &quot;spip_svg_plugin=non&quot;;
	*/

	//convert2math();

	retrait = 16;
	var obj=document.getElementsByTagName(&quot;input&quot;);
	for(i=0;i&lt;obj.length;i++) {
		if(obj[i].className==&quot;forml&quot; || obj[i].className==&quot;formo&quot;) {
			element = obj[i];
			if (element.offsetWidth) {
				obj[i][&quot;nouvelle-largeur&quot;] = (element.offsetWidth - retrait) + &quot;px&quot;;
			} else {
				obj[i][&quot;nouvelle-largeur&quot;] = &quot;95%&quot;;
			}
		}
	}
	
	var objx=document.getElementsByTagName(&quot;textarea&quot;);
	for(i=0;i&lt;objx.length;i++) {
		if(objx[i].className==&quot;forml&quot; || objx[i].className==&quot;formo&quot;) {
			element = objx[i];
			if (element.offsetWidth) {
				objx[i][&quot;nouvelle-largeur&quot;] = (element.offsetWidth - retrait) + &quot;px&quot;;
			} else {
				objx[i][&quot;nouvelle-largeur&quot;] = &quot;95%&quot;;
			}
		}
	}
	
	// Appliquer les modifs apres les calculs, sinon des decalages peuvent apparaitre
	for(i=0;i&lt;obj.length;i++) {
		if (obj[i][&quot;nouvelle-largeur&quot;]) obj[i].style.width = obj[i][&quot;nouvelle-largeur&quot;];
	}

	for(i=0;i&lt;objx.length;i++) {
		if (objx[i][&quot;nouvelle-largeur&quot;]) objx[i].style.width = objx[i][&quot;nouvelle-largeur&quot;];
	}
}


// effacement titre quand new=oui
var antifocus=false;
// effacement titre des groupes de mots-cles de plus de 50 mots
var antifocus_mots = new Array();

Index: inc_cron.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_cron.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_cron.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_cron.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_CRON&quot;)) return;
 define(&quot;_ECRIRE_INC_CRON&quot;, &quot;1&quot;);
@@ -52,7 +63,7 @@
 
 	include(_FILE_CONNECT);
 	if (!$GLOBALS['db_ok']) {
-		@touch(_FILE_MYSQL_OUT);
+		spip_touch(_FILE_MYSQL_OUT);
 		spip_log('pas de connexion DB pour taches de fond (cron)');
 		return;
 	}
@@ -65,10 +76,9 @@
 	foreach ($taches as $tache) {
 		$lock = _DIR_SESSIONS . $tache . '.lock';
 		clearstatcache();
-		$last = (@file_exists($lock) ? filemtime($lock) : 0);
+		$last = @filemtime($lock);
 
-		if (($t - $frequence_taches[$tache]) &gt; $last) {
-			@touch($lock);
+		if (spip_touch($lock, $frequence_taches[$tache])) {
 			spip_timer('tache');
 			include_ecrire('inc_' . $tache . _EXTENSION_PHP);
 			$fonction = 'cron_' . $tache;
@@ -76,6 +86,7 @@
 			if ($code_de_retour) {
 				$msg = &quot;cron: $tache&quot;;
 				if ($code_de_retour &lt; 0) {
+					# modifier la date du fichier
 					@touch($lock, (0 - $code_de_retour));
 					spip_log($msg . &quot; (en cours, &quot; . spip_timer('tache') .&quot;)&quot;);
 					spip_timer('tache');
@@ -92,20 +103,24 @@
 // Certaines ne sont pas activables de l'espace prive. A revoir.
 
 function taches_generales() {
+	$taches_generales = array();
 
-  // MAJ des rubriques publiques (cas de la publication post-datee)
+	// MAJ des rubriques publiques (cas de la publication post-datee)
+	$taches_generales[] = 'rubriques';
 
-	$taches_generales = array('rubriques');
-	
-  // cache
+	// Optimisation de la base
+	$taches_generales[] = 'optimiser';
+
+	// cache
 	if (_DIR_RESTREINT)
 	  $taches_generales[]= 'invalideur';
 
 	// nouveautes
-	if (lire_meta('adresse_neuf') AND lire_meta('jours_neuf') AND (lire_meta('quoi_de_neuf') == 'oui') AND _DIR_RESTREINT)
+	if (lire_meta('adresse_neuf') AND lire_meta('jours_neuf')
+	AND (lire_meta('quoi_de_neuf') == 'oui') AND _DIR_RESTREINT)
 		$taches_generales[]= 'mail';
 
-// Stat. Attention: la popularite DOIT preceder les visites
+	// Stat. Attention: la popularite DOIT preceder les visites
 	if (lire_meta(&quot;activer_statistiques&quot;) == &quot;oui&quot;) {
 		$taches_generales[]= 'statistiques';
 		$taches_generales[]= 'popularites';
@@ -138,7 +153,8 @@
 			  'rubriques' =&gt; 3600,
 			  'popularites' =&gt; 1800,
 			  'sites' =&gt; 90,
-			  'index' =&gt; 60
+			  'index' =&gt; 60,
+			  'optimiser' =&gt; 3600 * 48
 );
 
 // Fonctions effectivement appelees.
@@ -146,6 +162,11 @@
 
 function cron_rubriques($t) {
 	calculer_rubriques();
+	return 1;
+}
+
+function cron_optimiser($t) {
+	optimiser_base ();
 	return 1;
 }
 

Index: configuration.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/configuration.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- configuration.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ configuration.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,30 +1,17 @@
 &lt;?php
 
-include (&quot;inc.php3&quot;);
-
-include_ecrire (&quot;inc_config.php3&quot;);
-
-function mySel($varaut,$variable){
-		$retour= &quot; VALUE=\&quot;$varaut\&quot;&quot;;
-
-	if ($variable==$varaut){
-		$retour.= &quot; SELECTED&quot;;
-	}
-
-	return $retour;
-}
-
-
-debut_page(_T('titre_page_configuration'), &quot;administration&quot;, &quot;configuration&quot;);
-
-echo &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;
-gros_titre(_T('titre_configuration'));
-barre_onglets(&quot;configuration&quot;, &quot;contenu&quot;);
-
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
 
-debut_gauche();
 
-debut_droite();
+include (&quot;inc.php3&quot;);
 
 if ($connect_statut != '0minirezo' OR !$connect_toutes_rubriques) {
 	echo _T('avis_non_acces_page');
@@ -37,6 +24,7 @@
 // Modifications
 //
 
+include_ecrire (&quot;inc_config.php3&quot;);
 init_config();
 if ($changer_config == 'oui') {
 	appliquer_modifs_config();
@@ -50,6 +38,29 @@
 }
 
 lire_metas();
+
+
+function mySel($varaut,$variable){
+		$retour= &quot; VALUE=\&quot;$varaut\&quot;&quot;;
+
+	if ($variable==$varaut){
+		$retour.= &quot; SELECTED&quot;;
+	}
+
+	return $retour;
+}
+
+
+debut_page(_T('titre_page_configuration'), &quot;administration&quot;, &quot;configuration&quot;);
+
+echo &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;
+gros_titre(_T('titre_configuration'));
+barre_onglets(&quot;configuration&quot;, &quot;contenu&quot;);
+
+
+debut_gauche();
+
+debut_droite();
 
 avertissement_config();
 

Index: inc_math.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_math.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_math.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_math.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_MATH&quot;)) return;

Index: inc_export.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_export.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_export.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_export.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_EXPORT&quot;)) return;

Index: inc_acces.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_acces.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_acces.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_acces.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_ACCES&quot;)) return;
@@ -63,6 +74,7 @@
 }
 
 function effacer_low_sec($id_auteur) {
+	if (!$id_auteur = intval($id_auteur)) return; // jamais trop prudent ;)
 	spip_query(&quot;UPDATE spip_auteurs SET low_sec = '' WHERE id_auteur = $id_auteur&quot;);
 }
 
@@ -139,7 +151,7 @@
 		if ($GLOBALS['hebergeur'] != 'nexenservices'){
 			if (!$f = fopen($htaccess, &quot;w&quot;))
 				echo &quot;&lt;b&gt;&quot; .
-				  _L(&quot;ECHEC DE LA CREATION DE $htaccess&quot;) .
+				  &quot;ECHEC DE LA CREATION DE $htaccess&quot; . # ne pas traduire
 				  &quot;&lt;/b&gt;&quot;;
 			else
 			  {

Index: inc_logos.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_logos.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_logos.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_logos.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_LOGOS&quot;)) return;
@@ -78,22 +89,25 @@
 }
 
 
-function afficher_boite_logo($logo, $survol, $texteon, $texteoff) {
+
+function afficher_boite_logo($type, $id_objet, $id, $texteon, $texteoff) {
 	global $options, $spip_display;
 
+	$logon = $type.'on'.$id;
+	$logoff = $type.'off'.$id;
 
 	if ($spip_display != 4) {
 	
 		echo &quot;&lt;p&gt;&quot;;
 		debut_cadre_relief(&quot;image-24.gif&quot;);
 		echo &quot;&lt;div class='verdana1' style='text-align: center;'&gt;&quot;;
-		$desc = decrire_logo($logo);
-		afficher_logo($logo, $texteon, $desc);
+		$desc = decrire_logo($logon);
+		afficher_logo($logon, $texteon, $desc, $id_objet, $id);
 
-		if ($desc) {
+		if ($desc AND $texteoff) {
 			echo &quot;&lt;br /&gt;&lt;br /&gt;&quot;;
-			$desc = decrire_logo($survol);
-			afficher_logo($survol, $texteoff, $desc);   
+			$desc = decrire_logo($logoff);
+			afficher_logo($logoff, $texteoff, $desc, $id_objet, $id);
 		}
 	
 		echo &quot;&lt;/div&gt;&quot;;
@@ -103,8 +117,8 @@
 }
 
 
-function afficher_logo($racine, $titre, $logo) {
-	global $id_article, $id_rubrique, $id_breve, $id_auteur, $id_mot, $id_syndic, $connect_id_auteur;
+function afficher_logo($racine, $titre, $logo, $id_objet, $id) {
+	global $connect_id_auteur;
 	global $couleur_foncee, $couleur_claire;
 	global $clean_link;
 
@@ -120,34 +134,25 @@
 
 	if ($logo) {
 		list($fichier, $taille, $img) =  $logo;
-		$hash = calculer_action_auteur(&quot;supp_image $fichier&quot;);
+		$hash = calculer_action_auteur(&quot;supp_logo $fichier&quot;);
 
 		echo &quot;&lt;p&gt;&lt;center&gt;&lt;div&gt;$img&lt;/div&gt;&quot;;
 		echo debut_block_invisible(md5($titre));
 		echo $taille;
 		echo &quot;\n&lt;br /&gt;[&lt;a href='../spip_image.php3?&quot;;
-		$elements = array('id_article', 'id_breve', 'id_syndic', 'id_rubrique', 'id_mot', 'id_auteur');
-		while (list(,$element) = each ($elements)) {
-			if ($$element) {
-				echo $element.'='.$$element.'&amp;';
-			}
-		}
-		echo &quot;image_supp=$fichier&amp;hash_id_auteur=$connect_id_auteur&amp;id_auteur=$id_auteur&amp;hash=$hash&amp;redirect=$redirect'&gt;&quot;._T('lien_supprimer').&quot;&lt;/A&gt;]&quot;;
+		echo &quot;$id_objet=$id&amp;&quot;;
+		echo &quot;image_supp=$fichier&amp;hash_id_auteur=$connect_id_auteur&amp;hash=$hash&amp;redirect=$redirect'&gt;&quot;._T('lien_supprimer').&quot;&lt;/A&gt;]&quot;;
 		echo fin_block();
 		echo &quot;&lt;/center&gt;&lt;/p&gt;&quot;;
 	}
 	else {
-		$hash = calculer_action_auteur(&quot;ajout_image $racine&quot;);
+		$hash = calculer_action_auteur(&quot;ajout_logo $racine&quot;);
 		echo debut_block_invisible(md5($titre));
 
-		echo &quot;\n\n&lt;FORM ACTION='../spip_image.php3' METHOD='POST' ENCTYPE='multipart/form-data'&gt;&quot;;
+		echo &quot;\n\n&lt;FORM ACTION='../spip_image.php3' METHOD='POST'
+			ENCTYPE='multipart/form-data'&gt;&quot;;
 		echo &quot;\n&lt;INPUT NAME='redirect' TYPE=Hidden VALUE='$redirect'&gt;&quot;;
-		if ($id_auteur &gt; 0) echo &quot;\n&lt;INPUT NAME='id_auteur' TYPE=Hidden VALUE='$id_auteur'&gt;&quot;;
-		if ($id_article &gt; 0) echo &quot;\n&lt;INPUT NAME='id_article' TYPE=Hidden VALUE='$id_article'&gt;&quot;;
-		if ($id_breve &gt; 0) echo &quot;\n&lt;INPUT NAME='id_breve' TYPE=Hidden VALUE='$id_breve'&gt;&quot;;
-		if ($id_mot &gt; 0) echo &quot;\n&lt;INPUT NAME='id_mot' TYPE=Hidden VALUE='$id_mot'&gt;&quot;;
-		if ($id_syndic &gt; 0) echo &quot;\n&lt;INPUT NAME='id_syndic' TYPE=Hidden VALUE='$id_syndic'&gt;&quot;;
-		if ($id_rubrique &gt; 0) echo &quot;\n&lt;INPUT NAME='id_rubrique' TYPE=Hidden VALUE='$id_rubrique'&gt;&quot;;
+		echo &quot;\n&lt;INPUT NAME='$id_objet' TYPE=Hidden VALUE='$id'&gt;&quot;;
 		echo &quot;\n&lt;INPUT NAME='hash_id_auteur' TYPE=Hidden VALUE='$connect_id_auteur'&gt;&quot;;
 		echo &quot;\n&lt;INPUT NAME='hash' TYPE=Hidden VALUE='$hash'&gt;&quot;;
 		echo &quot;\n&lt;INPUT NAME='ajout_logo' TYPE=Hidden VALUE='oui'&gt;&quot;;
@@ -211,8 +216,8 @@
 	return array (ceil($destWidth), ceil($destHeight));
 }
 
-function creer_vignette($image, $maxWidth, $maxHeight, $format, $destdir, $destfile, $process='AUTO', $force=false) {
-	global $convert_command, $djpeg_command, $cjpeg_command, $pnmscale_command;
+function creer_vignette($image, $maxWidth, $maxHeight, $format, $destdir, $destfile, $process='AUTO', $force=false, $test_cache_only = false) {
+	global $convert_command, $pnmscale_command;
 	// ordre de preference des formats graphiques pour creer les vignettes
 	// le premier format disponible, selon la methode demandee, est utilise
 	if ($format == 'png')
@@ -241,8 +246,11 @@
 			$vignette = $destination.'.'.$fmt;
 			if ($force) @unlink($vignette);
 		}
-		
+
+	if ($test_cache_only AND !$vignette) return;
+
 	// utiliser le cache ?
+	if (!$test_cache_only)
 	if ($force OR !$vignette OR (@filemtime($vignette) &lt; @filemtime($image))) {
 
 		$creation = true;
@@ -333,6 +341,8 @@
 			// Choisir le format destination
 			// - on sauve de preference en JPEG (meilleure compression)
 			// - pour le GIF : les GD recentes peuvent le lire mais pas l'ecrire
+			# bug : gd_formats contient la liste des fichiers qu'on sait *lire*,
+			# pas *ecrire*
 			$gd_formats = lire_meta(&quot;gd_formats&quot;);
 			foreach ($formats_sortie as $fmt) {
 				if (ereg($fmt, $gd_formats)) {
@@ -395,22 +405,24 @@
 	$hauteur = $size[1];
 	$type = $size[2];
 
-	if ($type == &quot;2&quot;) $format = 1;
+	if ($type == &quot;2&quot;) $format = 1;			# spip_types_documents
 	else if ($type == &quot;3&quot;) $format = 2;
 	else if ($type == &quot;1&quot;) $format = 3;
+	else return;
 
 	$vignette = str_replace('../', '', $vignette);
 
 	spip_log(&quot;creation vignette($image) -&gt; $vignette&quot;);
 
-	if ($t = spip_query(&quot;SELECT id_document FROM spip_documents WHERE fichier='&quot;.addslashes($image).&quot;'&quot;))
-	{
+	if ($t = spip_query(&quot;SELECT id_document FROM spip_documents
+	WHERE fichier='&quot;.addslashes($image).&quot;'&quot;)) {
 		if ($row = spip_fetch_array($t)) {
 			$id_document = $row['id_document'];
-			$id_vignette = spip_abstract_insert(&quot;documents&quot;, 
-						   &quot;(mode)&quot;,
-						   &quot;('vignette')&quot;);
-			spip_query(&quot;UPDATE spip_documents SET id_vignette=$id_vignette WHERE id_document=$id_document&quot;);
+			$id_vignette = spip_abstract_insert(&quot;spip_documents&quot;, 
+				&quot;(mode)&quot;,
+				&quot;('vignette')&quot;);
+			spip_query(&quot;UPDATE spip_documents
+				SET id_vignette=$id_vignette WHERE id_document=$id_document&quot;);
 			spip_query(&quot;UPDATE spip_documents SET
 				id_type = '$format',
 				largeur = '$largeur',
@@ -434,11 +446,11 @@
 	if (!$taille_y)
 		$taille_y = $taille;
 
-	// recuperer le nom du fichier (est-ce encore utilise ?)
-	if (eregi(&quot;src=\'([^']+)\'&quot;, $img, $regs)) $logo = $regs[1];
-	if (eregi(&quot;align=\'([^']+)\'&quot;, $img, $regs)) $align = $regs[1];
-	if (eregi(&quot;name=\'([^']+)\'&quot;, $img, $regs)) $name = $regs[1];
-	if (eregi(&quot;hspace=\'([^']+)\'&quot;, $img, $regs)) $espace = $regs[1];
+	// recuperer le nom du fichier
+	if (eregi(&quot;src='([^']+)'&quot;, $img, $regs)) $logo = $regs[1];
+	if (eregi(&quot;align='([^']+)'&quot;, $img, $regs)) $align = $regs[1];
+	if (eregi(&quot;name='([^']+)'&quot;, $img, $regs)) $name = $regs[1];
+	if (eregi(&quot;hspace='([^']+)'&quot;, $img, $regs)) $espace = $regs[1];
 	if (!$logo) $logo = $img;
 
 	if (eregi(&quot;(.*)\.(jpg|gif|png)$&quot;, $logo, $regs)) {

Index: statistiques_lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/statistiques_lang.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- statistiques_lang.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ statistiques_lang.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 
@@ -42,47 +53,12 @@
 }
 
 //
-// Statistiques sur le site
+// Statistiques par langue
 //
 
 
-function enfants($id_parent){
-	global $nombre_vis;
-	global $total_vis;
-	global $nombre_abs;
-	global $critere;
-
-	$query = &quot;SELECT id_rubrique FROM spip_rubriques WHERE id_parent='$id_parent'&quot;;
-	$result = spip_query($query);
-	$nombre = 0;
-
-	while($row = spip_fetch_array($result)) {
-		$id_rubrique = $row['id_rubrique'];
-
-		$query2 = &quot;SELECT SUM(&quot;.$critere.&quot;) AS cnt FROM spip_articles WHERE id_rubrique='$id_rubrique'&quot;;
-		$result2 = spip_query($query2);
-		$visites = 0;
-		if ($row2 = spip_fetch_array($result2)) {
-			$visites = $row2['cnt'];
-		}
-		$nombre_abs[$id_rubrique] = $visites;
-		$nombre_vis[$id_rubrique] = $visites;
-		$nombre += $visites;
-		$nombre += enfants($id_rubrique);
-	}
-	$nombre_vis[$id_parent] += $nombre;
-	return $nombre;
-}
-
-
-
-
-
-if ($total_vis&lt;1) $total_vis=1;
-
 debut_cadre_enfonce(&quot;langues-24.gif&quot;);
 
-
 		$query = &quot;SELECT SUM(&quot;.$critere.&quot;) AS total_visites FROM spip_articles&quot;;
 		$result = spip_query($query);
 		$visites = 1;
@@ -103,7 +79,8 @@
 		while ($row = spip_fetch_array($result)) {
 			$lang = $row['lang'];
 			$visites = round($row['cnt'] / $total_visites * $taille);
-			
+			$pourcent = round($row['cnt'] / $total_visites * 100);
+
 			if ($visites &gt; 0) {
 
 				if ($ifond==0){
@@ -116,7 +93,7 @@
 	
 				echo &quot;&lt;tr bgcolor='$couleur'&gt;&quot;;
 				$dir=lang_dir($lang,'',' dir=rtl');
-				echo &quot;&lt;td width='100%' style='border-bottom: 1px solid #cccccc;'&gt;&lt;span class='verdana2'$dir&gt;&lt;div style='float: $spip_lang_right;'&gt;$visites%&lt;/div&gt;&quot;.traduire_nom_langue($lang).&quot;&lt;/span&gt;&lt;/td&gt;&quot;;
+				echo &quot;&lt;td width='100%' style='border-bottom: 1px solid #cccccc;'&gt;&lt;span class='verdana2'$dir&gt;&lt;div style='float: $spip_lang_right;'&gt;$pourcent%&lt;/div&gt;&quot;.traduire_nom_langue($lang).&quot;&lt;/span&gt;&lt;/td&gt;&quot;;
 				
 				echo &quot;&lt;td style='border-bottom: 1px solid #cccccc;'&gt;&quot;;
 					echo &quot;&lt;TABLE CELLPADDING=0 CELLSPACING=0 BORDER=0 WIDTH='&quot;.($taille+5).&quot;' HEIGHT=8&gt;&quot;;

Index: mots_tous.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/mots_tous.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- mots_tous.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ mots_tous.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 if ($conf_mot&gt;0) {
@@ -34,8 +45,17 @@
 			WHERE lien.id_mot=$conf_mot AND syndic.id_syndic=lien.id_syndic
 			AND FIND_IN_SET(syndic.statut,'$aff_articles')&gt;0 AND syndic.statut!='refuse'&quot;));
 		$nb_sites = $nb_sites[0];
-
-		if ($nb_articles + $nb_breves + $nb_sites == 0) {
+		/////////////////////////////
+		//MODIFICATION
+		////////////////////////////
+		$nb_objets = spip_fetch_array(spip_query(
+			&quot;SELECT COUNT(*) FROM spip_mots_carto_objets AS lien
+			WHERE lien.id_mot=$conf_mot&quot;));
+		$nb_objets = $nb_objets[0];
+		if ($nb_objets + $nb_articles + $nb_breves + $nb_sites == 0) {
+		
+		//if ($nb_articles + $nb_breves + $nb_sites == 0) {
+		////////////////////////////////
 			redirige_par_entete(&quot;mots_edit.php3?supp_mot=$id_mot&amp;redirect_ok=oui&amp;redirect=mots_tous.php3&quot;);
 		} // else traite plus loin
 	}
@@ -54,12 +74,12 @@
 			$query = &quot;UPDATE spip_groupes_mots SET titre='$change_type', unseul='$unseul', obligatoire='$obligatoire',
 				articles='$articles', breves='$breves', rubriques='$rubriques', syndic='$syndic',
 				0minirezo='$acces_minirezo', 1comite='$acces_comite', 6forum='$acces_forum'
-				WHERE id_groupe='$id_groupe'&quot;;
+				,carto_objets='$carto_objets' WHERE id_groupe='$id_groupe'&quot;;
 			spip_query($query);
 		} else {	// creation groupe
 			$query = &quot;INSERT INTO spip_groupes_mots SET titre='$change_type', unseul='$unseul', obligatoire='$obligatoire',
 				articles='$articles', breves='$breves', rubriques='$rubriques', syndic='$syndic',
-				0minirezo='$acces_minirezo', 1comite='$acces_comite', 6forum='$acces_forum'&quot;;
+				carto_objets='$carto_objets', 0minirezo='$acces_minirezo', 1comite='$acces_comite', 6forum='$acces_forum'&quot;;
 			spip_query($query);
 		}
 	}

Index: carte_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/carte_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carte_edit.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ carte_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,63 +1,73 @@
 &lt;?php
 
 include (&quot;inc.php3&quot;);
+include_ecrire (&quot;inc_documents.php3&quot;);
+include_ecrire (&quot;inc_mots.php3&quot;);
 include_ecrire(&quot;inc_carto.php3&quot;);
 //TODO : voir integration d'une option de configuration de Spip
 //bof, je prefere attendre d'avoir un systeme de gestion des modules
 //meme si il faut le faire ...
 //include_ecrire(&quot;inc_config.php3&quot;);
-//TODO : preparer les donn&#233;es pass&#233;es en POST par l'interface DHTML
-//et par le formulaire contenant les donn&#233;es de la carte
 
+$flag_editable=carte_editable($id_carte);
 $id_carte = intval($id_carte);
+$flag_mots = lire_meta(&quot;carto_mots&quot;);
+//$flag_mots = &quot;oui&quot;;
+$nouveau=false;
 //
 // Modifications aux donnees de base de la carte
 //
 if (carte_administrable($id_carte)) {
 	if ($supp_carte = intval($supp_carte) AND $supp_confirme AND !$supp_rejet) {
-		$query = &quot;DELETE FROM spip_carto_carte WHERE id_carte=$supp_carte&quot;;
+		//TODO : passer tout ca en spip_abstract ...
+		$query = &quot;DELETE FROM spip_carto_cartes WHERE id_carto_carte=$supp_carte&quot;;
 		$result = spip_query($query);
 		Header(&quot;Location: $retour&quot;);
 		exit;
 	}
 }
 
-if (carte_editable($id_carte)) {
+if ($flag_editable) {
 	if ($new == 'oui') {
 		$titre = _L(&quot;Nouvelle carte&quot;);
-		$fichier = &quot;&quot;;
-		$commentaire = &quot;&quot;;
+		$url_carte = &quot;&quot;;
+		$texte = &quot;&quot;;
 		$callage = &quot;&quot;;
-		$id_srs = 0;
+		$id_srs = 1;
 		$js_titre = &quot; onfocus=\&quot;if(!antifocus){this.value='';antifocus=true;}\&quot;&quot;;
-		spip_query(&quot;INSERT INTO spip_carto_carte (titre) VALUES ('&quot;.addslashes($titre).&quot;')&quot;);
+		//TODO : passer tout ca en spip_abstract ...
+		spip_query(&quot;INSERT INTO spip_carto_cartes (titre,url_carte,texte,callage,id_srs) VALUES ('&quot;.addslashes($titre).&quot;','&quot;.$url_carte.&quot;','&quot;.addslashes($texte).&quot;','&quot;.addslashes($callage).&quot;','&quot;.$id_srs.&quot;')&quot;);
 		$id_carte = spip_insert_id();
-		//TODO : normalement pas besoin de ca ...
-		//on continue et normalement c'est bon
-		//Header(&quot;Location: carte_edit.php3?id_carte=$id_carte&quot;);
-		//exit;
 	}
 
 	else {
 		if ($modif_carte == $id_carte) {
-			$query = &quot;UPDATE spip_carto_carte SET &quot;.
+			//TODO : generer automatiquement callage si document spip
+			if ($document_id=intval($url_carte)) {
+				//TODO : gerer type image et peut etre mime
+				$image = spip_fetch_array(spip_query(&quot;SELECT * FROM spip_documents WHERE id_document = $document_id&quot;));;
+				if ($image) $callage=&quot;rect(0,0;&quot;.$image['largeur'].&quot;,&quot;.$image['hauteur'].&quot;)&quot;;
+			}
+			//TODO : passer tout ca en spip_abstract ...
+			$query = &quot;UPDATE spip_carto_cartes SET &quot;.
 			&quot;titre='&quot;.addslashes($titre).&quot;', &quot;.
-			&quot;fichier='&quot;.$fichier.&quot;', &quot;.
-			&quot;commentaire='&quot;.addslashes($commentaire).&quot;', &quot;.
+			&quot;url_carte='&quot;.$url_carte.&quot;', &quot;.
+			&quot;texte='&quot;.addslashes($texte).&quot;', &quot;.
 			&quot;callage='&quot;.addslashes($callage).&quot;', &quot;.
 			&quot;id_srs='&quot;.intval($id_srs).&quot;' &quot;.
-			&quot;WHERE id_carte=$id_carte&quot;;
+			&quot;WHERE id_carto_carte=$id_carte&quot;;
+
 			$result = spip_query($query);
 		}
 		if ($id_carte) {
-			$query = &quot;SELECT * FROM spip_carto_carte WHERE id_carte=$id_carte&quot;;
+			//TODO : passer tout ca en spip_abstract ...
+			$query = &quot;SELECT * FROM spip_carto_cartes WHERE id_carto_carte=$id_carte&quot;;
 			$result = spip_query($query);
 			if ($row = spip_fetch_array($result)) {
-//				$id_carte = $row['id_carte'];
-				$titre = $row['titre'];
-				$fichier = $row['fichier'];
-				$commentaire = $row['commentaire'];
-				$callage = $row['callage'];
+				$titre = entites_html($row['titre']);
+				$url_carte = $row['url_carte'];
+				$texte = entites_html($row['texte']);
+				$callage = entites_html($row['callage']);
 				$id_srs = intval($row['id_srs']);
 				$js_titre = &quot;&quot;;
 			}
@@ -68,39 +78,50 @@
 		
 
 
-$carte_link = new Link(&quot;carte_edit.php3?id_carte=$id_carte&quot;);
+$carte_link = new Link(&quot;carte_edit.php3&quot;);
+$carte_link-&gt;addVar('id_carte', $id_carte);
 if ($retour) $carte_link-&gt;addVar('retour', $retour);
 
 //
 // Modifications des objets de la carte
 //
 
-if ($id_carte &amp;&amp; carte_editable($id_carte)) {
+if ($id_carte &amp;&amp; $flag_editable) {
 
 	// Ajout d'un objet
-	if ($selection_type=='polygon') {
-		$geometrie=$selection_type.&quot;(&quot;.$selection_coords.&quot;)&quot;;
+	if ($selection_type) {
+		$geometrie=coords2wtk($selection_type,$selection_coords);
 		$objet_titre = _L(&quot;Nouvel objet&quot;);
-		spip_query(&quot;INSERT INTO spip_carto_objet (id_carte,titre,geometrie) VALUES (&quot;.$id_carte.&quot;,'&quot;.addslashes($objet_titre).&quot;','&quot;.$geometrie.&quot;')&quot;);
+		$url_objet = &quot;#&quot;;
+		//TODO : passer tout ca en spip_abstract ...
+		spip_query(&quot;INSERT INTO spip_carto_objets (id_carto_carte,titre,geometrie,url_objet) VALUES (&quot;.$id_carte.&quot;,'&quot;.addslashes($objet_titre).&quot;','&quot;.$geometrie.&quot;','&quot;.$url_objet.&quot;')&quot;);
 		$id_objet = spip_insert_id();
+		$objet_visible=$id_objet;
+		$nouveau=true;
 	}
 	// Modif d'un objet
 	if ($modif_objet) {
-		$query = &quot;UPDATE spip_carto_objet SET &quot;.
-			//&quot;id_carte=&quot;.intval($id_carte).&quot;, &quot;.
+		//TODO : passer tout ca en spip_abstract ...
+		$query = &quot;UPDATE spip_carto_objets SET &quot;.
+			//&quot;id_carto_carte=&quot;.intval($id_carte).&quot;, &quot;.
 			&quot;titre='&quot;.addslashes($objet_titre).&quot;', &quot;.
-			&quot;commentaire='&quot;.addslashes($objet_commentaire).&quot;', &quot;.
-			&quot;lien='&quot;.$objet_lien.&quot;', &quot;.
-			&quot;logo='&quot;.$objet_logo.&quot;', &quot;.
+			&quot;texte='&quot;.addslashes($objet_texte).&quot;', &quot;.
+			&quot;url_objet='&quot;.$url_objet.&quot;', &quot;.
+			&quot;url_logo='&quot;.$url_logo.&quot;', &quot;.
 			&quot;geometrie='&quot;.addslashes($geometrie).&quot;' &quot;.
-			&quot;WHERE id_objet=$modif_objet&quot;;
+			&quot;WHERE id_carto_objet=$modif_objet&quot;;
 			$result = spip_query($query);
-		
+			$objet_visible=$modif_objet;
 	}
+	if ($id_objet) {
+			$objet_visible=$id_objet;
+	}
+	
 
 	// Suppression d'un objet
 	if ($supp_objet) {
-		$query = &quot;DELETE FROM spip_carto_objet WHERE id_objet=$supp_objet&quot;;
+		//TODO : passer tout ca en spip_abstract ...
+		$query = &quot;DELETE FROM spip_carto_objets WHERE id_carto_objet=$supp_objet&quot;;
 		$result = spip_query($query);
 	}
 	
@@ -112,18 +133,39 @@
 //
 
 debut_page(&quot;&laquo; $titre &raquo;&quot;, &quot;documents&quot;, &quot;cartes&quot;);
+
 debut_gauche();
 
-echo &quot;&lt;br /&gt;&lt;br /&gt;\n&quot;;
+debut_boite_info();
+
+echo &quot;&lt;div align='center'&gt;\n&quot;;
 
 
+echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size='1'&gt;&lt;b&gt;&quot;._L('CARTE NUM&Eacute;RO :').&quot;&lt;/b&gt;&lt;/font&gt;\n&quot;;
+echo &quot;&lt;br&gt;&lt;font face='Verdana,Arial,Sans,sans-serif' size='6'&gt;&lt;b&gt;$id_carte&lt;/b&gt;&lt;/font&gt;\n&quot;;
+
+if ($url_carte &amp;&amp; ($new!=&quot;oui&quot;)) icone_horizontale( _T('previsualiser'), &quot;../carto.php3?id_carto_carte=&quot;.$id_carte.&quot;&amp;var_mode=recalcul&quot;, &quot;racine-24.gif&quot;, &quot;rien.gif&quot;);
+if ($url_carte &amp;&amp; ($new!=&quot;oui&quot;)) icone_horizontale( _L('pr&#233;visualiser avec logos'), &quot;../carto_logo.php3?id_carto_carte=&quot;.$id_carte.&quot;&amp;var_mode=recalcul&quot;, &quot;racine-24.gif&quot;, &quot;rien.gif&quot;);
+if ($url_carte &amp;&amp; ($new!=&quot;oui&quot;)) icone_horizontale( _L('pr&#233;visualiser avec liens'), &quot;../carto_lien.php3?id_carto_carte=&quot;.$id_carte.&quot;&amp;var_mode=recalcul&quot;, &quot;racine-24.gif&quot;, &quot;rien.gif&quot;);
+
+echo &quot;&lt;/div&gt;\n&quot;;
+
+fin_boite_info();
+
+if ($new!=&quot;oui&quot;) {
+	# modifs de la description d'un des docs joints
+	maj_documents($id_carte, 'carto_carte');
+	
+	# affichage
+	afficher_documents_colonne($id_carte, 'carto_carte', true);
+}
+
 debut_droite();
 
 if ($supp_carte &amp;&amp; !$supp_confirme &amp;&amp; !$supp_rejet) {
 	echo &quot;&lt;p&gt;&lt;strong&gt;&quot;._L(&quot;Attention :&quot;).&quot;&lt;/strong&gt; &quot;;
-	echo _L(&quot;Des objets ont &eacute;t&eacute; attach&eacute;s &agrave; cette carte. &quot;.
-		&quot;Voulez-vous vraiment le supprimer ?&quot;).&quot;&lt;/p&gt;\n&quot;;
-	$link = new Link();
+	echo _L(&quot;Voulez-vous vraiment supprimer cette carte ?&quot;).&quot;&lt;/p&gt;\n&quot;;
+	$link = $carte_link;//new Link();
 	$link-&gt;addVar('supp_carte', $supp_carte);
 	echo $link-&gt;getform('GET');
 	echo &quot;&lt;input type='submit' name='supp_confirme' value=\&quot;&quot;._T('item_oui').&quot;\&quot; class='fondl'&gt;&quot;;
@@ -134,50 +176,50 @@
 
 
 if ($id_carte) {
-	debut_cadre_relief(&quot;carte-24.png&quot;);
+	debut_cadre_relief(&quot;carte-24.gif&quot;);
 	echo &quot;&lt;br/&gt;&quot;;
 	gros_titre($titre);
 	
-	if ($commentaire) {
+	if ($texte) {
 		echo &quot;&lt;p&gt;&lt;div align='left' border: 1px dashed #aaaaaa;'&gt;&quot;;
 		echo &quot;&lt;strong class='verdana2'&gt;&quot;._T('info_descriptif').&quot;&lt;/strong&gt; &quot;;
-		echo propre($commentaire);
+		echo propre($texte);
 		echo &quot;&lt;/div&gt;\n&quot;;
 	}
 	
-	if ($fichier) {
+	if ($url_carte!=&quot;&quot;) {
 		echo &quot;&lt;br /&gt;&quot;;
 		debut_cadre_relief();
 		
 		echo &quot;&lt;div style='padding: 2px; background-color: $couleur_claire; color: black;'&gt;&nbsp;&quot;;
 		echo bouton_block_visible(&quot;dhtml_carte&quot;);
 		echo &quot;&lt;strong class='verdana3' style='text-transform: uppercase;'&gt;&quot;
-			._L(&quot;Apparence du carte&quot;).&quot;&lt;/strong&gt;&quot;;
+			._L(&quot;Ajouter un objet&quot;).&quot;&lt;/strong&gt;&quot;;
 		echo &quot;&lt;/div&gt;\n&quot;;
 		
 		echo debut_block_visible(&quot;dhtml_carte&quot;);
-		echo _L(&quot;Cr&eacute;ation d'objets.&quot;).&quot;&lt;p&gt;\n&quot;;
-		echo &quot;&lt;div style='margin: 10px; padding: 10px; border: 1px dashed $couleur_foncee;'&gt;&quot;;
+		
+		//echo &quot;&lt;div style='margin: 10px; padding: 10px; border: 1px dashed $couleur_foncee;'&gt;&quot;;
 		
 		//remplacer id par appel &#224; spip_carte
 		//TODO : gerer zoom et position
-		if (intval($fichier)&gt;0) $lefichier=&quot;../spip_carto.php?id_carte=&quot;.intval($fichier);
-		else $lefichier=$fichier;
-		echo afficher_carte_inteface($lefichier,$id_carte,&quot;400&quot;,&quot;300&quot;);
+		//if (intval($url_carte)&gt;0) $leurl_carte=&quot;../spip_carto.php?fond_carte=&quot;.intval($url_carte);
+		//else $leurl_carte=$url_carte;
+		$lurl_carte=&quot;../spip_carto.php?fond_carte=&quot;.urlencode($url_carte);
+		$tabcallage=wtktoarray($callage);
+		echo afficher_carte_inteface($id_carte,$retour,$lurl_carte,$tabcallage);
 		
-		echo &quot;&lt;/div&gt;\n&quot;;
 		echo fin_block();
+		echo &quot;&lt;/div&gt;\n&quot;;
 		
 		fin_cadre_relief();
 	}
-	/*
-	//articles li&#233;s g&#233;r&#233;s &#224; la sauvegarde du contenu dans articles.php3 : 
-	//relecture du contenu de l'article puis delete / insert des liaisons
-	//de cet article
+	
+	//articles li&#233;s
 	afficher_articles(_L(&quot;Articles utilisant cette carte&quot;),
-		&quot;, spip_carto_carte_articles AS lien WHERE lien.id_article=articles.id_article &quot;.
-		&quot;AND id_carte=$id_carte AND statut!='poubelle' ORDER BY titre&quot;);
-	*/
+		&quot;, spip_carto_cartes_articles AS lien WHERE lien.id_article=articles.id_article &quot;.
+		&quot;AND id_carto_carte=$id_carte AND statut!='poubelle' ORDER BY titre&quot;);
+	
 	
 	fin_cadre_relief();
 }
@@ -200,9 +242,9 @@
 	if (!$retour) {
 		$link-&gt;addVar('retour', 'cartes.php3');
 	}
-	if (!$nb_reponses) {
-		$link-&gt;addVar('supp_confirme', 'oui');
-	}
+	//if (!$nb_reponses) {
+	//	$link-&gt;addVar('supp_confirme', 'oui');
+	//}
 	icone(_L(&quot;Supprimer cette carte&quot;), $link-&gt;getUrl(), &quot;carte-24.gif&quot;, &quot;supprimer.gif&quot;);
 	echo &quot;&lt;/div&gt;\n&quot;;
 }
@@ -211,7 +253,7 @@
 //
 // Edition des donnees de la carte
 //
-if (carte_editable($id_carte)) {
+if ($flag_editable) {
 	echo &quot;&lt;p&gt;&quot;;
 	debut_cadre_formulaire();
 
@@ -220,151 +262,154 @@
 	$link-&gt;addVar('modif_carte', $id_carte);
 	echo $link-&gt;getForm('GET');
 	
-	$titre= entites_html($titre);
-	$fichier= $fichier;
-	$commentaire= entites_html($commentaire);
-	$callage = entites_html($callage);
-	$id_srs= intval($id_srs);
-
 	echo &quot;&lt;strong&gt;&lt;label for='titre_carte'&gt;&quot;._L(&quot;Titre de la carte&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; &quot;._T('info_obligatoire_02');
 	echo &quot;&lt;br /&gt;&quot;;
 	echo &quot;&lt;input type='text' name='titre' id='titre_carte' CLASS='formo' &quot;.
 		&quot;value=\&quot;&quot;.$titre.&quot;\&quot; size='40'$js_titre&gt;&lt;br /&gt;\n&quot;;
 
-	echo &quot;&lt;strong&gt;&lt;label for='fichier_carte'&gt;&quot;._L(&quot;Fichier de la carte&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; &quot;._T('info_obligatoire_02');
-	echo &quot;&lt;br /&gt;&quot;;
-	echo &quot;&lt;input type='text' name='fichier' id='fichier_carte' CLASS='formo' &quot;.
-		&quot;value=\&quot;&quot;.$fichier.&quot;\&quot; size='40'&gt;&lt;br /&gt;\n&quot;;
-
-	echo &quot;&lt;strong&gt;&lt;label for='desc_carte'&gt;&quot;._T('info_descriptif').&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
+	echo &quot;&lt;strong&gt;&lt;label for='desc_carte'&gt;&quot;._T('info_texte').&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
 	echo &quot;&lt;br /&gt;&quot;;
-	echo &quot;&lt;textarea name='commentaire' id='desc_carte' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
-	echo $commentaire;
+	echo &quot;&lt;textarea name='texte' id='desc_carte' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
+	echo $texte;
 	echo &quot;&lt;/textarea&gt;&lt;br /&gt;\n&quot;;
 
-	echo &quot;&lt;strong&gt;&lt;label for='callage_carte'&gt;&quot;._T(&quot;Callage de la carte&quot;).&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
-	echo &quot;&lt;br /&gt;&quot;;
-	echo &quot;&lt;textarea name='callage' id='callage_carte' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
-	echo $callage;
-	echo &quot;&lt;/textarea&gt;&lt;br /&gt;\n&quot;;
+	if ($new) {
+		echo &quot;&lt;input type='hidden' name='url_carte' id='url_carte_carte' &quot;.
+			&quot;value=\&quot;&quot;.$url_carte.&quot;\&quot; size='40'&gt;&quot;;
+		
+		echo &quot;&lt;textarea name='callage' id='callage_carte' style='visibility:hidden;'&gt;&quot;;
+		echo $callage;
+		echo &quot;&lt;/textarea&gt;&quot;;
 
-	echo &quot;&lt;strong&gt;&lt;label for='srs_carte'&gt;&quot;._L(&quot;S.R.S. de la carte&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; &quot;._T('info_obligatoire_02');
-	echo &quot;&lt;br /&gt;&quot;;
-	echo &quot;&lt;input type='text' name='id_srs' id='srs_carte' CLASS='formo' &quot;.
-		&quot;value=\&quot;&quot;.$id_srs.&quot;\&quot; size='40'&gt;&lt;br /&gt;\n&quot;;
+
+		echo &quot;&lt;input type='hidden' name='id_srs' id='srs_carte' &quot;.
+			&quot;value=\&quot;&quot;.$id_srs.&quot;\&quot; size='40'&gt;&quot;;
+	}
+	else {
+		echo &quot;&lt;strong&gt;&lt;label for='url_carte_carte'&gt;&quot;._L(&quot;Fond de carte&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; &quot;._T('info_obligatoire_02'). &quot;&lt;br /&gt;&quot;._L(&quot;(Num&#233;ro de l'image Spip ou URL de l'image)&quot;);
+		echo &quot;&lt;br /&gt;&quot;;
+		echo &quot;&lt;input type='text' name='url_carte' id='url_carte_carte' CLASS='formo' &quot;.
+			&quot;value=\&quot;&quot;.$url_carte.&quot;\&quot; size='40'&gt;&lt;br /&gt;\n&quot;;
+		
+		echo &quot;&lt;strong&gt;&lt;label for='callage_carte'&gt;&quot;._L(&quot;Callage de la carte&quot;).&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
+		echo &quot;&lt;br /&gt;&quot;;
+		echo &quot;&lt;textarea name='callage' id='callage_carte' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
+		echo $callage;
+		echo &quot;&lt;/textarea&gt;&lt;br /&gt;\n&quot;;
 
 
+		echo &quot;&lt;strong&gt;&lt;label for='srs_carte'&gt;&quot;._L(&quot;S.R.S. de la carte&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; &quot;._T('info_obligatoire_02');
+		echo &quot;&lt;br /&gt;&quot;;
+		echo &quot;&lt;input type='text' name='id_srs' id='srs_carte' CLASS='formo' &quot;.
+			&quot;value=\&quot;&quot;.$id_srs.&quot;\&quot; size='40'&gt;&lt;br /&gt;\n&quot;;
+	}
+	
+	
 	echo &quot;&lt;div align='right'&gt;&quot;;
 	echo &quot;&lt;input type='submit' name='Valider' value='&quot;._T('bouton_valider').&quot;' class='fondo'&gt;&lt;/div&gt;\n&quot;;
-	
+
 	echo &quot;&lt;/form&gt;&quot;;
 
 	//
 	// Modifier / supprimer les objets
 	//
-	if ($id_carte) {
-		echo &quot;&lt;a name='objetss'&gt;&lt;/a&gt;&quot;;
+
+	$query = &quot;SELECT * FROM spip_carto_objets WHERE id_carto_carte=$id_carte&quot;;
+	$result = spip_query($query);
+	
+	if (spip_num_rows($result)&gt;0) {
+		echo &quot;&lt;a name='objets'&gt;&lt;/a&gt;&quot;;
 		echo &quot;&lt;p&gt;&lt;hr&gt;&lt;p&gt;\n&quot;;
 		echo &quot;&lt;div class='verdana3'&gt;&quot;;
 		echo &quot;&lt;strong&gt;&quot;._L(&quot;Objets de la carte&quot;).&quot;&lt;/strong&gt;&lt;br /&gt;\n&quot;;
 		echo _L(&quot;Vous pouvez ici modifier et supprimer les objets de la carte.&quot;);
 		echo &quot;&lt;/div&gt;\n&quot;;
-
-	$query = &quot;SELECT * FROM spip_carto_objet WHERE id_carte=$id_carte&quot;;
-	$result = spip_query($query);
-	while ($t = spip_fetch_array($result)) {
-
-		$id_objet= $t['id_objet'];
-		$titre_objet= entites_html($t['titre']);
-		$lien_objet= $t['lien'];
-		$commentaire_objet= entites_html($t['commentaire']);
-		$logo_objet = $t['logo'];
-		$geometrie = entites_html($t['geometrie']);
-
-		$nouveau = ($id_objet == $nouveau_objet);
-		if ($nouveau) echo &quot;&lt;a name='nouveau_objet'&gt;&lt;/a&gt;&quot;;
-		echo &quot;&lt;p&gt;\n&quot;;
-		debut_cadre_relief();
-		echo &quot;&lt;div style='padding: 2px; background-color: $couleur_claire; color: black;'&gt;&nbsp;&quot;;
-		
-		echo $nouveau ? bouton_block_visible(&quot;objet_$id_objet&quot;) : bouton_block_invisible(&quot;objet_$id_objet&quot;);
-		echo &quot;&lt;strong&gt;&quot;.$titre_objet.&quot;&lt;/strong&gt;&quot;;
-		echo &quot;&lt;br /&gt;&lt;/div&gt;&quot;;
-		echo $nouveau ? debut_block_visible(&quot;objet_$id_objet&quot;) : debut_block_invisible(&quot;objet_$id_objet&quot;);
+	
+		while ($t = spip_fetch_array($result)) {
+	
+			$id_objet= $t['id_carto_objet'];
+			$titre_objet= entites_html($t['titre']);
+			$lien_objet= $t['url_objet'];
+			$texte_objet= entites_html($t['texte']);
+			$url_logo = $t['url_logo'];
+			$geometrie = entites_html($t['geometrie']);
+	
+			$visible = ($id_objet == $objet_visible);
+			if ($nouveau) echo &quot;&lt;a name='nouveau_objet'&gt;&lt;/a&gt;&quot;;
+			else if ($visible) echo &quot;&lt;a name='objet_visible'&gt;&lt;/a&gt;&quot;;
+			echo &quot;&lt;p&gt;\n&quot;;
+			debut_cadre_relief();
+			echo &quot;&lt;div style='padding: 2px; background-color: $couleur_claire; color: black;'&gt;&nbsp;&quot;;
 			
-			// Modifier un objet
-			$link = $carte_link;
-			$link-&gt;addVar('modif_objet', $id_objet);
-			echo $link-&gt;getForm('GET', 'objet_visible');
-			echo &quot;&lt;div class='verdana2'&gt;&quot;;
-			echo &quot;&lt;p&gt;&quot;;
-			if ($nouveau) {
-				echo &quot;&lt;script type='text/javascript'&gt;&lt;!-- \nvar antifocus_champ = false; // --&gt;&lt;/script&gt;\n&quot;;
-				$js = &quot; onfocus=\&quot;if(!antifocus_champ){this.value='';antifocus_champ=true;}\&quot;&quot;;
+			echo $visible ? bouton_block_visible(&quot;objet_$id_objet&quot;) : bouton_block_invisible(&quot;objet_$id_objet&quot;);
+			echo &quot;&lt;strong&gt;&quot;.$titre_objet.&quot;&lt;/strong&gt;&quot;;
+			echo &quot;&lt;br /&gt;&lt;/div&gt;&quot;;
+			echo $visible ? debut_block_visible(&quot;objet_$id_objet&quot;) : debut_block_invisible(&quot;objet_$id_objet&quot;);
+				
+				// Modifier un objet
+				$link = $carte_link;
+				$link-&gt;addVar('modif_objet', $id_objet);
+				echo $link-&gt;getForm('GET', 'objet_visible');
+				echo &quot;&lt;div class='verdana2'&gt;&quot;;
+				echo &quot;&lt;p&gt;&quot;;
+				if ($nouveau) {
+					echo &quot;&lt;script type='text/javascript'&gt;&lt;!-- \nvar antifocus_champ = false; // --&gt;&lt;/script&gt;\n&quot;;
+					$js = &quot; onfocus=\&quot;if(!antifocus_champ){this.value='';antifocus_champ=true;}\&quot;&quot;;
+				}
+				else $js = &quot;&quot;;
+				echo &quot;&lt;strong&gt;&lt;label for='titre_$id_objet'&gt;&quot;._L(&quot;Titre de l'objet&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; :&quot;;
+				echo &quot;&lt;br /&gt;&quot;;
+				echo &quot;&lt;input type='text' name='objet_titre' id='titre_$id_objet' value=\&quot;&quot;.
+					$titre_objet.&quot;\&quot; class='fondo verdana2' size='30'$js&gt;&lt;br /&gt;\n&quot;;
+				//bloc_edition_objet($t, $carte_link);
+				
+				echo &quot;&lt;strong&gt;&lt;label for='desc_$id_objet'&gt;&quot;._T('info_texte').&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
+				echo &quot;&lt;br /&gt;&quot;;
+				echo &quot;&lt;textarea name='objet_texte' id='desc_$id_objet' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
+				echo $texte_objet;
+				echo &quot;&lt;/textarea&gt;&lt;br /&gt;\n&quot;;
+	
+				echo &quot;&lt;strong&gt;&lt;label for='lien_$id_objet'&gt;&quot;._L(&quot;Lien de l'objet&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; :&quot;;
+				echo &quot;&lt;br /&gt;&quot;;
+				echo &quot;&lt;input type='text' name='url_objet' id='lien_$id_objet' value=\&quot;&quot;.
+					$lien_objet.&quot;\&quot; class='fondo verdana2' size='30'$&gt;&lt;br /&gt;\n&quot;;
+	
+				echo &quot;&lt;strong&gt;&lt;label for='logo_$id_objet'&gt;&quot;._L(&quot;Logo de l'objet&quot;).&quot;&lt;/label&gt;&lt;/strong&gt; :&quot;;
+				echo &quot;&lt;br /&gt;&quot;;
+				echo &quot;&lt;input type='text' name='url_logo' id='logo_$id_objet' value=\&quot;&quot;.
+					$url_logo.&quot;\&quot; class='fondo verdana2' size='30'$&gt;&lt;br /&gt;\n&quot;;
+	
+				echo &quot;&lt;strong&gt;&lt;label for='geo_$id_objet'&gt;&quot;._L('G&#233;ometrie').&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
+				echo &quot;&lt;br /&gt;&quot;;
+				echo &quot;&lt;textarea name='geometrie' id='geo_$id_objet' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
+				echo $geometrie;
+				echo &quot;&lt;/textarea&gt;&lt;br /&gt;\n&quot;;
+	
+				echo &quot;&lt;/p&gt;&quot;;
+	
+				echo &quot;&lt;div align='right'&gt;&quot;;
+				echo &quot;&lt;input type='submit' name='Valider' value='&quot;._T('bouton_valider').&quot;' class='fondo verdana2'&gt;&lt;/div&gt;\n&quot;;
+				echo &quot;&lt;/div&gt;\n&quot;;
+				echo &quot;&lt;/form&gt;&quot;;
+				
+				if ($flag_mots!='non' AND $options == 'avancees') {
+					$tab_id['id_carte']=$id_carte;
+					$tab_id['id_objet']=$id_objet;
+					//TODO : passer les ,ouceau, cherche et supp que si bon mot
+					((!$nouveau) &amp;&amp; ($visible)) ? formulaire_mots('carto_objets', $tab_id, $nouv_mot, $supp_mot, $cherche_mot, $flag_editable): formulaire_mots('carto_objets', $tab_id, null, null, null, $flag_editable);
+				}
+	
+				// Supprimer un objet
+				$link = $carte_link;
+				$link-&gt;addVar('supp_objet', $id_objet);
+				echo &quot;&lt;div style='float: left;'&gt;&quot;;
+				icone_horizontale(_L(&quot;Supprimer cet objet&quot;), $link-&gt;getUrl('objets'), &quot;carte-24.gif&quot;, &quot;supprimer.gif&quot;);
+				echo &quot;&lt;/div&gt;\n&quot;;
+				
+				echo fin_block();
+				fin_cadre_relief();
 			}
-			else $js = &quot;&quot;;
-			echo &quot;&lt;label for='titre_$id_objet'&gt;&quot;._L(&quot;Titre de l'objet&quot;).&quot;&lt;/label&gt; :&quot;;
-			echo &quot; &nbsp;&lt;input type='text' name='objet_titre' id='titre_$id_objet' value=\&quot;&quot;.
-				$titre_objet.&quot;\&quot; class='fondo verdana2' size='30'$js&gt;&lt;br /&gt;\n&quot;;
-			//bloc_edition_objet($t, $carte_link);
-			
-			echo &quot;&lt;strong&gt;&lt;label for='desc_$id_objet'&gt;&quot;._T('info_descriptif').&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
-			echo &quot;&lt;br /&gt;&quot;;
-			echo &quot;&lt;textarea name='objet_commentaire' id='desc_$id_objet' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
-			echo $commentaire_objet;
-			echo &quot;&lt;/textarea&gt;&lt;br /&gt;\n&quot;;
-
-			echo &quot;&lt;label for='lien_$id_objet'&gt;&quot;._L(&quot;Lien de l'objet&quot;).&quot;&lt;/label&gt; :&quot;;
-			echo &quot; &nbsp;&lt;input type='text' name='objet_lien' id='lien_$id_objet' value=\&quot;&quot;.
-				$lien_objet.&quot;\&quot; class='fondo verdana2' size='30'$&gt;&lt;br /&gt;\n&quot;;
-
-			echo &quot;&lt;label for='logo_$id_objet'&gt;&quot;._L(&quot;Logo de l'objet&quot;).&quot;&lt;/label&gt; :&quot;;
-			echo &quot; &nbsp;&lt;input type='text' name='objet_logo' id='logo_$id_objet' value=\&quot;&quot;.
-				$logo_objet.&quot;\&quot; class='fondo verdana2' size='30'$&gt;&lt;br /&gt;\n&quot;;
-
-			echo &quot;&lt;strong&gt;&lt;label for='geo_$id_objet'&gt;&quot;._T('info_descriptif').&quot;&lt;/label&gt;&lt;/strong&gt;&quot;;
-			echo &quot;&lt;br /&gt;&quot;;
-			echo &quot;&lt;textarea name='geometrie' id='geo_$id_objet' CLASS='forml' rows='4' cols='40' wrap='soft'&gt;&quot;;
-			echo $geometrie;
-			echo &quot;&lt;/textarea&gt;&lt;br /&gt;\n&quot;;
-
-			echo &quot;&lt;/p&gt;&quot;;
-
-			echo &quot;&lt;div align='right'&gt;&quot;;
-			echo &quot;&lt;input type='submit' name='Valider' value='&quot;._T('bouton_valider').&quot;' class='fondo verdana2'&gt;&lt;/div&gt;\n&quot;;
-			echo &quot;&lt;/div&gt;\n&quot;;
-			echo &quot;&lt;/form&gt;&quot;;
-			// Supprimer un objet
-			$link = $carte_link;
-			$link-&gt;addVar('supp_objet', $id_objet);
-			echo &quot;&lt;div style='float: left;'&gt;&quot;;
-			icone_horizontale(_L(&quot;Supprimer cet objet&quot;), $link-&gt;getUrl('objets'), &quot;carte-24.gif&quot;, &quot;supprimer.gif&quot;);
-			echo &quot;&lt;/div&gt;\n&quot;;
-			
-			echo fin_block();
-			fin_cadre_relief();
 		}
-
-		// Ajouter un objet
-		/*
-		echo &quot;&lt;p&gt;&quot;;
-		debut_cadre_enfonce();
-		$link = $carte_link;
-		echo $link-&gt;getForm('GET', 'nouveau_objet');
-		echo &quot;&lt;strong&gt;&quot;._L(&quot;Ajouter un objet&quot;).&quot;&lt;/strong&gt;&lt;br /&gt;\n&quot;;
-		echo _L(&quot;Cr&eacute;er un objet de type&nbsp;:&quot;);
-		echo &quot; \n&quot;;
-		$types = array('ligne', 'texte', 'email', 'url', 'select', 'multiple', 'fichier', 'mot');
-		echo &quot;&lt;select name='ajout_objet' value='' class='fondo'&gt;\n&quot;;
-		foreach ($types as $type) {
-			echo &quot;&lt;option value='$type'&gt;&quot;.nom_type_objet($type).&quot;&lt;/option&gt;\n&quot;;
-		}
-		echo &quot;&lt;/select&gt;\n&quot;;
-		echo &quot; &nbsp; &lt;input type='submit' name='valider' id='ajout_objet' VALUE='&quot;._T('bouton_valider').&quot;' class='fondo'&gt;&quot;;
-		echo &quot;&lt;/form&gt;\n&quot;;
-		fin_cadre_enfonce();
-		*/
-	}
 	
 	echo &quot;&lt;/div&gt;\n&quot;;
 

Index: inc_visites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_visites.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_visites.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_visites.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_VISITES&quot;)) return;
 define(&quot;_ECRIRE_INC_VISITES&quot;, &quot;1&quot;);

Index: md5.js
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/md5.js,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2

Index: synchro.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/synchro.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- synchro.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ synchro.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 // pour low_sec (iCal)
 include_ecrire(&quot;inc_acces.php3&quot;);

Index: inc_texte.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_texte.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_texte.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_texte.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_TEXTE&quot;)) return;
@@ -12,11 +23,9 @@
 // (on peut les modifier globalement dans mes_fonctions.php3,
 //  OU individuellement pour chaque type de page dans article.php3,
 //  rubrique.php3, etc. cf doc...)
-// Par securite ne pas accepter les variables passees par l'utilisateur
 //
 function tester_variable($nom_var, $val){
-	global $INSECURE;
-	if (!isset($GLOBALS[$nom_var]) || $INSECURE[$nom_var]) {
+	if (!isset($GLOBALS[$nom_var])) {
 		$GLOBALS[$nom_var] = $val;
 		return false;
 	}
@@ -179,9 +188,8 @@
 	while (eregi(__regexp_img_echappe, $letexte, $match)) {
 		$num_echap++;
 
-		$letout = quotemeta($match[0]);
-		$letout = ereg_replace(&quot;\|&quot;, &quot;\|&quot;, $letout);
-		$letexte = ereg_replace($letout, &quot;@@SPIP_$source$num_echap@@&quot;, $letexte);
+		$letexte = str_replace($match[0],
+			&quot;@@SPIP_$source$num_echap@@&quot;, $letexte);
 		$les_echap[$num_echap] = $match;
 	}
 
@@ -229,12 +237,12 @@
 
 
 // fonction en cas de texte extrait d'un serveur distant:
-// on ne sait pas (encore) rappatrier les documents joints
+// on ne sait pas (encore) rapatrier les documents joints
 
 function supprime_img($letexte) {
-	$message = _L('indisponible');
+	$message = _T('img_indisponible');
 	while (eregi(__regexp_img_echappe, $letexte, $match)) {
-	  $letexte = ereg_replace($match[0], $message, $letexte);
+	  $letexte = str_replace($match[0], &quot;($message)&quot;, $letexte);
 	}
 	return $letexte;
 }
@@ -349,7 +357,6 @@
 
 // Correction typographique francaise
 function typo_fr($letexte) {
-	global $flag_strtr2;
 	static $trans;
 
 	// Nettoyer 160 = nbsp ; 187 = raquo ; 171 = laquo ; 176 = deg ; 147 = ldquo; 148 = rdquo
@@ -371,13 +378,7 @@
 		}
 	}
 
-	if ($flag_strtr2)
-		$letexte = strtr($letexte, $trans);
-	else {
-		reset($trans);
-		while (list($c, $r) = each($trans))
-			$letexte = str_replace($c, $r, $letexte);
-	}
+	$letexte = strtr($letexte, $trans);
 
 	$cherche1 = array(
 		/* 1		'/{([^}]+)}/',  */

Index: statistiques_referers.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/statistiques_referers.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- statistiques_referers.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ statistiques_referers.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire(&quot;inc_statistiques.php3&quot;);
 

Index: import_all.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/import_all.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- import_all.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ import_all.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 
 include_ecrire (&quot;inc_auth.php3&quot;);

Index: inc_surligne.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_surligne.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_surligne.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_surligne.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_SURLIGNE&quot;)) return;

Index: inc_presentation.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_presentation.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_presentation.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_presentation.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,11 +1,22 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_PRESENTATION&quot;)) return;
 define(&quot;_ECRIRE_INC_PRESENTATION&quot;, &quot;1&quot;);
 
-include_ecrire(&quot;inc_filtres.php3&quot;); # pour http_script (normalement d&#233;j&#224; fait)
+include_ecrire(&quot;inc_filtres.php3&quot;); # pour les fonctions http_* (normalement deja la)
 include_ecrire (&quot;inc_lang.php3&quot;);
 utiliser_langue_visiteur();
 
@@ -104,13 +115,12 @@
 		$ret .= &quot;&lt;div class='cadre-$style'$style_cadre&gt;&quot;;
 	}
 
-	//$ret = &quot;&lt;div class='cadre-$style' style='$style_haut'&gt;&quot;;
 	$ret .= &quot;&lt;div style='position: relative;'&gt;&quot;;
 
 	if ($spip_display != 1 AND $spip_display != 4 AND strlen($icone) &gt; 1) {
 		$ret .= &quot;&lt;div style='position: absolute; top: -16px; $spip_lang_left: 10px;'&gt;&quot;;
 		if ($fonction) {
-			$ret .= &quot;&lt;div &quot; . http_style_background($icone, &quot;no-repeat; padding: 0px; margin: 0px;'&quot;);
+			$ret .= &quot;&lt;div &quot; . http_style_background($icone, &quot;no-repeat; padding: 0px; margin: 0px&quot;);
 			$ret .= http_img_pack($fonction, &quot;&quot;, &quot;&quot;);
 			$ret .= &quot;&lt;/div&gt;&quot;;
 		}
@@ -543,7 +553,7 @@
 }
 
 
-function puce_statut_article($id_article, $statut) {
+function puce_statut_article($id, $statut) {
 	global $spip_lang_left, $dir_lang, $connect_statut, $options, $browser_name;
 	
 	switch ($statut) {
@@ -584,71 +594,107 @@
 			  &quot;verte&quot; =&gt; _T('texte_statut_publie'),
 			  &quot;rouge&quot; =&gt; _T('texte_statut_refuse'),
 			  &quot;poubelle&quot; =&gt; _T('texte_statut_poubelle'));
-		$inser_puce = &quot;&lt;div class='puce_article' id='statut$id_article'$dir_lang&gt;&quot;
-			. &quot;&lt;div class='puce_article_fixe' onmouseover=\&quot;montrer('statutdecal$id_article');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;$puce&quot;, &quot;&quot;, &quot;id='imgstatut$id_article' border='0' style='margin: 1px;'&quot;) .&quot;&lt;/div&gt;&quot;
-			. &quot;&lt;div class='puce_article_popup' id='statutdecal$id_article' onmouseout=\&quot;cacher('statutdecal$id_article');\&quot; style=' margin-left: -&quot;.((11*$clip)+1).&quot;px;'&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecal$id_article');\&quot; href=\&quot;javascript:selec_statut_art($id_article, 0, 'prepa');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-blanche.gif&quot;, &quot;&quot;, &quot;title='$titles[blanche]'&quot;). &quot;&lt;/a&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecal$id_article');\&quot; href=\&quot;javascript:selec_statut_art($id_article, 1, 'prop');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-orange.gif&quot;, &quot;&quot;, &quot;title='$titles[orange]'&quot;) . &quot;&lt;/a&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecal$id_article');\&quot; href=\&quot;javascript:selec_statut_art($id_article, 2, 'publie');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-verte.gif&quot;, &quot;&quot;, &quot;title='$titles[verte]'&quot;).&quot;&lt;/a&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecal$id_article');\&quot; href=\&quot;javascript:selec_statut_art($id_article, 3, 'refuse');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-rouge.gif&quot;, &quot;&quot;, &quot;title='$titles[rouge]'&quot;). &quot;&lt;/a&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecal$id_article');\&quot; href=\&quot;javascript:selec_statut_art($id_article, 4, 'poubelle');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-poubelle.gif&quot;, &quot;&quot;, &quot;title='$titles[poubelle]'&quot;). &quot;&lt;/a&gt;&quot;
+	  $action = &quot;onmouseover=\&quot;montrer('statutdecalarticle$id');\&quot;&quot;;
+	  $inser_puce = &quot;&lt;div class='puce_article' id='statut$id'$dir_lang&gt;&quot;
+			. &quot;&lt;div class='puce_article_fixe' $action&gt;&quot; .
+		  http_img_pack(&quot;$puce&quot;, &quot;&quot;, &quot;id='imgstatutarticle$id' border='0' style='margin: 1px;'&quot;) .&quot;&lt;/div&gt;&quot;
+			. &quot;&lt;div class='puce_article_popup' id='statutdecalarticle$id' onmouseout=\&quot;cacher('statutdecalarticle$id');\&quot; style=' margin-left: -&quot;.((11*$clip)+1).&quot;px;'&gt;&quot;
+		  . http_href_img(&quot;javascript:selec_statut($id, 'article', -1,'&quot; . _DIR_IMG_PACK . &quot;puce-blanche.gif', 'prepa');&quot;,
+				  &quot;puce-blanche.gif&quot;, 
+				  &quot;title=\&quot;$titles[blanche]\&quot;&quot;,
+				  &quot;&quot;,'','',
+				  $action)
+		  . http_href_img(&quot;javascript:selec_statut($id, 'article', -12,'&quot; . _DIR_IMG_PACK . &quot;puce-orange.gif', 'prop');&quot;,
+				  &quot;puce-orange.gif&quot;, 
+				  &quot;title=\&quot;$titles[orange]\&quot;&quot;,
+				  &quot;&quot;,'','',
+				  $action)
+		  . http_href_img(&quot;javascript:selec_statut($id, 'article', -23,'&quot; . _DIR_IMG_PACK . &quot;puce-verte.gif', 'publie');&quot;,
+				  &quot;puce-verte.gif&quot;, 
+				  &quot;title=\&quot;$titles[verte]\&quot;&quot;,
+				  &quot;&quot;,'','',
+				  $action)
+		  . http_href_img(&quot;javascript:selec_statut($id, 'article', -34,'&quot; . _DIR_IMG_PACK . &quot;puce-rouge.gif', 'refuse');&quot;,
+				  &quot;puce-rouge.gif&quot;, 
+				  &quot;title=\&quot;$titles[rouge]\&quot;&quot;,
+				  &quot;&quot;,'','',
+				  $action)
+		  . http_href_img(&quot;javascript:selec_statut($id, 'article', -45,'&quot; . _DIR_IMG_PACK . &quot;puce-poubelle.gif', 'poubelle');&quot;,
+				  &quot;puce-poubelle.gif&quot;, 
+				  &quot;title=\&quot;$titles[poubelle]\&quot;&quot;,
+				  &quot;&quot;,'','',
+				  $action)
 			. &quot;&lt;/div&gt;&lt;/div&gt;&quot;;
 	} else {
-		$inser_puce = http_img_pack(&quot;$puce&quot;, &quot;&quot;, &quot;id='imgstatut$id_article' border='0' style='margin: 1px;'&quot;);
+		$inser_puce = http_img_pack(&quot;$puce&quot;, &quot;&quot;, &quot;id='imgstatutarticle$id' border='0' style='margin: 1px;'&quot;);
 	}
 	return $inser_puce;
 }
 
-function puce_statut_breve($id_breve, $statut) {
-	global $spip_lang_left, $dir_lang, $connect_statut, $options, $browser_name;
-	
-			switch ($statut) {
+function puce_statut_breve($id, $statut, $type) {
+	global $spip_lang_left, $dir_lang, $connect_statut, $options;
+
+	$puces = array(
+		       0 =&gt; 'puce-orange-breve.gif',
+		       1 =&gt; 'puce-verte-breve.gif',
+		       2 =&gt; 'puce-rouge-breve.gif',
+		       3 =&gt; 'puce-blanche-breve.gif');
+
+	switch ($statut) {
 			case 'prop':
 				$clip = 0;
-				$puce = &quot;orange&quot;;
+				$puce = $puces[0];
 				$title = _T('titre_breve_proposee');
 				break;
 			case 'publie':
 				$clip = 1;
-				$puce = &quot;verte&quot;;
+				$puce = $puces[1];
 				$title = _T('titre_breve_publiee');
 				break;
 			case 'refuse':
 				$clip = 2;
-				$puce = &quot;rouge&quot;;
+				$puce = $puces[2];
 				$title = _T('titre_breve_refusee');
 				break;
-			}
+			default:
+				$clip = 0;
+				$puce = $puces[3];
+				$title = '';
+	}
 
+	$type1 = &quot;statut$type$id&quot;; 
+	$inser_puce = http_img_pack($puce, &quot;&quot;, &quot;id='img$type1' border='0' style='margin: 1px;'&quot;);
 
-	$puce = &quot;puce-$puce-breve.gif&quot;;
-	
-	if ($connect_statut == '0minirezo' AND $options == 'avancees') {
+	if (!($connect_statut == '0minirezo' AND $options == 'avancees'))
+		return $inser_puce;
 	
+	$type2 = &quot;statutdecal$type$id&quot;;
+	$action = &quot;onmouseover=\&quot;montrer('$type2');\&quot;\n&quot;;
+
 	  // les versions de MSIE ne font pas toutes pareil sur alt/title
 	  // la combinaison suivante semble ok pour tout le monde.
 
-		$inser_puce = &quot;&lt;div class='puce_breve' id='statutbreve$id_breve'$dir_lang&gt;&quot;
-			. &quot;&lt;div class='puce_breve_fixe' onmouseover=\&quot;montrer('statutdecalbreve$id_breve');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;$puce&quot;, &quot;&quot;, &quot;id='imgstatutbreve$id_breve' border='0' style='margin: 1px;'&quot;). &quot;&lt;/div&gt;&quot;
-			. &quot;&lt;div class='puce_breve_popup' id='statutdecalbreve$id_breve' onmouseout=\&quot;cacher('statutdecalbreve$id_breve');\&quot; style=' margin-left: -&quot;.((9*$clip)+1).&quot;px;'&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecalbreve$id_breve');\&quot; href=\&quot;javascript:selec_statut_breve($id_breve, 0, 'prop');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-orange-breve.gif&quot;, &quot;&quot;, &quot;title=\&quot;&quot;._T('texte_statut_propose_evaluation').&quot;\&quot;&quot;) . &quot;&lt;/a&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecalbreve$id_breve');\&quot; href=\&quot;javascript:selec_statut_breve($id_breve, 1, 'publie');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-verte-breve.gif&quot;, &quot;&quot;, &quot;title=\&quot;&quot;._T('texte_statut_publie').&quot;\&quot;&quot;). &quot;&lt;/a&gt;&quot;
-			. &quot;&lt;a onmouseover=\&quot;montrer('statutdecalbreve$id_breve');\&quot; href=\&quot;javascript:selec_statut_breve($id_breve, 2, 'refuse');\&quot;&gt;&quot; .
-		  http_img_pack(&quot;puce-rouge-breve.gif&quot;, &quot;&quot;, &quot;title=\&quot;&quot;._T('texte_statut_refuse').&quot;\&quot;&quot;). &quot;&lt;/a&gt;&quot;
-			. &quot;&lt;/div&gt;&lt;/div&gt;&quot;;
-	} else {
-		$inser_puce = http_img_pack(&quot;$puce&quot;, &quot;&quot;, &quot;id='imgstatut$id_article' border='0' style='margin: 1px;'&quot;);
-	}
-	return $inser_puce;
+	return	&quot;&lt;div class='puce_breve' id='$type1'$dir_lang&gt;&quot;
+		. &quot;&lt;div class='puce_breve_fixe' $action&gt;&quot;
+		. $inser_puce
+		. &quot;&lt;/div&gt;&quot;
+		. &quot;&lt;div class='puce_breve_popup' id='$type2' onmouseout=\&quot;cacher('$type2');\&quot; style=' margin-left: -&quot;.((9*$clip)+1).&quot;px;'&gt;&quot;
+		. http_href_img(&quot;javascript:selec_statut($id, '$type', -1, '&quot; . _DIR_IMG_PACK . $puces[0] . &quot;', 'prop');&quot;,
+			$puces[0],
+			&quot;title=\&quot;&quot;._T('texte_statut_propose_evaluation').&quot;\&quot;&quot;,
+			'','','',
+			$action)
+		. http_href_img(&quot;javascript:selec_statut($id, '$type', -10, '&quot; . _DIR_IMG_PACK .$puces[1] . &quot;', 'publie');&quot;,
+		 	$puces[1],
+			&quot;title=\&quot;&quot;._T('texte_statut_publie').&quot;\&quot;&quot;,
+			'','','',
+			$action)
+		. http_href_img(&quot;javascript:selec_statut($id, '$type', -19, '&quot; . _DIR_IMG_PACK .$puces[2] . &quot;', 'refuse');&quot;,
+			$puces[2],
+			&quot;title=\&quot;&quot;._T('texte_statut_refuse').&quot;\&quot;&quot;,
+			'','','',
+			$action)
+		.  &quot;&lt;/div&gt;&lt;/div&gt;&quot;;
 }
 
 
@@ -789,13 +835,14 @@
 
 			$s = affdate_jourcourt($date);
 			
+			/* # ca fait mal a la tete ce truc
 			if ($afficher_visites AND $visites &gt; 0) {
 				$s .= &quot;&lt;br&gt;&lt;font size=\&quot;1\&quot;&gt;&lt;a href='statistiques_visites.php3?id_article=$id_article'&gt;&quot;._T('lien_visites', array('visites' =&gt; $visites)).&quot;&lt;/a&gt;&lt;/font&gt;&quot;;
 				if ($popularite &gt; 0) $s .= &quot;&lt;br&gt;&lt;font size=\&quot;1\&quot;&gt;&lt;a href='statistiques_visites.php3?id_article=$id_article'&gt;&quot;._T('lien_popularite', array('popularite' =&gt; $popularite)).&quot;&lt;/a&gt;&lt;/font&gt;&quot;;
 
 				$s = &quot;&lt;div class='liste_clip' style='width: 100px;'&gt;$s&lt;/div&gt;&quot;;
 			}
-			
+			*/
 			
 			$vals[] = $s;
 			
@@ -888,8 +935,7 @@
 			if ($lang = $row['lang']) changer_typo($lang);
 			$id_rubrique = $row['id_rubrique'];
 			
-			$vals[] = puce_statut_breve($id_breve, $statut);
-			
+			$vals[] = puce_statut_breve($id_breve, $statut, 'breve');
 
 			$s = &quot;&lt;div&gt;&quot;;
 			$s .= &quot;&lt;a href='breves_voir.php3?id_breve=$id_breve'$dir_lang style=\&quot;display:block;\&quot;&gt;&quot;;
@@ -1245,7 +1291,7 @@
 					$heure_fin = &quot;...&quot;;
 
 				$s = &quot;&lt;div &quot; . 
-				  http_style_background('rv-12.gif', &quot;$spip_lang_left center no-repeat; padding-$spip_lang_left: 15px;'&quot;) .
+				  http_style_background('rv-12.gif', &quot;$spip_lang_left center no-repeat; padding-$spip_lang_left: 15px&quot;) .
 				  &quot;&gt;&lt;a href='calendrier_jour.php3?jour=$jour&amp;mois=$mois&amp;annee=$annee'&gt;&lt;b style='color: black;'&gt;$s&lt;/b&gt;&lt;br /&gt;$heure-$heure_fin&lt;/a&gt;&lt;/div&gt;&quot;;
 			} else {
 				$s = &quot;&lt;font color='#999999'&gt;$s&lt;/font&gt;&quot;;
@@ -1509,6 +1555,7 @@
 	global $couleur_foncee, $couleur_claire, $couleur_lien, $couleur_lien_off;
 	global $mode, $spip_lang_rtl, $spip_display;
 	global $connect_statut, $connect_toutes_rubriques;
+	global $browser_name, $browser_rev;
 
 	// hack pour compatibilite spip-lab
 	if (strpos($rubrique, 'script&gt;')) {
@@ -1549,306 +1596,47 @@
 	// &lt; script type=&quot;text/javascript&quot; src=&quot;js_detectplugins.js&quot;&gt;&lt;/script&gt;
 
 	debut_javascript($connect_statut == &quot;0minirezo&quot; AND $connect_toutes_rubriques, (lire_meta(&quot;activer_statistiques&quot;) != 'non'));
-?&gt;
-	  &lt;link rel=&quot;alternate stylesheet&quot; href=&quot;spip_style_invisible.css&quot; type=&quot;text/css&quot; title=&quot;invisible&quot; /&gt;
-	&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style_visible.css&quot; type=&quot;text/css&quot; title=&quot;visible&quot; /&gt;
-	&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style_print.css&quot; type=&quot;text/css&quot; media=&quot;print&quot;&gt;
 
-&lt;/head&gt;
-&lt;?php
-	echo &quot;&lt;body text='#000000' bgcolor='#f8f7f3' link='$couleur_lien' vlink='$couleur_lien_off' alink='$couleur_lien_off' topmargin='0' leftmargin='0' marginwidth='0' marginheight='0' frameborder='0'&quot;;
+	echo '&lt;link rel=&quot;alternate stylesheet&quot; href=&quot;', _DIR_RESTREINT, 'spip_style_invisible.css&quot; type=&quot;text/css&quot; title=&quot;invisible&quot; /&gt;', &quot;\n&quot;,
+		'&lt;link rel=&quot;stylesheet&quot; href=&quot;', _DIR_RESTREINT, 'spip_style_visible.css&quot; type=&quot;text/css&quot; title=&quot;visible&quot; /&gt;', &quot;\n&quot;,
+		'&lt;link rel=&quot;stylesheet&quot; href=&quot;', _DIR_RESTREINT, 'spip_style_print.css&quot; type=&quot;text/css&quot; media=&quot;print&quot;&gt;', &quot;\n&quot;,
+		&quot;&lt;/head&gt;\n&lt;body text='#000000' bgcolor='#f8f7f3' link='$couleur_lien' vlink='$couleur_lien_off' alink='$couleur_lien_off' topmargin='0' leftmargin='0' marginwidth='0' marginheight='0' frameborder='0'&quot;;
 
 	if ($spip_lang_rtl)
 		echo &quot; dir='rtl'&quot;;
 	//if ($mode == &quot;wysiwyg&quot;) echo &quot; onLoad='debut_editor();'&quot;;
-	echo &quot; onLoad=\&quot;setActiveStyleSheet('invisible'); verifForm();$onLoad\&quot;&quot;;
-	echo &quot;&gt;&quot;;
+	echo &quot; onLoad=\&quot;setActiveStyleSheet('invisible'); &quot;;
+
+	// Hack pour forcer largeur des formo/forml sous Mozilla &gt;= 1.7
+	// meme principe que le behavior win_width.htc pour MSIE
+	if (eregi(&quot;mozilla&quot;, $browser_name) AND $browser_rev &gt;= 1.7)
+		echo &quot;verifForm();&quot;;
+	echo &quot;$onLoad\&quot;&gt;&quot;;
 }
 
 function debut_javascript($admin, $stat)
 {
 	global $spip_lang_left;
-	global $browser_name, $browser_version, $browser_rev;
+	global $browser_name, $browser_version;
 
 	// envoi le fichier JS de config si browser ok.
 	echo $GLOBALS['browser_layer'];
 ?&gt;
 &lt;script type='text/javascript'&gt;&lt;!--
-	var init_gauche = true;
-
-	function changestyle(id_couche, element, style) {
-
-		&lt;?php if ($admin) { ?&gt;
-			hide_obj(&quot;bandeaudocuments&quot;);
-			hide_obj(&quot;bandeauredacteurs&quot;);
-			hide_obj(&quot;bandeauauteurs&quot;);
-			&lt;?php if ($stat) { ?&gt; hide_obj(&quot;bandeausuivi&quot;); &lt;?php } ?&gt;
-			hide_obj(&quot;bandeauadministration&quot;); 
-		&lt;?php } ?&gt;
-		
-		hide_obj(&quot;bandeaudeconnecter&quot;);
-		hide_obj(&quot;bandeautoutsite&quot;);
-		hide_obj(&quot;bandeaunavrapide&quot;);
-		hide_obj(&quot;bandeauagenda&quot;);
-		hide_obj(&quot;bandeaumessagerie&quot;);
-		hide_obj(&quot;bandeausynchro&quot;);
-		hide_obj(&quot;bandeaurecherche&quot;);
-		hide_obj(&quot;bandeauinfoperso&quot;);
-		hide_obj(&quot;bandeaudisplay&quot;);
-		hide_obj(&quot;bandeauecran&quot;);
-		hide_obj(&quot;bandeauinterface&quot;);
-		
-		
-		if (init_gauche) {
-		&lt;?php if ($admin) { ?&gt;
-			decalerCouche('bandeaudocuments');
-			decalerCouche('bandeauredacteurs');
-			decalerCouche('bandeauauteurs');
-			&lt;?php if ($stat) ?&gt; decalerCouche('bandeausuivi');
-			decalerCouche('bandeauadministration');
-		&lt;?php } ?&gt;
-			init_gauche = false;
-		}
-		
-		
-		if (!(layer = findObj(id_couche))) return;
-	
-		layer.style[element] = style;
-	}
-	
-	function decalerCouche(id_couche) {
-		if (!(layer = findObj(id_couche))) return;
-				
-		&lt;?php 
-		    if (($spip_lang_left == &quot;left&quot;) &amp;&amp;
-					   // bug offsetwidth
-			($browser_name != &quot;MSIE&quot; OR $browser_version &gt;= 6))
-		
-		      {  /* uniquement affichage ltr: bug Mozilla dans offsetWidth quand ecran inverse! */  ?&gt;
-		
-		if ( parseInt(layer.style.&lt;?php echo $spip_lang_left; ?&gt;) &gt; 0) {
-
-
-			gauche = parseInt(layer.style.&lt;?php echo $spip_lang_left; ?&gt;) - Math.floor( layer.offsetWidth / 2 ) + Math.floor(&lt;?php echo largeur_icone_bandeau_principal(_T('icone_a_suivre')); ?&gt; / 2);
-			if (gauche &lt; 0) gauche = 0;
-
-			layer.style.&lt;?php echo $spip_lang_left; ?&gt; = gauche+&quot;px&quot;;
-		}
-		
-		&lt;?php } ?&gt;
-		
-	}	
-
-	var accepter_change_statut;
-	
-	function selec_statut_art(id_article, clip, statut) {
-
-		if (!accepter_change_statut) {
-			accepter_change_statut = confirm ('&lt;?php 
-				include_ecrire(&quot;inc_charsets.php3&quot;);
-				echo unicode_to_javascript(addslashes(html2unicode(_T(&quot;confirm_changer_statut&quot;)))); ?&gt;');
-		}
-
-		if (accepter_change_statut) {
-			decal = -1 * ((clip*11) + 1);
-			changestyle ('statutdecal'+id_article, 'marginLeft', decal+'px');
-			cacher ('statutdecal'+id_article);
-	
-			if (clip == 0) puce = 'blanche';
-			else if (clip == 1) puce = 'orange';
-			else if (clip == 2) puce = 'verte';
-			else if (clip == 3) puce = 'rouge';
-			else if (clip == 4) puce = 'poubelle';
-	
-			findObj('imgstatut'+id_article).src= '&lt;?php echo _DIR_IMG_PACK; ?&gt;puce-'+puce +'.gif';
-			
-			frames['iframe_action'].location.href = 'iframe_action.php3?action=statut_article&amp;id_article='+id_article+'&amp;statut='+statut;
-		}
-	}
-	
-	function selec_statut_breve(id_breve, clip, statut) {
-	
-		if (!accepter_change_statut) {
-			accepter_change_statut = confirm ('&lt;?php 
-				include_ecrire(&quot;inc_charsets.php3&quot;);
-				echo unicode_to_javascript(addslashes(html2unicode(_T(&quot;confirm_changer_statut&quot;)))); ?&gt;');
-		}
-
-		if (accepter_change_statut) {
-			decal = -1 * ((clip*9) + 1);
-			changestyle ('statutdecalbreve'+id_breve, 'marginLeft', decal+'px');
-			cacher ('statutdecalbreve'+id_breve);
-	
-			if (clip == 0) puce = 'orange';
-			else if (clip == 1) puce = 'verte';
-			else if (clip == 2) puce = 'rouge';
-	
-			findObj('imgstatutbreve'+id_breve).src= '&lt;?php echo _DIR_IMG_PACK; ?&gt;puce-'+puce +'-breve.gif';
-			
-			frames['iframe_action'].location.href = 'iframe_action.php3?action=statut_breve&amp;id_breve='+id_breve+'&amp;statut='+statut;
-		}
-	}
-	
-	function changeclass(objet, myClass)
-	{
-			objet.className = myClass;
-	}
-	function changesurvol(iddiv, myClass)
-	{
-			document.getElementById(iddiv).className = myClass;
-	}
-	function setActiveStyleSheet(title) {
-	   var i, a, main;
-	   for(i=0; (a = document.getElementsByTagName(&quot;link&quot;)[i]); i++) {
-		 if(a.getAttribute(&quot;rel&quot;).indexOf(&quot;style&quot;) != -1
-			&amp;&amp; a.getAttribute(&quot;title&quot;)) {
-		   a.disabled = true;
-		   if(a.getAttribute(&quot;title&quot;) == title) a.disabled = false;
-		 }
-	   }
-	}
-	
-	function setvisibility (objet, statut) {
-		element = findObj(objet);
-		if (element.style.visibility != statut) element.style.visibility = statut;
-	}
-	
-	function montrer(objet) {
-		setvisibility(objet, 'visible');
-	}
-	function cacher(objet) {
-		setvisibility(objet, 'hidden');
-	}
-	
-	
-	
-	function getHeight(obj) {
-		if (obj == &quot;window&quot;) {
-			return hauteur_fenetre();
-		}
-		else
-		{
-			obj = document.getElementById(obj);
-			if (obj.offsetHeight) return obj.offsetHeight;
-		}
-	}
-	function hauteur_fenetre() {
-		var myWidth = 0, myHeight = 0;
-		if( typeof( window.innerWidth ) == 'number' ) {
-			//Non-IE
-			myHeight = window.innerHeight;
-		} else {
-			if( document.documentElement &amp;&amp;
-				( document.documentElement.clientWidth || document.documentElement.clientHeight ) ) {
-				//IE 6+ in 'standards compliant mode'
-				myHeight = document.documentElement.clientHeight;
-			} else {
-				if( document.body &amp;&amp; ( document.body.clientWidth || document.body.clientHeight ) ) {
-					//IE 4 compatible
-					myHeight = document.body.clientHeight;
-				}
-			}
-		}
-		return myHeight;
-	}
-
-	
-	function hauteurFrame(nbCol) {
-		hauteur = hauteur_fenetre() - 40;
-		hauteur = hauteur - getHeight('haut-page');
-		
-		if (findObj('brouteur_hierarchie')) hauteur = hauteur - getHeight('brouteur_hierarchie');
-			
-		for (i=0; i&lt;nbCol; i++) {
-			source = document.getElementById(&quot;iframe&quot; + i);
-			source.style.height = hauteur + 'px';
-		}
-	}
-
-	function hauteurTextarea() {
-		hauteur = hauteur_fenetre() - 80;
-		
-		source = document.getElementById(&quot;text_area&quot;);
-		source.style.height = hauteur + 'px';
-	}
-
-	function changeVisible(input, id, select, nonselect) {
-		if (input) {
-			element = findObj(id);
-			if (element.style.display != select)  element.style.display = select;
-		} else {
-			element = findObj(id);
-			if (element.style.display != nonselect)  element.style.display = nonselect;
-		}
-		
-	}
-	
-	
-
-	
-	
-	function verifForm() {
-		/* if (pluginlist.indexOf(&quot;SVG&quot;)!=-1)
-			document.cookie = &quot;spip_svg_plugin=oui&quot;;
-		else
-			document.cookie = &quot;spip_svg_plugin=non&quot;;
-		*/
-	
-		//convert2math();
-	&lt;?php
-		// Hack pour forcer largeur des formo/forml sous Mozilla &gt;= 1.7
-		// meme principe que le behavior win_width.htc pour MSIE
-		if (eregi(&quot;mozilla&quot;, $browser_name) AND $browser_rev &gt;= 1.7) {
-	?&gt;
-		
-	
-		retrait = 16;
-		var obj=document.getElementsByTagName(&quot;input&quot;);
-		for(i=0;i&lt;obj.length;i++) {
-			if(obj[i].className==&quot;forml&quot; || obj[i].className==&quot;formo&quot;) {
-				element = obj[i];
-				if (element.offsetWidth) {
-					obj[i][&quot;nouvelle-largeur&quot;] = (element.offsetWidth - retrait) + &quot;px&quot;;
-				} else {
-					obj[i][&quot;nouvelle-largeur&quot;] = &quot;95%&quot;;
-				}
-			}
-		}
-		
-		var objx=document.getElementsByTagName(&quot;textarea&quot;);
-		for(i=0;i&lt;objx.length;i++) {
-			if(objx[i].className==&quot;forml&quot; || objx[i].className==&quot;formo&quot;) {
-				element = objx[i];
-				if (element.offsetWidth) {
-					objx[i][&quot;nouvelle-largeur&quot;] = (element.offsetWidth - retrait) + &quot;px&quot;;
-				} else {
-					objx[i][&quot;nouvelle-largeur&quot;] = &quot;95%&quot;;
-				}
-			}
-		}
-		
-		// Appliquer les modifs apres les calculs, sinon des decalages peuvent apparaitre
-		for(i=0;i&lt;obj.length;i++) {
-			if (obj[i][&quot;nouvelle-largeur&quot;]) obj[i].style.width = obj[i][&quot;nouvelle-largeur&quot;];
-		}
-	
-		for(i=0;i&lt;objx.length;i++) {
-			if (objx[i][&quot;nouvelle-largeur&quot;]) objx[i].style.width = objx[i][&quot;nouvelle-largeur&quot;];
-		}
-	
-		
-		
-	&lt;?php
-		}
-	?&gt;
-	}
+	var admin = &lt;?php echo ($admin ? 1 : 0) ?&gt;;
+	var stat = &lt;?php echo ($stat ? 1 : 0) ?&gt;;
+	var largeur_icone = &lt;?php echo largeur_icone_bandeau_principal(_T('icone_a_suivre')); ?&gt;;
+	var  bug_offsetwidth = &lt;?php 
+// uniquement affichage ltr: bug Mozilla dans offsetWidth quand ecran inverse!
+	  echo ((($spip_lang_left == &quot;left&quot;) &amp;&amp;
+		 (($browser_name != &quot;MSIE&quot;) ||
+		  ($browser_version &gt;= 6))) ? 1 : 0) ?&gt; ;
 
-	
-	var antifocus=false; // effacement titre quand new=oui
-	
+	var confirm_changer_statut = '&lt;?php include_ecrire(&quot;inc_charsets.php3&quot;); echo unicode_to_javascript(addslashes(html2unicode(_T(&quot;confirm_changer_statut&quot;)))); ?&gt;';
 //--&gt;&lt;/script&gt;
 &lt;?php
-    }
+	echo http_script('',_DIR_RESTREINT . 'presentation.js');
+}
 
 // Fonctions onglets
 
@@ -2370,19 +2158,22 @@
 			$activer_sites = lire_meta('activer_sites');
 			if ($activer_sites&lt;&gt;'non')
 				icone_bandeau_secondaire (_T('icone_sites_references'), &quot;sites_tous.php3&quot;, &quot;site-24.gif&quot;, &quot;sites&quot;, $sous_rubrique);
-			
-//////////////////////////
-//MODIFICATION
-//////////////////////////
-//une requete en moins ...
+
+			//////////////////////////
+			//MODIFICATION
+			//////////////////////////
+			//if (@spip_num_rows(spip_query(&quot;SELECT * FROM spip_documents_rubriques LIMIT 0,1&quot;)) &gt; 0) {
+			//	icone_bandeau_secondaire (_T('icone_doc_rubrique'), &quot;documents_liste.php3&quot;, &quot;doc-24.gif&quot;, &quot;documents&quot;, $sous_rubrique);
+			//}
+			//une requete en moins ...
 			if (lire_meta('documents_rubrique')== 'oui') 
 				icone_bandeau_secondaire (_T('icone_doc_rubrique'), &quot;documents_liste.php3&quot;, &quot;doc-24.gif&quot;, &quot;documents&quot;, $sous_rubrique);
-
-//les cartes
+			
+			//les cartes
 			//if (@spip_num_rows(spip_query(&quot;SELECT * FROM spip_carto_carte LIMIT 0,1&quot;)) &gt; 0) 
 			if (lire_meta('activer_carto')== 'oui') 
 				icone_bandeau_secondaire(_L(&quot;Cartes&quot;), &quot;cartes.php3&quot;, &quot;carte-24.png&quot;, &quot;cartes&quot;, $sous_rubrique);
-////////////////						
+			////////////////						
 		}
 		echo &quot;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/div&gt;&quot;;
 	}
@@ -2404,7 +2195,7 @@
 
 				icone_bandeau_secondaire (_T('icone_suivi_forums'), &quot;controle_forum.php3&quot;, &quot;suivi-forum-24.gif&quot;, &quot;forum-controle&quot;, $sous_rubrique);
 				icone_bandeau_secondaire (_T('icone_suivi_pettions'), &quot;controle_petition.php3&quot;, &quot;suivi-petition-24.gif&quot;, &quot;suivi-petition&quot;, $sous_rubrique);
-				
+
 			echo &quot;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/div&gt;&quot;;
 	
 	}
@@ -2589,13 +2380,15 @@
 			// Choix de la couleur: automatique en fonction de $couleurs_spip
 
 			$link = new Link;
-			ksort($couleurs_spip);
-			while (list($key,$val) = each($couleurs_spip)) {
+			if ($couleurs_spip) {
+			  ksort($couleurs_spip);
+			  while (list($key,$val) = each($couleurs_spip)) {
 					$link-&gt;delVar('set_couleur');
 					$link-&gt;addVar('set_couleur', $key);
 					
 					echo &quot;&lt;a href=\&quot;&quot;.$link-&gt;getUrl().&quot;\&quot;&gt;&quot; .
 					  http_img_pack(&quot;rien.gif&quot;, &quot;&quot;, &quot;width='8' height='8' border='0' style='margin: 1px; background-color: &quot;.$couleurs_spip[$key]['couleur_claire'].&quot;;' onMouseOver=\&quot;changestyle('bandeauinterface','visibility', 'visible');\&quot;&quot;). &quot;&lt;/a&gt;&quot;;
+			  }
 			}
 			// echo &quot;&lt;img src=_DIR_IMG_PACK . 'rien.gif' width='10' height='1' /&gt;&quot;;
 		echo &quot;&lt;/td&gt;&quot;;
@@ -2737,7 +2530,7 @@
 			if (lire_meta(&quot;activer_sites&quot;) == 'oui') {
 				if ($connect_statut == '0minirezo' OR lire_meta(&quot;proposer_sites&quot;) &gt; 0) {
 					$gadget .= &quot;&lt;div style='width: 140px; float: $spip_lang_left;'&gt;&quot;;
-					$gadget .= icone_horizontale(_T('info_sites_referencer'), &quot;sites_edit.php3?new=oui$dans_rub&quot;, &quot;site-24.gif&quot;,&quot;creer.gif&quot;, false);
+					$gadget .= icone_horizontale(_T('info_sites_referencer'), &quot;sites_edit.php3?new=oui&amp;target=sites.php3$dans_rub&quot;, &quot;site-24.gif&quot;,&quot;creer.gif&quot;, false);
 					$gadget .= &quot;&lt;/div&gt;&quot;;
 				}
 			}
@@ -3180,15 +2973,20 @@
 
 	echo &quot;&lt;/body&gt;&lt;/html&gt;\n&quot;;
 
-	if ($GLOBALS['flag_ob'])
-		@ob_end_flush();
 }
 
+function info_copyright() {
+	global $spip_version_affichee;
+
+	echo _T('info_copyright', 
+		   array('spip' =&gt; &quot;&lt;b&gt;SPIP $spip_version_affichee&lt;/b&gt; &quot;,
+			      'lien_gpl' =&gt; 
+				&quot;&lt;a href='aide_index.php3?aide=licence&amp;var_lang=&quot;.$GLOBALS['spip_lang'].&quot;' target='spip_aide' onClick=\&quot;javascript:window.open(this.href, 'aide_spip', 'scrollbars=yes,resizable=yes,width=740,height=580'); return false;\&quot;&gt;&quot; . _T('info_copyright_gpl').&quot;&lt;/a&gt;&quot;));
+
+}
 
 function fin_page($credits='') {
-	global $spip_version_affichee, $spip_display;
-	global $connect_id_auteur;
-	global $multi_popup;
+	global $spip_display;
 
 	echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
 
@@ -3201,16 +2999,9 @@
 
 	if ($spip_display == 4) {
 		echo &quot;&lt;div&gt;&lt;a href=\&quot;index.php3?set_disp=2\&quot;&gt;&quot;._T(&quot;access_interface_graphique&quot;).&quot;&lt;/a&gt;&lt;/div&gt;&quot;;
-	} else {	
-
-		echo &quot;&lt;b&gt;SPIP $spip_version_affichee&lt;/b&gt; &quot;;
-		echo _T('info_copyright');
-	
+	} else {
+		echo info_copyright();
 		echo &quot;&lt;br&gt;&quot;._T('info_copyright_doc');
-	
-	//	if (ereg(&quot;jimmac&quot;, $credits))
-	//		echo &quot;&lt;br&gt;&quot;._T('lien_icones_interface');
-	
 		echo &quot;&lt;/div&gt;&lt;p&gt;&quot;;
 	}
 
@@ -3304,7 +3095,19 @@
 	&lt;font face='Verdana,Arial,Sans,sans-serif' size='4' color='#970038'&gt;&lt;B&gt;$titre&lt;/b&gt;&lt;/font&gt;\n&lt;p&gt;&quot;;
 }
 
-function install_fin_html() {
+function install_fin_html($suite = '') {
+
+	// bouton retour
+	global $spip_lang_right;
+	if ($suite) {
+		$link = new Link($suite);
+		echo $link-&gt;getForm();
+		echo &quot;&lt;DIV align='$spip_lang_right'&gt;&quot;
+		. &quot;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;
+		. _T('bouton_suivant').&quot; &gt;&gt;'&gt;&lt;/div&gt;&quot;
+		. &quot;&lt;/FORM&gt;&quot;;
+	}
+
 	echo '
 	&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 	&lt;/center&gt;
@@ -3350,36 +3153,21 @@
 		$message = _T('icone_voir_en_ligne');
 	else if ($en_ligne == 'preview') {
 		// est-ce autorise ?
-		if (lire_meta('preview') == 'non'
-			OR (lire_meta('preview') == '1comite'
-			AND $connect_statut=='1comite')
-		)
-			$message = '';
-		else
+		if ((lire_meta('preview') == 'oui' AND $connect_statut=='0minirezo')
+			OR (lire_meta('preview') == '1comite'))
 			$message = _T('previsualiser');
+		else
+			$message = '';
 	}
 
 	if ($message)
 		icone_horizontale($message, &quot;../spip_redirect.php3?id_$type=$id&amp;$en_ligne=oui&quot;, $image, &quot;rien.gif&quot;);
 }
 
-// produit une balise img avec un champ alt d'office (et different) si vide
-// attention le htmlentities et la traduction doivent etre appliques avant.
-
-function http_img_pack($img, $alt, $att) {
-  static $num = 0;
-  return &quot;&lt;img src='&quot; . _DIR_IMG_PACK . $img .
-    (&quot;'\nalt=\&quot;&quot; . ($alt ? $alt : ('img_pack' . $num++)) . '&quot; ') .
-    $att . &quot; /&gt;&quot;;
-}
 
 function http_style_background($img, $att='')
 {
   return &quot; style='background: url(\&quot;&quot; . _DIR_IMG_PACK . $img .  '&quot;)' .
     ($att ? (' ' . $att) : '') . &quot;;'&quot;;
-}
-
-function http_href_img($href, $img, $att, $title='', $style='', $class='') {
- return  http_href($href, http_img_pack($img, $title, $att), $title, $style, $class);
 }
 ?&gt;

Index: inc_tidy.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_tidy.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_tidy.php	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_tidy.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_TIDY&quot;)) return;

Index: iframe_action.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/iframe_action.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- iframe_action.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ iframe_action.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,17 +1,29 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
 include (&quot;inc.php3&quot;);
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at header</A>(&quot;Cache-Control: no-store, no-cache, must-revalidate&quot;);
 echo &quot;&quot;;
 
-if ($connect_statut == &quot;0minirezo&quot;) {
+if (($id &gt; 0) &amp;&amp; ($connect_statut == &quot;0minirezo&quot;)) {
 
 
 	#### OUH LA, il faudrait passer ca et les modifs des articles.php3 etc
 	#### dans un seul fichier, sinon toute modif faite ici doit etre reportee
 	#### la, et inversement : l'enfer
 
-	if ($action == 'statut_article' AND $id_article &gt; 0) {
+	if ($action == 'statut_article') {
 
+		$id_article = $id;
 		$query = &quot;SELECT statut FROM spip_articles WHERE id_article=$id_article&quot;;
 		$result = spip_query($query);
 		if ($row = spip_fetch_array($result)) {
@@ -45,8 +57,9 @@
 		}
 	}
 
-	if ($action == 'statut_breve' AND $id_breve &gt; 0) {
+	elseif ($action == 'statut_breve') {
 
+		$id_breve = $id;
 		$query = &quot;SELECT statut FROM spip_breves WHERE id_breve=$id_breve&quot;;
 		$result = spip_query($query);
 		if ($row = spip_fetch_array($result)) {
@@ -61,9 +74,5 @@
 			calculer_rubriques();
 		}
 	}
-
-}
-
-
-
-?&gt;
\ No newline at end of file
+ }
+?&gt;

Index: admin_vider.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_vider.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- admin_vider.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ admin_vider.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_admin.php3&quot;);

Index: naviguer.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/naviguer.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- naviguer.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ naviguer.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_logos.php3&quot;);
 include_ecrire (&quot;inc_mots.php3&quot;);
@@ -170,11 +181,14 @@
 if ($titre) {
 	// creation, le cas echeant
 	if ($new == 'oui' AND $flag_editable AND !$id_rubrique) {
-		$id_rubrique = spip_abstract_insert(&quot;rubriques&quot;, 
-				    &quot;(titre, id_parent)&quot;,
-				    &quot;('&quot;._T('item_nouvelle_rubrique').&quot;', '$id_parent')&quot;);
-		$result = spip_query($query);
-		$clean_link-&gt;AddVar('id_rubrique', $id_rubrique);
+		$id_rubrique = spip_abstract_insert(&quot;spip_rubriques&quot;, 
+			&quot;(titre, id_parent)&quot;,
+			&quot;('&quot;._T('item_nouvelle_rubrique').&quot;', '$id_parent')&quot;);
+
+		// Modifier le lien de base pour qu'il prenne en compte le nouvel id
+		unset($_POST['id_parent']);
+		$_POST['id_rubrique'] = $id_rubrique;
+		$clean_link = new Link();
 	}
 
 	// si c'est une rubrique-secteur contenant des breves, ne deplacer
@@ -264,36 +278,6 @@
 	$titre_page = _T('titre_naviguer_dans_le_site');
 
 
-if ($id_document) {
-	$query_doc = &quot;SELECT * FROM spip_documents_rubriques WHERE id_document=$id_document AND id_rubrique=$id_rubrique&quot;;
-	$result_doc = spip_query($query_doc);
-	$flag_document_editable = (spip_num_rows($result_doc) &gt; 0);
-} else {
-	$flag_document_editable = false;
-}
-
-
-$modif_document = $GLOBALS['modif_document'];
-if ($modif_document == 'oui' AND $flag_document_editable) {
-	$titre_document = addslashes(corriger_caracteres($titre_document));
-	$descriptif_document = addslashes(corriger_caracteres($descriptif_document));
-
-	$query = &quot;UPDATE spip_documents SET titre='$titre_document', descriptif='$descriptif_document'&quot;;
-	if ($largeur_document AND $hauteur_document) $query .= &quot;, largeur='$largeur_document', hauteur='$hauteur_document'&quot;;
-	$query .= &quot; WHERE id_document=$id_document&quot;;
-	spip_query($query);
-
-	if ($jour_doc AND $connect_statut == '0minirezo' AND acces_rubrique($id_rubrique)) {
-		if ($annee_doc == &quot;0000&quot;) $mois_doc = &quot;00&quot;;
-		if ($mois_doc == &quot;00&quot;) $jour_doc = &quot;00&quot;;
-		$query = &quot;UPDATE spip_documents SET date='$annee_doc-$mois_doc-$jour_doc' WHERE id_document=$id_document&quot;;
-		$result = spip_query($query);
-		calculer_rubriques();
-	}
-
-}
-
-
 ///// debut de la page
 debut_page($titre_page, &quot;documents&quot;, &quot;rubriques&quot;);
 
@@ -331,14 +315,14 @@
 	// Logos de la rubrique
 	//
 	
-	$rubon = &quot;rubon$id_rubrique&quot;;
-	$ruboff = &quot;ruboff$id_rubrique&quot;;
-	
 	if ($connect_statut == '0minirezo' AND acces_rubrique($id_rubrique)) {
-		if ($id_rubrique &gt; 0)
-			afficher_boite_logo($rubon, $ruboff, _T('logo_rubrique').&quot; &quot;.aide (&quot;rublogo&quot;), _T('logo_survol'));
+		if ($id_rubrique)
+			afficher_boite_logo('rub', 'id_rubrique', $id_rubrique,
+			_T('logo_rubrique').&quot; &quot;.aide (&quot;rublogo&quot;), _T('logo_survol'));
 		else
-			afficher_boite_logo($rubon, $ruboff, _T('logo_standard_rubrique').&quot; &quot;.aide (&quot;rublogo&quot;), _T('logo_survol'));
+			afficher_boite_logo('rub', 'id_rubrique', 0,
+			_T('logo_standard_rubrique').&quot; &quot;.aide (&quot;rublogo&quot;),
+			_T('logo_survol'));
 	}
 	
 	
@@ -643,9 +627,11 @@
 
 /// Documents associes a la rubrique
 
-if ($id_rubrique&gt;0)
+if ($id_rubrique&gt;0) {
+	# modifs de la description d'un des docs joints
+	if ($flag_editable) maj_documents($id_rubrique, 'rubrique');
 	 afficher_documents_non_inclus($id_rubrique, &quot;rubrique&quot;, $flag_editable);
-
+}
 
 
 

Index: inc_auth_spip.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_auth_spip.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_auth_spip.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_auth_spip.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_AUTH_SPIP&quot;)) return;

Index: articles.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ articles.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_logos.php3&quot;);
@@ -32,13 +43,17 @@
 
 		$forums_publics = substr(lire_meta('forums_publics'),0,3);
 
-		$id_article = spip_abstract_insert(&quot;articles&quot;,
-					     &quot;(id_rubrique, statut, date, accepter_forum, lang, langue_choisie)&quot;, 
-					     &quot;($id_rubrique, 'prepa', NOW(), '$forums_publics', '$langue_new', '$langue_choisie_new')&quot;);
-
+		$id_article = spip_abstract_insert(&quot;spip_articles&quot;,
+			&quot;(id_rubrique, statut, date, accepter_forum, lang, langue_choisie)&quot;, 
+			&quot;($id_rubrique, 'prepa', NOW(), '$forums_publics', '$langue_new', '$langue_choisie_new')&quot;);
 
 		spip_query(&quot;DELETE FROM spip_auteurs_articles WHERE id_article = $id_article&quot;);
 		spip_query(&quot;INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES ($connect_id_auteur, $id_article)&quot;);
+
+		// Modifier le lien de base pour qu'il prenne en compte le nouvel id
+		unset($_POST['id_rubrique']);
+		$_POST['id_article'] = $id_article;
+		$clean_link = new Link();
 	} else {
 		redirige_par_entete(&quot;./index.php3&quot;);
 	}
@@ -73,18 +88,6 @@
 
 
 
-/// En double avec articles_edit.php3, mais necessite le flag_editable
-$modif_document = $GLOBALS['modif_document'];
-if ($modif_document == 'oui' AND $flag_editable) {
-	$titre_document = addslashes(corriger_caracteres($titre_document));
-	$descriptif_document = addslashes(corriger_caracteres($descriptif_document));
-	$query = &quot;UPDATE spip_documents SET titre='$titre_document', descriptif='$descriptif_document'&quot;;
-	if ($largeur_document AND $hauteur_document) $query .= &quot;, largeur='$largeur_document', hauteur='$hauteur_document'&quot;;
-	$query .= &quot; WHERE id_document=$id_document&quot;;
-	spip_query($query);
-}
-
-
 //
 // Appliquer les modifications
 //
@@ -154,7 +157,7 @@
 
 // Appliquer la modification de langue
 if (lire_meta('multi_articles') == 'oui' AND $flag_editable) {
-	$row = spip_fetch_array(spip_query(&quot;SELECT lang FROM spip_rubriques WHERE id_rubrique=$rubrique_article&quot;));
+  $row = spip_fetch_array(spip_query(&quot;SELECT lang FROM spip_rubriques WHERE id_rubrique=&quot; . intval($rubrique_article)));
 	$langue_parent = $row['lang'];
 
 	if ($changer_lang) {
@@ -179,6 +182,10 @@
 }
 
 
+# modifs de la description d'un des docs joints
+if ($flag_editable) maj_documents($id_article, 'article');
+
+
 //
 // Reunit les textes decoupes parce que trop longs
 //
@@ -424,11 +431,9 @@
 
 // Logos de l'article
 
-$arton = &quot;arton$id_article&quot;;
-$artoff = &quot;artoff$id_article&quot;;
-
-if ($id_article&gt;0 AND $flag_editable)
-	afficher_boite_logo($arton, $artoff, _T('logo_article').aide (&quot;logoart&quot;), _T('logo_survol'));
+if ($id_article AND $flag_editable)
+	afficher_boite_logo('art', 'id_article', $id_article,
+	_T('logo_article').aide (&quot;logoart&quot;), _T('logo_survol'));
 
 
 //
@@ -459,14 +464,19 @@
 
 	$forums_publics = get_forums_publics($id_article);
 
-	if ($change_accepter_forum) {
-		$query_forum = &quot;UPDATE spip_articles SET accepter_forum='$change_accepter_forum' WHERE id_article='$id_article'&quot;;
+	if (isset($change_accepter_forum)
+	AND $change_accepter_forum &lt;&gt; $forums_publics) {
+		$query_forum = &quot;UPDATE spip_articles
+			SET accepter_forum='$change_accepter_forum'
+			WHERE id_article='$id_article'&quot;;
 		$result_forum = spip_query($query_forum);
 		$forums_publics = $change_accepter_forum;
 		if ($change_accepter_forum == 'abo') {
 			ecrire_meta('accepter_visiteurs', 'oui');
 			ecrire_metas();
 		}
+		include_ecrire('inc_invalideur.php3');
+		suivre_invalideur(&quot;id='id_forum/a$id_article'&quot;);
 	}
 
 	echo &quot;\n&lt;form action='articles.php3' method='get'&gt;&quot;;
@@ -946,7 +956,7 @@
 if ($creer_auteur AND $connect_statut=='0minirezo'){
 	$creer_auteur = addslashes($creer_auteur);
 
-	$nouv_auteur = spip_abstract_insert('auteurs', &quot;(nom, statut)&quot;,
+	$nouv_auteur = spip_abstract_insert('spip_auteurs', &quot;(nom, statut)&quot;,
 				      &quot;(\&quot;$creer_auteur\&quot;, '1comite')&quot;);
 	$ajout_auteur = true;
 }
@@ -1175,7 +1185,7 @@
 		echo &quot;&lt;span class='verdana1'&gt;&lt;B&gt;&quot;._T('titre_cadre_ajouter_auteur').&quot;&nbsp; &lt;/B&gt;&lt;/span&gt;\n&quot;;
 		echo &quot;&lt;DIV&gt;&lt;INPUT TYPE='Hidden' NAME='id_article' VALUE=\&quot;$id_article\&quot;&gt;&quot;;
 
-		if (spip_num_rows($result) &gt; 200 AND $flag_mots_ressemblants) {
+		if (spip_num_rows($result) &gt; 200) {
 			echo &quot;&lt;INPUT TYPE='text' NAME='cherche_auteur' onClick=\&quot;setvisibility('valider_ajouter_auteur','visible');\&quot; CLASS='fondl' VALUE='' SIZE='20'&gt;&quot;;
 			echo &quot;&lt;span  class='visible_au_chargement' id='valider_ajouter_auteur'&gt;&quot;;
 			echo &quot; &lt;INPUT TYPE='submit' NAME='Chercher' VALUE='&quot;._T('bouton_chercher').&quot;' CLASS='fondo'&gt;&quot;;

Index: upgrade.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/upgrade.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- upgrade.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ upgrade.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 
 if (!_FILE_CONNECT) {
@@ -38,8 +49,9 @@
 }
 
 
-
-$upgrade_titre = _T('info_mise_a_niveau_base');
+// eviter les actions vides pour cause de fichier de langue inaccessible.
+$upgrade_titre = _T('info_mise_a_niveau_base') ;
+if (!$upgrade_titre) $upgrade_titre = 'info_mise_a_niveau_base';
 
 // Commentaire standard upgrade
 $commentaire = _T('texte_mise_a_niveau_base_1');
@@ -47,6 +59,7 @@
 // Erreur downgrade (cas de double installation de fichiers SPIP sur une meme base)
 if ($spip_version &lt; (double) lire_meta('version_installee'))
 	$commentaire = _T('info_mise_a_niveau_base_2');
+
 
 // Qu'est-ce que tu fais ici?
 if ($spip_version == (double) lire_meta('version_installee')) {

Index: calendrier_semaine.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/calendrier_semaine.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- calendrier_semaine.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ calendrier_semaine.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,29 +1,16 @@
 &lt;?php
 
-include (&quot;inc.php3&quot;);
-
-// sans arguments =&gt; mois courant
-if (!$mois){
-  $today=getdate(time());
-  $jour=$today[&quot;mday&quot;];
-  $mois=$today[&quot;mon&quot;];
-  $annee=$today[&quot;year&quot;];
-}
-
-$date = date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois, $jour, $annee));
-$jour = journum($date);
-$mois = mois($date);
-$annee = annee($date);
-
-$afficher_bandeau_calendrier = true;
-$afficher_bandeau_calendrier_semaine = true;
-
-debut_page(_T('titre_page_calendrier',
-	      array('nom_mois' =&gt; nom_mois($date), 'annee' =&gt; $annee)),
-	   &quot;redacteurs&quot;, 
-	   &quot;calendrier&quot;);
-
-echo http_calendrier_semaine($jour,$mois,$annee);
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
 
-// fin_page();
+$type = 'semaine';
+include (&quot;calendrier.php3&quot;);
+exit;
 ?&gt;

Index: auteurs_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteurs_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- auteurs_edit.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ auteurs_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_acces.php3&quot;);
 include_ecrire (&quot;inc_index.php3&quot;);
@@ -88,11 +99,11 @@
 // Logos de l'auteur
 //
 
-$arton = &quot;auton$id_auteur&quot;;
-$artoff = &quot;autoff$id_auteur&quot;;
-
-if ($id_auteur&gt;0 AND (($connect_statut == '0minirezo') OR ($connect_id_auteur == $id_auteur)))
-	afficher_boite_logo($arton, $artoff, _T('logo_auteur').aide (&quot;logoart&quot;), _T('logo_survol'));
+if ($id_auteur
+AND (($connect_statut == '0minirezo')
+OR ($connect_id_auteur == $id_auteur)))
+	afficher_boite_logo('aut', 'id_auteur', $id_auteur,
+	_T('logo_auteur').aide (&quot;logoart&quot;), _T('logo_survol'));
 
 
 debut_droite();

Index: lang_raccourcis.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lang_raccourcis.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- lang_raccourcis.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ lang_raccourcis.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 

Index: aide_index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/aide_index.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- aide_index.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ aide_index.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+define('_ECRIRE_AIDE', 1);
 include (&quot;inc_version.php3&quot;);
 include_ecrire (&quot;inc_presentation.php3&quot;);
 
@@ -13,9 +24,11 @@
 include_ecrire (&quot;inc_layer.php3&quot;);
 include_ecrire (&quot;inc_texte.php3&quot;);
 
+
 // Recuperer les infos de langue (preferences auteur), si possible
 if (_FILE_CONNECT) {
-	include_ecrire (&quot;inc_auth.php3&quot;);
+	include_ecrire (&quot;inc_session.php3&quot;);
+	verifier_visiteur();
 }
 include_ecrire (&quot;inc_lang.php3&quot;);
 utiliser_langue_visiteur();
@@ -57,13 +70,15 @@
 	if (!$lang_aide) $lang_aide = $GLOBALS['spip_lang'];
 
 	// fichier local ?
-	if (@file_exists($fichier_aide = &quot;AIDE/$lang_aide/aide.html&quot;)) 
-		return array(file($fichier_aide), $lang_aide);
+	if (@file_exists($fichier_aide = &quot;../AIDE/aide-$lang_aide-aide.html&quot;)) {
+		echo &quot;oui&quot;;
+		return array(spip_file_get_contents($fichier_aide), $lang_aide);
+	}
 
 	// fichier local ? si reduction ISO du code langue oc_prv_ni =&gt; oc
 	else if (ereg(&quot;(.*)_&quot;, $lang_aide, $regs)
-		AND (@file_exists($fichier_aide = &quot;AIDE/&quot;.$regs[1].&quot;/aide.html&quot;)))
-			return array(file($fichier_aide), $regs[1]);
+		AND (@file_exists($fichier_aide = &quot;../AIDE/aide-&quot;.$regs[1].&quot;-aide.html&quot;)))
+			return array(spip_file_get_contents($fichier_aide), $regs[1]);
 
 	// Aide internet
 	else {
@@ -104,13 +119,7 @@
 
 		$image = $r[3];
 		$image_plat = str_replace('/', '-', $image);
-
-		# Image installee a l'ancienne
-		if (@file_exists($image))
-			$f = $image;
-		else
-		# Image telechargee ou a telecharger
-			$f = &quot;aide_index.php3?img=$image_plat&quot;;
+		$f = &quot;aide_index.php3?img=$image_plat&quot;;
 
 		$p = strpos($suite, $r[0]);
 		$html .= substr($suite, 0, $p) . $r[1].$f;
@@ -210,9 +219,11 @@
 	list ($cache, $rep, $lang, $file, $ext) = $regs;
 
 	header(&quot;Content-Type: image/$ext&quot;);
-	if (@file_exists(_DIR_CACHE . 'aide-'.$cache)) {
-		readfile(_DIR_CACHE . 'aide-'.$cache);
-	} else {
+	if (@file_exists($img = _DIR_CACHE . 'aide-'.$cache)) {
+		readfile($img);
+	} else if (@file_exists($img = '../AIDE/aide-'.$cache)) {
+		readfile($img);
+	} else if ($help_server) {
 		include_ecrire('inc_sites.php3');
 		if (ecrire_fichier(_DIR_CACHE . 'aide-test', &quot;test&quot;)
 		AND ($contenu =

Index: articles_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_forum.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles_forum.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ articles_forum.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_index.php3&quot;);
 include_ecrire (&quot;inc_logos.php3&quot;);

Index: inc_objet.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_objet.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_objet.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_objet.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_OBJET&quot;)) return;

Index: auteur_messagerie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteur_messagerie.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- auteur_messagerie.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ auteur_messagerie.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_acces.php3&quot;);
 include_ecrire (&quot;inc_index.php3&quot;);

Index: auteurs.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteurs.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- auteurs.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ auteurs.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_acces.php3&quot;);
 

Index: inc_flock.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_flock.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_flock.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_flock.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_FLOCK&quot;)) return;
@@ -67,7 +78,7 @@
 	// Ne rien faire si on est en preview, debug, ou si une erreur
 	// grave s'est presentee (compilation du squelette, MySQL, etc)
 	if ($GLOBALS['var_preview'] OR ($GLOBALS['var_mode'] == 'debug')
-	OR defined('spip_erreur_fatale'))
+	OR defined('spip_erreur_fatale') OR defined('spip_interdire_cache'))
 		return;
 
 	$gzip = (substr($fichier, -3) == '.gz');
@@ -111,12 +122,12 @@
 	else
 		return;
 
-	// supprimer
-	@unlink($fichier);
-
 	// liberer le verrou
 	@flock($fp, LOCK_UN);
 	@fclose($fp);
+
+	// supprimer
+	@unlink($fichier);
 }
 
 ?&gt;

Index: admin_index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_index.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- admin_index.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ admin_index.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_admin.php3&quot;);

Index: inc_auxbase.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_auxbase.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_auxbase.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_auxbase.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_AUXBASE&quot;)) return;
 define(&quot;_ECRIRE_INC_AUXBASE&quot;, &quot;1&quot;);
@@ -311,74 +322,71 @@
 
 global $tables_auxiliaires;
 
-$tables_auxiliaires  = 
-  array(
-	'petitions' =&gt; array('field' =&gt; &amp;$spip_petitions,
-			     'key' =&gt; &amp;$spip_petitions_key),
-	'visites_temp' =&gt; array('field' =&gt; &amp;$spip_visites_temp,
-				'key' =&gt; &amp;$spip_visites_temp_key),
-	'visites' =&gt;	array('field' =&gt; &amp;$spip_visites,
-			      'key' =&gt; &amp;$spip_visites_key),
-	'visites_articles' =&gt; array('field' =&gt; &amp;$spip_visites_articles,
-				    'key' =&gt; &amp;$spip_visites_articles_key),
-	'referers_temp' =&gt; array('field' =&gt; &amp;$spip_referers_temp,
-				 'key' =&gt; &amp;$spip_referers_temp_key),
-	'referers' =&gt; array('field' =&gt; &amp;$spip_referers,
-			    'key' =&gt; &amp;$spip_referers_key),
-	'referers_articles' =&gt; array('field' =&gt; &amp;$spip_referers_articles,
-				     'key' =&gt; &amp;$spip_referers_articles_key),
-	'auteurs_articles' =&gt; array('field' =&gt; &amp;$spip_auteurs_articles,
-				    'key' =&gt; &amp;$spip_auteurs_articles_key),
-	'auteurs_rubriques' =&gt; array('field' =&gt; &amp;$spip_auteurs_rubriques,
-				     'key' =&gt; &amp;$spip_auteurs_rubriques_key),
-	'auteurs_messages' =&gt; array('field' =&gt; &amp;$spip_auteurs_messages,
-				    'key' =&gt; &amp;$spip_auteurs_messages_key),
-	'documents_articles' =&gt; array('field' =&gt; &amp;$spip_documents_articles,
-				      'key' =&gt; &amp;$spip_documents_articles_key),
-	'documents_rubriques' =&gt; array('field' =&gt; &amp;$spip_documents_rubriques,
-				       'key' =&gt; &amp;$spip_documents_rubriques_key),
-	'documents_breves' =&gt; array('field' =&gt; &amp;$spip_documents_breves,
-				    'key' =&gt; &amp;$spip_documents_breves_key),
-	'mots_articles' =&gt; array('field' =&gt; &amp;$spip_mots_articles,
-				 'key' =&gt; &amp;$spip_mots_articles_key),
-	'mots_breves' =&gt; array('field' =&gt; &amp;$spip_mots_breves,
-			       'key' =&gt; &amp;$spip_mots_breves_key),
-	'mots_rubriques' =&gt; array('field' =&gt; &amp;$spip_mots_rubriques,
-				  'key' =&gt; &amp;$spip_mots_rubriques_key),
-	'mots_syndic' =&gt; array('field' =&gt; &amp;$spip_mots_syndic,
-			       'key' =&gt; &amp;$spip_mots_syndic_key),
-	'mots_forum' =&gt; array('field' =&gt; &amp;$spip_mots_forum,
-			      'key' =&gt; &amp;$spip_mots_forum_key),
-	'meta' =&gt; array('field' =&gt; &amp;$spip_meta,
-			'key' =&gt; &amp;$spip_meta_key),
-	'index_articles' =&gt; array('field' =&gt; &amp;$spip_index_articles,
-				  'key' =&gt; &amp;$spip_index_articles_key),
-	'index_auteurs' =&gt; array('field' =&gt; &amp;$spip_index_auteurs,
-				 'key' =&gt; &amp;$spip_index_auteurs_key),
-	'index_breves' =&gt; array('field' =&gt; &amp;$spip_index_breves,
-				'key' =&gt; &amp;$spip_index_breves_key),
-	'index_mots' =&gt; array('field' =&gt; &amp;$spip_index_mots,
-			      'key' =&gt; &amp;$spip_index_mots_key),
-	'index_rubriques' =&gt; array('field' =&gt; &amp;$spip_index_rubriques,
-				   'key' =&gt; &amp;$spip_index_rubriques_key),
-	'index_syndic' =&gt; array('field' =&gt; &amp;$spip_index_syndic,
-				'key' =&gt; &amp;$spip_index_syndic_key),
-	'index_signatures' =&gt; array('field' =&gt; &amp;$spip_index_signatures,
-				    'key' =&gt; &amp;$spip_index_signatures_key),
-	'index_forum' =&gt; array('field' =&gt; &amp;$spip_index_forum,
-			       'key' =&gt; &amp;$spip_index_forum_key),
-	'index_dico' =&gt; array('field' =&gt; &amp;$spip_index_dico,
-			      'key' =&gt; &amp;$spip_index_dico_key),
-	'versions'	=&gt; array('field' =&gt; &amp;$spip_versions,
-					 'key' =&gt; &amp;$spip_versions_key),
-	'versions_fragments'	=&gt; array('field' =&gt; &amp;$spip_versions_fragments,
-					 'key' =&gt; &amp;$spip_versions_fragments_key),
-	'caches'	=&gt; array('field' =&gt; &amp;$spip_caches,
-					 'key' =&gt; &amp;$spip_caches_key),
-	'ortho_cache'	=&gt; array('field' =&gt; &amp;$spip_ortho_cache,
-					 'key' =&gt; &amp;$spip_ortho_cache_key),
-	'ortho_dico'	=&gt; array('field' =&gt; &amp;$spip_ortho_dico,
-					 'key' =&gt; &amp;$spip_ortho_dico_key)
-	);
+$tables_auxiliaires['spip_petitions'] = array('field' =&gt; &amp;$spip_petitions,
+			     'key' =&gt; &amp;$spip_petitions_key);	     
+$tables_auxiliaires['spip_visites_temp'] = array('field' =&gt; &amp;$spip_visites_temp,
+				'key' =&gt; &amp;$spip_visites_temp_key);
+$tables_auxiliaires['spip_visites'] =	array('field' =&gt; &amp;$spip_visites,
+			      'key' =&gt; &amp;$spip_visites_key);
+$tables_auxiliaires['spip_visites_articles'] = array('field' =&gt; &amp;$spip_visites_articles,
+				    'key' =&gt; &amp;$spip_visites_articles_key);
+$tables_auxiliaires['spip_referers_temp'] = array('field' =&gt; &amp;$spip_referers_temp,
+				 'key' =&gt; &amp;$spip_referers_temp_key);
+$tables_auxiliaires['spip_referers'] = array('field' =&gt; &amp;$spip_referers,
+			    'key' =&gt; &amp;$spip_referers_key);
+$tables_auxiliaires['spip_referers_articles'] = array('field' =&gt; &amp;$spip_referers_articles,
+				     'key' =&gt; &amp;$spip_referers_articles_key);
+$tables_auxiliaires['spip_auteurs_articles'] = array('field' =&gt; &amp;$spip_auteurs_articles,
+				    'key' =&gt; &amp;$spip_auteurs_articles_key);
+$tables_auxiliaires['spip_auteurs_rubriques'] = array('field' =&gt; &amp;$spip_auteurs_rubriques,
+				     'key' =&gt; &amp;$spip_auteurs_rubriques_key);
+$tables_auxiliaires['spip_auteurs_messages'] = array('field' =&gt; &amp;$spip_auteurs_messages,
+				    'key' =&gt; &amp;$spip_auteurs_messages_key);
+$tables_auxiliaires['spip_documents_articles'] = array('field' =&gt; &amp;$spip_documents_articles,
+				      'key' =&gt; &amp;$spip_documents_articles_key);
+$tables_auxiliaires['spip_documents_rubriques'] = array('field' =&gt; &amp;$spip_documents_rubriques,
+				       'key' =&gt; &amp;$spip_documents_rubriques_key);
+$tables_auxiliaires['spip_documents_breves'] = array('field' =&gt; &amp;$spip_documents_breves,
+				    'key' =&gt; &amp;$spip_documents_breves_key);
+$tables_auxiliaires['spip_mots_articles'] = array('field' =&gt; &amp;$spip_mots_articles,
+				 'key' =&gt; &amp;$spip_mots_articles_key);
+$tables_auxiliaires['spip_mots_breves'] = array('field' =&gt; &amp;$spip_mots_breves,
+			       'key' =&gt; &amp;$spip_mots_breves_key);
+$tables_auxiliaires['spip_mots_rubriques'] = array('field' =&gt; &amp;$spip_mots_rubriques,
+				  'key' =&gt; &amp;$spip_mots_rubriques_key);
+$tables_auxiliaires['spip_mots_syndic'] = array('field' =&gt; &amp;$spip_mots_syndic,
+			       'key' =&gt; &amp;$spip_mots_syndic_key);
+$tables_auxiliaires['spip_mots_forum'] = array('field' =&gt; &amp;$spip_mots_forum,
+			      'key' =&gt; &amp;$spip_mots_forum_key);
+$tables_auxiliaires['spip_meta'] = array('field' =&gt; &amp;$spip_meta,
+			'key' =&gt; &amp;$spip_meta_key);
+$tables_auxiliaires['spip_index_articles'] = array('field' =&gt; &amp;$spip_index_articles,
+				  'key' =&gt; &amp;$spip_index_articles_key);
+$tables_auxiliaires['spip_index_auteurs'] = array('field' =&gt; &amp;$spip_index_auteurs,
+				 'key' =&gt; &amp;$spip_index_auteurs_key);
+$tables_auxiliaires['spip_index_breves'] = array('field' =&gt; &amp;$spip_index_breves,
+				'key' =&gt; &amp;$spip_index_breves_key);
+$tables_auxiliaires['spip_index_mots'] = array('field' =&gt; &amp;$spip_index_mots,
+			      'key' =&gt; &amp;$spip_index_mots_key);
+$tables_auxiliaires['spip_index_rubriques'] = array('field' =&gt; &amp;$spip_index_rubriques,
+				   'key' =&gt; &amp;$spip_index_rubriques_key);
+$tables_auxiliaires['spip_index_syndic'] = array('field' =&gt; &amp;$spip_index_syndic,
+				'key' =&gt; &amp;$spip_index_syndic_key);
+$tables_auxiliaires['spip_index_signatures'] = array('field' =&gt; &amp;$spip_index_signatures,
+				    'key' =&gt; &amp;$spip_index_signatures_key);
+$tables_auxiliaires['spip_index_forum'] = array('field' =&gt; &amp;$spip_index_forum,
+			       'key' =&gt; &amp;$spip_index_forum_key);
+$tables_auxiliaires['spip_index_dico'] = array('field' =&gt; &amp;$spip_index_dico,
+			      'key' =&gt; &amp;$spip_index_dico_key);
+$tables_auxiliaires['spip_versions'] = array('field' =&gt; &amp;$spip_versions,
+					 'key' =&gt; &amp;$spip_versions_key);
+$tables_auxiliaires['spip_versions_fragments'] = array('field' =&gt; &amp;$spip_versions_fragments,
+					 'key' =&gt; &amp;$spip_versions_fragments_key);
+$tables_auxiliaires['spip_caches'] = array('field' =&gt; &amp;$spip_caches,
+					 'key' =&gt; &amp;$spip_caches_key);
+$tables_auxiliaires['spip_ortho_cache'] = array('field' =&gt; &amp;$spip_ortho_cache,
+					 'key' =&gt; &amp;$spip_ortho_cache_key);
+$tables_auxiliaires['spip_ortho_dico'] = array('field' =&gt; &amp;$spip_ortho_dico,
+					 'key' =&gt; &amp;$spip_ortho_dico_key);
 
 ?&gt;

Index: inc_db_mysql.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_db_mysql.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_db_mysql.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_db_mysql.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_DB_MYSQL&quot;)) return;
@@ -18,11 +29,14 @@
 
 	$query = traite_query($query);
 
+	#spip_log($query);
 	if ($my_profile)
 		$m1 = microtime();
 
-	if ($GLOBALS['mysql_rappel_connexion'] AND $spip_mysql_link) $result = mysql_query($query, $spip_mysql_link);
-	else $result = mysql_query($query);
+	if ($GLOBALS['mysql_rappel_connexion'] AND $spip_mysql_link)
+		$result = mysql_query($query, $spip_mysql_link);
+	else
+		$result = mysql_query($query);
 
 	if ($my_profile) {
 		$m2 = microtime();
@@ -52,16 +66,15 @@
 // fonction appelant la precedente 
 // specifiquement pour les select des squelettes
 // c'est une instance de spip_abstract_select, voir ses specs dans inc_calcul
-// a noter qu'on pourrait y r&#233;aliser traite_query &#224; moindre cout
 // les \n et \t sont utiles au debusqueur
+// traite_query pourrait y est fait d'avance, &#224; moindre cout
 
 function spip_mysql_select($select, $from, $where,
 			   $groupby, $orderby, $limit,
 			   $sousrequete, $cpt,
 			   $table, $id, $serveur) {
 
-	$DB = 'spip_';
-	$q = &quot;\nFROM $DB&quot; . join(&quot;,\n\t$DB&quot;, $from)
+	$q = &quot;\nFROM &quot; . join(&quot;,\n\t&quot;, $from)
 	. ($where ? &quot;\nWHERE &quot; . join(&quot;\n\tAND &quot;, $where) : '')
 	. ($groupby ? &quot;\nGROUP BY $groupby&quot; : '')
 	. ($orderby ? &quot;\nORDER BY $orderby&quot; : '')
@@ -78,7 +91,7 @@
 	// Erreur ? C'est du debug de squelette, ou une erreur du serveur
 
 	if ($GLOBALS['var_mode'] == 'debug') {
-	  boucle_debug_resultat($id, '', $q);
+		boucle_debug_resultat($id, '', $q);
 	}
 
 	if (!($res = @spip_query($q))) {
@@ -92,7 +105,8 @@
 
 //
 // Passage d'une requete standardisee
-//
+// Quand tous les appels SQL seront abstraits on pourra l'ameliorer
+
 function traite_query($query) {
 	if ($GLOBALS['table_prefix']) $table_pref = $GLOBALS['table_prefix'].&quot;_&quot;;
 	else $table_pref = &quot;&quot;;
@@ -102,14 +116,14 @@
 
 	// changer les noms des tables ($table_prefix)
 	if ($GLOBALS['flag_pcre']) {
-		if (preg_match('/\s(VALUES|WHERE)\s/i', $query, $regs)) {
+		if (preg_match('/\s(SET|VALUES|WHERE)\s/i', $query, $regs)) {
 			$suite = strstr($query, $regs[0]);
 			$query = substr($query, 0, -strlen($suite));
 		}
 		$query = preg_replace('/([,\s])spip_/', '\1'.$db.$table_pref, $query) . $suite;
 	}
 	else {
-		if (eregi('[[:space:]](VALUES|WHERE)[[:space:]]', $query, $regs)) {
+		if (eregi('[[:space:]](SET|VALUES|WHERE)[[:space:]]', $query, $regs)) {
 			$suite = strstr($query, $regs[0]);
 			$query = substr($query, 0, -strlen($suite));
 		}
@@ -119,7 +133,6 @@
 	return $query;
 }
 
-
 //
 // Connexion a la base
 //
@@ -173,8 +186,8 @@
 		return mysql_free_result($r);
 }
 
-function spip_insert($table, $champs, $valeurs) {
-	spip_query(&quot;INSERT INTO spip_$table $champs VALUES $valeurs&quot;);
+function spip_mysql_insert($table, $champs, $valeurs) {
+	spip_query(&quot;INSERT INTO $table $champs VALUES $valeurs&quot;);
 	return  mysql_insert_id();
 }
 

Index: inc_lab.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_lab.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_lab.php	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_lab.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 	//
 	// Ce fichier assure la compatibilite avec spip-lab
 	//

Index: inc_suivi_revisions.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_suivi_revisions.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_suivi_revisions.php	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_suivi_revisions.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,4 +1,16 @@
 &lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_SUIVI_REVISIONS&quot;)) return;

Index: articles_page.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_page.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles_page.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ articles_page.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 debut_page(_T('titre_page_articles_page'), &quot;documents&quot;, &quot;articles&quot;);

Index: delete_all.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/delete_all.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- delete_all.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ delete_all.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 
 include_ecrire (&quot;inc_auth.php3&quot;);

Index: inc_documents.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_documents.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_documents.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_documents.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
[...1581 lines suppressed...]
+					$_POST['jour_doc'] = &quot;00&quot;;
+				$date = $_POST['annee_doc'].'-'
+				.$_POST['mois_doc'].'-'.$_POST['jour_doc'];
+
+				if (preg_match('/^[0-9-]+$/', $date)) {
+					spip_query(&quot;UPDATE spip_documents
+						SET date='$date'
+						WHERE id_document=$id_document&quot;);
+
+					// Changement de date, ce qui nous oblige a :
+					calculer_rubriques();
+				}
+			}
+
+		}
+
+	}
+}
 
 ?&gt;

Index: documents_liste.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/documents_liste.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- documents_liste.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ documents_liste.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_index.php3&quot;);
 include_ecrire (&quot;inc_logos.php3&quot;);

Index: calendrier.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/calendrier.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- calendrier.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ calendrier.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,27 +1,80 @@
 &lt;?php
 
-if (isset($HTTP_GET_VARS['type']))
-{
-	if ($HTTP_GET_VARS['type'] == 'semaine')
-		{ include (&quot;calendrier_semaine.php3&quot;);exit;}
-	else if ($HTTP_GET_VARS['type'] == 'jour')
-		{ include (&quot;calendrier_jour.php3&quot;);exit;}
-}
-include (&quot;inc.php3&quot;);
-include_ecrire (&quot;inc_calendrier.php&quot;);
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
+  // ce script peut etre recopie a la racine pour obtenir le calendrier
+  // a partir de l'espace public. 
+  // Evidemment les messages internes a la redaction seront absents.
+
+include((@is_dir(&quot;ecrire&quot;) ? 'ecrire/' : '') . &quot;inc_version.php3&quot;);
+
+if (!_DIR_RESTREINT)
+	include (&quot;inc.php3&quot;);
+ else {
+	include_ecrire(&quot;inc_presentation.php3&quot;);
+	include_ecrire(&quot;inc_calendrier.php&quot;);
+	include_ecrire(&quot;inc_texte.php3&quot;);
+	include_ecrire(&quot;inc_layer.php3&quot;);
+ }
 
 $today=getdate(time());
+$jour_today = $today[&quot;mday&quot;];
+$mois_today = $today[&quot;mon&quot;];
+$annee_today = $today[&quot;year&quot;];
 
 // sans arguments =&gt; mois courant
-if (!$mois){$annee=$today[&quot;year&quot;];$mois=$today[&quot;mon&quot;]; }
-$periode = $annee . '-' . sprintf(&quot;%02d&quot;, $mois) . '-01';
+if (!$mois){
+  $jour=$jour_today;
+  $mois=$mois_today;
+  $annee=$annee_today;
+}
+
+$date = date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois, $jour, $annee));
+$jour = journum($date);
+$mois = mois($date);
+$annee = annee($date);
+
+if (!isset($type)) $type = 'mois';
 
 $afficher_bandeau_calendrier = true;
 
-debut_page(_T('titre_page_calendrier',
-	      array('nom_mois' =&gt; nom_mois($periode), 'annee' =&gt; $annee)), 
-	   &quot;redacteurs&quot;, 
-	   &quot;calendrier&quot;);
+if ($type == 'semaine') {
+	$afficher_bandeau_calendrier_semaine = true;
+
+	$titre = _T('titre_page_calendrier',
+		    array('nom_mois' =&gt; nom_mois($date), 'annee' =&gt; $annee));
+	  }
+elseif ($type == 'jour') {
+	$titre = nom_jour(&quot;$annee-$mois-$jour&quot;).&quot; &quot;.
+	  affdate_jourcourt(&quot;$annee-$mois-$jour&quot;);
+	$jour = $jour_today;
+	$mois = $mois_today;
+	$annee = $annee_today;
+ }
+ else {
+	$type = 'mois';
+	$jour = '01';
+	$titre = _T('titre_page_calendrier',
+		    array('nom_mois' =&gt; nom_mois($annee . '-' . sprintf(&quot;%02d&quot;, $mois) . '-01'), 
+			  'annee' =&gt; $annee));
+	  }
+
+if (!_DIR_RESTREINT) 
+  debut_page($titre,  &quot;redacteurs&quot;, &quot;calendrier&quot;);
+ else debut_html($titre);
+
+$f = 'http_calendrier_init_' . $type;
+echo $f($jour,$mois,$annee, $date);
+
+if (!_DIR_RESTREINT) fin_page(); else 	echo &quot;&lt;/body&gt;&lt;/html&gt;\n&quot;;
 
-echo http_calendrier_tout($mois,$annee, '01', '31');
 ?&gt;

Index: inc_layer.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_layer.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_layer.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_layer.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,4 +1,15 @@
 &lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_INC_LAYER&quot;)) return;
@@ -25,8 +36,7 @@
 		$numero_block[&quot;$nom_block&quot;] = $compteur_block;
 	}
 
-	return http_script(&quot;
-vis['&quot;.$numero_block[&quot;$nom_block&quot;].&quot;'] = 'hide';
+	return http_script(&quot;vis['&quot;.$numero_block[&quot;$nom_block&quot;].&quot;'] = 'hide';
 document.write('&lt;div id=\&quot;Layer&quot;.$numero_block[&quot;$nom_block&quot;].&quot;\&quot; style=\&quot;display: none; margin-top: 1;\&quot;&gt;');&quot;,
 			      '',
 			   &quot;&lt;div id='Layer&quot;.$numero_block[&quot;$nom_block&quot;].&quot;' style='display: block;'&gt;&quot;);
@@ -37,14 +47,12 @@
   return (!$GLOBALS['browser_layer'] ? '' : &quot;&lt;div style='clear: both;'&gt;&lt;/div&gt;&lt;/div&gt;&quot;);
 }
 
-function bouton_block_invisible($nom_block) {
+function bouton_block_invisible($nom_block, $icone='') {
 	global $numero_block, $compteur_block, $browser_layer, $spip_lang_rtl;
 
-	$num_triangle = $compteur_block + 1;
-
 	if (!$browser_layer) return '';
 	$blocks = explode(&quot;,&quot;, $nom_block);
-
+	$javasc = array();
 	for ($index=0; $index &lt; count($blocks); $index ++){
 		$nom_block = $blocks[$index];
 
@@ -53,21 +61,23 @@
 			$numero_block[&quot;$nom_block&quot;] = $compteur_block;
 		}
 
-		$javasc .= &quot;swap_couche(\\'&quot;.$numero_block[$nom_block].&quot;\\', \\'$spip_lang_rtl\\',\\'&quot; . _DIR_IMG_PACK . &quot;\\');&quot;;
+		if (!$icone) {
+			$icone = &quot;deplierhaut$spip_lang_rtl.gif&quot;;
+			$javasc[] = '[' . $numero_block[$nom_block] . ',0]';
 		}
-	return http_script(&quot;
-document.write('&lt;a class=\&quot;triangle_block\&quot; href=\&quot;javascript:$javasc\&quot;&gt;&lt;img name=\&quot;triangle&quot;.$numero_block[&quot;$nom_block&quot;].&quot;\&quot; src=\&quot;&quot;. _DIR_IMG_PACK . &quot;deplierhaut$spip_lang_rtl.gif\&quot; alt=\&quot;\&quot; title=\&quot;&quot;.addslashes(_T('info_deplier')).&quot;\&quot; width=\&quot;10\&quot; height=\&quot;10\&quot; border=\&quot;0\&quot;&gt;&lt;/a&gt;');\n&quot;);
+		else
+			$javasc[] = '[' . $numero_block[$nom_block] . ',1]';
+	}
+	return produire_acceder_couche($javasc, $numero_block[$nom_block], $icone);
 }
 
 
 function bouton_block_visible($nom_block){
 	global $numero_block, $compteur_block, $browser_layer, $spip_lang_rtl;
 
-	$num_triangle = $compteur_block + 1;
-
 	if (!$browser_layer) return '';
 	$blocks = explode(&quot;,&quot;, $nom_block);
-
+	$javasc = array();
 	for ($index=0; $index &lt; count($blocks); $index ++){
 		$nom_block = $blocks[$index];
 
@@ -76,11 +86,24 @@
 			$numero_block[&quot;$nom_block&quot;] = $compteur_block;
 		}
 
-		$javasc .= &quot;swap_couche(\\'&quot;.$numero_block[$nom_block].&quot;\\', \\'$spip_lang_rtl\\',\\'&quot; . _DIR_IMG_PACK . &quot;\\');&quot;;
-		}
+		$javasc[] = '[' . $numero_block[$nom_block] . ',0]';
 
-	return http_script(&quot;
-document.write('&lt;a class=\&quot;triangle_block\&quot; href=\&quot;javascript:$javasc\&quot;&gt;&lt;img name=\&quot;triangle&quot;.$numero_block[&quot;$nom_block&quot;].&quot;\&quot; src=\&quot;&quot;. _DIR_IMG_PACK . &quot;deplierbas.gif\&quot; alt=\&quot;\&quot; title=\&quot;&quot;.addslashes(_T('info_deplier')).&quot;\&quot; width=\&quot;10\&quot; height=\&quot;10\&quot; border=\&quot;0\&quot;&gt;&lt;/a&gt;');\n&quot;);
+	}
+
+	return produire_acceder_couche($javasc, $numero_block[$nom_block], &quot;deplierbas.gif&quot;);
+}
+
+function produire_acceder_couche($couches, $nom, $icone) {
+	global $spip_lang_rtl;
+	return http_script(&quot;acceder_couche([&quot; . join(',',$couches) . '], ' .
+			   $nom .
+			   &quot;, '&quot; .
+			   _DIR_IMG_PACK .
+			   &quot;', '&quot; .
+			   $icone .
+			   &quot;', '&quot; .
+			   addslashes(_T('info_deplier')) .
+			   &quot;','$spip_lang_rtl')&quot;);
 }
 
 //

Index: inc_rubriques.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_rubriques.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_rubriques.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_rubriques.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_RUBRIQUES&quot;)) return;
@@ -25,9 +36,9 @@
 	// Publier et dater les rubriques qui ont un article publie
 	//
 
-	// Gerer les articles post-dates ?
+	// Afficher les articles post-dates ?
 	include_ecrire('inc_meta.php3');
-	$postdates = (lire_meta(&quot;post_dates&quot;) != &quot;non&quot;) ?
+	$postdates = (lire_meta(&quot;post_dates&quot;) == &quot;non&quot;) ?
 		&quot;AND fille.date &lt;= NOW()&quot; : '';
 
 	$r = spip_query(&quot;SELECT rub.id_rubrique AS id, max(fille.date) AS date_h

Index: inc_version.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_version.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_version.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_version.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_VERSION&quot;)) return;
@@ -28,7 +39,7 @@
 $included_files = array();
 
 function include_local($file) {
-	if ($GLOBALS['included_files'][$file]++) return;
+	if (@$GLOBALS['included_files'][$file]++) return;
 	include($file);
 }
 
@@ -36,132 +47,171 @@
 # Hack pour etre compatible avec les mes_options qui appellent cette fonction
 	define_once('_DIR_INCLUDE', _DIR_RESTREINT);
 	$file = _DIR_INCLUDE . $file;
-	if ($GLOBALS['included_files'][$file]++) return;
+	if (@$GLOBALS['included_files'][$file]++) return;
 	include($file);
 }
 
 function include_lang($file) {
 	$file = _DIR_LANG . $file;
-	if ($GLOBALS['included_files'][$file]++) return;
+	if (@$GLOBALS['included_files'][$file]++) return;
 	include($file);
 }
 
 function include_plug($file) {
 	$file = _DIR_RESTREINT . $file;
-	if ($GLOBALS['included_files'][$file]++) return;
+	if (@$GLOBALS['included_files'][$file]++) return;
 	if (file_exists($file)) include($file);
 }
 
 
-// Que faire si Spip n'est pas installe... sauf si justement on l'installe!
-if (!(_FILE_CONNECT OR defined('_ECRIRE_INSTALL') OR defined('_TEST_DIRS'))) {
-	// Soit on est dans ecrire/ et on envoie sur l'installation
-	if (@file_exists(&quot;inc_version.php3&quot;)) {
-		header(&quot;Location: &quot; . _DIR_RESTREINT . &quot;install.php3&quot;);
-		exit;
-	}
-	// Soit on est dans le site public
-	else if (defined(&quot;_INC_PUBLIC&quot;)) {
-		# on ne peut pas deviner ces repertoires avant l'installation !
-		define('_DIR_INCLUDE', _DIR_RESTREINT);
-		define('_DIR_IMG_PACK', (_DIR_RESTREINT . 'img_pack/'));
-		define('_DIR_LANG', (_DIR_RESTREINT . 'lang/'));
-		$db_ok = false;
-		include_ecrire (&quot;inc_presentation.php3&quot;);
-		install_debut_html(_T('info_travaux_titre'));
-		echo &quot;&lt;p&gt;&quot;._T('info_travaux_texte').&quot;&lt;/p&gt;&quot;;
-		install_fin_html();
-		exit;
-	}
-	// Soit on est appele de l'exterieur (spikini, etc)
+// *********** traiter les variables ************
+
+// Recuperer les superglobales $_GET si non definies
+// (en theorie c'est impossible depuis PHP 4.0.3, cf. track_vars)
+foreach (array('_GET', '_POST', '_COOKIE', '_SERVER') as $_table) {
+	if (!is_array($GLOBALS[$_table])) {
+		$GLOBALS[$_table] = array();
+		if (is_array($GLOBALS[$http_table_vars]))
+			$GLOBALS[$_table] = &amp; $GLOBALS[$http_table_vars];
+	} /* else
+	$GLOBALS[$http_table_vars] = &amp; $GLOBALS[$_table]; */
 }
 
-// *********** traiter les variables ************
+
 // Magic quotes : on n'en veut pas sur la base,
 // et on nettoie les GET/POST/COOKIE le cas echeant
-//
+function magic_unquote($_table) {
 
-function magic_unquote($table) {
-	if (is_array($GLOBALS[$table])) {
-		reset($GLOBALS[$table]);
-		while (list($key, $val) = each($GLOBALS[$table])) {
+	// Certains hebergeurs n'activent pas $GLOBALS['GLOBALS']
+	if ($_table == 'GLOBALS'
+	AND !isset($GLOBALS['GLOBALS']))
+		$GLOBALS['GLOBALS'] = &amp;$GLOBALS;
+
+	if (is_array($GLOBALS[$_table])) {
+		foreach ($GLOBALS[$_table] as $key =&gt; $val) {
 			if (is_string($val))
-				$GLOBALS[$table][$key] = stripslashes($val);
+				$GLOBALS[$_table][$key] = stripslashes($val);
 		}
 	}
 }
 
 @set_magic_quotes_runtime(0);
-$unquote_gpc = @get_magic_quotes_gpc();
+if (@get_magic_quotes_gpc()) {
+	magic_unquote('_GET');
+	magic_unquote('_POST');
+	magic_unquote('_COOKIE');
 
-if ($unquote_gpc) {
-	magic_unquote('HTTP_GET_VARS');
-	magic_unquote('HTTP_POST_VARS');
-	magic_unquote('HTTP_COOKIE_VARS');
+	if (@ini_get('register_globals'))
+		magic_unquote('GLOBALS');
 }
 
-//
-// Dirty hack contre le register_globals a 'Off' (PHP 4.1.x)
-// A remplacer par une gestion propre des variables admissibles ;-)
-//
 
-$INSECURE = array();
 
-function feed_globals($table, $insecure = true, $ignore_variables_contexte = false) {
-	global $INSECURE;
+// Dirty hack contre le register_globals a 'Off' (PHP 4.1.x)
+// A remplacer (un jour!) par une gestion propre des variables admissibles ;-)
+// Attention pour compatibilite max $_GET n'est pas superglobale
+// NB: c'est une fonction de maniere a ne pas pourrir $GLOBALS
+function spip_register_globals() {
 
-	// ignorer des cookies qui contiendraient du contexte 
-	$is_contexte = array('id_parent'=&gt;1, 'id_rubrique'=&gt;1, 'id_article'=&gt;1, 'id_auteur'=&gt;1,
-		'id_breve'=&gt;1, 'id_forum'=&gt;1, 'id_secteur'=&gt;1, 'id_syndic'=&gt;1, 'id_syndic_article'=&gt;1,
-		'id_mot'=&gt;1, 'id_groupe'=&gt;1, 'id_document'=&gt;1, 'date'=&gt;1, 'lang'=&gt;1);
+	// Liste des variables dont on refuse qu'elles puissent provenir du client
+	$refuse_gpc = array (
+		# inc-public.php3
+		'fond', 'delais',
 
-	if (is_array($GLOBALS[$table])) {
-        reset($GLOBALS[$table]);
-        while (list($key, $val) = each($GLOBALS[$table])) {
-			if ($ignore_variables_contexte AND isset($is_contexte[$key]))
-				unset ($GLOBALS[$key]);
-			else
-				$GLOBALS[$key] = $val;
-			if ($insecure) $INSECURE[$key] = $val;
-        }
-	}
-}
+		# ecrire/inc_auth.php3
+		'REMOTE_USER',
+		'PHP_AUTH_USER', 'PHP_AUTH_PW',
 
-feed_globals('HTTP_COOKIE_VARS', true, true);
-feed_globals('HTTP_GET_VARS');
-feed_globals('HTTP_POST_VARS');
-feed_globals('HTTP_SERVER_VARS', false);
+		# ecrire/inc_texte.php3
+		'debut_intertitre', 'fin_intertitre', 'ligne_horizontale',
+		'ouvre_ref', 'ferme_ref', 'ouvre_note', 'ferme_note',
+		'les_notes', 'compt_note', 'nombre_surligne',
+		'url_glossaire_externe', 'puce', 'puce_rtl'
+	);
 
+	// Liste des variables (contexte) dont on refuse qu'elles soient cookie
+	// (histoire que personne ne vienne fausser le cache)
+	$refuse_c = array (
+		# inc-calcul.php3
+		'id_parent', 'id_rubrique', 'id_article',
+		'id_auteur', 'id_breve', 'id_forum', 'id_secteur',
+		'id_syndic', 'id_syndic_article', 'id_mot', 'id_groupe',
+		'id_document', 'date', 'lang'
+	);
 
-//
-// Avec register_globals a Off sous PHP4, il faut utiliser
-// la nouvelle variable HTTP_POST_FILES pour les fichiers uploades
-// (pas valable sous PHP3...)
-//
 
-function feed_post_files($table) {
-	global $INSECURE;
-	if (is_array($GLOBALS[$table])) {
-	        reset($GLOBALS[$table]);
-	        while (list($key, $val) = each($GLOBALS[$table])) {
-	                $GLOBALS[$key] = $INSECURE[$key] = $val['tmp_name'];
-	                $GLOBALS[$key.'_name'] = $INSECURE[$key.'_name'] = $val['name'];
-	        }
+	// Si les variables sont passees en global par le serveur, il faut
+	// faire quelques verifications de base
+	if (@ini_get('register_globals')) {
+		foreach ($refuse_gpc as $var) {
+			if (isset($GLOBALS[$var])) {
+				foreach (array('_GET', '_POST', '_COOKIE') as $_table) {
+					if (
+					// demande par le client
+					isset ($GLOBALS[$_table][$var])
+					// et pas modifie par les fichiers d'appel
+					AND $GLOBALS[$_table][$var] == $GLOBALS[$var]
+					) // On ne sait pas si c'est un hack
+					{
+						# REMOTE_USER ou fond, c'est grave ;
+						# pour le reste (cookie 'lang', par exemple), simplement
+						# interdire la mise en cache de la page produite
+						switch ($var) {
+							case 'REMOTE_USER':
+							case 'fond':
+								die (&quot;$var interdite&quot;);
+								break;
+							default:
+								define ('spip_interdire_cache', true);
+						}
+					}
+				}
+			}
+		}
+		foreach ($refuse_c as $var) {
+			if (isset($GLOBALS[$var])) {
+				foreach (array('_COOKIE') as $_table) {
+					if (
+					// demande par le client
+					isset ($GLOBALS[$_table][$var])
+					// et pas modifie par les fichiers d'appel
+					AND $GLOBALS[$_table][$var] == $GLOBALS[$var]
+					)
+						define ('spip_interdire_cache', true);
+				}
+			}
+		}
+	}
+
+	// sinon il faut les passer nous-memes, a l'exception des interdites.
+	// (A changer en une liste des variables admissibles...)
+	else {
+		foreach (array('_SERVER', '_COOKIE', '_POST', '_GET') as $_table) {
+			foreach ($GLOBALS[$_table] as $var =&gt; $val) {
+				if (!isset($GLOBALS[$var])
+				AND isset($GLOBALS[$_table][$var])
+				AND ($_table == '_SERVER' OR !in_array($var, $refuse_gpc))
+				AND ($_table &lt;&gt; '_COOKIE' OR !in_array($var, $refuse_c)))
+					$GLOBALS[$var] = $val;
+			}
+		}
 	}
 }
+spip_register_globals();
+
+
 
-feed_post_files('HTTP_POST_FILES');
 
 
 //
-// 	*** Parametrage par defaut de SPIP ***
+// *** Parametrage par defaut de SPIP ***
 //
 // Ces parametres d'ordre technique peuvent etre modifies
-// dans FILE_OPTIONS Les valeurs specifiees
-// dans ce dernier fichier remplaceront automatiquement
+// dans ecrire/mes_options.php3 (_FILE_OPTIONS) Les valeurs
+// specifiees dans ce dernier fichier remplaceront automatiquement
 // les valeurs ci-dessous.
 //
-// Pour creer _FILE_OPTIONS : recopier simplement
+// Pour creer ecrire/mes_options.php3 : recopier simplement
 // les lignes ci-dessous, et ajouter le marquage de debut et
 // de fin de fichier PHP (&quot;&lt; ?php&quot; et &quot;? &gt;&quot;, sans les espaces)
 //
@@ -225,11 +275,8 @@
 $champs_extra_proposes = false;
 
 // faut-il ignorer l'authentification par auth http/remote_user ?
-// cela permet d'avoir un SPIP sous .htaccess (ignore_remote_user),
-// mais aussi de fonctionner sur des serveurs debiles se
-// bloquant sur PHP_AUTH_USER=root (ignore_auth_http)
 $ignore_auth_http = false;
-$ignore_remote_user = false;
+$ignore_remote_user = true; # methode obsolete et risquee
 
 // Faut-il &quot;invalider&quot; les caches quand on depublie ou modifie un article ?
 // (experimental)
@@ -276,12 +323,18 @@
 @umask(0);
 
 //
-// D&#233;finition des repertoires standards, _FILE_OPTIONS ayant priorite
+// Definition des repertoires standards, _FILE_OPTIONS ayant priorite
 //
 
 if (@file_exists(_FILE_OPTIONS)) {
   include(_FILE_OPTIONS);
- }
+}
+
+// la taille maxi des logos (0 : pas de limite)
+define_once('_LOGO_MAX_SIZE', 0); # poids en ko
+define_once('_LOGO_MAX_WIDTH', 0); # largeur en pixels
+define_once('_LOGO_MAX_HEIGHT', 0); # hauteur en pixels
+
 
 define_once('_DIR_INCLUDE', _DIR_RESTREINT);
 define_once('_DIR_PREFIX1', (_DIR_RESTREINT ? &quot;&quot; : &quot;../&quot;));
@@ -341,21 +394,16 @@
 define_once('_ACCESS_FILE_NAME', '.htaccess');
 define_once('_AUTH_USER_FILE', '.htpasswd');
 
-# obsoletes: utiliser les constantes ci-dessus.
-# Conserver pour compatibit&#233; vieilles contrib uniquement
-
-$flag_ecrire = !@file_exists(_DIR_RESTREINT_ABS . 'inc_version.php3');
-$dir_ecrire = (ereg(&quot;/ecrire/&quot;, $GLOBALS['REQUEST_URI'])) ? '' : 'ecrire/';
 
 // Version courante de SPIP
 // Stockee sous forme de nombre decimal afin de faciliter les comparaisons
 // (utilise pour les modifs de la base de donnees)
 
 // version de la base
-$spip_version = 1.809;
+$spip_version = 1.812;
 
 // version de spip
-$spip_version_affichee = &quot;1.8 beta 2 CVS&quot;;
+$spip_version_affichee = &quot;1.8 PR1 CVS&quot;;
 
 // version de spip / tag cvs
 if (ereg('Name: v(.*) ','$Name$', $regs)) $spip_version_affichee = $regs[1];
@@ -368,28 +416,18 @@
 $hash_recherche_strict = '';
 
 
+
 //
-// Infos de version PHP
-// (doit etre au moins egale a 3.0.8)
+// Capacites php (en fonction de la version)
 //
 
-$php_version = phpversion();
-$php_version_tab = explode('.', $php_version);
-$php_version_maj = intval($php_version_tab[0]);
-$php_version_med = intval($php_version_tab[1]);
-if (ereg('([0-9]+)', $php_version_tab[2], $match)) $php_version_min = intval($match[1]);
-
-$flag_levenshtein = ($php_version_maj &gt;= 4);
-$flag_uniqid2 = ($php_version_maj &gt; 3 OR $php_version_min &gt;= 13);
 $flag_get_cfg_var = (@get_cfg_var('error_reporting') != &quot;&quot;);
-$flag_strtr2 = ($php_version_maj &gt; 3);
-
 $flag_ini_get = (function_exists(&quot;ini_get&quot;)
 	&amp;&amp; (@ini_get('max_execution_time') &gt; 0));	// verifier pas desactivee
 $flag_gz = function_exists(&quot;gzencode&quot;); #php 4.0.4
 $flag_ob = ($flag_ini_get
 	&amp;&amp; !ereg(&quot;ob_&quot;, ini_get('disable_functions'))
-	&amp;&amp; function_exists(&quot;ob_start&quot;));
+	&amp;&amp; function_exists(&quot;ob_start&quot;)); 
 $flag_pcre = function_exists(&quot;preg_replace&quot;);
 $flag_crypt = function_exists(&quot;crypt&quot;);
 $flag_wordwrap = function_exists(&quot;wordwrap&quot;);
@@ -430,19 +468,18 @@
 	else
 		@setcookie ($name, $value);
 }
+
 if ($cookie_prefix != 'spip') {
-	reset ($HTTP_COOKIE_VARS);
-	while (list($name,$value) = each($HTTP_COOKIE_VARS)) {
+	foreach ($_COOKIE as $name =&gt; $value) {
 		if (ereg('^spip_', $name)) {
-			unset($HTTP_COOKIE_VARS[$name]);
+			unset($_COOKIE[$name]);
 			unset($$name);
 		}
 	}
-	reset ($HTTP_COOKIE_VARS);
-	while (list($name,$value) = each($HTTP_COOKIE_VARS)) {
+	foreach ($_COOKIE as $name =&gt; $value) {
 		if (ereg('^'.$cookie_prefix.'_', $name)) {
 			$spipname = ereg_replace ('^'.$cookie_prefix.'_', 'spip_', $name);
-			$HTTP_COOKIE_VARS[$spipname] = $INSECURE[$spipname] = $value;
+			$_COOKIE[$spipname] = $INSECURE[$spipname] = $value;
 			$$spipname = $value;
 		}
 	}
@@ -452,7 +489,7 @@
 //
 // Sommes-nous dans l'empire du Mal ?
 //
-if (strpos($HTTP_SERVER_VARS['SERVER_SOFTWARE'], '(Win') !== false)
+if (strpos($_SERVER['SERVER_SOFTWARE'], '(Win') !== false)
 	define ('os_serveur', 'windows');
 
 
@@ -498,7 +535,7 @@
 // Compatibilite avec serveurs ne fournissant pas $REQUEST_URI
 if (!$REQUEST_URI) {
 	$REQUEST_URI = $PHP_SELF;
-	if (!strpos($REQUEST_URI, '?') &amp;&amp; $QUERY_STRING)
+	if ($QUERY_STRING AND !strpos($REQUEST_URI, '?'))
 		$REQUEST_URI .= '?'.$QUERY_STRING;
 }
 
@@ -507,15 +544,34 @@
 	else if ($DOCUMENT_ROOT &amp;&amp; $SCRIPT_URL) $PATH_TRANSLATED = $DOCUMENT_ROOT.$SCRIPT_URL;
 }
 
+# obsoletes: utiliser les constantes ci-dessus.
+# Conserver pour compatibilite vieilles contrib uniquement
+$flag_ecrire = !@file_exists(_DIR_RESTREINT_ABS . 'inc_version.php3');
+$dir_ecrire = (ereg(&quot;/ecrire/&quot;, $GLOBALS['REQUEST_URI'])) ? '' : 'ecrire/';
+
+// API d'appel a la base de donnees
 function spip_query($query) {
-	if (!_FILE_CONNECT)  {$GLOBALS['db_ok'] = false; return;}
-	include_local(_FILE_CONNECT);
-	if (!$GLOBALS['db_ok'])	return;
+
+	// Remarque : si on est appele par l'install,
+	// la connexion initiale a ete faite avant
+	if (!$GLOBALS['db_ok']) {
+		// Essaie de se connecter
+		if (_FILE_CONNECT)
+			include_local(_FILE_CONNECT);
+	}
+
+	// Erreur de connexion
+	if (!$GLOBALS['db_ok'])
+		return;
+
+	// Vieux format de fichier connexion
 	if ($GLOBALS['spip_connect_version'] &lt; 0.1) {
 		if (!_DIR_RESTREINT) {$GLOBALS['db_ok'] = false; return;}
 		@Header(&quot;Location: upgrade.php3?reinstall=oui&quot;);
 		exit;
 	}
+
+	// Faire la requete
 	return spip_query_db($query);
 }
 
@@ -595,6 +651,7 @@
 		403 =&gt; '403 Forbidden',
 		404 =&gt; '404 Not Found'
 	);
+
 	if ($php_cgi) Header(&quot;Status: $status&quot;);
 	else Header(&quot;HTTP/1.0 &quot;.$status_string[$status]);
 }
@@ -633,7 +690,7 @@
 	return
 	$GLOBALS['auto_compress']
 	&amp;&amp; $GLOBALS['flag_ob']
-	&amp;&amp; ($php_version&lt;&gt;'4.0.4')
+	&amp;&amp; (phpversion()&lt;&gt;'4.0.4')
 	&amp;&amp; function_exists(&quot;ob_gzhandler&quot;)
 	&amp;&amp; $GLOBALS['flag_obgz']
 	// special bug de proxy
@@ -648,7 +705,7 @@
 	&amp;&amp; !@ini_get(&quot;output_handler&quot;);
 }
 // si un buffer est deja ouvert, stop
-if ($flag_ob AND !strlen(@ob_get_contents())) {
+if ($flag_ob AND !headers_sent()) {
 	@header(&quot;Vary: Cookie, Accept-Encoding&quot;);
 	if (test_obgz())
 		ob_start('ob_gzhandler');
@@ -665,6 +722,7 @@
 	// soit sans parametres, auquel cas l'URL est l'URL courante
 	//
 	function Link($url = '', $reentrant = false) {
+		global $_POST;
 		static $link = '';
 
 		$this-&gt;vars = array();
@@ -699,7 +757,7 @@
 		// ou l'on supprime de l'URL courant les bidules inutiles
 		if (!$url) {
 			// GET variables are read from the original URL
-			// (HTTP_GET_VARS may contain additional variables
+			// (_GET may contain additional variables
 			// introduced by rewrite-rules)
 			$url = $GLOBALS['REQUEST_URI'];
 			// Warning !!!! 
@@ -712,9 +770,9 @@
 			else $v = strrpos($url, '/');
 			$url = substr($url, $v + 1);
 			if (!$url) $url = &quot;./&quot;;
-			if (count($GLOBALS['HTTP_POST_VARS'])) {
+			if (count($_POST)) {
 				$vars = array();
-				foreach ($GLOBALS['HTTP_POST_VARS'] as $var =&gt; $val)
+				foreach ($_POST as $var =&gt; $val)
 					if (preg_match('/^id_/', $var))
 						$vars[$var] = $val;
 			}
@@ -739,7 +797,7 @@
 				if (!preg_match('/^('.
 				(!_DIR_RESTREINT ?
 					'|lang|set_options|set_couleur|set_disp|set_ecran':
-					'var_mode')
+					'var_mode|show_docs')
 				. ')$/i', $name)) {
 					if (is_array($value))
 						$this-&gt;arrays[$name] = $value;
@@ -878,10 +936,9 @@
 //
 // Traduction des textes de SPIP
 //
-function _T($text, $args = '') {
+function _T($texte, $args = '') {
 	include_ecrire('inc_lang.php3');
-	$text = traduire_chaine($text, $args);
-
+	$text = traduire_chaine($texte, $args);
 	if (!empty($GLOBALS['xhtml'])) {
 		include_ecrire(&quot;inc_charsets.php3&quot;);
 		$text = html2unicode($text);
@@ -929,26 +986,47 @@
 }
 
 
+// spip_touch : verifie si un fichier existe et n'est pas vieux (duree en s)
+// et le cas echeant le touch() ; renvoie true si la condition est verifiee
+// et fait touch() sauf si ca n'est pas souhaite
+// (regle aussi le probleme des droits sur les fichiers touch())
+function spip_touch($fichier, $duree=0, $touch=true) {
+	if (!($exists = @file_exists($fichier))
+	|| ($duree == 0)
+	|| (@filemtime($fichier) &lt; time() - $duree)) {
+		if ($touch) {
+			if (!@touch($fichier)) { @unlink($fichier); @touch($fichier); };
+			if (!$exists) @chmod($fichier, 0666);
+		}
+		return true;
+	}
+	return false;
+}
+
 //
-// cron : verifie qu'il s'est ecoule $delai sec au moins et lance le cron
-// Note : ici on met 2 secondes par defaut entre les hits, mais
-// spip_background.php3 est plus gourmand (1 sec)... chiffres a optimiser
-// si on utilise spip_background.php3 de maniere plus complete
+// cron() : execution des taches de fond
+// quand il est appele par spip_background.php3, il est gourmand ;
+// quand il est appele par inc-public il n'est pas gourmand
 //
-function cron($delai = 2) {
-	if (!$_REQUEST['forcer']) {
-		$touch = _DIR_SESSIONS.'.background';
-		if (!($exists = @file_exists($touch))
-		OR (@filemtime($touch) &lt; time() - $delai)) {
-			touch($touch);
-			if (!$exists) chmod($touch, 0666);
+function cron($gourmand = false) {
+	$touch = _DIR_SESSIONS.'.background';
+	$touch_gourmand = $touch.'-gourmand';
 
-		include_ecrire('inc_cron.php3');
-		spip_cron();
+	// Si on est gourmand, ou si le fichier gourmand n'existe pas
+	// (ou est trop vieux), on va voir si un cron est necessaire.
+	// Au passage si on est gourmand on le dit aux autres
+	if (spip_touch($touch_gourmand, 60, $gourmand)
+	OR $gourmand) {
+
+		// Faut-il travailler ? Pas tous en meme temps svp
+		// Au passage si on travaille on bloque les autres
+		if (spip_touch($touch, 1)) {
+			include_ecrire('inc_cron.php3');
+			spip_cron();
+		}
 	}
 }
 
-}
 
 //
 // qq  fonctions service pour les 2 niveaux
@@ -1010,10 +1088,13 @@
 }
 
 function debut_entete($title, $entete='') {
-	if (!$entete) {
-		if (!$charset = lire_meta('charset')) $charset = 'utf-8';
+	global $flag_preserver;
+
+	if (!$charset = lire_meta('charset'))
+		$charset = 'utf-8';
+	if (!$entete)
 		$entete = &quot;Content-Type: text/html; charset=$charset&quot;;
-	}
+
 	if (!$flag_preserver) @header($entete);
 	return &quot;&lt;!DOCTYPE HTML PUBLIC '-//W3C//DTD HTML 4.01 Transitional//EN' '<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>'&gt;\n&quot; .
 	  &quot;&lt;html lang='&quot;.$GLOBALS['spip_lang'].&quot;' dir='&quot;.($GLOBALS['spip_lang_rtl'] ? 'rtl' : 'ltr').&quot;'&gt;\n&quot; .
@@ -1021,6 +1102,73 @@
 #	  &quot;&lt;base href='$base' /&gt;\n&quot; .
 	  &quot;&lt;title&gt;$title&lt;/title&gt;\n&quot; .
 	  &quot;&lt;meta http-equiv='Content-Type' content='text/html; charset=$charset' /&gt;\n&quot;;
+}
+
+
+// Transforme n'importe quel champ en une chaine utilisable
+// en PHP ou Javascript en toute securite
+// &lt; ? php $x = '[(#TEXTE|texte_script)]'; ? &gt;
+function texte_script($texte) {
+	return str_replace('\'', '\\\'', str_replace('\\', '\\\\', $texte));
+}
+
+//
+// find_in_path() : chercher un fichier nomme x selon le chemin rep1:rep2:rep3
+//
+define_once('_SPIP_PATH', './:squelettes/:dist/:formulaires/');
+function find_in_path ($filename, $path='AUTO') {
+	// Chemin standard depuis l'espace public
+
+	if ($path == 'AUTO') {
+		$path = _SPIP_PATH;
+		if ($GLOBALS['dossier_squelettes'])
+			$path = $GLOBALS['dossier_squelettes'].'/:'.$path;
+	}
+
+	// Depuis l'espace prive, remonter d'un cran 
+	$racine = (_DIR_RESTREINT ? '' : '../');
+
+	// Parcourir le chemin
+	foreach (split(':', $path) as $dir) {
+		if (substr($dir, 0,1)&lt;&gt;'/')
+			$f = &quot;$racine$dir$filename&quot;;
+		else
+			$f = &quot;$dir$filename&quot;;
+
+		if (@is_readable($f)) {
+			return $f;
+		}
+	}
+#	spip_log(&quot;find_in_path: pas de fichier '$filename' sur le chemin '$path'&quot;);
+}
+
+
+//
+// Que faire si Spip n'est pas installe... sauf si justement on l'installe!
+//
+if (!(_FILE_CONNECT
+OR defined('_ECRIRE_INSTALL')
+OR defined('_TEST_DIRS')
+OR defined('_ECRIRE_AIDE'))) {
+	// Soit on est dans ecrire/ et on envoie sur l'installation
+	if (@file_exists(&quot;inc_version.php3&quot;)) {
+		header(&quot;Location: &quot; . _DIR_RESTREINT . &quot;install.php3&quot;);
+		exit;
+	}
+	// Soit on est dans le site public
+	else if (defined(&quot;_INC_PUBLIC&quot;)) {
+		# on ne peut pas deviner ces repertoires avant l'installation !
+		define('_DIR_INCLUDE', _DIR_RESTREINT);
+		define('_DIR_IMG_PACK', (_DIR_RESTREINT . 'img_pack/'));
+		define('_DIR_LANG', (_DIR_RESTREINT . 'lang/'));
+		$db_ok = false;
+		include_ecrire (&quot;inc_presentation.php3&quot;);
+		install_debut_html(_T('info_travaux_titre'));
+		echo &quot;&lt;p&gt;&quot;._T('info_travaux_texte').&quot;&lt;/p&gt;&quot;;
+		install_fin_html();
+		exit;
+	}
+	// Soit on est appele de l'exterieur (spikini, etc)
 }
 
 ?&gt;

Index: inc_lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_lang.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_lang.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_lang.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,90 +1,79 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_LANG&quot;)) return;
 define(&quot;_ECRIRE_INC_LANG&quot;, &quot;1&quot;);
 
-//
-// Ecrire un fichier cache langue
-//
-function ecrire_cache_lang($lang, $module) {
-	include_ecrire('inc_filtres.php3');
-
-	$contenu = &quot;&lt;&quot;.&quot;?php\n\n// Ceci est le CACHE d'un fichier langue spip\n\n&quot;;
-	if (is_array($cache = $GLOBALS['cache_lang'][$lang])) {
-		$contenu .= &quot;\$GLOBALS[\$GLOBALS['idx_lang']] = array(\n&quot;;
-		$texte = '';
-		ksort($cache);
-		reset($cache);
-		while (list($code, ) = each($cache))
-			$texte .= &quot;,\n\t'&quot;.$code.&quot;' =&gt; '&quot;.texte_script($GLOBALS['i18n_'.$module.'_'.$lang][$code]).&quot;'&quot;;
-		$contenu .= substr($texte,2).&quot;\n);\n\n&quot;;
-		$contenu .= &quot;\$GLOBALS['cache_lang']['$lang'] = array(\n&quot;;
-		$texte = '';
-		reset($cache);
-		while (list($code, ) = each($cache))
-			$texte .= &quot;,\n\t'&quot;.$code.&quot;' =&gt; 1&quot;;
-		$contenu .= substr($texte,2).&quot;\n);\n\n&quot;;
-	}
-	$contenu .= &quot;\n\n?&quot;.&quot;&gt;\n&quot;;
-
-	ecrire_fichier (_DIR_CACHE . 'lang_'.$module.'_'.$lang.'.php3', $contenu);
-}
-
-function ecrire_caches_langues() {
-	global $cache_lang_modifs;
-	reset($cache_lang_modifs);
-	while(list($module,$cache_module) = each($cache_lang_modifs))
-		while(list($lang, ) = each($cache_module))
-			ecrire_cache_lang($lang, $module);
-}
 
 //
 // Charger un fichier langue
 //
-function charger_langue($lang, $module = 'spip', $forcer = false) {
+
+function charger_langue($lang, $module = 'spip') {
 
 	$fichier_lang = $module.'_'.$lang.'.php3';
 	$fichier_lang_exists = @is_readable(_DIR_LANG . $fichier_lang);
 
-	if (_DIR_RESTREINT AND _FILE_CONNECT AND $fichier_lang_exists) {
-	  $fichier_cache = _DIR_CACHE . 'lang_'.$module.'_'.$lang.'.php3';
-	  $fichier_cache_time = @is_readable($fichier_cache) ? @filemtime($fichier_cache) : false;
-
-	  if (!$forcer AND $fichier_cache_time
-		AND ($fichier_cache_time &gt; @filemtime(_DIR_LANG .$module.'_'.$lang.'.php3'))
-		AND ($fichier_cache_time &gt; @filemtime(_DIR_LANG . 'perso.php3'))) {
-			$GLOBALS['idx_lang'] = 'i18n_'.$module.'_'.$lang;
-			if (lire_fichier($fichier_cache,	$contenu, array('phpcheck' =&gt; 'oui'))) {
-				eval ('?'.'&gt;'.$contenu);
-				return;
-			}
-	  }
-		else $GLOBALS['cache_lang_modifs'][$module][$lang] = true;
-	}
-
 	if ($fichier_lang_exists) {
 		$GLOBALS['idx_lang']='i18n_'.$module.'_'.$lang;
 		include_lang($fichier_lang);
 	} else {
 		// si le fichier de langue du module n'existe pas, on se rabat sur
-		// le francais, qui *par definition* doit exister, et on copie le
-		// tableau 'fr' dans la var liee a la langue
-		$fichier_lang = $module.'_fr.php3';
-		if (@is_readable(_DIR_LANG . $fichier_lang)) {
-			$GLOBALS['idx_lang']='i18n_'.$module.'_fr';
+		// la langue par defaut du site -- et au pire sur le francais, qui
+		// *par definition* doit exister, et on copie le tableau dans la
+		// var liee a la langue
+		$l = lire_meta('langue_site');
+		if (!is_readable(_DIR_LANG . $module.'_'.$l.'.php3'))
+			$l = 'fr';
+		$fichier_lang = $module.'_' .$l. '.php3';
+		if (is_readable(_DIR_LANG . $fichier_lang)) {
+			$GLOBALS['idx_lang']='i18n_'.$module.'_' .$l;
 			include_lang($fichier_lang);
+			$GLOBALS['i18n_'.$module.'_'.$lang]
+				= &amp;$GLOBALS['i18n_'.$module.'_'.$l];
+			spip_log(&quot;module de langue : ${module}_$l.php3&quot;);
 		}
-		$GLOBALS['i18n_'.$module.'_'.$lang] = $GLOBALS['i18n_'.$module.'_fr'];
 	}
 
-	// surcharge perso
-	if (@is_readable(_DIR_LANG .'perso.php3')) {
-		include_lang('perso.php3');
-	}
+	// surcharge perso -- on cherche le fichier local(_xx).php3 dans le chemin
+	if ($f = (find_in_path('local.php3')))
+		surcharger_langue($f);
+	if ($f = (find_in_path('local_'.$lang.'.php3')))
+		surcharger_langue($f);
+	// compatibilite ascendante : chercher aussi local_xx.php3 dans ecrire/lang/
+	else if (@is_readable($f = _DIR_LANG . 'local_'.$lang.'.php3'))
+		surcharger_langue($f);
+}
+
+//
+// Surcharger le fichier de langue courant avec un autre (tordu, hein...)
+//
+function surcharger_langue($f) {
+	$idx_lang_normal = $GLOBALS['idx_lang'];
+	$GLOBALS['idx_lang'] .= '_temporaire';
+	include($f);
 
+	if (is_array($GLOBALS[$GLOBALS['idx_lang']]))
+		foreach ($GLOBALS[$GLOBALS['idx_lang']] as $var =&gt; $val)
+			$GLOBALS[$idx_lang_normal][$var] = $val;
+
+	unset ($GLOBALS[$GLOBALS['idx_lang']]);
+	$GLOBALS['idx_lang'] = $idx_lang_normal;
 }
 
+
+
 //
 // Changer la langue courante
 //
@@ -112,9 +101,9 @@
 // Regler la langue courante selon les infos envoyees par le brouteur
 //
 function regler_langue_navigateur() {
-	global $HTTP_SERVER_VARS, $HTTP_COOKIE_VARS;
+	global $_SERVER, $_COOKIE;
 
-	$accept_langs = explode(',', $HTTP_SERVER_VARS['HTTP_ACCEPT_LANGUAGE']);
+	$accept_langs = explode(',', $_SERVER['HTTP_ACCEPT_LANGUAGE']);
 	if (is_array($accept_langs)) {
 		while(list(, $s) = each($accept_langs)) {
 			if (eregi('^([a-z]{2,3})(-[a-z]{2,3})?(;q=[0-9.]+)?$', trim($s), $r)) {
@@ -132,10 +121,14 @@
 //
 function traduire_chaine($code, $args) {
 	global $spip_lang;
-	global $cache_lang;
 
-	// liste des modules a parcourir
-	$modules = array('spip');
+	// modules par defaut
+	if (_DIR_RESTREINT)
+		$modules = array('spip');
+	else
+		$modules = array('spip', 'ecrire');
+
+	// modules demandes explicitement
 	if (strpos($code, ':')) {
 		if (ereg(&quot;^([a-z/]+):(.*)$&quot;, $code, $regs)) {
 			$modules = explode(&quot;/&quot;,$regs[1]);
@@ -143,17 +136,12 @@
 		}
 	}
 
-	$text = '';
 	// parcourir tous les modules jusqu'a ce qu'on trouve
+	$text = '';
 	while (!$text AND (list(,$module) = each ($modules))) {
 		$var = &quot;i18n_&quot;.$module.&quot;_&quot;.$spip_lang;
-		if (empty($GLOBALS[$var])) charger_langue($spip_lang, $module);
-		if (_DIR_RESTREINT) {
-			if (!isset($GLOBALS[$var][$code]))
-				charger_langue($spip_lang, $module, $code);
-			if (isset($GLOBALS[$var][$code]))
-				$cache_lang[$spip_lang][$code] = 1;
-		}
+		if (empty($GLOBALS[$var]))
+			charger_langue($spip_lang, $module);
 		$text = $GLOBALS[$var][$code];
 	}
 
@@ -177,6 +165,7 @@
 
 
 function traduire_nom_langue($lang) {
+	init_codes_langues();
 	$r = $GLOBALS['codes_langues'][$lang];
 	if (!$r) $r = $lang;
 
@@ -299,6 +288,7 @@
 	'pl' =&gt; &quot;polski&quot;,
 	'ps' =&gt; &quot;Pashto, Pushto&quot;,
 	'pt' =&gt; &quot;Portugu&#234;s&quot;,
+	'pt_br' =&gt; &quot;Portugu&#234;s do Brasil&quot;,
 	'qu' =&gt; &quot;Quechua&quot;,
 	'rm' =&gt; &quot;Rhaeto-Romance&quot;,
 	'rn' =&gt; &quot;Kirundi&quot;,
@@ -430,7 +420,12 @@
 		$cible = '';
 	} else {
 		$site = lire_meta(&quot;adresse_site&quot;);
-		if (!$site) $site = '..';
+		if (!$site)
+			if (_DIR_RESTREINT)
+				$site = '.';
+			else
+				$site = '..';
+
 		if (!_DIR_RESTREINT) {
 			include_ecrire('inc_admin.php3');
 			$cible = _DIR_RESTREINT_ABS . $lien-&gt;getUrl();
@@ -493,13 +488,16 @@
 // si necessaire vers l'URL xxxx?lang=ll
 //
 function verifier_lang_url() {
-	global $HTTP_GET_VARS, $HTTP_COOKIE_VARS, $spip_lang, $clean_link;
+	global $_GET, $_COOKIE, $spip_lang, $clean_link;
 
 	// quelle langue est demandee ?
 	$lang_demandee = lire_meta('langue_site');
-	if ($HTTP_COOKIE_VARS['spip_lang_ecrire']) $lang_demandee = $HTTP_COOKIE_VARS['spip_lang_ecrire'];
-	if ($HTTP_COOKIE_VARS['spip_lang']) $lang_demandee = $HTTP_COOKIE_VARS['spip_lang'];
-	if ($HTTP_GET_VARS['lang']) $lang_demandee = $HTTP_GET_VARS['lang'];
+	if ($_COOKIE['spip_lang_ecrire'])
+		$lang_demandee = $_COOKIE['spip_lang_ecrire'];
+	if ($_COOKIE['spip_lang'])
+		$lang_demandee = $_COOKIE['spip_lang'];
+	if ($_GET['lang'])
+		$lang_demandee = $_GET['lang'];
 
 	// Verifier que la langue demandee existe
 	include_ecrire('inc_lang.php3');
@@ -507,8 +505,8 @@
 	$lang_demandee = $spip_lang;
 
 	// Renvoyer si besoin
-	if (!($HTTP_GET_VARS['lang']&lt;&gt;'' AND $lang_demandee == $HTTP_GET_VARS['lang'])
-	AND !($HTTP_GET_VARS['lang']=='' AND $lang_demandee == lire_meta('langue_site')))
+	if (!($_GET['lang']&lt;&gt;'' AND $lang_demandee == $_GET['lang'])
+	AND !($_GET['lang']=='' AND $lang_demandee == lire_meta('langue_site')))
 	{
 		$destination = new Link;
 		$destination-&gt;addvar('lang', $lang_demandee);
@@ -520,7 +518,7 @@
 	// Subtilite : si la langue demandee par cookie est la bonne
 	// alors on fait comme si $lang etait passee dans l'URL
 	// (pour criteres {lang}).
-	$GLOBALS['lang'] = $GLOBALS['HTTP_GET_VARS']['lang'] = $spip_lang;
+	$GLOBALS['lang'] = $_GET['lang'] = $spip_lang;
 }
 
 
@@ -532,7 +530,7 @@
 }
 
 function utiliser_langue_visiteur() {
-	global $HTTP_COOKIE_VARS;
+	global $_COOKIE;
 
 	if (!regler_langue_navigateur())
 		utiliser_langue_site();
@@ -541,22 +539,20 @@
 		changer_langue($GLOBALS['auteur_session']['lang']);
 
 	$cookie_lang = (_DIR_RESTREINT  ? 'spip_lang' : 'spip_lang_ecrire');
-	if (!empty($HTTP_COOKIE_VARS[$cookie_lang]))
+	if (!empty($_COOKIE[$cookie_lang]))
 
-		changer_langue($HTTP_COOKIE_VARS[$cookie_lang]);
+		changer_langue($_COOKIE[$cookie_lang]);
 }
 
 //
 // Initialisation
 //
 function init_langues() {
-	global $all_langs, $langue_site, $cache_lang, $cache_lang_modifs;
+	global $all_langs, $langue_site;
 	global $pile_langues, $lang_typo, $lang_dir;
 
 	$all_langs = lire_meta('langues_proposees');
 	$langue_site = lire_meta('langue_site');
-	$cache_lang = array();
-	$cache_lang_modifs = array();
 	$pile_langues = array();
 	$lang_typo = '';
 	$lang_dir = '';
@@ -588,7 +584,6 @@
 			}
 		}
 	}
-	init_codes_langues();
 }
 
 init_langues();

Index: unpack.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/unpack.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- unpack.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ unpack.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 
 

Index: sites_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/sites_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- sites_edit.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ sites_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_sites.php3&quot;);
@@ -115,11 +126,12 @@
 if ($row = spip_fetch_array($result)) {
 	$id_syndic = $row[&quot;id_syndic&quot;];
 	$id_rubrique = $row[&quot;id_rubrique&quot;];
-	$nom_site = stripslashes($row[&quot;nom_site&quot;]);
-	$url_site = stripslashes($row[&quot;url_site&quot;]);
-	$url_syndic = stripslashes($row[&quot;url_syndic&quot;]);
-	$descriptif = stripslashes($row[&quot;descriptif&quot;]);
+	$nom_site = $row[&quot;nom_site&quot;];
+	$url_site = $row[&quot;url_site&quot;];
+	$url_syndic = $row[&quot;url_syndic&quot;];
+	$descriptif = $row[&quot;descriptif&quot;];
 	$syndication = $row[&quot;syndication&quot;];
+	$extra=$row[&quot;extra&quot;];
 }
 else {
 	$syndication = 'non';
@@ -269,6 +281,13 @@
 	echo &quot;&lt;INPUT TYPE='Hidden' NAME='syndication' VALUE=\&quot;$syndication\&quot;&gt;&quot;;
 	echo &quot;&lt;INPUT TYPE='hidden' NAME='url_syndic' VALUE=\&quot;$url_syndic\&quot;&quot;;
 }
+
+
+if ($champs_extra) {
+		include_ecrire(&quot;inc_extra.php3&quot;);
+		extra_saisie($extra, 'sites', $id_secteur);
+	}
+
 
 echo &quot;&lt;div ALIGN='right'&gt;&lt;INPUT TYPE='submit' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;' CLASS='fondo'&gt;&lt;/div&gt;&quot;;
 echo &quot;&lt;/FORM&gt;&quot;;

Index: inc_extra.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_extra.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_extra.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_extra.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,13 +1,24 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 
 ////////////////////////////////////////////////////////////////////////////////////
 // Pour utiliser les champs &quot;extra&quot;, il faut installer dans le fichier
 // ecrire/mes_options.php3 un tableau definissant les champs en question,
 // pour chaque type d'objet (article, rubrique, breve, auteur ou mot) que
 // l'on veut ainsi etendre ; utiliser dans l'espace public avec
-// [(#EXTRA|extra{&quot;nom_du_champ&quot;})]
-
+// [(#EXTRA|nom_du_champ)]
+// Exemples :
 
 /*
 
@@ -17,41 +28,56 @@
 
 $GLOBALS['champs_extra'] = Array (
 	'auteurs' =&gt; Array (
-			&quot;sexe&quot; =&gt; &quot;ligne|brut&quot;,
+			&quot;alim&quot; =&gt; &quot;radio|brut|Pr&eacute;f&eacute;rences alimentaires|Veggie,Viande&quot;,
+			&quot;habitation&quot; =&gt; &quot;liste|brut|Lieu|Kuala Lumpur,Cape Town,Uppsala&quot;,
+			&quot;ml&quot; =&gt; &quot;case|propre|Je souhaite m'abonner &agrave; la mailinglist&quot;,
 			&quot;age&quot; =&gt; &quot;ligne|propre|&Acirc;ge du capitaine&quot;,
 			&quot;biblio&quot; =&gt; &quot;bloc|propre|Bibliographie&quot;
 		),
 
 	'articles' =&gt; Array (
-			&quot;isbn&quot; =&gt; &quot;ligne|typo|ISBN&quot;
+			&quot;isbn&quot; =&gt; &quot;ligne|typo|ISBN&quot;,
+			 &quot;options&quot; =&gt; &quot;multiple|brut|Options de cet article|1,2,3,plus&quot;
+
+			 
 		)
 	);
+
+// Note : pour les listes et les radios on peut preciser les valeurs des labels 
+//  Exemples
+//  &quot;habitation&quot; =&gt; &quot;liste|brut|Lieu|San Diego,Suresnes|diego,suresnes&quot;,
+
+
 */
 
 
 /*
 
-// On peut optionnellement vouloir affiner les extras :
+// On peut optionnellement vouloir restreindre la portee des extras :
 // - pour les articles/rubriques/breves en fonction du secteur ;
 // - pour les auteurs en fonction du statut
 // - pour les mots-cles en fonction du groupe de mots
+// Exemples :
 
 $GLOBALS['champs_extra_proposes'] = Array (
 	'auteurs' =&gt; Array (
 		// tous : par defaut
-		'tous' =&gt;  'age|sexe',
-		// une biblio pour les admin (statut='0minirezo')
-		'0minirezo' =&gt; 'age|sexe|biblio'
+		'tous' =&gt;  'age|alim|ml',
+		// les admins (statut='0minirezo') ont plus de champs que les auteurs 
+		'0minirezo' =&gt; 'age|alim|ml|biblio|habitation'
 		),
 
 	'articles' =&gt; Array (
-		// tous : par defaut
+		// tous : par defaut aucun champs extra sur les articles
 		'tous' =&gt; '',
-		// 1 : id_secteur=1;
-		1 =&gt; 'isbn'
+		// seul le champs extra &quot;isbn&quot; est propos&#233; dans le secteur 1)
+		'1' =&gt; 'isbn',
+		// Dans le secteur 2 le champs &quot;options&quot; est propos&#233;)
+		'2' =&gt; 'options'
 		)
 	);
 
+
 */
 
 ////////////////////////////////////////////////////////////////////////////////////
@@ -100,18 +126,102 @@
 	reset($champs_proposes);
 	while (list(, $champ) = each($champs_proposes)) {
 		$desc = $champs[$champ];
-		list($form, $filtre, $prettyname) = explode(&quot;|&quot;, $desc);
+		list($form, $filtre, $prettyname, $choix, $valeurs) = explode(&quot;|&quot;, $desc);
 
 		if (!$prettyname) $prettyname = ucfirst($champ);
 		$affiche .= &quot;&lt;b&gt;$prettyname&nbsp;:&lt;/b&gt;&lt;br /&gt;&quot;;
+
 		switch($form) {
+
+			case &quot;case&quot;:
+			case &quot;checkbox&quot;:
+				$affiche = ereg_replace(&quot;&lt;br /&gt;$&quot;, &quot;&nbsp;&quot;, $affiche);
+				$affiche .= &quot;&lt;INPUT TYPE='checkbox' NAME='suppl_$champ'&quot;;
+				if ($extra[$champ] == 'true')
+					$affiche .= &quot; CHECKED &quot;;
+				break;
+
+			case &quot;list&quot;:
+			case &quot;liste&quot;:
+			case &quot;select&quot;:
+				$choix = explode(&quot;,&quot;,$choix);
+				if (!is_array($choix)) {
+					$affiche .= &quot;Pas de choix d&eacute;finis.\n&quot;;
+					break;
+				}
+
+				// prendre en compte les valeurs des champs
+				// si elles sont renseignees
+				$valeurs = explode(&quot;,&quot;,$valeurs);
+				if($valeurs == explode(&quot;,&quot;,&quot;&quot;))
+					$valeurs = $choix ;
+
+				$affiche .= &quot;&lt;SELECT NAME='suppl_$champ' &quot;;
+				$affiche .= &quot;CLASS='forml'&gt;\n&quot;;
+				$i = 0 ;
+				while (list(, $choix_) = each($choix)) {
+					$val = $valeurs[$i] ;
+					$affiche .= &quot;&lt;OPTION VALUE=\&quot;$val\&quot;&quot;;
+					if ($val == entites_html($extra[$champ]))
+						$affiche .= &quot; SELECTED&quot;;
+					$affiche .= &quot;&gt;$choix_&lt;/OPTION&gt;\n&quot;;
+					$i++;
+				}
+				$affiche .= &quot;&lt;/SELECT&gt;&quot;;
+				break;
+
+			case &quot;radio&quot;:
+				$choix = explode(&quot;,&quot;,$choix);
+				if (!is_array($choix)) {
+					$affiche .= &quot;Pas de choix d&eacute;finis.\n&quot;;
+					break;
+				}
+				$valeurs = explode(&quot;,&quot;,$valeurs);
+				if($valeurs == explode(&quot;,&quot;,&quot;&quot;))
+					$valeurs = $choix ;
+
+				$i=0;
+				while (list(, $choix_) = each($choix)) {
+					$affiche .= &quot;&lt;INPUT TYPE='radio' NAME='suppl_$champ' &quot;;
+					$val = $valeurs[$i] ;
+					if (entites_html($extra[&quot;$champ&quot;])== $val)
+						$affiche .= &quot; CHECKED&quot;;
+
+					// premiere valeur par defaut
+					if (!$extra[&quot;$champ&quot;] AND $i == 0)
+						$affiche .= &quot; CHECKED&quot;;
+
+					$affiche .= &quot; VALUE='$val'&gt;$choix_&lt;/INPUT&gt;\n&quot;;
+					$i++;
+				}
+				break;
+
+			// A refaire car on a pas besoin de renvoyer comme pour checkbox
+			// les cases non cochees
+			case &quot;multiple&quot;:
+				$choix = explode(&quot;,&quot;,$choix);
+				if (!is_array($choix)) {
+					$affiche .= &quot;Pas de choix d&eacute;finis.\n&quot;;
+					break; }
+				for ($i=0; $i &lt; count($choix); $i++) {
+					$affiche .= &quot;&lt;INPUT TYPE='checkbox' NAME='suppl_$champ$i'&quot;;
+					if (entites_html($extra[&quot;$champ&quot;][$i])==&quot;on&quot;)
+						$affiche .= &quot; CHECKED&quot;;
+					$affiche .= &quot;&gt;\n&quot;;
+					$affiche .= $choix[$i];
+					$affiche .= &quot;&lt;/INPUT&gt;\n&quot;;
+				}
+				break;
+
 			case &quot;bloc&quot;:
 			case &quot;block&quot;:
 				$affiche .= &quot;&lt;TEXTAREA NAME='suppl_$champ' CLASS='forml' ROWS='5' COLS='40'&gt;&quot;.entites_html($extra[$champ]).&quot;&lt;/TEXTAREA&gt;\n&quot;;
 				break;
+
 			case &quot;masque&quot;:
 				$affiche .= &quot;&lt;font color='#555555'&gt;&quot;.interdire_scripts($extra[$champ]).&quot;&lt;/font&gt;\n&quot;;
 				break;
+
 			case &quot;ligne&quot;:
 			case &quot;line&quot;:
 			default:
@@ -135,8 +245,36 @@
 	$champs = $GLOBALS['champs_extra'][$type];
 	if (is_array($champs)) {
 		$extra = Array();
-		while(list($champ,)=each($champs))
-			$extra[$champ]=$GLOBALS[&quot;suppl_$champ&quot;];
+		while(list($champ,)=each($champs)) {
+			list($style, $filtre, , $choix,) = explode(&quot;|&quot;, $GLOBALS['champs_extra'][$type][$champ]);
+			list(, $filtre) = explode(&quot;,&quot;, $filtre);
+			switch ($style) {
+			case &quot;multiple&quot;:
+				$choix =  explode(&quot;,&quot;, $choix);
+				$extra[&quot;$champ&quot;] = array();
+				for ($i=0; $i &lt; count($choix); $i++) {
+					if ($filtre &amp;&amp; function_exists($filtre))
+						 $extra[&quot;$champ&quot;][$i] =
+						 	$filtre($GLOBALS[&quot;suppl_$champ$i&quot;]);
+					else
+						$extra[&quot;$champ&quot;][$i] = $GLOBALS[&quot;suppl_$champ$i&quot;];
+				}
+				break;
+
+			case 'case':
+			case 'checkbox':
+				if ($GLOBALS[&quot;suppl_$champ&quot;] == 'on')
+					$GLOBALS[&quot;suppl_$champ&quot;] = 'true';
+				else
+					$GLOBALS[&quot;suppl_$champ&quot;] = 'false';
+
+			default:
+				if ($filtre &amp;&amp; function_exists($filtre))
+				$extra[&quot;$champ&quot;]=$filtre($GLOBALS[&quot;suppl_$champ&quot;]);
+				else $extra[&quot;$champ&quot;]=$GLOBALS[&quot;suppl_$champ&quot;];
+				break;
+			}
+		}
 		return serialize($extra);
 	} else
 		return '';
@@ -145,8 +283,21 @@
 // Retourne la liste des filtres a appliquer pour un champ extra particulier
 function extra_filtres($type, $nom_champ) {
 	$champ = $GLOBALS['champs_extra'][$type][$nom_champ];
-	if (!$champ) return array();;
+	if (!$champ) return array();
+	list(, $filtre, ) = explode(&quot;|&quot;, $champ);
+	list($filtre, ) = explode(&quot;,&quot;, $filtre);
+	if ($filtre &amp;&amp; $filtre != 'brut' &amp;&amp; function_exists($filtre))
+		return array($filtre);
+	return array();
+}
+
+// Retourne la liste des filtres a appliquer a la recuperation
+// d'un champ extra particulier
+function extra_filtres_recup($type, $nom_champ) {
+	$champ = $GLOBALS['champs_extra'][$type][$nom_champ];
+	if (!$champ) return array();
 	list(, $filtre, ) = explode(&quot;|&quot;, $champ);
+	list(,$filtre) = explode(&quot;,&quot;, $filtre);
 	if ($filtre &amp;&amp; $filtre != 'brut' &amp;&amp; function_exists($filtre))
 		return array($filtre);
 	return array();
@@ -163,13 +314,37 @@
 	$champs = $GLOBALS['champs_extra'][$type];
 
 	while (list($nom,$contenu) = each($extra)) {
-		list($type, $filtre, $prettyname) = explode(&quot;|&quot;, $champs[$nom]);
+		list ($style, $filtre, $prettyname, $choix, $valeurs) =
+			explode(&quot;|&quot;, $champs[$nom]);
+		list($filtre, ) = explode(&quot;,&quot;, $filtre);
+		switch ($style) {
+			case &quot;checkbox&quot;:
+			case &quot;case&quot;:
+				if ($contenu==&quot;true&quot;) $contenu = _T('item_oui');
+				elseif ($contenu==&quot;false&quot;) $contenu = _T('item_non');
+				break;
+
+			case &quot;multiple&quot;:
+				$contenu_ = &quot;&quot;;
+				$choix = explode (&quot;,&quot;, $choix);
+				if (is_array($contenu) AND is_array($choix)
+				AND count($choix)==count($contenu))
+					for ($i=0; $i &lt; count($contenu); $i++)
+						if ($contenu[$i] == &quot;on&quot;)
+							$contenu_ .= &quot;$choix[$i], &quot;;
+						else if ($contenu[$i] &lt;&gt; '')
+							$contenu_ = &quot;Choix incoh&eacute;rents, &quot;
+							.&quot;v&eacute;rifiez la configuration... &quot;;
+				$contenu = ereg_replace(&quot;, $&quot;, &quot;&quot;, $contenu_);
+				break;
+		}
 		if ($filtre != 'brut' AND function_exists($filtre))
 			$contenu = $filtre($contenu);
 		if (!$prettyname)
 			$prettyname = ucfirst($nom);
 		if ($contenu)
-			$affiche .= &quot;&lt;div&gt;&lt;b&gt;$prettyname&nbsp;:&lt;/b&gt; &quot;.interdire_scripts($contenu).&quot;&lt;br /&gt;&lt;/div&gt;\n&quot;;
+			$affiche .= &quot;&lt;div&gt;&lt;b&gt;$prettyname&nbsp;:&lt;/b&gt; &quot;
+			.interdire_scripts($contenu).&quot;&lt;br /&gt;&lt;/div&gt;\n&quot;;
 	}
 
 	if ($affiche) {

Index: inc_index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_index.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_index.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_index.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_INDEX&quot;)) return;

Index: forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/forum.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- forum.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ forum.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 // cette page gere les deux types de forums ; forum_admin.php3 n'est qu'une coquille vide

Index: controle_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/controle_forum.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- controle_forum.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ controle_forum.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 function forum_parent($id_forum) {

Index: js_menu_rubriques.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/js_menu_rubriques.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- js_menu_rubriques.php	13 Jan 2005 15:37:16 -0000	1.1
+++ js_menu_rubriques.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,18 +1,22 @@
 &lt;?php
 
-include_once(&quot;inc.php3&quot;);
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
 
-// Gestion d'expiration de ce jaja
-$expire = $date + 3600*24;
 
-$headers_only = http_last_modified($expire);
+include_once(&quot;inc.php3&quot;);
+
+if (http_last_modified(@filemtime(&quot;js_menu_rubriques.php&quot;), time() + 24 * 3600)) 
+	exit;
 
-$date = gmdate(&quot;D, d M Y H:i:s&quot;, $date);
-$expire = gmdate(&quot;D, d M Y H:i:s&quot;, $expire);
 @Header (&quot;Content-Type: text/javascript&quot;);
-if ($headers_only) exit;
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at Header</A> (&quot;Last-Modified: &quot;.$date.&quot; GMT&quot;);
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at Header</A> (&quot;Expires: &quot;.$expire.&quot; GMT&quot;);
 
 function extraire_article($id_p) {
 	if (array_key_exists($id_p, $GLOBALS['db_art_cache'])) {

Index: mes_options.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/mes_options.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- mes_options.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ mes_options.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,40 +1,162 @@
 &lt;?
+//$mysql_profile = true;
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//          MODULE CARTO
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
 
-///////////////////////////////////////////
-//PROTOMAIL (webmail de free)
-//////////////////////////////////////////
-global $server_ip_index, $server_ips, $nb_retry, $server_dns, $use_dns, $free_user_name, $free_user_passwd ;
-$free_user_name='spipcarto';
-$free_user_passwd='ultrabil';
-/* les ip's du serveur imp (nslookup imp.free.fr) */
-$i=0;
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+// PARAMETRAGE
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
 
-$server_ips[$i++] = '212.27.42.5';
-$server_ips[$i++] = '212.27.42.1';
-$server_ips[$i++] = '212.27.42.3';
-$server_ips[$i++] = '212.27.42.4';
-$server_ips[$i++] = '212.27.42.6';
-$server_ips[$i++] = '212.27.42.2';
+//////////////////////////////////////////////////
+// CARTO_CARTES
+//////////////////////////////////////////////////
+$spip_carto_cartes = array(
+	&quot;id_carto_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
+	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
+	&quot;texte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;url_carte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;callage&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;id_srs&quot; =&gt; &quot;bigint(21) NOT NULL&quot;);
 
-/* choisir un serveur initial par randum */
+$spip_carto_cartes_key = array(
+	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_carto_carte&quot; =&gt; &quot;id_carto_carte&quot;);
 
-srand ((double) microtime() * 10000000);
-$server_ip_index =  array_rand ($server_ips);
 
+//////////////////////////////////////////////////
+// CARTO_OBJETS
+//////////////////////////////////////////////////
 
-/* ou choisir un serveur initial fixe */
-/* $server_ip_index = 1; */
+$spip_carto_objets = array(
+	&quot;id_carto_objet&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
+	&quot;id_carto_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
+	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
+	&quot;texte&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;url_objet&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;url_logo&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
+	&quot;geometrie&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;);
+	
+$spip_carto_objets_key = array(
+	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carto_objet&quot;,
+	&quot;KEY id_carto_carte&quot; =&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY titre&quot; =&gt; &quot;titre&quot;);
 
-/* choisissez le nombre de tentatives de connexion */
-$nb_retry = 36;
+//////////////////////////////////////////////////
+// CARTO_CARTES_ARTICLES
+//////////////////////////////////////////////////
 
-/* ou choisir un serveur */
-//$server_ip = $server_ips[6];
+$spip_carto_cartes_articles = array(
+	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_article&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
 
-/* l'utilisation de imp.free.fr est possible mais ne semble pas fonctionner */
+$spip_carto_cartes_articles_key = array(
+	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_article&quot; =&gt; &quot;id_article&quot;);
 
-$server_dns = 'imp.free.fr';
 
-$use_dns = false;
+//////////////////////////////////////////////////
+// CARTO_CARTES_ARTICLES
+//////////////////////////////////////////////////
+
+$spip_carto_cartes_articles = array(
+	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_article&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
+
+$spip_carto_cartes_articles_key = array(
+	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_article&quot; =&gt; &quot;id_article&quot;);
+
+
+$tables_auxiliaires['spip_carto_cartes_articles'] = array(
+	'field' =&gt; &amp;$spip_carto_cartes_articles,
+	'key' =&gt; &amp;$spip_carto_cartes_articles_key);
+
+//////////////////////////////////////////////////
+// MOTS_CARTO_OBJETS
+//////////////////////////////////////////////////
+
+$spip_mots_carto_objets= array(
+	&quot;id_carto_objet&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_mot&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
+
+$spip_mots_carto_objets_key = array(
+	&quot;KEY id_carto_objet&quot; 	=&gt; &quot;id_carto_objet&quot;,
+	&quot;KEY id_mot&quot; =&gt; &quot;id_mot&quot;);
+
+//////////////////////////////////////////////////
+// DOCUMENTS_CARTO_OBJETS
+//////////////////////////////////////////////////
 
+$spip_documents_carto_cartes= array(
+	&quot;id_carto_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
+	&quot;id_document&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);
+
+$spip_documents_carto_cartes_key = array(
+	&quot;KEY id_carto_carte&quot; 	=&gt; &quot;id_carto_carte&quot;,
+	&quot;KEY id_document&quot; =&gt; &quot;id_document&quot;);
+
+
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+// DECLARATION
+//////////////////////////////////////////////////
+//////////////////////////////////////////////////
+
+//global $tables_principales,$table_primary,$tables_auxiliaires,$tables_relations;
+
+
+$tables_principales['spip_carto_cartes'] =
+	array('field' =&gt; &amp;$spip_carto_cartes, 'key' =&gt; &amp;$spip_carto_cartes_key);
+
+$tables_principales['spip_carto_objets'] =
+	array('field' =&gt; &amp;$spip_carto_objets, 'key' =&gt; &amp;$spip_carto_objets_key);
+
+//Relation avec les articles
+$tables_auxiliaires['spip_carto_cartes_articles'] = array(
+	'field' =&gt; &amp;$spip_carto_cartes_articles,
+	'key' =&gt; &amp;$spip_carto_cartes_articles_key);
+
+//La, ca se discute ...
+//Ca devrait etre une table secondaire
+//mais comme on n'utilise que l'id_mot dans la boucle
+//on gagne une jointure dans la requete
+//$tables_principales['spip_mots_carto_objets'] = array(
+//	'field' =&gt; &amp;$spip_mots_carto_objets,
+//	'key' =&gt; &amp;$spip_mots_carto_objets_key);
+$tables_auxiliaires['spip_mots_carto_objets'] = array(
+	'field' =&gt; &amp;$spip_mots_carto_objets,
+	'key' =&gt; &amp;$spip_mots_carto_objets_key);
+	
+
+$table_primary['carto_objets']=&quot;id_carto_objet&quot;;
+$table_primary['carto_cartes']=&quot;id_carto_carte&quot;;
+$table_primary['forms']=&quot;id_form&quot;;
+
+$table_des_tables['carto_objets']=&quot;carto_objets&quot;;
+$table_des_tables['carto_cartes']=&quot;carto_cartes&quot;;
+$table_des_tables['forms']=&quot;forms&quot;;
+
+$tables_relations['documents']['id_carto_carte']='documents_carto_cartes';
+$tables_relations['mots']['id_carto_objet']='mots_carto_objets';
+$tables_relations['carto_objets']['id_mot']='mots_carto_objets';
+$tables_relations['carto_cartes']['id_document']='documents_carto_cartes';
+
+function boucle_CARTO_CARTES($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$boucle-&gt;from[] =  &quot;spip_carto_cartes AS &quot; . $boucle-&gt;type_requete;
+	return calculer_boucle($id_boucle, $boucles); 
+}
+
+function boucle_CARTO_OBJETS($id_boucle, &amp;$boucles) {
+	$boucle = &amp;$boucles[$id_boucle];
+	$boucle-&gt;from[] =  &quot;spip_carto_objets AS &quot; . $boucle-&gt;type_requete;
+	return calculer_boucle($id_boucle, $boucles); 
+}
 ?&gt;

Index: brouteur_frame.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/brouteur_frame.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- brouteur_frame.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ brouteur_frame.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 debut_html();
@@ -66,7 +77,10 @@
 
 	}
 	else {
-		$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique=$id_rubrique ORDER BY titre&quot;;
+	  if (isset($id_rubrique) &amp;&amp; ($id_rubrique !== ''))
+ {
+
+		$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique='$id_rubrique' ORDER BY titre&quot;;
 		$result=spip_query($query);
 		if ($row=spip_fetch_array($result)){
 			$ze_rubrique=$row['id_rubrique'];
@@ -84,11 +98,9 @@
 			icone_horizontale(_T('info_racine_site'), &quot;javascript:window.parent.location=\&quot;naviguer.php3\&quot;&quot;, &quot;racine-site-24.gif&quot;,&quot;&quot;);
 			echo &quot;&lt;/div&gt;&quot;;
 		}
+
 	
-	
-	
-	
-		$query = &quot;SELECT * FROM spip_rubriques WHERE id_parent=$id_rubrique ORDER BY titre&quot;;
+		$query = &quot;SELECT * FROM spip_rubriques WHERE id_parent='$id_rubrique' ORDER BY titre&quot;;
 		$result=spip_query($query);
 		while($row=spip_fetch_array($result)){
 			$ze_rubrique=$row['id_rubrique'];
@@ -96,6 +108,7 @@
 			$id_parent=$row['id_parent'];
 			
 			echo &quot;&lt;div class='brouteur_rubrique' onMouseOver=\&quot;changeclass(this, 'brouteur_rubrique_on');\&quot; onMouseOut=\&quot;changeclass(this, 'brouteur_rubrique');\&quot;&gt;&quot;;
+
 			if ($id_parent == '0') 	{
 			  echo &quot;&lt;div style='background-image: url(&quot; . _DIR_IMG_PACK . &quot;secteur-24.gif);'&gt;&lt;a href='brouteur_frame.php3?id_rubrique=$ze_rubrique&amp;frame=&quot;.($frame+1).&quot;&amp;effacer_suivant=oui' target='iframe&quot;.($frame+1).&quot;'&gt;$titre&lt;/a&gt;&lt;/div&gt;&quot;;
 			}
@@ -106,7 +119,7 @@
 			}
 			echo &quot;&lt;/div&gt;\n&quot;;
 		}
-	
+
 	
 		if ($id_rubrique &gt; 0) {
 			if ($connect_statut == &quot;0minirezo&quot;) $query = &quot;SELECT articles.id_article, articles.titre, articles.statut FROM spip_articles AS articles WHERE id_rubrique=$id_rubrique ORDER BY date DESC&quot;;
@@ -191,7 +204,7 @@
 			}
 		}
 
-	
+
 		if ($frame == 0 AND $id_rubrique==0) {
 	
 			$query = &quot;SELECT articles.id_article, articles.titre, articles.statut FROM spip_articles AS articles, spip_auteurs_articles AS lien WHERE articles.statut = 'prepa' AND articles.id_article = lien.id_article AND lien.id_auteur = $connect_id_auteur GROUP BY id_article ORDER BY articles.date DESC&quot;;
@@ -217,7 +230,7 @@
 		}
 
 	}
-
+   }
 	echo &quot;&lt;/div&gt;&quot;;
 
 echo &quot;&lt;/body&gt;&lt;/html&gt;&quot;;

Index: messagerie.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/messagerie.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- messagerie.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ messagerie.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_acces.php3&quot;);
 include_ecrire (&quot;inc_calendrier.php&quot;);

Index: inc_config_plug.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_config_plug.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_config_plug.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_config_plug.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_CONFIG_PLUG&quot;)) return;
@@ -13,7 +24,7 @@
 	
 	while ($f = readdir($d)) {
 		if (is_file(&quot;$dir/$f&quot;) AND $f != 'remove.txt') {
-			if (ereg(&quot;^plug&quot;, $f)) {
+			if (ereg(&quot;^plug_.*\.php3?$&quot;, $f)) {
 				$fichiers[] = &quot;$dir/$f&quot;;
 			}
 		} else if (is_dir(&quot;$dir/$f&quot;) AND $f != '.' AND $f != '..') {

Index: forum_envoi.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/forum_envoi.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- forum_envoi.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ forum_envoi.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_barre.php3&quot;);
 include_ecrire (&quot;inc_forum.php3&quot;);

Index: calendrier_jour.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/calendrier_jour.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- calendrier_jour.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ calendrier_jour.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,37 +1,16 @@
 &lt;?php
 
-include (&quot;inc.php3&quot;);
-include_ecrire (&quot;inc_calendrier.php&quot;);
-
-$today=getdate(time());
-$jour_today = $today[&quot;mday&quot;];
-$mois_today = $today[&quot;mon&quot;];
-$annee_today = $today[&quot;year&quot;];
-
-// sans arguments =&gt; mois courant
-if (!$mois){
-  $jour=$jour_today;
-  $mois=$mois_today;
-  $annee=$annee_today;
-}
-
-$date = date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois, $jour, $annee));
-$jour = journum($date);
-$mois = mois($date);
-$annee = annee($date);
-
-
-$afficher_bandeau_calendrier = true;
-
-debut_page(nom_jour(&quot;$annee-$mois-$jour&quot;).&quot; &quot;. affdate_jourcourt(&quot;$annee-$mois-$jour&quot;),  
-	   &quot;redacteurs&quot;,
-	   &quot;calendrier&quot;);
-
-debut_gauche();
-
-echo http_calendrier_journee($jour_today,$mois_today,$annee_today, 
-		  date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois, $jour, $annee)));
-
-fin_page();
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
 
+$type = 'jour';
+include (&quot;calendrier.php3&quot;);
+exit;
 ?&gt;

Index: inc_filtres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_filtres.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_filtres.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_filtres.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_FILTRES&quot;)) return;
@@ -103,18 +114,33 @@
 // Fabrique une balise A, avec un href conforme au validateur W3C
 // attention au cas ou la href est du Javascript avec des &quot;'&quot;
 
-function http_href($href, $clic, $title='', $style='', $class='') {
+function http_href($href, $clic, $title='', $style='', $class='', $evt='') {
 	return '&lt;a href=&quot;' .
 		str_replace('&amp;', '&amp;', $href) .
 		'&quot;' .
-		(!$style ? '' : (&quot; style=\&quot;&quot; . $style . &quot;\&quot;&quot;)) .
-		(!$title ? '' : (&quot; title=\&quot;&quot; . supprimer_tags($title).&quot;\&quot;&quot;)) .
-		(!$class ? '' : (&quot; class=\&quot;&quot; . $class . &quot;\&quot;&quot;)) .
+		(!$title ? '' : (&quot;\ntitle=\&quot;&quot; . supprimer_tags($title).&quot;\&quot;&quot;)) .
+		(!$style ? '' : (&quot;\nstyle=\&quot;&quot; . $style . &quot;\&quot;&quot;)) .
+		(!$class ? '' : (&quot;\nclass=\&quot;&quot; . $class . &quot;\&quot;&quot;)) .
+		($evt ? &quot;\n$evt&quot; : '') .
 		'&gt;' .
 		$clic .
 		'&lt;/a&gt;';
 }
 
+// produit une balise img avec un champ alt d'office (et different) si vide
+// attention le htmlentities et la traduction doivent etre appliques avant.
+
+function http_img_pack($img, $alt, $att) {
+  static $num = 0;
+  return &quot;&lt;img src='&quot; . _DIR_IMG_PACK . $img .
+    (&quot;'\nalt=\&quot;&quot; . ($alt ? $alt : ('img_pack' . $num++)) . '&quot; ') .
+    $att . &quot; /&gt;&quot;;
+}
+
+function http_href_img($href, $img, $att, $title='', $style='', $class='', $evt='') {
+	return  http_href($href, http_img_pack($img, $title, $att), $title, $style, $class, $evt);
+}
+
 // Corrige les caracteres degoutants utilises par les Windozeries
 function corriger_caracteres($texte) {
 	static $trans;
@@ -141,11 +167,7 @@
 	}
 	$charset = lire_meta('charset');
 	if (!$trans[$charset]) return $texte;
-	if ($GLOBALS['flag_strtr2']) return strtr($texte, $trans[$charset]);
-	reset($trans[$charset]);
-	while (list($from, $to) = each($trans[$charset])) 
-		$texte = str_replace($from, $to, $texte);
-	return $texte;
+	return strtr($texte, $trans[$charset]);
 }
 
 // Transformer les sauts de paragraphe en simples passages a la ligne
@@ -192,16 +214,6 @@
 }
 
 
-// Transforme n'importe quel champ en une chaine utilisable
-// en PHP ou Javascript en toute securite
-// &lt; ? php $x = '[(#TEXTE|texte_script)]'; ? &gt;
-function texte_script($texte) {
-	$texte = str_replace('\\', '\\\\', $texte);
-	$texte = str_replace('\'', '\\\'', $texte);
-	return $texte;
-}
-
-
 // Rend une chaine utilisable sans dommage comme attribut HTML
 function attribut_html($texte) {
 	$texte = ereg_replace('&quot;', '&quot;', supprimer_tags($texte));
@@ -209,17 +221,11 @@
 }
 
 // Vider les url nulles comme '<A HREF="http://">http://</A>' ou 'mailto:'
-// + hack pour rester en mode 'preview' dans l'espace public
 function vider_url($url) {
-	global  $var_preview;
 
 	$url = trim($url);
 	if (eregi(&quot;^(http:?/?/?|mailto:?)$&quot;, $url))
 		return '';
-	else
-		if (_DIR_RESTREINT AND $var_preview AND !eregi(&quot;[a-z]+://&quot;, $url))
-			$url .= ((strpos($url, '?') !== false) ? '&amp;':'?')
-			. &quot;var_preview=oui&quot;;
 
 	return $url;
 }
@@ -228,10 +234,10 @@
 // Ajouter le &amp;var_recherche=toto dans les boucles de recherche
 //
 function url_var_recherche($url) {
-	if ($GLOBALS['HTTP_GET_VARS']['recherche']
+	if (_request('recherche')
 	AND !ereg(&quot;var_recherche&quot;, $url)) {
 		$url .= strpos($url, '?') ? '&amp;' : '?';
-		$url .= &quot;var_recherche=&quot;.urlencode($GLOBALS['recherche']);
+		$url .= &quot;var_recherche=&quot;.urlencode(_request('recherche'));
 	}
 	return $url;
 }
@@ -261,7 +267,11 @@
 
 // |choixsivide{vide,pasvide} affiche pasvide si la chaine n'est pas vide...
 
-function choixsivide($a, $vide, $pasvide) {return $a ? $pasvide : $vide;}
+function choixsivide($a, $vide, $pasvide)
+{
+  spip_log(&quot;choix '$a'&quot; . $a ? $pasvide : $vide);
+  return $a ? $pasvide : $vide;
+}
 
 // |choixsiegal{aquoi,oui,non} affiche oui si la chaine est egal a aquoi ...
 function choixsiegal($a1,$a2,$v,$f) {return ($a1 == $a2) ? $v : $f;}
@@ -747,13 +757,17 @@
 		. (!$noscript ? '' : &quot;&lt;noscript&gt;\n\t$noscript\n&lt;/noscript&gt;\n&quot;);
 }
 
-function inscriptionok($site, $mode)
-{
-  return ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;) OR
-	  (($mode == 'forum') AND
-	   (lire_meta(&quot;accepter_visiteurs&quot;) == &quot;oui&quot;
-	    OR lire_meta('forums_publics') == 'abo'))) ? ($site . '/') : '';
-}
 
+// Un filtre ad hoc, qui retourne ce qu'il faut pour les tests de config
+// dans les squelettes : [(#URL_SITE_SPIP|tester_config{quoi})]
+function tester_config($ignore, $quoi) {
+	switch ($quoi) {
+		case 'mode_inscription':
+			return (lire_meta('accepter_inscriptions') == 'oui') ? 'redac' : '';
+		
+		default:
+			return '';
+	}
+}
 
 ?&gt;

Index: admin_effacer.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_effacer.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- admin_effacer.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ admin_effacer.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 

Index: inc_calendrier.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_calendrier.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_calendrier.php	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_calendrier.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,4 +1,16 @@
 &lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_CALENDRIER&quot;)) return;
@@ -12,13 +24,13 @@
 	spip_setcookie('spip_calendrier_echelle', floor($GLOBALS['set_echelle']), time() + 365 * 24 * 3600);
 	$GLOBALS['echelle'] = floor($GLOBALS['set_echelle']);
 } else 
-	$GLOBALS['echelle'] = $GLOBALS['HTTP_COOKIE_VARS']['spip_calendrier_echelle'];
+	$GLOBALS['echelle'] = $GLOBALS['_COOKIE']['spip_calendrier_echelle'];
 
 if ($GLOBALS['set_partie_cal']) {
 	spip_setcookie('spip_partie_cal', $GLOBALS['set_partie_cal'], time() + 365 * 24 * 3600);
 	$GLOBALS['partie_cal'] = $GLOBALS['set_partie_cal'];
 } else 
-	$GLOBALS['partie_cal'] = $GLOBALS['HTTP_COOKIE_VARS']['spip_partie_cal'];
+	$GLOBALS['partie_cal'] = $GLOBALS['_COOKIE']['spip_partie_cal'];
 
 
 # Typographie generale des calendriers de 3 type: jour/mois/annee
@@ -32,7 +44,8 @@
 $jaune= http_img_pack(&quot;m_envoi_jaune$spip_lang_rtl.gif&quot;, 'J', &quot;width='14' height='7' border='0'&quot;);
 
 // Conversion en HTML d'un tableau de champ ics
-// Le champ URL devient une balise a href=URL entourant les champs SUMMARY et DESC
+// Le champ URL devient une balise A 
+// 	avec href=URL et clic sur les champs SUMMARY et DESC
 // Le champ CATEGORIES indique les couleurs pour le style CSS
 
 function http_calendrier_ics($evenements, $amj = &quot;&quot;) 
@@ -131,7 +144,7 @@
 
 # affiche un mois en grand, avec des tableau de clics vers d'autres mois
 
-function http_calendrier_tout($mois, $annee, $premier_jour, $dernier_jour)
+function http_calendrier_init_mois($premier_jour, $mois, $annee, $date)
 {
 	global $spip_lang_left, $largeur_table, $largeur_gauche, $spip_ecran;
 
@@ -148,6 +161,7 @@
 		'http_calendrier_clics' : 
 		'http_calendrier_sans_clics';*/
 	$fclic = 'http_calendrier_clics';
+	$dernier_jour = 31;
 	while (!(checkdate($mois,$dernier_jour,$annee))) $dernier_jour--;
 	$today=getdate(time());
 	$m=$today[&quot;mon&quot;];
@@ -191,7 +205,8 @@
 function http_calendrier_aide_mess()
 {
   global $bleu, $vert, $jaune;
- return
+  if (_DIR_RESTREINT) return &quot;&quot;;
+  return
    &quot;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;\n&lt;table width='700'&gt;\n&lt;tr&gt;&lt;td&gt;&lt;font face='arial,helvetica,sans-serif' size='2'&gt;&quot; .
     &quot;&lt;b&gt;&quot;._T('info_aide').&quot;&lt;/b&gt;&quot; .
     &quot;&lt;br /&gt;$bleu &quot;._T('info_symbole_bleu').&quot;\n&quot; .
@@ -235,7 +250,7 @@
 		else $img_att = &quot;&quot;;
 		$retour .= &quot;&lt;span$img_att&gt;&quot;
 		  .http_href_img(($script . &quot;type=$type&amp;set_partie_cal=tout&amp;$args&quot;),
-				 &quot;heures-tout.png&quot;, &quot;width='13' height='13' class='format_png'&quot;,  _L('jour entier')) . &quot;&lt;/span&gt;&quot;;
+				 &quot;heures-tout.png&quot;, &quot;width='13' height='13' class='format_png'&quot;,  _T('cal_jour_entier')) . &quot;&lt;/span&gt;&quot;;
 
 		if ($GLOBALS['partie_cal'] == &quot;matin&quot;) $img_att = &quot; class='navigation-bouton-desactive'&quot;;
 		else $img_att = &quot;&quot;;
@@ -243,7 +258,7 @@
 		  .http_href_img(($script . &quot;type=$type&amp;set_partie_cal=matin&amp;$args&quot;),
 				 &quot;heures-am.png&quot;,
 				 &quot;width='13' height='13' class='format_png'&quot;,
-				 _L('matin'))
+				 _T('cal_matin'))
 		  . &quot;&lt;/span&gt;&quot;;
 
 		if ($GLOBALS['partie_cal'] == &quot;soir&quot;) $img_att = &quot; class='navigation-bouton-desactive'&quot;;
@@ -252,30 +267,30 @@
 		  .http_href_img(($script . &quot;type=$type&amp;set_partie_cal=soir&amp;$args&quot;),
 				 &quot;heures-pm.png&quot;, 
 				 &quot;width='13' height='13' class='format_png'&quot;,
-				 _L('apr&egrave;s-midi'))
+				 _T('cal_apresmidi'))
 		  . &quot;&lt;/span&gt;&quot;;
 		$retour .= &quot;&nbsp;&quot;;
 		$retour .= http_href_img(($script . &quot;type=$type&amp;set_echelle=&quot; .
 					  floor($echelle * 1.5) . &quot;&amp;$args&quot;),
 					 &quot;loupe-moins.gif&quot;,
 					 '',
-					 _L('zoom'). '-');
+					 _T('info_zoom'). '-');
 		$retour .= http_href_img(($script . &quot;type=$type&amp;set_echelle=&quot; .
 					  floor($echelle / 1.5) . &quot;&amp;$args&quot;), 
 					 &quot;loupe-plus.gif&quot;,
 					 '', 
-					 _L('zoom'). '+');
+					 _T('info_zoom'). '+');
  		$retour .= &quot;&nbsp;&quot;;
 
 
  	}
 
         $img_att = ($type == 'jour') ? &quot; class='navigation-bouton-desactive'&quot; : '';
-	$retour .= http_href_img(($script . &quot;type=jour&amp;echelle=$echelle&amp;$args&quot;),&quot;cal-jour.gif&quot;, $img_att, _L('calendrier par jour')) . &quot;&nbsp;&quot;;
+	$retour .= http_href_img(($script . &quot;type=jour&amp;echelle=$echelle&amp;$args&quot;),&quot;cal-jour.gif&quot;, $img_att, _T('cal_par_jour')) . &quot;&nbsp;&quot;;
 	$img_att = ($type == 'semaine') ?  &quot; class='navigation-bouton-desactive'&quot; : &quot;&quot; ;
-	$retour .= http_href_img($script . &quot;type=semaine&amp;echelle=$echelle&amp;$args&quot;, &quot;cal-semaine.gif&quot;, $img_att, _L('calendrier par semaine'))  . &quot;&nbsp;&quot;;;
+	$retour .= http_href_img($script . &quot;type=semaine&amp;echelle=$echelle&amp;$args&quot;, &quot;cal-semaine.gif&quot;, $img_att, _T('cal_par_semaine'))  . &quot;&nbsp;&quot;;;
 	$img_att = ($type == 'mois') ? &quot; class='navigation-bouton-desactive'&quot; : &quot;&quot; ;
-	$retour .= http_href_img($script . &quot;type=mois&amp;echelle=$echelle&amp;$args&quot;,&quot;cal-mois.gif&quot;, $img_att, _L('calendrier par mois'));
+	$retour .= http_href_img($script . &quot;type=mois&amp;echelle=$echelle&amp;$args&quot;,&quot;cal-mois.gif&quot;, $img_att, _T('cal_par_mois'));
 	
   	$retour .= &quot;&nbsp;&nbsp;&quot;;
 
@@ -299,11 +314,11 @@
 	if ($args_pred)
 		$retour .= http_href($script . &quot;type=$type&amp;echelle=$echelle&amp;$args_pred$ancre&quot;,
 				     http_img_pack(&quot;fleche-$spip_lang_left.png&quot;, '&lt;&lt;&lt;', &quot;class='format_png'  width='12' height='12'&quot;),
-				     _L('pr&eacute;c&eacute;dent'));
+				     _T('precedent'));
 	if ($args_suiv)
 		$retour .= http_href(($script . &quot;type=$type&amp;echelle=$echelle&amp;$args_suiv$ancre&quot;),
 				     http_img_pack(&quot;fleche-$spip_lang_right.png&quot;,  '&gt;&gt;&gt;', &quot;class='format_png' width='12' height='12'&quot;),
-				     _L('suivant'));
+				     _T('suivant'));
   	$retour .= &quot;&nbsp;&nbsp;&quot;;
  	$retour .= &quot;&lt;span style='font-weight: bold'&gt;$nom&lt;/span&gt;&quot;;
 	return $retour .
@@ -319,7 +334,10 @@
 {
 	global $spip_lang_right, $spip_lang_left, $couleur_claire;
 
-	$gadget = &quot;&lt;div id='$id' onmouseover=\&quot;montrer('$id');\&quot; onmouseout=\&quot;cacher('$id');\&quot; style='position: relative; visibility: hidden;z-index: 1000; '&gt;&lt;div style='position: absolute; padding: 5px; background-color: $couleur_claire; margin-bottom: 5px; -moz-border-radius-bottomleft: 8px; -moz-border-radius-bottomright: 8px;'&gt;&quot;;
+	$gadget = &quot;&lt;div
+id='$id' style='position: relative; visibility: hidden;z-index: 1000; '
+onmouseover=\&quot;montrer('$id');\&quot; onmouseout=\&quot;cacher('$id');\&quot;&gt;&lt;div 
+style='position: absolute; padding: 5px; background-color: $couleur_claire; margin-bottom: 5px; -moz-border-radius-bottomleft: 8px; -moz-border-radius-bottomright: 8px;'&gt;&quot;;
 			//$gadget .= &quot;&lt;a href='calendrier_semaine.php3' class='lien_sous'&gt;&quot;;
 			//$gadget .= _T('icone_agenda');
 			//$gadget .= &quot;&lt;/a&gt;&quot;;
@@ -330,7 +348,7 @@
 			
 
 	$gadget .= &quot;&lt;table cellpadding='0' cellspacing='5' border='0' width='100%'&gt;&quot;;
-	$gadget .= &quot;&lt;tr&gt;&lt;td colspan='3' style='text-align:$spip_lang_left;'&gt;&quot;;
+	$gadget .= &quot;\n&lt;tr&gt;&lt;td colspan='3' style='text-align:$spip_lang_left;'&gt;&quot;;
 
 	$annee_avant = $annee - 1;
 	$annee_apres = $annee + 1;
@@ -344,12 +362,11 @@
 					nom_mois(&quot;$annee-$i-1&quot;),'','', 'calendrier-annee');
 			}
 	$gadget .= &quot;&lt;/td&gt;&lt;/tr&gt;&quot;
-		. &quot;\n&lt;tr&gt;&quot;
-		. &quot;&lt;td valign='top' width='33%'&gt;&quot;
+		. &quot;\n&lt;tr&gt;&lt;td valign='top' width='33%'&gt;&quot;
 		. http_calendrier_agenda($mois-1, $annee, $jour, $mois, $annee, $GLOBALS['afficher_bandeau_calendrier_semaine'], $script,$ancre) 
-		. &quot;&lt;/td&gt;&lt;td valign='top' width='33%'&gt;&quot;
+		. &quot;&lt;/td&gt;\n&lt;td valign='top' width='33%'&gt;&quot;
 		. http_calendrier_agenda($mois, $annee, $jour, $mois, $annee, $GLOBALS['afficher_bandeau_calendrier_semaine'], $script,$ancre) 
-		. &quot;&lt;/td&gt;&lt;td valign='top' width='33%'&gt;&quot;
+		. &quot;&lt;/td&gt;\n&lt;td valign='top' width='33%'&gt;&quot;
 		. http_calendrier_agenda($mois+1, $annee, $jour, $mois, $annee, $GLOBALS['afficher_bandeau_calendrier_semaine'], $script,$ancre) 
 		. &quot;&lt;/td&gt;&quot;
 		. &quot;&lt;/tr&gt;&quot;
@@ -594,8 +611,9 @@
   $href = &quot;message_edit.php3?rv=$annee-$mois-$jour&amp;new=oui&quot;;
 
   return &quot;\n&quot; .
-    http_href(&quot;calendrier_jour.php3?jour=$jour&amp;mois=$mois&amp;annee=$annee&quot;, $clic) .
+    http_href(&quot;calendrier.php3?type=jour&amp;jour=$jour&amp;mois=$mois&amp;annee=$annee&quot;, $clic) .
     &quot;\n&quot; .
+    (_DIR_RESTREINT ? '' : (
     http_href(&quot;$href&amp;type=pb&quot;, 
 		 $bleu, 
 		 _T(&quot;lien_nouvea_pense_bete&quot;),
@@ -604,13 +622,13 @@
     http_href(&quot;$href&amp;type=normal&quot;,
 		 $vert,
 		 _T(&quot;lien_nouveau_message&quot;),
-		 'color: green; font-family: Arial, Sans, sans-serif; font-size: 10px; ') .
+	      'color: green; font-family: Arial, Sans, sans-serif; font-size: 10px; '))) .
     (($GLOBALS['connect_statut'] != &quot;0minirezo&quot;) ? &quot;&quot; :
      (&quot;\n&quot; .
       http_href(&quot;$href&amp;type=affich&quot;,
 		   $jaune,
 		   _T(&quot;lien_nouvelle_annonce&quot;),
-		   'color: #ff9900; font-family: Arial, Sans, sans-serif; font-size: 10px; ')));
+		'color: #ff9900; font-family: Arial, Sans, sans-serif; font-size: 10px; ')));
 }
 
 # dispose les evenements d'une semaine
@@ -729,18 +747,31 @@
 		       '',
 		       'color: black;') .
     &quot;&lt;table width='100%' cellspacing='0' cellpadding='0'&gt;&quot; .
-    http_calendrier_agenda_rv ($mois, $annee, $jour_ved, $mois_ved, $annee_ved, 
-			       $semaine, 
-			       sql_calendrier_agenda($mois, $annee),
-			       $script,
-			       $ancre) .
+    http_calendrier_agenda_rv ($annee, $mois, 
+				sql_calendrier_agenda($mois, $annee),
+			        'http_jour_clic', array($script, $ancre),
+			        $jour_ved, $mois_ved, $annee_ved, 
+				$semaine) .
     &quot;&lt;/table&gt;&quot; .
     &quot;&lt;/div&gt;&quot;;
 }
 
+function http_jour_clic($annee, $mois, $jour, $type, $couleur, $perso)
+{
+
+  list($script, $ancre) = $perso;
+
+  return http_href($script . &quot;type=$type&amp;jour=$jour&amp;mois=$mois&amp;annee=$annee$ancre&quot;, 
+		   &quot;&lt;b&gt;$jour&lt;/b&gt;&quot;,
+		   '',
+		   &quot;color: $couleur&quot;);
+}
+
 // typographie un mois sous forme d'un tableau de 7 colonnes
 
-function http_calendrier_agenda_rv ($mois, $annee, $jour_ved, $mois_ved, $annee_ved, $semaine, $les_rv, $script, $ancre='') {
+function http_calendrier_agenda_rv ($annee, $mois, $les_rv, $fclic, $perso='',
+				    $jour_ved='', $mois_ved='', $annee_ved='',
+				    $semaine='') {
 	global $couleur_foncee;
 	global $spip_lang_left, $spip_lang_right;
 
@@ -756,7 +787,6 @@
 		$debut = mktime(1,1,1,$mois_ved,$jour_ved-$jour_semaine_valide+1,$annee_ved);
 		$fin = mktime(1,1,1,$mois_ved,$jour_ved-$jour_semaine_valide+7,$annee_ved);
 	} else { $debut = $fin = '';}
-		  
 	
 	$today=getdate(time());
 	$jour_today = $today[&quot;mday&quot;];
@@ -778,10 +808,7 @@
 		if (checkdate($mois,$j,$annee)){
 		  if ($j == $jour_ved AND $mois == $mois_ved AND $annee == $annee_ved) {
 		    $ligne .= &quot;\n\t&lt;td class='arial2' style='margin: 1px; padding: 2px; background-color: white; border: 1px solid $couleur_foncee; text-align: center; -moz-border-radius: 5px;'&gt;&quot; .
-		      http_href($script . &quot;type=jour&amp;jour=$j&amp;mois=$mois&amp;annee=$annee$ancre&quot;, 
-				&quot;&lt;b&gt;$j&lt;/b&gt;&quot;,
-				'',
-				&quot;color: black&quot;) .
+		      $fclic($annee,$mois, $j,&quot;jour&quot;,&quot;black&quot;, $perso) .
 		      &quot;&lt;/td&gt;&quot;;
 		  } else if ($semaine AND $nom &gt;= $debut AND $nom &lt;= $fin) {
 		    $ligne .= &quot;\n\t&lt;td class='arial2' style='margin: 0px; padding: 3px; background-color: white; text-align: center; &quot; .
@@ -790,10 +817,7 @@
 		       (($jour_semaine==7) ?
 			$style7 : '')) .
 		      &quot;'&gt;&quot; .
-		      http_href($script . &quot;type=&quot; . ($semaine ? 'semaine' : 'jour') . &quot;&amp;jour=$j&amp;mois=$mois&amp;annee=$annee$ancre&quot;, 
-				&quot;&lt;b&gt;$j&lt;/b&gt;&quot;,
-				'',
-				&quot;color: black&quot;) .
+		      $fclic($annee,$mois, $j,($semaine ? 'semaine' : 'jour'),&quot;black&quot;, $perso) .
 		      &quot;&lt;/td&gt;&quot;;
 		  } else {
 		    if ($j == $jour_today AND $mois == $mois_today AND $annee == $annee_today) {
@@ -812,10 +836,7 @@
 			}
 		    }
 		    $ligne .= &quot;\n\t&lt;td&gt;&lt;div class='arial2' style='margin-left: 1px; margin-top: 1px; padding: 2px; background-color: $couleur_fond; text-align: center; -moz-border-radius: 5px;'&gt;&quot; .
-		      http_href($script . &quot;type=&quot; . ($semaine ? 'semaine' : 'jour') . &quot;&amp;jour=$j&amp;mois=$mois&amp;annee=$annee$ancre&quot;, 
-				&quot;&lt;b&gt;$j&lt;/b&gt;&quot;,
-				'',
-				&quot;color: $couleur&quot;) .
+		      $fclic($annee,$mois, $j,($semaine ? 'semaine' : 'jour'),$couleur, $perso) .
 		      &quot;&lt;/div&gt;&lt;/td&gt;&quot;;
 		  }
 		  if ($jour_semaine==7) 
@@ -1079,7 +1100,7 @@
 }
 
 
-function http_calendrier_journee($jour_today,$mois_today,$annee_today, $date){
+function http_calendrier_init_jour($jour_today,$mois_today,$annee_today, $date){
 	global $largeur_table, $largeur_gauche, $spip_ecran;
 	$jour = journum($date);
 	$mois = mois($date);
@@ -1094,7 +1115,7 @@
 		$largeur_centre = $largeur_table - ($largeur_gauche + 20);
 	}
 		
-	$retour = &quot;&lt;table cellpadding=0 cellspacing=0 border=0 width='$largeur_table'&gt;&lt;tr&gt;&quot;;
+	$retour = &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&lt;table cellpadding=0 cellspacing=0 border=0 width='$largeur_table'&gt;&lt;tr&gt;&quot;;
 	
 	if ($spip_ecran == &quot;large&quot;) {
 		$retour .= &quot;&lt;td width='$largeur_gauche' class='verdana1' valign='top'&gt;&quot; .
@@ -1121,7 +1142,7 @@
 	return $retour;
 }
 
-function http_calendrier_semaine($jour_today,$mois_today,$annee_today)
+function http_calendrier_init_semaine($jour_today,$mois_today,$annee_today,$date)
 {
 	global $spip_ecran, $spip_lang_left, $couleur_claire;	
 	
@@ -1203,7 +1224,7 @@
 
 	if ($large == &quot;col&quot; ) {
 	  $entete = &quot;&lt;div align='center' style='padding: 5px;'&gt;&lt;b class='verdana1'&gt;&quot; .
-	    http_href(&quot;calendrier_jour.php3?jour=$jour&amp;mois=$mois&amp;annee=$annee&quot;,
+	    http_href(&quot;calendrier.php3?type=jour&amp;jour=$jour&amp;mois=$mois&amp;annee=$annee&quot;,
 				 affdate_jourcourt(&quot;$annee-$mois-$jour&quot;),
 				 '',
 				 'color:black;') .
@@ -1434,11 +1455,13 @@
  AND	date &lt; $apres
 ORDER BY date
 &quot;);
+	$script = (_DIR_RESTREINT ? 'article' : 'articles');
 	while($row=spip_fetch_array($result)){
 		$amj = sql_calendrier_jour_ical($row['date']);
 		$evenements[$amj][]=
 		array(
-			'URL' =&gt; &quot;articles.php3?id_article=&quot; . $row['id_article'],
+			'URL' =&gt; $script . _EXTENSION_PHP . &quot;?id_article=&quot; .
+ $row['id_article'],
 			'CATEGORIES' =&gt; 'a',
 			'DESCRIPTION' =&gt; $row['titre']);
 	}
@@ -1457,9 +1480,10 @@
 &quot;);
 	while($row=spip_fetch_array($result)){
 		$amj = sql_calendrier_jour_ical($row['date_heure']);
+		$script = (_DIR_RESTREINT ? 'breve' : 'breves_voir');
 		$evenements[$amj][]=
 		array(
-			'URL' =&gt; &quot;breves_voir.php3?id_breve=&quot; . $row['id_breve'],
+			'URL' =&gt; $script . _EXTENSION_PHP . &quot;?id_breve=&quot; . $row['id_breve'],
 			'CATEGORIES' =&gt; 'b',
 			'DESCRIPTION' =&gt; $row['titre']);
 	}
@@ -1469,6 +1493,7 @@
 function sql_calendrier_interval_rv($avant, $apres) {
 	global $connect_id_auteur;
 	$evenements= array();
+	if (!$connect_id_auteur) return $evenements;
 	$result=spip_query(&quot;
 SELECT	messages.id_message, messages.titre, messages.texte,
 	messages.date_heure, messages.date_fin, messages.type
@@ -1551,7 +1576,9 @@
 
 
 function sql_calendrier_taches_annonces () {
+	global $connect_id_auteur;
 	$r = array();
+	if (!$connect_id_auteur) return $r;
 	$result = spip_query(&quot;
 SELECT * FROM spip_messages 
 WHERE type = 'affich' AND rv != 'oui' AND statut = 'publie' ORDER BY date_heure DESC&quot;);
@@ -1563,6 +1590,7 @@
 function sql_calendrier_taches_pb () {
 	global $connect_id_auteur;
 	$r = array();
+	if (!$connect_id_auteur) return $r;
 	$result = spip_query(&quot;
 SELECT * FROM spip_messages AS messages 
 WHERE id_auteur=$connect_id_auteur AND statut='publie' AND type='pb' AND rv!='oui'&quot;);
@@ -1576,6 +1604,7 @@
 function sql_calendrier_taches_rv () {
 	global $connect_id_auteur;
 	$r = array();
+	if (!$connect_id_auteur) return $r;
 	$result = spip_query(&quot;
 SELECT messages.* 
 FROM spip_messages AS messages, spip_auteurs_messages AS lien 
@@ -1599,13 +1628,14 @@
 function sql_calendrier_agenda ($mois, $annee) {
 	global $connect_id_auteur;
 
+	$rv = array();
+	if (!$connect_id_auteur) return $rv;
 	$date = date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois, 1, $annee));
 	$mois = mois($date);
 	$annee = annee($date);
 
 	// rendez-vous personnels dans le mois
 	$result_messages=spip_query(&quot;SELECT messages.date_heure FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.date_heure &gt;='$annee-$mois-1' AND date_heure &lt; DATE_ADD('$annee-$mois-1', INTERVAL 1 MONTH) AND messages.statut='publie'&quot;);
-	$rv = array();
 	while($row=spip_fetch_array($result_messages)){
 		$rv[journum($row['date_heure'])] = 1;
 	}

Index: inc_abstract_sql.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_abstract_sql.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_abstract_sql.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_abstract_sql.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_INC_ABSTRACT_SQL&quot;)) return;
 define(&quot;_INC_ABSTRACT_SQL&quot;, &quot;1&quot;);
@@ -54,7 +65,7 @@
 	if (function_exists($f))
 		return $f;
 
-	erreur_squelette(_L(' serveur SQL indefini'), $serveur);
+	erreur_squelette(' '._T('zbug_serveur_indefini'), $serveur);
 
 	// hack pour continuer la chasse aux erreurs
 	return 'array';
@@ -86,7 +97,7 @@
 
 function spip_abstract_insert($table, $noms, $valeurs, $serveur='')
 {
-  $f = (!$serveur ? 'spip_insert' :
+  $f = (!$serveur ? 'spip_mysql_insert' :
 	spip_abstract_serveur('spip_' . $serveur . '_insert', $serveur));
   return $f($table, $noms, $valeurs);
 }

Index: inc_base.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_base.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_base.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_base.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_BASE&quot;)) return;
@@ -19,7 +30,6 @@
 
 function spip_create_table($nom, $champs, $cles, $autoinc=false) {
 	$query = ''; $keys = ''; $s = '';
-	$nom = 'spip_' . $nom;
 
 	foreach($cles as $k =&gt; $v) {
 		$keys .= &quot;$s\n\t\t$k ($v)&quot;;
@@ -123,7 +133,7 @@
 		&quot;('xls', 'Excel', 'non'), &quot;.
 		&quot;('xml', 'XML', 'non'), &quot;.
 		&quot;('zip', 'Zip', 'non')&quot;;
-	spip_query($query);
+	spip_query_db($query);
 }
 
 function stripslashes_base($table, $champs) {

Index: lab_revisions.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lab_revisions.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- lab_revisions.php	13 Jan 2005 15:37:15 -0000	1.1
+++ lab_revisions.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_REVISIONS&quot;)) return;

Index: inc_statistiques.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_statistiques.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_statistiques.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_statistiques.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_STATISTIQUES&quot;)) return;
 define(&quot;_ECRIRE_INC_STATISTIQUES&quot;, &quot;1&quot;);
@@ -101,8 +112,7 @@
 				$keywords = &quot;&quot;;
 			}
 						
-			if ((($kw_referer_host == &quot;Google&quot; &amp;&amp;
-				ereg('[io]e=([-a-z0-9]+)', strtolower($query), $regs))
+			if ((  ($kw_referer_host == &quot;Google&quot;)
 				|| ($kw_referer_host == &quot;AOL&quot; &amp;&amp; !ereg('enc=iso', $query))
 				|| ($kw_referer_host == &quot;MSN&quot;)
 				)) {

Index: config-multilang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-multilang.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- config-multilang.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ config-multilang.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_config.php3&quot;);
@@ -104,6 +115,7 @@
 		echo _T('info_multi_langues_choisies');
 		echo '&lt;/p&gt;';
 
+		init_codes_langues();
 		$langues = $GLOBALS['codes_langues'];
 		$cesure = floor((count($langues) + 1) / 2);
 

Index: inc_charsets.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_charsets.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_charsets.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_charsets.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_CHARSETS&quot;)) return;
@@ -2054,11 +2065,7 @@
 		}
 	}
 
-	if ($GLOBALS['flag_strtr2']) return strtr($texte, $trans);
-
-	foreach($trans as $from =&gt; $to)
-		$texte = str_replace($from, $to, $texte);
-	return $texte;
+	return strtr($texte, $trans);
 }
 
 //
@@ -2074,13 +2081,7 @@
 			$trans[&quot;&amp;$key;&quot;] = $val;
 	}
 
-	if ($GLOBALS['flag_strtr2']) return strtr($texte, $trans);
-
-	reset($trans);
-	foreach ($trans as $from =&gt; $to)
-		$texte = str_replace($from, $to, $texte);
-
-	return $texte;
+	return strtr($texte, $trans);
 }
 
 
@@ -2141,15 +2142,10 @@
 				$trans[$charset][chr($key)] = '&amp;#'.$val.';';
 			}
 		}
-		if ($trans[$charset]) {
-			if ($GLOBALS['flag_strtr2'])
-				$texte = strtr($texte, $trans[$charset]);
-			else {
-				reset($trans[$charset]);
-				foreach ($trans[$charset] as $from =&gt; $to)
-					$texte = str_replace($from, $to, $texte);
-			}
-		}
+
+		if ($trans[$charset])
+			$texte = strtr($texte, $trans[$charset]);
+
 		return $texte;
 	}
 }
@@ -2391,13 +2387,8 @@
 		foreach ($CHARSET[$table_translit] as $key =&gt; $val)
 			$trans[$complexe][caractere_utf_8($key)] = $val;
 	}
-	if ($GLOBALS['flag_strtr2'])
-		$texte = strtr($texte, $trans[$complexe]);
-	else {
-		$tr = $trans[$complexe];
-		foreach ($tr as $from =&gt; $to)
-			$texte = str_replace($from, $to, $texte);
-	}
+
+	$texte = strtr($texte, $trans[$complexe]);
 
 /*
 	// Le probleme d'iconv c'est qu'il risque de nous renvoyer des ? alors qu'on

Index: articles_versions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_versions.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles_versions.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ articles_versions.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include(&quot;inc_lab.php&quot;);
 
 include_spip(&quot;ecrire.php&quot;);

Index: inc_forum.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_forum.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_forum.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_forum.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_FORUM&quot;)) return;

Index: inc_getdocument.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_getdocument.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_getdocument.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_getdocument.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,23 +1,54 @@
 &lt;?php
 
-function creer_repertoire_documents($ext) {
-	global $dossier_squelettes;
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
 
-# est-il bien raisonnable d'accepter de creer si creer_rep retourne '' ?
+
+//
+// Fonctions de spip_image.php3
+
+//
+// Ce fichier ne sera execute qu'une fois
+if (defined(&quot;_ECRIRE_INC_GETDOCUMENT&quot;)) return;
+define(&quot;_ECRIRE_INC_GETDOCUMENT&quot;, &quot;1&quot;);
+
+
+// Creer IMG/pdf/
+function creer_repertoire_documents($ext) {
 	$rep = _DIR_DOC . creer_repertoire(_DIR_DOC, $ext);
-	// Securite
-	if (!$ext || ($rep == $dossier_squelettes) || (substr($rep,0,-1) == $dossier_squelettes))
-		{
-		  spip_log(&quot;creer_repertoire_documents interdit&quot;);
-		  exit;
-		}
+
+	if (!$ext OR !$rep) {
+		spip_log(&quot;creer_repertoire_documents interdit&quot;);
+		exit;
+	}
+
 	if (lire_meta(&quot;creer_htaccess&quot;) == 'oui') {
 		include_ecrire('inc_acces.php3');
 		verifier_htaccess($rep);
 	}
+
 	return $rep;
 }
 
+// Efface le repertoire de maniere recursive !
+function effacer_repertoire_temporaire($nom) {
+	$d = opendir($nom);
+	while ($f = readdir($d)) {
+		if (is_file(&quot;$nom/$f&quot;))
+			@unlink(&quot;$nom/$f&quot;);
+		else if ($f &lt;&gt; '.' AND $f &lt;&gt; '..'
+		AND is_dir(&quot;$nom/$f&quot;))
+			effacer_repertoire_temporaire(&quot;$nom/$f&quot;);
+	}
+	@rmdir($nom);
+}
 
 function copier_document($ext, $orig, $source) {
 
@@ -27,18 +58,88 @@
 			translitteration(ereg_replace(&quot;\.([^.]+)$&quot;, &quot;&quot;, 
 						      ereg_replace(&quot;&lt;[^&gt;]*&gt;&quot;, '', basename($orig)))));
 
-	# bien vu ?
-	if ($source == ($dest . '.' . $ext)) return $source;
+	// Si le document &quot;source&quot; est deja au bon endroit, ne rien faire
+	if ($source == ($dest . '.' . $ext))
+		return $source;
+
+	// sinon tourner jusqu'a trouver un numero correct
 	$n = 0;
 	while (@file_exists($newFile = $dest.($n++ ? '-'.$n : '').'.'.$ext));
-	$r = deplacer_fichier_upload($source, $newFile);
-	return (!$r ? '' : $newFile);
+
+	$newFile = preg_replace('/[.]+/', '.', $newFile);
+
+	if ($r = deplacer_fichier_upload($source, $newFile))
+		return $newFile;
 }
 
-function verifier_compactes($image_name) {
+//
+// Deplacer un fichier
+//
 
-	$zip = new PclZip($image_name);
+function deplacer_fichier_upload($source, $dest) {
+	// Securite
+	if (strstr($dest, &quot;..&quot;)) { exit; }
 
+	$ok = @copy($source, $dest);
+	if (!$ok) $ok = @move_uploaded_file($source, $dest);
+	if ($ok)
+		@chmod($dest, 0666);
+	else {
+		$f = @fopen($dest,'w');
+		if ($f) {
+			fclose ($f);
+		} else {
+			redirige_par_entete(&quot;spip_test_dirs.php3?test_dir=&quot;.
+				dirname($dest));
+		}
+		@unlink($dest);
+	}
+
+	return $ok;
+}
+
+
+// Erreurs d'upload
+// renvoie false si pas d'erreur
+// et true si erreur = pas de fichier
+// pour les autres erreurs affiche le message d'erreur et meurt
+function check_upload_error($error, $msg='') {
+	switch ($error) {
+		case 0:
+			return false;
+		case 4: /* UPLOAD_ERR_NO_FILE */
+			return true;
+
+		# on peut affiner les differents messages d'erreur
+		case 1: /* UPLOAD_ERR_INI_SIZE */
+			$msg = _T('upload_limit',
+			array('max' =&gt; ini_get('upload_max_filesize')));
+			break;
+		case 2: /* UPLOAD_ERR_FORM_SIZE */
+			$msg = _T('upload_limit',
+			array('max' =&gt; ini_get('upload_max_filesize')));
+			break;
+		case 3: /* UPLOAD_ERR_PARTIAL  */
+			$msg = _T('upload_limit',
+			array('max' =&gt; ini_get('upload_max_filesize')));
+			break;
+	}
+
+	spip_log (&quot;erreur upload $error&quot;);
+
+	include_ecrire('inc_presentation.php3');
+	install_debut_html(_T('forum_titre_erreur'));
+	echo &quot;&lt;p&gt;$msg&lt;/p&gt;\n&quot;;
+
+	install_fin_html(_DIR_RESTREINT_ABS . $GLOBALS['redirect']);
+	exit;
+}
+
+
+//
+// Gestion des fichiers ZIP
+//
+function verifier_compactes($zip) {
 	if ($list = $zip-&gt;listContent()) {
 	// si pas possible de decompacter: installer comme fichier zip joint
 	// Verifier si le contenu peut etre uploade (verif extension)
@@ -48,7 +149,7 @@
 			
 				if ($key == &quot;stored_filename&quot;) {
 					$f =  $list[$i][$key];
-					  // Regexp des fichiers a ignorer
+					// Regexp des fichiers a ignorer
 					if (!ereg(&quot;^(\.|.*/\.|.*__MACOSX/)&quot;, $f)) {
 						if (ereg(&quot;\.([^.]+)$&quot;, $f, $match)) {
 							$result = spip_query(&quot;SELECT * FROM spip_types_documents WHERE extension='&quot;
@@ -69,7 +170,7 @@
 	return $aff_fichiers ;
 }
 
-function afficher_compactes($image_name, $fichiers, $link) {
+function afficher_compactes($image_name /* not used */, $fichiers, $link) {
 // presenter une interface pour choisir si fichier joint ou decompacter
 // passer ca en squelette un de ces jours.
 
@@ -82,7 +183,6 @@
 		_T('upload_fichier_zip_texte2'),
 		&quot;&lt;/p&gt;&quot;,
 		$link-&gt;getForm('POST'),
-		_L(''),
 		&quot;&lt;div&gt;&lt;input type='radio' checked name='action_zip' value='telquel'&gt;&quot;,
 		_T('upload_zip_telquel'),
 		&quot;&lt;/div&gt;&quot;,
@@ -100,156 +200,538 @@
 	install_fin_html();
 }
 
+
 //
-// Ajouter un unique document
+// Ajouter un document (au format $_FILES)
 //
-
-function ajout_doc($orig, $source, $mode, $id_document) {
-	global $hash_id_auteur, $hash, $id_article, $type;
-	//
-	// Securite
-	//
-	if (!verifier_action_auteur(&quot;ajout_doc&quot;, $hash, $hash_id_auteur))
-		return;
+function ajouter_un_document ($source, $nom_envoye, $type_lien, $id_lien, $mode, $id_document, &amp;$documents_actifs) {
 
 	// type de document inconnu ?
+	if (!ereg(&quot;\.([^.]+)$&quot;, $nom_envoye, $match)) {
+		spip_log(&quot;nom envoye incorrect ($nom_envoye)&quot;);
+		return;
+	}
 
-	if (!ereg(&quot;\.([^.]+)$&quot;, $orig, $match)) return;
-
+	// tester le type de document :
+	// - interdit a l'upload ?
+	// - quel numero dans spip_types_documents ?  =-(
+	// - est-ce &quot;inclus&quot; comme une image ?
 	$ext = corriger_extension(addslashes(strtolower($match[1])));
-	$row = spip_query(&quot;SELECT * FROM spip_types_documents WHERE extension='$ext' AND upload='oui'&quot; . (($mode != 'vignette') ? '' : &quot; AND inclus='image'&quot;));
-
-	// type de document invalide ?
-
-	if (!$row = spip_fetch_array($row)) {return;}
 
-	// Recopier le fichier sauf si deja fait (zip tel quel)
+	if (!$row = spip_fetch_array(spip_query(
+	&quot;SELECT * FROM spip_types_documents
+	WHERE extension='$ext' AND upload='oui'&quot;))) {
+		spip_log(&quot;Extension $ext interdite a l'upload&quot;);
+		return;
+	}
+	$id_type = $row['id_type'];	# numero du type dans spip_types_documents :(
+	$type_inclus_image = ($row['inclus'] == 'image');
 
-	$dest_path = !$source ? $orig : copier_document($ext,$orig, $source);
+	// Recopier le fichier a son emplacement definitif
+	$definitif = copier_document($ext, $nom_envoye, $source);
+	if (!$definitif)
+		return;
 
-	if (!$dest_path) return;
+	// Quelques infos sur le fichier
+	if (!@file_exists($definitif)
+	OR !$taille = @filesize($definitif))
+		return;
 
-	// Preparation
-	if ($mode == 'vignette') {
-		$id_document_lie = $id_document;
-		$query = &quot;UPDATE spip_documents SET mode='document' where id_document='$id_document_lie'&quot;;
-		spip_query($query); // requete inutile a mon avis (Fil)...
-		$id_document = 0;
-	}
-	if (!$id_document) {
-		$id_type = $row['id_type'];
-		$id_document = spip_abstract_insert(&quot;documents&quot;, &quot;(id_type, titre, date)&quot;, &quot;($id_type, '', NOW())&quot;);
-		$nouveau = true;
-		if ($id_article &amp;&amp; isset($type)) {
-			$query = &quot;INSERT INTO spip_documents_&quot;.$type.&quot;s (id_document, id_&quot;.$type.&quot;) VALUES ($id_document, $id_article)&quot;;
-			spip_query($query);
-		}
-	}
-	//
-	// Mettre a jour les infos du document uploade
-	//
-	$size_image = @getimagesize($dest_path);
+	// Est-ce une image ?
+	$size_image = @getimagesize($definitif);
 	$type_image = decoder_type_image($size_image[2]);
 	if ($type_image) {
 		$largeur = $size_image[0];
 		$hauteur = $size_image[1];
 	}
-	$taille = filesize($dest_path);
-	if ($nouveau) {
-		$type_inclus = $row['inclus'];
-		if (!$mode) $mode = ($type_image AND $type_inclus == 'image') ? 'vignette' : 'document';
+
+	// Si on veut uploader une vignette, il faut qu'elle ait ete bien lue
+	if ($mode == 'vignette' AND !($largeur * $hauteur)) {
+		@unlink($definitif);
+		return;
+	}
+
+	// regler l'ancre du retour
+	if (!$GLOBALS['ancre']) {
+		if ($mode=='vignette')
+			$GLOBALS['ancre'] = 'images';
+		else if ($type_image)
+			$GLOBALS['ancre'] = 'portfolio';
+		else
+			$GLOBALS['ancre'] = 'documents';
+	}
+
+	// Preparation vignette du document $id_document
+	$id_document=intval($id_document);
+	if ($mode == 'vignette' AND $id_document_lie = $id_document) {
+		# on force le statut &quot;document&quot; de ce fichier (inutile ?)
+		spip_query(&quot;UPDATE spip_documents
+			SET mode='document'
+			WHERE id_document=$id_document&quot;);
+		$id_document = 0;
+	}
+
+	// Installer le document dans la base
+	// attention piege semantique : les images s'installent en mode 'vignette'
+	// note : la fonction peut &quot;mettre a jour un document&quot; si on lui
+	// passe &quot;mode=document&quot; et &quot;id_document=..&quot; (pas utilise)
+	if (!$id_document) {
+		// Inserer le nouveau doc et recuperer son id_
+		$id_document = spip_abstract_insert(&quot;spip_documents&quot;,
+		&quot;(id_type, titre, date)&quot;, &quot;($id_type, '', NOW())&quot;);
+
+		if ($id_lien
+		AND preg_match('/^[a-z0-9_]+$/i', $type_lien) # securite
+		)
+			spip_query(&quot;INSERT INTO spip_documents_&quot;.$type_lien.&quot;s
+				(id_document, id_&quot;.$type_lien.&quot;)
+				VALUES ($id_document, $id_lien)&quot;);
+
+		// par defaut (upload ZIP ou ftp) integrer
+		// les images en mode 'vignette' et le reste en mode document
+		if (!$mode)
+			if ($type_image AND $type_inclus_image)
+				$mode = 'vignette';
+			else
+				$mode = 'document';
 			$update = &quot;mode='$mode', &quot;;
 	}
 
-	spip_query(&quot;UPDATE spip_documents SET $update taille='$taille', largeur='$largeur', hauteur='$hauteur', fichier='$dest_path' WHERE id_document=$id_document&quot;);
+	// Mise a jour des donnees
+	spip_query(&quot;UPDATE spip_documents
+		SET $update
+		taille='$taille', largeur='$largeur', hauteur='$hauteur',
+		fichier='$definitif'
+		WHERE id_document=$id_document&quot;);
 
 	if ($id_document_lie) {
-		$query = &quot;UPDATE spip_documents SET id_vignette=$id_document WHERE id_document=$id_document_lie&quot;;
-		spip_query($query);
-		$id_document = $id_document_lie; // pour que le 'return' active le bon doc.
+		spip_query (&quot;UPDATE spip_documents
+		SET id_vignette=$id_document
+		WHERE id_document=$id_document_lie&quot;);
+		// hack pour que le retour vers ecrire/ active le bon doc.
+		$documents_actifs[] = $id_document_lie; 
 	}
+	else
+		$documents_actifs[] = $id_document; 
 
-	// Creer la vignette
-	if ($mode == 'document' AND ereg(&quot;,$ext,&quot;, ','.lire_meta('formats_graphiques').',')) {
-		creer_fichier_vignette($dest_path);
+	// Creer la vignette des images
+	if ($mode == 'document'
+	AND ereg(&quot;,$ext,&quot;, ','.lire_meta('formats_graphiques').',')
+	AND $type_image)
+		creer_fichier_vignette($definitif);
+
+	return true;
+}
+
+
+
+
+//
+// Convertit le type numerique retourne par getimagesize() en extension fichier
+//
+
+function decoder_type_image($type, $strict = false) {
+	switch ($type) {
+	case 1:
+		return &quot;gif&quot;;
+	case 2:
+		return &quot;jpg&quot;;
+	case 3:
+		return &quot;png&quot;;
+	case 4:
+		return $strict ? &quot;&quot; : &quot;swf&quot;;
+	case 5:
+		return &quot;psd&quot;;
+	case 6:
+		return &quot;bmp&quot;;
+	case 7:
+	case 8:
+		return &quot;tif&quot;;
+	default:
+		return &quot;&quot;;
 	}
 }
 
-// Ajouter un ou plusieurs documents ?
 
-function ajout_doc_zip($image, $image_name, $mode, $forcer_document, $action_zip, $id_document, $hash, $link)
-{
-// image_name n'est valide que par POST http, mais pas par la methode ftp/upload
-// par ailleurs, pour un fichier ftp/upload, il faut effacer l'original nous-memes
-// action_zip indique un rappel par la fonction affiche_compactes
-	if (!$action_zip){
-		// on va se rappeler: copier le fichier car PHP va le virer
-		$image_name = copier_document(&quot;zip&quot;, $image_name, $image);
-		// anormal, on se tire
-		if (!$image_name) exit;
-		// renvoyer un formulaire demandant si on deballe ou pas
-		require_once(_DIR_RESTREINT . 'pclzip.lib.php');
-		$fichiers = verifier_compactes($image_name);
-		if ($fichiers) {
-			$link-&gt;addVar(&quot;image_name&quot;, $image_name);
-			afficher_compactes($image_name, $fichiers, $link);
-			exit;
+//
+// Corrige l'extension du fichier dans quelques cas particuliers
+//
+
+function corriger_extension($ext) {
+	switch ($ext) {
+	case 'htm':
+		return 'html';
+	case 'jpeg':
+		return 'jpg';
+	case 'tiff':
+		return 'tif';
+	default:
+		return $ext;
+	}
+}
+
+
+//
+// Ajouter un logo
+//
+
+// $source = $_FILES[0]
+// $dest = arton12.xxx
+function ajout_logo($source, $dest) {
+
+	// Intercepter une erreur d'upload
+	if (check_upload_error($source['error'])) return;
+
+	// analyse le type de l'image (on ne fait pas confiance au nom de
+	// fichier envoye par le browser : pour les Macs c'est plus sur)
+	$f =_DIR_DOC . $dest . '.tmp';
+	deplacer_fichier_upload($source['tmp_name'], $f);
+	$size = @getimagesize($f);
+	$type = decoder_type_image($size[2], true);
+
+	if ($type) {
+		$poids = filesize($f);
+		if (_LOGO_MAX_SIZE &gt; 0
+		AND $poids &gt; _LOGO_MAX_SIZE*1024) {
+			@unlink ($f);
+			check_upload_error(6,
+			_T('info_logo_max_poids',
+				array('maxi' =&gt; taille_en_octets(_LOGO_MAX_SIZE*1024),
+				'actuel' =&gt; taille_en_octets($poids))));
 		}
-		// pas possible de deballer, on continue
-		$forcer_document = 'oui';
-		$image = $image_name;
-	  }
-	  else {
-	    // reponse au formulaire
-		if ($action_zip == &quot;telquel&quot;) {
-			$forcer_document = 'oui';
-			
-		} else {
-			require_once(_DIR_RESTREINT . 'pclzip.lib.php');
-  			$archive = new PclZip($image_name);
-			$tmp_dir = creer_repertoire_documents($hash);
-			$archive-&gt;extract(PCLZIP_OPT_PATH, $tmp_dir, PCLZIP_OPT_REMOVE_ALL_PATH);
-			# virer le zip apr&#232;s le d&#233;ballage
-			@unlink($image_name);
-			$image_name = $tmp_dir;
 
+		if (_LOGO_MAX_WIDTH * _LOGO_MAX_HEIGHT
+		AND ($size[0] &gt; _LOGO_MAX_WIDTH
+		OR $size[1] &gt; _LOGO_MAX_HEIGHT)) {
+			@unlink ($f);
+			check_upload_error(6, 
+			_T('info_logo_max_taille',
+				array(
+				'maxi' =&gt;
+					_T('info_largeur_vignette',
+						array('largeur_vignette' =&gt; _LOGO_MAX_WIDTH,
+						'hauteur_vignette' =&gt; _LOGO_MAX_HEIGHT)),
+				'actuel' =&gt;
+					_T('info_largeur_vignette',
+						array('largeur_vignette' =&gt; $size[0],
+						'hauteur_vignette' =&gt; $size[1]))
+			)));
 		}
-	  }
-	ajout_doc_s($image, $image_name, $mode, $forcer_document,$id_document, $hash);
+		@rename ($f, _DIR_DOC . $dest . &quot;.$type&quot;);
+	}
+	else {
+		@unlink ($f);
+		check_upload_error(6,
+			_T('info_logo_format_interdit',
+			array ('formats' =&gt; 'GIF, JPG, PNG'))
+		);
+	}
 }
 
-function ajout_doc_s($image, $image_name, $mode, $forcer_document, $id_document, $hash) 
-{
-	if (!is_dir($image_name)) {
-		ajout_doc($image_name,
-			  $image,
-			  ($forcer_document == 'oui' ? &quot;document&quot; : $mode),
-			  $id_document);
-	} else {
+
+function effacer_logo($nom) {
+	if (!strstr($nom, &quot;..&quot;))
+		@unlink(_DIR_IMG . $nom);
+}
+
+
+
+//
+// Creation automatique de vignette
+//
+
+// Tester nos capacites
+function tester_vignette ($test_vignette) {
+	global $pnmscale_command;
+
+	// verifier les formats acceptes par GD
+	if ($test_vignette == &quot;gd1&quot;) {
+		// Si GD est installe et php &gt;= 4.0.2
+		if (function_exists('imagetypes')) {
+
+			if (imagetypes() &amp; IMG_GIF) {
+				$gd_formats[] = &quot;gif&quot;;
+			} else {
+				# Attention GD sait lire le gif mais pas forcement l'ecrire
+				if (function_exists('ImageCreateFromGIF')) {
+					$srcImage = @ImageCreateFromGIF(_DIR_IMG . &quot;test.gif&quot;);
+					if ($srcImage) {
+						$gd_formats_read_gif = &quot;,gif&quot;;
+						ImageDestroy( $srcImage );
+					}
+				}
+			}
+
+			if (imagetypes() &amp; IMG_JPG)
+				$gd_formats[] = &quot;jpg&quot;;
+			if (imagetypes() &amp; IMG_PNG)
+				$gd_formats[] = &quot;png&quot;;
+		}
+
+		else {	# ancienne methode de detection des formats, qui en plus
+				# est bugguee car elle teste les formats en lecture
+				# alors que la valeur deduite sert a identifier
+				# les formats disponibles en ecriture... (cf. inc_logos.php3)
+		
+			$gd_formats = Array();
+			if (function_exists('ImageCreateFromJPEG')) {
+				$srcImage = @ImageCreateFromJPEG(_DIR_IMG . &quot;test.jpg&quot;);
+				if ($srcImage) {
+					$gd_formats[] = &quot;jpg&quot;;
+					ImageDestroy( $srcImage );
+				}
+			}
+			if (function_exists('ImageCreateFromGIF')) {
+				$srcImage = @ImageCreateFromGIF(_DIR_IMG . &quot;test.gif&quot;);
+				if ($srcImage) {
+					$gd_formats[] = &quot;gif&quot;;
+					ImageDestroy( $srcImage );
+				}
+			}
+			if (function_exists('ImageCreateFromPNG')) {
+				$srcImage = @ImageCreateFromPNG(_DIR_IMG . &quot;test.png&quot;);
+				if ($srcImage) {
+					$gd_formats[] = &quot;png&quot;;
+					ImageDestroy( $srcImage );
+				}
+			}
+		}
+
+		if ($gd_formats) $gd_formats = join(&quot;,&quot;, $gd_formats);
+		ecrire_meta(&quot;gd_formats_read&quot;, $gd_formats.$gd_formats_read_gif);
+		ecrire_meta(&quot;gd_formats&quot;, $gd_formats);
+		ecrire_metas();
+	}
+
+	// verifier les formats netpbm
+	else if ($test_vignette == &quot;netpbm&quot;
+	AND $pnmscale_command) {
+		$netpbm_formats= Array();
+
+		$jpegtopnm_command = str_replace(&quot;pnmscale&quot;,
+			&quot;jpegtopnm&quot;, $pnmscale_command);
+		$pnmtojpeg_command = str_replace(&quot;pnmscale&quot;,
+			&quot;pnmtojpeg&quot;, $pnmscale_command);
+
+		$vignette = _DIR_IMG . &quot;test.jpg&quot;;
+		$dest = _DIR_IMG . &quot;test-jpg.jpg&quot;;
+		$commande = &quot;$jpegtopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command &gt; $dest&quot;;
+		spip_log($commande);
+		exec($commande);
+		if ($taille = @getimagesize($dest)) {
+			if ($taille[1] == 10) $netpbm_formats[] = &quot;jpg&quot;;
+		}
+		$giftopnm_command = ereg_replace(&quot;pnmscale&quot;, &quot;giftopnm&quot;, $pnmscale_command);
+		$pnmtojpeg_command = ereg_replace(&quot;pnmscale&quot;, &quot;pnmtojpeg&quot;, $pnmscale_command);
+		$vignette = _DIR_IMG . &quot;test.gif&quot;;
+		$dest = _DIR_IMG . &quot;test-gif.jpg&quot;;
+		$commande = &quot;$giftopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command &gt; $dest&quot;;
+		spip_log($commande);
+		exec($commande);
+		if ($taille = @getimagesize($dest)) {
+			if ($taille[1] == 10) $netpbm_formats[] = &quot;gif&quot;;
+		}
+
+		$pngtopnm_command = ereg_replace(&quot;pnmscale&quot;, &quot;pngtopnm&quot;, $pnmscale_command);
+		$vignette = _DIR_IMG . &quot;test.png&quot;;
+		$dest = _DIR_IMG . &quot;test-gif.jpg&quot;;
+		$commande = &quot;$pngtopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command &gt; $dest&quot;;
+		spip_log($commande);
+		exec($commande);
+		if ($taille = @getimagesize($dest)) {
+			if ($taille[1] == 10) $netpbm_formats[] = &quot;png&quot;;
+		}
+		
+
+		if ($netpbm_formats)
+			$netpbm_formats = join(&quot;,&quot;, $netpbm_formats);
+		else
+			$netpbm_formats = '';
+		ecrire_meta(&quot;netpbm_formats&quot;, $netpbm_formats);
+		ecrire_metas();
+	}
+
+	// et maintenant envoyer la vignette de tests
+	if (ereg(&quot;^(gd1|gd2|imagick|convert|netpbm)$&quot;, $test_vignette)) {
+		include_ecrire('inc_logos.php3');
+		//$taille_preview = lire_meta(&quot;taille_preview&quot;);
+		if ($taille_preview &lt; 10) $taille_preview = 150;
+		if ($preview = creer_vignette(_DIR_IMG . 'test_image.jpg', $taille_preview, $taille_preview, 'jpg', '', &quot;test_$test_vignette&quot;, $test_vignette, true))
+
+			return ($preview['fichier']);
+	}
+
+	return _DIR_IMG_PACK . 'puce-rouge-anim.gif';	# image echec
+}
+
+// Creation
+function creer_fichier_vignette($vignette, $test_cache_only=false) {
+	if ($vignette &amp;&amp; lire_meta(&quot;creer_preview&quot;) == 'oui') {
+		eregi('\.([a-z0-9]+)$', $vignette, $regs);
+		$ext = $regs[1];
+		$taille_preview = lire_meta(&quot;taille_preview&quot;);
+		if ($taille_preview &lt; 10) $taille_preview = 120;
+		include_ecrire('inc_logos.php3');
+
+		if ($preview = creer_vignette($vignette, $taille_preview, $taille_preview, $ext, 'vignettes', basename($vignette).'-s', 'AUTO', false, $test_cache_only))
+		{
+			inserer_vignette_base($vignette, $preview['fichier']);
+			return $preview['fichier'];
+		}
 		include_ecrire('inc_documents.php3');
-		$fichiers = fichiers_upload($image_name);
+		return vignette_par_defaut($ext ? $ext : 'txt', false);
+	}
+}
 
-		while (list(,$f) = each($fichiers)) {
-			if (ereg(&quot;\.([^.]+)$&quot;, $f, $match)) {
-				$ext = strtolower($match[1]);
-				if ($ext == 'jpeg')
-					$ext = 'jpg';
-				$r = spip_query(&quot;SELECT extension FROM spip_types_documents WHERE extension='$ext'&quot; . ($inclus ? &quot; AND inclus='$inclus'&quot; : ''));
-				if (spip_fetch_array($r))
-					ajout_doc($f, $f, 'document', false);
+// Effacer un doc (et sa vignette)
+function supprime_document_et_vignette($doc_supp) {
+
+	$result = spip_query(&quot;SELECT id_vignette, fichier
+		FROM spip_documents
+		WHERE id_document=$doc_supp&quot;);
+	if ($row = spip_fetch_array($result)) {
+		$fichier = $row['fichier'];
+		$id_vignette = $row['id_vignette'];
+		spip_query(&quot;DELETE FROM spip_documents
+			WHERE id_document=$doc_supp&quot;);
+		spip_query(&quot;UPDATE spip_documents SET id_vignette=0
+			WHERE id_vignette=$doc_supp&quot;);
+		spip_query(&quot;DELETE FROM spip_documents_articles
+			WHERE id_document=$doc_supp&quot;);
+		spip_query(&quot;DELETE FROM spip_documents_rubriques
+			WHERE id_document=$doc_supp&quot;);
+		spip_query(&quot;DELETE FROM spip_documents_breves
+			WHERE id_document=$doc_supp&quot;);
+		@unlink($fichier);
+
+		if ($id_vignette &gt; 0) {
+			$query = &quot;SELECT id_vignette, fichier FROM spip_documents
+				WHERE id_document=$id_vignette&quot;;
+			$result = spip_query($query);
+			if ($row = spip_fetch_array($result)) {
+				$fichier = $row['fichier'];
+				@unlink($fichier);
 			}
+			spip_query(&quot;DELETE FROM spip_documents
+				WHERE id_document=$id_vignette&quot;);
+			spip_query(&quot;DELETE FROM spip_documents_articles
+				WHERE id_document=$id_vignette&quot;);
+			spip_query(&quot;DELETE FROM spip_documents_rubriques
+				WHERE id_document=$id_vignette&quot;);
+			spip_query(&quot;DELETE FROM spip_documents_breves
+				WHERE id_document=$id_vignette&quot;);
 		}
+	}
+}
 
-# d&#233;truire le repertoire de deballage
-		if ($tmp_dir) effacer_repertoire_temporaire($tmp_dir);
+
+
+/////////////////////////////////////////////////////////////////////
+//
+// Faire tourner une image
+//
+function gdRotate ($imagePath,$rtt){
+	if(preg_match(&quot;/\.(png)/i&quot;, $imagePath))
+		$src_img=ImageCreateFromPNG($imagePath);
+	else if(preg_match(&quot;/\.(jpg)/i&quot;, $imagePath))
+		$src_img=ImageCreateFromJPEG($imagePath);
+	else if(preg_match(&quot;/\.(bmp)/i&quot;, $imagePath))
+		$src_img=ImageCreateFromWBMP($imagePath);
+	$size=@getimagesize($imagePath);
+
+	// Sous GD2 : ImageCreateTrueColor
+	$process = lire_meta('image_process');
+	if ($process == &quot;gd2&quot;)
+		$dst_img=ImageCreateTrueColor($size[1],$size[0]);
+	else
+		$dst_img=ImageCreate($size[1],$size[0]);
+
+	if($rtt==90){
+		$t=0;
+		$b=$size[1]-1;
+		while($t&lt;=$b){
+			$l=0;
+			$r=$size[0]-1;
+			while($l&lt;=$r){
+				imagecopy($dst_img,$src_img,$t,$r,$r,$b,1,1);
+				imagecopy($dst_img,$src_img,$t,$l,$l,$b,1,1);
+				imagecopy($dst_img,$src_img,$b,$r,$r,$t,1,1);
+				imagecopy($dst_img,$src_img,$b,$l,$l,$t,1,1);
+				$l++;
+				$r--;
+			}
+			$t++;
+			$b--;
+		}
+	}
+	elseif($rtt==-90){
+		$t=0;
+		$b=$size[1]-1;
+		while($t&lt;=$b){
+			$l=0;
+			$r=$size[0]-1;
+			while($l&lt;=$r){
+				imagecopy($dst_img,$src_img,$t,$l,$r,$t,1,1);
+				imagecopy($dst_img,$src_img,$t,$r,$l,$t,1,1);
+				imagecopy($dst_img,$src_img,$b,$l,$r,$b,1,1);
+				imagecopy($dst_img,$src_img,$b,$r,$l,$b,1,1);
+				$l++;
+				$r--;
+			}
+			$t++;
+			$b--;
+		}
 	}
+	ImageDestroy($src_img);
+	ImageInterlace($dst_img,0);
+	ImageJPEG($dst_img,$imagePath);
 }
 
-function effacer_repertoire_temporaire($nom) {
-	$d = opendir($nom);
-	while ($f = readdir($d)) {
-		if (is_file($f = &quot;$nom/$f&quot;)) @unlink($f);
+function tourner_document($var_rot, $doc_rotate, $convert_command) {
+	
+	$var_rot = intval($var_rot);
+
+	$query = &quot;SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$doc_rotate&quot;;
+	$result = spip_query($query);
+	if ($row = spip_fetch_array($result)) {
+		$id_vignette = $row['id_vignette'];
+		$image = $row['fichier'];
+
+		$process = lire_meta('image_process');
+
+		 // imagick (php4-imagemagick)
+		 if ($process == 'imagick') {
+			$handle = imagick_readimage($image);
+			imagick_rotate($handle, $var_rot);
+			imagick_write($handle, $image);
+			if (!@file_exists($image)) return;	// echec imagick
 		}
-	@rmdir($nom);
+		else if ($process == &quot;gd2&quot;) { // theoriquement compatible gd1, mais trop forte degradation d'image
+			if ($var_rot == 180) { // 180 = 90+90
+				gdRotate ($image, 90);
+				gdRotate ($image, 90);
+			} else {
+				gdRotate ($image, $var_rot);
+			}
+		}
+		else if ($process = &quot;convert&quot;) {
+			$commande = &quot;$convert_command -rotate $var_rot ./&quot;
+				. escapeshellcmd($image).' ./'.escapeshellcmd($image);
+#			spip_log($commande);
+			exec($commande);
+		}
+
+		$size_image = @getimagesize($image);
+		$largeur = $size_image[0];
+		$hauteur = $size_image[1];
+
+		if ($id_vignette &gt; 0) {
+			creer_fichier_vignette($image);
+		}
+
+		spip_query(&quot;UPDATE spip_documents SET largeur=$largeur, hauteur=$hauteur WHERE id_document=$doc_rotate&quot;);
+
+	}
 }
+
 ?&gt;

Index: inc_mots.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_mots.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_mots.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_mots.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_MOTS&quot;)) return;
@@ -7,8 +18,6 @@
 
 include_ecrire(&quot;inc_filtres.php3&quot;); # pour http_script (normalement d&#233;j&#224; fait)
 
-$GLOBALS['flag_mots_ressemblants'] = $GLOBALS['flag_levenshtein'];
-
 
 // ne pas faire d'erreur si les chaines sont &gt; 254 caracteres
 function levenshtein255 ($a, $b) {
@@ -82,7 +91,6 @@
  */
 
 function formulaire_mots($table, $id_objet, $nouv_mot, $supp_mot, $cherche_mot, $flag_editable) {
-	global $flag_mots_ressemblants;
 	global $connect_statut, $options;
 	global $spip_lang_rtl, $spip_lang_right;
 
@@ -431,15 +439,14 @@
 			$query .= &quot;ORDER BY type, titre&quot;;
 			$result = spip_query($query);
 			if (spip_num_rows($result) &gt; 0) {
-				if ((spip_num_rows($result) &gt; 50 AND $flag_mots_ressemblants)) {
+				if ((spip_num_rows($result) &gt; 50)) {
 					echo &quot;\n&lt;tr&gt;&quot;;
 					echo $form_mot;
 					echo &quot;\n&lt;td&gt;&quot;;
 					echo $message_ajouter_mot;
 					$message_ajouter_mot = &quot;&quot;;
 					echo &quot;&lt;/td&gt;\n&lt;td&gt;&quot;;
-					echo &quot;&lt;script language='text/javascript'&gt;&lt;!--\nvar antifocus_$id_groupe = false;\n// --&gt;&lt;/script&gt;\n&quot;;
-					$jscript = &quot;onfocus=\&quot;if(!antifocus_$id_groupe){this.value='';antifocus_$id_groupe=true;}\&quot;&quot;. &quot; onClick=\&quot;setvisibility('valider_groupe_$id_groupe', 'visible');\&quot;&quot;;
+					$jscript = &quot;onfocus=\&quot;setvisibility('valider_groupe_$id_groupe', 'visible'); if(!antifocus_mots[$id_groupe]){this.value='';antifocus_mots[$id_groupe]=true;}\&quot;&quot;;
 
 					if ($obligatoire == &quot;oui&quot; AND !$groupes_vus[$id_groupe])
 						echo &quot;&lt;INPUT TYPE='text' NAME='cherche_mot' CLASS='fondl' STYLE='width: 180px; background-color:#E86519;' VALUE=\&quot;$titre_groupe\&quot; SIZE='20' $jscript&gt;&quot;;

Index: message_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/message_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- message_edit.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ message_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_abstract_sql.php3&quot;);
 
@@ -135,7 +146,7 @@
 	if ($type == 'pb') $statut = 'publie';
 	else $statut = 'redac';
 
-	$id_message = spip_abstract_insert(&quot;messages&quot;,
+	$id_message = spip_abstract_insert(&quot;spip_messages&quot;,
 				  &quot;(titre, date_heure, statut, type, id_auteur)&quot;, 
 				  &quot;('&quot;.addslashes(filtrer_entites(_T('texte_nouveau_message'))).&quot;', NOW(), '$statut', '$type', $connect_id_auteur)&quot;);
 	

Index: sites_tous.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/sites_tous.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- sites_tous.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ sites_tous.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_sites.php3&quot;);

Index: admin_tech.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_tech.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- admin_tech.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ admin_tech.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 

Index: inc_mail.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_mail.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_mail.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_mail.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_MAIL&quot;)) return;

Index: inc.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 include_ecrire(&quot;inc_auth.php3&quot;);
 include_ecrire(&quot;inc_presentation.php3&quot;);
@@ -10,12 +21,14 @@
 include_ecrire(&quot;inc_layer.php3&quot;);
 include_ecrire(&quot;inc_rubriques.php3&quot;);
 include_ecrire(&quot;inc_forum.php3&quot;);
+include_ecrire('inc_admin.php3');
+
 
 //
 // Preferences de presentation
 //
 
-if ($spip_lang_ecrire = $GLOBALS['HTTP_COOKIE_VARS']['spip_lang_ecrire']
+if ($spip_lang_ecrire = $GLOBALS['_COOKIE']['spip_lang_ecrire']
 AND $spip_lang_ecrire &lt;&gt; $auteur_session['lang']
 AND changer_langue($spip_lang_ecrire)) {
 	spip_query (&quot;UPDATE spip_auteurs SET lang = '&quot;.addslashes($spip_lang_ecrire)
@@ -187,7 +200,7 @@
 // Recuperation du cookie
 //
 
-$cookie_admin = $HTTP_COOKIE_VARS['spip_admin'];
+$cookie_admin = $_COOKIE['spip_admin'];
 
 // Supprimer rubrique
 if ($supp_rubrique = intval($supp_rubrique) AND $connect_statut == '0minirezo' AND acces_rubrique($supp_rubrique)) {
@@ -199,7 +212,6 @@
 
 // Modifs forum
 if ($controle_forum AND $id_controle_forum) {
-	include_ecrire('inc_admin.php3');
 	if (verifier_action_auteur(&quot;$controle_forum$id_controle_forum&quot;,
 	$hash, $connect_id_auteur)) {
 		switch($controle_forum) {

Index: config-fonctions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-fonctions.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- config-fonctions.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ config-fonctions.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_config.php3&quot;);
@@ -46,6 +57,12 @@
 	else
 		$border=0;
 
+	// Ici on va tester les capacites de GD independamment des tests realises
+	// dans les images spip_image -- qui servent neanmoins pour la qualite
+	/* if (function_exists('imageformats')) {
+		
+	} */
+
 	echo &quot;&lt;td  width='&quot;.($taille_preview+4).&quot;'&gt;&lt;div align='center' valign='bottom' width='&quot;.($taille_preview+4).&quot;'&gt;&lt;a href='config-fonctions.php3?image_process=$process'&gt;&lt;img src='../spip_image.php3?test_vignette=$process' border='$border' /&gt;&lt;/a&gt;&lt;br /&gt;&quot;;
 	if ($border) echo &quot;&lt;b&gt;$process&lt;/b&gt;&quot;;
 	else echo &quot;$process&quot;;
@@ -84,17 +101,13 @@
 			// mettre a jour les formats graphiques lisibles
 			switch (lire_meta('image_process')) {
 				case 'gd1':
-					$formats_graphiques = lire_meta('gd_formats');
-					break;
 				case 'gd2':
-					$formats_graphiques = lire_meta('gd_formats');
+					$formats_graphiques = lire_meta('gd_formats_read');
 					break;
 				case 'netpbm':
 					$formats_graphiques = lire_meta('netpbm_formats');
 					break;
 				case 'convert':
-					$formats_graphiques = 'gif,jpg,png';
-					break;
 				case 'imagick':
 					$formats_graphiques = 'gif,jpg,png';
 					break;
@@ -401,14 +414,13 @@
 // Creer fichier .htpasswd ?
 //
 
-if ($options == &quot;avancees&quot; AND !@file_exists(_ACCESS_FILE_NAME) AND !$REMOTE_USER ) {
+
+if ($options == &quot;avancees&quot;) {
 	include_ecrire (&quot;inc_acces.php3&quot;);
 	ecrire_acces();
 
-
-
-debut_cadre_trait_couleur(&quot;cadenas-24.gif&quot;, false, &quot;&quot;, 
-			  _T('info_fichiers_authent'));
+	debut_cadre_trait_couleur(&quot;cadenas-24.gif&quot;, false, &quot;&quot;,
+		_T('info_fichiers_authent'));
 
 	$creer_htpasswd = lire_meta(&quot;creer_htpasswd&quot;);
 
@@ -416,13 +428,13 @@
 
 	echo &quot;&lt;div class='verdana2'&gt;&quot;;
 	afficher_choix('creer_htpasswd', $creer_htpasswd,
-		       array('oui' =&gt; _T('item_creer_fichiers_authent'),
-			     'non' =&gt;  _T('item_non_creer_fichiers_authent')),
-		       ' &nbsp; ');
+		array('oui' =&gt; _T('item_creer_fichiers_authent'),
+			'non' =&gt;  _T('item_non_creer_fichiers_authent')),
+		' &nbsp; ');
 	echo &quot;&lt;/div&gt;&quot;;
 	echo &quot;&lt;div style='text-align:$spip_lang_right'&gt;&lt;INPUT TYPE='submit' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;' CLASS='fondo'&gt;&lt;/div&gt;&quot;;
 	
-fin_cadre_trait_couleur();
+	fin_cadre_trait_couleur();
 
 	echo &quot;&lt;p&gt;&quot;;
 }
@@ -431,7 +443,7 @@
 /*
 ###### PAS D'INTERFACE DE CONFIG POUR PROTEGER &quot;/IMG&quot;
 //
-// Creer fichier .htaccess dans les r&#233;pertoires de documents 
+// Creer fichier .htaccess dans les repertoires de documents 
 //
 
 if ($options == &quot;avancees&quot; AND !$REMOTE_USER ) {

Index: inc_urls.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_urls.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_urls.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_urls.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_URLS&quot;)) return;

Index: statistiques_visites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/statistiques_visites.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- statistiques_visites.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ statistiques_visites.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire(&quot;inc_statistiques.php3&quot;);
 
@@ -312,12 +323,12 @@
 		  echo http_href_img(&quot;statistiques_visites.php3?aff_jours=$aff_jours_plus$pour_article&quot;,
 				     'loupe-moins.gif',
 				     &quot;border='0' valign='center'&quot;,
-				     _L('zoom'). '-'), &quot;&nbsp;&quot;;
+				     _T('info_zoom'). '-'), &quot;&nbsp;&quot;;
 		if ( (($date_today - $date_debut) / (24*3600)) &gt; 30)
 		  echo http_href_img(&quot;statistiques_visites.php3?aff_jours=$aff_jours_moins$pour_article&quot;, 
 				     'loupe-plus.gif',
 				     &quot;border='0' valign='center'&quot;,
-				     _L('zoom'). '+'), &quot;&nbsp;&quot;;
+				     _T('info_zoom'). '+'), &quot;&nbsp;&quot;;
 	
 		/*
 		if ($spip_svg_plugin == 'oui') {
@@ -359,7 +370,7 @@
 						$tab_moyenne[$decal] = $value;
 	
 						$ce_jour=date(&quot;Y-m-d&quot;, $jour_prec+(3600*24*($i+1)));
-						$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
+						$jour = nom_jour($ce_jour).' '.affdate_jourcourt($ce_jour);
 	
 						reset($tab_moyenne);
 						$moyenne = 0;
@@ -386,7 +397,7 @@
 				}
 	
 				$ce_jour=date(&quot;Y-m-d&quot;, $key);
-				$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
+				$jour = nom_jour($ce_jour).' '.affdate_jourcourt($ce_jour);
 	
 				$total_loc = $total_loc + $value;
 				reset($tab_moyenne);

Index: brouteur.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/brouteur.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- brouteur.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ brouteur.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 	if ($spip_ecran == &quot;large&quot;) {
@@ -23,7 +34,7 @@
 	if ($id_rubrique) {
 		$j = $nb_col;
 		while ($id_rubrique &gt; 0) {
-			$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique=$id_rubrique ORDER BY titre&quot;;
+			$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique='$id_rubrique' ORDER BY titre&quot;;
 			$result=spip_query($query);
 			while($row=spip_fetch_array($result)){
 				$j = $j-1;
@@ -54,14 +65,14 @@
 			
 			$la_rubrique = $dest[0];
 			
-			$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique = $la_rubrique&quot;;
+			$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique ='$la_rubrique'&quot;;
 			$result = spip_query($query);
 			while ($row = spip_fetch_array($result)) {
 				$la_rubrique =$row['id_parent'];
 			}
 			
 			while ($la_rubrique &gt; 0) {
-				$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique = $la_rubrique&quot;;
+				$query = &quot;SELECT * FROM spip_rubriques WHERE id_rubrique ='$la_rubrique'&quot;;
 				$result = spip_query($query);
 				while ($row = spip_fetch_array($result)) {
 					$compteur = $compteur + 1;
@@ -106,8 +117,6 @@
 	
 	}
 	
-	echo &quot;&lt;/tr&gt;&quot;;
-	echo &quot;&lt;/table&gt;&quot;;	
-
+fin_page();
 
 ?&gt;

Index: export.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/export.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- export.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ export.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 
 include_ecrire (&quot;inc_auth.php3&quot;);

Index: forum_admin.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/forum_admin.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- forum_admin.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ forum_admin.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 $admin = 'oui';
 include ('forum.php3');
 

Index: config-contenu.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-contenu.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- config-contenu.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ config-contenu.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_config.php3&quot;);

Index: inc_sites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_sites.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_sites.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_sites.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_INC_SITES&quot;)) return;

Index: inc_popularites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_popularites.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_popularites.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_popularites.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_POPULARITES&quot;)) return;
 define(&quot;_ECRIRE_INC_POPULARITES&quot;, &quot;1&quot;);

Index: inc_serialbase.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_serialbase.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_serialbase.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_serialbase.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_SERIALBASE&quot;)) return;
 define(&quot;_ECRIRE_INC_SERIALBASE&quot;, &quot;1&quot;);
@@ -197,6 +208,7 @@
 		&quot;hauteur&quot;	=&gt; &quot;integer NOT NULL&quot;,
 		&quot;mode&quot;	=&gt; &quot;ENUM('vignette', 'document') NOT NULL&quot;,
 		&quot;inclus&quot;	=&gt; &quot;VARCHAR(3) DEFAULT 'non'&quot;,
+		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
 		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;);
 
 $spip_documents_key = array(
@@ -235,6 +247,7 @@
 		&quot;date&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
 		&quot;date_syndic&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
 		&quot;date_index&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
+		&quot;extra&quot;			=&gt; &quot;longblob NULL&quot;,
 		&quot;moderation&quot;	=&gt; &quot;VARCHAR(3) NOT NULL&quot;);
 
 $spip_syndic_key = array(
@@ -318,31 +331,31 @@
 /// Attention: mes_fonctions peut avoir deja defini cette variable
 /// il faut donc rajouter, mais pas reinitialiser
 
-$tables_principales['articles'] =
+$tables_principales['spip_articles'] =
 	array('field' =&gt; &amp;$spip_articles, 'key' =&gt; &amp;$spip_articles_key);
-$tables_principales['auteurs']  =
+$tables_principales['spip_auteurs']  =
 	array('field' =&gt; &amp;$spip_auteurs, 'key' =&gt; &amp;$spip_auteurs_key);
-$tables_principales['breves']   =
+$tables_principales['spip_breves']   =
 	array('field' =&gt; &amp;$spip_breves, 'key' =&gt; &amp;$spip_breves_key);
-$tables_principales['messages'] =
+$tables_principales['spip_messages'] =
 	array('field' =&gt; &amp;$spip_messages, 'key' =&gt; &amp;$spip_messages_key);
-$tables_principales['mots']     =
+$tables_principales['spip_mots']     =
 	array('field' =&gt; &amp;$spip_mots, 'key' =&gt; &amp;$spip_mots_key);
-$tables_principales['groupes_mots'] =
+$tables_principales['spip_groupes_mots'] =
 	array('field' =&gt; &amp;$spip_groupes_mots, 'key' =&gt; &amp;$spip_groupes_mots_key);
-$tables_principales['rubriques'] =
+$tables_principales['spip_rubriques'] =
 	array('field' =&gt; &amp;$spip_rubriques, 'key' =&gt; &amp;$spip_rubriques_key);
-$tables_principales['documents'] =
+$tables_principales['spip_documents'] =
 	array('field' =&gt; &amp;$spip_documents,  'key' =&gt; &amp;$spip_documents_key);
-$tables_principales['types_documents']	=
+$tables_principales['spip_types_documents']	=
 	array('field' =&gt; &amp;$spip_types_documents, 'key' =&gt; &amp;$spip_types_documents_key);
-$tables_principales['syndic'] =
+$tables_principales['spip_syndic'] =
 	array('field' =&gt; &amp;$spip_syndic, 'key' =&gt; &amp;$spip_syndic_key);
-$tables_principales['syndic_articles']	=
+$tables_principales['spip_syndic_articles']	=
 	array('field' =&gt; &amp;$spip_syndic_articles, 'key' =&gt; &amp;$spip_syndic_articles_key);
-$tables_principales['forum'] =
+$tables_principales['spip_forum'] =
 	array('field' =&gt; &amp;$spip_forum,	'key' =&gt; &amp;$spip_forum_key);
-$tables_principales['signatures'] =
+$tables_principales['spip_signatures'] =
 	array('field' =&gt; &amp;$spip_signatures, 'key' =&gt; &amp;$spip_signatures_key);
 
 ?&gt;

Index: articles_tous.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_tous.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles_tous.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ articles_tous.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 if (count($aff_art) &gt; 0) $aff_art = join(',', $aff_art);

Index: inc_barre.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_barre.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_barre.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_barre.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,4 +1,15 @@
 &lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_INC_BARRE&quot;)) return;

Index: export_all.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/export_all.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- export_all.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ export_all.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 
 include_ecrire (&quot;inc_auth.php3&quot;);

Index: spip_style.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/spip_style.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_style.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ spip_style.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,14 +1,26 @@
 &lt;?php
 
-	include(&quot;inc_version.php3&quot;);
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
 
-	// En-tetes
-	$lastmodified = @filemtime(&quot;spip_style.php3&quot;);
-	$headers_only = http_last_modified($lastmodified, time() + 24 * 3600);
-	if ($headers_only) exit;
 
+include(&quot;inc_version.php3&quot;);
 
-	@Header (&quot;Content-Type: text/css&quot;);
+// En-tetes
+
+if (http_last_modified(@filemtime(&quot;spip_style.php3&quot;), time() + 24 * 3600)) 
+	exit;
+
+// mettre absolument le charset :
+// Apache-AdvancedExtranetServer &amp; FireFox s'entendent mal sinon
+	@Header (&quot;Content-Type: text/css; charset=iso-8859-1&quot;);
 
 	// parano XSS
 	eregi(&quot;^([#0-9a-z]*).*-([#0-9a-z]*).*-([0-9a-z]*).*-([0-9a-z]*).*&quot;, &quot;$couleur_claire-$couleur_foncee-$left-$right&quot;, $regs);
@@ -27,7 +39,7 @@
 
 	function http_img_pack($f) { return _DIR_IMG_PACK . $f; }
 ?&gt;
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">- at import</A> &quot;dhtml_tools.css&quot;; 
<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">+ at import</A> &quot;dhtml_tools.css&quot;;
 
 /*
  * Police par defaut (bof...)

Index: cartes.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/cartes.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- cartes.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ cartes.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -15,10 +15,10 @@
 
 
 afficher_cartes(_L(&quot;Toutes les cartes&quot;),
-	&quot;SELECT cartes.*, COUNT(id_objet) AS objets &quot;.
-	&quot;FROM spip_carto_carte AS cartes LEFT JOIN spip_carto_objet AS objets &quot;.
-	&quot;ON (cartes.id_carte=objets.id_carte) &quot;.
-	&quot;GROUP BY cartes.id_carte ORDER BY cartes.titre&quot;);
+	&quot;SELECT cartes.*, COUNT(id_carto_objet) AS objets &quot;.
+	&quot;FROM spip_carto_cartes AS cartes LEFT JOIN spip_carto_objets AS objets &quot;.
+	&quot;ON (cartes.id_carto_carte=objets.id_carto_carte) &quot;.
+	&quot;GROUP BY cartes.id_carto_carte ORDER BY cartes.titre&quot;);
 //TODO : gerer un statut par objet
 //ajouter cette clause &#224; la jointure :
 //// AND objets.statut='valide'

Index: inc_majbase.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_majbase.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_majbase.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_majbase.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_MAJBASE&quot;)) return;
@@ -24,8 +35,9 @@
 	//
 	// Lecture de la version installee
 	//
+	// spip_query_db car on est peut-etre en cours d'installation
 	$version_installee = 0.0;
-	$result = spip_query(&quot;SELECT valeur FROM spip_meta WHERE nom='version_installee'&quot;);
+	$result = spip_query_db (&quot;SELECT valeur FROM spip_meta WHERE nom='version_installee'&quot;);
 	if ($result) if ($row = spip_fetch_array($result)) $version_installee = (double) $row['valeur'];
 
 	//
@@ -34,10 +46,10 @@
 	//   =&gt; ne pas passer par le processus de mise a jour
 	//
 	// $version_installee = 1.702; quand on a besoin de forcer une MAJ
+
 	if (!$version_installee) {
-		include_ecrire('inc_meta.php3');
-		ecrire_meta('version_installee', $spip_version);
-		ecrire_metas();
+		spip_query_db(&quot;REPLACE spip_meta (nom, valeur)
+			VALUES ('version_installee', '$spip_version')&quot;);
 		return true;
 	}
 
@@ -360,7 +372,7 @@
 				$fichier = _DIR_IMG . $fichier;
 				$taille = @filesize($fichier);
 				$fichier = substr('../', '', $fichier);
-				$id_document = spip_abstract_insert(&quot;documents&quot;, 
+				$id_document = spip_abstract_insert(&quot;spip_documents&quot;, 
 							   &quot;(titre, id_type, fichier, mode, largeur, hauteur, taille)&quot;,
 							   &quot;('image $largeur x $hauteur', $id_type, '$fichier', 'vignette', '$largeur', '$hauteur', '$taille')&quot;);
 
@@ -531,7 +543,7 @@
 			$res = spip_query(&quot;SELECT * FROM spip_groupes_mots
 				WHERE titre='$type'&quot;);
 			if (spip_num_rows($res) == 0) {
-			  if ($id_groupe = spip_abstract_insert(&quot;groupes_mots&quot;, 
+			  if ($id_groupe = spip_abstract_insert(&quot;spip_groupes_mots&quot;, 
 						       &quot;(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)&quot;,
 						       &quot;('$type', 'non', 'non', 'oui', 'oui', 'non', 'oui', 'oui', 'oui', 'non')&quot;))
 
@@ -934,6 +946,23 @@
 		spip_query(&quot;ALTER TABLE spip_versions ADD champs text NOT NULL&quot;);
 
 		maj_version(1.809);
+	}
+
+	// Annuler les brouillons de forum jamais valides
+	if ($version_installee &lt; 1.810) {
+		spip_query(&quot;DELETE FROM spip_forum WHERE statut='redac'&quot;);
+		maj_version(1.810);
+	}
+
+	if ($version_installee &lt; 1.811) {
+		spip_query(&quot;ALTER TABLE spip_syndic ADD extra longblob NULL&quot;);
+		maj_version(1.811);
+	}
+	
+	if ($version_installee &lt; 1.812) {
+		spip_query(&quot;ALTER TABLE spip_documents
+		ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
+		maj_version(1.812);
 	}
 
 	return true;

Index: inc_import.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_import.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_import.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_import.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_IMPORT&quot;)) return;
@@ -445,6 +456,49 @@
 	echo &quot;document.progression.taille.value='$taille';\n&quot;;
 	echo &quot;//--&gt;&lt;/script&gt;\n&lt;!--\n&quot;;
 	flush();
+}
+
+function import_init()
+{
+  global $meta, $flag_gz, $buf, $pos, $abs_pos;
+	$archive = $meta[&quot;fichier_restauration&quot;];
+	$my_pos = $meta[&quot;status_restauration&quot;];
+	$ok = @is_readable($archive);
+
+	if ($ok) {
+		if (ereg(&quot;\.gz$&quot;, $archive)) {
+			$affiche_progression_pourcent = false;
+			$taille = taille_en_octets($my_pos);
+		}
+		else {
+			$affiche_progression_pourcent = filesize($archive);
+			$taille = floor(100 * $my_pos / $affiche_progression_pourcent).&quot; %&quot;;
+		}
+		$texte_boite = _T('info_base_restauration').&quot;&lt;p&gt;
+		&lt;form name='progression'&gt;&lt;center&gt;&lt;input type='text' size=10 style='text-align:center;' name='taille' value='$taille'&gt;&lt;br&gt;
+		&lt;input type='text' class='forml' name='recharge' value='&quot;._T('info_recharger_page').&quot;'&gt;&lt;/center&gt;&lt;/form&gt;&quot;;
+	}
+	else {
+		$texte_boite = _T('info_erreur_restauration');
+	}
+
+	debut_boite_alerte();
+	echo &quot;&lt;font FACE='Verdana,Arial,Sans,sans-serif' SIZE=4 color='black'&gt;&lt;B&gt;$texte_boite&lt;/B&gt;&lt;/font&gt;&quot;;
+	fin_boite_alerte();
+	fin_page(&quot;jimmac&quot;);
+	echo &quot;&lt;/HTML&gt;&lt;font color='white'&gt;\n&lt;!--&quot;;
+	@flush();
+
+	if ($ok) {
+		$_fopen = ($flag_gz) ? gzopen : fopen;
+		$f = $_fopen($archive, &quot;rb&quot;);
+		$pos = 0;
+		$buf = &quot;&quot;;
+		if (!import_all($f, $gz)) import_abandon();
+	}
+	else {
+		import_fin();
+	}
 }
 
 ?&gt;

Index: inc_auth_ldap.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_auth_ldap.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_auth_ldap.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_auth_ldap.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_AUTH_LDAP&quot;)) return;

Index: install.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/install.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- install.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ install.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,4 +1,16 @@
 &lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 if (defined(&quot;_ECRIRE_INSTALL&quot;)) return;
 define(&quot;_ECRIRE_INSTALL&quot;, &quot;1&quot;);
 
@@ -60,7 +72,7 @@
 		$nom = addslashes($nom);
 		$login = addslashes($login);
 		$query = &quot;SELECT id_auteur FROM spip_auteurs WHERE login='$login'&quot;;
-		$result = spip_query_db($query);
+		$result = spip_query($query);
 		unset($id_auteur);
 		while ($row = spip_fetch_array($result)) $id_auteur = $row['id_auteur'];
 
@@ -73,10 +85,11 @@
 		else {
 			$query = &quot;INSERT INTO spip_auteurs (nom, email, login, pass, htpass, alea_futur, statut) VALUES('$nom','$email','$login','$mdpass','$htpass',FLOOR(32000*RAND()),'0minirezo')&quot;;
 		}
-		spip_query_db($query);
+		spip_query($query);
 
 		// inserer email comme email webmaster principal
-		ecrire_meta('email_webmaster', $email);
+		spip_query(&quot;REPLACE spip_meta (nom, valeur)
+			VALUES ('email_webmaster', '&quot;.addslashes($email).&quot;')&quot;);
 	}
 
 	include_ecrire(&quot;inc_config.php3&quot;);
@@ -179,18 +192,22 @@
 	echo $sel_db;
 	mysql_select_db(&quot;$sel_db&quot;);
 
+	// Message pour spip_query : tout va bien !
+	$GLOBALS['db_ok'] = true;
+	$GLOBALS['spip_connect_version'] = 0.1; # cf. inc_version
+
 	// Test si SPIP deja installe
-	@spip_query_db(&quot;SELECT COUNT(*) FROM spip_meta&quot;);
+	spip_query(&quot;SELECT COUNT(*) FROM spip_meta&quot;);
 	$nouvelle = spip_sql_errno();
-
 	creer_base();
+
 	$maj_ok = maj_base();
 
 	if ($nouvelle) {
-		spip_query_db(&quot;INSERT spip_meta (nom, valeur) VALUES ('nouvelle_install', 'oui')&quot;);
+		spip_query(&quot;INSERT spip_meta (nom, valeur) VALUES ('nouvelle_install', 'oui')&quot;);
 		$result_ok = !spip_sql_errno();
 	} else {
-		$result = spip_query_db(&quot;SELECT COUNT(*) FROM spip_articles&quot;);
+		$result = spip_query(&quot;SELECT COUNT(*) FROM spip_articles&quot;);
 		$result_ok = (spip_num_rows($result) &gt; 0);
 	}
 	echo &quot;($result_ok &amp;&amp; $maj_ok) --&gt;&quot;;
@@ -392,9 +409,7 @@
 		echo &quot;&lt;p align='center'&gt;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;logo-spip.gif'&gt;&lt;/p&gt;&quot;;
 		
 		echo &quot;&lt;p style='text-align: center; font-family: Verdana,Arial,Sans,sans-serif; font-size: 10px;'&gt;&quot;;
-		echo &quot;&lt;b&gt;SPIP $spip_version_affichee&lt;/b&gt; &quot;;
-		echo _T('info_copyright');
-
+		echo info_copyright();
 		echo &quot;&lt;/p&gt;&quot;;
 
 		echo &quot;&lt;p&gt;&quot; . _T('install_select_langue');

Index: suivi_revisions.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/suivi_revisions.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- suivi_revisions.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ suivi_revisions.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include(&quot;inc_lab.php&quot;);
 
 include_ecrire(&quot;inc_suivi_revisions.php&quot;);

Index: inc_invalideur.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_invalideur.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_invalideur.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_invalideur.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INVALIDEUR&quot;)) return;
 define(&quot;_ECRIRE_INVALIDEUR&quot;, &quot;1&quot;);
@@ -10,26 +21,37 @@
 	spip_query(&quot;DELETE FROM spip_caches&quot;);
 }
 
+
+// Compilateur : ajouter un invalideur &quot;$type/$valeur&quot; a un code donne
+// Attention le type est compile, pas forcement la valeur
+function ajouter_invalideur($type, $valeur, $code) {
+	return '
+	// invalideur '.$type.'
+	(!($Cache[\''.$type.'\']['.$valeur.&quot;]=1) ? '':\n\t&quot; . $code .&quot;)\n&quot;;
+}
+
+
 //
-// Noter dans la base les liens d'invalidation
+// Calcul des pages : noter dans la base les liens d'invalidation
 //
-function maj_invalideurs ($fichier, $infosurpage, $delais) {
+function maj_invalideurs ($fichier, $invalideurs, $delais) {
 	$fichier = addslashes($fichier); #parano
 	if ($fichier == '') return;	// ne pas noter les POST et les delais=0
 	spip_query(&quot;DELETE FROM spip_caches WHERE fichier='$fichier'&quot;);
 
 	// invalidation des forums (l'invalideur est : 'id_forum/a23')
-	insere_invalideur($infosurpage['id_forum'],'id_forum', $fichier);
+	insere_invalideur($invalideurs['id_forum'], 'id_forum', $fichier);
 
-	// invalidation des petitions (l'invalideur est : 'petition/petition')
-	insere_invalideur($infosurpage['petition'],'petition', $fichier);
+	// invalidation des petitions et autres
+	// (l'invalideur est par exemple : 'varia/petition')
+	insere_invalideur($invalideurs['varia'], 'varia', $fichier);
 
 	// invalidation du reste - experimental a activer dans mes_options
 	if ($GLOBALS['invalider_caches']) {
-		insere_invalideur($infosurpage['id_article'],'id_article', $fichier);
-		insere_invalideur($infosurpage['id_breve'], 'id_breve', $fichier);
-		insere_invalideur($infosurpage['id_rubrique'],'id_rubrique', $fichier);
-		insere_invalideur($infosurpage['id_syndic'],'id_syndic', $fichier);
+		insere_invalideur($invalideurs['id_article'],'id_article', $fichier);
+		insere_invalideur($invalideurs['id_breve'], 'id_breve', $fichier);
+		insere_invalideur($invalideurs['id_rubrique'],'id_rubrique', $fichier);
+		insere_invalideur($invalideurs['id_syndic'],'id_syndic', $fichier);
 	}
 }
 
@@ -38,12 +60,11 @@
 		$values = array();
 		foreach($a as $k =&gt; $v)
 			$values[] = &quot;('$fichier', '$type/$k')&quot;;
-			$query = &quot;INSERT IGNORE INTO spip_caches&quot; .
-		&quot; (fichier, id) VALUES &quot; . join(&quot;, &quot;, $values);
-		spip_query($query);
-		# spip_log(&quot;Dependances $type: &quot; . join(&quot;, &quot;, $values));
+		spip_query (&quot;INSERT IGNORE INTO spip_caches
+			(fichier, id) VALUES &quot; . join(&quot;, &quot;, $values));
 	}
 }
+
 
 //
 // Invalider les caches lies a telle condition

Index: info.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/info.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- info.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ info.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 if (_FILE_CONNECT) {
 	include_ecrire (&quot;inc_auth.php3&quot;);

Index: win_png.htc
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/win_png.htc,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- win_png.htc	13 Jan 2005 15:37:16 -0000	1.1
+++ win_png.htc	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,47 +1,47 @@
-&lt;public:component&gt;
-&lt;public:attach event=&quot;onpropertychange&quot; onevent=&quot;propertyChanged()&quot; /&gt;
-&lt;script&gt;
-
-var supported = /MSIE (5\.5)|[6789]/.test(navigator.userAgent) &amp;&amp; navigator.platform == &quot;Win32&quot;;
-var realSrc;
-var blankSrc = &quot;img_pack/rien.gif&quot;;
-
-if (supported) fixImage();
-
-function propertyChanged() {
-   if (!supported) return;
-   
-   var pName = event.propertyName;
-   if (pName != &quot;src&quot;) return;
-   // if not set to blank
-   if ( ! new RegExp(blankSrc).test(src))
-      fixImage();
-};
-
-function fixImage() {
-   // get src
-   var src = element.src;
-
-   // check for real change
-   if (src == realSrc) {
-      element.src = blankSrc;
-      return;
-   }
-
-   if ( ! new RegExp(blankSrc).test(src)) {
-      // backup old src
-      realSrc = src;
-   }
-   
-   // test for png
-   if ( /\.png$/.test( realSrc.toLowerCase() ) ) {
-      // set blank image
-      element.src = blankSrc;
-      // set filter
-      element.runtimeStyle.filter = &quot;progid:DXImageTransform.Microsoft.AlphaImageLoader(src='&quot; +
-                                     src + &quot;',sizingMethod='scale')&quot;;
-   }
-}
-
-&lt;/script&gt;
+&lt;public:component&gt;
+&lt;public:attach event=&quot;onpropertychange&quot; onevent=&quot;propertyChanged()&quot; /&gt;
+&lt;script&gt;
+
+var supported = /MSIE (5\.5)|[6789]/.test(navigator.userAgent) &amp;&amp; navigator.platform == &quot;Win32&quot;;
+var realSrc;
+var blankSrc = &quot;img_pack/rien.gif&quot;;
+
+if (supported) fixImage();
+
+function propertyChanged() {
+   if (!supported) return;
+   
+   var pName = event.propertyName;
+   if (pName != &quot;src&quot;) return;
+   // if not set to blank
+   if ( ! new RegExp(blankSrc).test(src))
+      fixImage();
+};
+
+function fixImage() {
+   // get src
+   var src = element.src;
+
+   // check for real change
+   if (src == realSrc) {
+      element.src = blankSrc;
+      return;
+   }
+
+   if ( ! new RegExp(blankSrc).test(src)) {
+      // backup old src
+      realSrc = src;
+   }
+   
+   // test for png
+   if ( /\.png$/.test( realSrc.toLowerCase() ) ) {
+      // set blank image
+      element.src = blankSrc;
+      // set filter
+      element.runtimeStyle.filter = &quot;progid:DXImageTransform.Microsoft.AlphaImageLoader(src='&quot; +
+                                     src + &quot;',sizingMethod='scale')&quot;;
+   }
+}
+
+&lt;/script&gt;
 &lt;/public:component&gt;

Index: mots_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/mots_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- mots_edit.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ mots_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_logos.php3&quot;);
 include_ecrire (&quot;inc_sites.php3&quot;);
@@ -28,7 +39,7 @@
 
 	if ($titre_mot) {
 		if ($new == 'oui' &amp;&amp; $id_groupe) {
-		  $id_mot = spip_abstract_insert(&quot;mots&quot;, '(id_groupe)', &quot;($id_groupe)&quot;);
+		  $id_mot = spip_abstract_insert(&quot;spip_mots&quot;, '(id_groupe)', &quot;($id_groupe)&quot;);
 
 
 			// ajouter le mot a l'article
@@ -122,11 +133,9 @@
 // Logos du mot-clef
 //
 
-$arton = &quot;moton$id_mot&quot;;
-$artoff = &quot;motoff$id_mot&quot;;
-
 if ($id_mot &gt; 0 AND $connect_statut == '0minirezo')
-	afficher_boite_logo($arton, $artoff, _T('logo_mot_cle').aide(&quot;breveslogo&quot;), _T('logo_survol'));
+	afficher_boite_logo('mot', 'id_mot', $id_mot,
+	_T('logo_mot_cle').aide(&quot;breveslogo&quot;), _T('logo_survol'));
 
 
 //
@@ -246,7 +255,7 @@
 		$row_groupes = spip_fetch_array($result);
 		if (!$row_groupes) {
 			// il faut creer un groupe de mots (cas d'un mot cree depuis articles.php3)
-		  $row_groupes['id_groupe'] = spip_abstract_insert(&quot;groupes_mots&quot;,
+		  $row_groupes['id_groupe'] = spip_abstract_insert(&quot;spip_groupes_mots&quot;,
 							  &quot;(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)&quot;,
 							  &quot;('&quot; .
 							  addslashes(_T('info_mot_sans_groupe')).&quot;', 'non',  'non', 'oui', 'oui', 'non', 'oui', 'oui', 'non', 'non'&quot;);

Index: pclzip.lib.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/pclzip.lib.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- pclzip.lib.php	13 Jan 2005 15:37:16 -0000	1.1
+++ pclzip.lib.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,9939 +1,4970 @@
 &lt;?php
-
 // --------------------------------------------------------------------------------
-
 // PhpConcept Library - Zip Module 2.1
-
 // --------------------------------------------------------------------------------
-
 // License GNU/LGPL - Vincent Blavet - December 2003
-
 // <A HREF="http://www.phpconcept.net">http://www.phpconcept.net</A>
[...9909 lines suppressed...]
-
       // ----- Change potential windows directory separator
-
       if ((strpos($p_path, '\\') &gt; 0) || (substr($p_path, 0,1) == '\\')) {
-
           $p_path = strtr($p_path, '\\', '/');
-
       }
-
     }
-
     return $p_path;
-
   }
-
   // --------------------------------------------------------------------------------
-
-
 
 ?&gt;

Index: layer.js
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/layer.js,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- layer.js	13 Jan 2005 15:37:16 -0000	1.1
+++ layer.js	20 Feb 2005 22:19:26 -0000	1.2
@@ -38,15 +38,15 @@
 		}
 	}
 
-function swap_couche(couche, rtl, dir) {
+function swap_couche(couche, rtl, dir, no_swap) {
 	triangle = findObj('triangle' + couche);
 	if (!(layer = findObj('Layer' + couche))) return;
 	if (vis[couche] == 'hide'){
-		if (triangle) triangle.src = dir + 'deplierbas.gif';
+		if (!no_swap &amp;&amp; triangle) triangle.src = dir + 'deplierbas.gif';
 		layer.style.display = 'block';
 		vis[couche] = 'show';
 	} else {
-		if (triangle) triangle.src = dir + 'deplierhaut' + rtl + '.gif';
+		if (!no_swap &amp;&amp; triangle) triangle.src = dir + 'deplierhaut' + rtl + '.gif';
 		layer.style.display = 'none';
 		vis[couche] = 'hide';
 	}
@@ -75,4 +75,17 @@
 			fermer_couche(j,rtl, dir);
 		}
 	}
+}
+
+function acceder_couche(couches, n, dir, icone, texte, sens) {
+	  javasc = ''
+	  for (j=0; j&lt;couches.length; j+=1)
+	  	javasc += 'swap_couche(' + couches[j][0] + &quot;, '&quot; + sens + &quot;','&quot; + dir + &quot;', &quot; + couches[j][1] + &quot;);&quot;;
+	  
+	document.write('&lt;a class=&quot;triangle_block&quot; href=&quot;javascript:' +
+	    javasc +
+	    '&quot;&gt;&lt;img name=&quot;triangle' + n + '&quot; src=&quot;' +
+	    dir + icone + '&quot; alt=&quot;&quot; title=&quot;' +
+	    texte +
+	    '&quot; width=&quot;10&quot; height=&quot;10&quot; border=&quot;0&quot;&gt;&lt;/a&gt;');
 }

Index: statistiques.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/statistiques.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- statistiques.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ statistiques.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 

Index: auteur_infos.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteur_infos.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- auteur_infos.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ auteur_infos.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_acces.php3&quot;);
 include_ecrire (&quot;inc_logos.php3&quot;);
@@ -167,7 +178,8 @@
 		$alea_futur = creer_uniqid();
 		$pass = md5($alea_actuel.$new_pass);
 		$query_pass = &quot; pass='$pass', htpass='$htpass', alea_actuel='$alea_actuel', alea_futur='$alea_futur', &quot;;
-		effacer_low_sec($auteur['id_auteur']);
+		if ($auteur['id_auteur'])
+		  effacer_low_sec($auteur['id_auteur']);
 	} else
 		$query_pass = '';
 
@@ -182,7 +194,7 @@
 	// l'entrer dans la base
 	if (!$echec) {
 		if (!$auteur['id_auteur']) { // creation si pas d'id
-		  $auteur['id_auteur'] = spip_abstract_insert(&quot;auteurs&quot;, &quot;(nom)&quot;, &quot;('temp')&quot;);
+		  $auteur['id_auteur'] = spip_abstract_insert(&quot;spip_auteurs&quot;, &quot;(nom)&quot;, &quot;('temp')&quot;);
 
 			$id_auteur = $auteur['id_auteur'];
 
@@ -434,7 +446,7 @@
 	if (($statut == '6forum') OR (lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo'))
 		echo &quot;&lt;OPTION&quot;.mySel(&quot;6forum&quot;,$statut).&quot;&gt;&quot;._T('item_visiteur');
 	echo &quot;&lt;OPTION&quot;.mySel(&quot;5poubelle&quot;,$statut).
-	  &quot; style='background:url(&quot; . _DIR_RESTREINT . &quot;rayures-sup.gif)'&gt;&gt; &quot;._T('texte_statut_poubelle');
+	  &quot; style='background:url(&quot; . _DIR_IMG_PACK . &quot;rayures-sup.gif)'&gt;&gt; &quot;._T('texte_statut_poubelle');
 
 	echo &quot;&lt;/SELECT&gt;&lt;/center&gt;\n&quot;;
 	fin_cadre_relief();

Index: inc_debug_sql.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_debug_sql.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_debug_sql.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_debug_sql.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_INC_DEBUG_SQL&quot;)) return;
@@ -10,23 +21,22 @@
 // ajouter &amp;var_mode=debug pour voir les erreurs et en parler sur <A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">spip at rezo.net</A>
 function affiche_erreurs_page($tableau_des_erreurs) {
 
-	echo &quot;&lt;div id='spip-debug' style='position: absolute; top: 20;&quot;,
-	&quot; z-index: 1000;'&gt;&lt;ul&gt;&lt;li&gt;&quot;,
-	_L(&quot;Erreur(s) dans le squelette&quot;),
-
+	$GLOBALS['bouton_admin_debug'] = true;
+	$res = '';
+	foreach ($tableau_des_erreurs as $err) {
+		$res .= &quot;&lt;li&gt;&quot; .$err[0] . &quot;, &lt;small&gt;&quot;.$err[1].&quot;&lt;/small&gt;&lt;br /&gt;&lt;/li&gt;\n&quot;;
+	}
+	return &quot;&lt;div id='spip-debug' style='&quot;
+	. &quot;position: absolute; top: 20px; left: 20px; z-index: 1000;&quot;
+	. &quot;'&gt;&lt;ul&gt;&lt;li&gt;&quot;
+	. _T('zbug_erreur_squelette')
 ## aide locale courte a ecrire, avec lien vers une grosse page de documentation
 #		aide('erreur_compilation'),
+	. &quot;&lt;br /&gt;&lt;/li&gt;&quot;
+	. &quot;&lt;ul&gt;&quot;
+	. $res
+	. &quot;&lt;/ul&gt;&lt;/ul&gt;&lt;/div&gt;&quot;;
 
-	&quot;&lt;br /&gt;&lt;/li&gt;&quot;,
-	&quot;&lt;ul&gt;&quot;;
-	foreach ($tableau_des_erreurs as $err) {
-		echo &quot;&lt;li&gt;&quot;.$err[0],
-		&quot;, &lt;small&gt;&quot;.$err[1].&quot;&lt;/small&gt;&lt;br /&gt;&quot;,
-		&quot;&lt;/li&gt;\n&quot;;
-	}
-	echo &quot;&lt;/ul&gt;&quot;;
-	echo &quot;&lt;/ul&gt;&lt;/div&gt;&quot;;
-	$GLOBALS['bouton_admin_debug'] = true;
 }
 
 //
@@ -36,7 +46,7 @@
 function erreur_requete_boucle($query, $id_boucle, $type) {
 
 	// Calmer le jeu avec MySQL (si jamais on est en saturation)
-	@touch(_FILE_MYSQL_OUT);	// pour spip_cron
+	spip_touch(_FILE_MYSQL_OUT); // pour spip_cron
 	spip_log('Erreur MySQL: on limite les acces quelques minutes');
 	$GLOBALS['bouton_admin_debug'] = true;
 
@@ -93,11 +103,12 @@
 	$tableau_des_erreurs[] = array($message, $lieu);
 	// Eviter les boucles infernales
 	if (++$runs &gt; 4) {
-		if ($HTTP_COOKIE_VARS['spip_admin'] OR
+		if ($_COOKIE['spip_admin'] OR
 		$auteur_session['statut'] == '0minirezo' OR
 		    ($GLOBALS['var_mode'] == 'debug')) {
-			echo debut_entete('Debug'), '&lt;/head&gt;&lt;body&gt;';
-			die(affiche_erreurs_page($tableau_des_erreurs));
+			echo debut_entete(_T('admin_debug')), '&lt;/head&gt;&lt;body&gt;',
+				affiche_erreurs_page($tableau_des_erreurs);
+			exit;
 		}
 	}
 }
@@ -166,15 +177,15 @@
 // - ca fait 2 headers !
 	ob_end_clean();
 
-	echo debut_entete('Debug'), 
+	echo debut_entete('Spip ' . _T('admin_debug')), 
 	  &quot;&lt;link rel='stylesheet' href='spip_admin.css' type='text/css' /&gt;&quot;,
 	  &quot;&lt;/head&gt;\n&lt;body&gt;&quot;,
-	  &quot;&lt;div id='spip-debug' style='position: absolute; top: 20; z-index: 1000;'&gt;&lt;ul&gt;\n&quot;; 
+	  &quot;&lt;div id='spip-debug' style='position: absolute; top: 20px; z-index: 1000;'&gt;&lt;ul&gt;\n&quot;; 
 
 	foreach ($debug_objets['sourcefile'] as $nom_skel =&gt; $sourcefile) {
 		echo &quot;&lt;li&gt;&lt;b&gt;&quot;,$sourcefile,&quot;&lt;/b&gt;&quot;;
-		echo &quot; &lt;a href='&quot;,$self, &quot;&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=resultat'&gt;resultat&lt;/a&gt;&quot;;
-		echo &quot; &lt;a href='&quot;, $self, &quot;&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=code'&gt;code&lt;/a&gt;&quot;;
+		echo &quot; &lt;a href='&quot;,$self, &quot;&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=resultat'&gt;&quot;._T('zbug_resultat').&quot;&lt;/a&gt;&quot;;
+		echo &quot; &lt;a href='&quot;, $self, &quot;&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=code'&gt;&quot;._T('zbug_code').&quot;&lt;/a&gt;&quot;;
 		echo &quot;&lt;table width='100%'&gt;\n&quot;;
 		$i = 0;
 		$colors = array('#c0c0c0', '#c0cad4');
@@ -185,7 +196,7 @@
 				$aff = &quot;&lt;&quot;.$pretty.&quot;&gt;&quot;;
 				if ($var_mode_objet == $nom)
 					$aff = &quot;&lt;b&gt;$aff&lt;/b&gt;&quot;;
-				echo &quot;&lt;tr bgcolor='&quot; . $colors[$i%2] . &quot;'&gt;&lt;td  align='right'&gt;$i&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;,$self,&quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=boucle' class='debug_link_boucle'&gt;boucle&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;,$self, &quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=resultat' class='debug_link_resultat'&gt;resultat&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;, $self, &quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=code' class='debug_link_code'&gt;code&lt;/a&gt;&lt;/td&gt;&lt;td&gt;$aff&lt;/td&gt;&lt;/tr&gt;&quot;;
+				echo &quot;&lt;tr bgcolor='&quot; . $colors[$i%2] . &quot;'&gt;&lt;td  align='right'&gt;$i&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;,$self,&quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=boucle' class='debug_link_boucle'&gt;&quot;._T('zbug_boucle').&quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;,$self, &quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=resultat' class='debug_link_resultat'&gt;&quot;._T('zbug_resultat').&quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;, $self, &quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=code' class='debug_link_code'&gt;&quot;._T('zbug_code').&quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;$aff&lt;/td&gt;&lt;/tr&gt;&quot;;
 			}
 		echo &quot;&lt;/table&gt;\n&lt;/li&gt;\n&quot;;
 	}
@@ -194,7 +205,7 @@
 	  if ($var_mode_affiche == 'resultat') {
 		echo &quot;&lt;div id=\&quot;debug_boucle\&quot;&gt;&lt;fieldset&gt;&lt;legend&gt;&quot;,$debug_objets['pretty'][$var_mode_objet],&quot;&lt;/legend&gt;&quot;;
 		highlight_string($debug_objets['requete'][$var_mode_objet]);
-		echo &quot;&lt;p class='spip-admin-bloc'&gt;les premiers appels &agrave; cette boucle ont donn&eacute;&nbsp;:&lt;/p&gt;&quot;;
+#		echo &quot;&lt;p class='spip-admin-bloc'&gt;les premiers appels &agrave; cette boucle ont donn&eacute;&nbsp;:&lt;/p&gt;&quot;;
 		foreach ($res as $view) 
 			if ($res) echo &quot;&lt;br&gt;&lt;fieldset&gt;&quot;,interdire_scripts($view),&quot;&lt;/fieldset&gt;&quot;;
 		echo &quot;&lt;/fieldset&gt;&lt;/div&gt;&quot;;
@@ -230,7 +241,9 @@
 	  echo &quot;&lt;/fieldset&gt;&lt;/div&gt;&quot;;
 	}
 	echo &quot;\n&lt;/div&gt;&quot;;
-	echo inclure_balise_dynamique(balise_formulaire_admin_dyn('','','','','',$debug_objets));
+	echo inclure_balise_dynamique(
+		balise_FORMULAIRE_ADMIN_dyn('div', $debug_objets)
+	);
 	echo '&lt;/body&gt;&lt;/html&gt;';
 	exit;
 }

Index: rubriques_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/rubriques_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- rubriques_edit.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ rubriques_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 
@@ -62,7 +73,7 @@
 			if (lire_meta('multi_rubriques') == 'oui' AND $langue_choisie_rub == &quot;oui&quot;) $titre = $titre.&quot; [&quot;.traduire_nom_langue($lang_rub).&quot;]&quot;;
 
 			$selec_rub = &quot;selec_rub&quot;;
-			if ($browser_name == &quot;MSIE&quot; AND $browser_version == &quot;5.0b1&quot;) $selec_rub = &quot;&quot;; // Bug de MSIE MacOs 9.0
+			if ($browser_name == &quot;MSIE&quot; AND floor($browser_version) == &quot;5&quot;) $selec_rub = &quot;&quot;; // Bug de MSIE MacOs 9.0
 
 			if (acces_rubrique($my_rubrique)) {
 				echo &quot;&lt;option&quot;.mySel($my_rubrique,$id_parent).&quot; class='$selec_rub' style=\&quot;$style\&quot;&gt;$espace&quot;.supprimer_tags($titre).&quot;\n&quot;;

Index: articles_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles_edit.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ articles_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,15 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_documents.php3&quot;);
 include_ecrire (&quot;inc_barre.php3&quot;);
@@ -135,26 +145,6 @@
 	die (&quot;&lt;H3&gt;&quot;._T('info_acces_interdit').&quot;&lt;/H3&gt;&quot;);
 }
 
-if ($id_article &amp;&amp; $id_document) {
-	$query_doc = &quot;SELECT * FROM spip_documents_articles WHERE id_document=$id_document AND id_article=$id_article&quot;;
-	$result_doc = spip_query($query_doc);
-	$flag_document_editable = (spip_num_rows($result_doc) &gt; 0);
-} else {
-	$flag_document_editable = false;
-}
-
-$modif_document = $GLOBALS['modif_document'];
-if ($modif_document == 'oui' AND $flag_document_editable) {
-	$titre_document = addslashes(corriger_caracteres($titre_document));
-	$descriptif_document = addslashes(corriger_caracteres($descriptif_document));
-	$query = &quot;UPDATE spip_documents SET titre='$titre_document', descriptif='$descriptif_document'&quot;;
-	if ($largeur_document AND $hauteur_document) $query .= &quot;, largeur='$largeur_document', hauteur='$hauteur_document'&quot;;
-	$query .= &quot; WHERE id_document=$id_document&quot;;
-	spip_query($query);
-}
-
-
-
 
 //
 // Gestion des textes trop longs (limitation brouteurs)
@@ -201,16 +191,18 @@
 //
 
 if ($new != 'oui'){
+	# modifs de la description d'un des docs joints
+	if ($flag_editable) maj_documents($id_article, 'article');
+
+	# affichage
 	afficher_documents_colonne($id_article, 'article', $flag_editable);
 ///////////////////////////
 //MODIFICATION
 ///////////////////////////
-	if (lire_meta('activer_forms') == 'oui'){
-		include_ecrire (&quot;inc_forms.php3&quot;);
-		afficher_insertion_formulaire($id_article);
-	}
+	creer_colonne_droite();
 	if (lire_meta('activer_carto') == 'oui'){
-		//include_ecrire (&quot;inc_carto.php3&quot;);
+		//on l'a deja ?
+		include_ecrire (&quot;inc_carto.php3&quot;);
 		afficher_insertion_carte($id_article);
 	}
 ////////////////////////////
@@ -338,7 +330,7 @@
 		}
 
 			$selec_rub = &quot;selec_rub&quot;;
-			if ($browser_name == &quot;MSIE&quot; AND $browser_version == &quot;5.0b1&quot;) $selec_rub = &quot;&quot;; // Bug de MSIE MacOs 9.0
+			if ($browser_name == &quot;MSIE&quot; AND floor($browser_version) == &quot;5&quot;) $selec_rub = &quot;&quot;; // Bug de MSIE MacOs 9.0
 
 		if ($rubrique_acceptable) {
 			if ($i == 1 &amp;&amp; !$premier) echo &quot;&lt;option value='$my_rubrique'&gt;\n&quot;; // sert a separer les secteurs

Index: articles_ortho.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/articles_ortho.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles_ortho.php	13 Jan 2005 15:37:16 -0000	1.1
+++ articles_ortho.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include(&quot;inc_lab.php&quot;);
 
 include_spip(&quot;ecrire.php&quot;);

Index: inc_carto.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_carto.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_carto.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_carto.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -4,11 +4,31 @@
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_CARTE&quot;)) return;
 define(&quot;_ECRIRE_INC_CARTE&quot;, &quot;1&quot;);
-
-function embed_map_url($id_carte, $url_parse) {
+function coords2wtk($selection_type,$selection_coords){
+	
+	return $selection_type.&quot;(&quot;.$selection_coords.&quot;)&quot;;
+}
+function wtktoarray($callage){	
+	$curseur=strpos($callage,&quot;(&quot;);
+	$tabcallage['shape']=substr($callage,0,$curseur);
+	$curseur2=strpos($callage,&quot;,&quot;);
+	$tabcallage['top_left']['x']=substr($callage,$curseur+1,$curseur2-$curseur-1);
+	$curseur=strpos($callage,&quot;;&quot;);
+	$tabcallage['top_left']['y']=substr($callage,$curseur2+1,$curseur-$curseur2-1);
+	$curseur2=strrpos($callage,&quot;,&quot;);
+	$tabcallage['bottom_right']['x']=substr($callage,$curseur+1,$curseur2-$curseur-1);
+	$curseur=strpos($callage,&quot;)&quot;);
+	$tabcallage['bottom_right']['y']=substr($callage,$curseur2+1,$curseur-$curseur2-1);
+	return $tabcallage;
+}
+function embed_carto_url($id_carte, $url_parse) {
 	$lURL = $url_parse['path'].&quot;/carto.php3?id_carte=&quot;.$id_carte.&quot;&amp;scale=&quot;.$_GET['scale'].&quot;&amp;x=&quot;.$_GET['x'].&quot;&amp;y=&quot;.$_GET['y'];
 	return $lURL;
 }
+function embed_fond_carte_url($fond_carte) {
+	$lURL = &quot;../spip_carto.php?fond_carte=&quot;.$fond_carte.&quot;&amp;scale=&quot;.$_GET['scale'].&quot;&amp;x=&quot;.$_GET['x'].&quot;&amp;y=&quot;.$_GET['y'];
+	return $lURL;
+}
 
 function afficher_cartes($titre_table, $requete, $icone = '') {
 	global $couleur_claire, $couleur_foncee;
@@ -32,14 +52,13 @@
 		$premier = true;
 		
 		$compteur_liste = 0;
-		while ($row = spip_fetch_array($result)) {
-			$vals = '';
-			$id_carte= $row['id_carte'];
+
+		echo &quot;&lt;table width='100%' cellpadding='3' cellspacing='0' border='0'&gt;&quot;;
+			while ($row = spip_fetch_array($result)) {
+			$id_carte= $row['id_carto_carte'];
 			$objets= $row['objets'];
 			$titre = $row['titre'];
 			
-			$tous_id[] = $id_carte;
-
 			$link = new Link(&quot;carte_edit.php3&quot;);
 			$link-&gt;addVar(&quot;id_carte&quot;, $id_carte);
 			$link-&gt;addVar(&quot;retour&quot;, $GLOBALS['clean_link']-&gt;getUrl());
@@ -50,39 +69,41 @@
 				$puce = 'puce-orange-breve.gif';
 			}
 
-			$s = &quot;&lt;a href=\&quot;&quot;.$link-&gt;getUrl().&quot;\&quot;&gt;&quot;;
-			$s .= &quot;&lt;img src='img_pack/$puce' width='7' height='7' border='0'&gt;&nbsp;&nbsp;&quot;;
-			$s .= typo($titre);
-			$s .= &quot;&lt;/a&gt; &nbsp;&nbsp;&quot;;
-			$vals[] = $s;
+			echo &quot;&lt;tr class='tr_liste'&gt;&lt;td class=\&quot;arial11\&quot;&gt;&quot;;
+			echo &quot;&lt;a href=\&quot;&quot;.$link-&gt;getUrl().&quot;\&quot;&gt;&quot;;
+			echo  &quot;&lt;img src='img_pack/$puce' width='7' height='7' border='0'&gt;&nbsp;&nbsp;&quot;;
+			echo  typo($titre);
+			echo &quot;&lt;/a&gt;&lt;br/&gt;&quot;;
 			
-			$s = &quot;&quot;;
-			$vals[] = $s;
-
-			$s = &quot;&quot;;
-			if ($reponses) {
-				$s .= $reponses.&quot; &quot;._L(&quot;r&eacute;ponses&quot;);
-			}
-			$vals[] = $s;
-			$table[] = $vals;
+			//articles li&#233;s
+			afficher_articles(_L(&quot;Articles utilisant cette carte&quot;),
+				&quot;, spip_carto_cartes_articles AS lien WHERE lien.id_article=articles.id_article &quot;.
+				&quot;AND id_carto_carte=$id_carte AND statut!='poubelle' ORDER BY titre&quot;);
+			
+			echo &quot;&lt;/a&gt;&lt;br/&gt;&lt;td&gt;&lt;/tr&gt;&quot;;
+				
 		}
 		spip_free_result($result);
 		
-		$largeurs = array('','','');
-		$styles = array('arial11', 'arial1', 'arial1');
-		afficher_liste($largeurs, $table, $styles);
 		echo &quot;&lt;/table&gt;&quot;;
 		echo &quot;&lt;/div&gt;\n&quot;;
 	}
 	return $tous_id;
 }
 
-function afficher_carte_inteface($fichier,$id_carte,$width,$height) {
+
+function afficher_carte_inteface($id_carte,$retour,$fichier,$callage) {
+	$width=$callage['bottom_right']['x']-$callage['top_left']['x'];
+	$height=$callage['bottom_right']['y']-$callage['top_left']['y'];
 	$returned='&lt;script type=&quot;text/javascript&quot; src=&quot;js/x_core_nn4.js&quot;&gt;&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;js/x_dom_nn4.js&quot;&gt;&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;js/x_event_nn4.js&quot;&gt;&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;js/navTools.js&quot;&gt;&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;js/graphTools.js&quot;&gt;&lt;/script&gt;
+&lt;form method=&quot;get&quot; action=&quot;#nouveau_objet&quot; name=&quot;carto_form&quot;&gt;
+ &lt;table border=&quot;1&quot;&gt;
+  &lt;tr&gt; 
+   &lt;td colspan=&quot;7&quot;&gt;
 &lt;script type=&quot;text/javascript&quot;&gt;
 /*&lt;![CDATA[*/ 
     var dhtmlDivs = new String();
@@ -126,7 +147,7 @@
       
       // map units values
 	  // dynamically given by the server
-      dhtmlBox.mapHeight = 300;
+      dhtmlBox.mapHeight = '.$height.';
       dhtmlBox.boxx = 470000;
       dhtmlBox.boxy = 46300;
       dhtmlBox.pixel_size = 924.83333333334;
@@ -146,37 +167,50 @@
     }
 	/*]]&gt;*/
   &lt;/script&gt;
-&lt;form method=&quot;get&quot; action=&quot;#&quot; name=&quot;carto_form&quot;&gt;
-  &lt;table&gt;
-    &lt;tr&gt; 
-      &lt;td&gt; &lt;input type=&quot;hidden&quot; name=&quot;id_carte&quot; value=&quot;'.$id_carte.'&quot;/&gt; &lt;input type=&quot;hidden&quot; name=&quot;selection_type&quot; /&gt; &lt;input type=&quot;hidden&quot; name=&quot;selection_coords&quot; /&gt; 
-        &lt;div id=&quot;mapAnchorDiv&quot; style=&quot;position:relative; width:'.$width.'px; height:'.$height.'px;&quot;&gt; 
-          &lt;table&gt;
-            &lt;tr&gt; 
-              &lt;td align=&quot;center&quot; valign=&quot;middle&quot; width=&quot;'.$width.'px&quot; height=&quot;'.$height.'px&quot;&gt;&lt;div id=&quot;loadbar&quot;&gt;Loading 
-                  message&lt;/div&gt;&lt;/td&gt;
-            &lt;/tr&gt;
-          &lt;/table&gt;
-        &lt;/div&gt;&lt;/td&gt;
-      &lt;td&gt; &lt;p&gt; 
-          &lt;!-- input value use : shapeType,action,cursorStyle,toolName (with no blank spaces!)--&gt;
-          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;rectangle,submit,crossHair,zoom_in&quot;  checked=&quot;checked&quot;  id=&quot;zoom_in&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;id_carte&quot; value=&quot;'.$id_carte.'&quot;/&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;retour&quot; value=&quot;'.$retour.'&quot;/&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;selection_type&quot; /&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;selection_coords&quot; /&gt;
+	&lt;div id=&quot;mapAnchorDiv&quot; style=&quot;position:relative; width:'.$width.'px; height:'.$height.'px;&quot;&gt; 
+     &lt;table&gt;
+      &lt;tr&gt; 
+       &lt;td align=&quot;center&quot; valign=&quot;middle&quot; width=&quot;'.$width.'px&quot; height=&quot;'.$height.'px&quot;&gt;
+		&lt;div id=&quot;loadbar&quot;&gt;Loading message&lt;/div&gt;
+	   &lt;/td&gt;
+      &lt;/tr&gt;
+     &lt;/table&gt;
+    &lt;/div&gt;
+   &lt;/td&gt;
+  &lt;/tr&gt;
+  &lt;tr&gt;
+   &lt;td&gt; 
+    &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;rectangle,submit,crossHair,zoom_in&quot;  id=&quot;zoom_in&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
           zoom_in&lt;br /&gt;
-          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;point,submit,crossHair,zoom_out&quot;  id=&quot;zoom_out&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
+   &lt;/td&gt;
+   &lt;td&gt;
+    &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;point,submit,crossHair,zoom_out&quot;  id=&quot;zoom_out&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
           zoom out&lt;br /&gt;
-          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;pan,submit,move,pan&quot;  id=&quot;pan&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
+   &lt;/td&gt;
+   &lt;td&gt;
+    &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;pan,submit,move,pan&quot;  id=&quot;pan&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
           pan&lt;br /&gt;
-          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;rectangle,submit,help,query&quot;  id=&quot;query&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
+   &lt;/td&gt;
+   &lt;td&gt;
+    &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;rectangle,submit,help,query&quot;  id=&quot;query&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
           query&lt;br /&gt;
-          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;point,submit,crossHair,point&quot;   id=&quot;point&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
+   &lt;/td&gt;
+   &lt;td&gt;
+    &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;point,submit,crossHair,point&quot;   id=&quot;point&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
           line submit&lt;br /&gt;
-          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;line,submit,crossHair,line&quot;   id=&quot;line&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
+   &lt;/td&gt;
+   &lt;td&gt;
+    &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;line,submit,crossHair,line&quot;   id=&quot;line&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
           line submit&lt;br /&gt;
-          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;polygon,submit,crossHair,polygon&quot;   id=&quot;toto&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
+          &lt;/td&gt;&lt;td&gt;&lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;polygon,submit,crossHair,polygon&quot;   checked=&quot;checked&quot;  id=&quot;polygon&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
           polygon submit&lt;br /&gt;
-        &lt;/p&gt;&lt;/td&gt;
-    &lt;/tr&gt;
-  &lt;/table&gt;
+   &lt;/td&gt;
+  &lt;/tr&gt;
+ &lt;/table&gt;
 &lt;/form&gt;';
 	return $returned;
 }
@@ -213,14 +247,14 @@
 		&quot;de l'article.&quot;);
 	echo &quot;&lt;/div&gt;&quot;;
 
-	$query = &quot;SELECT id_carte, titre FROM spip_carto_carte ORDER BY titre&quot;;
+	$query = &quot;SELECT id_carto_carte, titre FROM spip_carto_cartes ORDER BY titre&quot;;
 	$result = spip_query($query);
 	if (spip_num_rows($result)) {
 		echo &quot;&lt;br /&gt;\n&quot;;
 		echo &quot;&lt;div class='bandeau_rubriques' style='z-index: 1;'&gt;&quot;;
 		echo &quot;&lt;div class='plan-articles'&gt;&quot;;
 		while ($row = spip_fetch_array($result)) {
-			$id_carte = $row['id_carte'];
+			$id_carte = $row['id_carto_carte'];
 			$titre = typo($row['titre']);
 			
 			$link = new Link(&quot;carte_edit.php3&quot;);
@@ -231,7 +265,13 @@
 			echo &quot;&lt;div class='arial1' align='$spip_lang_right' style='color: black; padding-$spip_lang_left: 4px;' &quot;.
 				&quot;title=\&quot;&quot;._L(&quot;Recopiez ce raccourci dans le texte de l'article pour ins&eacute;rer ce formulaire.&quot;).
 				&quot;\&quot;&gt;&quot;;
-			echo &quot;&lt;font color='333333'&gt;&lt;div align='left'&gt;&lt;map$id_carte|left&gt;&lt;/div&gt;&lt;div align='center'&gt;&lt;map$id_carte|center&gt;&lt;/div&gt;&lt;div align='right'&gt;&lt;map$id_carte|right&gt;&lt;/div&gt;&lt;/font&gt;\n&quot;;
+			echo &quot;&lt;font color='333333'&gt;&quot;;
+			echo &quot;&lt;div align='right'&gt;Simple map : &lt;map$id_carte&gt;&lt;/div&gt;&quot;;
+			echo &quot;&lt;div align='right'&gt;Avec logo : &lt;map$id_carte|logo&gt;&lt;/div&gt;&quot;;
+			echo &quot;&lt;div align='right'&gt;Avec lien : &lt;map$id_carte|lien&gt;&lt;/div&gt;&quot;;
+//			echo &quot;&lt;div align='right'&gt;Avec logo survol : &lt;map$id_carte|logox&gt;&lt;/div&gt;&quot;;
+//			echo &quot;&lt;div align='right'&gt;Objet SVG : &lt;map$id_carte|svg&gt;&lt;/div&gt;&quot;;
+			echo &quot;&lt;/font&gt;\n&quot;;
 			echo &quot;&lt;/div&gt;&quot;;
 		}
 		echo &quot;&lt;/div&gt;&quot;;

Index: breves_voir.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/breves_voir.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- breves_voir.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ breves_voir.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_logos.php3&quot;);
 include_ecrire (&quot;inc_mots.php3&quot;);
@@ -49,7 +60,7 @@
 	}
 }
 
-function afficher_jour($jour){
+function afficher_jour($jour) {
 	my_sel(&quot;00&quot;,_T('jour_non_connu_nc'),$jour);
 	for($i=1;$i&lt;32;$i++){
 		if ($i&lt;10){$aff=&quot;&nbsp;&quot;.$i;}else{$aff=$i;}
@@ -67,12 +78,15 @@
 	if (!$langue_new) $langue_new = lire_meta('langue_site');
 	$langue_choisie_new = 'non';
 
-	$id_breve = spip_abstract_insert(&quot;breves&quot;, &quot;(titre, date_heure, id_rubrique, statut, lang, langue_choisie)&quot;, 
-			      &quot;('&quot;._T('item_nouvelle_breve').&quot;', NOW(), '$id_rubrique', 'refuse', '$langue_new', '$langue_choisie_new')&quot;);
-}
-
+	$id_breve = spip_abstract_insert(&quot;spip_breves&quot;,
+		&quot;(titre, date_heure, id_rubrique, statut, lang, langue_choisie)&quot;, 
+		&quot;('&quot;._T('item_nouvelle_breve').&quot;', NOW(), '$id_rubrique', 'refuse', '$langue_new', '$langue_choisie_new')&quot;);
 
-$clean_link = new Link(&quot;breves_voir.php3?id_breve=$id_breve&quot;);
+	// Modifier le lien de base pour qu'il prenne en compte le nouvel id
+	unset($_POST['id_rubrique']);
+	$_POST['id_breve'] = $id_breve;
+	$clean_link = new Link();
+}
 
 
 if ($titre AND $modifier_breve) {
@@ -179,11 +193,9 @@
 // Logos de la breve
 //
 
-$arton = &quot;breveon$id_breve&quot;;
-$artoff = &quot;breveoff$id_breve&quot;;
-
 if ($id_breve&gt;0 AND ($connect_statut == '0minirezo' AND acces_rubrique($id_rubrique)))
-	afficher_boite_logo($arton, $artoff, _T('logo_breve').aide (&quot;breveslogo&quot;), _T('logo_survol'));
+	afficher_boite_logo('breve', 'id_breve', $id_breve,
+	_T('logo_breve').aide (&quot;breveslogo&quot;), _T('logo_survol'));
 
 debut_raccourcis();
 icone_horizontale(_T('icone_nouvelle_breve'), &quot;breves_edit.php3?new=oui&quot;, &quot;breve-24.gif&quot;,&quot;creer.gif&quot;);

Index: inc_session.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_session.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_session.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_session.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,4 +1,15 @@
 &lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_SESSION&quot;)) return;
@@ -19,8 +30,8 @@
 // On verifie l'IP et le nom du navigateur
 //
 function hash_env() {
-	global $HTTP_SERVER_VARS;
-	return md5($HTTP_SERVER_VARS['REMOTE_ADDR'] . $HTTP_SERVER_VARS['HTTP_USER_AGENT']);
+	global $_SERVER;
+	return md5($_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT']);
 }
 
 
@@ -53,7 +64,7 @@
  		fclose($f);
 	} else {
 		redirige_par_entete(lire_meta(&quot;adresse_site&quot;) .
-				    &quot;spip_test_dirs.php3&quot;);
+				    &quot;/spip_test_dirs.php3&quot;);
 	}
 }
 
@@ -133,10 +144,7 @@
 
 	$s = mt_rand();
 	if (!$s) $s = rand();
-	if ($GLOBALS['flag_uniqid2'])
-		return uniqid($s, 1);
-	else
-		return uniqid($s);
+	return uniqid($s, 1);
 }
 
 
@@ -177,14 +185,14 @@
 // reconnaitre un utilisateur authentifie en php_auth
 //
 function verifier_php_auth() {
-	global $PHP_AUTH_USER, $PHP_AUTH_PW, $ignore_auth_http;
-	if ($PHP_AUTH_USER &amp;&amp; $PHP_AUTH_PW &amp;&amp; !$ignore_auth_http) {
-		$login = addslashes($PHP_AUTH_USER);
+	global $_SERVER, $ignore_auth_http;
+	if ($_SERVER['PHP_AUTH_USER'] &amp;&amp; $_SERVER['PHP_AUTH_PW']
+	&amp;&amp; !$ignore_auth_http) {
+		$login = addslashes($_SERVER['PHP_AUTH_USER']);
 		$result = spip_query(&quot;SELECT * FROM spip_auteurs WHERE login='$login'&quot;);
 		$row = spip_fetch_array($result);
-		$auth_mdpass = md5($row['alea_actuel'] . $PHP_AUTH_PW);
+		$auth_mdpass = md5($row['alea_actuel'] . $_SERVER['PHP_AUTH_PW']);
 		if ($auth_mdpass != $row['pass']) {
-			$PHP_AUTH_USER='';
 			return false;
 		} else {
 			$GLOBALS['auteur_session']['id_auteur'] = $row['id_auteur'];
@@ -217,7 +225,7 @@
 // et charge ses valeurs dans $GLOBALS['auteur_session']
 //
 function verifier_visiteur() {
-	if (verifier_session($GLOBALS['HTTP_COOKIE_VARS']['spip_session']))
+	if (verifier_session($GLOBALS['_COOKIE']['spip_session']))
 		return true;
 	if (verifier_php_auth())
 		return true;

Index: statistiques_svg.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/statistiques_svg.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- statistiques_svg.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ statistiques_svg.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,4 +1,16 @@
 &lt;?php
+
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire(&quot;inc_charsets.php3&quot;);
 

Index: admin_repair.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/admin_repair.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- admin_repair.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ admin_repair.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc_version.php3&quot;);
 
 include_ecrire (&quot;inc_admin.php3&quot;);

Index: controle_petition.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/controle_petition.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- controle_petition.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ controle_petition.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 
@@ -101,8 +112,9 @@
 	// Invalider les pages ayant trait aux petitions
 	if ($id_signature = ($add_petition?$add_petition:$supp_petition)) {
 		include_ecrire('inc_invalideur.php3');
-		# list ($id_article) = spip_fetch_array(spip_query(&quot;SELECT id_article FROM spip_signatures WHERE id_signature=$id_signature&quot;));
-		suivre_invalideur(&quot;id='petition/petition'&quot;);
+		list ($id_article) = spip_fetch_array(spip_query(&quot;SELECT id_article
+			FROM spip_signatures WHERE id_signature=$id_signature&quot;));
+		suivre_invalideur(&quot;id='varia/pet$id_article'&quot;);
 	}
 
 	if (!$debut) $debut = 0;

Index: inc_auth.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_auth.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_auth.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_auth.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_AUTH&quot;)) return;
@@ -29,7 +40,7 @@
 
 
 function auth() {
-	global $INSECURE, $HTTP_POST_VARS, $HTTP_GET_VARS, $HTTP_COOKIE_VARS, $REMOTE_USER, $PHP_AUTH_USER, $PHP_AUTH_PW;
+	global $_POST, $_GET, $_COOKIE, $_SERVER;
 	global $auth_can_disconnect, $ignore_auth_http, $ignore_remote_user;
 
 	global $connect_id_auteur, $connect_nom, $connect_bio, $connect_email;
@@ -44,10 +55,16 @@
 	// Si pas MySQL, fini
 	//
 	if (!$GLOBALS['db_ok']) {
-		echo &quot;&lt;P&gt;&lt;H4&gt;&quot;._T('titre_probleme_technique').&quot;&lt;/H4&gt;&lt;P&gt;&lt;P&gt;\n&quot;.
-		&quot;&lt;tt&gt;&quot;.spip_sql_errno().&quot; &quot;.spip_sql_error().&quot;&lt;/tt&gt;&quot;;
-		return false;
+		spip_log(&quot;Erreur base de donnees&quot;);
+		include_ecrire('inc_presentation.php3');
+		install_debut_html(_T('info_travaux_titre'));
+		echo _T('titre_probleme_technique');
+		echo &quot;&lt;p&gt;&lt;tt&gt;&quot;.spip_sql_errno().&quot; &quot;.spip_sql_error().&quot;&lt;/tt&gt;&lt;/p&gt;&quot;;
+		install_fin_html();
+		exit;
 	}
+
+
 	//
 	// Initialiser variables (eviter hacks par URL)
 	//
@@ -62,30 +79,11 @@
 	// Recuperer les donnees d'identification
 	//
 
-	// Peut-etre sommes-nous en auth http?
-	if ($PHP_AUTH_USER &amp;&amp; $PHP_AUTH_PW &amp;&amp; !$ignore_auth_http) {
-		if (verifier_php_auth()) {
-			$auth_login = $PHP_AUTH_USER;
-			$auth_pass_ok = true;
-			$auth_can_disconnect = true;
-		}
-		else // normalement on n'arrive pas la sauf changement de mot de passe dans la base...
-		if ($PHP_AUTH_USER != 'root') // ... mais quelques serveurs forcent cette valeur
-		{
-			$auth_login = '';
-			echo &quot;&lt;p&gt;&lt;b&gt;&quot;._T('info_connexion_refusee').&quot;&lt;/b&gt;&lt;/p&gt;&quot;;
-			echo &quot;[&lt;a href='../spip_cookie.php3?essai_auth_http=oui'&gt;&quot;._T('lien_reessayer').&quot;&lt;/a&gt;]&quot;;
-			exit;
-		}
-		$PHP_AUTH_PW = '';
-		$_SERVER['PHP_AUTH_PW'] = '';
-		$HTTP_SERVER_VARS['PHP_AUTH_PW'] = '';
-	}
-
 	// Authentification session
-	else if ($cookie_session = $HTTP_COOKIE_VARS['spip_session']) {
+	if ($cookie_session = $_COOKIE['spip_session']) {
 		if (verifier_session($cookie_session)) {
-			if ($auteur_session['statut'] == '0minirezo' OR $auteur_session['statut'] == '1comite') {
+			if ($auteur_session['statut'] == '0minirezo'
+			OR $auteur_session['statut'] == '1comite') {
 				$auth_login = $auteur_session['login'];
 				$auth_pass_ok = true;
 				$auth_can_disconnect = true;
@@ -93,15 +91,31 @@
 		}
 	}
 
-	// Authentification .htaccess
-	else if ($REMOTE_USER &amp;&amp; !$INSECURE['REMOTE_USER'] &amp;&amp; !$ignore_remote_user) {
-		$auth_login = $REMOTE_USER;
+	// Peut-etre sommes-nous en auth http?
+	else if ($_SERVER['PHP_AUTH_USER'] &amp;&amp; $_SERVER['PHP_AUTH_PW']
+	&amp;&amp; !$ignore_auth_http) {
+
+		// Si le login existe dans la base, se loger
+		if (verifier_php_auth()) {
+			$auth_login = $_SERVER['PHP_AUTH_USER'];
+			$auth_pass_ok = true;
+			$auth_can_disconnect = true;
+			$_SERVER['PHP_AUTH_PW'] = '';
+		}
+		// Sinon c'est un login d'intranet independant de spip, on ignore
+	}
+
+	// Authentification .htaccess old style, car .htaccess semble
+	// souvent definir *aussi* PHP_AUTH_USER et PHP_AUTH_PW
+	else if ($GLOBALS['_SERVER']['REMOTE_USER']
+	&amp;&amp; !$ignore_remote_user) {
+		$auth_login = $GLOBALS['_SERVER']['REMOTE_USER'];
 		$auth_pass_ok = true;
 		$auth_htaccess = true;
 	}
 
 	// Tentative de login echec
-	if ($HTTP_GET_VARS['bonjour'] == 'oui' AND !$auth_login) {
+	if ($_GET['bonjour'] == 'oui' AND !$auth_login) {
 		$link = new Link(&quot;../spip_cookie.php3?test_echec_cookie=oui&quot;);
 		$clean_link-&gt;delVar('bonjour');
 		$url = str_replace('/./', '/', _DIR_RESTREINT_ABS .$clean_link-&gt;getUrl());
@@ -112,8 +126,9 @@
 
 	// Si pas authentifie, demander login / mdp
 	if (!$auth_login) {
-		$url = urlencode(str_replace('/./', '/',  _DIR_RESTREINT_ABS .$clean_link-&gt;getUrl()));
-		redirige_par_entete($addr . &quot;../spip_login.php3?url=$url&quot;);
+		$url = str_replace('/./', '/',  _DIR_RESTREINT_ABS
+			. $clean_link-&gt;getUrl());
+		redirige_par_entete(&quot;../spip_login.php3?url=&quot;.urlencode($url));
 		exit;
 	}
 
@@ -142,23 +157,18 @@
 		// Special : si dans la fiche auteur on modifie les valeurs
 		// de messagerie, utiliser ces valeurs plutot que celle de la base.
 		// D'ou leger bug si on modifie la fiche de quelqu'un d'autre.
-		/*if ($GLOBALS['perso_activer_messagerie']) {
-			$connect_activer_messagerie = $GLOBALS['perso_activer_messagerie'];
-			$connect_activer_imessage = $GLOBALS['perso_activer_imessage'];
-		}*/
-		// (1.8: La messagerie est toujours active)
 
 		// regler les preferences de l'auteur
 		$prefs = unserialize($row['prefs']);
 
 		// vieux ! on pourra supprimer post 1.6 finale...
 		if (! isset($prefs['display'])) { // recuperer les cookies ou creer defaut
-			if ($GLOBALS['set_disp'] = $GLOBALS['HTTP_COOKIE_VARS']['spip_display']) {}
-			else $GLOBALS['set_disp'] = 2;
-			if ($GLOBALS['set_couleur'] = $GLOBALS['HTTP_COOKIE_VARS']['spip_couleur']) {}
-			else $GLOBALS['set_couleur'] = 6;
-			if ($GLOBALS['set_options'] = $GLOBALS['HTTP_COOKIE_VARS']['spip_options']) {}
-			else $GLOBALS['set_options'] = 'basiques';
+			if (!$GLOBALS['set_disp'] = $GLOBALS['_COOKIE']['spip_display'])
+				$GLOBALS['set_disp'] = 2;
+			if (!$GLOBALS['set_couleur'] = $GLOBALS['_COOKIE']['spip_couleur'])
+				$GLOBALS['set_couleur'] = 6;
+			if (!$GLOBALS['set_options'] = $GLOBALS['_COOKIE']['spip_options'])
+				$GLOBALS['set_options'] = 'basiques';
 		}
 
 		// Indiquer connexion
@@ -211,7 +221,9 @@
 	}
 
 	if (!$auth_pass_ok) {
-		redirige_par_entete(&quot;../spip_login.php3?var_erreur=pass&quot;);
+		redirige_par_entete(&quot;../spip_login.php3?var_erreur=pass&amp;inscription=&quot; .
+			     ((lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;)?
+			      ('spip_inscription.php3') : ''));
 	}
 
 	if ($connect_statut == 'nouveau') {

Index: inc_meta.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_meta.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_meta.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_meta.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_META&quot;)) return;

Index: sites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/sites.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- sites.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ sites.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_logos.php3&quot;);
 include_ecrire (&quot;inc_mots.php3&quot;);
@@ -81,7 +92,7 @@
 	
 		$moderation = (lire_meta(&quot;moderation_sites&quot;) == &quot;oui&quot;)? 'oui' : 'non';
 	
-		$id_syndic = spip_abstract_insert(&quot;syndic&quot;,
+		$id_syndic = spip_abstract_insert(&quot;spip_syndic&quot;,
 					 &quot;(nom_site, id_rubrique, id_secteur, date, date_syndic, statut, syndication, moderation)&quot;,
 					 &quot;('&quot;._T('avis_site_introuvable').&quot;', $id_rubrique, $id_rubrique, NOW(), NOW(), 'refuse', 'non', '$moderation')&quot;);
 	}
@@ -157,8 +168,17 @@
 	$descriptif = addslashes($descriptif);
 	if (strlen($url_syndic) &lt; 8) $syndication = &quot;non&quot;;
 	$url_syndic = addslashes($url_syndic);
-
-	$query = &quot;UPDATE spip_syndic SET id_rubrique='$id_rubrique', nom_site='$nom_site', url_site='$url_site', url_syndic='$url_syndic', descriptif='$descriptif', syndication='$syndication', statut='$statut' WHERE id_syndic=&quot;.intval($id_syndic);
+	
+	// recoller les champs du extra
+	if ($champs_extra) {
+		include_ecrire(&quot;inc_extra.php3&quot;);
+		$add_extra = &quot;, extra = '&quot;.addslashes(extra_recup_saisie(&quot;sites&quot;, $id_secteur)).&quot;'&quot;;
+	} else
+		$add_extra = '';
+	
+	
+	
+	$query = &quot;UPDATE spip_syndic SET id_rubrique='$id_rubrique', nom_site='$nom_site', url_site='$url_site', url_syndic='$url_syndic', descriptif='$descriptif', syndication='$syndication', statut='$statut' $add_extra WHERE id_syndic=&quot;.intval($id_syndic);
 	$result = spip_query($query);
 
 	if ($syndication_old != $syndication OR $url_syndic != $old_syndic) {
@@ -225,17 +245,19 @@
 if ($row = spip_fetch_array($result)) {
 	$id_syndic = $row[&quot;id_syndic&quot;];
 	$id_rubrique = $row[&quot;id_rubrique&quot;];
-	$nom_site = stripslashes($row[&quot;nom_site&quot;]);
-	$url_site = stripslashes($row[&quot;url_site&quot;]);
-	$url_syndic = stripslashes($row[&quot;url_syndic&quot;]);
-	$descriptif = stripslashes($row[&quot;descriptif&quot;]);
+	$nom_site = $row[&quot;nom_site&quot;];
+	$url_site = $row[&quot;url_site&quot;];
+	$url_syndic = $row[&quot;url_syndic&quot;];
+	$descriptif = $row[&quot;descriptif&quot;];
 	$syndication = $row[&quot;syndication&quot;];
 	$statut = $row[&quot;statut&quot;];
 	$date_heure = $row[&quot;date&quot;];
 	$date_syndic = $row['date_syndic'];
 	$mod = $row['moderation'];
-}
 
+	$extra=$row[&quot;extra&quot;];
+	
+	}
 
 if ($nom_site)
 	$titre_page = &quot;&laquo; $nom_site &raquo;&quot;;
@@ -272,11 +294,8 @@
 	icone (_T('icone_voir_sites_references'), &quot;sites_tous.php3&quot;, &quot;site-24.gif&quot;,&quot;rien.gif&quot;);
 echo &quot;&lt;/center&gt;&quot;;
 
-$rubon = &quot;siteon$id_syndic&quot;;
-$ruboff = &quot;siteoff$id_syndic&quot;;
-
-if ($id_syndic&gt;0 AND $flag_administrable)
-	afficher_boite_logo($rubon, $ruboff, _T('logo_site').&quot; &quot;.aide (&quot;rublogo&quot;), _T('logo_survol'));
+if ($id_syndic AND $flag_administrable)
+	afficher_boite_logo('site', 'id_syndic', $id_syndic, _T('logo_site').&quot; &quot;.aide (&quot;rublogo&quot;), _T('logo_survol'), 'site');
 
 
 debut_droite();
@@ -441,6 +460,11 @@
 	}
 	echo &quot;&lt;/font&gt;&quot;;
 }
+
+if ($champs_extra AND $extra) {
+		include_ecrire(&quot;inc_extra.php3&quot;);
+		extra_affichage($extra, &quot;sites&quot;);
+	}
 
 fin_cadre_relief();
 

Index: breves.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/breves.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- breves.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ breves.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 if ($statut AND $connect_statut == &quot;0minirezo&quot;) {

Index: breves_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/breves_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- breves_edit.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ breves_edit.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_documents.php3&quot;);
 include_ecrire (&quot;inc_barre.php3&quot;);
@@ -19,7 +30,8 @@
 	global $id_rubrique;
 	global $spip_lang_left;
 	
- 	$query=&quot;SELECT * FROM spip_rubriques WHERE id_parent='$leparent'&quot;;
+ 	$query=&quot;SELECT * FROM spip_rubriques WHERE id_parent='$leparent'
+ 		ORDER BY 0+titre,titre&quot;;
  	$result=spip_query($query);
 	$style = http_style_background('secteur-12.gif',  &quot;$spip_lang_left no-repeat; padding-$spip_lang_left: 16px&quot;);
 
@@ -61,24 +73,6 @@
 	$statut = &quot;prop&quot;;
 }
 
-if ($id_document) {
-	$query_doc = &quot;SELECT * FROM spip_documents_breves WHERE id_document=$id_document AND id_breve=$id_breve&quot;;
-	$result_doc = spip_query($query_doc);
-	$flag_document_editable = (spip_num_rows($result_doc) &gt; 0);
-} else {
-	$flag_document_editable = false;
-}
-
-
-$modif_document = $GLOBALS['modif_document'];
-if ($modif_document == 'oui' AND $flag_document_editable) {
-	$titre_document = addslashes(corriger_caracteres($titre_document));
-	$descriptif_document = addslashes(corriger_caracteres($descriptif_document));
-	spip_query(&quot;UPDATE spip_documents SET titre='$titre_document', descriptif='$descriptif_document' WHERE id_document=$id_document&quot;);
- }
-
-
-
 
 debut_page(_T('titre_page_breves_edit', array('titre' =&gt; $titre)), &quot;documents&quot;, &quot;breves&quot;);
 
@@ -89,7 +83,8 @@
 
 fin_grand_cadre();
 debut_gauche();
-if ($new != 'oui' AND ($connect_statut==&quot;0minirezo&quot; OR $statut==&quot;prop&quot;)){
+if ($new != 'oui' AND ($connect_statut==&quot;0minirezo&quot; OR $statut==&quot;prop&quot;)) {
+	maj_documents($id_breve, 'breve');
 	afficher_documents_colonne($id_breve, &quot;breve&quot;, true);
 }
 debut_droite();

Index: win_width.htc
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/win_width.htc,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- win_width.htc	13 Jan 2005 15:37:16 -0000	1.1
+++ win_width.htc	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,23 +1,23 @@
-&lt;public:component&gt;
-&lt;public:property name=&quot;retrait&quot;&gt;
-&lt;script language=&quot;JScript&quot;&gt;
-
-function fixWidth(){
-	if (element.className == &quot;spip_cadre&quot;) retrait = 24; 
-	else retrait = 16; 
-
-	if (element.offsetWidth) {
-		style.width = element.offsetWidth - retrait;
-	} else {
-		style.width = &quot;90%&quot;;
-		//alert (element.parentElement.tagName);
-	}
-}
-
-var supported = /MSIE (5\.5)|[6789]/.test(navigator.userAgent) &amp;&amp; navigator.platform == &quot;Win32&quot;;
-if (supported) fixWidth();
-
-
-&lt;/script&gt;
-&lt;/public:component&gt;
-
+&lt;public:component&gt;
+&lt;public:property name=&quot;retrait&quot;&gt;
+&lt;script language=&quot;JScript&quot;&gt;
+
+function fixWidth(){
+	if (element.className == &quot;spip_cadre&quot;) retrait = 24; 
+	else retrait = 16; 
+
+	if (element.offsetWidth) {
+		style.width = element.offsetWidth - retrait;
+	} else {
+		style.width = &quot;90%&quot;;
+		//alert (element.parentElement.tagName);
+	}
+}
+
+var supported = /MSIE (5\.5)|[6789]/.test(navigator.userAgent) &amp;&amp; navigator.platform == &quot;Win32&quot;;
+if (supported) fixWidth();
+
+
+&lt;/script&gt;
+&lt;/public:component&gt;
+

Index: recherche.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/recherche.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- recherche.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ recherche.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_mots.php3&quot;);
 include_ecrire (&quot;inc_sites.php3&quot;);

Index: inc_admin.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_admin.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_admin.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_admin.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_ADMIN&quot;)) return;
@@ -74,8 +85,11 @@
 }
 
 function verifier_action_auteur($action, $valeur, $id_auteur = 0) {
-	if ($valeur == _action_auteur($action, $id_auteur, 'alea_ephemere')) return true;
-	if ($valeur == _action_auteur($action, $id_auteur, 'alea_ephemere_ancien')) return true;
+	if ($valeur == _action_auteur($action, $id_auteur, 'alea_ephemere'))
+		return true;
+	if ($valeur == _action_auteur($action, $id_auteur, 'alea_ephemere_ancien'))
+		return true;
+	spip_log(&quot;inc_admin: verifier action $action $id_auteur : echec&quot;);
 	return false;
 }
 

Index: inc_config.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_config.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_config.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ inc_config.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_CONFIG&quot;)) return;
@@ -74,7 +85,6 @@
 		'gerer_trad' =&gt; 'non',
 		'langues_multilingue' =&gt; $GLOBALS['all_langs']
 	);
-
 	while (list($nom, $valeur) = each($liste_meta)) {
 		if (!lire_meta($nom)) {
 			ecrire_meta($nom, $valeur);
@@ -251,6 +261,15 @@
 		'gerer_trad',
 		'langues_multilingue'
 	);
+	// Modification du reglage accepter_inscriptions =&gt; vider le cache
+	// (pour repercuter la modif sur le panneau de login)
+	if (isset($GLOBALS['accepter_inscriptions'])
+	AND ($GLOBALS['accepter_inscriptions']
+	!= lire_meta('accepter_inscriptions'))) {
+		include_ecrire('inc_invalideur.php3');
+		suivre_invalideur(&quot;1&quot;); # tout effacer
+	}
+
 	while (list(,$i) = each($liste_meta))
 		if (isset($GLOBALS[$i])) ecrire_meta($i, $GLOBALS[$i]);
 
@@ -267,7 +286,6 @@
 
 	// modifs de secu (necessitent une authentification ftp)
 	$liste_meta = array(
-		// 'secu_avertissement',	// n'existe plus !
 			    'creer_htpasswd',
 			    'creer_htaccess'
 	);

Index: lab_diff.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lab_diff.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- lab_diff.php	13 Jan 2005 15:37:16 -0000	1.1
+++ lab_diff.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_DIFF&quot;)) return;
 define(&quot;_ECRIRE_INC_DIFF&quot;, &quot;1&quot;);

Index: index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/index.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- index.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ index.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,10 +1,19 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_calendrier.php&quot;);
 
-if ($HTTP_REFERER &amp;&amp; !strpos($HTTP_REFERER, _DIR_RESTEINT_ABS)) $bonjour = 'oui';
-
 debut_page(_T('titre_page_index'), &quot;asuivre&quot;, &quot;asuivre&quot;);
 
 debut_gauche();
@@ -58,8 +67,7 @@
 	}
 	echo &quot;&lt;div class='verdana1'&gt;&quot;;
 
-  $query = &quot;SELECT count(*) AS cnt, statut FROM spip_articles GROUP BY statut&quot;;
-  $res = spip_query($query);
+    $res = spip_query(&quot;SELECT count(*) AS cnt, statut FROM spip_articles GROUP BY statut&quot;);
   
   while($row = spip_fetch_array($res)) {
     $var  = 'nb_art_'.$row['statut'];
@@ -77,8 +85,8 @@
 
 	}
 
-	$query = &quot;SELECT count(*) AS cnt, statut FROM spip_breves GROUP BY statut&quot;;
-	$res = spip_query($query);
+	$res = spip_query(&quot;SELECT count(*) AS cnt, statut FROM spip_breves GROUP BY statut&quot;);
+
 
 	while($row = spip_fetch_array($res)) {
 		$var  = 'nb_bre_'.$row['statut'];
@@ -93,8 +101,8 @@
 		echo &quot;&lt;/ul&gt;&quot;;
 	}
 
-	$query = &quot;SELECT count(*) AS cnt FROM spip_forum where statut='publie'&quot;;
-	$result = spip_fetch_array(spip_query($query));
+	$result = spip_fetch_array(spip_query(&quot;SELECT count(*) AS cnt FROM spip_forum where statut='publie'&quot;));
+
 	$nb_forum = $result['cnt'];
 
 	if ($nb_forum) {
@@ -105,8 +113,8 @@
 		echo &quot;&lt;/ul&gt;&quot;;
 	}
 
-	$query = &quot;SELECT count(*) AS cnt, statut FROM spip_auteurs GROUP BY statut&quot;;
-	$res = spip_query($query);
+	$res = spip_query(&quot;SELECT count(*) AS cnt, statut FROM spip_auteurs GROUP BY statut&quot;);
+
 
 	while($row = spip_fetch_array($res)) {
 		$var  = 'nb_aut_'.$row['statut'];
@@ -159,22 +167,16 @@
 		$jour = jour($date);
 	
 		// rendez-vous personnels dans le mois
-		$result_messages = spip_query(&quot;SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
-				&quot;WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') &quot;.
-				&quot;AND messages.rv='oui' AND messages.date_heure &gt;='$annee-$mois-1' AND date_heure &lt; DATE_ADD('$annee-$mois-1', INTERVAL 1 MONTH) &quot;.
-				&quot;AND messages.statut='publie' LIMIT 0,1&quot;);
-		if (spip_num_rows($result_messages)) {
+		if (spip_num_rows(spip_query(&quot;SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.date_heure &gt;='$annee-$mois-1' AND date_heure &lt; DATE_ADD('$annee-$mois-1', INTERVAL 1 MONTH) AND messages.statut='publie' LIMIT 0,1&quot;))) {
 			echo &quot;&lt;p /&gt;&quot;;
 			echo http_calendrier_agenda ($mois_today, $annee_today, $jour_today, $mois_today, $annee_today);
 		}
 		// rendez-vous personnels dans le mois
-		$result_messages = spip_query(&quot;SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
+		if (spip_num_rows(spip_query(&quot;SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
 				&quot;WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') &quot;.
-				&quot;AND messages.rv='oui' AND messages.date_heure &gt;='$annee_today-$mois_today-$jour_today' AND messages.date_heure &lt; DATE_ADD('$annee_today-$mois_today-$jour_today', INTERVAL 1 DAY) &quot;.
-				&quot;AND messages.statut='publie' LIMIT 0,1&quot;);
-		if (spip_num_rows($result_messages)) {
+					     &quot;AND messages.rv='oui' AND messages.date_heure &gt;='$annee_today-$mois_today-$jour_today' AND messages.date_heure &lt; DATE_ADD('$annee_today-$mois_today-$jour_today', INTERVAL 1 DAY) AND messages.statut='publie' LIMIT 0,1&quot;))) {
 			echo &quot;&lt;p /&gt;&quot;;
-		echo http_calendrier_jour($jour_today,$mois_today,$annee_today, &quot;col&quot;);
+			echo http_calendrier_jour($jour_today,$mois_today,$annee_today, &quot;col&quot;);
 		}
 }
 
@@ -190,48 +192,9 @@
 if ($meta[&quot;debut_restauration&quot;]) {
 	@ignore_user_abort(1);
 	include_ecrire(&quot;inc_import.php3&quot;);
-
-	$archive = $meta[&quot;fichier_restauration&quot;];
-	$my_pos = $meta[&quot;status_restauration&quot;];
-	$ok = @file_exists($archive);
-
-	if ($ok) {
-		if (ereg(&quot;\.gz$&quot;, $archive)) {
-			$affiche_progression_pourcent = false;
-			$taille = taille_en_octets($my_pos);
-		}
-		else {
-			$affiche_progression_pourcent = filesize($archive);
-			$taille = floor(100 * $my_pos / $affiche_progression_pourcent).&quot; %&quot;;
-		}
-		$texte_boite = _T('info_base_restauration').&quot;&lt;p&gt;
-		&lt;form name='progression'&gt;&lt;center&gt;&lt;input type='text' size=10 style='text-align:center;' name='taille' value='$taille'&gt;&lt;br&gt;
-		&lt;input type='text' class='forml' name='recharge' value='&quot;._T('info_recharger_page').&quot;'&gt;&lt;/center&gt;&lt;/form&gt;&quot;;
-	}
-	else {
-		$texte_boite = _T('info_erreur_restauration');
-	}
-
-	debut_boite_alerte();
-	echo &quot;&lt;font FACE='Verdana,Arial,Sans,sans-serif' SIZE=4 color='black'&gt;&lt;B&gt;$texte_boite&lt;/B&gt;&lt;/font&gt;&quot;;
-	fin_boite_alerte();
-	fin_page(&quot;jimmac&quot;);
-	echo &quot;&lt;/HTML&gt;&lt;font color='white'&gt;\n&lt;!--&quot;;
-	@flush();
-	$gz = $flag_gz;
-	$_fopen = ($gz) ? gzopen : fopen;
-
-	if ($ok) {
-		$f = $_fopen($archive, &quot;rb&quot;);
-		$pos = 0;
-		$buf = &quot;&quot;;
-		if (!import_all($f, $gz)) import_abandon();
-	}
-	else {
-		import_fin();
-	}
+	import_init();
 	exit;
-}
+ }
 
 
 //
@@ -242,8 +205,7 @@
 
 if ($post_dates == &quot;non&quot; AND $connect_statut == '0minirezo' AND $options == 'avancees') {
 	echo &quot;&lt;p&gt;&quot;;
-	afficher_articles(_T('info_article_a_paraitre'),
-		&quot;WHERE statut='publie' AND date&gt;NOW() ORDER BY date&quot;);
+	afficher_articles(_T('info_article_a_paraitre'), &quot;WHERE statut='publie' AND date&gt;NOW() ORDER BY date&quot;);
 }
 
 
@@ -253,24 +215,17 @@
 //
 
 echo &quot;&lt;p&gt;&quot;;
-$vos_articles = afficher_articles(afficher_plus('articles_page.php3')._T('info_en_cours_validation'),
-	&quot;, spip_auteurs_articles AS lien WHERE articles.id_article=lien.id_article &quot;.
-	&quot;AND lien.id_auteur=$connect_id_auteur AND articles.statut='prepa' ORDER BY articles.date DESC&quot;);
+$vos_articles = afficher_articles(afficher_plus('articles_page.php3')._T('info_en_cours_validation'),	&quot;, spip_auteurs_articles AS lien WHERE articles.id_article=lien.id_article AND lien.id_auteur=$connect_id_auteur AND articles.statut='prepa' ORDER BY articles.date DESC&quot;);
 
 if ($vos_articles) $vos_articles = ' AND articles.id_article NOT IN ('.join($vos_articles,',').')';
 
-echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
-echo debut_cadre_trait_couleur();
 
 //
 // Raccourcis pour malvoyants
 //
 if ($spip_display == 4) {
 	debut_raccourcis();
-	$query = &quot;SELECT id_rubrique FROM spip_rubriques LIMIT 0,1&quot;;
-	$result = spip_query($query);
-	
-	if (spip_num_rows($result) &gt; 0) {
+	if (spip_num_rows(spip_query(&quot;SELECT id_rubrique FROM spip_rubriques LIMIT 0,1&quot;))) {
 		icone_horizontale(_T('icone_ecrire_article'), &quot;articles_edit.php3?new=oui&quot;, &quot;article-24.gif&quot;,&quot;creer.gif&quot;);
 	
 		$activer_breves = lire_meta(&quot;activer_breves&quot;);
@@ -287,25 +242,22 @@
 		icone_horizontale(_T('icone_creer_rubrique_2'), &quot;rubriques_edit.php3?new=oui&quot;, &quot;rubrique-24.gif&quot;,&quot;creer.gif&quot;);
 	}
 	fin_raccourcis();
-} else {
+ } else {
 
-		$query = &quot;SELECT id_rubrique FROM spip_rubriques LIMIT 0,1&quot;;
-		$result = spip_query($query);
-		$gadget = &quot;&quot;;
+	$gadget = &quot;&quot;;
 		
-		if (spip_num_rows($result) &gt; 0) {
-			$id_rubrique = $GLOBALS['id_rubrique'];
-			if ($id_rubrique &gt; 0) {
+	$gadget = &quot;&lt;center&gt;&lt;table&gt;&lt;tr&gt;&quot;;
+	$id_rubrique = $GLOBALS['id_rubrique'];
+	if ($id_rubrique &gt; 0) {
 				$dans_rub = &quot;&amp;id_rubrique=$id_rubrique&quot;;
 				$dans_parent = &quot;&amp;id_parent=$id_rubrique&quot;;
 			}
-			$gadget = &quot;&lt;center&gt;&lt;table&gt;&lt;tr&gt;&quot;;
-			if ($connect_statut == &quot;0minirezo&quot;) {
-				$gadget .= &quot;&lt;td&gt;&quot;;
-				$gadget .= icone_horizontale(_T('icone_creer_rubrique'), &quot;rubriques_edit.php3?new=oui&quot;, &quot;rubrique-24.gif&quot;, &quot;creer.gif&quot;, false);
-				$gadget .= &quot;&lt;/td&gt;&quot;;
-			}
-			
+	if ($connect_statut == &quot;0minirezo&quot;) {
+			$gadget .= &quot;&lt;td&gt;&quot;;
+			$gadget .= icone_horizontale(_T('icone_creer_rubrique'), &quot;rubriques_edit.php3?new=oui&quot;, &quot;rubrique-24.gif&quot;, &quot;creer.gif&quot;, false);
+			$gadget .= &quot;&lt;/td&gt;&quot;;
+		}
+	if (spip_num_rows(spip_query(&quot;SELECT id_rubrique FROM spip_rubriques LIMIT 0,1&quot;))) {
 			$gadget .= &quot;&lt;td&gt;&quot;;
 			$gadget .= icone_horizontale(_T('icone_ecrire_article'), &quot;articles_edit.php3?new=oui$dans_rub&quot;, &quot;article-24.gif&quot;,&quot;creer.gif&quot;, false);
 			$gadget .= &quot;&lt;/td&gt;&quot;;
@@ -320,22 +272,18 @@
 			if (lire_meta(&quot;activer_sites&quot;) == 'oui') {
 				if ($connect_statut == '0minirezo' OR lire_meta(&quot;proposer_sites&quot;) &gt; 0) {
 					$gadget .= &quot;&lt;td&gt;&quot;;
-					$gadget .= icone_horizontale(_T('info_sites_referencer'), &quot;sites_edit.php3?new=oui$dans_rub&quot;, &quot;site-24.gif&quot;,&quot;creer.gif&quot;, false);
+					$gadget .= icone_horizontale(_T('info_sites_referencer'), &quot;sites_edit.php3?new=oui&amp;target=sites.php3$dans_rub&quot;, &quot;site-24.gif&quot;,&quot;creer.gif&quot;, false);
 					$gadget .= &quot;&lt;/td&gt;&quot;;
 				}
 			}
 			
 		}
-
 		$gadget .= &quot;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;\n&quot;;
 
-	echo $gadget;
-
-
 
 	if ($connect_statut != &quot;0minirezo&quot;) {
 	
-		$gadget = &quot;&lt;center&gt;&lt;table&gt;&lt;tr&gt;&quot;;
+		$gadget .= &quot;&lt;center&gt;&lt;table&gt;&lt;tr&gt;&quot;;
 	
 		$nombre_articles = spip_num_rows(spip_query(&quot;SELECT art.id_article FROM spip_articles AS art, spip_auteurs_articles AS lien WHERE lien.id_auteur = '$connect_id_auteur' AND art.id_article = lien.id_article LIMIT 0,1&quot;));
 		if ($nombre_articles &gt; 0) {
@@ -366,7 +314,6 @@
 		}
 		$gadget .= &quot;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;\n&quot;;
 		
-		echo $gadget;
 	}
 
 }
@@ -380,20 +327,26 @@
 
 if ($connect_statut == &quot;0minirezo&quot; AND $spip_display != 4) {
 	if (!$cookie_admin) {
-		echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
-		echo &quot;&lt;table width=95%&gt;&lt;tr&gt;&quot;;
-		echo &quot;&lt;td width=100%&gt;&quot;;
-		echo _T('info_activer_cookie');
-		echo aide (&quot;cookie&quot;);
-		echo &quot;&lt;/td&gt;&quot;;
-		echo &quot;&lt;td width=10&gt;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;rien.gif' width=10 alt='' /&gt;&quot;;
-		echo &quot;&lt;/td&gt;&quot;;
-		echo &quot;&lt;td width='250'&gt;&quot;;
-		icone_horizontale(_T('icone_activer_cookie'), &quot;../spip_cookie.php3?cookie_admin=&quot;.rawurlencode(&quot;@$connect_login&quot;).&quot;&amp;url=&quot;.rawurlencode(_DIR_RESTREINT_ABS), &quot;cookie-24.gif&quot;, &quot;&quot;);
-		echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
+		$gadget .= &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
+		$gadget .= &quot;&lt;table width=95%&gt;&lt;tr&gt;&quot;;
+		$gadget .= &quot;&lt;td width=100%&gt;&quot;;
+		$gadget .= _T('info_activer_cookie');
+		$gadget .= aide (&quot;cookie&quot;);
+		$gadget .= &quot;&lt;/td&gt;&quot;;
+		$gadget .= &quot;&lt;td width=10&gt;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;rien.gif' width=10 alt='' /&gt;&quot;;
+		$gadget .= &quot;&lt;/td&gt;&quot;;
+		$gadget .= &quot;&lt;td width='250'&gt;&quot;;
+		$gadget .= icone_horizontale(_T('icone_activer_cookie'), &quot;../spip_cookie.php3?cookie_admin=&quot;.rawurlencode(&quot;@$connect_login&quot;).&quot;&amp;url=&quot;.rawurlencode(_DIR_RESTREINT_ABS), &quot;cookie-24.gif&quot;, &quot;&quot;, false);
+		$gadget .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
 	}
 }
-echo fin_cadre_trait_couleur();
+
+if (strlen($gadget) &gt; 0) {
+	echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
+	echo debut_cadre_trait_couleur();
+	echo $gadget;
+	echo fin_cadre_trait_couleur();
+}
 echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
 
 
@@ -404,26 +357,26 @@
 $relief = false;
 
 if (!$relief) {
-	$query = &quot;SELECT id_article FROM spip_articles AS articles WHERE statut='prop'$vos_articles LIMIT 0,1&quot;;
-	$result = spip_query($query);
+	$result = spip_query(&quot;SELECT id_article FROM spip_articles AS articles WHERE statut='prop'$vos_articles LIMIT 0,1&quot;);
+
 	$relief = (spip_num_rows($result) &gt; 0);
 }
 
 if (!$relief) {
-	$query = &quot;SELECT id_breve FROM spip_breves WHERE statut='prop' LIMIT 0,1&quot;;
-	$result = spip_query($query);
+	$result = spip_query(&quot;SELECT id_breve FROM spip_breves WHERE statut='prop' LIMIT 0,1&quot;);
+
 	$relief = (spip_num_rows($result) &gt; 0);
 }
 
 if (!$relief AND lire_meta('activer_syndic') != 'non') {
-	$query = &quot;SELECT id_syndic FROM spip_syndic WHERE statut='prop' LIMIT 0,1&quot;;
-	$result = spip_query($query);
+	$result = spip_query(&quot;SELECT id_syndic FROM spip_syndic WHERE statut='prop' LIMIT 0,1&quot;);
+	
 	$relief = (spip_num_rows($result) &gt; 0);
 }
 
 if (!$relief AND lire_meta('activer_syndic') != 'non' AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
-	$query = &quot;SELECT id_syndic FROM spip_syndic WHERE syndication='off' LIMIT 0,1&quot;;
-	$result = spip_query($query);
+	$result = spip_query(&quot;SELECT id_syndic FROM spip_syndic WHERE syndication='off' LIMIT 0,1&quot;);
+
 	$relief = (spip_num_rows($result) &gt; 0);
 }
 
@@ -436,14 +389,12 @@
 	//
 	// Les articles a valider
 	//
-	afficher_articles(_T('info_articles_proposes'),
-		&quot;WHERE statut='prop'$vos_articles ORDER BY date DESC&quot;);
+	afficher_articles(_T('info_articles_proposes'),	&quot;WHERE statut='prop'$vos_articles ORDER BY date DESC&quot;);
 
 	//
 	// Les breves a valider
 	//
-	$query = &quot;SELECT * FROM spip_breves WHERE statut='prepa' OR statut='prop' ORDER BY date_heure DESC&quot;;
-	afficher_breves(afficher_plus('breves.php3')._T('info_breves_valider'), $query, true);
+	afficher_breves(afficher_plus('breves.php3')._T('info_breves_valider'), &quot;SELECT * FROM spip_breves WHERE statut='prepa' OR statut='prop' ORDER BY date_heure DESC&quot;, true);
 
 	//
 	// Les sites references a valider
@@ -458,8 +409,7 @@
 	//
 	if (lire_meta('activer_syndic') != 'non' AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
 		include_ecrire(&quot;inc_sites.php3&quot;);
-		afficher_sites(afficher_plus('sites_tous.php3')._T('avis_sites_syndiques_probleme'),
-			&quot;SELECT * FROM spip_syndic WHERE syndication='off' AND statut='publie' ORDER BY nom_site&quot;);
+		afficher_sites(afficher_plus('sites_tous.php3')._T('avis_sites_syndiques_probleme'), &quot;SELECT * FROM spip_syndic WHERE syndication='off' AND statut='publie' ORDER BY nom_site&quot;);
 	}
 
 	// Les articles syndiques en attente de validation
@@ -491,8 +441,7 @@
 	/* Ne plus afficher: il y a la page &quot;Tous vos articles&quot; pour cela
 	// Vos articles publies
 	echo &quot;&lt;p&gt;&quot;;
-	afficher_articles(afficher_plus('articles_page.php3')._T('info_derniers_articles_publies'),
-		&quot;, spip_auteurs_articles AS lien &quot;.
+	afficher_articles(afficher_plus('articles_page.php3')._T('info_derniers_articles_publies'), &quot;, spip_auteurs_articles AS lien &quot;.
 		&quot;WHERE articles.id_article=lien.id_article AND lien.id_auteur=\&quot;$connect_id_auteur\&quot; AND articles.statut=\&quot;publie\&quot; ORDER BY articles.date DESC&quot;, true);
 	*/
 
@@ -529,23 +478,6 @@
 	ecrire_meta('alea_ephemere_ancien', lire_meta('alea_ephemere'));
 	ecrire_meta('alea_ephemere', $alea);
 	ecrire_metas();
-}
-
-
-//
-// Optimisation periodique de la base de donnees
-//
-if (!$bonjour) {
-	if ($optimiser == 'oui' || (time() - lire_meta('date_optimisation')) &gt; 24 * 3600) {
-		if (!file_exists($lock = _DIR_SESSIONS.'optimisation.lock')
-		OR (time()-filemtime($lock) &gt; 3600)) {
-			touch($lock);
-			ecrire_meta(&quot;date_optimisation&quot;, time());
-			ecrire_metas();
-			include (&quot;optimiser.php3&quot;);
-			unlink($lock);
-		}
-	}
 }
 
 ?&gt;

Index: inc_objet_base.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_objet_base.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_objet_base.php3	13 Jan 2005 15:37:15 -0000	1.1
+++ inc_objet_base.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 //
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_OBJET_BASE&quot;)) return;

Index: message.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/message.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- message.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ message.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 include_ecrire (&quot;inc_mots.php3&quot;);
 include_ecrire (&quot;inc_calendrier.php&quot;);
@@ -100,7 +111,7 @@
       echo &quot;&lt;DIV align=left&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2&gt;&lt;b&gt;&quot;._T('bouton_ajouter_participant').&quot; &nbsp; &lt;/b&gt;&lt;/FONT&gt;\n&quot;;
       echo &quot;&lt;input TYPE='Hidden' NAME='id_message' VALUE=\&quot;$id_message\&quot;&gt;&quot;;
 
-      if (spip_num_rows($result_ajout_auteurs) &gt; 50 AND $GLOBAL['flag_mots_ressemblants']) {
+      if (spip_num_rows($result_ajout_auteurs) &gt; 50) {
 	echo &quot;&lt;input TYPE='text' NAME='cherche_auteur' CLASS='fondl' VALUE='' SIZE='20'&gt;&quot;;
 	echo &quot;&lt;input TYPE='submit' NAME='Chercher' VALUE='&quot;._T('bouton_chercher').&quot;' CLASS='fondo'&gt;&quot;;
       }

Index: lab_ortho.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/lab_ortho.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- lab_ortho.php	13 Jan 2005 15:37:16 -0000	1.1
+++ lab_ortho.php	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 // Ce fichier ne sera execute qu'une fois
 if (defined(&quot;_ECRIRE_INC_ORTHO&quot;)) return;
 define(&quot;_ECRIRE_INC_ORTHO&quot;, &quot;1&quot;);

Index: mots_type.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/mots_type.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- mots_type.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ mots_type.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 
@@ -14,6 +25,11 @@
 	$breves = 'oui';
 	$rubriques = 'non';
 	$syndic = 'oui';
+	//////////////////////////////
+	//MODIFICATION
+	//////////////////////////////
+	$carto_objets= 'non';
+	//////////////////////////////
 	$acces_minirezo = 'oui';
 	$acces_comite = 'oui';
 	$acces_forum = 'non';
@@ -31,6 +47,11 @@
 		$breves = $row['breves'];
 		$rubriques = $row['rubriques'];
 		$syndic = $row['syndic'];
+		//////////////////////////////
+		//MODIFICATION
+		//////////////////////////////
+		$carto_objets = $row['carto_objets'];
+		//////////////////////////////
 		$acces_minirezo = $row['0minirezo'];
 		$acces_comite = $row['1comite'];
 		$acces_forum = $row['6forum'];
@@ -108,6 +129,13 @@
 		if ($syndic == &quot;oui&quot;) $checked = &quot;checked&quot;;
 		else $checked = &quot;&quot;;
 		echo &quot;&lt;input type='checkbox' name='syndic' value='oui' $checked id='syndic'&gt; &lt;label for='syndic'&gt;&quot;._T('item_mots_cles_association_sites').&quot;&lt;/label&gt;&quot;;
+		//////////////////////////////
+		//MODIFICATION
+		//////////////////////////////
+		if ($carto_objets == &quot;oui&quot;) $checked = &quot;checked&quot;;
+		else $checked = &quot;&quot;;
+		echo &quot;&lt;br&gt;&lt;input type='checkbox' name='carto_objets' value='oui' $checked id='carto_objets'&gt; &lt;label for='carto_objets'&gt;&quot;._L('aux objets des cartes').&quot;&lt;/label&gt;&quot;;
+		//////////////////////////////
 		
 		echo &quot;&lt;/ul&gt;&quot;;
 	echo &quot;&lt;/div&gt;&quot;;

Index: config-lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/config-lang.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- config-lang.php3	13 Jan 2005 15:37:16 -0000	1.1
+++ config-lang.php3	20 Feb 2005 22:19:26 -0000	1.2
@@ -1,5 +1,16 @@
 &lt;?php
 
+/***************************************************************************\
+ *  SPIP, Systeme de publication pour l'internet                           *
+ *                                                                         *
+ *  Copyright (c) 2001-2005                                                *
+ *  Arnaud Martin, Antoine Pitrou, Philippe Riviere, Emmanuel Saint-James  *
+ *                                                                         *
+ *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
+ *  Pour plus de details voir le fichier COPYING.txt ou l'aide en ligne.   *
+\***************************************************************************/
+
+
 include (&quot;inc.php3&quot;);
 
 include_ecrire (&quot;inc_config.php3&quot;);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000091.html">[Spip-carto-cvs] spipcarto/ecrire accents.php3,1.1,1.2
</A></li>
	<LI>Next message: <A HREF="000094.html">[Spip-carto-cvs] spipcarto/ecrire http.class.php,1.1,1.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#93">[ date ]</a>
              <a href="thread.html#93">[ thread ]</a>
              <a href="subject.html#93">[ subject ]</a>
              <a href="author.html#93">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
