From mose at berlios.de  Wed Jan 12 04:00:47 2005
From: mose at berlios.de (mose at berlios.de)
Date: Wed, 12 Jan 2005 04:00:47 +0100
Subject: [Spip-carto-cvs] CVSROOT loginfo,1.5,1.6
Message-ID: <200501120300.j0C30lNM019351@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv19337

Modified Files:
	loginfo 
Log Message:
encore tuning syncmail

Index: loginfo
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/loginfo,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** loginfo	12 Jan 2005 02:59:23 -0000	1.5
--- loginfo	12 Jan 2005 03:00:45 -0000	1.6
***************
*** 26,30 ****
  #DEFAULT (echo ""; id; echo %{sVv}; date; cat) >> $CVSROOT/CVSROOT/commitlog
  
! # syncmail envoie un mail sur la mailing-list CVS
  ALL $CVSROOT/CVSROOT/syncmail -f mail.berlios.de %{sVv} spip-carto-cvs at lists.berlios.de
  
--- 26,30 ----
  #DEFAULT (echo ""; id; echo %{sVv}; date; cat) >> $CVSROOT/CVSROOT/commitlog
  
! # syncmail envoie un mail sur la mailing-list CVS spip-carto-cvs
  ALL $CVSROOT/CVSROOT/syncmail -f mail.berlios.de %{sVv} spip-carto-cvs at lists.berlios.de
  



From mose at berlios.de  Wed Jan 12 04:03:24 2005
From: mose at berlios.de (mose at berlios.de)
Date: Wed, 12 Jan 2005 04:03:24 +0100
Subject: [Spip-carto-cvs] CVSROOT loginfo,1.6,1.7
Message-ID: <200501120303.j0C33ONM019686@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv19672

Modified Files:
	loginfo 
Log Message:
syncmail: diff unifi? plus joli

Index: loginfo
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/loginfo,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** loginfo	12 Jan 2005 03:00:45 -0000	1.6
--- loginfo	12 Jan 2005 03:03:21 -0000	1.7
***************
*** 27,31 ****
  
  # syncmail envoie un mail sur la mailing-list CVS spip-carto-cvs
! ALL $CVSROOT/CVSROOT/syncmail -f mail.berlios.de %{sVv} spip-carto-cvs at lists.berlios.de
  
  # ciabot envoie un message sur irc a chaque commit
--- 27,31 ----
  
  # syncmail envoie un mail sur la mailing-list CVS spip-carto-cvs
! ALL $CVSROOT/CVSROOT/syncmail -u %{sVv} spip-carto-cvs at lists.berlios.de
  
  # ciabot envoie un message sur irc a chaque commit



From mose at sheep.berlios.de  Wed Jan 12 04:16:00 2005
From: mose at sheep.berlios.de (mose at sheep.berlios.de)
Date: Wed, 12 Jan 2005 04:16:00 +0100
Subject: [Spip-carto-cvs] CVSROOT loginfo,1.7,1.8
Message-ID: <200501120316.j0C3G0NM022212@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv22135

Modified Files:
	loginfo 
Log Message:
ajout de precision a propos de ciabot

Index: loginfo
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/loginfo,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- loginfo	12 Jan 2005 03:03:21 -0000	1.7
+++ loginfo	12 Jan 2005 03:15:56 -0000	1.8
@@ -28,6 +28,6 @@
 # syncmail envoie un mail sur la mailing-list CVS spip-carto-cvs
 ALL $CVSROOT/CVSROOT/syncmail -u %{sVv} spip-carto-cvs at lists.berlios.de
 
-# ciabot envoie un message sur irc a chaque commit
+# ciabot envoie un message sur irc a chaque commit sur irc://irc.freenode.net/#spipcarto
 ALL $CVSROOT/CVSROOT/ciabot.pl %s $USER spip-carto noreply at lir.be cia at navi.cx 
 



From mose at sheep.berlios.de  Wed Jan 12 04:23:01 2005
From: mose at sheep.berlios.de (mose at sheep.berlios.de)
Date: Wed, 12 Jan 2005 04:23:01 +0100
Subject: [Spip-carto-cvs] CVSROOT loginfo,1.8,1.9
Message-ID: <200501120323.j0C3N1NM023859@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv23843

Modified Files:
	loginfo 
Log Message:
ajustement du domaine de provenance des mails syncmail

Index: loginfo
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/loginfo,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -d -r1.8 -r1.9
--- loginfo	12 Jan 2005 03:15:56 -0000	1.8
+++ loginfo	12 Jan 2005 03:22:57 -0000	1.9
@@ -26,7 +26,7 @@
 #DEFAULT (echo ""; id; echo %{sVv}; date; cat) >> $CVSROOT/CVSROOT/commitlog
 
 # syncmail envoie un mail sur la mailing-list CVS spip-carto-cvs
-ALL $CVSROOT/CVSROOT/syncmail -u %{sVv} spip-carto-cvs at lists.berlios.de
+ALL $CVSROOT/CVSROOT/syncmail -u -f users.berlios.de %{sVv} spip-carto-cvs at lists.berlios.de
 
 # ciabot envoie un message sur irc a chaque commit sur irc://irc.freenode.net/#spipcarto
 ALL $CVSROOT/CVSROOT/ciabot.pl %s $USER spip-carto noreply at lir.be cia at navi.cx 



From mose at berlios.de  Wed Jan 12 04:25:48 2005
From: mose at berlios.de (mose at berlios.de)
Date: Wed, 12 Jan 2005 04:25:48 +0100
Subject: [Spip-carto-cvs] CVSROOT loginfo,1.9,1.10
Message-ID: <200501120325.j0C3PmNM024714@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv24698

Modified Files:
	loginfo 
Log Message:
verif

Index: loginfo
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/loginfo,v
retrieving revision 1.9
retrieving revision 1.10
diff -u -d -r1.9 -r1.10
--- loginfo	12 Jan 2005 03:22:57 -0000	1.9
+++ loginfo	12 Jan 2005 03:25:46 -0000	1.10
@@ -29,5 +29,6 @@
 ALL $CVSROOT/CVSROOT/syncmail -u -f users.berlios.de %{sVv} spip-carto-cvs at lists.berlios.de
 
 # ciabot envoie un message sur irc a chaque commit sur irc://irc.freenode.net/#spipcarto
+# voir http://cia.navi.cx
 ALL $CVSROOT/CVSROOT/ciabot.pl %s $USER spip-carto noreply at lir.be cia at navi.cx 
 



From stef at berlios.de  Thu Jan 13 16:37:19 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:37:19 +0100
Subject: [Spip-carto-cvs] spipcarto/IMG/icones bz2-dist.png,NONE,1.1 defaut-dist.png,NONE,1.1 wav-dist.png,NONE,1.1 eps-dist.png,NONE,1.1 sit-dist.png,NONE,1.1 sdd-dist.png,NONE,1.1 qt-dist.png,NONE,1.1 rm-dist.png,NONE,1.1 mpg-dist.png,NONE,1.1 xls-dist.png,NONE,1.1 jpg-dist.png,NONE,1.1 asf-dist.png,NONE,1.1 png-dist.png,NONE,1.1 html-dist.png,NONE,1.1 ra-dist.png,NONE,1.1 aiff-dist.png,NONE,1.1 ppt-dist.png,NONE,1.1 xcf-dist.png,NONE,1.1 ogg-dist.png,NONE,1.1 psd-dist.png,NONE,1.1 zip-dist.png,NONE,1.1 sxc-dist.png,NONE,1.1 rtf-dist.png,NONE,1.1 pdf-dist.png,NONE,1.1 gif-dist.png,NONE,1.1 mov-dist.png,NONE,1.1 mid-dist.png,NONE,1.1 deb-dist.png,NONE,1.1 ps-dist.png,NONE,1.1 ram-dist.png,NONE,1.1 sxw-dist.png,NONE,1.1 gz-dist.png,NONE,1.1 txt-dist.png,NONE,1.1 bmp-dist.png,NONE,1.1 sxi-dist.png,NONE,1.1 tex-dist.png,NONE,1.1 avi-dist.png,NONE,1.1 tgz-dist.png,NONE,1.1 mp3-dist.png,NONE,1.1 sdw-dist.png,NONE,1.1 rpm-dist.png,NONE,1.1 ai-dist.png,NONE,1.1 tif-dist.png,NONE,1.1 xml-dist.png,N!
 ONE,1.1 dvi-dist.png,NONE,1.1 doc-dist.png,NONE,1.1
Message-ID: <200501131537.j0DFbINM020189@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/IMG/icones
In directory sheep:/tmp/cvs-serv19649/IMG/icones

Added Files:
	bz2-dist.png defaut-dist.png wav-dist.png eps-dist.png 
	sit-dist.png sdd-dist.png qt-dist.png rm-dist.png mpg-dist.png 
	xls-dist.png jpg-dist.png asf-dist.png png-dist.png 
	html-dist.png ra-dist.png aiff-dist.png ppt-dist.png 
	xcf-dist.png ogg-dist.png psd-dist.png zip-dist.png 
	sxc-dist.png rtf-dist.png pdf-dist.png gif-dist.png 
	mov-dist.png mid-dist.png deb-dist.png ps-dist.png 
	ram-dist.png sxw-dist.png gz-dist.png txt-dist.png 
	bmp-dist.png sxi-dist.png tex-dist.png avi-dist.png 
	tgz-dist.png mp3-dist.png sdw-dist.png rpm-dist.png 
	ai-dist.png tif-dist.png xml-dist.png dvi-dist.png 
	doc-dist.png 
Log Message:
premier proto

--- NEW FILE: bz2-dist.png ---

--- NEW FILE: defaut-dist.png ---

--- NEW FILE: wav-dist.png ---

--- NEW FILE: eps-dist.png ---

--- NEW FILE: sit-dist.png ---

--- NEW FILE: sdd-dist.png ---

--- NEW FILE: qt-dist.png ---

--- NEW FILE: rm-dist.png ---

--- NEW FILE: mpg-dist.png ---

--- NEW FILE: xls-dist.png ---

--- NEW FILE: jpg-dist.png ---

--- NEW FILE: asf-dist.png ---

--- NEW FILE: png-dist.png ---

--- NEW FILE: html-dist.png ---

--- NEW FILE: ra-dist.png ---

--- NEW FILE: aiff-dist.png ---

--- NEW FILE: ppt-dist.png ---

--- NEW FILE: xcf-dist.png ---

--- NEW FILE: ogg-dist.png ---

--- NEW FILE: psd-dist.png ---

--- NEW FILE: zip-dist.png ---

--- NEW FILE: sxc-dist.png ---

--- NEW FILE: rtf-dist.png ---

--- NEW FILE: pdf-dist.png ---

--- NEW FILE: gif-dist.png ---

--- NEW FILE: mov-dist.png ---

--- NEW FILE: mid-dist.png ---

--- NEW FILE: deb-dist.png ---

--- NEW FILE: ps-dist.png ---

--- NEW FILE: ram-dist.png ---

--- NEW FILE: sxw-dist.png ---

--- NEW FILE: gz-dist.png ---

--- NEW FILE: txt-dist.png ---

--- NEW FILE: bmp-dist.png ---

--- NEW FILE: sxi-dist.png ---

--- NEW FILE: tex-dist.png ---

--- NEW FILE: avi-dist.png ---

--- NEW FILE: tgz-dist.png ---

--- NEW FILE: mp3-dist.png ---

--- NEW FILE: sdw-dist.png ---

--- NEW FILE: rpm-dist.png ---

--- NEW FILE: ai-dist.png ---

--- NEW FILE: tif-dist.png ---

--- NEW FILE: xml-dist.png ---

--- NEW FILE: dvi-dist.png ---

--- NEW FILE: doc-dist.png ---



From stef at berlios.de  Thu Jan 13 16:37:16 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:37:16 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/img_pack base-24.gif,NONE,1.1 puce-blanche-anim.gif,NONE,1.1 cal-semaine.gif,NONE,1.1 tirets-separation.gif,NONE,1.1 documents-48.png,NONE,1.1 secteur-24.gif,NONE,1.1 langues-24.gif,NONE,1.1 doc-24.gif,NONE,1.1 fond-calendrier.gif,NONE,1.1 deplierbas.gif,NONE,1.1 loupe-moins.gif,NONE,1.1 visiter-48_rtl.png,NONE,1.1 xml.gif,NONE,1.1 choix-layout_rtl.png,NONE,1.1 statistiques-24.gif,NONE,1.1 administration-48.png,NONE,1.1 m_envoi_rtl.gif,NONE,1.1 image-24.gif,NONE,1.1 redacteurs-48.png,NONE,1.1 interface-display.png,NONE,1.1 forum-public-24.gif,NONE,1.1 rond-b.gif,NONE,1.1 heures-pm.png,NONE,1.1 statistiques-48.png,NONE,1.1 degrade.jpg,NONE,1.1 deplierhaut_rtl.gif,NONE,1.1 rond-g.gif,NONE,1.1 carte-24.png,NONE,1.1 set-ecran.png,NONE,1.1 racine-site-12.gif,NONE,1.1 mot-cle-24.gif,NONE,1.1 loupe.png,NONE,1.1 cadenas-24.gif,NONE,1.1 puce-orange-anim.gif,NONE,1.1 cal-today.gif,NONE,1.1 forum-admin-24.gif,NONE,1.1 heures-am.png,NONE,1.1 asuivre-24.gif,NONE!
 ,1.1 rayures-danger.png,NONE,1.1 logo-spip.gif,NONE,1.1 forum-interne-24.gif,NONE,1.1 rv.gif,NONE,1.1 rayures-gris.gif,NONE,1.1 racine-24.gif,NONE,1.1 fond-gris-anim.gif,NONE,1.1 puce-poubelle.gif,NONE,1.1 groupe-mot-24.gif,NONE,1.1 set-ecran-etroit.png,NONE,1.1 rond-d.gif,NONE,1.1 rv-12.gif,NONE,1.1 plus.gif,NONE,1.1 admin-12.gif,NONE,1.1 suivi-petition-24.gif,NONE,1.1 jauge-rouge.gif,NONE,1.1 fiche-perso.png,NONE,1.1 site-24.gif,NONE,1.1 tout-site.png,NONE,1.1 historique-24.gif,NONE,1.1 rayures-danger.gif,NONE,1.1 m_envoi.gif,NONE,1.1 racine-site-24.gif,NONE,1.1 rond-hg-24.gif,NONE,1.1 choix-layout_rtl_he.png,NONE,1.1 puce-verte-breve.gif,NONE,1.1 traductions-24.gif,NONE,1.1 effacer-cache-24.gif,NONE,1.1 deconnecter-24.gif,NONE,1.1 puce-rouge-breve.gif,NONE,1.1 ortho-24.gif,NONE,1.1 tout-site-24.gif,NONE,1.1 auteur-24.gif,NONE,1.1 visiter-48.png,NONE,1.1 forum-droite_rtl.gif,NONE,1.1 heures-tout.png,NONE,1.1 barre-g.gif,NONE,1.1 rien.gif,NONE,1.1 choix-layout.png,NONE,1.1!
 asuivre-48.png,NONE,1.1 secteur-12.gif,NONE,1.1 cal-suivi.png,NONE,1.
Message-ID: <200501131537.j0DFbGNM020060@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/img_pack
In directory sheep:/tmp/cvs-serv19649/ecrire/img_pack

Added Files:
	base-24.gif puce-blanche-anim.gif cal-semaine.gif 
	tirets-separation.gif documents-48.png secteur-24.gif 
	langues-24.gif doc-24.gif fond-calendrier.gif deplierbas.gif 
	loupe-moins.gif visiter-48_rtl.png xml.gif 
	choix-layout_rtl.png statistiques-24.gif administration-48.png 
	m_envoi_rtl.gif image-24.gif redacteurs-48.png 
	interface-display.png forum-public-24.gif rond-b.gif 
	heures-pm.png statistiques-48.png degrade.jpg 
	deplierhaut_rtl.gif rond-g.gif carte-24.png set-ecran.png 
	racine-site-12.gif mot-cle-24.gif loupe.png cadenas-24.gif 
	puce-orange-anim.gif cal-today.gif forum-admin-24.gif 
	heures-am.png asuivre-24.gif rayures-danger.png logo-spip.gif 
	forum-interne-24.gif rv.gif rayures-gris.gif racine-24.gif 
	fond-gris-anim.gif puce-poubelle.gif groupe-mot-24.gif 
	set-ecran-etroit.png rond-d.gif rv-12.gif plus.gif 
	admin-12.gif suivi-petition-24.gif jauge-rouge.gif 
	fiche-perso.png site-24.gif tout-site.png historique-24.gif 
	rayures-danger.gif m_envoi.gif racine-site-24.gif 
	rond-hg-24.gif choix-layout_rtl_he.png puce-verte-breve.gif 
	traductions-24.gif effacer-cache-24.gif deconnecter-24.gif 
	puce-rouge-breve.gif ortho-24.gif tout-site-24.gif 
	auteur-24.gif visiter-48.png forum-droite_rtl.gif 
	heures-tout.png barre-g.gif rien.gif choix-layout.png 
	asuivre-48.png secteur-12.gif cal-suivi.png puce-blanche.gif 
	edit.gif puce-poubelle-anim.gif cal-rv.png suivi-forum-24.gif 
	naviguer-site.png synchro-24.gif message.gif 
	triangle-droite_rtl.gif barre-noir.gif annonce.gif 
	administration-24.gif fleche-left.png fond-stats.gif creer.gif 
	redacteurs-admin-24.gif tourner-gauche.gif fleche-right.png 
	rayures-fines.gif cache-24.gif rond-hd-24.gif aide-48.png 
	breve-24.gif m_envoi_jaune.gif tourner-droite.gif aide_rtl.gif 
	index.php3 interface-display-comp.png article-24.gif 
	puce-rouge-anim.gif rond-bd.gif forum-droite.gif aide.gif 
	redacteurs-poubelle-24.gif petition-24.gif jauge-fond.gif 
	triangle-bas.gif cookie-24.gif pense-bete.gif jauge-vert.gif 
	tourner-180.gif messagerie-48.png calendrier-24.gif 
	puce-orange-breve.gif petite-cle.gif rayures-sup.gif 
	langues-off-12.gif rond-bg.gif messagerie-24.gif rayures.gif 
	warning-24.gif puce-orange.gif fiche-perso-24.gif 
	loupe-plus.gif cal-messagerie.png puce-verte-anim.gif 
	barre-d.gif barre-blanc.gif poubelle.gif 
	puce-poubelle-breve.gif m_envoi_bleu.gif rubrique-24.gif 
	forum-vert.gif supprimer.gif puce-rouge.gif rond-h-24.gif 
	m_envoi_jaune_rtl.gif cal-mois.gif m_envoi_bleu_rtl.gif 
	cal-jour.gif visit-12.gif aide-48_rtl.png langues-12.gif 
	fond-agenda.gif triangle-bleu.gif carte-24.gif rubrique-12.gif 
	croix-rouge.gif triangle_rtl.gif spip_out.gif 
	redacteurs-24.gif langues-modif-12.gif agenda-24.gif 
	triangle-droite.gif puce-verte.gif warning.gif referers-24.gif 
	redac-12.gif documents-48_rtl.png puce-blanche-breve.gif 
	deplierhaut.gif triangle.gif triangle-bleu-bas.gif 
Log Message:
premier proto

--- NEW FILE: base-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-blanche-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-semaine.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tirets-separation.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: documents-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: secteur-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: doc-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-calendrier.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deplierbas.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: loupe-moins.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: visiter-48_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: xml.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: choix-layout_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: statistiques-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: administration-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: image-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: interface-display.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-public-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-b.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: heures-pm.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: statistiques-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: degrade.jpg ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deplierhaut_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-g.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: carte-24.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: set-ecran.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: racine-site-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: mot-cle-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: loupe.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cadenas-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-orange-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-today.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-admin-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: heures-am.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: asuivre-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-danger.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: logo-spip.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-interne-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rv.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-gris.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: racine-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-gris-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-poubelle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: groupe-mot-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: set-ecran-etroit.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-d.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rv-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: plus.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: admin-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: suivi-petition-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: jauge-rouge.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fiche-perso.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: site-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tout-site.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: historique-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-danger.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: racine-site-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-hg-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: choix-layout_rtl_he.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-verte-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: traductions-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: effacer-cache-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deconnecter-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-rouge-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ortho-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tout-site-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: auteur-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: visiter-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-droite_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: heures-tout.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-g.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rien.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: choix-layout.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: asuivre-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: secteur-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-suivi.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-blanche.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: edit.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-poubelle-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-rv.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: suivi-forum-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: naviguer-site.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: synchro-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: message.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-droite_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-noir.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: annonce.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: administration-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fleche-left.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-stats.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: creer.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-admin-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tourner-gauche.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fleche-right.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-fines.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cache-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-hd-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: breve-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_jaune.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tourner-droite.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: index.php3 ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>Index des icones de Spip</title>
	<link rel="up" href="../">
</head>
<body>
	<center>
		<h1>Index des icones de <a href='http://www.spip.net'>Spip</a></h1>
		<table>
<?php
	$myDir = opendir('.');
	while($file = readdir($myDir)) {
		if (ereg("\.(png|gif)$", $file))
			echo "		<tr><td>$file</td><td><img src='$file' alt='$file' /></td></tr>\n";
	}
?>

		</table>
	</center>
</body>
</html>
--- NEW FILE: interface-display-comp.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: article-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-rouge-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-bd.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-droite.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-poubelle-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: petition-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: jauge-fond.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-bas.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cookie-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: pense-bete.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: jauge-vert.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tourner-180.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: messagerie-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: calendrier-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-orange-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: petite-cle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-sup.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-off-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-bg.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: messagerie-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: warning-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-orange.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fiche-perso-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: loupe-plus.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-messagerie.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-verte-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-d.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-blanc.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: poubelle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-poubelle-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_bleu.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rubrique-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-vert.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: supprimer.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-rouge.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-h-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_jaune_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-mois.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_bleu_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-jour.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: visit-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide-48_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-agenda.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-bleu.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: carte-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rubrique-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: croix-rouge.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: spip_out.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-modif-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: agenda-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-droite.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-verte.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: warning.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: referers-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redac-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: documents-48_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-blanche-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deplierhaut.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-bleu-bas.gif ---
(This appears to be a binary file; contents omitted.)



From stef at berlios.de  Thu Jan 13 16:37:17 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:37:17 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/lang spip_en.php3,NONE,1.1 public_oc_auv.php3,NONE,1.1 public_es.php3,NONE,1.1 spip_bg.php3,NONE,1.1 public_fa.php3,NONE,1.1 spip_es.php3,NONE,1.1 spip_oc_auv.php3,NONE,1.1 spip_oc_lms.php3,NONE,1.1 spip_fr.php3,NONE,1.1 spip_oc_prv.php3,NONE,1.1 spip_ca.php3,NONE,1.1 public_fon.php3,NONE,1.1 spip_lb.php3,NONE,1.1 spip_gl.php3,NONE,1.1 spip_oc_gsc.php3,NONE,1.1 public_eo.php3,NONE,1.1 spip_fa.php3,NONE,1.1 public_cpf.php3,NONE,1.1 spip_zh.php3,NONE,1.1 public_fr.php3,NONE,1.1 spip_eo.php3,NONE,1.1 public_ar.php3,NONE,1.1 public_pl.php3,NONE,1.1 spip_oc_lnc.php3,NONE,1.1 public_vi.php3,NONE,1.1 spip_ar.php3,NONE,1.1 spip_hu.php3,NONE,1.1 spip_de.php3,NONE,1.1 public_bg.php3,NONE,1.1 spip_pl.php3,NONE,1.1 spip_cpf.php3,NONE,1.1 spip_oc_va.php3,NONE,1.1 spip_da.php3,NONE,1.1 public_it.php3,NONE,1.1 spip_nl.php3,NONE,1.1 public_lb.php3,NONE,1.1 public_hu.php3,NONE,1.1 public_oc_ni.php3,NONE,1.1 spip_oc_ni.php3,NONE,1.1 public_oc_lnc.php3,NONE,1.1 public!
 _de.php3,NONE,1.1 public_zh.php3,NONE,1.1 public_nl.php3,NONE,1.1 public_en.php3,NONE,1.1 public_da.php3,NONE,1.1 spip_fon.php3,NONE,1.1 spip_pt.php3,NONE,1.1 public_oc_prv.php3,NONE,1.1 spip_it.php3,NONE,1.1 public_gl.php3,NONE,1.1 spip_vi.php3,NONE,1.1 public_ca.php3,NONE,1.1 public_pt.php3,NONE,1.1
Message-ID: <200501131537.j0DFbHNM020073@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/lang
In directory sheep:/tmp/cvs-serv19649/ecrire/lang

Added Files:
	spip_en.php3 public_oc_auv.php3 public_es.php3 spip_bg.php3 
	public_fa.php3 spip_es.php3 spip_oc_auv.php3 spip_oc_lms.php3 
	spip_fr.php3 spip_oc_prv.php3 spip_ca.php3 public_fon.php3 
	spip_lb.php3 spip_gl.php3 spip_oc_gsc.php3 public_eo.php3 
	spip_fa.php3 public_cpf.php3 spip_zh.php3 public_fr.php3 
	spip_eo.php3 public_ar.php3 public_pl.php3 spip_oc_lnc.php3 
	public_vi.php3 spip_ar.php3 spip_hu.php3 spip_de.php3 
	public_bg.php3 spip_pl.php3 spip_cpf.php3 spip_oc_va.php3 
	spip_da.php3 public_it.php3 spip_nl.php3 public_lb.php3 
	public_hu.php3 public_oc_ni.php3 spip_oc_ni.php3 
	public_oc_lnc.php3 public_de.php3 public_zh.php3 
	public_nl.php3 public_en.php3 public_da.php3 spip_fon.php3 
	spip_pt.php3 public_oc_prv.php3 spip_it.php3 public_gl.php3 
	spip_vi.php3 public_ca.php3 public_pt.php3 
Log Message:
premier proto

--- NEW FILE: spip_en.php3 ---

--- NEW FILE: public_oc_auv.php3 ---

--- NEW FILE: public_es.php3 ---

--- NEW FILE: spip_bg.php3 ---

--- NEW FILE: public_fa.php3 ---

--- NEW FILE: spip_es.php3 ---

--- NEW FILE: spip_oc_auv.php3 ---

--- NEW FILE: spip_oc_lms.php3 ---

--- NEW FILE: spip_fr.php3 ---

--- NEW FILE: spip_oc_prv.php3 ---

--- NEW FILE: spip_ca.php3 ---

--- NEW FILE: public_fon.php3 ---

--- NEW FILE: spip_lb.php3 ---

--- NEW FILE: spip_gl.php3 ---

--- NEW FILE: spip_oc_gsc.php3 ---

--- NEW FILE: public_eo.php3 ---

--- NEW FILE: spip_fa.php3 ---

--- NEW FILE: public_cpf.php3 ---

--- NEW FILE: spip_zh.php3 ---

--- NEW FILE: public_fr.php3 ---

--- NEW FILE: spip_eo.php3 ---

--- NEW FILE: public_ar.php3 ---

--- NEW FILE: public_pl.php3 ---

--- NEW FILE: spip_oc_lnc.php3 ---

--- NEW FILE: public_vi.php3 ---

--- NEW FILE: spip_ar.php3 ---

--- NEW FILE: spip_hu.php3 ---

--- NEW FILE: spip_de.php3 ---

--- NEW FILE: public_bg.php3 ---

--- NEW FILE: spip_pl.php3 ---

--- NEW FILE: spip_cpf.php3 ---

--- NEW FILE: spip_oc_va.php3 ---

--- NEW FILE: spip_da.php3 ---

--- NEW FILE: public_it.php3 ---

--- NEW FILE: spip_nl.php3 ---

--- NEW FILE: public_lb.php3 ---

--- NEW FILE: public_hu.php3 ---

--- NEW FILE: public_oc_ni.php3 ---

--- NEW FILE: spip_oc_ni.php3 ---

--- NEW FILE: public_oc_lnc.php3 ---

--- NEW FILE: public_de.php3 ---

--- NEW FILE: public_zh.php3 ---

--- NEW FILE: public_nl.php3 ---

--- NEW FILE: public_en.php3 ---

--- NEW FILE: public_da.php3 ---

--- NEW FILE: spip_fon.php3 ---

--- NEW FILE: spip_pt.php3 ---

--- NEW FILE: public_oc_prv.php3 ---

--- NEW FILE: spip_it.php3 ---

--- NEW FILE: public_gl.php3 ---

--- NEW FILE: spip_vi.php3 ---

--- NEW FILE: public_ca.php3 ---

--- NEW FILE: public_pt.php3 ---



From stef at berlios.de  Thu Jan 13 16:37:18 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:37:18 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire inc_meta.php3,NONE,1.1 suivi_revisions.php3,NONE,1.1 .cvsignore,NONE,1.1 index.php3,NONE,1.1 delete_all.php3,NONE,1.1 puce_rtl.gif,NONE,1.1 inc_objet_base.php3,NONE,1.1 inc_mail.php3,NONE,1.1 controle_petition.php3,NONE,1.1 inc_filtres.php3,NONE,1.1 calendrier_semaine.php3,NONE,1.1 breves_voir.php3,NONE,1.1 calendrier_jour.php3,NONE,1.1 unpack.php3,NONE,1.1 lab_revisions.php,NONE,1.1 inc_base.php3,NONE,1.1 naviguer.php3,NONE,1.1 rubriques_edit.php3,NONE,1.1 inc_auth_spip.php3,NONE,1.1 brouteur.php3,NONE,1.1 gnu_lgpl_fr.txt,NONE,1.1 inc_auth_ldap.php3,NONE,1.1 install.php3,NONE,1.1 inc_lab.php,NONE,1.1 auteur_messagerie.php3,NONE,1.1 spip_style_print.css,NONE,1.1 admin_tech.php3,NONE,1.1 gpl_fr.txt,NONE,1.1 import_all.php3,NONE,1.1 forum.php3,NONE,1.1 inc_auth.php3,NONE,1.1 puce.gif,NONE,1.1 inc_db_mysql.php3,NONE,1.1 admin_effacer.php3,NONE,1.1 inc_auxbase.php3,NONE,1.1 js_detectplugins.js,NONE,1.1 inc_index.php3,NONE,1.1 breves.php3,NONE,1.1 inc_su!
 ivi_revisions.php,NONE,1.1 inc_calendrier.php,NONE,1.1 message.php3,NONE,1.1 cartes.php3,NONE,1.1 inc_surligne.php3,NONE,1.1 statistiques_visites.php3,NONE,1.1 http.class.php,NONE,1.1 mes_options.php3,NONE,1.1 inc_layer.php3,NONE,1.1 articles.php3,NONE,1.1 licence_fr.html,NONE,1.1 inc_lang.php3,NONE,1.1 admin_vider.php3,NONE,1.1 lang_raccourcis.php3,NONE,1.1 articles_versions.php3,NONE,1.1 auteurs_edit.php3,NONE,1.1 inc_charsets.php3,NONE,1.1 inc_math.php3,NONE,1.1 inc_cron.php3,NONE,1.1 inc_majbase.php3,NONE,1.1 calendrier.php3,NONE,1.1 articles_edit.php3,NONE,1.1 carte_edit.php3,NONE,1.1 inc_config.php3,NONE,1.1 inc_tidy.php,NONE,1.1 inc_logos.php3,NONE,1.1 config-contenu.php3,NONE,1.1 statistiques.php3,NONE,1.1 inc_abstract_sql.php3,NONE,1.1 articles_forum.php3,NONE,1.1 spip_style.php3,NONE,1.1 inc_rubriques.php3,NONE,1.1 accents.php3,NONE,1.1 info.php3,NONE,1.1 brouteur_frame.php3,NONE,1.1 md5.js,NONE,1.1 sites_edit.php3,NONE,1.1 inc_presentation.php3,NONE,1.1 sites.php!
 3,NONE,1.1 license.txt,NONE,1.1 win_png.htc,NONE,1.1 layer.js,NONE,1.1
Message-ID: <200501131537.j0DFbINM020129@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv19649/ecrire

Added Files:
	inc_meta.php3 suivi_revisions.php3 .cvsignore index.php3 
	delete_all.php3 puce_rtl.gif inc_objet_base.php3 inc_mail.php3 
	controle_petition.php3 inc_filtres.php3 
	calendrier_semaine.php3 breves_voir.php3 calendrier_jour.php3 
	unpack.php3 lab_revisions.php inc_base.php3 naviguer.php3 
	rubriques_edit.php3 inc_auth_spip.php3 brouteur.php3 
	gnu_lgpl_fr.txt inc_auth_ldap.php3 install.php3 inc_lab.php 
	auteur_messagerie.php3 spip_style_print.css admin_tech.php3 
	gpl_fr.txt import_all.php3 forum.php3 inc_auth.php3 puce.gif 
	inc_db_mysql.php3 admin_effacer.php3 inc_auxbase.php3 
	js_detectplugins.js inc_index.php3 breves.php3 
	inc_suivi_revisions.php inc_calendrier.php message.php3 
	cartes.php3 inc_surligne.php3 statistiques_visites.php3 
	http.class.php mes_options.php3 inc_layer.php3 articles.php3 
	licence_fr.html inc_lang.php3 admin_vider.php3 
	lang_raccourcis.php3 articles_versions.php3 auteurs_edit.php3 
	inc_charsets.php3 inc_math.php3 inc_cron.php3 inc_majbase.php3 
	calendrier.php3 articles_edit.php3 carte_edit.php3 
	inc_config.php3 inc_tidy.php inc_logos.php3 
	config-contenu.php3 statistiques.php3 inc_abstract_sql.php3 
	articles_forum.php3 spip_style.php3 inc_rubriques.php3 
	accents.php3 info.php3 brouteur_frame.php3 md5.js 
	sites_edit.php3 inc_presentation.php3 sites.php3 license.txt 
	win_png.htc layer.js optimiser.php3 copyright_fr.html 
	mots_type.php3 iframe_action.php3 inc_debug_sql.php3 
	inc_documents.php3 auteur_infos.php3 inc.php3 auteurs.php3 
	inc_acces.php3 statistiques_lang.php3 dhtml_tools.css 
	mots_edit.php3 engines-list.txt synchro.php3 breves_edit.php3 
	export_all.php3 inc_version.php3 inc_statistiques.php3 
	controle_forum.php3 inc_barre.php3 inc_texte.php3 
	lab_ortho.php inc_visites.php3 inc_getdocument.php3 
	win_width.htc mots_tous.php3 inc_carto.php3 pclzip.lib.php 
	message_edit.php3 forum_admin.php3 inc_import.php3 
	inc_config_plug.php3 inc_invalideur.php3 inc_popularites.php3 
	upgrade.php3 articles_ortho.php config-fonctions.php3 
	documents_liste.php3 inc_mots.php3 inc_serialbase.php3 
	config-lang.php3 forum_envoi.php3 inc_urls.php3 
	aide_index.php3 inc_export.php3 inc_forum.php3 inc_extra.php3 
	spip_style_invisible.css statistiques_referers.php3 
	inc_objet.php3 js_menu_rubriques.php inc_sites.php3 index.php 
	articles_page.php3 export.php3 sites_tous.php3 recherche.php3 
	admin_index.php3 inc_session.php3 admin_repair.php3 
	articles_tous.php3 inc_flock.php3 messagerie.php3 lab_diff.php 
	config-multilang.php3 inc_admin.php3 configuration.php3 
	spip_style_visible.css statistiques_svg.php3 
Log Message:
premier proto

--- NEW FILE: inc_meta.php3 ---

--- NEW FILE: suivi_revisions.php3 ---

--- NEW FILE: .cvsignore ---

--- NEW FILE: index.php3 ---

--- NEW FILE: delete_all.php3 ---

--- NEW FILE: puce_rtl.gif ---

--- NEW FILE: inc_objet_base.php3 ---

--- NEW FILE: inc_mail.php3 ---

--- NEW FILE: controle_petition.php3 ---

--- NEW FILE: inc_filtres.php3 ---

--- NEW FILE: calendrier_semaine.php3 ---

--- NEW FILE: breves_voir.php3 ---

--- NEW FILE: calendrier_jour.php3 ---

--- NEW FILE: unpack.php3 ---

--- NEW FILE: lab_revisions.php ---

--- NEW FILE: inc_base.php3 ---

--- NEW FILE: naviguer.php3 ---

--- NEW FILE: rubriques_edit.php3 ---

--- NEW FILE: inc_auth_spip.php3 ---

--- NEW FILE: brouteur.php3 ---

--- NEW FILE: gnu_lgpl_fr.txt ---

--- NEW FILE: inc_auth_ldap.php3 ---

--- NEW FILE: install.php3 ---

--- NEW FILE: inc_lab.php ---

--- NEW FILE: auteur_messagerie.php3 ---

--- NEW FILE: spip_style_print.css ---

--- NEW FILE: admin_tech.php3 ---

--- NEW FILE: gpl_fr.txt ---

--- NEW FILE: import_all.php3 ---

--- NEW FILE: forum.php3 ---

--- NEW FILE: inc_auth.php3 ---

--- NEW FILE: puce.gif ---

--- NEW FILE: inc_db_mysql.php3 ---

--- NEW FILE: admin_effacer.php3 ---

--- NEW FILE: inc_auxbase.php3 ---

--- NEW FILE: js_detectplugins.js ---

--- NEW FILE: inc_index.php3 ---

--- NEW FILE: breves.php3 ---

--- NEW FILE: inc_suivi_revisions.php ---

--- NEW FILE: inc_calendrier.php ---

--- NEW FILE: message.php3 ---

--- NEW FILE: cartes.php3 ---

--- NEW FILE: inc_surligne.php3 ---

--- NEW FILE: statistiques_visites.php3 ---

--- NEW FILE: http.class.php ---

--- NEW FILE: mes_options.php3 ---

--- NEW FILE: inc_layer.php3 ---

--- NEW FILE: articles.php3 ---

--- NEW FILE: licence_fr.html ---

--- NEW FILE: inc_lang.php3 ---

--- NEW FILE: admin_vider.php3 ---

--- NEW FILE: lang_raccourcis.php3 ---

--- NEW FILE: articles_versions.php3 ---

--- NEW FILE: auteurs_edit.php3 ---

--- NEW FILE: inc_charsets.php3 ---

--- NEW FILE: inc_math.php3 ---

--- NEW FILE: inc_cron.php3 ---

--- NEW FILE: inc_majbase.php3 ---

--- NEW FILE: calendrier.php3 ---

--- NEW FILE: articles_edit.php3 ---

--- NEW FILE: carte_edit.php3 ---

--- NEW FILE: inc_config.php3 ---

--- NEW FILE: inc_tidy.php ---

--- NEW FILE: inc_logos.php3 ---

--- NEW FILE: config-contenu.php3 ---

--- NEW FILE: statistiques.php3 ---

--- NEW FILE: inc_abstract_sql.php3 ---

--- NEW FILE: articles_forum.php3 ---

--- NEW FILE: spip_style.php3 ---

--- NEW FILE: inc_rubriques.php3 ---

--- NEW FILE: accents.php3 ---

--- NEW FILE: info.php3 ---

--- NEW FILE: brouteur_frame.php3 ---

--- NEW FILE: md5.js ---

--- NEW FILE: sites_edit.php3 ---

--- NEW FILE: inc_presentation.php3 ---

--- NEW FILE: sites.php3 ---

--- NEW FILE: license.txt ---

--- NEW FILE: win_png.htc ---

--- NEW FILE: layer.js ---

--- NEW FILE: optimiser.php3 ---

--- NEW FILE: copyright_fr.html ---

--- NEW FILE: mots_type.php3 ---

--- NEW FILE: iframe_action.php3 ---

--- NEW FILE: inc_debug_sql.php3 ---

--- NEW FILE: inc_documents.php3 ---

--- NEW FILE: auteur_infos.php3 ---

--- NEW FILE: inc.php3 ---

--- NEW FILE: auteurs.php3 ---

--- NEW FILE: inc_acces.php3 ---

--- NEW FILE: statistiques_lang.php3 ---

--- NEW FILE: dhtml_tools.css ---

--- NEW FILE: mots_edit.php3 ---

--- NEW FILE: engines-list.txt ---

--- NEW FILE: synchro.php3 ---

--- NEW FILE: breves_edit.php3 ---

--- NEW FILE: export_all.php3 ---

--- NEW FILE: inc_version.php3 ---

--- NEW FILE: inc_statistiques.php3 ---

--- NEW FILE: controle_forum.php3 ---

--- NEW FILE: inc_barre.php3 ---

--- NEW FILE: inc_texte.php3 ---

--- NEW FILE: lab_ortho.php ---

--- NEW FILE: inc_visites.php3 ---

--- NEW FILE: inc_getdocument.php3 ---

--- NEW FILE: win_width.htc ---

--- NEW FILE: mots_tous.php3 ---

--- NEW FILE: inc_carto.php3 ---

--- NEW FILE: pclzip.lib.php ---

--- NEW FILE: message_edit.php3 ---

--- NEW FILE: forum_admin.php3 ---

--- NEW FILE: inc_import.php3 ---

--- NEW FILE: inc_config_plug.php3 ---

--- NEW FILE: inc_invalideur.php3 ---

--- NEW FILE: inc_popularites.php3 ---

--- NEW FILE: upgrade.php3 ---

--- NEW FILE: articles_ortho.php ---

--- NEW FILE: config-fonctions.php3 ---

--- NEW FILE: documents_liste.php3 ---

--- NEW FILE: inc_mots.php3 ---

--- NEW FILE: inc_serialbase.php3 ---

--- NEW FILE: config-lang.php3 ---

--- NEW FILE: forum_envoi.php3 ---

--- NEW FILE: inc_urls.php3 ---

--- NEW FILE: aide_index.php3 ---

--- NEW FILE: inc_export.php3 ---

--- NEW FILE: inc_forum.php3 ---

--- NEW FILE: inc_extra.php3 ---

--- NEW FILE: spip_style_invisible.css ---

--- NEW FILE: statistiques_referers.php3 ---

--- NEW FILE: inc_objet.php3 ---

--- NEW FILE: js_menu_rubriques.php ---

--- NEW FILE: inc_sites.php3 ---

--- NEW FILE: index.php ---

--- NEW FILE: articles_page.php3 ---

--- NEW FILE: export.php3 ---

--- NEW FILE: sites_tous.php3 ---

--- NEW FILE: recherche.php3 ---

--- NEW FILE: admin_index.php3 ---

--- NEW FILE: inc_session.php3 ---

--- NEW FILE: admin_repair.php3 ---

--- NEW FILE: articles_tous.php3 ---

--- NEW FILE: inc_flock.php3 ---

--- NEW FILE: messagerie.php3 ---

--- NEW FILE: lab_diff.php ---

--- NEW FILE: config-multilang.php3 ---

--- NEW FILE: inc_admin.php3 ---

--- NEW FILE: configuration.php3 ---

--- NEW FILE: spip_style_visible.css ---

--- NEW FILE: statistiques_svg.php3 ---



From stef at berlios.de  Thu Jan 13 16:28:09 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:09 +0100
Subject: [Spip-carto-cvs] spipcarto/CACHE - New directory
Message-ID: <200501131528.j0DFS9NM019538@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/CACHE
In directory sheep:/tmp/cvs-serv19500/CACHE

Log Message:
Directory /cvsroot/spip-carto/spipcarto/CACHE added to the repository




From stef at berlios.de  Thu Jan 13 16:28:10 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:10 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire - New directory
Message-ID: <200501131528.j0DFSANM019564@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv19500/ecrire

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire added to the repository




From stef at berlios.de  Thu Jan 13 16:28:10 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:10 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/img_pack - New directory
Message-ID: <200501131528.j0DFSANM019572@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/img_pack
In directory sheep:/tmp/cvs-serv19500/ecrire/img_pack

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire/img_pack added to the repository




From stef at berlios.de  Thu Jan 13 16:28:09 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:09 +0100
Subject: [Spip-carto-cvs] spipcarto/IMG - New directory
Message-ID: <200501131528.j0DFS9NM019544@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/IMG
In directory sheep:/tmp/cvs-serv19500/IMG

Log Message:
Directory /cvsroot/spip-carto/spipcarto/IMG added to the repository




From stef at berlios.de  Thu Jan 13 16:27:12 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:27:12 +0100
Subject: [Spip-carto-cvs] spipcarto - New directory
Message-ID: <200501131527.j0DFRCNM019468@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv19462/spipcarto

Log Message:
Directory /cvsroot/spip-carto/spipcarto added to the repository




From stef at berlios.de  Thu Jan 13 16:28:12 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:12 +0100
Subject: [Spip-carto-cvs] spipcarto/oo - New directory
Message-ID: <200501131528.j0DFSCNM019590@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/oo
In directory sheep:/tmp/cvs-serv19500/oo

Log Message:
Directory /cvsroot/spip-carto/spipcarto/oo added to the repository




From stef at berlios.de  Thu Jan 13 16:28:10 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:10 +0100
Subject: [Spip-carto-cvs] spipcarto/IMG/icones_barre - New directory
Message-ID: <200501131528.j0DFSANM019558@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/IMG/icones_barre
In directory sheep:/tmp/cvs-serv19500/IMG/icones_barre

Log Message:
Directory /cvsroot/spip-carto/spipcarto/IMG/icones_barre added to the repository




From stef at berlios.de  Thu Jan 13 16:28:11 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:11 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/js - New directory
Message-ID: <200501131528.j0DFSBNM019575@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/js
In directory sheep:/tmp/cvs-serv19500/ecrire/js

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire/js added to the repository




From stef at berlios.de  Thu Jan 13 16:28:11 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:11 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/lang - New directory
Message-ID: <200501131528.j0DFSBNM019578@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/lang
In directory sheep:/tmp/cvs-serv19500/ecrire/lang

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire/lang added to the repository




From stef at berlios.de  Thu Jan 13 16:28:09 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:09 +0100
Subject: [Spip-carto-cvs] spipcarto/IMG/icones - New directory
Message-ID: <200501131528.j0DFS9NM019551@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/IMG/icones
In directory sheep:/tmp/cvs-serv19500/IMG/icones

Log Message:
Directory /cvsroot/spip-carto/spipcarto/IMG/icones added to the repository




From stef at berlios.de  Thu Jan 13 16:28:11 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:11 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/plugins - New directory
Message-ID: <200501131528.j0DFSBNM019584@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/plugins
In directory sheep:/tmp/cvs-serv19500/ecrire/plugins

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire/plugins added to the repository




From stef at berlios.de  Thu Jan 13 16:28:10 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:10 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/data - New directory
Message-ID: <200501131528.j0DFSANM019569@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/data
In directory sheep:/tmp/cvs-serv19500/ecrire/data

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire/data added to the repository




From stef at berlios.de  Thu Jan 13 16:28:12 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:12 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/upload - New directory
Message-ID: <200501131528.j0DFSCNM019587@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/upload
In directory sheep:/tmp/cvs-serv19500/ecrire/upload

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire/upload added to the repository




From stef at berlios.de  Thu Jan 13 16:28:11 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:28:11 +0100
Subject: [Spip-carto-cvs] spipcarto/ecrire/oo - New directory
Message-ID: <200501131528.j0DFSBNM019581@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto/ecrire/oo
In directory sheep:/tmp/cvs-serv19500/ecrire/oo

Log Message:
Directory /cvsroot/spip-carto/spipcarto/ecrire/oo added to the repository




From stef at berlios.de  Thu Jan 13 16:37:17 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:37:17 +0100
Subject: [Spip-carto-cvs] spipcarto inc-html-squel.php3,NONE,1.1 formulaire_signature-dist.html,NONE,1.1 formulaire_oubli-dist.html,NONE,1.1 inc-urls-html.php3,NONE,1.1 spip_cal.php3,NONE,1.1 spip_inscription.php3,NONE,1.1 rubrique.php3,NONE,1.1 spip_image.php3,NONE,1.1 inc-urls-standard.php3,NONE,1.1 ical-dist.html,NONE,1.1 auteur.php3,NONE,1.1 downloadfile.class.php,NONE,1.1 index.php3,NONE,1.1 nouveautes-dist.html,NONE,1.1 inc-public.php3,NONE,1.1 inc-messforum.php3,NONE,1.1 distrib.php3,NONE,1.1 inc-cache.php3,NONE,1.1 sommaire_texte-dist.html,NONE,1.1 mot-dist.html,NONE,1.1 forum-dist.html,NONE,1.1 htaccess-propres.txt,NONE,1.1 recherche.php3,NONE,1.1 inc-formulaire_recherche.php3,NONE,1.1 spip_test_dirs.php3,NONE,1.1 formulaire_menu_lang-dist.html,NONE,1.1 inc-formulaire_site.php3,NONE,1.1 project.index,NONE,1.1 site.php3,NONE,1.1 backend-dist.html,NONE,1.1 spip_cookie.php3,NONE,1.1 spip_image_reduite.php3,NONE,1.1 inc-menu_lang_ecrire.php3,NONE,1.1 formulaire_ecrire_auteur-dist.html,N!
 ONE,1.1 inc-chercher.php3,NONE,1.1 formulaire_forum-dist.html,NONE,1.1 habillage.css,NONE,1.1 puce_rtl.gif,NONE,1.1 sommaire.php3,NONE,1.1 carto.html,NONE,1.1 rubrique-dist.html,NONE,1.1 spip_admin.css,NONE,1.1 spip_cache.php3,NONE,1.1 site-dist.html,NONE,1.1 sommaire_texte.php3,NONE,1.1 spip_redirect.php3,NONE,1.1 .project,NONE,1.1 breve.php3,NONE,1.1 resume.php3,NONE,1.1 inc-login_prive.php3,NONE,1.1 inc-formulaire_inscription.php3,NONE,1.1 plan-dist.html,NONE,1.1 spip_barre.js,NONE,1.1 spip_style.css,NONE,1.1 ical.php3,NONE,1.1 article-dist.html,NONE,1.1 forum.php3,NONE,1.1 resume-dist.html,NONE,1.1 puce.gif,NONE,1.1 carto.php3,NONE,1.1 inc-formulaire_ecrire_auteur.php3,NONE,1.1 formulaire_admin-dist.html,NONE,1.1 inc-menu_lang.php3,NONE,1.1 plan.php3,NONE,1.1 backend-breves-dist.html,NONE,1.1 spip_acces_doc.php3,NONE,1.1 index.php,NONE,1.1 inc-boucles.php3,NONE,1.1 inc-compilo.php3,NONE,1.1 spipcarto.zip,NONE,1.1 formulaire_site-dist.html,NONE,1.1 inc-compilo-api.php3,N!
 ONE,1.1 formulaire_login-dist.html,NONE,1.1 backend.php3,NONE,1.1 logi
Message-ID: <200501131537.j0DFbHNM020070@sheep.berlios.de>

Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv19649

Added Files:
	inc-html-squel.php3 formulaire_signature-dist.html 
	formulaire_oubli-dist.html inc-urls-html.php3 spip_cal.php3 
	spip_inscription.php3 rubrique.php3 spip_image.php3 
	inc-urls-standard.php3 ical-dist.html auteur.php3 
	downloadfile.class.php index.php3 nouveautes-dist.html 
	inc-public.php3 inc-messforum.php3 distrib.php3 inc-cache.php3 
	sommaire_texte-dist.html mot-dist.html forum-dist.html 
	htaccess-propres.txt recherche.php3 
	inc-formulaire_recherche.php3 spip_test_dirs.php3 
	formulaire_menu_lang-dist.html inc-formulaire_site.php3 
	project.index site.php3 backend-dist.html spip_cookie.php3 
	spip_image_reduite.php3 inc-menu_lang_ecrire.php3 
	formulaire_ecrire_auteur-dist.html inc-chercher.php3 
	formulaire_forum-dist.html habillage.css puce_rtl.gif 
	sommaire.php3 carto.html rubrique-dist.html spip_admin.css 
	spip_cache.php3 site-dist.html sommaire_texte.php3 
	spip_redirect.php3 .project breve.php3 resume.php3 
	inc-login_prive.php3 inc-formulaire_inscription.php3 
	plan-dist.html spip_barre.js spip_style.css ical.php3 
	article-dist.html forum.php3 resume-dist.html puce.gif 
	carto.php3 inc-formulaire_ecrire_auteur.php3 
	formulaire_admin-dist.html inc-menu_lang.php3 plan.php3 
	backend-breves-dist.html spip_acces_doc.php3 index.php 
	inc-boucles.php3 inc-compilo.php3 spipcarto.zip 
	formulaire_site-dist.html inc-compilo-api.php3 
	formulaire_login-dist.html backend.php3 login-dist.html 
	inc-calcul.php3 inc-public-global.php3 
	inc-formulaire_forum.php3 inc-urls-propres.php3 
	inc-formulaire_admin.php3 inc-balises.php3 inc-criteres.php3 
	carto-proto.sql spip_login.php3 distrib-dist.html 
	sommaire-dist.html mot.php3 inc-stats.php3 auteur-dist.html 
	spip_background.php3 mes_fonctions.php3 impression.css 
	backend-breves.php3 typographie.css article.php3 
	recherche-dist.html spip_carto.php 
	formulaire_inscription-dist.html inc-url_logout.php3 
	inc-compilo-index.php3 inc-login_public.php3 inc-admin.php3 
	inc-formulaire_signature.php3 inc-calcul-outils.php3 
	breve-dist.html spip_pass.php3 formulaire_recherche-dist.html 
	htaccess-html.txt 
Log Message:
premier proto

--- NEW FILE: inc-html-squel.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_HTML_SQUEL")) return;
define("_INC_HTML_SQUEL", "1");

# Ce fichier doit IMPERATIVEMENT contenir la fonction "parser"
# qui transforme un squelette en un tableau d'objets de classe Boucle
# il est charge par un include calcule dans inc-calcul-squel
# pour permettre differentes syntaxes en entree

define('NOM_DE_BOUCLE', "[0-9]+|[-_][-_.a-zA-Z0-9]*");
define('NOM_DE_CHAMP', "#((" . NOM_DE_BOUCLE . "):)?([A-Z_]+)(\*?)");
define('CHAMP_ETENDU', '\[([^]\[]*)\(' . NOM_DE_CHAMP . '([^]\[)]*)\)([^]\[]*)\]');
define('PARAM_DE_BOUCLE','[[:space:]]*\{[[:space:]]*([^{}]*(\{[^\}]*\}[^\}]*)*)[[:space:]]*\}');
define('TYPE_DE_BOUCLE', "[^)]*");
define('BALISE_DE_BOUCLE',
	"^<BOUCLE(" .
	NOM_DE_BOUCLE .
	')[[:space:]]*\((' .
	TYPE_DE_BOUCLE .
	')\)((' .
	PARAM_DE_BOUCLE .
	')*)[[:space:]]*>');
define('PARAM_INCLURE','[[:space:]]*\{[[:space:]]*([_0-9a-zA-Z]+)[[:space:]]*(=[[:space:]]*([^\{\}]*(\{[^\}]*\}[^\} ]*)?))?[[:space:]]*\}');
define('BALISE_INCLURE',"<INCLU[DR]E[[:space:]]*\(" .
       '([-_0-9a-zA-Z./ ]+)' .
	'\)((' .
	PARAM_INCLURE .
	')*)[[:space:]]*>');
define('DEBUT_DE_BOUCLE','/<B('.NOM_DE_BOUCLE.')>.*?<BOUCLE\1[^-_.a-zA-Z0-9]|<BOUCLE('.NOM_DE_BOUCLE.')/ms');	# preg


function parser_inclure($texte, $result) {
	while (($p=strpos($texte, '<INCLU')) !== false) {
		$fin = substr($texte, $p);

		if (!ereg('^' . BALISE_INCLURE, $fin, $match)) break;
		$s = $match[0];
		$debut = substr($texte, 0, $p);
		$texte = substr($fin, strlen($s));

		if ($debut) $result = parser_champs($debut, $result);

		$champ = new Inclure;
		$champ->fichier = $match[1];
		$champ->params = array();
		$p = trim($match[2]);
		if ($p) {
			while (ereg('^' . PARAM_INCLURE . '(.*)$', $p, $m)) {
				$champ->params[$m[1]] = $m[3];
				$p = $m[5];
			}
			
			if ($p)	erreur_squelette(_L("Param&egrave;tres d'inclusion incorrects"), $s);
		}
		$result[] = $champ;
	}

	return (!$texte ? $result : parser_champs($texte, $result));
}

function parser_champs($texte,$result) {
	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
	  $p = strpos($texte, $regs[0]);

	  if ($regs[4] || !ereg("[0-9a-z]", $regs[5][0])) {
		if ($p) {
			$champ = new Texte;
			$champ->texte = (substr($texte, 0, $p));
			$result[] = $champ;
		}
		  
		$champ = new Champ;
		$champ->nom_boucle = $regs[2];
		$champ->nom_champ = $regs[3];
		$champ->etoile = $regs[4];
		$texte = $regs[5];
		$result[] = $champ;
	  } else {
	    // faux champ
	    $champ = new Texte;
	    $champ->texte = (substr($texte, 0, $p+1));
	    $result[] = $champ;
	    $texte = (substr($texte, $p+1));
	  }
	}
	if ($texte) {
	  
		$champ = new Texte;
		$champ->texte = $texte;
		$result[] = $champ;
	}
	return $result;
}

// Gestion des imbrications:
// on cherches les [..] les plus internes et on les remplace par une  chaine
// %###N@ o? N indexe un tableau comportant le r?sultat de leur phras?
// on recommence tant qu'il y a des [...] en substituant ? l'appel suivant

function parser_champs_etendus($texte, $result) {
	if (!$texte) return $result;
	$sep = '##';
	while (strpos($texte,$sep)!== false)
		$sep .= '#';
	return array_merge($result, parser_champs_interieurs($texte, $sep, array()));
}


function parser_champs_exterieurs($debut, $sep, $nested) {
	$res = array();
	while (($p=strpos($debut, "%$sep"))!==false) {
	    if ($p) $res = parser_inclure(substr($debut,0,$p), $res);
	    ereg("^%$sep([0-9]+)@(.*)$", substr($debut,$p),$m);
	    $res[]= $nested[$m[1]];
	    $debut = $m[2];
	}
	return (!$debut ?  $res : parser_inclure($debut, $res));

}

function parser_champs_interieurs($texte, $sep, $result) {
	$i = 1;
	while (true) {	  $j=$i;
	  while (ereg(CHAMP_ETENDU . '(.*)$', $texte, $regs)) {
		$champ = new Champ;
		$champ->nom_boucle = $regs[3];
		$champ->nom_champ = $regs[4];
		$champ->etoile = $regs[5];
		$champ->cond_avant = parser_champs_exterieurs($regs[1],$sep,$result);
		$champ->cond_apres = parser_champs_exterieurs($regs[7],$sep,$result);
		$fonctions = $regs[6];
		if ($fonctions) {
			$fonctions = explode('|', ereg_replace("^\|", "", $fonctions));
			foreach($fonctions as $f) $champ->fonctions[]= $f;
		}

		$p = strpos($texte, $regs[0]);
		if ($p) {$result[$i] = substr($texte,0,$p);$i++; }
		$result[$i] = $champ;
		$i++;
		$texte = $regs[8];
	  }
	  if ($texte) {$result[$i] = $texte; $i++;}
	  $x ='';

	  while($j < $i) 
	    { $z= $result[$j]; 
	      if (is_object($z)) $x .= "%$sep$j@" ; else $x.=$z ;
	      $j++;}
	  if (ereg(CHAMP_ETENDU, $x)) $texte = $x;
	  else return parser_champs_exterieurs($x, $sep, $result);}
}


function parser_param($params, &$result) {
	$params2 = array();
	$type = $result->type_requete;
	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
		$params = $m[3];
		$m[1] = trim($m[1]);
		// cas d'un critere avec {...}
		if ($m[2])
			$params2[] = $m[1];
		else {
			if (strlen($m[1]) < 2)
				$params2[] = $m[1];
	    else {
	      ereg('^(.)([^"}]*)(.)$', $m[1], $args);
	      // cas syntaxique general, 
	      // traiter qq lexemes particuliers pour faciliter la suite
	      if ($args[3] != '"') {
			$param = $m[1];
			if (($param == 'tout') OR ($param == 'tous')) {
				$result->tout = true;
				unset ($param);
			}
			else if ($param == 'plat') {
				$result->plat = true;
				unset ($param);
			}

			// Boucle hierarchie, analyser le critere id_article - id_rubrique
			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
			// forcer {tout} pour avoir la rubrique mere...
			else if ($type == 'hierarchie') {
				if ($param == 'id_article' OR $param == 'id_syndic') {
					$result->tout = true;
					unset ($param);
				} else if ($param == 'id_rubrique')
					unset ($param);
			}

			// synonyme
			if ($param == 'unique') $param = 'doublons';

			// l'ajouter
			if ($param)
				$params2[] = $param;
	      }
		else {
		  // cas d'un guillemet final
			if ($args[1] == '"') {
			  // si tout le param est entre guillement, vite vu
				$result->separateur = 
					ereg_replace("'","\'",$args[2]);
			}
			else {
				$params2[] = $args[1] . $args[2] . '"' . $m[1];
			}
		}
	    }
	  }
	}
	$result->param = $params2;
}

function parser($texte, $id_parent, &$boucles, $nom) {

	$all_res = array();

	while (preg_match(DEBUT_DE_BOUCLE, $texte, $regs)) {
		$nom_boucle = $regs[1].$regs[2];
		$p = strpos($texte, '<BOUCLE'.$nom_boucle);

		// envoyer la boucle au debugueur
		if ($GLOBALS['var_mode']== 'debug') {
			$preg = "@<B($nom_boucle|OUCLE${nom_boucle}[^-_.a-zA-Z0-9][^>]*)>"
				. ".*</(BOUCLE|/?B)$nom_boucle>@ms";
			preg_match($preg, $texte, $match);
			boucle_debug ($nom_boucle, $nom, $match[0]);
		}

		//
		// Recuperer la partie principale de la boucle
		//
		$debut = substr($texte, 0, $p);
		$milieu = substr($texte, $p);

		if (!ereg(BALISE_DE_BOUCLE, $milieu, $match)) {
			erreur_squelette((_T('erreur_boucle_syntaxe')), $milieu);
		}
		$id_boucle = $match[1];

		$result = new Boucle;
		$result->id_parent = $id_parent;
		$result->id_boucle = $id_boucle;

		$type = $match[2];
		if ($p =strpos($type, ':'))
		  {
		    $result->sql_serveur = substr($type,0,$p);
		    $type = substr($type,$p+1);
		  }
		$type = strtolower($type);
		if ($type == 'sites') $type = 'syndication'; # alias

		//
		// Recuperer les criteres de la boucle (sauf boucle recursive)
		//
		if (substr($type, 0, 6) == 'boucle') {
			$result->type_requete = 'boucle';
			$result->param = substr($match[2], 6);
		} else {
			$result->type_requete = $type;
			parser_param($match[3], $result);
		}

		//
		// Recuperer la partie conditionnelle avant
		//
		$s = "<B$id_boucle>";
		$p = strpos($debut, $s);
		if ($p !== false) {
			$result->cond_avant = substr($debut, $p + strlen($s));
			$debut = substr($debut, 0, $p);
		}
		$milieu = substr($milieu, strlen($match[0]));
		if (strpos($milieu, $s)) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
				$id_boucle . 
				_L('&nbsp;: balise B en aval'));
		}

		//
		// Recuperer la fin :
		//
		$s = "</BOUCLE$id_boucle>";
		$p = strpos($milieu, $s);
		if ($p === false) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
					 _T('erreur_boucle_fermant',
						array('id'=>$id_boucle)));
		}
		$texte = substr($milieu, $p + strlen($s));
		$milieu = substr($milieu, 0, $p);

		//
		// 1. Recuperer la partie conditionnelle apres
		//
		$s = "</B$id_boucle>";
		$p = strpos($texte, $s);
		if ($p !== false) {
			$result->cond_fin = substr($texte, 0, $p);
			$texte = substr($texte, $p + strlen($s));
		}

		//
		// 2. Recuperer la partie alternative
		//
		$s = "<//B$id_boucle>";
		$p = strpos($texte, $s);
		if ($p !== false) {
			$result->cond_altern = substr($texte, 0, $p);
			$texte = substr($texte, $p + strlen($s));
		}

		$result->cond_avant = parser($result->cond_avant, $id_parent,$boucles, $nom);
		$result->cond_apres = parser($result->cond_fin, $id_parent,$boucles, $nom);
		$result->cond_altern = parser($result->cond_altern,$id_parent,$boucles, $nom);
		$result->milieu = parser($milieu, $id_boucle,$boucles, $nom);

		$all_res = parser_champs_etendus($debut, $all_res);
		$all_res[] = $result;
		if ($boucles[$id_boucle]) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
					 _T('erreur_boucle_double',
					 	array('id'=>$id_boucle)));
		} else
			$boucles[$id_boucle] = $result;
	}

	return parser_champs_etendus($texte, $all_res);
}

?>

--- NEW FILE: formulaire_signature-dist.html ---
<form method='post'
      action='#SELF#sp[(#HTTP_VARS{id_article})]' >
      <input type="hidden" name="url_page" value="#URL_SITE_SPIP/#SELF">
      <div class='spip_encadrer' style='color: black; font-size: 80%; font-weight: normal;'>
	[(#HTTP_VARS{texte}|traiter_raccourcis|interdire_scripts)]
	<fieldset style='font-size: 110%; font-weight: bold;'>
	  <legend></legend>
	  <label>
	    <:form_pet_votre_nom:>
	    <input type="text" class="forml" name="nom_email" value="" size="20" />
	  </label>
	  <label>
	    <:form_pet_votre_email:><br />
	    <input type="text" class="forml" name="adresse_email" value="" size="20" />
	  </label>
	</fieldset>
	<br />
	<p>[(#HTTP_VARS{site_obli}|choixsiegal{oui,'', ' '})<:form_pet_votre_site:><br />]
	<fieldset style='font-size: 110%; font-weight: bold;'>
	  <legend></legend>
	  <label>
	  <:form_pet_nom_site2:><br />
	  <input type="text" class="forml" name="signature_nom_site" value="" size="20" />
	  </label>
	  <label>
	    <:form_pet_adresse_site:><br />
	    <input type="text" class="forml" name="signature_url_site" value="http://" size="20" />
	  </label>
	</fieldset>[
	<br />
	<fieldset style='font-weight: bold'>
	  <legend></legend>
	(#HTTP_VARS{message}|choixsiegal{oui,' ', ''})
	  <label>
	  <:form_pet_message_commentaire:><br />
	    <textarea name="message" rows="3" class="forml" cols="20"></textarea>
	  </label>
	</fieldset>
	]
	<br />
	<div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>" /></div>
      </div>
</form>


--- NEW FILE: formulaire_oubli-dist.html ---
<form id="oubli_form" action='spip_pass.php3' method='post'>
	<fieldset style="border: none;"><legend></legend>[
	<:pass_nouveau_pass:>
	<input type='hidden' name="p" value="(#HTTP_VARS{p})">
	<label>
	    <:pass_choix_pass:>
	    <input type="password" name="oubli">
	</label>][
	(#HTTP_VARS{p}|choixsivide{' ',''})
	<label>
	  <:pass_indiquez_cidessous:>
	  <input type="texte" name="oubli">
	</label>]
	<input type=submit class="fondl" value="<:pass_ok:>">
      </fieldset>
</form>
<br />
<div align="right">
<script type="text/javascript"><!--
document.oubli_form.oubli.focus()
document.write("<a href='")
document.write((window.opener) ? "javascript:close()" : "./")
document.write("'><:pass_quitter_fenetre:><" + "/a>");
//--></script>
<noscript>
	&#91;<a href='./'><:pass_retour_public:></a>&#93;
</noscript>
</div>
<br />



--- NEW FILE: inc-urls-html.php3 ---
<?php

// executer une seule fois
if (defined("_INC_URLS2")) return;
define("_INC_URLS2", "1");

function generer_url_article($id_article) {
	return "article$id_article.html";
}

function generer_url_rubrique($id_rubrique) {
	return "rubrique$id_rubrique.html";
}

function generer_url_breve($id_breve) {
	return "breve$id_breve.html";
}

function generer_url_mot($id_mot) {
	return "mot$id_mot.html";
}

function generer_url_auteur($id_auteur) {
	return "auteur$id_auteur.html";
}

function generer_url_document($id_document) {
	if (intval($id_document) <= 0)
		return '';
	if ((lire_meta("creer_htaccess")) == 'oui')
		return "spip_acces_doc.php3?id_document=$id_document";
	if ($row = @spip_fetch_array(spip_query("SELECT fichier FROM spip_documents WHERE id_document = $id_document")))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;
	return;
}


//
// URLs des forums
//

// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
function racine_forum($id_forum){
	if (!$id_forum = intval($id_forum)) return;
	$query = "SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=".$id_forum;
	$result = spip_query($query);
	if($row = spip_fetch_array($result)){
		if($row['id_parent']) {
			return racine_forum($row['id_parent']);
		}
		else {
			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
		}
	}
} 

function generer_url_forum($id_forum, $show_thread=false) {
	list($type, $id, $id_thread) = racine_forum($id_forum);
	if ($id_thread>0 AND $show_thread)
		$id_forum = $id_thread;
	switch($type) {
		case 'article':
			return generer_url_article($id)."#forum$id_forum";
			break;
		case 'breve':
			return generer_url_breve($id)."#forum$id_forum";
			break;
		case 'rubrique':
			return generer_url_rubrique($id)."#forum$id_forum";
			break;
		default:
			return "forum$id_forum.html";
	}
}

?>

--- NEW FILE: spip_cal.php3 ---
<?php

include ("ecrire/inc_version.php3");

include_ecrire("inc_filtres.php3");
include_ecrire("inc_lang.php3");
include_ecrire("inc_texte.php3");
include_ecrire("inc_charsets.php3");
include_ecrire("inc_meta.php3");
include_ecrire("inc_admin.php3");
include_ecrire("inc_acces.php3");

/*
function ligne_x ($texte) {
	if (ereg("^BEGIN", $texte)) echo "<br>";
	echo $texte."<br>";
}
*/
function ligne ($texte) {
	echo filtrer_ical($texte)."\n";
}

$nom_site = lire_meta("nom_site");
$adresse_site = lire_meta("adresse_site");

// securite
unset($id_utilisateur);
$id_auteur = intval($id);

// verifier la cle
if (verifier_low_sec($id_auteur, $cle, 'ical')) {
	$query = "SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur";
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$id_utilisateur=$row['id_auteur'];
		$nom_utilisateur=$row['nom'];
		$statut_utilisateur=$row['statut'];
		$langue_utilisateur=$row['lang'];
	}
}
if (!$id_utilisateur) {
	echo _T('info_acces_interdit');
	exit;
}

lang_select($langue_utilisateur);

@header("content-type:text/calendar; charset=utf-8");

ligne ("BEGIN:VCALENDAR");
ligne ("CALSCALE:GREGORIAN");
ligne ("X-WR-CALNAME;VALUE=TEXT:$nom_site / $nom_utilisateur");
ligne ("X-WR-RELCALID:cal$id_utilisateur @ $adresse_site");


// rendez-vous
$result_messages=spip_query("SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure");
while($row=spip_fetch_array($result_messages)){
	$id_message=$row['id_message'];
	$date_heure=$row["date_heure"];
	$date_heure_fin=$row["date_fin"];
	//$titre=typo($row["titre"]);
	$titre = $row["titre"];
	$texte = $row["texte"];
	$type=$row["type"];

	if ($type == 'normal') {
		$le_type = _T('info_message_2');
		$result_auteurs=spip_query("SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)");
		while($row_auteur=spip_fetch_array($result_auteurs)){
			$id_auteur=$row_auteur['id_auteur'];
			$nom_auteur=$row_auteur['nom'];
			$email = $row_auteur ['email'];

			if ($id_auteur != $id_utilisateur) $titre = $titre." - ".$nom_auteur;
			
			if ($id_auteur == $id_utilisateur) ligne ("ORGANIZER:$nom_auteur <$email>");
			else  ligne ("ATTENDEE:$nom_auteur <$email>");
		}
	}
	else if ($type == 'pb') {
		$le_type = _T('info_pense_bete');
	}
	else if ($type == 'affich') {
		$le_type = _T('info_annonce');
		$titre = "[$nom_site] $titre";
	}

	ligne ("BEGIN:VEVENT");
	ligne ("SUMMARY:".$titre);
	ligne ("DESCRIPTION:$texte");
	ligne ("UID:mess$id_message @ $adresse_site");
	ligne ("DTSTAMP:".date_ical($date_heure));
	ligne ("DTSTART:".date_ical($date_heure));
	if ($date_heure_fin > $date_heure) ligne ("DTEND:".date_ical($date_heure_fin));

	ligne ("CATEGORIES:$le_type");
	ligne("URL:$adresse_site/ecrire/message.php3?id_message=$id_message");
	
	ligne ("END:VEVENT");
	
}

// todo
$result_messages=spip_query("SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message AND messages.type='pb' AND messages.rv!='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure");
while($row=spip_fetch_array($result_messages)){
	$id_message=$row['id_message'];
	$date_heure=$row["date_heure"];
	$titre = $row["titre"];
	$texte = $row["texte"];
	$type=$row["type"];

	if ($type == 'normal') {
		$le_type = _T('info_message_2');
		$result_auteurs=spip_query("SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)");
		while($row_auteur=spip_fetch_array($result_auteurs)){
			$id_auteur=$row_auteur['id_auteur'];
			$nom_auteur=$row_auteur['nom'];
			$email = $row_auteur ['email'];

			if ($id_auteur != $id_utilisateur) $titre = $titre." - ".$nom_auteur;
			
			if ($id_auteur == $id_utilisateur) ligne ("ORGANIZER:$nom_auteur <$email>");
			else  ligne ("ATTENDEE:$nom_auteur <$email>");
		}
	}
	else if ($type == 'pb') {
		$le_type = _T('info_pense_bete');
	}
	else if ($type == 'affich') {
		$le_type = _T('info_annonce');
		$titre = "[$nom_site] $titre";
	}
	
	ligne ("BEGIN:VTODO");
	ligne ("SUMMARY:".$titre);
	ligne ("DESCRIPTION:$texte");
	ligne ("UID:mess$id_message @ $adresse_site");
	ligne ("DTSTAMP:".date_ical($date_heure));
	ligne ("DTSTART:".date_ical($date_heure));
	ligne ("CATEGORIES:$le_type");
	ligne ("URL:$adresse_site/ecrire/message.php3?id_message=$id_message");
	ligne ("END:VTODO");

}

// Articles et breves proposes
$titres = Array();
$result_articles = spip_query("SELECT id_article, titre, date FROM spip_articles WHERE statut = 'prop'");
while($row=spip_fetch_array($result_articles)){
	$id_article=$row['id_article'];
	$titre = supprimer_numero($row['titre']);
	$titres[] = $titre;
	$date_heure = $row['date'];
	$nb_articles ++;
	ligne ("BEGIN:VEVENT");
	ligne ("SUMMARY:[$nom_site] $titre ("._T('info_article_propose').")");
	ligne ("UID:article$id_article @ $adresse_site");
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("DTSTART;VALUE=DATE:".date ("Ymd", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("CATEGORIES:"._T('info_article_propose'));
	ligne("URL:$adresse_site/ecrire/articles.php3?id_article=$id_article");
	ligne ("END:VEVENT");
}

$result_articles = spip_query("SELECT id_breve, titre, date_heure FROM spip_breves WHERE statut = 'prop'");
while($row=spip_fetch_array($result_articles)){
	$id_breve=$row['id_breve'];
	$titre = supprimer_numero($row['titre']);
	$titres[] = $titre;
	$date_heure = $row['date_heure'];
	$nb_breves++;
	ligne ("BEGIN:VEVENT");
	ligne ("SUMMARY:[$nom_site] $titre ("._T('item_breve_proposee').")");
	ligne ("UID:breve$id_breve @ $adresse_site");
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("DTSTART;VALUE=DATE:".date ("Ymd", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("CATEGORIES:"._T('item_breve_proposee'));
	ligne ("URL:$adresse_site/ecrire/breves_voir.php3?id_breve=$id_breve");
	ligne ("END:VEVENT");

}

if ($nb_articles + $nb_breves > 0) {
	if ($nb_articles > 0) $titre_prop[] = _T('info_articles_proposes').": ".$nb_articles;
	if ($nb_breves > 0) $titre_prop[] = _T('info_breves_valider').": ".$nb_breves;
	$titre = join($titre_prop," / ");
	ligne ("BEGIN:VTODO");
	ligne ("SUMMARY:[$nom_site] $titre");
	ligne ("UID:prop @ $adresse_site");
	$texte = join($titres," / ");
	ligne ("DESCRIPTION:$texte");
	
	$today=getdate(time());
	$jour = $today["mday"];
	$mois=$today["mon"];
	$annee=$today["year"];
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
	ligne ("DTSTART:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
	ligne ("CATEGORIES:"._T('icone_a_suivre'));
	ligne ("URL:$adresse_site/ecrire/");
	ligne ("END:VTODO");
}


// Nouveaux messages

$result_messages = spip_query("SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur=$id_utilisateur AND vu='non' AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message");
while($row=spip_fetch_array($result_messages)){
	$id_message=$row['id_message'];
	$date_heure=$row["date_heure"];
	$titre = $row["titre"];
	$texte = $row["texte"];
	$type=$row["type"];

	if ($type == 'normal') {
		$le_type = _T('info_message_2');
		$result_auteurs=spip_query("SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)");
		while($row_auteur=spip_fetch_array($result_auteurs)){
			$id_auteur=$row_auteur['id_auteur'];
			$nom_auteur = $row_auteur['nom'];
			$email = $row_auteur ['email'];

			if ($id_auteur != $id_utilisateur) $titre = $nom_auteur." - ".$titre;
			
			if ($id_auteur == $id_utilisateur) ligne ("ORGANIZER:$nom_auteur <$email>");
			else  ligne ("ATTENDEE:$nom_auteur <$email>");
		}
		$query_forum = "SELECT * FROM spip_forum WHERE statut='perso' AND id_message='$id_message' ORDER BY date_heure DESC LIMIT 0,1";
		$result_forum = spip_query($query_forum);
		if ($row_forum = spip_fetch_array($result_forum)) {
			$date_heure = $row_forum["date_heure"];
			$texte = $row_forum["texte"];
			$titre = $row_forum["titre"];
			$id_auteur = $row_forum["id_auteur"];

			$result_auteurs2 = spip_query("SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur");
			if ($row_auteur2 = spip_fetch_array($result_auteurs2)){
				$nom_auteur = $row_auteur2['nom'];
				$email = $row_auteur2 ['email'];
				
				$titre = $nom_auteur." - ".$titre;
			}
		}
	}
	else if ($type == 'pb') {
		$le_type = _T('info_pense_bete');
	}
	else if ($type == 'affich') {
		$le_type = _T('info_annonce');
		$titre = "[$nom_site] $titre";
	}

	
	
	ligne ("BEGIN:VTODO");
	ligne ("SUMMARY:".$titre);
	ligne ("DESCRIPTION:$texte");
	ligne ("UID:nouv_mess$id_message @ $adresse_site");
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("DTSTART:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("CATEGORIES:$le_type");
	ligne("URL:$adresse_site/ecrire/message.php3?id_message=$id_message");
	ligne ("END:VTODO");
	
}

// Messages de forum a valider
if ($statut_utilisateur == "0minirezo") {

	$query_forum = "SELECT * FROM spip_forum WHERE statut = 'prop'";
	$result_forum = spip_query($query_forum);

	while($row=spip_fetch_array($result_forum)){
		$nb_forum ++;
	
		$id_forum=$row['id_forum'];
		$date_heure = $row['date_heure'];
		$titre = $row['titre'];
		$texte = $row['texte'];
		$auteur = $row['auteur'];
		$email_auteur = $row['email_auteur'];
		if ($email_auteur) $email_auteur = "<$email_auteur>";
		
		ligne ("BEGIN:VEVENT");
		ligne ("SUMMARY:[$nom_site] $titre "._T('icone_forum_suivi'));
		ligne ("DESCRIPTION:$texte\r$auteur $email_auteur");
		ligne ("UID:forum$id_forum @ $adresse_site");
		ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
		ligne ("DTSTART:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
		ligne ("DTEND:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure)+60,0,mois($date_heure),jour($date_heure),annee($date_heure))));
		ligne ("CATEGORIES:"._T('icone_forum_suivi'));
		ligne("URL:$adresse_site/ecrire/controle_forum.php3");
		ligne ("END:VEVENT");


		
	}

	if ($nb_forum > 0) {
		ligne ("BEGIN:VTODO");
		ligne ("SUMMARY:[$nom_site] "._T('icone_forum_suivi').": $nb_forum");
		ligne ("UID:forum @ $adresse_site");
		
		$today=getdate(time());
		$jour = $today["mday"];
		$mois=$today["mon"];
		$annee=$today["year"];
		ligne ("DTSTAMP:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
		ligne ("DTSTART:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
		ligne ("CATEGORIES:"._T('icone_forum_suivi'));
		ligne("URL:$adresse_site/ecrire/controle_forum.php3");
		ligne ("END:VTODO");
	}
}




ligne ("END:VCALENDAR");


?>
--- NEW FILE: spip_inscription.php3 ---
<?php
include ("ecrire/inc_version.php3");
include_ecrire("inc_presentation.php3");
include_local("inc-formulaire_inscription.php3");
include_local("inc-public-global.php3"); 
include_ecrire("inc_lang.php3"); 
utiliser_langue_site();
utiliser_langue_visiteur();
install_debut_html(_T('pass_vousinscrire'));
inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus));
install_fin_html();
?>

--- NEW FILE: rubrique.php3 ---
<?php
$fond = "rubrique";
$delais = 2 * 3600;


include ("inc-public.php3");

?>

--- NEW FILE: spip_image.php3 ---
<?php

include ("ecrire/inc_version.php3");
include_ecrire("inc_charsets.php3");
include_ecrire("inc_meta.php3");
include_ecrire("inc_admin.php3");
include_ecrire("inc_abstract_sql.php3");

function effacer_image($nom) {
	global $hash_id_auteur, $hash;

	if ((!strstr($nom, "..")) AND
	    verifier_action_auteur("supp_image $nom", $hash, $hash_id_auteur))
		@unlink(_DIR_IMG . $nom);
}

function tester_vignette ($test_vignette) {
	global $djpeg_command, $cjpeg_command, $pnmscale_command;
	// verifier les formats acceptes par GD
	if ($test_vignette == "gd1") {
		$gd_formats = Array();
		if (function_exists('ImageCreateFromJPEG')) {
			$srcImage = @ImageCreateFromJPEG(_DIR_IMG . "test.jpg");
			if ($srcImage) {
				$gd_formats[] = "jpg";
				ImageDestroy( $srcImage );
			}
		}
		if (function_exists('ImageCreateFromGIF')) {
			$srcImage = @ImageCreateFromGIF(_DIR_IMG . "test.gif");
			if ($srcImage) {
				$gd_formats[] = "gif";
				ImageDestroy( $srcImage );
			}
		}
		if (function_exists('ImageCreateFromPNG')) {
			$srcImage = @ImageCreateFromPNG(_DIR_IMG . "test.png");
			if ($srcImage) {
				$gd_formats[] = "png";
				ImageDestroy( $srcImage );
			}
		}

		if ($gd_formats) $gd_formats = join(",", $gd_formats);
		ecrire_meta("gd_formats", $gd_formats);
		ecrire_metas();
	}
	// verifier les formats netpbm
	else if ($test_vignette == "netpbm") {
		$netpbm_formats= Array();

		$jpegtopnm_command = ereg_replace("pnmscale", "jpegtopnm", $pnmscale_command);
		$pnmtojpeg_command = ereg_replace("pnmscale", "pnmtojpeg", $pnmscale_command);

		$vignette = _DIR_IMG . "test.jpg";
		$dest = _DIR_IMG . "test-jpg.jpg";
		exec("$jpegtopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command > $dest");
		if ($taille = @getimagesize($dest)) {
			if ($taille[1] == 10) $netpbm_formats[] = "jpg";
		}	
		
		$giftopnm_command = ereg_replace("pnmscale", "giftopnm", $pnmscale_command);
		$pnmtojpeg_command = ereg_replace("pnmscale", "pnmtojpeg", $pnmscale_command);
		$vignette = _DIR_IMG . "test.gif";
		$dest = _DIR_IMG . "test-gif.jpg";
		exec("$giftopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command > $dest");
		if ($taille = @getimagesize($dest)) {
			if ($taille[1] == 10) $netpbm_formats[] = "gif";
		}

		$pngtopnm_command = ereg_replace("pnmscale", "pngtopnm", $pnmscale_command);
		$vignette = _DIR_IMG . "test.png";
		$dest = _DIR_IMG . "test-gif.jpg";
		exec("$pngtopnm_command $vignette | $pnmscale_command -width 10 | $cjpeg_command -outfile $dest");
		if ($taille = @getimagesize($dest)) {
			if ($taille[1] == 10) $netpbm_formats[] = "png";
		}
		

		if ($netpbm_formats) $netpbm_formats = join(",", $netpbm_formats);
		ecrire_meta("netpbm_formats", $netpbm_formats);
		ecrire_metas();
	}

	// et maintenant envoyer la vignette de tests
	if (ereg("^(gd1|gd2|imagick|convert|netpbm)$", $test_vignette)) {
		include_ecrire('inc_logos.php3');
		//$taille_preview = lire_meta("taille_preview");
		if ($taille_preview < 10) $taille_preview = 120;
		if ($preview = creer_vignette(_DIR_IMG . 'test_image.jpg', $taille_preview, $taille_preview, 'jpg', '', "test_$test_vignette", $test_vignette, true))

			return ($preview['fichier']);
	}
	return '';
}


//
// Deplacer un fichier
//

function deplacer_fichier_upload($source, $dest) {
	// Securite
	if (strstr($dest, "..")) {
		exit;
	}

	$ok = @copy($source, $dest);
	if (!$ok) $ok = @move_uploaded_file($source, $dest);
	if ($ok)
		@chmod($dest, 0666);
	else {
		$f = @fopen($dest,'w');
		if ($f)
			fclose ($f);
		else {
			redirige_par_entete("spip_test_dirs.php3?test_dir=".
					    dirname($dest));
		}
		@unlink($dest);

		if (($GLOBALS['_FILES']['size'] == 0) AND !$GLOBALS['action_zip']) {
			include_ecrire('inc_presentation.php3');
			install_debut_html(_T('forum_titre_erreur'));
			echo "<p>"._T('upload_limit',
				array('max' => ini_get('upload_max_filesize')));
			install_fin_html();
			exit;
		}
	}

	return $ok;
}


//
// Convertit le type numerique retourne par getimagesize() en extension fichier
//

function decoder_type_image($type, $strict = false) {
	switch ($type) {
	case 1:
		return "gif";
	case 2:
		return "jpg";
	case 3:
		return "png";
	case 4:
		return $strict ? "" : "swf";
	case 5:
		return "psd";
	case 6:
		return "bmp";
	case 7:
	case 8:
		return "tif";
	default:
		return "";
	}
}


//
// Corrige l'extension du fichier dans quelques cas particuliers
//

function corriger_extension($ext) {
	switch ($ext) {
	case 'htm':
		return 'html';
	case 'jpeg':
		return 'jpg';
	case 'tiff':
		return 'tif';
	default:
		return $ext;
	}
}


//
// Ajouter une image (logo)
//

function ajout_image($source, $dest) {
	global $redirect_url, $hash_id_auteur, $hash, $num_img, $dossier_squelettes;

	// Securite
	if (!(verifier_action_auteur("ajout_image $dest", $hash, $hash_id_auteur)
	      AND _DIR_DOC != $dossier_squelettes)) {
	  spip_log("interdiction ajout_image($source, $dest)");
	  return;
	}

	// analyse le type de l'image (on ne fait pas confiance au nom de
	// fichier envoye par le browser : pour les Macs c'est plus sur)

	$f =_DIR_DOC . $dest . '.tmp';
	deplacer_fichier_upload($source, $f);
	$size = @getimagesize($f);
	$type = decoder_type_image($size[2], true);
	if ($type)
		@rename ($f, _DIR_DOC . $dest . ".$type");
	else
		@unlink ($f);
}

//
// Faire tourner une image
//

//$imagePath - path to your image; function will save rotated image overwriting the old one
//$rtt - should be 90 or -90 - cw/ccw
function gdRotate($imagePath,$rtt){
	if(preg_match("/\.(png)/i", $imagePath)) $src_img=ImageCreateFromPNG($imagePath);
	elseif(preg_match("/\.(jpg)/i", $imagePath)) $src_img=ImageCreateFromJPEG($imagePath);
	elseif(preg_match("/\.(bmp)/i", $imagePath)) $src_img=ImageCreateFromWBMP($imagePath);
	$size=@getimagesize($imagePath);
	//note: to make it work on GD 2.xx properly change ImageCreate to ImageCreateTrueColor

	$process = lire_meta('image_process');
	if ($process == "gd2") $dst_img=ImageCreateTrueColor($size[1],$size[0]);
	else  $dst_img=ImageCreate($size[1],$size[0]);
	if($rtt==90){
		$t=0;
		$b=$size[1]-1;
		while($t<=$b){
			$l=0;
			$r=$size[0]-1;
			while($l<=$r){
				imagecopy($dst_img,$src_img,$t,$r,$r,$b,1,1);
				imagecopy($dst_img,$src_img,$t,$l,$l,$b,1,1);
				imagecopy($dst_img,$src_img,$b,$r,$r,$t,1,1);
				imagecopy($dst_img,$src_img,$b,$l,$l,$t,1,1);
				$l++;
				$r--;
			}
			$t++;
			$b--;
		}
	}
	elseif($rtt==-90){
		$t=0;
		$b=$size[1]-1;
		while($t<=$b){
			$l=0;
			$r=$size[0]-1;
			while($l<=$r){
				imagecopy($dst_img,$src_img,$t,$l,$r,$t,1,1);
				imagecopy($dst_img,$src_img,$t,$r,$l,$t,1,1);
				imagecopy($dst_img,$src_img,$b,$l,$r,$b,1,1);
				imagecopy($dst_img,$src_img,$b,$r,$l,$b,1,1);
				$l++;
				$r--;
			}
			$t++;
			$b--;
		}
	}
	ImageDestroy($src_img);
	ImageInterlace($dst_img,0);
	ImageJPEG($dst_img,$imagePath);
}

//
// Creation automatique de vignette new style
// Normalement le test est v?rifi? donc on ne rend rien sinon

function creer_fichier_vignette($vignette) {
	if ($vignette && lire_meta("creer_preview") == 'oui') {
		eregi('\.([a-z0-9]+)$', $vignette, $regs);
		$ext = $regs[1];
		$taille_preview = lire_meta("taille_preview");
		if ($taille_preview < 10) $taille_preview = 120;
		include_ecrire('inc_logos.php3');

		if ($preview = creer_vignette($vignette, $taille_preview, $taille_preview, $ext, 'vignettes', basename($vignette).'-s'))
		{
			inserer_vignette_base($vignette, $preview['fichier']);
			return $preview['fichier'];
		}
		include_ecrire('inc_documents.php3');
		return vignette_par_defaut($ext ? $ext : 'txt', false);
	}
}

function supprime_document_et_vignette($doc_supp) {
	global $hash_id_auteur, $hash;
	// Securite
	if (verifier_action_auteur("supp_doc $doc_supp", $hash, $hash_id_auteur)) {
		$query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$doc_supp";
		$result = spip_query($query);
		if ($row = spip_fetch_array($result)) {
			$fichier = $row['fichier'];
			$id_vignette = $row['id_vignette'];
			spip_query("DELETE FROM spip_documents WHERE id_document=$doc_supp");
			spip_query("UPDATE spip_documents SET id_vignette=0 WHERE id_vignette=$doc_supp");
			spip_query("DELETE FROM spip_documents_articles WHERE id_document=$doc_supp");
			spip_query("DELETE FROM spip_documents_rubriques WHERE id_document=$doc_supp");
			spip_query("DELETE FROM spip_documents_breves WHERE id_document=$doc_supp");
			@unlink($fichier);
			
			if ($id_vignette > 0) {
			  $query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$id_vignette";
			  $result = spip_query($query);
			  if ($row = spip_fetch_array($result)) {
			    $fichier = $row['fichier'];
			    @unlink($fichier);
			  }
			  spip_query("DELETE FROM spip_documents WHERE id_document=$id_vignette");
			  spip_query("DELETE FROM spip_documents_articles WHERE id_document=$id_vignette");
			  spip_query("DELETE FROM spip_documents_rubriques WHERE id_document=$id_vignette");
			  spip_query("DELETE FROM spip_documents_breves WHERE id_document=$id_vignette");
			}
		}
	}
}

function tourner_document($var_rot, $doc_rotate, $convert_command) {
	global $hash_id_auteur, $hash;
	// Securite
	if (!verifier_action_auteur("rotate $doc_rotate", $hash, $hash_id_auteur)) {
		return '';
	}
	
	if (!$var_rot) $var_rot = 0;

	$query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$doc_rotate";
	$result = spip_query($query);
	if ($row = spip_fetch_array($result)) {
		$id_vignette = $row['id_vignette'];
		$image = $row['fichier'];

		$process = lire_meta('image_process');

		 // imagick (php4-imagemagick)
		 if ($process == 'imagick') {
			$handle = imagick_readimage($image);
			imagick_rotate($handle, $var_rot);
			imagick_write($handle, $image);
			if (!@file_exists($image)) return;	// echec imagick
		}
		else if ($process == "gd2") { // theoriquement compatible gd1, mais trop forte degradation d'image
			if ($var_rot == 180) { // 180 = 90+90
				gdRotate ($image, 90);
				gdRotate ($image, 90);
			} else {
				gdRotate ($image, $var_rot);
			}
		}
		else if ($process = "convert") {
			$commande = "$convert_command -rotate $var_rot ./"
				. escapeshellcmd($image).' ./'.escapeshellcmd($image);
#			spip_log($commande);
			exec($commande);
		}

		$size_image = @getimagesize($image);
		$largeur = $size_image[0];
		$hauteur = $size_image[1];

		if ($id_vignette > 0) {
			creer_fichier_vignette($image);
/*			$query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$id_vignette";
			$result = spip_query($query);
			if ($row = spip_fetch_array($result)) {
				$fichier = $row['fichier'];
				@unlink($fichier);
			}
			spip_query("DELETE FROM spip_documents WHERE id_document=$id_vignette");
			spip_query("DELETE FROM spip_documents_articles WHERE id_document=$id_vignette");
			spip_query("DELETE FROM spip_documents_rubriques WHERE id_document=$id_vignette");
			spip_query("DELETE FROM spip_documents_breves WHERE id_document=$id_vignette");
*/		}


		spip_query("UPDATE spip_documents SET largeur=$largeur, hauteur=$hauteur WHERE id_document=$doc_rotate");

	}
}

if ($test_vignette) // appel de config-fonction
	$redirect = tester_vignette($test_vignette);
elseif ($vignette) // appels de inc_logo
	$redirect = creer_fichier_vignette($vignette);
else {
   $retour = $redirect;
   $redirect = '';
   if ($ajout_doc == 'oui') {
	include_ecrire('inc_getdocument.php3');
	if (!$image_name AND $image2) {
		$image = _DIR_TRANSFERT . $image2;
		$image_name = $image;
	} 
	if (!eregi("\.zip$",$image_name))
	  ajout_doc_s($image, $image_name, $mode, $forcer_document, $id_document, $hash);
	else {
	  // bizarre: clean_link ne recupere pas les variables
	  $link = new Link('spip_image.php3');
	  $link->addVar("ajout_doc", "oui");
	  $link->addVar("redirect", $retour);
	  $link->addVar('id_document', $id_document);
	  $link->addVar('id_article', $id_article);
	  $link->addVar('mode', $mode);
	  $link->addVar('type', $type);
	  $link->addVar('hash', $hash);
	  $link->addVar('hash_id_auteur', $hash_id_auteur);
	  ajout_doc_zip($image, $image_name, $mode, $forcer_document, $action_zip, $id_document, $hash, $link);
	}
   }
   elseif ($ajout_logo == "oui")
	ajout_image($image, $logo);
   elseif ($image_supp)
	effacer_image($image_supp);
   elseif ($doc_supp) // appels de inc_document
	supprime_document_et_vignette($doc_supp);
   elseif ($doc_rotate)
	tourner_document($var_rot, $doc_rotate, $convert_command);
 }

if (!($redirect)) {
	if ($HTTP_POST_VARS) $vars = $HTTP_POST_VARS;
	else $vars = $HTTP_GET_VARS;
	$redirect = $vars["redirect"];
	$link = new Link(_DIR_RESTREINT_ABS . $redirect);
	reset($vars);
	while (list ($key, $val) = each ($vars)) {
	  if (!ereg("^(redirect|image.*|hash.*|ajout.*|doc.*|transformer.*|modifier_.*|ok|type|forcer_.*|var_rot|action_zip)$", $key)) {
	    $link->addVar($key, $val);
	  }
	}
	if ($id_document)
	  $link->addVar('id_document',$id_document);
	if ($type == 'rubrique')
	  $link->delVar('id_article');
	
	$redirect = $link->getUrl();
 }


redirige_par_entete($redirect);

?>

--- NEW FILE: inc-urls-standard.php3 ---
<?php

// executer une seule fois
if (defined("_INC_URLS2")) return;
define("_INC_URLS2", "1");

function generer_url_article($id_article) {
	return "article.php3?id_article=$id_article";
}

function generer_url_rubrique($id_rubrique) {
	return "rubrique.php3?id_rubrique=$id_rubrique";
}

function generer_url_breve($id_breve) {
	return "breve.php3?id_breve=$id_breve";
}

function generer_url_mot($id_mot) {
	return "mot.php3?id_mot=$id_mot";
}

function generer_url_auteur($id_auteur) {
	return "auteur.php3?id_auteur=$id_auteur";
}

function generer_url_document($id_document) {
	if (intval($id_document) <= 0)
		return '';
	if ((lire_meta("creer_htaccess")) == 'oui')
		return "spip_acces_doc.php3?id_document=$id_document";
	if ($row = @spip_fetch_array(spip_query("SELECT fichier FROM spip_documents WHERE id_document = $id_document")))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;
	return;
}

//
// URLs des forums
//

// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
function racine_forum($id_forum){
	if (!$id_forum = intval($id_forum)) return;
	$query = "SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=".$id_forum;
	$result = spip_query($query);
	if($row = spip_fetch_array($result)){
		if($row['id_parent']) {
			return racine_forum($row['id_parent']);
		}
		else {
			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
		}
	}
} 

function generer_url_forum($id_forum, $show_thread=false) {
	list($type, $id, $id_thread) = racine_forum($id_forum);
	if ($id_thread>0 AND $show_thread)
		$id_forum = $id_thread;
	switch($type) {
		case 'article':
			return generer_url_article($id)."#forum$id_forum";
			break;
		case 'breve':
			return generer_url_breve($id)."#forum$id_forum";
			break;
		case 'rubrique':
			return generer_url_rubrique($id)."#forum$id_forum";
			break;
		default:
			return "forum.php3?id_forum=".$id_forum;
	}
}

?>

--- NEW FILE: ical-dist.html ---
BEGIN:VCALENDAR
CALSCALE:GREGORIAN
X-WR-CALNAME;VALUE=TEXT:[(#NOM_SITE_SPIP|filtrer_ical)]
X-WR-RELCALID:[(#URL_SITE_SPIP|filtrer_ical)]
<BOUCLE_articles(ARTICLES){par date}{inverse}{0,100}>
BEGIN:VEVENT
SUMMARY:[(#TITRE|filtrer_ical)] [[(#NOM_SITE_SPIP|filtrer_ical)]]
UID:article#ID_ARTICLE @ [(#URL_SITE_SPIP|filtrer_ical)]
DTSTAMP:[(#DATE|date_ical)]
DTSTART:[(#DATE|date_ical)]
DTEND:[(#DATE|date_ical{60})]
CATEGORIES:<:articles|filtrer_ical:>
URL:#URL_SITE_SPIP/#URL_ARTICLE
STATUS:CONFIRMED
END:VEVENT
</BOUCLE_articles>
<BOUCLE_breves(BREVES){par date}{inverse}{0,100}>
BEGIN:VEVENT
SUMMARY:[(#TITRE|filtrer_ical)] [[(#NOM_SITE_SPIP|filtrer_ical)]]
UID:breve#ID_BREVE @ [(#URL_SITE_SPIP|filtrer_ical)]
DTSTAMP:[(#DATE|date_ical)]
DTSTART:[(#DATE|date_ical)]
DTEND:[(#DATE|date_ical{60})]
CATEGORIES:<:breves|filtrer_ical:>
URL:#URL_SITE_SPIP/#URL_BREVE
STATUS:CONFIRMED
END:VEVENT
</BOUCLE_breves>
END:VCALENDAR

--- NEW FILE: auteur.php3 ---
<?php
$fond = "auteur";
$delais = 24 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: downloadfile.class.php ---
<?
/*
 * Class has simple interface to download any file from a server
 * without displaying the location of the file
 *
 * Author: Viatcheslav Ivanov, E-Witness Inc., Canada;
 * mail: ivanov at e-witness.ca;
 * web: www.e-witness.ca; www.coolwater.ca; www.strongpost.net;
 * version: 1.1 /08.19.2002
 *
 */

if ( !defined("DOWNLOADFILE_H") ) {

	define("DOWNLOADFILE_H",1);

	class DOWNLOADFILE {
		var $df_path = "";
		var $df_contenttype = "";
		var $df_contentdisposition = "";
		var $df_filename = "";

		function DOWNLOADFILE($df_path, $df_contentdisposition = "attachment", $df_filename = "") {
			$this->df_path = $df_path;
			if (!function_exists ("mime_content_type")) {
 					function mime_content_type ($file) {
  					return exec ("file -bi " . escapeshellcmd($file));
 				}
			}
			$df_contenttype=@mime_content_type($df_path);
			if ($df_contenttype) $this->df_contenttype = $df_contenttype;
			else $this->df_contenttype ="";// "application/octet-stream";
			$this->df_contentdisposition = $df_contentdisposition;
			$this->df_filename = ($df_filename)? $df_filename : basename($df_path);
		}

		// check is specified file exists?
		function df_exists() {
			if(@file_exists($this->df_path)) return true;
			return false;
		}

		// get file size
		function df_size() {
			if($this->df_exists()) return filesize($this->df_path);
			return false;
		}

		// return permission number for user 'other'
		function df_permitother() {
			return substr(decoct(fileperms($this->df_path)),-1);
		}

		// download file
		function df_download() {
			if($this->df_exists() && $this->df_permitother() >= 4) {
				header("Content-type: ".$this->df_contenttype);
				header("Content-Length: ".$this->df_size());
				header("Content-Disposition: ".$this->df_contentdisposition."; filename=\"".$this->df_filename."\";");
				header("Content-Transfer-Encoding: binary");
				$fp = readfile($this->df_path, "r");
				return $fp;
				//echo "Content-type: ".$this->df_contenttype."Content-Length: ".$this->df_size()."Content-Disposition: ".$this->df_contentdisposition."; filename=\"".$this->df_filename."\";";
			}
			else return false;
		}

	}

}

?>
--- NEW FILE: index.php3 ---
<?php include ("sommaire.php3"); ?>

--- NEW FILE: nouveautes-dist.html ---
[[(#NOM_SITE_SPIP|textebrut|texte_script)]] <:nouveautes|texte_script:>

<B0>
<:bonjour|texte_script:>

<:texte_lettre_information|texte_script:> "[(#NOM_SITE_SPIP|textebrut|texte_script)]" (#URL_SITE_SPIP).
<:texte_lettre_information_2|texte_script:> [(#HTTP_VARS{jours_neuf})] <:jours|texte_script:>.

<BOUCLE0(AUTEURS){0,1}><B_nv1>
          <:nouveaux_articles|texte_script:>
          --------------------------

<BOUCLE_nv1(ARTICLES){age_relatif<=0}{par date}{inverse}{0,30}>
[** (#TITRE|textebrut|texte_script) **]
[par (#LESAUTEURS|textebrut|texte_script)]
[le (#DATE|affdate|texte_script)]

[(#INTRODUCTION|textebrut|texte_script)]

-> #URL_SITE_SPIP/#URL_ARTICLE

</BOUCLE_nv1><B_nv2>
          
          <:nouvelles_breves|texte_script:>
          --------------------------

<BOUCLE_nv2(BREVES){age_relatif<=0}{par date}{inverse}{0,30}>
[* (#TITRE|textebrut|texte_script) *]
[ - (#DATE|affdate|texte_script)]

[(#INTRODUCTION|textebrut|texte_script)]

-> #URL_SITE_SPIP/#URL_BREVE

</BOUCLE_nv2></BOUCLE0>
--- NEW FILE: inc-public.php3 ---
<?php

// Page inclue ?
if (defined("_INC_PUBLIC")) {
	$page = inclure_page($fond, $delais, $contexte_inclus, $fichier_inclus);

	if ($page['process_ins'] == 'html')
		echo $page['texte'];
	else
		eval('?' . '>' . $page['texte']);

	if ($page['lang_select'])
		lang_dselect();
}
// Premier appel inc-public
else {
	define("_INC_PUBLIC", "1");
	include ("ecrire/inc_version.php3");

	//
	// Initialisations
	//

	// Regler le $delais par defaut
	if ($INSECURE['fond'] || $INSECURE['delais'])
		exit;
	if (!isset($delais))
		$delais = 1 * 3600;
	if ($recherche)
		$delais = 0;

	// authentification du visiteur
	if ($HTTP_COOKIE_VARS['spip_session'] OR
	($PHP_AUTH_USER AND !$ignore_auth_http)) {
		include_ecrire ("inc_session.php3");
		verifier_visiteur();
	}
	// multilinguisme
	if ($forcer_lang AND ($forcer_lang!=='non') AND empty($HTTP_POST_VARS)) {
		include_ecrire('inc_lang.php3');
		verifier_lang_url();
	}
	if ($HTTP_GET_VARS['lang']) {
		include_ecrire('inc_lang.php3');
		lang_select($HTTP_GET_VARS['lang']);
	}
	// Ajout_forum (pour les forums) et $val_confirm signalent des modifications
	// a faire avant d'afficher la page
	if ($ajout_forum) {
		$redirect = '';
		include('inc-messforum.php3');
		if ($redirect) redirige_par_entete($redirect);
	}
	if ($val_confirm) {
		include_local('inc-formulaire_signature.php3');
		reponse_confirmation($id_article, $val_confirm);
	}

	include_local ('inc-public-global.php3');

	//  refus du debug si pas dans les options generales ni admin connecte
	if ($var_mode=='debug') {
		if (($code_activation_debug == 'oui')
		OR $auteur_session['statut'] == '0minirezo')
			spip_log('debug !');
		else
			$var_mode = false; 
	}

	// est-on admin ?
	if ($affiche_boutons_admin = (!$flag_preserver
	AND ($HTTP_COOKIE_VARS['spip_admin']
	OR $HTTP_COOKIE_VARS['spip_debug'])))
		include_local('inc-formulaire_admin.php3');

	$tableau_des_erreurs = array();
	$page = afficher_page_globale ($fond, $delais, $use_cache);

	if (!$flag_preserver) {
	// Interdire au client de cacher un login, un admin ou un recalcul
		if ($flag_dynamique OR $var_mode
		OR $HTTP_COOKIE_VARS['spip_admin']) {
			@header("Cache-Control: no-cache,must-revalidate");
			@header("Pragma: no-cache");
	// Pour les autres donner l'heure de modif
		} else if ($lastmodified)
			@Header ("Last-Modified: ".http_gmoddate($lastmodified)." GMT");

	// si le squelette est nul se rabattre sur l'entete standard
		if ($page['texte']) 
			@header("Content-Type: text/html; charset=".lire_meta('charset'));
		else
			echo debut_entete($fond);
	}
	define('spip_active_ob', $flag_ob AND
		($var_mode == 'debug' OR $var_recherche OR $affiche_boutons_admin));

	// Cas d'une page contenant uniquement du HTML :
	if ($page['process_ins'] == 'html') {
		if (!spip_active_ob) {
			echo $page['texte'];
			$contenu = '';
		} else
			$contenu = $page['texte'];
	}

	// Cas d'une page contenant du PHP :
	else {
		// Evaluer la page
		if (!spip_active_ob) {
			eval('?' . '>' . $page['texte']);
			$contenu = '';
		} else {
			ob_start(); 
			$res = eval('?' . '>' . $page['texte']);
			$contenu = ob_get_contents(); 
			ob_end_clean();

			// en cas d'erreur lors du eval, afficher un message
			// et forcer les boutons de debug
			if ($res === false AND $affiche_boutons_admin
			AND $auteur_session['statut'] == '0minirezo') {
				include_ecrire('inc_debug_sql.php3');
				erreur_squelette(_L('erreur d\'execution de la page'));
			}
		}
	}

	// Passer la main au debuggueur le cas echeant 
	if ($var_mode == 'debug') {
		include_ecrire("inc_debug_sql.php3");
		debug_dumpfile('',$var_mode_objet,$var_mode_affiche);
		exit;
	} else if (count($tableau_des_erreurs) > 0
	AND $affiche_boutons_admin)
		affiche_erreurs_page ($tableau_des_erreurs);

	// Traiter var_recherche pour surligner les mots
	if ($var_recherche) {
		include_ecrire("inc_surligne.php3");
		$contenu = surligner_mots($contenu, $var_recherche);
	}

	// Ajouter au besoin la CSS des boutons admins
	if ($affiche_boutons_admin) {
		include_local("inc-admin.php3");
		$contenu = perso_admin($contenu);
	}

	// Afficher le resultat final
	echo $contenu;

	// Ajouter les boutons admins (les normaux) si absents
	// (ce sera apres la balise /html mais tant pis)
	if ($affiche_boutons_admin)
		inclure_balise_dynamique(balise_formulaire_admin_dyn($id_article, $id_breve, $id_rubrique, $id_mot, $id_auteur));

	// Taches de fin
	terminer_public_global();
 }

?>

--- NEW FILE: inc-messforum.php3 ---
<?php

include_ecrire('inc_meta.php3');
include_ecrire('inc_forum.php3');

// Ce fichier inclus par inc-public a un comportement special
// Voir commentaires dans celui-ci et dans inc-formulaire_forum

function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre)
{
	include_ecrire('inc_texte.php3');
	include_ecrire('inc_filtres.php3');
	include_ecrire('inc_mail.php3');
	// Gestionnaire d'URLs
	if (@file_exists("inc-urls.php3"))
	  include_local("inc-urls.php3");
	else
	  include_local("inc-urls-".$GLOBALS['type_urls'].".php3");
	$url = ereg_replace('^/', '', generer_url_article($id_article));
	$adresse_site = lire_meta("adresse_site");
	$nom_site_spip = lire_meta("nom_site");
	$url = "$adresse_site/$url";
	$parauteur = (strlen($auteur) <= 2) ? '' :
	  (" "
	   ._T('forum_par_auteur',
	       array('auteur' => $auteur)) .
	   (!$email_auteur ? '' : (' <' . $email_auteur . '>')));
	$courr =  _T('form_forum_message_auto')."\n\n"
		. _T('forum_poste_par',
		     array('parauteur' => $parauteur))."\n"
		. _T('forum_ne_repondez_pas')."\n"
		. $url
		. "\n\n\n".$titre."\n\n".textebrut(propre($texte))
		. "\n\n$nom_site_forum\n$url_site\n";
	$sujet = "[$nom_site_spip] ["._T('forum_forum')."] $titre";
	$result = spip_query("SELECT auteurs.email FROM spip_auteurs AS auteurs,
				spip_auteurs_articles AS lien
				WHERE lien.id_article='$id_article'
				AND auteurs.id_auteur=lien.id_auteur");

	while (list($email) = spip_fetch_array($result)) {
		$email = trim($email);
		if (strlen($email) < 3) continue;
		envoyer_mail($email, $sujet, $courr);
	}
}	

$retour_forum = rawurldecode($retour);
$forum_id_article = intval($id_article);
$forum_id_rubrique = intval($id_rubrique);
$forum_id_forum = intval($id_forum);
$forum_id_breve = intval($id_breve);
$forum_id_syndic = intval($id_syndic);
$slash_texte = addslashes($texte);
$slash_titre = addslashes($titre);
$slash_nom_site_forum = addslashes($nom_site_forum);
$slash_url_site = addslashes($url_site);
$id_message = intval($id_message);

if (!$id_auteur)
	$id_auteur = intval($auteur_session['id_auteur']);

if ($forum_id_article) {
	$r = spip_query("SELECT accepter_forum FROM spip_articles WHERE id_article=$forum_id_article");
	$r = spip_fetch_array($r);
	if ($r)
		$forums_publics = $r['accepter_forum'];
	else
		$forums_publics = lire_meta("forums_publics");
} else {
	$forums_publics = substr(lire_meta("forums_publics"),0,3);
}

if ($forums_publics == "abo") {
	if ($auteur_session) {
		$statut = $auteur_session['statut'];
		if (!$statut OR $statut == '5poubelle') {
			ask_php_auth(_T('forum_acces_refuse'),
				     _T('forum_cliquer_retour',
					array('retour_forum' => $retour_forum)));
			exit;		  
		}
	}
	else {
		ask_php_auth(_T('forum_non_inscrit'),
			     _T('forum_cliquer_retour',
				array('retour_forum' => $retour_forum)));
		exit;		  
	}

	// Ne pas autoriser de changement de nom si forum sur abonnement
	$auteur = $auteur_session['nom'];
	$email_auteur = $auteur_session['email'];
 } 

$slash_auteur = addslashes($auteur);
$slash_email_auteur = addslashes($email_auteur);

if ((strlen($slash_texte) + strlen($slash_titre) + strlen($slash_nom_site_forum) + strlen($slash_url_site) + strlen($slash_auteur) + strlen($slash_email_auteur)) > 20 * 1024) {
	ask_php_auth(_T('forum_message_trop_long'),
		     _T('forum_cliquer_retour',
			array('retour_forum' => $retour_forum)));
			exit;		  
}

spip_query("DELETE FROM spip_mots_forum WHERE id_forum='$id_message'");
if ($ajouter_mot) {
	for (reset($ajouter_mot);$key=key($ajouter_mot);next($ajouter_mot))
		$les_mots .= ",".join($ajouter_mot[$key],",");
	$les_mots = explode(",", $les_mots);
	for ($index = 0; $index < count($les_mots); $index++){
		$le_mot = $les_mots[$index];
		if ($le_mot > 0)
		spip_query("INSERT INTO spip_mots_forum (id_mot, id_forum)
		VALUES ('$le_mot', '$id_message')");
	}
}

$validation_finale = (strlen($confirmer) > 0 OR
	($afficher_texte=='non' AND $ajouter_mot));
$statut = ((!$validation_finale) ? 'redac' : 
	(($forums_publics == 'non') ? 'off' :
	(($forums_publics == 'pri') ? 'prop' : 'publie')));

if ($forum_id_forum > 0) $id_thread = $forum_id_forum;
else $id_thread = $id_message;

spip_query("UPDATE spip_forum SET id_parent = $forum_id_forum,
	id_rubrique =$forum_id_rubrique,
	id_article = $forum_id_article,
	id_breve = $forum_id_breve,
	id_syndic = $forum_id_syndic,
	id_auteur = $id_auteur,
	id_thread = $id_thread,
	date_heure = NOW(),
	titre = \"$slash_titre\",
	texte = \"$slash_texte\",
	nom_site = \"$slash_nom_site_forum\",
	url_site = \"$slash_url_site\",
	auteur = \"$slash_auteur\",
	email_auteur = \"$slash_email_auteur\",
	ip = \"$REMOTE_ADDR\",
	statut = \"$statut\"
	WHERE id_forum = '$id_message'
");

//calculer_threads();

if ($validation_finale) {
	include_ecrire("inc_admin.php3");
	if (!(verifier_action_auteur("ajout_forum $forum_id_rubrique".
	" $forum_id_forum $forum_id_article $forum_id_breve".
	" $forum_id_syndic $alea", $hash))) {
		header("Status: 404");
		exit;
	} else {
	  if (lire_meta("prevenir_auteurs") == "oui" AND ($afficher_texte != "non") AND ($id_article = $forum_id_article)) {
			prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);

		}
		// Poser un cookie pour ne pas retaper le nom / email
		$cookie_user = array('nom' => $auteur, 'email' => $email_auteur);
		spip_setcookie('spip_forum_user', serialize($cookie_user));

		//
		// INVALIDATION DES CACHES LIES AUX FORUMS
		//
		include_ecrire('inc_invalideur.php3');
		if ($statut == 'publie') {
			suivre_invalideur ("id='id_forum/" .
				calcul_index_forum($forum_id_article,
					$forum_id_breve,
					$forum_id_rubrique,
					$forum_id_syndic) . "'");
		}

		$redirect = $retour_forum;
	}
}

?>

--- NEW FILE: distrib.php3 ---
<?php
$fond = "distrib";
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
$flag_preserver = true;

include ("inc-public.php3");

?>
--- NEW FILE: inc-cache.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CACHE")) return;
define("_INC_CACHE", "1");


//
// Calcul du nom du fichier cache
//

function nettoyer_uri() {
	$fichier_requete = $GLOBALS['REQUEST_URI'];
	$fichier_requete = eregi_replace
		('[?&](PHPSESSID|(var_[^=&]*))=[^&]*',
		'', $fichier_requete);
	return $fichier_requete;
}

//
// Le format souhaite : "CACHE/a/(8400/)bout-d-url.md5(.gz)"
// Attention a modifier simultanement le sanity check de
// la fonction retire_cache()
//
function generer_nom_fichier_cache($contexte='', $fond='') {
	global $delais;
	global $flag_gz, $compresser_cache;

	if ($delais == 0) return '';

	if (!$contexte) {
		$fichier_requete = nettoyer_uri();
	} else {
		$fichier_requete = $fond;
		foreach ($contexte as $var=>$val)
			$fichier_requete .= "&$var=$val";
	}

	$md_cache = md5($fichier_requete);

	$fichier_cache = ereg_replace('^/+', '', $fichier_requete);
	$fichier_cache = ereg_replace('\.[a-zA-Z0-9]*', '', $fichier_cache);
	$fichier_cache = ereg_replace('&[^&]+=([^&]+)', '&\1', $fichier_cache);
	$fichier_cache = rawurlencode(strtr($fichier_cache, '/&-', '--_'));
	if (strlen($fichier_cache) > 24)
		$fichier_cache = substr(ereg_replace('([a-zA-Z]{1,3})[^-]*-',
		'\1-', $fichier_cache), -22);

	// Pour la page d'accueil
	if (!$fichier_cache)
		$fichier_cache = 'INDEX-';

	// morceau de md5
	$fichier_cache .= '.'.substr($md_cache, 1, 8);

	// Sous-repertoires 0...9a..f/
	$subdir = creer_repertoire(_DIR_CACHE, substr($md_cache, 0, 1));
	// Sous-sous-repertoires delais/ (inutile avec l'invalidation par 't')
	# $subdir2 = creer_repertoire("CACHE/$subdir", $delais);

	include_ecrire('inc_acces.php3');
	verifier_htaccess(_DIR_CACHE);

	$gzip = $flag_gz && $compresser_cache ? '.gz' : '';

	return _DIR_CACHE . $subdir.$subdir2.$fichier_cache.$gzip;
}

//
// Destruction des fichiers caches invalides
//
// NE PAS appeler ces fonctions depuis l'espace prive 
// car openbase_dir peut leur interdire l'acces au repertoire de cache

// Securite : est sur que c'est un cache
function retire_cache($cache) {
	if ($GLOBALS['flag_ecrire']) return;
	if (preg_match('|^' . _DIR_CACHE .
		"([0-9a-f]/)?([0-9]+/)?[^.][\-_\%0-9a-z]+\.[0-9a-f]+(\.gz)?$|i",
		       $cache)) {
		// supprimer le fichier (de facon propre)
		supprimer_fichier($cache);
	} else
		spip_log("Impossible de retirer $cache");
}

// Supprimer les caches marques "x"
function retire_caches() {
	if ($GLOBALS['flag_ecrire']) return;

	// signaler
	effacer_meta('invalider');
	ecrire_metas();

	// recuperer la liste des caches voues a la suppression
	$suppr = array();
	$q = spip_query("SELECT fichier FROM spip_caches WHERE type='x'");
	while ($r = spip_fetch_array($q))
		$suppr[$r['fichier']] = true;

	if ($n = count($suppr)) {
		spip_log ("Retire $n caches");
		foreach ($suppr as $cache => $ignore)
			retire_cache($cache);
		spip_query("DELETE FROM spip_caches WHERE "
		.calcul_mysql_in('fichier', "'".join("','",$suppr)."'") );
	}
}

//
// Retourne 0 s'il faut calculer le cache, 1 si on peut l'utiliser
//
function utiliser_cache($chemin_cache, $delais) {
	global $HTTP_SERVER_VARS;

	// ne jamais calculer pour les moteurs de recherche, proxies...
	if ($HTTP_SERVER_VARS['REQUEST_METHOD'] == 'HEAD')
		return 1;

	//  calcul par forcage
	if ($GLOBALS['var_mode'] &&
		($GLOBALS['HTTP_COOKIE_VARS']['spip_session']
		|| $GLOBALS['HTTP_COOKIE_VARS']['spip_admin']
		|| @file_exists(_ACCESS_FILE_NAME))) # insuffisant...
		return 0;

	// calcul par absence
	if (!@file_exists($chemin_cache)) return 0;

	// calcul par obsolescence
	return ((time() - @filemtime($chemin_cache)) > $delais) ? 0 : 1;
}


// Obsolete ?  Utilisee pour vider le cache depuis l'espace prive
// (ou juste les squelettes si un changement de config le necessite)
function purger_repertoire($dir, $age='ignore', $regexp = '') {
	$handle = @opendir($dir);
	if (!$handle) return;

	while (($fichier = @readdir($handle)) != '') {
		// Eviter ".", "..", ".htaccess", etc.
		if ($fichier[0] == '.') continue;
		if ($regexp AND !ereg($regexp, $fichier)) continue;
		$chemin = "$dir/$fichier";
		if (is_file($chemin))
			@unlink($chemin);
		else if (is_dir($chemin))
			if ($fichier != 'CVS')
				purger_repertoire($chemin);
	}
	closedir($handle);
}

function purger_cache() {
	spip_log('vider le cache');
	include_ecrire('inc_invalideur.php3');
	supprime_invalideurs();
	purger_repertoire(_DIR_CACHE, 0);
}

function purger_squelettes() {
	spip_log('effacer les squelettes compiles');
	purger_repertoire(_DIR_CACHE, 0, '^skel_');
}


// Determination du fichier cache (si besoin)
function determiner_cache($delais, &$use_cache, &$chemin_cache) {

	// Le fichier cache est-il valide ?
	if ($delais == 0 OR !empty($GLOBALS['HTTP_POST_VARS'])) {
		$use_cache = 0;
		$chemin_cache = '';
	} else {
		$use_cache = utiliser_cache($chemin_cache, $delais);
	}

	// Sinon, tester qu'on a la connexion a la base
	if (!$use_cache) {
		include_local(_FILE_CONNECT);
		if (!$GLOBALS['db_ok']) {
			if ($chemin_cache AND @file_exists($chemin_cache)) {
				$use_cache = 1;
			}
			else {
				spip_log("Erreur base de donnees & "
					. "impossible utiliser $chemin_cache");
				if (!$GLOBALS['flag_preserver']) {
					include_ecrire('inc_presentation.php3');
					install_debut_html(_T('info_travaux_titre'));
					echo _T('titre_probleme_technique');
					install_fin_html();
				}
				exit;
			}
		}
	}
}

?>

--- NEW FILE: sommaire_texte-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<!--
// ACCESSIBILITE
// la page /oo offre une lecture en mode "texte seul"
// des 3 articles les plus recents.
-->
<head>
	<title>
		#NOM_SITE_SPIP
	</title>
	<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
	<meta http-equiv="AUTHOR" content="#NOM_SITE_SPIP">
	<meta http-equiv="DESCRIPTION" content="Edition en mode texte de #NOM_SITE_SPIP">
</head>
<body dir="#LANG_DIR">
	<hr />
	<:edition_mode_texte:> <a href="#URL_SITE_SPIP">{#NOM_SITE_SPIP}</a>
	<hr />
	<b><u>Sommaire de la page :</u></b>

	<B_sarticles>
	<h2>Articles</h2>
	<ul>
		<BOUCLE_sarticles(ARTICLES){0,3}{par date}{inverse}>
			<li><a href="#ar#ID_ARTICLE">#TITRE</a>
		</BOUCLE_sarticles>
	</ul>
	</B_sarticles>

	<B_sbreves>
	<h2>Br&egrave;ves</h2>
	<ul>
		<BOUCLE_sbreves(BREVES){0,5}{par date}{inverse}>
			<li><a href="#br#ID_BREVE">#TITRE</a>
		</BOUCLE_sbreves>
	</ul>
	</B_sbreves>


	<B_articles>
	<h1>Articles r&eacute;cents</h1>

	<BOUCLE_articles(ARTICLES){0,3}{par date}{inverse}>
		<a name="ar#ID_ARTICLE"></a>
		<BOUCLE_RUB_AR(RUBRIQUES){ID_RUBRIQUE}>
			Rubrique : <a href="#URL_RUBRIQUE">{#TITRE}</a>
		</BOUCLE_RUB_AR>

		[<h2>(#SURTITRE|majuscules)</h2>]
		<h2>#TITRE</h2>
		<h3>#SOUSTITRE</h3>
		[Le (#DATE|nom_jour) ] [(#DATE|affdate)]
		[par (#LESAUTEURS)]
		<p>
		[(#CHAPO)]
		<p>
		[(#TEXTE)]

		
		<p><a href="#URL_ARTICLE">{Consulter}</a> l'article avec son forum. 

		
		<hr />
	</BOUCLE_articles>

	<B_breves>
	<h1>Derni&egrave;res br&egrave;ves</h1>

	<BOUCLE_breves(BREVES){0,5}{par date}{inverse}>
		<a name="br#ID_BREVE">
		<BOUCLE_RUB_BR(RUBRIQUES){ID_RUBRIQUE}>
			Rubrique : <a href="#URL_RUBRIQUE">{#TITRE}</a>
		</BOUCLE_RUB_BR>
		<h2>#TITRE</h2>
		[Le (#DATE|nom_jour) ] [(#DATE|affdate)]
		<p>
		[(#TEXTE)]
		[<p>Voir en ligne : <a href="(#URL_SITE)">#NOM_SITE</a>]
		<p><a href="#URL_BREVE">{Consulter}</a> la br&egrave;ve avec son forum. 
	<hr />
	</BOUCLE_breves>
	[<h1>NOTES :</h1>
	<p class="spip_note">(#NOTES)]
	
	<hr />
	<a name="about"></a>
	
	[<p>Rechercher sur ce site : (#FORMULAIRE_RECHERCHE|recherche.php3)</p>]
	<table><tr>
		<td><A href="http://www.uzine.net/spip">{Site r&eacute;alis&eacute; avec le logiciel SPIP}</td>
		[<td><A href="#URL_SITE_SPIP">{(#NOM_SITE_SPIP|majuscules)}</a></td>]
		<td><a href="#URL_SITE_SPIP/plan.php3">{<:plan_site:>}</a></td>
	</tr></table>

</body>
</html>

--- NEW FILE: mot-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_mot_principal(MOTS) {id_mot} {doublons}>

<html lang="#LANG">
<head>
<title>[(#TITRE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Menu de navigation mots-cles : les autres mots cles du meme groupe-->

<B_mots_freres>
<h2 class="structure"><:mots_clefs_meme_groupe:></h2>

<div class="menu">
<div class="divers">
<div class="menu-titre"><BOUCLE_groupe(GROUPES_MOTS) {id_groupe} {doublons}>#TITRE</BOUCLE_groupe></div>
	<ul class="menu-liste">
<BOUCLE_mots_freres(MOTS) {type} {doublons} {par titre}>
	<li class="menu-item"><a href="#URL_MOT" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
</BOUCLE_mots_freres>
	</ul>
</div>
</div>
</B_mots_freres>


<!-- Menu de navigation mots-cles : les autres groupes avec un lien sur le premier mot du groupe -->

<B_groupes_freres>
<h2 class="structure"><:autres_groupes_mots_clefs:></h2>

<div class="menu">
<div class="divers">
<div class="menu-titre"><:autres_groupes_mots_clefs:></div>
	<ul class="menu-liste">
<BOUCLE_groupes_freres(GROUPES_MOTS) {par titre} {doublons}>
<BOUCLE_mot_cousin(MOTS) {id_groupe} {par titre} {0,1}>
	<li class="menu-item"><a href="#URL_MOT">#TYPE</a></li>
</BOUCLE_mot_cousin>
</BOUCLE_groupes_freres>
	</ul>
</div>
</div>
</B_groupes_freres>


</div>

<!-- Une : contenu du mot-cle -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_MOT|left)]
<h1 class="titre-texte">#TITRE</h1>
</div>

	<div class="encart">

	<!-- Rubriques liees au mot-cle -->

	<B_rubriques>
	<h2 class="structure"><:rubriques:></h2>

	<div class="menu">
	<div class="rubriques">
	<div class="menu-titre"><:rubriques:></div>
		<ul class="menu-liste">
	<BOUCLE_rubriques(RUBRIQUES) {id_mot} {par titre}>
		<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
	</BOUCLE_rubriques>
		</ul>
	</div>
	</div>
	</B_rubriques>

	<!-- Breves liees au mot-cle -->

	<B_breves>
	<h2 class="structure"><:breves:></h2>

	<div class="menu">
	<div class="breves">
	<div class="menu-titre"><:breves:></div>
		<ul class="menu-liste">
	<BOUCLE_breves(BREVES) {id_mot} {par titre}>
		<li class="menu-item"><a href="#URL_BREVE">#TITRE</a></li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>
	</B_breves>

	<!-- Sites Web lies au mot-cle -->

	<B_sites>
	<h2 class="structure"><:sites_web:></h2>

	<div class="menu">
	<div class="breves">
	<div class="menu-titre"><:sites_web:></div>
		<ul class="menu-liste">
	<BOUCLE_sites(SITES) {id_mot} {par nom_site}>
		<li class="menu-item"><a href="#URL_SITE">#TITRE</a></li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>

	</div>

[<div class="chapo">(#TEXTE)</div>]
[<div class="notes">(#NOTES)</div>]


<!-- Articles lies au mot-cle -->

<h1 class="structure"><:articles:></h1>

<div class="liste-articles">

<BOUCLE_articles(ARTICLES) {id_mot} {par titre}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs><:par_auteur:> <BOUCLE_auteurs(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs>
	</div>
	<br>
</BOUCLE_articles>

</div>
</div>
#FORMULAIRE_ADMIN
</body>
</html>
</BOUCLE_mot_principal>
<//B_mot_principal>

--- NEW FILE: forum-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] <:poster_message:></title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

</div>


<!-- Contenu : poster un message dans le forum -->

<div id="principal" class="contenu">

<h1 class="structure"><:poster_message:></h1>

<BOUCLE_article(ARTICLES) {id_article}>
	<:en_reponse:>
	[(#LOGO_ARTICLE|right)]
	[<div class="surtitre">(#SURTITRE)</div>]
	<h2 class="titre-extrait"><a href="#URL_ARTICLE">#TITRE</a></h2>
	[<div class="surtitre">(#SOUSTITRE)</div>]
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_un><:par_auteur:> <BOUCLE_auteurs_un(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_un>
	</div>
	[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
	<br>
</BOUCLE_article>

<BOUCLE_breve(BREVES) {id_breve}>
	<:en_reponse:>
	[(#LOGO_BREVE|right)]
	<h2 class="titre-extrait"><a href="#URL_BREVE">#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	</div>
	[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
	<br>
</BOUCLE_breve>

<BOUCLE_forum_parent(FORUMS) {id_forum}>
	<:en_reponse:>
	<h2 class="titre-extrait"><a href="#URL_BREVE">#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	</div>
	[<div class="texte"><div class="extrait">(#TEXTE)</div></div>]
	<br>
</BOUCLE_forum_parent>


#FORMULAIRE_FORUM


</div>

#FORMULAIRE_ADMIN
</body>
</html>



--- NEW FILE: htaccess-propres.txt ---
###########################################################
# Fichier .htaccess pour les URLs propres ; a installer   #
# si vous reglez $type_urls='propre'                      #
# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
# (fichier associe : inc-urls-propres.php3)               #
###########################################################

RewriteEngine On

### si votre site est en sous-domaine, preciser ci-dessous
# RewriteBase /sous/domaine/

# Rediriger les mots et breves sans le "+" final
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(\+[^/\.\+]+)$ /$1+ [QSA,R]

# Les mots-cles
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^\+-[^/\.]+-\+$ mot.php3 [QSA,E=url_propre:$0]

# Les breves
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^\+[^/\.]+\+$ breve.php3 [QSA,E=url_propre:$0]

# Les rubriques
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^-[^/\.]+-$ rubrique.php3 [QSA,E=url_propre:$0]

# Les articles
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^[^/\.]+$ article.php3 [QSA,E=url_propre:$0]

--- NEW FILE: recherche.php3 ---
<?php
$fond = "recherche";
$delais = 0;

include ("inc-public.php3");


?>

--- NEW FILE: inc-formulaire_recherche.php3 ---
<?php

global $balise_FORMULAIRE_RECHERCHE_collecte;
$balise_FORMULAIRE_RECHERCHE_collecte = array();

function balise_FORMULAIRE_RECHERCHE_stat($args, $filtres)
{
  return (lire_meta("activer_moteur") != "oui") ? '' : array($filtres[0]);
}
 
function balise_FORMULAIRE_RECHERCHE_dyn($lien) {
	return array('formulaire_recherche', 3600, 
		     array('lien' => ($lien ? $lien : 'recherche.php3'),
			   'recherche' => ($GLOBALS['recherche'] ? $GLOBALS['recherche'] : _T('info_rechercher'))));
}

?>
--- NEW FILE: spip_test_dirs.php3 ---
<?php
if (defined("_TEST_DIRS")) return;
define("_TEST_DIRS", "1");

include("ecrire/inc_version.php3");

include_ecrire("inc_presentation.php3");

utiliser_langue_visiteur();


//
// Tente d'ecrire
//
function test_ecrire($my_dir) {
	$ok = true;
	$nom_fich = "$my_dir/test.txt";
	$f = @fopen($nom_fich, "w");
	if (!$f) $ok = false;
	else if (!@fclose($f)) $ok = false;
	else if (!@unlink($nom_fich)) $ok = false;
	return $ok;
}

//
// teste les droits sur les repertoires $test_dirs declares dans inc_version
//

// rajouter celui passer dans l'url ou celui du source (a l'installation)

if ($test_dir) {
  if (!ereg("/$", $test_dir)) $test_dir .= '/';
  if (!in_array($test_dir, $test_dirs)) $test_dirs[] = $test_dir;
 }
else {
	if (!_FILE_CONNECT)
	  $test_dirs[] = dirname(_FILE_CONNECT_INS);
}

unset($bad_dirs);
unset($absent_dirs);

while (list(, $my_dir) = each($test_dirs)) {
	if (!test_ecrire($my_dir)) {
		@umask(0);
		if (@file_exists($my_dir)) {
			@chmod($my_dir, 0777);
			// ???
			if (!test_ecrire($my_dir))
				@chmod($my_dir, 0775);
			if (!test_ecrire($my_dir))
				@chmod($my_dir, 0755);
			if (!test_ecrire($my_dir))
				$bad_dirs[] = "<LI>".$my_dir;
		} else
			$absent_dirs[] = "<LI>".$my_dir;
	}
}

if ($bad_dirs OR $absent_dirs) {
	install_debut_html();

	if (!_FILE_CONNECT) {
		$titre = _T('dirs_preliminaire');
		$continuer = ' '._T('dirs_commencer');
	} else
		$titre = _T('dirs_probleme_droits');

	$bad_url = "spip_test_dirs.php3";
	if ($test_dir) $bad_url .= '?test_dir='.$test_dir;

	echo "<FONT FACE=\"Verdana,Arial,Helvetica,sans-serif\" SIZE=3>$titre</FONT>\n<p>";
	echo "<div align='right'>". menu_langues('var_lang_ecrire')."</div>\n";

	if ($bad_dirs) {
		echo "<p>";
		echo _T('dirs_repertoires_suivants',
			array('bad_dirs' => join(" ", $bad_dirs)));
		echo "<B>". _T('login_recharger')."</b>";
	}

	if ($absent_dirs) {
		echo "<p>";
		echo _T('dirs_repertoires_absents',
			array('bad_dirs' => join(" ", $absent_dirs)));
		echo "<B>". _T('login_recharger')."</b>";
	}

	echo $continuer.'. ';
	echo aide ("install0");
	echo "<p>";

	echo "<FORM ACTION='$bad_urls' METHOD='GET'>\n";
	echo "<DIV align='right'><INPUT TYPE='submit' CLASS='fondl' VALUE='". _T('login_recharger')."'></DIV>";
	echo "</FORM>";

	install_fin_html();

} else {
	if (!_FILE_CONNECT)
		header("Location: " . _DIR_RESTREINT_ABS . "install.php3?etape=1");
	else
		header("Location: " . _DIR_RESTREINT_ABS);
}

?>

--- NEW FILE: formulaire_menu_lang-dist.html ---
<form	action='[(#HTTP_VARS{url})]'
	method='post'
	style='margin:0px; padding:0px;'>[
	<input type='hidden' name='url' value='(#HTTP_VARS{cible})' />
]	<select	name='[(#HTTP_VARS{nom})]' 
		class='forml'
		style='vertical-align: top; max-height: 24px; margin-bottom: 5px; width: 120px;'
		onchange="document.location.href='[(#HTTP_VARS{retour})]&amp;[(#HTTP_VARS{nom})]='+this.options[this.selectedIndex].value">
		[(#HTTP_VARS*{langues})]
      </select>
      <noscript>
	<input type='submit' value='&gt;&gt;' class='spip_bouton' />
      </noscript>
</form>

--- NEW FILE: inc-formulaire_site.php3 ---
<?php

global $balise_FORMULAIRE_SITE_collecte;
$balise_FORMULAIRE_SITE_collecte = array('id_rubrique', 'nom_site', 'url_site', 'description_site');

function balise_FORMULAIRE_SITE_stat($args, $filtres)
{
  return ((lire_meta("proposer_sites") != 2) ? '' : $args);
}

function balise_FORMULAIRE_SITE_dyn($id_rubrique, $nom_site, $url_site, $description_site) {

	if (!$nom_site) return array('formulaire_site', 0);

	// Tester le nom du site
	if (strlen ($nom_site) < 2){
		return _T('form_prop_indiquer_nom_site');
	}

	// Tester l'URL du site
	include_ecrire("inc_sites.php3");
	if (!recuperer_page($url_site)) {
		return _T('form_pet_url_invalide');
	}

	// Integrer a la base de donnees
		
	$nom_site = addslashes($nom_site);
	$url_site = addslashes($url_site);
	$description_site = addslashes($description_site);
			
	spip_query("INSERT INTO spip_syndic (nom_site, url_site, id_rubrique, descriptif, date, date_syndic, statut, syndication) VALUES ('$nom_site', '$url_site', $id_rubrique, '$description_site', NOW(), NOW(), 'prop', 'non')");
	return  _T('form_prop_enregistre');
}
?>

--- NEW FILE: project.index ---
ecrire/inc_base.php3	d_ECRIRE_INC_BASE	o100	fspip_create_table	o556	fcreer_base	o1062	g$tables_principales	o1085	g$tables_auxiliaires	o1106	fstripslashes_base	o3887
ecrire/inc_invalideur.php3	d_ECRIRE_INVALIDEUR	o99	fsupprime_invalideurs	o177	fmaj_invalideurs	o307	finsere_invalideur	o1214	fsuivre_invalideur	o1612	fretire_vieux_caches	o1913	fapplique_invalideur	o2094
ecrire/inc.php3	g$spip_lang_ecrire	o401	g$GLOBALS	o421	g$spip_lang_ecrire	o474	g$auteur_session	o495	g$spip_lang_ecrire	o538	g$spip_lang_ecrire	o619	g$auteur_session	o684	g$spip_lang_ecrire	o710	g$auteur_session	o746	g$spip_session	o763	g$set_couleur	o786	g$prefs	o803	g$set_couleur	o829	g$prefs_mod	o845	g$set_disp	o870	g$prefs	o884	g$set_disp	o910	g$prefs_mod	o923	g$set_options	o948	g$set_options	o978	g$prefs	o1009	g$set_options	o1029	g$prefs_mod	o1044	g$prefs_mod	o1069	g$prefs	o1153	g$set_ecran	o1212	g$set_ecran	o1339	g$spip_ecran	o1379	g$set_ecran	o1393	g$spip_ecran	o1412	g$spip_ecran	o1425	g$debloquer_article	o1477	g$debloquer_article	o1504	g$where_id	o1536	g$debloquer_article	o1573	g$query	o1595	g$query	o1710	g$options	o1766	g$prefs	o1782	g$spip_display	o1801	g$prefs	o1817	g$couleurs_spip	o1851	g$couleurs_spip	o1870	g$couleurs_spip	o2053	g$couleurs_spip	o2072	g$couleurs_spip	o2249	g$couleurs_spip	o2268	g$couleurs_spip	o2445	g$couleurs_spip	o2464	g$couleurs_spip	o2649	g$c!
 ouleurs_spip	o2668	g$couleurs_spip	o2844	g$couleurs_spip	o2863	g$choix_couleur	o3027	g$prefs	o3044	g$couleurs_spip	o3074	g$choix_couleur	o3089	g$choix_couleur	o3129	g$couleur_foncee	o3150	g$couleurs_spip	o3168	g$choix_couleur	o3183	g$couleur_claire	o3218	g$couleurs_spip	o3236	g$choix_couleur	o3251	g$couleur_lien	o3286	g$couleurs_spip	o3302	g$choix_couleur	o3317	g$couleur_lien_off	o3350	g$couleurs_spip	o3370	g$choix_couleur	o3385	g$version_installee	o3452	g$version_installee	o3518	g$spip_version	o3540	g$version_installee	o3578	g$version_installee	o3598	g$adresse_site	o3998	g$nom_site_spip	o4016	g$adresse_site	o4057	g$activer_breves	o4107	g$activer_breves	o4126	g$articles_mots	o4174	g$activer_statistiques	o4227	g$activer_statistiques	o4252	g$nom_site_spip	o4319	g$nom_site_spip	o4338	g$nom_site_spip	o4406	g$adresse_site	o4448	g$adresse_site	o4466	g$REQUEST_URI	o4509	g$REQUEST_URI	o4533	g$adresse_site	o4589	ftester_rubrique_vide	o4635	g$cookie_admin	o5718	g$HTTP_COOKIE_VARS	o57!
 34	g$supp_rubrique	o5794	g$supp_rubrique	o5818	g$connect_statut	o5838	
g$supp_rubrique	o5888	g$query	o5908	g$result	o5981	g$query	o6002	g$controle_forum	o6058	g$id_controle_forum	o6078	g$hash	o6201	g$connect_id_auteur	o6208	g$controle_forum	o6240	g$id_controle_forum	o6306	g$id_controle_forum	o6397	g$id_controle_forum	o6488
oo/index.php3
backend.php3	g$fond	o6	g$delais	o25	g$flag_preserver	o130
ecrire/lang_raccourcis.php3	g$module	o37	g$module	o46	g$modules	o289	g$d	o315	g$f	o356	g$d	o369	g$f	o408	g$regs	o412	g$nom_module	o422	g$regs	o436	g$nom_module	o469	g$spip_lang	o507	g$nom_module	o523	g$reps	o536	g$modules	o547	g$reps	o560	g$d	o581	g$modules	o597	g$modules	o806	g$nom_module	o832	g$modules	o852	g$nom_module	o871	g$module	o886	fafficher_raccourcis	o1197	g$spip_lang	o1247	g$couleur_foncee	o1267	g$module	o2808
ecrire/lang/spip_bg.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/img_pack/index.php3	g$myDir	o298	g$file	o328	g$myDir	o344	g$file	o382
spip_inscription.php3	g$mode	o366	g$mail_inscription	o373	g$nom_inscription	o392	g$focus	o410
ecrire/auteurs.php3	g$supp	o108	g$connect_statut	o118	g$retour	o233	g$tri	o264	g$retour	o273	g$tri	o301	g$tri	o316	g$partri	o334	g$tri	o382	g$tri	o400	g$partri	o418	g$visiteurs	o470	g$retour	o556	g$partri	o649	g$visiteurs	o728	g$connect_statut	o884	g$connect_statut	o995	g$query	o1030	g$result	o1110	g$query	o1131	g$flag_visiteurs	o1141	g$result	o1173	g$flag_visiteurs	o1468	g$visiteurs	o1493	g$visiteurs	o1828	g$connect_statut	o1854	g$sql_statut_auteurs	o1890	g$sql_statut_articles	o1963	g$tri	o1991	g$connect_statut	o2016	g$sql_statut_auteurs	o2051	g$sql_statut_articles	o2125	g$sql_statut_auteurs	o2204	g$sql_statut_articles	o2291	g$tri	o2336	g$sql_order	o2360	g$type_requete	o2407	g$sql_order	o2458	g$type_requete	o2518	g$sql_order	o2575	g$type_requete	o2607	g$nombre_auteurs	o2937	g$auteurs	o2955	g$type_requete	o2980	g$result_auteurs	o3010	g$row	o3225	g$result_auteurs	o3249	g$auteurs	o3271	g$row	o3280	g$row	o3301	g$nombre_auteurs	o3309	g$nom_auteur	o3332	g$row	o3346	g$result_nombr!
 es	o3364	g$row	o3753	g$result_nombres	o3777	g$auteurs	o3797	g$row	o3806	g$row	o3839	g$connect_statut	o3975	g$auteurs	o4017	g$auteur	o4043	g$auteurs	o4060	g$auteur	o4082	g$auteur	o4107	g$auteurs	o4154	g$auteur	o4163	g$nombre_auteurs	o4191	g$lettres_nombre_auteurs	o4366	g$auteurs	o4405	g$auteur	o4417	g$lettres_nombre_auteurs	o4430	g$premiere_lettre	o4460	g$auteur	o4508	g$premiere_lettre	o4537	g$lettre_prec	o4557	g$lettre	o4576	g$premiere_lettre	o4584	g$lettres_nombre_auteurs	o4604	g$lettre_prec	o4637	g$premiere_lettre	o4652	g$result_nombres	o4702	g$vus	o5209	g$row	o5224	g$result_nombres	o5248	g$auteurs	o5270	g$row	o5279	g$row	o5300	g$vus	o5308	g$row	o5320	g$nombre_auteurs	o5341	g$connect_statut	o5483	g$sql_statut_auteurs_ajout	o5517	g$sql_statut_auteurs	o5545	g$sql_statut_auteurs_ajout	o5574	g$result_auteurs	o5641	g$row	o5974	g$result_auteurs	o5998	g$auteurs	o6020	g$row	o6029	g$row	o6050	g$nombre_auteurs	o6058	g$rub_restreinte	o6092	g$connect_statut	o6114	g$restreint	o6184	g$!
 row	o6257	g$restreint	o6281	g$rub_restreinte	o6296	g$row	o6312	g$row	o
6338	g$visiteurs	o6399	g$max_par_page	o6524	g$debut	o6548	g$nombre_auteurs	o6557	g$max_par_page	o6575	g$debut	o6591	g$nombre_auteurs	o6606	g$max_par_page	o6624	g$fin	o6640	g$nombre_auteurs	o6651	g$debut	o6668	g$max_par_page	o6677	g$i	o6732	g$auteurs	o6744	g$i	o6762	g$debut	o6769	g$auteurs	o6785	g$tri	o7044	g$tri	o7249	g$tri	o7263	g$options	o7420	g$visiteurs	o7516	g$tri	o7545	g$nombre_auteurs	o7765	g$max_par_page	o7783	g$options	o7858	g$j	o7966	g$j	o7972	g$nombre_auteurs	o7977	g$j	o7994	g$max_par_page	o7998	g$j	o8021	g$j	o8048	g$debut	o8054	g$j	o8094	g$debut	o8193	g$j	o8202	g$debut	o8210	g$j	o8219	g$max_par_page	o8222	g$tri	o8322	g$tri	o8340	g$options	o8350	g$key	o8543	g$val	o8548	g$lettre	o8561	g$val	o8580	g$debut	o8588	g$i	o8770	g$fin	o8778	g$row	o8793	g$auteurs	o8807	g$couleur	o8843	g$i	o8855	g$couleur_claire	o8877	g$row	o9037	g$row	o9175	g$row	o9203	g$connect_statut	o9230	g$row	o9265	g$rub_restreinte	o9297	g$row	o9313	g$options	o9417	g$row	o9523	g$row	o9555	g$activer_mess!
 agerie	o9575	g$connect_activer_messagerie	o9608	g$messagerie	o9649	g$row	o9695	g$connect_statut	o9738	g$row	o9782	g$row	o9828	g$row	o9913	g$row	o10017	g$row	o10240	g$row	o10269	g$row	o10326	g$debut_suivant	o10520	g$debut	o10537	g$max_par_page	o10546	g$debut_suivant	o10565	g$nombre_auteurs	o10582	g$debut	o10601	g$debut	o10698	g$debut_prec	o10714	g$debut	o10739	g$max_par_page	o10748	g$link	o10770	g$link	o10790	g$debut_prec	o10813	g$link	o10834	g$debut_suivant	o11085	g$nombre_auteurs	o11102	g$link	o11123	g$link	o11143	g$debut_suivant	o11166	g$link	o11190
ecrire/lang/spip_pt.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_forum.php3	d_ECRIRE_INC_FORUM	o101	fchanger_statut_forum	o170	fcontrole_cache_forum	o1426	fcalcul_index_forum	o1807	fcalculer_threads	o2092
ecrire/plugins/plug_carto_distant.php	favant_typo_carto_distant	o366
ecrire/forum_envoi.php3	g$modif_forum	o105	g$titre_message	o128	g$titre_message	o178	g$nom	o195	g$connect_nom	o233	g$adresse_retour	o249	g$adresse_retour	o280	g$valider_forum	o303	g$statut	o323	g$titre_message	o340	g$titre_message	o388	g$texte	o407	g$texte	o447	g$query	o458	g$result	o889	g$query	o910	g$id_message	o947	g$query	o968	g$result	o1057	g$query	o1078	g$adresse_retour	o1112	g$id_message	o1137	g$id_parent	o1316	g$query	o1331	g$result	o1395	g$query	o1416	g$row	o1430	g$result	o1454	g$id_article	o1468	g$row	o1482	g$id_breve	o1504	g$row	o1516	g$id_rubrique	o1536	g$row	o1551	g$id_message	o1574	g$row	o1588	g$id_syndic	o1610	g$row	o1623	g$statut	o1644	g$row	o1654	g$titre_parent	o1672	g$row	o1688	g$texte_parent	o1705	g$row	o1721	g$auteur_parent	o1738	g$row	o1755	g$id_auteur_parent	o1773	g$row	o1793	g$date_heure_parent	o1814	g$row	o1835	g$nom_site_parent	o1857	g$row	o1876	g$url_site_parent	o1896	g$row	o1915	g$titre_parent	o1945	g$titre_parent	o2021	g$auteur_parent	o2109	g$id_a!
 uteur_parent	o2132	g$activer_messagerie	o2154	g$connect_activer_messagerie	o2187	g$bouton	o2229	g$id_auteur_parent	o2255	g$row	o2274	g$bouton	o2287	g$bouton	o2310	g$texte_parent	o2346	g$url_site_parent	o2376	g$nom_site_parent	o2403	g$modif_forum	o2584	g$modif_forum	o2926	g$titre_message	o2997	g$texte	o3029	g$nom_site	o3051	g$titre_parent	o3360	g$adresse_retour	o3873	g$titre_message	o4066	g$titre_message	o4096	g$modif_forum	o4249	g$modif_forum	o4265	g$GLOBALS	o5111	g$texte	o5204	g$statut	o5243	g$options	o5266	g$lien_url	o5515
ecrire/inc_urls.php3	d_ECRIRE_INC_URLS	o100	fgenerer_url_article	o137	fgenerer_url_rubrique	o442	fgenerer_url_breve	o756	fgenerer_url_forum	o1046	fgenerer_url_mot	o1155	fgenerer_url_auteur	o1256	fgenerer_url_document	o1369
ecrire/inc_acces.php3	d_ECRIRE_INC_ACCES	o101	fcreer_pass_aleatoire	o139	flow_sec	o977	fafficher_low_sec	o1431	fverifier_low_sec	o1541	feffacer_low_sec	o1660	finitialiser_sel	o1786	g$htsalt	o1814	fecrire_logins	o1878	fecrire_acces	o2090	fgenerer_htpass	o3230	g$htsalt	o3262	g$flag_crypt	o3271	fverifier_htaccess	o3405	fgerer_htaccess	o4382
spip_redirect.php3	g$GLOBALS	o251	g$id_article	o288	g$url	o304	g$id_article	o331	g$id_breve	o356	g$url	o370	g$id_breve	o395	g$id_forum	o418	g$url	o432	g$id_forum	o457	g$id_rubrique	o480	g$url	o497	g$id_rubrique	o525	g$id_mot	o551	g$url	o563	g$id_mot	o586	g$id_auteur	o607	g$url	o622	g$id_auteur	o648	g$url	o671	g$url	o711	g$super	o725	g$super	o747	g$recalcul	o765	g$url	o776	g$super	o784	g$preview	o821	g$url	o831	g$super	o839
ecrire/lang/spip_ar.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/admin_vider.php3	g$connect_statut	o353	g$connect_toutes_rubriques	o388	g$purger_index	o477	g$hash	o547	g$taille	o2000	g$taille	o2101	g$info	o2115	g$taille	o2184	g$info	o2204	g$quota_cache	o2319	g$quota_cache	o2402	g$compresser_cache	o2493	g$row	o3195	g$row	o3288	g$hash	o3466
ecrire/mes_options.php3	g$server_ip_index	o133	g$server_ips	o151	g$nb_retry	o164	g$server_dns	o175	g$use_dns	o188	g$free_user_name	o198	g$free_user_passwd	o215	g$free_user_name	o236	g$free_user_passwd	o266	g$i	o351	g$server_ips	o360	g$i	o372	g$server_ips	o396	g$i	o408	g$server_ips	o432	g$i	o444	g$server_ips	o468	g$i	o480	g$server_ips	o504	g$i	o516	g$server_ips	o540	g$i	o552	g$server_ip_index	o667	g$server_ips	o699	g$nb_retry	o846	g$server_dns	o1010	g$use_dns	o1042
ecrire/inc_calendrier.php	d_ECRIRE_INC_CALENDRIER	o105	g$GLOBALS	o214	g$GLOBALS	o294	g$GLOBALS	o348	g$GLOBALS	o376	g$GLOBALS	o411	g$GLOBALS	o433	g$GLOBALS	o495	g$GLOBALS	o560	g$GLOBALS	o616	g$GLOBALS	o641	g$GLOBALS	o678	g$GLOBALS	o703	g$bleu	o952	g$vert	o959	g$jaune	o966	g$bleu	o975	g$vert	o1073	g$jaune	o1166	fhttp_calendrier_ics	o1469	fhttp_calendrier_tout	o4060	g$spip_lang_left	o4136	g$largeur_table	o4153	g$largeur_gauche	o4169	g$spip_ecran	o4186	fhttp_calendrier_aide_mess	o5826	g$bleu	o5865	g$vert	o5872	g$jaune	o5879	fhttp_calendrier_retire_args	o6237	fhttp_calendrier_navigation	o6822	g$spip_lang_right	o6952	g$spip_lang_left	o6970	fhttp_agenda_invisible	o10882	g$spip_lang_right	o10958	g$spip_lang_left	o10976	g$couleur_claire	o10993	fhttp_calendrier_navigation_jour	o13215	fhttp_calendrier_navigation_semaine	o13834	fhttp_calendrier_mois	o15062	g$couleur_claire	o15170	g$couleur_foncee	o15187	fhttp_calendrier_les_jours	o16769	fhttp_calendrier_suitede7	o17433	g$couleur_claire	!
 o17543	g$spip_lang_left	o17560	g$spip_lang_right	o17577	fhttp_calendrier_sans_clics	o19478	fhttp_calendrier_clics_jour_semaine	o19566	fhttp_calendrier_clics	o20421	g$bleu	o20483	g$jaune	o20490	g$vert	o20498	fhttp_calendrier_suite_heures	o21282	g$couleur_claire	o21411	g$couleur_foncee	o21428	g$spip_ecran	o21445	g$spip_lang_left	o21458	g$partie_cal	o21474	fhttp_calendrier_agenda	o24122	fhttp_calendrier_agenda_rv	o24955	g$couleur_foncee	o25080	g$spip_lang_left	o25105	g$spip_lang_right	o25122	fhttp_calendrier_image_et_typo	o28211	fhttp_calendrier_articles_et_breves	o28716	fhttp_calendrier_heures	o29284	g$spip_lang_left	o29363	g$spip_lang_right	o29380	fhttp_cal_top	o30563	fhttp_cal_height	o31064	fhttp_calendrier_jour_ics	o31826	g$spip_lang_left	o31926	fhttp_calendrier_journee	o35587	g$largeur_table	o35665	g$largeur_gauche	o35681	g$spip_ecran	o35698	fhttp_calendrier_semaine	o36991	g$spip_ecran	o37063	g$spip_lang_left	o37076	g$couleur_claire	o37093	fhttp_calendrier_jour	o38426	g$s!
 pip_lang_rtl	o38512	g$spip_lang_right	o38528	g$spip_lang_left	o38546	g
$bleu	o38563	g$vert	o38570	g$jaune	o38576	g$calendrier_message_fermeture	o38592	g$partie_cal	o38631	fhttp_calendrier_message	o41726	g$calendrier_message_fermeture	o41773	fhttp_calendrier_ical	o42149	fhttp_calendrier_rv	o42860	g$spip_lang_rtl	o42907	g$spip_lang_left	o42923	g$spip_lang_right	o42940	fsql_calendrier_interval_jour	o45529	fsql_calendrier_interval_semaine	o45831	fsql_calendrier_interval_mois	o46357	fsql_calendrier_interval_articles	o46977	fsql_calendrier_interval_breves	o47481	fsql_calendrier_interval_rv	o48008	g$connect_id_auteur	o48061	fsql_calendrier_taches_annonces	o50553	fsql_calendrier_taches_pb	o50854	g$connect_id_auteur	o50892	fsql_calendrier_taches_rv	o51209	g$connect_id_auteur	o51247	fsql_calendrier_agenda	o51941	g$connect_id_auteur	o51989	fsql_calendrier_jour_ical	o52676	fcalendrier_echelle	o52987	g$contrastes	o53456	g$contrastes	o53469	fcalendrier_div_style	o54549	g$contrastes	o54593
ecrire/lang/spip_es.php3	g$GLOBALS	o80	g$GLOBALS	o89
mot.php3	g$fond	o6	g$delais	o21
ecrire/accents.php3	fchanger_accents	o142
ecrire/lang/spip_fon.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/message_edit.php3	g$new	o86	g$type	o110	g$ok	o139	g$connect_statut	o146	g$ok	o235	g$ok	o271	g$ok	o294	fmy_sel	o466	fafficher_mois	o614	fafficher_annee	o1219	fafficher_jour	o1459	fafficher_jour_mois_annee_h_m	o1659	fafficher_si_rdv	o2289	g$spip_lang_rtl	o2347	g$new	o3726	g$mydate	o3744	g$query	o3795	g$result	o3886	g$query	o3907	g$type	o3922	g$statut	o3937	g$statut	o3963	g$id_message	o3984	g$rv	o4215	g$type	o4366	g$dest	o4519	g$type	o4658	g$ajouter_auteur	o4677	g$onfocus	o4705	g$row	o4782	g$id_message	o4880	g$row	o4894	g$date_heure	o4914	g$row	o4928	g$date_fin	o4948	g$row	o4960	g$titre	o4978	g$row	o5000	g$texte	o5016	g$row	o5038	g$type	o5054	g$row	o5062	g$statut	o5076	g$row	o5086	g$page	o5102	g$row	o5110	g$rv	o5124	g$row	o5130	g$expediteur	o5142	g$row	o5156	g$expediteur	o5254	g$connect_id_auteur	o5268	g$type	o5291	g$connect_statut	o5313	g$type	o5359	g$le_type	o5382	g$logo	o5426	g$type	o5452	g$le_type	o5471	g$logo	o5509	g$type	o5538	g$le_type	o5561	g$logo	o5596	g$type	o5!
 867	g$ajouter_auteur	o6360	g$rv	o6636	g$fonction	o6650	g$fonction	o6677	g$fonction	o6740	g$date_heure	o6794	g$date_fin	o6807	g$rv	o6819	g$texte	o6995
ecrire/lang/public_zh.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/public_oc_prv.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_majbase.php3	d_ECRIRE_INC_MAJBASE	o103	fmaj_version	o142	fmaj_base	o481	g$spip_version	o502	g$htsalt	o5924
ecrire/breves_voir.php3	g$id_breve	o146	g$id_breve	o157	g$flag_mots	o171	fmy_sel	o225	fafficher_mois	o378	fafficher_annee	o925	fafficher_jour	o1220	g$id_breve	o1392	g$new	o1413	g$id_rubrique	o1432	g$id_rubrique	o1454	g$langue_new	o1470	g$result_lang_rub	o1489	g$row	o1591	g$result_lang_rub	o1615	g$langue_new	o1638	g$row	o1652	g$langue_new	o1675	g$langue_new	o1688	g$langue_choisie_new	o1729	g$id_breve	o1760	g$clean_link	o1992	g$titre	o2061	g$modifier_breve	o2072	g$titre	o2092	g$titre	o2112	g$texte	o2122	g$texte	o2142	g$lien_titre	o2152	g$lien_titre	o2177	g$champs_extra	o2230	g$add_extra	o2285	g$add_extra	o2368	g$query	o2387	g$result	o2584	g$query	o2605	g$invalider_caches	o2647	g$id_breve	o2859	g$id_rubrique	o2936	g$row	o2973	g$langue_old	o3085	g$row	o3099	g$langue_choisie_old	o3115	g$row	o3137	g$langue_choisie_old	o3170	g$row	o3205	g$langue_new	o3311	g$row	o3325	g$langue_new	o3348	g$langue_old	o3363	g$jour	o3490	g$connect_statut	o3500	g$annee	o3539	g$mois	o3557	g$mois	o3576	g$!
 jour	o3591	g$query	o3606	g$result	o3699	g$query	o3720	g$query	o3756	g$result	o3821	g$query	o3842	g$row	o3859	g$result	o3883	g$id_breve	o3896	g$row	o3906	g$date_heure	o3925	g$row	o3937	g$titre_breve	o3958	g$row	o3971	g$titre	o3987	g$row	o3994	g$texte	o4010	g$row	o4017	g$extra	o4033	g$row	o4040	g$lien_titre	o4056	g$row	o4068	g$lien_url	o4089	g$row	o4099	g$statut	o4118	g$row	o4126	g$id_rubrique	o4143	g$row	o4156	g$flag_editable	o4180	g$connect_statut	o4199	g$id_rubrique	o4249	g$statut	o4267	g$id_rubrique	o4401	g$id_breve	o4737	g$statut	o4748	g$arton	o4859	g$artoff	o4888	g$id_breve	o4924	g$connect_statut	o4941	g$id_rubrique	o4991	g$arton	o5028	g$artoff	o5036	fenfant	o5406	g$id_parent	o5433	g$id_rubrique	o5453	g$i	o5475	g$titre	o5939	g$flag_editable	o5967	g$flag_editable	o6251	g$options	o6271	g$statut	o6297	g$statut	o6327	g$date_heure	o6413	g$regs	o6426	g$mois	o6446	g$regs	o6454	g$jour	o6474	g$regs	o6482	g$annee	o6502	g$regs	o6511	g$jour	o7146	g$mois	o7243	g$annee	o7342	g$date_h!
 eure	o7660	g$flag_mots	o7709	g$flag_editable	o7731	g$options	o7750	g$i
d_breve	o7803	g$nouv_mot	o7814	g$supp_mot	o7825	g$cherche_mot	o7836	g$flag_editable	o7850	g$flag_editable	o7947	g$row	o7967	g$langue_parent	o8071	g$row	o8088	g$changer_lang	o8108	g$changer_lang	o8131	g$changer_lang	o8214	g$langue_parent	o8348	g$row	o8426	g$langue_breve	o8537	g$row	o8553	g$langue_choisie_breve	o8568	g$row	o8592	g$langue_choisie_breve	o8622	g$herit	o8654	g$herit	o8676	g$langue_breve	o8981	g$langue_breve	o9194	g$langue_parent	o9213	g$texte	o9328	g$lien_url	o9355	g$lien_titre	o9379	g$lien_titre	o9485	g$lien_titre	o9530	g$lien_titre	o9609	g$lien_url	o9654	g$les_notes	o9754	g$champs_extra	o9879	g$extra	o9897	g$extra	o9961	g$connect_statut	o9988	g$id_rubrique	o10036	g$statut	o10055	g$statut	o10074	g$forum_retour	o10721	g$forum_retour	o10904	g$titre	o10965	g$query_forum	o11056	g$result_forum	o11197	g$query_forum	o11224	g$result_forum	o11254	g$forum_retour	o11269
ecrire/statistiques_visites.php3	fhttp_img_rien	o80	g$id_article	o330	g$id_article	o351	g$query	o367	g$result	o485	g$query	o506	g$row	o521	g$result	o545	g$titre	o559	g$row	o573	g$total_absolu	o591	g$row	o607	g$val_popularite	o626	g$row	o650	g$query	o685	g$result	o752	g$query	o773	g$row	o788	g$result	o812	g$total_absolu	o826	g$row	o842	g$titre	o875	g$pourarticle	o883	g$origine	o950	g$pourarticle	o1418	g$titre	o1607	g$titre	o1626	g$id_article	o1842	g$articles_recents	o2089	g$query	o2117	g$result	o2238	g$query	o2259	g$row	o2276	g$result	o2300	g$articles_recents	o2314	g$row	o2336	g$articles_recents	o2360	g$articles_recents	o2385	g$query	o2433	g$result	o2577	g$query	o2598	g$nombre_articles	o2609	g$result	o2642	g$nombre_articles	o2657	g$row	o2952	g$result	o2976	g$titre	o2991	g$row	o3005	g$l_article	o3024	g$row	o3037	g$visites	o3060	g$row	o3071	g$popularite	o3091	g$row	o3111	g$liste	o3135	g$classement	o3148	g$l_article	o3160	g$liste	o3174	g$liste	o3193	g$articles_vus	o3213	g$l_arti!
 cle	o3231	g$l_article	o3255	g$id_article	o3269	g$popularite	o3487	g$visites	o3513	g$articles_vus	o3557	g$articles_vus	o3578	g$query_suite	o3625	g$result_suite	o3833	g$query_suite	o3860	g$result_suite	o3898	g$row	o3963	g$result_suite	o3987	g$titre	o4009	g$row	o4023	g$l_article	o4043	g$row	o4056	g$visites	o4080	g$row	o4091	g$popularite	o4112	g$row	o4132	g$numero	o4157	g$classement	o4167	g$l_article	o4179	g$l_article	o4205	g$id_article	o4219	g$popularite	o4446	g$visites	o4472	g$query	o4722	g$result	o4874	g$query	o4895	g$result	o4926	g$row	o5250	g$result	o5274	g$titre	o5289	g$row	o5303	g$l_article	o5322	g$row	o5335	g$visites	o5358	g$row	o5369	g$popularite	o5389	g$row	o5409	g$numero	o5434	g$classement	o5444	g$l_article	o5456	g$l_article	o5482	g$id_article	o5496	g$popularite	o5723	g$visites	o5749	g$connect_statut	o5939	g$id_article	o5979	g$connect_statut	o6197	g$aff_jours	o6303	g$aff_jours	o6315	g$origine	o6339	g$id_article	o6360	g$table	o6377	g$table_ref	o6413	g$where	o6454	g$ta!
 ble	o6501	g$table_ref	o6528	g$where	o6560	g$query	o6580	g$result	o6687
	g$query	o6708	g$row	o6725	g$result	o6749	g$date_premier	o6763	g$row	o6779	g$query	o6803	g$result	o6960	g$query	o6979	g$row	o6997	g$result	o7021	g$date	o7035	g$row	o7043	g$visites	o7064	g$row	o7075	g$log	o7095	g$date	o7100	g$visites	o7109	g$i	o7125	g$date_debut	o7134	g$date	o7148	g$i	o7157	g$id_article	o7192	g$query	o7209	g$result	o7333	g$query	o7354	g$query	o7375	g$result	o7449	g$query	o7470	g$row	o7487	g$result	o7512	g$visites_today	o7524	g$row	o7541	g$visites_today	o7566	g$log	o7598	g$max	o7611	g$log	o7626	g$visites_today	o7632	g$date_today	o7651	g$nb_jours	o7675	g$date_today	o7694	g$date_debut	o7706	g$maxgraph	o7736	g$max	o7767	g$max	o7809	g$maxgraph	o7825	g$maxgraph	o7841	g$maxgraph	o7869	g$max	o7881	g$maxgraph	o7887	g$maxgraph	o7914	g$max	o7926	g$maxgraph	o7932	g$maxgraph	o7950	g$rapport	o7963	g$maxgraph	o7980	g$log	o8004	g$largeur	o8017	g$nb_jours	o8041	g$largeur	o8062	g$largeur	o8081	g$agreg	o8098	g$log	o8118	g$agreg	o8147	g$largeur	o8169	g$largeur	o8184	g$largeur_ab!
 s	o8253	g$aff_jours	o8274	g$largeur_abs	o8295	g$inc	o8318	g$largeur_abs	o8330	g$aff_jours_plus	o8352	g$largeur_abs	o8377	g$inc	o8392	g$aff_jours_moins	o8402	g$largeur_abs	o8428	g$inc	o8443	g$largeur_abs	o8463	g$aff_jours_plus	o8487	g$aff_jour_moins	o8513	g$largeur_abs	o8549	g$aff_jours_plus	o8572	g$largeur_abs	o8600	g$aff_jours_moins	o8623	g$largeur_abs	o8652	g$id_article	o8791	g$pour_article	o8804	g$date_premier	o8854	g$date_debut	o8870	g$date_today	o9087	g$date_debut	o9101	g$key	o10016	g$value	o10022	g$log	o10037	g$test_agreg	o10055	g$test_agreg	o10082	g$agreg	o10097	g$test_agreg	o10117	g$n	o10138	g$decal	o10156	g$decal	o10170	g$decal	o10186	g$tab_moyenne	o10201	g$decal	o10214	g$value	o10224	g$jour_prec	o10293	g$ecart	o10316	g$key	o10332	g$jour_prec	o10337	g$agreg	o10360	g$i	o10385	g$i	o10391	g$ecart	o10396	g$i	o10404	g$decal	o10421	g$decal	o10435	g$decal	o10453	g$tab_moyenne	o10470	g$decal	o10483	g$value	o10493	g$ce_jour	o10509	g$jour_prec	o10532	g$i	o10553	g$jour	o10568!
 	g$ce_jour	o10585	g$ce_jour	o10613	g$tab_moyenne	o10638	g$moyenne	o106
59	g$val_tab	o10692	g$tab_moyenne	o10709	g$moyenne	o10731	g$val_tab	o10743	g$moyenne	o10759	g$moyenne	o10770	g$tab_moyenne	o10787	g$hauteur_moyenne	o10811	g$moyenne	o10837	g$rapport	o10849	g$difference	o10920	g$hauteur_moyenne	o10935	g$moyenne	o10963	g$moyenne	o10980	g$tagtitle	o11028	g$difference	o11162	g$largeur	o11209	g$tagtitle	o11250	g$largeur	o11289	g$hauteur_moyenne	o11299	g$tagtitle	o11321	g$largeur	o11377	g$tagtitle	o11415	g$n	o11453	g$ce_jour	o11478	g$key	o11501	g$jour	o11512	g$ce_jour	o11529	g$ce_jour	o11557	g$total_loc	o11574	g$total_loc	o11587	g$value	o11600	g$tab_moyenne	o11618	g$moyenne	o11639	g$val_tab	o11670	g$tab_moyenne	o11687	g$moyenne	o11707	g$val_tab	o11719	g$moyenne	o11733	g$moyenne	o11744	g$tab_moyenne	o11761	g$hauteur_moyenne	o11784	g$moyenne	o11809	g$rapport	o11820	g$hauteur	o11839	g$value	o11856	g$rapport	o11865	g$moyenne	o11884	g$moyenne	o11901	g$tagtitle	o11997	g$value	o12076	g$hauteur	o12096	g$hauteur_moyenne	o12120	g$hauteur	o12139	g$difference!
 	o12157	g$hauteur_moyenne	o12172	g$hauteur	o12191	g$largeur	o12230	g$tagtitle	o12270	g$largeur	o12307	g$difference	o12317	g$tagtitle	o12334	g$largeur	o12371	g$tagtitle	o12420	g$key	o12451	g$largeur	o12522	g$hauteur	o12532	g$tagtitle	o12579	g$largeur	o12629	g$hauteur	o12638	g$tagtitle	o12685	g$hauteur_moyenne	o12713	g$hauteur	o12732	g$difference	o12750	g$hauteur	o12765	g$hauteur_moyenne	o12776	g$largeur	o12823	g$tagtitle	o12871	g$key	o12902	g$couleur	o12953	g$couleur_foncee	o12965	g$couleur	o13000	g$couleur_claire	o13011	g$largeur	o13053	g$difference	o13063	g$tagtitle	o13106	g$largeur	o13143	g$tagtitle	o13183	g$largeur	o13220	g$hauteur_moyenne	o13230	g$tagtitle	o13278	g$largeur	o13330	g$tagtitle	o13380	g$key	o13411	g$largeur	o13482	g$hauteur	o13492	g$tagtitle	o13539	g$largeur	o13589	g$hauteur	o13598	g$tagtitle	o13645	g$largeur	o13693	g$tagtitle	o13733	g$jour_prec	o13773	g$key	o13786	g$val_prec	o13796	g$value	o13808	g$hauteur	o13850	g$visites_today	o13867	g$rapport	o13884	g$t!
 otal_absolu	o13902	g$total_absolu	o13918	g$visites_today	o13934	g$haut
eur	o14004	g$largeur	o14043	g$id_article	o14208	g$val_popularite	o14221	g$moyenne	o14239	g$prevision	o14253	g$val_popularite	o14309	g$hauteurprevision	o14330	g$prevision	o14355	g$rapport	o14368	g$prevision	o14383	g$prevision	o14402	g$visites_today	o14416	g$largeur	o14590	g$hauteurprevision	o14600	g$tagtitle	o14647	g$largeur	o14684	g$hauteur	o14694	g$tagtitle	o14733	g$largeur	o14772	g$maxgraph	o15359	g$maxgraph	o15538	g$maxgraph	o15700	g$maxgraph	o15878	g$maxgraph	o16040	g$maxgraph	o16221	g$maxgraph	o16380	g$maxgraph	o16557	g$gauche_prec	o16891	g$jour	o16919	g$date_debut	o16927	g$jour	o16940	g$date_today	o16949	g$jour	o16962	g$jour	o16970	g$ce_jour	o16995	g$jour	o17016	g$ce_jour	o17037	g$afficher	o17061	g$jour	o17096	g$jour	o17124	g$afficher	o17137	g$jour	o17175	g$gauche	o17207	g$jour	o17218	g$date_debut	o17226	g$largeur	o17241	g$agreg	o17263	g$gauche	o17287	g$gauche_prec	o17297	g$jour	o17329	g$gauche	o17520	g$afficher	o17547	g$gauche_prec	o17573	g$gauche	o17588	g$moyenne	o17!
 655	g$total_absolu	o17673	g$date_premier	o17701	g$max	o18032	g$moyenne	o18081	g$visites_today	o18224	g$val_prec	o18246	g$val_prec	o18293	g$id_article	o18310	g$val_popularite	o18363	g$total_absolu	o18514	g$id_article	o18545	g$classement	o18567	g$id_article	o18579	g$classement	o18607	g$id_article	o18619	g$ch	o18648	g$liste	o18695	g$ch	o18724	g$liste	o18771	g$classement	o18797	g$id_article	o18809	g$ch	o18822	g$log	o19028	g$query	o19232	g$result	o19450	g$query	o19469	g$i	o19483	g$row	o19500	g$result	o19524	g$date	o19539	g$row	o19547	g$visites	o19569	g$row	o19580	g$i	o19606	g$entrees	o19615	g$visites	o19635	g$entrees	o19664	g$max	o19684	g$entrees	o19695	g$maxgraph	o19709	g$max	o19740	g$max	o19782	g$maxgraph	o19801	g$maxgraph	o19817	g$maxgraph	o19846	g$max	o19858	g$maxgraph	o19864	g$maxgraph	o19892	g$max	o19904	g$maxgraph	o19910	g$maxgraph	o19928	g$rapport	o19942	g$maxgraph	o19959	g$largeur	o19975	g$entrees	o20005	g$largeur	o20025	g$largeur	o20039	g$largeur	o20060	g$largeur	o2007!
 5	g$n	o20368	g$decal	o20378	g$tab_moyenne	o20392	g$key	o20429	g$value	
o20435	g$entrees	o20450	g$n	o20466	g$mois	o20479	g$key	o20506	g$decal	o20521	g$decal	o20535	g$decal	o20550	g$tab_moyenne	o20564	g$decal	o20577	g$value	o20587	g$total_loc	o20602	g$total_loc	o20615	g$value	o20628	g$tab_moyenne	o20645	g$moyenne	o20665	g$val_tab	o20695	g$tab_moyenne	o20712	g$moyenne	o20731	g$val_tab	o20743	g$moyenne	o20756	g$moyenne	o20767	g$tab_moyenne	o20784	g$hauteur_moyenne	o20806	g$moyenne	o20831	g$rapport	o20842	g$hauteur	o20860	g$value	o20877	g$rapport	o20886	g$tagtitle	o20952	g$value	o21030	g$hauteur	o21048	g$hauteur_moyenne	o21071	g$hauteur	o21090	g$difference	o21107	g$hauteur_moyenne	o21122	g$hauteur	o21141	g$largeur	o21179	g$largeur	o21246	g$difference	o21256	g$tagtitle	o21273	g$largeur	o21309	g$key	o21378	g$largeur	o21441	g$hauteur	o21450	g$tagtitle	o21496	g$largeur	o21554	g$hauteur	o21563	g$tagtitle	o21609	g$hauteur_moyenne	o21647	g$hauteur	o21666	g$difference	o21683	g$hauteur	o21698	g$hauteur_moyenne	o21709	g$largeur	o21755	g$tagtitle	o21803	g$key	!
 o21835	g$couleur	o21878	g$couleur_foncee	o21890	g$couleur	o21933	g$couleur_claire	o21944	g$largeur	o21992	g$difference	o22001	g$tagtitle	o22044	g$largeur	o22080	g$tagtitle	o22119	g$largeur	o22155	g$hauteur_moyenne	o22164	g$tagtitle	o22211	g$largeur	o22265	g$tagtitle	o22313	g$key	o22345	g$largeur	o22408	g$hauteur	o22418	g$tagtitle	o22465	g$largeur	o22523	g$hauteur	o22532	g$tagtitle	o22579	g$largeur	o22631	g$tagtitle	o22669	g$jour_prec	o22707	g$key	o22720	g$val_prec	o22729	g$value	o22741	g$maxgraph	o23274	g$maxgraph	o23450	g$maxgraph	o23609	g$maxgraph	o23784	g$maxgraph	o23943	g$maxgraph	o24121	g$maxgraph	o24277	g$maxgraph	o24451	g$limit	o24812	g$limit	o24828	g$limit	o24848	g$limit	o24862	g$vis	o24906	g$origine	o24928	g$where	o24941	g$vis	o24969	g$table_ref	o24993	g$query	o25026	g$query	o25261	g$limit	o25269
ecrire/inc_meta.php3	d_ECRIRE_INC_META	o100	flire_metas	o136	g$meta	o159	g$meta_maj	o166	fecrire_meta	o422	feffacer_meta	o570	fecrire_metas	o794	g$meta	o819	g$meta_maj	o826	g$GLOBALS	o1766
sommaire_texte.php3	g$fond	o114	g$delais	o140
ecrire/auteur_messagerie.php3	fafficher_auteur_rubriques	o144	g$id_parent	o190	g$id_rubrique	o210	g$toutes_rubriques	o232	g$i	o259	g$connect_id_auteur	o824	g$id_auteur	o846	g$perso_activer_messagerie	o865	g$query	o896	g$result	o1036	g$query	o1057	g$query	o1073	g$result	o1141	g$query	o1162	g$row	o1177	g$result	o1201	g$id_auteur	o1214	g$row	o1225	g$nom	o1245	g$row	o1250	g$bio	o1264	g$row	o1269	g$email	o1283	g$row	o1290	g$nom_site_auteur	o1306	g$row	o1323	g$url_site	o1342	g$row	o1352	g$login	o1371	g$row	o1378	g$pass	o1394	g$row	o1400	g$statut	o1415	g$row	o1423	g$pgp	o1440	g$row	o1445	g$messagerie	o1459	g$row	o1471	g$imessage	o1492	g$row	o1502	g$abonne	o1521	g$row	o1531	g$abonne_pass	o1548	g$row	o1563	g$nom_auteur	o1596	g$nom	o1665	g$connect_statut	o1678	g$connect_id_auteur	o1714	g$id_auteur	o1736	g$statut_auteur	o1752	g$statut	o1767	fmySel	o2145	g$connect_id_auteur	o2329	g$id_auteur	o2351	g$activer_messagerie	o2645	g$activer_imessage	o2676	g$activer_messagerie	o2712	g$messageri!
 e	o3873	g$activer_imessage	o4878	g$messagerie	o4913	g$imessage	o5589
ecrire/iframe_action.php3	g$connect_statut	o43	g$action	o267	g$id_article	o299	g$query	o321	g$result	o397	g$query	o418	g$row	o433	g$result	o457	g$statut_ancien	o472	g$row	o489	g$statut	o519	g$statut_ancien	o530	g$query	o551	g$result	o637	g$query	o658	g$statut	o720	g$id_article	o886	g$id_article	o992	g$statut_ancien	o1018	g$invalider_caches	o1049	g$statut	o1206	g$statut_ancien	o1228	g$id_article	o1324	g$action	o1356	g$id_breve	o1386	g$query	o1406	g$result	o1476	g$query	o1497	g$row	o1512	g$result	o1536	g$statut_ancien	o1551	g$row	o1568	g$statut	o1599	g$statut_ancien	o1610	g$query	o1631	g$result	o1729	g$query	o1750
ecrire/install.php3	d_ECRIRE_INSTALL	o53	flogin_hebergeur	o228	g$HTTP_X_HOST	o256	g$REQUEST_URI	o270	g$SERVER_NAME	o284	g$HTTP_HOST	o298	g$etape	o1060	g$login	o1399	g$nom	o1411	g$nom	o1429	g$login	o1438	g$login	o1458	g$query	o1469	g$result	o1539	g$query	o1563	g$id_auteur	o1580	g$row	o1602	g$result	o1626	g$id_auteur	o1636	g$row	o1649	g$mdpass	o1671	g$pass	o1685	g$htpass	o1695	g$pass	o1720	g$id_auteur	o1735	g$query	o1752	g$query	o1976	g$query	o2172	g$email	o2266	g$etape	o2998	g$flag_ldap	o4559	g$ldap_present	o4575	g$etape	o5060	g$link	o5316	g$choix_db	o5410	g$sel_db	o5439	g$table_new	o5449	g$sel_db	o5516	g$choix_db	o5526	g$sel_db	o5546	g$nouvelle	o5668	g$maj_ok	o5715	g$nouvelle	o5743	g$result_ok	o5844	g$result	o5888	g$result_ok	o5953	g$result	o5981	g$result_ok	o6043	g$maj_ok	o6057	g$conn	o6070	g$conn	o6094	g$conn	o6156	g$conn	o6212	g$conn	o6269	g$conn	o6322	g$conn	o6407	g$conn	o6512	g$myFile	o6532	g$myFile	o6611	g$conn	o6620	g$myFile	o6637	g$result_ok	o6983	g$spip_version	o705!
 1	g$etape	o7194	g$link	o7754	g$result	o7816	g$result	o7930	g$n	o7944	g$result	o7965	g$bases	o8075	g$i	o8095	g$i	o8103	g$n	o8108	g$i	o8112	g$table_nom	o8123	g$result	o8149	g$i	o8158	g$base	o8166	g$table_nom	o8210	g$base_fin	o8252	g$table_nom	o8287	g$table_nom	o8327	g$login_db	o8341	g$bases	o8358	g$bases	o8392	g$checked	o8404	g$bases	o8440	g$bases	o8486	g$login_db	o8639	g$login_db	o8753	g$login_db	o8830	g$checked	o8907	g$checked	o9010	g$etape	o9366	g$link	o9526	g$db_connect	o9588	g$db_connect	o9651	g$link	o9672	g$etape	o10425	g$adresse_db	o10639	g$login_db	o10667	g$pass_db	o10699	g$s	o10859	g$s	o11006	g$regs	o11010	g$adresse_db	o11023	g$regs	o11037	g$login_db	o11050	g$regs	o11062	g$s	o11149	g$regs	o11153	g$adresse_db	o11166	g$regs	o11180	g$port_db	o11197	g$regs	o11208	g$adresse_db	o11218	g$port_db	o11237	g$login_db	o11250	g$regs	o11262	g$etape	o12251	g$etape	o12328	g$menu_langues	o12339	g$menu_langues	o12395	g$menu_langues	o12844	g$etape	o13191	g$statut_ldap	o13369	g$etape	o1!
 3737	g$base_ldap	o13788	g$base_ldap	o13800	g$base_ldap_text	o13813	g$l
dap_link	o13832	g$ldap_link	o13903	g$r	o13988	g$ldap_link	o14007	g$base_ldap	o14019	g$fail	o14052	g$ldap_link	o14072	g$fail	o14098	g$base_ldap	o14341	g$conn	o14532	g$p	o14610	g$conn	o14622	g$conn	o14643	g$conn	o14658	g$p	o14668	g$conn	o14687	g$conn	o14721	g$conn	o14769	g$conn	o14862	g$conn	o14948	g$conn	o14998	g$conn	o15017	g$conn	o15075	g$conn	o15129	g$myFile	o15149	g$myFile	o15228	g$conn	o15237	g$myFile	o15254	g$etape	o16269	g$ldap_link	o16460	g$ldap_link	o16531	g$result	o16575	g$ldap_link	o16596	g$info	o16656	g$ldap_link	o16682	g$result	o16694	g$checked	o17122	g$info	o17155	g$info	o17166	g$n	o17253	g$i	o17268	g$i	o17276	g$info	o17281	g$i	o17297	g$names	o17308	g$info	o17317	g$i	o17323	g$names	o17362	g$j	o17382	g$j	o17390	g$names	o17395	g$j	o17412	g$n	o17425	g$names	o17495	g$j	o17502	g$checked	o17547	g$checked	o17588	g$names	o17676	g$j	o17683	g$checked	o17847	g$checked	o17880	g$etape	o18276	g$ldap_link	o18442	g$r	o18502	g$ldap_link	o18518	g$ldap_link	o18566	g$r	o18581	g$log!
 in_ldap	o18588	g$etape	o19385	g$adresse_ldap	o19592	g$port_ldap	o19622	g$s	o19763	g$s	o19878	g$regs	o19882	g$adresse_ldap	o19895	g$regs	o19911	g$port_ldap	o19924	g$regs	o19937
downloadfile.class.php	dDOWNLOADFILE_H	o365	cDOWNLOADFILE	o396	vdf_path	o419	vdf_contenttype	o441	vdf_contentdisposition	o470	vdf_filename	o506	kDOWNLOADFILE	o538	fmime_content_type	o718	mdf_exists	o1193	mdf_size	o1314	mdf_permitother	o1471	mdf_download	o1586
ecrire/delete_all.php3	g$action	o150	g$action	o202	g$action	o2077
ecrire/inc_version.php3	d_ECRIRE_INC_VERSION	o103	fdefine_once	o142	g$included_files	o764	finclude_local	o801	finclude_ecrire	o903	finclude_lang	o1161	finclude_plug	o1290	g$db_ok	o2058	fmagic_unquote	o2464	g$unquote_gpc	o2717	g$unquote_gpc	o2762	g$INSECURE	o3020	ffeed_globals	o3051	g$INSECURE	o3136	ffeed_post_files	o4093	g$INSECURE	o4127	g$table_prefix	o5004	g$cookie_prefix	o5134	g$cookie_path	o5159	g$dossier_squelettes	o5286	g$auto_compress	o5447	g$compresser_cache	o5608	g$type_urls	o5800	g$convert_command	o6052	g$pnmscale_command	o6269	g$mysql_debug	o6357	g$mysql_profile	o6425	g$mysql_rappel_connexion	o6680	g$test_i18n	o6770	g$activer_revision_nbsp	o6866	g$champs_extra	o6968	g$champs_extra_proposes	o6991	g$ignore_auth_http	o7269	g$ignore_remote_user	o7296	g$invalider_caches	o7546	g$quota_cache	o7897	g$code_activation_debug	o8111	g$help_server	o8184	g$tex_server	o8233	g$ortho_servers	o8467	g$traiter_math	o8570	g$extension_squelette	o8747	g$test_dirs	o10270	g$flag_ecrire	o11!
 192	g$dir_ecrire	o11263	g$GLOBALS	o11295	g$spip_version	o11517	g$spip_version_affichee	o11560	g$regs	o11674	g$spip_version_affichee	o11682	g$regs	o11707	g$auteur_session	o11737	g$connect_statut	o11759	g$hash_recherche	o11781	g$hash_recherche_strict	o11803	g$php_version	o11903	g$php_version_tab	o11932	g$php_version	o11964	g$php_version_maj	o11979	g$php_version_tab	o12005	g$php_version_med	o12027	g$php_version_tab	o12053	g$php_version_tab	o12096	g$match	o12117	g$php_version_min	o12126	g$match	o12152	g$flag_levenshtein	o12165	g$php_version_maj	o12186	g$flag_uniqid2	o12210	g$php_version_maj	o12227	g$php_version_min	o12251	g$flag_get_cfg_var	o12276	g$flag_strtr2	o12337	g$php_version_maj	o12353	g$flag_ini_get	o12377	g$flag_gz	o12491	g$flag_ob	o12542	g$flag_ini_get	o12554	g$flag_pcre	o12649	g$flag_crypt	o12695	g$flag_wordwrap	o12735	g$flag_apc	o12781	g$flag_sapi_name	o12820	g$flag_utf8_decode	o12872	g$flag_ldap	o12924	g$flag_flock	o12970	g$flag_ImageCreateTrueColor	o13010	g$flag_I!
 mageCopyResampled	o13080	g$flag_ImageGif	o13146	g$flag_ImageJpeg	o1319
2	g$flag_ImagePng	o13240	g$flag_imagick	o13286	g$flag_multibyte	o13395	g$flag_iconv	o13454	g$flag_strtotime	o13494	g$flag_gd	o13543	g$flag_ImageGif	o13554	g$flag_ImageJpeg	o13572	g$flag_ImagePng	o13591	g$flag_revisions	o13607	g$flag_pcre	o13626	fspip_setcookie	o13721	g$cookie_prefix	o14250	g$HTTP_COOKIE_VARS	o14286	g$name	o14319	g$value	o14325	g$HTTP_COOKIE_VARS	o14340	g$name	o14383	g$HTTP_COOKIE_VARS	o14402	g$name	o14420	g$name	o14439	g$HTTP_COOKIE_VARS	o14462	g$name	o14495	g$value	o14501	g$HTTP_COOKIE_VARS	o14516	g$cookie_prefix	o14553	g$name	o14573	g$spipname	o14586	g$cookie_prefix	o14616	g$name	o14645	g$HTTP_COOKIE_VARS	o14656	g$spipname	o14674	g$INSECURE	o14687	g$spipname	o14697	g$value	o14710	g$spipname	o14722	g$value	o14734	g$HTTP_SERVER_VARS	o14808	fspip_log	o14950	g$REQUEST_URI	o15819	g$REQUEST_URI	o15836	g$PHP_SELF	o15851	g$REQUEST_URI	o15875	g$QUERY_STRING	o15897	g$REQUEST_URI	o15914	g$QUERY_STRING	o15934	g$PATH_TRANSLATED	o15957	g$SCRIPT_FILENAME	o15982	g$PATH_TR!
 ANSLATED	o16000	g$SCRIPT_FILENAME	o16019	g$DOCUMENT_ROOT	o16047	g$SCRIPT_URL	o16065	g$PATH_TRANSLATED	o16078	g$DOCUMENT_ROOT	o16097	g$SCRIPT_URL	o16112	fspip_query	o16137	fappliquer_fonction	o16493	fappliquer_fonction_avant	o17072	fappliquer_fonction_apres	o17382	fcompleter_fonction	o17732	g$php_module	o18122	g$flag_sapi_name	o18138	g$SERVER_SOFTWARE	o18219	g$php_cgi	o18239	g$flag_sapi_name	o18251	fhttp_status	o18314	g$php_cgi	o18345	g$REDIRECT_STATUS	o18355	fhttp_gmoddate	o18698	fhttp_last_modified	o18789	g$flag_upload	o19319	g$flag_get_cfg_var	o19336	ftester_upload	o19410	ftest_obgz	o19598	g$flag_ob	o20266	cLink	o20409	vfile	o20422	vvars	o20434	varrays	o20446	kLink	o20596	vlink	o20644	mdelVar	o22879	maddVar	o23123	mgetUrl	o23379	mgetForm	o23937	g$clean_link	o24745	fquote_amp	o24814	flire_meta	o25088	g$meta	o25114	flire_meta_maj	o25153	g$meta_maj	o25183	g$meta	o25323	g$meta	o25493	femail_valide	o25650	f_T	o26140	f_L	o26408	g$langue_site	o26552	g$langue_site	o26598	g$spip_l!
 ang	o26645	g$langue_site	o26658	ftable_objet	o26722	fspip_timer	o26921
	vtime	o26954	fcron	o27418	fcalculer_hierarchie	o27768	fcreer_repertoire	o28295	fredirige_par_entete	o28833	fdebut_entete	o28985
ecrire/inc_mots.php3	d_ECRIRE_INC_MOTS	o100	g$GLOBALS	o207	g$GLOBALS	o244	flevenshtein255	o347	fmots_ressemblants	o466	fformulaire_mots	o1837	g$flag_mots_ressemblants	o1934	g$connect_statut	o1967	g$options	o1984	g$spip_lang_rtl	o2002	g$spip_lang_right	o2018
ecrire/import_all.php3	fverifier_version_sauvegarde	o257	g$spip_version	o306	g$flag_gz	o329	g$archive	o926	g$action	o939	g$archive	o1003	g$commentaire	o1016	g$archive	o1060	g$action	o1086	g$commentaire	o1095	g$archive	o1112	g$archive	o1139	g$archive	o1230	g$action	o1309
ecrire/inc_objet.php3	d_ECRIRE_INC_OBJET	o101	cArticleFactory	o1012	kArticleFactory	o1102	mnew_object	o1485	cArticle	o1628	kArticle	o1682	ffetch_article	o1764	cBreveFactory	o1983	kBreveFactory	o2071	mnew_object	o2374	cBreve	o2515	kBreve	o2567	ffetch_breve	o2645	cDocumentFactory	o2863	kDocumentFactory	o2954	mnew_object	o3291	cDocument	o3382	kDocument	o3437	ffetch_document	o3521
ecrire/lang/public_en.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/oo/index.php
ecrire/pclzip.lib.php	g$g_pclzip_version	o2874	cPclZip	o6141	vzipname	o6202	vzip_fd	o6274	verror_code	o6336	verror_string	o6362	kPclZip	o6835	mcreate	o9637	madd	o16338	mlistContent	o23932	mextract	o26427	mextractByIndex	o33187	mdelete	o39254	mdeleteByIndex	o42211	mproperties	o43215	mduplicate	o45666	mmerge	o48141	merrorCode	o50023	merrorName	o50518	merrorInfo	o52588	mprivCheckFormat	o54114	mprivParseOptions	o56186	mprivCreate	o72792	mprivAdd	o74036	mprivOpenFd	o81219	mprivCloseFd	o82757	mprivAddList	o84046	mprivAddFileList	o87058	mprivAddFile	o92385	mprivWriteFileHeader	o101719	mprivWriteCentralFileHeader	o104133	mprivWriteCentralHeader	o106633	mprivList	o107835	mprivConvertHeader2FileInfo	o111603	mprivExtractByRule	o113548	mprivExtractFile	o126579	mprivExtractFileInOutput	o138697	mprivExtractFileAsString	o144006	mprivReadFileHeader	o146582	mprivReadCentralFileHeader	o152536	mprivReadEndCentralDir	o159348	mprivDeleteByRule	o167847	mprivDirCheck	o184032	mprivMerge	o186366	mpr!
 ivDuplicate	o194716	mprivErrorLog	o197448	mprivErrorReset	o198058	fPclZipUtilPathReduction	o198729	fPclZipUtilPathInclusion	o200859	fPclZipUtilCopyBlock	o203713	fPclZipUtilRename	o206853	fPclZipUtilOptionText	o208265	fPclZipUtilTranslateWinPath	o210548
ecrire/plugins/plug_ancres.php	favant_propre_ancres	o68
ecrire/inc_admin.php3	d_ECRIRE_INC_ADMIN	o101	ffichier_admin	o139	g$connect_login	o172	fdebut_admin	o278	g$clean_link	o326	g$connect_statut	o347	ffin_admin	o1343	f_action_auteur	o1484	g$connect_id_auteur	o1562	g$connect_pass	o1582	fcalculer_action_auteur	o1919	fverifier_action_auteur	o2043
ecrire/lab_diff.php	d_ECRIRE_INC_DIFF	o97	flcs_opt	o412	flcs	o1065	ftest_lcs	o2175	ftest_lcs_opt	o2522	cDiff	o2883	vdiff	o2896	vfuzzy	o2908	kDiff	o2926	mcomparer	o3000	cDiffTexte	o4791	vr	o4809	kDiffTexte	o4823	m_diff	o4868	mfuzzy	o4974	msegmenter	o5012	majouter	o5078	msupprimer	o5210	mdeplacer	o5356	mcomparer	o5551	mresultat	o5638	cDiffPara	o5682	vr	o5699	kDiffPara	o5713	m_diff	o5757	mfuzzy	o5865	msegmenter	o5903	majouter	o6214	msupprimer	o6338	mdeplacer	o6476	mcomparer	o6633	mresultat	o6711	cDiffPhrase	o6755	vr	o6774	kDiffPhrase	o6788	mfuzzy	o6834	msegmenter	o6873	majouter	o8263	msupprimer	o8388	mcomparer	o8527	mresultat	o8582	fpreparer_diff	o8630	fafficher_diff	o8888
ecrire/lab_ortho.php	d_ECRIRE_INC_ORTHO	o98	fmaj_miroirs_ortho	o181	flire_miroirs_ortho	o1208	g$miroirs_ortho	o1239	g$index_miroirs_ortho	o1255	g$duree_cache_miroirs_ortho	o1277	fecrire_miroir_ortho	o2338	g$index_miroirs_ortho	o2382	fajouter_langue_miroir	o2589	g$miroirs_ortho	o2634	fenlever_langue_miroir	o2780	g$miroirs_ortho	o2825	freset_miroir	o2974	g$miroirs_ortho	o3003	fchercher_miroirs_ortho	o3141	g$miroirs_ortho	o3181	fchoisir_miroirs_ortho	o3616	fpost_ortho	o3905	fverifier_langue_miroir	o6552	fsuggerer_dico_ortho	o6998	fajouter_dico_ortho	o7556	g$connect_id_auteur	o7598	fsupprimer_dico_ortho	o7864	fgerer_dico_ortho	o8062	g$ajout_ortho	o8096	g$supp_ortho	o8110	fsuggerer_cache_ortho	o8326	g$duree_cache_ortho	o8372	fajouter_cache_ortho	o9133	g$duree_cache_ortho	o9187	fpreparer_ortho	o9958	fafficher_ortho	o10232	fcorriger_ortho	o10677	fpanneau_ortho	o14305	g$id_suggest	o14344	fsouligner_match_ortho	o17088	fsouligner_ortho	o17863	g$id_suggest	o17919	finit_ortho	o19452	g$d!
 uree_cache_ortho	o19475	g$duree_cache_miroirs_ortho	o19495
ecrire/lang/public_cpf.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/sites_edit.php3	g$proposer_sites	o66	fmySel	o123	fpremiere_rubrique	o267	fenfant	o519	g$id_parent	o546	g$id_rubrique	o566	vi	o589	g$statut	o618	g$connect_toutes_rubriques	o635	g$couleur_claire	o670	g$spip_lang_left	o687	g$browser_name	o712	g$proposer_sites	o2778	g$query	o2826	g$result	o2893	g$query	o2914	g$row	o2927	g$result	o2951	g$id_syndic	o2964	g$row	o2977	g$id_rubrique	o2997	g$row	o3012	g$nom_site	o3034	g$row	o3059	g$url_site	o3079	g$row	o3104	g$url_syndic	o3124	g$row	o3151	g$descriptif	o3173	g$row	o3200	g$syndication	o3222	g$row	o3237	g$syndication	o3268	g$new	o3291	g$id_rubrique	o3312	g$id_rubrique	o3330	g$id_rubrique	o3476	g$new	o3672	g$nom_site	o3952	g$new	o4010	g$proposer_sites	o4028	g$connect_statut	o4080	g$proposer_sites	o4114	g$link	o4179	g$link	o4213	g$id_rubrique	o4242	g$link	o4259	g$link	o4290	g$clean_link	o4316	g$link	o4342	g$link	o4388	g$cadre_ouvert	o4824	g$link	o4895	g$target	o4912	g$link	o4922	g$link	o4944	g$link	o4983	g$syndication	o5016	g$link	o!
 5036	g$nom_site	o5061	g$nom_site	o5086	g$url_site	o5098	g$url_site	o5123	g$url_syndic	o5135	g$url_syndic	o5162	g$url_site	o5314	g$url_site	o5328	g$id_rubrique	o5487	g$logo_parent	o5506	g$query	o5553	g$result	o5637	g$query	o5656	g$row	o5673	g$result	o5695	g$parent_parent	o5709	g$row	o5724	g$parent_parent	o5753	g$logo_parent	o5774	g$logo_parent	o5814	g$descriptif	o6304	g$activer_syndic	o6340	g$activer_syndic	o6469	g$syndication	o6526	g$syndication	o6841	g$url_syndic	o7277	g$url_syndic	o7295	g$cadre_ouvert	o7893
plan.php3	g$fond	o7	g$delais	o23
inc-balises.php3	d_INC_BALISES	o482	fchamps_traitements	o562	vtraitements	o597	fbalise_distante_interdite	o2613	fbalise_NOM_SITE_SPIP_dist	o2820	fbalise_EMAIL_WEBMASTER_dist	o2934	fbalise_CHARSET_dist	o3057	fbalise_LANG_LEFT_dist	o3164	fbalise_LANG_RIGHT_dist	o3353	fbalise_LANG_DIR_dist	o3543	fbalise_PUCE_dist	o3728	fbalise_DATE_dist	o4137	fbalise_DATE_REDAC_dist	o4319	fbalise_DATE_MODIF_dist	o4513	fbalise_DATE_NOUVEAUTES_dist	o4712	fbalise_URL_SITE_SPIP_dist	o4929	fbalise_URL_ARTICLE_dist	o5048	fbalise_URL_RUBRIQUE_dist	o5568	fbalise_URL_BREVE_dist	o5848	fbalise_URL_MOT_dist	o6117	fbalise_URL_FORUM_dist	o6306	fbalise_URL_DOCUMENT_dist	o6448	fbalise_URL_AUTEUR_dist	o6600	fbalise_NOTES_dist	o6869	fbalise_RECHERCHE_dist	o6995	fbalise_COMPTEUR_BOUCLE_dist	o7123	fbalise_TOTAL_BOUCLE_dist	o7373	fbalise_POINTS_dist	o7694	fbalise_POPULARITE_ABSOLUE_dist	o7779	fbalise_POPULARITE_SITE_dist	o7920	fbalise_POPULARITE_MAX_dist	o8052	fbalise_EXPOSER_dist	o8181	g$table_primary	o8216	fbalis!
 e_EMBED_DOCUMENT_dist	o9029	fbalise_DEBUT_SURLIGNE_dist	o9684	g$flag_pcre	o9725	fbalise_FIN_SURLIGNE_dist	o9844	g$flag_pcre	o9883	fbalise_INTRODUCTION_dist	o10004	fbalise_LANG_dist	o10332	fbalise_LESAUTEURS_dist	o10647	fbalise_PETITION_dist	o11530	fbalise_POPULARITE_dist	o11882	fcalculer_balise_logo	o12214	fbalise_EXTRA_dist	o15103	fbalise_PARAMETRES_FORUM_dist	o16002	fcode_invalideur_forums	o17289	fbalise_SELF_dist	o17714	fbalise_HTTP_VARS_dist	o17881
ecrire/lang/spip_oc_ni.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_zh.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_hu.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/recherche.php3	g$recherche	o99	g$recherche	o136	g$recherche	o211	g$recherche_aff	o248	g$onfocus	o292	g$recherche_aff	o452	g$onfocus	o526	g$recherche	o590	g$query_articles	o783	g$query_breves	o839	g$query_rubriques	o892	g$query_sites	o951	g$recherche	o1026	g$query_articles	o1043	g$query_breves	o1098	g$query_rubriques	o1149	g$query_sites	o1206	g$recherche	o1314	g$recherche	o1348	g$rech2	o1362	g$recherche	o1393	g$rech2	o1411	g$where	o1421	g$rech2	o1477	g$where	o1501	g$query_articles	o1521	g$query_breves	o1577	g$query_rubriques	o1635	g$query_sites	o1698	g$query_sites	o1755	g$query_sites	o1815	g$activer_moteur	o1833	g$activer_moteur	o1896	g$hash_recherche	o1977	g$recherche	o2011	g$query_articles_int	o2026	g$hash_recherche	o2080	g$query_breves_int	o2100	g$hash_recherche	o2150	g$query_rubriques_int	o2170	g$hash_recherche	o2226	g$query_sites_int	o2246	g$hash_recherche	o2296	g$query_auteurs_int	o2316	g$hash_recherche	o2368	g$query_articles	o2396	g$nba	o2415	g$query_articles	o2!
 470	g$activer_moteur	o2493	g$nba	o2518	g$doublons	o2529	g$nba	o2546	g$query_articles_int	o2561	g$query_articles_int	o2655	g$nba1	o2683	g$query_articles_int	o2750	g$query_breves	o2782	g$nbb	o2799	g$query_breves	o2850	g$activer_moteur	o2877	g$nbb	o2902	g$doublons	o2913	g$nbb	o2930	g$query_breves_int	o2945	g$query_breves_int	o3035	g$nbb1	o3061	g$query_breves_int	o3124	g$query_rubriques	o3160	g$nbr	o3180	g$query_rubriques	o3238	g$activer_moteur	o3262	g$nbr	o3287	g$doublons	o3298	g$nbr	o3315	g$query_rubriques_int	o3330	g$query_rubriques_int	o3426	g$nbr1	o3455	g$query_rubriques_int	o3525	g$activer_moteur	o3558	g$nbt	o3577	g$query_auteurs_int	o3630	g$query_sites	o3658	g$nbs	o3674	g$query_sites	o3723	g$activer_moteur	o3743	g$nbs	o3768	g$doublons	o3779	g$nbs	o3796	g$query_sites_int	o3811	g$query_sites_int	o3901	g$nbs1	o3926	g$query_sites_int	o3987	g$nba	o4017	g$nba1	o4027	g$nbb	o4038	g$nbb1	o4048	g$nbr	o4059	g$nbr1	o4069	g$nbt	o4080	g$nbs	o4090	g$nbs1	o4100
inc-urls-html.php3	d_INC_URLS2	o76	fgenerer_url_article	o106	fgenerer_url_rubrique	o188	fgenerer_url_breve	o274	fgenerer_url_mot	o348	fgenerer_url_auteur	o414	fgenerer_url_document	o492	frecuperer_parametres_url	o842	g$contexte	o890	fracine_forum	o1021	fgenerer_url_forum	o1611
ecrire/lang/spip_gl.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_nl.php3	g$GLOBALS	o80	g$GLOBALS	o89
spip_cookie.php3	fauth_http	o112	g$change_session	o783	g$spip_session	o833	g$auteur_session	o1046	g$auteur_session	o1094	g$cookie	o1135	g$auteur_session	o1166	g$spip_session	o1205	g$cookie	o1255	g$url	o1580	g$url	o1587	g$url	o1604	g$essai_auth_http	o1655	g$ignore_auth_http	o1677	g$url	o1710	g$url	o1717	g$essai_auth_http	o1745	g$logout_public	o1826	g$logout	o1845	g$logout_public	o1855	g$url	o1877	g$url	o1885	g$logout	o1935	g$auteur_session	o1973	g$logout	o2001	g$auteur_session	o2115	g$spip_session	o2152	g$auteur_session	o2185	g$spip_session	o2256	g$PHP_AUTH_USER	o2302	g$ignore_auth_http	o2322	g$url	o2357	g$url	o2364	g$auteur_session	o2416	g$url	o2459	g$url	o2466	g$test_echec_cookie	o2651	g$url	o2811	g$url	o2818	g$cookie_session	o2879	g$redirect	o2897	g$url	o2910	g$url	o2917	g$essai_login	o2949	g$session_login_hidden	o3018	g$session_login	o3045	g$session_login	o3063	g$session_login_hidden	o3080	g$login	o3105	g$session_login	o3114	g$pass	o3131	g$session_password	o3139	g$auths	o!
 3212	g$ldap_present	o3308	g$auths	o3323	g$ok	o3343	g$auths	o3363	g$nom_auth	o3387	g$auths	o3405	g$nom_auth	o3445	g$classe_auth	o3467	g$nom_auth	o3490	g$auth	o3503	g$classe_auth	o3515	g$auth	o3535	g$ok	o3591	g$auth	o3597	g$login	o3627	g$session_password_md5	o3635	g$next_session_password_md5	o3658	g$ok	o3745	g$session_password	o3752	g$ok	o3771	g$auth	o3777	g$login	o3793	g$session_password	o3801	g$ok	o3828	g$auth	o3836	g$ok	o3873	g$auth	o3882	g$auth	o3907	g$auth	o3924	g$cookie_admin	o3992	g$auth	o4012	g$query	o4029	g$auth	o4092	g$result	o4113	g$query	o4134	g$row_auteur	o4149	g$result	o4180	g$cookie_session	o4193	g$row_auteur	o4232	g$redirect	o4278	g$redirect	o4300	g$redirect	o4321	g$redirect	o4413	g$redirect	o4430	g$redirect	o4467	g$redirect	o4488	g$session_password	o4545	g$session_password_md5	o4566	g$redirect	o4592	g$redirect	o4627	g$url	o4660	g$cookie_admin	o4698	g$spip_admin	o4754	g$redirect	o4789	g$redirect	o4841	g$redirect	o4854	g$redirect	o4875	g$cookie_admin	o4933	g$sp!
 ip_admin	o4951	g$cookie_admin	o4966	g$cookie_admin	o5013	g$cookie_sess
ion	o5084	g$session_remember	o5108	g$cookie_session	o5169	g$cookie_session	o5251	g$prefs	o5271	g$row_auteur	o5281	g$row_auteur	o5317	g$prefs	o5351	g$session_remember	o5368	g$prefs	o5482	g$row_auteur	o5514	g$var_lang	o5587	g$var_lang	o5655	g$var_lang	o5699	g$redirect	o5739	g$redirect	o5786	g$redirect	o5800	g$redirect	o5821	g$var_lang_ecrire	o5925	g$var_lang_ecrire	o6022	g$var_lang_ecrire	o6080	g$var_lang_ecrire	o6155	g$valeur	o6310	g$id_auteur	o6319	g$var_lang_ecrire	o6396	g$id_auteur	o6437	g$auteur_session	o6454	g$var_lang_ecrire	o6480	g$auteur_session	o6518	g$spip_session	o6535	g$redirect	o6605	g$redirect	o6652	g$redirect	o6666	g$redirect	o6687	g$SERVER_SOFTWARE	o6881	g$redirect	o6923	g$redirect	o6974	g$redirect	o7060	g$redirect	o7119
ecrire/configuration.php3	fmySel	o76	g$connect_statut	o435	g$connect_toutes_rubriques	o470	g$changer_config	o599	g$forums_publics	o665	g$forums_publics	o718	g$nom_site	o1055	g$adresse_site	o1105	g$email_webmaster	o1163	g$options	o1597	g$options	o2059	g$articles_surtitre	o2298	g$articles_soustitre	o2352	g$articles_descriptif	o2408	g$articles_chapeau	o2466	g$articles_ps	o2518	g$articles_redac	o2560	g$articles_urlref	o2608	g$articles_surtitre	o3078	g$articles_soustitre	o3399	g$articles_descriptif	o3722	g$articles_chapeau	o4042	g$articles_ps	o4360	g$articles_redac	o4688	g$articles_urlref	o4999	g$post_dates	o5467	g$post_dates	o5772	g$activer_breves	o6294	g$activer_breves	o6601	g$options	o7020	g$articles_mots	o7128	g$config_precise_groupes	o7174	g$mots_cles_forums	o7238	g$forums_publics	o7290	g$articles_mots	o7672	g$articles_mots	o7859	g$articles_mots	o8147	g$style	o8172	g$style	o8206	g$config_precise_groupes	o8663	g$forums_publics	o8873	g$mots_cles_forums	o9316	g$activer_sites	o1!
 0000	g$activer_syndic	o10045	g$proposer_sites	o10092	g$visiter_sites	o10139	g$moderation_sites	o10184	g$activer_sites	o10487	g$activer_sites	o10679	g$activer_sites	o10806	g$style	o10831	g$style	o10864	g$proposer_sites	o11397	g$proposer_sites	o11486	g$proposer_sites	o11570	g$options	o11735	g$activer_syndic	o12269	g$activer_syndic	o12463	g$activer_syndic	o12567	g$style	o12593	g$style	o12628	g$moderation_sites	o12896	g$activer_moteur	o13089	g$activer_moteur	o13143	g$visiter_sites	o13405	g$documents_rubrique	o14057	g$documents_article	o14112	g$documents_article	o14464	g$documents_rubrique	o14659
inc-messforum.php3	fprevenir_auteurs	o211	g$retour_forum	o1582	g$retour	o1611	g$forum_id_article	o1621	g$id_article	o1648	g$forum_id_rubrique	o1662	g$id_rubrique	o1690	g$forum_id_forum	o1705	g$id_forum	o1730	g$forum_id_breve	o1742	g$id_breve	o1767	g$forum_id_syndic	o1779	g$id_syndic	o1805	g$slash_texte	o1818	g$texte	o1844	g$slash_titre	o1853	g$titre	o1879	g$slash_nom_site_forum	o1888	g$nom_site_forum	o1923	g$slash_url_site	o1941	g$url_site	o1970	g$id_message	o1982	g$id_message	o2003	g$id_auteur	o2023	g$id_auteur	o2036	g$auteur_session	o2056	g$forum_id_article	o2092	g$r	o2114	g$r	o2211	g$r	o2233	g$r	o2243	g$forums_publics	o2249	g$r	o2267	g$forums_publics	o2297	g$forums_publics	o2354	g$forums_publics	o2420	g$auteur_session	o2453	g$statut	o2474	g$auteur_session	o2484	g$statut	o2518	g$statut	o2529	g$retour_forum	o2662	g$retour_forum	o2811	g$auteur	o2912	g$auteur_session	o2922	g$email_auteur	o2947	g$auteur_session	o2963	g$slash_auteur	o2994	g$auteur	o3021	g$slash_email_auteur	o30!
 31	g$email_auteur	o3064	g$slash_texte	o3093	g$slash_titre	o3116	g$slash_nom_site_forum	o3139	g$slash_url_site	o3171	g$slash_auteur	o3197	g$slash_email_auteur	o3221	g$retour_forum	o3364	g$ajouter_mot	o3474	g$ajouter_mot	o3502	g$key	o3516	g$ajouter_mot	o3525	g$ajouter_mot	o3544	g$les_mots	o3561	g$ajouter_mot	o3583	g$key	o3596	g$les_mots	o3609	g$les_mots	o3634	g$index	o3652	g$index	o3664	g$les_mots	o3679	g$index	o3691	g$le_mot	o3704	g$les_mots	o3714	g$index	o3724	g$le_mot	o3739	g$validation_finale	o3858	g$confirmer	o3887	g$afficher_texte	o3908	g$ajouter_mot	o3935	g$statut	o3951	g$validation_finale	o3964	g$forums_publics	o4000	g$forums_publics	o4039	g$forum_id_forum	o4094	g$id_thread	o4115	g$forum_id_forum	o4128	g$id_thread	o4150	g$id_message	o4163	g$validation_finale	o4744	g$hash	o4948	g$afficher_texte	o5053	g$id_article	o5084	g$forum_id_article	o5098	g$auteur	o5140	g$email_auteur	o5149	g$id_article	o5164	g$texte	o5177	g$titre	o5185	g$cookie_user	o5257	g$auteur	o5287	g$email_a!
 uteur	o5307	g$cookie_user	o5369	g$statut	o5488	g$forum_id_article	o557
4	g$forum_id_breve	o5598	g$forum_id_rubrique	o5620	g$forum_id_syndic	o5645	g$redirect	o5678	g$retour_forum	o5690
ecrire/inc_math.php3	d_ECRIRE_INC_MATH	o100	fimage_math	o202	g$traiter_math	o229	ftraiter_math	o1525
ecrire/inc_suivi_revisions.php	d_ECRIRE_INC_SUIVI_REVISIONS	o110	fafficher_para_modifies	o275	fafficher_suivi_versions	o632	g$connect_id_auteur	o746	g$connect_statut	o766	g$dir_lang	o783
ecrire/http.class.php	chttp_header	o5253	p5039	l205	v_headers	o5275	v_debug	o5293	khttp_header	o5315	mget_header	o5440	mset_header	o5694	mreset	o5916	mserialize_headers	o6108	m_format_header_name	o6320	madd_debug_info	o6566	mget_debug_info	o6639	chttp_response_header	o6950	p6727	l214	vcookies_headers	o7001	khttp_response_header	o7034	mdeserialize_headers	o7192	mreset	o7999	chttp_request_message	o8392	p8169	l214	vbody	o8443	khttp_request_message	o8465	mreset	o8599	chttp_response_message	o8893	p8669	l215	vbody	o8954	vcookies	o8968	khttp_response_message	o8993	mget_status	o9195	mget_protocol_version	o9357	mget_content_type	o9546	mget_body	o9629	mreset	o9687	mparse_cookies	o9773	chttp_cookie	o10152	p9938	l205	vcookies	o10174	khttp_cookie	o10197	m_now	o10299	m_timestamp	o10415	mget	o10617	mset	o11293	mparse	o11574	chttp	o13063	p12856	l198	v_socket	o13078	vhost	o13095	vport	o13109	vhttp_version	o13123	vuser_agent	o13145	verrstr	o13165	vconnected	o13181	vuri	o13200	v_proxy_host	o13!
 213	v_proxy_port	o13234	v_proxy_login	o13255	v_proxy_pwd	o13277	v_use_proxy	o13297	v_auth_login	o13317	v_auth_pwd	o13338	v_response	o13358	v_request	o13378	v_keep_alive	o13396	khttp	o13425	muse_proxy	o14305	mset_request_header	o14665	mget_response_body	o14772	mget_response	o14850	mhead	o14917	mget	o17176	mmultipart_post	o20006	mpost	o23420	mpost_xml	o26706	mdisconnect	o29947	m_connect	o30331	p30121	l192	m_merge_multipart_form_data	o30823	m_merge_form_data	o31950	m_current_directory	o32399	m_get_response	o32642	m_parse_location	o34510	m_redirect	o35340
ecrire/inc_auth_spip.php3	d_ECRIRE_INC_AUTH_SPIP	o105	cAuth_spip	o143	vnom	o161	minit	o235	mverifier_challenge_md5	o323	mverifier	o990	mlire	o1455	mactiver	o1493
distrib.php3	g$fond	o6	g$delais	o25	g$flag_preserver	o106
ecrire/admin_effacer.php3	g$connect_statut	o326	g$connect_toutes_rubriques	o361
ecrire/inc_filtres.php3	d_ECRIRE_INC_FILTRES	o103	fcorriger_entites_html	o343	fcorriger_toutes_entites_html	o547	fentites_html	o659	ffiltrer_entites	o801	fentites_unicode	o1063	ftexte_backend	o1196	fsupprimer_numero	o1939	fsupprimer_tags	o2133	fechapper_tags	o2463	ftextebrut	o2629	fliens_ouvrants	o3244	fhttp_href	o3525	fcorriger_caracteres	o3924	vtrans	o3963	fPtoBR	o4870	fmajuscules	o5132	ftaille_en_octets	o5923	ftexte_script	o6426	fattribut_html	o6631	fvider_url	o6860	g$var_preview	o6887	furl_var_recherche	o7229	fextraire_date	o7530	fantispam	o7722	fsinon	o7959	fchoixsivide	o8130	fchoixsiegal	o8282	fnormaliser_date	o8384	fvider_date	o8956	frecup_heure	o9117	fheures	o9369	fminutes	o9525	fsecondes	o9683	fheures_minutes	o9841	frecup_date	o9975	fdate_relative	o10635	faffdate_base	o11653	g$spip_lang	o11693	fnom_jour	o14298	fjour	o14375	fjournum	o14444	fmois	o14519	fnom_mois	o14588	fannee	o14665	fsaison	o14736	faffdate	o14809	faffdate_court	o14883	faffdate_jourcourt	o14962	faffda!
 te_mois_annee	o15049	faffdate_heure	o15138	faligner	o15315	fjustifier	o15582	faligner_droite	o15653	faligner_gauche	o15727	fcentrer	o15800	fstyle_align	o15868	g$spip_lang_left	o15896	ffiltrer_ical	o15986	fdate_ical	o16280	fdate_iso	o16473	freduire_image	o16738	fextra	o17012	fpost_autobr	o17160	fmulti_trad	o17978	fextraire_trad	o18735	fextraire_multi	o19179	g$flag_pcre	o19215	fajoute_popup_multi	o19623	vnum_multi	o19687	g$multi_popup	o19708	fextraire_attribut	o20342	fboutonne	o20786	fhttp_script	o20919	finscriptionok	o21188
ecrire/sites.php3	g$proposer_sites	o176	fcalculer_droits	o233	g$connect_statut	o261	g$statut	o278	g$id_rubrique	o287	g$id_rubrique_depart	o301	g$proposer_sites	o322	g$new	o339	g$flag_editable	o353	g$flag_administrable	o369	fmy_sel	o694	fafficher_mois	o847	fafficher_annee	o1394	fafficher_jour	o1688	g$new	o1889	g$flag_editable	o1932	g$id_rubrique	o1952	g$id_rubrique	o1974	g$mydate	o1993	g$query	o2041	g$result	o2124	g$query	o2145	g$moderation	o2158	g$id_syndic	o2233	g$query	o2500	g$result	o2585	g$query	o2606	g$row	o2620	g$result	o2644	g$statut	o2657	g$row	o2667	g$id_rubrique_depart	o2684	g$row	o2706	g$id_rubrique	o2733	g$id_rubrique	o2747	g$id_rubrique_depart	o2762	g$new	o2789	g$statut	o2804	g$analyser_site	o2888	g$flag_editable	o2916	g$v	o2936	g$url	o2955	g$v	o2968	g$nom_site	o2976	g$v	o2999	g$url_site	o3018	g$v	o3041	g$nom_site	o3065	g$nom_site	o3076	g$url_site	o3088	g$url_syndic	o3101	g$v	o3126	g$descriptif	o3147	g$v	o3172	g$syndication	o3193	g$v	o3208	g$query	o3238	g$id_syn!
 dic	o3451	g$result	o3466	g$query	o3487	g$syndication	o3502	g$id_syndic	o3539	g$link	o3554	g$link	o3588	g$link	o3618	g$redirect	o3647	g$link	o3659	g$redirect_ok	o3678	g$nouveau_statut	o3754	g$flag_administrable	o3774	g$statut	o3798	g$nouveau_statut	o3808	g$query	o3826	g$id_syndic	o3901	g$result	o3915	g$query	o3936	g$statut	o4000	g$query	o4025	g$result	o4108	g$query	o4129	g$statut	o4169	g$id_syndic	o4294	g$nom_site	o4321	g$modifier_site	o4335	g$flag_editable	o4363	g$nom_site	o4382	g$nom_site	o4405	g$url_site	o4418	g$url_site	o4441	g$descriptif	o4454	g$descriptif	o4479	g$url_syndic	o4505	g$syndication	o4523	g$url_syndic	o4546	g$url_syndic	o4571	g$query	o4587	g$id_syndic	o4814	g$result	o4828	g$query	o4849	g$syndication_old	o4864	g$syndication	o4884	g$url_syndic	o4900	g$old_syndic	o4915	g$recalcul	o4932	g$syndication_old	o4959	g$syndication	o4979	g$syndication	o4996	g$statut	o5159	g$invalider_caches	o5188	g$id_syndic	o5409	g$link	o5430	g$link	o5463	g$link	o5492	g$redirect	o5520	!
 g$link	o5532	g$redirect_ok	o5550	g$jour	o5580	g$flag_administrable	o55
90	g$annee	o5618	g$mois	o5636	g$mois	o5655	g$jour	o5670	g$query	o5685	g$id_syndic	o5769	g$result	o5783	g$query	o5804	g$redirect	o5845	g$redirect_ok	o5859	g$redirect	o5905	g$recalcul	o5943	g$result	o5967	g$result	o6094	g$result	o6120	g$erreur_syndic	o6134	g$id_syndic	o6166	g$query	o6230	g$result	o6297	g$query	o6318	g$row	o6332	g$result	o6356	g$id_syndic	o6369	g$row	o6382	g$id_rubrique	o6402	g$row	o6417	g$nom_site	o6439	g$row	o6464	g$url_site	o6484	g$row	o6509	g$url_syndic	o6529	g$row	o6556	g$descriptif	o6578	g$row	o6605	g$syndication	o6627	g$row	o6642	g$statut	o6664	g$row	o6674	g$date_heure	o6691	g$row	o6705	g$date_syndic	o6720	g$row	o6735	g$mod	o6757	g$row	o6764	g$nom_site	o6792	g$titre_page	o6804	g$titre_page	o6853	g$id_rubrique	o6997	g$rubon	o7446	g$ruboff	o7475	g$id_syndic	o7511	g$flag_administrable	o7528	g$rubon	o7570	g$ruboff	o7578	g$syndication	o7723	g$logo_statut	o7749	g$statut	o7800	g$logo_statut	o7824	g$statut	o7868	g$logo_statut	o7890	g$statut	o7936	g$logo_statut	o!
 7960	g$nom_site	o8132	g$logo_statut	o8143	g$url_affichee	o8159	g$url_site	o8175	g$url_affichee	o8198	g$url_affichee	o8219	g$url_affichee	o8242	g$descriptif	o8336	g$descriptif	o8580	g$flag_editable	o8665	g$link	o8684	g$link	o8722	g$link	o8751	g$clean_link	o8775	g$link	o8932	g$flag_editable	o9025	g$options	o9045	g$statut	o9071	g$statut	o9100	g$date_heure	o9185	g$regs	o9198	g$mois	o9218	g$regs	o9226	g$jour	o9246	g$regs	o9254	g$annee	o9274	g$regs	o9283	g$jour	o9909	g$mois	o10006	g$annee	o10105	g$date_heure	o10451	g$flag_editable	o10498	g$options	o10517	g$id_syndic	o10570	g$nouv_mot	o10582	g$supp_mot	o10593	g$cherche_mot	o10604	g$flag_editable	o10618	g$flag_administrable	o10642	g$link	o10666	g$GLOBALS	o10674	g$link	o10699	g$link	o10727	g$statut	o10982	g$statut	o11032	g$statut	o11084	g$syndication	o11290	g$syndication	o11315	g$syndication	o11340	g$erreur_syndic	o11476	g$syndication	o11556	g$url_syndic	o11666	g$date_syndic	o12118	g$date_syndic	o12213	g$flag_administrable	o12398	g$!
 options	o12421	g$moderation	o12451	g$moderation	o12475	g$id_syndic	o12
585	g$moderation	o12609	g$mod	o12623	g$moderation	o12636	g$moderation	o12660	g$moderation	o12913	g$forum_retour	o13300	g$link	o13352	g$link	o13390	g$link	o13424	g$forum_retour	o13456	g$link	o13472	g$link	o13500	g$nom_site	o13531	g$link	o13609	g$query_forum	o13708	g$result_forum	o13851	g$query_forum	o13878	g$result_forum	o13908	g$forum_retour	o13923
ical.php3	g$fond	o7	g$delais	o23	g$flag_preserver	o81
ecrire/lang/public_gl.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/calendrier_jour.php3	g$today	o69	g$jour_today	o93	g$today	o107	g$mois_today	o123	g$today	o137	g$annee_today	o152	g$today	o167	g$mois	o223	g$jour	o233	g$jour_today	o239	g$mois	o254	g$mois_today	o260	g$annee	o275	g$annee_today	o282	g$date	o299	g$mois	o334	g$jour	o341	g$annee	o348	g$jour	o358	g$date	o374	g$mois	o382	g$date	o395	g$annee	o403	g$date	o418	g$afficher_bandeau_calendrier	o428	g$jour_today	o640	g$mois_today	o652	g$annee_today	o664	g$mois	o710	g$jour	o717	g$annee	o724
ecrire/articles_ortho.php	g$query	o190	g$result	o261	g$query	o282	g$row	o296	g$result	o320	g$id_article	o333	g$row	o347	g$surtitre	o368	g$row	o380	g$titre	o399	g$row	o408	g$soustitre	o424	g$row	o437	g$id_rubrique	o457	g$row	o472	g$descriptif	o494	g$row	o508	g$nom_site	o529	g$row	o541	g$url_site	o560	g$row	o572	g$chapo	o591	g$row	o600	g$texte	o616	g$row	o625	g$ps	o641	g$row	o647	g$date	o660	g$row	o668	g$statut_article	o683	g$row	o701	g$maj	o718	g$row	o725	g$date_redac	o739	g$row	o753	g$visites	o774	g$row	o785	g$referers	o803	g$row	o815	g$extra	o834	g$row	o843	g$id_trad	o859	g$row	o870	g$lang_article	o888	g$row	o904	g$lang_article	o925	g$lang_article	o940	g$lang_article	o995	g$virtuel	o1049	g$chapo	o1071	g$virtuel	o1096	g$chapo	o1114	g$chapo	o1127	g$champs	o1143	g$echap	o1232	g$ortho	o1250	g$code_ie	o1331	g$titre	o1960	g$code_ie	o1978	g$lang_article	o2060	g$champs	o2211	g$champ	o2222	g$ortho	o2233	g$champ	o2244	g$ortho	o2258	g$ortho	o2282	g$lang_article	o2290	g$result_ortho	o2!
 306	g$ortho	o2337	g$lang_article	o2345	g$result_ortho	o2374	g$mots	o2393	g$result_ortho	o2401	g$erreur	o2432	g$result_ortho	o2442	g$result_ortho	o2656	g$erreur	o2682	g$result_ortho	o2692	g$lang_article	o2775	g$champs	o3126	g$champ	o3137	g$champ	o3156	g$champ	o3282	g$echap	o3290	g$champ	o3314	g$champ	o3335	g$champ	o3352	g$echap	o3382	g$champ	o3398	g$champ	o3413	g$champ	o3483	g$champ	o3508	g$lang_article	o3516	g$result_ortho	o3546	g$champ	o3565	g$champ	o3591	g$lang_article	o3599	g$result_ortho	o3614	g$champ	o3706	g$champ	o3731	g$echap	o3745	g$champ	o3756	g$champ	o3781	g$echap	o3789	g$les_notes	o3867	g$les_notes	o3882	g$les_notes	o3910	g$lang_article	o3922	g$result_ortho	o3952	g$les_notes	o3970	g$les_notes	o3999	g$lang_article	o4011	g$result_ortho	o4026	g$les_notes	o4043	g$les_notes	o4071	g$surtitre	o4114	g$surtitre	o4200	g$titre	o4254	g$soustitre	o4268	g$soustitre	o4355	g$descriptif	o4404	g$url_site	o4419	g$nom_site	o4432	g$texte_case	o4626	g$descriptif	o4641	g$texte_case	o47!
 11	g$nom_site	o4727	g$url_site	o4737	g$nom_site	o4780	g$url_site	o4795
	g$descriptif	o4821	g$virtuel	o4933	g$chapo	o5105	g$texte	o5169	g$ps	o5199	g$ps	o5357	g$les_notes	o5423	g$les_notes	o5552	g$champs_extra	o5624	g$extra	o5642	g$extra	o5699
inc-formulaire_recherche.php3	g$balise_FORMULAIRE_RECHERCHE_collecte	o14	g$balise_FORMULAIRE_RECHERCHE_collecte	o53	fbalise_FORMULAIRE_RECHERCHE_stat	o112	fbalise_FORMULAIRE_RECHERCHE_dyn	o252
inc-formulaire_admin.php3	g$balise_FORMULAIRE_ADMIN_collecte	o14	g$balise_FORMULAIRE_ADMIN_collecte	o50	fbalise_FORMULAIRE_ADMIN_stat	o229	fbalise_FORMULAIRE_ADMIN_dyn	o673	g$var_preview	o781	g$use_cache	o795	vdejafait	o816
ecrire/articles_versions.php3	g$champs	o119	g$query	o233	g$result	o304	g$query	o325	g$row	o339	g$result	o363	g$id_article	o376	g$row	o390	g$id_rubrique	o411	g$row	o426	g$date	o448	g$row	o456	g$statut_article	o471	g$row	o489	g$maj	o506	g$row	o513	g$date_redac	o527	g$row	o541	g$visites	o562	g$row	o573	g$referers	o591	g$row	o603	g$extra	o622	g$row	o631	g$id_trad	o647	g$row	o658	g$id_version	o684	g$id_version	o705	g$id_version	o723	g$row	o737	g$textes	o759	g$id_article	o787	g$id_version	o800	g$id_diff	o815	g$id_diff	o833	g$id_diff	o849	g$diff_auto	o862	g$query	o882	g$result	o1033	g$query	o1054	g$row	o1067	g$result	o1092	g$id_diff	o1104	g$row	o1115	g$id_version	o1172	g$id_diff	o1187	g$id_diff	o1232	g$id_version	o1243	g$t	o1260	g$id_version	o1265	g$id_version	o1280	g$id_diff	o1294	g$id_diff	o1306	g$t	o1317	g$old	o1323	g$textes	o1330	g$new	o1341	g$textes	o1348	g$id_article	o1376	g$id_version	o1389	g$old	o1416	g$id_article	o1441	g$id_diff	o1454	g$new	o1467	g$textes	o1474	g$textes	o1!
 488	g$champs	o1519	g$champ	o1530	g$new	o1547	g$champ	o1552	g$old	o1564	g$champ	o1569	g$diff	o1591	g$textes	o1626	g$champ	o1634	g$diff	o1658	g$new	o1688	g$champ	o1693	g$old	o1717	g$champ	o1722	g$textes	o1753	g$textes	o1772	g$var	o1783	g$t	o1791	g$var	o1796	g$t	o1803	g$id_rubrique	o1939	g$id_article	o2231	g$statut_article	o2342	g$logo_statut	o2372	g$statut_article	o2416	g$logo_statut	o2445	g$statut_article	o2491	g$logo_statut	o2519	g$statut_article	o2564	g$logo_statut	o2596	g$statut_article	o2640	g$logo_statut	o2674	g$surtitre	o2848	g$surtitre	o2939	g$titre	o2994	g$logo_statut	o3002	g$soustitre	o3022	g$soustitre	o3114	g$descriptif	o3165	g$url_site	o3180	g$nom_site	o3193	g$texte_case	o3387	g$descriptif	o3402	g$texte_case	o3472	g$nom_site	o3488	g$url_site	o3498	g$nom_site	o3541	g$url_site	o3556	g$texte_case	o3589	g$query	o3926	g$result	o4132	g$query	o4153	g$row	o4200	g$result	o4224	g$date	o4253	g$row	o4275	g$version_aff	o4291	g$row	o4306	g$titre_version	o4327	g$row	o4349	g$titr!
 e_aff	o4374	g$titre_version	o4387	g$titre_version	o4404	g$date	o4421	g
$version_aff	o4433	g$id_version	o4449	g$link	o4466	g$link	o4488	g$version_aff	o4516	g$link	o4533	g$link	o4578	g$row	o4722	g$version_aff	o4983	g$id_version	o4999	g$version_aff	o5057	g$id_diff	o5073	g$link	o5163	g$link	o5187	g$id_version	o5215	g$link	o5233	g$version_aff	o5258	g$link	o5295	g$id_version	o5571	g$virtuel	o5661	g$chapo	o5684	g$virtuel	o5710	g$chapo	o5728	g$virtuel	o5750	g$revision_nbsp	o5924	g$options	o5942	g$chapo	o6045	g$texte	o6132	g$ps	o6167	g$ps	o6337	g$revision_nbsp	o6404	g$les_notes	o6436	g$les_notes	o6578	g$champs_extra	o6656	g$extra	o6674	g$extra	o6733
spip_background.php3	g$image	o158	g$size	o309	g$image	o324	g$size	o395	g$image	o510
ecrire/inc_auxbase.php3	d_ECRIRE_INC_AUXBASE	o100	g$spip_petitions	o130	g$spip_petitions_key	o424	g$spip_visites_temp	o488	g$spip_visites_temp_key	o689	g$spip_visites	o764	g$spip_visites_key	o882	g$spip_visites_articles	o938	g$spip_visites_articles_key	o1108	g$spip_referers_temp	o1185	g$spip_referers_temp_key	o1475	g$spip_referers	o1564	g$spip_referers_key	o1864	g$spip_referers_articles	o1928	g$spip_referers_articles_key	o2189	g$spip_auteurs_articles	o2312	g$spip_auteurs_articles_key	o2453	g$spip_auteurs_rubriques	o2561	g$spip_auteurs_rubriques_key	o2704	g$spip_auteurs_messages	o2815	g$spip_auteurs_messages_key	o2988	g$spip_documents_articles	o3097	g$spip_documents_articles_key	o3242	g$spip_documents_rubriques	o3356	g$spip_documents_rubriques_key	o3503	g$spip_documents_breves	o3620	g$spip_documents_breves_key	o3761	g$spip_mots_articles	o3869	g$spip_mots_articles_key	o4004	g$spip_mots_breves	o4103	g$spip_mots_breves_key	o4234	g$spip_mots_rubriques	o4327	g$spip_mots_rubriques_!
 key	o4464	g$spip_mots_syndic	o4566	g$spip_mots_syndic_key	o4698	g$spip_mots_forum	o4793	g$spip_mots_forum_key	o4923	g$spip_meta	o5015	g$spip_meta_key	o5140	g$spip_index_articles	o5192	g$spip_index_articles_key	o5360	g$spip_index_auteurs	o5460	g$spip_index_auteurs_key	o5626	g$spip_index_breves	o5723	g$spip_index_breves_key	o5887	g$spip_index_mots	o5981	g$spip_index_mots_key	o6141	g$spip_index_rubriques	o6229	g$spip_index_rubriques_key	o6399	g$spip_index_syndic	o6502	g$spip_index_syndic_key	o6667	g$spip_index_signatures	o6763	g$spip_index_signatures_key	o6935	g$spip_index_forum	o7042	g$spip_index_forum_key	o7205	g$spip_index_dico	o7298	g$spip_index_dico_key	o7406	g$spip_versions	o7465	g$spip_versions_key	o7808	g$spip_versions_fragments	o7954	g$spip_versions_fragments_key	o8272	g$spip_caches	o8375	g$spip_caches_key	o8596	g$spip_ortho_cache	o8708	g$spip_ortho_cache_key	o8896	g$spip_ortho_dico	o8981	g$spip_ortho_dico_key	o9152	g$tables_auxiliaires	o9224	g$tables_auxiliaires	o924!
 6	g$spip_petitions	o9313	g$spip_petitions_key	o9348	g$spip_visites_tem
p	o9407	g$spip_visites_temp_key	o9441	g$spip_visites	o9498	g$spip_visites_key	o9532	g$spip_visites_articles	o9593	g$spip_visites_articles_key	o9635	g$spip_referers_temp	o9702	g$spip_referers_temp_key	o9738	g$spip_referers	o9797	g$spip_referers_key	o9830	g$spip_referers_articles	o9893	g$spip_referers_articles_key	o9937	g$spip_auteurs_articles	o10008	g$spip_auteurs_articles_key	o10050	g$spip_auteurs_rubriques	o10121	g$spip_auteurs_rubriques_key	o10165	g$spip_auteurs_messages	o10236	g$spip_auteurs_messages_key	o10278	g$spip_documents_articles	o10350	g$spip_documents_articles_key	o10396	g$spip_documents_rubriques	o10471	g$spip_documents_rubriques_key	o10519	g$spip_documents_breves	o10592	g$spip_documents_breves_key	o10634	g$spip_mots_articles	o10701	g$spip_mots_articles_key	o10737	g$spip_mots_breves	o10799	g$spip_mots_breves_key	o10838	g$spip_mots_rubriques	o10901	g$spip_mots_rubriques_key	o10939	g$spip_mots_syndic	o11002	g$spip_mots_syndic_key	o11041	g$spip_mots_forum	o11100	g$!
 spip_mots_forum_key	o11137	g$spip_meta	o11189	g$spip_meta_key	o11214	g$spip_index_articles	o11270	g$spip_index_articles_key	o11308	g$spip_index_auteurs	o11373	g$spip_index_auteurs_key	o11409	g$spip_index_breves	o11472	g$spip_index_breves_key	o11506	g$spip_index_mots	o11566	g$spip_index_mots_key	o11603	g$spip_index_rubriques	o11666	g$spip_index_rubriques_key	o11706	g$spip_index_syndic	o11771	g$spip_index_syndic_key	o11805	g$spip_index_signatures	o11871	g$spip_index_signatures_key	o11913	g$spip_index_forum	o11978	g$spip_index_forum_key	o12017	g$spip_index_dico	o12076	g$spip_index_dico_key	o12113	g$spip_versions	o12169	g$spip_versions_key	o12201	g$spip_versions_fragments	o12265	g$spip_versions_fragments_key	o12307	g$spip_caches	o12369	g$spip_caches_key	o12399	g$spip_ortho_cache	o12454	g$spip_ortho_cache_key	o12489	g$spip_ortho_dico	o12548	g$spip_ortho_dico_key	o12582
ecrire/inc_carto.php3	d_ECRIRE_INC_CARTE	o106	fembed_map_url	o145	fafficher_cartes	o338	g$couleur_claire	o402	g$couleur_foncee	o419	g$connect_id_auteur	o445	fafficher_carte_inteface	o2054	fcarte_editable	o6864	fcarte_administrable	o6911	fafficher_insertion_carte	o7050	g$connect_id_auteur	o7099	g$connect_statut	o7119	g$couleur_foncee	o7145	g$couleur_claire	o7162	g$options	o7179	g$spip_lang_left	o7198	g$spip_lang_right	o7215	g$clean_link	o7242
inc-calcul.php3	d_INC_CALCUL	o93	g$GLOBALS	o905	fsquelette_obsolete	o992	fcharger_squelette	o1623	fcherche_page	o3783	g$dossier_squelettes	o3834	g$delais	o3855	fcalculer_contexte	o5649	fcalculer_page_globale	o6122	g$contexte	o6298	fcalculer_page	o7131
recherche.php3	g$fond	o6	g$delais	o27
ecrire/lang/spip_oc_gsc.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/statistiques_referers.php3	g$id_article	o76	g$id_article	o97	g$query	o113	g$result	o231	g$query	o252	g$row	o267	g$result	o291	g$titre	o305	g$row	o319	g$total_absolu	o337	g$row	o353	g$val_popularite	o372	g$row	o396	g$query	o431	g$result	o498	g$query	o519	g$row	o534	g$result	o558	g$total_absolu	o572	g$row	o588	g$titre	o621	g$pourarticle	o629	g$connect_statut	o1089	g$limit	o1246	g$limit	o1262	g$limit	o1282	g$limit	o1295	g$jour	o1314	g$jour	o1332	g$jour	o1378	g$where	o1417	g$vis	o1445	g$table_ref	o1470	g$query	o1501	g$query	o1671	g$limit	o1679
ecrire/lang/public_eo.php3	g$GLOBALS	o80	g$GLOBALS	o89
inc-formulaire_signature.php3	g$balise_FORMULAIRE_SIGNATURE_collecte	o60	g$balise_FORMULAIRE_SIGNATURE_collecte	o99	fbalise_FORMULAIRE_SIGNATURE_stat	o280	fbalise_FORMULAIRE_SIGNATURE_dyn	o378	freponse_confirmation	o1327	vconfirm	o1391	freponse_signature	o4145	ftest_pass	o7551
ecrire/inc_statistiques.php3	d_ECRIRE_INC_STATISTIQUES	o105	fstats_load_engines	o347	fstats_show_keywords	o1010	varr_engines	o1072	vurl_site	o1094	fsupprimer_referers	o3291	fcalculer_n_referers	o4117	faff_referers	o6869
inc-compilo.php3	d_INC_COMPILO	o150	fcalculer_inclure	o811	g$dossier_squelettes	o880	fcalculer_texte	o2248	fcalculer_boucle	o3439	fcalculer_parties	o9254	fcalculer_liste	o10907	fcalculer_squelette	o14075	g$table_primary	o14206	g$table_des_tables	o14222	g$tables_des_serveurs_sql	o14241
ecrire/statistiques.php3	g$spip_ecran	o104	g$largeur_table	o132	g$taille	o156	g$largeur_table	o183	g$taille	o207	g$GLOBALS	o579	g$critere	o614	g$critere	o694	g$critere	o777	g$connect_statut	o936	fenfants	o1071	g$nombre_vis	o1100	g$total_vis	o1121	g$nombre_abs	o1141	g$critere	o1162	fenfants_aff	o1816	g$total_vis	o1871	g$ifond	o1891	g$niveau	o1907	g$nombre_vis	o1924	g$nombre_abs	o1945	g$couleur_claire	o1966	g$couleur_foncee	o1983	g$spip_lang_right	o2000	g$spip_lang_left	o2018	g$abs_total	o2043	g$taille	o2063	g$abs_total	o4779	g$abs_total	o4806	g$abs_total	o4820	g$nombre_vis	o4834	g$query	o4855	g$result	o4926	g$query	o4947	g$row	o4963	g$result	o4987	g$id_rubrique	o5000	g$row	o5015	g$nombre_vis	o5041	g$id_rubrique	o5053	g$total_vis	o5069	g$total_vis	o5081	g$nombre_vis	o5093	g$id_rubrique	o5105	g$total_vis	o5127	g$total_vis	o5141	g$taille	o5262
ecrire/inc_lab.php	finclude_spip	o350	fhtml_background	o867
breve.php3	g$fond	o6	g$delais	o23
ecrire/suivi_revisions.php3	g$debut	o324	g$debut	o332	g$uniq_auteur	o350	g$uniq_auteur	o364	g$uniq_auteur	o392	g$connect_statut	o419	g$req_where	o451	g$req_where	o523	g$uniq_auteur	o648	g$id_secteur	o665	g$nom_auteur	o817	g$GLOBALS	o831	g$uniq_auteur	o871	g$query	o1011	g$result	o1087	g$query	o1108	g$row	o1125	g$result	o1150	g$id_rubrique	o1163	g$row	o1178	g$titre	o1200	g$row	o1216	g$query_rub	o1235	g$result_rub	o1496	g$query_rub	o1521	g$id_rubrique	o1541	g$id_secteur	o1557	g$result_rub	o1621	g$langues	o1823	g$langues	o1894	g$lang	o1906	g$titre	o1917	g$lang	o1946	g$query_lang	o1958	g$result_lang	o2178	g$query_lang	o2204	g$lang	o2227	g$lang_choisie	o2236	g$result_lang	o2303	g$debut	o2563	g$id_secteur	o2571	g$uniq_auteur	o2584	g$lang_choisie	o2598
ecrire/lang/spip_oc_lms.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_getdocument.php3	fcreer_repertoire_documents	o16	g$dossier_squelettes	o59	fcopier_document	o520	fverifier_compactes	o1015	fafficher_compactes	o1978	fajout_doc	o2924	g$hash_id_auteur	o2981	g$hash	o2998	g$id_article	o3005	g$type	o3018	fajout_doc_zip	o5306	fajout_doc_s	o6749	feffacer_repertoire_temporaire	o7552
ecrire/sites_tous.php3	g$connect_statut	o70	g$supp_syndic	o105	g$query	o122	g$supp_syndic	o179	g$result	o195	g$query	o214	g$proposer_sites	o326	g$connect_statut	o785	g$proposer_sites	o819	g$link	o872	g$link	o910	g$link	o950	g$clean_link	o976	g$link	o1044	g$options	o1262	g$connect_statut	o1289
ecrire/lang/public_da.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/breves.php3	g$statut	o34	g$connect_statut	o46	g$query	o81	g$result	o175	g$query	o194	fenfant	o398	g$spip_lang_left	o425	g$spip_lang_right	o442
ecrire/lang/spip_lb.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/config-lang.php3	fmySel	o76	g$connect_statut	o425	g$connect_toutes_rubriques	o460	g$changer_config	o564	g$langues_prop	o901	g$langue_site	o960	g$langue_site	o1252	g$langues_prop	o1288	g$l	o1317	g$langues_prop	o1329	g$l	o1352	g$langue_site	o1358	g$l	o1421	g$options	o1631	g$charset	o1733	g$charset	o1971	g$charset	o2083	g$charset	o2194	g$charset	o2217	g$charset	o2263	g$charset	o2286
ecrire/inc_mail.php3	d_ECRIRE_INC_MAIL	o100	g$hebergeur	o201	g$HTTP_X_HOST	o220	g$REQUEST_URI	o234	g$SERVER_NAME	o248	g$HTTP_HOST	o262	g$hebergeur	o274	g$HTTP_X_HOST	o322	g$hebergeur	o361	g$SERVER_NAME	o425	g$hebergeur	o443	g$REQUEST_URI	o513	g$regs	o527	g$hebergeur	o538	g$SERVER_ADMIN	o587	g$hebergeur	o688	g$hebergeur	o768	g$GLOBALS	o870	fenvoyer_queue_mails	o910	g$queue_mails	o942	g$GLOBALS	o1212	ftester_mail	o1310	g$hebergeur	o1334	fenvoyer_mail	o1445	g$hebergeur	o1519	g$queue_mails	o1531	g$flag_wordwrap	o1545	fextrait_article	o3096	fnettoyer_titre_email	o4246	fenvoyer_mail_publication	o4366	g$connect_nom	o4414	fenvoyer_mail_proposition	o5392
ecrire/lang/public_oc_ni.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_index.php3	d_ECRIRE_INC_INDEX	o101	fseparateurs_indexation	o139	fspip_split	o637	g$flag_pcre	o672	fnettoyer_chaine_indexation	o788	g$translitteration_complexe	o833	findexer_chaine	o1175	g$index	o1233	g$mots	o1241	g$translitteration_complexe	o1248	fdeja_indexe	o2025	findexer_objet	o2284	g$index	o2387	g$mots	o2395	g$translitteration_complexe	o2402	fmarquer_indexer	o9365	findexer_article	o9588	findexer_auteur	o9672	findexer_breve	o9752	findexer_mot	o9828	findexer_rubrique	o9896	findexer_syndic	o9984	fcritere_indexation	o10101	feffectuer_une_indexation	o10464	fexecuter_une_indexation_syndic	o11229	fcreer_liste_indexation	o11646	fpurger_index	o11917	frequete_txt_integral	o12428	frequete_dico	o12921	frequete_hash	o13255	fprepare_recherche	o14486	vcache	o14568
ecrire/inc_flock.php3	d_ECRIRE_INC_FLOCK	o101	fspip_file_get_contents	o138	flire_fichier	o570	fecrire_fichier	o1374	fsupprimer_fichier	o2396
inc-login_public.php3	g$balise_LOGIN_PUBLIC_collecte	o144	g$balise_LOGIN_PUBLIC_collecte	o175	fbalise_LOGIN_PUBLIC_stat	o399	fbalise_LOGIN_PUBLIC_dyn	o519	g$clean_link	o586	flogin_explicite	o772	g$auteur_session	o821	g$clean_link	o838	flogin_pour_tous	o1691	g$ignore_auth_http	o1761	g$spip_admin	o1780	g$php_module	o1793	ffiltre_rester_connecte	o3458	fsilogoauteur	o3594
ecrire/inc_objet_base.php3	d_ECRIRE_INC_OBJET_BASE	o106	c_Abstract	o146	mabstract_error	o168	mabstract_func	o271	k_Abstract	o364	cObjectCacheInstance	o414	vfast_vars	o488	vslow_vars	o505	vfast_vars_loaded	o543	vslow_vars_loaded	o575	vdirty	o626	kObjectCacheInstance	o652	c_ObjectFactory	o750	vid_factory	o806	vobject_class	o867	vsql_table	o915	vsql_id	o932	vfast_vars_list	o963	vslow_vars_list	o1000	vfast_vars_array	o1060	vslow_vars_array	o1083	vfast_vars_sql	o1127	vslow_vars_sql	o1148	vcache	o1187	minit_factory	o1324	mnew_object	o2449	mcreate_object_cache_instance	o2499	mcreate_object_alias	o2814	mget_object_field	o3009	mset_object_field	o3584	mload_object_sql	o4225	mload_object_id	o5462	mfetch_object_id	o5652	mcreate_object	o5906	vnew_id	o5934	mfetch_object	o6256	mupdate_object	o6707	c_Object	o6851	vid_factory	o6900	vid	o6933	minit_object	o6952	mget	o7065	mset	o7164	mcommit	o7279	fadd_factory	o7430	g$factories	o7459
ecrire/carte_edit.php3	g$id_carte	o390	g$id_carte	o409	g$id_carte	o500	g$supp_carte	o519	g$supp_carte	o540	g$supp_confirme	o557	g$supp_rejet	o577	g$query	o594	g$result	o664	g$query	o685	g$id_carte	o758	g$new	o777	g$titre	o796	g$fichier	o829	g$commentaire	o846	g$callage	o867	g$id_srs	o884	g$js_titre	o899	g$titre	o1046	g$id_carte	o1063	g$modif_carte	o1266	g$id_carte	o1282	g$query	o1298	g$titre	o1363	g$fichier	o1393	g$commentaire	o1439	g$callage	o1486	g$id_srs	o1524	g$result	o1573	g$query	o1594	g$id_carte	o1613	g$query	o1629	g$result	o1700	g$query	o1721	g$row	o1737	g$result	o1761	g$titre	o1813	g$row	o1822	g$fichier	o1841	g$row	o1852	g$commentaire	o1873	g$row	o1888	g$callage	o1913	g$row	o1924	g$id_srs	o1945	g$row	o1962	g$js_titre	o1983	g$carte_link	o2021	g$retour	o2087	g$carte_link	o2096	g$retour	o2126	g$id_carte	o2188	g$id_carte	o2216	g$selection_type	o2257	g$geometrie	o2289	g$selection_type	o2300	g$selection_coords	o2320	g$objet_titre	o2345	g$id_carte	o2460	g$objet_titre	o2486!
 	g$geometrie	o2506	g$id_objet	o2526	g$modif_objet	o2585	g$query	o2603	g$objet_titre	o2709	g$objet_commentaire	o2760	g$objet_lien	o2799	g$objet_logo	o2830	g$geometrie	o2877	g$result	o2932	g$query	o2953	g$supp_objet	o3001	g$query	o3018	g$result	o3088	g$query	o3109	g$supp_carte	o3282	g$supp_confirme	o3298	g$supp_rejet	o3317	g$link	o3520	g$link	o3541	g$supp_carte	o3569	g$link	o3589	g$id_carte	o3850	g$titre	o3927	g$commentaire	o3943	g$commentaire	o4105	g$fichier	o4149	g$fichier	o4746	g$lefichier	o4759	g$fichier	o4807	g$lefichier	o4825	g$fichier	o4836	g$lefichier	o4877	g$id_carte	o4888	g$retour	o5428	g$retour	o5524	g$id_carte	o5586	g$id_carte	o5619	g$link	o5692	g$carte_link	o5700	g$link	o5714	g$id_carte	o5742	g$retour	o5760	g$link	o5773	g$nb_reponses	o5822	g$link	o5840	g$link	o5918	g$id_carte	o6051	g$link	o6139	g$carte_link	o6147	g$link	o6161	g$id_carte	o6190	g$link	o6208	g$titre	o6234	g$titre	o6255	g$fichier	o6265	g$fichier	o6275	g$commentaire	o6286	g$commentaire	o6313	g$callage!
 	o6329	g$callage	o6353	g$id_srs	o6365	g$id_srs	o6381	g$titre	o6608	g$f
ichier	o6874	g$commentaire	o7115	g$callage	o7371	g$id_srs	o7625	g$id_carte	o7859	g$query	o8122	g$result	o8191	g$query	o8212	g$t	o8229	g$result	o8251	g$id_objet	o8266	g$t	o8277	g$titre_objet	o8295	g$t	o8322	g$lien_objet	o8338	g$t	o8351	g$commentaire_objet	o8365	g$t	o8398	g$logo_objet	o8420	g$t	o8434	g$geometrie	o8448	g$t	o8474	g$nouveau	o8495	g$id_objet	o8507	g$nouveau_objet	o8520	g$nouveau	o8543	g$nouveau	o8733	g$titre_objet	o8847	g$nouveau	o8903	g$link	o9028	g$carte_link	o9036	g$link	o9052	g$id_objet	o9081	g$link	o9101	g$nouveau	o9197	g$js	o9310	g$js	o9403	g$titre_objet	o9580	g$commentaire_objet	o9918	g$lien_objet	o10133	g$logo_objet	o10358	g$geometrie	o10638	g$link	o10909	g$carte_link	o10917	g$link	o10933	g$id_objet	o10961	g$link	o11059
ecrire/lab_revisions.php	d_ECRIRE_INC_REVISIONS	o105	g$GLOBALS	o137	fseparer_paras	o185	freplace_fragment	o497	g$flag_gz	o590	fexec_replace_fragments	o1054	fexec_delete_fragments	o1306	fajouter_fragments	o1631	g$flag_gz	o1697	g$agregation_versions	o1707	fsupprimer_fragments	o3292	g$flag_gz	o3365	g$agregation_versions	o3375	frecuperer_fragments	o7876	fapparier_paras	o8749	frecuperer_version	o10746	fsupprimer_versions	o11338	fajouter_version	o11670	g$connect_id_auteur	o11739
ecrire/config-multilang.php3	fmySel	o76	g$connect_statut	o360	g$connect_toutes_rubriques	o395	g$changer_config	o499	g$langues	o2773	g$GLOBALS	o2784	g$cesure	o2813	g$langues	o2836	g$langues_installees	o2860	g$GLOBALS	o2895	g$langues_autorisees	o2921	g$l	o3007	g$langues_installees	o3019	g$langues_trad	o3046	g$l	o3060	g$l	o3092	g$langues_autorisees	o3104	g$langues_auth	o3131	g$l	o3145	g$langues_bloquees	o3164	g$query	o3215	g$result	o3291	g$query	o3312	g$row	o3330	g$result	o3354	g$langues_bloquees	o3369	g$row	o3387	g$query	o3412	g$result	o3486	g$query	o3507	g$row	o3525	g$result	o3549	g$langues_bloquees	o3564	g$row	o3582	g$query	o3607	g$result	o3684	g$query	o3705	g$row	o3723	g$result	o3747	g$langues_bloquees	o3762	g$row	o3780	g$langues_bloquees	o3912	g$code_langue	o3946	g$langues_bloquees	o3969	g$i	o3994	g$nom_langue	o4020	g$langues	o4034	g$code_langue	o4043	g$langues_trad	o4065	g$code_langue	o4079	g$nom_langue	o4094	g$nom_langue	o4133	g$i	o4474	g$cesure	o4480	g$code_langue	o4596!
 	g$nom_langue	o4610	g$langues	o4630	g$langues_bloquees	o4650	g$code_langue	o4668	g$i	o4696	g$langues_trad	o4726	g$code_langue	o4740	g$nom_langue	o4755	g$langues_auth	o4800	g$code_langue	o4814	g$nom_langue	o4952	g$i	o5274	g$cesure	o5280
ecrire/lang/public_oc_lnc.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_eo.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/admin_tech.php3	g$options	o113	g$connect_statut	o356	g$connect_toutes_rubriques	o391	g$flag_gz	o1085	g$flag_gz	o2208	g$fichier_defaut	o2221	g$texte_compresse	o2255	g$fichier_defaut	o2323	g$texte_compresse	o2354	g$texte_compresse	o2477	g$options	o2822	g$res	o2849	g$row	o2894	g$res	o2918	g$row	o2930
ecrire/inc_rubriques.php3	d_ECRIRE_INC_RUBRIQUES	o105	fcalculer_rubriques	o305	fcalculer_langues_rubriques_etape	o5231	fcalculer_langues_rubriques	o5788
ecrire/lang/spip_pl.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_fr.php3	g$GLOBALS	o80	g$GLOBALS	o89
inc-urls-propres.php3	d_INC_URLS2	o76	f_generer_url_propre	o354	fgenerer_url_article	o1845	fgenerer_url_rubrique	o2017	fgenerer_url_breve	o2223	fgenerer_url_forum	o2408	fgenerer_url_mot	o2492	fgenerer_url_auteur	o2665	fgenerer_url_document	o2754	frecuperer_parametres_url	o3104	g$contexte	o3152
ecrire/inc_documents.php3	d_ECRIRE_INC_DOCUMENTS	o105	fvignette_par_defaut	o225	fvignette_previsu_ou_par_defaut	o1015	fdocument_et_vignette	o1503	fembed_document	o1797	g$id_doublons	o1878	fintegre_image	o6197	g$id_doublons	o6254	ffichiers_upload	o10323	ftexte_upload_manuel	o10832	ftexte_vignette_document	o11911	g$connect_id_auteur	o12021	fafficher_upload	o13131	g$clean_link	o13283	g$connect_statut	o13296	g$connect_toutes_rubriques	o13313	g$options	o13340	vnum_form	o13359	fafficher_documents_non_inclus	o15242	g$connect_id_auteur	o15327	g$connect_statut	o15347	g$couleur_foncee	o15372	g$couleur_claire	o15389	g$clean_link	o15414	g$id_doublons	o15435	g$options	o15449	g$spip_lang_left	o15467	g$spip_lang_right	o15484	fafficher_horizontal_document	o35834	g$connect_id_auteur	o35933	g$connect_statut	o35953	g$couleur_foncee	o35978	g$couleur_claire	o35995	g$clean_link	o36020	g$options	o36041	g$id_document_deplie	o36051	fafficher_documents_colonne	o43978	g$connect_id_auteur	o44065	g$conn!
 ect_statut	o44085	g$couleur_foncee	o44110	g$couleur_claire	o44127	g$options	o44144	g$clean_link	o44162	g$descriptif	o44804	g$texte	o44817	g$chapo	o44825	fafficher_case_document	o47438	g$connect_id_auteur	o47536	g$connect_statut	o47556	g$couleur_foncee	o47581	g$couleur_claire	o47598	g$clean_link	o47623	g$options	o47644	g$id_doublons	o47662	g$spip_lang_left	o47684	g$spip_lang_right	o47701
inc-admin.php3	fperso_admin	o151
ecrire/messagerie.php3	g$supp_dest	o108	g$detruire_message	o233	g$connect_statut	o1449	g$connect_id_auteur	o1642	g$messages_vus	o1697	g$query_message	o1719	g$query_message	o1958	g$query_message	o1990	g$query_message	o2251	g$query_message	o2282	g$query_message	o2612	g$query_message	o2644	g$query_message	o2809	g$query	o2849	g$result	o3451	g$query	o3472	g$result	o3499	g$row	o3962	g$result	o3986	g$count	o4000	g$i	o4017	g$bgcolor	o4031	g$i	o4054	g$bgcolor	o4076	g$couleur_claire	o4087	g$i	o4107	g$id_auteur	o4121	g$row	o4134	g$nom	o4155	g$row	o4167	g$total	o4183	g$row	o4192	g$count	o4576	g$result	o4605	g$query_message	o4746	g$query_message	o4937	g$query_message	o4977	g$query_message	o5187
inc-formulaire_site.php3	g$balise_FORMULAIRE_SITE_collecte	o14	g$balise_FORMULAIRE_SITE_collecte	o48	fbalise_FORMULAIRE_SITE_stat	o159	fbalise_FORMULAIRE_SITE_dyn	o278
ecrire/aide_index.php3	g$lastmodified	o154	g$headers_only	o200	g$lastmodified	o235	g$headers_only	o275	g$var_lang	o596	g$var_lang	o622	fhelp_frame	o697	g$spip_lang	o726	ffichier_aide	o1472	g$help_server	o1512	fhelp_body	o2466	g$help_server	o2500	fhelp_img	o4902	g$help_server	o4928	fhelp_menu	o5522	g$spip_lang_left	o5556	g$spip_lang_rtl	o5573	g$spip_lang_right	o5589	frubrique	o7647	g$ligne_rubrique	o7693	g$block_rubrique	o7718	g$titre_rubrique	o7743	g$afficher_rubrique	o7768	g$ouvrir_rubrique	o7788	g$larubrique	o7814	g$aide_statut	o7836	ffin_rubrique	o8137	g$ligne_rubrique	o8162	g$block_rubrique	o8187	g$titre_rubrique	o8212	g$afficher_rubrique	o8237	g$ouvrir_rubrique	o8257	g$texte	o8283	farticle	o8842	g$aide	o8894	g$ligne	o8909	g$ligne_rubrique	o8925	g$rubrique	o8950	g$texte	o8969	g$afficher_rubrique	o8985	g$ouvrir_rubrique	o9005	g$aide_statut	o9031	g$spip_lang	o9053	fanalyse_aide	o9737	g$img	o10189	g$regs	o10195	g$regs	o10213	g$html	o10234	g$l	o10241	g$url_aide	o10245	g$html!
 	o10311	g$help_server	o10410	g$frame	o10855	g$aide	o10886	g$html	o10893	g$frame	o10912	g$aide	o10943	g$html	o10950	g$aide	o10979
ecrire/inc_sites.php3	d_INC_SITES	o94	g$supprimer_lien	o120	g$GLOBALS	o138	g$ajouter_lien	o281	g$GLOBALS	o297	frecuperer_page	o442	ftranscoder_page	o2257	ftrouver_format	o2795	fanalyser_site	o3159	fsyndic_a_jour	o5864	fafficher_sites	o15256	g$couleur_claire	o15305	g$couleur_foncee	o15322	g$spip_lang_left	o15339	g$spip_lang_right	o15356	g$connect_id_auteur	o15382	fafficher_syndic_articles	o19452	g$couleur_claire	o19535	g$connect_statut	o19560	g$REQUEST_URI	o19585	g$debut_liste_sites	o19607	g$flag_editable	o19635	vn_liste_sites	o19661	fexecuter_une_syndication	o24278
ecrire/lang/spip_oc_va.php3	g$GLOBALS	o80	g$GLOBALS	o89
inc-boucles.php3	d_INC_BOUCLES	o151	fboucle_DEFAUT	o224	fboucle_BOUCLE_dist	o482	fboucle_ARTICLES_dist	o630	fboucle_AUTEURS_dist	o1115	fboucle_BREVES_dist	o1941	fboucle_FORUMS_dist	o2330	fboucle_SIGNATURES_dist	o2777	fboucle_DOCUMENTS_dist	o3356	fboucle_TYPES_DOCUMENTS_dist	o3778	fboucle_GROUPES_MOTS_dist	o4042	fboucle_MOTS_dist	o4292	fboucle_RUBRIQUES_dist	o4531	fboucle_HIERARCHIE_dist	o4882	fboucle_SYNDICATION_dist	o5724	fboucle_SYNDIC_ARTICLES_dist	o6027
ecrire/lang/spip_oc_auv.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/public_vi.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/message.php3	fhttp_afficher_rendez_vous	o112	g$spip_lang_rtl	o173	fsql_nouveau_participant	o1356	fhttp_auteurs_ressemblants	o1653	g$connect_id_auteur	o1720	fhttp_visualiser_participants	o3789	fhttp_ajouter_participants	o4243	fhttp_afficher_forum_perso	o6754	g$row	o7516	g$row	o7621	g$ajout_forum	o7808	g$texte	o7832	g$titre	o7856	g$modifier_message	o7967	g$titre	o7998	g$titre	o8018	g$texte	o8028	g$texte	o8048	g$changer_rv	o8167	g$jour	o8270	g$date	o8400	g$heures	o8435	g$minutes	o8443	g$mois	o8454	g$jour	o8461	g$annee	o8468	g$jour	o8485	g$date	o8501	g$mois	o8512	g$date	o8525	g$annee	o8536	g$date	o8551	g$heures	o8562	g$date	o8579	g$minutes	o8590	g$date	o8609	g$unix_debut	o8688	g$heures	o8719	g$minutes	o8727	g$mois	o8738	g$jour	o8745	g$annee	o8752	g$unix_fin	o8765	g$heures_fin	o8794	g$minutes_fin	o8806	g$mois_fin	o8821	g$jour_fin	o8832	g$annee_fin	o8843	g$unix_fin	o8864	g$unix_debut	o8877	g$jour_fin	o8896	g$jour	o8908	g$mois_fin	o8919	g$mois	o8931	g$annee_fin	o8942	g$annee!
 	o8955	g$heures_fin	o8967	g$heures	o8981	g$minutes_fin	o8998	g$minutes	o9013	g$date_fin	o9034	g$heures_fin	o9073	g$minutes_fin	o9085	g$mois_fin	o9100	g$jour_fin	o9111	g$annee_fin	o9122	g$jour_fin	o9143	g$date_fin	o9163	g$mois_fin	o9178	g$date_fin	o9195	g$annee_fin	o9210	g$date_fin	o9229	g$heures_fin	o9244	g$date_fin	o9265	g$minutes_fin	o9280	g$date_fin	o9303	g$change_statut	o9523	g$supp_dest	o9747	g$row	o9876	g$id_message	o9976	g$row	o9990	g$date_heure	o10011	g$row	o10025	g$date_fin	o10046	g$row	o10058	g$titre	o10077	g$row	o10091	g$texte	o10108	g$row	o10124	g$type	o10141	g$row	o10149	g$statut	o10164	g$row	o10174	g$page	o10191	g$row	o10199	g$rv	o10214	g$row	o10220	g$expediteur	o10233	g$row	o10247	g$lejour	o10268	g$row	o10284	g$lemois	o10306	g$row	o10321	g$lannee	o10345	g$row	o10361	g$type	o10435	g$titre	o10592	g$rv	o10654	g$lemois	o10700	g$lannee	o10709	g$lejour	o10718	g$lemois	o10727	g$lannee	o10736	g$rv	o10965	g$lejour	o11038	g$lemois	o11046	g$lannee	o11054	g$id_message	o1!
 1070	g$type	o11110	g$le_type	o11133	g$la_couleur	o11184	g$couleur_fond
	o11211	g$type	o11251	g$le_type	o11270	g$la_couleur	o11325	g$couleur_fond	o11352	g$type	o11392	g$le_type	o11415	g$la_couleur	o11448	g$couleur_fond	o11475	g$statut	o12026	g$rv	o12189	g$date_heure	o12301	g$date_heure	o12332	g$type	o12475	g$cherche_auteur	o12560	g$cherche_auteur	o12665	g$id_message	o12683	g$nouv_auteur	o12732	g$nouv_auteur	o12774	g$id_message	o12788	g$query_auteurs	o12845	g$result_auteurs	o13016	g$query_auteurs	o13045	g$total_dest	o13066	g$result_auteurs	o13094	g$total_dest	o13120	g$couleurs	o13142	g$couleur_claire	o13170	g$auteurs_tmp	o13191	g$ze_auteurs	o13218	g$ifond	o13244	g$res	o13259	g$row	o13279	g$result_auteurs	o13303	g$id_auteur	o13327	g$row	o13340	g$nom_auteur	o13363	g$row	o13382	g$statut_auteur	o13400	g$row	o13417	g$ze_auteurs	o13437	g$id_auteur	o13453	g$couleur	o13470	g$couleurs	o13481	g$ifond	o13491	g$ifond	o13504	g$ifond	o13517	g$auteurs_tmp	o13530	g$id_auteur	o13589	g$nom_auteur	o13607	g$res	o13634	g$row	o13765	g$id_auteur	o13790	g$expediteur	o13!
 804	g$nom_auteur	o13917	g$id_auteur	o14076	g$connect_id_auteur	o14090	g$auteurs_tmp	o14327	g$res	o14502	g$statut	o14566	g$forcer_dest	o14588	g$ze_auteurs	o14642	g$id_message	o14665	g$rv	o15001	g$date_heure	o15041	g$date_fin	o15054	g$expediteur	o15319	g$connect_id_auteur	o15334	g$statut	o15357	g$type	o15386	g$total_dest	o15408	g$expediteur	o16050	g$connect_id_auteur	o16065	g$statut	o16089	g$type	o16111	g$type	o16130	g$connect_statut	o16152	g$statut	o16435	g$type	o16459	g$expediteur	o16743	g$connect_id_auteur	o16758	g$type	o16781	g$connect_statut	o16803	g$id_message	o17131	g$titre	o17144
resume.php3	g$fond	o6	g$delais	o24
ecrire/lang/public_ar.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/documents_liste.php3	g$res	o444	g$row	o509	g$res	o533	g$types	o542	g$row	o549	g$row	o568	g$query	o576	g$result	o1025	g$query	o1046	g$row	o1064	g$result	o1086	g$titre	o1100	g$row	o1107	g$descriptif	o1125	g$row	o1137	g$date	o1160	g$row	o1166	g$id_document	o1183	g$row	o1196	g$id_rubrique	o1215	g$row	o1228	g$titre_rub	o1247	g$row	o1265	g$fichier	o1288	g$row	o1299	g$titre	o1325	g$titre	o1333	g$id_document	o1366	g$types	o1449	g$row	o1456	g$date	o1496	g$descriptif	o1517	g$descriptif	o1552
ecrire/inc_abstract_sql.php3	d_INC_ABSTRACT_SQL	o98	fspip_abstract_select	o957	fspip_abstract_serveur	o1756	fspip_abstract_fetch	o2095	fspip_abstract_count	o2286	fspip_abstract_free	o2474	fspip_abstract_insert	o2663	fspip_abstract_fetsel	o2918
ecrire/synchro.php3	g$suivi_edito	o407	g$adresse_suivi	o446	g$adresse_site	o489	g$adresse_suivi_inscription	o530	g$suivi_edito	o656	g$adresse_suivi	o689	g$adresse_suivi_inscription	o720	g$lien	o837	fafficher_liens_calendrier	o1225	g$adresse_site	o1284	g$connect_id_auteur	o1953	g$adresse_site	o2249	g$query	o2348	g$result	o2425	g$query	o2446	g$result	o2475	g$row	o2515	g$result	o2537	g$id_rubrique	o2551	g$row	o2564	g$titre_rubrique	o2588	g$row	o2611	g$activer_breves	o2831	g$activer_breves	o2885	g$adresse_site	o2993	g$adresse_site	o3269
ecrire/inc_debug_sql.php3	d_INC_DEBUG_SQL	o98	faffiche_erreurs_page	o348	ferreur_requete_boucle	o975	ferreur_squelette	o2417	g$tableau_des_erreurs	o2467	g$auteur_session	o2497	vruns	o2523	fboucle_debug_resultat	o3304	g$debug_objets	o3359	vrequete	o3383	fboucle_debug_compile	o3784	g$debug_objets	o3856	fsquelette_debug_compile	o4031	g$debug_objets	o4096	fboucle_debug	o4287	g$debug_objets	o4331	fdebug_dumpfile	o4449	g$debug_objets	o4498	g$var_mode_objet	o4513	g$var_mode_affiche	o4530
mes_fonctions.php3	g$tables_principales	o87	g$spip_carto_carte	o111	g$spip_carto_carte_key	o384	g$spip_carto_objet	o482	g$spip_carto_objet_key	o809	g$tables_principales	o933	g$spip_carto_objet	o990	g$spip_carto_objet_key	o1019	g$tables_principales	o1044	g$spip_carto_carte	o1101	g$spip_carto_carte_key	o1130	g$table_primary	o1162	g$table_primary	o1179	fwkt2coords	o1842	fwkt2shape	o2543
ecrire/lang/public_lb.php3	g$GLOBALS	o80	g$GLOBALS	o89
article.php3	g$fond	o7	g$delais	o26
inc-formulaire_forum.php3	g$GLOBALS	o473	g$balise_FORMULAIRE_FORUM_collecte	o615	g$balise_FORMULAIRE_FORUM_collecte	o650	fbalise_FORMULAIRE_FORUM_stat	o769	fbalise_FORMULAIRE_FORUM_dyn	o1171	g$REMOTE_ADDR	o1304	g$id_message	o1318	g$afficher_texte	o1331	g$spip_forum_user	o1348	fbarre_forum	o7328	vnum_formulaire	o7515	ftable_des_mots	o8118	g$afficher_groupe	o8162	fafficher_petits_logos_mots	o9752	fsql_recherche_donnees_forum	o10473
ecrire/inc_export.php3	d_ECRIRE_INC_EXPORT	o102	g$GLOBALS	o133	fmysql_timestamp_to_time	o251	fbuild_begin_tag	o543	fbuild_end_tag	o597	ftext_to_xml	o695	fexport_objets	o873	g$debut_limit	o991
ecrire/plugins/plug_carto_vignette.php	favant_typo_carto_vignette	o114
ecrire/statistiques_svg.php3	g$date	o101	g$expire	o120	g$date	o130	g$headers_only	o148	g$expire	o183	g$date	o194	g$date	o227	g$expire	o235	g$expire	o270	g$headers_only	o327	g$date	o375	g$expire	o411	g$connect_statut	o436	g$couleur_claire	o1161	g$couleur_foncee	o1249	g$aff_jours	o1504	g$aff_jours	o1516	g$id_article	o1539	g$table	o1556	g$table_ref	o1592	g$where	o1633	g$table	o1680	g$table_ref	o1707	g$where	o1739	g$query	o1785	g$result	o1892	g$query	o1913	g$row	o1930	g$result	o1954	g$date_premier	o1968	g$row	o1984	g$query	o2038	g$result	o2195	g$query	o2214	g$row	o2232	g$result	o2256	g$date	o2270	g$row	o2278	g$visites	o2299	g$row	o2310	g$log	o2330	g$date	o2335	g$visites	o2344	g$i	o2360	g$date_debut	o2369	g$date	o2383	g$i	o2392	g$log	o2416	g$max	o2429	g$log	o2444	g$visites_today	o2450	g$date_today	o2469	g$nb_jours	o2493	g$date_today	o2512	g$date_debut	o2524	g$maxgraph	o2554	g$max	o2585	g$max	o2627	g$maxgraph	o2643	g$maxgraph	o2659	g$maxgraph	o2687	g$max	o2699	g$maxgraph	o2705	g$m!
 axgraph	o2732	g$max	o2744	g$maxgraph	o2750	g$maxgraph	o2768	g$rapport	o2781	g$maxgraph	o2798	g$log	o2822	g$largeur	o2835	g$nb_jours	o2859	g$largeur	o2880	g$largeur	o2899	g$agreg	o2916	g$log	o2936	g$agreg	o2965	g$largeur	o2987	g$largeur	o3002	g$largeur_abs	o3020	g$aff_jours	o3041	g$largeur_abs	o3062	g$inc	o3085	g$largeur_abs	o3097	g$aff_jours_plus	o3119	g$largeur_abs	o3144	g$inc	o3159	g$aff_jours_moins	o3169	g$largeur_abs	o3195	g$inc	o3210	g$largeur_abs	o3230	g$aff_jours_plus	o3254	g$aff_jour_moins	o3280	g$largeur_abs	o3316	g$aff_jours_plus	o3339	g$largeur_abs	o3367	g$aff_jours_moins	o3390	g$largeur_abs	o3419	g$largeur	o3486	g$nb_jours	o3495	g$agreg	o3505	g$largeur	o3610	g$nb_jours	o3619	g$agreg	o3629	g$largeur	o3735	g$nb_jours	o3744	g$agreg	o3754	g$largeur	o3862	g$nb_jours	o3871	g$agreg	o3881	g$largeur	o3986	g$nb_jours	o3995	g$agreg	o4005	g$largeur	o4111	g$nb_jours	o4120	g$agreg	o4130	g$largeur	o4236	g$nb_jours	o4245	g$agreg	o4255	g$key	o4363	g$value	o4369	g$log	o4384	g$tes!
 t_agreg	o4400	g$test_agreg	o4425	g$agreg	o4440	g$test_agreg	o4458	g$n	
o4478	g$decal	o4494	g$decal	o4508	g$decal	o4523	g$tab_moyenne	o4537	g$decal	o4550	g$value	o4560	g$jour_prec	o4626	g$ecart	o4648	g$key	o4664	g$jour_prec	o4669	g$agreg	o4692	g$i	o4715	g$i	o4721	g$ecart	o4726	g$i	o4734	g$decal	o4750	g$decal	o4764	g$decal	o4781	g$tab_moyenne	o4797	g$decal	o4810	g$value	o4820	g$ce_jour	o4849	g$jour_prec	o4872	g$i	o4893	g$jour	o4913	g$ce_jour	o4930	g$ce_jour	o4958	g$tab_moyenne	o4981	g$moyenne	o5001	g$val_tab	o5033	g$tab_moyenne	o5050	g$moyenne	o5071	g$val_tab	o5083	g$moyenne	o5098	g$moyenne	o5109	g$tab_moyenne	o5126	g$difference	o5199	g$hauteur_moyenne	o5214	g$moyenne	o5241	g$moyenne	o5258	g$hauteur_moyenne	o5305	g$moyenne	o5331	g$rapport	o5343	g$hauteur_moyenne_prec	o5369	g$n	o5433	g$largeur	o5439	g$largeur	o5454	g$n	o5477	g$largeur	o5483	g$largeur	o5498	g$hauteur_moyenne_prec	o5520	g$n	o5549	g$largeur	o5555	g$largeur	o5570	g$hauteur_moyenne	o5592	g$n	o5617	g$largeur	o5623	g$largeur	o5638	g$n	o5704	g$largeur	o5710	g$largeur	o5725	g$hauteur_moyen!
 ne_prec	o5752	g$n	o5786	g$largeur	o5792	g$largeur	o5807	g$hauteur_moyenne	o5834	g$hauteur_moyenne_prec	o5889	g$hauteur_moyenne	o5913	g$difference	o5942	g$n	o6369	g$ce_jour	o6390	g$key	o6413	g$jour	o6423	g$ce_jour	o6440	g$ce_jour	o6468	g$total_loc	o6483	g$total_loc	o6496	g$value	o6509	g$tab_moyenne	o6526	g$moyenne	o6545	g$val_tab	o6575	g$tab_moyenne	o6592	g$moyenne	o6611	g$val_tab	o6623	g$moyenne	o6636	g$moyenne	o6647	g$tab_moyenne	o6664	g$hauteur_moyenne	o6685	g$moyenne	o6710	g$rapport	o6721	g$hauteur	o6739	g$value	o6756	g$rapport	o6765	g$moyenne	o6783	g$moyenne	o6800	g$key	o7013	g$fill	o7061	g$couleur_foncee	o7069	g$fill	o7099	g$n	o7148	g$largeur	o7154	g$hauteur	o7177	g$n	o7273	g$largeur	o7279	g$hauteur	o7302	g$key	o7398	g$n	o7437	g$largeur	o7443	g$hauteur_moyenne	o7467	g$n	o7496	g$largeur	o7502	g$hauteur_moyenne_prec	o7561	g$n	o7623	g$largeur	o7629	g$largeur	o7644	g$n	o7667	g$largeur	o7673	g$largeur	o7688	g$hauteur_moyenne_prec	o7710	g$n	o7739	g$largeur	o7745	g$largeur	o7!
 760	g$hauteur_moyenne	o7782	g$n	o7807	g$largeur	o7813	g$largeur	o7828	
g$n	o7892	g$largeur	o7898	g$largeur	o7913	g$hauteur_moyenne_prec	o7940	g$n	o7974	g$largeur	o7980	g$largeur	o7995	g$hauteur_moyenne	o8022	g$hauteur_moyenne	o8120	g$n	o8144	g$largeur	o8150	g$largeur	o8165	g$hauteur_moyenne	o8187	g$n	o8212	g$largeur	o8218	g$largeur	o8233	g$hauteur_moyenne	o8307	g$n	o8336	g$largeur	o8342	g$largeur	o8357	g$hauteur_moyenne	o8384	g$hauteur_moyenne_prec	o8436	g$hauteur_moyenne	o8460	g$jour_prec	o8486	g$key	o8499	g$val_prec	o8509	g$value	o8521	g$largeur	o8581	g$nb_jours	o8590	g$agreg	o8600	g$largeur	o8731	g$nb_jours	o8740	g$agreg	o8750	g$largeur	o8913	g$nb_jours	o8922	g$agreg	o8932	g$maxgraph	o9049	g$largeur	o9110	g$nb_jours	o9119	g$agreg	o9129	g$maxgraph	o9246	g$largeur	o9307	g$nb_jours	o9316	g$agreg	o9326	g$maxgraph	o9444	g$largeur	o9505	g$nb_jours	o9514	g$agreg	o9524	g$maxgraph	o9639	g$gauche_prec	o9674	g$jour	o9701	g$date_debut	o9709	g$jour	o9722	g$date_today	o9731	g$jour	o9744	g$jour	o9752	g$ce_jour	o9776	g$jour	o9797	g$ce_jour	o9816	g$afficher	!
 o9839	g$jour	o9874	g$jour	o9901	g$afficher	o9914	g$jour	o9952	g$gauche	o9981	g$jour	o9992	g$date_debut	o10000	g$largeur	o10015	g$agreg	o10037	g$gauche	o10059	g$gauche_prec	o10069	g$jour	o10101	g$gauche	o10451	g$afficher	o10578	g$gauche_prec	o10620	g$gauche	o10635
ecrire/lang/spip_en.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_oc_prv.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_popularites.php3	d_ECRIRE_INC_POPULARITES	o104	fcalculer_popularites	o190
site.php3	g$fond	o6	g$delais	o22
ecrire/auteurs_edit.php3	fsupp_auteur	o144	fafficher_auteur_rubriques	o293	g$id_parent	o339	g$id_rubrique	o359	g$toutes_rubriques	o381	g$i	o408	g$query	o969	g$result	o1037	g$query	o1058	g$row	o1073	g$result	o1097	g$id_auteur	o1110	g$row	o1121	g$nom	o1141	g$row	o1146	g$bio	o1160	g$row	o1165	g$email	o1179	g$row	o1186	g$nom_site_auteur	o1202	g$row	o1219	g$url_site	o1238	g$row	o1248	g$login	o1267	g$row	o1274	g$pass	o1290	g$row	o1296	g$statut	o1311	g$row	o1319	g$pgp	o1336	g$row	o1341	g$messagerie	o1355	g$row	o1367	g$imessage	o1388	g$row	o1398	g$extra	o1417	g$row	o1426	g$low_sec	o1442	g$row	o1453	g$connect_id_auteur	o1476	g$id_auteur	o1498	g$nom	o1521	g$nom	o1564	g$arton	o1999	g$artoff	o2027	g$id_auteur	o2062	g$connect_statut	o2081	g$connect_id_auteur	o2117	g$id_auteur	o2139	g$arton	o2174	g$artoff	o2182	fmySel	o2275	g$nom	o2600	g$email	o2648	g$nom_site_auteur	o2752	g$connect_statut	o2907	g$connect_id_auteur	o2942	g$id_auteur	o2964	g$bio	o3136	g$bio	o3179	g$pgp	o3220	g$pgp	o3267	g$!
 champs_extra	o3302	g$extra	o3320	g$extra	o3384	g$connect_statut	o3462	g$aff_art	o3494	g$connect_id_auteur	o3550	g$id_auteur	o3572	g$aff_art	o3584	g$aff_art	o3627	g$id_auteur	o3901	g$connect_id_auteur	o3915	g$query_message	o3991	g$query_message	o4374	g$query_message	o4408	g$query_message	o4810
ecrire/lang/public_pl.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/plugins/plug_carto.php	favant_typo_carto	o172
inc-cache.php3	d_INC_CACHE	o94	fnettoyer_uri	o166	fgenerer_nom_fichier_cache	o520	g$delais	o580	g$flag_gz	o597	g$compresser_cache	o607	fretire_cache	o2059	fretire_caches	o2416	futiliser_cache	o3064	g$HTTP_SERVER_VARS	o3113	fpurger_repertoire	o3792	fpurger_cache	o4272	fpurger_squelettes	o4430	fdeterminer_cache	o4602
ecrire/lang/public_fr.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/export_all.php3	g$archive	o191	g$gz	o208	g$archive	o213	g$archive	o245	g$action	o271	g$archive	o328	g$action	o353	g$debug_limit	o364	g$debut_limit	o421	g$debut_limit	o435	g$etape	o503	g$etape	o688	g$f	o701	g$gz	o707	g$archive	o737	g$archive	o777	g$f	o800	g$gz	o806	g$archive	o836	g$archive	o876	g$f	o899	g$_fputs	o990	g$gz	o1001	g$etape	o1029	g$_fputs	o1042	g$f	o1050	g$query	o1242	g$query	o1297	g$f	o1317	g$gz	o1321	g$etape	o1326	g$query	o1372	g$query	o1425	g$f	o1443	g$gz	o1447	g$etape	o1452	g$query	o1496	g$query	o1550	g$f	o1569	g$gz	o1573	g$etape	o1578	g$query	o1623	g$query	o1684	g$f	o1709	g$gz	o1713	g$etape	o1718	g$query	o1769	g$query	o1824	g$f	o1844	g$gz	o1848	g$etape	o1853	g$query	o1899	g$query	o1949	g$f	o1964	g$gz	o1968	g$etape	o1973	g$query	o2019	g$query	o2077	g$f	o2100	g$gz	o2104	g$etape	o2109	g$query	o2157	g$debug_limit	o2194	g$query	o2222	g$f	o2239	g$gz	o2243	g$etape	o2248	g$query	o2422	g$debug_limit	o2458	g$query	o2486	g$f	o2503	g$gz	o2507	g$etape	o2512	g$query!
 	o2555	g$query	o2610	g$f	o2630	g$gz	o2634	g$etape	o2639	g$query	o2686	g$debug_limit	o2727	g$query	o2755	g$f	o2776	g$gz	o2780	g$etape	o2785	g$query	o2833	g$query	o2885	g$f	o2903	g$gz	o2907	g$etape	o2912	g$query	o2966	g$debug_limit	o3012	g$query	o3040	g$f	o3066	g$gz	o3070	g$etape	o3075	g$etape	o3429	g$etape	o3439	g$_fputs	o3455	g$f	o3464	g$archive	o3602	g$etape_suivante	o3726	g$etape	o3744	g$debut_limit	o3761	g$gz	o4068	g$f	o4081	g$f	o4098	g$etape	o4109	g$etape	o4119	g$action	o4143
ecrire/plugins/plug_couleurs.php	g$couleurs_spip	o63	g$couleurs_spip	o80	g$couleurs_spip	o245	g$couleurs_spip	o409
forum.php3	g$fond	o6	g$delais	o23
ecrire/plugins/plug_carto_lien.php	favant_typo_cartelien	o105
ecrire/lang/public_pt.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_barre.php3	d_INC_BARRE	o93	fbouton_barre_racc	o187	fafficher_barre	o765	vnum_barre	o813	g$spip_lang	o917	g$spip_lang_right	o929	g$spip_lang_left	o947	fafficher_claret	o5202
ecrire/inc_surligne.php3	d_ECRIRE_INC_SURLIGNE	o104	dMARQUEUR_SURLIGNE	o286	dMARQUEUR_FSURLIGNE	o358	fsurligner_sans_accents	o416	fsplit_by_char	o1333	fsurligner_regexp_accents	o1494	fsurligner_mots	o2678	g$nombre_surligne	o2717	ftrouve_surligne	o4284	g$nombre_surligne	o4553
rubrique.php3	g$fond	o6	g$delais	o26
spip_cal.php3	fligne	o395	g$nom_site	o448	g$adresse_site	o483	g$id_utilisateur	o545	g$id_auteur	o563	g$id	o583	g$id_auteur	o630	g$cle	o642	g$query	o660	g$result	o727	g$query	o748	g$row	o763	g$result	o787	g$id_utilisateur	o801	g$row	o817	g$nom_utilisateur	o838	g$row	o855	g$statut_utilisateur	o870	g$row	o890	g$langue_utilisateur	o908	g$row	o928	g$id_utilisateur	o952	g$langue_utilisateur	o1026	g$result_messages	o1302	g$row	o1638	g$result_messages	o1660	g$id_message	o1681	g$row	o1693	g$date_heure	o1714	g$row	o1726	g$date_heure_fin	o1747	g$row	o1763	g$titre	o1813	g$row	o1822	g$texte	o1838	g$row	o1847	g$type	o1863	g$row	o1869	g$type	o1889	g$le_type	o1912	g$result_auteurs	o1947	g$row_auteur	o2138	g$result_auteurs	o2167	g$id_auteur	o2189	g$row_auteur	o2200	g$nom_auteur	o2229	g$row_auteur	o2241	g$email	o2264	g$row_auteur	o2273	g$id_auteur	o2304	g$id_utilisateur	o2318	g$titre	o2335	g$titre	o2344	g$nom_auteur	o2357	g$id_auteur	o2381	g$id_utilisateur	o2395	g$type	o2521	g$le_type	o2540	g!
 $type	o2587	g$le_type	o2610	g$titre	o2643	g$titre	o2722	g$date_heure	o2839	g$date_heure	o2883	g$date_heure_fin	o2903	g$date_heure	o2921	g$date_heure_fin	o2960	g$result_messages	o3122	g$row	o3452	g$result_messages	o3474	g$id_message	o3495	g$row	o3507	g$date_heure	o3528	g$row	o3540	g$titre	o3561	g$row	o3570	g$texte	o3586	g$row	o3595	g$type	o3611	g$row	o3617	g$type	o3637	g$le_type	o3660	g$result_auteurs	o3695	g$row_auteur	o3886	g$result_auteurs	o3915	g$id_auteur	o3937	g$row_auteur	o3948	g$nom_auteur	o3977	g$row_auteur	o3989	g$email	o4012	g$row_auteur	o4021	g$id_auteur	o4052	g$id_utilisateur	o4066	g$titre	o4083	g$titre	o4092	g$nom_auteur	o4105	g$id_auteur	o4129	g$id_utilisateur	o4143	g$type	o4269	g$le_type	o4288	g$type	o4335	g$le_type	o4358	g$titre	o4391	g$titre	o4470	g$date_heure	o4587	g$date_heure	o4631	g$titres	o4808	g$result_articles	o4827	g$row	o4939	g$result_articles	o4961	g$id_article	o4982	g$row	o4994	g$titre	o5015	g$row	o5041	g$titres	o5058	g$titre	o5070	g$date_heure	o!
 5079	g$row	o5093	g$nb_articles	o5108	g$date_heure	o5325	g$date_heure	o
5346	g$date_heure	o5366	g$date_heure	o5384	g$date_heure	o5403	g$date_heure	o5478	g$date_heure	o5499	g$date_heure	o5519	g$date_heure	o5537	g$date_heure	o5556	g$result_articles	o5723	g$row	o5837	g$result_articles	o5859	g$id_breve	o5880	g$row	o5890	g$titre	o5909	g$row	o5935	g$titres	o5952	g$titre	o5964	g$date_heure	o5973	g$row	o5987	g$nb_breves	o6008	g$date_heure	o6217	g$date_heure	o6238	g$date_heure	o6258	g$date_heure	o6276	g$date_heure	o6295	g$date_heure	o6370	g$date_heure	o6391	g$date_heure	o6411	g$date_heure	o6429	g$date_heure	o6448	g$nb_articles	o6619	g$nb_breves	o6634	g$nb_articles	o6657	g$titre_prop	o6675	g$nb_articles	o6725	g$nb_breves	o6744	g$titre_prop	o6760	g$nb_breves	o6807	g$titre	o6820	g$titre_prop	o6834	g$texte	o6955	g$titres	o6969	g$today	o7019	g$jour	o7044	g$today	o7052	g$mois	o7069	g$today	o7075	g$annee	o7091	g$today	o7098	g$mois	o7166	g$jour	o7172	g$annee	o7178	g$mois	o7241	g$jour	o7247	g$annee	o7253	g$result_messages	o7395	g$row	o7634	g$result_messages	o7656!
 	g$id_message	o7677	g$row	o7689	g$date_heure	o7710	g$row	o7722	g$titre	o7743	g$row	o7752	g$texte	o7768	g$row	o7777	g$type	o7793	g$row	o7799	g$type	o7819	g$le_type	o7842	g$result_auteurs	o7877	g$row_auteur	o8068	g$result_auteurs	o8097	g$id_auteur	o8119	g$row_auteur	o8130	g$nom_auteur	o8159	g$row_auteur	o8173	g$email	o8196	g$row_auteur	o8205	g$id_auteur	o8236	g$id_utilisateur	o8250	g$titre	o8267	g$nom_auteur	o8276	g$titre	o8294	g$id_auteur	o8313	g$id_utilisateur	o8327	g$query_forum	o8442	g$result_forum	o8572	g$query_forum	o8599	g$row_forum	o8620	g$result_forum	o8650	g$date_heure	o8671	g$row_forum	o8685	g$texte	o8714	g$row_forum	o8723	g$titre	o8747	g$row_forum	o8756	g$id_auteur	o8780	g$row_forum	o8793	g$result_auteurs2	o8822	g$row_auteur2	o8919	g$result_auteurs2	o8951	g$nom_auteur	o8975	g$row_auteur2	o8989	g$email	o9014	g$row_auteur2	o9023	g$titre	o9056	g$nom_auteur	o9065	g$titre	o9083	g$type	o9113	g$le_type	o9132	g$type	o9179	g$le_type	o9202	g$titre	o9235	g$titre	o9317	g$date!
 _heure	o9462	g$date_heure	o9483	g$date_heure	o9503	g$date_heure	o9521	
g$date_heure	o9540	g$date_heure	o9609	g$date_heure	o9630	g$date_heure	o9650	g$date_heure	o9668	g$date_heure	o9687	g$statut_utilisateur	o9870	g$query_forum	o9910	g$result_forum	o9976	g$query_forum	o10003	g$row	o10026	g$result_forum	o10048	g$nb_forum	o10067	g$id_forum	o10085	g$row	o10095	g$date_heure	o10115	g$row	o10129	g$titre	o10151	g$row	o10160	g$texte	o10177	g$row	o10186	g$auteur	o10203	g$row	o10213	g$email_auteur	o10231	g$row	o10247	g$email_auteur	o10275	g$email_auteur	o10290	g$date_heure	o10575	g$date_heure	o10596	g$date_heure	o10616	g$date_heure	o10634	g$date_heure	o10653	g$date_heure	o10723	g$date_heure	o10744	g$date_heure	o10764	g$date_heure	o10782	g$date_heure	o10801	g$date_heure	o10869	g$date_heure	o10890	g$date_heure	o10913	g$date_heure	o10931	g$date_heure	o10950	g$nb_forum	o11111	g$today	o11269	g$jour	o11295	g$today	o11303	g$mois	o11321	g$today	o11327	g$annee	o11344	g$today	o11351	g$mois	o11420	g$jour	o11426	g$annee	o11432	g$mois	o11496	g$jour	o11502	g$annee	o11508
ecrire/inc_auth_ldap.php3	d_ECRIRE_INC_AUTH_LDAP	o105	cAuth_ldap	o143	vuser_dn	o161	vnom	o176	minit	o230	mverifier_challenge_md5	o364	mverifier	o458	g$ldap_link	o493	g$ldap_base	o505	mlire	o1673	g$ldap_link	o1691	g$ldap_base	o1703	g$flag_utf8_decode	o1715	mactiver	o3420
ecrire/lang/public_fa.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_layer.php3	d_INC_LAYER	o93	fdebut_block_visible	o203	g$numero_block	o244	g$compteur_block	o259	g$browser_layer	o276	fdebut_block_invisible	o533	g$numero_block	o576	g$compteur_block	o591	g$browser_layer	o608	ffin_block	o1061	fbouton_block_invisible	o1174	g$numero_block	o1219	g$compteur_block	o1234	g$browser_layer	o1251	g$spip_lang_rtl	o1267	fbouton_block_visible	o2044	g$numero_block	o2086	g$compteur_block	o2101	g$browser_layer	o2118	g$spip_lang_rtl	o2134	fverif_butineur	o2934	g$HTTP_USER_AGENT	o2961	g$browser_name	o2979	g$browser_version	o2994	g$browser_description	o3020	g$browser_rev	o3042	g$browser_layer	o3056	g$browser_barre	o3072	fafficher_script_layer	o4848	ftest_layer	o4914	g$GLOBALS	o4982	g$GLOBALS	o5013
ecrire/inc_db_mysql.php3	d_ECRIRE_INC_DB_MYSQL	o104	fspip_query_db	o176	g$spip_mysql_link	o208	vtt	o235	fspip_mysql_select	o1623	ftraite_query	o2640	fspip_connect_db	o3494	g$spip_mysql_link	o3554	g$spip_mysql_db	o3572	fspip_fetch_array	o3819	fspip_sql_error	o4068	fspip_sql_errno	o4122	fspip_num_rows	o4176	fspip_free_result	o4246	fspip_insert	o4322	fspip_insert_id	o4467	fspip_get_lock	o4572	g$spip_mysql_db	o4616	g$table_prefix	o4632	fspip_release_lock	o4955	g$spip_mysql_db	o4989	g$table_prefix	o5005	fcalcul_mysql_in	o5280
backend-breves.php3	g$fond	o6	g$delais	o32	g$flag_preserver	o113
ecrire/inc_import.php3	d_ECRIRE_INC_IMPORT	o102	fxml_fetch_tag	o178	g$buf	o227	g$pos	o233	g$abs_pos	o239	vbuf_len	o258	fxml_parse_tag	o1061	fimport_debut	o1398	fimport_objet_1_2	o1857	g$import_ok	o1899	g$pos	o1911	g$abs_pos	o1917	vtime_javascript	o1936	vtables	o2092	fimport_objet_0_0	o5981	g$import_ok	o6023	g$pos	o6035	g$abs_pos	o6041	fimport_objet	o9296	fimport_fin	o9375	fimport_abandon	o9810	fimport_all	o10090	g$import_ok	o10126	g$meta	o10146	g$auth_htaccess	o10161	g$connect_id_auteur	o10185	faffiche_progression_javascript	o12475	g$affiche_progression_pourcent	o12526
spip_test_dirs.php3	d_TEST_DIRS	o48	ftest_ecrire	o211	g$test_dir	o593	g$test_dir	o624	g$test_dir	o636	g$test_dir	o670	g$test_dirs	o681	g$test_dirs	o694	g$test_dir	o709	g$test_dirs	o754	g$bad_dirs	o806	g$absent_dirs	o824	g$my_dir	o854	g$test_dirs	o870	g$my_dir	o903	g$my_dir	o947	g$my_dir	o969	g$my_dir	o1015	g$my_dir	o1036	g$my_dir	o1072	g$my_dir	o1093	g$my_dir	o1129	g$bad_dirs	o1143	g$my_dir	o1164	g$absent_dirs	o1185	g$my_dir	o1209	g$bad_dirs	o1228	g$absent_dirs	o1241	g$titre	o1306	g$continuer	o1342	g$titre	o1391	g$bad_url	o1430	g$test_dir	o1469	g$bad_url	o1480	g$test_dir	o1505	g$bad_dirs	o1681	g$bad_dirs	o1780	g$absent_dirs	o1847	g$absent_dirs	o1948	g$continuer	o2019
ecrire/inc_config_plug.php3	d_ECRIRE_INC_CONFIG_PLUG	o107	ffichiers_plugins	o152	finstaller_plugins	o618
ecrire/cartes.php3	g$link	o683	g$link	o721	g$link	o751	g$clean_link	o775	g$link	o845
ecrire/rubriques_edit.php3	fmySel	o40	fenfant	o183	g$id_parent	o210	g$id_rubrique	o230	g$connect_toutes_rubriques	o252	g$i	o287	g$couleur_claire	o299	g$spip_lang_left	o316	g$browser_name	o341	g$browser_version	o356	g$new	o2050	g$connect_statut	o2073	g$id_parent	o2122	g$id_parent	o2139	g$id_parent	o2159	g$id_rubrique	o2174	g$titre	o2194	g$onfocus	o2253	g$descriptif	o2328	g$texte	o2348	g$query	o2427	g$result	o2502	g$query	o2523	g$row	o2540	g$result	o2564	g$id_rubrique	o2578	g$row	o2593	g$id_parent	o2616	g$row	o2629	g$titre	o2650	g$row	o2659	g$descriptif	o2676	g$row	o2690	g$texte	o2712	g$row	o2721	g$id_secteur	o2738	g$row	o2752	g$extra	o2774	g$row	o2783	g$titre	o2858	g$id_parent	o2900	g$ze_logo	o2917	g$ze_logo	o2951	g$id_parent	o2986	g$logo_parent	o3003	g$query	o3048	g$result	o3130	g$query	o3149	g$row	o3165	g$result	o3187	g$parent_parent	o3200	g$row	o3215	g$parent_parent	o3242	g$logo_parent	o3263	g$logo_parent	o3302	g$id_parent	o3383	g$id_rubrique	o3609	g$ze_logo	o3691	g$ze_log!
 o	o3785	g$titre	o3966	g$id_rubrique	o4019	g$new	o4248	g$titre	o4319	g$titre	o4341	g$connect_toutes_rubriques	o4836	g$id_parent	o4892	g$id_parent	o5144	g$id_parent	o5396	g$query	o5529	g$row	o5614	g$query	o5649	g$contient_breves	o5659	g$row	o5678	g$contient_breves	o5695	g$scb	o5727	g$contient_breves	o5735	g$contient_breves	o5969	g$scb	o5996	g$options	o6072	g$descriptif	o6098	g$descriptif	o6298	g$descriptif	o6415	g$texte	o6596	g$champs_extra	o6632	g$extra	o6700	g$id_secteur	o6721
ecrire/spip_style.php3	g$lastmodified	o57	g$headers_only	o106	g$lastmodified	o141	g$headers_only	o183	g$regs	o382	g$couleur_claire	o399	g$couleur_foncee	o415	g$left	o431	g$right	o437	g$regs	o447	g$ltr	o456	g$left	o464	g$rtl	o484	g$right	o492	g$left	o520	g$_rtl	o537	g$_rtl	o556	g$couleur_claire	o621	g$couleur_claire	o642	g$couleur_foncee	o684	g$couleur_foncee	o705	fhttp_img_pack	o747	g$couleur_claire	o1080	g$couleur_foncee	o1177	g$couleur_foncee	o1234	g$left	o1289	g$couleur_claire	o1450	g$couleur_claire	o1685	g$couleur_claire	o1885	g$couleur_foncee	o2003	g$couleur_claire	o3500	g$right	o4048	g$left	o4087	g$ltr	o4249	g$ltr	o4516	g$left	o4617	g$_rtl	o4826	g$right	o4847	g$left	o4973	g$left	o5117	g$couleur_foncee	o5211	g$right	o5487	g$couleur_foncee	o5660	g$couleur_foncee	o6186	g$couleur_foncee	o7027	g$couleur_claire	o7964	g$couleur_foncee	o8801	g$couleur_foncee	o9920	g$couleur_claire	o9973	g$couleur_foncee	o10129	g$left	o10589	g$left	o10844	g$right	o11033	g$couleur_foncee	o11132	!
 g$right	o11285	g$left	o11677	g$couleur_foncee	o13262	g$couleur_foncee	o13386	g$couleur_foncee	o13542	g$couleur_claire	o13631	g$couleur_foncee	o13717	g$couleur_foncee	o13899	g$couleur_foncee	o13988	g$right	o17987	g$couleur_claire	o18020	g$left	o18094	g$couleur_claire	o18140	g$left	o18181	g$couleur_claire	o18213	g$right	o18339	g$couleur_claire	o18372	g$couleur_claire	o18853	g$couleur_foncee	o18941	g$couleur_foncee	o19517	g$couleur_claire	o19812	g$couleur_foncee	o19993	g$couleur_foncee	o20052	g$couleur_foncee	o20151	g$couleur_foncee	o20351	g$couleur_foncee	o20467	g$couleur_foncee	o20526	g$couleur_claire	o21040	g$left	o21304	g$couleur_claire	o21380	g$left	o21646	g$couleur_foncee	o21928	g$couleur_foncee	o22053	g$left	o22279	g$left	o22317	g$left	o22354	g$left	o22425	g$left	o22463	g$left	o22500	g$left	o22735	g$ltr	o22814	g$couleur_foncee	o23948	g$couleur_foncee	o24016	g$couleur_claire	o24099	g$couleur_foncee	o24140	g$couleur_foncee	o24192	g$right	o24439	g$left	o24661	g$left	o24711!
 	g$right	o25814	g$couleur_foncee	o25867	g$couleur_foncee	o25926	g$coul
eur_foncee	o25983	g$couleur_foncee	o26041	g$_rtl	o26124	g$right	o26146	g$right	o26290	g$couleur_foncee	o26343	g$couleur_foncee	o26402	g$couleur_foncee	o26459	g$couleur_foncee	o26517	g$_rtl	o26601	g$right	o26623	g$left	o26878	g$left	o26969	g$couleur_foncee	o27114	g$couleur_foncee	o27375	g$left	o28220	g$right	o28391	g$right	o28441	g$couleur_foncee	o28746	g$left	o28987	g$right	o29024	g$left	o29234	g$left	o29272	g$left	o29309	g$left	o29407	g$right	o29882	g$left	o29949	g$right	o29985
ecrire/js_menu_rubriques.php	g$expire	o69	g$date	o79	g$headers_only	o97	g$expire	o132	g$date	o143	g$date	o176	g$expire	o184	g$expire	o219	g$headers_only	o276	g$date	o324	g$expire	o360	fextraire_article	o387	fgen_liste_rubriques	o556	fbandeau_menu	o957	g$spip_ecran	o982	fbandeau_rubrique	o1954	g$zdecal	o2020	g$spip_ecran	o2037	g$spip_display	o2050	g$spip_lang	o2073	g$spip_lang_rtl	o2085	g$spip_lang_left	o2101	g$spip_lang_right	o2118
ecrire/forum_admin.php3	g$admin	o7
ecrire/index.php3	g$HTTP_REFERER	o73	g$HTTP_REFERER	o98	g$bonjour	o133	g$spip_display	o233	g$titre_cadre	o344	g$titre_cadre	o425	g$connect_nom	o457	g$titre_cadre	o561	g$connect_statut	o681	g$cookie_admin	o716	g$texte	o735	g$spip_display	o780	g$texte	o800	g$texte	o847	g$nom_site_spip	o961	g$nom_site_spip	o1015	g$nom_site_spip	o1031	g$nom_site_spip	o1145	g$spip_display	o1169	g$logo	o1231	g$logo	o1269	g$logo	o1374	g$query	o1448	g$res	o1528	g$query	o1546	g$row	o1566	g$res	o1590	g$var	o1603	g$row	o1621	g$var	o1642	g$row	o1649	g$nb_art_prepa	o1675	g$nb_art_prop	o1692	g$nb_art_publie	o1708	g$nb_art_prepa	o1896	g$nb_art_prepa	o1966	g$nb_art_prop	o1987	g$nb_art_prop	o2056	g$nb_art_publie	o2076	g$nb_art_publie	o2139	g$query	o2184	g$res	o2261	g$query	o2279	g$row	o2296	g$res	o2320	g$var	o2331	g$row	o2349	g$var	o2368	g$row	o2375	g$nb_bre_prop	o2398	g$nb_bre_publie	o2414	g$nb_bre_prop	o2595	g$nb_bre_prop	o2664	g$nb_bre_publie	o2684	g$nb_bre_publie	o2747	g$query	o2791	g$result	o2865	g$quer!
 y	o2903	g$nb_forum	o2914	g$result	o2926	g$nb_forum	o2948	g$connect_statut	o2967	g$nb_forum	o3196	g$query	o3235	g$res	o3313	g$query	o3331	g$row	o3348	g$res	o3372	g$var	o3383	g$row	o3401	g$var	o3420	g$row	o3427	g$nb_aut_0minirezo	o3450	g$nb_aut_1comite	o3471	g$nb_aut_6forum	o3490	g$nb_aut_0minirezo	o3671	g$nb_aut_0minirezo	o3734	g$nb_aut_1comite	o3759	g$nb_aut_1comite	o3815	g$nb_aut_6forum	o3838	g$nb_aut_6forum	o3892	g$today	o4411	g$jour_today	o4439	g$today	o4453	g$mois_today	o4471	g$today	o4485	g$annee_today	o4502	g$today	o4517	g$date	o4535	g$mois_today	o4570	g$annee_today	o4586	g$mois	o4604	g$date	o4617	g$annee	o4627	g$date	o4642	g$jour	o4652	g$date	o4665	g$result_messages	o4718	g$result_messages	o5163	g$mois_today	o5233	g$annee_today	o5246	g$jour_today	o5260	g$mois_today	o5273	g$annee_today	o5286	g$result_messages	o5348	g$result_messages	o5844	g$jour_today	o5910	g$mois_today	o5922	g$annee_today	o5934	g$meta	o6024	g$archive	o6117	g$meta	o6128	g$my_pos	o6160	g$meta	o6170	g$o!
 k	o6201	g$archive	o6220	g$ok	o6237	g$archive	o6264	g$affiche_progressi
on_pourcent	o6280	g$taille	o6322	g$my_pos	o6349	g$affiche_progression_pourcent	o6375	g$archive	o6416	g$taille	o6430	g$my_pos	o6452	g$affiche_progression_pourcent	o6462	g$texte_boite	o6505	g$texte_boite	o6799	g$gz	o7070	g$flag_gz	o7076	g$_fopen	o7087	g$gz	o7098	g$ok	o7127	g$f	o7136	g$_fopen	o7141	g$archive	o7149	g$pos	o7168	g$buf	o7180	g$f	o7209	g$gz	o7213	g$post_dates	o7334	g$post_dates	o7378	g$connect_statut	o7403	g$options	o7438	g$vos_articles	o7646	g$vos_articles	o7931	g$vos_articles	o7946	g$vos_articles	o8003	g$spip_display	o8129	g$query	o8173	g$result	o8235	g$query	o8256	g$result	o8286	g$activer_breves	o8415	g$activer_breves	o8468	g$connect_statut	o8623	g$connect_statut	o8739	g$connect_toutes_rubriques	o8774	g$query	o8950	g$result	o9013	g$query	o9034	g$gadget	o9045	g$result	o9082	g$id_rubrique	o9101	g$GLOBALS	o9116	g$id_rubrique	o9148	g$dans_rub	o9172	g$dans_parent	o9217	g$gadget	o9267	g$connect_statut	o9307	g$gadget	o9345	g$gadget	o9368	g$gadget	o9500	g$gadget	o9532	g$!
 gadget	o9554	g$gadget	o9691	g$activer_breves	o9718	g$activer_breves	o9772	g$gadget	o9804	g$gadget	o9827	g$gadget	o9961	g$connect_statut	o10044	g$gadget	o10118	g$gadget	o10142	g$gadget	o10276	g$gadget	o10318	g$gadget	o10364	g$connect_statut	o10381	g$gadget	o10419	g$nombre_articles	o10456	g$nombre_articles	o10681	g$gadget	o10708	g$gadget	o10730	g$gadget	o10842	g$activer_breves	o10870	g$activer_breves	o10921	g$gadget	o10951	g$gadget	o10973	g$gadget	o11069	g$articles_mots	o11097	g$articles_mots	o11148	g$gadget	o11178	g$gadget	o11200	g$gadget	o11305	g$activer_sites	o11332	g$activer_sites	o11383	g$gadget	o11411	g$gadget	o11433	g$gadget	o11543	g$gadget	o11569	g$gadget	o11618	g$connect_statut	o11674	g$spip_display	o11709	g$cookie_admin	o11737	g$relief	o12364	g$relief	o12387	g$query	o12399	g$result	o12504	g$query	o12525	g$relief	o12535	g$result	o12560	g$relief	o12583	g$query	o12595	g$result	o12671	g$query	o12692	g$relief	o12702	g$result	o12727	g$relief	o12750	g$query	o12803	g$result!
 	o12880	g$query	o12901	g$relief	o12911	g$result	o12936	g$relief	o12959
	g$connect_statut	o13012	g$connect_toutes_rubriques	o13047	g$query	o13077	g$result	o13158	g$query	o13179	g$relief	o13189	g$result	o13214	g$relief	o13237	g$query	o13611	g$query	o13785	g$connect_statut	o14184	g$connect_toutes_rubriques	o14219	g$connect_statut	o14527	g$connect_toutes_rubriques	o14562	g$result	o14593	g$row	o14699	g$result	o14723	g$row	o14737	g$row	o14801	g$connect_statut	o14947	g$connect_toutes_rubriques	o14982	g$result	o15013	g$row	o15108	g$result	o15132	g$row	o15146	g$row	o15217	g$row	o15240	g$options	o15525	g$maj_alea	o16392	g$meta_maj	o16404	g$t_jour	o16432	g$maj_alea	o16449	g$t_jour	o16475	g$alea	o16541	g$alea	o16666	g$bonjour	o16755	g$optimiser	o16772	g$lock	o16871	g$lock	o16937	g$lock	o16964	g$lock	o17077
ecrire/admin_repair.php3	g$connect_statut	o411	fverifier_base	o453	g$res1	o1317	g$message	o1357	g$tab	o1411	g$res1	o1435	g$version_mysql	o1444	g$tab	o1461	g$version_mysql	o1475	g$message	o1505	g$version_mysql	o1566	g$message	o1594	g$ok	o1638	g$action	o1656	g$ok	o1702	g$action	o1722	g$message	o1731	g$action	o2059
ecrire/articles_page.php3	g$query	o168	g$result	o229	g$query	o250	g$result	o278	g$connect_statut	o458
ecrire/admin_index.php3	g$connect_statut	o234	g$connect_toutes_rubriques	o269	g$forcer_indexation	o394	g$forcer_indexation	o422	g$forcer_indexation	o470	g$forcer_reindexation	o496	g$purger	o559	g$types	o1198	g$type	o1301	g$types	o1315	g$table	o1327	g$type	o1356	g$table_index	o1365	g$type	o1406	g$critere	o1415	g$type	o1445	g$mise_a_jour	o1534	g$vus	o1552	g$s	o1563	g$t	o1636	g$s	o1658	g$vus	o1666	g$t	o1676	g$vus	o1689	g$s	o1801	g$t	o1889	g$s	o1911	g$indexes	o1920	g$type	o1929	g$t	o1936	g$t	o1945	g$index_total	o1954	g$type	o1967	g$t	o1977	fjauge	o2023	g$types	o2175	g$type	o2197	g$types	o2211	g$index_total	o2224	g$type	o2237	g$ifond	o2257	g$ifond	o2274	g$couleur	o2289	g$ifond	o2333	g$couleur	o2348	g$type	o2533	g$a	o2577	g$indexes	o2592	g$type	o2601	g$index_total	o2615	g$type	o2628	g$b	o2653	g$indexes	o2667	g$type	o2676	g$index_total	o2690	g$type	o2703	g$a	o2732	g$b	o2735
ecrire/breves_edit.php3	fmySel	o113	fenfant	o257	g$id_parent	o285	g$id_rubrique	o305	g$spip_lang_left	o327	g$id_breve	o1060	g$id_breve	o1079	g$new	o1095	g$query	o1113	g$result	o1179	g$query	o1200	g$row	o1216	g$result	o1238	g$id_breve	o1252	g$row	o1262	g$date_heure	o1282	g$row	o1294	g$titre	o1316	g$row	o1323	g$texte	o1340	g$row	o1347	g$lien_titre	o1364	g$row	o1376	g$lien_url	o1398	g$row	o1408	g$statut	o1428	g$row	o1436	g$id_rubrique	o1454	g$row	o1467	g$id_secteur	o1490	g$id_rubrique	o1502	g$extra	o1518	g$row	o1527	g$pour_doublons	o1544	g$titre	o1600	g$onfocus	o1655	g$statut	o1729	g$id_document	o1754	g$query_doc	o1771	g$result_doc	o1878	g$query_doc	o1903	g$flag_document_editable	o1917	g$result_doc	o1958	g$flag_document_editable	o1987	g$modif_document	o2024	g$GLOBALS	o2042	g$modif_document	o2074	g$flag_document_editable	o2103	g$titre_document	o2131	g$titre_document	o2180	g$descriptif_document	o2200	g$descriptif_document	o2254	g$titre	o2474	g$id_rubrique	o2552	g$new	o2607	g$conn!
 ect_statut	o2626	g$statut	o2658	g$id_breve	o2705	g$new	o2782	g$titre	o3166	g$connect_statut	o3224	g$statut	o3256	g$new	o3275	g$id_breve	o3297	g$lien	o3308	g$new	o3625	g$titre	o3697	g$titre	o3719	g$lien_titre	o3729	g$lien_titre	o3756	g$id_rubrique	o4017	g$logo_parent	o4036	g$query	o4083	g$result	o4167	g$query	o4186	g$row	o4203	g$result	o4225	g$parent_parent	o4239	g$row	o4254	g$parent_parent	o4283	g$logo_parent	o4304	g$logo_parent	o4344	g$spip_ecran	o4652	g$rows	o4676	g$rows	o4694	g$GLOBALS	o4845	g$texte	o4929	g$lien_url	o5165	g$lien_url	o5181	g$champs_extra	o5329	g$extra	o5397	g$id_secteur	o5415	g$connect_statut	o5438	g$id_rubrique	o5486	g$statut	o5667	g$statut	o5778	g$statut	o5899
oo/index.php
spip_cache.php3	g$purger_cache	o150	g$hash	o220	g$id_auteur	o227	g$purger_squelettes	o265	g$hash	o345	g$id_auteur	o352	g$redirect	o411
ecrire/lang/spip_vi.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/brouteur_frame.php3	g$spip_ecran	o50	g$nb_col	o78	g$nb_col	o103	g$effacer_suivant	o125	g$i	o161	g$frame	o166	g$i	o176	g$nb_col	o181	g$i	o190	g$special	o331	g$query	o356	g$result	o654	g$query	o673	g$result	o702	g$row	o886	g$result	o908	g$id_article	o923	g$row	o935	g$titre	o959	g$row	o973	g$statut	o993	g$row	o1003	g$special	o1185	g$query	o1212	g$result	o1376	g$query	o1395	g$result	o1424	g$row	o1612	g$result	o1634	g$id_article	o1649	g$row	o1661	g$titre	o1685	g$row	o1699	g$statut	o1719	g$row	o1729	g$query	o1900	g$result	o1999	g$query	o2018	g$result	o2047	g$row	o2211	g$result	o2233	g$id_breve	o2248	g$row	o2258	g$titre	o2280	g$row	o2294	g$statut	o2314	g$row	o2324	g$puce	o2344	g$query	o2541	g$result	o2630	g$query	o2649	g$row	o2664	g$result	o2686	g$ze_rubrique	o2700	g$row	o2713	g$titre	o2737	g$row	o2751	g$id_parent	o2770	g$row	o2781	g$id_parent	o2811	g$icone	o2828	g$icone	o2863	g$frame	o3131	g$query	o3383	g$result	o3470	g$query	o3489	g$row	o3506	g$result	o3528	g$ze_rubrique	o!
 3542	g$row	o3555	g$titre	o3579	g$row	o3593	g$id_parent	o3612	g$row	o3623	g$id_parent	o3810	g$frame	o3979	g$frame	o4029	g$frame	o4084	g$nb_col	o4095	g$frame	o4253	g$frame	o4303	g$id_rubrique	o4570	g$connect_statut	o4597	g$query	o4629	g$query	o4790	g$result	o5189	g$query	o5208	g$result	o5238	g$row	o5420	g$result	o5442	g$id_article	o5458	g$row	o5470	g$titre	o5495	g$row	o5509	g$statut	o5530	g$row	o5540	g$query	o5716	g$result	o5825	g$query	o5844	g$result	o5874	g$row	o6036	g$result	o6058	g$id_breve	o6074	g$row	o6084	g$titre	o6107	g$row	o6121	g$statut	o6142	g$row	o6152	g$statut	o6181	g$puce	o6220	g$puce	o6279	g$puce	o6338	g$puce	o6398	g$puce	o6459	g$puce	o6505	g$query	o6701	g$result	o6814	g$query	o6833	g$result	o6863	g$row	o6993	g$result	o7015	g$id_syndic	o7031	g$row	o7042	g$titre	o7066	g$row	o7080	g$statut	o7104	g$row	o7114	g$statut	o7143	g$puce	o7182	g$puce	o7241	g$puce	o7300	g$puce	o7360	g$puce	o7421	g$frame	o7772	g$id_rubrique	o7788	g$query	o7812	g$result	o8111	g$query	o8130	g!
 $result	o8160	g$frame	o8426	g$frame	o8476	g$query	o8546	g$result	o8711
	g$query	o8732	g$total_articles	o8744	g$result	o8776	g$query	o8793	g$result	o8893	g$query	o8912	g$total_breves	o8924	g$result	o8954	g$total_articles	o8975	g$total_breves	o8993	g$frame	o9274	g$frame	o9324
ecrire/lang/public_es.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_oc_lnc.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/public_fon.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/info.php3	g$connect_statut	o98
inc-html-squel.php3	d_INC_HTML_SQUEL	o96	fparser_inclure	o1260	fparser_champs	o1999	fparser_champs_etendus	o2993	fparser_champs_exterieurs	o3223	fparser_champs_interieurs	o3582	fparser_param	o4590	fparser	o6168
inc-formulaire_ecrire_auteur.php3	g$balise_FORMULAIRE_ECRIRE_AUTEUR_collecte	o14	g$balise_FORMULAIRE_ECRIRE_AUTEUR_collecte	o58	fbalise_FORMULAIRE_ECRIRE_AUTEUR_stat	o246	fbalise_FORMULAIRE_ECRIRE_AUTEUR_dyn	o464	g$spip_lang_rtl	o554
ecrire/mots_edit.php3	fmySel	o151	g$connect_statut	o319	g$supp_mot	o358	g$query	o373	g$result	o432	g$query	o453	g$query	o464	g$result	o532	g$query	o553	g$titre_mot	o571	g$new	o591	g$id_groupe	o608	g$id_mot	o626	g$ajouter_id_article	o747	g$ajouter_id_article	o784	g$titre_mot	o924	g$titre_mot	o948	g$texte	o963	g$texte	o983	g$descriptif	o994	g$descriptif	o1019	g$type	o1035	g$type	o1074	g$result	o1085	g$row	o1177	g$result	o1201	g$type	o1214	g$row	o1253	g$champs_extra	o1311	g$add_extra	o1368	g$add_extra	o1451	g$query	o1471	g$result	o1635	g$query	o1656	g$id_mot	o1765	g$new	o1792	g$titre_mot	o1816	g$titre	o1829	g$titre_mot	o1842	g$onfocus	o1900	g$redirect_ok	o2021	g$redirect	o2046	g$redirect	o2093	g$query	o2139	g$result	o2198	g$query	o2219	g$row	o2233	g$result	o2257	g$id_mot	o2270	g$row	o2280	g$titre_mot	o2297	g$row	o2310	g$descriptif	o2326	g$row	o2340	g$texte	o2361	g$row	o2370	g$type	o2386	g$row	o2394	g$extra	o2409	g$row	o2418	g$id_groupe	o2434	g$row	o2447	g$id_mot	o2638	g$id_mot	!
 o2922	g$new	o2979	g$adresse_retour	o2997	g$adresse_retour	o3094	g$arton	o3266	g$artoff	o3291	g$id_mot	o3323	g$connect_statut	o3339	g$arton	o3392	g$artoff	o3400	g$connect_statut	o3660	g$titre_mot	o4069	g$descriptif	o4088	g$descriptif	o4279	g$texte	o4396	g$texte	o4480	g$id_mot	o4515	g$connect_statut	o4545	g$aff_articles	o4579	g$aff_articles	o4639	g$connect_statut	o5613	g$id_mot	o5776	g$new	o5859	g$titre_mot	o6153	g$titre_mot	o6179	g$descriptif	o6193	g$descriptif	o6220	g$texte	o6235	g$texte	o6257	g$query_groupes	o6489	g$result	o6557	g$query_groupes	o6578	g$result	o6614	g$row_groupes	o6815	g$result	o6847	g$groupe	o6861	g$row_groupes	o6871	g$titre_groupe	o6901	g$row_groupes	o6951	g$groupe	o7002	g$id_groupe	o7011	g$row_groupes	o7114	g$result	o7146	g$row_groupes	o7163	g$row_groupes	o7262	g$row_groupes	o7627	g$options	o7668	g$descriptif	o7694	g$descriptif	o7853	g$options	o7980	g$texte	o8006	g$texte	o8153	g$champs_extra	o8265	g$extra	o8333	g$id_groupe	o8349
ecrire/inc_extra.php3	d_ECRIRE_INC_EXTRA	o1442	fextra_saisie	o1542	fextra_recup_saisie	o3734	fextra_filtres	o4071	fextra_champ_valide	o4352	fextra_affichage	o4520
ecrire/lang/public_bg.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_charsets.php3	d_ECRIRE_INC_CHARSETS	o104	fload_charset	o235	ftest_iconv	o60449	viconv_ok	o60473	ftest_pcre_unicode	o60829	vpcre_ok	o60860	fpcre_lettres_unicode	o61102	vplage_unicode	o61136	fplage_punct_unicode	o61566	fhtml2unicode	o61695	vtrans	o61727	g$CHARSET	o61759	fmathml2unicode	o62086	vtrans	o62120	g$CHARSET	o62152	fcharset2unicode	o62512	g$flag_multibyte	o62580	vtrans	o62606	g$CHARSET	o63954	funicode2charset	o64449	vCHARSET_REVERSE	o64501	fimporter_charset	o65729	futf_8_to_unicode	o65862	vdecrement	o65899	vshift	o65919	futf_32_to_unicode	o68104	fcaractere_utf_8	o69181	funicode_to_utf_8	o69526	funicode_to_javascript	o69754	fjavascript_to_unicode	o70061	fjavascript_to_binary	o70343	ftranslitteration	o70647	vtrans	o70714	g$CHARSET	o71041	ftranslitteration_complexe	o71715	g$GLOBALS	o71825
ecrire/lang/public_nl.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/statistiques_lang.php3	g$spip_ecran	o112	g$largeur_table	o140	g$largeur_table	o174	g$taille	o201	g$largeur_table	o211	g$GLOBALS	o498	g$critere	o533	g$critere	o613	g$critere	o696	g$connect_statut	o815	fenfants	o950	g$nombre_vis	o979	g$total_vis	o1000	g$nombre_abs	o1020	g$critere	o1041	g$total_vis	o1693	g$total_vis	o1707	g$query	o1765	g$critere	o1788	g$result	o1840	g$query	o1861	g$visites	o1872	g$row	o1892	g$result	o1916	g$total_visites	o1929	g$row	o1946	g$total_visites	o1979	g$query	o2017	g$critere	o2046	g$result	o2124	g$query	o2145	g$ifond	o2271	g$row	o2295	g$result	o2319	g$lang	o2334	g$row	o2342	g$visites	o2359	g$row	o2376	g$total_visites	o2390	g$taille	o2407	g$visites	o2428	g$ifond	o2453	g$ifond	o2470	g$couleur	o2485	g$ifond	o2519	g$couleur	o2534	g$dir	o2601	g$lang	o2615	g$lang	o2808	g$taille	o2960	g$visites_abs	o3124	g$visites	o3233	g$visites_abs	o3448	g$visites	o3464
inc-menu_lang_ecrire.php3	g$balise_MENU_LANG_ECRIRE_collecte	o14	g$balise_MENU_LANG_ECRIRE_collecte	o49	fbalise_MENU_LANG_ECRIRE_stat	o191	fbalise_MENU_LANG_ECRIRE_dyn	o398	fmenu_lang_pour_tous	o616
spip_image_reduite.php3	g$img	o7	g$_GET	o14	g$logo	o28	g$img	o36	g$taille_y	o153	g$taille_y	o165	g$taille_x	o177	g$logo	o224	g$regs	o231	g$i	o246	g$regs	o272	g$regs	o288	g$hash	o362	g$hash_id_auteur	o369	g$dir	o397	g$nom	o402	g$format	o407	g$i	o418	g$logo	o424	g$dir	o432	g$nom	o439	g$format	o452	g$suffixe	o502	g$taille_x	o517	g$taille_y	o531	g$preview	o544	g$logo	o570	g$taille_x	o577	g$taille_y	o588	g$format	o599	g$suffixe	o616	g$nom	o627	g$suffixe	o632	g$preview	o649	g$vignette	o664	g$preview	o676	g$width	o700	g$preview	o709	g$height	o731	g$preview	o741	g$retour	o932	g$vignette	o942	g$taille_origine	o968	g$logo	o1000	g$retour	o1125	g$logo	o1135	g$retour	o1298
ecrire/articles.php3	g$articles_surtitre	o181	g$articles_soustitre	o234	g$articles_descriptif	o289	g$articles_urlref	o346	g$articles_chapeau	o395	g$articles_ps	o446	g$articles_redac	o487	g$articles_mots	o534	g$articles_versions	o579	g$flag_revisions	o643	g$id_article	o665	g$new	o688	g$id_rubrique	o705	g$id_rubrique	o727	g$titre	o748	g$titre	o760	g$langue_new	o795	g$result_lang_rub	o815	g$row	o918	g$result_lang_rub	o942	g$langue_new	o964	g$row	o978	g$langue_new	o1000	g$langue_new	o1013	g$langue_choisie_new	o1055	g$forums_publics	o1087	g$id_article	o1149	g$clean_link	o1634	g$query	o1808	g$result	o1902	g$query	o1923	g$row	o1936	g$result	o1960	g$statut_article	o1973	g$row	o1991	g$titre_article	o2008	g$row	o2025	g$rubrique_article	o2041	g$row	o2061	g$statut_article	o2092	g$query	o2117	g$result_auteur	o2227	g$query	o2255	g$flag_auteur	o2265	g$result_auteur	o2295	g$flag_editable	o2317	g$rubrique_article	o2350	g$flag_auteur	o2374	g$statut_article	o2392	g$statut_article	o2422	g$statu!
 t_article	o2451	g$modif_document	o2559	g$GLOBALS	o2577	g$modif_document	o2609	g$flag_editable	o2638	g$titre_document	o2657	g$titre_document	o2706	g$descriptif_document	o2726	g$descriptif_document	o2780	g$query	o2805	g$largeur_document	o2907	g$hauteur_document	o2929	g$query	o2948	g$query	o3021	g$query	o3078	g$suivi_edito	o3129	g$ok_nouveau_statut	o3171	g$statut_nouv	o3205	g$rubrique_article	o3241	g$ok_nouveau_statut	o3261	g$flag_auteur	o3298	g$statut_nouv	o3320	g$statut_article	o3347	g$ok_nouveau_statut	o3378	g$statut_nouv	o3416	g$statut_article	o3444	g$ok_nouveau_statut	o3478	g$ok_nouveau_statut	o3513	g$query	o3537	g$result	o3627	g$query	o3648	g$statut_nouv	o3664	g$statut_nouv	o3693	g$statut_article	o3709	g$statut_ancien	o3812	g$statut_article	o3829	g$statut_article	o3914	g$statut_nouv	o3932	g$flag_editable	o3948	g$rubrique_article	o3981	g$flag_auteur	o4007	g$statut_article	o4025	g$statut_article	o4055	g$ok_nouveau_statut	o4120	g$statut_nouv	o4143	g$statut_nouv	o4172	g$stat!
 ut_ancien	o4188	g$id_article	o4302	g$ok_nouveau_statut	o4361	g$statut_
ancien	o4384	g$statut_nouv	o4415	g$statut_ancien	o4431	g$invalider_caches	o4450	g$jour	o4570	g$flag_editable	o4579	g$annee	o4602	g$mois	o4620	g$mois	o4639	g$jour	o4654	g$query	o4669	g$result	o4762	g$query	o4783	g$jour_redac	o4822	g$flag_editable	o4837	g$annee_redac	o4860	g$annee_redac	o4881	g$annee_redac	o4902	g$mois_redac	o4930	g$jour_redac	o4951	g$avec_redac	o4977	g$annee_redac	o5000	g$mois_redac	o5025	g$jour_redac	o5047	g$query	o5072	g$result	o5189	g$query	o5210	g$flag_editable	o5307	g$row	o5326	g$langue_parent	o5435	g$row	o5452	g$changer_lang	o5472	g$changer_lang	o5495	g$changer_lang	o5580	g$langue_parent	o5718	g$query	o5839	g$result	o6008	g$query	o6029	g$row	o6045	g$result	o6067	g$ze_doc	o6079	g$row	o6089	g$ze_doc	o6123	g$ze_docs	o6137	g$ze_doc	o6153	g$nb_texte	o6316	g$nb_texte	o6338	g$varname	o6410	g$texte_plus	o6440	g$varname	o6455	g$texte_plus	o6515	g$texte_plus	o6531	g$texte_plus	o6588	g$texte_ajout	o6604	g$texte_plus	o6624	g$texte	o6661	g$texte_ajout	o6670	g$texte	!
 o6685	g$changer_virtuel	o6722	g$flag_editable	o6742	g$virtuel	o6761	g$virtuel	o6808	g$virtuel	o6825	g$chapo	o6835	g$chapo	o6896	g$query	o6910	g$result	o6992	g$query	o7013	g$titre	o7029	g$ajout_forum	o7040	g$flag_editable	o7056	g$champs	o7075	g$champs_version	o7189	g$champs	o7226	g$nom_champ	o7237	g$t	o7253	g$champs_versions	o7258	g$nom_champ	o7275	g$nom_champ	o7310	g$nom_champ	o7326	g$t	o7350	g$champs_extra	o7397	g$add_extra	o7452	g$id_secteur	o7521	g$add_extra	o7550	g$flag_auteur	o7632	g$id_rubrique	o7663	g$change_rubrique	o7682	g$change_rubrique	o7746	g$articles_versions	o7849	g$new	o7910	g$query	o7988	g$query	o8109	g$select	o8125	g$champs	o8146	g$query	o8160	g$champs_originaux	o8239	g$query	o8287	g$id_version	o8301	g$id_article	o8331	g$champs_originaux	o8344	g$id_version	o8464	g$query	o8650	g$result	o8918	g$query	o8939	g$statut_article	o9004	g$invalider_caches	o9041	g$id_article	o9265	g$articles_versions	o9318	g$id_article	o9358	g$champs_versions	o9371	g$id_rubrique	o942!
 9	g$id_rubrique_old	o9445	g$row	o9467	g$langue_old	o9585	g$row	o9599	g
$langue_choisie_old	o9615	g$row	o9637	g$langue_choisie_old	o9668	g$row	o9703	g$langue_new	o9809	g$row	o9823	g$langue_new	o9844	g$langue_old	o9859	g$titre_article	o10028	g$titre	o10058	g$id_article_bloque	o10260	g$id_article	o10281	fget_forums_publics	o10416	g$query	o10872	g$result	o10943	g$query	o10964	g$row	o10978	g$result	o11002	g$id_article	o11015	g$row	o11029	g$surtitre	o11050	g$row	o11062	g$titre	o11081	g$row	o11090	g$soustitre	o11106	g$row	o11119	g$id_rubrique	o11139	g$row	o11154	g$descriptif	o11176	g$row	o11190	g$nom_site	o11211	g$row	o11223	g$url_site	o11242	g$row	o11254	g$chapo	o11273	g$row	o11282	g$texte	o11298	g$row	o11307	g$ps	o11323	g$row	o11329	g$date	o11342	g$row	o11350	g$statut_article	o11365	g$row	o11383	g$maj	o11400	g$row	o11407	g$date_redac	o11421	g$row	o11435	g$visites	o11456	g$row	o11467	g$referers	o11485	g$row	o11497	g$extra	o11516	g$row	o11525	g$id_trad	o11541	g$row	o11552	g$id_version	o11570	g$row	o11584	g$virtuel	o11644	g$chapo	o11666	g$virtuel	o1169!
 1	g$chapo	o11709	g$date_redac	o11769	g$regs	o11782	g$mois_redac	o11800	g$regs	o11814	g$jour_redac	o11832	g$regs	o11846	g$annee_redac	o11864	g$regs	o11879	g$annee_redac	o11901	g$annee_redac	o11922	g$date	o11992	g$regs	o11999	g$mois	o12017	g$regs	o12025	g$jour	o12043	g$regs	o12051	g$annee	o12069	g$regs	o12078	g$id_rubrique	o12207	g$id_article	o12637	g$statut_article	o12650	g$connect_statut	o12673	g$id_rubrique	o12721	g$query	o12739	g$row	o12866	g$query	o12901	g$nb_forums	o12915	g$row	o12928	g$nb_forums	o12949	g$nb_forums	o13029	g$activer_statistiques	o13131	g$connect_statut	o13195	g$statut_article	o13230	g$visites	o13262	g$activer_statistiques	o13279	g$options	o13314	g$visites	o13407	g$articles_versions	o13513	g$id_version	o13536	g$options	o13554	g$js_ortho	o13790	g$js_ortho	o14048	g$arton	o14125	g$artoff	o14154	g$id_article	o14190	g$flag_editable	o14208	g$arton	o14245	g$artoff	o14253	g$options	o14367	g$connect_statut	o14393	g$flag_editable	o14425	g$visible	o14502	g$change_ac!
 cepter_forum	o14513	g$change_petition	o14539	g$visible	o14636	g$visibl
e	o14816	g$forums_publics	o15017	g$id_article	o15054	g$change_accepter_forum	o15074	g$query_forum	o15102	g$result_forum	o15218	g$query_forum	o15245	g$forums_publics	o15262	g$change_accepter_forum	o15280	g$change_accepter_forum	o15310	g$forums_publics	o15599	g$forums_publics	o16036	g$forums_publics	o16465	g$forums_publics	o16902	g$change_petition	o17507	g$change_petition	o17533	g$email_unique	o17569	g$email_unique	o17584	g$site_obli	o17615	g$site_obli	o17627	g$site_unique	o17655	g$site_unique	o17669	g$message	o17699	g$message	o17709	g$texte_petition	o17731	g$texte_petition	o17760	g$query_pet	o17782	g$result_pet	o17998	g$query_pet	o18023	g$change_petition	o18051	g$query_pet	o18083	g$result_pet	o18158	g$query_pet	o18183	g$query_petition	o18205	g$result_petition	o18285	g$query_petition	o18315	g$petition	o18334	g$result_petition	o18361	g$row	o18394	g$result_petition	o18418	g$id_rubrique	o18441	g$row	o18454	g$email_unique	o18476	g$row	o18490	g$site_obli	o18514	g$row	o18525	g$site_!
 unique	o18546	g$row	o18559	g$message	o18582	g$row	o18591	g$texte_petition	o18610	g$row	o18626	g$petition	o18777	g$query_signatures	o18969	g$result	o19066	g$query_signatures	o19104	g$result	o19131	g$result	o19235	g$email_unique	o19317	g$site_obli	o19625	g$site_unique	o19906	g$message	o20207	g$texte_petition	o20623	g$petition	o20851	g$visible	o21525	g$changer_virtuel	o21537	g$virtuel	o21557	g$visible	o21647	g$visible	o21844	g$virtuelhttp	o22165	g$virtuel	o22181	g$vos_articles	o22756	g$vos_articles	o23089	g$row	o23320	g$vos_articles	o23344	g$ze_article	o23366	g$row	o23380	g$ze_titre	o23404	g$row	o23421	g$ze_statut	o23441	g$row	o23454	g$options	o23483	g$numero	o23514	g$id_article	o24000	fmySel	o24067	fmy_sel	o24210	fafficher_mois	o24363	fafficher_annee	o24910	fafficher_jour	o25204	g$logo_statut	o25433	g$statut_article	o25468	g$surtitre	o25622	g$surtitre	o25711	g$titre	o25767	g$logo_statut	o25775	g$soustitre	o25795	g$soustitre	o25885	g$descriptif	o25936	g$url_site	o25951	g$nom_s!
 ite	o25964	g$texte_case	o26156	g$descriptif	o26171	g$texte_case	o26241
	g$nom_site	o26257	g$url_site	o26267	g$nom_site	o26310	g$url_site	o26325	g$texte_case	o26358	g$statut_article	o26413	g$flag_editable	o26601	g$flag_modif	o26718	g$query	o26826	g$result	o26991	g$query	o27012	g$row	o27028	g$result	o27052	g$auteur_modif	o27067	g$row	o27083	g$modification	o27108	g$row	o27124	g$maintenant	o27149	g$row	o27163	g$date_diff	o27187	g$maintenant	o27207	g$modification	o27221	g$date_diff	o27249	g$date_diff	o27269	g$auteur_modif	o27289	g$auteur_modif	o27311	g$connect_id_auteur	o27328	g$flag_modif	o27354	g$query_auteur	o27378	g$result_auteur	o27462	g$query_auteur	o27490	g$row_auteur	o27514	g$result_auteur	o27545	g$nom_auteur_modif	o27569	g$row_auteur	o27594	g$flag_modif	o27638	g$nom_auteur_modif	o27881	g$date_diff	o27915	g$flag_editable	o28253	g$options	o28272	g$statut_article	o28485	g$date	o28686	g$jour	o28958	g$mois	o29109	g$annee	o29262	g$date	o29638	g$options	o29689	g$articles_redac	o29716	g$annee_redac	o29746	g$mois_redac	o29763	g$jour_redac	o29779	g$a!
 nnee_redac	o29817	g$mois_redac	o29834	g$jour_redac	o29850	g$date_affichee	o29879	g$date_redac	o29904	g$date_affichee	o29925	g$date_affichee	o30128	g$annee_redac	o30487	g$mois_redac	o30504	g$jour_redac	o30520	g$annee_redac	o30842	g$mois_redac	o30859	g$jour_redac	o30875	g$jour_redac	o31212	g$mois_redac	o31379	g$annee_redac	o31489	g$statut_article	o31943	g$texte_date	o31972	g$texte_date	o32030	g$date	o32219	g$annee_redac	o32268	g$mois_redac	o32285	g$jour_redac	o32301	g$date_affichee	o32335	g$date_redac	o32377	g$date_affichee	o32522	g$flag_editable	o32685	g$options	o32704	g$bouton	o32731	g$bouton	o32834	g$creer_auteur	o33107	g$connect_statut	o33125	g$creer_auteur	o33157	g$creer_auteur	o33184	g$nouv_auteur	o33202	g$ajout_auteur	o33312	g$cherche_auteur	o33371	g$query	o33417	g$result	o33470	g$query	o33491	g$table_auteurs	o33507	g$table_ids	o33531	g$row	o33552	g$result	o33576	g$table_auteurs	o33590	g$row	o33609	g$table_ids	o33624	g$row	o33639	g$resultat	o33662	g$cherche_auteur	o336!
 92	g$table_auteurs	o33709	g$table_ids	o33725	g$resultat	o33765	g$cherc
he_auteur	o33851	g$resultat	o33901	g$ajout_auteur	o33922	g$nouv_auteur	o33954	g$resultat	o33975	g$query	o34039	g$result	o34109	g$query	o34130	g$row	o34163	g$result	o34187	g$id_auteur	o34202	g$row	o34215	g$nom_auteur	o34237	g$row	o34251	g$email_auteur	o34267	g$row	o34283	g$bio_auteur	o34301	g$row	o34315	g$nom_auteur	o34415	g$resultat	o34503	g$resultat	o34530	g$les_auteurs	o34550	g$id_auteur	o34581	g$resultat	o34600	g$les_auteurs	o34612	g$id_auteur	o34629	g$les_auteurs	o34647	g$les_auteurs	o34666	g$les_auteurs	o34691	g$cherche_auteur	o34777	g$query	o34810	g$result	o34899	g$query	o34920	g$row	o34972	g$result	o34996	g$id_auteur	o35012	g$row	o35025	g$nom_auteur	o35048	g$row	o35062	g$email_auteur	o35079	g$row	o35095	g$bio_auteur	o35114	g$row	o35128	g$nom_auteur	o35166	g$email_auteur	o35196	g$bio_auteur	o35396	g$bio_auteur	o35445	g$cherche_auteur	o35607	g$GLOBALS	o35646	g$retour	o35731	g$GLOBALS	o35751	g$titre	o35788	g$cherche_auteur	o35807	g$ajout_auteur	o36114	g$flag_editable	o36!
 131	g$nouv_auteur	o36154	g$query	o36176	g$result	o36282	g$query	o36301	g$query	o36312	g$result	o36419	g$query	o36438	g$id_article	o36551	g$supp_auteur	o36575	g$flag_editable	o36591	g$query	o36610	g$result	o36715	g$query	o36734	g$id_article	o36843	g$les_auteurs	o36901	g$query	o36917	g$result	o37127	g$query	o37148	g$result	o37176	g$table	o37305	g$row	o37326	g$result	o37350	g$vals	o37364	g$id_auteur	o37378	g$row	o37391	g$nom_auteur	o37412	g$row	o37426	g$email_auteur	o37441	g$row	o37457	g$bio_auteur	o37478	g$row	o37520	g$bio_auteur	o37544	g$url_site_auteur	o37586	g$row	o37605	g$statut_auteur	o37625	g$row	o37642	g$row	o37664	g$row	o37695	g$messagerie	o37716	g$les_auteurs	o37740	g$id_auteur	o37757	g$connect_statut	o37776	g$aff_articles	o37808	g$aff_articles	o37872	g$query2	o37913	g$result2	o38190	g$query2	o38212	g$result2	o38228	g$nombre_articles	o38243	g$result2	o38280	g$nombre_articles	o38298	g$url_auteur	o38323	g$vals	o38382	g$row	o38408	g$vals	o38418	g$nom_auteur	o38471	g$val!
 s	o38495	g$id_auteur	o38521	g$email_auteur	o38547	g$vals	o38562	g$vals
	o38634	g$url_site_auteur	o38662	g$vals	o38680	g$vals	o38756	g$nombre_articles	o38784	g$vals	o38806	g$nombre_articles	o38817	g$nombre_articles	o38871	g$vals	o38894	g$vals	o38934	g$flag_editable	o38962	g$connect_id_auteur	o38982	g$id_auteur	o39004	g$connect_statut	o39018	g$options	o39054	g$vals	o39084	g$vals	o39324	g$table	o39347	g$vals	o39358	g$largeurs	o39373	g$styles	o39423	g$largeurs	o39531	g$table	o39542	g$styles	o39550	g$les_auteurs	o39591	g$les_auteurs	o39616	g$flag_editable	o39667	g$options	o39686	g$query	o39761	g$les_auteurs	o39812	g$query	o39826	g$query	o39877	g$result	o39975	g$query	o39996	g$connect_statut	o40056	g$rubrique_article	o40106	g$options	o40129	g$retour	o40184	g$clean_link	o40204	g$result	o40481	g$result	o40773	g$flag_mots_ressemblants	o40792	g$group	o41390	g$group2	o41409	g$row	o41437	g$result	o41461	g$id_auteur	o41477	g$row	o41490	g$nom	o41513	g$row	o41520	g$email	o41537	g$row	o41546	g$statut	o41565	g$row	o41575	g$statut	o41596	g$statut	o41658	g$statut!
 	o41672	g$statut	o41727	g$statut	o41741	g$statut	o41795	g$premiere	o41810	g$nom	o41845	g$connect_statut	o41869	g$p	o41910	g$email	o41922	g$email	o41942	g$email	o41958	g$p	o41969	g$email	o41989	g$email	o42002	g$statut	o42033	g$statut_old	o42044	g$premiere	o42197	g$premiere_old	o42210	g$statut	o42229	g$premiere_old	o42271	g$texte_option	o42336	g$statut_old	o42485	g$statut	o42499	g$premiere_old	o42512	g$premiere	o42528	g$options	o42968	g$articles_mots	o42995	g$id_article	o43051	g$nouv_mot	o43064	g$supp_mot	o43075	g$cherche_mot	o43086	g$flag_editable	o43100	g$row	o43283	g$langue_article	o43400	g$row	o43418	g$langue_choisie_article	o43433	g$row	o43459	g$titre_barre	o43525	g$titre_barre	o43581	g$titre_barre	o43626	g$langue_article	o43673	g$titre_barre	o43817	g$flag_editable	o43905	g$row	o43974	g$langue_parent	o44079	g$row	o44096	g$langue_choisie_article	o44117	g$herit	o44151	g$herit	o44174	g$langue_article	o44295	g$langue_parent	o44346	g$flag_editable	o44515	g$supp_trad	o44534	g$!
 result_autres_trad	o44777	g$row	o44898	g$result_autres_trad	o44922	g$n
ombre_autres_trad	o44948	g$row	o44970	g$nombre_autres_trad	o44992	g$id_trad	o45105	g$connect_statut	o45130	g$id_trad_new	o45163	g$id_trad	o45324	g$id_trad_new	o45335	g$flag_editable	o45360	g$lier_trad	o45379	g$query_lier	o45428	g$result_lier	o45510	g$query_lier	o45536	g$row	o45557	g$result_lier	o45581	g$id_lier	o45602	g$row	o45613	g$id_lier	o45639	g$nouveau_trad	o45732	g$lier_trad	o45748	g$id_lier	o45786	g$id_trad	o45798	g$err	o45808	g$nouveau_trad	o45862	g$id_lier	o45878	g$id_lier	o46001	g$id_trad	o46211	g$id_trad	o46319	g$nouveau_trad	o46330	g$err	o46362	g$err	o46426	g$id_trad	o46571	g$query_trad	o46591	g$result_trad	o46694	g$query_trad	o46720	g$table	o46745	g$row	o46766	g$result_trad	o46790	g$vals	o46811	g$id_article_trad	o46827	g$row	o46846	g$titre_trad	o46870	g$row	o46884	g$lang_trad	o46903	g$row	o46916	g$statut_trad	o46934	g$row	o46949	g$lang_trad	o46983	g$titre_trad	o47000	g$ifond	o47061	g$ifond	o47081	g$bgcolor	o47098	g$ifond	o47136	g$bgcolor	o47153	g$couleur_claire	!
 o47164	g$vals	o47193	g$statut_trad	o47237	g$id_article_trad	o47326	g$id_trad	o47346	g$vals	o47364	g$titre_trad	o47453	g$connect_statut	o47512	g$vals	o47542	g$vals	o47760	g$ret	o47859	g$id_article_trad	o47885	g$id_article	o47905	g$s	o47918	g$s	o47947	g$id_article_trad	o48031	g$id_trad	o48051	g$s	o48061	g$vals	o48097	g$s	o48107	g$vals	o48116	g$lang_trad	o48146	g$table	o48167	g$vals	o48178	g$vals	o48288	g$largeurs	o48594	g$styles	o48633	g$largeurs	o48697	g$table	o48708	g$styles	o48716	g$langue_article	o48790	g$flag_editable	o48905	g$options	o48924	g$ret	o48952	g$lien	o49046	g$GLOBALS	o49054	g$lien	o49081	g$nom_select	o49095	g$lien	o49112	g$lien	o49120	g$flag_editable	o49904	g$options	o49923	g$ret	o49950	g$connect_statut	o50947	g$rubrique_article	o50997	g$statut_url_javascript	o51408	g$statut_article	o51697	g$statut_article	o51827	g$statut_article	o51962	g$statut_article	o52087	g$statut_article	o52225	g$statut_article	o52386	g$virtuel	o52987	g$revision_nbsp	o53126	g$activer_rev!
 ision_nbsp	o53143	g$chapo	o53180	g$chapo	o53264	g$texte	o53366	g$ps	o5
3397	g$ps	o53562	g$revision_nbsp	o53625	g$les_notes	o53655	g$les_notes	o53795	g$champs_extra	o53861	g$extra	o53879	g$extra	o53943	g$flag_editable	o54014	g$date_diff	o54074	g$date_diff	o54094	g$auteur_modif	o54114	g$auteur_modif	o54136	g$connect_id_auteur	o54153	g$query_auteur	o54177	g$result_auteur	o54257	g$query_auteur	o54285	g$row_auteur	o54310	g$result_auteur	o54341	g$nom_auteur_modif	o54363	g$row_auteur	o54388	g$nom_auteur_modif	o54632	g$date_diff	o54666	g$spip_display	o54913	g$id_article	o54963	g$flag_editable	o54987	g$flag_auteur	o55045	g$statut_article	o55062	g$forum_retour	o55453	g$forum_retour	o55636	g$titre	o55701	g$query_forum	o55791	g$result_forum	o55914	g$query_forum	o55941	g$total	o55956	g$row	o55972	g$result_forum	o55996	g$total	o56012	g$row	o56021	g$debut	o56040	g$debut	o56048	g$total_afficher	o56060	g$total	o56085	g$total_afficher	o56094	g$i	o56164	g$i	o56172	g$total	o56177	g$i	o56185	g$i	o56190	g$total_afficher	o56195	g$y	o56215	g$i	o56220	g$total_afficher	!
 o56225	g$i	o56252	g$debut	o56258	g$query_forum	o56424	g$result_forum	o56587	g$query_forum	o56614	g$result_forum	o56644	g$forum_retour	o56659	g$debut	o56682	g$debut	o56690	g$total_afficher	o56702	g$total	o56727	g$total_afficher	o56736	g$i	o56806	g$i	o56814	g$total	o56819	g$i	o56827	g$i	o56832	g$total_afficher	o56837	g$y	o56857	g$i	o56862	g$total_afficher	o56867	g$i	o56894	g$debut	o56900	g$ok_nouveau_statut	o57117	g$statut_nouv	o57178	g$statut_ancien	o57207	g$statut_nouv	o57225	g$id_article	o57303	g$statut_nouv	o57325	g$statut_ancien	o57352	g$statut_nouv	o57370	g$statut_ancien	o57387	g$id_article	o57479
inc-compilo-api.php3	d_INC_COMPILO_API	o97	cTexte	o188	vtype	o202	vtexte	o224	cInclure	o240	vtype	o256	vfichier	o280	vparams	o295	cBoucle	o364	vtype	o379	vid_boucle	o402	vid_parent	o419	vcond_avant	o440	vlang_select	o494	vtype_requete	o513	vsql_serveur	o533	vparam	o552	vseparateur	o575	vdoublons	o593	vpartie	o609	vexterne	o652	vtout	o770	vplat	o790	vselect	o810	vfrom	o824	vwhere	o836	vlimit	o849	vgroup	o862	vorder	o880	vdate	o898	vhash	o920	vlien	o941	vsous_requete	o961	vcompte_requete	o989	vhierarchie	o1015	vid_table	o1083	vprimary	o1099	vreturn	o1114	vnumrows	o1128	cChamp	o1155	vtype	o1169	vnom_champ	o1191	vnom_boucle	o1208	vcond_avant	o1263	vfonctions	o1315	vetoile	o1354	vid_boucle	o1406	vboucles	o1423	vtype_requete	o1438	vcode	o1458	vstatut	o1488	vid_mere	o1675	vdocument	o1728	g$tables_des_serveurs_sql	o1830	g$tables_principales	o1856	g$exceptions_des_tables	o1909	g$table_des_tables	o1933	g$tables_relations	o1959	g$table_primary	o1979	g$table_date	o1995	g$tables_des_serv!
 eurs_sql	o2009	g$tables_principales	o2058	g$table_primary	o2119	g$table_des_tables	o2600	g$exceptions_des_tables	o3026	g$table_date	o3837	g$tables_relations	o4291
ecrire/mots_type.php3	g$connect_statut	o35	g$new	o70	g$id_groupe	o88	g$type	o106	g$onfocus	o160	g$ancien_type	o234	g$unseul	o254	g$obligatoire	o272	g$articles	o295	g$breves	o315	g$rubriques	o333	g$syndic	o354	g$acces_minirezo	o372	g$acces_comite	o398	g$acces_forum	o422	g$query_groupes	o454	g$result_groupes	o536	g$query_groupes	o565	g$row	o589	g$result_groupes	o613	g$id_groupe	o635	g$row	o648	g$type	o669	g$row	o677	g$ancien_type	o694	g$type	o709	g$titre	o718	g$type	o732	g$unseul	o742	g$row	o752	g$obligatoire	o770	g$row	o785	g$articles	o808	g$row	o820	g$breves	o840	g$row	o850	g$rubriques	o868	g$row	o881	g$syndic	o902	g$row	o912	g$acces_minirezo	o930	g$row	o948	g$acces_comite	o969	g$row	o985	g$acces_forum	o1004	g$row	o1019	g$titre	o1635	g$connect_statut	o1675	g$type	o1708	g$type	o1737	g$connect_statut	o2459	g$articles	o2701	g$checked	o2721	g$checked	o2750	g$activer_breves	o2932	g$activer_breves	o2985	g$breves	o3019	g$checked	o3037	g$checked	o3067	g$rubriques	o3320	g$checked	o33!
 41	g$checked	o3370	g$syndic	o3560	g$checked	o3578	g$checked	o3607	g$config_precise_groupes	o3812	g$config_precise_groupes	o3880	g$unseul	o3916	g$obligatoire	o3936	g$unseul	o4063	g$checked	o4084	g$checked	o4116	g$obligatoire	o4303	g$checked	o4329	g$checked	o4358	g$acces_minirezo	o4876	g$checked	o4902	g$checked	o4931	g$acces_comite	o5154	g$checked	o5178	g$checked	o5207	g$mots_cles_forums	o5403	g$forums_publics	o5456	g$mots_cles_forums	o5511	g$acces_forum	o5541	g$forums_publics	o5568	g$acces_forum	o5602	g$checked	o5625	g$checked	o5655
ecrire/optimiser.php3	d_ECRIRE_OPTIMISER	o101	foptimiser_base	o139
ecrire/articles_forum.php3	g$query	o102	g$result	o190	g$query	o211	g$row	o227	g$result	o251	g$titre	o264	g$row	o273	g$id_rubrique	o289	g$row	o304	g$titre	o340	g$id_rubrique	o419	g$titre	o1052	g$connect_statut	o1160	g$id_rubrique	o1208	g$debut	o1281	g$debut	o1289	g$pack	o1301	g$enplus	o1347	g$limitdeb	o1400	g$debut	o1413	g$enplus	o1422	g$debut	o1433	g$enplus	o1440	g$limitnb	o1453	g$debut	o1464	g$enplus	o1473	g$limitdeb	o1483	g$query_forum	o1495	g$result_forum	o1658	g$query_forum	o1685	g$i	o1702	g$limitdeb	o1707	g$i	o1722	g$row	o1821	g$result_forum	o1845	g$i	o1893	g$pack	o1899	g$i	o1911	g$pack	o1914	g$i	o1930	g$debut	o1936	g$i	o2128	g$mots_cles_forums	o2244	g$connect_statut	o2300	g$query_forum	o2335	g$result_forum	o2511	g$query_forum	o2538	g$result_forum	o2569	g$forum_retour	o2584	g$id_article	o2599
ecrire/lang/spip_fa.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_serialbase.php3	d_ECRIRE_INC_SERIALBASE	o103	g$spip_articles	o137	g$spip_articles_key	o1530	g$spip_auteurs	o1889	g$spip_auteurs_key	o2855	g$spip_breves	o3048	g$spip_breves_key	o3667	g$spip_messages	o3822	g$spip_messages_key	o4258	g$spip_mots	o4355	g$spip_mots_key	o4757	g$spip_groupes_mots	o4894	g$spip_groupes_mots_key	o5365	g$spip_rubriques	o5431	g$spip_rubriques_key	o6263	g$spip_documents	o6444	g$spip_documents_key	o7008	g$spip_types_documents	o7165	g$spip_types_documents_key	o7537	g$spip_syndic	o7669	g$spip_syndic_key	o8393	g$spip_syndic_articles	o8591	g$spip_syndic_articles_key	o8985	g$spip_forum	o9146	g$spip_forum_key	o10048	g$spip_signatures	o10378	g$spip_signatures_key	o10873	g$tables_principales	o11034	g$tables_principales	o11174	g$spip_articles	o11227	g$spip_articles_key	o11253	g$tables_principales	o11274	g$spip_auteurs	o11327	g$spip_auteurs_key	o11352	g$tables_principales	o11372	g$spip_breves	o11425	g$spip_breves_key	o11449	g$tables_principales	o11468	g$s!
 pip_messages	o11521	g$spip_messages_key	o11547	g$tables_principales	o11568	g$spip_mots	o11621	g$spip_mots_key	o11643	g$tables_principales	o11660	g$spip_groupes_mots	o11717	g$spip_groupes_mots_key	o11747	g$tables_principales	o11772	g$spip_rubriques	o11826	g$spip_rubriques_key	o11853	g$tables_principales	o11875	g$spip_documents	o11929	g$spip_documents_key	o11957	g$tables_principales	o11979	g$spip_types_documents	o12039	g$spip_types_documents_key	o12072	g$tables_principales	o12100	g$spip_syndic	o12151	g$spip_syndic_key	o12175	g$tables_principales	o12194	g$spip_syndic_articles	o12254	g$spip_syndic_articles_key	o12287	g$tables_principales	o12315	g$spip_forum	o12365	g$spip_forum_key	o12388	g$tables_principales	o12406	g$spip_signatures	o12461	g$spip_signatures_key	o12489
ecrire/oo/index.php3
inc-formulaire_inscription.php3	g$balise_FORMULAIRE_INSCRIPTION_collecte	o56	g$balise_FORMULAIRE_INSCRIPTION_collecte	o98	fbalise_FORMULAIRE_INSCRIPTION_stat	o272	fbalise_FORMULAIRE_INSCRIPTION_dyn	o492	ftest_mail_ins	o2548	fenvoyer_inscription	o2670	ftest_login	o3518
ecrire/lang/public_hu.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/public_de.php3	g$GLOBALS	o80	g$GLOBALS	o89
inc-url_logout.php3	g$balise_URL_LOGOUT_collecte	o14	g$balise_URL_LOGOUT_collecte	o43	fbalise_URL_LOGOUT_stat	o92	fbalise_URL_LOGOUT_dyn	o176
index.php
ecrire/lang/spip_it.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/public_oc_auv.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/articles_tous.php3	g$aff_art	o40	g$aff_art	o55	g$aff_art	o76	g$aff_art	o92	g$statut_art	o119	g$aff_art	o162	g$direction_generale	o312	g$spip_dir_lang	o334	g$query	o387	g$result	o471	g$query	o492	g$row	o508	g$result	o532	g$id_rubrique	o545	g$row	o560	g$titre	o582	g$row	o596	g$id_parent	o613	g$row	o626	g$les_rubriques	o648	g$nom_block	o694	g$numero_block	o737	g$compteur_block	o773	g$numero_block	o794	g$compteur_block	o824	g$first_couche	o849	g$first_couche	o864	g$compteur_block	o880	g$last_couche	o899	g$compteur_block	o914	g$id_parent	o940	g$rubrique	o963	g$id_rubrique	o973	g$rubrique	o1012	g$id_rubrique	o1022	g$enfant	o1054	g$id_parent	o1062	g$id_rubrique	o1078	g$query	o1097	g$result	o1156	g$query	o1177	g$row	o1193	g$result	o1217	g$id_rubrique	o1230	g$row	o1245	g$rubriques_actives	o1267	g$id_rubrique	o1286	g$id_rubrique	o1302	g$sel_lang	o1363	g$l	o1391	g$sel_lang	o1402	g$sel	o1416	g$l	o1421	g$l	o1427	g$sel_lang	o1432	g$sel	o1444	g$sel_lang	o1452	g$spip_lang	o1462	g$spi!
 p_lang	o1476	g$connect_statut	o1493	g$query	o1525	g$query	o1728	g$result	o2287	g$query	o2308	g$row	o2323	g$result	o2347	g$id_rubrique	o2360	g$row	o2373	g$id_article	o2395	g$row	o2409	g$titre	o2430	g$row	o2444	g$statut	o2461	g$row	o2471	g$lang	o2488	g$row	o2496	g$id_trad	o2511	g$row	o2522	g$date_modif	o2540	g$row	o2554	g$aff_statut	o2577	g$aff_lang	o2609	g$text_article	o2637	g$id_article	o2651	g$text_article	o2686	g$id_article	o2700	g$statut	o2725	g$text_article	o2735	g$id_article	o2749	g$lang	o2772	g$text_article	o2780	g$id_article	o2794	g$id_trad	o2820	g$text_article	o2831	g$id_article	o2845	g$date_modif	o2874	g$GLOBALS	o2888	g$lang	o2918	g$langues	o2937	g$langues	o3135	g$l	o3170	g$langues	o3182	g$sel_lang	o3204	g$l	o3214	g$text_article	o3219	g$id_article	o3233	g$id_trad	o3320	g$id_article	o3332	g$id_trad	o3347	g$text_article	o3366	g$id_article	o3380	g$article	o3519	g$id_rubrique	o3528	g$id_article	o3546	g$tmp	o3565	g$text_article	o3572	g$tmp	o3592	g$tmp	o3612	g$id_article!
 	o3619	g$tmp	o3637	g$tmp	o3649	g$id_trad	o3660	g$tmp	o3671	g$id_articl
e	o3676	g$date	o3703	g$tmp	o3711	g$id_article	o3716	g$date_modif	o3740	g$tmp	o3754	g$id_article	o3759	g$lang	o3789	g$tmp	o3797	g$id_article	o3802	g$id_trad	o3839	g$id_trad	o3856	g$id_article	o3868	g$sel_lang	o3884	g$lang	o3894	g$text_article	o3911	g$id_trad	o3925	g$text_article	o3951	g$id_article	o3965	g$text_article	o3999	g$id_trad	o4013	g$text_article	o4133	g$id_trad	o4147	g$aff_statut	o4475	g$aff_art	o4518	g$aff_statut	o4888	g$aff_art	o4929	g$aff_statut	o5293	g$aff_art	o5338	g$aff_statut	o5699	g$aff_art	o5743	g$aff_statut	o6105	g$aff_art	o6153	g$lf	o6821	g$langues	o7279	g$langues	o7349	g$langues	o7373	g$langues	o7545	g$l	o7594	g$langues	o7606	g$sel_lang	o7626	g$l	o7636	g$l	o7701	g$l	o7780	fafficher_rubriques_filles	o8039	g$rubrique	o8087	g$enfant	o8098	g$article	o8107	g$text_article	o8117	g$spip_lang_left	o8140	g$spip_lang_right	o8157	g$spip_lang	o8175	g$direction_generale	o8187	g$couleur_claire	o8216	g$decal	o8241	g$javasc_ouvrir	o10582	g$javasc_fermer	o10699	g$les_rubri!
 ques	o10845	g$browser_layer	o10864	g$les_rubriques	o10883	g$les_rubriques	o10905
inc-stats.php3	d_INC_STATS	o94	fecrire_stats	o124	g$id_article	o149	g$id_breve	o162	g$id_rubrique	o173	fafficher_raccourci_stats	o1632
ecrire/index.php
inc-chercher.php3	d_INC_CHERCHE	o93	fchercher_squelette	o237
ecrire/auteur_infos.php3	g$id_auteur	o228	g$id_auteur	o247	fmySel	o286	fafficher_auteur_rubriques	o464	g$id_parent	o510	g$id_rubrique	o530	g$toutes_rubriques	o552	g$i	o579	g$connect_toutes_rubriques	o1116	g$add_rub	o1146	g$add_rub	o1161	g$query	o1174	g$result	o1274	g$query	o1295	g$connect_toutes_rubriques	o1310	g$supp_rub	o1340	g$supp_rub	o1356	g$query	o1370	g$result	o1471	g$query	o1492	g$connect_statut	o1520	g$connect_id_auteur	o1555	g$id_auteur	o1577	g$auteur	o1705	g$id_auteur	o1720	g$auteur	o1735	g$new	o1833	g$auteur	o1877	g$titre	o1894	g$auteur	o1906	g$onfocus	o1968	g$auteur	o2045	g$auteur	o2077	g$statut	o2159	g$connect_statut	o2238	g$statut	o2319	g$auteur	o2352	g$statut	o2372	g$nom	o2387	g$auteur	o2414	g$nom	o2451	g$modif_login	o2493	g$old_login	o2509	g$auteur	o2522	g$new_login	o2546	g$old_login	o2558	g$connect_statut	o2574	g$connect_toutes_rubriques	o2609	g$auteur	o2639	g$new_login	o2676	g$new_login	o2704	g$echec	o2725	g$new_login	o2861	g$echec	o2934	g$new_login	o2989	!
 g$old_login	o3003	g$modif_login	o3021	g$auteur	o3046	g$new_login	o3065	g$auteur	o3124	g$modif_login	o3150	g$new_pass	o3230	g$statut	o3245	g$auteur	o3273	g$auteur	o3294	g$new_pass	o3331	g$new_pass2	o3344	g$echec	o3359	g$new_pass	o3416	g$new_pass	o3437	g$echec	o3456	g$modif_login	o3513	g$auteur	o3537	g$new_pass	o3559	g$modif_login	o3583	g$auteur	o3653	g$connect_id_auteur	o3688	g$auteur	o3710	g$GLOBALS	o3753	g$connect_statut	o3942	g$connect_toutes_rubriques	o3979	g$statut	o4008	g$email	o4040	g$email	o4070	g$echec	o4084	g$auteur	o4130	g$email	o4149	g$auteur	o4169	g$email	o4188	g$connect_id_auteur	o4205	g$id_auteur	o4227	g$perso_activer_imessage	o4247	g$query	o4277	g$result	o4378	g$query	o4399	g$auteur	o4411	g$perso_activer_imessage	o4433	g$auteur	o4497	g$bio	o4534	g$auteur	o4542	g$pgp	o4579	g$auteur	o4587	g$nom_site_auteur	o4629	g$auteur	o4689	g$url_site	o4721	g$new_pass	o4739	g$htpass	o4754	g$new_pass	o4779	g$alea_actuel	o4793	g$alea_futur	o4826	g$pass	o4858	g$alea_actuel	o487!
 0	g$new_pass	o4883	g$query_pass	o4897	g$auteur	o5020	g$query_pass	o505
3	g$champs_extra	o5110	g$extra	o5165	g$add_extra	o5207	g$extra	o5245	g$add_extra	o5268	g$echec	o5318	g$auteur	o5335	g$auteur	o5387	g$id_auteur	o5468	g$auteur	o5481	g$ajouter_id_article	o5519	g$ajouter_id_article	o5555	g$query	o5704	g$auteur	o5771	g$auteur	o5814	g$auteur	o5857	g$auteur	o5900	g$auteur	o5948	g$auteur	o5999	g$auteur	o6045	g$auteur	o6089	g$auteur	o6146	g$query	o6181	g$query	o6196	g$id_auteur	o6308	g$echec	o6426	g$redirect_ok	o6437	g$redirect	o6483	g$redirect	o6508	g$connect_id_auteur	o6592	g$id_auteur	o6614	g$auteur	o6638	g$auteur	o6692	g$id_auteur	o6776	g$echec	o7139	g$auteur	o7866	g$connect_statut	o7963	g$connect_toutes_rubriques	o7999	g$auteur	o8028	g$auteur	o8143	g$auteur	o8213	g$auteur	o8482	g$auteur	o8720	g$auteur	o8882	g$options	o8961	g$auteur	o9153	g$auteur	o9299	g$champs_extra	o9342	g$auteur	o9410	g$auteur	o9439	g$auteur	o9608	g$edit_login	o9640	g$edit_pass	o9662	g$connect_statut	o9694	g$connect_toutes_rubriques	o9730	g$edit_login	o9760	g$edit_pass	o9781!
 	g$connect_id_auteur	o9811	g$id_auteur	o9833	g$edit_login	o9848	g$edit_pass	o9870	g$edit_login	o9899	g$edit_pass	o9921	g$edit_login	o10042	g$edit_pass	o10057	g$connect_id_auteur	o10073	g$id_auteur	o10095	g$edit_login	o10385	g$auteur	o10591	g$auteur	o10732	g$edit_pass	o10900	g$connect_id_auteur	o11354	g$id_auteur	o11376	g$auteur	o11548	g$statut	o12737	g$auteur	o12747	g$connect_statut	o12795	g$connect_toutes_rubriques	o12832	g$statut	o12861	g$connect_id_auteur	o12890	g$id_auteur	o12912	g$connect_statut	o13064	g$connect_toutes_rubriques	o13099	g$statut	o13161	g$statut	o13236	g$statut	o13279	g$statut	o13421	g$statut	o13489	g$statut	o13775	g$query_admin	o13843	g$result_admin	o14059	g$query_admin	o14086	g$result_admin	o14121	g$row_admin	o14338	g$result_admin	o14368	g$id_rubrique	o14389	g$row_admin	o14404	g$titre	o14434	g$row_admin	o14448	g$connect_toutes_rubriques	o14499	g$connect_id_auteur	o14529	g$id_auteur	o14551	g$toutes_rubriques	o14717	g$toutes_rubriques	o14777	g$connect_to!
 utes_rubriques	o14828	g$connect_id_auteur	o14858	g$id_auteur	o14880	g$
result_admin	o14914
ecrire/inc_auth.php3	d_ECRIRE_INC_AUTH	o100	facces_rubrique	o311	g$connect_toutes_rubriques	o350	g$connect_id_rubrique	o385	facces_restreint_rubrique	o495	g$connect_id_rubrique	o544	g$connect_statut	o574	fauth	o686	g$INSECURE	o703	g$HTTP_POST_VARS	o714	g$HTTP_GET_VARS	o731	g$HTTP_COOKIE_VARS	o747	g$REMOTE_USER	o766	g$PHP_AUTH_USER	o780	g$PHP_AUTH_PW	o796	g$auth_can_disconnect	o818	g$ignore_auth_http	o840	g$ignore_remote_user	o859	g$connect_id_auteur	o889	g$connect_nom	o909	g$connect_bio	o923	g$connect_email	o937	g$connect_nom_site	o961	g$connect_url_site	o980	g$connect_login	o999	g$connect_pass	o1015	g$connect_activer_imessage	o1038	g$connect_activer_messagerie	o1065	g$connect_statut	o1102	g$connect_toutes_rubriques	o1119	g$connect_id_rubrique	o1146	g$auteur_session	o1177	g$prefs	o1194	g$clean_link	o1210
ecrire/inc_tidy.php	d_ECRIRE_INC_TIDY	o100	fversion_tidy	o137	vversion	o163	fechappe_xhtml	o383	fxhtml	o1212
ecrire/controle_petition.php3	fcontrole_forum	o233	g$debut	o284	g$couleur_foncee	o300	g$connect_statut	o2577	g$supp_petition	o2658	g$query_forum	o2677	g$result_forum	o2777	g$query_forum	o2804	g$add_petition	o2828	g$query_forum	o2846	g$result_forum	o2943	g$query_forum	o2970	g$id_signature	o3044	g$add_petition	o3061	g$add_petition	o3075	g$supp_petition	o3089	g$debut	o3336	g$debut	o3344	g$id_article	o3362	g$signature_article	o3379	g$url_article	o3433	g$signature_article	o3486	g$query_forum	o3513	g$result_forum	o3686	g$query_forum	o3713	g$total	o3729	g$row	o3746	g$result_forum	o3770	g$total	o3786	g$row	o3795	g$total	o3814	g$i	o3850	g$i	o3858	g$total	o3863	g$i	o3871	g$i	o3876	g$i	o3893	g$i	o3920	g$debut	o3926	g$query_forum	o4066	g$result_forum	o4208	g$query_forum	o4235	g$query_forum	o4252	g$result_forum	o4404	g$query_forum	o4431	g$result_forum	o4462
ecrire/controle_forum.php3	fforum_parent	o39	fcontrole_forum	o3295	g$couleur_foncee	o3335	g$mots_cles_forums	o3360	g$page	o7916	g$page	o7923	g$page	o8029	g$connect_statut	o8290	g$connect_toutes_rubriques	o8325	g$page	o8418	g$query_forum	o8443	g$query_forum	o8536	g$query_forum	o8643	g$query_forum	o8762	g$debut	o8800	g$debut	o8808	g$pack	o8820	g$enplus	o8866	g$limitdeb	o8919	g$debut	o8932	g$enplus	o8941	g$debut	o8952	g$enplus	o8959	g$limitnb	o8972	g$debut	o8983	g$enplus	o8992	g$limitdeb	o9002	g$rappel	o9013	g$mots_cles_forums	o9037	g$controle	o9088	g$i	o9134	g$limitdeb	o9139	g$i	o9154	g$result_forum	o9220	g$query_forum	o9284	g$row	o9364	g$result_forum	o9388	g$i	o9436	g$pack	o9442	g$i	o9454	g$pack	o9457	g$i	o9473	g$debut	o9479	g$i	o9681	g$debut	o9685	g$i	o9698	g$debut	o9702	g$pack	o9711	g$controle	o9723	g$row	o9751	g$i	o9783
ecrire/plugins/plug_small_caps.php	favant_typo_smallcaps	o74
carto.php3	g$fond	o9	g$delais	o27
ecrire/lang/spip_da.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/unpack.php3	g$action	o109	g$action	o152	g$hash	o163	g$action	o216
ecrire/config-fonctions.php3	g$connect_statut	o72	g$connect_toutes_rubriques	o107	g$changer_config	o198	fafficher_choix_vignette	o703	g$flag_gd	o1280	g$flag_imagick	o1292	g$convert_command	o1309	g$flag_imagick	o1376	g$image_process	o1395	g$formats_graphiques	o1468	g$flag_gd	o1589	g$convert_command	o1601	g$formats_graphiques	o1623	g$image_process	o1873	g$image_process	o1923	g$formats_graphiques	o2124	g$formats_graphiques	o2204	g$formats_graphiques	o2287	g$formats_graphiques	o2375	g$formats_graphiques	o2449	g$formats_graphiques	o2540	g$flag_gd	o2670	g$nb_process	o2686	g$p	o2730	g$flag_ImageCreateTrueColor	o2752	g$p	o2811	g$nb_process	o2829	g$p	o2884	g$nb_process	o2903	g$convert_command	o2928	g$p	o2976	g$nb_process	o2997	g$creer_preview	o3231	g$taille_preview	o3277	g$taille_preview	o3329	g$taille_preview	o3351	g$formats_graphiques	o3387	g$block	o3617	g$creer_preview	o3729	g$creer_preview	o3820	g$style	o3845	g$style	o3880	g$block	o4240	g$creer_preview	o4354	g$flag_gd	o4816	g$fla!
 g_imagick	o4828	g$convert_command	o4845	g$activer_moteur	o5066	g$activer_moteur	o5286	g$activer_statistiques	o5772	g$activer_statistiques	o5998	g$options	o6384	g$articles_modif	o6501	g$articles_modif	o6705	g$flag_revisions	o7094	g$options	o7114	g$articles_versions	o7230	g$articles_versions	o7438	g$articles_ortho	o7873	g$articles_ortho	o8210	g$preview	o8646	g$preview	o8932	g$options	o9354	g$http_proxy	o9484	g$http_proxy	o9740	g$options	o10434	g$REMOTE_USER	o10499	g$creer_htpasswd	o10665	g$creer_htpasswd	o10851
ecrire/naviguer.php3	g$id_rubrique	o181	g$id_rubrique	o203	g$flag_mots	o218	fenfant	o269	g$les_enfants	o298	g$couleur_foncee	o312	g$lang_dir	o329	g$spip_display	o348	g$spip_lang_left	o363	g$spip_lang_right	o380	g$connect_id_auteur	o406	fsous_enfant	o3098	g$lang_dir	o3133	g$spip_lang_dir	o3144	g$spip_lang_left	o3160	fmy_sel	o4011	fafficher_mois	o4164	fafficher_annee	o4711	fafficher_jour	o5006	g$id_parent	o5211	g$id_parent	o5231	g$id_rubrique	o5244	g$id_rubrique	o5266	g$flag_editable	o5281	g$connect_statut	o5299	g$id_parent	o5350	g$id_rubrique	o5380	g$modifier_rubrique	o5462	g$titre	o5523	g$new	o5567	g$flag_editable	o5585	g$id_rubrique	o5605	g$id_rubrique	o5623	g$result	o5768	g$query	o5789	g$clean_link	o5800	g$id_rubrique	o5835	g$query	o5961	g$row	o6047	g$query	o6082	g$row	o6098	g$confirme_deplace	o6121	g$id_parent	o6154	g$id_parent	o6253	g$change_parent	o6270	g$change_parent	o6329	g$titre	o6355	g$titre	o6375	g$descriptif	o6385	g$descriptif	o6410	g$texte	o6425	g$texte	o6445	g$!
 champs_extra	o6460	g$add_extra	o6515	g$add_extra	o6601	g$flag_editable	o6624	g$query	o6644	g$result	o6798	g$query	o6819	g$invalider_caches	o6919	g$id_rubrique	o7140	g$changer_lang	o7208	g$id_rubrique	o7226	g$id_parent	o7328	g$flag_editable	o7349	g$changer_lang	o7372	g$changer_lang	o7457	g$id_parent	o7545	g$langue_parent	o7565	g$row	o7620	g$langue_parent	o7724	g$row	o7741	g$langue_parent	o7818	g$query	o7965	g$result	o8037	g$query	o8056	g$row	o8072	g$result	o8094	g$id_rubrique	o8106	g$row	o8119	g$id_parent	o8141	g$row	o8152	g$titre	o8172	g$row	o8179	g$descriptif	o8195	g$row	o8207	g$texte	o8228	g$row	o8235	g$statut	o8251	g$row	o8261	g$extra	o8278	g$row	o8287	g$langue_rubrique	o8303	g$row	o8322	g$titre	o8343	g$titre_page	o8352	g$titre	o8392	g$titre_page	o8419	g$id_document	o8474	g$query_doc	o8491	g$result_doc	o8607	g$query_doc	o8632	g$flag_document_editable	o8646	g$result_doc	o8687	g$flag_document_editable	o8716	g$modif_document	o8753	g$GLOBALS	o8771	g$modif_document	o8803	g$fl!
 ag_document_editable	o8832	g$titre_document	o8860	g$titre_document	o89
09	g$descriptif_document	o8929	g$descriptif_document	o8983	g$query	o9009	g$largeur_document	o9111	g$hauteur_document	o9133	g$query	o9152	g$query	o9225	g$query	o9282	g$jour_doc	o9297	g$connect_statut	o9311	g$id_rubrique	o9361	g$annee_doc	o9384	g$mois_doc	o9406	g$mois_doc	o9430	g$jour_doc	o9449	g$query	o9469	g$result	o9578	g$query	o9599	g$titre_page	o9674	g$id_rubrique	o9761	g$id_parent	o9803	g$id_rubrique	o9867	g$spip_display	o9905	g$id_rubrique	o9932	g$id_rubrique	o10241	g$statut	o10255	g$rubon	o10328	g$ruboff	o10359	g$connect_statut	o10398	g$id_rubrique	o10448	g$id_rubrique	o10471	g$rubon	o10512	g$ruboff	o10520	g$rubon	o10621	g$ruboff	o10629	g$query	o10807	g$result	o10869	g$query	o10890	g$result	o11009	g$id_rubrique	o11031	g$activer_breves	o11188	g$activer_breves	o11241	g$id_parent	o11270	g$id_rubrique	o11292	g$connect_statut	o11467	g$id_rubrique	o11599	g$nom_site	o11621	g$titre	o11657	g$nom_site	o11694	g$id_rubrique	o11712	g$ze_logo	o11732	g$id_parent	o11774	g$ze_logo	o117!
 91	g$ze_logo	o11825	g$ze_logo	o11876	g$id_rubrique	o12041	g$fleche	o12057	g$fleche	o12202	g$titre	o12210	g$id_rubrique	o12238	g$flag_editable	o12259	g$ze_logo	o12493	g$descriptif	o12561	g$descriptif	o12763	g$champs_extra	o12854	g$extra	o12872	g$extra	o12936	g$flag_mots	o12981	g$flag_editable	o13004	g$options	o13023	g$id_rubrique	o13050	g$id_rubrique	o13115	g$nouv_mot	o13129	g$supp_mot	o13140	g$cherche_mot	o13151	g$flag_editable	o13165	g$texte	o13197	g$texte	o13321	g$id_rubrique	o13399	g$id_parent	o13501	g$flag_editable	o13522	g$row	o13542	g$langue_rubrique	o13662	g$row	o13681	g$langue_choisie_rubrique	o13696	g$row	o13723	g$id_parent	o13752	g$row	o13768	g$langue_parent	o13871	g$row	o13888	g$langue_parent	o13906	g$langue_rubrique	o14244	g$langue_rubrique	o14440	g$langue_parent	o14462	g$id_rubrique	o14612	g$les_enfants2	o14629	g$les_enfants	o14650	g$les_enfants	o14676	g$les_enfants	o14700	g$les_enfants2	o14727	g$les_enfants2	o14769	g$les_enfants2	o14790	g$les_enfants2	o14811	g!
 $les_enfants2	o14857	g$les_enfants1	o14875	g$les_enfants	o14896	g$les_
enfants	o14918	g$les_enfants2	o14939	g$les_enfants1	o14964	g$les_enfants	o14978	g$les_enfants2	o14993	g$les_enfants2	o15341	g$flag_editable	o15476	g$id_rubrique	o15499	g$relief	o16016	g$relief	o16039	g$query	o16051	g$result	o16187	g$query	o16208	g$relief	o16218	g$result	o16243	g$relief	o16266	g$query	o16278	g$result	o16405	g$query	o16426	g$relief	o16436	g$result	o16461	g$relief	o16484	g$query	o16537	g$result	o16645	g$query	o16666	g$relief	o16676	g$result	o16701	g$relief	o16724	g$connect_statut	o16777	g$connect_toutes_rubriques	o16812	g$query	o16842	g$result	o16954	g$query	o16975	g$relief	o16985	g$result	o17010	g$relief	o17033	g$query	o17395	g$query	o17573	g$connect_statut	o17937	g$connect_toutes_rubriques	o17972	g$id_rubrique	o18278	g$connect_statut	o18300	g$connect_toutes_rubriques	o18335	g$result	o18366	g$row	o18470	g$result	o18494	g$row	o18508	g$row	o18572	g$connect_statut	o18779	g$options	o18814	g$id_rubrique	o19184	g$activer_breves	o19576	g$id_parent	o19626	g$id_rubriqu!
 e	o19648	g$activer_breves	o19672	g$proposer_sites	o20178	g$id_rubrique	o20228	g$flag_editable	o20250	g$proposer_sites	o20268	g$link	o20294	g$link	o20333	g$id_rubrique	o20362	g$link	o20379	g$link	o20420	g$clean_link	o20446	g$link	o20539	g$id_rubrique	o20653	g$id_rubrique	o20701	g$flag_editable	o20727	g$id_rubrique	o20796	g$id_rubrique	o20837	g$flag_editable	o20855	g$link	o20874	g$link	o20910	g$id_parent	o20939	g$link	o20953	g$id_rubrique	o20984	g$link	o21072
inc-criteres.php3	d_INC_CRITERES	o143	fcritere_racine_dist	o220	fcritere_exclus_dist	o505	fcritere_doublons_dist	o916	fcritere_lang_select_dist	o1420	fcritere_debut_dist	o1857	fcritere_recherche_dist	o2240	fcritere_inverse_dist	o2901	fcritere_traduction_dist	o3431	fcritere_origine_traduction_dist	o4018	fcritere_meme_parent_dist	o4378	fcritere_branche_dist	o5193	fcritere_par_dist	o5862	g$table_des_tables	o7141	g$tables_des_serveurs_sql	o7160	fcalculer_critere_parties	o7766	g$tables_relations	o7841	g$table_des_tables	o7860	g$table_date	o7879	g$tables_des_serveurs_sql	o7892	fcalculer_critere_parties_aux	o8439	fcalculer_criteres	o8824	fcalculer_critere_DEFAUT	o9456	g$table_des_tables	o9521	g$table_date	o9540	g$tables_des_serveurs_sql	o9553	fcalculer_critere_externe	o16129	g$tables_relations	o16198	fcalculer_param_date	o16669	fcalculer_param_dynamique	o17144	fcalculer_params_dynamiques	o17937
inc-public.php3	g$page	o55	g$fond	o76	g$delais	o83	g$contexte_inclus	o92	g$fichier_inclus	o110	g$page	o134	g$page	o173	g$page	o214	g$page	o237	d_INC_PUBLIC	o322	g$INSECURE	o449	g$INSECURE	o470	g$delais	o511	g$delais	o523	g$recherche	o548	g$delais	o562	g$HTTP_COOKIE_VARS	o614	g$PHP_AUTH_USER	o653	g$ignore_auth_http	o673	g$forcer_lang	o784	g$forcer_lang	o802	g$HTTP_POST_VARS	o834	g$HTTP_GET_VARS	o920	g$HTTP_GET_VARS	o995	g$ajout_forum	o1143	g$redirect	o1161	g$redirect	o1216	g$redirect	o1247	g$val_confirm	o1267	g$id_article	o1356	g$val_confirm	o1369	g$var_mode	o1509	g$code_activation_debug	o1538	g$auteur_session	o1576	g$var_mode	o1652	g$affiche_boutons_admin	o1700	g$flag_preserver	o1727	g$HTTP_COOKIE_VARS	o1749	g$HTTP_COOKIE_VARS	o1785	g$tableau_des_erreurs	o1868	g$page	o1901	g$fond	o1932	g$delais	o1939	g$use_cache	o1948	g$flag_preserver	o1968	g$flag_dynamique	o2061	g$var_mode	o2080	g$HTTP_COOKIE_VARS	o2095	g$lastmodified	o2274	g$lastmodified	o2333	g$page	o2426	g$fond	o2541	g$f!
 lag_ob	o2578	g$var_mode	o2594	g$var_recherche	o2618	g$affiche_boutons_admin	o2636	g$page	o2718	g$page	o2785	g$contenu	o2804	g$contenu	o2831	g$page	o2842	g$page	o2974	g$contenu	o2994	g$res	o3039	g$page	o3063	g$contenu	o3083	g$res	o3234	g$affiche_boutons_admin	o3253	g$auteur_session	o3283	g$var_mode	o3496	g$var_mode_objet	o3580	g$var_mode_affiche	o3596	g$tableau_des_erreurs	o3642	g$affiche_boutons_admin	o3673	g$tableau_des_erreurs	o3721	g$var_recherche	o3800	g$contenu	o3859	g$contenu	o3885	g$var_recherche	o3895	g$affiche_boutons_admin	o3969	g$contenu	o4032	g$contenu	o4055	g$contenu	o4107	g$affiche_boutons_admin	o4229	g$id_article	o4308	g$id_breve	o4321	g$id_rubrique	o4332	g$id_mot	o4346	g$id_auteur	o4355
spip_image.php3	feffacer_image	o199	g$hash_id_auteur	o229	g$hash	o246	ftester_vignette	o397	g$djpeg_command	o440	g$cjpeg_command	o456	g$pnmscale_command	o472	fdeplacer_fichier_upload	o3248	fdecoder_type_image	o4037	fcorriger_extension	o4410	fajout_image	o4620	g$redirect_url	o4658	g$hash_id_auteur	o4673	g$hash	o4690	g$num_img	o4697	g$dossier_squelettes	o4707	fgdRotate	o5469	fcreer_fichier_vignette	o6960	fsupprime_document_et_vignette	o7587	g$hash_id_auteur	o7638	g$hash	o7655	ftourner_document	o9049	g$hash_id_auteur	o9117	g$hash	o9134	g$test_vignette	o11086	g$redirect	o11131	g$test_vignette	o11159	g$vignette	o11184	g$redirect	o11218	g$vignette	o11253	g$retour	o11275	g$redirect	o11285	g$redirect	o11299	g$ajout_doc	o11322	g$image_name	o11392	g$image2	o11408	g$image	o11421	g$image2	o11447	g$image_name	o11458	g$image	o11472	g$image_name	o11505	g$image	o11534	g$image_name	o11542	g$mode	o11555	g$forcer_document	o11562	g$id_document	o11580	g$hash	o11594	g$link	o11669	g$link	o11709	g$!
 link	o11747	g$retour	o11773	g$link	o11786	g$id_document	o11815	g$link	o11833	g$id_article	o11861	g$link	o11878	g$mode	o11900	g$link	o11911	g$type	o11933	g$link	o11944	g$hash	o11966	g$link	o11977	g$hash_id_auteur	o12009	g$image	o12044	g$image_name	o12052	g$mode	o12065	g$forcer_document	o12072	g$action_zip	o12090	g$id_document	o12103	g$hash	o12117	g$link	o12124	g$ajout_logo	o12151	g$image	o12186	g$logo	o12194	g$image_supp	o12213	g$image_supp	o12241	g$doc_supp	o12266	g$doc_supp	o12334	g$doc_rotate	o12357	g$var_rot	o12388	g$doc_rotate	o12398	g$convert_command	o12411	g$redirect	o12440	g$HTTP_POST_VARS	o12459	g$vars	o12476	g$HTTP_POST_VARS	o12484	g$vars	o12507	g$HTTP_GET_VARS	o12515	g$redirect	o12532	g$vars	o12544	g$link	o12564	g$redirect	o12602	g$vars	o12621	g$key	o12643	g$val	o12649	g$vars	o12663	g$key	o12794	g$link	o12808	g$key	o12822	g$val	o12828	g$id_document	o12848	g$link	o12865	g$id_document	o12893	g$type	o12913	g$link	o12937	g$redirect	o12969	g$link	o12981	g$redirect	o130!
 23
inc-public-global.php3	d_INC_PUBLIC_GLOBAL	o99	fobtenir_page	o190	g$lastmodified	o287	fafficher_page_globale	o2149	g$flag_preserver	o2211	g$flag_dynamique	o2228	g$lastmodified	o2245	g$var_preview	o2268	g$var_mode	o2282	fterminer_public_global	o5637	fmasquer_les_bugs	o6277	finclure_page	o6333	finclure_balise_dynamique	o7253
ecrire/calendrier_semaine.php3	g$mois	o69	g$today	o79	g$jour	o105	g$today	o111	g$mois	o129	g$today	o135	g$annee	o152	g$today	o159	g$date	o178	g$mois	o213	g$jour	o220	g$annee	o227	g$jour	o237	g$date	o253	g$mois	o261	g$date	o274	g$annee	o282	g$date	o297	g$afficher_bandeau_calendrier	o306	g$afficher_bandeau_calendrier_semaine	o343	g$date	o464	g$annee	o483	g$jour	o561	g$mois	o567	g$annee	o573
ecrire/lang/public_it.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/lang/spip_ca.php3	g$GLOBALS	o80	g$GLOBALS	o89
inc-menu_lang.php3	g$balise_MENU_LANG_collecte	o14	g$balise_MENU_LANG_collecte	o42	fbalise_MENU_LANG_stat	o168	fbalise_MENU_LANG_dyn	o370
ecrire/forum.php3	g$admin	o124	g$statutforum	o204	g$logo	o231	g$urlforum	o262	g$statutforum	o367	g$logo	o394	g$urlforum	o427	g$admin	o572	g$admin	o696	g$connect_statut	o716	g$debut	o828	g$debut	o836	g$query_forum	o849	g$result_forum	o950	g$query_forum	o977	g$total	o992	g$row	o1008	g$result_forum	o1032	g$total	o1048	g$row	o1057	g$total	o1075	g$i	o1109	g$i	o1117	g$total	o1122	g$i	o1130	g$i	o1135	g$i	o1151	g$i	o1177	g$debut	o1183	g$logo	o1497	g$query_forum	o1561	g$result_forum	o1687	g$query_forum	o1712	g$result_forum	o1743	g$urlforum	o1757
ecrire/inc_texte.php3	d_ECRIRE_INC_TEXTE	o101	ftester_variable	o467	g$INSECURE	o508	g$lang2	o1572	g$GLOBALS	o1592	g$GLOBALS	o1636	g$lang2	o1682	g$GLOBALS	o1693	g$GLOBALS	o1739	g$lang2	o1765	fnettoyer_chapo	o1874	fspip_avant_propre	o2047	fspip_apres_propre	o2183	fspip_avant_typo	o2281	fspip_apres_typo	o2413	fechappe_html	o3206	fechappe_retour	o6508	fsupprime_img	o7406	fechappe_retour_doublon	o7760	fcouper	o8099	fcouper_intro	o10116	finterdire_scripts	o10814	ftypo_fr	o10991	g$flag_strtr2	o11019	vtrans	o11042	ftypo_en	o12548	ftypo_generale	o13110	g$spip_lang	o13144	g$lang_typo	o13156	ftypo	o13534	ftypo_doublon	o13807	fextraire_lien	o14328	ftraiter_listes	o17975	ftraiter_raccourcis_generale	o19962	g$debut_intertitre	o20010	g$fin_intertitre	o20029	g$ligne_horizontale	o20046	g$url_glossaire_externe	o20066	g$compt_note	o20098	g$marqueur_notes	o20119	g$ouvre_ref	o20144	g$ferme_ref	o20164	g$ouvre_note	o20184	g$ferme_note	o20205	g$flag_pcre	o20226	g$lang_dir	o20246	ftraiter_les_notes	!
 o28045	ftraiter_raccourcis	o28484	ftraiter_raccourcis_doublon	o28926	fpropre	o29420
index.php3
ecrire/calendrier.php3	g$HTTP_GET_VARS	o17	g$HTTP_GET_VARS	o49	g$HTTP_GET_VARS	o143	g$today	o285	g$mois	o349	g$annee	o356	g$today	o363	g$mois	o378	g$today	o384	g$periode	o401	g$annee	o412	g$mois	o443	g$afficher_bandeau_calendrier	o460	g$periode	o573	g$annee	o595	g$mois	o671	g$annee	o677
ecrire/mots_tous.php3	g$conf_mot	o34	g$query	o50	g$result	o112	g$query	o133	g$row	o147	g$result	o171	g$id_mot	o185	g$row	o195	g$titre_mot	o213	g$row	o231	g$type_mot	o249	g$row	o266	g$connect_statut	o288	g$aff_articles	o318	g$aff_articles	o367	g$nb_articles	o399	g$nb_articles	o683	g$nb_articles	o698	g$nb_rubriques	o717	g$nb_rubriques	o926	g$nb_rubriques	o942	g$nb_breves	o962	g$nb_breves	o1224	g$nb_breves	o1237	g$nb_sites	o1254	g$nb_sites	o1521	g$nb_sites	o1533	g$nb_articles	o1554	g$nb_breves	o1569	g$nb_sites	o1582	g$connect_statut	o1739	g$modifier_groupe	o1778	g$change_type	o1809	g$change_type	o1855	g$ancien_type	o1873	g$ancien_type	o1919	g$ancien_type	o1942	g$query	o1977	g$query	o2073	g$query	o2086	g$query	o2408	g$query	o2450	g$query	o2744	g$supp_group	o2766	g$type	o2782	g$supp_group	o2799	g$query	o2815	g$result	o2887	g$query	o2906	g$conf_mot	o3135	g$nb_articles	o3155	g$texte_lie	o3178	g$nb_articles	o3230	g$texte_lie	o3252	g$nb_articles	o3315	g$nb_breves	o3344	g$texte_lie	o3!
 365	g$nb_breves	o3417	g$texte_lie	o3437	g$nb_breves	o3497	g$nb_sites	o3523	g$texte_lie	o3543	g$nb_sites	o3593	g$texte_lie	o3612	g$nb_sites	o3670	g$nb_rubriques	o3695	g$texte_lie	o3719	g$nb_rubriques	o3774	g$texte_lie	o3797	g$nb_rubriques	o3863	g$titre_mot	o3992	g$type_mot	o4018	g$texte_lie	o4044	g$connect_statut	o4488	g$aff_articles	o4518	g$aff_articles	o4566	g$result_articles	o4602	g$row_articles	o4841	g$result_articles	o4875	g$id_mot	o4896	g$row_articles	o4906	g$total_articles	o4932	g$row_articles	o4950	g$nb_articles	o4973	g$id_mot	o4986	g$total_articles	o4997	g$result_rubriques	o5018	g$row_rubriques	o5227	g$result_rubriques	o5261	g$id_mot	o5283	g$row_rubriques	o5293	g$total_rubriques	o5320	g$row_rubriques	o5339	g$nb_rubriques	o5363	g$id_mot	o5377	g$total_rubriques	o5388	g$result_breves	o5409	g$row_breves	o5633	g$result_breves	o5664	g$id_mot	o5683	g$row_breves	o5693	g$total_breves	o5717	g$row_breves	o5733	g$nb_breves	o5754	g$id_mot	o5765	g$total_breves	o5776	g$result_synd!
 ic	o5794	g$row_syndic	o6023	g$result_syndic	o6054	g$id_mot	o6073	g$row
_syndic	o6083	g$total_sites	o6107	g$row_syndic	o6122	g$nb_sites	o6143	g$id_mot	o6153	g$total_sites	o6164	g$query_groupes	o6234	g$result_groupes	o6301	g$query_groupes	o6330	g$row_groupes	o6355	g$result_groupes	o6387	g$id_groupe	o6408	g$row_groupes	o6421	g$titre_groupe	o6449	g$row_groupes	o6470	g$unseul	o6495	g$row_groupes	o6505	g$obligatoire	o6530	g$row_groupes	o6545	g$articles	o6575	g$row_groupes	o6587	g$breves	o6614	g$row_groupes	o6624	g$rubriques	o6649	g$row_groupes	o6662	g$syndic	o6690	g$row_groupes	o6700	g$acces_minirezo	o6725	g$row_groupes	o6743	g$acces_comite	o6771	g$row_groupes	o6787	g$acces_forum	o6813	g$row_groupes	o6828	g$titre_groupe	o6938	g$articles	o7090	g$breves	o7164	g$rubriques	o7235	g$syndic	o7309	g$unseul	o7389	g$obligatoire	o7409	g$unseul	o7450	g$obligatoire	o7518	g$acces_minirezo	o7616	g$acces_comite	o7701	g$acces_forum	o7779	g$query	o7918	g$result	o8001	g$query	o8022	g$table	o8032	g$result	o8066	g$row	o8233	g$result	o8257	g$vals	o8275	g$id_mot	o8294	g$ro!
 w	o8304	g$titre_mot	o8323	g$row	o8336	g$connect_statut	o8359	g$aff_articles	o8395	g$aff_articles	o8449	g$id_mot	o8486	g$conf_mot	o8495	g$couleur	o8512	g$ifond	o8523	g$couleur_claire	o8544	g$ifond	o8565	g$ifond	o8574	g$connect_statut	o8595	g$nb_articles	o8629	g$id_mot	o8642	g$s	o8661	g$titre_mot	o8756	g$s	o8790	g$titre_mot	o8800	g$vals	o8818	g$s	o8828	g$texte_lie	o8837	g$nb_articles	o8868	g$id_mot	o8881	g$texte_lie	o8901	g$nb_articles	o8951	g$id_mot	o8964	g$texte_lie	o8983	g$nb_articles	o8998	g$id_mot	o9011	g$nb_breves	o9057	g$id_mot	o9068	g$texte_lie	o9088	g$nb_breves	o9136	g$id_mot	o9147	g$texte_lie	o9166	g$nb_breves	o9181	g$id_mot	o9192	g$nb_sites	o9236	g$id_mot	o9246	g$texte_lie	o9266	g$nb_sites	o9313	g$id_mot	o9323	g$texte_lie	o9342	g$nb_sites	o9357	g$id_mot	o9367	g$nb_rubriques	o9407	g$id_mot	o9421	g$texte_lie	o9441	g$nb_rubriques	o9497	g$id_mot	o9511	g$texte_lie	o9530	g$nb_rubriques	o9545	g$id_mot	o9559	g$texte_lie	o9602	g$texte_lie	o9620	g$vals	o9647	g$texte_lie	o965!
 7	g$connect_statut	o9679	g$vals	o9716	g$table	o9925	g$vals	o9936	g$con
nect_statut	o9969	g$largeurs	o10004	g$styles	o10040	g$largeurs	o10104	g$styles	o10135	g$largeurs	o10194	g$table	o10205	g$styles	o10213	g$supprimer_groupe	o10286	g$connect_statut	o10329	g$supprimer_groupe	o10363	g$connect_statut	o10395	g$conf_mot	o10430	g$supprimer_groupe	o10674	g$connect_statut	o11224	g$conf_mot	o11259
ecrire/inc_config.php3	d_ECRIRE_INC_CONFIG	o102	finit_config	o421	favertissement_config	o2312	g$spip_lang_right	o2345	g$spip_lang_left	o2363	fbouton_radio	o2750	vid_label	o2826	fafficher_choix	o3174	fappliquer_modifs_config	o3445	g$clean_link	o3481	g$connect_id_auteur	o3494	g$adresse_site	o3522	g$email_webmaster	o3537	g$email_envoi	o3555	g$post_dates	o3569	g$tester_proxy	o3582	g$test_proxy	o3597	g$activer_moteur	o3610	g$forums_publics	o3635	g$forums_publics_appliquer	o3652	g$charset	o3687	g$charset_custom	o3697	g$langues_auth	o3714
inc-calcul-outils.php3	d_INC_CALCUL_OUTILS	o507	fcalcule_fichier_logo	o790	faffiche_logos	o1071	vnum_survol	o1119	g$espace_logos	o1141	fcalcule_logo	o1785	fcalcul_introduction	o2877	fexecuter_balise_dynamique	o3672	fcalcul_exposer	o4298	vexposer	o4349	vref_precedente	o4367	ftable_from_primary	o5293	g$tables_principales	o5327	fcalcul_generation	o5566	fcalcul_branche	o5929	fcalcule_document	o6208	fcalcule_embed_document	o8149	fcalculer_notes	o8406	fsql_profondeur	o8609	fsql_parent	o8716	fsql_rubrique	o8904	fsql_auteurs	o9094	fsql_petitions	o9836	fsql_chapo	o10310	fsql_rubrique_fond	o10589
ecrire/lang/spip_de.php3	g$GLOBALS	o80	g$GLOBALS	o89
inc-compilo-index.php3	d_INC_COMPILO_INDEX	o180	findex_pile	o709	g$exceptions_des_tables	o775	g$table_des_tables	o799	g$tables_des_serveurs_sql	o818	fcalculer_champ	o2879	fchamp_sql	o3529	fcalculer_balise	o3714	fcalculer_balise_dynamique	o5023	fparam_balise	o5441	fcollecter_balise_dynamique	o5800	fapplique_filtres	o6001	ffiltres_arglist	o7349	fcalculer_argument_precedent	o7969	frindex_pile	o8369
spip_login.php3	g$fond	o6	g$delais	o23	g$flag_dynamique	o39	g$flag_preserver	o63	g$forcer_lang	o87
ecrire/lang/public_ca.php3	g$GLOBALS	o80	g$GLOBALS	o89
spip_pass.php3	fformulaire_oubli_dyn	o439	g$p	o2558	g$oubli	o2562
ecrire/inc_visites.php3	d_ECRIRE_INC_VISITES	o100	fcalculer_visites	o139
spip_acces_doc.php3	g$id_document	o247	g$_GET	o263	g$file	o286	g$_GET	o304	g$file	o331	g$refus	o357	g$refus	o382	g$auteur_session	o562	g$cookie_session	o587	g$HTTP_COOKIE_VARS	o605	g$cookie_session	o671	g$auteur_session	o704	g$auteur_session	o751	g$auth_login	o799	g$auteur_session	o813	g$id_document	o862	g$id_document	o884	g$file	o1008	g$id_document	o1032	g$refus	o1046	g$id_document	o1064	g$id_document	o1079	g$file	o1127	g$id_document	o1235	g$file	o1267	g$refus	o1274	g$file	o1292	g$file	o1300	g$auth_login	o1334	g$refus	o1350	g$id_document	o1623	g$id_document	o1935	g$id_document	o2208	g$refus	o2247	g$refus	o2271	g$file	o2331	g$file	o2381	g$file	o2459	g$file	o2539	g$_GET	o2610	g$_GET	o2641
ecrire/lang/spip_cpf.php3	g$GLOBALS	o80	g$GLOBALS	o89
ecrire/inc_presentation.php3	d_ECRIRE_INC_PRESENTATION	o113	faide	o322	g$couleur_foncee	o348	g$spip_lang	o365	g$spip_lang_rtl	o377	g$spip_display	o393	fbouton_imessage	o972	g$connect_id_auteur	o1104	g$spip_lang_rtl	o1133	g$couche_invisible	o1158	fhr	o2208	fdebut_cadre	o2435	g$browser_name	o2508	g$spip_display	o2532	g$spip_lang_left	o2547	vaccesskey	o2574	ffin_cadre	o4077	fdebut_cadre_relief	o4309	ffin_cadre_relief	o4522	fdebut_cadre_enfonce	o4668	ffin_cadre_enfonce	o4882	fdebut_cadre_sous_rub	o5031	ffin_cadre_sous_rub	o5251	fdebut_cadre_forum	o5406	ffin_cadre_forum	o5622	fdebut_cadre_thread_forum	o5769	ffin_cadre_thread_forum	o5999	fdebut_cadre_gris_clair	o6160	ffin_cadre_gris_clair	o6386	fdebut_cadre_couleur	o6545	ffin_cadre_couleur	o6763	fdebut_cadre_couleur_foncee	o6916	ffin_cadre_couleur_foncee	o7148	fdebut_cadre_trait_couleur	o7313	ffin_cadre_trait_couleur	o7543	fdebut_boite_alerte	o7739	ffin_boite_alerte	o7956	fdebut_boite_info	o8079	ffin_boite_info	o8638	fbandeau_titr!
 e_boite	o8765	g$couleur_foncee	o8849	fbandeau_titre_boite2	o9531	g$spip_lang_left	o9626	g$spip_display	o9643	fdebut_raccourcis	o10429	g$spip_display	o10459	ffin_raccourcis	o10800	g$spip_display	o10828	fafficher_plus	o11006	g$options	o11038	g$spip_lang_right	o11048	g$browser_name	o11066	fafficher_liste	o11485	g$couleur_claire	o11544	g$browser_name	o11570	g$spip_display	o11594	g$spip_lang_left	o11618	fafficher_tranches_requete	o12802	vancre	o12859	g$spip_lang_right	o12879	g$spip_display	o12897	fafficher_liste_debut_tableau	o14918	g$spip_display	o14960	fafficher_liste_fin_tableau	o15092	g$spip_display	o15132	fpuce_statut_article	o15209	g$spip_lang_left	o15262	g$dir_lang	o15279	g$connect_statut	o15290	g$options	o15307	g$browser_name	o15317	fpuce_statut_breve	o18020	g$spip_lang_left	o18069	g$dir_lang	o18086	g$connect_statut	o18097	g$options	o18114	g$browser_name	o18124	fafficher_articles	o20112	g$connect_id_auteur	o20304	g$connect_statut	o20324	g$dir_lang	o20341	g$options	o20361!
 	g$spip_display	o20371	g$spip_lang_left	o20395	g$spip_lang_right	o2041
2	fafficher_breves	o26775	g$connect_id_auteur	o26841	g$spip_lang_right	o26861	g$spip_lang_left	o26879	g$dir_lang	o26896	g$couleur_claire	o26907	g$couleur_foncee	o26924	g$options	o26950	fafficher_rubriques	o30585	g$connect_id_auteur	o30639	g$spip_lang_rtl	o30668	fbonhomme_statut	o32055	g$connect_statut	o32088	fpuce_statut	o33022	fafficher_auteurs	o33299	fafficher_messages	o34693	g$messages_vus	o34846	g$connect_id_auteur	o34870	g$couleur_claire	o34899	g$couleur_foncee	o34916	g$spip_lang_rtl	o34942	g$spip_lang_left	o34958	fafficher_forum	o39097	g$debut	o39176	vcompteur_forum	o39194	vnb_forum	o39220	vi	o39240	g$couleur_foncee	o39252	g$connect_id_auteur	o39278	g$connect_activer_messagerie	o39298	g$mots_cles_forums	o39336	g$spip_lang_rtl	o39364	g$spip_lang_left	o39380	g$spip_lang_right	o39397	g$spip_display	o39415	fafficher_thread_forum	o45671	fbouton	o46178	fdebut_html	o46728	g$couleur_foncee	o46789	g$couleur_claire	o46806	g$couleur_lien	o46823	g$couleur_lien_off	o46838	g$mode	o4!
 6866	g$spip_lang_rtl	o46873	g$spip_display	o46889	g$connect_statut	o46913	g$connect_toutes_rubriques	o46930	fdebut_javascript	o49334	g$spip_lang_left	o49378	g$browser_name	o49404	g$browser_version	o49419	g$browser_rev	o49437	fonglet_relief_inter	o57273	g$spip_display	o57305	fdebut_onglet	o57367	g$spip_display	o57392	ffin_onglet	o57557	g$spip_display	o57580	fonglet	o57655	g$spip_display	o57720	g$spip_lang_left	o57735	fbarre_onglets	o58927	g$id_auteur	o58971	g$connect_id_auteur	o58983	g$connect_statut	o59003	g$statut_auteur	o59020	g$options	o59036	flargeur_icone_bandeau_principal	o62316	g$spip_display	o62367	g$spip_ecran	o62382	g$connect_statut	o62405	g$connect_toutes_rubriques	o62422	ficone_bandeau_principal	o62847	g$spip_display	o63014	g$spip_ecran	o63029	g$couleur_foncee	o63042	g$menu_accesskey	o63069	g$compteur_survol	o63086	ficone_bandeau_secondaire	o64453	g$spip_display	o64557	g$menu_accesskey	o64581	g$compteur_survol	o64598	ficone	o65997	g$spip_display	o66077	g$couleur!
 _claire	o66092	g$couleur_foncee	o66109	g$compteur_survol	o66126	ficone
_horizontale	o67405	g$spip_display	o67507	g$couleur_claire	o67522	g$couleur_foncee	o67539	g$compteur_survol	o67556	fbandeau_barre_verticale	o68479	flien_change_var	o68595	fafficher_menu_rubriques	o68864	g$spip_lang_rtl	o68901	g$spip_ecran	o68917	fdebut_page	o69107	g$couleurs_spip	o69207	g$couleur_foncee	o69232	g$couleur_claire	o69258	g$adresse_site	o69284	g$connect_id_auteur	o69308	g$connect_statut	o69337	g$connect_activer_messagerie	o69363	g$connect_toutes_rubriques	o69401	g$auth_can_disconnect	o69437	g$connect_login	o69459	g$options	o69484	g$spip_display	o69494	g$spip_ecran	o69509	g$spip_lang	o69531	g$spip_lang_rtl	o69543	g$spip_lang_left	o69559	g$spip_lang_right	o69576	fafficher_javascript	o87588	g$recherche	o93211	g$changer_config	o100521	g$activer_messagerie	o100547	g$activer_imessage	o100577	g$connect_activer_messagerie	o100605	g$connect_activer_imessage	o100643	fgros_titre	o101781	g$couleur_foncee	o101823	g$spip_display	o101840	fdebut_grand_cadre	o102255	g$spip_ecran	!
 o102285	ffin_grand_cadre	o102538	fdebut_cadre_formulaire	o102627	ffin_cadre_formulaire	o102711	fdebut_gauche	o102817	g$connect_statut	o102864	g$cookie_admin	o102881	g$options	o102905	g$spip_display	o102915	g$connect_id_auteur	o102939	g$spip_ecran	o102968	g$flag_3_colonnes	o102990	g$flag_centre_large	o103008	g$spip_lang_rtl	o103037	fcreer_colonne_droite	o103772	g$deja_colonne_droite	o103817	g$changer_config	o103848	g$activer_messagerie	o103874	g$activer_imessage	o103904	g$connect_activer_messagerie	o103932	g$connect_activer_imessage	o103970	g$connect_statut	o104006	g$cookie_admin	o104023	g$options	o104047	g$connect_id_auteur	o104066	g$spip_ecran	o104086	g$flag_3_colonnes	o104108	g$flag_centre_large	o104126	g$spip_lang_rtl	o104155	g$lang_left	o104171	fdebut_droite	o104746	g$options	o104784	g$spip_ecran	o104794	g$deja_colonne_droite	o104807	g$spip_display	o104829	g$connect_id_auteur	o104853	g$connect_statut	o104873	g$connect_toutes_rubriques	o104890	g$flag_3_colonnes	o104926	g!
 $flag_centre_large	o104944	g$couleur_foncee	o104964	g$couleur_claire	o
104981	g$lang_left	o105007	ffin_html	o107978	ffin_page	o108417	g$spip_version_affichee	o108450	g$spip_display	o108474	g$connect_id_auteur	o108498	g$multi_popup	o108527	fafficher_hierarchie	o109278	g$couleur_foncee	o109336	g$spip_lang_left	o109353	g$lang_dir	o109370	finstall_debut_html	o110743	g$spip_lang_rtl	o110790	finstall_fin_html	o112190	fvoir_en_ligne	o112354	g$connect_statut	o112431	fhttp_img_pack	o113791	vnum	o113836	fhttp_style_background	o113995	fhttp_href_img	o114162
ecrire/upgrade.php3	g$spip_lang	o361	g$langue_site	o384	g$spip_lang	o404	g$spip_lang	o416	g$reinstall	o488	g$link	o710	g$link	o768	g$upgrade_titre	o952	g$commentaire	o1033	g$spip_version	o1171	g$commentaire	o1229	g$spip_version	o1312	g$upgrade_titre	o1428	g$commentaire	o1444	g$ok	o1509	g$ok	o1532	g$upgrade_titre	o1586	g$ok	o1608	g$hash	o1616	g$spip_version	o1909
ecrire/inc_session.php3	d_ECRIRE_INC_SESSION	o102	g$GLOBALS	o289	fhash_env	o382	g$HTTP_SERVER_VARS	o403	ffichier_session	o564	fajouter_session	o819	fverifier_session	o1454	fsupprimer_session	o2453	fcreer_cookie_session	o2876	fcreer_uniqid	o3156	vseeded	o3182	fzap_sessions	o3598	fverifier_php_auth	o4328	g$PHP_AUTH_USER	o4358	g$PHP_AUTH_PW	o4374	g$ignore_auth_http	o4388	fask_php_auth	o5220	fverifier_visiteur	o5776
ecrire/inc_lang.php3	d_ECRIRE_INC_LANG	o97	fecrire_cache_lang	o173	fecrire_caches_langues	o1005	g$cache_lang_modifs	o1039	fcharger_langue	o1280	fchanger_langue	o2811	g$all_langs	o2843	g$spip_lang_rtl	o2855	g$spip_lang_right	o2871	g$spip_lang_left	o2889	g$spip_lang_dir	o2906	g$spip_dir_lang	o2922	fregler_langue_navigateur	o3465	g$HTTP_SERVER_VARS	o3502	g$HTTP_COOKIE_VARS	o3521	ftraduire_chaine	o3929	g$spip_lang	o3969	g$cache_lang	o3989	ftraduire_nom_langue	o5130	finit_codes_langues	o5311	flang_dir	o10206	flang_typo	o10364	fchanger_typo	o10638	g$lang_typo	o10687	g$lang_dir	o10699	g$dir_lang	o10710	flang_select	o11113	g$pile_langues	o11146	g$spip_lang	o11161	flang_dselect	o11283	g$pile_langues	o11317	fmenu_langues	o11597	g$couleur_foncee	o11687	g$couleur_claire	o11704	g$connect_id_auteur	o11721	fliste_options_langues	o13440	fverifier_lang_url	o14404	g$HTTP_GET_VARS	o14434	g$HTTP_COOKIE_VARS	o14450	g$spip_lang	o14469	g$clean_link	o14481	futiliser_langue_site	o15625	futiliser_lan!
 gue_visiteur	o15704	g$HTTP_COOKIE_VARS	o15741	finit_langues	o16130	g$all_langs	o16155	g$langue_site	o16167	g$cache_lang	o16181	g$cache_lang_modifs	o16194	g$pile_langues	o16222	g$lang_typo	o16237	g$lang_dir	o16249
inc-urls-standard.php3	d_INC_URLS2	o76	fgenerer_url_article	o106	fgenerer_url_rubrique	o200	fgenerer_url_breve	o299	fgenerer_url_mot	o383	fgenerer_url_auteur	o457	fgenerer_url_document	o546	frecuperer_parametres_url	o896	g$contexte	o944	fracine_forum	o1074	fgenerer_url_forum	o1664
sommaire.php3	g$fond	o6	g$delais	o26
inc-login_prive.php3	g$balise_LOGIN_PRIVE_collecte	o55	g$balise_LOGIN_PRIVE_collecte	o85	fbalise_LOGIN_PRIVE_stat	o308	fbalise_LOGIN_PRIVE_dyn	o427
ecrire/config-contenu.php3	g$connect_statut	o71	g$connect_toutes_rubriques	o106	g$changer_config	o210	fmySel	o293	g$forums_publics	o972	g$forums_publics	o1194	g$block	o1220	g$block	o1255	g$forums_publics	o1362	g$forums_publics	o1712	g$block	o1745	g$block	o1780	g$forums_publics	o1900	g$forums_publics	o2013	g$block	o2042	g$block	o2077	g$forums_publics	o2189	g$forums_publics	o2323	g$block	o2349	g$block	o2385	g$forums_publics	o2504	g$options	o2721	g$options	o4172	g$accepter_inscriptions	o4296	g$accepter_inscriptions	o4738	g$accepter_inscriptions	o5067	g$accepter_visiteurs	o5104	g$forums_publics	o5508	g$accepter_visiteurs	o5850	g$prevenir_auteurs	o6557	g$prevenir_auteurs	o7270	g$suivi_edito	o7503	g$adresse_suivi	o7543	g$adresse_suivi_inscription	o7587	g$suivi_edito	o8220	g$suivi_edito	o8318	g$style	o8341	g$style	o8377	g$adresse_suivi	o8640	g$adresse_suivi	o8656	g$adresse_suivi	o8753	g$suivi_edito	o9052	g$quoi_de_neuf	o9230	g$adresse_neuf	o9272	g$jours_neuf	o9314	g$envoi_now	o9357!
 	g$jours_neuf	o9411	g$quoi_de_neuf	o9944	g$quoi_de_neuf	o10239	g$style	o10263	g$style	o10299	g$quoi_de_neuf	o10914	g$options	o11250	g$email_envoi	o11278	g$options	o12114
ecrire/inc_logos.php3	d_ECRIRE_INC_LOGOS	o101	fcherche_image_nommee	o139	fdecrire_logo	o669	g$connect_id_auteur	o701	fresize_logo	o1606	fafficher_boite_logo	o2095	g$options	o2162	g$spip_display	o2172	fafficher_logo	o2601	g$id_article	o2649	g$id_rubrique	o2662	g$id_breve	o2676	g$id_auteur	o2687	g$id_mot	o2699	g$id_syndic	o2708	g$connect_id_auteur	o2720	g$couleur_foncee	o2748	g$couleur_claire	o2765	g$clean_link	o2790	fimage_ratio	o5831	fcreer_vignette	o6321	g$convert_command	o6438	g$djpeg_command	o6456	g$cjpeg_command	o6472	g$pnmscale_command	o6488	finserer_vignette_base	o12138	freduire_image_logo	o13297
ecrire/inc_cron.php3	d_ECRIRE_INC_CRON	o97	fspip_cron	o1920	g$frequence_taches	o1958	ftaches_generales	o3131	g$frequence_taches	o4277	g$frequence_taches	o4296	fcron_rubriques	o4665	fcron_index	o4732	fcron_sites	o4804	fcron_statistiques	o5132	fcron_popularites	o5342	fcron_visites	o5509	fcron_mail	o5747	fcron_invalideur	o6912	g$quota_cache	o7373
auteur.php3	g$fond	o6	g$delais	o24
ecrire/articles_edit.php3	g$articles_surtitre	o104	g$articles_soustitre	o157	g$articles_descriptif	o212	g$articles_urlref	o269	g$articles_chapeau	o318	g$articles_ps	o369	g$articles_redac	o410	g$articles_mots	o457	g$articles_modif	o502	g$id_article	o562	g$id_article	o583	g$id_rubrique	o597	g$id_rubrique	o619	g$lier_trad	o634	g$lier_trad	o654	g$flag_editable	o674	g$id_article	o734	g$id_article_bloque	o870	g$id_article	o891	g$query	o978	g$result	o1048	g$query	o1069	g$row	o1084	g$result	o1108	g$id_article	o1122	g$row	o1136	g$surtitre	o1158	g$row	o1170	g$titre	o1190	g$row	o1199	g$soustitre	o1216	g$row	o1229	g$id_rubrique	o1250	g$row	o1265	g$id_secteur	o1288	g$row	o1302	g$descriptif	o1324	g$row	o1338	g$nom_site	o1360	g$row	o1372	g$url_site	o1392	g$row	o1404	g$chapo	o1424	g$row	o1433	g$texte	o1450	g$row	o1459	g$ps	o1476	g$row	o1482	g$date	o1496	g$row	o1504	g$statut	o1520	g$row	o1530	g$date_redac	o1548	g$row	o1562	g$date_redac	o1632	g$regs	o1644	g$mois_redac	o1663	g$regs	o1677	g$jou!
 r_redac	o1697	g$regs	o1711	g$annee_redac	o1731	g$regs	o1746	g$annee_redac	o1770	g$annee_redac	o1791	g$extra	o1819	g$row	o1826	g$query	o1844	g$result_auteur	o1956	g$query	o1984	g$flag_auteur	o1995	g$result_auteur	o2025	g$flag_editable	o2050	g$id_rubrique	o2083	g$flag_auteur	o2101	g$statut	o2123	g$statut	o2145	g$new	o2166	g$new	o2198	g$lier_trad	o2218	g$changer_lang	o2272	g$query	o2339	g$result	o2409	g$query	o2430	g$row	o2447	g$result	o2471	g$surtitre	o2486	g$row	o2498	g$titre	o2519	g$row	o2580	g$soustitre	o2598	g$row	o2611	g$id_rubrique_trad	o2633	g$row	o2653	g$descriptif	o2677	g$row	o2691	g$nom_site	o2714	g$row	o2726	g$url_site	o2747	g$row	o2759	g$chapo	o2780	g$row	o2789	g$texte	o2807	g$row	o2816	g$ps	o2834	g$row	o2840	g$date	o2855	g$row	o2863	g$date_redac	o2880	g$row	o2894	g$date_redac	o2961	g$regs	o2973	g$mois_redac	o2987	g$regs	o3001	g$jour_redac	o3015	g$regs	o3029	g$annee_redac	o3043	g$regs	o3058	g$annee_redac	o3076	g$annee_redac	o3097	g$extra	o3127	g$row	o3136	g$langue!
 s_autorisees	o3157	g$changer_lang	o3478	g$spip_lang	o3494	g$id_parent	
o3686	g$query	o3718	g$row_rub	o3803	g$query	o3842	g$id_parent	o3857	g$row_rub	o3870	g$query	o3903	g$row_rub	o4011	g$query	o4050	g$id_rubrique	o4067	g$id_secteur	o4082	g$row_rub	o4096	g$changer_lang	o4126	g$titre	o4218	g$onfocus	o4273	g$id_secteur	o4355	g$row_rub	o4372	g$id_secteur	o4487	g$row_rub	o4501	g$flag_editable	o4529	g$flag_editable	o4560	g$id_article	o4634	g$id_document	o4649	g$query_doc	o4666	g$result_doc	o4779	g$query_doc	o4804	g$flag_document_editable	o4818	g$result_doc	o4859	g$flag_document_editable	o4888	g$modif_document	o4924	g$GLOBALS	o4942	g$modif_document	o4974	g$flag_document_editable	o5003	g$titre_document	o5031	g$titre_document	o5080	g$descriptif_document	o5100	g$descriptif_document	o5154	g$query	o5179	g$largeur_document	o5281	g$hauteur_document	o5303	g$query	o5322	g$query	o5395	g$query	o5452	fcoupe_trop_long	o5539	g$titre	o6230	g$id_rubrique	o6332	g$new	o6441	g$id_article	o6485	g$flag_editable	o6509	g$id_article	o6709	g$id_article	o6835	fmySel	o6937	fmy_!
 sel	o7084	fafficher_mois	o7237	fafficher_jour	o7742	fenfant	o7874	g$id_parent	o7901	g$id_rubrique	o7921	vi	o7944	g$statut	o7973	g$connect_toutes_rubriques	o7990	g$couleur_claire	o8025	g$spip_lang_left	o8042	g$browser_name	o8067	g$browser_version	o8082	g$lier_trad	o10655	g$titre	o11021	g$titre	o11091	g$titre	o11113	g$soustitre	o11123	g$soustitre	o11149	g$surtitre	o11163	g$surtitre	o11188	g$descriptif	o11202	g$descriptif	o11229	g$nom_site	o11244	g$nom_site	o11269	g$url_site	o11282	g$url_site	o11307	g$chapo	o11320	g$chapo	o11342	g$texte	o11352	g$texte	o11374	g$ps	o11384	g$ps	o11403	g$lien	o11411	g$id_article	o11441	g$lien	o11454	g$id_article	o11561	g$new	o11654	g$lier_trad	o11730	g$options	o11893	g$articles_surtitre	o11920	g$surtitre	o11952	g$articles_soustitre	o12427	g$soustitre	o12460	g$id_rubrique	o12766	g$logo_parent	o12785	g$query	o12832	g$result	o12916	g$query	o12935	g$row	o12952	g$result	o12974	g$parent_parent	o12988	g$row	o13003	g$parent_parent	o13032	g$logo_parent	o13!
 053	g$logo_parent	o13093	g$new	o13489	g$options	o13588	g$articles_desc
riptif	o13615	g$descriptif	o13649	g$descriptif	o13882	g$options	o14015	g$articles_urlref	o14042	g$nom_site	o14072	g$url_site	o14085	g$chapo	o14406	g$virtuel	o14432	g$chapo	o14450	g$chapo	o14464	g$connect_statut	o14486	g$virtuel	o14519	g$virtuel	o15015	g$virtuel	o15025	g$articles_chapeau	o15438	g$chapo	o15469	g$spip_ecran	o15486	g$rows	o15510	g$rows	o15529	g$chapo	o15752	g$spip_ecran	o15878	g$rows	o15902	g$rows	o15920	g$texte	o15945	g$textes_supplement	o16008	g$texte	o16105	g$nombre_textes	o16129	g$texte1	o16156	g$texte	o16164	g$texte	o16190	g$textes_supplement	o16203	g$textes_supplement	o16236	g$nombre_textes	o16301	g$textes_supplement	o16321	g$GLOBALS	o16405	g$texte1	o16474	g$textes_supplement	o16653	g$GLOBALS	o16788	g$texte	o16872	g$articles_ps	o16910	g$options	o16936	g$ps	o16963	g$ps	o17104	g$champs_extra	o17212	g$extra	o17280	g$id_secteur	o17300	g$date	o17323	g$new	o17409
ecrire/export.php3	fliste_objets	o306	g$maj	o345	g$articles	o359	fliste_rubriques	o827	g$maj	o862	g$rubriques	o876	g$id_rubrique	o1569	g$query	o1584	g$query	o1662	g$query	o1747	g$rubriques	o1762	g$rubriques	o1777	g$rubriques	o1800	g$query	o1815	g$query	o1936	g$query	o1959	g$query	o2076	g$articles	o2101	g$articles	o2116	g$articles	o2138	g$query	o2153	g$query	o2358
ecrire/brouteur.php3	g$spip_ecran	o35	g$largeur_table	o63	g$hauteur_table	o87	g$nb_col	o111	g$largeur_table	o136	g$hauteur_table	o160	g$nb_col	o184	g$largeur_col	o201	g$largeur_table	o222	g$nb_col	o237	g$id_rubrique	o462	g$j	o480	g$nb_col	o485	g$id_rubrique	o503	g$query	o526	g$result	o616	g$query	o635	g$row	o653	g$result	o675	g$j	o690	g$j	o695	g$ze_rubrique	o705	g$row	o720	g$titre	o745	g$row	o759	g$id_rubrique	o779	g$row	o793	g$dest	o821	g$j	o827	g$ze_rubrique	o833	g$dest	o861	g$j	o867	g$dest	o891	g$i	o911	g$i	o919	g$nb_col	o924	g$i	o933	g$dest	o945	g$i	o951	g$dest	o957	g$i	o963	g$dest	o989	g$parent	o1006	g$dest	o1016	g$nb_col	o1022	g$la_rubrique	o1244	g$dest	o1259	g$query	o1276	g$result	o1353	g$query	o1374	g$row	o1393	g$result	o1417	g$la_rubrique	o1433	g$row	o1447	g$la_rubrique	o1485	g$query	o1509	g$result	o1587	g$query	o1608	g$row	o1628	g$result	o1652	g$compteur	o1669	g$compteur	o1681	g$ze_rubrique	o1701	g$row	o1716	g$titre	o1742	g$row	o1756	g$la_rubrique	o1777	g$row	o1791!
 	g$lien	o1815	g$dest	o1823	g$nb_col	o1829	g$compteur	o1837	g$la_rubrique	o1860	g$icone	o1879	g$icone	o1916	g$ret	o1949	g$icone	o1995	g$lien	o2242	g$dest	o2250	g$nb_col	o2256	g$compteur	o2264	g$ret	o2281	g$ret	o2598	g$id_rubrique	o2668	g$dest	o2688	g$i	o2769	g$i	o2775	g$nb_col	o2780	g$i	o2789	g$dest	o2947	g$i	o2953

--- NEW FILE: site.php3 ---
<?php
$fond = "site";
$delais = 24 * 3600;


include ("inc-public.php3");


?>

--- NEW FILE: backend-dist.html ---
<?php echo '<'.'?xml version="1.0" encoding="#CHARSET"?'.">\n"; ?>
<rss version="0.91" xmlns:dc="http://purl.org/dc/elements/1.1/">

<channel>
	<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
	<link>#URL_SITE_SPIP/</link>
	<description></description>
	<language>#LANG</language>

	<image>
		<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
		<url>#URL_SITE_SPIP[/(#LOGO_SITE_SPIP||extraire_attribut{src})]</url>
		<link>#URL_SITE_SPIP/</link>
		<description></description>
	</image>

	<BOUCLE_10recents(ARTICLES){lang ?}{branche ?}{par date}{inverse}{0,10}{unique}>
		<item>
		<title>[(#TITRE|texte_backend)]</title>
		<link>#URL_SITE_SPIP/#URL_ARTICLE</link>
		<date>#DATE</date>
		<description>[&lt;img src="#URL_SITE_SPIP/(#LOGO_ARTICLE||extraire_attribut{src})" align="left" hspace="4" vspace="4"&gt; ][(#INTRODUCTION|texte_backend)]</description>
		<author><BOUCLE_auteurs(AUTEURS){id_article}{", "}>[(#NOM|texte_backend)]</BOUCLE_auteurs></author>
		<dc:date>[(#DATE|date_iso)]</dc:date>
		<dc:format>text/html</dc:format>
		<dc:language>#LANG</dc:language>
		<dc:creator><BOUCLE_auteursb(AUTEURS){id_article}{", "}>[(#NOM|texte_backend)]</BOUCLE_auteursb></dc:creator>
		</item>
	</BOUCLE_10recents>
	<BOUCLE_tres_recents(ARTICLES){lang ?}{branche ?}{par date}{inverse}{age<3}{unique}>
		<item>
		<title>[(#TITRE|texte_backend)]</title>
		<link>#URL_SITE_SPIP/#URL_ARTICLE</link>
		<date>#DATE</date>
		<description>[&lt;img src="#URL_SITE_SPIP/(#LOGO_ARTICLE||extraire_attribut{src})" align="left" hspace="4" vspace="4"&gt; ][(#INTRODUCTION|texte_backend)]</description>
		<author><BOUCLE_auteurs_t(AUTEURS){id_article}{","}>[(#NOM|texte_backend)]</BOUCLE_auteurs_t></author>
		<dc:date>[(#DATE|date_iso)]</dc:date>
		<dc:format>text/html</dc:format>
		<dc:language>#LANG</dc:language>
		<dc:creator><BOUCLE_auteurs_tb(AUTEURS){id_article}{", "}>[(#NOM|texte_backend)]</BOUCLE_auteurs_tb></dc:creator>
		</item>
	</BOUCLE_tres_recents>

</channel>

</rss>

--- NEW FILE: spip_cookie.php3 ---
<?php

include ("ecrire/inc_version.php3");
include_ecrire ("inc_session.php3");

// gerer l'auth http
function auth_http($url, $essai_auth_http) {
	if ($essai_auth_http == 'oui') {
		if (!verifier_php_auth()) {
		  $url = quote_amp(urlencode($url));
		  ask_php_auth(_T('login_connexion_refusee'),_T('login_login_pass_incorrect'),_T('login_retour_site'), "url=$url",_T('login_nouvelle_tentative'), (ereg(_DIR_RESTREINT_ABS, $url)));
		  exit;
		}
		else
			redirige_par_entete($url);
	}
	// si demande logout auth_http
	else if ($essai_auth_http == 'logout') {
		ask_php_auth(_T('login_deconnexion_ok'),_T('login_verifiez_navigateur'),_T('login_retour_public'),"redirect=ecrire",_T('login_test_navigateur'), true);
		exit;
	}
}

// rejoue le cookie pour renouveler spip_session
if ($change_session == 'oui') {
	if (verifier_session($spip_session)) {
		// Attention : seul celui qui a le bon IP a le droit de rejouer,
		// ainsi un eventuel voleur de cookie ne pourrait pas deconnecter
		// sa victime, mais se ferait deconnecter par elle.
		if ($auteur_session['hash_env'] == hash_env()) {
			$auteur_session['ip_change'] = false;
			$cookie = creer_cookie_session($auteur_session);
			supprimer_session($spip_session);
			spip_setcookie('spip_session', $cookie);
		}
		@header('Content-Type: image/gif');
		@header('Expires: 0');
		@header("Cache-Control: no-store, no-cache, must-revalidate");
		@header('Pragma: no-cache');
		@header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
		@readfile(_DIR_IMG_PACK . 'rien.gif');
		exit;
	}
}
#spip_log("cookie: $url");

if ($url)  $url = urldecode($url);

// tentative de connexion en auth_http
if ($essai_auth_http AND !$ignore_auth_http) {
	auth_http(($url ? $url : _DIR_RESTREINT_ABS), $essai_auth_http);
	exit;
}

// cas particulier, logout dans l'espace public
if ($logout_public) {
	$logout = $logout_public;
	if (!$url)
		$url = 'index.php3';
}
// tentative de logout
if ($logout) {
	verifier_visiteur();
	if ($auteur_session['login'] == $logout) {
		spip_query("UPDATE spip_auteurs SET en_ligne = DATE_SUB(NOW(),INTERVAL 6 MINUTE) WHERE id_auteur = ".$auteur_session['id_auteur']);
		if ($spip_session) {
			zap_sessions($auteur_session['id_auteur'], true);
			spip_setcookie('spip_session', $spip_session, time() - 3600 * 24);
		}
		if ($PHP_AUTH_USER AND !$ignore_auth_http) {
			auth_http(($url ? $url : _DIR_RESTREINT_ABS), 'logout');
		}
		unset ($auteur_session);
	}

	redirige_par_entete($url ? $url : "spip_login.php3");
}

// en cas de login sur bonjour=oui, on tente de poser un cookie
// puis de passer a spip_login qui diagnostiquera l'echec de cookie
// le cas echeant.
if ($test_echec_cookie == 'oui') {
	spip_setcookie('spip_session', 'test_echec_cookie');
	redirige_par_entete("spip_login.php3?var_echec_cookie=oui&url=" .
			    ($url ? $url : _DIR_RESTREINT_ABS));
}

// Tentative de login
unset ($cookie_session);
$redirect = ($url ? $url : _DIR_RESTREINT_ABS);
if ($essai_login == "oui") {
	// Recuperer le login en champ hidden
	if ($session_login_hidden AND !$session_login)
		$session_login = $session_login_hidden;

	$login = $session_login;
	$pass = $session_password;

	// Essayer differentes methodes d'authentification
	$auths = array('spip');
	include_local(_FILE_CONNECT); // pour savoir si ldap est present 
	if ($ldap_present) $auths[] = 'ldap';
	$ok = false;
	reset($auths);
	while (list(, $nom_auth) = each($auths)) {
		include_ecrire("inc_auth_".$nom_auth.".php3");
		$classe_auth = "Auth_".$nom_auth;
		$auth = new $classe_auth;
		if ($auth->init()) {
			// Essayer les mots de passe md5
			$ok = $auth->verifier_challenge_md5($login, $session_password_md5, $next_session_password_md5);
			// Sinon essayer avec le mot de passe en clair
			if (!$ok && $session_password) $ok = $auth->verifier($login, $session_password);
			if ($ok)  { $auth->lire(); break; }
		}
	}

	if ($ok) {
		$auth->activer();

		if ($auth->login AND $auth->statut == '0minirezo') // force le cookie pour les admins
			$cookie_admin = "@".$auth->login;

		$query = "SELECT * FROM spip_auteurs WHERE login='".addslashes($auth->login)."'";
		$result = spip_query($query);
		if ($row_auteur = spip_fetch_array($result))
			$cookie_session = creer_cookie_session($row_auteur);

		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
		      $redirect .= (strpos($redirect, "?") ? "&" : "?") . 'bonjour=oui';
		}
	}
	else {
		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
			$redirect = "spip_login.php3";
		}
		$redirect .= (strpos($redirect, "?") ? "&" : "?") . "var_login=$login";
		if ($session_password || $session_password_md5)
			$redirect .= '&var_erreur=pass';
		$redirect .= '&url=' . urlencode($url);
	}
 }

// cookie d'admin ?
if ($cookie_admin == "non") {
	spip_setcookie('spip_admin', $spip_admin, time() - 3600 * 24);
	$redirect = ereg_replace("[?&]var_login=[^&]*", '', $redirect);
	$redirect .= (strpos($redirect, "?") ? "&" : "?") . "var_login=-1";
}
else if ($cookie_admin AND $spip_admin != $cookie_admin) {
	spip_setcookie('spip_admin', $cookie_admin, time() + 3600 * 24 * 14);
}

// cookie de session ?
if ($cookie_session) {
	if ($session_remember == 'oui')
		spip_setcookie('spip_session', $cookie_session, time() + 3600 * 24 * 14);
	else
		spip_setcookie('spip_session', $cookie_session);

	$prefs = ($row_auteur['prefs']) ? unserialize($row_auteur['prefs']) : array();
	$prefs['cnx'] = ($session_remember == 'oui') ? 'perma' : '';
	spip_query ("UPDATE spip_auteurs SET prefs = '".addslashes(serialize($prefs))."' WHERE id_auteur = ".$row_auteur['id_auteur']);

}

// changement de langue espace public
if ($var_lang) {
	include_ecrire('inc_lang.php3');

	if (changer_langue($var_lang)) {
		spip_setcookie('spip_lang', $var_lang, time() + 365 * 24 * 3600);
		$redirect = ereg_replace("[?&]lang=[^&]*", '', $redirect);
		$redirect .= (strpos($redirect, "?") ? "&" : "?") . "lang=$var_lang";
	}
}

// changer de langue espace prive (ou login)
if ($var_lang_ecrire) {
	include_ecrire('inc_lang.php3');
	verifier_visiteur();

	if (changer_langue($var_lang_ecrire)) {
		spip_setcookie('spip_lang_ecrire', $var_lang_ecrire, time() + 365 * 24 * 3600);
		spip_setcookie('spip_lang', $var_lang_ecrire, time() + 365 * 24 * 3600);

		if (_FILE_CONNECT) {
			include_ecrire('inc_admin.php3');
			if (verifier_action_auteur('var_lang_ecrire', $valeur, $id_auteur)) {
				spip_query ("UPDATE spip_auteurs SET lang = '".addslashes($var_lang_ecrire)."' WHERE id_auteur = ".$id_auteur);
				$auteur_session['lang'] = $var_lang_ecrire;
				ajouter_session($auteur_session, $spip_session);	// enregistrer dans le fichier de session
			}
		}

		$redirect = ereg_replace("[?&]lang=[^&]*", '', $redirect);
		$redirect .= (strpos($redirect, "?") ? "&" : "?") . "lang=$var_lang_ecrire";
	}
}

// Redirection
// Sous Apache, les cookies avec une redirection fonctionnent
// Sinon, on fait un refresh HTTP

if (ereg("^Apache", $SERVER_SOFTWARE)) {
	redirige_par_entete($redirect);
}
else {
	@header("Refresh: 0; url=" . $redirect);
	echo "<html><head>";
	echo "<meta http-equiv='Refresh' content='0; url=".$redirect."'>";
	echo "</head>\n";
	echo "<body><a href='".$redirect."'>"._T('navigateur_pas_redirige')."</a></body></html>";
}

?>

--- NEW FILE: spip_image_reduite.php3 ---
<?php

$img = $_GET['img'];
$logo = $img;
include ("ecrire/inc_version.php3");
include_ecrire("inc_admin.php3");
include_ecrire("inc_logos.php3");

if (!$taille_y)
	$taille_y = $taille_x;
	
if (eregi("(.*)\.(jpg|gif|png)$", $logo, $regs)) {
	if ($i = cherche_image_nommee($regs[1], array($regs[2]))
	    AND verifier_action_auteur("reduire $taille_x $taille_y", $hash, $hash_id_auteur))
	{
		list($dir,$nom,$format) = $i;
		$logo = $dir . $nom . '.' . $format;
		
		include_ecrire("inc_logos.php3");
		$suffixe = '-'.$taille_x.'x'.$taille_y;
		$preview = creer_vignette($logo, $taille_x, $taille_y, $format,('cache'.$suffixe), $nom.$suffixe);
		if ($preview) {
			$vignette = $preview['fichier'];
			$width = $preview['width'];
			$height = $preview['height'];
			//echo "<img src='$vignette' name='$name' border='0' align='$align' alt='' hspace='$espace' vspace='$espace' width='$width' height='$height' class='spip_logos' />";
			$retour = $vignette;
		}
		else if ($taille_origine = @getimagesize($logo)) {
			//list ($destWidth,$destHeight) = image_ratio($taille_origine[0], $taille_origine[1], $taille_x, $taille_y);
			$retour = $logo;
		}	

	// Afficher l'image resultante, meme grande...
//	header("Content-type: image/$format");
//	echo implode ('', file ($retour));

	redirige_par_entete($retour);
	}
 }

?>
--- NEW FILE: inc-menu_lang_ecrire.php3 ---
<?php

global $balise_MENU_LANG_ECRIRE_collecte;
$balise_MENU_LANG_ECRIRE_collecte = array('menu_lang');

// s'il n'y a qu'une langue proposee eviter definitivement la balise ?php 

function balise_MENU_LANG_ECRIRE_stat ($args, $filtres)
{
  if (!strpos(lire_meta('langues_proposees'),',')) return '';
  return $args;
}

// normalement $opt sera toujours non vide suite au test ci-dessus

function balise_MENU_LANG_ECRIRE_dyn($default)
{
  include_ecrire("inc_lang.php3");
  $opt = liste_options_langues('var_lang_ecrire', $default);
  return (!$opt ? '' : menu_lang_pour_tous('var_lang_ecrire', $opt));
}

function menu_lang_pour_tous($nom, $opt)
{
  $site = lire_meta("adresse_site");
  $post = ($site ? $site : '..') . "/spip_cookie.php3";
  $cible = $GLOBALS['clean_link']->getUrl();
  $postcomplet = new Link($post);
  $postcomplet->addvar('url', $cible);

  return array('formulaire_menu_lang',
	       10, 
	       array('nom' => $nom,
		     'url' => $post,
		     'cible' => $cible,
		     'retour' => $postcomplet->getUrl(),
		     'langues' => $opt));
}
?>

--- NEW FILE: formulaire_ecrire_auteur-dist.html ---
[<br /><img src='puce(#HTTP_VARS{sujetko}).gif' border='0' alt='-' /> <:form_prop_indiquer_sujet:><br />&nbsp;][
<br /><img src='puce(#HTTP_VARS{mailko}).gif' border='0' alt='-' /> <:form_prop_indiquer_email:><br /><br />
]<form action="[(#HTTP_VARS{action})]" method='post'>
<p><label><:form_pet_votre_email:>
	<input type="text" class="forml" name="email_message_auteur"
		 value="[(#HTTP_VARS{mail})]" size="30" />
</label></p>
<p><label><:form_prop_sujet:><br />
	<input type="text" class="forml" name="sujet_message_auteur"
		 value="[(#HTTP_VARS{sujet})]" size="30" />
</label></p>
<p>
<textarea name='texte_message_auteur' rows='10' class='forml' cols='40'>[(#HTTP_VARS{texte})]</textarea>
</p>
[<input type="hidden" name="id_auteur" value="(#HTTP_VARS{id_auteur})" />]
<div align="right">
	<input type="submit"  class="spip_bouton" name="valide"
		 value="[(#HTTP_VARS{valide})]" />
</div>
</form>

--- NEW FILE: inc-chercher.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CHERCHE")) return;
define("_INC_CHERCHE", "1");

// Ce fichier doit imperativement contenir la fonction chercher-squelette
// (cf commentaires dans inc-calcul)

function chercher_squelette($fond, $id_rubrique, $dossier, $lang) {
	$ext = $GLOBALS['extension_squelette'];

	$d ="$dossier$fond";

	// On selectionne, dans l'ordre :
	// fond=10
	
	$f = "$d=$id_rubrique";
	if (($id_rubrique > 0) AND (@file_exists("$f.$ext")))
		$squelette = $f;

	// fond-10 fond-<rubriques parentes>
	if (!$squelette)
		while ($id_rubrique > 0) {
			if (@file_exists("$d-$id_rubrique.$ext")) {
				$squelette = "$d-$id_rubrique";
				break;
			}
			else
				$id_rubrique = sql_parent($id_rubrique);
		}

	if (!$squelette) {
		// fond
		if (@file_exists("$d.$ext"))
			$squelette = $d;
		// fond, a la racine
		else if (@file_exists("$fond.$ext"))
			$squelette = $fond;
		else if (@file_exists("$fond-dist.$ext"))
			$squelette = "$fond-dist";
		else {
			// erreur webmaster : $fond ne correspond a rien
			erreur_squelette(_T('info_erreur_squelette2',
				 array('fichier'=>$fond)),
				 $dossier);
			return '';
		}
	}

	// Affiner par lang
	if ($lang) {
		lang_select($lang);
		$f = "$squelette.$lang";
		if (@file_exists("$f.$ext"))
			$squelette = $f;
	}

	return $squelette;
}

?>

--- NEW FILE: formulaire_forum-dist.html ---
<form action='[(#HTTP_VARS{url})]' method='post' name='formulaire'>
      <input type='hidden' name='ajout_forum' value="oui" />
      <input type='hidden' name='id_message' value="[(#HTTP_VARS{id_message})]" />
      <input type='hidden' name='alea' value="[(#HTTP_VARS{alea})]" />
      <input type='hidden' name='hash' value="[(#HTTP_VARS{hash})]" />
      <input type='hidden' name='retour' value="[(#HTTP_VARS{retour})]" />
      [(#HTTP_VARS*{modere})<p>]
      [(#HTTP_VARS*{afficher_non})]
      [(#HTTP_VARS*{previsu})
      <fieldset class='spip_encadrer'>
	<legend><b><:forum_titre:></b></legend>
	<label>
	  <input type='text' name='titre' 
	    [value="(#HTTP_VARS{titre})" ]class='forml' size='40' />
	</label>
      </fieldset>
      <br />
      <fieldset class='spip_encadrer'>
	<legend><b><:forum_texte:></b></legend>
	<p><:info_creation_paragraphe:></p>
[(#HTTP_VARS{texte}|barre_forum)]
      </fieldset>
      <br />
      [(#HTTP_VARS*{table})]
      <fieldset class='spip_encadrer'>
	<legend><:forum_lien_hyper:></legend>
	<p><:forum_page_url:></p>
	<p><label><:forum_titre:>
	  <input type='text' name='nom_site_forum' class='forml' size='40'
	  value="[(#HTTP_VARS{nom_site_forum})]"  />
	</label></p>
	<p><label><:forum_url:>
	<input type='text' name='url_site' class='forml'  size='40'
	  value="[(#HTTP_VARS{url_site})]" />
	</label></p>
	</fieldset>
      <br />
	<fieldset class='spip_encadrer'>
	  <legend><:forum_qui_etes_vous:></legend>
	  <p>
	  <label>
	    <:forum_votre_nom:>
	    <input type='text' name='auteur' value="[(#HTTP_VARS{auteur})]"
	      class='forml' size='40' [(#HTTP_VARS{disabled})] />
	  </label>
	  </p>
	  <p>
	  <label>
	    <:forum_votre_email:>
	    <input type='text' name='email_auteur' value="[(#HTTP_VARS{email_auteur})]"
	      class='forml' size='40' [(#HTTP_VARS{disabled})] />
	  </label>
	</p>
      </fieldset>
      <br /><div align='right'>
	<input type='submit'  value="<:forum_voir_avant:>" class='spip_bouton'></div>]
</form>


--- NEW FILE: habillage.css ---


/*
 * Mise en page des textes (bordures...)
 */

.chapo {
	line-height: 1.4em;
	margin-top: 1em;
}
.texte {
}
.ps {
	padding-top: 0.6em;
	margin-top: 0.6em;
	border-top: 1px dashed #404040;
}
.notes {
	margin-top: 0.6em;
	margin-bottom: 0.6em;
	border-top: 1px solid #a0a0a0;
	padding: 1.5em;
}

/*
 * Habillage des menus et de la navigation
 */

.menu {
	border: 1px solid #a0a0a0;
	border-top: 0px;
	padding: 0px;
	margin: 0px;
	margin-bottom: 16px;
}
.menu ul {
	display: block;
	margin: 0px;
	padding: 0px;
	padding-bottom: 4px;
	list-style: none;
}
.menu ol {
	display: block;
	margin: 0px;
	padding: 0px;
	padding-bottom: 4px;
	list-style: none;
}
.menu-titre {
	border-top: 1px solid #a0a0a0;
	border-bottom: 1px dashed #d0d0d0;
	margin: 0px;
	padding-left: 4px;
	padding-right: 4px;
	padding-top: 3px;
	padding-bottom: 2px;
	font-size: 90%;
}
.menu-item {
	margin: 0px;
	padding-left: 4px;
	padding-right: 4px;
	padding-top: 1px;
	padding-bottom: 1px;
	font-size: 80%;
}

/* Des couleurs specifiques selon les types de menus */

.general		{ background-color: #f8f8e8; text-align:center; }
.general .menu-titre 	{ background-color: #fcfcf0; }

.rubriques 		{ background-color: #eaffea; text-align:center; }
.rubriques .menu-titre	{ background-color: #f2fff2; }

.breves 		{ background-color: #ffeaea; }
.breves .menu-titre	{ background-color: #fff2f2; text-align:center; }

.divers 		{ background-color: #eaeaff; }
.divers .menu-titre	{ background-color: #f2f2ff; text-align:center; }

.forums 		{ background-color: #e8f8f8; }
.forums .menu-titre	{ background-color: #f0fcfc; text-align:center; }


/*
 * Styles pour le contenu (c-a-d. la colonne principale)
 */

.contenu {
	margin: 15px;
}
.contenu h2.titre-extrait {
}
.contenu h2.titre-texte {
}
.contenu .surtitre {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu .detail {
	margin-left: 2em;
}
.contenu .detail .important {
	color: #a02020;
}
.extrait {
	margin: 0.1em;
	margin-top: 0.5em;
	margin-bottom: 0.5em;
	margin-left: 2em;
	margin-right: 0.1em;
	line-height: 1.4em;
}
.liste-articles {
	margin-top: 1em;
	margin-bottom: 1em;
	clear: left;
}
.contenu .forum-repondre {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	text-align: left;
	font-size: 90%;
	font-weight: bold;
	margin-top: 0.6em;
}


/*
 * Disposition a l'ecran : colonnes, encarts, cartouches
 */

#principal {
	position: absolute;
	left: 30%;
	/*left: 18em;*/
	top: 0px;
	margin: 0px;
	padding: 0px;
	/*margin-right: 2em;*/
	margin-right: 3%;
	margin-top: 1.5em;
}

#plan {
	position: absolute;
	left: 2em;
	top: 0px;
	margin: 0px;
	padding: 0px;
	margin-right: 2em;
	margin-top: 2em;
}

#navigation {
	position: absolute;
	left: 0px;
	top: 0px;
	width: 24%;
	/*width: 14em;*/
	padding: 0px;
	margin: 0px;
	/*margin-left: 1.8em;*/
	margin-left: 3%;
	margin-top: 1.5em;
}

.encart {
	float: right;
	/*width: 14em;*/
	width: 34%;
	margin-left: 4%;
	/*margin-left: 2em;*/
	margin-top: 1em;
	margin-bottom: 0em;
	margin-right: 0px;
}

.cartouche {
	padding-top: 1em;
	border-top: 2px solid #404040;
	margin-bottom: 0em;
}

.cartouche .spip_logos {
	margin-left: 0px;
	padding-left: 0px;
	margin-right: 0.8em;
}


/*
 * Habillage du plan du site
 */

.plan-secteur {
	margin-top: 0em;
	margin-bottom: 3em;
	clear: right;
}

.plan-secteur h1 {
	display: block;
	border: 1px solid #a0a0a0;
	margin: 0px;
	padding: 8px;
	font-size: 150%;
	font-weight: bold;
	background-color: #e0ffe0;
	text-align:center;
}
.plan-rubriques {
	clear: left;
	display: block;
	list-style: none;
}
.plan-rubrique {
	display: inline;
	border: 1px solid #a0a0a0;
	padding: 3px;
	font-weight: bold;
}
.plan-articles {
	clear: left;
	margin-top: 0.5em;
	margin-bottom: 1em;
	list-style: square;
}

/* Eclaircissement progressif des rubriques en fonction de la profondeur */

ul .plan-rubrique {
	background-color: #e0ffe0;
	border-color: #b8b8b8;
}
ul ul .plan-rubrique {
	background-color: #eaffea;
	border-color: #d0d0d0;
}
ul ul ul .plan-rubrique {
	background-color: #f4fff4;
	border-color: #e8e8e8;
}


/*
 * Habillage des forums
 */

ul.forum-total {
	display: block;
	padding: 0px;
	margin: 0px;
	list-style: none;
}
.forum-fil {
	margin-top: 3em;
}
.forum-fil ul {
	display: block;
	margin: 0px;
	margin-left: 2em;
	padding: 0px;
	list-style: none;
}
.forum-titre {
	font-weight: bold;
	font-size: 120%;
}
.forum-item {
	margin: 0px;
	padding: 1em;
	padding-top: 0.5em;
	padding-bottom: 0em;
	text-align: justify;
	color: #303030;
	font-size: 80%;
}
.forum-repondre-message {
	text-align: right;
}

/* Boite d'un forum : eclaircissement progressif des bords */

ul .forum {
	border: 1px solid #909090;
	padding: 0px;
	margin: 0px;
	margin-bottom: 1em;
}
ul ul .forum {
	border: 1px solid #a4a4a4;
}
ul ul ul .forum {
	border: 1px solid #b8b8b8;
}
ul ul ul ul .forum {
	border: 1px solid #cccccc;
}
ul ul ul ul ul .forum {
	border: 1px solid #e0e0e0;
}
ul ul ul ul ul ul .forum {
	border: 1px dashed #e0e0e0;
}

/* Boite de titre d'un forum : mise en couleur selon la profondeur du forum */

ul .forum-chapo {
	border: 0px;
	border-bottom: 1px dashed #b8b8b8;
	margin: 0px;
	padding-left: 6px;
	padding-right: 6px;
	padding-top: 3px;
	padding-bottom: 2px;
	font-size: 90%;
	background: #c4e0e0;
}
ul ul .forum-chapo {
	background: #d4e8e8;
}
ul ul ul .forum-chapo {
	background: #e4f0f0;
}
ul ul ul ul .forum-chapo {
	background: #f4f8f8;
}
ul ul ul ul ul .forum-chapo {
	background: #ffffff;
}


/*
 * Habillage des petitions
 */

.signatures {
	margin-left: 0px;
	margin-right: 0px;
	margin-top: 1em;
	margin-bottom: 1em;
	width: 100%;
}
.signatures td {
	-moz-border-radius: 0.4em;
}
.signatures-titre {
	clear: right;
	font-weight: bold;
	font-size: 120%;
	text-align: center;
	padding: 0.5em;
	margin: 0px;
}
.signature-date {
	white-space: nowrap;
	background: #e4f0f0;
	padding: 0.5em;
}
.signature-nom {
	font-weight: bold;
	background: #ecf4f4;
	padding: 0.2em;
	text-align: center;
}
.signature-message {
	font-size: 85%;
	background: #f4f8f8;
	padding: 0.4em;
	text-align: justify;
}


/*
 * Formulaires
 */

.formrecherche {
	background-color: #f2f2f2;
	color: #505030;
	margin: 0px;
	padding: 2px;
	border: solid 1px #909090;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 80%;
	font-weight: normal;
}

.formulaire {
	color: black;
	margin: 0px;
	margin-bottom: 16px;
	padding: 4px;
	border: 1px solid #a0a0a0;
	background-color: #f6f6f6;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 80%;
	font-weight: normal;
}
.forml {
	background-color: #ececec;
	margin: 4px;
	padding: 1px;
	border: dashed 1px #909090;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 90%;
}
.spip_bouton {
	border: 2px solid #404040;
	padding: 3px;
	background: #d0d0d0;
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
}

.spip-admin {
}



--- NEW FILE: puce_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sommaire.php3 ---
<?php
$fond = "sommaire";
$delais = 2 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: carto.html ---
<BOUCLE_carte(CARTO_CARTE){id_carte}><img alt="#TITRE" src="spip_carto.php?id_carte=[(#FICHIER|propre)]&scale=[(#HTTP_VARS{scale})]&x=[(#HTTP_VARS{x})]&y=[(#HTTP_VARS{y})]" usemap="#map#ID_CARTE"/><B_objets><map name="map#ID_CARTE"><BOUCLE_objets(CARTO_OBJET){id_carte=#ID_CARTE}><area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords)]" href="#LIEN"/></BOUCLE_objets></map></B_objets></BOUCLE_carte>


--- NEW FILE: rubrique-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_rubrique_principal(RUBRIQUES) {id_rubrique}>

<html lang="#LANG">
<head>
<title>[(#TITRE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">

<!-- Lien vers le backend pour navigateurs eclaires -->
<link rel="alternate" type="application/rss+xml" title="<:syndiquer_rubrique:>" href="backend.php3?id_rubrique=#ID_RUBRIQUE">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Menu de navigation rubriques -->

<div class="menu">
<ol class="rubriques" title="<:hierarchie_site:>">
<BOUCLE_hierarchie(HIERARCHIE) {id_rubrique} {tout}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_rubriques_soeurs>
	<ul class="menu-liste">
<BOUCLE_rubriques_soeurs(RUBRIQUES) {meme_parent} {exclus} {par titre}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_rubriques_soeurs>
	</ul>
</B_rubriques_soeurs>
</li>
</BOUCLE_hierarchie>
</ol>
</div>


<!-- Breves dans la rubrique -->

<B_breves_rubrique>

<div class="menu">
<div class="breves" title="<:dernieres_breves:>">
	<div class="menu-titre">
	<:breves:>
	</div>
	<ul>
<BOUCLE_breves_rubrique(BREVES) {id_secteur} {par date} {inverse} {0,5}>
	<li class="menu-item">
	<i>[(#DATE|affdate_court)]</i>:
	<a href="#URL_BREVE">#TITRE</a>
	</li>
</BOUCLE_breves_rubrique>
	</ul>
</div>
</div>

</B_breves_rubrique>


</div>


<!-- Une : contenu de la rubrique -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_RUBRIQUE|left)]
<h1 class="titre-texte">#TITRE</h1>
[<:dernier_ajout:> : (#DATE|nom_jour)] [(#DATE|affdate).]
</div>

	<div class="encart">

	<!-- Menu de navigation mots-cles -->

	<B_mots>
	<h2 class="structure"><:mots_clefs:></h2>

	<div class="menu">
	<ul class="divers" title="<:mots_clefs:>">
	<BOUCLE_mots(MOTS) {id_rubrique} {par titre}>
	<li>
	<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
	<B_rubriques_mots>
		<ul class="menu-liste">
	<BOUCLE_rubriques_mots(RUBRIQUES) {id_mot} {par hasard} {0,4}>
		<li class="menu-item"><a href="#URL_RUBRIQUE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
	</BOUCLE_rubriques_mots>
		</ul>
	</B_rubriques_mots>
	</li>
	</BOUCLE_mots>
	</ul>
	</div>
	</B_mots>

	<!-- Sous-rubriques -->

	<B_sous_rubriques>
	<h2 class="structure"><:sous_rubriques:></h2>

	<div class="menu">
	<ul class="rubriques" title="<:sous_rubriques:>">
	<BOUCLE_sous_rubriques(RUBRIQUES) {id_parent} {par titre}>
	<li>
	<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
	<B_sous_sous_rubriques>
		<ul class="menu-liste">
	<BOUCLE_sous_sous_rubriques(RUBRIQUES) {id_parent} {par titre}>
		<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
	</BOUCLE_sous_sous_rubriques>
		</ul>
	</B_sous_sous_rubriques>
	</li>
	</BOUCLE_sous_rubriques>
	</ul>
	</div>
	</B_sous_rubriques>
	
	<!-- Sites syndiques -->
	
	<B_sites>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_sites(SITES) {id_rubrique} {par nom_site}>
		<li class="menu-item">
		<a href="#URL_SITE">#NOM_SITE</a>
		<B_syndic>
		<ul class="menu-liste">
		<BOUCLE_syndic(SYNDIC_ARTICLES) {id_syndic} {par date} {inverse} {0,3}>
			<li class="menu-item"><small><a href="#URL_ARTICLE">#TITRE</a></small></li>
		</BOUCLE_syndic>
		</ul>
		</B_syndic>
		</li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>
	[
<div class="menu">
    <div class="divers">
      <div class="menu-titre"><:proposer_site:>
	<div class='reponse_formulaire'>(#FORMULAIRE_SITE)</div>
      </div>
    </div>
</div>
]
	</div>

[<div class="chapo">(#TEXTE)</div>]
[<div class="notes">(#NOTES)</div>]

<BOUCLE_documents_joints(DOCUMENTS) {id_rubrique} {mode=document} {doublons} {"<br>"}>
[(#LOGO_DOCUMENT|#URL_DOCUMENT)][<br>(#TITRE)][ - (#DESCRIPTIF)]
</BOUCLE_documents_joints>
<br>

<!-- Articles de la rubrique -->

<h1 class="structure"><:articles_rubrique:></h1>

<div class="liste-articles">

<BOUCLE_articles_recents(ARTICLES) {id_rubrique} {par titre}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_recents><:par_auteur:> <BOUCLE_auteurs_recents(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_recents>
	</div>
	<br>
</BOUCLE_articles_recents>


</div>


</div>
#FORMULAIRE_ADMIN
</body>
</html>


</BOUCLE_rubrique_principal>
<:aucune_rubrique:>
<//B_rubrique_principal>

--- NEW FILE: spip_admin.css ---
/* Les boutons d'admin survolent la page (sauf #FORMULAIRE_ADMIN) */
.spip-admin-float {
	top: 0px;
	right: 20px;
	position: absolute;
	z-index: 100;
}


/* Couleurs et design des boutons d'admin */
.spip-admin-bloc {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	background-color: transparent;
	font-size: 10px;
}

.spip-admin-bloc li {
	padding: 0 2px;
	display: inline;
}

.spip-admin-bloc ul {
	display: inline;
}

a.spip-admin-boutons {
	border-top: 1px solid #cecece;
	border-bottom: 2px solid #4a4a4a;
	border-left: 1px solid #cecece;
	border-right: 1px solid #cecece;
	text-decoration: none;
	width: 3em;
	text-align: center;
	margin: 0;
	padding: 1px .5em;
	font-family: helvetica,arial,sans-serif;
	font-size: 10px;
	font-weight: bold;
	background-color: #fff;
	color: #0c479d;
}

a:hover.spip-admin-boutons {
	background-color: #fc3;
	border-bottom: 2px solid #36f;
}

a:active.spip-admin-boutons {
	background-color: #ccc;
	border-bottom: 2px solid #f00;
}


/* Style pour le mode debug */
#spip-debug {
	background-color: #f0f0f0;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
}
#spip-debug ul table {
	font-size: 80%;
}

#spip-debug fieldset {
	background-color: #FFF;
	font-family: "Courier New", Courier, monospace;
	font-size: 12;
}

#spip-debug legend {
	background-color: #FFF;
	border: solid 1px #F00;
	padding: 1px 1em;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
	font-weight: bold;
}

#spip-debug ul table a {
	text-decoration: none;
}

#spip-debug ul table a:hover {
	text-decoration: underline;
}

--- NEW FILE: spip_cache.php3 ---
<?php

include ("ecrire/inc_version.php3");

include_ecrire("inc_meta.php3");
include_ecrire("inc_admin.php3");
include_local("inc-cache.php3");

if ($purger_cache == "oui") {
	if (verifier_action_auteur("purger_cache", $hash, $id_auteur))
		purger_cache();
}

if ($purger_squelettes == "oui") {
	if (verifier_action_auteur("purger_squelettes", $hash, $id_auteur))
	  purger_squelettes();
}
redirige_par_entete($redirect);

?>

--- NEW FILE: site-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_site(SITES){id_syndic}>

<html lang="#LANG">
<head>
<title>[(#NOM_SITE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


</div>

<!-- Une : affichage du site -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_SITE|left)]
<h1 class="titre-texte"><a href="#URL_SITE">#NOM_SITE</a></h1>

[<div class="chapo">(#DESCRIPTIF)</div>]
[<div class="notes">(#NOTES)</div>]
</div>


<!-- Articles du site -->

<h1 class="structure"><:articles:></h1>

<div class="liste-articles">

<BOUCLE_articles(SYNDIC_ARTICLES) {id_syndic} {par date}{inverse}{0,10}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	</div>
	<br>
</BOUCLE_articles>

</div>

</div>

#FORMULAIRE_ADMIN
</body>
</html>


</BOUCLE_site>
<:aucun_site:>
<//B_site>

--- NEW FILE: sommaire_texte.php3 ---
<?php

// ACCESSIBILITE
// cette page offre une lecture en mode "texte seul"
// des 3 articles les plus recents.

$fond = "sommaire_texte";
$delais = 3600;

include ("inc-public.php3");

?>

--- NEW FILE: spip_redirect.php3 ---
<?php
// redirige vers l'URL canonique de l'article,
// en indiquant recalcul et previsu

include ("ecrire/inc_version.php3");

// Gestionnaire d'URLs
if (@file_exists("inc-urls.php3"))
	include_local("inc-urls.php3");
else
	include_local("inc-urls-".$GLOBALS['type_urls'].".php3");

if ($id_article) {
	$url = generer_url_article($id_article);
}
else if ($id_breve) {
	$url = generer_url_breve($id_breve);
}
else if ($id_forum) {
	$url = generer_url_forum($id_forum);
}
else if ($id_rubrique) {
	$url = generer_url_rubrique($id_rubrique);
}
else if ($id_mot) {
	$url = generer_url_mot($id_mot);
}
else if ($id_auteur) {
	$url = generer_url_auteur($id_auteur);
}
else {
	$url = _DIR_RESTREINT_ABS;
}
if (strpos($url,'?')) {
	$super='&';
}
else {
	$super='?';
}
if ($recalcul) $url .= $super."var_mode=recalcul";
else if ($preview) $url .= $super."var_preview=oui";
@header("Location: $url");

?>
--- NEW FILE: .project ---
<?xml version="1.0" encoding="UTF-8"?>
<projectDescription>
	<name>spipcarto</name>
	<comment></comment>
	<projects>
	</projects>
	<buildSpec>
		<buildCommand>
			<name>net.sourceforge.phpeclipse.parserbuilder</name>
			<arguments>
			</arguments>
		</buildCommand>
	</buildSpec>
	<natures>
		<nature>net.sourceforge.phpeclipse.phpnature</nature>
	</natures>
</projectDescription>

--- NEW FILE: breve.php3 ---
<?php
$fond = "breve";
$delais = 12 * 3600;

include ("inc-public.php3");


?>

--- NEW FILE: resume.php3 ---
<?php
$fond = "resume";
$delais = 2 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: inc-login_prive.php3 ---
<?php

include_local("inc-login_public.php3");

global $balise_LOGIN_PRIVE_collecte;
$balise_LOGIN_PRIVE_collecte = array('url');

# retourner:
# 1. l'url collectee ci-dessus (args0) ou donnee en filtre (filtre0)
# 2. l'eventuel parametre de la balise (args1) fournie par calculer_balise_dynamique

function balise_LOGIN_PRIVE_stat ($args, $filtres)
{
	return array($filtres[0] ? $filtres[0] : $args[0], $args[1]);
}

function balise_LOGIN_PRIVE_dyn($cible, $login)
{
	return login_explicite($login, $cible,  'redac');
}
?>

--- NEW FILE: inc-formulaire_inscription.php3 ---
<?php

include_ecrire('inc_abstract_sql.php3');

global $balise_FORMULAIRE_INSCRIPTION_collecte ;
$balise_FORMULAIRE_INSCRIPTION_collecte = array('mail_inscription', 'nom_inscription');

// args 0 et 1 sont mail et nom ci-dessus, args2 le parametre de la balise

function balise_FORMULAIRE_INSCRIPTION_stat($args, $filtres)
{
  return ((lire_meta('accepter_inscriptions') != 'oui') ? '' :
	  array('redac', $args[0], $args[1], 
		($args[2] == 'focus' ? 'nom_inscription' : '')));
}

function balise_FORMULAIRE_INSCRIPTION_dyn($mode, $mail_inscription, $nom_inscription, $focus) {
	if (($mode == 'redac') AND (lire_meta("accepter_inscriptions") == "oui"))
		$statut = "nouveau";
	else if (($mode == 'forum') AND ((lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo')))
		$statut = "6forum";
	else return _T('pass_rien_a_faire_ici');

	if (test_mail_ins($mode, $mail_inscription) && $nom_inscription) {
		include(_FILE_CONNECT);
		// envoyer les identifiants si l'abonne n'existe pas d?j?.
		if (!$row = spip_fetch_array(spip_query("SELECT statut, id_auteur, login, pass FROM spip_auteurs WHERE email='".addslashes($mail_inscription)."' LIMIT 1")))
		  {
			include_ecrire("inc_acces.php3");
			$pass = creer_pass_aleatoire(8, $mail_inscription);
			$login = test_login($mail_inscription);
			$mdpass = md5($pass);
			$htpass = generer_htpass($pass);
			$r = spip_abstract_insert('auteurs', 
					 '(nom, email, login, pass, statut, htpass)',
					 "('".addslashes($nom_inscription)."',  '".addslashes($mail_inscription)."', '$login', '$mdpass', '$statut', '$htpass')");
			ecrire_acces();
			return envoyer_inscription($mail_inscription, $statut, $mode, $login, $pass);
		  }

		else {
		  // existant mais encore muet, renvoyer les infos
			if ($row['statut'] == 'nouveau') {
			  return (envoyer_inscription($mail_inscription, $row['statut'], $mode, $row['login'], $row['pass']));
			} else {
				if ($row['statut'] == '5poubelle')
		  // dead
				  return _T('form_forum_access_refuse');
				else  
		  // deja inscrit
				  return _T('form_forum_email_deja_enregistre');
			}
		}
	}
	// demande du formulaire
	else {
		if (!$nom_inscription) 
		  {
		    return array("formulaire_inscription",0,
				 array('focus' => $focus,
				       'mode' => $mode));
		  }
		else {
		  spip_log("Mail incorrect: '$mail_inscription'");
		  return _L('adresse mail incorrecte');
		}
	}
}

// fonction qu'on peut redefinir pour filtrer selon l'adresse mail
// cas general: controler juste que l'adresse n'est pas vide

function test_mail_ins($mode, $mail_inscription) {
  return trim($mail_inscription);
}

	// envoyer identifiants par mail
function envoyer_inscription($mail, $statut, $type, $login, $pass) {
	$nom_site_spip = lire_meta("nom_site");
	$adresse_site = lire_meta("adresse_site");
	
	$message = _T('form_forum_message_auto')."\n\n"._T('form_forum_bonjour')."\n\n";
	if ($type == 'forum') {
		$message .= _T('form_forum_voici1', array('nom_site_spip' => $nom_site_spip, 'adresse_site' => $adresse_site)) . "\n\n";
	} else {
		$message .= _T('form_forum_voici2', array('nom_site_spip' => $nom_site_spip, 'adresse_site' => $adresse_site)) . "\n\n";
	}
	$message .= "- "._T('form_forum_login')." $login\n";
	$message .= "- "._T('form_forum_pass')." $pass\n\n";

	include_ecrire("inc_mail.php3");
	if (envoyer_mail($mail, "[$nom_site_spip] "._T('form_forum_identifiants'), $message))
	  return _T('form_forum_identifiant_mail');
	else
	  return _T('form_forum_probleme_mail');
}

function test_login($mail) {
	if (strpos($mail, "@") > 0) $login_base = substr($mail, 0, strpos($mail, "@"));
	else $login_base = $mail;

	$login_base = strtolower($login_base);
	$login_base = ereg_replace("[^a-zA-Z0-9]", "", $login_base);
	if (!$login_base) $login_base = "user";
	$login = $login_base;

	for ($i = 1; ; $i++) {
		$query = "SELECT id_auteur FROM spip_auteurs WHERE login='$login' LIMIT 1";
		if (!spip_num_rows(spip_query($query))) return $login;
		$login = $login_base.$i;
	}


}

?>

--- NEW FILE: plan-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] </title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<!-- Plan du site -->

<div id="plan" class="contenu">

<BOUCLE_secteurs(RUBRIQUES) {racine} {par titre}>

<div class="plan-secteur">

	[(#LOGO_RUBRIQUE|left)]<h1><a href="#URL_RUBRIQUE">#TITRE</a></h1>

	<div class="encart">

	<!-- Breves -->

	<h2 class="structure"><:breves:></h2>

	<B_breves>
	<div class="menu">
	<div class="breves">
		<div class="menu-titre">
		<:breves:>
		</div>
		<ul>
	<BOUCLE_breves(BREVES) {id_secteur} {par date} {inverse} {0,15}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>
	</B_breves>

	<!-- Sur le Web -->

	<h2 class="structure"><:sites_web:></h2>

	<B_sites>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_sites(SITES) {id_secteur} {par nom_site}>
		<li class="menu-item">
		<a href="#URL_SITE">#NOM_SITE</a>
		</li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>

	</div>

<!-- Articles et sous-rubriques -->

<h2 class="structure"><:articles:></h2>

<B_articles_racine>
<ul class="plan-articles">

<BOUCLE_articles_racine(ARTICLES) {id_rubrique} {par titre}>
<li class="plan-article"><a href="#URL_ARTICLE">#TITRE</a></li>
</BOUCLE_articles_racine>

</ul>
</B_articles_racine>

<B_rubriques>

<ul class="plan-rubriques">

<BOUCLE_rubriques(RUBRIQUES) {id_parent} {par titre}>
<li>
<div class="plan-rubrique"><a href="#URL_RUBRIQUE">#TITRE</a></div>

	<B_articles>
	<ul class="plan-articles">
	<BOUCLE_articles(ARTICLES) {id_rubrique} {par titre}>
	<li class="plan-article"><a href="#URL_ARTICLE">#TITRE</a></li>
	</BOUCLE_articles>
	</ul>
	</B_articles>

	<BOUCLE_sous_rubriques(BOUCLE_rubriques)></BOUCLE_sous_rubriques>

</li>
</BOUCLE_rubriques>

</ul>
</B_rubriques>


</div>

</BOUCLE_secteurs>

</div>
#FORMULAIRE_ADMIN
</body>
</html>

--- NEW FILE: spip_barre.js ---
// Barre de raccourcis
// derive du:
// bbCode control by subBlue design : www.subBlue.com

// Startup variables
var theSelection = false;

// Check for Browser & Platform for PC & IE specific bits
// More details from: http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html
var clientPC = navigator.userAgent.toLowerCase(); // Get client info
var clientVer = parseInt(navigator.appVersion); // Get browser version

var is_ie = ((clientPC.indexOf("msie") != -1) && (clientPC.indexOf("opera") == -1));
var is_nav = ((clientPC.indexOf('mozilla')!=-1) && (clientPC.indexOf('spoofer')==-1)
                && (clientPC.indexOf('compatible') == -1) && (clientPC.indexOf('opera')==-1)
                && (clientPC.indexOf('webtv')==-1) && (clientPC.indexOf('hotjava')==-1));
var is_moz = 0;

var is_win = ((clientPC.indexOf("win")!=-1) || (clientPC.indexOf("16bit") != -1));
var is_mac = (clientPC.indexOf("mac")!=-1);


function barre_raccourci(debut,fin,champ) {
	var txtarea = champ;

	txtarea.focus();
	donotinsert = false;
	theSelection = false;
	bblast = 0;

	if ((clientVer >= 4) && is_ie && is_win)
	{
		theSelection = document.selection.createRange().text; // Get text selection
		if (theSelection) {

			while (theSelection.substring(theSelection.length-1, theSelection.length) == ' ')
			{
				theSelection = theSelection.substring(0, theSelection.length-1);
				fin = fin + " ";
			}
			if (theSelection.substring(0,1) == '{' && debut.substring(0,1) == '{')
			{
				debut = debut + " ";
			}
			if (theSelection.substring(theSelection.length-1, theSelection.length) == '}' && fin.substring(0,1) == '}')
			{
				fin = " " + fin;
			}

			// Add tags around selection
			document.selection.createRange().text = debut + theSelection + fin;
			txtarea.focus();
			theSelection = '';
			return;
		}
	}
	else if (txtarea.selectionEnd && (txtarea.selectionEnd - txtarea.selectionStart > 0))
	{
		mozWrap(txtarea, debut, fin);
		return;
	}
}

function barre_demande(debut,milieu,fin,affich,champ) {
	var inserer = prompt(affich);

	if (inserer != null) {
		if (inserer == "") {inserer = "xxx"; }

		barre_raccourci(debut, milieu+inserer+fin, champ);
	}
}

function barre_inserer(text,champ) {
	var txtarea = champ;
	
	if (txtarea.createTextRange && txtarea.caretPos) {
		var caretPos = txtarea.caretPos;
		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
		txtarea.focus();
	} else {
		//txtarea.value  += text;
		//txtarea.focus();
		mozWrap(txtarea, '', text);
		return;
	}
}


// D'apres Nicolas Hoizey 
function barre_tableau(toolbarfield)
{
	var txtarea = toolbarfield;
	txtarea.focus();
	var cols = prompt("Nombre de colonnes du tableau :", "");
	var rows = prompt("Nombre de lignes du tableau :", "");
	if (cols != null && rows != null) {
		var tbl = '';
		var ligne = '|';
		var entete = '|';
		for(i = 0; i < cols; i++) {
			ligne = ligne + ' valeur |';
			entete = entete + ' {{entete}} |';
		}
		for (i = 0; i < rows; i++) {
			tbl = tbl + ligne + '\n';
		}
		if (confirm('Voulez vous ajouter une ligne d\'en-t?te ?')) {
			tbl = entete + '\n' + tbl;
		}
		if ((clientVer >= 4) && is_ie && is_win) {
			var str = document.selection.createRange().text;
			var sel = document.selection.createRange();
			sel.text = str + '\n\n' + tbl + '\n\n';
		} else {
			mozWrap(txtarea, '', "\n\n" + tbl + "\n\n");
		}
	}
	return;
}



// Shows the help messages in the helpline window
function helpline(help, champ) {
	champ.value = help;
}


function setCaretToEnd (input) {
  setSelectionRange(input, input.value.length, input.value.length);
}


function setSelectionRange(input, selectionStart, selectionEnd) {
  if (input.setSelectionRange) {
    input.focus();
    input.setSelectionRange(selectionStart, selectionEnd);
  }
  else if (input.createTextRange) {
    var range = input.createTextRange();
    range.collapse(true);
    range.moveEnd('character', selectionEnd);
    range.moveStart('character', selectionStart);
    range.select();
  }
}

// From http://www.massless.org/mozedit/
function mozWrap(txtarea, open, close)
{
	var selLength = txtarea.textLength;
	var selStart = txtarea.selectionStart;
	var selEnd = txtarea.selectionEnd;
	if (selEnd == 1 || selEnd == 2)
		selEnd = selLength;
	
	// Raccourcir la selection par double-clic si dernier caractere est espace	
	if (selEnd - selStart > 0 && (txtarea.value).substring(selEnd-1,selEnd) == ' ') selEnd = selEnd-1;
	
	var s1 = (txtarea.value).substring(0,selStart);
	var s2 = (txtarea.value).substring(selStart, selEnd)
	var s3 = (txtarea.value).substring(selEnd, selLength);

	// Eviter melange bold-italic-intertitre
	if ((txtarea.value).substring(selEnd,selEnd+1) == '}' && close.substring(0,1) == "}") close = close + " ";
	if ((txtarea.value).substring(selEnd-1,selEnd) == '}' && close.substring(0,1) == "}") close = " " + close;
	if ((txtarea.value).substring(selStart-1,selStart) == '{' && open.substring(0,1) == "{") open = " " + open;
	if ((txtarea.value).substring(selStart,selStart+1) == '{' && open.substring(0,1) == "{") open = open + " ";

	txtarea.value = s1 + open + s2 + close + s3;
	selDeb = selStart + open.length;
	selFin = selEnd + close.length;
	window.setSelectionRange(txtarea, selDeb, selFin);
	txtarea.focus();
	
	return;
}

// Insert at Claret position. Code from
// http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130
     function storeCaret (textEl) {
       if (textEl.createTextRange) 
         textEl.caretPos = document.selection.createRange().duplicate();
     }


--- NEW FILE: spip_style.css ---
a {
	text-decoration: none;
}

a:hover {
	color:#FF9900;
	text-decoration: underline;
}

a.spip_url { }
a.spip_in { }
a.spip_out { }
a.spip_glossaire { }

.spip_code { }

p.spip_note { }

h3.spip {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 120%;
	text-align: center;
	margin-top : 40px;
	margin-bottom : 40px;
	padding: 0em;
}

.spip_puce {
	list-style-position: inside;
}

.spip_documents{
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size : 70%;
}


table.spip {
}

table.spip tr.row_first {
	background-color: #FCF4D0;
}

table.spip tr.row_odd {
	background-color: #C0C0C0;
}

table.spip tr.row_even {
	background-color: #F0F0F0;
}

table.spip td {
	padding: 1px;
	text-align: left;
	vertical-align: middle;
}

hr.spip { }
b.spip { }
i.spip { }
blockquote.spip {
	margin-left : 40px;
	margin-top : 10px;
	margin-bottom : 10px;
	margin-right: 0px;
	border : solid 1px #aaaaaa;
	background-color: #ffffff;
	padding-left: 10px;
	padding-right: 10px;
}

.forml { width: 100% ; background-color: #FFDDAA;}

.spip_encadrer {
	font-family: helvetica, arial, sans-serif;
	width : 95%;
	background-color: #FFFFFF;
	padding: 5px;
	border: 1px #666666 solid;
}

.spip_cadre {
	width : 95%;
	background-color: #FFFFFF;
	padding: 5px;
	margin-top: 10px;
}

div.spip_poesie {
	margin-bottom: 5px;
	margin-left: 10px;
	padding-left: 10px;
	border-left: 1px solid #999999;
}
div.spip_poesie div {
	text-indent: -60px;
	margin-left: 60px;
}

.spip_bouton { background-color: #FFCC00;}

form.formrecherche { 
	margin-top: 5px;
	margin-bottom: 5px;
}
input.formrecherche {
	width: 95%;
	background-color: #FFDDAA;
}

.reponse_formulaire {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 110%;
	color: red;
}

.spip_surligne { background-color: #FFFF66; }


/*
 * Barre de raccourcis
 */

a.spip_barre img {
	border-left: 1px solid #ffffff;
	border-top: 1px solid #ffffff;
	border-right: 1px solid #aa9966;
	border-bottom: 1px solid #aa9966;
	padding: 3px;
	background-color: #FFDDAA;
}
a.spip_barre:hover img {
	border: 1px solid #808080;
	padding: 3px;
	background-color: #f8f8f4;
}

--- NEW FILE: ical.php3 ---
<?php

$fond = "ical";
$delais = 3600;

@header ("content-type:text/calendar");

$flag_preserver=true;
include ("inc-public.php3");


?>

--- NEW FILE: article-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_article_principal(ARTICLES) {id_article}>
<html lang="#LANG">
<head>
<title>[(#TITRE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">
<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Menu de navigation rubriques -->

<B_rubriques>
<div class="menu">
<ol class="rubriques">
<BOUCLE_rubriques(HIERARCHIE) {id_article}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_sous_rubriques>
	<ul class="menu-liste">
<BOUCLE_sous_rubriques(RUBRIQUES) {meme_parent} {exclus} {par date} {inverse} {0,3}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_sous_rubriques>
	</ul>
</B_sous_rubriques>
</li>
</BOUCLE_rubriques>
</ol>
</div>
</B_rubriques>


<!-- Menu de navigation mots-cles -->

<B_mots>
<div class="menu">

<h1 class="structure"><:mots_clefs:></h1>

<ul class="divers" title="<:mots_clefs:>">
<BOUCLE_mots(MOTS) {id_article} {par titre}>
<li>
<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_articles_mots>
	<ul class="menu-liste">
<BOUCLE_articles_mots(ARTICLES) {id_mot} {par hasard} {0,4}>
	<li class="menu-item"><a href="#URL_ARTICLE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
</BOUCLE_articles_mots>
	</ul>
</B_articles_mots>
</li>
</BOUCLE_mots>
</ul>
</div>
</B_mots>


<!-- Liens des forums -->
<BOUCLE_forums_decompte(FORUMS){id_article}{plat}></BOUCLE_forums_decompte>
[<div class="menu" title="<:derniers_commentaires:>">

<h1 class="structure"><:derniers_commentaires:></h1>

<ul class="forums">

<li class="menu-titre"><:messages_forum:>: (#TOTAL_BOUCLE)</li>]
<//B_forums_decompte>
<BOUCLE_forums_liens(FORUMS){id_article}{par date}{inverse}{0,5}>
    <li class="menu-item">[<i>(#DATE|affdate_court)</i>:]
    <a href="#forum#ID_FORUM">#TITRE</a>
    </li>
</BOUCLE_forums_liens>
</ul>
</div>
</B_forums_liens>


</div>


<!-- Une : derniers articles publies -->

<div class="contenu" id="principal">

<div class="cartouche">
#DEBUT_SURLIGNE[
(#LOGO_ARTICLE|left)][
<div class="surtitre">(#SURTITRE)</div>
]<h1 class="titre-texte">#TITRE</h1>[
<div class="surtitre">(#SOUSTITRE)</div>
]#FIN_SURLIGNE
[(#DATE|nom_jour)] [(#DATE|affdate).]
</div>
<div style="line-height: 0em">&nbsp;</div><!-- Bug Mozilla http://bugzilla.mozilla.org/show_bug.cgi?id=200510 -->

	<div class="encart">

	<!-- Auteurs de l'article -->

	<B_auteurs>

	<div class="menu">
	<h2 class="structure"><:memes_auteurs:></h2>
	<ul class="divers">
	<BOUCLE_auteurs(AUTEURS) {id_article} {par nom}>
		<li>
		<div class="menu-titre"><a href="#URL_AUTEUR">#NOM</a></div>
		<ul>
		[<li class="menu-item" style="text-align: center"><a href="(#URL_SITE)">#NOM_SITE</a></li>]
		[<li class="menu-item" style="text-align: center">(#BIO)</li>]
	<B_articles_auteur>
	<BOUCLE_articles_auteur(ARTICLES) {id_auteur} {par popularite} {inverse} {0,5}>
		<li class="menu-item"><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
	</BOUCLE_articles_auteur>
		</ul>
		</li>
	</BOUCLE_auteurs>
	</ul>
	</div>

	</B_auteurs>

	<!-- Articles dans la meme rubrique -->

	<B_articles_rubrique>

	<div class="menu">
	<div class="breves">
		<h2 class="structure"><:meme_rubrique:></h2>
		<div class="menu-titre">
		<:meme_rubrique:>
		</div>
		<ul>
	<BOUCLE_articles_rubrique(ARTICLES) {id_rubrique} {par hasard} {exclus} {0,8}>
		<li class="menu-item">
		<a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a>
		</li>
	</BOUCLE_articles_rubrique>
		</ul>
	</div>
	</div>

	</B_articles_rubrique>
  [<div class='reponse_formulaire'>
	<a name='sp#ID_ARTICLE' id='sp#ID_ARTICLE'></a>
    (#FORMULAIRE_SIGNATURE)
  </div>]
	</div>

#DEBUT_SURLIGNE[
<div class="chapo">(#CHAPO)</div>
][<div class="texte">(#TEXTE)</div>
][<div class="ps">(#PS)</div>][
<div class="notes">(#NOTES)</div>
]#FIN_SURLIGNE

<BOUCLE_documents_joints(DOCUMENTS) {id_article} {mode=document} {doublons} {"<br>"}>
[(#LOGO_DOCUMENT|#URL_DOCUMENT)][<br>(#TITRE)][ - (#DESCRIPTIF)]
</BOUCLE_documents_joints>
<br>


<!-- Signatures petition -->

<BOUCLE_signatures_decompte(SIGNATURES) {id_article}></BOUCLE_signatures_decompte>
[<div class="signatures-titre"><:signatures_petition:>: (#TOTAL_BOUCLE)</div>

<table class="signatures">
<thead class="structure">
<tr>
	<td><:date:></td>
	<td><:nom:></td>
	<td><:message:></td>
</tr>
</thead>
<tbody>]
<//B_signatures_decompte>
<BOUCLE_signatures(SIGNATURES) {id_article} {par date} {inverse} {debut_signatures,30}>
<tr>
	<td class="signature-date">[(#DATE|affdate_court)]</td>
	<td class="signature-nom">#NOM[<br><a href="#URL_SITE">(#NOM_SITE)</a>]</td>
	[<td class="signature-message">(#MESSAGE)</td>]
</tr>
</BOUCLE_signatures>
</tbody>
</table>
</B_signatures>


<!-- Forums -->

[<div class="forum-repondre"><B><A  HREF="forum.php3?(#PARAMETRES_FORUM)"><:repondre_article:></A></B></div>]
<br>

<h1 class="structure"><:Forum:></h1>

<B_forums>
<ul class="forum-total">

<BOUCLE_forums(FORUMS){id_article}{par date}{inverse}>

<li>
<div class="forum-fil">

<div class="forum">
<div class="forum-chapo">
<div class="forum-titre"><a name="forum#ID_FORUM"></a>#TITRE</div>
[(#DATE|affdate)][, <:par_auteur:> <A HREF="mailto:#EMAIL">(#NOM)</A>]
</div>
<div class="forum-item">
#TEXTE
[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
</div>
</div>

<B_forums_fils>
	<ul>
	<BOUCLE_forums_fils(FORUMS){id_parent}{par date}>

	<li>
	<div class="forum">
	<div class="forum-chapo">
	<div class="forum-titre"><a name="forum#ID_FORUM"></a>#TITRE</div>
	[(#DATE|affdate)][, <:par_auteur:> <A HREF="mailto:#EMAIL">(#NOM)</A>]
	</div>
	<div class="forum-item">
	#TEXTE
	[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
	[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
	</div>

	</div>

	<BOUCLE_Forums_Boucle(boucle_forums_fils)></BOUCLE_Forums_Boucle>
	</li>

	</BOUCLE_forums_fils>
	</ul>
</B_forums_fils>

</div>
</li>
</BOUCLE_forums>

</ul>
</B_forums>

</div>


#FORMULAIRE_ADMIN
</body>
</html>


</BOUCLE_article_principal>
<:aucun_article:>
<//B_article_principal>

--- NEW FILE: forum.php3 ---
<?php
$fond = "forum";
$delais = 3600;

include ("inc-public.php3");

?>

--- NEW FILE: resume-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] </title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]

<!-- Liens des forums -->
<B_forums_liens>
<div class="menu" title="<:derniers_messages_forum:>">
	<h1 class="structure"><:messages_recents:></h1>
	<div class="forums">
	<div class="menu-titre">
	<:derniers_commentaires:>
	</div>
	<ul>
<BOUCLE_forums_liens(FORUMS){plat}{par date}{inverse}{0,15}>
        <li class="menu-item">[<i>(#DATE|affdate_court)</i>:]
        <a href="#URL_FORUM">#TITRE</a>
        </li>
</BOUCLE_forums_liens>
	</ul>
	</div>
</div>
</B_forums_liens>


</div>

<!-- Une : articles les plus populaires -->

<div id="principal" class="contenu">

<h1 class="structure"><:articles_populaires:></h1>

<BOUCLE_article_un(ARTICLES) {par popularite} {inverse} {0,2}>
	[(#LOGO_ARTICLE_RUBRIQUE|right|#URL_ARTICLE)]
	[<div class="surtitre">(#SURTITRE)</div>]
	<h2 class="titre-extrait"><a href="#URL_ARTICLE">#TITRE</a></h2>
	[<div class="surtitre">(#SOUSTITRE)</div>]
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_un><:par_auteur:> <BOUCLE_auteurs_un(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_un>
	[<br><:popularite:>&nbsp;: <span class="important">(#POPULARITE)</span> %]
	</div>
	[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
	<br>
</BOUCLE_article_un>


	<div class="encart">

	<!-- <:sur_web:> -->

	<h1 class="structure"><:nouveautes_web:></h1>

	<B_syndic>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_syndic(SYNDIC_ARTICLES) {par date} {inverse} {0,15}>
		<li class="menu-item">
		[<i>(#DATE|affdate_court)</i>:]
		<a href="#URL_ARTICLE">[(#TITRE*)]</a>
		</li>
	</BOUCLE_syndic>
		</ul>
	</div>
	</div>
	</B_syndic>

	</div>


<h1 class="structure"><:articles_populaires:> (<:suite:>)</h1>

<!-- Articles les plus populaires (suite) -->

<BOUCLE_articles_populaires(ARTICLES) {par popularite} {inverse} {2,8}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_recents><:par_auteur:> <BOUCLE_auteurs_recents(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_recents><br>
	<:popularite:>&nbsp;: <span class="important">#POPULARITE</span> %
	</div>
	<br>
</BOUCLE_articles_populaires>


</div>
#FORMULAIRE_ADMIN
</body>
</html>



--- NEW FILE: puce.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: carto.php3 ---
<?php

$fond = "carto";
$delais = 24*3600;

include ("inc-public.php3");

?>

--- NEW FILE: inc-formulaire_ecrire_auteur.php3 ---
<?php

global $balise_FORMULAIRE_ECRIRE_AUTEUR_collecte ;
$balise_FORMULAIRE_ECRIRE_AUTEUR_collecte = array('id_auteur',
			     'email',
			     'sujet_message_auteur',
			     'texte_message_auteur',
			     'email_message_auteur'
);

function balise_FORMULAIRE_ECRIRE_AUTEUR_stat($args, $filtres)
{
  list($id_auteur, $mail, $sujet, $texte, $adres) = $args;
  return (!email_valide($mail) ? '' :
	  array($id_auteur, $mail,$sujet, $texte, $adres));
}

function balise_FORMULAIRE_ECRIRE_AUTEUR_dyn($id_auteur, $mail, $sujet, $texte, $adres) {
  global $spip_lang_rtl;
	include_ecrire("inc_lang.php3"); // pour spip_lang_rtl 
	if (!$spip_lang_rt) $spip_lang_rtl = '_rtl'; # INDISPENSABLE cf skel
	$mailko = $texte && !email_valide($adres);
	$validable = $texte && $sujet && (!$mailko);

	if ($validable && ($GLOBALS['valide'] == _T('form_prop_confirmer_envoi'))) { 
		$texte .= "\n\n-- "._T('envoi_via_le_site')." ".lire_meta('nom_site')." (".lire_meta('adresse_site')."/) --\n";
		include_ecrire("inc_mail.php3");
		envoyer_mail($mail, $sujet, $texte, $adres,
				"X-Originating-IP: ".$GLOBALS['REMOTE_ADDR']);
		return _T('form_prop_message_envoye');
	    }


	// repartir de zero pour les boutons car clean_link a pu etre utilisee

	$link = new Link;

	$link->delVar('sujet_message_auteur');
	$link->delVar('texte_message_auteur');
	$link->delVar('email_message_auteur');
	$link->delVar('id_auteur');
	return 
	  array('formulaire_ecrire_auteur', 0,
		array(
		      'action' => $link->getUrl(),
		      'id_auteur' => $id_auteur,
		      'mailko' => $mailko ? $spip_lang_rtl : '',
		      'mail' => $adres,
		      'sujetko' => ($texte && !$sujet) ? $spip_lang_rtl : '',
		      'sujet' => $sujet,
		      'texte' => $texte,
		      'valide' => ($validable ?
				    _T('form_prop_confirmer_envoi') :
				    _T('form_prop_envoyer'))
		      )
		);
}
?>

--- NEW FILE: formulaire_admin-dist.html ---
<div class="spip-admin-float">
<div class="spip-admin-bloc" dir='#LANG_DIR'>
<div class="spip-admin">
	<ul>[
	<li><a href='ecrire/articles.php3?id_article=(#HTTP_VARS{id_article})' class='spip-admin-boutons'><:admin_modifier_article:> ([(#HTTP_VARS{id_article})])</a></li>][
	<li><a href='ecrire/breves_voir.php3?id_breve=(#HTTP_VARS{id_breve})' class='spip-admin-boutons'><:admin_modifier_breve:> ([(#HTTP_VARS{id_breve})])</a></li>][
	<li><a href='ecrire/naviguer.php3?id_rubrique=(#HTTP_VARS{id_rubrique})' class='spip-admin-boutons'><:admin_modifier_rubrique:> ([(#HTTP_VARS{id_rubrique})])</a></li>][
	<li><a href='ecrire/mots_edit.php3?id_mot=(#HTTP_VARS{id_mot})' class='spip-admin-boutons'><:admin_modifier_mot:> ([(#HTTP_VARS{id_mot})])</a></li>][
	<li><a href='ecrire/auteurs_edit.php3?id_auteur=(#HTTP_VARS{id_auteur})' class='spip-admin-boutons'><:admin_modifier_auteur:> ([(#HTTP_VARS{id_auteur})])</a></li>]
	<li><a href='[(#HTTP_VARS{action})]var_mode=recalcul' class='spip-admin-boutons'><:admin_recalculer:>[(#HTTP_VARS{use_cache})]</a></li>[
	<li><a href='ecrire/(#HTTP_VARS{statistiques})[id_article=(#HTTP_VARS{id_article})]' class='spip-admin-boutons'><:info_visites:>&nbsp;[(#HTTP_VARS{visites})];&nbsp;<:info_popularite_5:>&nbsp;[(#HTTP_VARS{popularite})]</a></li>][
	<li><a href='[(#HTTP_VARS{action})]var_mode=(#HTTP_VARS{debug})' class='spip-admin-boutons'>Debug</a></li>]
	</ul>
</div>
</div>
</div>

--- NEW FILE: inc-menu_lang.php3 ---
<?php

global $balise_MENU_LANG_collecte;
$balise_MENU_LANG_collecte = array('menu_lang');

// s'il n'y a qu'une langue eviter definitivement la balise ?php 

function balise_MENU_LANG_stat ($args, $filtres)
{
  if (!strpos(lire_meta('langues_multilingue'),',')) return '';
  return $args;
}

// normalement $opt sera toujours non vide suite au test ci-dessus

function balise_MENU_LANG_dyn($default)
{
  include_ecrire("inc_lang.php3");
  $opt = liste_options_langues('var_lang', $default);
  if (!$opt) return '';
  include_local("inc-menu_lang_ecrire.php3");
  return menu_lang_pour_tous('var_lang', $opt);
}
?>

--- NEW FILE: plan.php3 ---
<?php

$fond = "plan";
$delais = 2 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: backend-breves-dist.html ---
<?php echo '<'.'?xml version="1.0" encoding="#CHARSET"?'.">\n"; ?>
<rss version="0.91" xmlns:dc="http://purl.org/dc/elements/1.1/">

<channel>

	<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
	<link>#URL_SITE_SPIP/</link>
	<description></description>
	<language>#LANG</language>

	<image>
		<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
		<url>#URL_SITE_SPIP[/(#LOGO_SITE_SPIP||extraire_attribut{src})]</url>
		<link>#URL_SITE_SPIP/</link>
		<description></description>
	</image>

	<BOUCLE_breves(BREVES){id_rubrique ?}{lang ?}{par date}{inverse}{0,10}>
	<item>
		<title>[(#TITRE|texte_backend)]</title>
		<link>#URL_SITE_SPIP/#URL_BREVE</link>
		<date>#DATE</date>
		<description>[&lt;img src="#URL_SITE_SPIP/(#LOGO_BREVE||extraire_attribut{src})" align="left" hspace="4" vspace="4"&gt; ][(#TEXTE|texte_backend)]</description>
		<dc:date>[(#DATE|date_iso)]</dc:date>
		<dc:format>text/html</dc:format>
		<dc:language>#LANG</dc:language>
	</item>
	</BOUCLE_breves>

</channel>

</rss>

--- NEW FILE: spip_acces_doc.php3 ---
<?
# script d'acces aux documents joints
# doit etre appele avec un de ces 2 parametres de GET:
# - id_document 
# - file 
# il verifie soit que le demandeur est authentifie
# soit que le fichier est joint ? au moins 1 article, breve ou rubrique

$id_document = ($_GET['id_document']);
$file = urldecode($_GET['file']);
if (strpos($file,'../') !== false)
  $refus = 1;
else
  {
    $refus = false;
    include ("ecrire/inc_version.php3");
    include_local(_FILE_CONNECT);
    include_ecrire("inc_meta.php3");
    include_ecrire("inc_session.php3");

    global $auteur_session;
    if ($cookie_session = $HTTP_COOKIE_VARS['spip_session']) 
      {
	if (verifier_session($cookie_session)) 
	  {
	    if ($auteur_session['statut'] == '0minirezo' 
		OR $auteur_session['statut'] == '1comite') 
	      $auth_login = $auteur_session['login'];
	  }
      }

    if (!$id_document) {
      $id_document = @spip_fetch_array(spip_query("select id_document from spip_documents as documents where documents.fichier='".$file."'"));
      if (!$id_document) $refus = 2;
      $id_document = $id_document['id_document'];
    } else {
      $file = @spip_fetch_array(spip_query("select fichier from spip_documents as documents where id_document='". $id_document ."'"));
      if (!$file) $refus = 3;
      $file = $file['fichier'];
    }
  }

if (!$auth_login && !$refus) { 
    if (!spip_num_rows(spip_query("select articles.id_article
from spip_documents_articles as rel_articles, spip_articles as articles 
where rel_articles.id_article = articles.id_article AND
articles.statut = 'publie' AND rel_articles.id_document ='".
			       $id_document .
				"' LIMIT 1"))) {
      if (!spip_num_rows(spip_query("select rubriques.id_rubrique
from spip_documents_rubriques as rel_rubriques, spip_rubriques as rubriques 
where rel_rubriques.id_rubrique = rubriques.id_rubrique AND
rubriques.statut = 'publie' AND rel_rubriques.id_document ='".
			       $id_document .
				  "' LIMIT 1"))) {
	if (!spip_num_rows(spip_query("select breves.id_breve
from spip_documents_breves as rel_breves, spip_breves as breves 
where rel_breves.id_breve = breves.id_breve AND
breves.statut = 'publie' AND rel_breves.id_document ='".
			       $id_document .
				  "' LIMIT 1")))
	  $refus = 4; } } }

if (!$refus)
  {
     header("Content-Type: ". mime_content_type($file));
     header("Content-Length: ". filesize($file));
     header("Content-Disposition: attachment; filename=\"". basename($file) ."\";");
     header("Content-Transfer-Encoding: binary");
     readfile($file);
   }
 else
   spip_log("Acces refuse ($refus) au document " . ($_GET['id_document']) . ': ' .($_GET['file']));

?>
--- NEW FILE: index.php ---
<?php
	// pour hebergeurs ayant oublie de configurer DirectoryIndex index.php3
	include ("index.php3");
?>

--- NEW FILE: inc-boucles.php3 ---
<?php

//
// Ce fichier definit les boucles standard de SPIP
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_BOUCLES")) return;
define("_INC_BOUCLES", "1");


//
// Boucle sur une table hors SPIP
//
function boucle_DEFAUT($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$boucle->from[] =  $boucle->type_requete . " AS " . $boucle->type_requete;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(BOUCLE)> boucle dite recursive
//
function boucle_BOUCLE_dist($id_boucle, &$boucles) {

	    return "\n	\$t0 = " . $boucles[$id_boucle]->return . ";";
}

//
// <BOUCLE(ARTICLES)>
//
function boucle_ARTICLES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "articles AS $id_table";
	if (!$GLOBALS['var_preview']) {
		$boucle->where[] = "$id_table.statut='publie'";
		if (lire_meta("post_dates") == 'non')
			$boucle->where[] = "$id_table.date < NOW()";
	} else
		$boucle->where[] = "$id_table.statut IN ('publie','prop')";
	return calculer_boucle($id_boucle, $boucles); 
}

//
// <BOUCLE(AUTEURS)>
//
function boucle_AUTEURS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "auteurs AS $id_table";
	// Si pas de lien avec un article, selectionner
	// uniquement les auteurs d'un article publie
	if (!$GLOBALS['var_preview'])
	if (!$boucle->lien AND !$boucle->tout) {
		$boucle->from[] =  "auteurs_articles AS lien";
		$boucle->from[] =  "articles AS articles";
		$boucle->where[] = "lien.id_auteur=$id_table.id_auteur";
		$boucle->where[] = 'lien.id_article=articles.id_article';
		$boucle->where[] = "articles.statut='publie'";
		$boucle->group =  $boucle->id_table . '.' . $boucle->primary;
	}
	// pas d'auteurs poubellises
	$boucle->where[] = "NOT($id_table.statut='5poubelle')";
	return calculer_boucle($id_boucle, $boucles); 
}

//
// <BOUCLE(BREVES)>
//
function boucle_BREVES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "breves AS $id_table";
	if (!$GLOBALS['var_preview'])
		$boucle->where[] = "$id_table.statut='publie'";
	else
		$boucle->where[] = "$id_table.statut IN ('publie','prop')";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(FORUMS)>
//
function boucle_FORUMS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "forum AS $id_table";
	// Par defaut, selectionner uniquement les forums sans pere
	if (!$boucle->tout AND !$boucle->plat) 
		{
	$boucle->where[] = "$id_table.id_parent=0";
		}
	$boucle->where[] = "$id_table.statut='publie'";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(SIGNATURES)>
//
function boucle_SIGNATURES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "signatures AS $id_table";
	$boucle->from[] =  "petitions AS petitions";
	$boucle->from[] =  "articles articles";
	$boucle->where[] = "petitions.id_article=articles.id_article";
	$boucle->where[] = "petitions.id_article=$id_table.id_article";
	$boucle->where[] = "$id_table.statut='publie'";
	$boucle->group =  $boucle->id_table . '.' . $boucle->primary;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(DOCUMENTS)>
//
function boucle_DOCUMENTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "documents AS $id_table";
	$boucle->from[] =  "types_documents AS types_documents";
	$boucle->where[] = "$id_table.id_type=types_documents.id_type";
	$boucle->where[] = "$id_table.taille > 0";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(TYPES_DOCUMENTS)>
//
function boucle_TYPES_DOCUMENTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "types_documents AS $id_table";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(GROUPES_MOTS)>
//
function boucle_GROUPES_MOTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "groupes_mots AS $id_table";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(MOTS)>
//
function boucle_MOTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "mots AS $id_table";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(RUBRIQUES)>
//
function boucle_RUBRIQUES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "rubriques AS $id_table";
	if (!$GLOBALS['var_preview'])
		if (!$boucle->tout) $boucle->where[] = "$id_table.statut='publie'";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(HIERARCHIE)>
//
function boucle_HIERARCHIE_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "rubriques AS $id_table";

	// Si la boucle mere est une boucle RUBRIQUES il faut ignorer la feuille
	// sauf si le critere {tout} est present (cf. inc-html-squel)
	$exclure_feuille = ($boucle->tout ? 'false' : 'true');

	// $hierarchie sera calculee par une fonction de inc-calcul-outils
	$boucle->where[] = 'id_rubrique IN ($hierarchie)';
	$boucle->select[] = 'FIND_IN_SET(id_rubrique, \'$hierarchie\')-1 AS rang';
	$boucle->order = 'rang';
	$boucle->hierarchie = '$hierarchie = calculer_hierarchie('
	. calculer_argument_precedent($boucle->id_boucle, 'id_rubrique', $boucles)
	. ', '
	. $exclure_feuille
	. ');';
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(SYNDICATION)>
//
function boucle_SYNDICATION_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "syndic AS $id_table";
	$boucle->where[] = "$id_table.statut='publie'";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(SYNDIC_ARTICLES)>
//
function boucle_SYNDIC_ARTICLES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "syndic_articles  AS $id_table";
	$boucle->from[] =  "syndic AS syndic";
	$boucle->where[] = "$id_table.id_syndic=syndic.id_syndic";
	$boucle->where[] = "$id_table.statut='publie'";
	$boucle->where[] = "syndic.statut='publie'";
	$boucle->select[]='syndic.nom_site AS nom_site'; # derogation zarbi
	$boucle->select[]='syndic.url_site AS url_site'; # idem
	return calculer_boucle($id_boucle, $boucles); 
}


?>

--- NEW FILE: inc-compilo.php3 ---
<?php

//
// Fichier principal du compilateur de squelettes
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_COMPILO")) return;
define("_INC_COMPILO", "1");


// Definition de la structure $p, et fonctions de recherche et de reservation
// dans l'arborescence des boucles
include_local("inc-compilo-index.php3");  # index ? structure ? pile ?

// definition des boucles
include_local("inc-boucles.php3");

// definition des criteres
include_local("inc-criteres.php3");

// definition des balises
include_local("inc-balises.php3");

// definition de l'API
include_local("inc-compilo-api.php3");

# definition des tables
include_ecrire('inc_serialbase.php3');

// outils pour debugguer le compilateur
#include_local("inc-compilo-debug.php3"); # desactive

//
// Calculer un <INCLURE()>
//
function calculer_inclure($fichier, $params, $id_boucle, &$boucles) {
	global $dossier_squelettes;

	$l = array();
	if ($params) {
		foreach($params as $var => $val) {
			if ($val) {
			  $val = trim($val);
			  $val = ereg_replace('^["\'](.*)["\']$', "\\1",$val);
			  $l[] = "\'$var\' => \'" .
				 addslashes(calculer_param_dynamique($val,
								     $boucles,
								     $idb)) .
				  "\'";
			}
			else {
			// Cas de la langue : passer $spip_lang
			  // et non table.lang (car depend de {lang_select})
				if ($var =='lang')
					$l[] = "\'lang\' => \''.\$GLOBALS[\"spip_lang\"].'\'";
				else
					$l[] = "\'$var\' => \'' . addslashes(" . index_pile($id_boucle, $var, $boucles) . ") .'\'";
				}
			}
	}
	return "\n'<".
		"?php\n\t\$contexte_inclus = array(" .
		join(", ",$l) .
		");\n\t\$fichier_inclus = \'$fichier\';\n" .
		(($dossier_squelettes) ?
		("
			if (@file_exists(\'$dossier_squelettes/$fichier\')){
				include(\'$dossier_squelettes/$fichier\');
			} else {
				include(\'$fichier\');
			} " ) :
		("\tinclude(\'$fichier\');")) .
		"\n?'." . "'>'";
}


//
// Traite une partie "texte" d'un squelette (c'est-a-dire tout element
// qui ne contient ni balise, ni boucle, ni <INCLURE()> ; le transforme
// en une EXPRESSION php (qui peut etre l'argument d'un Return ou la
// partie droite d'une affectation). Ici sont analyses les elements
// multilingues des squelettes : <:xxx:> et <multi>[fr]coucou</multi>
//
function calculer_texte($texte, $id_boucle, &$boucles, $id_mere) {
	$code = "'".ereg_replace("([\\\\'])", "\\\\1", $texte)."'";

	// bloc multi
	if (eregi('<multi>', $texte)) {
		$ouvre_multi = 'extraire_multi(';
		$ferme_multi = ')';
	} else {
		$ouvre_multi = $ferme_multi = '';
	}

	// Reperer les balises de traduction <:toto:>
	while (eregi("<:(([a-z0-9_]+):)?([a-z0-9_]+)(\|[^>]*)?:>", $code, $match)) {
		//
		// Traiter la balise de traduction multilingue
		//
		$chaine = strtolower($match[3]);
		if (!($module = $match[2]))
			// ordre standard des modules a explorer
			$module = 'local/public/spip';
		$c = new Champ;
		$c->code = "_T('$module:$chaine')";
		$c->fonctions = explode('|', substr($match[4],1));
		$c->id_boucle = $id_boucle;
		$c->boucles = &$boucles;
		$c->statut = 'php'; // ne pas manger les espaces avec trim()
		$c = applique_filtres($c);
		$code = str_replace($match[0], "'$ferme_multi.$c.$ouvre_multi'", $code);
	}

	return $ouvre_multi . $code . $ferme_multi;
}


//
// calculer_boucle() produit le corps PHP d'une boucle Spip 
// (sauf les recursives)
// Ce corps est essentiellement une boucle while
// remplissant une variable $t0 retournee en valeur
//
function calculer_boucle($id_boucle, &$boucles) {

	$boucle = &$boucles[$id_boucle];
	$type_boucle = $boucle->type_requete;
	$return = $boucle->return;
	$id_table = $boucle->id_table;
	$primary = $boucle->primary;
	$id_field = $id_table . "." . $primary;
	// La boucle doit-elle selectionner la langue ?
	// 1. par defaut, les boucles suivantes le font
	// "peut-etre", c'est-a-dire si forcer_lang == false.
	if (
		$type_boucle == 'articles'
		OR $type_boucle == 'rubriques'
		OR $type_boucle == 'hierarchie'
		OR $type_boucle == 'breves'
	) $lang_select = 'maybe';
	else
		$lang_select = false;

	// 2. a moins d'une demande explicite
	if ($boucle->lang_select == 'oui') $lang_select = 'oui';
	if ($boucle->lang_select == 'non') $lang_select = false;

	// Penser a demander le champ lang
	if ($lang_select)
		$boucle->select[] = 
			// cas des tables SPIP
			($id_table ? $id_table.'.' : '')
			// cas general ({lang_select} sur une table externe)
			. 'lang';

	// Calculer les invalideurs si c'est une boucle non constante
	$constant = ereg("^\(?'[^']*'\)?$",$return);

	if ((!$primary) || $constant)
		$invalide = '';
	else {
		$boucle->select[] = $id_field;

		$invalide = "\n			\$Cache['$primary']";
		if ($primary != 'id_forum')
			$invalide .= "[\$Pile[\$SP]['$primary']] = 1;";
		else
			$invalide .= "[calcul_index_forum(" . 
				// Retournera 4 [$SP] mais force la demande du champ a MySQL
				index_pile($id_boucle, 'id_article', $boucles) . ',' .
				index_pile($id_boucle, 'id_breve', $boucles) .  ',' .
				index_pile($id_boucle, 'id_rubrique', $boucles) .',' .
				index_pile($id_boucle, 'id_syndic', $boucles) .  ")] = 1;";
		$invalide .= ' // invalideurs';
	}

	// Cas {1/3} {1,4} {n-2,1}...

	$flag_cpt = $boucle->mode_partie || // pas '$compteur' a cause du cas 0
		strpos($return,'compteur_boucle');

	//
	// Creer le debut du corps de la boucle :
	//
	$debut = '';
	if ($flag_cpt)
		$debut = "\n		\$compteur_boucle++;";

	if ($boucle->mode_partie)
		$debut .= '
		if ($compteur_boucle-1 >= $debut_boucle
		AND $compteur_boucle-1 <= $fin_boucle) {';
	
	if ($lang_select AND !$constant) {
		$selecteur = 
			(($lang_select == 'maybe') ? 
			'if (!$GLOBALS["forcer_lang"]) ':'')
			. 'if ($x = $Pile[$SP]["lang"]) $GLOBALS[\'spip_lang\'] = $x;'
			. ' // lang_select';
		$debut .= "\n			".$selecteur;
	}

	$debut .= $invalide;

	if ($boucle->doublons)
		$debut .= "\n			\$doublons['".$boucle->doublons."'] .= ','. " .
		index_pile($id_boucle, $primary, $boucles)
		. "; // doublons";

	// gestion optimale des separateurs et des boucles constantes

	$corps = $debut . 
		((!$boucle->separateur) ? 
			(($constant && !$debut) ? $return :
			 	("\n\t\t" . '$t0 .= ' . $return . ";")) :
		 ("\n\t\t\$t1 " .
			((strpos($return, '$t1.') === 0) ? 
			 (".=" . substr($return,4)) :
			 ('= ' . $return)) .
		  ";\n\t\t" .
		  '$t0 .= (($t1 && $t0) ? \'' . $boucle->separateur .
		  "' : '') . \$t1;"));
     
	// Fin de parties
	if ($boucle->mode_partie)
		$corps .= "\n		}\n";

	$texte = '';

	// Gestion de la hierarchie (voir inc-boucles.php3)
	if ($boucle->hierarchie)
		$texte .= "\n	".$boucle->hierarchie;


	// si le corps est une constante, ne pas appeler le serveur N fois!
	if (ereg("^\(?'[^']*'\)?$",$corps)) {
		// vide ?
		if (($corps == "''") || ($corps == "('')")) {
			if (!$boucle->numrows)
				return 'return "";';
			else
				$corps = "";
		} else {
			$boucle->numrows = true;
			$corps = "\n		".'for($x=$Numrows["'.$id_boucle.'"];$x>0;$x--)
			$t0 .= ' . $corps .';';
		}
	} else {

	$corps = '

	// RESULTATS
	while ($Pile[$SP] = @spip_abstract_fetch($result,"' .
		  $boucle->sql_serveur .
		  '")) {'. "\n$corps\n	}\n";
		 

		// Memoriser la langue avant la boucle pour la restituer apres
		if ($lang_select) {
			$texte .= "\n	\$old_lang = \$GLOBALS['spip_lang'];";
			$corps .= "\n	\$GLOBALS['spip_lang'] = \$old_lang;";
		}
	}

	//
	// Requete
	//

	// hack critere recherche : ignorer la requete en cas de hash vide
	// Recherche : recuperer les hash a partir de la chaine de recherche
	if ($boucle->hash) {
		$init =  '
	// RECHERCHE
	list($rech_select, $rech_where) = prepare_recherche($GLOBALS["recherche"], "'.$boucle->primary.'", "'.$boucle->id_table.'");
	if ($rech_select) ';
	}

	else $init = '';

	$init .= "\n\n	// REQUETE
	\$result = spip_abstract_select(\n\t\tarray(\"". 
		# En absence de champ c'est un decompte : 
	  	# prendre la primary pour avoir qqch
	  	# (COUNT incompatible avec le cas general
		(($boucle->select) ? 
			join("\",\n\t\t\"", array_unique($boucle->select)) :
			$id_field) .
		'"), # SELECT
		array("' .
		join('","', array_unique($boucle->from)) .
		'"), # FROM
		array(' .
		(!$boucle->where ? '' : ( '"' . join('",
		"', $boucle->where) . '"')) .
		"), # WHERE
		'".addslashes($boucle->group)."', # GROUP
		" . ($boucle->order ? $boucle->order : "''") .", # ORDER
		" . (strpos($boucle->limit, 'intval') === false ?
			"'".$boucle->limit."'" :
			$boucle->limit). ", # LIMIT
		'".$boucle->sous_requete."', # sous
		".$boucle->compte_requete.", # compte
		'".$id_table."', # table
		'".$boucle->id_boucle."', # boucle
		'".$boucle->sql_serveur."'); # serveur";

	$init .= "\n	".'$t0 = "";
	$SP++;';
	if ($flag_cpt)
		$init .= "\n	\$compteur_boucle = 0;";


	if ($boucle->mode_partie)
		$init .= calculer_parties($boucle->partie,
			$boucle->mode_partie,
			$boucle->total_parties,
			$id_boucle);
	else if ($boucle->numrows)
		$init .= "\n	\$Numrows['" .
			$id_boucle .
			"'] = @spip_abstract_count(\$result,'" .
			$boucle->sql_serveur .
			"');";

	//
	// Conclusion et retour
	//
	$conclusion = "\n	@spip_abstract_free(\$result,'" .
	  $boucle->sql_serveur . "');";

	return $texte . $init . $corps . $conclusion;
}


//
// fonction traitant les criteres {1,n} (analyses dans inc-criteres)
//
## a deplacer dans inc-criteres ??
function calculer_parties($partie, $mode_partie, $total_parties, $id_boucle) {

	// Notes :
	// $debut_boucle et $fin_boucle sont les indices SQL du premier
	// et du dernier demandes dans la boucle : 0 pour le premier,
	// n-1 pour le dernier ; donc total_boucle = 1 + debut - fin

	// nombre total avant partition
	$retour = "\n\n	// Partition\n	" .
		'$nombre_boucle = @spip_abstract_count($result,"' .
		$boucle->sql_serveur .
		'");';

	ereg("([+-/])([+-/])?", $mode_partie, $regs);
	list(,$op1,$op2) = $regs;

	// {1/3}
	if ($op1 == '/') {
		$retour .= "\n	"
			.'$debut_boucle = ceil(($nombre_boucle * '
			. ($partie - 1) . ')/' . $total_parties . ");\n	"
			. '$fin_boucle = ceil (($nombre_boucle * '
			. $partie . ')/' . $total_parties . ") - 1;";
	}

	// {1,x}
	if ($op1 == '+') {
		$retour .= "\n	"
			. '$debut_boucle = ' . $partie . ';';
	}
	// {n-1,x}
	if ($op1 == '-') {
		$retour .= "\n	"
			. '$debut_boucle = $nombre_boucle - ' . $partie . ';';
	}
	// {x,1}
	if ($op2 == '+') {
		$retour .= "\n	"
			. '$fin_boucle = $debut_boucle + ' . $total_parties . ' - 1;';
	}
	// {x,n-1}
	if ($op2 == '-') {
		$retour .= "\n	"
			.'$fin_boucle = $debut_boucle + $nombre_boucle - '.$total_parties.' - 1;';
	}

	// Rabattre $fin_boucle sur le maximum
	$retour .= "\n	"
		.'$fin_boucle = min($fin_boucle, $nombre_boucle - 1);';

	// calcul du total boucle final
	$retour .= "\n	"
		.'$Numrows[\''.$id_boucle.'\'] = $fin_boucle - $debut_boucle + 1;';

	return $retour;
}

// Production du code PHP a partir de la sequence livree par le phraseur
// $boucles est passe par reference pour affectation par index_pile.
// Retourne une expression PHP,

function calculer_liste($tableau, $descr, &$boucles, $id_boucle='', $niv=1) {
	if (!$tableau) return "''";
        $codes = array();
	$t = '$t' . $niv;

	for ($i=0; $i<=$niv; $i++) $tab .= "\t";

	foreach ($tableau as $p) {

		switch($p->type) {
		// texte seul
		case 'texte':
			$code = calculer_texte($p->texte, $id_boucle, $boucles, $descr['id_mere']);
			$commentaire='';
			$avant='';
			$apres='';
			$altern = "''";
			break;

		// inclure
		case 'include':
			$code= calculer_inclure($p->fichier,
						$p->params,
						$id_boucle,
						$boucles);
			$commentaire = '<INCLURE('.$p->fichier.')>';
			$avant='';
			$apres='';
			$altern = "''";
			break;

		// boucle
		case 'boucle':
			$nom = $p->id_boucle;
			$newdescr = $descr;
			$newdescr['id_mere'] = $nom;
			$code = 'BOUCLE' .
			  ereg_replace("-","_", $nom) . $descr['nom'] .
			  '($Cache, $Pile, $doublons, $Numrows, $SP)';
			$commentaire='';
			$avant = calculer_liste($p->cond_avant,
				$newdescr, $boucles, $id_boucle, $niv+2);
			$apres = calculer_liste($p->cond_apres,
				$newdescr, $boucles, $id_boucle, $niv+2);
			$altern = calculer_liste($p->cond_altern,
				$newdescr, $boucles, $id_boucle, $niv+1);
			break;

		// balise SPIP
		default: 

			// cette structure pourrait etre completee des le phrase' (a faire)
			$p->id_boucle = $id_boucle;
			$p->boucles = &$boucles;
			$p->id_mere = $descr['id_mere'];
			$p->documents = $descr['documents'];
			$p->statut = 'html';
			$p->type_requete = $boucles[$id_boucle]->type_requete;

			$code = calculer_champ($p);
			$commentaire = '#' . $p->nom_champ . $p->etoile;
			$avant = calculer_liste($p->cond_avant,
				$descr, $boucles, $id_boucle, $niv+1);
			$apres = calculer_liste($p->cond_apres,
				$descr, $boucles, $id_boucle, $niv+1);
			$altern = "''";
			break;

		} // switch

		if ($avant == "''") $avant = '';
		if ($apres == "''") $apres = '';
		if ($avant||$apres||($altern!="''"))
		  {
		    $res = (!$avant ? "" : "$avant . ") . 
		      $t .
		      (!$apres ? "" : " . $apres");

		    if (($res != $t) || ($altern != "''"))
		      $code = "(($t = $code) ?\n\t$tab($res) :\n\t$tab($altern))";
		  }
		// if ($code) # c'est toujours etre ainsi
		  $codes[]= (!$commentaire ? $code : 
			     ("/"."* $commentaire *"."/ " . $code));
	} // foreach

	return "(" . join ("\n$tab. ", $codes) . ")";
}

// Prend en argument le source d'un squelette, sa grammaire et un nom.
// Retourne une fonction PHP/SQL portant ce nom et calculant une page HTML.
// Pour appeler la fonction produite, lui fournir 2 tableaux de 1 e'le'ment:
// - 1er: element 'cache' => nom (du fichier ou` mettre la page)
// - 2e: element 0 contenant un environnement ('id_article => $id_article, etc)
// Elle retourne alors un tableau de 4 e'le'ments:
// - 'texte' => page HTML, application du squelette a` l'environnement;
// - 'squelette' => le nom du squelette
// - 'process_ins' => 'html' ou 'php' selon la pre'sence de PHP dynamique
// - 'invalideurs' =>  de'pendances de cette page, pour invalider son cache.
// (voir son utilisation, optionnelle, dans invalideur.php)
// En cas d'erreur, elle retourne un tableau des 2 premiers elements seulement

function calculer_squelette($squelette, $nom, $gram, $sourcefile) {
# 3 variables qui sont en fait des constantes apr?s chargement
  global $table_primary, $table_des_tables, $tables_des_serveurs_sql;
	// Phraser le squelette, selon sa grammaire
	// pour le moment: "html" seul connu (HTML+balises BOUCLE)
	$boucles = '';
	spip_timer('calcul_skel');

	include_local("inc-$gram-squel.php3");

	$racine = parser($squelette, '',$boucles, $nom);

	// tableau des informations sur le squelette
	$descr = array('nom' => $nom, 'documents' => false);

	if ($boucles) {
	  // une boucle documents est conditionnee par tout le reste!
	  // une boucle avec critere de recheche conditionne tout le reste!
	  // (a cause du cas #nom_de_boucle:URL_*)
	  // 
		foreach($boucles as $idb => $boucle)
		  {
		    if ($boucle->param && is_array($boucle->param)) {
				if (($boucle->type_requete == 'documents') && 
				    in_array('doublons',$boucle->param))
				  { $descr['documents'] = true; break; }
				if (in_array('recherche',$boucle->param))
					$boucles[$idb]->hash = true;
			}
		  }
	// Commencer par reperer les boucles appelees explicitement 
	// car elles indexent les arguments de maniere derogatoire
		foreach($boucles as $id => $boucle) { 
			if ($boucle->type_requete == 'boucle') {
				$rec = &$boucles[$boucle->param];
				if (!$rec) {
					return array(_T('info_erreur_squelette'),
						($boucle->param
						. _L(' boucle recursive non definie')));
				} else {
					$rec->externe = $id;
					$descr['id_mere'] = $id;
					$boucles[$id]->return =
						calculer_liste(array($rec),
							 $descr,
							 $boucles,
							 $boucle->param);
				}
			}
		}
		foreach($boucles as $id => $boucle) { 
			$type = $boucle->type_requete;
			if ($type != 'boucle') {
				$boucles[$id]->id_table = $table_des_tables[$type];
				if ($boucles[$id]->id_table) {
					$boucles[$id]->primary = $table_primary[$type];
				} else { 
					// table non Spip.
					$boucles[$id]->id_table = $type;
					$serveur = $boucle->sql_serveur;
					$boucles[$id]->primary = $tables_des_serveurs_sql[$serveur ? $serveur : 'localhost'][$type]['key']["PRIMARY KEY"]; 
				}
				if ($boucle->param) {
					$res = calculer_criteres($id, $boucles);
					if (is_array($res))
						return $res; # erreur
				}
				$descr['id_mere'] = $id;
				$boucles[$id]->return =
				calculer_liste($boucle->milieu,
					 $descr,
					 $boucles,
					 $id);
			}
		}
	}

	// idem pour la racine
	$descr['id_mere'] = '';
	$corps = calculer_liste($racine, $descr, $boucles);

	// Corps de toutes les fonctions PHP,
	// en particulier les requetes SQL et TOTAL_BOUCLE
	// de'terminables seulement maintenant
	// Les 3 premiers parame`tres sont passe's par re'fe'rence
	// (sorte d'environnements a` la Lisp 1.5)
	// sauf pour la fonction principale qui recoit les initialisations

	$code = '';
	if ($boucles) {

		foreach($boucles as $id => $boucle) {
			// appeler la fonction de definition de la boucle
			$f = 'boucle_'.strtoupper($boucle->type_requete);
			// si pas de definition perso, definition spip
			if (!function_exists($f)) $f = $f.'_dist';
			// laquelle a une definition par defaut
			if (!function_exists($f)) $f = 'boucle_DEFAUT';
			$boucles[$id]->return = $f($id, $boucles);
		}

		foreach($boucles as $id => $boucle) {

			// Reproduire la boucle en commentaire
			$pretty = "BOUCLE$id(".strtoupper($boucle->type_requete).")";
		    if ($boucle->param && is_array($boucle->param)) 
				$pretty .= " {".join("} {", $boucle->param)."}";
			// sans oublier les parametres traites en amont
			if ($boucle->separateur)
			  $pretty .= '{"' . $boucle->separateur . '"}';
			if ($boucle->tout)
			  $pretty .= '{tout}';
			if ($boucle->plat)
			  $pretty .= '{plat}';
			$pretty = ereg_replace("[\r\n]", " ", $pretty);

			// Puis envoyer son code
			$codeboucle = "\n//\n// <$pretty>\n//\n"
			."function BOUCLE" . ereg_replace("-","_",$id) . $nom .
			'(&$Cache, &$Pile, &$doublons, &$Numrows, $SP) {' .
			$boucle->return;

			$fincode = "\n	return \$t0;"
			."\n}\n\n";

			## inserer les elements pour le debuggueur, a deux niveaux :
			## 1) apres le calcul d'une boucle compilee, envoyer le code
			##    compile vers boucle_debug_compile()
			## 2) le resultat de la boucle, lui, sera plus tard envoye vers
			##    boucle_debug_resultat()
			if ($GLOBALS['var_mode'] == 'debug') {
				boucle_debug_compile ($id, $nom, $pretty,
					$sourcefile, $codeboucle.$fincode);
				$codedebug = "
	boucle_debug_resultat('$id', '$nom', \$t0);";
			}

			$code .= $codeboucle.$codedebug.$fincode;
		}
	}

	$secondes = spip_timer('calcul_skel');
	spip_log("calcul skel $sourcefile ($secondes)");

	if (is_array($boucles))
		$aff_boucles = join (', ', array_keys($boucles));
	else
		$aff_boucles = "pas de boucle";

	$squelette_compile = "<"."?php
/*
 * Squelette : $sourcefile
 * Date :      ".http_gmoddate(@filemtime($sourcefile))." GMT
 * Compile :   ".http_gmoddate(time())." GMT ($secondes)
 * Boucles :   ".$aff_boucles."
 */
$code

//
// Fonction principale du squelette $sourcefile
//
function $nom (\$Cache, \$Pile, \$doublons=array(), \$Numrows='', \$SP=0) {
\$t0 = $corps;

	return array(
		'texte' => \$t0,
		'squelette' => '$nom',
		'process_ins' => ((strpos(\$t0,'<'.'?')=== false) ? 'html' : 'php'),
		'invalideurs' => \$Cache
	);
}

?".">";

	if ($GLOBALS['var_mode'] == 'debug')
		squelette_debug_compile($nom, $sourcefile, $squelette_compile);

	return $squelette_compile;

}

?>

--- NEW FILE: spipcarto.zip ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: formulaire_site-dist.html ---
<form action="#SELF" method="post">
      <br />
      <fieldset	class='spip_encadrer' style='color: black; font-size: 90%'>
	<legend></legend>
	<label>
	  <:form_prop_nom_site:>
	  <input type="text" class="forml" name="nom_site" value="" size="30">
	</label>
	<label>
	  <:form_prop_url_site:>
	  <input type="text" class="forml" name="url_site" value="" size="30">
	</label>
	<label><:form_prop_description:>
	  <textarea name='description_site' rows='5' class='forml' cols='40'></textarea>
	</label>
	<div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>"></div>
      </fieldset>
</form>

--- NEW FILE: inc-compilo-api.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_COMPILO_API")) return;
define("_INC_COMPILO_API", "1");


// Definition des classes Boucle, Texte, Inclure, Champ

class Texte {
	var $type = 'texte';
	var $texte;
}

class Inclure {
	var $type = 'include';
	var $fichier;
	var $params;
}

//
// encodage d'une boucle SPIP en un objet PHP
//
class Boucle {
	var $type = 'boucle';
	var $id_boucle;
	var $id_parent ='';
	var $cond_avant, $milieu, $cond_apres, $cond_altern;
	var $lang_select;
	var $type_requete;
	var $sql_serveur;
	var $param = array();
	var $separateur;
	var $doublons;
	var $partie, $total_parties,$mode_partie;
	var $externe = ''; # appel a partir d'une autre boucle (recursion)
	// champs pour la construction de la requete SQL
	var $tout = false;
	var $plat = false;
	var $select;
	var $from;
	var $where;
	var $limit;
	var $group = '';
	var $order = '';
	var $date = 'date' ;
	var $hash = false ;
	var $lien = false;
	var $sous_requete = false;
	var $compte_requete = 1;
	var $hierarchie = '';
	// champs pour la construction du corps PHP
	var $id_table;
	var $primary;
	var $return;
	var $numrows = false; 
}

class Champ {
	var $type = 'champ';
	var $nom_champ;
	var $nom_boucle= ''; // seulement si boucle explicite
	var $cond_avant, $cond_apres; // tableaux d'objets
	var $fonctions;  // filtre explicites
	var $etoile;
	// champs pour la production de code
	var $id_boucle;
	var $boucles;
	var $type_requete;
	var $code;	// code du calcul
	var $statut;	// 'numerique, 'h'=texte (html) ou 'p'=script (php) ?
			// -> definira les pre et post-traitements obligatoires
	// champs pour la production de code dependant du contexte
	var $id_mere;    // pour TOTAL_BOUCLE hors du corps
	var $document;   // pour embed et img dans les textes
}


//
// Globales de description de la base

global $tables_des_serveurs_sql, $tables_principales; // (voir inc_serialbase)
global $exceptions_des_tables, $table_des_tables;
global $tables_relations,  $table_primary, $table_date;

$tables_des_serveurs_sql = array('localhost' => &$tables_principales);
	

	// champ principal des tables SQL
	$table_primary = array(
		'articles' => "id_article",
		'auteurs' => "id_auteur",
		'breves' => "id_breve",
		'documents' => "id_document",
		'forums' => "id_forum",
		'groupes_mots' => "id_groupe",
		'hierarchie' => "id_rubrique",
		'mots' => "id_mot",
		'rubriques' => "id_rubrique",
		'signatures' => "id_signature",
		'syndication' => "id_syndic",
		'syndic_articles' => "id_syndic_article",
		'types_documents' => "id_type"
	);
	
	# cf. fonction table_objet dans inc_version
	$table_des_tables = array(
		'articles' => 'articles',
		'auteurs' => 'auteurs',
		'breves' => 'breves',
		'forums' => 'forum',
		'signatures' => 'signatures',
		'documents' => 'documents',
		'types_documents' => 'types_documents',
		'mots' => 'mots',
		'groupes_mots' => 'groupes_mots',
		'rubriques' => 'rubriques',
		'syndication' => 'syndic',
		'syndic_articles' => 'syndic_articles',
		'hierarchie' => 'rubriques'
	);
	
	$exceptions_des_tables = array(
		'breves' => array(
			'id_secteur' => 'id_rubrique',
			'date' => 'date_heure',
			'nom_site' => 'lien_titre',
			'url_site' => 'lien_url'
			),
		'forums' => array(
			'date' => 'date_heure',
			'nom' => 'auteur',
			'email' => 'email_auteur'
			),
		'signatures' => array(
			'date' => 'date_time',
			'nom' => 'nom_email',
			'email' => 'ad_email'
		),
		'documents' => array(
			'type_document' => array('types_documents', 'titre'),
			'extension_document' => array('types_documents', 'extension')
		),
		'syndic_articles' => array(
			'url_article' => 'url',		  # ne sert pas ? cf balise_URL_ARTICLE
			'lesauteurs' => 'lesauteurs', # ne sert pas ? cf balise_LESAUTEURS
			'url_site' => array('syndic', 'url_site'),
			'nom_site' => array('syndic', 'nom_site')
		)
	);
	
	$table_date = array (
		'articles' => 'date',
		'auteurs' =>  'date',
		'breves' =>  'date_heure',
		'forums' =>  'date_heure',
		'signatures' => 'date_time',
		'documents' => 'date',
		'types_documents' => 'date',
		'groupes_mots' => 'date',
		'mots' => 'date',
		'rubriques' => 'date',
		'syndication' => 'date',
		'syndic_articles' => 'date'
	);


//
// tableau des tables de relations,
// Ex: gestion du critere {id_mot} dans la boucle(ARTICLES)
//

$tables_relations = array(
	'articles' => array (
		'id_mot' => 'mots_articles',
		'id_auteur' => 'auteurs_articles',
		'id_document' => 'documents_articles'
		),

	'auteurs' => array (
		'id_article' => 'auteurs_articles'
		),

	'breves' => array (
		'id_mot' => 'mots_breves',
		'id_document' => 'documents_breves'
		),

	'documents' => array (
		'id_article' => 'documents_articles',
		'id_rubrique' => 'documents_rubriques',
		'id_breve' => 'documents_breves'
		),

	'forums' => array (
		'id_mot' => 'mots_forum',
		),

	'mots' => array (
		'id_article' => 'mots_articles',
		'id_breve' => 'mots_breves',
		'id_forum' => 'mots_forum',
		'id_rubrique' => 'mots_rubriques',
		'id_syndic' => 'mots_syndic'
		),

	'groupes_mots' => array (
		'id_groupe' => 'mots'
		),

	'rubriques' => array (
		'id_mot' => 'mots_rubriques',
		'id_document' => 'documents_rubriques'
		),

	'syndication' => array (
		'id_mot' => 'mots_syndic'
		)
	);
?>

--- NEW FILE: formulaire_login-dist.html ---
[(#HTTP_VARS{echec_cookie})
	<h3 class="spip"><:erreur_probleme_cookie:></h3>
		<b><:login_cookie_oblige:></b>
		  <:login_cookie_accepte:><p />
][
(#HTTP_VARS{message})
	<br />
	 <:forum_vous_enregistrer:>
	[<a href='(#URL_SITE_SPIP|inscriptionok{forum})spip_inscription.php3?mode=forum&focus=nom_inscription' target="spip_pass"
onclick="javascript:window.open(this.href, 'spip_inscription', 'scrollbars=yes, resizable=yes, width=480, height=450'); return false;"><:forum_vous_inscrire:></a>]&nbsp;&nbsp;&#91;<a
		href="spip_pass.php3"
		target="spip_pass" 
		onclick="javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=280'); return false;"><:login_motpasseoublie:></a>&#93;<br /><br />
]<div style="font-family: Verdana,arial,helvetica,sans-serif; font-size: 12px;">
	<script type="text/javascript" src="ecrire/md5.js"></script>
	<form	id="login[_(#HTTP_VARS{login})]"
		action="[(#HTTP_VARS{action2})]"
		method="post"[(#HTTP_VARS{source}|choixsiegal{spip,' ',''})
		onSubmit='if (this.session_password.value) {
			this.session_password_md5.value = calcMD5("[(#HTTP_VARS{alea_actuel})]" + this.session_password.value);
			this.next_session_password_md5.value = calcMD5("[(#HTTP_VARS{alea_futur})]" + this.session_password.value);
			this.session_password.value = "";
			}']>
		<div class="spip_encadrer" style="[(#URL_SITE_SPIP|style_align)]">[
			<div class="reponse_formulaire">(#HTTP_VARS*{erreur})<br /><br /></div>
][
			<label><b><:login_login2:></b><br /></label>(#HTTP_VARS{login}|choixsivide{' ',''})
			<input type="text" id='var_login' name="var_login" class="forml" value="" size="40" />
][
<div>
			<input type="hidden" name="session_login_hidden" value="(#HTTP_VARS{login})" />
<script type="text/javascript"><!--
document.write("<:login_login:>&nbsp;<b>[(#HTTP_VARS{login})]<" + "/b><br />&#91;<a href='spip_cookie.php3?cookie_admin=non&amp;url=[(#HTTP_VARS{url})]'><font size='2'><:login_autre_identifiant:><" + "/font><" + "/a>&#93;")
//--></script>
<noscript>
	<font face="Georgia, Garamond, Times, serif" size="3">
		<:login_non_securise:>
		<a href="[(#HTTP_VARS{action})]"><:login_recharger:></a>
	</font>
	<br /><br />
	<label><b><:login_login2:></b><br /></label>
	<input type='text' name='session_login' class='forml' [value="(#HTTP_VARS{login})" ]size='40' />
</noscript>
[<img src="(#HTTP_VARS{id_auteur}|silogoauteur)" width="75" align="right" alt="[(#HTTP_VARS{login})]">]
</div>
<p><br /><br />
		<label><b><:login_pass2:></b></label>&nbsp;<input type="password" name="session_password"[ id="var_login_(#HTTP_VARS{login})]" class="forml" value="" size="40" />
		<br />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox"
			 name="session_remember"
			 id="session[_(#HTTP_VARS{login})]"
			 value="oui"[(#HTTP_VARS*{prefs}|filtre_rester_connecte)checked="checked"]/>
		<label for="session[_(#HTTP_VARS{login})]"><:login_rester_identifie:></label>
</p>
		<input type="hidden" name="session_password_md5" value="" />
		<input type="hidden" name="next_session_password_md5" value="" />
		<input type="hidden" name="essai_login" value="oui" />
]		<input type="hidden" name="url" value="[(#HTTP_VARS{url})]" />
		<div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>" /></div>
		</div>
	</form>
<script type="text/javascript"><!--
document.getElementById('var_login[_(#HTTP_VARS{login})]').focus()
--></script>[
	<form action="(#HTTP_VARS{auth})" method="get">
		<fieldset>
		<p>
		<:login_preferez_refuser:>
		<input type="hidden" name="essai_auth_http" value="oui"/>
		[<input type="hidden" name="url" value="(#HTTP_VARS{url})"/>]
		<div align="right"><input type="submit" class="spip_bouton" value="<:login_sans_cookiie:>"/></div>
		</fieldset>
	</form>
]
</div>

--- NEW FILE: backend.php3 ---
<?php
$fond = "backend";
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
// Et les headers !!!!

$flag_preserver = true;

@header("Content-type: text/xml");

include ("inc-public.php3");

?>

--- NEW FILE: login-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
	<title><:login_acces_prive:></title>
	<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
	<link rel="stylesheet" href="spip_style.css" type="text/css">
</head>
<body dir="#LANG_DIR" bgcolor="#ffffff" text="#000000" link="#e86519" vlink="#6e003a" alink="#ff9900">

<br><br><br><center><table width="400"><tr><td width="400">
<div align="center">
<h3 class="spip">#NOM_SITE_SPIP<br>
<small><:login_acces_prive:></small></h3>
<div align="#LANG_RIGHT">#MENU_LANG_ECRIRE</div>
</div>
#LOGIN_PRIVE
	<div align="center">[&#91;<a
		target="spip_pass"
		href='(#URL_SITE_SPIP|inscriptionok{redac})/spip_inscription.php3?mode=redac&focus=nom_inscription'
		onclick="javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=500'); return false;"><:login_sinscrire:></a>&#93;]&#91;<a
		href="spip_pass.php3"
		target="spip_pass" 
		onclick="javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=280'); return false;"><:login_motpasseoublie:></a>&#93;&#91;<a 
		href='#URL_SITE_SPIP'><:login_retoursitepublic:></a>&#93
	      </div>

</td></tr></table></center>

</body>
</html>

--- NEW FILE: inc-calcul.php3 ---
<?php


// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CALCUL")) return;
define("_INC_CALCUL", "1");

//
// Ce fichier calcule une page en executant un squelette.
//

include_ecrire("inc_meta.php3");
include_ecrire("inc_index.php3");
include_ecrire("inc_texte.php3");
include_ecrire("inc_filtres.php3");
include_ecrire("inc_lang.php3");
include_ecrire("inc_documents.php3");
include_ecrire("inc_abstract_sql.php3");
include_ecrire("inc_forum.php3");
include_ecrire("inc_debug_sql.php3");
include_local("inc-calcul-outils.php3");

// Ce fichier peut contenir une affectation de $dossier_squelettes  indiquant
// le repertoire du source des squelettes (les pseudo-html avec BOUCLE...)

if (@file_exists("mes_fonctions.php3")) 
    include_local ("mes_fonctions.php3");


// Gestionnaire d'URLs
if (@file_exists("inc-urls.php3"))
	include_local("inc-urls.php3");
else
	include_local("inc-urls-".$GLOBALS['type_urls'].".php3");


// Le squelette compile est-il trop vieux ?
function squelette_obsolete($skel, $squelette) {
	return (
		$GLOBALS['var_mode']
		OR !@file_exists($skel)
		OR (@filemtime($squelette) > ($date = @filemtime($skel)))
		OR (@filemtime('mes_fonctions.php3') > $date)
		OR (@filemtime(_FILE_OPTIONS) > $date)
	);
}


# Charge un squelette (au besoin le compile) 
# et retoune le nom de sa fonction principale, ou '' s'il est indefini
# Charge egalement un fichier homonyme de celui du squelette
# mais de suffixe '_fonctions.php3' pouvant contenir:
# - des filtres
# - des fonctions de traduction de balise, de critere et de boucle
# - des declaration de tables SQL supplementaires

function charger_squelette ($squelette) {
	$ext = $GLOBALS['extension_squelette'];
	$nom = $ext . '_' . md5($squelette);
	$sourcefile = $squelette . ".$ext";

	// le squelette est-il deja en memoire (INCLURE  a repetition)
	if (function_exists($nom))
		return $nom;

	$phpfile = _DIR_CACHE . 'skel_' . $nom . '.php';

	// le squelette est-il deja compile et perenne ?
	if (!squelette_obsolete($phpfile, $sourcefile)
	AND lire_fichier ($phpfile, $contenu,
	array('critique' => 'oui', 'phpcheck' => 'oui'))) 
		eval('?'.'>'.$contenu);

	// sinon, charger le compilateur et verifier que le source est lisible
	if (!function_exists($nom)) {
		include_local("inc-compilo.php3");
		lire_fichier ($sourcefile, $skel);
	}

	// Le fichier suivant peut contenir entre autres:
	// 1. les filtres utilises par le squelette
	// 2. des ajouts au compilateur
	// Le point 1 exige qu'il soit lu dans tous les cas.
	// Le point 2 exige qu'il soit lu apres inc-compilo
	// (car celui-ci initialise $tables_principales) mais avant la compil
	$f = $squelette . '_fonctions.php3';
	if (@file_exists($f)) include($f);

	if (function_exists($nom)) return $nom;

	$skel_code = calculer_squelette($skel, $nom, $ext, $sourcefile);

	// Tester si le compilateur renvoie une erreur
	if (is_array($skel_code))
		erreur_squelette($skel_code[0], $skel_code[1]);
	else {
		if ($GLOBALS['var_mode'] == 'debug') {
			include_ecrire("inc_debug_sql.php3");
			debug_dumpfile ($skel_code, $nom, 'code');
		}
		eval('?'.'>'.$skel_code);
		if (function_exists($nom)) {
			ecrire_fichier ($phpfile, $skel_code);
			return $nom;
		}
	}
}

# Provoque la recherche du squelette $fond d'une $lang donnee,
# et l'applique sur un $contexte pour un certain $cache.
# Retourne un tableau de 3 elements:
# 'texte' => la page calculee
# 'process_ins' => 'html' ou 'php' si presence d'un '< ?php'
# 'invalideurs' => les invalideurs (cf inc-calcul-squel)

# En cas d'erreur process_ins est absent et texte est un tableau de 2 chaines

# La recherche est assuree par la fonction chercher_squelette,
# definie dans inc-chercher, fichier non charge si elle est deja definie
# (typiquement dans mes_fonctions.php3)

function cherche_page ($cache, $contexte, $fond)  {
	global $dossier_squelettes, $delais;

	if (!function_exists('chercher_squelette'))
		include_local("inc-chercher.php3"); # a renommer ?

	// Choisir entre $fond-dist.html, $fond=7.html, etc?
	$id_rubrique_fond = 0;
	// Si inc-urls veut fixer la langue, on la recupere ici
	$lang = $contexte['lang'];
	// Chercher le fond qui va servir de squelette
	if ($r = sql_rubrique_fond($contexte,
	$lang ? $lang : lire_meta('langue_site')))
		list($id_rubrique_fond, $lang) = $r;

	if (!$GLOBALS['forcer_lang'])
		lang_select($lang);

	$skel = chercher_squelette($fond,
			$id_rubrique_fond,
			$dossier_squelettes ? "$dossier_squelettes/" :'',
			$GLOBALS['spip_lang']);

	// Charger le squelette et recuperer sa fonction principale
	// (compilation automatique au besoin) et calculer

	$page = array();

	if ($skel) {
		if ($fonc = charger_squelette($skel))
		  $page = $fonc(array('cache' => $cache), array($contexte));

		// Passer la main au debuggueur)
		if ($GLOBALS['var_mode'] == 'debug')
		  {
			include_ecrire("inc_debug_sql.php3");
			debug_dumpfile ($page['texte'], $fonc, 'resultat');
		  }
	}

	// Nettoyer le resultat si on est fou de XML
	if ($GLOBALS['xhtml']) {
		include_ecrire("inc_tidy.php");
		$page['texte'] = xhtml($page['texte']);
	}

	// Entrer les invalideurs dans la base
	if ($delais>0) {
		include_ecrire('inc_invalideur.php3');
		maj_invalideurs($cache, $page['invalideurs'], $delais);
	}

	// Retourner la structure de la page

	return $page;
}


//
// Contexte : lors du calcul d'une page spip etablit le contexte a partir
// des variables $HTTP_GET_VARS et $HTTP_POST_VARS, et leur ajoute la date
// Note : pour hacker le contexte depuis le fichier d'appel (article.php3),
// il est recommande de modifier $HTTP_GET_VARS['toto'] (meme si la page est
// appelee avec la methode POST).
//
function calculer_contexte() {
	foreach($GLOBALS['HTTP_GET_VARS'] as $var => $val) {
		if (strpos($var, 'var_') !== 0)
			$contexte[$var] = $val;
	}
	foreach($GLOBALS['HTTP_POST_VARS'] as $var => $val) {
		if (strpos($var, 'var_') !== 0)
			$contexte[$var] = $val;
	}

	if ($GLOBALS['date'])
		$contexte['date'] = $contexte['date_redac'] = normaliser_date($GLOBALS['date']);
	else
		$contexte['date'] = $contexte['date_redac'] = date("Y-m-d H:i:s");

	return $contexte;
}

function calculer_page_globale($cache, $contexte_local, $fond) {

	// Gestion des URLs personnalises - sale mais historique
	if (function_exists("recuperer_parametres_url")) {
		global $contexte;
		$contexte = $contexte_local;
		recuperer_parametres_url($fond, nettoyer_uri());

		// remettre les globales pour le bouton "Modifier cet article"
		if (is_array($contexte))
			foreach ($contexte as $var=>$val)
				if (substr($var,0,3) == 'id_')
					$GLOBALS[$var] = $val;
		$contexte_local = $contexte;
	}

	// Go to work !
	$page = cherche_page($cache, $contexte_local, $fond);

	$signal = array();
	foreach(array('id_parent', 'id_rubrique', 'id_article', 'id_auteur',
	'id_breve', 'id_forum', 'id_secteur', 'id_syndic', 'id_syndic_article',
	'id_mot', 'id_groupe', 'id_document') as $val) {
		if ($contexte_local[$val])
			$signal['contexte'][$val] = intval($contexte_local[$val]);
	}

	$page['signal'] = $signal;

	return $page;
}


// Cf ramener_page +cherche_page_incluante+ cherche_page_incluse chez ESJ
function calculer_page($chemin_cache, $elements, $delais, $inclusion=false) {

	// Inclusion
	if ($inclusion) {
		$contexte_inclus = $elements['contexte'];
		$page = cherche_page($chemin_cache,
			$contexte_inclus, $elements['fond']);
	}
	else {

		// Page globale
		// si le champ chapo commence par '=' c'est une redirection.
		if ($id_article = intval($GLOBALS['id_article'])) {
			if ($art = sql_chapo($id_article)) {
				$chapo = $art['chapo'];
				if (substr($chapo, 0, 1) == '=') {
					include_ecrire('inc_texte.php3');
					list(,$url) = extraire_lien(array('','','',
					substr($chapo, 1)));
					if ($url) { // sinon les navigateurs pataugent
						$url = addslashes($url);
						$page = array('texte' => "<".
						"?php header(\"Location: $url\"); ?" . ">",
						'process_ins' => 'php');
					}
				}
			}
		}
		if (!$page)
			$page = calculer_page_globale($chemin_cache,
				$elements['contexte'],
				$elements['fond']);
	}

	$page['signal']['process_ins'] = $page['process_ins'];
	$signal = "<!-- ".str_replace("\n", " ",
	serialize($page['signal']))." -->\n";

	// Enregistrer le fichier cache
	if ($delais > 0 AND $GLOBALS['var_mode'] != 'debug'
	AND empty($GLOBALS['HTTP_POST_VARS']))
		ecrire_fichier($chemin_cache, $signal.$page['texte']);

	return $page;
}
?>

--- NEW FILE: inc-public-global.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_PUBLIC_GLOBAL")) return;
define("_INC_PUBLIC_GLOBAL", "1");

//
// Aller chercher la page dans le cache ou pas
//
function obtenir_page ($contexte, $chemin_cache, $delais, &$use_cache, $fond, $inclusion=false) {
	global $lastmodified;

	if (!$use_cache) {
		include_local('inc-calcul.php3');

		// page globale ? calculer le contexte
		if (!$contexte)
			$contexte = calculer_contexte();

		spip_timer('calculer_page');
		$page = calculer_page($chemin_cache,
			array('fond' => $fond,
				'contexte' => $contexte),
			$delais,
			$inclusion);

		$lastmodified = time();

		// log
		if (!$log = $chemin_cache) $log = "($fond, delais=$delais, "
		. $GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'].")";
		spip_log (($inclusion ? 'calcul inclus':'calcul').' ('
		.spip_timer('calculer_page')."): $log");

		// Nouveau cache : creer un invalideur 't' fixant la date
		// d'expiration et la taille du fichier
		if (@file_exists($chemin_cache)) {
			// Ici on ajoute 3600s pour eviter toute concurrence
			// entre un invalideur et un appel public de page
			$bedtime = time() + $delais + 3600;
			$taille = @filesize($chemin_cache);
			$fichier = addslashes($chemin_cache);
			spip_query("INSERT IGNORE INTO spip_caches (fichier,id,type,taille)
			VALUES ('$fichier','$bedtime','t','$taille')");
		}

	} else {

		//
		// Lire le fichier cache
		//
		lire_fichier ($chemin_cache, $page['texte']);
		$lastmodified = max($lastmodified, @filemtime($chemin_cache));
		# spip_log ("cache $chemin_cache $lastmodified");

		//
		// Lire sa carte d'identite & fixer le contexte global
		//
		if (preg_match("/^<!-- ([^\n]*) -->\n(.*)/ms", $page['texte'], $match)
		AND is_array($meta_donnees = unserialize($match[1]))) {
			foreach ($meta_donnees as $var=>$val)
				$page[$var] = $val;

			$page['texte'] = $match[2];

			// Remplir les globals pour les boutons d'admin
			if (!$inclusion AND is_array($page['contexte']))
				foreach ($page['contexte'] as $var=>$val)
					$GLOBALS[$var] = $val;
		}

	}

	return $page;
}


//
// Appeler cette fonction pour obtenir la page principale
//
function afficher_page_globale ($fond, $delais, &$use_cache) {
	global $flag_preserver, $flag_dynamique, $lastmodified;
	global $var_preview, $var_mode;
	include_local ("inc-cache.php3");

	// demande de previsualisation ?
	// -> inc-calcul.php3 n'enregistrera pas les fichiers caches
	// -> inc-reqsql-squel.php3 acceptera les objets non 'publie'
	if ($var_preview == 'oui') {
		// Verifier qu'on a le droit de previsualisation
		$statut = $GLOBALS['auteur_session']['statut'];
		if ($statut=='0minirezo' OR
		(lire_meta('preview')=='1comite' AND $statut=='1comite')) {
			$var_mode = 'recalcul';
			$delais = 0;
			$var_preview = true;
			spip_log('preview !');
		}
	}

	// Faut-il effacer des pages invalidees ?
	if (lire_meta('invalider')) {
		include_ecrire('inc_meta.php3');
		lire_metas();
		if (lire_meta('invalider'))
			retire_caches();
	}

	// Calculer le chemin putatif du cache
	$chemin_cache = generer_nom_fichier_cache('', $fond);

	// Peut-on utiliser un fichier cache ?
	determiner_cache($delais, $use_cache, $chemin_cache);

	// Repondre gentiment aux requetes sympas
	// (ici on ne tient pas compte d'une obsolence du cache ou des
	// eventuels fichiers inclus modifies depuis la date
	// HTTP_IF_MODIFIED_SINCE du client)
	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE'] AND !$var_mode
	AND $chemin_cache AND !$flag_dynamique) {
		$lastmodified = @filemtime($chemin_cache);
		$headers_only = http_last_modified($lastmodified);
	}
	$headers_only |= ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] == 'HEAD');

	if ($headers_only) {
		if ($chemin_cache)
			$t = @filemtime($chemin_cache);
		else
			$t = time();
		@header('Last-Modified: '.http_gmoddate($t).' GMT');
		@header('Connection: close');
		// Pas de bouton admin pour un HEAD
		$flag_preserver = true;
	}
	else {
		// Obtenir la page
		$page = obtenir_page ('', $chemin_cache, $delais, $use_cache,
		$fond, false);
		if (!$flag_preserver) {
		// Entete content-type: xml ou html ; charset
			if ($xhtml) {
			// Si Mozilla et tidy actif, passer en "application/xhtml+xml"
			// extremement risque: Mozilla passe en mode debugueur strict
			// mais permet d'afficher du MathML directement dans le texte
			// (et sauf erreur, c'est la bonne facon de declarer du xhtml)
				include_ecrire("inc_tidy.php");
				if (version_tidy() > 0) {
					if (ereg("application/xhtml\+xml", $GLOBALS['HTTP_ACCEPT'])) 
						@header("Content-Type: application/xhtml+xml; charset=".lire_meta('charset'));
					else 
						@header("Content-Type: text/html; charset=".lire_meta('charset'));
					echo '<'.'?xml version="1.0" encoding="'. lire_meta('charset').'"?'.">\n";
				} else {
					@header("Content-Type: text/html; charset=".lire_meta('charset'));
				}
			} else {
				@header("Content-Type: text/html; charset=".lire_meta('charset'));
			}
		}
	}

	if ($chemin_cache) $page['cache'] = $chemin_cache;

	if ($var_preview AND !$flag_preserver) {
		$url = $GLOBALS['clean_link'];
		$url->delvar('var_preview');
		$url = $url->geturl();
		include_ecrire('inc_lang.php3');
		lang_select($GLOBALS['auteur_session']['lang']);
		$page['texte'] .= '<div style="
		display: block;
		color: #eeeeee;
		background-color: #111111;
		padding-right: 5px;
		padding-top: 2px;
		padding-bottom: 5px;
		font-size: 20px;
		top: 0px;
		left: 0px;
		position: absolute;
		"><a href="'.$url.'"><img src="' . _DIR_IMG_PACK . 'naviguer-site.png" align="left" border="0" /></a>
&nbsp; '.majuscules(_T('previsualisation')).'</div>';
	}

	return $page;
}


function terminer_public_global() {

	// Mise a jour des fichiers langues de l'espace public
	if ($GLOBALS['cache_lang_modifs']) {
		include_ecrire('inc_lang.php3');
		ecrire_caches_langues();
	}

	// Gestion des statistiques du site public

	if (lire_meta("activer_statistiques") != "non") {
		include_local ("inc-stats.php3");
		ecrire_stats();
	}

	// Effectuer une tache de fond ?
	cron();
}

// Cette fonction sert au dernier ob_start() de inc-public : elle
// va absorber les eventuels messages d'erreur de inc_cron(), permettant
// de ne pas planter le content-length qu'on a annonce ; decommenter la ligne
// pour afficher les bugs
function masquer_les_bugs ($bugs) {
	# return $bugs;
}

function inclure_page($fond, $delais_inclus, $contexte_inclus, $cache_incluant='') {

	$contexte_inclus['fond'] = $fond;

	$chemin_cache = generer_nom_fichier_cache($contexte_inclus, $fond);

	// Peut-on utiliser un fichier cache ?
	determiner_cache($delais_inclus, $use_cache, $chemin_cache);

	// Si on a inclus sans fixer le critere de lang, de deux choses l'une :
	// - on est dans la langue du site, et pas besoin d'inclure inc_lang
	// - on n'y est pas, et alors il faut revenir dans la langue par defaut
	if (($lang = $contexte_inclus['lang'])
	|| ($GLOBALS['spip_lang'] != ($lang = lire_meta('langue_site')))) {
		include_ecrire('inc_lang.php3');
		lang_select($lang);
		$lang_select = true; // pour lang_dselect en sortie
	}

	$page = obtenir_page ($contexte_inclus, $chemin_cache, $delais_inclus,
	$use_cache, $fond, true);

	$page['lang_select'] = $lang_select;

	// Retourner le contenu...
	return $page;
}

function inclure_balise_dynamique($r) {
	if (is_string($r))
		echo $r;
	else {
		list($fond, $delais, $contexte_inclus) = $r;
		if ((!$contexte_inclus['lang']) AND
		($GLOBALS['spip_lang'] != lire_meta('langue_site')))
			$contexte_inclus['lang'] = $GLOBALS['spip_lang']; 
		include('inc-public.php3');
	}
}
?>

--- NEW FILE: inc-formulaire_forum.php3 ---
<?php

include_ecrire('inc_meta.php3');
include_ecrire('inc_admin.php3');
include_ecrire('inc_acces.php3');
include_ecrire('inc_texte.php3');
include_ecrire('inc_filtres.php3');
include_ecrire('inc_lang.php3');
include_ecrire('inc_mail.php3');
include_ecrire('inc_forum.php3');
include_ecrire("inc_abstract_sql.php3");
include_local(_FILE_CONNECT);

// Gestionnaire d'URLs
if (@file_exists("inc-urls.php3"))
	include_local("inc-urls.php3");
else
	include_local("inc-urls-".$GLOBALS['type_urls'].".php3");

/*******************************/
/* GESTION DU FORMULAIRE FORUM */
/*******************************/
global $balise_FORMULAIRE_FORUM_collecte;
$balise_FORMULAIRE_FORUM_collecte = array('id_rubrique', 'id_forum', 'id_article', 'id_breve', 'id_syndic');

function balise_FORMULAIRE_FORUM_stat($args, $filtres)
{
  list ($idr, $idf, $ida, $idb, $ids) = $args;

  // recuperer les donnees du forum auquel on repond, false = forum interdit
  if (!$r = sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids))
    return '';
  list($titre, $table, $forums_publics) = $r;
  return 
    array($titre, $table, $forums_publics, $idr, $idf, $ida, $idb, $ids);
}

function balise_FORMULAIRE_FORUM_dyn($titre, $table, $forums_publics, $id_rubrique, $id_forum, $id_article, $id_breve, $id_syndic) {

	global $REMOTE_ADDR, $id_message, $afficher_texte, $spip_forum_user;

	// url de reference
	if (!$url = rawurldecode($GLOBALS['url'])) 
	    $url = $GLOBALS['REQUEST_URI'];
	else {
	// identifiants des parents
	  $args = '';  
	  if ($id_rubrique) $args .= "id_rubrique=$id_rubrique";
	  if ($id_forum) $args .= "id_forum=$id_forum";
	  if ($id_article) $args .= "id_article=$id_article";
	  if ($id_breve) $args .= "id_breve=$id_breve";
	  if ($id_syndic) $args .= "id_syndic=$id_syndic";
	  if ($args && strpos($url,$args)===false) $url .= (strpos($url,'?') ? '&' : '?') . $args;
	}
	$url = ereg_replace("[?&]var_erreur=[^&]*", '', $url);
	$url = ereg_replace("[?&]var_login=[^&]*", '', $url);
	$url = ereg_replace("[?&]url=[^&]*", '', $url);

	// verifier l'identite des posteurs pour les forums sur abo
	if (($forums_publics == "abo") && (!$GLOBALS["auteur_session"]))
	  {
	    include_local('inc-login_public.php3');
	    return login_pour_tous($GLOBALS['var_login'], $url, true, $url, 'forum');
	  }
	// au premier appel (pas de http-var nommee "retour")
	// memoriser l'URL courante pour y revenir apres envoi du message
	// aux appels suivants, reconduire la valeur.
	if ($retour = rawurldecode($GLOBALS['HTTP_GET_VARS']['retour']))
	  $retour = ereg_replace('&var_mode=recalcul','',$retour);
	else {
	  if (!$retour = rawurldecode($GLOBALS['HTTP_POST_VARS']['retour']))
	    $retour = $url;
	}

	// ne pas mettre '', sinon le squelette n'affichera rien.

	$previsu = ' ';

	// Recuperer le message a previsualiser
	if ($id_message = intval($GLOBALS['HTTP_POST_VARS']['id_message']))  {
		$titre = $GLOBALS['HTTP_POST_VARS']['titre'];
		$texte = $GLOBALS['HTTP_POST_VARS']['texte'];
		$auteur = $GLOBALS['HTTP_POST_VARS']['auteur'];
		$email_auteur = $GLOBALS['HTTP_POST_VARS']['email_auteur'];
		$nom_site_forum = $GLOBALS['HTTP_POST_VARS']['nom_site_forum'];
		$url_site = $GLOBALS['HTTP_POST_VARS']['url_site'];

		if ($afficher_texte != 'non') {
			$previsu = 
			  "<div style='font-size: 120%; font-weight: bold;'>"
			  . interdire_scripts(typo($titre))
			  . "</div><p /><b><a href=\"mailto:"
			  . interdire_scripts(typo($email_auteur)) . "\">"
			  . interdire_scripts(typo($auteur)) . "</a></b><p />"
			  . propre($texte) . "<p /><a href=\""
			  . interdire_scripts($url_site) . "\">"
			  . interdire_scripts(typo($nom_site_forum)) . "</a>";

			// Verifier mots associes au message
			$result_mots = spip_query("SELECT mots.id_mot, mots.titre, mots.type
			FROM spip_mots_forum AS lien, spip_mots AS mots 
			WHERE id_forum='$id_message' AND mots.id_mot = lien.id_mot
			GROUP BY mots.id_mot");
			if (spip_num_rows($result_mots)>0) {
				$previsu .= "<p>"._T('forum_avez_selectionne')."</p><ul>";
				while ($row = spip_fetch_array($result_mots)) {
					$les_mots[$row['id_mot']] = "checked='checked'";
					$presence_mots = true;
					$previsu .= "<li class='font-size=80%'> "
					. typo($row['type']) . "&nbsp;: <b>"
					. typo($row['titre']) ."</b></li>";
				}
				$previsu .= '</ul>';
			}

			if (strlen($texte) < 10 AND !$presence_mots) {
				$previsu .= "<p align='right' style='color: red;'>"._T('forum_attention_dix_caracteres')."</p>\n";
			}
			else if (strlen($titre) < 3 AND $afficher_texte <> "non") {
				$previsu .= "<p align='right' style='color: red;'>"._T('forum_attention_trois_caracteres')."</p>";
			}
			else {
				$previsu .= "<div align='right'><input type='submit' name='confirmer' class='spip_bouton' value='"._T('forum_message_definitif')."' /></div>";
			}
			$previsu = "<div class='spip_encadrer'>$previsu</div>\n<br />";
			// supprimer les <form> de la previsualisation
			// (sinon on ne peut pas faire <cadre>...</cadre> dans les forums)
			$previsu = preg_replace("@<(/?)f(orm[>[:space:]])@ism", "<\\1no-f\\2", $previsu);
		}
	} else {
		// Premiere edition, initialiser l'auteur
	  	// puis s'accorder une nouvelle entree dans la table
		if ($spip_forum_user && is_array($cookie_user = unserialize($spip_forum_user))) {
			$auteur = $cookie_user['nom'];
			$email_auteur = $cookie_user['email'];
		}
		else {
			$auteur = $GLOBALS['auteur_session']['nom'];
			$email_auteur = $GLOBALS['auteur_session']['email'];
		}
		$id_message = spip_abstract_insert('forum', 
					  "(date_heure, titre, ip, statut)",
					  "(NOW(), '".addslashes($titre)."', '$REMOTE_ADDR', 'redac')");

	}

	// Generation d'une valeur de securite pour validation
	$seed = (double) (microtime() + 1) * time() * 1000000;
	@mt_srand($seed);
	$alea = @mt_rand();
	if (!$alea) {srand($seed);$alea = rand();}
	$forum_id_rubrique = intval($id_rubrique);
	$forum_id_forum = intval($id_forum);
	$forum_id_article = intval($id_article);
	$forum_id_breve = intval($id_breve);
	$forum_id_syndic = intval($id_syndic);
	$hash = calculer_action_auteur("ajout_forum $forum_id_rubrique $forum_id_forum $forum_id_article $forum_id_breve $forum_id_syndic $alea");

	// Faut-il ajouter des propositions de mots-cles
	if ((lire_meta("mots_cles_forums") == "oui") && ($table != 'forum'))
		$table = table_des_mots($table, $les_mots);
	else
		$table = '';

	return array(
		     'formulaire_forum',
		     0,
		     array(
		     'afficher_non' => 
		     ($afficher_texte != 'non' ? '' :
		      (boutonne('hidden', 'titre', htmlspecialchars($titre)) .
		       $table .
		       "\n<br /><div align='right'>" .
		       boutonne('submit', '', _T('forum_valider'), "class='spip_bouton'") .
		       "</div>")), 
		     'alea' => $alea,
		     'auteur' => $auteur,
		     'disabled' => ($forums_publics == "abo")? " disabled='disabled'" : '',
		     'email_auteur' => $email_auteur,
		     'hash' => $hash,
		     'id_message' => $id_message,
		     'modere' => (($forums_publics != 'pri') ? '' :
				  _T('forum_info_modere')),
		     'nom_site_forum' => $nom_site_forum,
		     'previsu' => $previsu,
		     'retour' => $retour,
		     'table' => $table,
		     'texte' => $texte,
		     'titre' => $titre,
		     'url' =>  $url,
		     'url_site' => ($url_site ? $url_site : "http://")
		     ));
}


function barre_forum($texte)
{
	include_ecrire('inc_layer.php3');

	if (!$GLOBALS['browser_barre'])
		return "<textarea name='texte' rows='12' class='forml' cols='40'>$texte</textarea>";
	static $num_formulaire = 0;
	$num_formulaire++;
	include_ecrire('inc_barre.php3');
	return afficher_barre("document.getElementById('formulaire_$num_formulaire')", true) .
	  "
<textarea name='texte' rows='12' class='forml' cols='40'
id='formulaire_$num_formulaire'
onselect='storeCaret(this);'
onclick='storeCaret(this);'
onkeyup='storeCaret(this);'
ondbclick='storeCaret(this);'>$texte</textarea>";
}

// Mots-cles dans les forums :
// Si la variable de personnalisation $afficher_groupe[] est definie
// dans le fichier d'appel, et si la table de reference est OK, proposer
// la liste des mots-cles
function table_des_mots($table, $les_mots) {
	global $afficher_groupe;

	if ($afficher_groupe)
		$in_group = " AND id_groupe IN (" . join($afficher_groupe, ", ") .")";

	$result_groupe = spip_query("SELECT * FROM spip_groupes_mots
	WHERE 6forum = 'oui' AND $table = 'oui'". $in_group);

	$ret = '';
	while ($row_groupe = spip_fetch_array($result_groupe)) {
		$id_groupe = $row_groupe['id_groupe'];
		$titre_groupe = propre($row_groupe['titre']);
		$unseul = ($row_groupe['unseul']== 'oui') ? 'radio' : 'checkbox';
		$result =spip_query("SELECT * FROM spip_mots
		WHERE id_groupe='$id_groupe'");
		$total_rows = spip_num_rows($result);

		if ($total_rows > 0) {
			$ret .= "\n<p />";
			$ret .= "<div class='spip_encadrer' style='font-size: 80%;'>";
			$ret.= "<b>$titre_groupe&nbsp;:</b>";
			$ret .= "<table cellpadding='0' cellspacing='0' border='0' width='100%'>\n";
			$ret .= "<tr><td width='47%' valign='top'>";
			$i = 0;
      
		while ($row = spip_fetch_array($result)) {
			$id_mot = $row['id_mot'];
			$titre_mot = propre($row['titre']);
			$descriptif_mot = propre($row['descriptif']);

			if ($i >= ($total_rows/2) AND $i < $total_rows) {
				$i = $total_rows + 1;
				$ret .= "</td><td width='6%'>&nbsp;</td>
				<td width='47%' valign='top'>";
			}

			$ret .= boutonne($unseul, "ajouter_mot[$id_groupe][]", $id_mot, "id='mot$id_mot' " . $les_mots[$id_mot]) .
			  afficher_petits_logos_mots($id_mot)
			. "<b><label for='mot$id_mot'>$titre_mot</label></b><br />";

			if ($descriptif_mot)
				$ret .= "$descriptif_mot<br />";
			$i++;
		}

		$ret .= "</td></tr></table>";
		$ret .= "</div>";
		}
	}

	return $ret;
}


function afficher_petits_logos_mots($id_mot) {
	include_ecrire('inc_logos.php3');
	$on = cherche_image_nommee("moton$id_mot");
	if ($on) {
	  $image = ("$on[0]$on[1].$on[2]");
		$taille = @getimagesize($image);
		$largeur = $taille[0];
		$hauteur = $taille[1];
		if ($largeur < 100 AND $hauteur < 100)
			return "<img src='$image' align='middle' width='$largeur'
			height='$hauteur' hspace='1' vspace='1' alt=' ' border='0'
			class='spip_image' /> ";
	}
}

/*******************************************************/
/* FONCTIONS DE CALCUL DES DONNEES DU FORMULAIRE FORUM */
/*******************************************************/

//
// Chercher le titre et la configuration du forum de l'element auquel on repond
//

function sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids) {

	// changer la table de reference s'il y a lieu (pour afficher_groupes[] !!)
	if ($idr) {
		$r = "SELECT titre FROM spip_rubriques WHERE id_rubrique = $idr";
		$table = "rubriques";
	} else if ($ida) {
		$r = "SELECT titre FROM spip_articles WHERE id_article = $ida";
		$table = "articles";
	} else if ($idb) {
		$r = "SELECT titre FROM spip_breves WHERE id_breve = $idb";
		$table = "breves";
	} else if ($ids) {
		$r = "SELECT nom_site AS titre FROM spip_syndic WHERE id_syndic = $ids";
		$table = "syndic";
	}

	if ($idf)
		$r = "SELECT titre FROM spip_forum WHERE id_forum = $idf";

	if ($r) {
		list($titre) = spip_fetch_array(spip_query($r));
		$titre = '> ' . supprimer_numero($titre);
	} else {
		$titre = _T('forum_titre_erreur');
		$table = '';
	}

	// quelle est la configuration du forum ?
	if ($ida)
		list($accepter_forum) = spip_fetch_array(spip_query(
		"SELECT accepter_forum FROM spip_articles WHERE id_article=$ida"));
	else
		$accepter_forum = substr(lire_meta("forums_publics"),0,3);
	// valeurs possibles : 'pos'teriori, 'pri'ori, 'abo'nnement
	if ($accepter_forum == "non")
		return false;

	return array ($titre, $table, $accepter_forum);
}

?>

--- NEW FILE: inc-urls-propres.php3 ---
<?php

// executer une seule fois
if (defined("_INC_URLS2")) return;
define("_INC_URLS2", "1");


/*

- Comment utiliser ce jeu d'URLs ?

Il faut recopier le fichier htaccess-propre.txt sous le nom .htaccess
dans le repertoire de base du site SPIP (attention a ne pas ecraser
d'autres reglages que vous pourriez avoir mis dans ce fichier)

*/


function _generer_url_propre($type, $id_objet) {
	$table = "spip_".$type."s";
	$col_id = "id_".$type;

	// D'abord, essayer de recuperer l'URL existante si possible
	$query = "SELECT url_propre, titre FROM $table WHERE $col_id=$id_objet";
	$result = spip_query($query);
	if (!($row = spip_fetch_array($result))) return "";
	if ($row['url_propre']) return $row['url_propre'];

	// Sinon, creer l'URL
	include_ecrire("inc_filtres.php3");
	include_ecrire("inc_charsets.php3");
	$url = translitteration(corriger_caracteres(supprimer_tags(supprimer_numero($row['titre']))));
	$url = @preg_replace(',[[:punct:][:space:]]+,u', ' ', $url);
	// S'il reste des caracteres non latins, utiliser l'id a la place
	if (preg_match(",[^a-zA-Z0-9 ],", $url)) {
		$url = $type.$id_objet;
	}
	else {
		$mots = explode(' ', $url);
		$url = '';
		foreach ($mots as $mot) {
			if (!$mot) continue;
			$url2 = $url.'-'.$mot;
			if (strlen($url2) > 35) {
				break;
			}
			$url = $url2;
		}
		$url = substr($url, 1);
		//echo "$url<br>";
		if (strlen($url) < 2) $url = $type.$id_objet;
	}

	// Verifier les eventuels doublons et mettre a jour
	$lock = "url $type $id_objet";
	spip_get_lock($lock, 10);
	$query = "SELECT $col_id FROM $table WHERE url_propre='".addslashes($url)."'";
	if (spip_num_rows(spip_query($query)) > 0) {
		$url = $url.','.$id_objet;
	}
	$query = "UPDATE $table SET url_propre='".addslashes($url)."' WHERE $col_id=$id_objet";
	spip_query($query);
	spip_release_lock($lock);

	return $url;
}

function generer_url_article($id_article) {
	$url = _generer_url_propre('article', $id_article);
	if (!$url) $url = "article.php3?id_article=$id_article";
	return $url;
}

function generer_url_rubrique($id_rubrique) {
	$url = _generer_url_propre('rubrique', $id_rubrique);
	if (!$url) $url = "rubrique.php3?id_rubrique=$id_rubrique";
	else $url = '-'.$url.'-';
	return $url;
}

function generer_url_breve($id_breve) {
	$url = _generer_url_propre('breve', $id_breve);
	if (!$url) $url = "breve.php3?id_breve=$id_breve";
	else $url = '+'.$url.'+';
	return $url;
}

function generer_url_forum($id_forum) {
	return "forum.php3?id_forum=$id_forum";
}

function generer_url_mot($id_mot) {
	$url = _generer_url_propre('mot', $id_mot);
	if (!$url) $url = "mot.php3?id_mot=$id_mot";
	else $url = '+-'.$url.'-+';
	return $url;
}

function generer_url_auteur($id_auteur) {
	return "auteur.php3?id_auteur=$id_auteur";
}

function generer_url_document($id_document) {
	if (intval($id_document) <= 0)
		return '';
	if ((lire_meta("creer_htaccess")) == 'oui')
		return "spip_acces_doc.php3?id_document=$id_document";
	if ($row = @spip_fetch_array(spip_query("SELECT fichier FROM spip_documents WHERE id_document = $id_document")))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;

	// Migration depuis anciennes URLs ?
	if ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] != 'POST' &&
		preg_match(',(^|/)(article|breve|rubrique|mot)\.php3?([\?&].*)?$,', $url, $regs)) {
		$type = $regs[2];
		$id_objet = intval($GLOBALS['id_'.$type]);
		if ($id_objet) {
			$func = "generer_url_$type";
			$url_propre = $func($id_objet);
			if ($url_propre) {
				http_status(301);
				Header("Location: $url_propre");
				exit;
			}
		}
		return;
	}

	$url_propre = $GLOBALS['HTTP_SERVER_VARS']['REDIRECT_url_propre'];
	if (!$url_propre) $url_propre = $GLOBALS['HTTP_ENV_VARS']['url_propre'];
	if (!$url_propre) $url_propre = substr($url, strrpos($url, '/') + 1);
	if (!$url_propre) return;

	// Detecter les differents types d'objets demandes
	if (preg_match(',^\+-(.*)-\+$,', $url_propre, $regs)) {
		$type = 'mot';
		$url_propre = $regs[1];
	}
	else if (preg_match(',^-(.*)-$,', $url_propre, $regs)) {
		$type = 'rubrique';
		$url_propre = $regs[1];
	}
	else if (preg_match(',^\+(.*)\+$,', $url_propre, $regs)) {
		$type = 'breve';
		$url_propre = $regs[1];
	}
	else {
		$type = 'article';
	}

	$table = "spip_".$type."s";
	$col_id = "id_".$type;
	$query = "SELECT $col_id FROM $table WHERE url_propre='".addslashes($url_propre)."'";
	$result = spip_query($query);
	if (spip_num_rows($result) == 1) {
		$row = spip_fetch_array($result);
		$contexte[$col_id] = $row[$col_id];
	}

	return;
}

?>
--- NEW FILE: inc-formulaire_admin.php3 ---
<?php

global $balise_FORMULAIRE_ADMIN_collecte ;
$balise_FORMULAIRE_ADMIN_collecte = array('id_article', 'id_breve', 'id_rubrique', 'id_mot', 'id_auteur');

# on ne peut rien dire au moment de l'ex?cution du squelette

function balise_FORMULAIRE_ADMIN_stat($args, $filtres)
{
	return $args;
}

# les boutons admin sont mis d'autorite si absents
# donc une variable statique controle si FORMULAIRE_ADMIN a ete vu.
# Toutefois, si c'est le debuger qui appelle,
# il peut avoir recopie le code dans ses donnees et il faut le lui refounir.
# Pas question de recompiler: ca fait boucler !
# Le debuger transmet donc ses donnees, et cette balise y retrouve son petit.

function balise_FORMULAIRE_ADMIN_dyn($id_article, $id_breve, $id_rubrique, $id_mot, $id_auteur, $debug='') {
	global $var_preview, $use_cache;
	static $dejafait = false;

	if ($GLOBALS['flag_preserver'] || !$GLOBALS['spip_admin'])
		return '';

	if (!is_array($debug)) {
		if ($dejafait)
			return '';
	} else {
		if ($dejafait) {
			$res = '';
			foreach($debug['sourcefile'] as $k => $v) {
				if (strpos($v,'formulaire_admin') === 0)
					return $debug['resultat'][$k . 'tout'];
			}
			return '';
		}
	}
	$dejafait = true;

	// regler les boutons dans la langue de l'admin (sinon tant pis)
	include_local(_FILE_CONNECT);
	$login = addslashes(ereg_replace('^@','',$GLOBALS['spip_admin']));
	if ($row = spip_fetch_array(spip_query("SELECT lang FROM spip_auteurs WHERE login='$login'"))) {
		$lang = $row['lang'];
		include_ecrire ("inc_lang.php3");
		lang_select($lang);
	}

	// repartir de zero pour les boutons car clean_link a pu etre utilisee
	$link = new Link;
	$link->delVar('var_mode');
	$link->delVar('var_mode_objet');
	$link->delVar('var_mode_affiche');
	$action = $link->getUrl();
	$action = ($action . ((strpos($action, '?') === false) ? '?' : '&'));

  // en preview pas de stat ni de debug
	if (!$var_preview) {
		// Bouton statistiques
		if (lire_meta("activer_statistiques") != "non" 
		AND $id_article
		AND ($GLOBALS['auteur_session']['statut'] == '0minirezo')) {
			if (spip_fetch_array(spip_query("SELECT id_article
			FROM spip_articles WHERE statut='publie'
			AND id_article =".intval($id_article)))) {
				include_local ("inc-stats.php3");
				$r = afficher_raccourci_stats($id_article);
				$visites = $r['visites'];
				$popularite = $r['popularite'];
				$statistiques = 'statistiques_visites.php3?';
			}
		}

		// Bouton de debug
		$debug = (
			($forcer_debug
			OR $GLOBALS['bouton_admin_debug']
			OR ($GLOBALS['var_mode'] == 'debug'
				AND $GLOBALS['HTTP_COOKIE_VARS']['spip_debug']
			)) AND ($GLOBALS['code_activation_debug'] == 'oui'
				OR $GLOBALS['auteur_session']['statut'] == '0minirezo')
		) ? 'debug' : '';
	}

	// hack - ne pas avoir la rubrique si un autre bouton est deja present
	if ($id_article OR $id_breve) unset ($id_rubrique);

	return array('formulaire_admin', 0,
			array(
				'id_article' => $id_article,
				'id_rubrique' => $id_rubrique,
				'id_auteur' => $id_auteur,
				'id_breve' => $id_breve,
				'id_mot' => $id_mot,
				'action' => $action,
				'debug' => $debug,
				'popularite' => intval($popularite),
				'statistiques' => $statistiques,
				'visites' => intval($visites),
				'use_cache' => ($use_cache ? ' *' : '')
			)
		);
}
?>

--- NEW FILE: inc-balises.php3 ---
<?php

//
// Ce fichier regroupe la quasi totalite des definitions de #BALISES de spip
// Pour chaque balise, il est possible de surcharger, dans mes_fonctions.php3,
// la fonction balise_TOTO_dist par une fonction balise_TOTO() respectant la
// meme API : 
// elle recoit en entree un objet de classe CHAMP, le modifie et le retourne.
// Cette classe est definie dans inc-compilo-index.php3
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_BALISES")) return;
define("_INC_BALISES", "1");


//
// Traitements standard de divers champs
//
function champs_traitements ($p) {
	static $traitements = array (
		'BIO' => 'traiter_raccourcis(%s)',
		'CHAPO' => 'traiter_raccourcis(nettoyer_chapo(%s))',
		'DATE' => 'vider_date(%s)',
		'DATE_MODIF' => 'vider_date(%s)',
		'DATE_NOUVEAUTES' => 'vider_date(%s)',
		'DATE_REDAC' => 'vider_date(%s)',
		'DESCRIPTIF' => 'traiter_raccourcis(%s)',
		'LIEN_TITRE' => 'typo(%s)',
		'LIEN_URL' => 'htmlspecialchars(vider_url(%s))',
		'MESSAGE' => 'traiter_raccourcis(%s)',
		'NOM_SITE_SPIP' => 'typo(%s)',
		'NOM' => 'typo(%s)',
		'PARAMETRES_FORUM' => 'htmlspecialchars(%s)',
		'PS' => 'traiter_raccourcis(%s)',
		'SOUSTITRE' => 'typo(%s)',
		'SURTITRE' => 'typo(%s)',
		'TEXTE' => 'traiter_raccourcis(%s)',
		'TITRE' => 'typo(%s)',
		'TYPE' => 'typo(%s)',
		'URL_ARTICLE' => 'htmlspecialchars(vider_url(%s))',
		'URL_BREVE' => 'htmlspecialchars(vider_url(%s))',
		'URL_DOCUMENT' => 'htmlspecialchars(vider_url(%s))',
		'URL_FORUM' => 'htmlspecialchars(vider_url(%s))',
		'URL_MOT' => 'htmlspecialchars(vider_url(%s))',
		'URL_RUBRIQUE' => 'htmlspecialchars(vider_url(%s))',
		'URL_SITE_SPIP' => 'htmlspecialchars(vider_url(%s))',
		'URL_SITE' => 'htmlspecialchars(vider_url(%s))',
		'URL_SYNDIC' => 'htmlspecialchars(vider_url(%s))',
		'HTTP_VARS' => 'htmlspecialchars(%s)'
	);
	$ps = $traitements[$p->nom_champ];
	if (!$ps) return $p->code;
	if ($p->documents)
	  {$ps = str_replace('traiter_raccourcis(', 
			     'traiter_raccourcis_doublon($doublons,',
			     str_replace('typo(', 
					 'typo_doublon($doublons,',
					 $ps));
	  }
	// on supprime les < IMGnnn > tant qu'on ne rapatrie pas
	// les documents distants joints..
	// il faudrait aussi corriger les raccourcis d'URL locales
	return str_replace('%s',
			   (!$p->boucles[$p->id_boucle]->sql_serveur ?
			    $p->code :
			    ('supprime_img(' . $p->code . ')')),
			   $ps);				
}

// il faudrait savoir traiter les formulaires en local 
// tout en appelant le serveur SQL distant.
// En attendant, cette fonction permet de refuser une authentification 
// sur qqch qui n'a rien ? voir.

function balise_distante_interdite($p) {
	$nom = $p->id_boucle;
	if ($p->boucles[$nom]->sql_serveur) {
		erreur_squelette($p->nom_champ ._L(" distant interdit"), $nom);
	}
}

//
// Definition des balises
//
function balise_NOM_SITE_SPIP_dist($p) {
	$p->code = "lire_meta('nom_site')";
	$p->statut = 'php';
	return $p;
}

function balise_EMAIL_WEBMASTER_dist($p) {
	$p->code = "lire_meta('email_webmaster')";
	$p->statut = 'php';
	return $p;
}

function balise_CHARSET_dist($p) {
	$p->code = "lire_meta('charset')";
	$p->statut = 'php';
	return $p;
}

function balise_LANG_LEFT_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'left','right')";
	$p->statut = 'php';
	return $p;
}

function balise_LANG_RIGHT_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'right','left')";
	$p->statut = 'php';
	return $p;
}

function balise_LANG_DIR_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'ltr','rtl')";
	$p->statut = 'php';
	return $p;
}

function balise_PUCE_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "((lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),false,true) && \$GLOBALS['puce_rtl']) ? \$GLOBALS['puce_rtl'] : \$GLOBALS['puce'])";
	$p->statut = 'php';
	return $p;
}

// #DATE
// Cette fonction sait aller chercher dans le contexte general
// quand #DATE est en dehors des boucles
// http://www.spip.net/fr_article1971.html
function balise_DATE_dist ($p) {
	$_date = champ_sql('date', $p);
	$p->code = "$_date";
	$p->statut = 'php';
	return $p;
}

// #DATE_REDAC
// http://www.spip.net/fr_article1971.html
function balise_DATE_REDAC_dist ($p) {
	$_date = champ_sql('date_redac', $p);
	$p->code = "$_date";
	$p->statut = 'php';
	return $p;
}

// #DATE_MODIF
// http://www.spip.net/fr_article1971.html
function balise_DATE_MODIF_dist ($p) {
	$_date = champ_sql('date_modif', $p);
	$p->code = "$_date";
	$p->statut = 'php';
	return $p;
}

// #DATE_NOUVEAUTES
// http://www.spip.net/fr_article1971.html
function balise_DATE_NOUVEAUTES_dist($p) {
	$p->code = "((lire_meta('quoi_de_neuf') == 'oui' AND lire_meta('majnouv')) ? normaliser_date(lire_meta('majnouv')) : \"'0000-00-00'\")";
	$p->statut = 'php';
	return $p;
}

function balise_URL_SITE_SPIP_dist($p) {
	$p->code = "lire_meta('adresse_site')";
	$p->statut = 'php';
	return $p;
}


function balise_URL_ARTICLE_dist($p) {
	$_type = $p->type_requete;

	// Cas particulier des boucles (SYNDIC_ARTICLES)
	if ($_type == 'syndic_articles') {
		$p->code = champ_sql('url', $p);
	}

	// Cas general : chercher un id_article dans la pile
	else {
		$_id_article = champ_sql('id_article', $p);
		$p->code = "generer_url_article($_id_article)";

		if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
			$p->code = "url_var_recherche(" . $p->code . ")";
	}

	$p->statut = 'html';
	return $p;
}

function balise_URL_RUBRIQUE_dist($p) {
	$p->code = "generer_url_rubrique(" . 
	champ_sql('id_rubrique',$p) . 
	")" ;
	if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_BREVE_dist($p) {
	$p->code = "generer_url_breve(" .
	champ_sql('id_breve',$p) . 
	")";
	if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_MOT_dist($p) {
	$p->code = "generer_url_mot(" .
	champ_sql('id_mot',$p) .
	")";
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_FORUM_dist($p) {
	$p->code = "generer_url_forum(" .
	champ_sql('id_forum',$p) .")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_DOCUMENT_dist($p) {
	$p->code = "generer_url_document(" .
	champ_sql('id_document',$p) . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_AUTEUR_dist($p) {
	$p->code = "generer_url_auteur(" .
	champ_sql('id_auteur',$p) .")";
	if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_NOTES_dist($p) {
	// Recuperer les notes
	$p->code = 'calculer_notes()';
	$p->statut = 'html';
	return $p;
}

function balise_RECHERCHE_dist($p) {
	$p->code = 'htmlspecialchars($GLOBALS["recherche"])';
	$p->statut = 'php';
	return $p;
}

function balise_COMPTEUR_BOUCLE_dist($p) {
	if ($p->id_mere === '') {
		erreur_squelette(_L("Champ #COMPTEUR_BOUCLE hors boucle"), $p->id_boucle);
		$p->code = "''";
	} else {
		$p->code = '$compteur_boucle';
		$p->statut = 'php';
		return $p;
	}
}

function balise_TOTAL_BOUCLE_dist($p) {
	$b = $p->nom_boucle ? $p->nom_boucle : $p->id_mere;
	if ($b === '') {
		erreur_squelette(_L("Champ #TOTAL_BOUCLE hors boucle"), $p->id_boucle);
		$p->code = "''";
	} else {
		$p->code = "\$Numrows['$b']";
		$p->boucles[$b]->numrows = true;
		$p->statut = 'php';
	}
	return $p;
}

function balise_POINTS_dist($p) {
	return rindex_pile($p, 'points', 'recherche');
}

function balise_POPULARITE_ABSOLUE_dist($p) {
	$p->code = 'ceil(' .
	champ_sql('popularite', $p) .
	')';
	$p->statut = 'php';
	return $p;
}

function balise_POPULARITE_SITE_dist($p) {
	$p->code = 'ceil(lire_meta(\'popularite_total\'))';
	$p->statut = 'php';
	return $p;
}

function balise_POPULARITE_MAX_dist($p) {
	$p->code = 'ceil(lire_meta(\'popularite_max\'))';
	$p->statut = 'php';
	return $p;
}

function balise_EXPOSER_dist($p) {
	global  $table_primary;
	$type_boucle = $p->type_requete;
	$primary_key = $table_primary[$type_boucle];
	if (!$primary_key) {
		erreur_squelette(_L("Champ #EXPOSER hors boucle"), $p->id_boucle);
	}
	$on = 'on';
	$off= '';
	if ($p->fonctions) {
		// Gerer la notation [(#EXPOSER|on,off)]
		reset($p->fonctions);
		list(, $onoff) = each($p->fonctions);
		ereg("([^,]*)(,(.*))?", $onoff, $regs);
		$on = addslashes($regs[1]);
		$off = addslashes($regs[3]);
		
		// autres filtres
		$filtres=Array();
		while (list(, $nom) = each($p->fonctions))
		  $filtres[] = $nom;
		$p->fonctions = $filtres;
	}


	$p->code = '(calcul_exposer('
	.champ_sql($primary_key, $p)
	.', "'.$primary_key.'", $Pile[0]) ?'." '$on': '$off')";
	$p->statut = 'php';
	return $p;
}


//
// Inserer directement un document dans le squelette
//
function balise_EMBED_DOCUMENT_dist($p) {
	balise_distante_interdite($p);
	$_id_document = champ_sql('id_document',$p);
	$p->code = "calcule_embed_document(intval($_id_document), '" .
	texte_script($p->fonctions ? join($p->fonctions, "|") : "") .
	  "', \$doublons, '" . $p->documents . "')";
	unset ($p->fonctions);
	$p->statut = 'html';
	return $p;
}

// Debut et fin de surlignage auto des mots de la recherche
// on insere une balise Span avec une classe sans spec:
// c'est transparent s'il n'y a pas de recherche,
// sinon elles seront remplacees par les fontions de inc_surligne
// flag_pcre est juste une flag signalant que preg_match est dispo.

function balise_DEBUT_SURLIGNE_dist($p) {
	global $flag_pcre;
	$p->code = ($flag_pcre ? ('\'<span class="spip_surligneconditionnel">\'') : "''");
	return $p;
}
function balise_FIN_SURLIGNE_dist($p) {
	global $flag_pcre;
	$p->code = ($flag_pcre ? ('\'</span class="spip_surligneconditionnel">\'') : "''");
	return $p;
}

function balise_INTRODUCTION_dist ($p) {
	$_type = $p->type_requete;
	$_texte = champ_sql('texte', $p);
	$_chapo = champ_sql('chapo', $p);
	$_descriptif = champ_sql('descriptif', $p);
	$p->code = "calcul_introduction('$_type', $_texte, $_chapo, $_descriptif)";

	$p->statut = 'html';
	return $p;
}


// #LANG
// non documente ?
function balise_LANG_dist ($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "($_lang ? $_lang : \$GLOBALS['spip_lang'])";
	$p->statut = 'php';
	return $p;
}


// #LESAUTEURS
// les auteurs d'un article (ou d'un article syndique)
// http://www.spip.net/fr_article902.html
// http://www.spip.net/fr_article911.html
function balise_LESAUTEURS_dist ($p) {
	// Cherche le champ 'lesauteurs' dans la pile
	$_lesauteurs = champ_sql('lesauteurs', $p); 

	// Si le champ n'existe pas (cas de spip_articles), on donne la
	// construction speciale sql_auteurs(id_article) ;
	// dans le cas contraire on prend le champ 'les_auteurs' (cas de
	// spip_syndic_articles)
	if ($_lesauteurs AND $_lesauteurs != '$Pile[0][\'lesauteurs\']') {
		$p->code = $_lesauteurs;
	} else {
		$nom = $p->id_boucle;
	# On pourrait mieux faire qu'utiliser cette fonction assistante ?
		$p->code = "sql_auteurs(" .
			champ_sql('id_article', $p) .
			",'" .
			$nom .
			"','" .
			$p->boucles[$nom]->type_requete .
			"','" .
			$p->boucles[$nom]->sql_serveur .
			"')";
	}

	$p->statut = 'html';
	return $p;
}


// #PETITION
// Champ testant la presence d'une petition
// non documente mais indispensable a FORMULAIRE_PETITION

function balise_PETITION_dist ($p) {
	$nom = $p->id_boucle;
	$p->code = "sql_petitions(" .
			champ_sql('id_article', $p) .
			",'" .
			$p->boucles[$nom]->type_requete .
			"','" .
			$nom .
			"','" .
			$p->boucles[$nom]->sql_serveur .
			"', \$Cache)";
	$p->statut = 'php';
	return $p;
}


// #POPULARITE
// http://www.spip.net/fr_article1846.html
function balise_POPULARITE_dist ($p) {
	$_popularite = champ_sql('popularite', $p);
	$p->code = "(ceil(min(100, 100 * $_popularite
	/ max(1 , 0 + lire_meta('popularite_max')))))";
	$p->statut = 'php';
	return $p;
}


//
// Fonction commune aux balises #LOGO_XXXX
// (les balises portant ce type de nom sont traitees en bloc ici)
//
function calculer_balise_logo ($p) {

	eregi("^LOGO_([A-Z]+)(_.*)?$", $p->nom_champ, $regs);
	$type_objet = $regs[1];
	$suite_logo = $regs[2];	
	if (ereg("^_SPIP(.*)$", $suite_logo, $regs)) {
		$type_objet = 'RUBRIQUE';
		$suite_logo = $regs[1];
		$_id_objet = "\"'0'\"";
	} else {

		if ($type_objet == 'SITE')
			$_id_objet = champ_sql("id_syndic", $p);
		else
			$_id_objet = champ_sql("id_".strtolower($type_objet), $p);
	}
	// analyser les filtres
	$flag_fichier = false;
	$filtres = '';
	if (is_array($p->fonctions)) {
		foreach($p->fonctions as $nom) {
			if (ereg('^(left|right|center|top|bottom)$', $nom))
				$align = $nom;
			else if ($nom == 'lien') {
				$flag_lien_auto = 'oui';
				$flag_stop = true;
			}
			else if ($nom == 'fichier') {
				$flag_fichier = 'true';
				$flag_stop = true;
			}
			// double || signifie "on passe aux filtres"
			else if ($nom == '')
				$flag_stop = true;
			else if (!$flag_stop) {
				$lien = $nom;
				$flag_stop = true;
			}
			// apres un URL ou || ou |fichier ce sont
			// des filtres (sauf left...lien...fichier)
			else
				$filtres[] = $nom;
		}
		// recuperer les autres filtres s'il y en a
		$p->fonctions = $filtres;
	}

	//
	// Preparer le code du lien
	//
	// 1. filtre |lien
	if ($flag_lien_auto AND !$lien)
		$code_lien = '($lien = generer_url_'.$type_objet.'('.$_id_objet.')) ? $lien : ""';
	// 2. lien indique en clair (avec des balises : imprimer#ID_ARTICLE.html)
	else if ($lien) {
		$code_lien = "'".texte_script(trim($lien))."'";
		while (ereg("^([^#]*)#([A-Za-z_]+)(.*)$", $code_lien, $match)) {
			$c = new Champ();
			$c->nom_champ = $match[2];
			$c->id_boucle = $p->id_boucle;
			$c->boucles = &$p->boucles;
			$c->id_mere = $p->id_mere;
			$c = calculer_champ($c);
			$code_lien = str_replace('#'.$match[2], "'.".$c.".'", $code_lien);
		}
		// supprimer les '' disgracieux
		$code_lien = ereg_replace("^''\.|\.''$", "", $code_lien);
	}

	if ($flag_fichier)
	  $code_lien = "'',''" ; 
	else {
		if (!$code_lien)
			$code_lien = "''";
		$code_lien .= ", '". addslashes($align) . "'";
	}

	// cas des documents
	if ($type_objet == 'DOCUMENT') {
		$code_logo = "calcule_document($_id_objet, '" .
			$p->documents .
		  '\', $doublons)';
		if ($flag_fichier)
		  $p->code = "calcule_fichier_logo($code_logo)";
		else
		  $p->code = "affiche_logos(array($code_logo, ''), $code_lien)";
	}
	else {
	  $p->code = "affiche_logos(calcule_logo('$type_objet', '" .
	    (($suite_logo == '_SURVOL') ? 'off' : 
	     (($suite_logo == '_NORMAL') ? 'on' : 'ON')) .
	    "', $_id_objet," .
	    (($suite_logo == '_RUBRIQUE') ? 
	     champ_sql("id_rubrique", $p) :
	     (($type_objet == 'RUBRIQUE') ? "sql_parent($_id_objet)" : "''")) .
	    ",  '$flag_fichier'), $code_lien)";
	}
	$p->statut = 'php';
	return $p;
}

// #EXTRA [(#EXTRA|isbn)]
// Champs extra
// Non documentes, en voie d'obsolescence, cf. ecrire/inc_extra.php3
function balise_EXTRA_dist ($p) {
	$_extra = champ_sql('extra', $p);
	$p->code = $_extra;

	// Gerer la notation [(#EXTRA|isbn)]
	if ($p->fonctions) {
		include_ecrire("inc_extra.php3");
		list ($key, $champ_extra) = each($p->fonctions);	// le premier filtre
		$type_extra = $p->type_requete;
			// ci-dessus est sans doute un peu buggue : si on invoque #EXTRA
			// depuis un sous-objet sans champ extra d'un objet a champ extra,
			// on aura le type_extra du sous-objet (!)
		if (extra_champ_valide($type_extra, $champ_extra)) {
			unset($p->fonctions[$key]);
			$p->code = "extra($p->code, '".addslashes($champ_extra)."')";

			// Appliquer les filtres definis par le webmestre
			$filtres = extra_filtres($type_extra, $champ_extra);
			if ($filtres) foreach ($filtres as $f)
				$p->code = "$f($p->code)";
		}
	}

	$p->statut = 'html';
	return $p;
}

//
// Parametres de reponse a un forum
//

function balise_PARAMETRES_FORUM_dist($p) {
	include_local('inc-formulaire_forum.php3');
	$_accepter_forum = champ_sql('accepter_forum', $p);
	$p->code = '
	// refus des forums ?
	('.$_accepter_forum.'=="non" OR
	(lire_meta("forums_publics") == "non" AND !ereg("^(pos|pri|abo)", '.$_accepter_forum.')))
	? "" : // sinon:
	';

	switch ($p->type_requete) {
		case 'articles':
			$c = '"id_article=".' . champ_sql('id_article', $p);
			break;
		case 'breves':
			$c = '"id_breve=".' . champ_sql('id_breve', $p);
			break;
		case 'rubriques':
			$c = '"id_rubrique=".' . champ_sql('id_rubrique', $p);
			break;
		case 'syndication':
			$c = '"id_syndic=".' . champ_sql('id_syndic', $p);
			break;
		case 'forums':
		default:
			$liste_champs = array ("id_article","id_breve","id_rubrique","id_syndic","id_forum");
			foreach ($liste_champs as $champ) {
				$x = champ_sql( $champ, $p);
				$c .= (($c) ? ".\n" : "") . "((!$x) ? '' : ('&$champ='.$x))";
			}
			$c = "substr($c,1)";
			break;
	}

	$c .= '.
	"&retour=".rawurlencode($lien=$GLOBALS["HTTP_GET_VARS"]["retour"] ? $lien : nettoyer_uri())';

	$p->code .= code_invalideur_forums($p, "(".$c.")");

	$p->statut = 'html';
	return $p;
}


// Noter l'invalideur de la page contenant ces parametres,
// en cas de premier post sur le forum
function code_invalideur_forums($p, $code) {
	return '
	// invalideur forums
	(!($Cache[\'id_forum\'][calcul_index_forum(' . 
				// Retournera 4 [$SP] mais force la demande du champ a MySQL
				champ_sql('id_article', $p) . ',' .
				champ_sql('id_breve', $p) .  ',' .
				champ_sql('id_rubrique', $p) .',' .
				champ_sql('id_syndic', $p) .  ")]=1)".
				"?'':\n" . $code .")";
}

// reference a l'URL de la page courante

function balise_SELF_dist($p) {
	$p->code = 'quote_amp($GLOBALS["clean_link"]->getUrl())';
	$p->statut = 'php';
	return $p;
}

// reference aux parametres GET & POST

function balise_HTTP_VARS_dist($p) {
	$nom = param_balise($p);
	if (!$nom)
		erreur_squelette(_L("Champ #HTTP_VARS argument manquant"),
				$p->id_boucle);
	else {
		$p->code = '$Pile[0]["' . addslashes($nom) . '"]';
		$p->statut = 'php';
	}
	return $p;
}
?>

--- NEW FILE: inc-criteres.php3 ---
<?php

//
// Definition des {criteres} d'une boucle
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CRITERES")) return;
define("_INC_CRITERES", "1");


// {racine}
// http://www.spip.net/@racine
function critere_racine_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];

	if ($param != 'racine' OR $not)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$boucle->where[] = $boucle->id_table.".id_parent='0'";

}

// {exclus}
// http://www.spip.net/@exclus
function critere_exclus_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	$id = $boucle->primary;

	if ($param != 'exclus' OR $not OR !$id)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$arg = calculer_argument_precedent($idb,$id, $boucles);
	$boucle->where[] = $boucle->id_table . '.' . $id."!='\"." . $arg . ".\"'";

}

// {doublons} ou {unique}
// http://www.spip.net/@doublons
function critere_doublons_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];

	if (!preg_match("/(doublons|unique)[[:space:]]*([a-z_0-9]*)/i",
	$param, $match))
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$boucle->doublons = $boucle->type_requete . $match[2];
	$boucle->where[] = '" .' .
		"calcul_mysql_in('".$boucle->id_table . '.' . $boucle->primary."', "
		.'"0".$doublons[\''.$boucle->doublons."'], 'NOT') . \"";
}

// {lang_select}
// http://www.spip.net/@lang_select
function critere_lang_select_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if (preg_match('/lang_select(=(oui|non))?$/i', $param, $match)) {
		if (!$lang_select = $match[2])
			$lang_select = 'oui';
		if ($not)
			$lang_select = ($lang_select=='oui')?'non':'oui';
		$boucle->lang_select = $lang_select;
	}
	else erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {debut_xxx}
// http://www.spip.net/@debut_
function critere_debut_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if (ereg('^debut([-_a-zA-Z0-9]+),([0-9]*)$', $param, $match)) {
		$debut_lim = "debut".$match[1];
		$boucle->limit =
			'intval($GLOBALS["'.$debut_lim.'"]).",'.$match[2] .'"' ;
	}
	else erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {recherche}
// http://www.spip.net/@recherche
function critere_recherche_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];

	$table = $boucle->id_table;	#articles
	$id_table = 'id_'.preg_replace('/s$/', '', $table); 	#id_article

	// horrible hack du aux id_forum = spip_forum et id_article=spip_articleS
	// en fait il faudrait la fonction inverse de table_objet()
	$id = 'id_'.preg_replace('/s$/', '', $boucle->id_table);

	$boucle->select[] = $boucle->id_table . '.' . $boucle->primary; # pour postgres, neuneu ici
	$boucle->select[] = '$rech_select'; # pour les ... as points

	// et la recherche trouve
	$boucle->where[] = '$rech_where';
}

// {inverse}
// http://www.spip.net/@inverse
function critere_inverse_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	// Classement par ordre inverse
	if ($param == 'inverse' AND !$not) {
		if ($boucle->order)
			$boucle->order .= ".' DESC'";
		else 
			erreur_squelette(_L("inversion d'un ordre inexistant"), 
			"BOUCLE" . $idb);
	} else
		erreur_squelette(_T('info_erreur_squelette'), "{$param} BOUCLE$idb");
}

// {traduction}
// http://www.spip.net/@traduction
//   (id_trad>0 AND id_trad=id_trad(precedent))
//    OR id_article=id_article(precedent)
function critere_traduction_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($param == 'traduction') {
		$boucle->where[] = "((".$boucle->id_table.".id_trad > 0 AND "
			. $boucle->id_table.".id_trad ='\"."
			. calculer_argument_precedent($idb, 'id_trad',
				$boucles)
			. ".\"')
		OR
			(" . $boucle->id_table.".".$boucle->primary." ='\"."
			. calculer_argument_precedent($idb, $boucle->primary,
				$boucles)
			. ".\"'))";
	} else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {origine_traduction}
// http://www.spip.net/@origine_traduction
function critere_origine_traduction_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($param == 'origine_traduction')
		$boucle->where[] = $boucle->id_table.".id_trad = "
		. $boucle->id_table . '.' . $boucle->primary;
	else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}


// {meme_parent}
// http://www.spip.net/@meme_parent
function critere_meme_parent_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($param != 'meme_parent')
		erreur_squelette(_T('info_erreur_squelette'), $param);
	else {
		if ($boucle->type_requete == 'rubriques') {
			$boucle->where[] = $boucle->id_table.".id_parent='\"."
			. calculer_argument_precedent($idb, 'id_parent',
			$boucles)
			. ".\"'";
		} else if ($boucle->type_requete == 'forums') {
			$boucle->where[] = $boucle->id_table.".id_parent='\"."
			. calculer_argument_precedent($idb, 'id_parent',
			$boucles)
			. ".\"'";
			$boucle->where[] = $boucle->id_table.".id_parent > 0";
			$boucle->plat = true;
		} else
			erreur_squelette(_L("{meme_parent} ne s'applique qu'aux boucles (FORUMS) ou (RUBRIQUES)"), "BOUCLE" . $idb);
	}
}

// {branche ?}
// http://www.spip.net/@branche
function critere_branche_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if (preg_match('/branche[[:space:]]*([?])?$/i', $param, $regs)) {
		$c = "calcul_mysql_in('".$boucle->id_table.".id_rubrique',
		calcul_branche(" . calculer_argument_precedent($idb,
		'id_rubrique', $boucles) . "), '')";
		if (!$regs[1])
			$where = "\". $c .\"" ;
		else
			$where = "\".("
			. calculer_argument_precedent($idb, 'id_rubrique',
			$boucles)."? $c : 1).\"";

		if ($not)
			$boucle->where[] = "NOT($where)";
		else
			$boucle->where[] = $where;
	} else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}

// Tri : {par xxxx}
// http://www.spip.net/@par
function critere_par_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($not)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	preg_match('/par[[:space:]]*(.*)/ims', $param, $regs);
	$tri = trim($regs[1]);

	// par hasard
	if ($tri == 'hasard') {
		// tester si cette version de MySQL accepte la commande RAND()
		// sinon faire un gloubi-boulga maison avec de la mayonnaise.
		if (spip_query("SELECT RAND()"))
			$boucle->select[] = "RAND() AS alea";
		else
			$boucle->select[] = "MOD(".$boucle->id_table.'.'.$boucle->primary
			." * UNIX_TIMESTAMP(),32767) & UNIX_TIMESTAMP() AS alea";

		$boucle->order = "'alea'";
	}

	// par titre_mot
	else if ($tri == 'titre_mot') {
		$boucle->order= "'mots.titre'";
	}

	// par type_mot
	else if ($tri == 'type_mot'){
		$boucle->order= "'mots.type'";
	}
	// par num champ(, suite)
	else if (ereg("^num[[:space:]]+([^,]*)(,.*)?",$tri, $match2)) {
		$boucle->select[] = "0+".$boucle->id_table.".".$match2[1]." AS num";
		$boucle->order = "'num".texte_script($match2[2])."'";
	}
	// par champ. Verifier qu'ils sont presents.
	else if (ereg("^[a-z][a-z0-9]*$", $tri)) {
		if ($tri == 'date')
			$boucle->order = "'".$boucle->id_table.".".
			  $GLOBALS['table_date'][$boucle->type_requete]
			  ."'";
		else {
			global $table_des_tables, $tables_des_serveurs_sql;
			$r = $boucle->type_requete;
			$s = $boucles[$idb]->sql_serveur;
			if (!$s) $s = 'localhost';
			$t = $table_des_tables[$r];
			if (!$t) $t = $r; // pour les tables non Spip
			$desc = $tables_des_serveurs_sql[$s][$t];
			if ($desc['field'][$tri])
				$boucle->order = "'".$boucle->id_table.".".$tri."'";
			else {
			  // tri sur les champs synthetises (cf points)
				$boucle->order = "'".$tri."'";
			}
		}
	}
	// tris par critere bizarre
	// (formule composee, virgules, etc).
	// autoriser le hack {par $GLOBALS["tri"]}
	else
		$boucle->order = "\"$tri\"";
}



function calculer_critere_parties($idb, &$boucles, $param, $not, $match) {
  global $tables_relations, $table_des_tables, $table_date, $tables_des_serveurs_sql;
	$boucle = &$boucles[$idb];
	list(,$a1,$op,$a2) = $match;
	list($a11,$a12) = calculer_critere_parties_aux($idb, $boucles, $a1);
	list($a21,$a22) = calculer_critere_parties_aux($idb, $boucles, $a2);

	if (($op== ',')&&(is_numeric($a11) && (is_numeric($a21))))
		$boucle->limit = $a11 .',' . $a21;
	else {
	  $boucle->partie =	($a11 != 'n') ? $a11 : $a12;
		$boucle->total_parties =  ($a21 != 'n') ? $a21 : $a22;
		$boucle->mode_partie = (($op == '/') ? '/' :
				(($a1=='n')?'-':'+').(($a2=='n')?'-':'+'));
	}
}

function calculer_critere_parties_aux($idb, &$boucles, $param) {
	ereg('^(([0-9]+)|n|(#.*))(-([0-9]+))?$', $param, $m);
	if ($m[1] == 'n') 
	  $a = 'n';
	else {
	  $a = calculer_param_dynamique($m[1], $boucles, $idb);
	  if (ereg('" \. *addslashes(.*)\. "', $a, $m2)) $a = $m2[1];
	}
	return array($a, ($m[5] ? $m[5] : 0));
}

//
// La fonction d'aiguillage sur le nom du criteres
//

function calculer_criteres ($idb, &$boucles) {

	foreach($boucles[$idb]->param as $param) {
		// Analyse du critere
		preg_match("/^([!]?)[[:space:]]*(debut|([a-z_]+))/ism",
			$param, $match);
		$critere = $match[2];
		$not = ($match[1] == '!');

		// critere personnalise ?
		$f = "critere_".$critere;
		if (!function_exists($f))
			$f .= '_dist';

		// fonction critere standard ?
		if (!function_exists($f))
			$f = 'calculer_critere_DEFAUT';

		// Applique le critere
		$res = $f($idb, $boucles, $param, $not);

		// gestion d'erreur
		if (is_array($res)) erreur_squelette($res);
	}
}

# Criteres numeriques et de comparaison

function calculer_critere_DEFAUT($idb, &$boucles, $param, $not) {
	global $table_des_tables, $table_date, $tables_des_serveurs_sql;

	$boucle = &$boucles[$idb];
	$type = $boucle->type_requete;
	$id_table = $boucle->id_table;
	$primary = $boucle->primary;
	$id_field = $id_table . '.' . $primary; 

	if (ereg('^([0-9a-zA-Z#_\{\}]+)([,/])([0-9a-zA-Z#_\{\}]+)$', $param, $match))
	  calculer_critere_parties($idb, $boucles, $param, $not, $match);

		// Restriction de valeurs (implicite ou explicite)
	else if (eregi('^([a-z_]+\(?[a-z_]*\)?) *(\??)((!?)(<=?|>=?|==?|IN) *"?([^<>=!"]*))?"?$', $param, $match)) {
	  		$op = $match[5] ? $match[5] : '=';
			// Variable comparee
			$col = $match[1];
			// fonction SQL
			$fct = '';
			if (ereg("([a-z_]+)\(([a-z_]+)\)", $col,$match3)) {
				$col = $match3[2];
				$fct = $match3[1];
			}
			$col_table = $id_table;
			// Valeur de comparaison
			if ($match[3]) {
				if (strtoupper($op) != 'IN') {
					$val = calculer_param_dynamique($match[6], $boucles, $idb);
					// gestion d'erreur
					if (is_array($val)) erreur_squelette($val);
				}
				else {
				// traitement special des valeurs textuelles
				  $val = calculer_params_dynamiques($match[6], $boucles, $idb);
				}
			}
			
			else {
				$val = $match[1];

				// Cas special {lang} : aller chercher $GLOBALS['spip_lang']
				if ($val == 'lang')
					$val = '".$GLOBALS[\'spip_lang\']."';
				else {
				// Si id_parent, comparer l'id_parent avec l'id_objet
				// de la boucle superieure
					if ($val == 'id_parent')
						$val = $primary;
				// Si id_enfant, comparer l'id_objet avec l'id_parent
				// de la boucle superieure
					else if ($val == 'id_enfant')
						$val = 'id_parent';
					$val = calculer_argument_precedent($idb, $val, $boucles) ;
					if (ereg('^\$',$val))
						$val = '" . addslashes(' . $val . ') . "';
					else
						$val = addslashes($val);
				}

			}

			if ($s = calculer_critere_externe($boucle, $id_field,$col, $type))
				$col_table = $s;

			// Cas particulier pour les raccourcis 'type_mot' et 'titre_mot'
			else if ($type != 'mots'
			AND ($col == 'type_mot' OR $col == 'titre_mot'
			OR $col == 'id_groupe')) {
				if ($type == 'forums')
					$col_lien = "forum";
				else if ($type == 'syndication')
					$col_lien = "syndic";
				else
					$col_lien = $type;
				$boucle->from[] = "mots_$col_lien AS lien_mot";
				$boucle->from[] = 'mots AS mots';
				$boucle->where[] = "$id_field=lien_mot." . $primary;
				$boucle->where[] = 'lien_mot.id_mot=mots.id_mot';
				$boucle->group = $id_field;
				$boucle->select[] = $id_field; # pour postgres, neuneu ici
				$col_table = 'mots';

				$boucle->lien = true;
				if ($col == 'type_mot')
					$col = 'type';
				else if ($col == 'titre_mot')
					$col = 'titre';
				else if ($col == 'id_groupe')
					$col = 'id_groupe';
			}

			// Cas particulier : selection des documents selon l'extension
			if ($type == 'documents' AND $col == 'extension')
				$col_table = 'types_documents';
			// HACK : selection des documents selon mode 'image'
			// (a creer en dur dans la base)
			else if ($type == 'documents' AND $col == 'mode'
			AND $val == 'image')
				$val = 'vignette';
			// Cas particulier : lier les articles syndiques
			// au site correspondant
			else if ($type == 'syndic_articles' AND
			!ereg("^(id_syndic_article|titre|url|date|descriptif|lesauteurs)$",$col))
				$col_table = 'syndic';

			// Cas particulier : id_enfant => utiliser la colonne id_objet
			if ($col == 'id_enfant')
				$col = $primary;
			// Cas particulier : id_secteur = id_rubrique pour certaines tables
			if (($type == 'breves' OR $type == 'forums') AND $col == 'id_secteur')
				$col = 'id_rubrique';

			// Cas particulier : expressions de date
			if (ereg("^(date|mois|annee|age|age_relatif|jour_relatif|mois_relatif|annee_relatif)(_redac)?$", $col, $regs)) {
				$col = $regs[1];
				if ($regs[2]) {
					$date_orig = $id_table . ".date_redac";
					$date_compare = '\'" . normaliser_date(' .
					calculer_argument_precedent($idb, 'date_redac', $boucles) .
					') . "\'';
				}
				else {
					$date_orig = "$id_table." . $table_date[$type];
					$date_compare = '\'" . normaliser_date(' .
					  calculer_argument_precedent($idb, 'date', $boucles) .
					  ') . "\'';
				}

				if ($col == 'date') {
					$col = $date_orig;
					$col_table = '';
				}
				else if ($col == 'mois') {
					$col = "MONTH($date_orig)";
					$col_table = '';
				}
				else if ($col == 'annee') {
					$col = "YEAR($date_orig)";
					$col_table = '';
				}
				else if ($col == 'age') {
					$col = calculer_param_date("now()", $date_orig);
					$col_table = '';
				}
				else if ($col == 'age_relatif') {
					$col = calculer_param_date($date_compare, $date_orig);
					$col_table = '';
				}
				else if ($col == 'jour_relatif') {
					$col = "LEAST(TO_DAYS(" .$date_compare . ")-TO_DAYS(" .
					$date_orig . "), DAYOFMONTH(" . $date_compare .
					")-DAYOFMONTH(" . $date_orig . ")+30.4368*(MONTH(" .
					$date_compare . ")-MONTH(" . $date_orig .
					"))+365.2422*(YEAR(" . $date_compare . ")-YEAR(" .
					$date_orig . ")))";
					$col_table = '';
				}
				else if ($col == 'mois_relatif') {
					$col = "MONTH(" . $date_compare . ")-MONTH(" .
					$date_orig . ")+12*(YEAR(" . $date_compare .
					")-YEAR(" . $date_orig . "))";
					$col_table = '';
				}
				else if ($col == 'annee_relatif') {
					$col = "YEAR(" . $date_compare . ")-YEAR(" .
					$date_orig . ")";
					$col_table = '';
				}
			}

			if ($type == 'forums' AND
			($col == 'id_parent' OR $col == 'id_forum'))
				$boucle->plat = true;

			// Operateur de comparaison
			if ($col_table)
				$col = "$col_table.$col";

			if (strtoupper($op) == 'IN') {
				// traitement special des valeurs textuelles
				$where = "$col IN ($val)";
				if ($match[4] == '!') {
					$where = "NOT ($where)";
				} else {
					if (!$boucle->order) {
						$boucle->order = 'rang';
						$boucle->select[] =
						"FIND_IN_SET($col, \\\"$val\\\") AS rang";
					}
				}
			} else {
				if ($op == '==') $op = 'REGEXP';
				if ($fct) $col = "$fct($col)";
				if ($match[4] == '!')
					$where = "NOT ($col $op '$val')";
				else
					$where = "($col $op '$val')";

				// operateur optionnel {lang?}
				if ($match[2]) {
					$champ = calculer_argument_precedent($idb, $match[1], $boucles) ;
					$where = "\".($champ ? \"$where\" : 1).\"";
				}

			}
			$boucle->where[] = $where;
	} // fin du if sur les restrictions de valeurs
	else erreur_squelette(_L("critere inconnu $param"));
}

// traitement des relations externes par une jointure.
// tant qu'a faire eviter de dupliquer sa declaration,
// mais c'est une goutte d'eau dans la mer

function calculer_critere_externe(&$boucle, $id_field, $col, $type)
{
	global $tables_relations;
	if ($col_table =  $tables_relations[$type][$col]) {
		$externe = "$id_field=$col_table." . $boucle->primary;
		if (!$boucle->where || (!in_array($externe, $boucle->where))) {

			$boucle->lien = true;
			$boucle->from[] = "$col_table AS $col_table";
			$boucle->where[] = $externe;
			$boucle->group = $id_field;
		// postgres exige que le champ pour GROUP soit dans le SELECT
			$boucle->select[] = $id_field;
		}
	}
	return $col_table;
}


function calculer_param_date($date_compare, $date_orig) {
	return
	"LEAST((UNIX_TIMESTAMP(" .
	$date_compare .
	")-UNIX_TIMESTAMP(" .
	$date_orig .
	"))/86400,\n\tTO_DAYS(" .
	$date_compare .
	")-TO_DAYS(" .
	$date_orig .
	"),\n\tDAYOFMONTH(" .
	$date_compare .
	")-DAYOFMONTH(" .
	$date_orig .
	")+30.4368*(MONTH(" .
	$date_compare .
	")-MONTH(" .
	$date_orig .
	"))+365.2422*(YEAR(" .
	$date_compare .
	")-YEAR(" .
	$date_orig .
	")))";
}

//
// Calculer les parametres
//
function calculer_param_dynamique($val, &$boucles, $idb) {
#	if (ereg('^ *\((.*)) *$', $val, $m)) $val = $m[1]; # si on veut (#...)
	if (ereg(NOM_DE_CHAMP . "(\{[^}]*\})?", $val, $regs)) {
	  	$champ = new Champ;
		$champ->nom_boucle = $regs[2];
		$champ->nom_champ = $regs[3];
		$champ->etoile = $regs[4];
		$champ->fonctions = $regs[5] ? array($regs[5]) : '';
		$champ->id_boucle = $boucles[$idb]->id_parent;
		$champ->boucles = &$boucles;
		$champ->id_mere = $idb;
		$champ = calculer_champ($champ);
		return '" . addslashes(' . $champ . ') . "';

	} else {
	  if ($val[0]== '%') {
	    spip_log($val .
		     " est obsolete; utiliser HTTP_VARS{" .  substr($val,1) . "}");
		  return '" . addslashes($Pile[0][\''. substr($val,1)  ."']) . \"";
	  }
		else
		  return addslashes($val);
	}
}

function calculer_params_dynamiques($liste, &$boucles, $idb) {
	ereg("^ *\(?(.*[^)])\)? *$",$liste, $reg);
	$res = array();
	foreach (split(" *, *", $reg[1]) as $v) {
	  $v = calculer_param_dynamique($v, $boucles, $idb);
	  if (is_array($v)) erreur_squelette($v);
	  spip_log("'$v'");
	  if (strpos('0123456789',$v[0]) !== false)
	    $res[] = $v;
	  else if ($v[0]=='"')
	    $res[] = "'" . $v . "'";
	  else
	    $res[] = "'$v'";
	}
	return join(',', $res);
}
?>

--- NEW FILE: carto-proto.sql ---
CREATE TABLE spip_carto_carte (
id_carte smallint unsigned NOT NULL auto_increment,
fichier varchar(255) NOT NULL,
titre varchar(255) NOT NULL,
commentaire text default NULL,
callage text default NULL,
id_srs smallint unsigned default NULL,
PRIMARY KEY (id_carte),
KEY titre (titre)
) TYPE=MyISAM;

# srs = systeme de reference spatial
CREATE TABLE spip_carto_srs (
id_srs smallint unsigned NOT NULL auto_increment,
label varchar(30) NOT NULL,
code smallint NOT NULL,
PRIMARY KEY (id_srs)
) TYPE=MyISAM;

# objet cartographique (point, ligne, surface) attach? ? une carte
CREATE TABLE spip_carto_objet (
id_objet smallint unsigned NOT NULL auto_increment,
id_carte smallint unsigned NOT NULL,
titre varchar(255) default NULL,
commentaire text default NULL,
lien varchar(255) default NULL,
logo varchar(255) default NULL,
geometrie text default NULL,
PRIMARY KEY (id_objet),
KEY id_carte (id_carte),
KEY titre (titre)
) TYPE=MyISAM;

# table de jointure entre les objets et les mots cl?s
CREATE TABLE spip_carto_objet_mots (
id_objet smallint unsigned NOT NULL,
id_mot smallint unsigned NOT NULL,
ordre tinyint unsigned NOT NULL,
PRIMARY KEY (id_objet,id_mot),
KEY ordre (ordre)
) TYPE=MyISAM;

# table de jointure entre les objets et les mots cl?s
CREATE TABLE spip_carto_objet_articles (
id_objet smallint unsigned NOT NULL,
id_article smallint unsigned NOT NULL,
ordre tinyint unsigned NOT NULL,
PRIMARY KEY (id_objet,id_article),
KEY ordre (ordre)
) TYPE=MyISAM;

INSERT INTO SPIP_META(nom, valeur, maj) VALUES ('activer_carto','oui',now());
--- NEW FILE: spip_login.php3 ---
<?php
$fond = "login";
$delais = 3600;
$flag_dynamique = true;
$flag_preserver = true;
$forcer_lang = true;

include ("inc-public.php3");

?>

--- NEW FILE: distrib-dist.html ---
document.write('<table border="0" bgcolor="#000000" cellspacing="0" cellpadding="0"><tr><td>');
document.write('<table border="0" bgcolor="#FFFFFF" cellspacing="1" cellpadding="2"><tr><td bgcolor="#D0D0D0" align="center">');
document.write('<a href="#URL_SITE_SPIP/"><b>[(#NOM_SITE_SPIP|addslashes)]</b></a>&nbsp;</td></tr><tr><td><ul><small>');
<BOUCLE_articles(articles){tout}{par date}{inverse}{0,10}>
document.write('<li><a href="#URL_SITE_SPIP/#URL_ARTICLE"><font color="#000000">[(#TITRE|addslashes)]</font></a></li>\n');
</BOUCLE_articles>
document.write('</small></ul></td></tr></table></td></tr></table>');

--- NEW FILE: sommaire-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] </title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">

<!-- Lien vers le backend pour navigateurs eclaires -->
<link rel="alternate" type="application/rss+xml" title="<:syndiquer_site:>" href="backend.php3">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]

<!-- Menu de navigation rubriques -->

<B_rubriques>
<div class="menu">
<ul class="rubriques">
<BOUCLE_rubriques(RUBRIQUES) {racine} {par titre}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_sous_rubriques>
	<ul class="menu-liste">
<BOUCLE_sous_rubriques(RUBRIQUES) {id_parent} {par titre}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_sous_rubriques>
	</ul>
</B_sous_rubriques>
</li>
</BOUCLE_rubriques>
</ul>
</div>
</B_rubriques>

<!-- Logo SPIP -->

<a href="http://www.spip.net"><img src="IMG/logo_spip.jpg" width="105" height="92" border="0" alt="<:site_realise_avec_spip:>"></a>

</div>


<div id="principal" class="contenu">

	<!-- Une : derniers articles publies -->
	
	<h1 class="structure"><:derniers_articles:></h1>
	
	<BOUCLE_article_un(ARTICLES) {par date} {inverse} {0,2}>
		[(#LOGO_ARTICLE_RUBRIQUE|right)]
		[<div class="surtitre">(#SURTITRE)</div>]
		<h2 class="titre-extrait"><a href="#URL_ARTICLE">#TITRE</a></h2>
		[<div class="surtitre">(#SOUSTITRE)</div>]
		<div class="detail">
		[(#DATE|nom_jour)] [(#DATE|affdate)]
		<B_auteurs_un><:par_auteur:> <BOUCLE_auteurs_un(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_un>
		</div>
		[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
		<br>
	</BOUCLE_article_un>


	<div class="encart">

	<!-- Breves -->

	<h1 class="structure"><:dernieres_breves:></h1>

	<B_breves>
	<div class="menu">
	<div class="breves">
		<div class="menu-titre">
		<:breves:>
		</div>
		<ul>
	<BOUCLE_breves(BREVES) {par date} {inverse} {0,8}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>
	</B_breves>

	<!-- Sur le Web -->

	<h1 class="structure"><:nouveautes_web:></h1>

	<B_syndic>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_syndic(SYNDIC_ARTICLES) {par date} {inverse} {0,8}>
		<li class="menu-item">
		<a href="#URL_ARTICLE">[(#TITRE*)]</a>
		</li>
	</BOUCLE_syndic>
		</ul>
	</div>
	</div>
	</B_syndic>

	[<!-- Inscription au site -->

		<div class="formulaire"><:participer_site:>
			<br /><br />(#FORMULAIRE_INSCRIPTION)
		</div>]

	</div>


<h1 class="structure"><:articles_recents:></h1>

<!-- Articles recents -->

<BOUCLE_articles_recents(ARTICLES) {par date} {inverse} {2,8}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_recents><:par_auteur:> <BOUCLE_auteurs_recents(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_recents>
	</div>
	<br>
</BOUCLE_articles_recents>


</div>


#FORMULAIRE_ADMIN
</body>
</html>



--- NEW FILE: mot.php3 ---
<?php
$fond = "mot";
$delais = 24 * 3600;


include ("inc-public.php3");


?>

--- NEW FILE: inc-stats.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_INC_STATS")) return;
define("_INC_STATS", "1");

function ecrire_stats() {
	global $id_article, $id_breve, $id_rubrique;

	if ($GLOBALS['HTTP_X_FORWARDED_FOR'])
		$log_ip = $GLOBALS['HTTP_X_FORWARDED_FOR'];
	else
		$log_ip = $GLOBALS['REMOTE_ADDR'];

	if ($log_id_num = intval($id_rubrique))
		$log_type = "rubrique";
	else if ($log_id_num = intval($id_article))
		$log_type = "article";
	else if ($log_id_num = intval($id_breve))
		$log_type = "breve";
	else
		$log_type = "autre";

	// Conversion IP 4 octets -> entier 32 bits
	if (ereg("^(::ffff:)?([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$", $log_ip, $r)) {
		$log_ip = sprintf("0x%02x%02x%02x%02x", $r[2], $r[3], $r[4], $r[5]);
	}
	else return;

	//
	// Loguer la visite dans la base si possible
	//
	if ($log_type != "autre") {
		$query = "INSERT IGNORE INTO spip_visites_temp (ip, type, id_objet) ".
			"VALUES ($log_ip, '$log_type', $log_id_num)";
		spip_query($query);
	}

	//
	// Loguer le referer
	//
	$url_site_spip = lire_meta('adresse_site');
	$url_site_spip = eregi_replace("^((https?|ftp)://)?(www\.)?", "", $url_site_spip);
	$log_referer = $GLOBALS['HTTP_REFERER'];
	if (($url_site_spip<>'') AND strpos('-'.strtolower($log_referer), strtolower($url_site_spip)) AND !$GLOBALS['var_recherche']) $log_referer = "";
	if ($log_referer) {
		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
		$query = "INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) ".
			"VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)";
		spip_query($query);
	}
}


function afficher_raccourci_stats($id_article) {
	$query = "SELECT visites, popularite FROM spip_articles WHERE id_article=$id_article AND statut='publie'";
	$result = spip_query($query);
	if ($row = @spip_fetch_array($result)) {
		$visites = intval($row['visites']);
		$popularite = ceil($row['popularite']);

		$query = "SELECT COUNT(DISTINCT ip) AS c FROM spip_visites_temp WHERE type='article' AND id_objet=$id_article";
		$result = spip_query($query);
		if ($row = @spip_fetch_array($result)) {
			$visites = $visites + $row['c'];
		}

		return array('visites' => $visites, 'popularite' => $popularite);
	}
}

?>

--- NEW FILE: auteur-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_auteur_principal(AUTEURS) {id_auteur}>

<html lang="#LANG">
<head>
<title>[(#NOM|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


</div>


<!-- Une : affichage de l'auteur -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_AUTEUR|left)]
<h1 class="titre-texte">#NOM</h1>

[<div class="chapo">(#BIO)</div>]
[<br>#NOM_SITE : <a href="(#URL_SITE)">#URL_SITE</a><br>]
[<div class="notes">(#NOTES)</div>]
</div>

[<p><b><:envoyer_message:></b></p>
<div class='spip_encadrer'><b>(#FORMULAIRE_ECRIRE_AUTEUR)</b></div>]

<!-- Articles de l'auteur -->

<h1 class="structure"><:articles_auteur:></h1>

<div class="liste-articles">

<BOUCLE_articles(ARTICLES) {id_auteur} {par titre}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs><:par_auteur:> <BOUCLE_auteurs(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs>
	</div>
	<br>
</BOUCLE_articles>

</div>

</div>
#FORMULAIRE_ADMIN
</body>
</html>

</BOUCLE_auteur_principal>
<:aucun_auteur:>
<//B_auteur_principal>

--- NEW FILE: spip_background.php3 ---
<?php

// Du cote de la page HTML, utiliser un background-image en feuille de style
// plutot qu'un <img>, c'est plus discret notamment sous navigateur texte
$image = pack("H*", "47494638396118001800800000ffffff00000021f90401000000002c0000000018001800000216848fa9cbed0fa39cb4da8bb3debcfb0f86e248965301003b");
$size = strlen($image);

Header("Content-Type: image/gif");
Header("Content-Length: ".$size);
Header("Cache-Control: no-cache,no-store");
Header("Pragma: no-cache");
Header("Connection: close");

echo $image;

flush();

include('ecrire/inc_version.php3');

cron(1);	// toutes les 1 seconde (gourmand)


?>
--- NEW FILE: mes_fonctions.php3 ---
<?php

/////////////////////////////
//CARTO
/////////////////////////////
global $tables_principales;

$spip_carto_carte = array(
	"id_carte" => "bigint(21) NOT NULL",
	"titre" => "VARCHAR(255) BINARY NOT NULL",
	"commentaire" => "TEXT BINARY NOT NULL",
	"fichier" => "TEXT BINARY NOT NULL",
	"callage" => "TEXT BINARY NOT NULL",
	"id_srs" => "bigint(21) NOT NULL");

$spip_carto_carte_key = array(
	"PRIMARY KEY" => "id_carte",
	"KEY id_carte" => "id_carte");

$spip_carto_objet = array(
	"id_objet" => "bigint(21) NOT NULL",
	"id_carte" => "bigint(21) NOT NULL",
	"titre" => "VARCHAR(255) BINARY NOT NULL",
	"commentaire" => "TEXT BINARY NOT NULL",
	"lien" => "VARCHAR(255) BINARY NOT NULL",
	"logo" => "VARCHAR(255) BINARY NOT NULL",
	"geometrie" => "TEXT BINARY NOT NULL");
	
$spip_carto_objet_key = array(
	"PRIMARY KEY" => "id_objet",
	"KEY id_carte" => "id_carte",
	"KEY titre" => "titre");

$tables_principales['carto_objet'] =
	array('field' => &$spip_carto_objet, 'key' => &$spip_carto_objet_key);
$tables_principales['carto_carte'] =
	array('field' => &$spip_carto_carte, 'key' => &$spip_carto_carte_key);
global $table_primary;
$table_primary['carto_carte']="id_carte";


/*
 *   +---------------------------------------------+
 *    Nom du Filtre : WKT to COORDS
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : 
 *    site :  
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#GEOMETRIE|wkt2coords)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * http://www.uzine.net/spip_contrib/
 *
 */
function wkt2coords($geometrie){
	
	return str_replace(';',',',substr($geometrie,8,-1));
}
/*
 *   +---------------------------------------------+
 *    Nom du Filtre : WKT to SHAPE 
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : 
 *    site :  
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#GEOMETRIE|wkt2shape)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * http://www.uzine.net/spip_contrib/
 *
 */
function wkt2shape($geometrie){
	
	return substr($geometrie,0,4);
}

/*
 *   +---------------------------------------------+
 *    Nom du Filtre : Nombre de messages 
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : BoOz Email:booz.bloog at laposte.net
 *    site : http://bloog.net
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *    Compte le nombre de messages d'un auteur
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#ID_AUTEUR|nb_messages)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * http://www.uzine.net/spip_contrib/
 *
 */


?>

--- NEW FILE: impression.css ---

/*
 * Feuille de style specifique a l'impression
 */
 
/* Pour les liens, on desactive les couleurs
   et on affiche l'URL cible a la suite du lien (!) */

a { color: black; text-decoration: underline; }
a:visited { color: black; text-decoration: underline; }
a.spip_in { color: black; text-decoration: underline; }
a.spip_out { color: black; text-decoration: underline; }
a:after {
	display: inline;
	border: 1px solid dotted;
	content: " [" attr(href) "]";
}

/*
 * Un peu de coquetterie
 */

.chapo {
	line-height: 1.4em;
	margin-top: 1em;
}
.texte {
}
.ps {
	padding-top: 0.6em;
	margin-top: 0.6em;
	border-top: 1px dashed #404040;
}
.notes {
	margin-top: 0.6em;
	margin-bottom: 0.6em;
	border-top: 1px solid #707070;
}
.structure {
	display: none;
}
.spip-admin {
	display: none;
}


.contenu {
	margin: 10px;
}
.contenu h1 {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu h1.titre-extrait {
}
.contenu h1.titre-texte {
}
.contenu .surtitre {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu .detail {
	margin-left: 2em;
}
.extrait {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
	margin-left: 2em;
	margin-right: 0em;
	line-height: 1.4em;
}


/*
 * Disposition : on elimine les elements de navigation (display: none)
 * et on choisit un affichage de base pour le principal
 */

#principal {
	margin: 10px;
}

#navigation {
	display: none;
}

.encart {
	display: none;
}

.cartouche {
	margin-top: 0.5em;
	padding-top: 1em;
	margin-bottom: 1em;
}

.cartouche .spip_logos {
	margin-left: 0px;
	padding-left: 0px;
	margin-right: 0.8em;
}


/*
 * Forums
 */

.forum-repondre {
	display: none;
}
.forum-repondre-message {
	display: none;
}


--- NEW FILE: backend-breves.php3 ---
<?php
$fond = "backend-breves";
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
$flag_preserver = true;

@header("Content-type: text/xml");

include ("inc-public.php3");

?>

--- NEW FILE: typographie.css ---

/*
 * Correction des styles HTML par defaut
 */

.structure {
	display: none;
}
h1,h2,h3,h4 {
	margin-top: 0em;
	margin-bottom: 0em;
	font-size: 100%;
	font-weight: normal;
}

/*
 * Styles generaux
 */

/* bien regler la marge (bugs IE) */
body { background: white; margin: 10px; }
a { text-decoration: none; color: #505050; }
a:hover { text-decoration: none; color: #303030; background: #e8e8e8; }
a.spip_out { text-decoration: none; color: #a02020; }
a.spip_in, a.spip_url { text-decoration: none; color: #2020a0; }
a.spip_glossaire { text-decoration: none; color: #20a020; }

.chapo {
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
	font-weight: bold;
	text-align: justify;
	font-size: 105%;
}
.texte, .texte p.spip {
	font-family: Georgia, Garamond, Times, serif;
	text-align: justify;
}
.ps {
	font-family: Georgia, Garamond, Times, serif;
	text-align: justify;
	font-size: 85%;
}
.notes {
	font-family: Georgia, Garamond, Times, serif;
	text-align: left;
	font-size: 80%;
}

/*
 * Ici les styles pour le contenu
 */

.contenu h1,h2 {
	font-size: 120%;
	font-weight: bold;
}
.contenu h1,h2.titre-extrait {
	font-size: 160%;
	font-weight: bold;
}
.contenu h1,h2.titre-texte {
	font-size: 190%;
	font-weight: bold;
}
.contenu .surtitre {
	font-size: 110%;
	font-weight: bold;
	font-variant: small-caps;
}
.contenu .detail {
	font-size: 80%;
	color: #303030;
}
.extrait {
	border: groove 2px #a0a0a0;
	padding: 1em;
	font-size: 85%;
}


/*
 * Disposition a l'ecran
 */

#principal {
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
}

#plan {
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
}

#navigation {
	font-family: Verdana, Arial, Helvetica, sans-serif;
}

.encart {
	font-family: Verdana, Arial, Helvetica, sans-serif;
}


--- NEW FILE: article.php3 ---
<?php

$fond = "article";
$delais = 24 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: recherche-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html lang="#LANG">
<head>
<title><:resultats_recherche:></title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Rubriques trouvees -->

<B_rubriques>
<div class="menu">
<ul class="rubriques" title="<:rubriques:>">
<li class="menu-titre"><:rubriques:></li>
<BOUCLE_rubriques(RUBRIQUES) {recherche} {par points} {inverse} {0,8}>
<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_rubriques>
</ul>
</div>
</B_rubriques>


<!-- Mots-cles trouves et articles associes-->

<B_mots>
<div class="menu">
<ul class="divers" title="<:mots_clefs:>">
<BOUCLE_mots(MOTS) {recherche} {par points} {inverse} {0,5}>
<li>
<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_articles_mots>
	<ul class="menu-liste">
<BOUCLE_articles_mots(ARTICLES) {id_mot} {par hasard} {0,8}>
	<li class="menu-item"><a href="#URL_ARTICLE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
</BOUCLE_articles_mots>
	</ul>
</B_articles_mots>
</li>
</BOUCLE_mots>
</ul>
</div>
</B_mots>

</div>

<!-- Une : articles trouves -->

<div class="contenu" id="principal">

<div class="cartouche">
<h1 class="surtitre"><:resultats_recherche:></h1>
[<h2 class="titre-texte">(#RECHERCHE)</h2>]
</div>

	<div class="encart">

	<!-- Breves trouvees -->

	<B_breves>

	<div class="menu">
	<div class="breves" title="Br&egrave;ves trouv&eacute;es">
		<div class="menu-titre">
		<:breves:>
		</div>
		<ul>
	<BOUCLE_breves(BREVES) {recherche} {par points} {inverse} {0,8}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>

	</B_breves>

	<!-- Sites Web trouves -->

	<B_sites>
	<div class="menu">
	<div class="divers" title="Sites Web trouv&eacute;s">
		<div class="menu-titre">
		<:sites_web:>
		</div>
		<ul>
	<BOUCLE_sites(SITES) {recherche} {par points} {inverse} {0,8}>
		<li class="menu-item">
		<a href="#URL_SITE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#NOM_SITE</a>
		</li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>

	<!-- Messages trouves -->

	<B_messages>
	<div class="menu">
	<div class="divers" title="<:messages_forum:>">
		<div class="menu-titre">
		<:messages_forum:>
		</div>
		<ul>
	<BOUCLE_messages(FORUMS) {recherche} {par points} {inverse} {0,8}>
		<li class="menu-item">
		<a href="#URL_FORUM">#TITRE</a>
		</li>
	</BOUCLE_messages>
		</ul>
	</div>
	</div>
	</B_messages>

	</div>


<div class="liste-articles">

<BOUCLE_articles(ARTICLES) {recherche} {par points} {inverse} {0,10}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_articles><:par_auteur:> <BOUCLE_auteurs_articles(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_articles>
	</div>
	<br>
</BOUCLE_articles>

</div>

</div>

#FORMULAIRE_ADMIN
</body>
</html>


--- NEW FILE: spip_carto.php ---
<?php
include ("ecrire/inc_version.php3");
include ("ecrire/inc_connect.php3");
//include ("ecrire/inc_meta.php3");
//include ("ecrire/inc_session.php3");

include("downloadfile.class.php");

if (isset($_GET["id_carte"]) && !empty($_GET["id_carte"])) 
{
	$query="select fichier from spip_documents where id_document=".$_GET["id_carte"];
		
	$result = @spip_query($query);
	if ($result) 
	{
		$row = @spip_fetch_array($result); 
		$downloadfile = new DOWNLOADFILE($row[0],"inline");
		//si c'est un probleme de document supprim? : "!!!" ... bof !
		if (!$downloadfile->df_download()) echo "!!!";
		//else exit();
	}
}
?>
--- NEW FILE: formulaire_inscription-dist.html ---
[
(#HTTP_VARS{mode}|choixsiegal{forum,' ',''})<:pass_forum_bla:><br /><br />][
(#HTTP_VARS{mode}|choixsiegal{redac,' ',''})<:pass_espace_prive_bla:><br /><br />]<:form_forum_indiquer_nom_email:>
<form id="inscription" method='post' action='#SELF' style='border: 0px; margin: 0px;'> 
      <fieldset style="border: none; font-weight: bold"><legend></legend>
	<label>
	  <:form_pet_votre_nom:>
	  <input type="text" class="forml" name="nom_inscription" value="" size="30" />
	</label>
	<label>
	  <:form_pet_votre_email:>
	  <input type="text" class="forml" name="mail_inscription" value="" size="30" />
	</label>
      </fieldset>
      <div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>" />
	</div> 
</form>[
<script type="text/javascript"><!--
document.inscription.(#HTTP_VARS{focus}).focus()
--></script>
][<br />
<div align="right">
(#HTTP_VARS{mode}|choixsivide{'', ' '})
<script type="text/javascript"><!--
document.write("<a href='")
document.write((window.opener) ? "javascript:close()" : "./")
document.write("'><:pass_quitter_fenetre:><" + "/a>");
//--></script>
<noscript>
	&#91;<a href='./'><:pass_retour_public:></a>&#93;
</noscript>
</div>
]


--- NEW FILE: inc-url_logout.php3 ---
<?php

global $balise_URL_LOGOUT_collecte;
$balise_URL_LOGOUT_collecte = array();

function balise_URL_LOGOUT_stat ($args, $filtres)
{
  return array($filtres[0]);
}

function balise_URL_LOGOUT_dyn($cible)
{
	if (!$login = $GLOBALS['auteur_session']['login'])
	  return '';
	if (!$cible) $cible = $GLOBALS['clean_link']->getUrl();
	return 'spip_cookie.php3?logout_public=' . $login . '&amp;url=' . urlencode($cible);
}
?>

--- NEW FILE: inc-compilo-index.php3 ---
<?php


// fonctions de recherche et de reservation
// dans l'arborescence des boucles

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_COMPILO_INDEX")) return;
define("_INC_COMPILO_INDEX", "1");

// index_pile retourne la position dans la pile du champ SQL $nom_champ 
// en prenant la boucle la plus proche du sommet de pile (indique par $idb).
// Si on ne trouve rien, on considere que ca doit provenir du contexte 
// (par l'URL ou l'include) qui a ete recopie dans Pile[0]
// (un essai d'affinage a debouche sur un bug vicieux)
// Si ca reference un champ SQL, on le memorise dans la structure $boucles
// afin de construire un requete SQL minimale (plutot qu'un brutal 'SELECT *')

function index_pile($idb, $nom_champ, &$boucles, $explicite='') {
  global $exceptions_des_tables, $table_des_tables, $tables_des_serveurs_sql;

	$i = 0;
	if (strlen($explicite)) {
	// Recherche d'un champ dans un etage superieur
	  while (($idb != $explicite) && ($idb !='')) {
#		spip_log("Cherchexpl: $nom_champ '$explicite' '$idb' '$i'");
			$i++;
			$idb = $boucles[$idb]->id_parent;
		}
	}

	$c = strtolower($nom_champ);
	// attention: entre la boucle nommee 0, "" et le tableau vide,
	// il y a incoherences qu'il vaut mieux eviter
	while ($boucles[$idb]) {
#		spip_log("Cherche: $nom_champ '$idb' '$c'");
		$r = $boucles[$idb]->type_requete;
		$s = $boucles[$idb]->sql_serveur;
		if (!$s) 
		  { $s = 'localhost';
    // indirection (pour les rares cas ou le nom de la table!=type)
		    $t = $table_des_tables[$r];
		  }
		if (!$t) $t = $r; // pour les tables non Spip
		// $t est le nom PHP de cette table 
#		spip_log("Go: idb='$idb' r='$r' c='$c' nom='$nom_champ' s=$s");
		$desc = $tables_des_serveurs_sql[$s][$t];
		if (!$desc) {
			erreur_squelette(_L("Table SQL \"$r\" inconnue"), "'$idb'");
			# continuer pour chercher l'erreur suivante
			return  "'#" . $r . ':' . $nom_champ . "'";
		}
		$excep = $exceptions_des_tables[$r][$c];
		if ($excep) {
			// entite SPIP alias d'un champ SQL
			if (!is_array($excep)) {
				$e = $excep;
				$c = $excep;
			} 
			// entite SPIP alias d'un champ dans une autre table SQL
			else {
				$t = $excep[0];
				$e = $excep[1].' AS '.$c;
			}
		}
		else {
			// $e est le type SQL de l'entree
			// entite SPIP homonyme au champ SQL
			if ($desc['field'][$c])
				$e = $c;
			else
				unset($e);
		}

#		spip_log("Dans $idb ('$t' '$e'): $desc");

		// On l'a trouve
		if ($e) {
			$boucles[$idb]->select[] = $t . "." . $e;
			return '$Pile[$SP' . ($i ? "-$i" : "") . '][\'' . $c . '\']';
		}

		// Sinon on remonte d'un cran
		$idb = $boucles[$idb]->id_parent;
		$i++;
	}

#	spip_log("Pas vu $nom_champ dans les " . count($boucles) . " boucles");
	// esperons qu'il y sera
	return('$Pile[0][\''.$nom_champ.'\']');
}

# calculer_champ genere le code PHP correspondant a une balise Spip
# Retourne une EXPRESSION php 
function calculer_champ($p) {
	$p = calculer_balise($p->nom_champ, $p);

	// definir le type et les traitements
	// si ca ramene le choix par defaut, ce n'est pas un champ 

	if (($p->code) && ($p->code != '$Pile[0][\''.$nom.'\']')) {
		// Par defaut basculer en numerique pour les #ID_xxx
		if (substr($nom,0,3) == 'ID_') $p->statut = 'num';
	}

	else {
	// on renvoie la forme initiale '#TOTO'
	$p->code = "'#" . $nom . "'";
	$p->statut = 'php';	// pas de traitement
	
	}

	// Retourner l'expression php correspondant au champ + ses filtres
	return applique_filtres($p);
}

// cette fonction sert d'API pour demander le champ '$champ' dans la pile
function champ_sql($champ, $p) {
	return index_pile($p->id_boucle, $champ, $p->boucles, $p->nom_boucle);
}

// cette fonction sert d'API pour demander une balise quelconque sans filtre
function calculer_balise($nom, $p) {

	// regarder s'il existe une fonction personnalisee balise_NOM()
	$f = 'balise_' . $nom;
	if (function_exists($f))
		return $f($p);

	// regarder s'il existe une fonction standard balise_NOM_dist()
	$f = 'balise_' . $nom . '_dist';
	if (function_exists($f))
		return $f($p);

	// regarder s'il existe un fichier d'inclusion au nom de la balise
	// et contenant un tableau balise_NOM_collecte
	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
	if (@file_exists($file)) {
		include_local($file);
		$f = $GLOBALS['balise_' . $nom . '_collecte'];
		if (is_array($f))
			return calculer_balise_dynamique($p, $nom, $f);
	}

	// S'agit-il d'un logo ? Une fonction speciale les traite tous
	if (ereg('^LOGO_', $nom))
		return calculer_balise_logo($p);

	// ca doit etre un champ SQL homonyme,
	$p->code = index_pile($p->id_boucle, $nom, $p->boucles, $p->nom_boucle);
	return $p;
}

//
// Traduction des balises dynamiques, notamment les "formulaire_*"
// Inclusion du fichier associe a son nom.
// Ca donne les arguments a chercher dans la pile,on compile leur localisation
// Ensuite on delegue a une fonction generale definie dans inc-calcul-outils
// qui recevra a l'execution la valeurs des arguments, 
// ainsi que les filtres (qui ne sont donc pas traites ? la compil)

function calculer_balise_dynamique($p, $nom, $l) {
	balise_distante_interdite($p);
	$param = param_balise($p);
	$p->code = "executer_balise_dynamique('" . $nom . "',\n\tarray("
	  . join(',',collecter_balise_dynamique($l, $p))
	  . filtres_arglist($param, $p)
	  . "),\n\tarray("
	  . (!$p->fonctions ? '' : ("'" . join("','", $p->fonctions) . "'"))
	  . "))";
	$p->statut = 'php';
	$p->fonctions = '';
	return $p;
}

function param_balise(&$p) 
{
	$a = $p->fonctions;
	if ($a) list(,$nom) = each($a) ; else $nom = '';
	if (!ereg(' *\{ *([^}]+) *\} *',$nom, $m))
	  return '';
	else {
		$filtres= array();
		while (list(, $f) = each($a)) if ($f) $filtres[] = $f;
		$p->fonctions = $filtres;
		return $m[1];
	}
}

// construire un tableau des valeurs interessant un formulaire

function collecter_balise_dynamique($l, $p) {
	$args = array();
	foreach($l as $c) { $x = calculer_balise($c, $p); $args[] = $x->code;}
	return $args;
}

// Genere l'application d'une liste de filtres
function applique_filtres($p) {
	$statut = $p->statut;
	$fonctions = $p->fonctions;
	$p->fonctions = ''; # pour r?utiliser la structure si r?cursion

	// pretraitements standards
	switch ($statut) {
		case 'num':
			$code = "intval($code)";
			break;
		case 'php':
			break;
		case 'html':
		default:
			$code = "trim($code)";
			break;
	}

//  processeurs standards (cf inc-balises.php3)
	$code = ($p->etoile ? $p->code : champs_traitements($p));
	// Appliquer les filtres perso
	if ($fonctions) {
		foreach($fonctions as $fonc) {
			if ($fonc) {
				$arglist = '';
				if (ereg('([^\{\}]*)\{(.+)\}$', $fonc, $regs)) {
					$fonc = $regs[1];
				        $arglist = filtres_arglist($regs[2],$p);
				}
				if (function_exists($fonc))
				  $code = "$fonc($code$arglist)";
				else if (strpos(" < > <= >= == <> ", " $fonc "))
				  $code = "$code $fonc " . substr($arglist,1);
				else 
				  $code = "erreur_squelette('".
					  texte_script(
						_T('erreur_filtre', array('filtre' => $fonc))
					)."','" . $p->id_boucle . "')";
			}
		}
	}

	// post-traitement securite
	if ($statut == 'html')
		$code = "interdire_scripts($code)";
	return $code;
}

// analyse des parametres d'un champ etendu
// [...(#CHAMP{parametres})...] ou [...(#CHAMP|filtre{parametres})...]
// retourne une suite de N references aux N valeurs indiqu?es avec N virgules

function filtres_arglist($args, $p) {
	$arglist ='';;
	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
		$arg = trim($regs[1]);
		if ($arg) {
		  if (ereg("^" . NOM_DE_CHAMP, $arg, $regs2)) {
				$p->nom_boucle = $regs2[2];
				$p->nom_champ = $regs2[3];
				$arg = calculer_champ($p);
			} else if ($arg[0] =='$')
				$arg = '$Pile[0][\'' . substr($arg,1) . "']";
			$arglist .= ','.$arg;
		}
		$args=$regs[2];
	}
	return $arglist;
}

//
// Reserve les champs necessaires a la comparaison avec le contexte donne par
// la boucle parente ; attention en recursif il faut les reserver chez soi-meme
// ET chez sa maman
// 
function calculer_argument_precedent($idb, $nom_champ, &$boucles) {

	// recursif ?
	if ($boucles[$idb]->externe)
		index_pile ($idb, $nom_champ, $boucles); // reserver chez soi-meme
	// reserver chez le parent et renvoyer l'habituel $Pile[$SP]['nom_champ']
#	spip_log("boucles[$idb]->id_parent " . $boucles[$idb]->id_parent);
	return index_pile ($boucles[$idb]->id_parent, $nom_champ, $boucles);
}

function rindex_pile($p, $champ, $motif) 
{
	$n = 0;
	$b = $p->id_boucle;
	$p->code = '';
	while ($b != '') {
	if ($s = $p->boucles[$b]->param) {
	  foreach($s as $v) {
		if (strpos($v,$motif) !== false) {
		  $p->code = '$Pile[$SP' . (($n==0) ? "" : "-$n") .
			"]['$champ']";
		  $b = '';
		  break;
		}
	  }
	}
	$n++;
	$b = $p->boucles[$b]->id_parent;
	}
	if (!$p->code) {
	  erreur_squelette(_L("Champ #" . strtoupper($champ) . " hors d'une boucle de motif $motif"), $p->id_boucle);
	}
	$p->statut = 'php';
	return $p;
}

?>

--- NEW FILE: inc-login_public.php3 ---
<?php

include(_FILE_CONNECT);
include_ecrire("inc_meta.php3");
include_ecrire("inc_session.php3");
include_ecrire("inc_filtres.php3");

global $balise_LOGIN_PUBLIC_collecte;
$balise_LOGIN_PUBLIC_collecte = array('url');

# retourner:
# 1. l'url collectee ci-dessus (args0) ou donnee en filtre (filtre0)
# 2. l'eventuel parametre de la balise (args1) fournie par calculer_balise_dynamique

function balise_LOGIN_PUBLIC_stat ($args, $filtres)
{
	return array($filtres[0] ? $filtres[0] : $args[0], $args[1]);
}

function balise_LOGIN_PUBLIC_dyn($cible, $login)
{
	if (!$cible) {
		global $clean_link;
		$clean_link->delVar('var_erreur');
		$clean_link->delVar('var_login');
		$cible = $clean_link->getUrl();
	}
	return login_explicite($login, $cible,  'forum');
}

function login_explicite($login, $cible, $mode) {
	global $auteur_session, $clean_link;

	$clean_link->delVar('var_erreur');
	$clean_link->delVar('var_login');
	$action = $clean_link->getUrl();

	if ($cible) {
	  $cible = ereg_replace("[?&]var_erreur=[^&]*", '', $cible);
	  $cible = ereg_replace("[?&]var_login=[^&]*", '', $cible);
	} else {
	  if (ereg("[?&]url=([^&]*)", $action, $m))
	    $cible = urldecode($m[1]);
	  else
	    $cible = _DIR_RESTREINT ;
	}
	      
	include_ecrire("inc_session.php3");
	verifier_visiteur();

	if ($auteur_session AND 
	($auteur_session['statut']=='0minirezo' OR $auteur_session['statut']=='1comite')) {
		if (($cible != $action) &&  !headers_sent())
			redirige_par_entete($cible);
		return http_href($cible, _T('login_par_ici'));
	}
	return login_pour_tous($login ? $login : $GLOBALS['var_login'], $cible, '', $action, $mode);
}

// fonction aussi pour les forums sur abonnement

function login_pour_tous($login, $cible, $message, $action, $mode) {

  global $ignore_auth_http, $spip_admin, $php_module;

	// en cas d'echec de cookie, inc_auth a renvoye vers spip_cookie qui
	// a tente de poser un cookie ; s'il n'est pas la, c'est echec cookie
	// s'il est la, c'est probablement un bookmark sur bonjour=oui,
	// et pas un echec cookie.
	if ($GLOBALS['var_echec_cookie'])
	  $echec_cookie = ($GLOBALS['spip_session'] != 'test_echec_cookie');
	$auth = ($echec_cookie AND $php_module AND !$ignore_auth_http) ?
	  'spip_cookie.php3' : '';
	// Le login est memorise dans le cookie d'admin eventuel
	if (!$login) {
		if (ereg("^@(.*)$", $spip_admin, $regs))
			$login = $regs[1];
	} else if ($login == '-1')
	  $login = '';

	$row = array();
	$erreur = '';
	if ($login) {
		$row = spip_query("SELECT * FROM spip_auteurs WHERE login='" .addslashes($login) ."'");
		$row =  spip_fetch_array($row);
		if ((!$row AND !$GLOBALS['ldap_present']) OR
		    ($row['statut'] == '5poubelle') OR 
		    (($row['source'] == 'spip') AND $row['pass'] == '')) {
			$erreur =  _T('login_identifiant_inconnu', array('login' => $login));
 			$row = array();
			$login = '';
			@spip_setcookie("spip_admin", "", time() - 3600);
		} else {
		  // on laisse le menu decide de la langue
		  unset($row['lang']);
		}
	}

	return array('formulaire_login', 0, 
		     array_merge(array_map('addslashes', $row),
				 array(
				       'action2' => ($login ? 'spip_cookie.php3' : $action),
				       'erreur' => $erreur,
				       'action' => $action,
				       'url' => $cible,
				       'auth' => $auth,
				       'echec_cookie' => ($echec_cookie ? ' ' : ''),
				       'message' => ($message ? ' ' : ''),
				       )
				 )
		     );

}

// Bouton duree de connexion

function filtre_rester_connecte($prefs) 
{
	$prefs = unserialize(stripslashes($prefs));
	return $prefs['cnx'] == 'perma' ? ' ' : '';
}

function silogoauteur($id_auteur)
{
  $f = _DIR_IMG . 'auton' . $id_auteur . '.jpg';
  return (@file_exists($f) ? $f : '');
}
?>

--- NEW FILE: inc-admin.php3 ---
<?php

// Inserer la feuille de style selon les normes, dans le <head>
// Feuilles de style admin : d'abord la CSS officielle, puis la perso,
function perso_admin($texte) {
	$css = "<link rel='stylesheet' href='spip_admin.css' type='text/css' />\n";
	if (@file_exists('spip_admin_perso.css'))
		$css2 = "<link rel='stylesheet' href='spip_admin_perso.css' type='text/css' />\n";

	if (eregi('<(/head|body)', $texte, $regs)) {
		$texte = explode($regs[0], $texte, 2);
		return $texte[0] . $css. $css2 . $regs[0] . $texte[1];
	} else
		return $css . $css2 . $texte;
}

?>

--- NEW FILE: inc-formulaire_signature.php3 ---
<?php

// Formulaire de signature d'une petition
//

global $balise_FORMULAIRE_SIGNATURE_collecte;
$balise_FORMULAIRE_SIGNATURE_collecte = array('petition', 'nom_email', 'adresse_email', 'message', 'signature_nom_site', 'signature_url_site', 'url_page', 'val_confirm');

function balise_FORMULAIRE_SIGNATURE_stat($args, $filtres)
{
  return ($args[0] ? $args : '');
}

function balise_FORMULAIRE_SIGNATURE_dyn($id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm) {

	include_local(_FILE_CONNECT);
	if ($val_confirm)
		return reponse_confirmation($id_article);
	else if ($nom_email AND $adresse_email)
		return  reponse_signature($id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm);
	else {
		$row = spip_fetch_array(spip_query("SELECT * FROM spip_petitions WHERE id_article='$id_article'"));
		return !$row ? '': array('formulaire_signature', 0, $row);
	}
}


//
// Retour a l'ecran du lien de confirmation d'une signature de petition.
// Si val_confirm est non vide, c'est l'appel en debut de inc-public
// pour vider le cache au demarrage afin que la nouvelle signature apparaisse.
// Sinon, c'est l'execution du formulaire et on retourne le message 
// de confirmation ou d'erreur construit lors de l'appel par inc-public.

function reponse_confirmation($id_article, $val_confirm = '') {
	static $confirm = '';

	if (!$val_confirm) return $confirm;
	include_local(_FILE_CONNECT);
	if ($GLOBALS['db_ok']) {
		include_ecrire("inc_texte.php3");
		include_ecrire("inc_filtres.php3");

		// Eviter les doublons
		$lock = "petition $id_article $val_confirm";
		if (!spip_get_lock($lock, 5)) {
			$confirm= _T('form_pet_probleme_technique');
		}
		else {
			$query_sign = "SELECT * FROM spip_signatures WHERE statut='".addslashes($val_confirm)."'";
			$result_sign = spip_query($query_sign);
			if (spip_num_rows($result_sign) > 0) {
				while($row = spip_fetch_array($result_sign)) {
					$id_signature = $row['id_signature'];
					$id_article = $row['id_article'];
					$date_time = $row['date_time'];
					$nom_email = $row['nom_email'];
					$adresse_email = $row['ad_email'];
					$nom_site = $row['nom_site'];
					$url_site = $row['url_site'];
					$message = $row['message'];
					$statut = $row['statut'];
				}
	
				$query_petition = "SELECT * FROM spip_petitions WHERE id_article=$id_article";
				$result_petition = spip_query($query_petition);
	
				while ($row = spip_fetch_array($result_petition)) {
					$id_article = $row['id_article'];
					$email_unique = $row['email_unique'];
					$site_obli = $row['site_obli'];
					$site_unique = $row['site_unique'];
					$message_petition = $row['message'];
					$texte_petition = $row['texte'];
				}
	
				if ($email_unique == "oui") {
					$email = addslashes($adresse_email);
					$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND ad_email='$email' AND statut='publie'";
					$result = spip_query($query);
					if (spip_num_rows($result) > 0) {
						$confirm= (_T('form_pet_deja_signe'));
						$refus = "oui";
					}
				}
	
				if ($site_unique == "oui") {
					$site = addslashes($url_site);
					$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND url_site='$site' AND statut='publie'";
					$result = spip_query($query);
					if (spip_num_rows($result) > 0) {
						$confirm= (_T('form_pet_deja_enregistre'));
						$refus = "oui";
					}
				}
	
				if ($refus == "oui") {
					$confirm= (_T('form_deja_inscrit'));
				}
				else {
					$query = "UPDATE spip_signatures SET statut='publie' WHERE id_signature='$id_signature'";
					$result = spip_query($query);
					// invalider les pages ayant des boucles signatures
					include_ecrire('inc_invalideur.php3');
					include_ecrire('inc_meta.php3');
					suivre_invalideur("id='petition/petition'");
	
					$confirm= (_T('form_pet_signature_validee'));
				}
			}
			else {
				$confirm= (_T('form_pet_aucune_signature'));
			}
			spip_release_lock($lock);
		}
	}
	else {
		$confirm= _T('form_pet_probleme_technique');
	}
}

//
// Retour a l'ecran de la signature d'une petition
//

function reponse_signature($id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm) {

	if ($GLOBALS['db_ok']) {
		include_ecrire("inc_texte.php3");
		include_ecrire("inc_filtres.php3");
		include_ecrire("inc_mail.php3");

		// Eviter les doublons
		$lock = "petition $id_article $adresse_email";
		if (!spip_get_lock($lock, 5)) {
			return _T('form_pet_probleme_technique');
		} else {
			$query_petition = "SELECT * FROM spip_petitions WHERE id_article=$id_article";
			$result_petition = spip_query($query_petition);
	
			while ($row = spip_fetch_array($result_petition)) {
				$id_article = $row['id_article'];
				$email_unique = $row['email_unique'];
				$site_obli = $row['site_obli'];
				$site_unique = $row['site_unique'];
				$message_petition = $row['message'];
				$texte_petition = $row['texte'];
			}
	
			if (strlen($nom_email) < 2) {
				return (_T('form_indiquer_nom'));
			}
	
			if ($adresse_email == _T('info_mail_fournisseur')) {
				return (_T('form_indiquer_email'));
			}
	
			if ($email_unique == "oui") {
				$email = addslashes($adresse_email);
				$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND ad_email='$email' AND statut='publie'";
				$result = spip_query($query);
				if (spip_num_rows($result) > 0) {
					return (_T('form_pet_deja_signe'));
				}
			}
	
			if (!email_valide($adresse_email)) {
				return (_T('form_email_non_valide'));
			}
	
			if ($site_obli == "oui") {
				if (!$nom_site) {
					return (_T('form_indiquer_nom_site'));
				}
				include_ecrire("inc_sites.php3");
	
				if (!recuperer_page($url_site)) {
					return (_T('form_pet_url_invalide'));
				}
			}
			if ($site_unique == "oui") {
				$site = addslashes($url_site);
				$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND url_site='$site' AND (statut='publie' OR statut='poubelle')";
				$result = spip_query($query);
				if (spip_num_rows($result) > 0) {
					return (_T('form_pet_site_deja_enregistre'));
				}
			}
	
			$passw = test_pass();
	
			if ($refus == "oui") {
				return _T('form_pet_signature_pasprise');
			}
			else {
				$query_site = "SELECT titre FROM spip_articles WHERE id_article=$id_article";
				$result_site = spip_query($query_site);
				while ($row = spip_fetch_array($result_site)) {
					$titre = $row['titre'];
				}

				$link = new Link($url_page);
				$link->addVar('val_confirm', $passw);
				$url = $link->getUrl("sp$id_article");
	
				$messagex = _T('form_pet_mail_confirmation', array('titre' => $titre, 'nom_email' => $nom_email, 'nom_site' => $nom_site, 'url_site' => $url_site, 'url' => $url));

				if (envoyer_mail($adresse_email, _T('form_pet_confirmation')." ".$titre, $messagex)) {

					$nom_email = addslashes($nom_email);
					$adresse_email = addslashes($adresse_email);
					$nom_site = addslashes($nom_site);
					$url_site = addslashes($url_site);
					$message = addslashes($message);
	
					spip_query("INSERT INTO spip_signatures (id_article, date_time, nom_email, ad_email, nom_site, url_site, message, statut) VALUES ('$id_article', NOW(), '$nom_email', '$adresse_email', '$nom_site', '$url_site', '$message', '$passw')");
					return _T('form_pet_envoi_mail_confirmation');
				}
				else {
					return _T('form_pet_probleme_technique');
				}
			}
			spip_release_lock($lock);
		}
	}
	else {
		return _T('form_pet_probleme_technique');
	}

}


function test_pass() {
	include_ecrire("inc_acces.php3");
	for (;;) {
		$passw = creer_pass_aleatoire();
		$query = "SELECT statut FROM spip_signatures WHERE statut='$passw'";
		$result = spip_query($query);
		if (!spip_num_rows($result)) break;
	}
	return $passw;
}

?>

--- NEW FILE: inc-calcul-outils.php3 ---
<?php

//
// Des fonctions diverses utilisees lors du calcul d'une page ; ces fonctions
// bien pratiques n'ont guere de logique organisationnelle ; elles sont
// appelees par certaines balises au moment du calcul des pages. (Peut-on
// trouver un modele de donnees qui les associe physiquement au fichier
// definissant leur balise ???
//

// ON TROUVERA EN QUEUE DE FICHIER LES FONCTIONS FAISANT DES APPELS SQL


// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CALCUL_OUTILS")) return;
define("_INC_CALCUL_OUTILS", "1");

// Pour les documents comme pour les logos, le filtre |fichier donne
// le chemin du fichier apres 'IMG/' ;  peut-etre pas d'une purete
// remarquable, mais a conserver pour compatibilite ascendante.
// -> http://www.spip.net/fr_article901.html
function calcule_fichier_logo($on) {
	$r = ereg_replace("^" . _DIR_IMG, "", $on);
	return $r;
}

// Renvoie le code html pour afficher un logo, avec ou sans survol, lien, etc.
// utilise la globale ci-dessous pour les attributs hspace & vspace

tester_variable('espace_logos',3);

function affiche_logos($logos, $lien, $align) {
	static $num_survol=0;
	global $espace_logos;
	list ($arton, $artoff) = $logos;

	if (!$arton) return $artoff;

	$num_survol++;
	$milieu = "<img src='$arton'"
		. ($align ? " align='$align' " : '') 
		. " name='image$num_survol' border='0' "
		. "alt='image$num_survol'"
		. " hspace='$espace_logos' vspace='$espace_logos' class='spip_logos' />";

	if (!$artoff) return ($lien ? http_href($lien, $milieu) : $milieu);

	$att =	"onmouseover=\"image$num_survol.src='$artoff'\" 
		onmouseout=\"image$num_survol.src='$arton'\"";

	return ($lien ? "<a href='$lien' $att>$milieu</a>" : "<div $att>$milieu</div>");

}

//
// Retrouver le logo d'un objet (et son survol)
//

function calcule_logo($type, $onoff, $id, $id_rubrique, $ff) {
	include_ecrire('inc_logos.php3');

	$table_logos = array (
	'ARTICLE' => 'art',
	'AUTEUR' =>  'aut',
	'BREVE' =>  'breve',
	'MOT' => 'mot',
	'RUBRIQUE' => 'rub',
	'SITE' => 'site'
	);
	$type = $table_logos[$type];
	$nom = strtolower($onoff);
	# attention au cas $id = '0' pour LOGO_SITE_SPIP : utiliser intval()
	while (1) {
		$on = cherche_image_nommee($type . $nom . intval($id));
		if ($on) {
			if ($ff)
			  return  (array('', "$on[1].$on[2]"));
			else {
				$off = ($onoff != 'ON') ? '' :
					cherche_image_nommee($type . 'off' . $id);
				return array ("$on[0]$on[1].$on[2]",
					      ($off ? ("$off[0]$off[1].$off[2]") : ''));
			}
		}
		else if ($id_rubrique) {
			$type = 'rub';
			$id = $id_rubrique;
			$id_rubrique = 0;
		} else if ($id AND $type == 'rub')
			$id = sql_parent($id);
		else return array('','');
	}
}

//
// fonction standard de calcul de la balise #INTRODUCTION
// on peut la surcharger en definissant dans mes_fonctions.php3 :
// function introduction($type,$texte,$chapo,$descriptif) {...}
//
function calcul_introduction ($type, $texte, $chapo='', $descriptif='') {
	if (function_exists("introduction"))
		return introduction ($type, $texte, $chapo, $descriptif);

	switch ($type) {
		case 'articles':
			if ($descriptif)
				return propre($descriptif);
			else if (substr($chapo, 0, 1) == '=')	// article virtuel
				return '';
			else
				return PtoBR(propre(supprimer_tags(couper_intro($chapo."\n\n\n".$texte, 500))));
			break;
		case 'breves':
			return PtoBR(propre(supprimer_tags(couper_intro($texte, 300))));
			break;
		case 'forums':
			return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
			break;
		case 'rubriques':
			if ($descriptif)
				return propre($descriptif);
			else
				return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
			break;
	}
}

function executer_balise_dynamique($nom, $args, $filtres) {
	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
	include_local($file);

	$f = 'balise_' . $nom . '_stat';
	$r = $f($args, $filtres);
	if (!is_array($r))
		return $r;
	else { 
		return
		('<'.'?php 
include_ecrire(\'inc_lang.php3\');
lang_select($GLOBALS["spip_lang"]);
include_local("'
		. $file
		. '");
inclure_balise_dynamique(balise_'
		. $nom
		. '_dyn(\''
		. join("', '", array_map("addslashes", $r))
		. '\'));
	lang_dselect();
?'
		.">");
	}
}

//
// FONCTIONS FAISANT DES APPELS SQL
//

# NB : a l'exception des fonctions pour les balises dynamiques

function calcul_exposer ($id, $type, $reference) {
	static $exposer;
	static $ref_precedente;

	// Que faut-il exposer ? Tous les elements de $reference
	// ainsi que leur hierarchie ; on ne fait donc ce calcul
	// qu'une fois (par squelette) et on conserve le resultat
	// en static.
	if ($reference<>$ref_precedente) {
		$ref_precedente = $reference;

		$exposer = array();
		foreach ($reference as $element=>$id_element) {
			if ($element == 'id_secteur') $element = 'id_rubrique';
			if ($x = table_from_primary($element)) {
				list($table,$hierarchie) = $x;
				$exposer[$element][$id_element] = true;
				if ($hierarchie) {
					list ($id_rubrique) = spip_abstract_fetsel(
array('id_rubrique'), 
array($table),
array("$element=$id_element"));
				$hierarchie = substr(calculer_hierarchie($id_rubrique), 2);
				foreach (split(',',$hierarchie) as $id_rubrique)
					$exposer['id_rubrique'][$id_rubrique] = true;
				}
			}
		}
	}

	// And the winner is...
	return $exposer[$type][$id];
}

function table_from_primary($id) {
	global $tables_principales;
	include_ecrire('inc_serialbase.php3');
	foreach ($tables_principales as $k => $v) {
		if ($v['key']['PRIMARY KEY'] == $id)
			return array($k, array_key_exists('id_rubrique', $v['field']));
	}
	return '';
}

function calcul_generation ($generation) {
	$lesfils = array();
	$result = spip_abstract_select(array('id_rubrique'),
				array('rubriques AS rubriques'),
				array(calcul_mysql_in('id_parent', 
					$generation,
					'')),
				'','','','','','','');
	while ($row = spip_abstract_fetch($result))
		$lesfils[] = $row['id_rubrique'];
	return join(",",$lesfils);
}

function calcul_branche ($generation) {
	if (!$generation) 
		return '0';
	else {
		$branche[] = $generation;
		while ($generation = calcul_generation ($generation))
			$branche[] = $generation;
		return join(",",$branche);
	}
}

// fonction appelee par la balise #LOGO_DOCUMENT
function calcule_document($id_document, $doubdoc, &$doublons) {
	if (!$id_document) return '';
	if ($doubdoc && $id_document) $doublons["documents"] .= ', ' . $id_document;

	if (!($row = spip_abstract_select(array('id_type', 'id_vignette', 'fichier', 'mode'), array('documents AS documents'), array("id_document = $id_document"))))
// pas de document. Ne devrait pas arriver
		return ''; 

	list($id_type, $id_vignette, $fichier, $mode) = spip_abstract_fetch($row);
	if ($id_vignette) {
		if ($res = spip_abstract_select(array('fichier'), array('documents AS documents'), array("id_document = $id_vignette"))) {
			list($vignette) = spip_abstract_fetch($res);
			if (@file_exists($vignette))
				return generer_url_document($id_vignette);
				# return ($fichier); # en std g_u_d fait ca
		}
	} else if ($mode == 'vignette') 
		return generer_url_document($id_document);
		# return $fichier; # en std g_u_d fait ca

// calcul de l'extension par tous les moyens
	if ($id_type) {
		list($ext) = spip_abstract_fetch(spip_abstract_select(array('extension'), array('types_documents AS documents'), array("id_type = " . intval($id_type))));
	} else {
		eregi('\.([a-z0-9]+)$', $fichier, $regs);
		$ext = $regs[1];
	}
// Pas de vignette mais une extension:
// prendre la vignette de celle-ci dans IMG/icones sauf si on peut faire mieux
	$formats = ','.lire_meta('formats_graphiques').',';
	if ((strpos($formats, ",$ext,") === false) OR
	!$fichier OR (lire_meta("creer_preview") != 'oui')) {
		return vignette_par_defaut($ext ? $ext : 'txt', false);
	}
// on peut faire mieux dans le cas des images: une previsualisation
// on devrait verifier que le fichier existe dans IMG/vignette
// et sinon lancer creer_vignette (qui fera un UPDATE sur spip_documents)
// mais on risque de d?passer le temps alloue au processus
	return 'spip_image.php3?vignette='.rawurlencode(
		str_replace('../', '', $fichier));
}


// fonction appelee par la balise #EMBED
function calcule_embed_document($id_document, $filtres, &$doublons, $doubdoc) {
	if ($doubdoc && $id_document) $doublons["documents"] .= ', ' . $id_document;
	return embed_document($id_document, $filtres, false);
}

// fonction appelee par la balise #NOTES
function calculer_notes() {
	$r = $GLOBALS["les_notes"];
	$GLOBALS["les_notes"] = "";
	$GLOBALS["compt_note"] = 0;
	$GLOBALS["marqueur_notes"] ++;
	return $r;
}

# retourne la profondeur d'une rubrique

function sql_profondeur($id) {
	$n = 0;
	while ($id) {
		$n++;
		$id = sql_parent($id);
	}
	return $n;
}


function sql_parent($id_rubrique) {
	$row = spip_abstract_fetsel(array(id_parent), 
			array('rubriques'), 
			array("id_rubrique=" . intval($id_rubrique)));
	return $row['id_parent'];
}

function sql_rubrique($id_article) {
	$row = spip_abstract_fetsel(array('id_rubrique'),
			array('articles'),
			array("id_article=" . intval($id_article)));
	return $row['id_rubrique'];
}

function sql_auteurs($id_article, $table, $id_boucle, $serveur='') {
	$auteurs = "";
	if ($id_article) {
		$result_auteurs = spip_abstract_select(array('auteurs.nom', 'auteurs.email'),
			array('auteurs AS auteurs',
				'auteurs_articles AS lien'), 
			array("lien.id_article=$id_article",
				"auteurs.id_auteur=lien.id_auteur"),
			'','','','',1, 
			$table, $id_boucle, $serveur);

		while($row_auteur = spip_abstract_fetch($result_auteurs, $serveur)) {
			$nom_auteur = typo($row_auteur["nom"]);
			$email_auteur = $row_auteur["email"];
			if ($email_auteur) {
				$auteurs[] = "<a href=\"mailto:$email_auteur\">$nom_auteur</a>";
			} else {
				$auteurs[] = "$nom_auteur";
			}
		}
	}
	return (!$auteurs) ? "" : join($auteurs, ", ");
}

function sql_petitions($id_article, $table, $id_boucle, $serveur, &$Cache) {
	$retour = spip_abstract_fetsel(
			array('id_article'),
			array('petitions'),
			array("id_article=".intval($id_article)),
			'','','','',1, 
			$table, $id_boucle, $serveur);

	# cette page est invalidee par toute petition
	if ($retour AND $Cache)
		$Cache['petition']['petition'] = 1;

	return ($retour ? $id_article : '');
}

# retourne le chapeau d'un article, et seulement s'il est publie

function sql_chapo($id_article) {
	return spip_abstract_fetsel(array('chapo'),
		array('articles'),
		array("id_article=".intval($id_article),
		"statut='publie'"));
}

// Calcul de la rubrique associee a la requete
// (selection de squelette specifique par id_rubrique & lang)

function sql_rubrique_fond($contexte, $lang) {

	if ($id = intval($contexte['id_rubrique'])) {
		$row = spip_abstract_fetsel(array('lang'),
					    array('rubriques'),
					    array("id_rubrique=$id"));
		if ($row['lang'])
			$lang = $row['lang'];
		return array ($id, $lang);
	}

	if ($id  = intval($contexte['id_breve'])) {
		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
			array('breves'), 
			array("id_breve=$id"));
		$id_rubrique_fond = $row['id_rubrique'];
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}

	if ($id = intval($contexte['id_syndic'])) {
		$row = spip_abstract_fetsel(array('id_rubrique'),
			array('syndic'),
			array("id_syndic=$id"));
		$id_rubrique_fond = $row['id_rubrique'];
		$row = spip_abstract_fetsel(array('lang'),
			array('rubriques'),
			array("id_rubrique='$id_rubrique_fond'"));
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}

	if ($id = intval($contexte['id_article'])) {
		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
			array('articles'),
			array("id_article=$id"));
		$id_rubrique_fond = $row['id_rubrique'];
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}
}

?>
--- NEW FILE: breve-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_breve_principal(BREVES) {id_breve}>

<html lang="#LANG">
<head>
<title>#TITRE</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]

<!-- Menu de navigation rubriques -->

<div class="menu">
<ul class="rubriques">
<BOUCLE_rubrique(RUBRIQUES) {id_rubrique}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
</li>
<BOUCLE_autres_rubriques(RUBRIQUES) {racine} {exclus} {par titre}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_autres_rubriques>
</BOUCLE_rubrique>
</ul>
</div>


<!-- Menu de navigation mots-cles -->

<B_mots>
<div class="menu">
<ul class="divers" title="<:mots_clefs:>">
<BOUCLE_mots(MOTS) {id_article} {par titre}>
<li>
<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_breves_mots>
	<ul class="menu-liste">
<BOUCLE_breves_mots(BREVES) {id_mot} {par hasard} {0,4}>
	<li class="menu-item"><a href="#URL_BREVE">#TITRE</a></li>
</BOUCLE_breves_mots>
	</ul>
</B_breves_mots>
</li>
</BOUCLE_mots>
</ul>
</div>
</B_mots>


<!-- Articles dans le meme secteur -->

<B_articles_secteur>

<div class="menu">
<div class="breves" title="<:derniers_articles:>">
	<div class="menu-titre">
	<:derniers_articles:>
	</div>
	<ul>
<BOUCLE_articles_secteur(ARTICLES) {id_secteur} {par date} {inverse} {0,5}>
	<li class="menu-item">
	<a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a>
	</li>
</BOUCLE_articles_secteur>
	</ul>
</div>
</div>

</B_articles_secteur>


</div>

<!-- Contenu : corps de la breve -->

<div class="contenu" id="principal">

<div id="cartouche">
[(#LOGO_BREVE|left)]
<h1 class="titre-texte">#TITRE</h1>
[(#DATE|nom_jour)] [(#DATE|affdate).]
</div>

	<div class="encart">

	<!-- Breves dans la meme rubrique -->

	<B_breves_rubrique>

	<div class="menu">
	<div class="breves" title="<:meme_rubrique:>">
		<h1 class="structure"><:meme_rubrique:></h1>
		<div class="menu-titre">
		<:autres_breves:>
		</div>
		<ul>
	<BOUCLE_breves_rubrique(BREVES) {id_rubrique} {exclus} {par date} {inverse} {0,8}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves_rubrique>
		</ul>
	</div>
	</div>

	</B_breves_rubrique>

	</div>


[<div class="texte">(#TEXTE)</div>]
[<div class="chapo"><:voir_en_ligne:>: <a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a>.</div>]
[<div class="notes">(#NOTES)</div>]

<br>


<!-- Forums -->

[<div class="forum-repondre"><B><A  HREF="forum.php3?(#PARAMETRES_FORUM)"><:repondre_breve:></A></B></div>]
<br>

<h1 class="structure"><:forum:></h1>

<B_forums>
<ul class="forum-total">

<BOUCLE_forums(FORUMS){id_breve}{par date}{inverse}>

<li>
<div class="forum-fil">
<div class="forum">
<a name="forum#ID_FORUM"></a>
<div class="forum-chapo">
<div class="forum-titre">#TITRE</div>
[(#DATE|affdate)][, <:par_auteur:> <A HREF="mailto:#EMAIL">(#NOM)</A>]
</div>
<div class="forum-item">
#TEXTE
[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
</div>
</div>

<B_forums_fils>
	<ul>
	<BOUCLE_forums_fils(FORUMS){id_parent}{par date}>

	<li>
	<div class="forum">
	<a name="forum#ID_FORUM"></a>
	<div class="forum-chapo">
	<div class="forum-titre">#TITRE</div>
	[(#DATE|affdate)][, par <A HREF="mailto:#EMAIL">(#NOM)</A>]
	</div>
	<div class="forum-item">
	#TEXTE
	[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
	[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
	</div>

	</div>

	<BOUCLE_Forums_Boucle(boucle_forums_fils)></BOUCLE_Forums_Boucle>
	</li>

	</BOUCLE_forums_fils>
	</ul>
</B_forums_fils>

</div>
</li>
</BOUCLE_forums>

</ul>
</B_forums>

</div>
#FORMULAIRE_ADMIN
</body></html>
</BOUCLE_breve_principal>
<:aucune_breve:>
<//B_breve_principal>

--- NEW FILE: spip_pass.php3 ---
<?php

include ("ecrire/inc_version.php3");

include_ecrire("inc_meta.php3");
include_ecrire("inc_presentation.php3");
include_ecrire("inc_session.php3");
include_ecrire("inc_filtres.php3");
include_ecrire("inc_texte.php3");
include_ecrire("inc_meta.php3");
include_ecrire("inc_mail.php3");
include_ecrire("inc_acces.php3");
include_local("inc-public-global.php3"); 

// Ce fichier est celui d'une balise dynamique qui s'ignore.

function formulaire_oubli_dyn($p, $oubli)
{

$erreur = '';

// au 3e appel la variable P est positionnee par le script lui-meme
// et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
if ($p = addslashes($p)) {
	$res = spip_query ("SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut<>'5poubelle' AND pass<>''");
	if (!$row = spip_fetch_array($res)) 
		$erreur = _T('pass_erreur_code_inconnu');
	else {
		if ($oubli) {
			$mdpass = md5($oubli);
			$htpass = generer_htpass($oubli);
			spip_query ("UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
				cookie_oubli='' WHERE cookie_oubli='$p'");

			$login = $row['login'];
			$erreur = "<b>"._T('pass_nouveau_enregistre')."</b>".
			"<p>"._T('pass_rappel_login', array('login' => $login));
		}
	}
 } else { 
  // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
  if ($oubli) {
	if (email_valide($oubli)) {
		$email = addslashes($oubli);
		$res = spip_query("SELECT * FROM spip_auteurs WHERE email ='$email'");
		if ($row = spip_fetch_array($res)) {
			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
				$erreur = _T('pass_erreur_acces_refuse');
			else {
				$cookie = creer_uniqid();
				spip_query("UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'");

				if (envoyer_mail($email,
						 "[" . lire_meta("nom_site") .'] ' ._T('pass_oubli_mot'),
						 _T('pass_mail_passcookie',
						    array('nom_site_spip' => lire_meta("nom_site"),
							  'adresse_site' => lire_meta("adresse_site"), 
							  'cookie' => $cookie))))
					$erreur = _T('pass_recevoir_mail');
				else
					$erreur = _T('pass_erreur_probleme_technique');
			}
		}
		else
			$erreur = _T('pass_erreur_non_enregistre', array('email_oubli' => htmlspecialchars($oubli)));
	} else {
		$erreur = _T('pass_erreur_non_valide', array('email_oubli' => htmlspecialchars($oubli)));
	}
  }
 }
 return $erreur ? $erreur : array('formulaire_oubli', 0, array('p' => $p));
}

utiliser_langue_site();
utiliser_langue_visiteur();
install_debut_html(_T('pass_mot_oublie'));
inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
install_fin_html();
?>

--- NEW FILE: formulaire_recherche-dist.html ---
<form action='[(#HTTP_VARS{lien})]' method='get' class='formrecherche'>
	<div>
		<input	type='text'
			id='formulaire_recherche'
			class='formrecherche'
			name='recherche'
			value="[(#HTTP_VARS{recherche})]" />
	</div>
</form>

--- NEW FILE: htaccess-html.txt ---
###########################################################
# Fichier .htaccess pour les URLs 'html' ; a installer    #
# si vous reglez $type_urls='html'                        #
# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
# (fichier associe : inc-urls-html.php3)                  #
###########################################################

RewriteEngine On

### si votre site est en sous-domaine, preciser ci-dessous
# RewriteBase /sous/domaine/

RewriteRule ^rubrique([0-9]+)\.html$	rubrique.php3?id_rubrique=$1 [QSA,L]
RewriteRule ^article([0-9]+)\.html$		article.php3?id_article=$1 [QSA,L]
RewriteRule ^breve([0-9]+)\.html$		breve.php3?id_breve=$1 [QSA,L]
RewriteRule ^mot([0-9]+)\.html$			mot.php3?id_mot=$1 [QSA,L]
RewriteRule ^auteur([0-9]+)\.html$		auteur.php3?id_auteur=$1 [QSA,L]



From mose at berlios.de  Thu Jan 13 16:48:47 2005
From: mose at berlios.de (mose at berlios.de)
Date: Thu, 13 Jan 2005 16:48:47 +0100
Subject: [Spip-carto-cvs] CVSROOT modules,1.2,1.3
Message-ID: <200501131548.j0DFmlNM020906@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv20892

Modified Files:
	modules 
Log Message:
adaptation du nom du module principal

Index: modules
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/modules,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- modules	11 Jan 2005 18:08:39 -0000	1.2
+++ modules	13 Jan 2005 15:48:45 -0000	1.3
@@ -25,4 +25,6 @@
 # can be useful for creating a module that consists of many directories
 # spread out over the entire source repository.
 
-spip-carto spip-carto
+spipcarto  spipcarto
+spip-carto spipcarto
+



From stef at berlios.de  Thu Jan 13 16:54:10 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:10 +0100
Subject: [Spip-carto-cvs] spip-carto - New directory
Message-ID: <200501131554.j0DFsANM021311@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto
In directory sheep:/tmp/cvs-serv21305/spip-carto

Log Message:
Directory /cvsroot/spip-carto/spip-carto added to the repository




From stef at berlios.de  Thu Jan 13 16:54:46 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:46 +0100
Subject: [Spip-carto-cvs] spip-carto/oo - New directory
Message-ID: <200501131554.j0DFskNM021423@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/oo
In directory sheep:/tmp/cvs-serv21331/oo

Log Message:
Directory /cvsroot/spip-carto/spip-carto/oo added to the repository




From stef at berlios.de  Thu Jan 13 16:54:46 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:46 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/oo - New directory
Message-ID: <200501131554.j0DFskNM021414@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/oo
In directory sheep:/tmp/cvs-serv21331/ecrire/oo

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire/oo added to the repository




From stef at berlios.de  Thu Jan 13 16:54:46 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:46 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/upload - New directory
Message-ID: <200501131554.j0DFskNM021420@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/upload
In directory sheep:/tmp/cvs-serv21331/ecrire/upload

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire/upload added to the repository




From stef at berlios.de  Thu Jan 13 16:54:45 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:45 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/js - New directory
Message-ID: <200501131554.j0DFsjNM021408@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/js
In directory sheep:/tmp/cvs-serv21331/ecrire/js

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire/js added to the repository




From stef at berlios.de  Thu Jan 13 16:54:46 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:46 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/plugins - New directory
Message-ID: <200501131554.j0DFskNM021417@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/plugins
In directory sheep:/tmp/cvs-serv21331/ecrire/plugins

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire/plugins added to the repository




From stef at berlios.de  Thu Jan 13 16:54:43 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:43 +0100
Subject: [Spip-carto-cvs] spip-carto/CACHE - New directory
Message-ID: <200501131554.j0DFshNM021370@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/CACHE
In directory sheep:/tmp/cvs-serv21331/CACHE

Log Message:
Directory /cvsroot/spip-carto/spip-carto/CACHE added to the repository




From stef at berlios.de  Thu Jan 13 16:54:44 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:44 +0100
Subject: [Spip-carto-cvs] spip-carto/IMG/icones - New directory
Message-ID: <200501131554.j0DFsiNM021383@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/IMG/icones
In directory sheep:/tmp/cvs-serv21331/IMG/icones

Log Message:
Directory /cvsroot/spip-carto/spip-carto/IMG/icones added to the repository




From stef at berlios.de  Thu Jan 13 16:54:44 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:44 +0100
Subject: [Spip-carto-cvs] spip-carto/IMG - New directory
Message-ID: <200501131554.j0DFsiNM021376@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/IMG
In directory sheep:/tmp/cvs-serv21331/IMG

Log Message:
Directory /cvsroot/spip-carto/spip-carto/IMG added to the repository




From stef at berlios.de  Thu Jan 13 16:54:44 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:44 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire - New directory
Message-ID: <200501131554.j0DFsiNM021396@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire
In directory sheep:/tmp/cvs-serv21331/ecrire

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire added to the repository




From stef at berlios.de  Thu Jan 13 16:54:44 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:44 +0100
Subject: [Spip-carto-cvs] spip-carto/IMG/icones_barre - New directory
Message-ID: <200501131554.j0DFsiNM021390@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/IMG/icones_barre
In directory sheep:/tmp/cvs-serv21331/IMG/icones_barre

Log Message:
Directory /cvsroot/spip-carto/spip-carto/IMG/icones_barre added to the repository




From stef at berlios.de  Thu Jan 13 16:54:45 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:45 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/data - New directory
Message-ID: <200501131554.j0DFsjNM021402@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/data
In directory sheep:/tmp/cvs-serv21331/ecrire/data

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire/data added to the repository




From stef at berlios.de  Thu Jan 13 16:54:45 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:45 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/lang - New directory
Message-ID: <200501131554.j0DFsjNM021411@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/lang
In directory sheep:/tmp/cvs-serv21331/ecrire/lang

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire/lang added to the repository




From stef at berlios.de  Thu Jan 13 16:54:45 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:54:45 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/img_pack - New directory
Message-ID: <200501131554.j0DFsjNM021405@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/img_pack
In directory sheep:/tmp/cvs-serv21331/ecrire/img_pack

Log Message:
Directory /cvsroot/spip-carto/spip-carto/ecrire/img_pack added to the repository




From stef at berlios.de  Thu Jan 13 16:57:40 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 16:57:40 +0100
Subject: [Spip-carto-cvs] spip-carto spip_cal.php3,NONE,1.1 sommaire.php3,NONE,1.1 typographie.css,NONE,1.1 resume-dist.html,NONE,1.1 spip_pass.php3,NONE,1.1 spip_background.php3,NONE,1.1 spip_cache.php3,NONE,1.1 recherche-dist.html,NONE,1.1 sommaire-dist.html,NONE,1.1 puce_rtl.gif,NONE,1.1 resume.php3,NONE,1.1 spip_admin.css,NONE,1.1 spip_image.php3,NONE,1.1 site-dist.html,NONE,1.1 rubrique.php3,NONE,1.1 spip_redirect.php3,NONE,1.1 site.php3,NONE,1.1 recherche.php3,NONE,1.1 spip_acces_doc.php3,NONE,1.1 spip_style.css,NONE,1.1 sommaire_texte.php3,NONE,1.1 spip_barre.js,NONE,1.1 spip_inscription.php3,NONE,1.1 spip_login.php3,NONE,1.1 rubrique-dist.html,NONE,1.1 spip_carto.php,NONE,1.1 puce.gif,NONE,1.1 sommaire_texte-dist.html,NONE,1.1 spip_image_reduite.php3,NONE,1.1 spip_test_dirs.php3,NONE,1.1 spip_cookie.php3,NONE,1.1
Message-ID: <200501131557.j0DFveNM021786@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto
In directory sheep:/tmp/cvs-serv21755

Added Files:
	spip_cal.php3 sommaire.php3 typographie.css resume-dist.html 
	spip_pass.php3 spip_background.php3 spip_cache.php3 
	recherche-dist.html sommaire-dist.html puce_rtl.gif 
	resume.php3 spip_admin.css spip_image.php3 site-dist.html 
	rubrique.php3 spip_redirect.php3 site.php3 recherche.php3 
	spip_acces_doc.php3 spip_style.css sommaire_texte.php3 
	spip_barre.js spip_inscription.php3 spip_login.php3 
	rubrique-dist.html spip_carto.php puce.gif 
	sommaire_texte-dist.html spip_image_reduite.php3 
	spip_test_dirs.php3 spip_cookie.php3 
Log Message:
proto

--- NEW FILE: spip_cal.php3 ---
<?php

include ("ecrire/inc_version.php3");

include_ecrire("inc_filtres.php3");
include_ecrire("inc_lang.php3");
include_ecrire("inc_texte.php3");
include_ecrire("inc_charsets.php3");
include_ecrire("inc_meta.php3");
include_ecrire("inc_admin.php3");
include_ecrire("inc_acces.php3");

/*
function ligne_x ($texte) {
	if (ereg("^BEGIN", $texte)) echo "<br>";
	echo $texte."<br>";
}
*/
function ligne ($texte) {
	echo filtrer_ical($texte)."\n";
}

$nom_site = lire_meta("nom_site");
$adresse_site = lire_meta("adresse_site");

// securite
unset($id_utilisateur);
$id_auteur = intval($id);

// verifier la cle
if (verifier_low_sec($id_auteur, $cle, 'ical')) {
	$query = "SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur";
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$id_utilisateur=$row['id_auteur'];
		$nom_utilisateur=$row['nom'];
		$statut_utilisateur=$row['statut'];
		$langue_utilisateur=$row['lang'];
	}
}
if (!$id_utilisateur) {
	echo _T('info_acces_interdit');
	exit;
}

lang_select($langue_utilisateur);

@header("content-type:text/calendar; charset=utf-8");

ligne ("BEGIN:VCALENDAR");
ligne ("CALSCALE:GREGORIAN");
ligne ("X-WR-CALNAME;VALUE=TEXT:$nom_site / $nom_utilisateur");
ligne ("X-WR-RELCALID:cal$id_utilisateur @ $adresse_site");


// rendez-vous
$result_messages=spip_query("SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE ((lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message) OR messages.type='affich') AND messages.rv='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure");
while($row=spip_fetch_array($result_messages)){
	$id_message=$row['id_message'];
	$date_heure=$row["date_heure"];
	$date_heure_fin=$row["date_fin"];
	//$titre=typo($row["titre"]);
	$titre = $row["titre"];
	$texte = $row["texte"];
	$type=$row["type"];

	if ($type == 'normal') {
		$le_type = _T('info_message_2');
		$result_auteurs=spip_query("SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)");
		while($row_auteur=spip_fetch_array($result_auteurs)){
			$id_auteur=$row_auteur['id_auteur'];
			$nom_auteur=$row_auteur['nom'];
			$email = $row_auteur ['email'];

			if ($id_auteur != $id_utilisateur) $titre = $titre." - ".$nom_auteur;
			
			if ($id_auteur == $id_utilisateur) ligne ("ORGANIZER:$nom_auteur <$email>");
			else  ligne ("ATTENDEE:$nom_auteur <$email>");
		}
	}
	else if ($type == 'pb') {
		$le_type = _T('info_pense_bete');
	}
	else if ($type == 'affich') {
		$le_type = _T('info_annonce');
		$titre = "[$nom_site] $titre";
	}

	ligne ("BEGIN:VEVENT");
	ligne ("SUMMARY:".$titre);
	ligne ("DESCRIPTION:$texte");
	ligne ("UID:mess$id_message @ $adresse_site");
	ligne ("DTSTAMP:".date_ical($date_heure));
	ligne ("DTSTART:".date_ical($date_heure));
	if ($date_heure_fin > $date_heure) ligne ("DTEND:".date_ical($date_heure_fin));

	ligne ("CATEGORIES:$le_type");
	ligne("URL:$adresse_site/ecrire/message.php3?id_message=$id_message");
	
	ligne ("END:VEVENT");
	
}

// todo
$result_messages=spip_query("SELECT messages.* FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur='$id_utilisateur' AND lien.id_message=messages.id_message AND messages.type='pb' AND messages.rv!='oui' AND messages.statut='publie' GROUP BY messages.id_message ORDER BY messages.date_heure");
while($row=spip_fetch_array($result_messages)){
	$id_message=$row['id_message'];
	$date_heure=$row["date_heure"];
	$titre = $row["titre"];
	$texte = $row["texte"];
	$type=$row["type"];

	if ($type == 'normal') {
		$le_type = _T('info_message_2');
		$result_auteurs=spip_query("SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)");
		while($row_auteur=spip_fetch_array($result_auteurs)){
			$id_auteur=$row_auteur['id_auteur'];
			$nom_auteur=$row_auteur['nom'];
			$email = $row_auteur ['email'];

			if ($id_auteur != $id_utilisateur) $titre = $titre." - ".$nom_auteur;
			
			if ($id_auteur == $id_utilisateur) ligne ("ORGANIZER:$nom_auteur <$email>");
			else  ligne ("ATTENDEE:$nom_auteur <$email>");
		}
	}
	else if ($type == 'pb') {
		$le_type = _T('info_pense_bete');
	}
	else if ($type == 'affich') {
		$le_type = _T('info_annonce');
		$titre = "[$nom_site] $titre";
	}
	
	ligne ("BEGIN:VTODO");
	ligne ("SUMMARY:".$titre);
	ligne ("DESCRIPTION:$texte");
	ligne ("UID:mess$id_message @ $adresse_site");
	ligne ("DTSTAMP:".date_ical($date_heure));
	ligne ("DTSTART:".date_ical($date_heure));
	ligne ("CATEGORIES:$le_type");
	ligne ("URL:$adresse_site/ecrire/message.php3?id_message=$id_message");
	ligne ("END:VTODO");

}

// Articles et breves proposes
$titres = Array();
$result_articles = spip_query("SELECT id_article, titre, date FROM spip_articles WHERE statut = 'prop'");
while($row=spip_fetch_array($result_articles)){
	$id_article=$row['id_article'];
	$titre = supprimer_numero($row['titre']);
	$titres[] = $titre;
	$date_heure = $row['date'];
	$nb_articles ++;
	ligne ("BEGIN:VEVENT");
	ligne ("SUMMARY:[$nom_site] $titre ("._T('info_article_propose').")");
	ligne ("UID:article$id_article @ $adresse_site");
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("DTSTART;VALUE=DATE:".date ("Ymd", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("CATEGORIES:"._T('info_article_propose'));
	ligne("URL:$adresse_site/ecrire/articles.php3?id_article=$id_article");
	ligne ("END:VEVENT");
}

$result_articles = spip_query("SELECT id_breve, titre, date_heure FROM spip_breves WHERE statut = 'prop'");
while($row=spip_fetch_array($result_articles)){
	$id_breve=$row['id_breve'];
	$titre = supprimer_numero($row['titre']);
	$titres[] = $titre;
	$date_heure = $row['date_heure'];
	$nb_breves++;
	ligne ("BEGIN:VEVENT");
	ligne ("SUMMARY:[$nom_site] $titre ("._T('item_breve_proposee').")");
	ligne ("UID:breve$id_breve @ $adresse_site");
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("DTSTART;VALUE=DATE:".date ("Ymd", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("CATEGORIES:"._T('item_breve_proposee'));
	ligne ("URL:$adresse_site/ecrire/breves_voir.php3?id_breve=$id_breve");
	ligne ("END:VEVENT");

}

if ($nb_articles + $nb_breves > 0) {
	if ($nb_articles > 0) $titre_prop[] = _T('info_articles_proposes').": ".$nb_articles;
	if ($nb_breves > 0) $titre_prop[] = _T('info_breves_valider').": ".$nb_breves;
	$titre = join($titre_prop," / ");
	ligne ("BEGIN:VTODO");
	ligne ("SUMMARY:[$nom_site] $titre");
	ligne ("UID:prop @ $adresse_site");
	$texte = join($titres," / ");
	ligne ("DESCRIPTION:$texte");
	
	$today=getdate(time());
	$jour = $today["mday"];
	$mois=$today["mon"];
	$annee=$today["year"];
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
	ligne ("DTSTART:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
	ligne ("CATEGORIES:"._T('icone_a_suivre'));
	ligne ("URL:$adresse_site/ecrire/");
	ligne ("END:VTODO");
}


// Nouveaux messages

$result_messages = spip_query("SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien WHERE lien.id_auteur=$id_utilisateur AND vu='non' AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message");
while($row=spip_fetch_array($result_messages)){
	$id_message=$row['id_message'];
	$date_heure=$row["date_heure"];
	$titre = $row["titre"];
	$texte = $row["texte"];
	$type=$row["type"];

	if ($type == 'normal') {
		$le_type = _T('info_message_2');
		$result_auteurs=spip_query("SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_messages AS lien WHERE (lien.id_message='$id_message' AND lien.id_auteur=auteurs.id_auteur)");
		while($row_auteur=spip_fetch_array($result_auteurs)){
			$id_auteur=$row_auteur['id_auteur'];
			$nom_auteur = $row_auteur['nom'];
			$email = $row_auteur ['email'];

			if ($id_auteur != $id_utilisateur) $titre = $nom_auteur." - ".$titre;
			
			if ($id_auteur == $id_utilisateur) ligne ("ORGANIZER:$nom_auteur <$email>");
			else  ligne ("ATTENDEE:$nom_auteur <$email>");
		}
		$query_forum = "SELECT * FROM spip_forum WHERE statut='perso' AND id_message='$id_message' ORDER BY date_heure DESC LIMIT 0,1";
		$result_forum = spip_query($query_forum);
		if ($row_forum = spip_fetch_array($result_forum)) {
			$date_heure = $row_forum["date_heure"];
			$texte = $row_forum["texte"];
			$titre = $row_forum["titre"];
			$id_auteur = $row_forum["id_auteur"];

			$result_auteurs2 = spip_query("SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur");
			if ($row_auteur2 = spip_fetch_array($result_auteurs2)){
				$nom_auteur = $row_auteur2['nom'];
				$email = $row_auteur2 ['email'];
				
				$titre = $nom_auteur." - ".$titre;
			}
		}
	}
	else if ($type == 'pb') {
		$le_type = _T('info_pense_bete');
	}
	else if ($type == 'affich') {
		$le_type = _T('info_annonce');
		$titre = "[$nom_site] $titre";
	}

	
	
	ligne ("BEGIN:VTODO");
	ligne ("SUMMARY:".$titre);
	ligne ("DESCRIPTION:$texte");
	ligne ("UID:nouv_mess$id_message @ $adresse_site");
	ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("DTSTART:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
	ligne ("CATEGORIES:$le_type");
	ligne("URL:$adresse_site/ecrire/message.php3?id_message=$id_message");
	ligne ("END:VTODO");
	
}

// Messages de forum a valider
if ($statut_utilisateur == "0minirezo") {

	$query_forum = "SELECT * FROM spip_forum WHERE statut = 'prop'";
	$result_forum = spip_query($query_forum);

	while($row=spip_fetch_array($result_forum)){
		$nb_forum ++;
	
		$id_forum=$row['id_forum'];
		$date_heure = $row['date_heure'];
		$titre = $row['titre'];
		$texte = $row['texte'];
		$auteur = $row['auteur'];
		$email_auteur = $row['email_auteur'];
		if ($email_auteur) $email_auteur = "<$email_auteur>";
		
		ligne ("BEGIN:VEVENT");
		ligne ("SUMMARY:[$nom_site] $titre "._T('icone_forum_suivi'));
		ligne ("DESCRIPTION:$texte\r$auteur $email_auteur");
		ligne ("UID:forum$id_forum @ $adresse_site");
		ligne ("DTSTAMP:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
		ligne ("DTSTART:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure),0,mois($date_heure),jour($date_heure),annee($date_heure))));
		ligne ("DTEND:".date ("Ymd\THis", mktime (heures($date_heure),minutes($date_heure)+60,0,mois($date_heure),jour($date_heure),annee($date_heure))));
		ligne ("CATEGORIES:"._T('icone_forum_suivi'));
		ligne("URL:$adresse_site/ecrire/controle_forum.php3");
		ligne ("END:VEVENT");


		
	}

	if ($nb_forum > 0) {
		ligne ("BEGIN:VTODO");
		ligne ("SUMMARY:[$nom_site] "._T('icone_forum_suivi').": $nb_forum");
		ligne ("UID:forum @ $adresse_site");
		
		$today=getdate(time());
		$jour = $today["mday"];
		$mois=$today["mon"];
		$annee=$today["year"];
		ligne ("DTSTAMP:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
		ligne ("DTSTART:".date ("Ymd\THis", mktime (12,0,0,$mois,$jour,$annee)));
		ligne ("CATEGORIES:"._T('icone_forum_suivi'));
		ligne("URL:$adresse_site/ecrire/controle_forum.php3");
		ligne ("END:VTODO");
	}
}




ligne ("END:VCALENDAR");


?>
--- NEW FILE: sommaire.php3 ---
<?php
$fond = "sommaire";
$delais = 2 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: typographie.css ---

/*
 * Correction des styles HTML par defaut
 */

.structure {
	display: none;
}
h1,h2,h3,h4 {
	margin-top: 0em;
	margin-bottom: 0em;
	font-size: 100%;
	font-weight: normal;
}

/*
 * Styles generaux
 */

/* bien regler la marge (bugs IE) */
body { background: white; margin: 10px; }
a { text-decoration: none; color: #505050; }
a:hover { text-decoration: none; color: #303030; background: #e8e8e8; }
a.spip_out { text-decoration: none; color: #a02020; }
a.spip_in, a.spip_url { text-decoration: none; color: #2020a0; }
a.spip_glossaire { text-decoration: none; color: #20a020; }

.chapo {
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
	font-weight: bold;
	text-align: justify;
	font-size: 105%;
}
.texte, .texte p.spip {
	font-family: Georgia, Garamond, Times, serif;
	text-align: justify;
}
.ps {
	font-family: Georgia, Garamond, Times, serif;
	text-align: justify;
	font-size: 85%;
}
.notes {
	font-family: Georgia, Garamond, Times, serif;
	text-align: left;
	font-size: 80%;
}

/*
 * Ici les styles pour le contenu
 */

.contenu h1,h2 {
	font-size: 120%;
	font-weight: bold;
}
.contenu h1,h2.titre-extrait {
	font-size: 160%;
	font-weight: bold;
}
.contenu h1,h2.titre-texte {
	font-size: 190%;
	font-weight: bold;
}
.contenu .surtitre {
	font-size: 110%;
	font-weight: bold;
	font-variant: small-caps;
}
.contenu .detail {
	font-size: 80%;
	color: #303030;
}
.extrait {
	border: groove 2px #a0a0a0;
	padding: 1em;
	font-size: 85%;
}


/*
 * Disposition a l'ecran
 */

#principal {
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
}

#plan {
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
}

#navigation {
	font-family: Verdana, Arial, Helvetica, sans-serif;
}

.encart {
	font-family: Verdana, Arial, Helvetica, sans-serif;
}


--- NEW FILE: resume-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] </title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]

<!-- Liens des forums -->
<B_forums_liens>
<div class="menu" title="<:derniers_messages_forum:>">
	<h1 class="structure"><:messages_recents:></h1>
	<div class="forums">
	<div class="menu-titre">
	<:derniers_commentaires:>
	</div>
	<ul>
<BOUCLE_forums_liens(FORUMS){plat}{par date}{inverse}{0,15}>
        <li class="menu-item">[<i>(#DATE|affdate_court)</i>:]
        <a href="#URL_FORUM">#TITRE</a>
        </li>
</BOUCLE_forums_liens>
	</ul>
	</div>
</div>
</B_forums_liens>


</div>

<!-- Une : articles les plus populaires -->

<div id="principal" class="contenu">

<h1 class="structure"><:articles_populaires:></h1>

<BOUCLE_article_un(ARTICLES) {par popularite} {inverse} {0,2}>
	[(#LOGO_ARTICLE_RUBRIQUE|right|#URL_ARTICLE)]
	[<div class="surtitre">(#SURTITRE)</div>]
	<h2 class="titre-extrait"><a href="#URL_ARTICLE">#TITRE</a></h2>
	[<div class="surtitre">(#SOUSTITRE)</div>]
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_un><:par_auteur:> <BOUCLE_auteurs_un(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_un>
	[<br><:popularite:>&nbsp;: <span class="important">(#POPULARITE)</span> %]
	</div>
	[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
	<br>
</BOUCLE_article_un>


	<div class="encart">

	<!-- <:sur_web:> -->

	<h1 class="structure"><:nouveautes_web:></h1>

	<B_syndic>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_syndic(SYNDIC_ARTICLES) {par date} {inverse} {0,15}>
		<li class="menu-item">
		[<i>(#DATE|affdate_court)</i>:]
		<a href="#URL_ARTICLE">[(#TITRE*)]</a>
		</li>
	</BOUCLE_syndic>
		</ul>
	</div>
	</div>
	</B_syndic>

	</div>


<h1 class="structure"><:articles_populaires:> (<:suite:>)</h1>

<!-- Articles les plus populaires (suite) -->

<BOUCLE_articles_populaires(ARTICLES) {par popularite} {inverse} {2,8}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_recents><:par_auteur:> <BOUCLE_auteurs_recents(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_recents><br>
	<:popularite:>&nbsp;: <span class="important">#POPULARITE</span> %
	</div>
	<br>
</BOUCLE_articles_populaires>


</div>
#FORMULAIRE_ADMIN
</body>
</html>



--- NEW FILE: spip_pass.php3 ---
<?php

include ("ecrire/inc_version.php3");

include_ecrire("inc_meta.php3");
include_ecrire("inc_presentation.php3");
include_ecrire("inc_session.php3");
include_ecrire("inc_filtres.php3");
include_ecrire("inc_texte.php3");
include_ecrire("inc_meta.php3");
include_ecrire("inc_mail.php3");
include_ecrire("inc_acces.php3");
include_local("inc-public-global.php3"); 

// Ce fichier est celui d'une balise dynamique qui s'ignore.

function formulaire_oubli_dyn($p, $oubli)
{

$erreur = '';

// au 3e appel la variable P est positionnee par le script lui-meme
// et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
if ($p = addslashes($p)) {
	$res = spip_query ("SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut<>'5poubelle' AND pass<>''");
	if (!$row = spip_fetch_array($res)) 
		$erreur = _T('pass_erreur_code_inconnu');
	else {
		if ($oubli) {
			$mdpass = md5($oubli);
			$htpass = generer_htpass($oubli);
			spip_query ("UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
				cookie_oubli='' WHERE cookie_oubli='$p'");

			$login = $row['login'];
			$erreur = "<b>"._T('pass_nouveau_enregistre')."</b>".
			"<p>"._T('pass_rappel_login', array('login' => $login));
		}
	}
 } else { 
  // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
  if ($oubli) {
	if (email_valide($oubli)) {
		$email = addslashes($oubli);
		$res = spip_query("SELECT * FROM spip_auteurs WHERE email ='$email'");
		if ($row = spip_fetch_array($res)) {
			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
				$erreur = _T('pass_erreur_acces_refuse');
			else {
				$cookie = creer_uniqid();
				spip_query("UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'");

				if (envoyer_mail($email,
						 "[" . lire_meta("nom_site") .'] ' ._T('pass_oubli_mot'),
						 _T('pass_mail_passcookie',
						    array('nom_site_spip' => lire_meta("nom_site"),
							  'adresse_site' => lire_meta("adresse_site"), 
							  'cookie' => $cookie))))
					$erreur = _T('pass_recevoir_mail');
				else
					$erreur = _T('pass_erreur_probleme_technique');
			}
		}
		else
			$erreur = _T('pass_erreur_non_enregistre', array('email_oubli' => htmlspecialchars($oubli)));
	} else {
		$erreur = _T('pass_erreur_non_valide', array('email_oubli' => htmlspecialchars($oubli)));
	}
  }
 }
 return $erreur ? $erreur : array('formulaire_oubli', 0, array('p' => $p));
}

utiliser_langue_site();
utiliser_langue_visiteur();
install_debut_html(_T('pass_mot_oublie'));
inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
install_fin_html();
?>

--- NEW FILE: spip_background.php3 ---
<?php

// Du cote de la page HTML, utiliser un background-image en feuille de style
// plutot qu'un <img>, c'est plus discret notamment sous navigateur texte
$image = pack("H*", "47494638396118001800800000ffffff00000021f90401000000002c0000000018001800000216848fa9cbed0fa39cb4da8bb3debcfb0f86e248965301003b");
$size = strlen($image);

Header("Content-Type: image/gif");
Header("Content-Length: ".$size);
Header("Cache-Control: no-cache,no-store");
Header("Pragma: no-cache");
Header("Connection: close");

echo $image;

flush();

include('ecrire/inc_version.php3');

cron(1);	// toutes les 1 seconde (gourmand)


?>
--- NEW FILE: spip_cache.php3 ---
<?php

include ("ecrire/inc_version.php3");

include_ecrire("inc_meta.php3");
include_ecrire("inc_admin.php3");
include_local("inc-cache.php3");

if ($purger_cache == "oui") {
	if (verifier_action_auteur("purger_cache", $hash, $id_auteur))
		purger_cache();
}

if ($purger_squelettes == "oui") {
	if (verifier_action_auteur("purger_squelettes", $hash, $id_auteur))
	  purger_squelettes();
}
redirige_par_entete($redirect);

?>

--- NEW FILE: recherche-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html lang="#LANG">
<head>
<title><:resultats_recherche:></title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Rubriques trouvees -->

<B_rubriques>
<div class="menu">
<ul class="rubriques" title="<:rubriques:>">
<li class="menu-titre"><:rubriques:></li>
<BOUCLE_rubriques(RUBRIQUES) {recherche} {par points} {inverse} {0,8}>
<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_rubriques>
</ul>
</div>
</B_rubriques>


<!-- Mots-cles trouves et articles associes-->

<B_mots>
<div class="menu">
<ul class="divers" title="<:mots_clefs:>">
<BOUCLE_mots(MOTS) {recherche} {par points} {inverse} {0,5}>
<li>
<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_articles_mots>
	<ul class="menu-liste">
<BOUCLE_articles_mots(ARTICLES) {id_mot} {par hasard} {0,8}>
	<li class="menu-item"><a href="#URL_ARTICLE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
</BOUCLE_articles_mots>
	</ul>
</B_articles_mots>
</li>
</BOUCLE_mots>
</ul>
</div>
</B_mots>

</div>

<!-- Une : articles trouves -->

<div class="contenu" id="principal">

<div class="cartouche">
<h1 class="surtitre"><:resultats_recherche:></h1>
[<h2 class="titre-texte">(#RECHERCHE)</h2>]
</div>

	<div class="encart">

	<!-- Breves trouvees -->

	<B_breves>

	<div class="menu">
	<div class="breves" title="Br&egrave;ves trouv&eacute;es">
		<div class="menu-titre">
		<:breves:>
		</div>
		<ul>
	<BOUCLE_breves(BREVES) {recherche} {par points} {inverse} {0,8}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>

	</B_breves>

	<!-- Sites Web trouves -->

	<B_sites>
	<div class="menu">
	<div class="divers" title="Sites Web trouv&eacute;s">
		<div class="menu-titre">
		<:sites_web:>
		</div>
		<ul>
	<BOUCLE_sites(SITES) {recherche} {par points} {inverse} {0,8}>
		<li class="menu-item">
		<a href="#URL_SITE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#NOM_SITE</a>
		</li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>

	<!-- Messages trouves -->

	<B_messages>
	<div class="menu">
	<div class="divers" title="<:messages_forum:>">
		<div class="menu-titre">
		<:messages_forum:>
		</div>
		<ul>
	<BOUCLE_messages(FORUMS) {recherche} {par points} {inverse} {0,8}>
		<li class="menu-item">
		<a href="#URL_FORUM">#TITRE</a>
		</li>
	</BOUCLE_messages>
		</ul>
	</div>
	</div>
	</B_messages>

	</div>


<div class="liste-articles">

<BOUCLE_articles(ARTICLES) {recherche} {par points} {inverse} {0,10}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_articles><:par_auteur:> <BOUCLE_auteurs_articles(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_articles>
	</div>
	<br>
</BOUCLE_articles>

</div>

</div>

#FORMULAIRE_ADMIN
</body>
</html>


--- NEW FILE: sommaire-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] </title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">

<!-- Lien vers le backend pour navigateurs eclaires -->
<link rel="alternate" type="application/rss+xml" title="<:syndiquer_site:>" href="backend.php3">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]

<!-- Menu de navigation rubriques -->

<B_rubriques>
<div class="menu">
<ul class="rubriques">
<BOUCLE_rubriques(RUBRIQUES) {racine} {par titre}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_sous_rubriques>
	<ul class="menu-liste">
<BOUCLE_sous_rubriques(RUBRIQUES) {id_parent} {par titre}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_sous_rubriques>
	</ul>
</B_sous_rubriques>
</li>
</BOUCLE_rubriques>
</ul>
</div>
</B_rubriques>

<!-- Logo SPIP -->

<a href="http://www.spip.net"><img src="IMG/logo_spip.jpg" width="105" height="92" border="0" alt="<:site_realise_avec_spip:>"></a>

</div>


<div id="principal" class="contenu">

	<!-- Une : derniers articles publies -->
	
	<h1 class="structure"><:derniers_articles:></h1>
	
	<BOUCLE_article_un(ARTICLES) {par date} {inverse} {0,2}>
		[(#LOGO_ARTICLE_RUBRIQUE|right)]
		[<div class="surtitre">(#SURTITRE)</div>]
		<h2 class="titre-extrait"><a href="#URL_ARTICLE">#TITRE</a></h2>
		[<div class="surtitre">(#SOUSTITRE)</div>]
		<div class="detail">
		[(#DATE|nom_jour)] [(#DATE|affdate)]
		<B_auteurs_un><:par_auteur:> <BOUCLE_auteurs_un(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_un>
		</div>
		[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
		<br>
	</BOUCLE_article_un>


	<div class="encart">

	<!-- Breves -->

	<h1 class="structure"><:dernieres_breves:></h1>

	<B_breves>
	<div class="menu">
	<div class="breves">
		<div class="menu-titre">
		<:breves:>
		</div>
		<ul>
	<BOUCLE_breves(BREVES) {par date} {inverse} {0,8}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>
	</B_breves>

	<!-- Sur le Web -->

	<h1 class="structure"><:nouveautes_web:></h1>

	<B_syndic>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_syndic(SYNDIC_ARTICLES) {par date} {inverse} {0,8}>
		<li class="menu-item">
		<a href="#URL_ARTICLE">[(#TITRE*)]</a>
		</li>
	</BOUCLE_syndic>
		</ul>
	</div>
	</div>
	</B_syndic>

	[<!-- Inscription au site -->

		<div class="formulaire"><:participer_site:>
			<br /><br />(#FORMULAIRE_INSCRIPTION)
		</div>]

	</div>


<h1 class="structure"><:articles_recents:></h1>

<!-- Articles recents -->

<BOUCLE_articles_recents(ARTICLES) {par date} {inverse} {2,8}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_recents><:par_auteur:> <BOUCLE_auteurs_recents(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_recents>
	</div>
	<br>
</BOUCLE_articles_recents>


</div>


#FORMULAIRE_ADMIN
</body>
</html>



--- NEW FILE: puce_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: resume.php3 ---
<?php
$fond = "resume";
$delais = 2 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: spip_admin.css ---
/* Les boutons d'admin survolent la page (sauf #FORMULAIRE_ADMIN) */
.spip-admin-float {
	top: 0px;
	right: 20px;
	position: absolute;
	z-index: 100;
}


/* Couleurs et design des boutons d'admin */
.spip-admin-bloc {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	background-color: transparent;
	font-size: 10px;
}

.spip-admin-bloc li {
	padding: 0 2px;
	display: inline;
}

.spip-admin-bloc ul {
	display: inline;
}

a.spip-admin-boutons {
	border-top: 1px solid #cecece;
	border-bottom: 2px solid #4a4a4a;
	border-left: 1px solid #cecece;
	border-right: 1px solid #cecece;
	text-decoration: none;
	width: 3em;
	text-align: center;
	margin: 0;
	padding: 1px .5em;
	font-family: helvetica,arial,sans-serif;
	font-size: 10px;
	font-weight: bold;
	background-color: #fff;
	color: #0c479d;
}

a:hover.spip-admin-boutons {
	background-color: #fc3;
	border-bottom: 2px solid #36f;
}

a:active.spip-admin-boutons {
	background-color: #ccc;
	border-bottom: 2px solid #f00;
}


/* Style pour le mode debug */
#spip-debug {
	background-color: #f0f0f0;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
}
#spip-debug ul table {
	font-size: 80%;
}

#spip-debug fieldset {
	background-color: #FFF;
	font-family: "Courier New", Courier, monospace;
	font-size: 12;
}

#spip-debug legend {
	background-color: #FFF;
	border: solid 1px #F00;
	padding: 1px 1em;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
	font-weight: bold;
}

#spip-debug ul table a {
	text-decoration: none;
}

#spip-debug ul table a:hover {
	text-decoration: underline;
}

--- NEW FILE: spip_image.php3 ---
<?php

include ("ecrire/inc_version.php3");
include_ecrire("inc_charsets.php3");
include_ecrire("inc_meta.php3");
include_ecrire("inc_admin.php3");
include_ecrire("inc_abstract_sql.php3");

function effacer_image($nom) {
	global $hash_id_auteur, $hash;

	if ((!strstr($nom, "..")) AND
	    verifier_action_auteur("supp_image $nom", $hash, $hash_id_auteur))
		@unlink(_DIR_IMG . $nom);
}

function tester_vignette ($test_vignette) {
	global $djpeg_command, $cjpeg_command, $pnmscale_command;
	// verifier les formats acceptes par GD
	if ($test_vignette == "gd1") {
		$gd_formats = Array();
		if (function_exists('ImageCreateFromJPEG')) {
			$srcImage = @ImageCreateFromJPEG(_DIR_IMG . "test.jpg");
			if ($srcImage) {
				$gd_formats[] = "jpg";
				ImageDestroy( $srcImage );
			}
		}
		if (function_exists('ImageCreateFromGIF')) {
			$srcImage = @ImageCreateFromGIF(_DIR_IMG . "test.gif");
			if ($srcImage) {
				$gd_formats[] = "gif";
				ImageDestroy( $srcImage );
			}
		}
		if (function_exists('ImageCreateFromPNG')) {
			$srcImage = @ImageCreateFromPNG(_DIR_IMG . "test.png");
			if ($srcImage) {
				$gd_formats[] = "png";
				ImageDestroy( $srcImage );
			}
		}

		if ($gd_formats) $gd_formats = join(",", $gd_formats);
		ecrire_meta("gd_formats", $gd_formats);
		ecrire_metas();
	}
	// verifier les formats netpbm
	else if ($test_vignette == "netpbm") {
		$netpbm_formats= Array();

		$jpegtopnm_command = ereg_replace("pnmscale", "jpegtopnm", $pnmscale_command);
		$pnmtojpeg_command = ereg_replace("pnmscale", "pnmtojpeg", $pnmscale_command);

		$vignette = _DIR_IMG . "test.jpg";
		$dest = _DIR_IMG . "test-jpg.jpg";
		exec("$jpegtopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command > $dest");
		if ($taille = @getimagesize($dest)) {
			if ($taille[1] == 10) $netpbm_formats[] = "jpg";
		}	
		
		$giftopnm_command = ereg_replace("pnmscale", "giftopnm", $pnmscale_command);
		$pnmtojpeg_command = ereg_replace("pnmscale", "pnmtojpeg", $pnmscale_command);
		$vignette = _DIR_IMG . "test.gif";
		$dest = _DIR_IMG . "test-gif.jpg";
		exec("$giftopnm_command $vignette | $pnmscale_command -width 10 | $pnmtojpeg_command > $dest");
		if ($taille = @getimagesize($dest)) {
			if ($taille[1] == 10) $netpbm_formats[] = "gif";
		}

		$pngtopnm_command = ereg_replace("pnmscale", "pngtopnm", $pnmscale_command);
		$vignette = _DIR_IMG . "test.png";
		$dest = _DIR_IMG . "test-gif.jpg";
		exec("$pngtopnm_command $vignette | $pnmscale_command -width 10 | $cjpeg_command -outfile $dest");
		if ($taille = @getimagesize($dest)) {
			if ($taille[1] == 10) $netpbm_formats[] = "png";
		}
		

		if ($netpbm_formats) $netpbm_formats = join(",", $netpbm_formats);
		ecrire_meta("netpbm_formats", $netpbm_formats);
		ecrire_metas();
	}

	// et maintenant envoyer la vignette de tests
	if (ereg("^(gd1|gd2|imagick|convert|netpbm)$", $test_vignette)) {
		include_ecrire('inc_logos.php3');
		//$taille_preview = lire_meta("taille_preview");
		if ($taille_preview < 10) $taille_preview = 120;
		if ($preview = creer_vignette(_DIR_IMG . 'test_image.jpg', $taille_preview, $taille_preview, 'jpg', '', "test_$test_vignette", $test_vignette, true))

			return ($preview['fichier']);
	}
	return '';
}


//
// Deplacer un fichier
//

function deplacer_fichier_upload($source, $dest) {
	// Securite
	if (strstr($dest, "..")) {
		exit;
	}

	$ok = @copy($source, $dest);
	if (!$ok) $ok = @move_uploaded_file($source, $dest);
	if ($ok)
		@chmod($dest, 0666);
	else {
		$f = @fopen($dest,'w');
		if ($f)
			fclose ($f);
		else {
			redirige_par_entete("spip_test_dirs.php3?test_dir=".
					    dirname($dest));
		}
		@unlink($dest);

		if (($GLOBALS['_FILES']['size'] == 0) AND !$GLOBALS['action_zip']) {
			include_ecrire('inc_presentation.php3');
			install_debut_html(_T('forum_titre_erreur'));
			echo "<p>"._T('upload_limit',
				array('max' => ini_get('upload_max_filesize')));
			install_fin_html();
			exit;
		}
	}

	return $ok;
}


//
// Convertit le type numerique retourne par getimagesize() en extension fichier
//

function decoder_type_image($type, $strict = false) {
	switch ($type) {
	case 1:
		return "gif";
	case 2:
		return "jpg";
	case 3:
		return "png";
	case 4:
		return $strict ? "" : "swf";
	case 5:
		return "psd";
	case 6:
		return "bmp";
	case 7:
	case 8:
		return "tif";
	default:
		return "";
	}
}


//
// Corrige l'extension du fichier dans quelques cas particuliers
//

function corriger_extension($ext) {
	switch ($ext) {
	case 'htm':
		return 'html';
	case 'jpeg':
		return 'jpg';
	case 'tiff':
		return 'tif';
	default:
		return $ext;
	}
}


//
// Ajouter une image (logo)
//

function ajout_image($source, $dest) {
	global $redirect_url, $hash_id_auteur, $hash, $num_img, $dossier_squelettes;

	// Securite
	if (!(verifier_action_auteur("ajout_image $dest", $hash, $hash_id_auteur)
	      AND _DIR_DOC != $dossier_squelettes)) {
	  spip_log("interdiction ajout_image($source, $dest)");
	  return;
	}

	// analyse le type de l'image (on ne fait pas confiance au nom de
	// fichier envoye par le browser : pour les Macs c'est plus sur)

	$f =_DIR_DOC . $dest . '.tmp';
	deplacer_fichier_upload($source, $f);
	$size = @getimagesize($f);
	$type = decoder_type_image($size[2], true);
	if ($type)
		@rename ($f, _DIR_DOC . $dest . ".$type");
	else
		@unlink ($f);
}

//
// Faire tourner une image
//

//$imagePath - path to your image; function will save rotated image overwriting the old one
//$rtt - should be 90 or -90 - cw/ccw
function gdRotate($imagePath,$rtt){
	if(preg_match("/\.(png)/i", $imagePath)) $src_img=ImageCreateFromPNG($imagePath);
	elseif(preg_match("/\.(jpg)/i", $imagePath)) $src_img=ImageCreateFromJPEG($imagePath);
	elseif(preg_match("/\.(bmp)/i", $imagePath)) $src_img=ImageCreateFromWBMP($imagePath);
	$size=@getimagesize($imagePath);
	//note: to make it work on GD 2.xx properly change ImageCreate to ImageCreateTrueColor

	$process = lire_meta('image_process');
	if ($process == "gd2") $dst_img=ImageCreateTrueColor($size[1],$size[0]);
	else  $dst_img=ImageCreate($size[1],$size[0]);
	if($rtt==90){
		$t=0;
		$b=$size[1]-1;
		while($t<=$b){
			$l=0;
			$r=$size[0]-1;
			while($l<=$r){
				imagecopy($dst_img,$src_img,$t,$r,$r,$b,1,1);
				imagecopy($dst_img,$src_img,$t,$l,$l,$b,1,1);
				imagecopy($dst_img,$src_img,$b,$r,$r,$t,1,1);
				imagecopy($dst_img,$src_img,$b,$l,$l,$t,1,1);
				$l++;
				$r--;
			}
			$t++;
			$b--;
		}
	}
	elseif($rtt==-90){
		$t=0;
		$b=$size[1]-1;
		while($t<=$b){
			$l=0;
			$r=$size[0]-1;
			while($l<=$r){
				imagecopy($dst_img,$src_img,$t,$l,$r,$t,1,1);
				imagecopy($dst_img,$src_img,$t,$r,$l,$t,1,1);
				imagecopy($dst_img,$src_img,$b,$l,$r,$b,1,1);
				imagecopy($dst_img,$src_img,$b,$r,$l,$b,1,1);
				$l++;
				$r--;
			}
			$t++;
			$b--;
		}
	}
	ImageDestroy($src_img);
	ImageInterlace($dst_img,0);
	ImageJPEG($dst_img,$imagePath);
}

//
// Creation automatique de vignette new style
// Normalement le test est v?rifi? donc on ne rend rien sinon

function creer_fichier_vignette($vignette) {
	if ($vignette && lire_meta("creer_preview") == 'oui') {
		eregi('\.([a-z0-9]+)$', $vignette, $regs);
		$ext = $regs[1];
		$taille_preview = lire_meta("taille_preview");
		if ($taille_preview < 10) $taille_preview = 120;
		include_ecrire('inc_logos.php3');

		if ($preview = creer_vignette($vignette, $taille_preview, $taille_preview, $ext, 'vignettes', basename($vignette).'-s'))
		{
			inserer_vignette_base($vignette, $preview['fichier']);
			return $preview['fichier'];
		}
		include_ecrire('inc_documents.php3');
		return vignette_par_defaut($ext ? $ext : 'txt', false);
	}
}

function supprime_document_et_vignette($doc_supp) {
	global $hash_id_auteur, $hash;
	// Securite
	if (verifier_action_auteur("supp_doc $doc_supp", $hash, $hash_id_auteur)) {
		$query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$doc_supp";
		$result = spip_query($query);
		if ($row = spip_fetch_array($result)) {
			$fichier = $row['fichier'];
			$id_vignette = $row['id_vignette'];
			spip_query("DELETE FROM spip_documents WHERE id_document=$doc_supp");
			spip_query("UPDATE spip_documents SET id_vignette=0 WHERE id_vignette=$doc_supp");
			spip_query("DELETE FROM spip_documents_articles WHERE id_document=$doc_supp");
			spip_query("DELETE FROM spip_documents_rubriques WHERE id_document=$doc_supp");
			spip_query("DELETE FROM spip_documents_breves WHERE id_document=$doc_supp");
			@unlink($fichier);
			
			if ($id_vignette > 0) {
			  $query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$id_vignette";
			  $result = spip_query($query);
			  if ($row = spip_fetch_array($result)) {
			    $fichier = $row['fichier'];
			    @unlink($fichier);
			  }
			  spip_query("DELETE FROM spip_documents WHERE id_document=$id_vignette");
			  spip_query("DELETE FROM spip_documents_articles WHERE id_document=$id_vignette");
			  spip_query("DELETE FROM spip_documents_rubriques WHERE id_document=$id_vignette");
			  spip_query("DELETE FROM spip_documents_breves WHERE id_document=$id_vignette");
			}
		}
	}
}

function tourner_document($var_rot, $doc_rotate, $convert_command) {
	global $hash_id_auteur, $hash;
	// Securite
	if (!verifier_action_auteur("rotate $doc_rotate", $hash, $hash_id_auteur)) {
		return '';
	}
	
	if (!$var_rot) $var_rot = 0;

	$query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$doc_rotate";
	$result = spip_query($query);
	if ($row = spip_fetch_array($result)) {
		$id_vignette = $row['id_vignette'];
		$image = $row['fichier'];

		$process = lire_meta('image_process');

		 // imagick (php4-imagemagick)
		 if ($process == 'imagick') {
			$handle = imagick_readimage($image);
			imagick_rotate($handle, $var_rot);
			imagick_write($handle, $image);
			if (!@file_exists($image)) return;	// echec imagick
		}
		else if ($process == "gd2") { // theoriquement compatible gd1, mais trop forte degradation d'image
			if ($var_rot == 180) { // 180 = 90+90
				gdRotate ($image, 90);
				gdRotate ($image, 90);
			} else {
				gdRotate ($image, $var_rot);
			}
		}
		else if ($process = "convert") {
			$commande = "$convert_command -rotate $var_rot ./"
				. escapeshellcmd($image).' ./'.escapeshellcmd($image);
#			spip_log($commande);
			exec($commande);
		}

		$size_image = @getimagesize($image);
		$largeur = $size_image[0];
		$hauteur = $size_image[1];

		if ($id_vignette > 0) {
			creer_fichier_vignette($image);
/*			$query = "SELECT id_vignette, fichier FROM spip_documents WHERE id_document=$id_vignette";
			$result = spip_query($query);
			if ($row = spip_fetch_array($result)) {
				$fichier = $row['fichier'];
				@unlink($fichier);
			}
			spip_query("DELETE FROM spip_documents WHERE id_document=$id_vignette");
			spip_query("DELETE FROM spip_documents_articles WHERE id_document=$id_vignette");
			spip_query("DELETE FROM spip_documents_rubriques WHERE id_document=$id_vignette");
			spip_query("DELETE FROM spip_documents_breves WHERE id_document=$id_vignette");
*/		}


		spip_query("UPDATE spip_documents SET largeur=$largeur, hauteur=$hauteur WHERE id_document=$doc_rotate");

	}
}

if ($test_vignette) // appel de config-fonction
	$redirect = tester_vignette($test_vignette);
elseif ($vignette) // appels de inc_logo
	$redirect = creer_fichier_vignette($vignette);
else {
   $retour = $redirect;
   $redirect = '';
   if ($ajout_doc == 'oui') {
	include_ecrire('inc_getdocument.php3');
	if (!$image_name AND $image2) {
		$image = _DIR_TRANSFERT . $image2;
		$image_name = $image;
	} 
	if (!eregi("\.zip$",$image_name))
	  ajout_doc_s($image, $image_name, $mode, $forcer_document, $id_document, $hash);
	else {
	  // bizarre: clean_link ne recupere pas les variables
	  $link = new Link('spip_image.php3');
	  $link->addVar("ajout_doc", "oui");
	  $link->addVar("redirect", $retour);
	  $link->addVar('id_document', $id_document);
	  $link->addVar('id_article', $id_article);
	  $link->addVar('mode', $mode);
	  $link->addVar('type', $type);
	  $link->addVar('hash', $hash);
	  $link->addVar('hash_id_auteur', $hash_id_auteur);
	  ajout_doc_zip($image, $image_name, $mode, $forcer_document, $action_zip, $id_document, $hash, $link);
	}
   }
   elseif ($ajout_logo == "oui")
	ajout_image($image, $logo);
   elseif ($image_supp)
	effacer_image($image_supp);
   elseif ($doc_supp) // appels de inc_document
	supprime_document_et_vignette($doc_supp);
   elseif ($doc_rotate)
	tourner_document($var_rot, $doc_rotate, $convert_command);
 }

if (!($redirect)) {
	if ($HTTP_POST_VARS) $vars = $HTTP_POST_VARS;
	else $vars = $HTTP_GET_VARS;
	$redirect = $vars["redirect"];
	$link = new Link(_DIR_RESTREINT_ABS . $redirect);
	reset($vars);
	while (list ($key, $val) = each ($vars)) {
	  if (!ereg("^(redirect|image.*|hash.*|ajout.*|doc.*|transformer.*|modifier_.*|ok|type|forcer_.*|var_rot|action_zip)$", $key)) {
	    $link->addVar($key, $val);
	  }
	}
	if ($id_document)
	  $link->addVar('id_document',$id_document);
	if ($type == 'rubrique')
	  $link->delVar('id_article');
	
	$redirect = $link->getUrl();
 }


redirige_par_entete($redirect);

?>

--- NEW FILE: site-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_site(SITES){id_syndic}>

<html lang="#LANG">
<head>
<title>[(#NOM_SITE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


</div>

<!-- Une : affichage du site -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_SITE|left)]
<h1 class="titre-texte"><a href="#URL_SITE">#NOM_SITE</a></h1>

[<div class="chapo">(#DESCRIPTIF)</div>]
[<div class="notes">(#NOTES)</div>]
</div>


<!-- Articles du site -->

<h1 class="structure"><:articles:></h1>

<div class="liste-articles">

<BOUCLE_articles(SYNDIC_ARTICLES) {id_syndic} {par date}{inverse}{0,10}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	</div>
	<br>
</BOUCLE_articles>

</div>

</div>

#FORMULAIRE_ADMIN
</body>
</html>


</BOUCLE_site>
<:aucun_site:>
<//B_site>

--- NEW FILE: rubrique.php3 ---
<?php
$fond = "rubrique";
$delais = 2 * 3600;


include ("inc-public.php3");

?>

--- NEW FILE: spip_redirect.php3 ---
<?php
// redirige vers l'URL canonique de l'article,
// en indiquant recalcul et previsu

include ("ecrire/inc_version.php3");

// Gestionnaire d'URLs
if (@file_exists("inc-urls.php3"))
	include_local("inc-urls.php3");
else
	include_local("inc-urls-".$GLOBALS['type_urls'].".php3");

if ($id_article) {
	$url = generer_url_article($id_article);
}
else if ($id_breve) {
	$url = generer_url_breve($id_breve);
}
else if ($id_forum) {
	$url = generer_url_forum($id_forum);
}
else if ($id_rubrique) {
	$url = generer_url_rubrique($id_rubrique);
}
else if ($id_mot) {
	$url = generer_url_mot($id_mot);
}
else if ($id_auteur) {
	$url = generer_url_auteur($id_auteur);
}
else {
	$url = _DIR_RESTREINT_ABS;
}
if (strpos($url,'?')) {
	$super='&';
}
else {
	$super='?';
}
if ($recalcul) $url .= $super."var_mode=recalcul";
else if ($preview) $url .= $super."var_preview=oui";
@header("Location: $url");

?>
--- NEW FILE: site.php3 ---
<?php
$fond = "site";
$delais = 24 * 3600;


include ("inc-public.php3");


?>

--- NEW FILE: recherche.php3 ---
<?php
$fond = "recherche";
$delais = 0;

include ("inc-public.php3");


?>

--- NEW FILE: spip_acces_doc.php3 ---
<?
# script d'acces aux documents joints
# doit etre appele avec un de ces 2 parametres de GET:
# - id_document 
# - file 
# il verifie soit que le demandeur est authentifie
# soit que le fichier est joint ? au moins 1 article, breve ou rubrique

$id_document = ($_GET['id_document']);
$file = urldecode($_GET['file']);
if (strpos($file,'../') !== false)
  $refus = 1;
else
  {
    $refus = false;
    include ("ecrire/inc_version.php3");
    include_local(_FILE_CONNECT);
    include_ecrire("inc_meta.php3");
    include_ecrire("inc_session.php3");

    global $auteur_session;
    if ($cookie_session = $HTTP_COOKIE_VARS['spip_session']) 
      {
	if (verifier_session($cookie_session)) 
	  {
	    if ($auteur_session['statut'] == '0minirezo' 
		OR $auteur_session['statut'] == '1comite') 
	      $auth_login = $auteur_session['login'];
	  }
      }

    if (!$id_document) {
      $id_document = @spip_fetch_array(spip_query("select id_document from spip_documents as documents where documents.fichier='".$file."'"));
      if (!$id_document) $refus = 2;
      $id_document = $id_document['id_document'];
    } else {
      $file = @spip_fetch_array(spip_query("select fichier from spip_documents as documents where id_document='". $id_document ."'"));
      if (!$file) $refus = 3;
      $file = $file['fichier'];
    }
  }

if (!$auth_login && !$refus) { 
    if (!spip_num_rows(spip_query("select articles.id_article
from spip_documents_articles as rel_articles, spip_articles as articles 
where rel_articles.id_article = articles.id_article AND
articles.statut = 'publie' AND rel_articles.id_document ='".
			       $id_document .
				"' LIMIT 1"))) {
      if (!spip_num_rows(spip_query("select rubriques.id_rubrique
from spip_documents_rubriques as rel_rubriques, spip_rubriques as rubriques 
where rel_rubriques.id_rubrique = rubriques.id_rubrique AND
rubriques.statut = 'publie' AND rel_rubriques.id_document ='".
			       $id_document .
				  "' LIMIT 1"))) {
	if (!spip_num_rows(spip_query("select breves.id_breve
from spip_documents_breves as rel_breves, spip_breves as breves 
where rel_breves.id_breve = breves.id_breve AND
breves.statut = 'publie' AND rel_breves.id_document ='".
			       $id_document .
				  "' LIMIT 1")))
	  $refus = 4; } } }

if (!$refus)
  {
     header("Content-Type: ". mime_content_type($file));
     header("Content-Length: ". filesize($file));
     header("Content-Disposition: attachment; filename=\"". basename($file) ."\";");
     header("Content-Transfer-Encoding: binary");
     readfile($file);
   }
 else
   spip_log("Acces refuse ($refus) au document " . ($_GET['id_document']) . ': ' .($_GET['file']));

?>
--- NEW FILE: spip_style.css ---
a {
	text-decoration: none;
}

a:hover {
	color:#FF9900;
	text-decoration: underline;
}

a.spip_url { }
a.spip_in { }
a.spip_out { }
a.spip_glossaire { }

.spip_code { }

p.spip_note { }

h3.spip {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 120%;
	text-align: center;
	margin-top : 40px;
	margin-bottom : 40px;
	padding: 0em;
}

.spip_puce {
	list-style-position: inside;
}

.spip_documents{
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size : 70%;
}


table.spip {
}

table.spip tr.row_first {
	background-color: #FCF4D0;
}

table.spip tr.row_odd {
	background-color: #C0C0C0;
}

table.spip tr.row_even {
	background-color: #F0F0F0;
}

table.spip td {
	padding: 1px;
	text-align: left;
	vertical-align: middle;
}

hr.spip { }
b.spip { }
i.spip { }
blockquote.spip {
	margin-left : 40px;
	margin-top : 10px;
	margin-bottom : 10px;
	margin-right: 0px;
	border : solid 1px #aaaaaa;
	background-color: #ffffff;
	padding-left: 10px;
	padding-right: 10px;
}

.forml { width: 100% ; background-color: #FFDDAA;}

.spip_encadrer {
	font-family: helvetica, arial, sans-serif;
	width : 95%;
	background-color: #FFFFFF;
	padding: 5px;
	border: 1px #666666 solid;
}

.spip_cadre {
	width : 95%;
	background-color: #FFFFFF;
	padding: 5px;
	margin-top: 10px;
}

div.spip_poesie {
	margin-bottom: 5px;
	margin-left: 10px;
	padding-left: 10px;
	border-left: 1px solid #999999;
}
div.spip_poesie div {
	text-indent: -60px;
	margin-left: 60px;
}

.spip_bouton { background-color: #FFCC00;}

form.formrecherche { 
	margin-top: 5px;
	margin-bottom: 5px;
}
input.formrecherche {
	width: 95%;
	background-color: #FFDDAA;
}

.reponse_formulaire {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 110%;
	color: red;
}

.spip_surligne { background-color: #FFFF66; }


/*
 * Barre de raccourcis
 */

a.spip_barre img {
	border-left: 1px solid #ffffff;
	border-top: 1px solid #ffffff;
	border-right: 1px solid #aa9966;
	border-bottom: 1px solid #aa9966;
	padding: 3px;
	background-color: #FFDDAA;
}
a.spip_barre:hover img {
	border: 1px solid #808080;
	padding: 3px;
	background-color: #f8f8f4;
}

--- NEW FILE: sommaire_texte.php3 ---
<?php

// ACCESSIBILITE
// cette page offre une lecture en mode "texte seul"
// des 3 articles les plus recents.

$fond = "sommaire_texte";
$delais = 3600;

include ("inc-public.php3");

?>

--- NEW FILE: spip_barre.js ---
// Barre de raccourcis
// derive du:
// bbCode control by subBlue design : www.subBlue.com

// Startup variables
var theSelection = false;

// Check for Browser & Platform for PC & IE specific bits
// More details from: http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html
var clientPC = navigator.userAgent.toLowerCase(); // Get client info
var clientVer = parseInt(navigator.appVersion); // Get browser version

var is_ie = ((clientPC.indexOf("msie") != -1) && (clientPC.indexOf("opera") == -1));
var is_nav = ((clientPC.indexOf('mozilla')!=-1) && (clientPC.indexOf('spoofer')==-1)
                && (clientPC.indexOf('compatible') == -1) && (clientPC.indexOf('opera')==-1)
                && (clientPC.indexOf('webtv')==-1) && (clientPC.indexOf('hotjava')==-1));
var is_moz = 0;

var is_win = ((clientPC.indexOf("win")!=-1) || (clientPC.indexOf("16bit") != -1));
var is_mac = (clientPC.indexOf("mac")!=-1);


function barre_raccourci(debut,fin,champ) {
	var txtarea = champ;

	txtarea.focus();
	donotinsert = false;
	theSelection = false;
	bblast = 0;

	if ((clientVer >= 4) && is_ie && is_win)
	{
		theSelection = document.selection.createRange().text; // Get text selection
		if (theSelection) {

			while (theSelection.substring(theSelection.length-1, theSelection.length) == ' ')
			{
				theSelection = theSelection.substring(0, theSelection.length-1);
				fin = fin + " ";
			}
			if (theSelection.substring(0,1) == '{' && debut.substring(0,1) == '{')
			{
				debut = debut + " ";
			}
			if (theSelection.substring(theSelection.length-1, theSelection.length) == '}' && fin.substring(0,1) == '}')
			{
				fin = " " + fin;
			}

			// Add tags around selection
			document.selection.createRange().text = debut + theSelection + fin;
			txtarea.focus();
			theSelection = '';
			return;
		}
	}
	else if (txtarea.selectionEnd && (txtarea.selectionEnd - txtarea.selectionStart > 0))
	{
		mozWrap(txtarea, debut, fin);
		return;
	}
}

function barre_demande(debut,milieu,fin,affich,champ) {
	var inserer = prompt(affich);

	if (inserer != null) {
		if (inserer == "") {inserer = "xxx"; }

		barre_raccourci(debut, milieu+inserer+fin, champ);
	}
}

function barre_inserer(text,champ) {
	var txtarea = champ;
	
	if (txtarea.createTextRange && txtarea.caretPos) {
		var caretPos = txtarea.caretPos;
		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
		txtarea.focus();
	} else {
		//txtarea.value  += text;
		//txtarea.focus();
		mozWrap(txtarea, '', text);
		return;
	}
}


// D'apres Nicolas Hoizey 
function barre_tableau(toolbarfield)
{
	var txtarea = toolbarfield;
	txtarea.focus();
	var cols = prompt("Nombre de colonnes du tableau :", "");
	var rows = prompt("Nombre de lignes du tableau :", "");
	if (cols != null && rows != null) {
		var tbl = '';
		var ligne = '|';
		var entete = '|';
		for(i = 0; i < cols; i++) {
			ligne = ligne + ' valeur |';
			entete = entete + ' {{entete}} |';
		}
		for (i = 0; i < rows; i++) {
			tbl = tbl + ligne + '\n';
		}
		if (confirm('Voulez vous ajouter une ligne d\'en-t?te ?')) {
			tbl = entete + '\n' + tbl;
		}
		if ((clientVer >= 4) && is_ie && is_win) {
			var str = document.selection.createRange().text;
			var sel = document.selection.createRange();
			sel.text = str + '\n\n' + tbl + '\n\n';
		} else {
			mozWrap(txtarea, '', "\n\n" + tbl + "\n\n");
		}
	}
	return;
}



// Shows the help messages in the helpline window
function helpline(help, champ) {
	champ.value = help;
}


function setCaretToEnd (input) {
  setSelectionRange(input, input.value.length, input.value.length);
}


function setSelectionRange(input, selectionStart, selectionEnd) {
  if (input.setSelectionRange) {
    input.focus();
    input.setSelectionRange(selectionStart, selectionEnd);
  }
  else if (input.createTextRange) {
    var range = input.createTextRange();
    range.collapse(true);
    range.moveEnd('character', selectionEnd);
    range.moveStart('character', selectionStart);
    range.select();
  }
}

// From http://www.massless.org/mozedit/
function mozWrap(txtarea, open, close)
{
	var selLength = txtarea.textLength;
	var selStart = txtarea.selectionStart;
	var selEnd = txtarea.selectionEnd;
	if (selEnd == 1 || selEnd == 2)
		selEnd = selLength;
	
	// Raccourcir la selection par double-clic si dernier caractere est espace	
	if (selEnd - selStart > 0 && (txtarea.value).substring(selEnd-1,selEnd) == ' ') selEnd = selEnd-1;
	
	var s1 = (txtarea.value).substring(0,selStart);
	var s2 = (txtarea.value).substring(selStart, selEnd)
	var s3 = (txtarea.value).substring(selEnd, selLength);

	// Eviter melange bold-italic-intertitre
	if ((txtarea.value).substring(selEnd,selEnd+1) == '}' && close.substring(0,1) == "}") close = close + " ";
	if ((txtarea.value).substring(selEnd-1,selEnd) == '}' && close.substring(0,1) == "}") close = " " + close;
	if ((txtarea.value).substring(selStart-1,selStart) == '{' && open.substring(0,1) == "{") open = " " + open;
	if ((txtarea.value).substring(selStart,selStart+1) == '{' && open.substring(0,1) == "{") open = open + " ";

	txtarea.value = s1 + open + s2 + close + s3;
	selDeb = selStart + open.length;
	selFin = selEnd + close.length;
	window.setSelectionRange(txtarea, selDeb, selFin);
	txtarea.focus();
	
	return;
}

// Insert at Claret position. Code from
// http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130
     function storeCaret (textEl) {
       if (textEl.createTextRange) 
         textEl.caretPos = document.selection.createRange().duplicate();
     }


--- NEW FILE: spip_inscription.php3 ---
<?php
include ("ecrire/inc_version.php3");
include_ecrire("inc_presentation.php3");
include_local("inc-formulaire_inscription.php3");
include_local("inc-public-global.php3"); 
include_ecrire("inc_lang.php3"); 
utiliser_langue_site();
utiliser_langue_visiteur();
install_debut_html(_T('pass_vousinscrire'));
inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus));
install_fin_html();
?>

--- NEW FILE: spip_login.php3 ---
<?php
$fond = "login";
$delais = 3600;
$flag_dynamique = true;
$flag_preserver = true;
$forcer_lang = true;

include ("inc-public.php3");

?>

--- NEW FILE: rubrique-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_rubrique_principal(RUBRIQUES) {id_rubrique}>

<html lang="#LANG">
<head>
<title>[(#TITRE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">

<!-- Lien vers le backend pour navigateurs eclaires -->
<link rel="alternate" type="application/rss+xml" title="<:syndiquer_rubrique:>" href="backend.php3?id_rubrique=#ID_RUBRIQUE">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Menu de navigation rubriques -->

<div class="menu">
<ol class="rubriques" title="<:hierarchie_site:>">
<BOUCLE_hierarchie(HIERARCHIE) {id_rubrique} {tout}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_rubriques_soeurs>
	<ul class="menu-liste">
<BOUCLE_rubriques_soeurs(RUBRIQUES) {meme_parent} {exclus} {par titre}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_rubriques_soeurs>
	</ul>
</B_rubriques_soeurs>
</li>
</BOUCLE_hierarchie>
</ol>
</div>


<!-- Breves dans la rubrique -->

<B_breves_rubrique>

<div class="menu">
<div class="breves" title="<:dernieres_breves:>">
	<div class="menu-titre">
	<:breves:>
	</div>
	<ul>
<BOUCLE_breves_rubrique(BREVES) {id_secteur} {par date} {inverse} {0,5}>
	<li class="menu-item">
	<i>[(#DATE|affdate_court)]</i>:
	<a href="#URL_BREVE">#TITRE</a>
	</li>
</BOUCLE_breves_rubrique>
	</ul>
</div>
</div>

</B_breves_rubrique>


</div>


<!-- Une : contenu de la rubrique -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_RUBRIQUE|left)]
<h1 class="titre-texte">#TITRE</h1>
[<:dernier_ajout:> : (#DATE|nom_jour)] [(#DATE|affdate).]
</div>

	<div class="encart">

	<!-- Menu de navigation mots-cles -->

	<B_mots>
	<h2 class="structure"><:mots_clefs:></h2>

	<div class="menu">
	<ul class="divers" title="<:mots_clefs:>">
	<BOUCLE_mots(MOTS) {id_rubrique} {par titre}>
	<li>
	<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
	<B_rubriques_mots>
		<ul class="menu-liste">
	<BOUCLE_rubriques_mots(RUBRIQUES) {id_mot} {par hasard} {0,4}>
		<li class="menu-item"><a href="#URL_RUBRIQUE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
	</BOUCLE_rubriques_mots>
		</ul>
	</B_rubriques_mots>
	</li>
	</BOUCLE_mots>
	</ul>
	</div>
	</B_mots>

	<!-- Sous-rubriques -->

	<B_sous_rubriques>
	<h2 class="structure"><:sous_rubriques:></h2>

	<div class="menu">
	<ul class="rubriques" title="<:sous_rubriques:>">
	<BOUCLE_sous_rubriques(RUBRIQUES) {id_parent} {par titre}>
	<li>
	<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
	<B_sous_sous_rubriques>
		<ul class="menu-liste">
	<BOUCLE_sous_sous_rubriques(RUBRIQUES) {id_parent} {par titre}>
		<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
	</BOUCLE_sous_sous_rubriques>
		</ul>
	</B_sous_sous_rubriques>
	</li>
	</BOUCLE_sous_rubriques>
	</ul>
	</div>
	</B_sous_rubriques>
	
	<!-- Sites syndiques -->
	
	<B_sites>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_sites(SITES) {id_rubrique} {par nom_site}>
		<li class="menu-item">
		<a href="#URL_SITE">#NOM_SITE</a>
		<B_syndic>
		<ul class="menu-liste">
		<BOUCLE_syndic(SYNDIC_ARTICLES) {id_syndic} {par date} {inverse} {0,3}>
			<li class="menu-item"><small><a href="#URL_ARTICLE">#TITRE</a></small></li>
		</BOUCLE_syndic>
		</ul>
		</B_syndic>
		</li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>
	[
<div class="menu">
    <div class="divers">
      <div class="menu-titre"><:proposer_site:>
	<div class='reponse_formulaire'>(#FORMULAIRE_SITE)</div>
      </div>
    </div>
</div>
]
	</div>

[<div class="chapo">(#TEXTE)</div>]
[<div class="notes">(#NOTES)</div>]

<BOUCLE_documents_joints(DOCUMENTS) {id_rubrique} {mode=document} {doublons} {"<br>"}>
[(#LOGO_DOCUMENT|#URL_DOCUMENT)][<br>(#TITRE)][ - (#DESCRIPTIF)]
</BOUCLE_documents_joints>
<br>

<!-- Articles de la rubrique -->

<h1 class="structure"><:articles_rubrique:></h1>

<div class="liste-articles">

<BOUCLE_articles_recents(ARTICLES) {id_rubrique} {par titre}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_recents><:par_auteur:> <BOUCLE_auteurs_recents(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_recents>
	</div>
	<br>
</BOUCLE_articles_recents>


</div>


</div>
#FORMULAIRE_ADMIN
</body>
</html>


</BOUCLE_rubrique_principal>
<:aucune_rubrique:>
<//B_rubrique_principal>

--- NEW FILE: spip_carto.php ---
<?php
include ("ecrire/inc_version.php3");
include ("ecrire/inc_connect.php3");
//include ("ecrire/inc_meta.php3");
//include ("ecrire/inc_session.php3");

include("downloadfile.class.php");

if (isset($_GET["id_carte"]) && !empty($_GET["id_carte"])) 
{
	$query="select fichier from spip_documents where id_document=".$_GET["id_carte"];
		
	$result = @spip_query($query);
	if ($result) 
	{
		$row = @spip_fetch_array($result); 
		$downloadfile = new DOWNLOADFILE($row[0],"inline");
		//si c'est un probleme de document supprim? : "!!!" ... bof !
		if (!$downloadfile->df_download()) echo "!!!";
		//else exit();
	}
}
?>
--- NEW FILE: puce.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sommaire_texte-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<!--
// ACCESSIBILITE
// la page /oo offre une lecture en mode "texte seul"
// des 3 articles les plus recents.
-->
<head>
	<title>
		#NOM_SITE_SPIP
	</title>
	<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
	<meta http-equiv="AUTHOR" content="#NOM_SITE_SPIP">
	<meta http-equiv="DESCRIPTION" content="Edition en mode texte de #NOM_SITE_SPIP">
</head>
<body dir="#LANG_DIR">
	<hr />
	<:edition_mode_texte:> <a href="#URL_SITE_SPIP">{#NOM_SITE_SPIP}</a>
	<hr />
	<b><u>Sommaire de la page :</u></b>

	<B_sarticles>
	<h2>Articles</h2>
	<ul>
		<BOUCLE_sarticles(ARTICLES){0,3}{par date}{inverse}>
			<li><a href="#ar#ID_ARTICLE">#TITRE</a>
		</BOUCLE_sarticles>
	</ul>
	</B_sarticles>

	<B_sbreves>
	<h2>Br&egrave;ves</h2>
	<ul>
		<BOUCLE_sbreves(BREVES){0,5}{par date}{inverse}>
			<li><a href="#br#ID_BREVE">#TITRE</a>
		</BOUCLE_sbreves>
	</ul>
	</B_sbreves>


	<B_articles>
	<h1>Articles r&eacute;cents</h1>

	<BOUCLE_articles(ARTICLES){0,3}{par date}{inverse}>
		<a name="ar#ID_ARTICLE"></a>
		<BOUCLE_RUB_AR(RUBRIQUES){ID_RUBRIQUE}>
			Rubrique : <a href="#URL_RUBRIQUE">{#TITRE}</a>
		</BOUCLE_RUB_AR>

		[<h2>(#SURTITRE|majuscules)</h2>]
		<h2>#TITRE</h2>
		<h3>#SOUSTITRE</h3>
		[Le (#DATE|nom_jour) ] [(#DATE|affdate)]
		[par (#LESAUTEURS)]
		<p>
		[(#CHAPO)]
		<p>
		[(#TEXTE)]

		
		<p><a href="#URL_ARTICLE">{Consulter}</a> l'article avec son forum. 

		
		<hr />
	</BOUCLE_articles>

	<B_breves>
	<h1>Derni&egrave;res br&egrave;ves</h1>

	<BOUCLE_breves(BREVES){0,5}{par date}{inverse}>
		<a name="br#ID_BREVE">
		<BOUCLE_RUB_BR(RUBRIQUES){ID_RUBRIQUE}>
			Rubrique : <a href="#URL_RUBRIQUE">{#TITRE}</a>
		</BOUCLE_RUB_BR>
		<h2>#TITRE</h2>
		[Le (#DATE|nom_jour) ] [(#DATE|affdate)]
		<p>
		[(#TEXTE)]
		[<p>Voir en ligne : <a href="(#URL_SITE)">#NOM_SITE</a>]
		<p><a href="#URL_BREVE">{Consulter}</a> la br&egrave;ve avec son forum. 
	<hr />
	</BOUCLE_breves>
	[<h1>NOTES :</h1>
	<p class="spip_note">(#NOTES)]
	
	<hr />
	<a name="about"></a>
	
	[<p>Rechercher sur ce site : (#FORMULAIRE_RECHERCHE|recherche.php3)</p>]
	<table><tr>
		<td><A href="http://www.uzine.net/spip">{Site r&eacute;alis&eacute; avec le logiciel SPIP}</td>
		[<td><A href="#URL_SITE_SPIP">{(#NOM_SITE_SPIP|majuscules)}</a></td>]
		<td><a href="#URL_SITE_SPIP/plan.php3">{<:plan_site:>}</a></td>
	</tr></table>

</body>
</html>

--- NEW FILE: spip_image_reduite.php3 ---
<?php

$img = $_GET['img'];
$logo = $img;
include ("ecrire/inc_version.php3");
include_ecrire("inc_admin.php3");
include_ecrire("inc_logos.php3");

if (!$taille_y)
	$taille_y = $taille_x;
	
if (eregi("(.*)\.(jpg|gif|png)$", $logo, $regs)) {
	if ($i = cherche_image_nommee($regs[1], array($regs[2]))
	    AND verifier_action_auteur("reduire $taille_x $taille_y", $hash, $hash_id_auteur))
	{
		list($dir,$nom,$format) = $i;
		$logo = $dir . $nom . '.' . $format;
		
		include_ecrire("inc_logos.php3");
		$suffixe = '-'.$taille_x.'x'.$taille_y;
		$preview = creer_vignette($logo, $taille_x, $taille_y, $format,('cache'.$suffixe), $nom.$suffixe);
		if ($preview) {
			$vignette = $preview['fichier'];
			$width = $preview['width'];
			$height = $preview['height'];
			//echo "<img src='$vignette' name='$name' border='0' align='$align' alt='' hspace='$espace' vspace='$espace' width='$width' height='$height' class='spip_logos' />";
			$retour = $vignette;
		}
		else if ($taille_origine = @getimagesize($logo)) {
			//list ($destWidth,$destHeight) = image_ratio($taille_origine[0], $taille_origine[1], $taille_x, $taille_y);
			$retour = $logo;
		}	

	// Afficher l'image resultante, meme grande...
//	header("Content-type: image/$format");
//	echo implode ('', file ($retour));

	redirige_par_entete($retour);
	}
 }

?>
--- NEW FILE: spip_test_dirs.php3 ---
<?php
if (defined("_TEST_DIRS")) return;
define("_TEST_DIRS", "1");

include("ecrire/inc_version.php3");

include_ecrire("inc_presentation.php3");

utiliser_langue_visiteur();


//
// Tente d'ecrire
//
function test_ecrire($my_dir) {
	$ok = true;
	$nom_fich = "$my_dir/test.txt";
	$f = @fopen($nom_fich, "w");
	if (!$f) $ok = false;
	else if (!@fclose($f)) $ok = false;
	else if (!@unlink($nom_fich)) $ok = false;
	return $ok;
}

//
// teste les droits sur les repertoires $test_dirs declares dans inc_version
//

// rajouter celui passer dans l'url ou celui du source (a l'installation)

if ($test_dir) {
  if (!ereg("/$", $test_dir)) $test_dir .= '/';
  if (!in_array($test_dir, $test_dirs)) $test_dirs[] = $test_dir;
 }
else {
	if (!_FILE_CONNECT)
	  $test_dirs[] = dirname(_FILE_CONNECT_INS);
}

unset($bad_dirs);
unset($absent_dirs);

while (list(, $my_dir) = each($test_dirs)) {
	if (!test_ecrire($my_dir)) {
		@umask(0);
		if (@file_exists($my_dir)) {
			@chmod($my_dir, 0777);
			// ???
			if (!test_ecrire($my_dir))
				@chmod($my_dir, 0775);
			if (!test_ecrire($my_dir))
				@chmod($my_dir, 0755);
			if (!test_ecrire($my_dir))
				$bad_dirs[] = "<LI>".$my_dir;
		} else
			$absent_dirs[] = "<LI>".$my_dir;
	}
}

if ($bad_dirs OR $absent_dirs) {
	install_debut_html();

	if (!_FILE_CONNECT) {
		$titre = _T('dirs_preliminaire');
		$continuer = ' '._T('dirs_commencer');
	} else
		$titre = _T('dirs_probleme_droits');

	$bad_url = "spip_test_dirs.php3";
	if ($test_dir) $bad_url .= '?test_dir='.$test_dir;

	echo "<FONT FACE=\"Verdana,Arial,Helvetica,sans-serif\" SIZE=3>$titre</FONT>\n<p>";
	echo "<div align='right'>". menu_langues('var_lang_ecrire')."</div>\n";

	if ($bad_dirs) {
		echo "<p>";
		echo _T('dirs_repertoires_suivants',
			array('bad_dirs' => join(" ", $bad_dirs)));
		echo "<B>". _T('login_recharger')."</b>";
	}

	if ($absent_dirs) {
		echo "<p>";
		echo _T('dirs_repertoires_absents',
			array('bad_dirs' => join(" ", $absent_dirs)));
		echo "<B>". _T('login_recharger')."</b>";
	}

	echo $continuer.'. ';
	echo aide ("install0");
	echo "<p>";

	echo "<FORM ACTION='$bad_urls' METHOD='GET'>\n";
	echo "<DIV align='right'><INPUT TYPE='submit' CLASS='fondl' VALUE='". _T('login_recharger')."'></DIV>";
	echo "</FORM>";

	install_fin_html();

} else {
	if (!_FILE_CONNECT)
		header("Location: " . _DIR_RESTREINT_ABS . "install.php3?etape=1");
	else
		header("Location: " . _DIR_RESTREINT_ABS);
}

?>

--- NEW FILE: spip_cookie.php3 ---
<?php

include ("ecrire/inc_version.php3");
include_ecrire ("inc_session.php3");

// gerer l'auth http
function auth_http($url, $essai_auth_http) {
	if ($essai_auth_http == 'oui') {
		if (!verifier_php_auth()) {
		  $url = quote_amp(urlencode($url));
		  ask_php_auth(_T('login_connexion_refusee'),_T('login_login_pass_incorrect'),_T('login_retour_site'), "url=$url",_T('login_nouvelle_tentative'), (ereg(_DIR_RESTREINT_ABS, $url)));
		  exit;
		}
		else
			redirige_par_entete($url);
	}
	// si demande logout auth_http
	else if ($essai_auth_http == 'logout') {
		ask_php_auth(_T('login_deconnexion_ok'),_T('login_verifiez_navigateur'),_T('login_retour_public'),"redirect=ecrire",_T('login_test_navigateur'), true);
		exit;
	}
}

// rejoue le cookie pour renouveler spip_session
if ($change_session == 'oui') {
	if (verifier_session($spip_session)) {
		// Attention : seul celui qui a le bon IP a le droit de rejouer,
		// ainsi un eventuel voleur de cookie ne pourrait pas deconnecter
		// sa victime, mais se ferait deconnecter par elle.
		if ($auteur_session['hash_env'] == hash_env()) {
			$auteur_session['ip_change'] = false;
			$cookie = creer_cookie_session($auteur_session);
			supprimer_session($spip_session);
			spip_setcookie('spip_session', $cookie);
		}
		@header('Content-Type: image/gif');
		@header('Expires: 0');
		@header("Cache-Control: no-store, no-cache, must-revalidate");
		@header('Pragma: no-cache');
		@header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
		@readfile(_DIR_IMG_PACK . 'rien.gif');
		exit;
	}
}
#spip_log("cookie: $url");

if ($url)  $url = urldecode($url);

// tentative de connexion en auth_http
if ($essai_auth_http AND !$ignore_auth_http) {
	auth_http(($url ? $url : _DIR_RESTREINT_ABS), $essai_auth_http);
	exit;
}

// cas particulier, logout dans l'espace public
if ($logout_public) {
	$logout = $logout_public;
	if (!$url)
		$url = 'index.php3';
}
// tentative de logout
if ($logout) {
	verifier_visiteur();
	if ($auteur_session['login'] == $logout) {
		spip_query("UPDATE spip_auteurs SET en_ligne = DATE_SUB(NOW(),INTERVAL 6 MINUTE) WHERE id_auteur = ".$auteur_session['id_auteur']);
		if ($spip_session) {
			zap_sessions($auteur_session['id_auteur'], true);
			spip_setcookie('spip_session', $spip_session, time() - 3600 * 24);
		}
		if ($PHP_AUTH_USER AND !$ignore_auth_http) {
			auth_http(($url ? $url : _DIR_RESTREINT_ABS), 'logout');
		}
		unset ($auteur_session);
	}

	redirige_par_entete($url ? $url : "spip_login.php3");
}

// en cas de login sur bonjour=oui, on tente de poser un cookie
// puis de passer a spip_login qui diagnostiquera l'echec de cookie
// le cas echeant.
if ($test_echec_cookie == 'oui') {
	spip_setcookie('spip_session', 'test_echec_cookie');
	redirige_par_entete("spip_login.php3?var_echec_cookie=oui&url=" .
			    ($url ? $url : _DIR_RESTREINT_ABS));
}

// Tentative de login
unset ($cookie_session);
$redirect = ($url ? $url : _DIR_RESTREINT_ABS);
if ($essai_login == "oui") {
	// Recuperer le login en champ hidden
	if ($session_login_hidden AND !$session_login)
		$session_login = $session_login_hidden;

	$login = $session_login;
	$pass = $session_password;

	// Essayer differentes methodes d'authentification
	$auths = array('spip');
	include_local(_FILE_CONNECT); // pour savoir si ldap est present 
	if ($ldap_present) $auths[] = 'ldap';
	$ok = false;
	reset($auths);
	while (list(, $nom_auth) = each($auths)) {
		include_ecrire("inc_auth_".$nom_auth.".php3");
		$classe_auth = "Auth_".$nom_auth;
		$auth = new $classe_auth;
		if ($auth->init()) {
			// Essayer les mots de passe md5
			$ok = $auth->verifier_challenge_md5($login, $session_password_md5, $next_session_password_md5);
			// Sinon essayer avec le mot de passe en clair
			if (!$ok && $session_password) $ok = $auth->verifier($login, $session_password);
			if ($ok)  { $auth->lire(); break; }
		}
	}

	if ($ok) {
		$auth->activer();

		if ($auth->login AND $auth->statut == '0minirezo') // force le cookie pour les admins
			$cookie_admin = "@".$auth->login;

		$query = "SELECT * FROM spip_auteurs WHERE login='".addslashes($auth->login)."'";
		$result = spip_query($query);
		if ($row_auteur = spip_fetch_array($result))
			$cookie_session = creer_cookie_session($row_auteur);

		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
		      $redirect .= (strpos($redirect, "?") ? "&" : "?") . 'bonjour=oui';
		}
	}
	else {
		if (ereg(_DIR_RESTREINT_ABS, $redirect)) {
			$redirect = "spip_login.php3";
		}
		$redirect .= (strpos($redirect, "?") ? "&" : "?") . "var_login=$login";
		if ($session_password || $session_password_md5)
			$redirect .= '&var_erreur=pass';
		$redirect .= '&url=' . urlencode($url);
	}
 }

// cookie d'admin ?
if ($cookie_admin == "non") {
	spip_setcookie('spip_admin', $spip_admin, time() - 3600 * 24);
	$redirect = ereg_replace("[?&]var_login=[^&]*", '', $redirect);
	$redirect .= (strpos($redirect, "?") ? "&" : "?") . "var_login=-1";
}
else if ($cookie_admin AND $spip_admin != $cookie_admin) {
	spip_setcookie('spip_admin', $cookie_admin, time() + 3600 * 24 * 14);
}

// cookie de session ?
if ($cookie_session) {
	if ($session_remember == 'oui')
		spip_setcookie('spip_session', $cookie_session, time() + 3600 * 24 * 14);
	else
		spip_setcookie('spip_session', $cookie_session);

	$prefs = ($row_auteur['prefs']) ? unserialize($row_auteur['prefs']) : array();
	$prefs['cnx'] = ($session_remember == 'oui') ? 'perma' : '';
	spip_query ("UPDATE spip_auteurs SET prefs = '".addslashes(serialize($prefs))."' WHERE id_auteur = ".$row_auteur['id_auteur']);

}

// changement de langue espace public
if ($var_lang) {
	include_ecrire('inc_lang.php3');

	if (changer_langue($var_lang)) {
		spip_setcookie('spip_lang', $var_lang, time() + 365 * 24 * 3600);
		$redirect = ereg_replace("[?&]lang=[^&]*", '', $redirect);
		$redirect .= (strpos($redirect, "?") ? "&" : "?") . "lang=$var_lang";
	}
}

// changer de langue espace prive (ou login)
if ($var_lang_ecrire) {
	include_ecrire('inc_lang.php3');
	verifier_visiteur();

	if (changer_langue($var_lang_ecrire)) {
		spip_setcookie('spip_lang_ecrire', $var_lang_ecrire, time() + 365 * 24 * 3600);
		spip_setcookie('spip_lang', $var_lang_ecrire, time() + 365 * 24 * 3600);

		if (_FILE_CONNECT) {
			include_ecrire('inc_admin.php3');
			if (verifier_action_auteur('var_lang_ecrire', $valeur, $id_auteur)) {
				spip_query ("UPDATE spip_auteurs SET lang = '".addslashes($var_lang_ecrire)."' WHERE id_auteur = ".$id_auteur);
				$auteur_session['lang'] = $var_lang_ecrire;
				ajouter_session($auteur_session, $spip_session);	// enregistrer dans le fichier de session
			}
		}

		$redirect = ereg_replace("[?&]lang=[^&]*", '', $redirect);
		$redirect .= (strpos($redirect, "?") ? "&" : "?") . "lang=$var_lang_ecrire";
	}
}

// Redirection
// Sous Apache, les cookies avec une redirection fonctionnent
// Sinon, on fait un refresh HTTP

if (ereg("^Apache", $SERVER_SOFTWARE)) {
	redirige_par_entete($redirect);
}
else {
	@header("Refresh: 0; url=" . $redirect);
	echo "<html><head>";
	echo "<meta http-equiv='Refresh' content='0; url=".$redirect."'>";
	echo "</head>\n";
	echo "<body><a href='".$redirect."'>"._T('navigateur_pas_redirige')."</a></body></html>";
}

?>



From mose at berlios.de  Thu Jan 13 16:57:55 2005
From: mose at berlios.de (mose at berlios.de)
Date: Thu, 13 Jan 2005 16:57:55 +0100
Subject: [Spip-carto-cvs] CVSROOT modules,1.3,1.4
Message-ID: <200501131557.j0DFvtNM021833@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv21819

Modified Files:
	modules 
Log Message:
adaptation du nom du module secondaire

Index: modules
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/modules,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -d -r1.3 -r1.4
--- modules	13 Jan 2005 15:48:45 -0000	1.3
+++ modules	13 Jan 2005 15:57:53 -0000	1.4
@@ -26,5 +26,5 @@
 # spread out over the entire source repository.
 
 spipcarto  spipcarto
-spip-carto spipcarto
+spip-carto spip-carto
 



From stef at berlios.de  Thu Jan 13 17:04:34 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 17:04:34 +0100
Subject: [Spip-carto-cvs] spip-carto/IMG/icones defaut-dist.png,NONE,1.1 avi-dist.png,NONE,1.1 pdf-dist.png,NONE,1.1 dvi-dist.png,NONE,1.1 qt-dist.png,NONE,1.1 ra-dist.png,NONE,1.1 rm-dist.png,NONE,1.1 rpm-dist.png,NONE,1.1 ram-dist.png,NONE,1.1 sit-dist.png,NONE,1.1 html-dist.png,NONE,1.1 psd-dist.png,NONE,1.1 mpg-dist.png,NONE,1.1 sxi-dist.png,NONE,1.1 sdd-dist.png,NONE,1.1 mid-dist.png,NONE,1.1 deb-dist.png,NONE,1.1 ai-dist.png,NONE,1.1 sxw-dist.png,NONE,1.1 png-dist.png,NONE,1.1 tgz-dist.png,NONE,1.1 sdw-dist.png,NONE,1.1 mov-dist.png,NONE,1.1 rtf-dist.png,NONE,1.1 bz2-dist.png,NONE,1.1 ogg-dist.png,NONE,1.1 sxc-dist.png,NONE,1.1 ps-dist.png,NONE,1.1 wav-dist.png,NONE,1.1 aiff-dist.png,NONE,1.1 asf-dist.png,NONE,1.1 xcf-dist.png,NONE,1.1 jpg-dist.png,NONE,1.1 mp3-dist.png,NONE,1.1 txt-dist.png,NONE,1.1 xml-dist.png,NONE,1.1 xls-dist.png,NONE,1.1 gif-dist.png,NONE,1.1 eps-dist.png,NONE,1.1 tex-dist.png,NONE,1.1 zip-dist.png,NONE,1.1 tif-dist.png,NONE,1.1 doc-dist.png,NONE,1.1 bmp-dist.png!
 ,NONE,1.1 ppt-dist.png,NONE,1.1 gz-dist.png,NONE,1.1
Message-ID: <200501131604.j0DG4YNM022122@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/IMG/icones
In directory sheep:/tmp/cvs-serv21842/IMG/icones

Added Files:
	defaut-dist.png avi-dist.png pdf-dist.png dvi-dist.png 
	qt-dist.png ra-dist.png rm-dist.png rpm-dist.png ram-dist.png 
	sit-dist.png html-dist.png psd-dist.png mpg-dist.png 
	sxi-dist.png sdd-dist.png mid-dist.png deb-dist.png 
	ai-dist.png sxw-dist.png png-dist.png tgz-dist.png 
	sdw-dist.png mov-dist.png rtf-dist.png bz2-dist.png 
	ogg-dist.png sxc-dist.png ps-dist.png wav-dist.png 
	aiff-dist.png asf-dist.png xcf-dist.png jpg-dist.png 
	mp3-dist.png txt-dist.png xml-dist.png xls-dist.png 
	gif-dist.png eps-dist.png tex-dist.png zip-dist.png 
	tif-dist.png doc-dist.png bmp-dist.png ppt-dist.png 
	gz-dist.png 
Log Message:
proto

--- NEW FILE: defaut-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: avi-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: pdf-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: dvi-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: qt-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ra-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rm-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rpm-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ram-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sit-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: html-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: psd-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: mpg-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sxi-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sdd-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: mid-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deb-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ai-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sxw-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: png-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tgz-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sdw-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: mov-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rtf-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: bz2-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ogg-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: sxc-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ps-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: wav-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aiff-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: asf-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: xcf-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: jpg-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: mp3-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: txt-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: xml-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: xls-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: gif-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: eps-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tex-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: zip-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tif-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: doc-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: bmp-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ppt-dist.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: gz-dist.png ---
(This appears to be a binary file; contents omitted.)



From stef at berlios.de  Thu Jan 13 17:16:24 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 13 Jan 2005 17:16:24 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire inc_abstract_sql.php3,NONE,1.1 inc_export.php3,NONE,1.1 inc_acces.php3,NONE,1.1 config-multilang.php3,NONE,1.1 inc_charsets.php3,NONE,1.1 articles_versions.php3,NONE,1.1 inc_getdocument.php3,NONE,1.1 .cvsignore,NONE,1.1 inc_mots.php3,NONE,1.1 md5.js,NONE,1.1 message_edit.php3,NONE,1.1 inc_mail.php3,NONE,1.1 inc_presentation.php3,NONE,1.1 inc_urls.php3,NONE,1.1 statistiques_visites.php3,NONE,1.1 export.php3,NONE,1.1 forum_admin.php3,NONE,1.1 inc_auth_spip.php3,NONE,1.1 inc_sites.php3,NONE,1.1 licence_fr.html,NONE,1.1 inc_serialbase.php3,NONE,1.1 auteurs_edit.php3,NONE,1.1 cartes.php3,NONE,1.1 aide_index.php3,NONE,1.1 inc_majbase.php3,NONE,1.1 inc_import.php3,NONE,1.1 articles_forum.php3,NONE,1.1 install.php3,NONE,1.1 suivi_revisions.php3,NONE,1.1 inc_db_mysql.php3,NONE,1.1 mots_edit.php3,NONE,1.1 pclzip.lib.php,NONE,1.1 spip_style_invisible.css,NONE,1.1 auteur_infos.php3,NONE,1.1 inc_suivi_revisions.php,NONE,1.1 articles_page.php3,NONE,1.1 inc_debug!
 _sql.php3,NONE,1.1 optimiser.php3,NONE,1.1 calendrier.php3,NONE,1.1 inc_carto.php3,NONE,1.1 spip_style_print.css,NONE,1.1 forum.php3,NONE,1.1 statistiques_svg.php3,NONE,1.1 js_menu_rubriques.php,NONE,1.1 admin_repair.php3,NONE,1.1 gnu_lgpl_fr.txt,NONE,1.1 inc_meta.php3,NONE,1.1 messagerie.php3,NONE,1.1 sites.php3,NONE,1.1 breves.php3,NONE,1.1 calendrier_jour.php3,NONE,1.1 recherche.php3,NONE,1.1 http.class.php,NONE,1.1 index.php3,NONE,1.1 lab_ortho.php,NONE,1.1 config-lang.php3,NONE,1.1
Message-ID: <200501131616.j0DGGONM022509@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire
In directory sheep:/tmp/cvs-serv22503/ecrire

Added Files:
	inc_abstract_sql.php3 inc_export.php3 inc_acces.php3 
	config-multilang.php3 inc_charsets.php3 articles_versions.php3 
	inc_getdocument.php3 .cvsignore inc_mots.php3 md5.js 
	message_edit.php3 inc_mail.php3 inc_presentation.php3 
	inc_urls.php3 statistiques_visites.php3 export.php3 
	forum_admin.php3 inc_auth_spip.php3 inc_sites.php3 
	licence_fr.html inc_serialbase.php3 auteurs_edit.php3 
	cartes.php3 aide_index.php3 inc_majbase.php3 inc_import.php3 
	articles_forum.php3 install.php3 suivi_revisions.php3 
	inc_db_mysql.php3 mots_edit.php3 pclzip.lib.php 
	spip_style_invisible.css auteur_infos.php3 
	inc_suivi_revisions.php articles_page.php3 inc_debug_sql.php3 
	optimiser.php3 calendrier.php3 inc_carto.php3 
	spip_style_print.css forum.php3 statistiques_svg.php3 
	js_menu_rubriques.php admin_repair.php3 gnu_lgpl_fr.txt 
	inc_meta.php3 messagerie.php3 sites.php3 breves.php3 
	calendrier_jour.php3 recherche.php3 http.class.php index.php3 
	lab_ortho.php config-lang.php3 
Log Message:
proto

--- NEW FILE: inc_abstract_sql.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_ABSTRACT_SQL")) return;
define("_INC_ABSTRACT_SQL", "1");

// Cette fonction est systematiquement appelee par les squelettes
// pour constuire une requete SQL de type "lecture" (SELECT) a partir
// de chaque boucle.
// Elle construit et exe'cute une reque^te SQL correspondant a` une balise
// Boucle ; elle notifie une erreur SQL dans le flux de sortie et termine
// le processus.
// Sinon, retourne la ressource interrogeable par spip_abstract_fetch.
// Recoit en argument:
// - le tableau des champs a` ramener
// - le tableau des tables a` consulter
// - le tableau des conditions a` remplir
// - le crite`re de regroupement
// - le crite`re de classement
// - le crite`re de limite
// - une sous-requete e'ventuelle (MySQL > 4.1)
// - un compteur de sous-requete
// - le nom de la table
// - le nom de la boucle (pour le message d'erreur e'ventuel)
// - le serveur sollicite

function spip_abstract_select (
	$select = array(), $from = array(), $where = '',
	$groupby = '', $orderby = '', $limit = '',
	$sousrequete = '', $cpt = '',
	$table = '', $id = '', $serveur='') {

	if (!$serveur)
	  // le serveur par defaut est celui de inc_connect.php
	  // tout est deja pret, notamment la fonction suivante:
	  $f = 'spip_mysql_select';
	else {
	  // c'est un autre; est-il deja charge ?
		$f = 'spip_' . $serveur . '_select';
		if (!function_exists($f)) {
		  // non, il est decrit dans le fichier ad hoc
			$d = _DIR_RESTREINT . 'inc_connect-' . $serveur .'.php3';
			if (@file_exists($d)) include($d);
			$f = spip_abstract_serveur($f, $serveur);
		}
	}
	return $f($select, $from, $where,
		  $groupby, $orderby, $limit,
		  $sousrequete, $cpt,
		  $table, $id, $serveur);
}

function spip_abstract_serveur($f, $serveur) {
	if (function_exists($f))
		return $f;

	erreur_squelette(_L(' serveur SQL indefini'), $serveur);

	// hack pour continuer la chasse aux erreurs
	return 'array';
}

// Les 3 fonctions suivantes exploitent le resultat de la precedente,
// si l'include ne les a pas definies, erreur immediate

function spip_abstract_fetch($res, $serveur='')
{
  if (!$serveur) return spip_fetch_array($res);
  $f = spip_abstract_serveur('spip_' . $serveur . '_fetch', $serveur);
  return $f($res);
}

function spip_abstract_count($res, $serveur='')
{
  if (!$serveur) return spip_num_rows($res);
  $f = spip_abstract_serveur('spip_' . $serveur . '_count', $serveur);
  return $f($res);
}

function spip_abstract_free($res, $serveur='')
{
  if (!$serveur) return spip_free_result($res);
  $f = spip_abstract_serveur('spip_' . $serveur . '_free', $serveur);
  return $f($res);
}

function spip_abstract_insert($table, $noms, $valeurs, $serveur='')
{
  $f = (!$serveur ? 'spip_insert' :
	spip_abstract_serveur('spip_' . $serveur . '_insert', $serveur));
  return $f($table, $noms, $valeurs);
}

# une composition tellement frequente...
function spip_abstract_fetsel(
	$select = array(), $from = array(), $where = '',
	$groupby = '', $orderby = '', $limit = '',
	$sousrequete = '', $cpt = '',
	$table = '', $id = '', $serveur='') {
	return spip_abstract_fetch(spip_abstract_select(
$select, $from, $where,	$groupby, $orderby, $limit,
$sousrequete, $cpt, $table, $id, $serveur),
				   $serveur);
}
?>

--- NEW FILE: inc_export.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_EXPORT")) return;
define("_ECRIRE_INC_EXPORT", "1");



$GLOBALS['version_archive'] = '1.2';


// Conversion timestamp MySQL (format ascii) en Unix (format integer)
function mysql_timestamp_to_time($maj)
{
	$t_an = substr($maj, 0, 4);
	$t_mois = substr($maj, 4, 2);
	$t_jour = substr($maj, 6, 2);
	$t_h = substr($maj, 8, 2);
	$t_min = substr($maj, 10, 2);
	$t_sec = substr($maj, 12, 2);
	return mktime ($t_h, $t_min, $t_sec, $t_mois, $t_jour, $t_an, 0);
}

function build_begin_tag($tag) {
	return "<$tag>";
}

function build_end_tag($tag) {
	return "</$tag>";
}

// Conversion texte -> xml (ajout d'entites)
function text_to_xml($string) {
	return str_replace('<', '&lt;', str_replace('&', '&amp;', $string));
}


//
// Exportation generique d'objets (fichier ou retour de fonction)
//
function export_objets($query, $type, $file = 0, $gz = false, $etape_en_cours="", $etape_actuelle="", $nom_etape="") {
	global $debut_limit;
	if ($etape_en_cours < 1 OR $etape_en_cours == $etape_actuelle){
		if ($etape_en_cours > 0) {
			echo "<li><b>$nom_etape</b>";
		}
	
		$result = spip_query($query);

		if ($etape_en_cours > 0){
			if ($type == "forum"){
				$total = spip_num_rows($result);
				if ($total > 5000){
					$result = spip_query($query." LIMIT $debut_limit, 5000");
					$debut_limit = $debut_limit + 5000;
					if ($debut_limit > $total) {
						$debut_limit = 0;
						echo " "._T('info_tous_resultats_enregistres');
					}
					else {
						echo " "._T('info_premier_resultat', array('debut_limit' => $debut_limit, 'total' => $total));
					}
				} 
				else {
					$debut_limit = 0;
				}
			}
			if ($type == "article"){
				$total = spip_num_rows($result);
				if ($total > 500){
					$result = spip_query($query." LIMIT $debut_limit, 500");
					$debut_limit = $debut_limit + 500;
					if ($debut_limit > $total) {
						$debut_limit = 0;
						echo " "._T('info_tous_resultats_enregistres');
					}
					else {
						echo " "._T('info_premier_resultat_sur', array('debut_limit' => $debut_limit, 'total' => $total));
					}
				} 
				else {
					$debut_limit = 0;
				}
			}
		
		}
		
		$_fputs = ($gz) ? gzputs : fputs;
		$nfields = mysql_num_fields($result);
		// Recuperer les noms des champs
		for ($i = 0; $i < $nfields; ++$i) $fields[$i] = mysql_field_name($result, $i);
		while ($row = spip_fetch_array($result)) {
			$string .= build_begin_tag($type) . "\n";
			// Exporter les champs de la table
			for ($i = 0; $i < $nfields; ++$i) {
				$string .= '<'.$fields[$i].'>' . text_to_xml($row[$i]) . '</'.$fields[$i].'>' . "\n";
			}
			// Exporter les relations
			if ($type == 'article') {
				$query = 'SELECT id_auteur FROM spip_auteurs_articles WHERE id_article='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:auteur>' . $row2['id_auteur'] . '</lien:auteur>' . "\n";
				}
				spip_free_result($res2);
				$query = 'SELECT id_document FROM spip_documents_articles WHERE id_article='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:document>' . $row2['id_document'] . '</lien:document>' . "\n";
				}
				spip_free_result($res2);
			}
			else if ($type == 'message') {
				$query = 'SELECT id_auteur FROM spip_auteurs_messages WHERE id_message='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:auteur>' . $row2['id_auteur'] . '</lien:auteur>' . "\n";
				}
				spip_free_result($res2);
			}
			else if ($type == 'breve') {
				$query = 'SELECT id_document FROM spip_documents_breves WHERE id_breve='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:document>' . $row2['id_document'] . '</lien:document>' . "\n";
				}
				spip_free_result($res2);
			}
			else if ($type == 'rubrique') {
				$query = 'SELECT id_document FROM spip_documents_rubriques WHERE id_rubrique='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:document>' . $row2['id_document'] . '</lien:document>' . "\n";
				}
				spip_free_result($res2);
				$query = 'SELECT id_auteur FROM spip_auteurs_rubriques WHERE id_rubrique='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:auteur>' . $row2['id_auteur'] . '</lien:auteur>' . "\n";
				}
				spip_free_result($res2);
			}
			else if ($type == 'auteur') {
				$query = 'SELECT id_rubrique FROM spip_auteurs_rubriques WHERE id_auteur='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:rubrique>' . $row2['id_rubrique'] . '</lien:rubrique>' . "\n";
				}
				spip_free_result($res2);
			}
			else if ($type == 'mot') {
				$query = 'SELECT id_article FROM spip_mots_articles WHERE id_mot='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:article>' . $row2['id_article'] . '</lien:article>' . "\n";
				}
				spip_free_result($res2);
				$query = 'SELECT id_breve FROM spip_mots_breves WHERE id_mot='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '<lien:breve>' . $row2['id_breve'] . '</lien:breve>' . "\n";
				}
				spip_free_result($res2);
				$query = 'SELECT id_forum FROM spip_mots_forum WHERE id_mot='.$row[0];
				$res3 = spip_query($query);
				while($row3 = spip_fetch_array($res3)) {
					$string .= '<lien:forum>' . $row3['id_forum'] . '</lien:forum>' . "\n";
				}
				spip_free_result($res3);
				$query = 'SELECT id_rubrique FROM spip_mots_rubriques WHERE id_mot='.$row[0];
				$res4 = spip_query($query);
				while($row4 = spip_fetch_array($res4)) {
					$string .= '<lien:rubrique>' . $row4['id_rubrique'] . '</lien:rubrique>' . "\n";
				}
				spip_free_result($res4);
				$query = 'SELECT id_syndic FROM spip_mots_syndic WHERE id_mot='.$row[0];
				$res4 = spip_query($query);
				while($row4 = spip_fetch_array($res4)) {
					$string .= '<lien:syndic>' . $row4['id_syndic'] . '</lien:syndic>' . "\n";
				}
				spip_free_result($res4);
			}
			$string .= build_end_tag($type) . "\n\n";
			if ($file) {
				$_fputs($file, $string);
				$string = '';
			}
		}
		spip_free_result($result);
		if (!$file) return $string;
	}
	else if ($etape_actuelle < $etape_en_cours) {
		echo "<li> $nom_etape";
	} else {
		echo "<li> <font color='#999999'>$nom_etape</font>";
	}
}



?>

--- NEW FILE: inc_acces.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_ACCES")) return;
define("_ECRIRE_INC_ACCES", "1");


function creer_pass_aleatoire($longueur = 8, $sel = "") {
	$seed = (double) (microtime() + 1) * time();
	mt_srand($seed);
	srand($seed);
	$s = '';
	$pass = '';
	for ($i = 0; $i < $longueur; $i++) {
		if (!$s) {
			$s = mt_rand();
			if (!$s) $s = rand();
			$s = substr(md5(uniqid($s).$sel), 0, 16);
		}
		$r = unpack("Cr", pack("H2", $s.$s));
		$x = $r['r'] & 63;
		if ($x < 10) $x = chr($x + 48);
		else if ($x < 36) $x = chr($x + 55);
		else if ($x < 62) $x = chr($x + 61);
		else if ($x == 63) $x = '/';
		else $x = '.';
		$pass .= $x;
		$s = substr($s, 2);
	}
	$pass = ereg_replace("[./]", "a", $pass);
	$pass = ereg_replace("[I1l]", "L", $pass);
	$pass = ereg_replace("[0O]", "o", $pass);
	return $pass;
}


//
// low-security : un ensemble de fonctions pour gerer de l'identification
// faible via les URLs (suivi RSS, iCal...)
//
function low_sec($id_auteur) {
	if (!$id_auteur = intval($id_auteur)) return; // jamais trop prudent ;)
	$query = "SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur";
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$low_sec = $row["low_sec"];
		if (!$low_sec) {
			$low_sec = creer_pass_aleatoire();
			spip_query("UPDATE spip_auteurs SET low_sec = '$low_sec' WHERE id_auteur = $id_auteur");
		}
		return $low_sec;
	}
}

function afficher_low_sec ($id_auteur, $action='') {
	return substr(md5($action.low_sec($id_auteur)),0,8);
}

function verifier_low_sec ($id_auteur, $cle, $action='') {
	return ($cle == afficher_low_sec($id_auteur, $action));
}

function effacer_low_sec($id_auteur) {
	spip_query("UPDATE spip_auteurs SET low_sec = '' WHERE id_auteur = $id_auteur");
}



function initialiser_sel() {
	global $htsalt;

	$htsalt = '$1$'.creer_pass_aleatoire();
}


function ecrire_logins($fichier, $tableau_logins) {
	reset($tableau_logins);

	while(list($login, $htpass) = each($tableau_logins)) {
		if ($login && $htpass) {
			fputs($fichier, "$login:$htpass\n");
		}
	}
}


function ecrire_acces() {
	$htaccess = _DIR_RESTREINT . _ACCESS_FILE_NAME;
	$htpasswd = _DIR_SESSIONS . _AUTH_USER_FILE;

	// si .htaccess existe, outrepasser spip_meta
	if ((lire_meta('creer_htpasswd') == 'non') AND !@file_exists($htaccess)) {
		@unlink($htpasswd);
		@unlink($htpasswd."-admin");
		return;
	}

	$query = "SELECT login, htpass FROM spip_auteurs WHERE statut != '5poubelle' AND statut!='6forum'";
	$result = spip_query_db($query);	// attention, il faut au prealable se connecter a la base (necessaire car utilise par install.php3)
	$logins = array();
	while($row = spip_fetch_array($result)) $logins[$row['login']] = $row['htpass'];

	$fichier = @fopen($htpasswd, "w");
	if ($fichier) {
		ecrire_logins($fichier, $logins);
		fclose($fichier);
	} else {
		redirige_par_entete("../spip_test_dirs.php3");
	}

	$query = "SELECT login, htpass FROM spip_auteurs WHERE statut = '0minirezo'";
	$result = spip_query_db($query);

	$logins = array();
	while($row = spip_fetch_array($result)) $logins[$row['login']] = $row['htpass'];

	$fichier = fopen("$htpasswd-admin", "w");
	ecrire_logins($fichier, $logins);
	fclose($fichier);
}


function generer_htpass($pass) {
	global $htsalt, $flag_crypt;
	if ($flag_crypt) return crypt($pass, $htsalt);
	else return '';
}

//
// Verifier la presence des .htaccess
//
function verifier_htaccess($rep) {
	$htaccess = "$rep/" . _ACCESS_FILE_NAME;
	if ((!@file_exists($htaccess)) AND 
	    !defined('_ECRIRE_INSTALL') AND !defined('_TEST_DIRS')) {
		spip_log("demande de creation de $htaccess");
		if ($GLOBALS['hebergeur'] != 'nexenservices'){
			if (!$f = fopen($htaccess, "w"))
				echo "<b>" .
				  _L("ECHEC DE LA CREATION DE $htaccess") .
				  "</b>";
			else
			  {
				fputs($f, "deny from all\n");
				fclose($f);
			  }
		} else {
			echo "<font color=\"#FF0000\">IMPORTANT : </font>";
			echo "Votre h&eacute;bergeur est Nexen Services.<br />";
			echo "La protection du r&eacute;pertoire <i>$rep/</i> doit se faire
			par l'interm&eacute;diaire de ";
			echo "<a href=\"http://www.nexenservices.com/webmestres/htlocal.php\"
			target=\"_blank\">l'espace webmestres</a>.";
			echo "Veuillez cr&eacute;er manuellement la protection pour
			ce r&eacute;pertoire (un couple login/mot de passe est
			n&eacute;cessaire).<br />";
		}
	}
}

function gerer_htaccess() {
	$mode = lire_meta('creer_htaccess');
	$r = spip_query("SELECT extension FROM spip_types_documents");
	while ($e = spip_fetch_array($r)) {
		if (is_dir($dir = _DIR_DOC . $e['extension'])) {
			if ($mode == 'oui')
				verifier_htaccess($dir);
			else @unlink("$dir/" . _ACCESS_FILE_NAME);
		}
	}
	return $mode;
}

// En profiter pour verifier la securite de ecrire/data/
verifier_htaccess(_DIR_SESSIONS);

initialiser_sel();

?>

--- NEW FILE: config-multilang.php3 ---
<?php

include ("inc.php3");

include_ecrire ("inc_config.php3");

function mySel($varaut,$variable){
		$retour= " VALUE=\"$varaut\"";

	if ($variable==$varaut){
		$retour.= " SELECTED";
	}

	return $retour;
}

lire_metas();

debut_page(_T('titre_page_config_contenu'), "administration", "langues");

echo "<br><br><br>";
gros_titre(_T('info_langues'));


if ($connect_statut != '0minirezo' OR !$connect_toutes_rubriques) {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}

init_config();
if ($changer_config == 'oui') {
	appliquer_modifs_config();
	calculer_langues_rubriques();
}


barre_onglets("config_lang", "multi");


debut_gauche();

	
	
debut_droite();




echo "<form action='config-multilang.php3' method='post'>";
echo "<input type='hidden' name='changer_config' value='oui'>";

debut_cadre_couleur("traductions-24.gif", false, "", _T('info_multilinguisme'));
	echo "<p>"._T('texte_multilinguisme')."</p>";

	echo "<div>";
	echo _T('info_multi_articles');
	echo "<div style='text-align: $spip_lang_right';>";
	afficher_choix('multi_articles', lire_meta('multi_articles'),
		array('oui' => _T('item_oui'), 'non' => _T('item_non')), " &nbsp; ");
	echo "</div>";
	echo "</div>";

	echo "<div>";
	echo _T('info_multi_rubriques');
	echo "<div style='text-align: $spip_lang_right';>";
	afficher_choix('multi_rubriques', lire_meta('multi_rubriques'),
		array('oui' => _T('item_oui'), 'non' => _T('item_non')), " &nbsp; ");
	echo "</div>";
	echo "</div>";

	if  (lire_meta('multi_rubriques') == 'oui') {
		echo "<div>";
		echo _T('info_multi_secteurs');
		echo "<div style='text-align: $spip_lang_right';>";
		afficher_choix('multi_secteurs', lire_meta('multi_secteurs'),
			array('oui' => _T('item_oui'), 'non' => _T('item_non')), " &nbsp; ");
		echo "</div>";
		echo "</div>";
	} else
		echo "<input type='hidden' name='multi_secteurs' value='".lire_meta('multi_secteurs')."'>";

	if ((lire_meta('multi_rubriques') == 'oui') OR (lire_meta('multi_articles') == 'oui')) {
		echo "<hr>";
		echo "<p>"._T('texte_multilinguisme_trad')."</p>";

		echo _T('info_gerer_trad');
		echo "<div style='text-align: $spip_lang_right';>";
		afficher_choix('gerer_trad', lire_meta('gerer_trad'),
			array('oui' => _T('item_oui'), 'non' => _T('item_non')), " &nbsp; ");
		echo "</div>";
	} else
		echo "<input type='hidden' name='gerer_trad' value='".lire_meta('gerer_trad')."'>";


	echo "<div style='text-align: $spip_lang_right;'><INPUT TYPE='submit' NAME='Valider' VALUE='"._T('bouton_valider')."' CLASS='fondo'></div>";

fin_cadre_couleur();

	if (lire_meta('multi_articles') == "oui" OR lire_meta('multi_rubriques') == "oui") {
		echo "<p>";
		debut_cadre_relief("langues-24.gif");
		echo "<p class='verdana2'>";
		echo _T('info_multi_langues_choisies');
		echo '</p>';

		$langues = $GLOBALS['codes_langues'];
		$cesure = floor((count($langues) + 1) / 2);

		$langues_installees = explode(',', $GLOBALS['all_langs']);
		$langues_autorisees = explode(',', lire_meta('langues_multilingue'));

		while (list(,$l) = each ($langues_installees)) {
			$langues_trad[$l] = true;
		}

		while (list(,$l) = each ($langues_autorisees)) {
			$langues_auth[$l] = true;
		}

		$langues_bloquees[lire_meta('langue_site')] = 1;
		$query = "SELECT DISTINCT lang FROM spip_articles WHERE statut='publie'";
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$langues_bloquees[$row['lang']] = 1;
		}
		$query = "SELECT DISTINCT lang FROM spip_breves WHERE statut='publie'";
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$langues_bloquees[$row['lang']] = 1;
		}
		$query = "SELECT DISTINCT lang FROM spip_rubriques WHERE statut='publie'";
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$langues_bloquees[$row['lang']] = 1;
		}

		echo "<table width = '100%' cellspacing='10'><tr><td width='50%' align='top' class='verdana1'>";

		ksort($langues_bloquees);
		while (list($code_langue, ) = each($langues_bloquees)) {
			$i++;
			echo "<div>";
			$nom_langue = $langues[$code_langue];
			if ($langues_trad[$code_langue]) $nom_langue = "<u>$nom_langue</u>";
			$nom_langue = "<b><font color='$couleur_foncee'>$nom_langue</font></b>";
			echo "<input type='hidden' name='langues_auth[]' value='$code_langue' id='langue_auth_$code_langue'>";
			echo "<input type='checkbox' checked disabled>";
			echo  " $nom_langue &nbsp; &nbsp;<font color='#777777'>[$code_langue]</font>";
			echo "</div>\n";

			if ($i == $cesure) echo "</td><td width='50%' align='top' class='verdana1'>";
		}

		echo "<div>&nbsp;</div>";

		while (list($code_langue, $nom_langue) = each($langues)) {
			if ($langues_bloquees[$code_langue]) continue;
			$i++;
			echo "<div>";
			if ($langues_trad[$code_langue]) $nom_langue = "<u>$nom_langue</u>";
	
			if ($langues_auth[$code_langue]) {
				echo "<input type='checkbox' name='langues_auth[]' value='$code_langue' id='langue_auth_$code_langue' checked>";
				$nom_langue = "<b>$nom_langue</b>";
			}
			else {
				echo "<input type='checkbox' name='langues_auth[]' value='$code_langue' id='langue_auth_$code_langue'>";
			}
			echo  " <label for='langue_auth_$code_langue'>$nom_langue</label> &nbsp; &nbsp;<font color='#777777'>[$code_langue]</font>";

			echo "</div>\n";

			if ($i == $cesure) echo "</font></td><td width='50%' align='top' class='verdana1'>";
		}

		echo "</td></tr>";
		echo "<tr><td style='text-align:$spip_lang_right;' COLSPAN=2>";
		echo "<INPUT TYPE='submit' NAME='Valider' VALUE='"._T('bouton_valider')."' CLASS='fondo'>";
		echo "</td></tr></table>";
		
		
		echo "<div class='verdana1'>"._T("info_multi_langues_soulignees")."</div>";

		fin_cadre_relief();
	}



echo "</form>";

fin_page();

?>

--- NEW FILE: inc_charsets.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_CHARSETS")) return;
define("_ECRIRE_INC_CHARSETS", "1");


/* charsets supportes :
	utf-8 ;
	iso-8859-1 ; iso-8859-15 ;
	windows-1251  = CP1251 ;
*/
function load_charset ($charset = 'AUTO', $langue_site = 'AUTO') {
	if ($charset == 'AUTO')
		$charset = lire_meta('charset');
	if (is_array($GLOBALS['CHARSET'][$charset]))
		return $charset;

[...2383 lines suppressed...]
	// Le probleme d'iconv c'est qu'il risque de nous renvoyer des ? alors qu'on
	// prefere garder l'utf-8 pour que la chaine soit indexable.
	// 3. Translitterer grace a iconv
	if ($GLOBALS['flag_iconv'] && ereg('&#0*([0-9]+);', $texte)) {
		$texte = iconv('utf-8', 'ascii//translit', $texte);
	}
*/

	return $texte;
}

function translitteration_complexe($texte) {
	return translitteration($texte,'AUTO','complexe');
}


// Initialisation
$GLOBALS['CHARSET'] = Array();

?>

--- NEW FILE: articles_versions.php3 ---
<?php

include("inc_lab.php");

include_spip("ecrire.php");
include_spip("revisions.php");



//
// Lire l'article
//

$champs = array('surtitre', 'titre', 'soustitre', 'descriptif', 'nom_site', 'url_site', 'chapo', 'texte', 'ps');

$query = "SELECT * FROM spip_articles WHERE id_article='$id_article'";
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$id_article = $row["id_article"];
	$id_rubrique = $row["id_rubrique"];
	$date = $row["date"];
	$statut_article = $row["statut"];
	$maj = $row["maj"];
	$date_redac = $row["date_redac"];
	$visites = $row["visites"];
	$referers = $row["referers"];
	$extra = $row["extra"];
	$id_trad = $row["id_trad"];
}

if (!($id_version = intval($id_version))) {
	$id_version = $row['id_version'];
}
$textes = recuperer_version($id_article, $id_version);

$id_diff = intval($id_diff);
if (!$id_diff) {
	$diff_auto = true;
	$query = "SELECT id_version FROM spip_versions WHERE id_article=$id_article ".
		"AND id_version<$id_version ORDER BY id_version DESC LIMIT 0,1";
	if ($result = spip_query($query)) {
		$row = mysql_fetch_array($result);
		$id_diff = $row['id_version'];
	}
}

//
// Calculer le diff
//

if ($id_version && $id_diff) {
	include_spip("diff.php");

	if ($id_diff > $id_version) {
		$t = $id_version;
		$id_version = $id_diff;
		$id_diff = $t;
		$old = $textes;
		$new = $textes = recuperer_version($id_article, $id_version);
	}
	else {
		$old = recuperer_version($id_article, $id_diff);
		$new = $textes;
	}

	$textes = array();
	
	foreach ($champs as $champ) {
		if (!$new[$champ] && !$old[$champ]) continue;

		$diff = new Diff(new DiffTexte);
		$textes[$champ] = afficher_diff($diff->comparer(preparer_diff($new[$champ]), preparer_diff($old[$champ])));
	}
}

if (is_array($textes))
foreach ($textes as $var => $t) $$var = $t;



debut_page(_T('info_historique')." &laquo; $titre &raquo;", "documents", "articles");

debut_grand_cadre();

afficher_hierarchie($id_rubrique);

fin_grand_cadre();



//////////////////////////////////////////////////////
// Affichage de la colonne de gauche
//

debut_gauche();



//////////////////////////////////////////////////////
// Affichage de la colonne de droite
//

debut_droite();

changer_typo('','article'.$id_article);

echo "<a name='diff'></a>\n";

debut_cadre_relief();

//
// Titre, surtitre, sous-titre
//

if ($statut_article=='publie') {
	$logo_statut = "puce-verte.gif";
}
else if ($statut_article=='prepa') {
	$logo_statut = "puce-blanche.gif";
}
else if ($statut_article=='prop') {
	$logo_statut = "puce-orange.gif";
}
else if ($statut_article == 'refuse') {
	$logo_statut = "puce-rouge.gif";
}
else if ($statut_article == 'poubelle') {
	$logo_statut = "puce-poubelle.gif";
}


echo "\n<table cellpadding='0' cellspacing='0' border='0' width='100%'>";
echo "<tr width='100%'><td width='100%' valign='top'>";
if ($surtitre) {
	echo "<span $dir_lang><font face='arial,helvetica' size='3'><b>";
	echo typo($surtitre);
	echo "</b></font></span>\n";
}
gros_titre($titre, $logo_statut);

if ($soustitre) {
	echo "<span $dir_lang><font face='arial,helvetica' size='3'><b>";
	echo typo($soustitre);
	echo "</b></font></span>\n";
}


if ($descriptif OR $url_site OR $nom_site) {
	echo "<p><div align='left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;' $dir_lang>";
	echo "<font size='2' face='Verdana,Arial,Sans,sans-serif'>";
	$texte_case = ($descriptif) ? "{{"._T('info_descriptif')."}} $descriptif\n\n" : '';
	$texte_case .= ($nom_site.$url_site) ? "{{"._T('info_urlref')."}} [".$nom_site."->".$url_site."]" : '';
	echo propre($texte_case);
	echo "</font>";
	echo "</div>";
}

echo "</td>";

echo "<td align='center'>";
icone(_T('icone_retour_article'), "articles.php3?id_article=$id_article", "", "article-24.gif");
echo "</td>";

echo "</tr></table>";


//////////////////////////////////////////////////////
// Affichage des versions
//

debut_cadre_relief();

$query = "SELECT id_version, titre_version, date, v.id_auteur, a.nom ".
	"FROM spip_versions AS v, spip_auteurs AS a ".
	"WHERE id_article=$id_article AND v.id_auteur=a.id_auteur ORDER BY id_version DESC";
$result = spip_query($query);

echo "<ul class='verdana3'>";
while ($row = spip_fetch_array($result)) {
	echo "<li>\n";
	$date = affdate_heure($row['date']);
	$version_aff = $row['id_version'];
	$titre_version = typo($row['titre_version']);
	$titre_aff = $titre_version ? $titre_version : $date;
	if ($version_aff != $id_version) {
		$link = new Link();
		$link->addVar('id_version', $version_aff);
		$link->delVar('id_diff');
		echo "<a href='".$link->getUrl('diff')."' title=\""._T('info_historique_affiche')."\">$titre_aff</a>";
	}
	else {
		echo "<b>$titre_aff</b>";
	}
	echo " (".typo($row['nom']).")";
	#if ($options == 'avancees') {	// note : c'est redondant car on ne peut arriver sur cette page qu'en options avancees...
		//echo " <span style='color:#989898; font-size: 80%; font-weight: bold;'><i>#".$row['id_version']."</i></span>";
		if ($version_aff != $id_version) {
			echo " <span class='verdana2'>";
			if ($version_aff == $id_diff) {
				echo "<b>("._T('info_historique_comparaison').")</b>";
			}
			else {
				$link = new Link();
				$link->addVar('id_version', $id_version);
				$link->addVar('id_diff', $version_aff);
				echo "(<a href='".$link->getUrl('diff').
				"'>"._T('info_historique_comparaison')."</a>)";
			}
			echo "</span>";
		}
	#} // fin avancees
	echo "</li>\n";
}
echo "</ul>\n";

fin_cadre_relief();


//////////////////////////////////////////////////////
// Corps de la version affichee
//

if ($id_version) {
	echo "\n\n<div align='justify'>";

	// pour l'affichage du virtuel
	unset($virtuel);
	if (substr($chapo, 0, 1) == '=') {
		$virtuel = substr($chapo, 1);
	}
	
	if ($virtuel) {
		debut_boite_info();
		echo _T('info_renvoi_article')." ".propre("<center>[->$virtuel]</center>");
		fin_boite_info();
	}
	else {
		echo "<div $dir_lang><b>";
		$revision_nbsp = ($options == "avancees");	// a regler pour relecture des nbsp dans les articles
		echo justifier(propre($chapo));
		echo "</b></div>\n\n";
	
		echo "<div $dir_lang>";
		echo justifier(propre($texte));
		echo "</div>";
	
		if ($ps) {
			echo debut_cadre_enfonce();
			echo "<div $dir_lang><font size='2' face='Verdana,Arial,Sans,sans-serif'>";
			echo justifier("<b>"._T('info_ps')."</b> ".propre($ps));
			echo "</font></div>";
			echo fin_cadre_enfonce();
		}
		$revision_nbsp = false;
	
		if ($les_notes) {
			echo debut_cadre_relief();
			echo "<div $dir_lang><font size='2'>";
			echo justifier("<b>"._T('info_notes')."&nbsp;:</b> ".$les_notes);
			echo "</font></div>";
			echo fin_cadre_relief();
		}
	
		if ($champs_extra AND $extra) {
			include_spip("extra.php");
			extra_affichage($extra, "articles");
		}
	}
}

fin_cadre_relief();


fin_page();

?>

--- NEW FILE: inc_getdocument.php3 ---
<?php

function creer_repertoire_documents($ext) {
	global $dossier_squelettes;

# est-il bien raisonnable d'accepter de creer si creer_rep retourne '' ?
	$rep = _DIR_DOC . creer_repertoire(_DIR_DOC, $ext);
	// Securite
	if (!$ext || ($rep == $dossier_squelettes) || (substr($rep,0,-1) == $dossier_squelettes))
		{
		  spip_log("creer_repertoire_documents interdit");
		  exit;
		}
	if (lire_meta("creer_htaccess") == 'oui') {
		include_ecrire('inc_acces.php3');
		verifier_htaccess($rep);
	}
	return $rep;
}


function copier_document($ext, $orig, $source) {

	$dir = creer_repertoire_documents($ext);
	$dest = $dir .
		ereg_replace("[^.a-zA-Z0-9_=-]+", "_", 
			translitteration(ereg_replace("\.([^.]+)$", "", 
						      ereg_replace("<[^>]*>", '', basename($orig)))));

	# bien vu ?
	if ($source == ($dest . '.' . $ext)) return $source;
	$n = 0;
	while (@file_exists($newFile = $dest.($n++ ? '-'.$n : '').'.'.$ext));
	$r = deplacer_fichier_upload($source, $newFile);
	return (!$r ? '' : $newFile);
}

function verifier_compactes($image_name) {

	$zip = new PclZip($image_name);

	if ($list = $zip->listContent()) {
	// si pas possible de decompacter: installer comme fichier zip joint
	// Verifier si le contenu peut etre uploade (verif extension)
		$aff_fichiers = array();
		for ($i=0; $i<sizeof($list); $i++) {
			for(reset($list[$i]); $key = key($list[$i]); next($list[$i])) {
			
				if ($key == "stored_filename") {
					$f =  $list[$i][$key];
					  // Regexp des fichiers a ignorer
					if (!ereg("^(\.|.*/\.|.*__MACOSX/)", $f)) {
						if (ereg("\.([^.]+)$", $f, $match)) {
							$result = spip_query("SELECT * FROM spip_types_documents WHERE extension='"
. corriger_extension(addslashes(strtolower($match[1]))) 
									     . "' AND upload='oui'");
							if ($row = @spip_fetch_array($result))
								$aff_fichiers[]= $f;
							else
							spip_log("chargement de $f interdit");
							
						}
					}
				}
			}
		}
	}

	return $aff_fichiers ;
}

function afficher_compactes($image_name, $fichiers, $link) {
// presenter une interface pour choisir si fichier joint ou decompacter
// passer ca en squelette un de ces jours.

	include_ecrire ("inc_presentation.php3");
	install_debut_html(_T('upload_fichier_zip'));
	echo "<p>",
		_T('upload_fichier_zip_texte'),
		"</p>",
		"<p>",
		_T('upload_fichier_zip_texte2'),
		"</p>",
		$link->getForm('POST'),
		_L(''),
		"<div><input type='radio' checked name='action_zip' value='telquel'>",
		_T('upload_zip_telquel'),
		"</div>",
		"<div><input type='radio' name='action_zip' value='decompacter'>",
		_T('upload_zip_decompacter'),
		"</div>",
		"<ul><li>" ,
		 join("</li>\n<li>",$fichiers) ,
		 "</li></ul>",
		"<div>&nbsp;</div>",
		"<div style='text-align: right;'><input class='fondo' style='font-size: 9px;' type='submit' value='",
		_T('bouton_valider'),
		"'></div>",
		"</form>";
	install_fin_html();
}

//
// Ajouter un unique document
//

function ajout_doc($orig, $source, $mode, $id_document) {
	global $hash_id_auteur, $hash, $id_article, $type;
	//
	// Securite
	//
	if (!verifier_action_auteur("ajout_doc", $hash, $hash_id_auteur))
		return;

	// type de document inconnu ?

	if (!ereg("\.([^.]+)$", $orig, $match)) return;

	$ext = corriger_extension(addslashes(strtolower($match[1])));
	$row = spip_query("SELECT * FROM spip_types_documents WHERE extension='$ext' AND upload='oui'" . (($mode != 'vignette') ? '' : " AND inclus='image'"));

	// type de document invalide ?

	if (!$row = spip_fetch_array($row)) {return;}

	// Recopier le fichier sauf si deja fait (zip tel quel)

	$dest_path = !$source ? $orig : copier_document($ext,$orig, $source);

	if (!$dest_path) return;

	// Preparation
	if ($mode == 'vignette') {
		$id_document_lie = $id_document;
		$query = "UPDATE spip_documents SET mode='document' where id_document='$id_document_lie'";
		spip_query($query); // requete inutile a mon avis (Fil)...
		$id_document = 0;
	}
	if (!$id_document) {
		$id_type = $row['id_type'];
		$id_document = spip_abstract_insert("documents", "(id_type, titre, date)", "($id_type, '', NOW())");
		$nouveau = true;
		if ($id_article && isset($type)) {
			$query = "INSERT INTO spip_documents_".$type."s (id_document, id_".$type.") VALUES ($id_document, $id_article)";
			spip_query($query);
		}
	}
	//
	// Mettre a jour les infos du document uploade
	//
	$size_image = @getimagesize($dest_path);
	$type_image = decoder_type_image($size_image[2]);
	if ($type_image) {
		$largeur = $size_image[0];
		$hauteur = $size_image[1];
	}
	$taille = filesize($dest_path);
	if ($nouveau) {
		$type_inclus = $row['inclus'];
		if (!$mode) $mode = ($type_image AND $type_inclus == 'image') ? 'vignette' : 'document';
			$update = "mode='$mode', ";
	}

	spip_query("UPDATE spip_documents SET $update taille='$taille', largeur='$largeur', hauteur='$hauteur', fichier='$dest_path' WHERE id_document=$id_document");

	if ($id_document_lie) {
		$query = "UPDATE spip_documents SET id_vignette=$id_document WHERE id_document=$id_document_lie";
		spip_query($query);
		$id_document = $id_document_lie; // pour que le 'return' active le bon doc.
	}

	// Creer la vignette
	if ($mode == 'document' AND ereg(",$ext,", ','.lire_meta('formats_graphiques').',')) {
		creer_fichier_vignette($dest_path);
	}
}

// Ajouter un ou plusieurs documents ?

function ajout_doc_zip($image, $image_name, $mode, $forcer_document, $action_zip, $id_document, $hash, $link)
{
// image_name n'est valide que par POST http, mais pas par la methode ftp/upload
// par ailleurs, pour un fichier ftp/upload, il faut effacer l'original nous-memes
// action_zip indique un rappel par la fonction affiche_compactes
	if (!$action_zip){
		// on va se rappeler: copier le fichier car PHP va le virer
		$image_name = copier_document("zip", $image_name, $image);
		// anormal, on se tire
		if (!$image_name) exit;
		// renvoyer un formulaire demandant si on deballe ou pas
		require_once(_DIR_RESTREINT . 'pclzip.lib.php');
		$fichiers = verifier_compactes($image_name);
		if ($fichiers) {
			$link->addVar("image_name", $image_name);
			afficher_compactes($image_name, $fichiers, $link);
			exit;
		}
		// pas possible de deballer, on continue
		$forcer_document = 'oui';
		$image = $image_name;
	  }
	  else {
	    // reponse au formulaire
		if ($action_zip == "telquel") {
			$forcer_document = 'oui';
			
		} else {
			require_once(_DIR_RESTREINT . 'pclzip.lib.php');
  			$archive = new PclZip($image_name);
			$tmp_dir = creer_repertoire_documents($hash);
			$archive->extract(PCLZIP_OPT_PATH, $tmp_dir, PCLZIP_OPT_REMOVE_ALL_PATH);
			# virer le zip apr?s le d?ballage
			@unlink($image_name);
			$image_name = $tmp_dir;

		}
	  }
	ajout_doc_s($image, $image_name, $mode, $forcer_document,$id_document, $hash);
}

function ajout_doc_s($image, $image_name, $mode, $forcer_document, $id_document, $hash) 
{
	if (!is_dir($image_name)) {
		ajout_doc($image_name,
			  $image,
			  ($forcer_document == 'oui' ? "document" : $mode),
			  $id_document);
	} else {
		include_ecrire('inc_documents.php3');
		$fichiers = fichiers_upload($image_name);

		while (list(,$f) = each($fichiers)) {
			if (ereg("\.([^.]+)$", $f, $match)) {
				$ext = strtolower($match[1]);
				if ($ext == 'jpeg')
					$ext = 'jpg';
				$r = spip_query("SELECT extension FROM spip_types_documents WHERE extension='$ext'" . ($inclus ? " AND inclus='$inclus'" : ''));
				if (spip_fetch_array($r))
					ajout_doc($f, $f, 'document', false);
			}
		}

# d?truire le repertoire de deballage
		if ($tmp_dir) effacer_repertoire_temporaire($tmp_dir);
	}
}

function effacer_repertoire_temporaire($nom) {
	$d = opendir($nom);
	while ($f = readdir($d)) {
		if (is_file($f = "$nom/$f")) @unlink($f);
		}
	@rmdir($nom);
}
?>

--- NEW FILE: .cvsignore ---
inc_connect.php3
inc_meta_cache.php3

--- NEW FILE: inc_mots.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_MOTS")) return;
define("_ECRIRE_INC_MOTS", "1");

include_ecrire("inc_filtres.php3"); # pour http_script (normalement d?j? fait)

$GLOBALS['flag_mots_ressemblants'] = $GLOBALS['flag_levenshtein'];


// ne pas faire d'erreur si les chaines sont > 254 caracteres
function levenshtein255 ($a, $b) {
	$a = substr($a, 0, 254);
	$b = substr($b, 0, 254);
	return @levenshtein($a,$b);
}

function mots_ressemblants($mot, $table_mots, $table_ids='') {
	$lim = 2;
	$nb = 0;
	$opt = 1000000;
	$mot_opt = '';
	$mot = strtolower(trim($mot));
	$len = strlen($mot);

	if (!$table_mots) return '';

	while (!$nb AND $lim < 10) {
		reset($table_mots);
		if ($table_ids) reset($table_ids);
		while (list(, $val) = each($table_mots)) {
			if ($table_ids) list(, $id) = each($table_ids);
			else $id = $val;
			$val2 = trim($val);
			if ($val2) {
				if (!($m = $distance[$id])) {
					$val2 = strtolower($val2);
					$len2 = strlen($val2);
					if (substr($val2, 0, $len) == $mot) $m = -1;
					else if ($len2 > $len) $m = levenshtein255($val2, $mot) + $len - $len2;
					else $m = levenshtein255($val2, $mot);
					$distance[$id] = $m;
				}
				if ($m <= $lim) {
					$selection[$id] = $m;
					if ($m < $opt) {
						$opt = $m;
						$mot_opt = $val;
					}
					$nb++;
				}
			}
		}
		$lim += 2;
	}

	if (!$nb) return '';
	reset($selection);
	if ($opt != -1) {
		$moy = 1;
		while(list(, $val) = each($selection)) $moy *= $val;
		if($moy) $moy = pow($moy, 1.0/$nb);
		$lim = ($opt + $moy) / 2;
	}
	else $lim = -1;

	reset($selection);
	while (list($key, $val) = each($selection)) {
		if ($val <= $lim) {
			$result[] = $key;
		}
	}
	return $result;
}


/*
 * Affiche la liste des mots-cles associes a l'objet
 * specifie, plus le formulaire d'ajout de mot-cle
 */

function formulaire_mots($table, $id_objet, $nouv_mot, $supp_mot, $cherche_mot, $flag_editable) {
	global $flag_mots_ressemblants;
	global $connect_statut, $options;
	global $spip_lang_rtl, $spip_lang_right;

	$select_groupe = $GLOBALS['select_groupe'];

	if ($table == 'articles') {
		$id_table = 'id_article';
		$objet = 'article';
		$url_base = "articles.php3?id_article=$id_objet";
	}
	else if ($table == 'breves') {
		$id_table = 'id_breve';
		$objet = 'breve';
		$url_base = "breves_voir.php3?id_breve=$id_objet";
	}
	else if ($table == 'rubriques') {
		$id_table = 'id_rubrique';
		$objet = 'rubrique';
		$url_base = "naviguer.php3?id_rubrique=$id_objet";
	}

	else if ($table == 'syndic') {
		$id_table = 'id_syndic';
		$objet = 'syndic';
		$url_base = "sites.php3?id_syndic=$id_objet";
	}

	$query = "SELECT mots.* FROM spip_mots AS mots, spip_mots_$table AS lien WHERE lien.$id_table=$id_objet AND mots.id_mot=lien.id_mot";
	$nombre_mots = spip_num_rows(spip_query($query));

	$query_groupes = "SELECT * FROM spip_groupes_mots WHERE $table = 'oui' AND $connect_statut = 'oui'";
	$nombre_groupes = spip_num_rows(spip_query($query_groupes));

	if (!$nombre_mots AND (!$nombre_groupes OR !$flag_editable)) return;

	echo "<a name='mots'></a>";
	if ($flag_editable){
		if ($nouv_mot.$cherche_mot.$supp_mot)
			$bouton = bouton_block_visible("lesmots");
		else
			$bouton =  bouton_block_invisible("lesmots");
	}
	debut_cadre_enfonce("mot-cle-24.gif", false, "", $bouton._T('titre_mots_cles').aide ("artmots"));

	//////////////////////////////////////////////////////
	// Recherche de mot-cle
	//

	if ($nouv_mot)
		$nouveaux_mots[] = $nouv_mot;

	$tous_les_mots = split(" *[,;] *", $cherche_mot);
	while ((list(,$cherche_mot) = each ($tous_les_mots)) AND $cherche_mot) {
		echo "<P ALIGN='left'>";
		$query = "SELECT id_mot, titre FROM spip_mots WHERE id_groupe='$select_groupe'";
		$result = spip_query($query);
		unset($table_mots);
		unset($table_ids);
		while ($row = spip_fetch_array($result)) {
			$table_ids[] = $row['id_mot'];
			$table_mots[] = $row['titre'];
		}
		$resultat = mots_ressemblants($cherche_mot, $table_mots, $table_ids);
		debut_boite_info();
		if (!$resultat) {
			echo "<B>"._T('info_non_resultat', array('cherche_mot' => $cherche_mot))."</B><BR>";
		}
		else if (count($resultat) == 1) {
			list(, $nouv_mot) = each($resultat);
			$nouveaux_mots[] = $nouv_mot;
			echo "<B>"._T('info_mot_cle_ajoute')." ";
			if ($table == 'articles') echo _T('info_l_article');
			else if ($table == 'breves') echo _T('info_la_breve');
			else if ($table == 'rubriques') echo _T('info_la_rubrique');
			echo " : </B><BR>";
			$query = "SELECT * FROM spip_mots WHERE id_mot=$nouv_mot";
			$result = spip_query($query);
			echo "<UL>";
			while ($row = spip_fetch_array($result)) {
				$id_mot = $row['id_mot'];
				$titre_mot = $row['titre'];
				$type_mot = typo($row['type']);
				$descriptif_mot = $row['descriptif'];

				echo "<LI><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2><B><FONT SIZE=3>".typo($titre_mot)."</FONT></B>";
				echo "</FONT>\n";
			}
			echo "</UL>";
		}
		else if (count($resultat) < 16) {
			reset($resultat);
			unset($les_mots);
			while (list(, $id_mot) = each($resultat)) $les_mots[] = $id_mot;
			if ($les_mots) {
				$les_mots = join(',', $les_mots);
				echo "<B>"._T('info_plusieurs_mots_trouves', array('cherche_mot' => $cherche_mot))."</B><BR>";
				$query = "SELECT * FROM spip_mots WHERE id_mot IN ($les_mots) ORDER BY titre";
				$result = spip_query($query);
				echo "<UL>";
				while ($row = spip_fetch_array($result)) {
					$id_mot = $row['id_mot'];
					$titre_mot = $row['titre'];
					$type_mot = typo($row['type']);
					$descriptif_mot = $row['descriptif'];

					echo "<LI><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2><B><FONT SIZE=3>".typo($titre_mot)."</FONT></B>";

					if ($type_mot) echo " ($type_mot)";
					echo " | <A HREF=\"$url_base&nouv_mot=$id_mot#mots\">"._T('info_ajouter_mot')."</A>";

					if (strlen($descriptif_mot) > 1) {
						echo "<BR><FONT SIZE=1>".propre(couper($descriptif_mot, 100))."</FONT>\n";
					}
					echo "</FONT><p>\n";
				}
				echo "</UL>";
			}
		}
		else {
			echo "<B>"._T('info_trop_resultat', array('cherche_mot' => $cherche_mot))."<BR>";
		}

		if ($GLOBALS['connect_statut'] == '0minirezo') {
			echo "<div style='width: 200px;'>";
			$retour = urlencode($GLOBALS['clean_link']->getUrl());
			$titre = urlencode($cherche_mot);
			icone_horizontale(_T('icone_creer_mot_cle'), "mots_edit.php3?new=oui&ajouter_id_article=$id_objet&titre=$titre&redirect=$retour", "mot-cle-24.gif", "creer.gif");
			echo "</div> ";
		}

		fin_boite_info();
		echo "<P>";

	}


	//////////////////////////////////////////////////////
	// Appliquer les modifications sur les mots-cles
	//

	if ($nouveaux_mots && $flag_editable) {
		while ((list(,$nouv_mot) = each($nouveaux_mots)) AND $nouv_mot!='x') {
			$query = "SELECT * FROM spip_mots_$table WHERE id_mot=$nouv_mot AND $id_table=$id_objet";
			$result = spip_query($query);
			if (!spip_num_rows($result)) {
				$query = "INSERT INTO spip_mots_$table (id_mot,$id_table) VALUES ($nouv_mot, $id_objet)";
				$result = spip_query($query);
			}
		}
		$reindexer = true;
	}

	if ($supp_mot && $flag_editable) {
		if ($supp_mot == -1)
			$mots_supp = "";
		else
			$mots_supp = " AND id_mot=$supp_mot";
		$query = "DELETE FROM spip_mots_$table WHERE $id_table=$id_objet $mots_supp";
		$result = spip_query($query);
		$reindexer = true;
	}


	if ($reindexer AND lire_meta('activer_moteur') == 'oui') {
		include_ecrire ("inc_index.php3");
		marquer_indexer($objet, $id_objet);
	}

	//
	// Afficher les mots-cles
	//

	$query = "SELECT DISTINCT type FROM spip_mots";
	$result = spip_query($query);
	$plusieurs_types = (spip_num_rows($result) > 1);

	unset($les_mots);

	$query = "SELECT mots.* FROM spip_mots AS mots, spip_mots_$table AS lien WHERE lien.$id_table=$id_objet AND mots.id_mot=lien.id_mot ORDER BY mots.type, mots.titre";
	$result = spip_query($query);

	if (spip_num_rows($result) > 0) {
		echo "<div class='liste'>";
		echo "<table width='100%' cellpadding='3' cellspacing='0' border='0' background=''>";
	
		$ifond=0;
			
		$tableau= '';
		while ($row = spip_fetch_array($result)) {
			$vals = '';
		
			$id_mot = $row['id_mot'];
			$titre_mot = $row['titre'];
			$type_mot = typo($row['type']);
			$descriptif_mot = $row['descriptif'];
			$id_groupe = $row['id_groupe'];
	
			$query_groupe = "SELECT * FROM spip_groupes_mots WHERE id_groupe = $id_groupe";
			$result_groupe = spip_query($query_groupe);
			while($row_groupe = spip_fetch_array($result_groupe)) {
				$id_groupe = $row_groupe['id_groupe'];
				$titre_groupe = entites_html($row_groupe['titre']);
				$unseul = $row_groupe['unseul'];
				$obligatoire = $row_groupe['obligatoire'];
				$acces_admin =  $row_groupe['0minirezo'];
				$acces_redacteur = $row_groupe['1comite'];
	
				$flag_groupe = ($flag_editable AND (($connect_statut == '1comite' AND $acces_redacteur == 'oui') OR ($connect_statut == '0minirezo' AND $acces_admin == 'oui')));
			}
	
			$groupes_vus[$id_groupe] = true;
			$id_groupes_vus[] = $id_groupe;
	
			if ($ifond==0){
				$ifond=1;
				$couleur="#FFFFFF";
			}else{
				$ifond=0;
				$couleur="#EDF3FE";
			}
	
			$url = "mots_edit.php3?id_mot=$id_mot&redirect=".rawurlencode($url_base.'#mots');
	
			$vals[] = "<A HREF='$url'>" . http_img_pack('petite-cle.gif', "", "width='23' height='12' border='0'") ."</A>";
			
	
			// Changer
			if ($unseul == "oui" AND $flag_groupe) {
				$s = "<form action='$url_base#mots' method='post' style='margin:0px; padding: 0px'>";
				$s .= "<INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'>";
				if ($table == 'rubriques') $s .= "<INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'>";
				$s .= "<select name='nouv_mot' onChange=\"setvisibility('valider_groupe_$id_groupe', 'visible');\" CLASS='fondl' STYLE='font-size:10px; width:90px;'>";
	
				$query_autres_mots = "SELECT * FROM spip_mots WHERE id_groupe = $id_groupe ORDER by titre";
				$result_autres_mots = spip_query($query_autres_mots);
				while ($row_autres = spip_fetch_array($result_autres_mots)) {
					$le_mot = $row_autres['id_mot'];
					$le_titre_mot = supprimer_tags(typo($row_autres['titre']));
	
					if ($le_mot == $id_mot) $selected = "SELECTED";
					else $selected = "";
					$s .= "<option value='$le_mot' $selected> $le_titre_mot";
				}
				$s .= "</select>";
				$s .= "<INPUT TYPE='Hidden' NAME='supp_mot' VALUE='$id_mot'>";
				$s .= "<span class='visible_au_chargement' id='valider_groupe_$id_groupe'>";
				$s .= " &nbsp; <INPUT TYPE='submit' NAME='Choisir' VALUE='"._T('bouton_changer')."' CLASS='fondo' style='font-size: 10px';>";
				$s .= "</span>";
				$s .= "</form>";
	
			} else {
				$s = "<A HREF='$url'>".typo($titre_mot)."</A>";
			}
			$vals[] = $s;
	
			$vals[] = "$type_mot";
	
			if ($flag_editable){
				$s = "";
				if ($flag_groupe)
				  $s .= "<A HREF=\"$url_base&supp_mot=$id_mot#mots\">"._T('info_retirer_mot')."&nbsp;" . http_img_pack('croix-rouge.gif', "X", "width='7' height='7' border='0' align='middle'") ."</A>";
				else $s .= "&nbsp;";
			}
			$vals[] = $s;
			
			$tableau[] = $vals;
	
			$les_mots[] = $id_mot;
		}
	
		$largeurs = array('25', '', '', '');
		$styles = array('arial11', 'arial2', 'arial2', 'arial1');
		afficher_liste($largeurs, $tableau, $styles);
	
	
		echo "</table></div>";
	}

	if ($les_mots) {
		$nombre_mots_associes = count($les_mots);
		$les_mots = join($les_mots, ",");
	} else {
		$les_mots = "0";
	}
	if ($id_groupes_vus) $id_groupes_vus = join($id_groupes_vus, ",");
	else $id_groupes_vus = "0";

	$query_groupes = "SELECT * FROM spip_groupes_mots WHERE $table = 'oui' AND $connect_statut = 'oui' AND obligatoire = 'oui' AND id_groupe NOT IN ($id_groupes_vus)";
	$nb_groupes = spip_num_rows(spip_query($query_groupes));

	//
	// Afficher le formulaire d'ajout de mots-cles
	//

	if ($flag_editable) {
		if ($nouveaux_mots.$cherche_mot.$supp_mot)
			echo debut_block_visible("lesmots");
		else if ($nb_groupes > 0) {
			echo debut_block_visible("lesmots");
			// vilain hack pour redresser un triangle
			$couche_a_redresser = $GLOBALS['numero_block']['lesmots'];
			if ($GLOBALS['browser_layer']) echo http_script("
triangle = findObj('triangle' + $couche_a_redresser);
if (triangle) triangle.src = '" . _DIR_IMG_PACK . "deplierbas$spip_lang_rtl.gif';");
		}
		else
			echo debut_block_invisible("lesmots");

		if ($nombre_mots_associes > 3) {
			echo "<div align='right' class='arial1'>";
			echo "<a href=\"$url_base&supp_mot=-1#mots\">"._T('info_retirer_mots')."</a>";
			echo "</div><br />\n";
		}


		$form_mot = "<FORM ACTION='$url_base#mots' METHOD='post' STYLE='margin:1px;'>"
			."<INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'>";

		if ($table == 'rubriques') $form_mot .= "<INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'>";

		$message_ajouter_mot = "<span class='verdana1'><B>"._T('titre_ajouter_mot_cle')."</B></span> &nbsp;\n";

		echo "<table border='0' width='100%' style='text-align: $spip_lang_right'>";

		$query_groupes = "SELECT * FROM spip_groupes_mots WHERE $table = 'oui' AND $connect_statut = 'oui' AND (unseul != 'oui'  OR (unseul = 'oui' AND id_groupe NOT IN ($id_groupes_vus))) ORDER BY titre";
		$result_groupes = spip_query($query_groupes);

		// Afficher un menu par groupe de mots


		while ($row_groupes = spip_fetch_array($result_groupes)) {
			$id_groupe = $row_groupes['id_groupe'];
			$titre_groupe = entites_html(textebrut(typo($row_groupes['titre'])));
			$unseul = $row_groupes['unseul'];
			$obligatoire = $row_groupes['obligatoire'];
			$articles = $row_groupes['articles'];
			$breves = $row_groupes['breves'];
			$rubriques = $row_groupes['rubriques'];
			$syndic = $row_groupes['syndic'];
			$acces_minirezo = $row_groupes['0minirezo'];
			$acces_comite = $row_groupes['1comite'];
			$acces_forum = $row_groupes['6forum'];
			
			$query = "SELECT * FROM spip_mots WHERE id_groupe = '$id_groupe' ";
			if ($les_mots) $query .= "AND id_mot NOT IN ($les_mots) ";
			$query .= "ORDER BY type, titre";
			$result = spip_query($query);
			if (spip_num_rows($result) > 0) {
				if ((spip_num_rows($result) > 50 AND $flag_mots_ressemblants)) {
					echo "\n<tr>";
					echo $form_mot;
					echo "\n<td>";
					echo $message_ajouter_mot;
					$message_ajouter_mot = "";
					echo "</td>\n<td>";
					echo "<script language='text/javascript'><!--\nvar antifocus_$id_groupe = false;\n// --></script>\n";
					$jscript = "onfocus=\"if(!antifocus_$id_groupe){this.value='';antifocus_$id_groupe=true;}\"". " onClick=\"setvisibility('valider_groupe_$id_groupe', 'visible');\"";

					if ($obligatoire == "oui" AND !$groupes_vus[$id_groupe])
						echo "<INPUT TYPE='text' NAME='cherche_mot' CLASS='fondl' STYLE='width: 180px; background-color:#E86519;' VALUE=\"$titre_groupe\" SIZE='20' $jscript>";
					else if ($unseul == "oui")
						echo "<INPUT TYPE='text' NAME='cherche_mot' CLASS='fondl' STYLE='width: 180px; background-color:#cccccc;' VALUE=\"$titre_groupe\" SIZE='20' $jscript>";
					else
						echo "<INPUT TYPE='text' NAME='cherche_mot'  CLASS='fondl' STYLE='width: 180px; ' VALUE=\"$titre_groupe\" SIZE='20' $jscript>";

					echo "</td>\n<td>";
					echo "<INPUT TYPE='hidden' NAME='select_groupe'  VALUE='$id_groupe'>";

					echo "<span class='visible_au_chargement' id='valider_groupe_$id_groupe'>";
					echo " <INPUT TYPE='submit' NAME='Chercher' VALUE='"._T('bouton_chercher')."' CLASS='fondo' STYLE='font-size:10px'>";
					echo "</span>";
					echo "</td></FORM>";
					echo "</tr>";
				}
				else {
					echo "\n<tr>";
					echo $form_mot;
					echo "\n<td>";
					echo $message_ajouter_mot;
					$message_ajouter_mot = "";
					echo "</td>\n<td>";

					if ($obligatoire == "oui" AND !$groupes_vus[$id_groupe])
						echo "<SELECT NAME='nouv_mot' SIZE='1' onChange=\"setvisibility('valider_groupe_$id_groupe', 'visible');\" STYLE='width: 180px; background-color:#E86519;' CLASS='fondl'>";
					else if ($unseul == "oui")
						echo "<SELECT NAME='nouv_mot' SIZE='1' onChange=\"setvisibility('valider_groupe_$id_groupe', 'visible');\" STYLE='width: 180px; background-color:#cccccc;' CLASS='fondl'>";
					else
						echo "<SELECT NAME='nouv_mot' SIZE='1' onChange=\"setvisibility('valider_groupe_$id_groupe', 'visible');\" STYLE='width: 180px; ' CLASS='fondl'>";

					$ifond == 0;
					echo "\n<option value='x' style='font-variant: small-caps;'>$titre_groupe</option>";
					while($row = spip_fetch_array($result)) {
						$id_mot = $row['id_mot'];
						$titre_mot = $row['titre'];
						$texte_option = entites_html(textebrut(typo($titre_mot)));
						echo "\n<OPTION VALUE=\"$id_mot\">";
						echo "&nbsp;&nbsp;&nbsp;";
						echo "$texte_option</option>";
					}
					echo "</SELECT>";
					echo "</td>\n<td>";
					echo "<span class='visible_au_chargement' id='valider_groupe_$id_groupe'>";
					echo " &nbsp; <INPUT TYPE='submit' NAME='Choisir' VALUE='"._T('bouton_choisir')."' CLASS='fondo'>";
					echo "</span>";
					echo "</td></FORM>";
					echo "</tr>";
				}
			}
		}
		
		if ($table == 'articles' AND $connect_statut == '0minirezo' AND $flag_editable AND $options == "avancees") {
			echo "<tr><td></td><td colspan='2'>";
			echo "<div style='width: 200px;'>";
			$retour = urlencode($GLOBALS['clean_link']->getUrl());
			icone_horizontale(_T('icone_creer_mot_cle'), "mots_edit.php3?new=oui&ajouter_id_article=$id_objet&redirect=$retour", "mot-cle-24.gif", "creer.gif");
			echo "</div> ";
			echo "</td></tr>";
		}
		
		
		
		echo "</table>";
		echo fin_block();
	}


	fin_cadre_enfonce();
}


?>

--- NEW FILE: md5.js ---
/*
 *  md5.jvs 1.0b 27/06/96
 *
 * Javascript implementation of the RSA Data Security, Inc. MD5
 * Message-Digest Algorithm.
 *
 * Copyright (c) 1996 Henri Torgemane. All Rights Reserved.
 *
 * Permission to use, copy, modify, and distribute this software
 * and its documentation for any purposes and without
 * fee is hereby granted provided that this copyright notice
 * appears in all copies.
 *
 * Of course, this soft is provided "as is" without express or implied
 * warranty of any kind.
 *
 * -------------------------------------------------------------
 * Modified :
 * - 2003/06/09 by Antoine Pitrou (unicode compatibility)
 *
 *
 * $Id: md5.js,v 1.1 2005/01/13 16:16:22 stef Exp $
 *
 */



function array(n) {
  for(i=0;i<n;i++) this[i]=0;
  this.length=n;
}

/* Some basic logical functions had to be rewritten because of a bug in
 * Javascript.. Just try to compute 0xffffffff >> 4 with it..
 * Of course, these functions are slower than the original would be, but
 * at least, they work!
 */

function integer(n) { return n%(0xffffffff+1); }

function shr(a,b) {
  a=integer(a);
  b=integer(b);
  if (a-0x80000000>=0) {
    a=a%0x80000000;
    a>>=b;
    a+=0x40000000>>(b-1);
  } else
    a>>=b;
  return a;
}

function shl1(a) {
  a=a%0x80000000;
  if (a&0x40000000==0x40000000)
  {
    a-=0x40000000;
    a*=2;
    a+=0x80000000;
  } else
    a*=2;
  return a;
}

function shl(a,b) {
  a=integer(a);
  b=integer(b);
  for (var i=0;i<b;i++) a=shl1(a);
  return a;
}

function and(a,b) {
  a=integer(a);
  b=integer(b);
  var t1=(a-0x80000000);
  var t2=(b-0x80000000);
  if (t1>=0)
    if (t2>=0)
      return ((t1&t2)+0x80000000);
    else
      return (t1&b);
  else
    if (t2>=0)
      return (a&t2);
    else
      return (a&b);
}

function or(a,b) {
  a=integer(a);
  b=integer(b);
  var t1=(a-0x80000000);
  var t2=(b-0x80000000);
  if (t1>=0)
    if (t2>=0)
      return ((t1|t2)+0x80000000);
    else
      return ((t1|b)+0x80000000);
  else
    if (t2>=0)
      return ((a|t2)+0x80000000);
    else
      return (a|b);
}

function xor(a,b) {
  a=integer(a);
  b=integer(b);
  var t1=(a-0x80000000);
  var t2=(b-0x80000000);
  if (t1>=0) 
    if (t2>=0) 
      return (t1^t2);
    else
      return ((t1^b)+0x80000000);
  else
    if (t2>=0)
      return ((a^t2)+0x80000000);
    else
      return (a^b);  
}

function not(a) {
  a=integer(a);
  return (0xffffffff-a);
}

/* Here begin the real algorithm */

    var state = new array(4); 
    var count = new array(2);
	count[0] = 0;
	count[1] = 0;                     
    var buffer = new array(64); 
    var transformBuffer = new array(16);
    var digestBits = new array(16);

    var S11 = 7;
    var S12 = 12;
    var S13 = 17;
    var S14 = 22;
    var S21 = 5;
    var S22 = 9;
    var S23 = 14;
    var S24 = 20;
    var S31 = 4;
    var S32 = 11;
    var S33 = 16;
    var S34 = 23;
    var S41 = 6;
    var S42 = 10;
    var S43 = 15;
    var S44 = 21;

    function F(x,y,z) {
	return or(and(x,y),and(not(x),z));
    }

    function G(x,y,z) {
	return or(and(x,z),and(y,not(z)));
    }

    function H(x,y,z) {
	return xor(xor(x,y),z);
    }

    function I(x,y,z) {
	return xor(y ,or(x , not(z)));
    }

    function rotateLeft(a,n) {
	return or(shl(a, n),(shr(a,(32 - n))));
    }

    function FF(a,b,c,d,x,s,ac) {
        a = a+F(b, c, d) + x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function GG(a,b,c,d,x,s,ac) {
	a = a+G(b, c, d) +x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function HH(a,b,c,d,x,s,ac) {
	a = a+H(b, c, d) + x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function II(a,b,c,d,x,s,ac) {
	a = a+I(b, c, d) + x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function transform(buf,offset) { 
	var a=0, b=0, c=0, d=0; 
	var x = transformBuffer;
	
	a = state[0];
	b = state[1];
	c = state[2];
	d = state[3];

	for (i = 0; i < 16; i++) {
	    x[i] = and(buf[i*4+offset],0xff);
	    for (j = 1; j < 4; j++) {
		x[i]+=shl(and(buf[i*4+j+offset] ,0xff), j * 8);
	    }
	}

	/* Round 1 */
	a = FF ( a, b, c, d, x[ 0], S11, 0xd76aa478); /* 1 */
	d = FF ( d, a, b, c, x[ 1], S12, 0xe8c7b756); /* 2 */
	c = FF ( c, d, a, b, x[ 2], S13, 0x242070db); /* 3 */
	b = FF ( b, c, d, a, x[ 3], S14, 0xc1bdceee); /* 4 */
	a = FF ( a, b, c, d, x[ 4], S11, 0xf57c0faf); /* 5 */
	d = FF ( d, a, b, c, x[ 5], S12, 0x4787c62a); /* 6 */
	c = FF ( c, d, a, b, x[ 6], S13, 0xa8304613); /* 7 */
	b = FF ( b, c, d, a, x[ 7], S14, 0xfd469501); /* 8 */
	a = FF ( a, b, c, d, x[ 8], S11, 0x698098d8); /* 9 */
	d = FF ( d, a, b, c, x[ 9], S12, 0x8b44f7af); /* 10 */
	c = FF ( c, d, a, b, x[10], S13, 0xffff5bb1); /* 11 */
	b = FF ( b, c, d, a, x[11], S14, 0x895cd7be); /* 12 */
	a = FF ( a, b, c, d, x[12], S11, 0x6b901122); /* 13 */
	d = FF ( d, a, b, c, x[13], S12, 0xfd987193); /* 14 */
	c = FF ( c, d, a, b, x[14], S13, 0xa679438e); /* 15 */
	b = FF ( b, c, d, a, x[15], S14, 0x49b40821); /* 16 */

	/* Round 2 */
	a = GG ( a, b, c, d, x[ 1], S21, 0xf61e2562); /* 17 */
	d = GG ( d, a, b, c, x[ 6], S22, 0xc040b340); /* 18 */
	c = GG ( c, d, a, b, x[11], S23, 0x265e5a51); /* 19 */
	b = GG ( b, c, d, a, x[ 0], S24, 0xe9b6c7aa); /* 20 */
	a = GG ( a, b, c, d, x[ 5], S21, 0xd62f105d); /* 21 */
	d = GG ( d, a, b, c, x[10], S22,  0x2441453); /* 22 */
	c = GG ( c, d, a, b, x[15], S23, 0xd8a1e681); /* 23 */
	b = GG ( b, c, d, a, x[ 4], S24, 0xe7d3fbc8); /* 24 */
	a = GG ( a, b, c, d, x[ 9], S21, 0x21e1cde6); /* 25 */
	d = GG ( d, a, b, c, x[14], S22, 0xc33707d6); /* 26 */
	c = GG ( c, d, a, b, x[ 3], S23, 0xf4d50d87); /* 27 */
	b = GG ( b, c, d, a, x[ 8], S24, 0x455a14ed); /* 28 */
	a = GG ( a, b, c, d, x[13], S21, 0xa9e3e905); /* 29 */
	d = GG ( d, a, b, c, x[ 2], S22, 0xfcefa3f8); /* 30 */
	c = GG ( c, d, a, b, x[ 7], S23, 0x676f02d9); /* 31 */
	b = GG ( b, c, d, a, x[12], S24, 0x8d2a4c8a); /* 32 */

	/* Round 3 */
	a = HH ( a, b, c, d, x[ 5], S31, 0xfffa3942); /* 33 */
	d = HH ( d, a, b, c, x[ 8], S32, 0x8771f681); /* 34 */
	c = HH ( c, d, a, b, x[11], S33, 0x6d9d6122); /* 35 */
	b = HH ( b, c, d, a, x[14], S34, 0xfde5380c); /* 36 */
	a = HH ( a, b, c, d, x[ 1], S31, 0xa4beea44); /* 37 */
	d = HH ( d, a, b, c, x[ 4], S32, 0x4bdecfa9); /* 38 */
	c = HH ( c, d, a, b, x[ 7], S33, 0xf6bb4b60); /* 39 */
	b = HH ( b, c, d, a, x[10], S34, 0xbebfbc70); /* 40 */
	a = HH ( a, b, c, d, x[13], S31, 0x289b7ec6); /* 41 */
	d = HH ( d, a, b, c, x[ 0], S32, 0xeaa127fa); /* 42 */
	c = HH ( c, d, a, b, x[ 3], S33, 0xd4ef3085); /* 43 */
	b = HH ( b, c, d, a, x[ 6], S34,  0x4881d05); /* 44 */
	a = HH ( a, b, c, d, x[ 9], S31, 0xd9d4d039); /* 45 */
	d = HH ( d, a, b, c, x[12], S32, 0xe6db99e5); /* 46 */
	c = HH ( c, d, a, b, x[15], S33, 0x1fa27cf8); /* 47 */
	b = HH ( b, c, d, a, x[ 2], S34, 0xc4ac5665); /* 48 */

	/* Round 4 */
	a = II ( a, b, c, d, x[ 0], S41, 0xf4292244); /* 49 */
	d = II ( d, a, b, c, x[ 7], S42, 0x432aff97); /* 50 */
	c = II ( c, d, a, b, x[14], S43, 0xab9423a7); /* 51 */
	b = II ( b, c, d, a, x[ 5], S44, 0xfc93a039); /* 52 */
	a = II ( a, b, c, d, x[12], S41, 0x655b59c3); /* 53 */
	d = II ( d, a, b, c, x[ 3], S42, 0x8f0ccc92); /* 54 */
	c = II ( c, d, a, b, x[10], S43, 0xffeff47d); /* 55 */
	b = II ( b, c, d, a, x[ 1], S44, 0x85845dd1); /* 56 */
	a = II ( a, b, c, d, x[ 8], S41, 0x6fa87e4f); /* 57 */
	d = II ( d, a, b, c, x[15], S42, 0xfe2ce6e0); /* 58 */
	c = II ( c, d, a, b, x[ 6], S43, 0xa3014314); /* 59 */
	b = II ( b, c, d, a, x[13], S44, 0x4e0811a1); /* 60 */
	a = II ( a, b, c, d, x[ 4], S41, 0xf7537e82); /* 61 */
	d = II ( d, a, b, c, x[11], S42, 0xbd3af235); /* 62 */
	c = II ( c, d, a, b, x[ 2], S43, 0x2ad7d2bb); /* 63 */
	b = II ( b, c, d, a, x[ 9], S44, 0xeb86d391); /* 64 */

	state[0] +=a;
	state[1] +=b;
	state[2] +=c;
	state[3] +=d;

    }

    function init() {
	count[0]=count[1] = 0;
	state[0] = 0x67452301;
	state[1] = 0xefcdab89;
	state[2] = 0x98badcfe;
	state[3] = 0x10325476;
	for (i = 0; i < digestBits.length; i++)
	    digestBits[i] = 0;
    }

    function update(b) {
	var index,i;

	index = and(shr(count[0],3) , 0x3f);
	if (count[0]<0xffffffff-7)
	  count[0] += 8;
        else {
	  count[1]++;
	  count[0]-=0xffffffff+1;
          count[0]+=8;
        }
	buffer[index] = and(b,0xff);
	if (index  >= 63) {
	    transform(buffer, 0);
	}
    }

    function finish() {
	var bits = new array(8);
	var	padding;
	var	i=0, index=0, padLen=0;

	for (i = 0; i < 4; i++) {
	    bits[i] = and(shr(count[0],(i * 8)), 0xff);
	}
        for (i = 0; i < 4; i++) {
	    bits[i+4]=and(shr(count[1],(i * 8)), 0xff);
	}
	index = and(shr(count[0], 3) ,0x3f);
	padLen = (index < 56) ? (56 - index) : (120 - index);
	padding = new array(64); 
	padding[0] = 0x80;
        for (i=0;i<padLen;i++)
	  update(padding[i]);
        for (i=0;i<8;i++)
	  update(bits[i]);

	for (i = 0; i < 4; i++) {
	    for (j = 0; j < 4; j++) {
		digestBits[i*4+j] = and(shr(state[i], (j * 8)) , 0xff);
	    }
	} 
    }

/* End of the MD5 algorithm */

function hexa(n) {
 var hexa_h = "0123456789abcdef";
 var hexa_c="";
 var hexa_m=n;
 for (hexa_i=0;hexa_i<8;hexa_i++) {
   hexa_c=hexa_h.charAt(Math.abs(hexa_m)%16)+hexa_c;
   hexa_m=Math.floor(hexa_m/16);
 }
 return hexa_c;
}


var ascii="01234567890123456789012345678901" +
          " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ"+
          "[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~";

function calcMD5(entree)
{
 var l,s,k,ka,kb,kc,kd;

 init();
 /*for (k=0;k<entree.length;k++) {
   l=entree.charAt(k);
   update(ascii.lastIndexOf(l));
 }*/
 for (k=0;k<entree.length;k++) {
   l=entree.charCodeAt(k);
   update(l);
 }

 finish();
 ka=kb=kc=kd=0;
 for (i=0;i<4;i++) ka+=shl(digestBits[15-i], (i*8));
 for (i=4;i<8;i++) kb+=shl(digestBits[15-i], ((i-4)*8));
 for (i=8;i<12;i++) kc+=shl(digestBits[15-i], ((i-8)*8));
 for (i=12;i<16;i++) kd+=shl(digestBits[15-i], ((i-12)*8));
 s=hexa(kd)+hexa(kc)+hexa(kb)+hexa(ka);
 return s;
}

--- NEW FILE: message_edit.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_abstract_sql.php3");

// Droits
if ($new=='oui') {
	switch ($type) {
		case 'affich':
			$ok = ($connect_statut == '0minirezo');
			break;
		case 'pb':
		case 'rv':
		case 'normal':
			$ok = true;
			break;
		default:
			$ok = false;
	}

	if (!$ok) {
		debut_page(_T('info_acces_refuse'));
		debut_gauche();
		debut_droite();
		echo "<b>"._T('avis_non_acces_message')."</b><p>";
		fin_page();
		exit;
	}
}

function my_sel($num, $tex, $comp) {
  return "<option value='$num'" . (($num != $comp) ? '' : " selected='selected'") .
    ">$tex</option>\n";
}

function afficher_mois($mois, $attributs){
  return
	"<select $attributs>\n" .
	my_sel("01", _T('date_mois_1'), $mois) .
	my_sel("02", _T('date_mois_2'), $mois) .
	my_sel("03", _T('date_mois_3'), $mois) .
	my_sel("04", _T('date_mois_4'), $mois) .
	my_sel("05", _T('date_mois_5'), $mois) .
	my_sel("06", _T('date_mois_6'), $mois) .
	my_sel("07", _T('date_mois_7'), $mois) .
	my_sel("08", _T('date_mois_8'), $mois) .
	my_sel("09", _T('date_mois_9'), $mois) .
	my_sel("10", _T('date_mois_10'), $mois) .
	my_sel("11", _T('date_mois_11'), $mois) .
	my_sel("12", _T('date_mois_12'), $mois) .
	"</select>\n";
}

function afficher_annee($annee, $attributs) {
	echo "<select $attributs>\n";
	if ($annee < 1996) echo	my_sel($annee,$annee,$annee);
	for ($i=date("Y") - 1; $i < date("Y") + 3; $i++) {
		echo my_sel($i,$i,$annee);
	}
	echo "</select>\n";
}

function afficher_jour($jour, $attributs){
	echo "<select $attributs>\n";
	for($i=1;$i<32;$i++){
		if ($i<10){$aff="&nbsp;".$i;}else{$aff=$i;}
		echo my_sel($i,$aff,$jour);
	}
	echo "</select>\n";
}

function afficher_jour_mois_annee_h_m($date, $heures, $minutes, $suffixe='')
{
  afficher_jour(jour($date), "name='jour$suffixe' size='1' class='fondl verdana1'");
  echo afficher_mois(mois($date), "name='mois$suffixe' size='1' class='fondl verdana1'");
//  echo '<br />';
 afficher_annee(annee($date), "name='annee$suffixe' size='1' class='fondl verdana1'");

  echo "&nbsp;  <input type='text' class='fondl verdana1' name='heures$suffixe' value=\"".$heures."\" size='3'/>&nbsp;".majuscules(_T('date_mot_heures'))."&nbsp;",
    "<input type='text' class='fondl verdana1' name='minutes$suffixe' value=\"$minutes\" size='3'/>";
}

function afficher_si_rdv($date_heure, $date_fin, $choix)
{
	global $spip_lang_rtl;

	$heures_debut = heures($date_heure);
	$minutes_debut = minutes($date_heure);
	$heures_fin = heures($date_fin);
	$minutes_fin = minutes($date_fin);
  
	if ($date_fin == "0000-00-00 00:00:00") {
		$date_fin = $date_heure;
		$heures_fin = $heures_debut + 1;
	}
  
	if ($heures_fin >=24){
		$heures_fin = 23;
		$minutes_fin = 59;
	}
			
	$res = "<div><input type='radio' name='rv' value='non' id='rv_off'" .
		(!$choix ? "checked='checked' " : '') .
		" onclick=\"changeVisible(this.checked, 'heure-rv', 'none', 'block');\"/>" .
		"<label for='rv_off'>".
		_T('item_non_afficher_calendrier').
		"</label>";
	echo ($choix  ? $res : "<b>$res</b>") . "</div>";

	$res = "<input type='radio' name='rv' value='oui' id='rv_on' " .
		($choix ? "checked='checked' " : '') .
		"onclick=\"changeVisible(this.checked, 'heure-rv', 'block', 'none');\"/>" . 
		"<label for='rv_on'>".
		_T('item_afficher_calendrier').
		"</label>";
	echo '<div>' . (!$choix  ? $res : "<b>$res</b>") . '</div>';
	
	$display = ($choix ? "block" : "none");
	
	echo "<div id='heure-rv' style='display: $display; padding-top: 4px; padding-left: 24px;'>";

	afficher_jour_mois_annee_h_m($date_heure, $heures_debut, $minutes_debut);

	echo " <br /><img src='puce$spip_lang_rtl.gif' alt=' '/> &nbsp; ";
	afficher_jour_mois_annee_h_m($date_fin, $heures_fin, $minutes_fin, '_fin');
	echo "</div>";
}


if ($new == "oui") {
	$mydate = date("YmdHis", time() - 2 * 24 * 3600);
	$query = "DELETE FROM spip_messages WHERE (statut = 'redac') AND (date_heure < $mydate)";
	$result = spip_query($query);

	if ($type == 'pb') $statut = 'publie';
	else $statut = 'redac';

	$id_message = spip_abstract_insert("messages",
				  "(titre, date_heure, statut, type, id_auteur)", 
				  "('".addslashes(filtrer_entites(_T('texte_nouveau_message')))."', NOW(), '$statut', '$type', $connect_id_auteur)");
	
	if ($rv) {
		spip_query("UPDATE spip_messages SET rv='oui', date_heure='$rv 12:00:00', date_fin= '$rv 13:00:00' WHERE id_message = $id_message");
	}

	if ($type != "affich"){
		spip_query("INSERT INTO spip_auteurs_messages (id_auteur,id_message,vu) VALUES ('$connect_id_auteur','$id_message','oui')");
		if ($dest) {
			spip_query("INSERT INTO spip_auteurs_messages (id_auteur,id_message,vu) VALUES ('$dest','$id_message','non')");
		}
		else if ($type == 'normal') $ajouter_auteur = true;
	}
	$onfocus = " onfocus=\"if(!antifocus){this.value='';antifocus=true;}\"";
 }

$row = spip_fetch_array(spip_query("SELECT * FROM spip_messages WHERE id_message=$id_message"));

$id_message = $row['id_message'];
$date_heure = $row["date_heure"];
$date_fin = $row["date_fin"];
$titre = entites_html($row["titre"]);
$texte = entites_html($row["texte"]);
$type = $row["type"];
$statut = $row["statut"];
$page = $row["page"];
$rv = $row["rv"];
$expediteur = $row["id_auteur"];

debut_page(_T('titre_page_message_edit'), "redacteurs", "messagerie");

if (!($expediteur = $connect_id_auteur OR ($type == 'affich' AND $connect_statut == '0minirezo'))) die();

if ($type == 'normal') {
  $le_type = _T('bouton_envoi_message_02');
  $logo = "message";
 }
if ($type == 'pb') {
  $le_type = _T('bouton_pense_bete');
  $logo = "pense-bete";
 }
if ($type == 'affich') {
  $le_type = _T('bouton_annonce');
  $logo = "annonce";
 }

echo "<form action='message.php3?id_message=$id_message' method='post'>";

 debut_gauche();

debut_droite();

	echo "<div class='arial2'>";
	echo "<font face='Verdana,Arial,Sans,sans-serif' size='2' color='green'><b>$le_type</b></font><p>";
	
	if ($type == "affich")
		echo "<font face='Verdana,Arial,Sans,sans-serif' size='1' color='red'>"._T('texte_message_edit')."</font></p><p>";
	

	echo "<input type='hidden' name='modifier_message' value='oui'/>";
	echo "<input type='hidden' name='id_message' value='$id_message'/>";
	echo "<input type='hidden' name='changer_rv' value='$id_message'/>";
	echo _T('texte_titre_obligatoire')."<br />";
	echo "<input type='text' class='formo' name='titre' value=\"$titre\" size='40' $onfocus />";

	if ($ajouter_auteur) {
		echo "</p><p><b>"._T('info_nom_destinataire')."</b><br />";
		echo "<input type='text' class='formo' name='cherche_auteur' value='' size='40'/>";
	}

	echo "<p />";


	//////////////////////////////////////////////////////
	// Fixer rendez-vous?
	//
	if ($rv == "oui") $fonction = "rv.gif";	else $fonction = "";
	debut_cadre_trait_couleur("$logo.gif", false, $fonction, _T('titre_rendez_vous'));
	afficher_si_rdv($date_heure, $date_fin, ($rv == "oui")); 
	fin_cadre_trait_couleur();

	echo "<p><b>"._T('info_texte_message_02')."</b><br />";
	echo "<textarea name='texte' rows='20' class='formo' cols='40'>";
	echo $texte;
	echo "</textarea></p><br />\n";

	echo "<p align='right'><input type='submit' name='valider' value='"._T('bouton_valider')."' class='fondo'/></p>";
	echo "</div>";
	echo "</form>";

fin_page();

?>

--- NEW FILE: inc_mail.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_MAIL")) return;
define("_ECRIRE_INC_MAIL", "1");



//
// Infos de mails sur l'hebergeur (tout ca est assez sale)
//
global $hebergeur;
global $HTTP_X_HOST, $REQUEST_URI, $SERVER_NAME, $HTTP_HOST;
$hebergeur = '';

// Lycos (ex-Multimachin)
if ($HTTP_X_HOST == 'membres.lycos.fr') {
	$hebergeur = 'lycos';
}
// Altern
else if (ereg('altern\.com$', $SERVER_NAME)) {
	$hebergeur = 'altern';
}
// Free
else if (ereg('^/([^/]*)\.free.fr/', $REQUEST_URI, $regs)) {
	$hebergeur = 'free';
}
// NexenServices
else if ($SERVER_ADMIN == 'www at nexenservices.com') {
	if (!function_exists('email'))
		include ('mail.inc');
	$hebergeur = 'nexenservices';
}
// Online
else if (function_exists('email')) {
	$hebergeur = 'online';
}


//
// Chez lyconiania, envoyer un mail coupe la connection MySQL (sic)
//

$GLOBALS['queue_mails'] = '';

function envoyer_queue_mails() {
	global $queue_mails;
	if (!$queue_mails) return;
	reset($queue_mails);
	while (list(, $val) = each($queue_mails)) {
		$email = $val['email'];
		$sujet = $val['sujet'];
		$texte = $val['texte'];
		$headers = $val['headers'];
		@mail($email, $sujet, $texte, $headers);
	}
}

if ($GLOBALS['hebergeur'] == 'lycos') {
	register_shutdown_function(envoyer_queue_mails);
}

function tester_mail() {
	global $hebergeur;
	$test_mail = true;
	if ($hebergeur == 'free') $test_mail = false;
	return $test_mail;
}

function envoyer_mail($email, $sujet, $texte, $from = "", $headers = "") {
	global $hebergeur, $queue_mails, $flag_wordwrap;
	include_ecrire("inc_filtres.php3");

	if (!$from) {
		$email_envoi = lire_meta("email_envoi");
		$from = email_valide($email_envoi) ? $email_envoi : $email;
	}
	if (!email_valide($email)) return false;
	if ($email == _T('info_mail_fournisseur')) return false; // tres fort

	spip_log("mail ($email): $sujet");

	$charset = lire_meta('charset');

	$headers = "From: $from\n".
		"MIME-Version: 1.0\n".
		"Content-Type: text/plain; charset=$charset\n".
		"Content-Transfer-Encoding: 8bit\n$headers";

	$texte = filtrer_entites($texte);
	$sujet = filtrer_entites($sujet);

	// fignoler ce qui peut l'etre...
	if ($charset <> 'utf-8') {
		$texte = str_replace("&#8217;", "'", $texte);
		$sujet = str_replace("&#8217;", "'", $sujet);
	}
	$texte = str_replace("&mdash;", "--", $texte);
	$sujet = str_replace("&mdash;", "--", $sujet);

	// encoder le sujet si possible selon la RFC
	if($GLOBALS['flag_multibyte'] AND @mb_internal_encoding($charset))
		$sujet = mb_encode_mimeheader($sujet, $charset, 'Q');

	if ($flag_wordwrap) $texte = wordwrap($texte);

	if (os_serveur == 'windows') {
		$texte = ereg_replace ("\r*\n","\r\n", $texte);
		$headers = ereg_replace ("\r*\n","\r\n", $headers);
	}

	switch($hebergeur) {
	case 'lycos':
		$queue_mails[] = array(
			'email' => $email,
			'sujet' => $sujet,
			'texte' => $texte,
			'headers' => $headers);
		return true;
	case 'free':
		return false;
	case 'online':
		return @email('webmaster', $email, $sujet, $texte);
	default:
		return @mail($email, $sujet, $texte, $headers);
	}
}

function extrait_article($row) {
	include_ecrire("inc_texte.php3");
	include_ecrire("inc_filtres.php3");

	$adresse_site = lire_meta("adresse_site");

	$id_article = $row[0];
	$titre = $row[2];
	$chapo = $row[6];
	$texte = $row[7];
	$date = $row[9];
	$statut = $row[10];

	$les_auteurs = "";
 	$query = "SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_articles AS lien WHERE lien.id_article=$id_article AND auteurs.id_auteur=lien.id_auteur";
	$result_auteurs = spip_query($query);

	while ($row = spip_fetch_array($result_auteurs)) {
		$nom_auteur = trim(supprimer_tags(typo($row['nom'])));

		if ($les_auteurs) $les_auteurs .= ', ';
		$les_auteurs .= $nom_auteur;
	}

	$extrait = "** $titre **\n";
	if ($les_auteurs) $extrait .= _T('info_les_auteurs_1', array('les_auteurs' => $les_auteurs));
	if ($statut == 'publie') $extrait .= " "._T('date_fmt_nomjour_date', array('nomjour'=>nom_jour($date), 'date'=>affdate($date)));
	$extrait .= "\n\n".textebrut(propre(couper_intro("$chapo<p>$texte", 700)))."\n\n";
	if ($statut == 'publie') $extrait .= "-> ".$adresse_site."/spip_redirect.php3?id_article=$id_article\n\n";
	return $extrait;
}


function nettoyer_titre_email($titre) {
	$titre = ereg_replace("\n", ' ', supprimer_tags($titre));
	return ($titre);
}

function envoyer_mail_publication($id_article) {
	global $connect_nom;
	$adresse_suivi = lire_meta("adresse_suivi");
	$nom_site_spip = lire_meta("nom_site");
	$suivi_edito = lire_meta("suivi_edito");

	if ($suivi_edito == "oui") {
		$query = "SELECT * FROM spip_articles WHERE id_article = $id_article";
		$result = spip_query($query);

		if ($row = spip_fetch_array($result)) {

			// selectionne langue du site
			$lang_utilisateur = $GLOBALS['spip_lang'];
			changer_langue($GLOBALS['langue_site']);

			$titre = nettoyer_titre_email($row['titre']);

			$sujet = _T('info_publie_1', array('nom_site_spip' => $nom_site_spip, 'titre' => $titre));
			$courr = _T('info_publie_2')."\n\n";
			$nom = trim(supprimer_tags(typo($connect_nom)));
			$courr .= _T('info_publie_01', array('titre' => $titre, 'connect_nom' => $nom))."\n\n\n";
			$courr = $courr . extrait_article($row);
			envoyer_mail($adresse_suivi, $sujet, $courr);

			// reinstalle la langue utilisateur (au cas ou)
			changer_langue($lang_utilisateur);
		}
	}
}

function envoyer_mail_proposition($id_article) {
	$adresse_suivi = lire_meta("adresse_suivi");
	$adresse_site = lire_meta("adresse_site");
	$nom_site_spip = lire_meta("nom_site");
	$suivi_edito = lire_meta("suivi_edito");

	if ($suivi_edito == "oui") {
		if ($row = spip_fetch_array(spip_query("SELECT * FROM spip_articles WHERE id_article = $id_article"))) {
			$lang_utilisateur = $GLOBALS['spip_lang'];
			changer_langue($GLOBALS['langue_site']);

			$titre = nettoyer_titre_email($row['titre']);

			$sujet = _T('info_propose_1', array('nom_site_spip' => $nom_site_spip, 'titre' => $titre));
			envoyer_mail($adresse_suivi,
				     $sujet,
				     _T('info_propose_2')
				     ."\n\n" 
				     . _T('info_propose_3', array('titre' => $titre))
				     ."\n" 
				     . _T('info_propose_4')
				     ."\n" 
				     . _T('info_propose_5')
				     ."\n" 
				     . $adresse_site 
				     . '/' 
				     . _DIR_RESTREINT_ABS 
				     . "articles.php3?id_article=$id_article\n\n\n" 
				     . extrait_article($row));
			changer_langue($lang_utilisateur);
		}
	}
}

?>

--- NEW FILE: inc_presentation.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_PRESENTATION")) return;
define("_ECRIRE_INC_PRESENTATION", "1");

include_ecrire("inc_filtres.php3"); # pour http_script (normalement d?j? fait)
include_ecrire ("inc_lang.php3");
utiliser_langue_visiteur();

//
// Aide
//
function aide($aide='') {
	global $couleur_foncee, $spip_lang, $spip_lang_rtl, $spip_display;

	if (!$aide OR $spip_display == 4) return;

[...3346 lines suppressed...]
// produit une balise img avec un champ alt d'office (et different) si vide
// attention le htmlentities et la traduction doivent etre appliques avant.

function http_img_pack($img, $alt, $att) {
  static $num = 0;
  return "<img src='" . _DIR_IMG_PACK . $img .
    ("'\nalt=\"" . ($alt ? $alt : ('img_pack' . $num++)) . '" ') .
    $att . " />";
}

function http_style_background($img, $att='')
{
  return " style='background: url(\"" . _DIR_IMG_PACK . $img .  '")' .
    ($att ? (' ' . $att) : '') . ";'";
}

function http_href_img($href, $img, $att, $title='', $style='', $class='') {
 return  http_href($href, http_img_pack($img, $title, $att), $title, $style, $class);
}
?>

--- NEW FILE: inc_urls.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_URLS")) return;
define("_ECRIRE_INC_URLS", "1");


function generer_url_article($id_article) {
	if (($row = spip_fetch_array(spip_query(
	"SELECT statut FROM spip_articles WHERE id_article=$id_article"
	))) AND ($row['statut'] == 'publie'))
		return "../spip_redirect.php3?id_article=$id_article";
	else
		return "articles.php3?id_article=$id_article";
}

function generer_url_rubrique($id_rubrique) {
	if (($row = spip_fetch_array(spip_query(
	"SELECT statut FROM spip_rubriques WHERE id_rubrique=$id_rubrique"
	))) AND ($row['statut'] == 'publie'))
		return "../spip_redirect.php3?id_rubrique=$id_rubrique";
	else
		return "naviguer.php3?id_rubrique=$id_rubrique";
}

function generer_url_breve($id_breve) {
	if (($row = spip_fetch_array(spip_query(
	"SELECT statut FROM spip_breves WHERE id_breve=$id_breve"
	))) AND ($row['statut'] == 'publie'))
		return "../spip_redirect.php3?id_breve=$id_breve";
	else
		return "breves_voir.php3?id_breve=$id_breve";
}

function generer_url_forum($id_forum) {
	$url = "../spip_redirect.php3?id_forum=$id_forum";
	return $url;
}

function generer_url_mot($id_mot) {
	$url = "../spip_redirect.php3?id_mot=$id_mot";
	return $url;
}

function generer_url_auteur($id_auteur) {
	$url = "../spip_redirect.php3?id_auteur=$id_auteur";
	return $url;
}

function generer_url_document($id_document) {
	if (intval($id_document) <= 0)
		return '';
	if ((lire_meta("creer_htaccess")) == 'oui')
		return "../spip_acces_doc.php3?id_document=$id_document";
	if ($row = @spip_fetch_array(spip_query("SELECT fichier FROM spip_documents WHERE id_document = $id_document")))
		return '../' . ($row['fichier']);
	return '';
}

?>

--- NEW FILE: statistiques_visites.php3 ---
<?php

include ("inc.php3");
include_ecrire("inc_statistiques.php3");

function http_img_rien($width, $height, $style='', $title='')
{
  return http_img_pack('rien.gif', $title, 
		       "width='$width' height='$height'" 
		       . (!$style ? '' : (" style='$style'"))
		       . (!$title ? '' : (" title=\"$title\"")));
}

if ($id_article = intval($id_article)){
	$query = "SELECT titre, visites, popularite FROM spip_articles WHERE statut='publie' AND id_article ='$id_article'";
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$titre = typo($row['titre']);
		$total_absolu = $row['visites'];
		$val_popularite = round($row['popularite']);
	}
} 
else {
	$query = "SELECT SUM(visites) AS total_absolu FROM spip_visites";
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$total_absolu = $row['total_absolu'];
	}
}


if ($titre) $pourarticle = " "._T('info_pour')." &laquo; $titre &raquo;";

if ($origine) {
	debut_page(_T('titre_page_statistiques_referers'), "suivi", "statistiques");
	echo "<br><br>";
	gros_titre(_T('titre_liens_entrants'));
	barre_onglets("statistiques", "referers");

	debut_gauche();
	debut_boite_info();
	echo "<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2>";
	echo "<P align=left>"._T('info_gauche_statistiques_referers')."</P></FONT>";
	fin_boite_info();
	
	debut_droite();

}
else {
	debut_page(_T('titre_page_statistiques_visites').$pourarticle, "suivi", "statistiques");
	echo "<br><br>";
	gros_titre(_T('titre_evolution_visite')."<html>".aide("confstat")."</html>");
//	barre_onglets("statistiques", "evolution");
	if ($titre) gros_titre($titre);

	debut_gauche();

	echo "<p>";

	echo "<div class='iconeoff' style='padding: 5px;'>";
	echo "<font face='Verdana,Arial,Sans,sans-serif' size=2>";
	echo typo(_T('info_afficher_visites'));
	echo "<ul>";
	if ($id_article>0) {
		echo "<li><b><a href='statistiques_visites.php3'>"._T('info_tout_site')."</a></b>";
	} else {
		echo "<li><b>"._T('titre_page_articles_tous')."</b>";
	}

		echo "</ul>";
		echo "</font>";
		echo "</div>";

	
	// Par popularite
	$articles_recents[] = "0";
	$query = "SELECT id_article FROM spip_articles WHERE statut='publie' AND popularite > 0 ORDER BY date DESC LIMIT 0,10";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$articles_recents[] = $row['id_article'];
	}
	$articles_recents = join($articles_recents, ",");
		
	// Par popularite
	$query = "SELECT id_article, titre, popularite, visites FROM spip_articles WHERE statut='publie' AND popularite > 0 ORDER BY popularite DESC";
	$result = spip_query($query);

	$nombre_articles = spip_num_rows($result);
	if ($nombre_articles > 0) {
		echo "<p>";
		echo "<div class='iconeoff' style='padding: 5px;'>";
		echo "<font face='Verdana,Arial,Sans,sans-serif' size=2>";
		echo typo(_T('info_visites_plus_populaires'));
		echo "<ol style='padding-left:25 px;'>";
		echo "<font size=1 color='#666666'>";
		while ($row = spip_fetch_array($result)) {
			$titre = typo($row['titre']);
			$l_article = $row['id_article'];
			$visites = $row['visites'];
			$popularite = round($row['popularite']);
			$liste++;
			$classement[$l_article] = $liste;
			
			if ($liste <= 30) {
				$articles_vus[] = $l_article;
			
				if ($l_article == $id_article){
					echo "\n<li value='$liste'><b>$titre</b>";
				} else {
					echo "\n<li value='$liste'><a href='statistiques_visites.php3?id_article=$l_article' title='"._T('info_popularite', array('popularite' => $popularite, 'visites' => $visites))."'>$titre</a>";
				}
			}
		}
		$articles_vus = join($articles_vus, ",");
			
		// Par popularite
		$query_suite = "SELECT id_article, titre, popularite, visites FROM spip_articles WHERE statut='publie' AND id_article IN ($articles_recents) AND id_article NOT IN ($articles_vus) ORDER BY popularite DESC";
		$result_suite = spip_query($query_suite);
		
		if (spip_num_rows($result_suite) > 0) {
			echo "<br><br>[...]<br><br>";
			while ($row = spip_fetch_array($result_suite)) {
				$titre = typo($row['titre']);
				$l_article = $row['id_article'];
				$visites = $row['visites'];
				$popularite = round($row['popularite']);
				$numero = $classement[$l_article];
				
				if ($l_article == $id_article){
					echo "\n<li value='$numero'><b>$titre</b></li>";
				} else {
					echo "\n<li value='$numero'><a href='statistiques_visites.php3?id_article=$l_article' title='"._T('info_popularite_3', array('popularite' => $popularite, 'visites' => $visites))."'>$titre</a></li>";
				}
			}
		}
			
		echo "</ol>";

		echo "<b>"._T('info_comment_lire_tableau')."</b><br>"._T('texte_comment_lire_tableau');

		echo "</font>";
		echo "</font>";
		echo "</div>";
	}


	// Par visites depuis le debut
	$query = "SELECT id_article, titre, popularite, visites FROM spip_articles WHERE statut='publie' AND popularite > 0 ORDER BY visites DESC LIMIT 0,30";
	$result = spip_query($query);
		
	if (spip_num_rows($result) > 0) {
		creer_colonne_droite();

		echo "<p></p><div class='iconeoff' style='padding: 5px;'>";
		echo "<font face='Verdana,Arial,Sans,sans-serif' size=2>";
		echo typo(_T('info_affichier_visites_articles_plus_visites'));
		echo "<ol style='padding-left:25 px;'>";
		echo "<font size=1 color='#666666'>";

		while ($row = spip_fetch_array($result)) {
			$titre = typo($row['titre']);
			$l_article = $row['id_article'];
			$visites = $row['visites'];
			$popularite = round($row['popularite']);
				$numero = $classement[$l_article];
				
				if ($l_article == $id_article){
					echo "\n<li value='$numero'><b>$titre</b></li>";
				} else {
					echo "\n<li value='$numero'><a href='statistiques_visites.php3?id_article=$l_article' title='"._T('info_popularite_4', array('popularite' => $popularite, 'visites' => $visites))."'>$titre</a></li>";
				}
		}
		echo "</ol>";
		echo "</font>";
	
		echo "</font>";
		echo "</div>";
	}


	//
	// Afficher les boutons de creation d'article et de breve
	//
	if ($connect_statut == '0minirezo') {
		if ($id_article > 0) {
			debut_raccourcis();
			icone_horizontale(_T('icone_retour_article'), "articles.php3?id_article=$id_article", "article-24.gif","rien.gif");
			fin_raccourcis();
		}
	}



	debut_droite();
}



if ($connect_statut != '0minirezo') {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}




//////

if (!$aff_jours) $aff_jours = 105;

if (!$origine) {




	if ($id_article) {
		$table = "spip_visites_articles";
		$table_ref = "spip_referers_articles";
		$where = "id_article=$id_article";
	} else {
		$table = "spip_visites";
		$table_ref = "spip_referers";
		$where = "1";
	}
	
	$query="SELECT UNIX_TIMESTAMP(date) AS date_unix FROM $table ".
		"WHERE $where ORDER BY date LIMIT 0,1";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$date_premier = $row['date_unix'];
	}

	$query="SELECT UNIX_TIMESTAMP(date) AS date_unix, visites FROM $table ".
		"WHERE $where AND date > DATE_SUB(NOW(),INTERVAL $aff_jours DAY) ORDER BY date";
	$result=spip_query($query);

	while ($row = spip_fetch_array($result)) {
		$date = $row['date_unix'];
		$visites = $row['visites'];

		$log[$date] = $visites;
		if ($i == 0) $date_debut = $date;
		$i++;
	}

	// Visites du jour
	if ($id_article) {
		$query = "SELECT COUNT(DISTINCT ip) AS visites FROM spip_visites_temp WHERE type = 'article' AND id_objet = $id_article";
		$result = spip_query($query);
	} else {
		$query = "SELECT COUNT(DISTINCT ip) AS visites FROM spip_visites_temp";
		$result = spip_query($query);
	}
	if ($row = @spip_fetch_array($result))
		$visites_today = $row['visites'];
	else
		$visites_today = 0;

	if (count($log)>0) {
		$max = max(max($log),$visites_today);
		$date_today = time();
		$nb_jours = floor(($date_today-$date_debut)/(3600*24));
		
		$maxgraph = substr(ceil(substr($max,0,2) / 10)."000000000000", 0, strlen($max));
	
		if ($maxgraph < 10) $maxgraph = 10;
		if (1.1 * $maxgraph < $max) $maxgraph.="0";	
		if (0.8*$maxgraph > $max) $maxgraph = 0.8 * $maxgraph;
		$rapport = 200 / $maxgraph;

		if (count($log) < 420) $largeur = floor(450 / ($nb_jours+1));
		if ($largeur < 1) {
			$largeur = 1;
			$agreg = ceil(count($log) / 420);	
		} else {
			$agreg = 1;
		}
		if ($largeur > 50) $largeur = 50;

		debut_cadre_relief("statistiques-24.gif");
		
		
		$largeur_abs = 420 / $aff_jours;
		
		if ($largeur_abs > 1) {
			$inc = ceil($largeur_abs / 5);
			$aff_jours_plus = 420 / ($largeur_abs - $inc);
			$aff_jours_moins = 420 / ($largeur_abs + $inc);
		}
		
		if ($largeur_abs == 1) {
			$aff_jours_plus = 840;
			$aff_jour_moins = 210;
		}
		
		if ($largeur_abs < 1) {
			$aff_jours_plus = 420 * ((1/$largeur_abs) + 1);
			$aff_jours_moins = 420 * ((1/$largeur_abs) - 1);
		}
		
//		$aff_jours_plus = round($aff_jours * 1.5);		
//		$aff_jours_moins = round($aff_jours / 1.5);
		
		
		
		if ($id_article) $pour_article="&id_article=$id_article";
		
		if ($date_premier < $date_debut)
		  echo http_href_img("statistiques_visites.php3?aff_jours=$aff_jours_plus$pour_article",
				     'loupe-moins.gif',
				     "border='0' valign='center'",
				     _L('zoom'). '-'), "&nbsp;";
		if ( (($date_today - $date_debut) / (24*3600)) > 30)
		  echo http_href_img("statistiques_visites.php3?aff_jours=$aff_jours_moins$pour_article", 
				     'loupe-plus.gif',
				     "border='0' valign='center'",
				     _L('zoom'). '+'), "&nbsp;";
	
		/*
		if ($spip_svg_plugin == 'oui') {
			echo "<div>";
			echo "<object data='statistiques_svg.php3?id_article=$id_article&aff_jours=$aff_jours' width='450' height='310' type='image/svg+xml'>";
			echo "<embed src='statistiques_svg.php3?id_article=$id_article&aff_jours=$aff_jours'  width='450' height='310' type='image/svg+xml' />";
			echo "</object>";
			echo "</div>";
		} 
		else {
		*/
			echo "<table cellpadding=0 cellspacing=0 border=0><tr>",
			  "<td background='", _DIR_IMG_PACK, "fond-stats.gif'>";
			echo "<table cellpadding=0 cellspacing=0 border=0><tr>";
	
			echo "<td bgcolor='black'>", http_img_rien(1,200), "</td>";
	
			// Presentation graphique
			while (list($key, $value) = each($log)) {
				
				$test_agreg ++;
		
				if ($test_agreg == $agreg) {	
				
				$test_agreg = 0;
				$n++;
			
				if ($decal == 30) $decal = 0;
				$decal ++;
				$tab_moyenne[$decal] = $value;
			
				// Inserer des jours vides si pas d'entrees	
				if ($jour_prec > 0) {
					$ecart = floor(($key-$jour_prec)/((3600*24)*$agreg)-1);
		
					for ($i=0; $i < $ecart; $i++){
						if ($decal == 30) $decal = 0;
						$decal ++;
						$tab_moyenne[$decal] = $value;
	
						$ce_jour=date("Y-m-d", $jour_prec+(3600*24*($i+1)));
						$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
	
						reset($tab_moyenne);
						$moyenne = 0;
						while (list(,$val_tab) = each($tab_moyenne))
							$moyenne += $val_tab;
						$moyenne = $moyenne / count($tab_moyenne);
		
						$hauteur_moyenne = round(($moyenne) * $rapport) - 1;
						echo "<td valign='bottom' width=$largeur>";
						$difference = ($hauteur_moyenne) -1;
						$moyenne = round($moyenne,2); // Pour affichage harmonieux
						$tagtitle= attribut_html(supprimer_tags("$jour | "
						._T('info_visites')." | "
						._T('info_moyenne')." $moyenne"));
						if ($difference > 0) {	
						  echo http_img_rien($largeur,1, 'background-color:#333333;', $tagtitle);
						  echo http_img_rien($largeur, $hauteur_moyenne, '', $tagtitle);
						}
						echo 
						    http_img_rien($largeur,1,'background-color:black;', $tagtitle);
						echo "</td>";
						$n++;
					}
				}
	
				$ce_jour=date("Y-m-d", $key);
				$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
	
				$total_loc = $total_loc + $value;
				reset($tab_moyenne);
	
				$moyenne = 0;
				while (list(,$val_tab) = each($tab_moyenne))
					$moyenne += $val_tab;
				$moyenne = $moyenne / count($tab_moyenne);
			
				$hauteur_moyenne = round($moyenne * $rapport) - 1;
				$hauteur = round($value * $rapport) - 1;
				$moyenne = round($moyenne,2); // Pour affichage harmonieux
				echo "<td valign='bottom' width=$largeur>";
	
				$tagtitle= attribut_html(supprimer_tags("$jour | "
				._T('info_visites')." ".$value));
	
				if ($hauteur > 0){
					if ($hauteur_moyenne > $hauteur) {
						$difference = ($hauteur_moyenne - $hauteur) -1;
						echo http_img_rien($largeur, 1,'background-color:#333333;',$tagtitle);
						echo http_img_rien($largeur, $difference, '', $tagtitle);
						echo http_img_rien($largeur,1, "background-color:$couleur_foncee;", $tagtitle);
						if (date("w",$key) == "0") // Dimanche en couleur foncee
						  echo http_img_rien($largeur, $hauteur, "background-color:$couleur_foncee;", $tagtitle);
						else
						  echo http_img_rien($largeur,$hauteur, "background-color:$couleur_claire;", $tagtitle);
					} else if ($hauteur_moyenne < $hauteur) {
						$difference = ($hauteur - $hauteur_moyenne) -1;
						echo http_img_rien($largeur,1,"background-color:$couleur_foncee;", $tagtitle);
						if (date("w",$key) == "0") // Dimanche en couleur foncee
							$couleur =  $couleur_foncee;
						else
							$couleur = $couleur_claire;
						echo http_img_rien($largeur, $difference, "background-color:$couleur;", $tagtitle);
						echo http_img_rien($largeur,1,"background-color:#333333;", $tagtitle);
						echo http_img_rien($largeur, $hauteur_moyenne, "background-color:$couleur;", $tagtitle);
					} else {
					  echo http_img_rien($largeur, 1, "background-color:$couleur_foncee;", $tagtitle);
						if (date("w",$key) == "0") // Dimanche en couleur foncee
						  echo http_img_rien($largeur, $hauteur, "background-color:$couleur_foncee;", $tagtitle);
						else
						  echo http_img_rien($largeur,$hauteur, "background-color:$couleur_claire;", $tagtitle);
					}
				}
				echo http_img_rien($largeur, 1, 'background-color:black;', $tagtitle);
				echo "</td>\n";
			
				$jour_prec = $key;
				$val_prec = $value;
			}
			}
	
			// Dernier jour
			$hauteur = round($visites_today * $rapport)	- 1;
			$total_absolu = $total_absolu + $visites_today;
			echo "<td valign='bottom' width=$largeur>";
			if ($hauteur > 0){
			  echo http_img_rien($largeur, 1, "background-color:$couleur_foncee;");
	
				// prevision de visites jusqu'a minuit
				// basee sur la moyenne (site) ou popularite (article)
				if (! $id_article) $val_popularite = $moyenne;
				$prevision = (1 - (date("H")*60 - date("i"))/(24*60)) * $val_popularite;
				$hauteurprevision = ceil($prevision * $rapport);
				$prevision = round($prevision,0)+$visites_today; // Pour affichage harmonieux
#				$tagtitle= attribut_html(supprimer_tags(_T('info_aujourdhui')." $visites_today &rarr; $prevision"));
				echo http_img_rien($largeur, $hauteurprevision,'background-color:#eeeeee;', $tagtitle);
	
				echo http_img_rien($largeur, $hauteur, 'background-color:#cccccc;', $tagtitle);
			}
			echo http_img_rien($largeur, 1, 'background-color:black;');
			echo "</td>";
		
			echo "<td bgcolor='black'>",http_img_rien(1, 1),"</td>";
			echo "</tr></table>";
			echo "</td>",
			  "<td background='", _DIR_IMG_PACK, "fond-stats.gif' valign='bottom'>", http_img_rien(3, 1, 'background-color:black;'),"</td>";
			echo "<td>", http_img_rien(5, 1),"</td>";
			echo "<td valign='top'><font face='Verdana,Arial,Sans,sans-serif' size=2>";
			echo "<table cellpadding=0 cellspacing=0 border=0>";
			echo "<tr><td height=15 valign='top'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1><b>".round($maxgraph)."</b></font>";
			echo "</td></tr>";
			echo "<tr><td height=25 valign='middle'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(7*($maxgraph/8))."</font>";
			echo "</td></tr>";
			echo "<tr><td height=25 valign='middle'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1>".round(3*($maxgraph/4))."</font>";
			echo "</td></tr>";
			echo "<tr><td height=25 valign='middle'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(5*($maxgraph/8))."</font>";
			echo "</td></tr>";
			echo "<tr><td height=25 valign='middle'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1><b>".round($maxgraph/2)."</b></font>";
			echo "</td></tr>";
			echo "<tr><td height=25 valign='middle'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(3*($maxgraph/8))."</font>";
			echo "</td></tr>";
			echo "<tr><td height=25 valign='middle'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1>".round($maxgraph/4)."</font>";
			echo "</td></tr>";
			echo "<tr><td height=25 valign='middle'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(1*($maxgraph/8))."</font>";
			echo "</td></tr>";
			echo "<tr><td height=10 valign='bottom'>";		
			echo "<font face='arial,helvetica,sans-serif' size=1><b>0</b></font>";
			echo "</td>";
			
			
			echo "</table>";
			echo "</font></td>";
			echo "</td></tr></table>";
			
			echo "<div style='position: relative; height: 15px;'>";
			$gauche_prec = -50;
			for ($jour = $date_debut; $jour <= $date_today; $jour = $jour + (24*3600)) {
				$ce_jour = date("d", $jour);
				
				if ($ce_jour == "1") {
					$afficher = nom_mois(date("Y-m-d", $jour));
					if (date("m", $jour) == 1) $afficher = "<b>".annee(date("Y-m-d", $jour))."</b>";
					
				
					$gauche = ($jour - $date_debut) * $largeur / ((24*3600)*$agreg);
					
					if ($gauche - $gauche_prec >= 40 OR date("m", $jour) == 1) {									
						echo "<div class='arial0' style='border-$spip_lang_left: 1px solid black; padding-$spip_lang_left: 2px; padding-top: 3px; position: absolute; $spip_lang_left: ".$gauche."px; top: -1px;'>".$afficher."</div>";
						$gauche_prec = $gauche;
					}
				}
			}
			echo "</div>";
			
		//}
				
				
		$moyenne =  round($total_absolu / ((date("U")-$date_premier)/(3600*24)));

		echo "<font face='arial,helvetica,sans-serif' size=1>"._T('texte_statistiques_visites')."</font>";
		echo "<p><table cellpadding=0 cellspacing=0 border=0 width='100%'><tr width='100%'>";
		echo "<td valign='top' width='33%'><font face='Verdana,Arial,Sans,sans-serif'>";
		echo _T('info_maximum')." ".$max;
		echo "<br>"._T('info_moyenne')." ".round($moyenne);
		echo "</td>";
		echo "<td valign='top' width='33%'><font face='Verdana,Arial,Sans,sans-serif'>";
		echo _T('info_aujourdhui').' '.$visites_today;
		if ($val_prec > 0) echo "<br>"._T('info_hier').' '.$val_prec;
		if ($id_article) echo "<br>"._T('info_popularite_5').' '.$val_popularite;

		echo "</td>";
		echo "<td valign='top' width='33%'><font face='Verdana,Arial,Sans,sans-serif'>";
		echo "<b>"._T('info_total')." ".$total_absolu."</b>";
		
		if ($id_article) {
			if ($classement[$id_article] > 0) {
				if ($classement[$id_article] == 1)
				      $ch = _T('info_classement_1', array('liste' => $liste));
				else
				      $ch = _T('info_classement_2', array('liste' => $liste));
				echo "<br>".$classement[$id_article].$ch;
			}
		} else {
			echo "<font size=1>";
			echo "<br>"._T('info_popularite_2')." ";
			echo ceil(lire_meta('popularite_total'));
			echo "</font>";
		}
		echo "</td></tr></table>";	
	}		
	
	if (count($log) > 60) {
		echo "<p>";
		echo "<font face='verdana,arial,helvetica,sans-serif' size='2'><b>"._T('info_visites_par_mois')."</b></font>";

		echo "<div align='left'>";
		///////// Affichage par mois
		$query="SELECT FROM_UNIXTIME(UNIX_TIMESTAMP(date),'%Y-%m') AS date_unix, SUM(visites) AS total_visites  FROM $table ".
			"WHERE $where AND date > DATE_SUB(NOW(),INTERVAL 2700 DAY) GROUP BY date_unix ORDER BY date";
		$result=spip_query($query);
		
		$i = 0;
		while ($row = spip_fetch_array($result)) {
			$date = $row['date_unix'];
			$visites = $row['total_visites'];
			$i++;
			$entrees["$date"] = $visites;
		}
		
		if (count($entrees)>0){
		
			$max = max($entrees);
			$maxgraph = substr(ceil(substr($max,0,2) / 10)."000000000000", 0, strlen($max));
			
			if ($maxgraph < 10) $maxgraph = 10;
			if (1.1 * $maxgraph < $max) $maxgraph.="0";	
			if (0.8*$maxgraph > $max) $maxgraph = 0.8 * $maxgraph;
			$rapport = 200 / $maxgraph;
	
			$largeur = floor(420 / (count($entrees)));
			if ($largeur < 1) $largeur = 1;
			if ($largeur > 50) $largeur = 50;
		}
		
		echo "<table cellpadding=0 cellspacing=0 border=0><tr>",
		  "<td background='", _DIR_IMG_PACK, "fond-stats.gif'>";
		echo "<table cellpadding=0 cellspacing=0 border=0><tr>";
		echo "<td bgcolor='black'>", http_img_rien(1, 200),"</td>";
	
		// Presentation graphique
		$n = 0;
		$decal = 0;
		$tab_moyenne = "";
			
		while (list($key, $value) = each($entrees)) {
			$n++;
			
			$mois = affdate_mois_annee($key);

			if ($decal == 30) $decal = 0;
			$decal ++;
			$tab_moyenne[$decal] = $value;
			
			$total_loc = $total_loc + $value;
			reset($tab_moyenne);
	
			$moyenne = 0;
			while (list(,$val_tab) = each($tab_moyenne))
				$moyenne += $val_tab;
			$moyenne = $moyenne / count($tab_moyenne);
			
			$hauteur_moyenne = round($moyenne * $rapport) - 1;
			$hauteur = round($value * $rapport) - 1;
			echo "<td valign='bottom' width=$largeur>";

			$tagtitle= attribut_html(supprimer_tags("$mois | "
			._T('info_visites')." ".$value));

			if ($hauteur > 0){
				if ($hauteur_moyenne > $hauteur) {
					$difference = ($hauteur_moyenne - $hauteur) -1;
					echo http_img_rien($largeur, 1, 'background-color:#333333;');
					echo http_img_rien($largeur, $difference, '', $tagtitle);
					echo http_img_rien($largeur,1,"background-color:$couleur_foncee;");
					if (ereg("-01",$key)){ // janvier en couleur foncee
					  echo http_img_rien($largeur,$hauteur,"background-color:$couleur_foncee;", $tagtitle);
					} 
					else {
					  echo http_img_rien($largeur,$hauteur,"background-color:$couleur_claire;", $tagtitle);
					}
				}
				else if ($hauteur_moyenne < $hauteur) {
					$difference = ($hauteur - $hauteur_moyenne) -1;
					echo http_img_rien($largeur,1,"background-color:$couleur_foncee;", $tagtitle);
					if (ereg("-01",$key)){ // janvier en couleur foncee
						$couleur =  $couleur_foncee;
					} 
					else {
						$couleur = $couleur_claire;
					}
					echo http_img_rien($largeur,$difference, "background-color:$couleur;", $tagtitle);
					echo http_img_rien($largeur,1,'background-color:#333333;',$tagtitle);
					echo http_img_rien($largeur,$hauteur_moyenne,"background-color:$couleur;", $tagtitle);
				}
				else {
				  echo http_img_rien($largeur,1,"background-color:$couleur_foncee;", $tagtitle);
					if (ereg("-01",$key)){ // janvier en couleur foncee
					  echo http_img_rien($largeur, $hauteur, "background-color:$couleur_foncee;", $tagtitle);
					} 
					else {
					  echo http_img_rien($largeur,$hauteur, "background-color:$couleur_claire;", $tagtitle);
					}
				}
			}
			echo http_img_rien($largeur,1,'background-color:black;', $tagtitle);
			echo "</td>\n";
			
			$jour_prec = $key;
			$val_prec = $value;
		}
		
		echo "<td bgcolor='black'>", http_img_rien(1, 1),"</td>";
		echo "</tr></table>";
		echo "</td>",
		  "<td background='", _DIR_IMG_PACK, "fond-stats.gif' valign='bottom'>", http_img_rien(3, 1, 'background-color:black;'),"</td>";
		echo "<td>", http_img_rien(5, 1),"</td>";
		echo "<td valign='top'><font face='Verdana,Arial,Sans,sans-serif' size=2>";
		echo "<table cellpadding=0 cellspacing=0 border=0>";
		echo "<tr><td height=15 valign='top'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1><b>".round($maxgraph)."</b></font>";
		echo "</td></tr>";
		echo "<tr><td height=25 valign='middle'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(7*($maxgraph/8))."</font>";
		echo "</td></tr>";
		echo "<tr><td height=25 valign='middle'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1>".round(3*($maxgraph/4))."</font>";
		echo "</td></tr>";
		echo "<tr><td height=25 valign='middle'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(5*($maxgraph/8))."</font>";
		echo "</td></tr>";
		echo "<tr><td height=25 valign='middle'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1><b>".round($maxgraph/2)."</b></font>";
		echo "</td></tr>";
		echo "<tr><td height=25 valign='middle'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(3*($maxgraph/8))."</font>";
		echo "</td></tr>";
		echo "<tr><td height=25 valign='middle'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1>".round($maxgraph/4)."</font>";
		echo "</td></tr>";
		echo "<tr><td height=25 valign='middle'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1 color='#999999'>".round(1*($maxgraph/8))."</font>";
		echo "</td></tr>";
		echo "<tr><td height=10 valign='bottom'>";		
		echo "<font face='arial,helvetica,sans-serif' size=1><b>0</b></font>";
		echo "</td>";

		echo "</tr></table>";
		echo "</td></tr></table>";
		echo "</div>";
	}
	
	/////
		
	fin_cadre_relief();

}



//
// Affichage des referers
//

// nombre de referers a afficher
$limit = intval($limit);	//secu
if ($limit == 0)
	$limit = 100;

// afficher quels referers ?
$vis = "visites";
if ($origine) {
	$where = "visites_jour>0";
	$vis = "visites_jour";
	$table_ref = "spip_referers";
}

$query = "SELECT referer, $vis AS vis FROM $table_ref WHERE $where ORDER BY $vis DESC";


echo "<br><br><br>";
gros_titre(_T("onglet_origine_visites"));

echo "<p><font face='Verdana,Arial,Sans,sans-serif' size=2>";
echo aff_referers ($query, $limit);
echo "</font></p>";	

echo "</font>";

fin_page();

?>

--- NEW FILE: export.php3 ---
<?php

include ("inc_version.php3");

include_ecrire ("inc_auth.php3");
include_ecrire ("inc_export.php3");
include_ecrire ("inc_admin.php3");
include_ecrire ("inc_presentation.php3");

// Liste un sommaire d'objets de n'importe quel type
// a la condition d'etre publics et plus recents que $maj
function liste_objets($result, $type) {
	global $maj;
	global $articles;
	if ($result) while ($row = spip_fetch_array($result)) {
		$t_id = $row["id_$type"];
		$t_statut = $row["statut"];
		$t_maj = mysql_timestamp_to_time($row["maj"]);
		if ($t_maj > $maj && (!$t_statut || $t_statut == "publie")) {
			echo "$type $t_id $t_maj\n";
			if ($type == "article") $articles[]=$t_id;
		}
	}
	spip_free_result($result);
}

// Liste un sommaire recursif de rubriques
// a condition que la mise a jour soit plus recente que $maj
function liste_rubriques($result) {
	global $maj;
	global $rubriques;
	if ($result) while ($row=spip_fetch_array($result)) {
		$id_rubrique = $row['id_rubrique'];
		$id_parent = $row['id_parent'];
		$titre = $row['titre'];
		$descriptif = $row['descriptif'];
		$texte = $row['texte'];
		$rubrique_maj = mysql_timestamp_to_time($row["maj"]);
		if ($rubrique_maj > $maj) {
			echo "rubrique $id_rubrique $rubrique_maj\n";
		}
		$t_rubriques[] = $id_rubrique;
	}
	spip_free_result($result);
 	if ($t_rubriques) {
 		$t_rubriques = join(",", $t_rubriques);
 		$rubriques[] = $t_rubriques;
 		$query = "SELECT * FROM spip_rubriques WHERE id_parent IN ($t_rubriques)";
		liste_rubriques(spip_query($query));
	}
}



Header("Content-Type: text/plain");

if ($id_rubrique)
	$query="SELECT * FROM spip_rubriques WHERE id_rubrique='$id_rubrique'";
else
	$query="SELECT * FROM spip_rubriques WHERE id_parent=0";

liste_rubriques(spip_query($query));

if ($rubriques) {
	$rubriques = join(",", $rubriques);

	$query = "SELECT id_article, statut, maj FROM spip_articles WHERE id_rubrique IN ($rubriques)";
	liste_objets(spip_query($query), "article");

	$query = "SELECT id_breve, statut, maj FROM spip_breves WHERE id_rubrique IN ($rubriques)";
	liste_objets(spip_query($query), "breve");

	if ($articles) {
		$articles = join(",", $articles);

		$query = "SELECT DISTINCT spip_auteurs.id_auteur, maj FROM spip_auteurs, spip_auteurs_articles AS lien WHERE id_article IN ($articles) AND spip_auteurs.id_auteur=lien.id_auteur";
		liste_objets(spip_query($query), "auteur");
	}
}


exit;

?>
--- NEW FILE: forum_admin.php3 ---
<?php

$admin = 'oui';
include ('forum.php3');

?>


--- NEW FILE: inc_auth_spip.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_AUTH_SPIP")) return;
define("_ECRIRE_INC_AUTH_SPIP", "1");

class Auth_spip {
	var $nom, $login, $email, $md5pass, $md5next, $alea_futur, $statut;

	function init() {
		return true;
	}

	// Verification du mot passe crypte (javascript)
	function verifier_challenge_md5($login, $mdpass_actuel, $mdpass_futur) {
		// Interdire mot de passe vide
		if ($mdpass_actuel == '') return false;

		$query = "SELECT * FROM spip_auteurs WHERE login='".addslashes($login)."' AND pass='".addslashes($mdpass_actuel)."' AND statut<>'5poubelle'";
		$result = spip_query($query);

		if ($row = spip_fetch_array($result)) {
			$this->nom = $row['nom'];
			$this->login = $row['login'];
			$this->email = $row['email'];
			$this->statut = $row['statut'];
			$this->md5pass = $mdpass_actuel;
			$this->md5next = $mdpass_futur;
			return true;
		}
		return false;
	}

	// Verification du mot passe en clair (sans javascript)
	function verifier($login, $pass) {
		// Interdire mot de passe vide
		if ($pass == '') return false;

		$query = "SELECT alea_actuel, alea_futur FROM spip_auteurs WHERE login='".addslashes($login)."'";
		$result = spip_query($query);
		if ($row = spip_fetch_array($result)) {
			$md5pass = md5($row['alea_actuel'] . $pass);
			$md5next = md5($row['alea_futur'] . $pass);
			return $this->verifier_challenge_md5($login, $md5pass, $md5next);
		}
		return false;
	}

	function lire() {
		return true;
	}

	function activer() {
		if ($this->statut == 'nouveau') { // nouvel inscrit
			spip_query("UPDATE spip_auteurs SET statut='1comite' WHERE login='".addslashes($this->login)."'");
		}
		if ($this->md5next) {
			include_ecrire("inc_session.php3");
			// fait tourner le codage du pass dans la base
			$nouvel_alea_futur = creer_uniqid();
			$query = "UPDATE spip_auteurs SET alea_actuel = alea_futur, ".
				"pass = '".addslashes($this->md5next)."', alea_futur = '$nouvel_alea_futur' ".
				"WHERE login='".$this->login."'";
			@spip_query($query);
		}
	}
}


?>

--- NEW FILE: inc_sites.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_INC_SITES")) return;
define("_INC_SITES", "1");


if ($supprimer_lien = $GLOBALS["supprimer_lien"]) {
	spip_query("UPDATE spip_syndic_articles SET statut='refuse' WHERE id_syndic_article='$supprimer_lien'");
}

if ($ajouter_lien = $GLOBALS["ajouter_lien"]) {
	spip_query("UPDATE spip_syndic_articles SET statut='publie' WHERE id_syndic_article='$ajouter_lien'");
}


function recuperer_page($url) {
	$http_proxy = lire_meta("http_proxy");
	if (!eregi("^http://", $http_proxy))
		$http_proxy = '';
	else
		$via_proxy = " (proxy $http_proxy)";

	spip_log("chargement $url$via_proxy");

	for ($i=0;$i<10;$i++) {	// dix tentatives maximum en cas d'entetes 301...
		$t = @parse_url($url);
		$host = $t['host'];
		if (!($port = $t['port'])) $port = 80;
		$query = $t['query'];
		if (!($path = $t['path'])) $path = "/";

		if ($http_proxy) {
			$t2 =  @parse_url($http_proxy);
			$proxy_host = $t2['host'];
			if (!($proxy_port = $t2['port'])) $proxy_port = 80;
			$f = @fsockopen($proxy_host, $proxy_port);
		} else
			$f = @fsockopen($host, $port);

		if ($f) {
			if ($http_proxy)
				fputs($f, "GET http://$host" . (($port != 80) ? ":$port" : "") . $path . ($query ? "?$query" : "") . " HTTP/1.0\r\n");
			else
				fputs($f, "GET $path" . ($query ? "?$query" : "") . " HTTP/1.0\r\n");

			fputs($f, "Host: $host\r\n");
			fputs($f, "User-Agent: SPIP-".$GLOBALS['spip_version_affichee']." (http://www.spip.net/)\r\n");
			if ($referer = lire_meta("adresse_site"))
				fputs($f, "Referer: $referer/\r\n");
			fputs($f,"\r\n");

			$s = trim(fgets($f, 16384));
			if (ereg('^HTTP/[0-9]+\.[0-9]+ ([0-9]+)', $s, $r)) {
				$status = $r[1];
			}
			else return;
			while ($s = trim(fgets($f, 16384))) {
				if (eregi('^Location: (.*)', $s, $r)) {
					$location = $r[1];
				}
			}
			if ($status >= 300 AND $status < 400 AND $location) $url = $location;
			else if ($status != 200) return;
			else break;
			fclose($f);
		}
		else {
			if (!$GLOBALS['tester_proxy'])
				$f = @fopen($url, "rb");
			break;
		}
	}

	if (!$f) {
		spip_log("ECHEC chargement $url$via_proxy");
		$result = '';
	} else {
		while (!feof($f))
			$result .= fread($f, 16384);
		fclose($f);
	}

	return $result;
}


function transcoder_page($texte) {
	include_ecrire('inc_charsets.php3');

	// Si le backend precise son charset et que celui-ci est connu de SPIP,
	// decoder puis recoder
	if (ereg('<\\?xml[[:space:]]([^>]*[[:space:]])?encoding[[:space:]]*=[[:space:]]*[\'"]([-_a-zA-Z0-9]+)[\'"]', $texte, $regs)) {
		$charset_page = strtolower($regs[2]);
		$texte = importer_charset($texte, $charset_page);
	}
	// Si le backend ne precise pas, on considere qu'il est iso-8859-1
	else $texte = importer_charset($texte, 'iso-8859-1');

	return $texte;
}

function trouver_format($texte) {
	$syndic_version = '';
	
	// Chercher un numero de version
	if (ereg('(rss|feed)[[:space:]](([^>]*[[:space:]])*)version[[:space:]]*=[[:space:]]*[\'"]([-_a-zA-Z0-9\.]+)[\'"]', $texte, $regs)) {
		$syndic_version = $regs[4];
	} else {
		if (strpos($texte,'rdf:RDF')) {
			$syndic_version = '1.0';
		}
	}
	return $syndic_version;
}

function analyser_site($url) {
	include_ecrire("inc_filtres.php3");

	$texte = transcoder_page(recuperer_page($url));
	if (!$texte) return false;
	$result = '';
	
	// definir les regexp pour decoder
	// il faut deux etapes pour link sous Atom0.3
	$syndic_version = trouver_format($texte);

	switch ($syndic_version) {
		case "1.0" :
			$site_regexp = array(
				'channel'     => '<channel[^>]*>(.*)</channel>',
				'link1'       => '<link[^>]*>([^<]*)</link>',
				'link2'       => '(.*)',
				'item'        => '<item[^>]*>',
				'description' => '<description[^>]*>([^<]*)</description>'
			);
			break;
		case "0.3" :
			$site_regexp = array(
				'channel'     => '<feed[^>]*>(.*)</feed>',
				'link1'       => '<link[[:space:]]([^<]*)rel[[:space:]]*=[[:space:]]*[\'"]alternate[\'"]([^<]*)/>',
				'link2'       => 'href[[:space:]]*=[[:space:]]*[\'"]([^["|\']]+)[\'"]',
				'item'        => '<entry[^>]*>',
				'description' => '<tagline[^>]*>([^<]*)</tagline>'
			);
			break;
		case "0.91" :
		case "0.92" :
		case "2.0" :
		default :	# backend defectueux, mais il faut une regexp
			$site_regexp = array(
				'channel'     =>'<channel[^>]*>(.*)</channel>',
				'link1'       => '<link[^>]*>([^<]*)</link>',
				'link2'       => '(.*)',
				'item'        => '<item[^>]*>',
				'description' => '<description[^>]*>([^<]*)</description>'
			);
			break;
	}

	if (ereg($site_regexp['channel'], $texte, $regs)) {
		$result['syndic'] = true;
		$result['url_syndic'] = $url;
		$channel = $regs[1];
		if (ereg('<title[^>]*>(([^<]|<[^/]|</[^t]>|</t[^i]>)*)</title>', $channel, $r))
			$result['nom_site'] = supprimer_tags(filtrer_entites($r[1]));
		if (ereg($site_regexp['link1'], $channel, $regs)) {
			if (ereg($site_regexp['link2'], $regs[1].$regs[2], $r))
				$result['url_site'] = filtrer_entites($r[1]);
		}

		// si le channel n'a pas de description, ne pas prendre celle d'un article
		list($channel_desc,$drop) = split($site_regexp['item'], $channel, 2);
		if (ereg($site_regexp['description'], $channel_desc, $r))
			$result['descriptif'] = filtrer_entites($r[1]);
	}
	else {
		$result['syndic'] = false;
		$result['url_site'] = $url;
		if (eregi('<head>(.*)', $texte, $regs))
			$head = filtrer_entites(eregi_replace('</head>.*', '', $regs[1]));
		else
			$head = $texte;
		if (eregi('<title[^>]*>(.*)', $head, $regs))
			$result['nom_site'] = filtrer_entites(supprimer_tags(eregi_replace('</title>.*', '', $regs[1])));
		if (eregi('<meta[[:space:]]+(name|http\-equiv)[[:space:]]*=[[:space:]]*[\'"]?description[\'"]?[[:space:]]+(content|value)[[:space:]]*=[[:space:]]*[\'"]([^>]+)[\'"]>', $head, $regs))
			$result['descriptif'] = filtrer_entites(supprimer_tags($regs[3]));
	}
	return $result;
}


function syndic_a_jour($now_id_syndic, $statut = 'off') {
	include_ecrire("inc_texte.php3");
	include_ecrire("inc_filtres.php3");

	$query = "SELECT * FROM spip_syndic WHERE id_syndic='$now_id_syndic'";
	$result = spip_query($query);
	if ($row = spip_fetch_array($result))
		$url_syndic = $row["url_syndic"];
	else return;
	$moderation = $row['moderation'];
	if ($moderation == 'oui')
		$moderation = 'dispo';	// a valider
	else
		$moderation = 'publie';	// en ligne sans validation

	// Section critique : n'autoriser qu'une seule syndication simultanee pour un site donne
	if (!spip_get_lock("syndication $url_syndic")) return;

	spip_query("UPDATE spip_syndic SET syndication='$statut', date_syndic=NOW() WHERE id_syndic='$now_id_syndic'");

	$le_retour = transcoder_page(recuperer_page($url_syndic));
	$erreur = "";
	$les_auteurs_du_site = "";

	// definir les regexp pour decoder
	// il faut deux etapes pour link sous Atom0.3
	$syndic_version = trouver_format($le_retour);
	switch ($syndic_version) {
		case "0.91" :
		case "0.92" :
		case "2.0" :
			$syndic_regexp = array(
				'item'           => '<item[>[:space:]]',
				'itemfin'        => '</item>',
				'link1'          => '<link[^>]*>([^<]*)</link>',
				'link2'          => '(.*)',
				'date1'          => '<pubDate>([^<]*)</pubDate>',
				'date2'          => '<[[:alpha:]]{2}:date>([^<]*)</[[:alpha:]]{2}:date>',
				'author1'        => '<[[:alpha:]]{2}:[Cc]reator>([^<]*)</[[:alpha:]]{2}:[Cc]reator>',
				'author2'        => '(.*)',
				'authorbis'      => '<author>([^<]*)</author>',
				'description'    => '<description[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</description[^>]*>',
				'descriptionbis' =>     '<content[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</content[^>]*>'
			);
			break;
		case "1.0" :
			$syndic_regexp = array(
				'item'           => '<item[>[:space:]]',
				'itemfin'        => '</item>',
				'link1'          => '<link[^>]*>([^<]*)</link>',
				'link2'          => '(.*)',
				'date1'          => '<[[:alpha:]]{2}:date>([^<]*)</[[:alpha:]]{2}:date>',
				'date2'          => '<pubDate>([^<]*)</pubDate>',
				'author1'        => '<[[:alpha:]]{2}:[Cc]reator>([^<]*)</[[:alpha:]]{2}:[Cc]reator>',
				'author2'        => '(.*)',
				'authorbis'      => '<author>([^<]*)</author>',
				'description'    => '<description[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</description[^>]*>',
				'descriptionbis' =>     '<content[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</content[^>]*>'
			);
			break;
		case "0.3" :
			$syndic_regexp = array('channel'=>'<feed[^>]*>(.*)</feed>',
				'item'           => '<entry[>[:space:]]',
				'itemfin'        => '</entry>',
				'link1'          => '<link[[:space:]]([^<]*)rel[[:space:]]*=[[:space:]]*[\'"]alternate[\'"]([^<]*)/>',
				'link2'          => 'href[[:space:]]*=[[:space:]]*[\'"]([^"|^\']+)[\'"]',
				'date1'          => '<modified>([^<]*)</modified>',
				'date2'          => '<issued>([^<]*)</issued>',
				'author1'        => '<author>(.*<name>.*</name>.*)</author>',
				'author2'        => '<name>([^<]*)</name>',
				'authorbis'      => '<[[:alpha:]]{2}:[Cc]reator>([^<]*)</[[:alpha:]]{2}:[Cc]reator>',
				'description'    => '<summary[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(\]{2}>)?[[:space:]]*</summary[^>]*>',
				'descriptionbis' => '<content[^>]*>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(\]{2}>)?[[:space:]]*</content[^>]*>'
			);
			break;
		default :
			// format de syndication non reconnu
			$erreur = _T('avis_echec_syndication_02');
			$le_retour = '';
			break;
	}

	// chercher un auteur dans le fil au cas ou les entry n'en auraient pas

	if ($le_retour) {
		list($channel_head,$drop) = split($syndic_regexp['item'], $le_retour, 2);
		if (ereg($syndic_regexp['author1'],$channel_head,$mat)) {
			if (ereg($syndic_regexp['author2'],$mat[1],$match))
				$les_auteurs_du_site = addslashes(filtrer_entites($match[1]));
	}
		$i = 0;
		while (ereg($syndic_regexp['item'],$le_retour,$regs)) {
			$debut_item=strpos($le_retour,$regs[0]);
			$fin_item=strpos($le_retour,$syndic_regexp['itemfin'])+strlen($syndic_regexp['itemfin']);
			$item[$i]=substr($le_retour,$debut_item,$fin_item-$debut_item);

			$debut_texte=substr($le_retour,"0",$debut_item);
			$fin_texte=substr($le_retour,$fin_item,strlen($le_retour));
			$le_retour=$debut_texte.$fin_texte;
			$i++;
		}
		if (is_array($item)) {
			$now = time();
			for ($i = 0 ; $i < count($item) ; $i++) {

				// URL (obligatoire)
				if (ereg($syndic_regexp['link1'],$item[$i],$match)) {
					$link_match = $match[1].$match[2];
					if (ereg($syndic_regexp['link2'], $link_match, $mat))
						$le_lien = addslashes(filtrer_entites($mat[1]));
				}
				else if (ereg("<guid>([^<]*)</guid>",$item[$i],$match))
					$le_lien = addslashes(filtrer_entites($match[1]));
				else continue;

				// Titre (obligatoire)
				if
(ereg("<title>[[:space:]]*(<\!\[CDATA\[)?(([^]]|][^]]|]{2}[^>]|(\[([^]])*]))*)(]{2}>)?[[:space:]]*</title>",$item[$i],$match))
					$le_titre = addslashes(supprimer_tags(filtrer_entites($match[2])));
				else if (($syndic_version==0.3) AND (strlen($letitre)==0))
					if (ereg('title[[:space:]]*=[[:space:]]*[\'"]([^"|^\']+)[\'"]',$link_match,$mat))
						$le_titre=$mat[1]; 
				else continue;

				// Date
				$la_date = "";
				if (ereg("<date>([^<]*)</date>",$item[$i],$match))
					$la_date = $match[1];
				if (ereg($syndic_regexp['date1'],$item[$i],$match))
					$la_date = $match[1];
				else if (ereg($syndic_regexp['date2'],$item[$i],$match))
					$la_date = $match[1];
				if ($GLOBALS['flag_strtotime'] AND $la_date) {
					// http://www.w3.org/TR/NOTE-datetime
					if (ereg('^([0-9]+-[0-9]+-[0-9]+T[0-9]+:[0-9]+(:[0-9]+)?)(\.[0-9]+)?(Z|([-+][0-9][0-9]):[0-9]+)$', $la_date, $match)) {
						$la_date = str_replace("T", " ", $match[1])." GMT";
						$la_date = strtotime($la_date) - intval($match[5]) * 3600;
					}
					else $la_date = strtotime($la_date);
				}
				if ($la_date < $now - 365 * 24 * 3600 OR $la_date > $now + 48 * 3600)
					$la_date = $now;

				// Auteur
				if (ereg($syndic_regexp['author1'],$item[$i],$mat)) {
					if (ereg($syndic_regexp['author2'],$mat[1],$match))
						$les_auteurs = addslashes(filtrer_entites($match[1]));
				}
				else if (ereg($syndic_regexp['authorbis'],$item[$i],$match))
					$les_auteurs = addslashes(filtrer_entites($match[1]));
				else $les_auteurs = $les_auteurs_du_site;

				// Description
				if (ereg($syndic_regexp['description'],$item[$i],$match)) {
					$la_description = couper(addslashes(supprimer_tags(filtrer_entites($match[2]))),300);
				}
				elseif (ereg($syndic_regexp['descriptionbis'],$item[$i],$match))
					$la_description = couper(addslashes(supprimer_tags(filtrer_entites($match[2]))),300);
				else $la_description = "";
				$query_deja = "SELECT * FROM spip_syndic_articles WHERE url='$le_lien' AND id_syndic=$now_id_syndic";
				$result_deja = spip_query($query_deja);
				if (spip_num_rows($result_deja) == 0 and !spip_sql_error()) {
					$query_syndic = "INSERT INTO spip_syndic_articles (id_syndic, titre, url, date, lesauteurs, statut, descriptif) ".
						"VALUES ('$now_id_syndic', '$le_titre', '$le_lien', FROM_UNIXTIME($la_date), '$les_auteurs', '$moderation', '$la_description')";
					$result_syndic=spip_query($query_syndic);
					$flag_ajout_lien = true;
				}
			}
			spip_query("UPDATE spip_syndic SET syndication='oui' WHERE id_syndic='$now_id_syndic'");
		}
		// syndication javascript : y a-t-il quelqu'un qui se sert de ce truc ??
		// la question est posee
		else if (ereg("document\.write", $le_retour)) {
			$i = 0;
			while ($i < 50 AND eregi("<a[[:space:]]+href[[:space:]]*=[[:space:]]*\"?([^\">]+)\"?[^>]*>(.*)",$le_retour,$reg)){ //"
				$le_lien = addslashes(stripslashes($reg[1]));
				$la_suite = $reg[2];

				$pos_fin = strpos($la_suite, "</a");
				$pos_fin2 = strpos($la_suite, "</A");
				if ($pos_fin2 > $pos_fin) $pos_fin = $pos_fin2;

				$le_titre = substr($la_suite, 0, $pos_fin);
				$le_titre = addslashes(stripslashes($le_titre));
				$le_titre = ereg_replace("<[^>]*>","",$le_titre);
				$le_retour = substr($la_suite, $pos_fin + 4, strlen($le_retour));

				echo "<li> $le_titre / $le_lien";

				if (strlen($la_date) < 4) $la_date=date("Y-m-j H:i:00");

				$query_deja="SELECT * FROM spip_syndic_articles WHERE url='$le_lien' AND id_syndic=$now_id_syndic";
				$result_deja=spip_query($query_deja);
				if (spip_num_rows($result_deja)==0){
					$query_syndic = "INSERT INTO spip_syndic_articles (id_syndic, titre, url, date, lesauteurs, statut, descriptif) ".
						"VALUES ('$now_id_syndic', '$le_titre', '$le_lien', '$la_date', '$les_auteurs', '$moderation', '$la_description')";
					$result_syndic=spip_query($query_syndic);
					$flag_ajout_lien = true;
				}
				$i++;
			}
			spip_query("UPDATE spip_syndic SET syndication='oui', date_syndic=NOW() WHERE id_syndic='$now_id_syndic'");
		}
		else $erreur = _T('avis_echec_syndication_01');
	}
	else $erreur = _T('avis_echec_syndication_02');

	// Ne pas oublier de liberer le verrou
	spip_release_lock($url_syndic);

	if ($flag_ajout_lien) {
		include_ecrire('inc_rubriques.php3');
		calculer_rubriques();
	}

	return $erreur;
}


function afficher_sites($titre_table, $requete) {
	global $couleur_claire, $couleur_foncee, $spip_lang_left, $spip_lang_right;
	global $connect_id_auteur;

	$tranches = afficher_tranches_requete($requete, 3);

	if ($tranches) {
//		debut_cadre_relief("site-24.gif");
		if ($titre_table) echo "<div style='height: 12px;'></div>";
		echo "<div class='liste'>";
		bandeau_titre_boite2($titre_table, "site-24.gif", $couleur_claire, "black");
		echo "<table width='100%' cellpadding='2' cellspacing='0' border='0'>";

		echo $tranches;

	 	$result = spip_query($requete);
		$num_rows = spip_num_rows($result);

		$ifond = 0;
		$premier = true;
		
		$compteur_liste = 0;
		while ($row = spip_fetch_array($result)) {
			$vals = '';
			$id_syndic=$row["id_syndic"];
			$id_rubrique=$row["id_rubrique"];
			$nom_site=typo($row["nom_site"]);
			$url_site=$row["url_site"];
			$url_syndic=$row["url_syndic"];
			$description=propre($row["description"]);
			$syndication=$row["syndication"];
			$statut=$row["statut"];
			$date=$row["date"];
			$moderation=$row['moderation'];
			
			$tous_id[] = $id_syndic;

			//echo "<tr bgcolor='$couleur'>";

			//echo "<td class='arial2'>";
			$link = new Link("sites.php3?id_syndic=$id_syndic");
			switch ($statut) {
			case 'publie':
				if (acces_restreint_rubrique($id_rubrique))
					$puce = 'puce-verte-anim.gif';
				else
					$puce='puce-verte-breve.gif';
				$title = _T('info_site_reference');
				break;
			case 'prop':
				if (acces_restreint_rubrique($id_rubrique))
					$puce = 'puce-orange-anim.gif';
				else
					$puce='puce-orange-breve.gif';
				$title = _T('info_site_attente');
				break;
			case 'refuse':
				if (acces_restreint_rubrique($id_rubrique))
					$puce = 'puce-poubelle-anim.gif';
				else
					$puce='puce-poubelle-breve.gif';
				$title = _T('info_site_refuse');
				break;
			}
			if ($syndication == "off") {
				$puce = 'puce-orange-anim.gif';
				$title = _T('info_panne_site_syndique');
			}

			$s = "<a href=\"".$link->getUrl()."\" title=\"$title\">";

			if ($spip_display != 1 AND $spip_display != 4 AND lire_meta('image_process') != "non") {
				include_ecrire("inc_logos.php3");
				$logo = decrire_logo("siteon$id_syndic");
				if ($logo) {
					$fichier = $logo[0];
					$taille = $logo[1];
					$taille_x = $logo[3];
					$taille_y = $logo[4];
					$taille = image_ratio($taille_x, $taille_y, 26, 20);
					$w = $taille[0];
					$h = $taille[1];
					$fid = $logo[2];
					$hash = calculer_action_auteur ("reduire $w $h");

					$s.= "<div style='float: $spip_lang_right; margin-top: -2px; margin-bottom: -2px;'><img src='../spip_image_reduite.php3?img="._DIR_IMG."$fichier&taille_x=$w&taille_y=$h&hash=$hash&hash_id_auteur=$connect_id_auteur' alt='' width='$w' height='$h' border='0'></div>";
					
				}
			}


			$s .= http_img_pack($puce, "", "width='7' height='7' border='0'") ."&nbsp;&nbsp;";
			
			$s .= typo($nom_site);
			/*if ($moderation == 'oui')
				$s .= "<i>".typo($nom_site)."</i>";
			else
				$s .= typo($nom_site);
			*/
			$s .= "</a> &nbsp;&nbsp; <font size='1'>[<a href='$url_site'>"._T('lien_visite_site')."</a>]</font>";
			$vals[] = $s;
			
			//echo "</td>";

			$s = "";
			//echo "<td class='arial1' align='right'> &nbsp;";
			if ($syndication == "off") {
				$s .= "<font color='red'>"._T('info_probleme_grave')." </font>";
			}
			if ($syndication == "oui" or $syndication == "off"){
				$s .= "<font color='red'>"._T('info_syndication')."</font>";
			}
				$vals[] = $s;
			//echo "</td>";					
			//echo "<td class='arial1'>";
			$s = "";
			if ($syndication == "oui" OR $syndication == "off") {
				$result_art = spip_query("SELECT COUNT(*) FROM spip_syndic_articles WHERE id_syndic='$id_syndic'");
				list($total_art) = spip_fetch_array($result_art);
				$s .= " $total_art "._T('info_syndication_articles');
			} else {
				$s .= "&nbsp;";
			}
			$vals[] = $s;
			//echo "</td>";					
			//echo "</tr></n>";
			$table[] = $vals;
		}
		spip_free_result($result);
		
		$largeurs = array('','','');
		$styles = array('arial11', 'arial1', 'arial1');
		afficher_liste($largeurs, $table, $styles);
		echo "</table>";
		//fin_cadre_relief();
		echo "</div>\n";
	}
	return $tous_id;
}


function afficher_syndic_articles($titre_table, $requete, $afficher_site = false) {
	global $couleur_claire;
	global $connect_statut;
	global $REQUEST_URI;
	global $debut_liste_sites;
	global $flag_editable;

	static $n_liste_sites;

	$n_liste_sites++;
	if (!$debut_liste_sites[$n_liste_sites]) $debut_liste_sites[$n_liste_sites] = 0;

	$adresse_page = substr($REQUEST_URI, strpos($REQUEST_URI, "/ecrire")+8, strlen($REQUEST_URI));
	$adresse_page = ereg_replace("\&?debut\_liste\_sites\[$n_liste_sites\]\=[0-9]+","",$adresse_page);
	$adresse_page = ereg_replace("\&?(ajouter\_lien|supprimer_lien)\=[0-9]+","",$adresse_page);

	if (ereg("\?",$adresse_page)) $lien_url = "&";
	else $lien_url = "?";

	$lien_url .= "debut_liste_sites[".$n_liste_sites."]=".$debut_liste_sites[$n_liste_sites]."&";


	$nombre_aff = 10;

 	$result = spip_query($requete);
	$num_rows = spip_num_rows($result);

	// Ne pas couper pour trop peu
	if ($num_rows <= 1.5 * $nombre_aff) $nombre_aff = $num_rows;

		if ($num_rows > 0) {
			echo "<p><table width='100%' cellpadding='0' cellspacing='0' border='0'><tr><td width='100%' background=''>";
			echo "<table width='100%' cellpadding='3' cellspacing='0' border='0'>";

			bandeau_titre_boite($titre_table, true);

			if ($num_rows > $nombre_aff) {
				echo "<tr><td background='' class='arial2' colspan='4'>";
				for ($i = 0; $i < $num_rows; $i = $i + $nombre_aff){
					$deb = $i + 1;
					$fin = $i + $nombre_aff;
					if ($fin > $num_rows) $fin = $num_rows;
					if ($debut_liste_sites[$n_liste_sites] == $i) {
						echo "[<b>$deb-$fin</b>] ";
					} else {
						echo "[<a href='".$adresse_page.$lien_url."debut_liste_sites[$n_liste_sites]=$i'>$deb-$fin</a>] ";
					}
				}
				echo "</td></tr>";
			}
		
			$ifond = 0;
			$premier = true;
			
			$compteur_liste = 0;

			while ($row = spip_fetch_array($result)) {
				if ($compteur_liste >= $debut_liste_sites[$n_liste_sites] AND $compteur_liste < $debut_liste_sites[$n_liste_sites] + $nombre_aff) {
					$ifond = $ifond ^ 1;
					$couleur = ($ifond) ? '#FFFFFF' : $couleur_claire;

					$id_syndic_article=$row["id_syndic_article"];
					$id_syndic=$row["id_syndic"];
					$titre=typo($row["titre"]);
					$url=$row["url"];
					$date=$row["date"];
					$lesauteurs=propre($row["lesauteurs"]);
					$statut=$row["statut"];
					$descriptif=$row["descriptif"];

					echo "<tr bgcolor='$couleur'>";
					
					echo "<td class='arial1'>";
					echo "<a href='$url'>";
					if ($statut=='publie') {
						if (acces_restreint_rubrique($id_rubrique))
							$puce = 'puce-verte-anim.gif';
						else
							$puce='puce-verte.gif';
					}
					else if ($statut == "refuse") {
							$puce = 'puce-poubelle.gif';
					}

					else if ($statut == "dispo") { // moderation : a valider
							$puce = 'puce-rouge.gif';
					}

					else if ($statut == "off") { // vieillerie
							$puce = 'puce-rouge-anim.gif';
					}

					echo http_img_pack($puce, "", "width='7' height='7' border='0'");

					if ($statut == "refuse")
						echo "<font color='black'>&nbsp;&nbsp;$titre</font>";
					else
						echo "&nbsp;&nbsp;".$titre;

					echo "</a>";

					if (strlen($lesauteurs)>0) echo "<br />"._T('info_auteurs_nombre')." <font color='#336666'>$lesauteurs</font>";
					if (strlen($descriptif)>0) echo "<br />"._T('info_descriptif_nombre')." <font color='#336666'>$descriptif</font>";
					
					echo "</td>";
					
					// $my_sites cache les resultats des requetes sur les sites
					if ($afficher_site) {
						if (!$my_sites[$id_syndic])
							$my_sites[$id_syndic] = spip_fetch_array(spip_query(
								"SELECT * FROM spip_syndic WHERE id_syndic=$id_syndic"));
						echo "<td class='arial1' align='left'>";
						$aff = $my_sites[$id_syndic]['nom_site'];
						if ($my_sites[$id_syndic]['moderation'] == 'oui')
							echo "<i>$aff</i>";
						else
							echo $aff;
						echo "</td>";
					} else echo "<td></td>";

					echo "<td class='arial1' align='right'>";
					
					if ($connect_statut == '0minirezo'){
						if ($statut == "publie"){
							echo "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&supprimer_lien=$id_syndic_article'><font color='black'>"._T('info_bloquer_lien')."</font></a>]";
						
						}
						else if ($statut == "refuse"){
							echo "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&ajouter_lien=$id_syndic_article'>"._T('info_retablir_lien')."</a>]";
						}
						else if ($statut == "dispo") {
							echo "[<a href='".$adresse_page.$lien_url."id_syndic=$id_syndic&ajouter_lien=$id_syndic_article'>"._T('info_valider_lien')."</a>]";
						}
					} else {
						echo "&nbsp;";
					}

					echo "</td>";
					echo "</tr></n>";

			}
			$compteur_liste++;

		}
		echo "</table></td></tr></table></p>";
	}
}


//
// Effectuer la syndication d'un unique site, retourne 0 si aucun a faire.
//

function executer_une_syndication() {
	$id_syndic = 0;
	if ($row = spip_fetch_array(spip_query("SELECT * FROM spip_syndic WHERE syndication='sus' AND statut='publie' AND date_syndic < DATE_SUB(NOW(), INTERVAL 24 HOUR) ORDER BY date_syndic LIMIT 0,1"))) {
		$id_syndic = $row["id_syndic"];
		syndic_a_jour($id_syndic);
	}

	if ($row = spip_fetch_array(spip_query("SELECT * FROM spip_syndic WHERE syndication='oui' AND statut='publie' AND date_syndic < DATE_SUB(NOW(), INTERVAL 2 HOUR) ORDER BY date_syndic LIMIT 0,1"))) {
		$id_syndic = $row["id_syndic"];
		syndic_a_jour($id_syndic, 'sus');
	}
	return $id_syndic;
}

?>

--- NEW FILE: licence_fr.html ---
<html>
<head>
<title>
License GPL (traduction non-officielle)
</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<style type="text/css"><!--
h1 { font-family: Verdana, Arial, Sans, sans-serif; font-size: 17px; font-weight: bold; text-align: center; }
body { font-family: Georgia, Garamond, Times, serif; font-size: 13px; text-align: justify; margin: 5%; }

a { text-decoration: none; }
a:hover { text-decoration: underline; }
a.icone { text-decoration: none; }
a.icone:hover { text-decoration: none; }
// --></style>
</head>
<body bgcolor="#ffffff" text="#000000" link="#e86519" vlink="#6e003a" alink="#ff9900">

<h1><br>
Notice d'accompagnement de la traduction non officielle &agrave;
conserver dans toute reproduction de cette traduction</h1>
<p><b> This is an unofficial translation of the GNU General Public
License into <em>french</em>. It was not published by the Free
Software Foundation, and does not legally state the distribution terms
for software that uses the GNU GPL--only the <a
href="http://www.gnu.org/copyleft/gpl.html">original English text of
the GNU GPL</a> does that. However, we hope that this translation
will help <em>french</em> speakers understand the GNU GPL better.</b>

<p><b> Ceci est une traduction non officielle de la GNU General Public
License en fran&ccedil;ais. Elle n'a pas &eacute;t&eacute; publi&eacute;e par la Free Software
Foundation, et ne d&eacute;termine pas les termes de distribution pour les
logiciels qui utilisent la GNU GPL--seul le <a
href="http://www.gnu.org/copyleft/gpl.html">texte anglais original de
la GNU GPL</a> en a le droit. Cependant, nous esp&eacute;rons que cette
traduction aidera les francophones &agrave; mieux comprendre la GPL.</b>  

<b><p> Cette traduction est sous Copyright 2001 APRIL (http://www.april.org).<br>
La version la plus &agrave; jour de ce document est disponible sur <a
href="http://www.april.org/gnu/gpl_french.html">http://www.april.org/gnu/gpl_french.html</a><br>
<p>Il est permis &agrave; tout le monde de reproduire et distribuer des
copies conformes de cette traduction, mais aucune modification ne doit
y &ecirc;tre apport&eacute;e, et la pr&eacute;sente notice doit &ecirc;tre pr&eacute;serv&eacute;e.</b>
Nous autorisons la FSF &agrave; apporter toute modification qu'elle jugera
n&eacute;cessaire pour rendre la traduction plus claire.
<p>
<h1><br>
GNU GENERAL PUBLIC LICENSE (<em>TRADUCTION NON OFFICIELLE</em>)</h1>

<p>Version 2, juin 1991
<p>Copyright (C) 1989, 1991, Free Software Foundation Inc. 675 Mass Ave, Cambridge, MA02139, Etats-Unis.
<p>Il est permis &agrave; tout le monde de reproduire et distribuer
des copies conformes de ce document de licence, mais aucune
modification ne doit y &ecirc;tre apport&eacute;e.
<br>
<br>
<h1><br>
Pr&eacute;ambule</h1>
<p>
Les licences relatives &agrave; la plupart des logiciels sont
destin&eacute;es &agrave; supprimer votre libert&eacute; de les
partager et de les modifier. Par contraste, la licence publique
g&eacute;n&eacute;rale GNU General Public License veut garantir votre
libert&eacute; de partager et de modifier les logiciels libres, pour
qu'ils soient vraiment libres pour tous leurs utilisateurs. La
pr&eacute;sente licence publique g&eacute;n&eacute;rale s'applique

&agrave; la plupart des logiciels de la Free Software Foundation,
ainsi qu'&agrave; tout autre programme dont les auteurs s'engagent
&agrave; l'utiliser. (Certains autres logiciels sont couverts par la
Licence Publique G&eacute;n&eacute;rale pour Biblioth&egrave;ques GNU
&agrave; la place). Vous pouvez aussi l'appliquer &agrave; vos
programmes.
<p>Quand nous parlons de logiciels libres, nous parlons de
libert&eacute;, non de gratuit&eacute;. Nos licences publiques
g&eacute;n&eacute;rales veulent vous garantir :

<ul>
<p>
<li>que vous avez toute libert&eacute; de distribuer des copies des
logiciels libres (et de facturer ce service, si vous le souhaitez)
;
<p>
<li>que vous recevez les codes sources ou pouvez les obtenir si vous
le souhaitez ;
<p>
<li>que vous pouvez modifier les logiciels ou en utiliser des
&eacute;l&eacute;ments dans de nouveaux programmes libres ;
<p>
<li>et que vous savez que vous pouvez le faire.
</ul>
<p>Pour prot&eacute;ger vos droits, nous devons apporter des
restrictions, qui vont interdire &agrave; quiconque de vous
d&eacute;nier ces droits, ou de vous demander de vous en
d&eacute;sister. Ces restrictions se traduisent par certaines
responsabilit&eacute;s pour ce qui vous concerne, si vous distribuez
des copies de logiciels, ou si vous les modifiez.

<p>Par exemple, si vous distribuez des copies d'un tel programme,
gratuitement ou contre une r&eacute;mun&eacute;ration, vous devez
transf&eacute;rer aux destinataires tous les droits dont vous
disposez. Vous devez vous garantir qu'eux-m&ecirc;mes, par ailleurs,
re&ccedil;oivent ou peuvent recevoir le code source. Et vous devez
leur montrer les pr&eacute;sentes dispositions, de fa&ccedil;on qu'ils
connaissent leurs droits. 
<p>Nous prot&eacute;geons vos droits en deux &eacute;tapes&nbsp;:
<ol>
<p>
<li> Nous assurons le droit d'auteur (copyright) du logiciel, et

<p>
<li> Nous vous proposons cette licence, qui vous donne l'autorisation
l&eacute;gale de dupliquer, distribuer et/ou modifier le logiciel.
</ol>
<p>De m&ecirc;me, pour la protection de chacun des auteurs, et pour
notre propre protection, nous souhaitons nous assurer que tout le
monde comprenne qu'il n'y a aucune garantie portant sur ce logiciel
libre. Si le logiciel est modifi&eacute; par quelqu'un d'autre puis
transmis &agrave; des tiers, nous souhaitons que les destinataires
sachent que ce qu'ils poss&egrave;dent n'est pas l'original, de
fa&ccedil;on que tous probl&egrave;mes introduits par d'autres ne se
traduisent pas par une r&eacute;percussion n&eacute;gative sur la
r&eacute;putation de l'auteur original.

<p>Enfin, tout programme libre est en permanence menac&eacute; par des
brevets de logiciels. Nous souhaitons &eacute;viter le danger que des
sous-distributeurs d'un programme libre obtiennent &agrave; titre
individuel des licences de brevets, avec comme cons&eacute;quence
qu'ils ont un droit de propri&eacute;t&eacute; sur le programme. Pour
&eacute;viter cette situation, nous avons fait tout ce qui est
n&eacute;cessaire pour que tous brevets doivent faire l'objet d'une
concession de licence qui en permette l'utilisation libre par
quiconque, ou bien qu'il ne soit pas conc&eacute;d&eacute; du
tout.
<p>Nous pr&eacute;sentons ci-dessous les clauses et dispositions
concernant la duplication, la distribution et la modification.

<br>
<br>
<h1><br>
Conditions d'exploitation portant sur la duplication,
la distribution et la modification</h1>
<ol>
<p>
<li>Le pr&eacute;sent contrat de licence s'applique &agrave; tout
programme ou autre ouvrage contenant un avis, appos&eacute; par le
d&eacute;tenteur du droit de propri&eacute;t&eacute;, disant qu'il
peut &ecirc;tre distribu&eacute; au titre des dispositions de la
pr&eacute;sente Licence Publique
G&eacute;n&eacute;rale. Ci-apr&egrave;s, le "Programme" d&eacute;signe
l'un quelconque de ces programmes ou ouvrages, et un "ouvrage
fond&eacute; sur le programme" d&eacute;signe soit le programme, soit
un ouvrage qui en d&eacute;rive au titre de la loi sur le droit
d'auteur ; plus pr&eacute;cis&eacute;ment, il s'agira d'un ouvrage
contenant le programme ou une version de ce dernier, soit mot &agrave;

mot, soit avec des modifications et/ou traduit en une autre langue
(ci-apr&egrave;s, le terme "modification" englobe, sans aucune
limitation, les traductions qui en sont faites). Chaque titulaire de
licence sera appel&eacute; "concessionnaire".
<p>Les activit&eacute;s autres que la duplication, la distribution et
la modification ne sont pas couvertes par la pr&eacute;sente licence ;
elles n'entrent pas dans le cadre de cette
derni&egrave;re. L'ex&eacute;cution du programme n'est soumise
&agrave; aucune restriction, et les r&eacute;sultats du programme ne
sont couverts que si son contenu constitue un ouvrage fond&eacute; sur
le programme (ind&eacute;pendamment du fait qu'il a &eacute;t&eacute;

r&eacute;alis&eacute; par ex&eacute;cution du programme). La
v&eacute;racit&eacute; de ce qui pr&eacute;c&egrave;de d&eacute;pend
de ce que fait le programme. 
<p>
<li>Le concessionnaire peut dupliquer et distribuer des copies mot
&agrave; mot du code source du programme tel qu'il les re&ccedil;oit,
et ce sur un support quelconque, du moment qu'il appose, d'une
mani&egrave;re parfaitement visible et appropri&eacute;e, sur chaque
exemplaire, un avis appropri&eacute; de droits d'auteur (Copyright) et
de renonciation &agrave; garantie&nbsp;; qu'il maintient intacts tous
les avis qui se rapportent &agrave; la pr&eacute;sente licence et
&agrave; l'absence de toute garantie ; et qu'il transmet &agrave; tout
destinataire du programme un exemplaire de la pr&eacute;sente licence
en m&ecirc;me temps que le programme.
<p>Le concessionnaire peut facturer l'acte physique de transfert d'un
exemplaire, et il peut, &agrave; sa discr&eacute;tion, proposer en
&eacute;change d'une r&eacute;mun&eacute;ration une protection en
garantie.
<p>
<li>Le concessionnaire peut modifier son ou ses exemplaires du
programme ou de toute portion de ce dernier, en formant ainsi un
ouvrage fond&eacute; sur le programme, et dupliquer et distribuer ces
modifications ou cet ouvrage selon les dispositions de la section 1
ci-dessus, du moment que le concessionnaire satisfait aussi &agrave;

toutes ces conditions :
<ol TYPE="a">
<p>
<li>Le concessionnaire doit faire en sorte que les fichiers
modifi&eacute;s portent un avis, parfaitement visible, disant que le
concessionnaire a modifi&eacute; les fichiers, avec la date de tout
changement.
<p>
<li> Le concessionnaire doit faire en sorte que tout ouvrage qu'il
distribue ou publie, et qui, en totalit&eacute; ou en partie, contient
le programme ou une partie quelconque de ce dernier ou en
d&eacute;rive, soit conc&eacute;d&eacute; en bloc, &agrave; titre
gracieux, &agrave; tous tiers au titre des dispositions de la
pr&eacute;sente licence.

<p>
<li> Si le programme modifi&eacute; lit normalement des instructions
interactives lors de son ex&eacute;cution, le concessionnaire doit,
quand il commence l'ex&eacute;cution du programme pour une telle
utilisation interactive de la mani&egrave;re la plus usuelle, faire en
sorte que ce programme imprime ou affiche une annonce, comprenant un
avis appropri&eacute; de droits d'auteur, et un avis selon lequel il
n'y a aucune garantie (ou autrement, que le concessionnaire fournit
une garantie), et que les utilisateurs peuvent redistribuer le
programme au titre de ces dispositions, et disant &agrave;
l'utilisateur comment visualiser une copie de cette licence (exception
: si le programme par lui-m&ecirc;me est interactif mais n'imprime
normalement pas une telle annonce, l'ouvrage du concessionnaire se
fondant sur le programme n'a pas besoin d'imprimer une annonce).
</ol>
<p>Les exigences ci-dessus s'appliquent &agrave; l'ouvrage
modifi&eacute; pris en bloc. Si des sections identifiables de cet
ouvrage ne d&eacute;rivent pas du programme et peuvent &ecirc;tre
consid&eacute;r&eacute;es raisonnablement comme repr&eacute;sentant
des ouvrages ind&eacute;pendants et distincts par eux-m&ecirc;mes,
alors la pr&eacute;sente licence, et ses dispositions, ne s'appliquent
pas &agrave; ces sections quand le concessionnaire les distribue sous
forme d'ouvrages distincts. Mais quand le concessionnaire distribue
ces m&ecirc;mes sections en tant qu'&eacute;l&eacute;ment d'un tout
qui repr&eacute;sente un ouvrage se fondant sur le programme, la
distribution de ce tout doit se faire conform&eacute;ment aux
dispositions de la pr&eacute;sente licence, dont les autorisations,
portant sur d'autres concessionnaires, s'&eacute;tendent &agrave; la
totalit&eacute; dont il est question, et ainsi &agrave; chacune de ces
parties, ind&eacute;pendamment de celui qu'il a &eacute;crite.

<p>Ainsi, cette section n'a pas pour but de revendiquer des droits ou
de contester vos droits sur un ouvrage enti&egrave;rement &eacute;crit
par le concessionnaire ; bien plus, l'intention est d'exercer le droit
de surveiller la distribution d'ouvrages d&eacute;riv&eacute;e ou
collective se fondant sur le programme.
<p>De plus, un simple assemblage d'un autre ouvrage ne se fondant pas
sur le programme, avec le programme (ou avec un ouvrage se fondant sur
le programme) sur un volume d'un support de stockage ou distribution,
ne fait pas entrer l'autre ouvrage dans le cadre de la pr&eacute;sente
licence.
<p>
<li> Le concessionnaire peut dupliquer et distribuer le programme (ou
un ouvrage se fondant sur ce dernier, au titre de la Section 2), en
code objet ou sous une forme ex&eacute;cutable, au titre des
dispositions des Sections 1 et 2 ci-dessus, du moment que le
concessionnaire effectue aussi l'une des op&eacute;rations suivantes :
<ol TYPE="a">
<p>

<li>Lui joindre le code source complet correspondant, exploitable par
une machine, code qui doit &ecirc;tre distribu&eacute; au titre des
Sections 1 et 2 ci-dessus sur un support couramment utilis&eacute;
pour l'&eacute;change de logiciels ; ou bien
<p>
<li>Lui joindre une offre &eacute;crite, dont la validit&eacute; se
prolonge pendant au moins 3 ans, de transmettre &agrave; un tiers
quelconque, pour un montant non sup&eacute;rieur au co&ucirc;t pour le
concessionnaire, de r&eacute;alisation physique de la distribution de
la source, un exemplaire complet, exploitable par une machine, du code
source correspondant, qui devra &ecirc;tre distribu&eacute; au titre
des dispositions des Sections 1 et 2 ci-dessus sur un support
couramment utilis&eacute; pour l'&eacute;change des logiciels ; ou
bien

<p>
<li>Lui joindre les informations que le concessionnaire a
re&ccedil;ues, pour proposer une distribution du code source
correspondant (cette variante n'est autoris&eacute;e que pour la
distribution non commerciale, et seulement si le concessionnaire a
re&ccedil;u le programme sous forme ex&eacute;cutable ou sous forme
d'un code objet, avec une telle offre, conform&eacute;ment &agrave;
l'alin&eacute;a b) ci-dessus).
</ol>
<p>Le code source d'un ouvrage repr&eacute;sente la forme
pr&eacute;f&eacute;r&eacute;e de l'ouvrage pour y effectuer des
modifications. Pour un ouvrage ex&eacute;cutable, le code source
complet repr&eacute;sente la totalit&eacute; du code source pour tous
les modules qu'il contient, plus tous fichiers de d&eacute;finitions
d'interface associ&eacute;s, plus les informations en code machine
pour commander la compilation et l'installation du programme
ex&eacute;cutable. Cependant, &agrave; titre d'exceptions
sp&eacute;ciales, le code source distribu&eacute; n'a pas besoin de
comprendre quoi que ce soit qui est normalement distribu&eacute; (sous
forme source ou sous forme binaire) avec les composants principaux
(compilateur, noyau de syst&egrave;me d'exploitation, etc.) du
syst&egrave;me d'exploitation sur lequel est ex&eacute;cut&eacute; le
programme ex&eacute;cutable, &agrave; moins que le composant, par
lui-m&ecirc;me, soit joint au programme ex&eacute;cutable.

<p>Si la distribution de l'ex&eacute;cutable ou du code objet est
r&eacute;alis&eacute;e de telle sorte qu'elle offre d'acc&eacute;der
&agrave; une copie &agrave; partir d'un lieu d&eacute;sign&eacute;,
alors le fait d'offrir un acc&egrave;s &eacute;quivalent &agrave; la
duplication du code source &agrave; partir de ce m&ecirc;me lieu
s'entend comme distribution du code source, m&ecirc;me si des tiers ne
sont pas contraints de dupliquer la source en m&ecirc;me temps que le
code objet.

<p>
<li> Le concessionnaire ne peut dupliquer, modifier, conc&eacute;der
en sous-licence ou distribuer le programme, sauf si cela est
express&eacute;ment pr&eacute;vu par les dispositions de la
pr&eacute;sente licence. Toute tentative pour autrement dupliquer,
modifier, conc&eacute;der en sous-licence ou distribuer le programme
est r&eacute;p&eacute;t&eacute;e nulle, et met automatiquement fin aux
droits du concessionnaire au titre de la pr&eacute;sente
licence. Cependant, les parties qui ont re&ccedil;u des copies, ou des
droits, de la part du concessionnaire au titre de la pr&eacute;sente
licence, ne verront pas expirer leur contrat de licence, tant que ces
parties agissent d'une mani&egrave;re parfaitement conforme.
<p>

<li> Il n'est pas exig&eacute; du concessionnaire qu'il accepte la
pr&eacute;sente licence, car il ne l'a pas sign&eacute;e. Cependant,
rien d'autre n'octroie au concessionnaire l'autorisation de modifier
ou de distribuer le programme ou ses ouvrages
d&eacute;riv&eacute;s. Ces actions sont interdites par la loi si le
concessionnaire n'accepte pas la pr&eacute;sente licence. En
cons&eacute;quence, par le fait de modifier ou de distribuer le
programme (ou un ouvrage quelconque se fondant sur le programme), le
concessionnaire indique qu'il accepte la pr&eacute;sente licence, et
qu'il a la volont&eacute; de se conformer &agrave; toutes les clauses
et dispositions concernant la duplication, la distribution ou la
modification du programme ou d'ouvrages se fondant sur ce dernier.
<p>

<li> Chaque fois que le concessionnaire redistribue le programme (ou
tout ouvrage se fondant sur le programme), le destinataire
re&ccedil;oit automatiquement une licence de l'&eacute;metteur initial
de la licence, pour dupliquer, distribuer ou modifier le programme,
sous r&eacute;serve des pr&eacute;sentes clauses et dispositions. Le
concessionnaire ne peut imposer aucune restriction plus pouss&eacute;e
sur l'exercice, par le destinataire, des droits octroy&eacute;s au
titre des pr&eacute;sentes. Le concessionnaire n'a pas pour
responsabilit&eacute; d'exiger que des tiers se conforment &agrave; la
pr&eacute;sente licence.
<p>
<li> Si, en cons&eacute;quence une d&eacute;cision de justice ou une
all&eacute;gation d'infraction au droit des brevets, ou pour toute
autre raison (qui n'est pas limit&eacute;e &agrave; des
probl&egrave;mes de propri&eacute;t&eacute;s industrielles), des
conditions sont impos&eacute;es au concessionnaire (par
autorit&eacute; de justice, par convention ou autrement), qui entrent
en contradiction avec les dispositions de la pr&eacute;sente licence,
elles n'exemptent pas le concessionnaire de respecter les dispositions
de la pr&eacute;sente licence. Si le concessionnaire ne peut
proc&eacute;der &agrave; la distribution de fa&ccedil;on &agrave;

satisfaire simultan&eacute;ment &agrave; ces obligations au titre de
la pr&eacute;sente licence et &agrave; toutes autres obligations
pertinentes, alors, en cons&eacute;quence de ce qui
pr&eacute;c&egrave;de, le concessionnaire peut ne pas proc&eacute;der
du tout &agrave; la distribution du programme. Par exemple, si une
licence de brevet ne permettait pas une redistribution du programme,
sans redevances, par tous ceux qui re&ccedil;oivent des copies
directement ou indirectement par l'interm&eacute;diaire du
concessionnaire, alors le seul moyen par lequel le concessionnaire
pourrait satisfaire tant &agrave; cette licence de brevet qu'&agrave;

la pr&eacute;sente licence, consisterait &agrave; s'abstenir
compl&egrave;tement de distribuer le programme.
<p>Si une partie quelconque de cette section est
consid&eacute;r&eacute;e comme nulle ou non ex&eacute;cutoire dans
certaines circonstances particuli&egrave;res, le reste de cette
section est r&eacute;put&eacute; s'appliquer, et la section dans son
ensemble est consid&eacute;r&eacute;e comme s'appliquant dans les
autres circonstances.

<p>La pr&eacute;sente section n'a pas pour objet de pousser le
concessionnaire &agrave; enfreindre tous brevets ou autres
revendications &agrave; droit de propri&eacute;t&eacute;, ou encore
&agrave; contester la validit&eacute; de une ou plusieurs quelconques
de ces revendications ; la pr&eacute;sente section a pour objet unique
de prot&eacute;ger l'int&eacute;grit&eacute; du syst&egrave;me de
distribution des logiciels libres, syst&egrave;me qui est mis en
oeuvre par les pratiques li&eacute;es aux licences publiques. De
nombreuses personnes ont apport&eacute; une forte contribution

&agrave; la gamme &eacute;tendue des logiciels distribu&eacute;s par
ce syst&egrave;me, en comptant sur l'application syst&eacute;matique
de ce syst&egrave;me ; c'est &agrave; l'auteur/donateur de
d&eacute;cider s'il a la volont&eacute; de distribuer le logiciel par
un quelconque autre syst&egrave;me, et un concessionnaire ne peut
imposer ce choix.
<p>La pr&eacute;sente section veut rendre parfaitement claire ce que
l'on pense &ecirc;tre une cons&eacute;quence du reste de la
pr&eacute;sente licence.

<p>
<li> Si la distribution et/ou l'utilisation du Programme est
restreinte dans certains pays, sous l'effet de brevets ou d'interfaces
pr&eacute;sentant un droit d'auteur, le d&eacute;tenteur du droit
d'auteur original, qui soumet le Programme aux dispositions de la
pr&eacute;sente licence, pourra ajouter une limitation expresse de
distribution g&eacute;ographique excluant ces pays, de fa&ccedil;on
que la distribution ne soit autoris&eacute;e que dans les pays ou
parmi les pays qui ne sont pas ainsi exclus. Dans ce cas, la
limitation fait partie int&eacute;grante de la pr&eacute;sente
licence, comme si elle &eacute;tait &eacute;crite dans le corps de la
pr&eacute;sente licence.
<p>La Free Software Foundation peut, de temps &agrave; autre, publier
des versions r&eacute;vis&eacute;es et/ou nouvelles du General Public
License. Ces nouvelles versions seront analogues, du point de vue de
leur esprit, &agrave; la pr&eacute;sente version, mais pourront en
diff&eacute;rer dans le d&eacute;tail, pour r&eacute;soudre de
nouveaux probl&egrave;mes ou de nouvelles situations.

<p>Chaque version re&ccedil;oit un num&eacute;ro de version qui lui
est propre. Si le programme sp&eacute;cifie un num&eacute;ro de
version de la pr&eacute;sente licence, qui s'applique &agrave; cette
dernier et "&agrave; toute autre version ult&eacute;rieure", le
concessionnaire a le choix de respecter les clauses et dispositions de
cette version, ou une quelconque version ult&eacute;rieure
publi&eacute;e par la Free Software Foundation. Si le programme ne
sp&eacute;cifie pas de num&eacute;ro de version de la pr&eacute;sente
licence, le concessionnaire pourra choisir une version quelconque
publi&eacute;e &agrave; tout moment par la Free Software
Foundation.

<p>
<li> Si le concessionnaire souhaite incorporer des parties du
programme dans d'autres programmes libres dont les conditions de
distribution sont diff&eacute;rentes, il devrait &eacute;crire
&agrave; l'auteur pour demander son autorisation. Pour un logiciel
soumis &agrave; droit d'auteur par la Free Software Foundation, il
devra &eacute;crire &agrave; la Free Software Foundation ; nous
faisons quelquefois des exceptions &agrave; cette r&egrave;gle. Notre
d&eacute;cision va &ecirc;tre guid&eacute;e par le double objectif de
prot&eacute;ger le statut libre de tous les d&eacute;riv&eacute;s de
nos logiciels libres, et de favoriser le partage et la
r&eacute;utilisation des logiciels en g&eacute;n&eacute;ral.

<h1><br>
ABSENCE DE GARANTIE</h1>
<p>
<p>
<li>
COMME LA LICENCE DU PROGRAMME EST CONCEDEE A
TITRE GRATUIT, IL N'Y AUCUNE GARANTIE S'APPLIQUANT AU PROGRAMME, DANS
LA MESURE AUTORISEE PAR LA LOI EN VIGUEUR. SAUF MENTION CONTRAIRE
ECRITE, LES DETENTEURS DU DROIT D'AUTEUR ET/OU LES AUTRES PARTIES
METTENT LE PROGRAMME A DISPOSITON "EN L'ETAT", SANS AUCUNE GARANTIE DE
QUELQUE NATURE QUE CE SOIT, EXPRESSE OU IMPLICITE, Y COMPRIS, MAIS
SANS LIMITATION, LES GARANTIES IMPLICITES DE COMMERCIALISATION ET DE
L'APTITUDE A UN OBJET PARTICULIER. C'EST LE CONCESSIONNAIRE QUI PREND
LA TOTALITE DU RISQUE QUANT A LA QUALITE ET AUX PERFORMANCES DU
PROGRAMME. SI LE PROGRAMME SE REVELAIT DEFECTUEUX, C'EST LE
CONCESSIONNAIRE QUI PRENDRAIT A SA CHARGE LE COUT DE L'ENSEMBLE DES
OPERATIONS NECESSAIRES D'ENTRETIEN, REPARATION OU CORRECTION.
<li>EN AUCUN CAS, SAUF SI LA LOI EN VIGUEUR L'EXIGE OU SI UNE
CONVENTION ECRITE EXISTE A CE SUJET, AUCUN DETENTEUR DE DROITS
D'AUTEUR, OU AUCUNE PARTIE AYANT LE POUVOIR DE MODIFIER ET/OU DE
REDISTRIBUER LE PROGRAMME CONFORMEMENT AUX AUTORISATIONS CI-DESSUS,
N'EST RESPONSABLE VIS-A-VIS DU CONCESSIONNAIRE POUR CE QUI EST DES
DOMMAGES, Y COMPRIS TOUS DOMMAGES GENERAUX, SPECIAUX, ACCIDENTELS OU
INDIRECTS, RESULTANT DE L'UTILISATION OU DU PROGRAMME OU DE
L'IMPOSSIBILITE D'UTILISER LE PROGRAMME (Y COMPRIS, MAIS SANS
LIMITATION, LA PERTE DE DONNEES, OU LE FAIT QUE DES DONNEES SONT
RENDUES IMPRECISES, OU ENCORE LES PERTES EPROUVEES PAR LE
CONCESSIONNAIRE OU PAR DES TIERS, OU ENCORE UN MANQUEMENT DU PROGRAMME
A FONCTIONNER AVEC TOUS AUTRES PROGRAMMES), MEME SI CE DETENTEUR OU
CETTE AUTRE PARTIE A ETE AVISE DE LA POSSIBILITE DE TELS DOMMAGES.

</ol>
<br>
<div align="center">
<b>
FIN DES CONDITIONS D'EXPLOITATION
</b>
</div>
<p>

<hr>

<h1><br>
Comment appliquer ces dispositions a vos nouveaux programmes?</h1>
</b><p>Si le concessionnaire d&eacute;veloppe un nouveau programme, et s'il en souhaite l'utilisation la plus large possible dans le public, le meilleur moyen d'y arriver est d'en faire un logiciel libre, que tout le monde pourra redistribuer et modifier au titre des pr&eacute;sentes dispositions.
<p>Dans ce but, il convient de rattacher au programme les avis suivants. Le moyen le plus s&ucirc;r consiste &agrave; les rattacher au d&eacute;but de chaque fichier source, pour avertir le plus efficacement possible de l'exclusion de garantie ; et chaque fichier doit comporter au moins la ligne "copyright", et un pointeur indiquant o&ugrave; est localis&eacute;e la totalit&eacute; de l'avis.

<tt>
<i><p>Une ligne pour donner le nom du programme et une id&eacute;e de ce qu'il fait.
</i><p>Copyright (C) 19<i>yy</i> <i>nom de l'auteur
</i><p>Ce programme est un logiciel libre ; vous pouvez le
redistribuer et/ou le modifier conform&eacute;ment aux dispositions de
la Licence Publique G&eacute;n&eacute;rale GNU, telle que
publi&eacute;e par la Free Software Foundation ; version 2 de la
licence, ou encore (&agrave; votre choix) toute version
ult&eacute;rieure.

<p>Ce programme est distribu&eacute; dans l'espoir qu'il sera utile,
mais SANS AUCUNE GARANTIE ; sans m&ecirc;me la garantie implicite de
COMMERCIALISATION ou D'ADAPTATION A UN OBJET PARTICULIER. Pour plus de
d&eacute;tail, voir la Licence Publique G&eacute;n&eacute;rale GNU
.
<p>Vous devez avoir re&ccedil;u un exemplaire de la Licence Publique
G&eacute;n&eacute;rale GNU en m&ecirc;me temps que ce programme ; si
ce n'est pas le cas, &eacute;crivez &agrave; la Free Software
Foundation Inc., 675 Mass Ave, Cambridge, MA 02139, Etats-Unis.

</tt>
<p>Ajoutez aussi des informations sur le moyen permettant
d'entrer en contact avec vous par courrier &eacute;lectronique
(e-mail) et courrier normal.
<p>Si le programme est interactif, pr&eacute;voyez en sortie un court
avis, tel que celui qui est pr&eacute;sent&eacute; ci-dessous, lors du
d&eacute;marrage en mode interactif.
<tt>
<p>Gnomovision version 69, Copyright (C) 19 <i>yy nom de
l'auteur
</i><p>Gnomovision est livr&eacute; absolument SANS AUCUNE GARANTIE ;
pour plus de d&eacute;tail, tapez "show w". Il s'agit d'un logiciel
libre, et vous avez le droit de le redistribuer dans certaines
conditions ; pour plus de d&eacute;tail, tapez "show c".

</tt>
<p>Les instructions hypoth&eacute;tiques </font>"show w"<font>
et </font>"show c"<font> doivent pr&eacute;senter les parties
appropri&eacute;es de la Licence Publique G&eacute;n&eacute;rale. Bien
&eacute;videmment, les instructions que vous utilisez peuvent porter
d'autres noms que </font>"show w"<font> et </font>"show
c"&nbsp;<font>; elles peuvent m&ecirc;me correspondre &agrave; des
clics de souris ou &agrave; des &eacute;l&eacute;ments d'un menu,
selon ce qui convient &agrave; votre programme.

<p>Si n&eacute;cessaire, vous devrez aussi demander &agrave; votre
employeur (si vous travaillez en tant que programmeur) ou &agrave;
votre &eacute;ventuelle &eacute;cole ou universit&eacute;, de signer
une "renonciation &agrave; droit d'auteur" concernant le programme. En
voici un &eacute;chantillon (il suffit de modifier les noms) :
<tt>
<p>Yoyodyne, Inc., par la pr&eacute;sente, renonce &agrave; tout int&eacute;r&ecirc;t de droits d'auteur dans le programme "Gnomovision" (qui fait des passages au niveau des compilateurs) &eacute;crit par James Hacker.

<i><p>Signature de Ty Coon</i>, 1<sup>er</sup> avril 1989
<p>Ty Coon, President of Vice
</tt>
<p>La pr&eacute;sente Licence Publique G&eacute;n&eacute;rale
n'autorise pas le concessionnaire &agrave; incorporer son programme
dans des programmes propri&eacute;taires. Si votre programme est une
biblioth&egrave;que de sous-programmes, vous pouvez consid&eacute;rer
comme plus int&eacute;ressant d'autoriser une &eacute;dition de liens
des applications propri&eacute;taires avec la biblioth&egrave;que. Si
c'est ce que vous souhaitez, vous devrez utiliser non pas la
pr&eacute;sente licence, mais la Licence Publique
G&eacute;n&eacute;rale pour Biblioth&egrave;ques GNU.

</body>
</html>

--- NEW FILE: inc_serialbase.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_SERIALBASE")) return;
define("_ECRIRE_INC_SERIALBASE", "1");


$spip_articles = array(
		"id_article"	=> "bigint(21) NOT NULL",
		"surtitre"	=> "text NOT NULL",
		"titre"	=> "text NOT NULL",
		"soustitre"	=> "text NOT NULL",
		"id_rubrique"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"descriptif"	=> "text NOT NULL",
		"chapo"	=> "mediumtext NOT NULL",
		"texte"	=> "longblob NOT NULL",
		"ps"	=> "mediumtext NOT NULL",
		"date"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"statut"	=> "varchar(10) DEFAULT '0' NOT NULL",
		"id_secteur"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"maj"	=> "TIMESTAMP",
		"export"	=> "VARCHAR(10) DEFAULT 'oui'",
		"date_redac"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"visites"	=> "INTEGER DEFAULT '0' NOT NULL",
		"referers"	=> "INTEGER DEFAULT '0' NOT NULL",
		"popularite"	=> "DOUBLE DEFAULT '0' NOT NULL",
		"accepter_forum"	=> "CHAR(3) NOT NULL",
		"auteur_modif"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"date_modif"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"lang"		=> "VARCHAR(10) DEFAULT '' NOT NULL",
		"langue_choisie"	=> "VARCHAR(3) DEFAULT 'non'",
		"id_trad"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"extra"		=> "longblob NULL",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"id_version"	=> "int unsigned DEFAULT '0' NOT NULL",
		"nom_site"	=> "tinytext NOT NULL",
		"url_site"	=> "VARCHAR(255) NOT NULL",
		"url_propre" => "VARCHAR(255) NOT NULL");

$spip_articles_key = array(
		"PRIMARY KEY"		=> "id_article",
		"KEY id_rubrique"	=> "id_rubrique",
		"KEY id_secteur"	=> "id_secteur",
		"KEY id_trad"		=> "id_trad",
		"KEY lang"			=> "lang",
		"KEY statut"		=> "statut, date",
		"KEY url_site"		=> "url_site",
		"KEY date_modif"	=> "date_modif",
		"KEY idx"			=> "idx",
		"KEY url_propre"	=> "url_propre");

$spip_auteurs = array(
		"id_auteur"	=> "bigint(21) NOT NULL",
		"nom"	=> "text NOT NULL",
		"bio"	=> "text NOT NULL",
		"email"	=> "tinytext NOT NULL",
		"nom_site"	=> "tinytext NOT NULL",
		"url_site"	=> "text NOT NULL",
		"login"	=> "VARCHAR(255) BINARY NOT NULL",
		"pass"	=> "tinytext NOT NULL",
		"low_sec"	=> "tinytext NOT NULL",
		"statut"	=> "VARCHAR(255) NOT NULL",
		"maj"	=> "TIMESTAMP",
		"pgp"	=> "BLOB NOT NULL",
		"htpass"	=> "tinyblob NOT NULL",
		"en_ligne"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"imessage"	=> "VARCHAR(3) NOT NULL",
		"messagerie"	=> "VARCHAR(3) NOT NULL",
		"alea_actuel"	=> "tinytext NOT NULL",
		"alea_futur"	=> "tinytext NOT NULL",
		"prefs"	=> "tinytext NOT NULL",
		"cookie_oubli"	=> "tinytext NOT NULL",
		"source"	=> "VARCHAR(10) DEFAULT 'spip' NOT NULL",
		"lang"	=> "VARCHAR(10) DEFAULT '' NOT NULL",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"extra"	=> "longblob NULL");

$spip_auteurs_key = array(
		"PRIMARY KEY"	=> "id_auteur",
		"KEY login"	=> "login",
		"KEY statut"	=> "statut",
		"KEY lang"	=> "lang",
		"KEY idx"	=> "idx",
		"KEY en_ligne"	=> "en_ligne");

$spip_breves = array(
		"id_breve"	=> "bigint(21) NOT NULL",
		"date_heure"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"titre"	=> "text NOT NULL",
		"texte"	=> "longblob NOT NULL",
		"lien_titre"	=> "text NOT NULL",
		"lien_url"	=> "text NOT NULL",
		"statut"	=> "varchar(6) NOT NULL",
		"id_rubrique"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"lang"	=> "VARCHAR(10) DEFAULT '' NOT NULL",
		"langue_choisie"	=> "VARCHAR(3) DEFAULT 'non'",
		"maj"	=> "TIMESTAMP",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"extra"	=> "longblob NULL",
		"url_propre" => "VARCHAR(255) NOT NULL");

$spip_breves_key = array(
		"PRIMARY KEY"	=> "id_breve",
		"KEY idx"	=> "idx",
		"KEY id_rubrique"	=> "id_rubrique",
		"KEY url_propre"	=> "url_propre");

$spip_messages = array(
		"id_message"	=> "bigint(21) NOT NULL",
		"titre"	=> "text NOT NULL",
		"texte"	=> "longblob NOT NULL",
		"type"	=> "varchar(6) NOT NULL",
		"date_heure"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"date_fin"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"rv"	=> "varchar(3) NOT NULL",
		"statut"	=> "varchar(6) NOT NULL",
		"id_auteur"	=> "bigint(21) NOT NULL",
		"maj"	=> "TIMESTAMP");

$spip_messages_key = array(
		"PRIMARY KEY"	=> "id_message",
		"KEY id_auteur"	=> "id_auteur");

$spip_mots = array(
		"id_mot"	=> "bigint(21) NOT NULL",
		"type"	=> "VARCHAR(100) NOT NULL",
		"titre"	=> "text NOT NULL",
		"descriptif"	=> "text NOT NULL",
		"texte"	=> "longblob NOT NULL",
		"id_groupe"	=> "bigint(21) NOT NULL",
		"extra"	=> "longblob NULL",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"url_propre" => "VARCHAR(255) NOT NULL",
		"maj"	=> "TIMESTAMP");

$spip_mots_key = array(
		"PRIMARY KEY"	=> "id_mot",
		"KEY idx"	=> "idx",
		"KEY type"	=> "type",
		"KEY url_propre"	=> "url_propre");

$spip_groupes_mots = array(
		"id_groupe"	=> "bigint(21) NOT NULL",
		"titre"	=> "text NOT NULL",
		"unseul"	=> "varchar(3) NOT NULL",
		"obligatoire"	=> "varchar(3) NOT NULL",
		"articles"	=> "varchar(3) NOT NULL",
		"breves"	=> "varchar(3) NOT NULL",
		"rubriques"	=> "varchar(3) NOT NULL",
		"syndic"	=> "varchar(3) NOT NULL",
		"0minirezo"	=> "varchar(3) NOT NULL",
		"1comite"	=> "varchar(3) NOT NULL",
		"6forum"	=> "varchar(3) NOT NULL",
		"maj"	=> "TIMESTAMP");

$spip_groupes_mots_key = array(
		"PRIMARY KEY"	=> "id_groupe");

$spip_rubriques = array(
		"id_rubrique"	=> "bigint(21) NOT NULL",
		"id_parent"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"titre"	=> "text NOT NULL",
		"descriptif"	=> "text NOT NULL",
		"texte"	=> "longblob NOT NULL",
		"id_secteur"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"maj"	=> "TIMESTAMP",
		"export"	=> "VARCHAR(10) DEFAULT 'oui'",
		"id_import"	=> "BIGINT DEFAULT '0'",
		"statut"	=> "VARCHAR(10) NOT NULL",
		"date"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"lang"	=> "VARCHAR(10) DEFAULT '' NOT NULL",
		"langue_choisie"	=> "VARCHAR(3) DEFAULT 'non'",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"extra"	=> "longblob NULL",
		"url_propre" => "VARCHAR(255) NOT NULL",
		"statut_tmp"	=> "VARCHAR(10) NOT NULL",
		"date_tmp"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL"
		);

$spip_rubriques_key = array(
		"PRIMARY KEY"	=> "id_rubrique",
		"KEY lang"	=> "lang",
		"KEY idx"	=> "idx",
		"KEY id_parent"	=> "id_parent",
		"KEY url_propre"	=> "url_propre");

$spip_documents = array(
		"id_document"	=> "bigint(21) NOT NULL",
		"id_vignette"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"id_type"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"titre"	=> "text NOT NULL",
		"date"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"descriptif"	=> "text NOT NULL",
		"fichier"	=> "varchar(255) NOT NULL",
		"taille"	=> "integer NOT NULL",
		"largeur"	=> "integer NOT NULL",
		"hauteur"	=> "integer NOT NULL",
		"mode"	=> "ENUM('vignette', 'document') NOT NULL",
		"inclus"	=> "VARCHAR(3) DEFAULT 'non'",
		"maj"	=> "TIMESTAMP");

$spip_documents_key = array(
		"PRIMARY KEY"	=> "id_document",
		"KEY id_vignette"	=> "id_vignette",
		"KEY mode"	=> "mode",
		"KEY id_type"	=> "id_type");

$spip_types_documents = array(
		"id_type"	=> "bigint(21) NOT NULL",
		"titre"	=> "text NOT NULL",
		"descriptif"	=> "text NOT NULL",
		"extension"	=> "varchar(10) NOT NULL",
		"mime_type"	=> "varchar(100) NOT NULL",
		"inclus"	=> "ENUM('non', 'image', 'embed') NOT NULL DEFAULT 'non'",
		"upload"	=> "ENUM('oui', 'non') NOT NULL DEFAULT 'oui'",
		"maj"	=> "TIMESTAMP");

$spip_types_documents_key = array(
		"PRIMARY KEY"	=> "id_type",
		"UNIQUE extension"	=> "extension",
		"KEY inclus"	=> "inclus");

$spip_syndic = array(
		"id_syndic"	=> "bigint(21) NOT NULL",
		"id_rubrique"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"id_secteur"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"nom_site"	=> "blob NOT NULL",
		"url_site"	=> "blob NOT NULL",
		"url_syndic"	=> "blob NOT NULL",
		"descriptif"	=> "blob NOT NULL",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"maj"	=> "TIMESTAMP",
		"syndication"	=> "VARCHAR(3) NOT NULL",
		"statut"	=> "VARCHAR(10) NOT NULL",
		"date"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"date_syndic"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"date_index"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"moderation"	=> "VARCHAR(3) NOT NULL");

$spip_syndic_key = array(
		"PRIMARY KEY"	=> "id_syndic",
		"KEY id_rubrique"	=> "id_rubrique",
		"KEY id_secteur"	=> "id_secteur",
		"KEY idx"		=> "idx",
		"KEY statut"	=> "statut, date_syndic");

$spip_syndic_articles = array(
		"id_syndic_article"	=> "bigint(21) NOT NULL",
		"id_syndic"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"titre"	=> "text NOT NULL",
		"url"	=> "VARCHAR(255) NOT NULL",
		"date"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"lesauteurs"	=> "text NOT NULL",
		"maj"	=> "TIMESTAMP",
		"statut"	=> "VARCHAR(10) NOT NULL",
		"descriptif"	=> "blob NOT NULL");

$spip_syndic_articles_key = array(
		"PRIMARY KEY"	=> "id_syndic_article",
		"KEY id_syndic"	=> "id_syndic",
		"KEY statut"	=> "statut",
		"KEY url"	=> "url");

$spip_forum = array(
		"id_forum"	=> "bigint(21) NOT NULL",
		"id_parent"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"id_thread"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"id_rubrique"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"id_article"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"id_breve"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"date_heure"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"titre"	=> "text NOT NULL",
		"texte"	=> "mediumtext NOT NULL",
		"auteur"	=> "text NOT NULL",
		"email_auteur"	=> "text NOT NULL",
		"nom_site"	=> "text NOT NULL",
		"url_site"	=> "text NOT NULL",
		"statut"	=> "varchar(8) NOT NULL",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"ip"	=> "varchar(16)",
		"maj"	=> "TIMESTAMP",
		"id_auteur"	=> "BIGINT DEFAULT '0' NOT NULL",
		"id_message"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"id_syndic"	=> "bigint(21) DEFAULT '0' NOT NULL");

$spip_forum_key = array(
		"PRIMARY KEY"	=> "id_forum",
		"KEY id_parent"	=> "id_parent",
		"KEY id_rubrique"	=> "id_rubrique",
		"KEY id_article"	=> "id_article",
		"KEY id_breve"	=> "id_breve",
		"KEY id_message"	=> "id_message",
		"KEY id_syndic"	=> "id_syndic",
		"KEY idx"	=> "idx",
		"KEY statut"	=> "statut, date_heure");

$spip_signatures = array(
		"id_signature"	=> "bigint(21) NOT NULL",
		"id_article"	=> "bigint(21) DEFAULT '0' NOT NULL",
		"date_time"	=> "datetime DEFAULT '0000-00-00 00:00:00' NOT NULL",
		"nom_email"	=> "text NOT NULL",
		"ad_email"	=> "text NOT NULL",
		"nom_site"	=> "text NOT NULL",
		"url_site"	=> "text NOT NULL",
		"message"	=> "mediumtext NOT NULL",
		"statut"	=> "varchar(10) NOT NULL",
		"idx"		=> "ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL",
		"maj"	=> "TIMESTAMP");

$spip_signatures_key = array(
		"PRIMARY KEY"	=> "id_signature",
		"KEY id_article"	=> "id_article",
		"KEY idx"		=> "idx",
		"KEY statut" => "statut");

global $tables_principales;

/// Attention: mes_fonctions peut avoir deja defini cette variable
/// il faut donc rajouter, mais pas reinitialiser

$tables_principales['articles'] =
	array('field' => &$spip_articles, 'key' => &$spip_articles_key);
$tables_principales['auteurs']  =
	array('field' => &$spip_auteurs, 'key' => &$spip_auteurs_key);
$tables_principales['breves']   =
	array('field' => &$spip_breves, 'key' => &$spip_breves_key);
$tables_principales['messages'] =
	array('field' => &$spip_messages, 'key' => &$spip_messages_key);
$tables_principales['mots']     =
	array('field' => &$spip_mots, 'key' => &$spip_mots_key);
$tables_principales['groupes_mots'] =
	array('field' => &$spip_groupes_mots, 'key' => &$spip_groupes_mots_key);
$tables_principales['rubriques'] =
	array('field' => &$spip_rubriques, 'key' => &$spip_rubriques_key);
$tables_principales['documents'] =
	array('field' => &$spip_documents,  'key' => &$spip_documents_key);
$tables_principales['types_documents']	=
	array('field' => &$spip_types_documents, 'key' => &$spip_types_documents_key);
$tables_principales['syndic'] =
	array('field' => &$spip_syndic, 'key' => &$spip_syndic_key);
$tables_principales['syndic_articles']	=
	array('field' => &$spip_syndic_articles, 'key' => &$spip_syndic_articles_key);
$tables_principales['forum'] =
	array('field' => &$spip_forum,	'key' => &$spip_forum_key);
$tables_principales['signatures'] =
	array('field' => &$spip_signatures, 'key' => &$spip_signatures_key);

?>

--- NEW FILE: auteurs_edit.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_acces.php3");
include_ecrire ("inc_index.php3");
include_ecrire ("inc_logos.php3");

function supp_auteur($id_auteur) {
	$query="UPDATE spip_auteurs SET statut='5poubelle' WHERE id_auteur=$id_auteur";
	$result=spip_query($query);
}


function afficher_auteur_rubriques($leparent){
	global $id_parent;
	global $id_rubrique;
	global $toutes_rubriques;
	global $i;
	
	$i++;
 	$query="SELECT * FROM spip_rubriques WHERE id_parent='$leparent' ORDER BY titre";
 	$result=spip_query($query);

	while($row=spip_fetch_array($result)){
		$my_rubrique=$row["id_rubrique"];
		$titre=typo($row["titre"]);
	
		if (!ereg(",$my_rubrique,","$toutes_rubriques")){
			$espace="";
			for ($count=0;$count<$i;$count++){$espace.="&nbsp;&nbsp;";}
			$espace .= "|";
			if ($i==1)
				$espace = "*";

			echo "<OPTION VALUE='$my_rubrique'>$espace ".supprimer_tags($titre)."\n";
			afficher_auteur_rubriques($my_rubrique);
		}
	}
	$i=$i-1;
}


$query = "SELECT * FROM spip_auteurs WHERE id_auteur='$id_auteur'";
$result = spip_query($query);


if ($row = spip_fetch_array($result)) {
	$id_auteur=$row['id_auteur'];
	$nom=$row['nom'];
	$bio=$row['bio'];
	$email=$row['email'];
	$nom_site_auteur=$row['nom_site'];
	$url_site=$row['url_site'];
	$login=$row['login'];
	$pass=$row['pass'];
	$statut=$row['statut'];
	$pgp=$row["pgp"];
	$messagerie=$row["messagerie"];
	$imessage=$row["imessage"];
	$extra = $row["extra"];
	$low_sec = $row["low_sec"];


if ($connect_id_auteur == $id_auteur) debut_page($nom, "auteurs", "perso");
else debut_page($nom,"auteurs","redacteurs");


echo "<br><br><br>";

debut_gauche();



debut_boite_info();

echo "<CENTER>";

echo "<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=1><B>"._T('info_gauche_numero_auteur')."&nbsp;:</B></FONT>";
echo "<BR><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=6><B>$id_auteur</B></FONT>";
echo "</CENTER>";

fin_boite_info();




//////////////////////////////////////////////////////
// Logos de l'auteur
//

$arton = "auton$id_auteur";
$artoff = "autoff$id_auteur";

if ($id_auteur>0 AND (($connect_statut == '0minirezo') OR ($connect_id_auteur == $id_auteur)))
	afficher_boite_logo($arton, $artoff, _T('logo_auteur').aide ("logoart"), _T('logo_survol'));


debut_droite();

function mySel($varaut,$variable) {
	$retour = " VALUE=\"$varaut\"";
	if ($variable==$varaut){
		$retour.= " SELECTED";
	}
	return $retour;
}

	debut_cadre_relief("redacteurs-24.gif");
	
	
	echo "<table width='100%' cellpadding='0' border='0' cellspacing='0'>";
	
	echo "<tr>";

	echo "<td valign='top' width='100%'>";	


	gros_titre($nom);

	echo "<div>&nbsp;</div>";

	if (strlen($email) > 2) echo "<div>"._T('email_2')." <B><A HREF='mailto:$email'>$email</A></B></div>";
	if (strlen($nom_site_auteur) > 2) echo "<div>"._T('info_site_2')." <B><A HREF='$url_site'>$nom_site_auteur</A></B></div>";

		
	echo "</td>";
	
	echo "<td>";
	
	if (($connect_statut == "0minirezo") OR $connect_id_auteur == $id_auteur) {
		icone (_T("admin_modifier_auteur"), "auteur_infos.php3?id_auteur=$id_auteur", "redacteurs-24.gif", "edit.gif");
	}
	echo "</td></tr></table>";

	if (strlen($bio) > 0) { echo "<div>".propre("<quote>".$bio."</quote>")."</div>"; }
	if (strlen($pgp) > 0) { echo "<div>".propre("PGP:<cadre>".$pgp."</cadre>")."</div>"; }

	if ($champs_extra AND $extra) {
		include_ecrire("inc_extra.php3");
		extra_affichage($extra, "auteurs");
	}


	fin_cadre_relief();


echo "<div>&nbsp;</div>";
if ($connect_statut == "0minirezo") $aff_art = "'prepa','prop','publie','refuse'";
else if ($connect_id_auteur == $id_auteur) $aff_art = "'prepa','prop','publie'";
else $aff_art = "'prop','publie'";

afficher_articles(_T('info_articles_auteur'),
	", spip_auteurs_articles AS lien WHERE lien.id_auteur='$id_auteur' ".
	"AND lien.id_article=articles.id_article AND articles.statut IN ($aff_art) ".
	"ORDER BY articles.date DESC", true);
}


if ($id_auteur != $connect_id_auteur) {
	echo "<div>&nbsp;</div>";
	debut_cadre_couleur();
	
	$query_message = "SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien, spip_auteurs_messages AS lien2 ".
		"WHERE lien.id_auteur=$connect_id_auteur AND lien2.id_auteur = $id_auteur AND statut='publie' AND type='normal' AND rv!='oui' AND lien.id_message=messages.id_message AND lien2.id_message=messages.id_message";
	afficher_messages(_T('info_discussion_cours'), $query_message, false, false);
	
	$query_message = "SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien, spip_auteurs_messages AS lien2 ".
		"WHERE lien.id_auteur=$connect_id_auteur AND lien2.id_auteur = $id_auteur AND statut='publie' AND type='normal' AND rv='oui' AND date_fin > NOW() AND lien.id_message=messages.id_message AND lien2.id_message=messages.id_message";
	afficher_messages(_T('info_vos_rendez_vous'), $query_message, false, false);
	
	icone_horizontale(_T('info_envoyer_message_prive'),"message_edit.php3?new=oui&type=normal&dest=$id_auteur", "message.gif");
	fin_cadre_couleur();
}

fin_page();

?>

--- NEW FILE: cartes.php3 ---
<?php

include ("inc.php3");

include_ecrire ("inc_carto.php3");


debut_page(_L("Toutes les cartes"), "documents", "cartes");
debut_gauche();



debut_droite();



afficher_cartes(_L("Toutes les cartes"),
	"SELECT cartes.*, COUNT(id_objet) AS objets ".
	"FROM spip_carto_carte AS cartes LEFT JOIN spip_carto_objet AS objets ".
	"ON (cartes.id_carte=objets.id_carte) ".
	"GROUP BY cartes.id_carte ORDER BY cartes.titre");
//TODO : gerer un statut par objet
//ajouter cette clause ? la jointure :
//// AND objets.statut='valide'

//TODO : afficher par lot.
//peut etre par id_srs ... ? voir
//WHERE id_srs='$x' 
echo "<br />\n";

if (carte_editable()) {
	echo "<div align='right'>";
	$link = new Link('carte_edit.php3');
	$link->addVar('new', 'oui');
	$link->addVar('retour', $clean_link->getUrl());
	icone(_L("Cr&eacute;er une nouvelle carte"), $link->getUrl(), "carte-24.gif", "creer.gif");
	echo "</div>";
}



fin_page();

?>


--- NEW FILE: aide_index.php3 ---
<?php

include ("inc_version.php3");
include_ecrire ("inc_presentation.php3");


// Eviter les calculs evitables (surtout en client/serveur sans cache !)
$lastmodified = filemtime("aide_index.php3");
$headers_only = http_last_modified($lastmodified, time() + 24 * 3600);
if ($headers_only) exit;

include_ecrire ("inc_filtres.php3");
include_ecrire ("inc_layer.php3");
include_ecrire ("inc_texte.php3");

// Recuperer les infos de langue (preferences auteur), si possible
if (_FILE_CONNECT) {
	include_ecrire ("inc_auth.php3");
}
include_ecrire ("inc_lang.php3");
utiliser_langue_visiteur();
if ($var_lang) changer_langue($var_lang);

/////////////////////////////
// La frame de base
//
function help_frame ($aide) {
	global $spip_lang;

	echo "</head>\n";

	$frame_menu = "<frame src=\"aide_index.php3?aide=$aide&var_lang=$spip_lang&frame=menu\" name=\"gauche\" scrolling=\"auto\" noresize>\n";
	$frame_body = "<frame src=\"aide_index.php3?aide=$aide&var_lang=$spip_lang&frame=body\" name=\"droite\" scrolling=\"auto\" noresize>\n";

	if ($GLOBALS['spip_lang_rtl']) {
		echo '<frameset cols="*,160" border="0" frameborder="0" framespacing="0">';
		echo $frame_body.$frame_menu;
	}
	else {
		echo '<frameset cols="160,*" border="0" frameborder="0" framespacing="0">';
		echo $frame_menu.$frame_body;
	}
	echo '</frameset>';
	echo "\n</html>";
}



/////////////////////////////
// Le contenu demande
//

// Selection de l'aide correspondant a la langue demandee
function fichier_aide($lang_aide = '') {
	global $help_server;

	if (!$lang_aide) $lang_aide = $GLOBALS['spip_lang'];

	// fichier local ?
	if (@file_exists($fichier_aide = "AIDE/$lang_aide/aide.html")) 
		return array(file($fichier_aide), $lang_aide);

	// fichier local ? si reduction ISO du code langue oc_prv_ni => oc
	else if (ereg("(.*)_", $lang_aide, $regs)
		AND (@file_exists($fichier_aide = "AIDE/".$regs[1]."/aide.html")))
			return array(file($fichier_aide), $regs[1]);

	// Aide internet
	else {
		// en cache ?
		if (!@file_exists($fichier_aide = _DIR_CACHE . "aide-$lang_aide-aide.html")) {
			if ($help_server) {
				include_ecrire('inc_sites.php3');
				if (ecrire_fichier(_DIR_CACHE . 'aide-test', "test")
				AND ($contenu = recuperer_page("$help_server/$lang_aide-aide.html")))
					ecrire_fichier ($fichier_aide, $contenu);
			}
		}

		lire_fichier($fichier_aide, $contenu);
		if (strlen($contenu) > 500) {
			return array($contenu, $lang_aide);
		}
	}

	return false;
}


function help_body($aide, $html) {
	global $help_server;

	if (!$aide) $aide = 'spip';

	// Recuperation du contenu de l'aide demandee
	$html = analyse_aide($html, $aide);

	// Recherche des images de l'aide
	$suite = $html;
	$html = "";
	while (preg_match("@(<img([^<>]* +)? src=['\"])"
		. "((AIDE|IMG)/([-_a-zA-Z0-9]*/?)([^'\"<>]*))@i",
	$suite, $r)) {

		$image = $r[3];
		$image_plat = str_replace('/', '-', $image);

		# Image installee a l'ancienne
		if (@file_exists($image))
			$f = $image;
		else
		# Image telechargee ou a telecharger
			$f = "aide_index.php3?img=$image_plat";

		$p = strpos($suite, $r[0]);
		$html .= substr($suite, 0, $p) . $r[1].$f;
		$suite = substr($suite, $p + strlen($r[0]));
	}

	$html .= $suite;

?>
<style type="text/css"><!--
.spip_cadre {
	width : 100%;
	background-color: #FFFFFF;
	padding: 5px;
}
.spip_quote {
	margin-left : 40px;
	margin-top : 10px;
	margin-bottom : 10px;
	border : solid 1px #aaaaaa;
	background-color: #dddddd;
	padding: 5px;
}

a {text-decoration: none;}
a:hover {color:#FF9900; text-decoration: underline;}

body {
	font-family: Georgia, Garamond, Times New Roman, serif;
}
h3.spip {
	font-family: Verdana,Arial,Sans,sans-serif;
	font-weight: bold;
	font-size: 115%;
	text-align: center;
}

table.spip {
}

table.spip tr.row_first {
	background-color: #FCF4D0;
}

table.spip tr.row_odd {
	background-color: #C0C0C0;
}

table.spip tr.row_even {
	background-color: #F0F0F0;
}

table.spip td {
	padding: 1px;
	text-align: left;
	vertical-align: center;
}

--></style>
</head>
<?php

	echo '<body bgcolor="#FFFFFF" text="#000000" TOPMARGIN="24" LEFTMARGIN="24" MARGINWIDTH="24" MARGINHEIGHT="24"';
	if ($spip_lang_rtl)
		echo " dir='rtl'";
	echo " lang='$lang_aide'>";

	if ($aide == 'spip') {
		echo '<TABLE BORDER=0 WIDTH=100% HEIGHT=60%>
<TR WIDTH=100% HEIGHT=60%>
<TD WIDTH=100% HEIGHT=60% ALIGN="center" VALIGN="middle">

<CENTER>
<img src="aide_index.php3?img=AIDE--logo-spip.gif" alt="SPIP" width="300" height="170" border="0">
</CENTER>
</TD></TR></TABLE>';
	}

	// Il faut que la langue de typo() soit celle de l'aide en ligne
	changer_typo($lang_aide);

	$html = justifier($html."<p>");
	// Remplacer les liens externes par des liens ouvrants (a cause des frames)
	$html = ereg_replace('<a href="(http://[^"]+)"([^>]*)>', '<a href="\\1"\\2 target="_blank">', $html);

	echo $html;

}


/////////////////////////////////////
// Recuperer une image dans le cache
//
function help_img($regs) {
	global $help_server;

	list ($cache, $rep, $lang, $file, $ext) = $regs;

	header("Content-Type: image/$ext");
	if (@file_exists(_DIR_CACHE . 'aide-'.$cache)) {
		readfile(_DIR_CACHE . 'aide-'.$cache);
	} else {
		include_ecrire('inc_sites.php3');
		if (ecrire_fichier(_DIR_CACHE . 'aide-test', "test")
		AND ($contenu =
		recuperer_page("$help_server/$rep/$lang/$file"))) {
			echo $contenu;
			ecrire_fichier (_DIR_CACHE . 'aide-'.$cache, $contenu);
		} else
			header ("Location: $help_server/$rep/$lang/$file");
	}
	exit;
}

///////////////////////////////////////
// Le menu de gauche
//
function help_menu($aide, $html) {
	global $spip_lang_left, $spip_lang_rtl, $spip_lang_right;

$triangle = "url(" . _DIR_IMG_PACK . 'triangle'.$spip_lang_rtl.'.gif) ';

echo '<style type="text/css">
<!--
	a {text-decoration: none; }
	A:Hover {text-decoration: underline;}

	.article-inactif {
		float: '.$spip_lang_left.';
		text-align: '.$spip_lang_left.';
		width: 80%;
		background: ' . $triangle . $spip_lang_left.' center no-repeat;
		margin: 2px;
		padding: 0px;
		padding-'.$spip_lang_left.': 20px;
		font-family: Arial, Sans, sans-serif;
		font-size: 12px;
	}
	.article-actif {
		float: '.$spip_lang_right.';
		text-align: '.$spip_lang_right.';
		width: 80%;
		background: ' . $triangle . $spip_lang_right.' center no-repeat;
		margin: 4px;
		padding: 0px;
		padding-'.$spip_lang_right.': 20px;
		font-family: Arial, Sans, sans-serif;
		font-size: 12px;
		font-weight: bold;
		color: black;
	}
	.article-actif:hover {
		text-decoration: none;
	}
	.rubrique {
		width: 90%;
		margin: 0px;
		margin-top: 6px;
		margin-bottom: 4px;
		padding: 4px;
		font-family: Trebuchet MS, Arial, Sans, sans-serif;
		font-size: 13px;
		font-weight: bold;
		color: black;
		background-color: #EEEECC;
		-moz-border-radius: 4px;
	}
-->
</style>
<script type="text/javascript"><!--
var curr_article;
function activer_article(id) {
	if (curr_article)
		document.getElementById(curr_article).className = "article-inactif";
	if (id) {
		document.getElementById(id).className = "article-actif";
		curr_article = id;
	}
}
//--></script>
';

afficher_script_layer();
echo '
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#E86519" vlink="#6E003A" alink="#FF9900" TOPMARGIN="5" LEFTMARGIN="5" MARGINWIDTH="5" MARGINHEIGHT="5"';

	if ($spip_lang_rtl)
		echo " dir='rtl'";
	echo " lang='$lang_aide'>";


	// Recuperation et analyse de la structure de l'aide demandee
	$sections = analyse_aide($html);
	foreach ($sections as $section) {
		if ($section[1] == '1') {
			if ($rubrique_vue)
				fin_rubrique();
			rubrique($section[3].$section[5]);
			$rubrique_vue = true;
		} else
			article($section[5], $section[3]);
	}
	fin_rubrique();
}


function rubrique($titre, $statut = "redac") {
	global $ligne_rubrique;
	global $block_rubrique;
	global $titre_rubrique;
	global $afficher_rubrique, $ouvrir_rubrique;
	global $larubrique;

	global $aide_statut;

	$afficher_rubrique = 0;

	if (($statut == "admin" AND $aide_statut == "admin") OR ($statut == "redac")) {
		$larubrique++;
		$titre_rubrique = $titre;
		$ligne_rubrique = array();
		$block_rubrique = "block$larubrique";
		$afficher_rubrique = 1;
		$ouvrir_rubrique = 0;
	}
}

function fin_rubrique() {
	global $ligne_rubrique;
	global $block_rubrique;
	global $titre_rubrique;
	global $afficher_rubrique, $ouvrir_rubrique;
	global $texte;

	if ($afficher_rubrique && count($ligne_rubrique)) {
		echo "<div class='rubrique'>";
		if ($ouvrir_rubrique)
			echo bouton_block_visible($block_rubrique);
		else 
			echo bouton_block_invisible($block_rubrique);
		echo $titre_rubrique;
		echo "</div>\n";
		if ($ouvrir_rubrique)
			echo debut_block_visible($block_rubrique);
		else
			echo debut_block_invisible($block_rubrique);
		echo "\n";
		reset($ligne_rubrique);
		while (list(, $ligne) = each($ligne_rubrique)) {
			echo $texte[$ligne];
		}
		echo fin_block();
		echo "\n\n";
	}
}

function article($titre, $lien, $statut = "redac") {
	global $aide;
	global $ligne;
	global $ligne_rubrique;
	global $rubrique;
	global $texte;
	global $afficher_rubrique, $ouvrir_rubrique;
	global $aide_statut;
	global $spip_lang;

	if ($afficher_rubrique AND (($statut == "admin" AND $aide_statut == "admin") OR ($statut == "redac"))) {
		$ligne_rubrique[] = ++$ligne;
		
		$texte[$ligne] = '';
		$id = "ligne$ligne";
		$url = "aide_index.php3?aide=$lien&frame=body&var_lang=$spip_lang";
		if ($aide == $lien) {
			$ouvrir_rubrique = 1;
			$class = "article-actif";
			$texte[$ligne] .= "<script type='text/javascript'><!--\ncurr_article = '$id';\n// --></script>\n";
		}
		else {
			$class = "article-inactif";
		}
		$texte[$ligne] .= "<a class='$class' id='$id' href='$url' target='droite' ".
			"onClick=\"activer_article('$id');return true;\">$titre</a><br style='clear:both;'>\n";
	}
}


function analyse_aide($html, $aide=false) {

	preg_match_all(',<h([12])( class="spip")?'. '>([^/]+?)(/(.+?))?</h\1>,ism',
	$html, $regs, PREG_SET_ORDER);

	if ($aide) {
		unset ($regs);
		$preg = ',<h2( class="spip")?'
		. ">$aide/(.+?)</h2>(.*)$,ism";
		preg_match($preg, $html, $regs);
		$regs = preg_replace(',<h[12].*,ism', '', $regs[3]);
	}

	return $regs;
}


//
// Distribuer le travail
//
if (preg_match(',^([^-.]*)-([^-.]*)-([^\.]*\.(gif|jpg|png))$,', $img, $regs))
	help_img($regs);
else {
	list($html, $l, $url_aide) = fichier_aide();

	// On n'a pas d'aide du tout
	if (!$html) {
		// Renvoyer sur l'aide en ligne du serveur externe
		// (hack: sauf sur SPIP.NET)
		if ($help_server AND !defined('SPIP.NET_PAS_DE_BOUCLE_AIDE'))
			@Header("Location: $help_server/?lang=$spip_lang");
		// Ou alors message d'erreur
		else {
			include_ecrire('inc_presentation.php3');
			install_debut_html(_T('forum_titre_erreur'));
			echo "<div>"._T('aide_non_disponible')."</div>";
			install_fin_html();
			exit;
		}
	} else {
		echo debut_entete(_T('info_aide_en_ligne'),
				  "Content-Type: text/html; charset=utf-8");
		if ($frame == 'menu')
			help_menu($aide, $html);
		else if ($frame == 'body')
			help_body($aide, $html);
		else
			help_frame($aide);
	}
}

?>

--- NEW FILE: inc_majbase.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_MAJBASE")) return;
define("_ECRIRE_INC_MAJBASE", "1");

function maj_version ($version, $test = true) {
	if ($test) {
		include_ecrire('inc_meta.php3');
		ecrire_meta('version_installee', $version);
		ecrire_metas();
		spip_log("mise a jour de la base vers $version");
	} else {
		include_ecrire ('inc_lang.php3');
		echo _T('alerte_maj_impossible', array('version' => $version));
		exit;
	}
}

function maj_base() {
	global $spip_version;

	//
	// Lecture de la version installee
	//
	$version_installee = 0.0;
	$result = spip_query("SELECT valeur FROM spip_meta WHERE nom='version_installee'");
	if ($result) if ($row = spip_fetch_array($result)) $version_installee = (double) $row['valeur'];

	//
	// Si pas de version mentionnee dans spip_meta, c'est qu'il s'agit
	// d'une nouvelle installation
	//   => ne pas passer par le processus de mise a jour
	//
	// $version_installee = 1.702; quand on a besoin de forcer une MAJ
	if (!$version_installee) {
		include_ecrire('inc_meta.php3');
		ecrire_meta('version_installee', $spip_version);
		ecrire_metas();
		return true;
	}


	//
	// Verification des droits de modification sur la base
	//

	spip_query("DROP TABLE IF EXISTS spip_test");
	spip_query("CREATE TABLE spip_test (a INT)");
	spip_query("ALTER TABLE spip_test ADD b INT");
	spip_query("INSERT INTO spip_test (b) VALUES (1)");
	$result = spip_query("SELECT b FROM spip_test");
	spip_query("ALTER TABLE spip_test DROP b");
	if (!$result) return false;

	//
	// Selection en fonction de la version
	//
	if ($version_installee < 0.98) {

		spip_query("ALTER TABLE spip_articles ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_articles ADD export VARCHAR(10) DEFAULT 'oui'");
		spip_query("ALTER TABLE spip_articles ADD images TEXT DEFAULT ''");
		spip_query("ALTER TABLE spip_articles ADD date_redac datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		spip_query("ALTER TABLE spip_articles DROP INDEX id_article");
		spip_query("ALTER TABLE spip_articles ADD INDEX id_rubrique (id_rubrique)");
		spip_query("ALTER TABLE spip_articles ADD visites INTEGER DEFAULT '0' NOT NULL");
		spip_query("ALTER TABLE spip_articles ADD referers BLOB NOT NULL");

		spip_query("ALTER TABLE spip_auteurs ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_auteurs ADD pgp BLOB NOT NULL");

		spip_query("ALTER TABLE spip_auteurs_articles ADD INDEX id_auteur (id_auteur), ADD INDEX id_article (id_article)");
	
		spip_query("ALTER TABLE spip_rubriques ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_rubriques ADD export VARCHAR(10) DEFAULT 'oui', ADD id_import BIGINT DEFAULT '0'");
	
		spip_query("ALTER TABLE spip_breves ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_breves DROP INDEX id_breve");
		spip_query("ALTER TABLE spip_breves DROP INDEX id_breve_2");
		spip_query("ALTER TABLE spip_breves ADD INDEX id_rubrique (id_rubrique)");
	
		spip_query("ALTER TABLE spip_forum ADD ip VARCHAR(16)");
		spip_query("ALTER TABLE spip_forum ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_forum DROP INDEX id_forum");
		spip_query("ALTER TABLE spip_forum ADD INDEX id_parent (id_parent), ADD INDEX id_rubrique (id_rubrique), ADD INDEX id_article(id_article), ADD INDEX id_breve(id_breve)");
		maj_version (0.98);
	}

	if ($version_installee < 0.99) {
	
		$query = "SELECT DISTINCT id_article FROM spip_forum WHERE id_article!=0 AND id_parent=0";
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			unset($forums_article);
			$id_article = $row['id_article'];
			$query2 = "SELECT id_forum FROM spip_forum WHERE id_article=$id_article";
			for (;;) {
				$result2 = spip_query($query2);
				unset($forums);
				while ($row2 = spip_fetch_array($result2)) $forums[] = $row2['id_forum'];
				if (!$forums) break;
				$forums = join(',', $forums);
				$forums_article[] = $forums;
				$query2 = "SELECT id_forum FROM spip_forum WHERE id_parent IN ($forums)";
			}
			$forums_article = join(',', $forums_article);
			$query3 = "UPDATE spip_forum SET id_article=$id_article WHERE id_forum IN ($forums_article)";
			spip_query($query3);
		}
	
		$query = "SELECT DISTINCT id_breve FROM spip_forum WHERE id_breve!=0 AND id_parent=0";
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			unset($forums_breve);
			$id_breve = $row['id_breve'];
			$query2 = "SELECT id_forum FROM spip_forum WHERE id_breve=$id_breve";
			for (;;) {
				$result2 = spip_query($query2);
				unset($forums);
				while ($row2 = spip_fetch_array($result2)) $forums[] = $row2['id_forum'];
				if (!$forums) break;
				$forums = join(',', $forums);
				$forums_breve[] = $forums;
				$query2 = "SELECT id_forum FROM spip_forum WHERE id_parent IN ($forums)";
			}
			$forums_breve = join(',', $forums_breve);
			$query3 = "UPDATE spip_forum SET id_breve=$id_breve WHERE id_forum IN ($forums_breve)";
			spip_query($query3);
		}
	
		$query = "SELECT DISTINCT id_rubrique FROM spip_forum WHERE id_rubrique!=0 AND id_parent=0";
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			unset($forums_rubrique);
			$id_rubrique = $row['id_rubrique'];
			$query2 = "SELECT id_forum FROM spip_forum WHERE id_rubrique=$id_rubrique";
			for (;;) {
				$result2 = spip_query($query2);
				unset($forums);
				while ($row2 = spip_fetch_array($result2)) $forums[] = $row2['id_forum'];
				if (!$forums) break;
				$forums = join(',', $forums);
				$forums_rubrique[] = $forums;
				$query2 = "SELECT id_forum FROM spip_forum WHERE id_parent IN ($forums)";
			}
			$forums_rubrique = join(',', $forums_rubrique);
			$query3 = "UPDATE spip_forum SET id_rubrique=$id_rubrique WHERE id_forum IN ($forums_rubrique)";
			spip_query($query3);
		}
		maj_version (0.99);
	}

	if ($version_installee < 0.997) {
		spip_query("DROP TABLE spip_index");
		maj_version (0.997);
	}

	if ($version_installee < 0.999) {
		global $htsalt;
		spip_query("ALTER TABLE spip_auteurs CHANGE pass pass tinyblob NOT NULL");
		spip_query("ALTER TABLE spip_auteurs ADD htpass tinyblob NOT NULL");
		$query = "SELECT id_auteur, pass FROM spip_auteurs WHERE pass!=''";
		$result = spip_query($query);
		while (list($id_auteur, $pass) = spip_fetch_array($result)) {
			$htpass = generer_htpass($pass);
			$pass = md5($pass);
			spip_query("UPDATE spip_auteurs SET pass='$pass', htpass='$htpass' WHERE id_auteur=$id_auteur");
		}
		maj_version (0.999);
	}
	
	if ($version_installee < 1.01) {
		spip_query("UPDATE spip_forum SET statut='publie' WHERE statut=''");
		maj_version (1.01);
	}
	
	if ($version_installee < 1.02) {
		spip_query("ALTER TABLE spip_forum ADD id_auteur BIGINT DEFAULT '0' NOT NULL");
		maj_version (1.02);
	}

	if ($version_installee < 1.03) {
		spip_query("DROP TABLE spip_maj");
		maj_version (1.03);
	}

	if ($version_installee < 1.04) {
		spip_query("ALTER TABLE spip_articles ADD accepter_forum VARCHAR(3)");
		maj_version (1.04);
	}

	if ($version_installee < 1.05) {
		spip_query("DROP TABLE spip_petition");
		spip_query("DROP TABLE spip_signatures_petition");
		maj_version (1.05);
	}

	if ($version_installee < 1.1) {
		spip_query("DROP TABLE spip_petition");
		spip_query("DROP TABLE spip_signatures_petition");
		maj_version (1.1);
	}

	// Correction de l'oubli des modifs creations depuis 1.04
	if ($version_installee < 1.204) {
		spip_query("ALTER TABLE spip_articles ADD accepter_forum VARCHAR(3) NOT NULL");
		spip_query("ALTER TABLE spip_forum ADD id_message bigint(21) NOT NULL");
		spip_query("ALTER TABLE spip_forum ADD INDEX id_message (id_message)");
		spip_query("ALTER TABLE spip_auteurs ADD en_ligne datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		spip_query("ALTER TABLE spip_auteurs ADD imessage VARCHAR(3) not null");
		spip_query("ALTER TABLE spip_auteurs ADD messagerie VARCHAR(3) not null");
		maj_version (1.204);
	}

	if ($version_installee < 1.207) {
		spip_query("ALTER TABLE spip_rubriques DROP INDEX id_rubrique");
		spip_query("ALTER TABLE spip_rubriques ADD INDEX id_parent (id_parent)");
		spip_query("ALTER TABLE spip_rubriques ADD statut VARCHAR(10) NOT NULL");
		// Declencher le calcul des rubriques publiques
		spip_query("REPLACE spip_meta (nom, valeur) VALUES ('calculer_rubriques', 'oui')");
		maj_version (1.207);
	}

	if ($version_installee < 1.208) {
		spip_query("ALTER TABLE spip_auteurs_messages CHANGE forum vu CHAR(3) NOT NULL");
		spip_query("UPDATE spip_auteurs_messages SET vu='oui'");
		spip_query("UPDATE spip_auteurs_messages SET vu='non' WHERE statut='a'");

		spip_query("ALTER TABLE spip_messages ADD id_auteur bigint(21) NOT NULL");
		spip_query("ALTER TABLE spip_messages ADD INDEX id_auteur (id_auteur)");
		$result = spip_query("SELECT id_auteur, id_message FROM spip_auteurs_messages WHERE statut='de'");
		while ($row = spip_fetch_array($result)) {
			$id_auteur = $row['id_auteur'];
			$id_message = $row['id_message'];
			spip_query("UPDATE spip_messages SET id_auteur=$id_auteur WHERE id_message=$id_message");
		}

		spip_query("ALTER TABLE spip_auteurs_messages DROP statut");
		maj_version (1.208);
	}

	if ($version_installee < 1.209) {
		spip_query("ALTER TABLE spip_syndic ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_syndic_articles ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_messages ADD maj TIMESTAMP");
		maj_version (1.209);
	}

	if ($version_installee < 1.210) {
		spip_query("ALTER TABLE spip_messages DROP page");

		stripslashes_base('spip_articles', array('surtitre', 'titre', 'soustitre', 'descriptif', 'chapo', 'texte', 'ps'));
		stripslashes_base('spip_auteurs', array('nom', 'bio', 'nom_site'));
		stripslashes_base('spip_breves', array('titre', 'texte', 'lien_titre'));
		stripslashes_base('spip_forum', array('titre', 'texte', 'auteur', 'nom_site'));
		stripslashes_base('spip_messages', array('titre', 'texte'));
		stripslashes_base('spip_mots', array('type', 'titre', 'descriptif', 'texte'));
		stripslashes_base('spip_petitions', array('texte'));
		stripslashes_base('spip_rubriques', array('titre', 'descriptif', 'texte'));
		stripslashes_base('spip_signatures', array('nom_email', 'nom_site', 'message'));
		stripslashes_base('spip_syndic', array('nom_site', 'descriptif'));
		stripslashes_base('spip_syndic_articles', array('titre', 'lesauteurs'));
		maj_version (1.210);
	}

	if ($version_installee < 1.3) {
		// Modifier la syndication (pour liste de sites)
		spip_query("ALTER TABLE spip_syndic ADD syndication VARCHAR(3) NOT NULL");
		spip_query("ALTER TABLE spip_syndic ADD statut VARCHAR(10) NOT NULL");
		spip_query("ALTER TABLE spip_syndic ADD date datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		spip_query("UPDATE spip_syndic SET syndication='oui', statut='publie', date=NOW()");

		// Statut pour articles syndication, pour pouvoir desactiver un article
		spip_query("ALTER TABLE spip_syndic_articles ADD statut VARCHAR(10) NOT NULL");
		spip_query("UPDATE spip_syndic_articles SET statut='publie'");
		maj_version (1.3);
	}

	if ($version_installee < 1.301) {
		spip_query("ALTER TABLE spip_forum ADD id_syndic bigint(21) DEFAULT '0' NOT NULL");
		maj_version (1.301);
	}

	if ($version_installee < 1.302) {
		# spip_query("ALTER TABLE spip_forum_cache DROP PRIMARY KEY");
		# spip_query("ALTER TABLE spip_forum_cache DROP INDEX fichier");
		# spip_query("ALTER TABLE spip_forum_cache ADD PRIMARY KEY (fichier, id_forum, id_article, id_rubrique, id_breve, id_syndic)");
		spip_query("ALTER TABLE spip_forum ADD INDEX id_syndic (id_syndic)");
		maj_version (1.302);
	}

	if ($version_installee < 1.303) {
		spip_query("ALTER TABLE spip_rubriques ADD date datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		spip_query("ALTER TABLE spip_syndic ADD date_syndic datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		spip_query("UPDATE spip_syndic SET date_syndic=date");
		maj_version (1.303);
	}

	if ($version_installee < 1.306) {
		spip_query("DROP TABLE spip_index_syndic_articles");
		spip_query("ALTER TABLE spip_syndic ADD date_index datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		spip_query("ALTER TABLE spip_syndic ADD INDEX date_index (date_index)");
		maj_version (1.306);
	}

	if ($version_installee < 1.307) {
		spip_query("ALTER TABLE spip_syndic_articles ADD descriptif blob NOT NULL");
		maj_version (1.307);
	}

	if ($version_installee < 1.404) {
		spip_query("UPDATE spip_mots SET type='Mots sans groupe...' WHERE type=''");

		$result = spip_query("SELECT * FROM spip_mots GROUP BY type");
		while($row = spip_fetch_array($result)) {
				$type = addslashes($row['type']);
				spip_query("INSERT INTO spip_groupes_mots 
					(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)
					VALUES (\"$type\", 'non', 'non', 'oui', 'oui', 'non', 'oui', 'oui', 'oui', 'non')");
		}
		spip_query("DELETE FROM spip_mots WHERE titre='kawax'");
		maj_version (1.404);
	}

	if ($version_installee < 1.405) {
		spip_query("ALTER TABLE spip_mots ADD id_groupe bigint(21) NOT NULL");
	
		$result = spip_query("SELECT * FROM spip_groupes_mots");
		while($row = spip_fetch_array($result)) {
				$id_groupe = addslashes($row['id_groupe']);
				$type = addslashes($row['titre']);
				spip_query("UPDATE spip_mots SET id_groupe = '$id_groupe' WHERE type='$type'");
		}
		maj_version (1.405);
	}

	if ($version_installee < 1.408) {
		// Images articles passent dans spip_documents
		$query = "SELECT id_article, images FROM spip_articles WHERE LENGTH(images) > 0";
		$result = spip_query($query);

		$types = array('jpg' => 1, 'png' => 2, 'gif' => 3);

		while ($row = @spip_fetch_array($result)) {
			$id_article = $row['id_article'];
			$images = $row['images'];
			$images = explode(",", $images);
			reset($images);
			$replace = '_orig_';
			while (list (, $val) = each($images)) {
				$image = explode("|", $val);
				$fichier = $image[0];
				$largeur = $image[1];
				$hauteur = $image[2];
				ereg("-([0-9]+)\.(gif|jpg|png)$", $fichier, $match);
				$id_type = intval($types[$match[2]]);
				$num_img = $match[1];
				$fichier = _DIR_IMG . $fichier;
				$taille = @filesize($fichier);
				$fichier = substr('../', '', $fichier);
				$id_document = spip_abstract_insert("documents", 
							   "(titre, id_type, fichier, mode, largeur, hauteur, taille)",
							   "('image $largeur x $hauteur', $id_type, '$fichier', 'vignette', '$largeur', '$hauteur', '$taille')");

				if ($id_document > 0) {
					spip_query("INSERT INTO spip_documents_articles (id_document, id_article) VALUES ($id_document, $id_article)");
					$replace = "REPLACE($replace, '<IMG$num_img|', '<IM_$id_document|')";
				} else {
					echo _T('texte_erreur_mise_niveau_base', array('fichier' => $fichier, 'id_article' => $id_article));
					exit;
				}
			}
			$replace = "REPLACE($replace, '<IM_', '<IMG')";
			$replace_chapo = ereg_replace('_orig_', 'chapo', $replace);
			$replace_descriptif = ereg_replace('_orig_', 'descriptif', $replace);
			$replace_texte = ereg_replace('_orig_', 'texte', $replace);
			$replace_ps = ereg_replace('_orig_', 'ps', $replace);
			$query = "UPDATE spip_articles ".
				"SET chapo=$replace_chapo, descriptif=$replace_descriptif, texte=$replace_texte, ps=$replace_ps ".
				"WHERE id_article=$id_article";
			spip_query($query);
		}
		spip_query("ALTER TABLE spip_articles DROP images");
		maj_version (1.408);
	}

	if ($version_installee < 1.414) {
		// Forum par defaut "en dur" dans les spip_articles
		// -> non, prio (priori), pos (posteriori), abo (abonnement)
		include_ecrire ("inc_meta.php3");
		$accepter_forum = substr(lire_meta("forums_publics"),0,3) ;
		$query = "ALTER TABLE spip_articles CHANGE accepter_forum accepter_forum CHAR(3) NOT NULL";
		$result = spip_query($query);
		$query = "UPDATE spip_articles SET accepter_forum='$accepter_forum' WHERE accepter_forum != 'non'";
		$result = spip_query($query);
		maj_version (1.414);
	}

	/*
	if ($version_installee == 1.415) {
		spip_query("ALTER TABLE spip_documents DROP inclus");
		maj_version (1.415);
	}
	*/

	if ($version_installee < 1.417) {
		spip_query("ALTER TABLE spip_syndic_articles DROP date_index");
		maj_version (1.417);
	}

	if ($version_installee < 1.418) {
		$query = "SELECT * FROM spip_auteurs WHERE statut = '0minirezo' AND email != '' ORDER BY id_auteur LIMIT 0,1";
		$result = spip_query($query);
		if ($webmaster = spip_fetch_array($result)) {
			include_ecrire("inc_meta.php3");
			ecrire_meta('email_webmaster', $webmaster['email']);
			ecrire_metas();
		}
		maj_version (1.418);
	}

	if ($version_installee < 1.419) {
		$query = "ALTER TABLE spip_auteurs ADD alea_actuel TINYTEXT DEFAULT ''";
		spip_query($query);
		$query = "ALTER TABLE spip_auteurs ADD alea_futur TINYTEXT DEFAULT ''";
		spip_query($query);
		$query = "UPDATE spip_auteurs SET alea_futur = FLOOR(32000*RAND())";
		spip_query($query);
		maj_version (1.419);
	}

	if ($version_installee < 1.420) {
		$query = "UPDATE spip_auteurs SET alea_actuel='' WHERE statut='nouveau'";
		spip_query($query);
		maj_version (1.420);
	}
	
	if ($version_installee < 1.421) {
		$query = "ALTER TABLE spip_articles ADD auteur_modif bigint(21) DEFAULT '0' NOT NULL";
		spip_query($query);
		$query = "ALTER TABLE spip_articles ADD date_modif datetime DEFAULT '0000-00-00 00:00:00' NOT NULL";
		spip_query($query);
		maj_version (1.421);
	}

	if ($version_installee < 1.432) {
		spip_query("ALTER TABLE spip_articles DROP referers");
		$query = "ALTER TABLE spip_articles ADD referers INTEGER DEFAULT '0' NOT NULL";
		spip_query($query);
		$query = "ALTER TABLE spip_articles ADD popularite INTEGER DEFAULT '0' NOT NULL";
		spip_query($query);
		maj_version (1.432);
	}

	if ($version_installee < 1.436) {
		$query = "ALTER TABLE spip_documents ADD date datetime DEFAULT '0000-00-00 00:00:00' NOT NULL";
		spip_query($query);
		maj_version (1.436);
	}

	if ($version_installee < 1.437) {
		spip_query("ALTER TABLE spip_visites ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_visites_referers ADD maj TIMESTAMP");
		maj_version (1.437);
	}

	if ($version_installee < 1.438) {
		spip_query("ALTER TABLE spip_articles ADD INDEX id_secteur (id_secteur)");
		spip_query("ALTER TABLE spip_articles ADD INDEX statut (statut, date)");
		maj_version (1.438);
	}

	if ($version_installee < 1.439) {
		spip_query("ALTER TABLE spip_syndic ADD INDEX statut (statut, date_syndic)");
		spip_query("ALTER TABLE spip_syndic_articles ADD INDEX statut (statut)");
		spip_query("ALTER TABLE spip_syndic_articles CHANGE url url VARCHAR(255) NOT NULL");
		spip_query("ALTER TABLE spip_syndic_articles ADD INDEX url (url)");
		maj_version (1.439);
	}

	if ($version_installee < 1.440) {
		spip_query("ALTER TABLE spip_visites_temp CHANGE ip ip INTEGER UNSIGNED NOT NULL");
		maj_version (1.440);
	}

	if ($version_installee < 1.441) {
		spip_query("ALTER TABLE spip_visites_temp CHANGE date date DATE NOT NULL");
		spip_query("ALTER TABLE spip_visites CHANGE date date DATE NOT NULL");
		spip_query("ALTER TABLE spip_visites_referers CHANGE date date DATE NOT NULL");
		maj_version (1.441);
	}

	if ($version_installee < 1.442) {
		$query = "ALTER TABLE spip_auteurs ADD prefs TINYTEXT NOT NULL";
		spip_query($query);
		maj_version (1.442);
	}

	if ($version_installee < 1.443) {
		spip_query("ALTER TABLE spip_auteurs CHANGE login login VARCHAR(255) BINARY NOT NULL");
		spip_query("ALTER TABLE spip_auteurs CHANGE statut statut VARCHAR(255) NOT NULL");
		spip_query("ALTER TABLE spip_auteurs ADD INDEX login (login)");
		spip_query("ALTER TABLE spip_auteurs ADD INDEX statut (statut)");
		maj_version (1.443);
	}

	if ($version_installee < 1.444) {
		spip_query("ALTER TABLE spip_syndic ADD moderation VARCHAR(3) NOT NULL");
		maj_version (1.444);
	}

	if ($version_installee < 1.457) {
		spip_query("DROP TABLE spip_visites");
		spip_query("DROP TABLE spip_visites_temp");
		spip_query("DROP TABLE spip_visites_referers");
		creer_base(); // crade, a ameliorer :-((
		maj_version (1.457);
	}

	if ($version_installee < 1.458) {
		spip_query("ALTER TABLE spip_auteurs ADD cookie_oubli TINYTEXT NOT NULL");
		maj_version (1.458);
	}

	if ($version_installee < 1.459) {
		$result = spip_query("SELECT type FROM spip_mots GROUP BY type");
		while ($row = spip_fetch_array($result)) {
			$type = addslashes($row['type']);
			$res = spip_query("SELECT * FROM spip_groupes_mots
				WHERE titre='$type'");
			if (spip_num_rows($res) == 0) {
			  if ($id_groupe = spip_abstract_insert("groupes_mots", 
						       "(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)",
						       "('$type', 'non', 'non', 'oui', 'oui', 'non', 'oui', 'oui', 'oui', 'non')"))

					spip_query("UPDATE spip_mots SET id_groupe = '$id_groupe' WHERE type='$type'");
			}
		}
		spip_query("UPDATE spip_articles SET popularite=0");
		maj_version (1.459);
	}

	if ($version_installee < 1.460) {
		// remettre les mots dans les groupes dupliques par erreur
		// dans la precedente version du paragraphe de maj 1.459
		// et supprimer ceux-ci
		$result = spip_query("SELECT * FROM spip_groupes_mots ORDER BY id_groupe");
		while ($row = spip_fetch_array($result)) {
			$titre = addslashes($row['titre']);
			if (! $vu[$titre] ) {
				$vu[$titre] = true;
				$id_groupe = $row['id_groupe'];
				spip_query ("UPDATE spip_mots SET id_groupe=$id_groupe WHERE type='$titre'");
				spip_query ("DELETE FROM spip_groupes_mots WHERE titre='$titre' AND id_groupe<>$id_groupe");
			}
		}
		maj_version (1.460);
	}

	if ($version_installee < 1.462) {
		spip_query("UPDATE spip_types_documents SET inclus='embed' WHERE inclus!='non' AND extension IN ".
			"('aiff', 'asf', 'avi', 'mid', 'mov', 'mp3', 'mpg', 'ogg', 'qt', 'ra', 'ram', 'rm', 'swf', 'wav', 'wmv')");
		maj_version (1.462);
	}

	if ($version_installee < 1.463) {
		spip_query("ALTER TABLE spip_articles CHANGE popularite popularite DOUBLE");
		spip_query("ALTER TABLE spip_visites_temp ADD maj TIMESTAMP");
		spip_query("ALTER TABLE spip_referers_temp ADD maj TIMESTAMP");
		maj_version (1.463);
	}

	// l'upgrade < 1.462 ci-dessus etait fausse, d'ou correctif
	if (($version_installee < 1.464) AND ($version_installee >= 1.462)) {
		$res = spip_query("SELECT id_type, extension FROM spip_types_documents WHERE id_type NOT IN (1,2,3)");
		while ($row = spip_fetch_array($res)) {
			$extension = $row['extension'];
			$id_type = $row['id_type'];
			spip_query("UPDATE spip_documents SET id_type=$id_type
				WHERE fichier like '%.$extension'");
		}
		maj_version (1.464);
	}

	if ($version_installee < 1.465) {
		spip_query("ALTER TABLE spip_articles CHANGE popularite popularite DOUBLE NOT NULL");
		maj_version (1.465);
	}

	if ($version_installee < 1.466) {
		spip_query("ALTER TABLE spip_auteurs ADD source VARCHAR(10) DEFAULT 'spip' NOT NULL");
		maj_version (1.466);
	}

	if ($version_installee < 1.468) {
		spip_query("ALTER TABLE spip_auteurs ADD INDEX en_ligne (en_ligne)");
		spip_query("ALTER TABLE spip_forum ADD INDEX statut (statut, date_heure)");
		maj_version (1.468);
	}

	if ($version_installee < 1.470) {
		if ($version_installee >= 1.467) {	// annule les "listes de diff"
			spip_query("DROP TABLE spip_listes");
			spip_query("ALTER TABLE spip_auteurs DROP abonne");
			spip_query("ALTER TABLE spip_auteurs DROP abonne_pass");
		}
		maj_version (1.470);
	}

	if ($version_installee < 1.471) {
		if ($version_installee >= 1.470) {	// annule les "maj"
			spip_query("ALTER TABLE spip_auteurs_articles DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_auteurs_rubriques DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_auteurs_messages DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_documents_articles DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_documents_rubriques DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_documents_breves DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_mots_articles DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_mots_breves DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_mots_rubriques DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_mots_syndic DROP maj TIMESTAMP");
			spip_query("ALTER TABLE spip_mots_forum DROP maj TIMESTAMP");
		}
		maj_version (1.471);
	}

	if ($version_installee < 1.472) {
		spip_query("ALTER TABLE spip_referers ADD visites_jour INTEGER UNSIGNED NOT NULL");
		maj_version (1.472);
	}

	if ($version_installee < 1.473) {
		spip_query("UPDATE spip_syndic_articles SET url = REPLACE(url, '&amp;', '&')");
		spip_query("UPDATE spip_syndic SET url_site = REPLACE(url_site, '&amp;', '&')");
		maj_version (1.473);
	}

	if ($version_installee < 1.600) {
		include_ecrire('inc_index.php3');
		purger_index();
		creer_liste_indexation();
		maj_version (1.600);
	}

	if ($version_installee < 1.601) {
		spip_query("ALTER TABLE spip_forum ADD INDEX id_syndic (id_syndic)");
		maj_version (1.601);
	}

	if ($version_installee < 1.603) {
		// supprimer les fichiers deplaces
		@unlink('inc_meta_cache.php3');
		@unlink('data/engines-list.ini');
		maj_version (1.603);
	}

	if ($version_installee < 1.604) {
		spip_query("ALTER TABLE spip_auteurs ADD lang VARCHAR(10) DEFAULT '' NOT NULL");
		$u = spip_query("SELECT * FROM spip_auteurs WHERE prefs LIKE '%spip_lang%'");
		while ($row = spip_fetch_array($u)) {
			$prefs = unserialize($row['prefs']);
			$l = $prefs['spip_lang'];
			unset ($prefs['spip_lang']);
			spip_query ("UPDATE spip_auteurs SET lang='".addslashes($l)."',
				prefs='".addslashes(serialize($prefs))."'
				WHERE id_auteur=".$row['id_auteur']);
		}
		maj_version (1.604, spip_query("SELECT lang FROM spip_auteurs"));
	}

	if ($version_installee < 1.702) {
		spip_query("ALTER TABLE spip_articles ADD extra longblob NULL");
		spip_query("ALTER TABLE spip_auteurs ADD extra longblob NULL");
		spip_query("ALTER TABLE spip_breves ADD extra longblob NULL");
		spip_query("ALTER TABLE spip_rubriques ADD extra longblob NULL");
		spip_query("ALTER TABLE spip_mots ADD extra longblob NULL");

		// recuperer les eventuels 'supplement' installes en 1.701
		if ($version_installee == 1.701) {
			spip_query ("UPDATE spip_articles SET extra = supplement");
			spip_query ("ALTER TABLE spip_articles DROP supplement");
			spip_query ("UPDATE spip_auteurs SET extra = supplement");
			spip_query ("ALTER TABLE spip_auteurs DROP supplement");
			spip_query ("UPDATE spip_breves SET extra = supplement");
			spip_query ("ALTER TABLE spip_breves DROP supplement");
			spip_query ("UPDATE spip_rubriques SET extra = supplement");
			spip_query ("ALTER TABLE spip_rubriques DROP supplement");
			spip_query ("UPDATE spip_mots SET extra = supplement");
			spip_query ("ALTER TABLE spip_mots DROP supplement");
		}
		maj_version (1.702,
			spip_query("SELECT extra FROM spip_articles")
			&& spip_query("SELECT extra FROM spip_auteurs")
			&& spip_query("SELECT extra FROM spip_breves")
			&& spip_query("SELECT extra FROM spip_rubriques")
			&& spip_query("SELECT extra FROM spip_mots")
			);
	}

	if ($version_installee < 1.703) {
		spip_query("ALTER TABLE spip_articles ADD lang VARCHAR(10) DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_rubriques ADD lang VARCHAR(10) DEFAULT '' NOT NULL");
		maj_version (1.703);
	}

	if ($version_installee < 1.704) {
		spip_query("ALTER TABLE spip_articles ADD INDEX lang (lang)");
		spip_query("ALTER TABLE spip_auteurs ADD INDEX lang (lang)");
		spip_query("ALTER TABLE spip_rubriques ADD INDEX lang (lang)");
		maj_version (1.704);
	}

	if ($version_installee < 1.705) {
		spip_query("ALTER TABLE spip_articles ADD langue_choisie VARCHAR(3) DEFAULT 'non'");
		spip_query("ALTER TABLE spip_rubriques ADD langue_choisie VARCHAR(3) DEFAULT 'non'");
		maj_version (1.705);
	}

	if ($version_installee < 1.707) {
		spip_query("UPDATE spip_articles SET langue_choisie='oui' WHERE MID(lang,1,1) != '.' AND lang != ''");
		spip_query("UPDATE spip_articles SET lang=MID(lang,2,8) WHERE langue_choisie = 'non'");
		spip_query("UPDATE spip_rubriques SET langue_choisie='oui' WHERE MID(lang,1,1) != '.' AND lang != ''");
		spip_query("UPDATE spip_rubriques SET lang=MID(lang,2,8) WHERE langue_choisie = 'non'");
		maj_version (1.707);
	}

	if ($version_installee < 1.708) {
		spip_query("ALTER TABLE spip_breves ADD lang VARCHAR(10) DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_breves ADD langue_choisie VARCHAR(3) DEFAULT 'non'");
		maj_version (1.708);
	}

	if ($version_installee < 1.709) {
		spip_query("ALTER TABLE spip_articles ADD id_trad bigint(21) DEFAULT '0' NOT NULL");
		spip_query("ALTER TABLE spip_articles ADD INDEX id_trad (id_trad)");
		maj_version (1.709);
	}

	if ($version_installee < 1.717) {
		spip_query("ALTER TABLE spip_articles ADD INDEX date_modif (date_modif)");
		maj_version (1.717);
	}

	if ($version_installee < 1.718) {
		spip_query("ALTER TABLE spip_referers DROP domaine");
		spip_query("ALTER TABLE spip_referers_articles DROP domaine");
		spip_query("ALTER TABLE spip_referers_temp DROP domaine");
		maj_version (1.718);
	}

	if ($version_installee < 1.722) {
		spip_query("ALTER TABLE spip_articles ADD nom_site tinytext NOT NULL");
		spip_query("ALTER TABLE spip_articles ADD url_site VARCHAR(255) NOT NULL");
		spip_query("ALTER TABLE spip_articles ADD INDEX url_site (url_site)");
		if ($version_installee >= 1.720) {
			spip_query("UPDATE spip_articles SET url_site=url_ref");
			spip_query("ALTER TABLE spip_articles DROP INDEX url_ref");
			spip_query("ALTER TABLE spip_articles DROP url_ref");
		}
		maj_version (1.722);
	}

	if ($version_installee < 1.723) {
		if ($version_installee == 1.722) {
			spip_query("ALTER TABLE spip_articles MODIFY url_site VARCHAR(255) NOT NULL");
			spip_query("ALTER TABLE spip_articles DROP INDEX url_site;");
			spip_query("ALTER TABLE spip_articles ADD INDEX url_site (url_site);");
		}
		maj_version (1.723);
	}

	if ($version_installee < 1.724) {
		spip_query("ALTER TABLE spip_messages ADD date_fin datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		maj_version (1.724);
	}

	if ($version_installee < 1.726) {
		spip_query("ALTER TABLE spip_auteurs ADD low_sec tinytext NOT NULL");
		maj_version (1.726);
	}

	if ($version_installee < 1.727) {
		// occitans : oci_xx -> oc_xx
		spip_query("UPDATE spip_auteurs SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'");
		spip_query("UPDATE spip_rubriques SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'");
		spip_query("UPDATE spip_articles SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'");
		spip_query("UPDATE spip_breves SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'");
		maj_version (1.727);
	}

	// Ici version 1.7 officielle

	if ($version_installee < 1.728) {
		spip_query("ALTER TABLE spip_articles ADD id_version int unsigned DEFAULT '0' NOT NULL");
		maj_version (1.728);
	}

	if ($version_installee < 1.730) {
		spip_query("ALTER TABLE spip_articles ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_articles INDEX idx (idx)");
		spip_query("ALTER TABLE spip_auteurs ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_auteurs INDEX idx (idx)");
		spip_query("ALTER TABLE spip_breves ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_breves INDEX idx (idx)");
		spip_query("ALTER TABLE spip_mots ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_mots INDEX idx (idx)");
		spip_query("ALTER TABLE spip_rubriques ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_rubriques INDEX idx (idx)");
		spip_query("ALTER TABLE spip_syndic ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_syndic INDEX idx (idx)");
		spip_query("ALTER TABLE spip_forum ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_forum ADD INDEX idx (idx)");
		spip_query("ALTER TABLE spip_signatures ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL");
		spip_query("ALTER TABLE spip_signatures INDEX idx (idx)");
		maj_version (1.730);
	}

	if ($version_installee < 1.731) {	// reindexer les docs allemands et vietnamiens
		spip_query("UPDATE spip_articles SET idx='1' where lang IN ('de','vi')");
		spip_query("UPDATE spip_rubriques SET idx='1' where lang IN ('de','vi')");
		spip_query("UPDATE spip_breves SET idx='1' where lang IN ('de','vi')");
		spip_query("UPDATE spip_auteurs SET idx='1' where lang IN ('de','vi')");
		maj_version (1.731);
	}

	if ($version_installee < 1.732) {	// en correction d'un vieux truc qui avait fait sauter le champ inclus sur les bases version 1.415
		spip_query ("ALTER TABLE spip_documents ADD inclus  VARCHAR(3) DEFAULT 'non'");
		maj_version (1.732);
	}

	if ($version_installee < 1.733) {
		// spip_query("ALTER TABLE spip_articles ADD id_version int unsigned DEFAULT '0' NOT NULL");
		spip_query("DROP TABLE spip_versions");
		spip_query("DROP TABLE spip_versions_fragments");
		creer_base();
		maj_version(1.733);
	}

	#if ($version_installee < 1.734) {
	#	// integrer nouvelles tables auxiliaires du compilateur ESJ
	#	creer_base();
	#	maj_version(1.734);
	#}

	if ($version_installee < 1.801) {
		spip_query("ALTER TABLE spip_rubriques
			ADD statut_tmp VARCHAR(10) NOT NULL,
			ADD date_tmp datetime DEFAULT '0000-00-00 00:00:00' NOT NULL");
		include_ecrire('inc_rubriques.php3');
		calculer_rubriques();
		maj_version(1.801);
	}

	// Nouvelles tables d'invalidation
	if ($version_installee < 1.802) {
		spip_query("DROP TABLE spip_id_article_caches");
		spip_query("DROP TABLE spip_id_auteur_caches");
		spip_query("DROP TABLE spip_id_breve_caches");
		spip_query("DROP TABLE spip_id_document_caches");
		spip_query("DROP TABLE spip_id_forum_caches");
		spip_query("DROP TABLE spip_id_groupe_caches");
		spip_query("DROP TABLE spip_id_message_caches");
		spip_query("DROP TABLE spip_id_mot_caches");
		spip_query("DROP TABLE spip_id_rubrique_caches");
		spip_query("DROP TABLE spip_id_signature_caches");
		spip_query("DROP TABLE spip_id_syndic_article_caches");
		spip_query("DROP TABLE spip_id_syndic_caches");
		spip_query("DROP TABLE spip_id_type_caches");
		spip_query("DROP TABLE spip_inclure_caches");
		maj_version(1.802);
	}
	if ($version_installee < 1.803) {

	#	27 AOUT 2004 : conservons cette table pour autoriser les retours
	#	de SPIP 1.8a6 CVS vers 1.7.2
	#	spip_query("DROP TABLE spip_forum_cache");

		spip_query("DROP TABLE spip_inclure_caches");
		maj_version(1.803);
	}
	if ($version_installee < 1.804) {
		// recreer la table spip_caches
		spip_query("DROP TABLE spip_caches");
		creer_base();
		maj_version(1.804);
	}

	if ($version_installee < 1.805) {
		spip_query("ALTER TABLE spip_forum
		ADD id_thread bigint(21) DEFAULT '0' NOT NULL");
		include_ecrire('inc_forum.php3');
		calculer_threads();
		maj_version(1.805);
	}

	// tables d'orthographe
	#if ($version_installee < 1.806)
	#	maj_version(1.806);

	// URLs propres (lab_version = 0.12)
	if ($version_installee < 1.807) {
		foreach (array('articles', 'breves', 'rubriques', 'mots') as $objets) {
			spip_query("ALTER TABLE spip_$objets
				ADD url_propre VARCHAR(255) NOT NULL");
			spip_query("ALTER TABLE spip_$objets
				ADD INDEX url_propre (url_propre)");
		}
		maj_version(1.807);
	}

	// referers de la veille
	if ($version_installee < 1.808) {
		spip_query("ALTER TABLE spip_referers
		ADD visites_veille INT UNSIGNED NOT NULL");
		maj_version(1.808);
	}


	// corrections diverses
	if ($version_installee < 1.809) {
		// plus de retour possible vers 1.7.2
		spip_query("DROP TABLE spip_forum_cache");

		// les requetes ci-dessous ne s'appliqueront que si on est passe
		// par une certaine version de developpement - oublie de le faire
		// plus tot, car le code d'alors recreait purement et simplement
		// cette table
		spip_query("ALTER TABLE spip_versions DROP chapo");
		spip_query("ALTER TABLE spip_versions DROP texte");
		spip_query("ALTER TABLE spip_versions DROP ps");
		spip_query("ALTER TABLE spip_versions DROP extra");
		spip_query("ALTER TABLE spip_versions ADD champs text NOT NULL");

		maj_version(1.809);
	}

	return true;
}

?>

--- NEW FILE: inc_import.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_IMPORT")) return;
define("_ECRIRE_INC_IMPORT", "1");


include_ecrire ("inc_acces.php3");


function xml_fetch_tag($f, &$before, $gz=false) {
	global $buf, $pos, $abs_pos;
	static $buf_len = 1000;
	$_fread = ($gz) ? gzread : fread;
	$_feof = ($gz) ? gzeof : feof;
	$_ftell = ($gz) ? gztell : ftell;
	$p = $pos;

	$q = @strpos($buf, '<', $p);
	while (!$q AND substr($buf, $p, 1) != '<') {
		if ($_feof($f)) return false;
		$before .= substr($buf, $p);
		$buf = $_fread($f, $buf_len);
		$p = 0;
		$q = strpos($buf, '<');
	}
	$before .= substr($buf, $p, $q - $p);
	$tag = '';
	$p = ++$q;
	$q = @strpos($buf, '>', $p);
	while (!$q AND substr($buf, $p, 1) != '>') {
		if ($_feof($f)) return false;
		$tag .= substr($buf, $p);
		$buf = $_fread($f, $buf_len);
		$p = 0;
		$q = strpos($buf, '>');
	}
	$pos = $q + 1;
	$tag .= substr($buf, $p, $q - $p);
	$before = str_replace('&amp;', '&', str_replace('&lt;', '<', $before));
	$abs_pos = $_ftell($f) - strlen($buf);
	return $tag;
}


function xml_parse_tag($texte) {
	list($tag, $atts) = split('[[:space:]]+', $texte, 2);
	$result[0] = $tag;
	$result[1] = '';
	if (!$atts) return $result;
	while (ereg('^([^[:space:]]+)[[:space:]]*=[[:space:]]*"([^"]*)"([[:space:]]+(.*))?', $atts, $regs)) {
		$result[1][$regs[1]] = $regs[2];
		$atts = $regs[4];
	}
	return $result;
}


function import_debut($f, $gz=false) {
	$b = "";
	while ($t = xml_fetch_tag($f, $b, $gz)) {
		$r = xml_parse_tag($t);
		if ($r[0] == '?xml' AND $r[1]['encoding'])
			ecrire_meta('charset_restauration', strtolower($r[1]['encoding']));
		if ($r[0] == "SPIP") return $r;
		$b = "";
	}
	return false;
}


//
// $f = handle fichier
// $gz = flag utilisation zlib
//
// importe un objet depuis le fichier, retourne true si ok, false si erreur ou fin de fichier
//

function import_objet_1_2($f, $gz=false) {
	global $import_ok, $pos, $abs_pos;
	static $time_javascript;

	if (time() - $time_javascript > 3) {	// 3 secondes
		affiche_progression_javascript($abs_pos);
		$time_javascript = time();
	}

	static $tables;
	if (!$tables) $tables = array(
		'article' => 'spip_articles',
		'auteur' => 'spip_auteurs',
		'breve' => 'spip_breves',
		'document' => 'spip_documents',
		'forum' => 'spip_forum',
		'groupe_mots' => 'spip_groupes_mots',
		'message' => 'spip_messages',
		'mot' => 'spip_mots',
		'petition' => 'spip_petitions',
		'rubrique' => 'spip_rubriques',
		'signature' => 'spip_signatures',
		'syndic' => 'spip_syndic',
		'syndic_article' => 'spip_syndic_articles',
		'type_document' => 'spip_types_documents'
	);

	$import_ok = false;
	$b = '';
	// Lire le type d'objet
	if (!($type = xml_fetch_tag($f, $b, $gz))) return false;
	if ($type == '/SPIP') return !($import_ok = true);
	$id = "id_$type";
	$id_objet = 0;

	// Lire les champs de l'objet
	for (;;) {
		$b = '';
		if (!($col = xml_fetch_tag($f, $b, $gz))) return false;
		if ($col == '/'.$type) break;
		$value = '';
		if (!xml_fetch_tag($f, $value, $gz)) return false;
		if (substr($col, 0, 5) == 'lien:') {
			$type_lien = substr($col, 5);
			$liens[$type_lien][] = '('.$id_objet.','.$value.')';
		}
		else if ($col != 'maj') {
			// tentative de restauration d'une base sauvegardee avec le champ 'images' ; d'experience, ca arrive...
			// mieux vaut accepter que canner silencieusement...
			if (($type == 'article') && ($col == 'images'))
			{
				if ($value) {		// ne pas afficher de message si on a un champ suppl mais vide
					echo "--><br><font color='red'><b>"._T('avis_erreur_sauvegarde', array('type' => $type, 'id_objet' => $id_objet))."</b></font>\n<font color='black'>"._T('avis_colonne_inexistante', array('col' => $col));
					if ($col == 'images') echo _T('info_verifier_image');
					echo "</font>\n<!--";
					$GLOBALS['erreur_restauration'] = true;
				}
			}
			else {
				$cols[] = $col;
				$values[] = '"'.addslashes($value).'"';
				if ($col == $id) $id_objet = $value;
			}
		}
	}

	$table = $tables[$type];
	$query = "REPLACE $table (" . join(',', $cols) . ') VALUES (' . join(',', $values) . ')';
	if (!spip_query($query)) {
		echo "--><br><font color='red'><b>"._T('avis_erreur_mysql')."</b></font>\n<font color='black'><tt>".spip_sql_error()."</tt></font>\n<!--";
		$GLOBALS['erreur_restauration'] = true;
	}

	if ($type == 'article') {
		spip_query("DELETE FROM spip_auteurs_articles WHERE id_article=$id_objet");
		spip_query("DELETE FROM spip_documents_articles WHERE id_article=$id_objet");
	}
	else if ($type == 'rubrique') {
		spip_query("DELETE FROM spip_auteurs_rubriques WHERE id_rubrique=$id_objet");
		spip_query("DELETE FROM spip_documents_rubriques WHERE id_rubrique=$id_objet");
	}
	else if ($type == 'breve') {
		spip_query("DELETE FROM spip_documents_breves WHERE id_breve=$id_objet");
	}
	else if ($type == 'mot') {
		spip_query("DELETE FROM spip_mots_articles WHERE id_mot=$id_objet");
		spip_query("DELETE FROM spip_mots_breves WHERE id_mot=$id_objet");
		spip_query("DELETE FROM spip_mots_forum WHERE id_mot=$id_objet");
		spip_query("DELETE FROM spip_mots_rubriques WHERE id_mot=$id_objet");
		spip_query("DELETE FROM spip_mots_syndic WHERE id_mot=$id_objet");
	}
	else if ($type == 'auteur') {
		spip_query("DELETE FROM spip_auteurs_rubriques WHERE id_auteur=$id_objet");
	}
	else if ($type == 'message') {
		spip_query("DELETE FROM spip_auteurs_messages WHERE id_message=$id_objet");
	}
	if ($liens) {
		reset($liens);
		while (list($type_lien, $t) = each($liens)) {
			if ($type == 'auteur' OR $type == 'mot' OR $type == 'document')
				if ($type_lien == 'syndic' OR $type_lien == 'forum') $table_lien = 'spip_'.$type.'s_'.$type_lien;
				else $table_lien = 'spip_'.$type.'s_'.$type_lien.'s';
			else
				$table_lien = 'spip_'.$type_lien.'s_'.$type.'s';
			$query = "INSERT INTO $table_lien ($id, id_$type_lien) VALUES ".join(',', $t);
			spip_query($query);
		}
	}

	$p = $pos + $abs_pos;
	ecrire_meta("status_restauration", "$p");

	return $import_ok = true;
}


function import_objet_0_0($f, $gz=false) {
	global $import_ok, $pos, $abs_pos;

	$import_ok = false;
	$b = '';
	if (!($type = xml_fetch_tag($f, $b, $gz))) return false;
	if ($type == '/SPIP') return !($import_ok = true);
	$is_art = ($type == 'article');
	$is_mot = ($type == 'mot');
	for (;;) {
		$b = '';
		if (!($col = xml_fetch_tag($f, $b, $gz))) return false;
		if ($col == ("/$type")) break;
		$value = '';
		if (!xml_fetch_tag($f, $value, $gz)) return false;
		if ($is_art AND $col == 'id_auteur') {
			$auteurs[] = $value;
		}
		else if ($is_mot AND $col == 'id_article') {
			$articles[] = $value;
		}
		else if ($is_mot AND $col == 'id_breve') {
			$breves[] = $value;
		}
		else if ($is_mot AND $col == 'id_forum') {
			$forums[] = $value;
		}
		else if ($is_mot AND $col == 'id_rubrique') {
			$rubriques[] = $value;
		}
		else if ($is_mot AND $col == 'id_syndic') {
			$syndics[] = $value;
		}
		else if ($col != 'maj') {
			$cols[] = $col;
			$values[] = '"'.addslashes($value).'"';
			if ($is_art && ($col == 'id_article')) $id_article = $value;
			if ($is_mot && ($col == 'id_mot')) $id_mot = $value;
		}
	}

	$table = "spip_$type";
	if ($type != 'forum' AND $type != 'syndic') $table .= 's';
	$query = "REPLACE $table (" . join(",", $cols) . ") VALUES (" . join(",", $values) . ")";
	spip_query($query);

	if ($is_art && $id_article) {
		$query = "DELETE FROM spip_auteurs_articles WHERE id_article=$id_article";
		spip_query($query);
		if ($auteurs) {
			reset ($auteurs);
			while (list(, $auteur) = each($auteurs)) {
				$query = "INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES ($auteur, $id_article)";
				spip_query($query);
			}
		}
	}
	if ($is_mot && $id_mot) {
		$query = "DELETE FROM spip_mots_articles WHERE id_mot=$id_mot";
		spip_query($query);
		$query = "DELETE FROM spip_mots_breves WHERE id_mot=$id_mot";
		spip_query($query);
		$query = "DELETE FROM spip_mots_forum WHERE id_mot=$id_mot";
		spip_query($query);
		$query = "DELETE FROM spip_mots_rubriques WHERE id_mot=$id_mot";
		spip_query($query);
		$query = "DELETE FROM spip_mots_syndic WHERE id_mot=$id_mot";
		spip_query($query);
		if ($articles) {
			reset ($articles);
			while (list(, $article) = each($articles)) {
				$query = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES ($id_mot, $article)";
				spip_query($query);
			}
		}
		if ($breves) {
			reset ($breves);
			while (list(, $breve) = each($breves)) {
				$query = "INSERT INTO spip_mots_breves (id_mot, id_breve) VALUES ($id_mot, $breve)";
				spip_query($query);
			}
		}
		if ($forums) {
			reset ($forums);
			while (list(, $forum) = each($forums)) {
				$query = "INSERT INTO spip_mots_forum (id_mot, id_forum) VALUES ($id_mot, $forum)";
				spip_query($query);
			}
		}
		if ($rubriques) {
			reset ($rubriques);
			while (list(, $rubrique) = each($rubriques)) {
				$query = "INSERT INTO spip_mots_rubriques (id_mot, id_rubrique) VALUES ($id_mot, $id_rubrique)";
				spip_query($query);
			}
		}
		if ($syndics) {
			reset ($syndics);
			while (list(, $syndic) = each($syndics)) {
				$query = "INSERT INTO spip_mots_syndic (id_mot, id_syndic) VALUES ($id_mot, $syndic)";
				spip_query($query);
			}
		}
	}

	$p = $pos + $abs_pos;
	ecrire_meta("status_restauration", "$p");
//	ecrire_metas();

	return $import_ok = true;
}

function import_objet($f, $gz = false) {
	return import_objet_1_2($f, $gz);
}

function import_fin() {
	// Effacer l'ancien acces admin
	$query = "DELETE FROM spip_auteurs WHERE id_auteur=0";
	spip_query($query);

	if ($charset = lire_meta('charset_restauration'))
		ecrire_meta('charset', $charset);
	effacer_meta("charset_restauration");
	effacer_meta("status_restauration");
	effacer_meta("debut_restauration");
	effacer_meta("date_optimisation");
	ecrire_meta('calculer_rubriques', 'oui');
	ecrire_metas();
}

function import_abandon() {
	// Probleme pour restaurer l'ancien acces admin : il conserve un id_auteur = 0

	effacer_meta("charset_restauration");
	effacer_meta("status_restauration");
	effacer_meta("debut_restauration");
	effacer_meta("date_optimisation");
	ecrire_metas();
}


function import_all($f, $gz=false) {
	global $import_ok;
	global $meta;
	global $auth_htaccess;
	global $connect_id_auteur;
	$_fseek = ($gz) ? gzseek : fseek;

	$my_date = lire_meta_maj("debut_restauration");
	if (!$my_date) return false;

	$my_pos = lire_meta("status_restauration");

	if (!$my_pos) {
		// Debut de l'importation
		ecrire_meta('charset_restauration', 'iso-8859-1');
		if (!($r = import_debut($f, $gz))) {
			ecrire_meta("erreur", _T('avis_archive_incorrect'));
			return false;
		}
		else {
			// Bidouille pour garder l'acces admin actuel pendant toute la restauration
			$query = "UPDATE spip_auteurs SET id_auteur=0 WHERE id_auteur=$connect_id_auteur";
			spip_query($query);

			$version_archive = $r[1]['version_archive'];
			ecrire_meta('version_archive_restauration', $version_archive);
		}
	}
	else {
		// Reprise de l'importation
		$_fseek($f, $my_pos);
		$version_archive = lire_meta('version_archive_restauration');
	}

	// Restauration des entrees du fichier

	switch ($version_archive) {
	case '1.2':
		while (import_objet_1_2($f, $gz));
		break;
	default:
		while (import_objet_0_0($f, $gz));
		break;
	}
	if (!$import_ok) {
		ecrire_meta("erreur", _T('avis_archive_invalide'));
		return false;
	}

	// Mise a jour du fichier htpasswd

	ecrire_acces();

	// Destruction des entrees non restaurees

	$query = "DELETE FROM spip_rubriques WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_breves WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_auteurs WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_articles WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_documents WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_types_documents WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_forum WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_mots WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_groupes_mots WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_petitions WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_signatures WHERE maj < $my_date";
	spip_query($query);
	$query = "DELETE FROM spip_visites WHERE maj < $my_date";
	spip_query($query);

	import_fin();

	affiche_progression_javascript('100 %');

	return true;
}


function affiche_progression_javascript($abs_pos) {
	global $affiche_progression_pourcent;
	include_ecrire('inc_charsets.php3');
	flush();
	echo " -->\n<script type='text/javascript'><!--\n";

	if ($abs_pos == '100 %') {
		$taille = $abs_pos;
		if ($GLOBALS['erreur_restauration'])
			echo "document.progression.recharge.value='".str_replace("'", "\\'", unicode_to_javascript(_T('avis_erreur')))."';\n";
		else
			echo "document.progression.recharge.value='".str_replace("'", "\\'", unicode_to_javascript(_T('info_fini')))."';\n";
	}
	else if (! $affiche_progression_pourcent)
		$taille = ereg_replace("&nbsp;", " ", taille_en_octets($abs_pos));
	else
		$taille = floor(100 * $abs_pos / $affiche_progression_pourcent)." %";

	echo "document.progression.taille.value='$taille';\n";
	echo "//--></script>\n<!--\n";
	flush();
}

?>

--- NEW FILE: articles_forum.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_index.php3");
include_ecrire ("inc_logos.php3");



$query = "SELECT titre, id_rubrique FROM spip_articles WHERE id_article='$id_article'";
$result = spip_query($query);

while($row = spip_fetch_array($result)) {
	$titre = $row["titre"];
	$id_rubrique = $row["id_rubrique"];
}


debut_page($titre, "documents", "articles");



debut_grand_cadre();

afficher_hierarchie($id_rubrique);

fin_grand_cadre();



debut_gauche();


debut_boite_info();

echo "<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2>";
echo "<P align=left>"._T('info_gauche_suivi_forum');

echo aide ("suiviforum");
echo "</FONT>";

fin_boite_info();


debut_droite();


echo "\n<table cellpadding=0 cellspacing=0 border=0 width='100%'>";
echo "<tr width='100%'>";
echo "<td>";
	icone(_T('icone_retour'), "articles.php3?id_article=$id_article", "article-24.gif", "rien.gif");

echo "</td>";
echo "<td>" . http_img_pack('rien.gif', "", "width='10'") ."</td>\n";
echo "<td width='100%'>";
echo _T('texte_messages_publics');
gros_titre($titre);
echo "</td></tr></table>";
echo "<p>";

// Ne pas donner les cles du forum a des non-admins
if (! ($connect_statut=='0minirezo' AND acces_rubrique($id_rubrique)))
	return;

echo "<div class='serif2'>";

// reglages
if (!$debut) $debut = 0;
$pack = 5;		// nb de forums affiches par page
$enplus = 200;	// intervalle affiche autour du debut
$limitdeb = ($debut > $enplus) ? $debut-$enplus : 0;
$limitnb = $debut + $enplus - $limitdeb;

$query_forum = "SELECT id_forum FROM spip_forum WHERE id_article='$id_article' AND id_parent=0 AND statut IN ('publie', 'off', 'prop') LIMIT $limitdeb, $limitnb";
$result_forum = spip_query($query_forum);


$i = $limitdeb;
if ($i>0)
	echo "<A HREF='articles_forum.php3?id_article=$id_article&page=$page'>0</A> ... | ";
while ($row = spip_fetch_array($result_forum)) {

	// barre de navigation
	if ($i == $pack*floor($i/$pack)) {
		if ($i == $debut)
			echo "<FONT SIZE=3><B>$i</B></FONT>";
		else
			echo "<A HREF='articles_forum.php3?id_article=$id_article&debut=$i&page=$page'>$i</A>";
		echo " | ";
	}

	// elements a controler

	$i ++;
}
echo "<A HREF='articles_forum.php3?id_article=$id_article&debut=$i&page=$page'>...</A>";

echo "</div>";


$mots_cles_forums = lire_meta("mots_cles_forums");

if ($connect_statut == "0minirezo") {
	$query_forum = "SELECT * FROM spip_forum WHERE id_article='$id_article' AND id_parent=0 AND statut IN ('publie', 'off', 'prop') ORDER BY date_heure DESC LIMIT $debut, $pack";
	$result_forum = spip_query($query_forum);
	afficher_forum($result_forum, $forum_retour, $id_article);
}

echo "</FONT>";

fin_page();

?>

--- NEW FILE: install.php3 ---
<?php
if (defined("_ECRIRE_INSTALL")) return;
define("_ECRIRE_INSTALL", "1");

include ("inc_version.php3");
include_ecrire ("inc_presentation.php3");


// Une fonction pour faciliter la recherche du login (superflu ?)
function login_hebergeur() {
	global $HTTP_X_HOST, $REQUEST_URI, $SERVER_NAME, $HTTP_HOST;

	// Lycos (ex-Multimachin)
	if ($HTTP_X_HOST == 'membres.lycos.fr') {
		ereg('^/([^/]*)', $REQUEST_URI, $regs);
		$login_hebergeur = $regs[1];
	}
	// Altern
	else if (ereg('altern\.com$', $SERVER_NAME)) {
		ereg('([^.]*\.[^.]*)$', $HTTP_HOST, $regs);
		$login_hebergeur = ereg_replace('[^a-zA-Z0-9]', '_', $regs[1]);
	}
	// Free
	else if (ereg('^/([^/]*)\.free.fr/', $REQUEST_URI, $regs)) {
		$login_hebergeur = $regs[1];
	}

	return $login_hebergeur;
}



if (_FILE_CONNECT) {
	install_debut_html();
	echo "<P><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=4>"._T('avis_espace_interdit')."</FONT>";

	install_fin_html();
	exit;
}

include_ecrire ("inc_base.php3");
define('_FILE_TMP', '_install');

//
// Etapes de l'installation standard
//

if ($etape == 6) {
	install_debut_html();

	echo "<BR><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_derniere_etape')."</B></FONT>";
	echo "<P>";
	echo "<B>"._T('info_code_acces')."</B>";
	echo "<P>"._T('info_utilisation_spip');

	include(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
	include_ecrire ("inc_meta.php3");

	if ($login) {
		$nom = addslashes($nom);
		$login = addslashes($login);
		$query = "SELECT id_auteur FROM spip_auteurs WHERE login='$login'";
		$result = spip_query_db($query);
		unset($id_auteur);
		while ($row = spip_fetch_array($result)) $id_auteur = $row['id_auteur'];

		$mdpass = md5($pass);
		$htpass = generer_htpass($pass);

		if ($id_auteur) {
			$query = "UPDATE spip_auteurs SET nom='$nom', email='$email', login='$login', pass='$mdpass', alea_actuel='', alea_futur=FLOOR(32000*RAND()), htpass='$htpass', statut='0minirezo' WHERE id_auteur=$id_auteur";
		}
		else {
			$query = "INSERT INTO spip_auteurs (nom, email, login, pass, htpass, alea_futur, statut) VALUES('$nom','$email','$login','$mdpass','$htpass',FLOOR(32000*RAND()),'0minirezo')";
		}
		spip_query_db($query);

		// inserer email comme email webmaster principal
		ecrire_meta('email_webmaster', $email);
	}

	include_ecrire("inc_config.php3");
	init_config();
	init_langues();

	include_ecrire ("inc_acces.php3");
	ecrire_acces();

	@unlink(_DIR_SESSIONS . 'inc_meta_cache.php3');
	@unlink(_DIR_SESSIONS . 'meta_cache.php3');
	if (!@rename(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP,
		    _FILE_CONNECT_INS . _EXTENSION_PHP)) {
		copy(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP, 
		     _FILE_CONNECT_INS . _EXTENSION_PHP);
		@unlink(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
	}

	echo "<FORM ACTION='index.php3' METHOD='post'>";
	echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";
	echo "</FORM>";

	ecrire_metas();

	install_fin_html();
}

else if ($etape == 5) {
	install_debut_html();

	include(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_informations_personnelles')."</FONT>";
	echo "<P>\n";

	echo "<b>"._T('texte_informations_personnelles_1')."</b>";
	echo aide ("install5");
	echo "<p>\n"._T('texte_informations_personnelles_2')." ";
	echo _T('info_laisser_champs_vides');

	echo "<FORM ACTION='install.php3' METHOD='post'>";
	echo "<INPUT TYPE='hidden' NAME='etape' VALUE='6'>";

	echo "<fieldset><label><B>"._T('info_identification_publique')."</B><BR />\n</label>";
	echo "<B>"._T('entree_signature')."</B><BR />\n";
	echo _T('entree_nom_pseudo_1')."<BR />\n";
	echo "<INPUT TYPE='text' NAME='nom' CLASS='formo' VALUE=\"$nom\" SIZE='40'><P>\n";

	echo "<B>"._T('entree_adresse_email')."</B><BR />\n";
	echo "<INPUT TYPE='text' NAME='email' CLASS='formo' VALUE=\"$email\" SIZE='40'></fieldset><P>\n";

	echo "<fieldset><label><B>"._T('entree_identifiants_connexion')."</B><BR />\n</label>";
	echo "<B>"._T('entree_login')."</B><BR />\n";
	echo _T('info_plus_trois_car')."<BR />\n";
	echo "<INPUT TYPE='text' NAME='login' CLASS='formo' VALUE=\"$login\" SIZE='40'><P>\n";

	echo "<B>"._T('entree_mot_passe')."</B> <BR />\n";
	echo _T('info_plus_cinq_car_2')."<BR />\n";
	echo "<INPUT TYPE='password' NAME='pass' CLASS='formo' VALUE=\"$pass\" SIZE='40'></fieldset><P>\n";

	echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";
	echo "</FORM>";
	echo "<p>\n";

	if ($flag_ldap AND !$ldap_present) {
		echo "<div style='border: 1px solid #404040; padding: 10px; text-align: left;'>";
		echo "<b>"._T('info_authentification_externe')."</b>";
		echo "<p>\n"._T('texte_annuaire_ldap_1');
		echo "<FORM ACTION='install.php3' METHOD='post'>";
		echo "<INPUT TYPE='hidden' NAME='etape' VALUE='ldap1'>";
		echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE=\""._T('bouton_acces_ldap')."\">";
		echo "</FORM>";
	}

	install_fin_html();

}

else if ($etape == 4) {

	install_debut_html();

	// Necessaire pour appeler les fonctions SQL wrappees
	include_ecrire("inc_db_mysql.php3");

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_creation_tables')."</FONT>";
	echo "<P>\n";

	$link = mysql_connect("$adresse_db", "$login_db", "$pass_db");

	echo "<"."!-- $link ";

	if ($choix_db == "new_spip") {
		$sel_db = $table_new;
		mysql_query("CREATE DATABASE $sel_db");
	}
	else {
		$sel_db = $choix_db;
	}
	echo $sel_db;
	mysql_select_db("$sel_db");

	// Test si SPIP deja installe
	@spip_query_db("SELECT COUNT(*) FROM spip_meta");
	$nouvelle = spip_sql_errno();

	creer_base();
	$maj_ok = maj_base();

	if ($nouvelle) {
		spip_query_db("INSERT spip_meta (nom, valeur) VALUES ('nouvelle_install', 'oui')");
		$result_ok = !spip_sql_errno();
	} else {
		$result = spip_query_db("SELECT COUNT(*) FROM spip_articles");
		$result_ok = (spip_num_rows($result) > 0);
	}
	echo "($result_ok && $maj_ok) -->";


	if ($result_ok && $maj_ok) {
		$conn = "<"."?php\n";
		$conn .= "if (defined(\"_ECRIRE_INC_CONNECT\")) return;\n";
		$conn .= "define(\"_ECRIRE_INC_CONNECT\", \"1\");\n";
		$conn .= "\$GLOBALS['spip_connect_version'] = 0.1;\n";
		$conn .= "include_ecrire('inc_db_mysql.php3');\n";
		$conn .= "@spip_connect_db('$adresse_db','','$login_db','$pass_db','$sel_db');\n";
		$conn .= "\$GLOBALS['db_ok'] = !!@spip_num_rows(@spip_query_db('SELECT COUNT(*) FROM spip_meta'));\n";
		$conn .= "?".">";
		$myFile = fopen(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP, "wb");
		fputs($myFile, $conn);
		fclose($myFile);

		echo "<B>"._T('info_base_installee')."</B><P>\n"._T('info_etape_suivante_1');

		echo "<FORM ACTION='install.php3' METHOD='post'>";
		echo "<INPUT TYPE='hidden' NAME='etape' VALUE='5'>";

		echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";

		echo "</FORM>";
	}
	else if ($result_ok) {
		echo _T('alerte_maj_impossible', array('version' => $spip_version));
	}
	else {
		echo "<B>"._T('avis_operation_echec')."</B> "._T('texte_operation_echec');
	}

	install_fin_html();

}

else if ($etape == 3) {

	install_debut_html();

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_choix_base')." <B>"._T('menu_aide_installation_choix_base')."</B></FONT>";

	echo aide ("install2");
	echo "<P>\n";

	echo "<FORM ACTION='install.php3' METHOD='post'>";
	echo "<INPUT TYPE='hidden' NAME='etape' VALUE='4'>";
	echo "<INPUT TYPE='hidden' NAME='adresse_db'  VALUE=\"$adresse_db\" SIZE='40'>";
	echo "<INPUT TYPE='hidden' NAME='login_db' VALUE=\"$login_db\">";
	echo "<INPUT TYPE='hidden' NAME='pass_db' VALUE=\"$pass_db\"><P>\n";

	$link = mysql_connect("$adresse_db","$login_db","$pass_db");
	$result = @mysql_list_dbs();

	echo "<fieldset><label><B>"._T('texte_choix_base_1')."</B><BR />\n</label>";

	if ($result AND (($n = @mysql_num_rows($result)) > 0)) {
		echo "<B>"._T('texte_choix_base_2')."</B><P> "._T('texte_choix_base_3');
		echo "<UL>";
		$bases = "";
		for ($i = 0; $i < $n; $i++) {
			$table_nom = mysql_dbname($result, $i);
			$base = "<INPUT NAME=\"choix_db\" VALUE=\"".$table_nom."\" TYPE=Radio id='tab$i'";
			$base_fin = "><label for='tab$i'>".$table_nom."</label><BR />\n\n";
			if ($table_nom == $login_db) {
				$bases = "$base CHECKED$base_fin".$bases;
				$checked = true;
			}
			else {
				$bases .= "$base$base_fin\n";
			}
		}
		echo $bases."</UL>";
		echo _T('info_ou')." ";
	}
	else {
		echo "<B>"._T('avis_lecture_noms_bases_1')."</B>
		"._T('avis_lecture_noms_bases_2')."<P>";
		if ($login_db) {
			echo _T('avis_lecture_noms_bases_3');
			echo "<UL>";
			echo "<INPUT NAME=\"choix_db\" VALUE=\"".$login_db."\" TYPE=Radio id='stand' CHECKED>";
			echo "<label for='stand'>".$login_db."</label><BR />\n";
			echo "</UL>";
			echo _T('info_ou')." ";
			$checked = true;
		}
	}
	echo "<INPUT NAME=\"choix_db\" VALUE=\"new_spip\" TYPE=Radio id='nou'";
	if (!$checked) echo " CHECKED";
	echo "> <label for='nou'>"._T('info_creer_base')."</label> ";
	echo "<INPUT TYPE='text' NAME='table_new' CLASS='fondo' VALUE=\"spip\" SIZE='20'></fieldset><P>";

	echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";


	echo "</FORM>";

	install_fin_html();

}

else if ($etape == 2) {

	install_debut_html();

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_connexion_base')."</FONT>";

	echo "<!--";
	$link = mysql_connect("$adresse_db","$login_db","$pass_db");
	$db_connect = mysql_errno();
	echo "-->";

	echo "<P>";

	if (($db_connect=="0") && $link){
		echo "<B>"._T('info_connexion_ok')."</B><P> "._T('info_etape_suivante_2');

		echo "<FORM ACTION='install.php3' METHOD='post'>";
		echo "<INPUT TYPE='hidden' NAME='etape' VALUE='3'>";
		echo "<INPUT TYPE='hidden' NAME='adresse_db'  VALUE=\"$adresse_db\" SIZE='40'>";
		echo "<INPUT TYPE='hidden' NAME='login_db' VALUE=\"$login_db\">";
		echo "<INPUT TYPE='hidden' NAME='pass_db' VALUE=\"$pass_db\"><P>";

		echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";
		echo "</FORM>";
	}
	else {
		echo "<B>"._T('avis_connexion_echec_1')."</B>";
		echo "<P>"._T('avis_connexion_echec_2');
		echo "<P><FONT SIZE=2>"._T('avis_connexion_echec_3')."</FONT>";
	}

	install_fin_html();

}
else if ($etape == 1) {
	install_debut_html();

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_connexion_mysql')."</FONT>";

	echo "<P>"._T('texte_connexion_mysql');

	echo aide ("install1");

	$adresse_db = 'localhost';
	$login_db = login_hebergeur();
	$pass_db = '';

	// Recuperer les anciennes donnees pour plus de facilite (si presentes)
	if (@file_exists(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP)) {
		$s = @join('', @file(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP));
		if (ereg("mysql_connect\([\"'](.*)[\"'],[\"'](.*)[\"'],[\"'](.*)[\"']\)", $s, $regs)) {
			$adresse_db = $regs[1];
			$login_db = $regs[2];
		}
		else if (ereg("spip_connect_db\('(.*)','(.*)','(.*)','(.*)','(.*)'\)", $s, $regs)) {
			$adresse_db = $regs[1];
			if ($port_db = $regs[2]) $adresse_db .= ':'.$port_db;
			$login_db = $regs[3];
		}
	}

	echo "<p><FORM ACTION='install.php3' METHOD='post'>";
	echo "<INPUT TYPE='hidden' NAME='etape' VALUE='2'>";
	echo "<fieldset><label><B>"._T('entree_base_donnee_1')."</B><BR />\n</label>";
	echo _T('entree_base_donnee_2')."<BR />\n";
	echo "<INPUT TYPE='text' NAME='adresse_db' CLASS='formo' VALUE=\"$adresse_db\" SIZE='40'></fieldset><P>";

	echo "<fieldset><label><B>"._T('entree_login_connexion_1')."</B><BR />\n</label>";
	echo _T('entree_login_connexion_2')."<BR />\n";
	echo "<INPUT TYPE='text' NAME='login_db' CLASS='formo' VALUE=\"$login_db\" SIZE='40'></fieldset><P>";

	echo "<fieldset><label><B>"._T('entree_mot_passe_1')."</B><BR />\n</label>";
	echo _T('entree_mot_passe_2')."<BR />\n";
	echo "<INPUT TYPE='password' NAME='pass_db' CLASS='formo' VALUE=\"$pass_db\" SIZE='40'></fieldset><P>";

	echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";


	echo "</FORM>";

	install_fin_html();

}
else if ($etape == 'dirs') {
	header("Location: ../spip_test_dirs.php3");
}
else if (!$etape) {
	$menu_langues = menu_langues('var_lang_ecrire');

	if (!$menu_langues)
		header("Location: ../spip_test_dirs.php3");
	else {
		install_debut_html();

		echo "<p align='center'><img src='" . _DIR_IMG_PACK . "logo-spip.gif'></p>";
		
		echo "<p style='text-align: center; font-family: Verdana,Arial,Sans,sans-serif; font-size: 10px;'>";
		echo "<b>SPIP $spip_version_affichee</b> ";
		echo _T('info_copyright');

		echo "</p>";

		echo "<p>" . _T('install_select_langue');

		echo "<p><div align='center'>".$menu_langues."</div>";

		echo "<p><FORM ACTION='install.php3' METHOD='get'>";
		echo "<INPUT TYPE='hidden' NAME='etape' VALUE='dirs'>";
		echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";
		echo "</FORM>";
		install_fin_html();
	}
}


//
// Etapes de l'installation LDAP
//

else if ($etape == 'ldap5') {
	install_debut_html();

	include_local(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
	include_ecrire('inc_meta.php3');
	ecrire_meta("ldap_statut_import", $statut_ldap);
	ecrire_metas();

	echo "<B>"._T('info_ldap_ok')."</B>";
	echo "<P>"._T('info_terminer_installation');

	echo "<FORM ACTION='install.php3' METHOD='post'>";
	echo "<INPUT TYPE='hidden' NAME='etape' VALUE='5'>";

	echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";

	echo "</FORM>";
}

else if ($etape == 'ldap4') {
	install_debut_html();

	if (!$base_ldap) $base_ldap = $base_ldap_text;

	$ldap_link = @ldap_connect("$adresse_ldap", "$port_ldap");
	@ldap_bind($ldap_link, "$login_ldap", "$pass_ldap");

	// Essayer de verifier le chemin fourni
	$r = @ldap_compare($ldap_link, $base_ldap, "objectClass", "");
	$fail = (ldap_errno($ldap_link) == 32);

	if ($fail) {
		echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_chemin_acces_annuaire')."</B></FONT>";
		echo "<P>";

		echo "<B>"._T('avis_operation_echec')."</B> "._T('avis_chemin_invalide_1')." (<tt>".htmlspecialchars($base_ldap);
		echo "</tt>) "._T('avis_chemin_invalide_2');
	}
	else {
		echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_reglage_ldap')."</FONT>";
		echo "<P>";

		$conn = join('', file(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP));
		if ($p = strpos($conn, '?'.'>')) 
			$conn = substr($conn, 0, $p);
		if (!strpos($conn, 'spip_connect_ldap')) {
			$conn .= "function spip_connect_ldap() {\n";
			$conn .= "\t\$GLOBALS['ldap_link'] = @ldap_connect(\"$adresse_ldap\",\"$port_ldap\");\n";
			$conn .= "\t at ldap_bind(\$GLOBALS['ldap_link'],\"$login_ldap\",\"$pass_ldap\");\n";
			$conn .= "\treturn \$GLOBALS['ldap_link'];\n";
			$conn .= "}\n";
			$conn .= "\$GLOBALS['ldap_base'] = \"$base_ldap\";\n";
			$conn .= "\$GLOBALS['ldap_present'] = true;\n";
		}
		$conn .= "?".">";
		$myFile = fopen(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP, "wb");
		fputs($myFile, $conn);
		fclose($myFile);

		echo "<p><FORM ACTION='install.php3' METHOD='post'>";
		echo "<INPUT TYPE='hidden' NAME='etape' VALUE='ldap5'>";
		echo "<fieldset><label><B>"._T('info_statut_utilisateurs_1')."</B></label><BR />\n";
		echo _T('info_statut_utilisateurs_2')." ";
		echo "<p>";
		echo "<INPUT TYPE='Radio' NAME='statut_ldap' VALUE=\"6forum\" id='visit'>";
		echo "<label for='visit'><b>"._T('info_visiteur_1')."</b></label> "._T('info_visiteur_2')."<br />\n";
		echo "<INPUT TYPE='Radio' NAME='statut_ldap' VALUE=\"1comite\" id='redac' CHECKED>";
		echo "<label for='redac'><b>"._T('info_redacteur_1')."</b></label> "._T('info_redacteur_2')."<br />\n";
		echo "<INPUT TYPE='Radio' NAME='statut_ldap' VALUE=\"0minirezo\" id='admin'>";
		echo "<label for='admin'><b>"._T('info_administrateur_1')."</b></label> "._T('info_administrateur_2')."<br />\n";
	
		echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";

		echo "</FORM>";
	}

	install_fin_html();
}

else if ($etape == 'ldap3') {
	install_debut_html();

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_chemin_acces_1')."</FONT>";

	echo "<P>"._T('info_chemin_acces_2');

	$ldap_link = @ldap_connect("$adresse_ldap", "$port_ldap");
	@ldap_bind($ldap_link, "$login_ldap", "$pass_ldap");

	$result = @ldap_read($ldap_link, "", "objectclass=*", array("namingContexts"));
	$info = @ldap_get_entries($ldap_link, $result);

	echo "<FORM ACTION='install.php3' METHOD='post'>";
	echo "<INPUT TYPE='hidden' NAME='etape' VALUE='ldap4'>";
	echo "<INPUT TYPE='hidden' NAME='adresse_ldap' VALUE=\"$adresse_ldap\">";
	echo "<INPUT TYPE='hidden' NAME='port_ldap' VALUE=\"$port_ldap\">";
	echo "<INPUT TYPE='hidden' NAME='login_ldap' VALUE=\"$login_ldap\">";
	echo "<INPUT TYPE='hidden' NAME='pass_ldap' VALUE=\"$pass_ldap\">";

	echo "<fieldset>";

	$checked = false;

	if (is_array($info) AND $info["count"] > 0) {
		echo "<P>"._T('info_selection_chemin_acces');
		echo "<UL>";
		$n = 0;
		for ($i = 0; $i < $info["count"]; $i++) {
			$names = $info[$i]["namingcontexts"];
			if (is_array($names)) {
				for ($j = 0; $j < $names["count"]; $j++) {
					$n++;
					echo "<INPUT NAME=\"base_ldap\" VALUE=\"".htmlspecialchars($names[$j])."\" TYPE='Radio' id='tab$n'";
					if (!$checked) {
						echo " CHECKED";
						$checked = true;
					}
					echo ">";
					echo "<label for='tab$n'>".htmlspecialchars($names[$j])."</label><BR />\n\n";
				}
			}
		}
		echo "</UL>";
		echo _T('info_ou')." ";
	}
	echo "<INPUT NAME=\"base_ldap\" VALUE=\"\" TYPE='Radio' id='manuel'";
	if (!$checked) {
		echo " CHECKED";
		$checked = true;
	}
	echo ">";
	echo "<label for='manuel'>"._T('entree_chemin_acces')."</label> ";
	echo "<INPUT TYPE='text' NAME='base_ldap_text' CLASS='formo' VALUE=\"ou=users, dc=mon-domaine, dc=com\" SIZE='40'></fieldset><P>";

	echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";
	echo "</FORM>";

	install_fin_html();

}

else if ($etape == 'ldap2') {
	install_debut_html();

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('titre_connexion_ldap')."</FONT>";

	echo "<P>";

	$ldap_link = @ldap_connect("$adresse_ldap", "$port_ldap");
	$r = @ldap_bind($ldap_link, "$login_ldap", "$pass_ldap");

	if ($ldap_link && ($r || !$login_ldap)) {
		echo "<B>"._T('info_connexion_ldap_ok');

		echo "<FORM ACTION='install.php3' METHOD='post'>";
		echo "<INPUT TYPE='hidden' NAME='etape' VALUE='ldap3'>";
		echo "<INPUT TYPE='hidden' NAME='adresse_ldap' VALUE=\"$adresse_ldap\">";
		echo "<INPUT TYPE='hidden' NAME='port_ldap' VALUE=\"$port_ldap\">";
		echo "<INPUT TYPE='hidden' NAME='login_ldap' VALUE=\"$login_ldap\">";
		echo "<INPUT TYPE='hidden' NAME='pass_ldap' VALUE=\"$pass_ldap\">";

		echo "<DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";
		echo "</FORM>";
	}
	else {
		echo "<B>"._T('avis_connexion_ldap_echec_1')."</B>";
		echo "<P>"._T('avis_connexion_ldap_echec_2');
		echo "<br />\n"._T('avis_connexion_ldap_echec_3');
	}

	install_fin_html();

}

else if ($etape == 'ldap1') {
	install_debut_html();

	echo "<BR />\n<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('titre_connexion_ldap')."</FONT>";

	echo "<P>"._T('entree_informations_connexion_ldap');

	$adresse_ldap = 'localhost';
	$port_ldap = 389;

	// Recuperer les anciennes donnees (si presentes)
	if (@file_exists(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP)) {
		$s = @join('', @file(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP));
		if (ereg('ldap_connect\("(.*)","(.*)"\)', $s, $regs)) {
			$adresse_ldap = $regs[1];
			$port_ldap = $regs[2];
		}
	}

	echo "<p><FORM ACTION='install.php3' METHOD='post'>";
	echo "<INPUT TYPE='hidden' NAME='etape' VALUE='ldap2'>";
	echo "<fieldset><label><B>"._T('entree_adresse_annuaire')."</B><BR />\n</label>";
	echo _T('texte_adresse_annuaire_1')."<BR />\n";
	echo "<INPUT TYPE='text' NAME='adresse_ldap' CLASS='formo' VALUE=\"$adresse_ldap\" SIZE='20'><P>";

	echo "<label><B>"._T('entree_port_annuaire')."</B><BR />\n</label>";
	echo _T('texte_port_annuaire')."<BR />\n";
	echo "<INPUT TYPE='text' NAME='port_ldap' CLASS='formo' VALUE=\"$port_ldap\" SIZE='20'><P></fieldset>";

	echo "<p><fieldset>";
	echo _T('texte_acces_ldap_anonyme_1')." ";
	echo "<label><B>"._T('entree_login_ldap')."</B><BR />\n</label>";
	echo _T('texte_login_ldap_1')."<br />\n";
	echo "<INPUT TYPE='text' NAME='login_ldap' CLASS='formo' VALUE=\"\" SIZE='40'><P>";

	echo "<label><B>"._T('entree_passe_ldap')."</B><BR />\n</label>";
	echo "<INPUT TYPE='password' NAME='pass_ldap' CLASS='formo' VALUE=\"\" SIZE='40'></fieldset>";

	echo "<p><DIV align='$spip_lang_right'><INPUT TYPE='submit' CLASS='fondl'  VALUE='"._T('bouton_suivant')." >>'>";

	echo "</FORM>";

	install_fin_html();

}


?>

--- NEW FILE: suivi_revisions.php3 ---
<?php

include("inc_lab.php");

include_ecrire("inc_suivi_revisions.php");
include_spip("ecrire.php");
include_spip("revisions.php");
include_spip("diff.php");




debut_page(_T("icone_suivi_revisions"));


//////////////////////////////////////////////////////
// Affichage de la colonne de gauche
//

debut_gauche();
if (!$debut) $debut = 0;

if (!$uniq_auteur) $uniq_auteur = false ;
else $uniq_auteur = true;


if ($connect_statut == "0minirezo") $req_where = " AND articles.statut IN ('prepa','prop','publie')"; 
else $req_where = " AND articles.statut IN ('prop','publie')"; 

echo "<p>";

echo "<div class='arial11'><ul>";
echo "<p>";

if (!$uniq_auteur AND $id_secteur < 1) echo "<li><b>"._T('info_tout_site')."</b>";
else echo "<li><a href='suivi_revisions.php3'>"._T('info_tout_site')."</a>";

echo "<p>";

$nom_auteur = $GLOBALS['auteur_session']['nom'];

if ($uniq_auteur) echo "<li><b>$nom_auteur</b>";
else echo "<li><a href='suivi_revisions.php3?uniq_auteur=true'>$nom_auteur</a>";

echo "<p>";

$query = "SELECT * FROM spip_rubriques WHERE id_parent = 0 ORDER BY titre";
$result = spip_query($query);

while ($row = mysql_fetch_array($result)) {
	$id_rubrique = $row['id_rubrique'];
	$titre = propre($row['titre']);
	
	$query_rub = "
SELECT versions.*, articles.statut, articles.titre
FROM spip_versions AS versions, spip_articles AS articles 
WHERE versions.id_article = articles.id_article AND versions.id_version > 1 AND articles.id_secteur=$id_rubrique$req_where LIMIT 0,1";
	$result_rub = spip_query($query_rub);
	
	if ($id_rubrique == $id_secteur)  echo "<li><b>$titre</b>";
	else if (spip_num_rows($result_rub) > 0) echo "<li><a href='suivi_revisions.php3?id_secteur=$id_rubrique'>$titre</a>";
}

if ((lire_meta('multi_rubriques') == 'oui') OR (lire_meta('multi_articles') == 'oui')) {
	echo "<p>";
	$langues = explode(',', lire_meta('langues_multilingue'));
	
	foreach ($langues as $lang) {
		$titre = traduire_nom_langue($lang);
	
		$query_lang = "
SELECT versions.*
FROM spip_versions AS versions, spip_articles AS articles 
WHERE versions.id_article = articles.id_article AND versions.id_version > 1 AND articles.lang='$lang' $req_where LIMIT 0,1";
		$result_lang = spip_query($query_lang);
		
		if ($lang == $lang_choisie)  echo "<li><b>$titre</b>";
		else if (spip_num_rows($result_lang) > 0) echo "<li><a href='suivi_revisions.php3?lang_choisie=$lang'>$titre</a>";
	}
}


echo "</ul></div>";


//////////////////////////////////////////////////////
// Affichage de la colonne de droite
//


debut_droite();

afficher_suivi_versions ($debut, $id_secteur, $uniq_auteur, $lang_choisie);

fin_page();

?>

--- NEW FILE: inc_db_mysql.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_DB_MYSQL")) return;
define("_ECRIRE_INC_DB_MYSQL", "1");

//
// Appel de requetes SQL
//

function spip_query_db($query) {
	global $spip_mysql_link;
	static $tt = 0;
	$my_admin = (($GLOBALS['connect_statut'] == '0minirezo') OR ($GLOBALS['auteur_session']['statut'] == '0minirezo'));
	$my_profile = ($GLOBALS['mysql_profile'] AND $my_admin);
	$my_debug = ($GLOBALS['mysql_debug'] AND $my_admin);

	$query = traite_query($query);

	if ($my_profile)
		$m1 = microtime();

	if ($GLOBALS['mysql_rappel_connexion'] AND $spip_mysql_link) $result = mysql_query($query, $spip_mysql_link);
	else $result = mysql_query($query);

	if ($my_profile) {
		$m2 = microtime();
		list($usec, $sec) = explode(" ", $m1);
		list($usec2, $sec2) = explode(" ", $m2);
		$dt = $sec2 + $usec2 - $sec - $usec;
		$tt += $dt;
		echo "<small>".htmlentities($query);
		echo " -> <font color='blue'>".sprintf("%3f", $dt)."</font> ($tt)</small><p>\n";

	}

	if ($s = mysql_error()) {
		if ($my_debug) {
			echo _T('info_erreur_requete')." ".htmlentities($query)."<br>";
			echo "&laquo; ".htmlentities($s)." &raquo;<p>";
		}
		spip_log($GLOBALS['REQUEST_METHOD'].' '.$GLOBALS['REQUEST_URI'], 'mysql');
		spip_log("$s - $query", 'mysql');
	}

	# spip_log("$s - $query", 'mysql');

	return $result;
}

// fonction appelant la precedente 
// specifiquement pour les select des squelettes
// c'est une instance de spip_abstract_select, voir ses specs dans inc_calcul
// a noter qu'on pourrait y r?aliser traite_query ? moindre cout
// les \n et \t sont utiles au debusqueur

function spip_mysql_select($select, $from, $where,
			   $groupby, $orderby, $limit,
			   $sousrequete, $cpt,
			   $table, $id, $serveur) {

	$DB = 'spip_';
	$q = "\nFROM $DB" . join(",\n\t$DB", $from)
	. ($where ? "\nWHERE " . join("\n\tAND ", $where) : '')
	. ($groupby ? "\nGROUP BY $groupby" : '')
	. ($orderby ? "\nORDER BY $orderby" : '')
	. ($limit ? "\nLIMIT $limit" : '');

	if (!$sousrequete)
		$q = " SELECT ". join(", ", $select) . $q;
	else
		$q = " SELECT S_" . join(", S_", $select)
		. " FROM (" . join(", ", $select)
		. ", COUNT(".$sousrequete.") AS compteur " . $q
		.") AS S_$table WHERE compteur=" . $cpt;

	// Erreur ? C'est du debug de squelette, ou une erreur du serveur

	if ($GLOBALS['var_mode'] == 'debug') {
	  boucle_debug_resultat($id, '', $q);
	}

	if (!($res = @spip_query($q))) {
		include_ecrire('inc_debug_sql.php3');
		echo erreur_requete_boucle($q, $id, $table);
	}

#	 spip_log($serveur . spip_num_rows($res) . $q);
	return $res;
}

//
// Passage d'une requete standardisee
//
function traite_query($query) {
	if ($GLOBALS['table_prefix']) $table_pref = $GLOBALS['table_prefix']."_";
	else $table_pref = "";

	if ($GLOBALS['mysql_rappel_connexion'] AND $db = $GLOBALS['spip_mysql_db'])
		$db = '`'.$db.'`.';

	// changer les noms des tables ($table_prefix)
	if ($GLOBALS['flag_pcre']) {
		if (preg_match('/\s(VALUES|WHERE)\s/i', $query, $regs)) {
			$suite = strstr($query, $regs[0]);
			$query = substr($query, 0, -strlen($suite));
		}
		$query = preg_replace('/([,\s])spip_/', '\1'.$db.$table_pref, $query) . $suite;
	}
	else {
		if (eregi('[[:space:]](VALUES|WHERE)[[:space:]]', $query, $regs)) {
			$suite = strstr($query, $regs[0]);
			$query = substr($query, 0, -strlen($suite));
		}
		$query = ereg_replace('([[:space:],])spip_', '\1'.$db.$table_pref, $query) . $suite;
	}

	return $query;
}


//
// Connexion a la base
//

function spip_connect_db($host, $port, $login, $pass, $db) {
	global $spip_mysql_link, $spip_mysql_db;	// pour connexions multiples

	if ($port > 0) $host = "$host:$port";
	$spip_mysql_link = @mysql_connect($host, $login, $pass);
	$spip_mysql_db = $db;
	return @mysql_select_db($db);
}


//
// Recuperation des resultats
//

function spip_fetch_array($r) {
	if ($r)
		return mysql_fetch_array($r);
}

/* Appels obsoletes
function spip_fetch_object($r) {
	if ($r)
		return mysql_fetch_object($r);
}

function spip_fetch_row($r) {
	if ($r)
		return mysql_fetch_row($r);
}
*/

function spip_sql_error() {
	return mysql_error();
}

function spip_sql_errno() {
	return mysql_errno();
}

function spip_num_rows($r) {
	if ($r)
		return mysql_num_rows($r);
}

function spip_free_result($r) {
	if ($r)
		return mysql_free_result($r);
}

function spip_insert($table, $champs, $valeurs) {
	spip_query("INSERT INTO spip_$table $champs VALUES $valeurs");
	return  mysql_insert_id();
}

function spip_insert_id() {
	return mysql_insert_id();
}

//
// Poser un verrou local a un SPIP donne
//
function spip_get_lock($nom, $timeout = 0) {
	global $spip_mysql_db, $table_prefix;
	if ($table_prefix) $nom = "$table_prefix:$nom";
	if ($spip_mysql_db) $nom = "$spip_mysql_db:$nom";

	$nom = addslashes($nom);
	$q = spip_query("SELECT GET_LOCK('$nom', $timeout)");
	list($lock_ok) = spip_fetch_array($q);

	if (!$lock_ok) spip_log("pas de lock sql pour $nom");
	return $lock_ok;
}

function spip_release_lock($nom) {
	global $spip_mysql_db, $table_prefix;
	if ($table_prefix) $nom = "$table_prefix:$nom";
	if ($spip_mysql_db) $nom = "$spip_mysql_db:$nom";

	$nom = addslashes($nom);
	spip_query("SELECT RELEASE_LOCK('$nom')");
}


//
// IN (...) est limite a 255 elements, d'ou cette fonction assistante
//
function calcul_mysql_in($val, $valeurs, $not='') {
	if (!$valeurs) return '0=0';
	$s = split(',', $valeurs, 255);
	if (count($s) < 255) {
		return ("($val $not IN ($valeurs))");
	} else {
		$valeurs = array_pop($s);
		return ("($val $not IN (" . join(',',$s) . "))\n" .
			($not ? "AND\t" : "OR\t") .
			calcul_mysql_in($val, $valeurs, $not));
    }
}

?>

--- NEW FILE: mots_edit.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_logos.php3");
include_ecrire ("inc_sites.php3");
include_ecrire ("inc_abstract_sql.php3");

function mySel($varaut, $variable) {
	$retour = " VALUE=\"$varaut\"";

	if ($variable==$varaut){
		$retour.= " SELECTED";
	}
	return $retour;
}


//
// modifications mot
//
if ($connect_statut == '0minirezo') {
	if ($supp_mot) {
		$query = "DELETE FROM spip_mots WHERE id_mot=$supp_mot";
		$result = spip_query($query);
		$query = "DELETE FROM spip_mots_articles WHERE id_mot=$supp_mot";
		$result = spip_query($query);
	}

	if ($titre_mot) {
		if ($new == 'oui' && $id_groupe) {
		  $id_mot = spip_abstract_insert("mots", '(id_groupe)', "($id_groupe)");


			// ajouter le mot a l'article
			if (settype($ajouter_id_article, 'integer') AND ($ajouter_id_article>0))
				spip_query("INSERT INTO spip_mots_articles (id_mot, id_article) VALUES ($id_mot, $ajouter_id_article)");
		}

		$titre_mot = addslashes($titre_mot);
		$texte = addslashes($texte);
		$descriptif = addslashes($descriptif);
		$type = addslashes(corriger_caracteres($type));
		$result = spip_query("SELECT * FROM spip_groupes_mots WHERE id_groupe='$id_groupe'");
		if ($row = spip_fetch_array($result))
			$type = addslashes(corriger_caracteres($row['titre']));

		// recoller les champs du extra
		if ($champs_extra) {
			include_ecrire("inc_extra.php3");
			$add_extra = ", extra = '".addslashes(extra_recup_saisie("mots"))."'";
		} else
			$add_extra = '';

		$query = "UPDATE spip_mots SET titre='$titre_mot', texte='$texte', descriptif='$descriptif', type='$type', id_groupe=$id_groupe $add_extra WHERE id_mot=$id_mot";
		$result = spip_query($query);

		if (lire_meta('activer_moteur') == 'oui') {
			include_ecrire ("inc_index.php3");
			indexer_mot($id_mot);
		}
	}
	else if ($new == 'oui') {
		if (!$titre_mot = $titre) {
			$titre_mot = filtrer_entites(_T('texte_nouveau_mot'));
			$onfocus = " onfocus=\"if(!antifocus){this.value='';antifocus=true;}\"";
		}
	}
}

//
// redirection ou affichage
//
if ($redirect_ok == 'oui' && $redirect) {
	redirige_par_entete(rawurldecode($redirect));
}

//
// Recupere les donnees
//
$query = "SELECT * FROM spip_mots WHERE id_mot='$id_mot'";
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$id_mot = $row['id_mot'];
	$titre_mot = $row['titre'];
	$descriptif = $row['descriptif'];
	$texte = $row['texte'];
	$type = $row['type'];
	$extra = $row['extra'];
	$id_groupe = $row['id_groupe'];
}

debut_page("&laquo; $titre_mot &raquo;", "documents", "mots");
debut_gauche();


//////////////////////////////////////////////////////
// Boite "voir en ligne"
//

if ($id_mot) {
	debut_boite_info();
	echo "<CENTER>";
	echo "<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=1><B>"._T('titre_gauche_mots_edit')."</B></FONT>";
	echo "<BR><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=6><B>$id_mot</B></FONT>";
	echo "</CENTER>";

	voir_en_ligne ('mot', $id_mot);

	fin_boite_info();
}

echo "<p><center>";
if ($new == 'oui') {
	$adresse_retour = "mots_edit.php3?redirect=$redirect&redirect_ok=oui&supp_mot=$id_mot";
}else {
	$adresse_retour = "mots_edit.php3?redirect=$redirect&redirect_ok=oui";
}
echo "</center>";

//////////////////////////////////////////////////////
// Logos du mot-clef
//

$arton = "moton$id_mot";
$artoff = "motoff$id_mot";

if ($id_mot > 0 AND $connect_statut == '0minirezo')
	afficher_boite_logo($arton, $artoff, _T('logo_mot_cle').aide("breveslogo"), _T('logo_survol'));


//
// Afficher les boutons de creation d'article et de breve
//
debut_raccourcis();

icone_horizontale(_T('icone_voir_tous_mots_cles'), "mots_tous.php3", "mot-cle-24.gif", "rien.gif");

if ($connect_statut == '0minirezo')
		icone_horizontale(_T('icone_creation_mots_cles'), "mots_edit.php3?new=oui&redirect=mots_tous.php3&id_groupe=$id_groupe", "mot-cle-24.gif", "creer.gif");

fin_raccourcis();


debut_droite();

debut_cadre_relief("mot-cle-24.gif");


echo "\n<table cellpadding=0 cellspacing=0 border=0 width='100%'>";
echo "<tr width='100%'>";
echo "<td width='100%' valign='top'>";
gros_titre($titre_mot);


if ($descriptif) {
	echo "<p><div align='left' border: 1px dashed #aaaaaa;'>";
	echo "<font size=2 face='Verdana,Arial,Sans,sans-serif'>";
	echo "<b>"._T('info_descriptif')."</b> ";
	echo propre($descriptif);
	echo "&nbsp; ";
	echo "</font>";
	echo "</div>";
}
echo "</td>";
echo "</tr></table>\n";


if (strlen($texte)>0){
	echo "<FONT FACE='Verdana,Arial,Sans,sans-serif'>";
	echo "<P>".propre($texte);
	echo "</FONT>";
}



if ($id_mot) {
	echo "<P>";

	if ($connect_statut == "0minirezo")
		$aff_articles = "'prepa','prop','publie','refuse'";
	else
		$aff_articles = "'prop','publie'";

	afficher_rubriques(_T('info_rubriques_liees_mot'),
	"SELECT rubrique.* FROM spip_rubriques AS rubrique, spip_mots_rubriques AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_rubrique=rubrique.id_rubrique ORDER BY rubrique.titre");

	afficher_articles(_T('info_articles_lies_mot'),
	", spip_mots_articles AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_article=articles.id_article AND articles.statut IN ($aff_articles) ORDER BY articles.date DESC", true);

	afficher_breves(_T('info_breves_liees_mot'),
	"SELECT breves.* FROM spip_breves AS breves, spip_mots_breves AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_breve=breves.id_breve ORDER BY breves.date_heure DESC LIMIT 0,10");

	afficher_sites(_T('info_sites_lies_mot'),
	"SELECT syndic.* FROM spip_syndic AS syndic, spip_mots_syndic AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_syndic=syndic.id_syndic ORDER BY syndic.nom_site DESC LIMIT 0,10");
}

fin_cadre_relief();



if ($connect_statut =="0minirezo"){
	echo "<P>";
	debut_cadre_formulaire();

	echo "<FORM ACTION='mots_edit.php3' METHOD='post'>";
	echo "<div class='serif'>";
	
	if ($id_mot)
		echo "<INPUT TYPE='Hidden' NAME='id_mot' VALUE='$id_mot'>\n";
	else if ($new=='oui')
		echo "<INPUT TYPE='Hidden' NAME='new' VALUE='oui'>\n";
	echo "<INPUT TYPE='Hidden' NAME='redirect' VALUE=\"$redirect\">\n";
	echo "<INPUT TYPE='Hidden' NAME='redirect_ok' VALUE='oui'>\n";
	echo "<INPUT TYPE='Hidden' NAME='ajouter_id_article' VALUE=\"$ajouter_id_article\">\n";

	$titre_mot = entites_html($titre_mot);
	$descriptif = entites_html($descriptif);
	$texte = entites_html($texte);

	echo "<B>"._T('info_titre_mot_cle')."</B> "._T('info_obligatoire_02');
	echo aide ("mots");

	echo "<BR><INPUT TYPE='text' NAME='titre_mot' CLASS='formo' VALUE=\"$titre_mot\" SIZE='40' $onfocus>";

	// dans le groupe...
	$query_groupes = "SELECT * FROM spip_groupes_mots ORDER BY titre";
	$result = spip_query($query_groupes);
	if (spip_num_rows($result)>1) {
		debut_cadre_relief("groupe-mot-24.gif");
		echo  _T('info_dans_groupe')."</label>\n";
		echo aide ("motsgroupes");
		echo  " &nbsp; <SELECT NAME='id_groupe' class='fondl'>\n";
		while ($row_groupes = spip_fetch_array($result)){
			$groupe = $row_groupes['id_groupe'];
			$titre_groupe = texte_backend(supprimer_tags(typo($row_groupes['titre'])));
			echo  "<OPTION".mySel($groupe, $id_groupe).">$titre_groupe</OPTION>\n";
		}			
		echo  "</SELECT>";
		fin_cadre_relief();
	} else {
		$row_groupes = spip_fetch_array($result);
		if (!$row_groupes) {
			// il faut creer un groupe de mots (cas d'un mot cree depuis articles.php3)
		  $row_groupes['id_groupe'] = spip_abstract_insert("groupes_mots",
							  "(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)",
							  "('" .
							  addslashes(_T('info_mot_sans_groupe'))."', 'non',  'non', 'oui', 'oui', 'non', 'oui', 'oui', 'non', 'non'");

		}
		echo "<input type='hidden' name='id_groupe' value='".$row_groupes['id_groupe']."'>";
	}

	if ($options == 'avancees' OR $descriptif) {
		echo "<B>"._T('texte_descriptif_rapide')."</B><BR>";
		echo "<TEXTAREA NAME='descriptif' CLASS='forml' ROWS='4' COLS='40' wrap=soft>";
		echo $descriptif;
		echo "</TEXTAREA><P>\n";
	}
	else
		echo "<INPUT TYPE='hidden' NAME='descriptif' VALUE=\"$descriptif\">";

	if ($options == 'avancees' OR $texte) {
		echo "<B>"._T('info_texte_explicatif')."</B><BR>";
		echo "<TEXTAREA NAME='texte' ROWS='8' CLASS='forml' COLS='40' wrap=soft>";
		echo $texte;
		echo "</TEXTAREA><P>\n";
	}
	else
		echo "<INPUT TYPE='hidden' NAME='texte' VALUE=\"$texte\">";

	if ($champs_extra) {
		include_ecrire("inc_extra.php3");
		extra_saisie($extra, 'mots', $id_groupe);
	}

	echo "<DIV align='right'><INPUT TYPE='submit' NAME='Valider' VALUE='"._T('bouton_valider')."' CLASS='fondo'></div>";
	
	echo "</div>";
	echo "</FORM>";

	fin_cadre_formulaire();
}


fin_page();

?>

--- NEW FILE: pclzip.lib.php ---
<?php

// --------------------------------------------------------------------------------

// PhpConcept Library - Zip Module 2.1

// --------------------------------------------------------------------------------

// License GNU/LGPL - Vincent Blavet - December 2003

// http://www.phpconcept.net

// --------------------------------------------------------------------------------

//

// Presentation :

//   PclZip is a PHP library that manage ZIP archives.
[...9900 lines suppressed...]

      // ----- Change potential windows directory separator

      if ((strpos($p_path, '\\') > 0) || (substr($p_path, 0,1) == '\\')) {

          $p_path = strtr($p_path, '\\', '/');

      }

    }

    return $p_path;

  }

  // --------------------------------------------------------------------------------



?>

--- NEW FILE: spip_style_invisible.css ---
.invisible_au_chargement {
	visibility: hidden;
}
.visible_au_chargement {
	visibility: hidden;
}
.display_au_chargement {
	display: none;
}
--- NEW FILE: auteur_infos.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_acces.php3");
include_ecrire ("inc_logos.php3");
include_ecrire ("inc_session.php3");
include_ecrire ("inc_filtres.php3");
include_ecrire ("inc_abstract_sql.php3");

// securite
$id_auteur = floor($id_auteur);

// menu statuts
function mySel($varaut,$variable) {
	$retour = " VALUE=\"$varaut\"";
	if ($variable==$varaut){
		$retour.= " SELECTED";
	}
	return $retour;
}

//
// Auteurs a acces restreint
//
function afficher_auteur_rubriques($leparent){
	global $id_parent;
	global $id_rubrique;
	global $toutes_rubriques;
	global $i;
	
	$i++;
 	$query="SELECT * FROM spip_rubriques WHERE id_parent=$leparent ORDER BY titre";
 	$result=spip_query($query);

	while($row=spip_fetch_array($result)){
		$my_rubrique=$row['id_rubrique'];
		$titre=typo($row['titre']);
	
		if (!ereg(",$my_rubrique,","$toutes_rubriques")){
			$espace = str_repeat("&nbsp", $i*2) . "|";
			if ($i==1)
				$espace = "*";

			echo "<OPTION VALUE='$my_rubrique'>$espace ".supprimer_tags($titre)."\n";
			afficher_auteur_rubriques($my_rubrique);
		}
	}
	$i=$i-1;
}

// modif auteur restreint
if ($connect_toutes_rubriques AND $add_rub=floor($add_rub)){
	$query = "INSERT INTO spip_auteurs_rubriques (id_auteur,id_rubrique) VALUES($id_auteur,$add_rub)";
	$result = spip_query($query);
}
if ($connect_toutes_rubriques AND $supp_rub=floor($supp_rub)){
	$query = "DELETE FROM spip_auteurs_rubriques WHERE id_auteur=$id_auteur AND id_rubrique=$supp_rub";
	$result = spip_query($query);
}

// securite
if ($connect_statut != "0minirezo" AND $connect_id_auteur != $id_auteur) {
	gros_titre(_T('info_acces_interdit'));
	exit;
}

//
// Recuperer l'auteur (id_auteur) ... ou l'inventer
//
unset($auteur);

if ($id_auteur) {
	$auteur = spip_fetch_array(spip_query("SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur"));
	$new = false;	// eviter hack
} else {
	if (!$auteur['nom'] = $titre) {
		$auteur['nom'] = filtrer_entites(_T('item_nouvel_auteur'));
		$onfocus = " onfocus=\"if(!antifocus){this.value='';antifocus=true;}\"";
	}
	$auteur['statut'] = '1comite';
	$auteur['source'] = 'spip';
}


//
// Modification (et creation si besoin)
//
if ($statut) { // si on poste un statut, c'est qu'on modifie une fiche auteur
	if ($connect_statut == '0minirezo' AND ereg("^(0minirezo|1comite|5poubelle|6forum)$",$statut))	// changer le statut
		$auteur['statut'] = $statut;

	if ($nom)	// pas de nom vide
		$auteur['nom'] = corriger_caracteres($nom);

	// login et mot de passe
	unset ($modif_login);
	$old_login = $auteur['login'];
	if (($new_login<>$old_login) AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques AND $auteur['source'] == 'spip') {
		if ($new_login) {
			if (strlen($new_login) < 4)
				$echec .= "<p>"._T('info_login_trop_court');
			else if (spip_num_rows(spip_query("SELECT * FROM spip_auteurs WHERE login='".addslashes($new_login)."' AND id_auteur!=$id_auteur AND statut!='5poubelle'")))
				$echec .= "<p>"._T('info_login_existant');
			else if ($new_login != $old_login) {
				$modif_login = true;
				$auteur['login'] = $new_login;
			}
		}
		// suppression du login
		else {
			$auteur['login'] = '';
			$modif_login = true;
		}
	}

	// changement de pass, a securiser en jaja ?
	if ($new_pass AND ($statut != '5poubelle') AND $auteur['login'] AND $auteur['source'] == 'spip') {
		if ($new_pass != $new_pass2)
			$echec .= "<p>"._T('info_passes_identiques');
		else if ($new_pass AND strlen($new_pass) < 6)
			$echec .= "<p>"._T('info_passe_trop_court');
		else {
			$modif_login = true;
			$auteur['new_pass'] = $new_pass;
		}
	}

	if ($modif_login) {
		include_ecrire('inc_session.php3');
		zap_sessions ($auteur['id_auteur'], true);
		if ($connect_id_auteur == $auteur['id_auteur'])
			supprimer_session($GLOBALS['spip_session']);
	}

	// email
	// seuls les admins peuvent modifier l'email
	// les admins restreints peuvent modifier l'email des redacteurs
	// mais pas des autres admins
	if ($connect_statut == '0minirezo'
	AND ($connect_toutes_rubriques OR $statut<>'0minirezo')) { 
		if ($email !='' AND !email_valide($email)) {
			$echec .= "<p>"._T('info_email_invalide');
			$auteur['email'] = $email;
		} else
			$auteur['email'] = $email;
	}

	if ($connect_id_auteur == $id_auteur) {
		if ($perso_activer_imessage) {
			$query = "UPDATE spip_auteurs SET imessage='$perso_activer_imessage' WHERE id_auteur=$id_auteur";
			$result = spip_query($query);
			$auteur['imessage'] = $perso_activer_imessage;
		}
	}



	// variables sans probleme
	$auteur['bio'] = corriger_caracteres($bio);
	$auteur['pgp'] = corriger_caracteres($pgp);
	$auteur['nom_site'] = corriger_caracteres($nom_site_auteur); // attention mix avec $nom_site_spip ;(
	$auteur['url_site'] = vider_url($url_site);

	if ($new_pass) {
		$htpass = generer_htpass($new_pass);
		$alea_actuel = creer_uniqid();
		$alea_futur = creer_uniqid();
		$pass = md5($alea_actuel.$new_pass);
		$query_pass = " pass='$pass', htpass='$htpass', alea_actuel='$alea_actuel', alea_futur='$alea_futur', ";
		effacer_low_sec($auteur['id_auteur']);
	} else
		$query_pass = '';

	// recoller les champs du extra
	if ($champs_extra) {
		include_ecrire("inc_extra.php3");
		$extra = extra_recup_saisie("auteurs");
		$add_extra = ", extra = '".addslashes($extra)."'";
	} else
		$add_extra = '';

	// l'entrer dans la base
	if (!$echec) {
		if (!$auteur['id_auteur']) { // creation si pas d'id
		  $auteur['id_auteur'] = spip_abstract_insert("auteurs", "(nom)", "('temp')");

			$id_auteur = $auteur['id_auteur'];

			if (settype($ajouter_id_article,'integer') AND ($ajouter_id_article>0))
				spip_query("INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES ($id_auteur, $ajouter_id_article)");
		}

		$query = "UPDATE spip_auteurs SET $query_pass
			nom='".addslashes($auteur['nom'])."',
			login='".addslashes($auteur['login'])."',
			bio='".addslashes($auteur['bio'])."',
			email='".addslashes($auteur['email'])."',
			nom_site='".addslashes($auteur['nom_site'])."',
			url_site='".addslashes($auteur['url_site'])."',
			pgp='".addslashes($auteur['pgp'])."',
			statut='".addslashes($auteur['statut'])."'
			$add_extra
			WHERE id_auteur=".$auteur['id_auteur'];
		spip_query($query) OR die($query);
	}

	if (lire_meta('activer_moteur') == 'oui') {
		include_ecrire ("inc_index.php3");
		indexer_auteur($id_auteur);
	}


	// Mettre a jour les fichiers .htpasswd et .htpasswd-admin
	ecrire_acces();
}

// Redirection
if (!$echec AND $redirect_ok == "oui") {
	redirige_par_entete($redirect ? rawurldecode($redirect) : "auteurs_edit.php3?id_auteur=$id_auteur");
}


//
// Affichage
//

if ($connect_id_auteur == $id_auteur)
	debut_page($auteur['nom'], "auteurs", "perso");
else
	debut_page($auteur['nom'],"auteurs","redacteurs");

echo "<br><br><br>";

debut_gauche();

if ($id_auteur) {
	debut_boite_info();
	echo "<CENTER>";
	echo "<FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=1><B>"._T('titre_cadre_numero_auteur')."&nbsp;:</B></FONT>";
	echo "<BR><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=6><B>$id_auteur</B></FONT>";
	echo "</CENTER>";
	fin_boite_info();
}

debut_droite();


//
// Formulaire d'edition de l'auteur
//

if ($echec){
	debut_cadre_relief();
	echo http_img_pack("warning.gif", _T('info_avertissement'), "width='48' height='48' align='left'");
	echo "<font color='red'>$echec <p>"._T('info_recommencer')."</font>";
	fin_cadre_relief();
	echo "<p>";
}


debut_cadre_formulaire();
echo "<FORM ACTION='auteur_infos.php3?id_auteur=$id_auteur' METHOD='post'>";
echo "<INPUT TYPE='Hidden' NAME='id_auteur' VALUE=\"$id_auteur\">";


//
// Infos personnelles
//

echo "<div class='serif'>";

debut_cadre_relief("fiche-perso-24.gif", false, "", _T("icone_informations_personnelles"));

echo _T('titre_cadre_signature_obligatoire');
echo "("._T('entree_nom_pseudo').")<BR>";
echo "<INPUT TYPE='text' NAME='nom' CLASS='formo' VALUE=\"".entites_html($auteur['nom'])."\" SIZE='40' $onfocus><P>";

echo "<B>"._T('entree_adresse_email')."</B>";

if ($connect_statut == "0minirezo"
AND ($connect_toutes_rubriques OR $auteur['statut']<>'0minirezo')) {
	echo "<br><INPUT TYPE='text' NAME='email' CLASS='formo' VALUE=\"".entites_html($auteur['email'])."\" SIZE='40'><P>\n";
}
else {
	echo "&nbsp;: <tt>".$auteur['email']."</tt>";
	echo "<br>("._T('info_reserve_admin').")\n";
	echo "<P>";
}

echo "<B>"._T('entree_infos_perso')."</B><BR>";
echo "("._T('entree_biographie').")<BR>";
echo "<TEXTAREA NAME='bio' CLASS='forml' ROWS='4' COLS='40' wrap=soft>";
echo entites_html($auteur['bio']);
echo "</TEXTAREA>\n";

debut_cadre_enfonce("site-24.gif", false, "", _T('info_site_web'));
echo "<B>"._T('entree_nom_site')."</B><BR>";
echo "<INPUT TYPE='text' NAME='nom_site_auteur' CLASS='forml' VALUE=\"".entites_html($auteur['nom_site'])."\" SIZE='40'><P>\n";

echo "<B>"._T('entree_url')."</B><BR>";
echo "<INPUT TYPE='text' NAME='url_site' CLASS='forml' VALUE=\"".entites_html($auteur['url_site'])."\" SIZE='40'>\n";
fin_cadre_enfonce();
	echo "<p>";

if ($options == "avancees") {
	debut_cadre_enfonce("cadenas-24.gif", false, "", _T('entree_cle_pgp'));
	echo "<TEXTAREA NAME='pgp' CLASS='forml' ROWS='4' COLS='40' wrap=soft>";
	echo entites_html($auteur['pgp']);
	echo "</TEXTAREA>\n";
	fin_cadre_enfonce();
	echo "<p>";
}
else {
	echo "<input type='hidden' name='pgp' value=\"".entites_html($auteur['pgp'])."\">";
}

echo "<p>";
	if ($champs_extra) {
		include_ecrire("inc_extra.php3");
		extra_saisie($auteur['extra'], 'auteurs', $auteur['statut']);
	}

fin_cadre_relief();
echo "<p>";



//
// Login et mot de passe :
// accessibles seulement aux admins non restreints et l'auteur lui-meme
//

if ($auteur['source'] != 'spip') {
	$edit_login = false;
	$edit_pass = false;
}
else if (($connect_statut == "0minirezo") AND $connect_toutes_rubriques) {
	$edit_login = true;
	$edit_pass = true;
}
else if ($connect_id_auteur == $id_auteur) {
	$edit_login = false;
	$edit_pass = true;
}
else {
	$edit_login = false;
	$edit_pass = false;
}

debut_cadre_relief("base-24.gif");

// Avertissement en cas de modifs de ses propres donnees
if (($edit_login OR $edit_pass) AND $connect_id_auteur == $id_auteur) {
	debut_cadre_enfonce();
	echo http_img_pack("warning.gif", _T('info_avertissement'), "width='48' height='48' align='right'");
	echo "<b>"._T('texte_login_precaution')."</b>\n";
	fin_cadre_enfonce();
	echo "<p>";
}

// Un redacteur n'a pas le droit de modifier son login !
if ($edit_login) {
	echo "<B>"._T('item_login')."</B> ";
	echo "<font color='red'>("._T('texte_plus_trois_car').")</font> :<BR>";
	echo "<INPUT TYPE='text' NAME='new_login' CLASS='formo' VALUE=\"".entites_html($auteur['login'])."\" SIZE='40'><P>\n";
}
else {
	echo "<fieldset style='padding:5'><legend><B>"._T('item_login')."</B><BR></legend><br><b>".$auteur['login']."</b> ";
	echo "<i> ("._T('info_non_modifiable').")</i><p>";
}

// On ne peut modifier le mot de passe en cas de source externe (par exemple LDAP)
if ($edit_pass) {
	echo "<B>"._T('entree_nouveau_passe')."</B> ";
	echo "<font color='red'>("._T('info_plus_cinq_car').")</font> :<BR>";
	echo "<INPUT TYPE='password' NAME='new_pass' CLASS='formo' VALUE=\"\" SIZE='40'><BR>\n";
	echo _T('info_confirmer_passe')."<BR>";
	echo "<INPUT TYPE='password' NAME='new_pass2' CLASS='formo' VALUE=\"\" SIZE='40'><P>\n";
}
fin_cadre_relief();
echo "<p>";


//
// Apparaitre dans la liste des redacteurs connectes
//

if ($connect_id_auteur == $id_auteur) {

	debut_cadre_relief("messagerie-24.gif", false, "", _T('info_liste_redacteurs_connectes'));
		
	echo "<div>"._T('texte_auteur_messagerie')."</div>";	

		if ($auteur['imessage']=="non"){
			echo "<INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='oui' id='perso_activer_imessage_on'>";
			echo " <label for='perso_activer_imessage_on'>"._T('bouton_radio_apparaitre_liste_redacteurs_connectes')."</label> ";
			echo "<BR><INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='non' CHECKED id='perso_activer_imessage_off'>";
			echo " <B><label for='perso_activer_imessage_off'>"._T('bouton_radio_non_apparaitre_liste_redacteurs_connectes')."</label></B> ";
		} else {
			echo "<INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='oui' id='perso_activer_imessage_on' CHECKED>";
			echo " <B><label for='perso_activer_imessage_on'>"._T('bouton_radio_apparaitre_liste_redacteurs_connectes')."</label></B> ";

			echo "<BR><INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='non' id='perso_activer_imessage_off'>";
			echo " <label for='perso_activer_imessage_off'>"._T('bouton_radio_non_apparaitre_liste_redacteurs_connectes')."</label> ";
		}

	fin_cadre_relief();
	echo "<p />";

	
}



//
// Seuls les admins voient le menu 'statut', mais les admins restreints ne
// pourront l'utiliser que pour mettre un auteur a la poubelle
//

$statut = $auteur['statut']; // pour aller plus vite

if ($connect_statut == "0minirezo"
	AND ($connect_toutes_rubriques OR $statut != "0minirezo")
	AND $connect_id_auteur != $id_auteur) {
	debut_cadre_relief();
	echo "<center><B>"._T('info_statut_auteur')." </B> ";
	echo " <SELECT NAME='statut' SIZE=1 CLASS='fondl'>";

	if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques)
		echo "<OPTION".mySel("0minirezo",$statut).">"._T('item_administrateur_2');

	echo "<OPTION".mySel("1comite",$statut).">"._T('intem_redacteur');

	if (($statut == '6forum') OR (lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo'))
		echo "<OPTION".mySel("6forum",$statut).">"._T('item_visiteur');
	echo "<OPTION".mySel("5poubelle",$statut).
	  " style='background:url(" . _DIR_RESTREINT . "rayures-sup.gif)'>&gt; "._T('texte_statut_poubelle');

	echo "</SELECT></center>\n";
	fin_cadre_relief();
}
else {
	echo "<INPUT TYPE='Hidden' NAME='statut' VALUE=\"$statut\">";
}

//
// Gestion restreinte des rubriques
//
if ($statut == '0minirezo') {
	debut_cadre_enfonce("secteur-24.gif");

	$query_admin = "SELECT lien.id_rubrique, titre FROM spip_auteurs_rubriques AS lien, spip_rubriques AS rubriques WHERE lien.id_auteur=$id_auteur AND lien.id_rubrique=rubriques.id_rubrique GROUP BY lien.id_rubrique";
	$result_admin = spip_query($query_admin);

	if (spip_num_rows($result_admin) == 0) {
		echo _T('info_admin_gere_toutes_rubriques');
	} else {
		echo _T('info_admin_gere_rubriques')."\n";
		echo "<ul style='list-style-image: url(" . _DIR_IMG_PACK . "rubrique-12.gif)'>";
		while ($row_admin = spip_fetch_array($result_admin)) {
			$id_rubrique = $row_admin["id_rubrique"];
			$titre = typo($row_admin["titre"]);
			echo "<li>$titre";
			if ($connect_toutes_rubriques AND $connect_id_auteur != $id_auteur) {
				echo " <font size=1>[<a href='auteur_infos.php3?id_auteur=$id_auteur&supp_rub=$id_rubrique'>"._T('lien_supprimer_rubrique')."</a>]</font>";
			}
			$toutes_rubriques .= "$id_rubrique,";
		}
		echo "</ul>";
		$toutes_rubriques = ",$toutes_rubriques";
	}

	if ($connect_toutes_rubriques AND $connect_id_auteur != $id_auteur) {
		if (spip_num_rows($result_admin) == 0) {
			echo "<p><B>"._T('info_restreindre_rubrique')."</b><BR>";
		} else {
			echo "<p><B>"._T('info_ajouter_rubrique')."</b><BR>";
		}
		echo "<INPUT NAME='id_auteur' VALUE='$id_auteur' TYPE='hidden'>";
		echo "<SELECT NAME='add_rub' SIZE=1 CLASS='formo'>";
		echo "<OPTION VALUE='0'>   \n";
		afficher_auteur_rubriques("0");
		echo "</SELECT>";
	}
	fin_cadre_enfonce();
}

echo "<INPUT NAME='ajouter_id_article' VALUE='$ajouter_id_article' TYPE='hidden'>\n";
echo "<INPUT NAME='redirect' VALUE='$redirect' TYPE='hidden'>\n";
echo "<INPUT NAME='redirect_ok' VALUE='oui' TYPE='hidden'>\n";

echo "<DIV align='right'><INPUT TYPE='submit' CLASS='fondo' NAME='Valider' VALUE='"._T('bouton_valider')."'></DIV>";

echo "</div>";

echo "</form>";
fin_cadre_formulaire();
echo "&nbsp;<p>";

fin_page();

?>

--- NEW FILE: inc_suivi_revisions.php ---
<?php
//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_SUIVI_REVISIONS")) return;
define("_ECRIRE_INC_SUIVI_REVISIONS", "1");

include_ecrire("inc_lab.php");
include_spip("ecrire.php");
include_spip("revisions.php");
include_spip("diff.php");


function afficher_para_modifies ($texte, $court = false) {
	// Limiter la taille de l'affichage
	if ($court) $max = 200;
	else $max = 2000;
	
	$paras = explode ("\n",$texte);
	for ($i = 0; $i < count($paras) AND strlen($texte_ret) < $max; $i++) {
		if (ereg("diff-", $paras[$i])) $texte_ret .= $paras[$i]."\n\n";
	}
	$texte = $texte_ret;
	return $texte;
}

function afficher_suivi_versions ($debut = 0, $id_secteur = 0, $uniq_auteur = false, $lang = "", $court = false) {
	global $connect_id_auteur, $connect_statut, $dir_lang;
	
	$nb_aff = 10;
	$champs = array('surtitre', 'titre', 'soustitre', 'descriptif', 'nom_site', 'url_site', 'chapo', 'texte', 'ps');

	if ($uniq_auteur) $req_where = " AND articles.statut IN ('prepa','prop','publie')"; 
	else $req_where = " AND articles.statut IN ('prop','publie')"; 
	
	if ($uniq_auteur) $req_where = " AND versions.id_auteur = $connect_id_auteur";

	if (strlen($lang) > 0) $req_where .= " AND articles.lang='$lang'";

	if ($id_secteur > 0) $req_where .= " AND articles.id_secteur = $id_secteur";

	$query = "
		SELECT versions.*, articles.statut, articles.titre 
		FROM spip_versions AS versions, spip_articles AS articles 
		WHERE versions.id_article = articles.id_article AND versions.id_version > 1 $req_where ";
	
	$result = spip_query($query . " ORDER BY versions.date DESC LIMIT $debut, $nb_aff");
	if (spip_num_rows($result) > 0) {	
		$titre_table = _T('icone_suivi_revisions');
		if ($court) $titre_table = afficher_plus("suivi_revisions.php3").$titre_table;
		echo "<div style='height: 12px;'></div>";
		echo "<div class='liste'>";
		bandeau_titre_boite2($titre_table, "historique-24.gif");
	
		$total = spip_num_rows(spip_query($query . "LIMIT 0, 149"));
		
		if ($total > $nb_aff) {
			$nb_tranches = ceil($total / $nb_aff);
			
			echo "<div class='arial2' style='background-color: #dddddd; padding: 5px;'>";
		
			for ($i = 0; $i < $nb_tranches; $i++) {
				if ($i > 0) echo " | ";
				if ($i*$nb_aff == $debut) echo "<b>";
				else echo "<a href='suivi_revisions.php3?debut=".($i * $nb_aff)."&id_secteur=$id_secteur&uniq_auteur=$uniq_auteur&lang_choisie=$lang'>";
				echo (($i * $nb_aff) + 1);
				if ($i*$nb_aff == $debut) echo "</b>";
				else echo "</a>";
			}
			echo "</div>";
		}
	
		while ($row = mysql_fetch_array($result)) {
			$id_version = $row['id_version'];
			$id_auteur = $row['id_auteur'];
			$date = date_relative($row['date']);
			$id_article = $row['id_article'];
			$statut = $row['statut'];
			$titre = propre($row['titre']);	
			$nom = "";
			$query_auteur = "
				SELECT nom
				FROM spip_auteurs
				WHERE id_auteur = $id_auteur";
			$result_auteur = spip_query($query_auteur);
			if ($row_auteur = spip_fetch_array($result_auteur)) {
				$nom = propre($row_auteur["nom"]);
				if (strlen($nom) > 0) $nom = "($nom)";
			}
	
	
			$logo_statut = "puce-".puce_statut($statut).".gif";
			
			echo "<div class='tr_liste' style='padding: 5px; border-top: 1px solid #aaaaaa;'>";
	
			echo "<span class='arial2'>";
			if (!$court) echo bouton_block_invisible("$id_version-$id_article-$id_auteur");
			echo "<img src='" . _DIR_IMG_PACK . "$logo_statut' border='0'>&nbsp;";
			echo "<a class='$statut' style='font-weight: bold;' href='articles_versions.php3?id_article=$id_article'>$titre</a>";
			echo "</span>";
			echo "<span class='arial1'>";
			echo " $date $nom";
			echo "</span>";
		
			if (!$court) { 
				$query_diff = "
					SELECT id_version
					FROM spip_versions
					WHERE id_article=$id_article AND id_version<$id_version 
					ORDER BY id_version DESC LIMIT 0,1";
					if ($result_diff = spip_query($query_diff)) {
						$row_diff = mysql_fetch_array($result_diff);
						$id_diff = $row_diff['id_version'];
				}
		
		
				$query_art = "
					SELECT *
					FROM spip_articles
					WHERE id_article='$id_article'";
				$result_art = spip_query($query_art);
				
				if ($row_art = spip_fetch_array($result_art)) {
					$id_article = $row_art["id_article"];
					$id_rubrique = $row_art["id_rubrique"];
					$date = $row_art["date"];
					$statut_article = $row_art["statut"];
					$maj = $row_art["maj"];
					$date_redac = $row_art["date_redac"];
					$visites = $row_art["visites"];
					$referers = $row_art["referers"];
					$extra = $row_art["extra"];
					$id_trad = $row_art["id_trad"];
				}
				
				$textes = recuperer_version($id_article, $id_version);		
						
				if ($id_version && $id_diff) {		
					if ($id_diff > $id_version) {
						$t = $id_version;
						$id_version = $id_diff;
						$id_diff = $t;
						$old = $textes;
						$new = $textes = recuperer_version($id_article, $id_version);
					}
					else {
						$old = recuperer_version($id_article, $id_diff);
						$new = $textes;
					}		
					$textes = array();			
					foreach ($champs as $champ) {
						if (!$new[$champ] && !$old[$champ]) continue;			
						$diff = new Diff(new DiffTexte);
						$textes[$champ] = afficher_para_modifies(afficher_diff($diff->comparer(preparer_diff($new[$champ]), preparer_diff($old[$champ]))), $court);
					}
				}	
				
				echo debut_block_invisible("$id_version-$id_article-$id_auteur");
				if (is_array($textes))
				foreach ($textes as $var => $t) {
					if (strlen($t) > 0) {
						echo "<blockquote class='spip serif1'>";
						echo propre($t)."";
						echo "</blockquote>";
					}		
				}		
				echo fin_block();
			
			}
			
			echo "</div>";
		}		
		echo "</div>";
	}
}

?>
--- NEW FILE: articles_page.php3 ---
<?php

include ("inc.php3");

debut_page(_T('titre_page_articles_page'), "documents", "articles");

debut_gauche();

//
// Afficher le bouton de creation d'article
//

$query = "SELECT id_rubrique FROM spip_rubriques LIMIT 0,1";
$result = spip_query($query);

if (spip_num_rows($result) > 0) {
	debut_raccourcis();
	icone_horizontale (_T('icone_ecrire_article'), "articles_edit.php3?new=oui", "article-24.gif", "creer.gif");
	fin_raccourcis();
}
else {
	if ($connect_statut == '0minirezo') {
		echo _T('texte_creer_rubrique');
		icone_horizontale (_T('icone_creer_rubrique'), "rubriques_edit.php3?new=oui&retour=nav", "rubrique-24.gif", "creer.gif");
	}
}

debut_droite();




//
// Vos articles en cours de redaction
//

echo "<P align=left>";
afficher_articles(_T('info_en_cours_validation'),
	", spip_auteurs_articles AS lien ".
	"WHERE articles.id_article=lien.id_article AND lien.id_auteur=$connect_id_auteur AND articles.statut=\"prepa\" ORDER BY articles.date DESC");




//
// Vos articles soumis au vote
//

echo "<p>";
afficher_articles(_T('info_attente_validation'),
	", spip_auteurs_articles AS lien ".
	"WHERE articles.id_article=lien.id_article AND lien.id_auteur=$connect_id_auteur AND articles.statut='prop' ORDER BY articles.date");


//
// Vos articles publies
//

echo "<p>";
afficher_articles(_T('info_publies'),
	", spip_auteurs_articles AS lien ".
	"WHERE articles.id_article=lien.id_article AND lien.id_auteur=\"$connect_id_auteur\" AND articles.statut=\"publie\" ORDER BY articles.date DESC", true);

//
//  Vos articles refuses
//

echo "<p>";
afficher_articles(_T('info_refuses'),
	", spip_auteurs_articles AS lien ".
	"WHERE articles.id_article=lien.id_article AND lien.id_auteur=\"$connect_id_auteur\" AND articles.statut=\"refuse\" ORDER BY articles.date DESC");


fin_page();


?>

--- NEW FILE: inc_debug_sql.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_INC_DEBUG_SQL")) return;
define("_INC_DEBUG_SQL", "1");

// Si le code php produit des erreurs, on les affiche en surimpression
// sauf pour un visiteur non admin (lui ne voit rien de special)
// ajouter &var_mode=debug pour voir les erreurs et en parler sur spip at rezo.net
function affiche_erreurs_page($tableau_des_erreurs) {

	echo "<div id='spip-debug' style='position: absolute; top: 20;",
	" z-index: 1000;'><ul><li>",
	_L("Erreur(s) dans le squelette"),

## aide locale courte a ecrire, avec lien vers une grosse page de documentation
#		aide('erreur_compilation'),

	"<br /></li>",
	"<ul>";
	foreach ($tableau_des_erreurs as $err) {
		echo "<li>".$err[0],
		", <small>".$err[1]."</small><br />",
		"</li>\n";
	}
	echo "</ul>";
	echo "</ul></div>";
	$GLOBALS['bouton_admin_debug'] = true;
}

//
// Si une boucle cree des soucis, on peut afficher la requete fautive
// avec son code d'erreur
//
function erreur_requete_boucle($query, $id_boucle, $type) {

	// Calmer le jeu avec MySQL (si jamais on est en saturation)
	@touch(_FILE_MYSQL_OUT);	// pour spip_cron
	spip_log('Erreur MySQL: on limite les acces quelques minutes');
	$GLOBALS['bouton_admin_debug'] = true;

	$erreur = spip_sql_error();
	$errno = spip_sql_errno();
	if (eregi('err(no|code):?[[:space:]]*([0-9]+)', $erreur, $regs))
		$errsys = $regs[2];
	else if (($errno == 1030 OR $errno <= 1026)
	AND ereg('[^[:alnum:]]([0-9]+)[^[:alnum:]]', $erreur, $regs))
		$errsys = $regs[1];

	// Erreur systeme
	if ($errsys > 0 AND $errsys < 200) {
		$retour .= "<tt><br><br><blink>"
		. _T('info_erreur_systeme', array('errsys'=>$errsys))
		. "</blink><br>\n"
		. _T('info_erreur_systeme2');
		spip_log("Erreur systeme $errsys");
	}
	// Requete erronee
	else {
		$retour .= "<tt><blink>&lt;BOUCLE".$id_boucle."&gt;("
		. $type . ")</blink><br>\n"
		. "<b>"._T('avis_erreur_mysql')."</b><br>\n"
		. htmlspecialchars($query)
		. "<br><font color='red'><b>".htmlspecialchars($erreur)
		. "</b></font><br>"
		. "<blink>&lt;/BOUCLE".$id_boucle."&gt;</blink></tt>\n";

		include_ecrire('inc_presentation.php3');
		include_ecrire('inc_lang.php3');
		utiliser_langue_visiteur();
		$retour .= aide('erreur_mysql');
		spip_log("Erreur MySQL BOUCLE$id_boucle (".$GLOBALS['fond'].".html)");
	}

	erreur_squelette($retour);
}


//
// Erreur de syntaxe des squelettes : memoriser le code fautif
//
function erreur_squelette($message='', $lieu='') {
	global $tableau_des_erreurs;
	global $auteur_session;
	static $runs;

	if (is_array($message)) list($message, $lieu) = $message;

	spip_log("Erreur squelette: $message | $lieu ("
		. $GLOBALS['fond'].".html)");
	$GLOBALS['bouton_admin_debug'] = true;
	$tableau_des_erreurs[] = array($message, $lieu);
	// Eviter les boucles infernales
	if (++$runs > 4) {
		if ($HTTP_COOKIE_VARS['spip_admin'] OR
		$auteur_session['statut'] == '0minirezo' OR
		    ($GLOBALS['var_mode'] == 'debug')) {
			echo debut_entete('Debug'), '</head><body>';
			die(affiche_erreurs_page($tableau_des_erreurs));
		}
	}
}

//
// Le debugueur v2
//

// appelee a chaque sortie de boucle (inc-compilo) et a chaque requete
// dans ce derniers cas on n'a pas le nom du squelette
// alors on memorise dans une statique et lors de l'autre appel qui suit
// on finalise
function boucle_debug_resultat ($id, $nom, $resultat) {
	global $debug_objets;
	static $requete = array();
	if (!$nom) {$requete[$id] = $resultat; return;}
	if ($requete[$id]) {
		$debug_objets['requete']["$nom$id"] = $requete[$id];
		$requete[$id] = '';
	}
	// ne pas memoriser plus de 3 tours d'une meme boucle
	if (count($debug_objets['resultat']["$nom$id"]) < 3)
		$debug_objets['resultat']["$nom$id"][] = $resultat;
}

// appelee a chaque compilation de boucle (inc-compilo)
function boucle_debug_compile ($id, $nom, $pretty, $sourcefile, $code) {
	global $debug_objets;

	$debug_objets['code'][$nom.$id] = $code;
	$debug_objets['pretty'][$nom.$id] = $pretty;
}

// appelee a chaque compilation de squelette (inc-compilo)
function squelette_debug_compile($nom, $sourcefile, $squelette) {
	global $debug_objets;
	$debug_objets['squelettes'][$nom] = $squelette;
	$debug_objets['sourcefile'][$nom] = $sourcefile;
}

// appelee a chaque analyse syntaxique de squelette (inc-parser)
function boucle_debug ($id, $nom, $boucle) {
	global $debug_objets;

	$debug_objets['boucle'][$nom.$id] = $boucle;
}

// l'environnement graphique du debuggueur 
function debug_dumpfile ($texte, $fonc, $type) {

	global $debug_objets, $var_mode_objet, $var_mode_affiche;
	$debug_objets[$type][$fonc . 'tout'] = $texte;
	if (!$debug_objets['sourcefile']) return;
	if ($texte && ($var_mode_objet != $fonc || $var_mode_affiche != $type))
	    return;
	spip_setcookie('spip_debug', 'oui', time()+12*3600);

	$link = new Link;
	$link->delvar('var_mode_affiche');
	$link->delvar('var_mode_objet');
	$link->addvar('var_mode','debug');
	$self = $link->getUrl();

// en cas de squelette inclus,  virer le code de l'incluant:
// - il contient souvent une Div restreignant la largeur a 3 fois rien
// - ca fait 2 headers !
	ob_end_clean();

	echo debut_entete('Debug'), 
	  "<link rel='stylesheet' href='spip_admin.css' type='text/css' />",
	  "</head>\n<body>",
	  "<div id='spip-debug' style='position: absolute; top: 20; z-index: 1000;'><ul>\n"; 

	foreach ($debug_objets['sourcefile'] as $nom_skel => $sourcefile) {
		echo "<li><b>",$sourcefile,"</b>";
		echo " <a href='",$self, "&var_mode_objet=$nom_skel&var_mode_affiche=resultat'>resultat</a>";
		echo " <a href='", $self, "&var_mode_objet=$nom_skel&var_mode_affiche=code'>code</a>";
		echo "<table width='100%'>\n";
		$i = 0;
		$colors = array('#c0c0c0', '#c0cad4');
		if (is_array($debug_objets['pretty']))
		foreach ($debug_objets['pretty'] as $nom => $pretty)
			if (substr($nom, 0, strlen($nom_skel)) == $nom_skel) {
				$i++;
				$aff = "&lt;".$pretty."&gt;";
				if ($var_mode_objet == $nom)
					$aff = "<b>$aff</b>";
				echo "<tr bgcolor='" . $colors[$i%2] . "'><td  align='right'>$i</td><td><a href='",$self,"&var_mode_objet=$nom&var_mode_affiche=boucle' class='debug_link_boucle'>boucle</a></td><td><a href='",$self, "&var_mode_objet=$nom&var_mode_affiche=resultat' class='debug_link_resultat'>resultat</a></td><td><a href='", $self, "&var_mode_objet=$nom&var_mode_affiche=code' class='debug_link_code'>code</a></td><td>$aff</td></tr>";
			}
		echo "</table>\n</li>\n";
	}
	echo "</ul>\n";
	if ($var_mode_objet && ($res = $debug_objets[$var_mode_affiche][$var_mode_objet])) {
	  if ($var_mode_affiche == 'resultat') {
		echo "<div id=\"debug_boucle\"><fieldset><legend>",$debug_objets['pretty'][$var_mode_objet],"</legend>";
		highlight_string($debug_objets['requete'][$var_mode_objet]);
		echo "<p class='spip-admin-bloc'>les premiers appels &agrave; cette boucle ont donn&eacute;&nbsp;:</p>";
		foreach ($res as $view) 
			if ($res) echo "<br><fieldset>",interdire_scripts($view),"</fieldset>";
		echo "</fieldset></div>";

      } else if ($var_mode_affiche == 'code') {
		echo "<div id=\"debug_boucle\"><fieldset><legend>",$debug_objets['pretty'][$var_mode_objet],"</legend>";
		highlight_string("<"."?php\n".$res."\n?".">");
		echo "</fieldset></div>";
	} else if ($var_mode_affiche == 'boucle') {
		echo "<div id=\"debug_boucle\"><fieldset><legend>",$debug_objets['pretty'][$var_mode_objet],"</legend>";
		highlight_string($res);
		echo "</fieldset></div>";
	  }
    }

	if ($texte) {
	  echo "<div id=\"debug_boucle\"><fieldset><legend>",$GLOBALS['var_mode_affiche'],"</legend>";
	  ob_start();
	  highlight_string($texte);
	  $s = ob_get_contents();
	  ob_end_clean();
	  if (substr($s,0,6) == '<code>') { $s=substr($s,6); echo '<code>';}
	  $tableau = explode("<br />", $s);
	  $format = "<br />\n<span style='color: black'>%0".
	    strlen(count($tableau)).
	    "d </span>";
	  $format10=str_replace('black','pink',$format);
	  $i=1;
	  foreach ($tableau as $ligne)
	    echo sprintf(($i%10) ? $format :$format10, $i++), $ligne ;


	  echo "</fieldset></div>";
	}
	echo "\n</div>";
	echo inclure_balise_dynamique(balise_formulaire_admin_dyn('','','','','',$debug_objets));
	echo '</body></html>';
	exit;
}

?>

--- NEW FILE: optimiser.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_OPTIMISER")) return;
define("_ECRIRE_OPTIMISER", "1");


function optimiser_base() {
	spip_log ("optimisation de la base");

	$mydate = date("YmdHis", time() - 24 * 3600);

	//
	// Rubriques
	//

	$query = "SELECT id_rubrique FROM spip_rubriques";
	$result = spip_query($query);
	$rubriques = '0';
	while ($row = spip_fetch_array($result)) $rubriques .= ','.$row['id_rubrique'];

	if ($rubriques) {
		$query = "DELETE FROM spip_articles WHERE id_rubrique NOT IN ($rubriques) AND maj < $mydate";
		spip_query($query);
		$query = "DELETE FROM spip_breves WHERE id_rubrique NOT IN ($rubriques) AND maj < $mydate";
		spip_query($query);
		$query = "DELETE FROM spip_forum WHERE id_rubrique NOT IN (0,$rubriques)";
		spip_query($query);
		$query = "DELETE FROM spip_auteurs_rubriques WHERE id_rubrique NOT IN ($rubriques)";
		spip_query($query);
		$query = "DELETE FROM spip_documents_rubriques WHERE id_rubrique NOT IN ($rubriques)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_rubriques WHERE id_rubrique NOT IN ($rubriques)";
		spip_query($query);
	}


	//
	// Articles
	//

	$query = "DELETE FROM spip_articles WHERE statut='poubelle' AND maj < $mydate";
	spip_query($query);
	$query = "SELECT id_article FROM spip_articles";
	$result = spip_query($query);
	$articles = '0';
	while ($row = spip_fetch_array($result)) $articles .= ','.$row['id_article'];

	if ($articles) {
		$query = "DELETE FROM spip_auteurs_articles WHERE id_article NOT IN ($articles)";
		spip_query($query);
		$query = "DELETE FROM spip_documents_articles WHERE id_article NOT IN ($articles)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_articles WHERE id_article NOT IN ($articles)";
		spip_query($query);
		$query = "DELETE FROM spip_forum WHERE id_article NOT IN (0,$articles)";
		spip_query($query);
	}


	//
	// Breves
	//

	$query = "DELETE FROM spip_breves WHERE statut='refuse' AND maj < $mydate";
	spip_query($query);
	$breves = '0';
	$query = "SELECT id_breve FROM spip_breves";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $breves .= ','.$row['id_breve'];

	if ($breves) {
		$query = "DELETE FROM spip_documents_breves WHERE id_breve NOT IN ($breves)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_breves WHERE id_breve NOT IN ($breves)";
		spip_query($query);
		$query = "DELETE FROM spip_forum WHERE id_breve NOT IN (0,$breves)";
		spip_query($query);
	}


	//
	// Sites
	//

	$query = "DELETE FROM spip_syndic WHERE maj < $mydate AND statut = 'refuse'";
	spip_query($query);

	$syndic = '0';
	$query = "SELECT id_syndic FROM spip_syndic";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $syndic .= ','.$row['id_syndic'];

	if ($syndic) {
		$query = "DELETE FROM spip_syndic_articles WHERE id_syndic NOT IN (0,$syndic)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_syndic WHERE id_syndic NOT IN ($syndic)";
		spip_query($query);
		$query = "DELETE FROM spip_forum WHERE id_syndic NOT IN (0,$syndic)";
		spip_query($query);
	}


	//
	// Auteurs
	//

	$auteurs = '0';
	$query = "SELECT id_auteur FROM spip_auteurs";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $auteurs .= ','.$row['id_auteur'];

	if ($auteurs) {
		$query = "DELETE FROM spip_auteurs_articles WHERE id_auteur NOT IN ($auteurs)";
		spip_query($query);
		$query = "DELETE FROM spip_auteurs_messages WHERE id_auteur NOT IN ($auteurs)";
		spip_query($query);
		$query = "DELETE FROM spip_auteurs_rubriques WHERE id_auteur NOT IN ($auteurs)";
		spip_query($query);
	}

	$query = "SELECT id_auteur,nom,email FROM spip_auteurs WHERE statut='5poubelle' AND maj < $mydate";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$id_auteur = $row['id_auteur'];
		$nom = $row['nom'];
		$email = $row['email'];

		$query2 = "SELECT * FROM spip_auteurs_articles WHERE id_auteur=$id_auteur";
		$result2 = spip_query($query2);
		if (!spip_num_rows($result2)) {
			$query3 = "DELETE FROM spip_auteurs WHERE id_auteur=$id_auteur";
			$result3 = spip_query($query3);
			spip_log ("suppression auteur $id_auteur ($nom, $email)");
		}
	}


	//
	// Messages prives
	//

	$query = "SELECT m.id_message FROM spip_messages AS m, spip_auteurs_messages AS lien ".
		"WHERE m.id_message = lien.id_message GROUP BY m.id_message";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $messages[] = $row['id_message'];

	$query = "SELECT id_message FROM spip_messages ".
		"WHERE type ='affich'";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $messages[] = $row['id_message'];

	if ($messages) {
		$messages = join(",", $messages);

		$query = "DELETE FROM spip_messages WHERE id_message NOT IN ($messages)";
		spip_query($query);
		$query = "DELETE FROM spip_forum WHERE id_message NOT IN (0,$messages)";
		spip_query($query);
	}


	//
	// Mots-cles
	//

	$query = "DELETE FROM spip_mots WHERE titre='' AND maj < $mydate";
	$result = spip_query($query);

	$mots = '0';
	$query = "SELECT id_mot FROM spip_mots";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $mots .= ','.$row['id_mot'];

	if ($mots) {
		$query = "DELETE FROM spip_mots_articles WHERE id_mot NOT IN ($mots)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_breves WHERE id_mot NOT IN ($mots)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_forum WHERE id_mot NOT IN ($mots)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_rubriques WHERE id_mot NOT IN ($mots)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_syndic WHERE id_mot NOT IN ($mots)";
		spip_query($query);
	}


	// 
	// Documents
	//

/*
	$query = "SELECT id_document FROM spip_documents_articles";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_document'];
	$query = "SELECT id_document FROM spip_documents_rubriques";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_document'];
	$query = "SELECT id_document FROM spip_documents_breves";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_document'];
	$query = "SELECT DISTINCT id_vignette FROM spip_documents WHERE id_vignette != 0";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_vignette'];
	
	if ($documents) {
		$documents = join(",", $documents);

		$query = "SELECT id_document, fichier FROM spip_documents WHERE id_document NOT IN ($documents)";
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$documents_poubelle[] = $row['id_document'];
			$fichiers_poubelle[] = $row['fichier'];
		}

		if ($documents_poubelle) {
			$documents_poubelle = join(",", $documents_poubelle);

			$fichier = _DIR_RESTEINT_ABS .'data/.poubelle';
			if (!$f = @fopen($fichier, 'a')) {
				spip_log("impossible d'ecrire dans $fichier !");
				@unlink($fichier);	// on essaie de forcer
				$f = @fopen($fichier, 'a');
			}
			spip_log("mise a la poubelle : ".join(", ", $fichiers_poubelle));
			$ok = fputs($f, join("\n", $fichiers_poubelle)."\n");
			fclose($f);
			if ($ok) {
				$query = "DELETE FROM spip_documents WHERE id_document IN ($documents_poubelle)";
				spip_query($query);
			}
		}
	}
*/

	//
	// Forums
	//

	$query = "DELETE FROM spip_forum WHERE statut='redac' AND maj < $mydate";
	spip_query($query);

	$forums = '0';
	$query = "SELECT id_forum FROM spip_forum";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $forums .= ','.$row[0];

	if ($forums) {
		$query = "DELETE FROM spip_forum WHERE id_parent NOT IN (0,$forums)";
		spip_query($query);
		$query = "DELETE FROM spip_mots_forum WHERE id_forum NOT IN ($forums)";
		spip_query($query);
	}


	//
	// Indexation
	//

	// les objets inutiles
	$types = array('article','auteur','breve','mot','rubrique','forum','signature','syndic');
	while (list(,$type) = each($types)) {
		$table_objet = 'spip_'.table_objet($type);
		$table_index = 'spip_index_'.table_objet($type);
		
		// limiter aux objets publies
		switch ($type) {
			case 'article':
			case 'breve':
			case 'rubrique':
			case 'syndic':
			case 'forum':
			case 'signature':
				$critere = "AND statut<>'publie'";
				break;
			case 'auteur':
				$critere = "AND statut NOT IN ('0minirezo', '1comite')";
				break;
			case 'mot':
			default:
				$critere = 'AND 1=0';	// ne jamais desindexer un mot
				break;
		}

		spip_query("UPDATE $table_objet SET idx='' WHERE idx<>'non' $critere");

		$suppr = '';
		$s = spip_query("SELECT id_$type FROM $table_objet WHERE idx='' $critere");
		while ($t = spip_fetch_array($s))
			$suppr .= ','.$t[0];
		$s = spip_query("SELECT id_$type FROM $table_objet WHERE idx='non'");
		while ($t = spip_fetch_array($s))
			$suppr .= ','.$t[0];
		if ($suppr)
			spip_query("DELETE FROM $table_index WHERE id_$type IN (0$suppr)");
	}

/*
	// les objets supprimes
	$hash = array();
	$types = array('article','auteur','breve','mot','rubrique','forum','signature','syndic');
	while (list(,$type) = each($types)) {
		$table_objet = 'spip_'.table_objet($type);
		$table_index = 'spip_index_'.table_objet($type);
		$list_objets = table_objet($type);
		if ($liste = $$list_objets)
			spip_query("DELETE FROM $table_index WHERE id_$type NOT IN ($liste)");
		$s = spip_query("SELECT DISTINCT(hash) FROM $table_index");
		while ($t = spip_fetch_array($s))
			$hash[$t[0]] = $t[0];
	}
	if (count($hash)) {
		$s = spip_query("SELECT hash FROM spip_index_dico");
		$suppr = '';
		while ($t = spip_fetch_array($s))
			if (!$hash[$t[0]]) $suppr.=','.$t[0];
		if ($suppr)
			spip_query("DELETE FROM spip_index_dico WHERE hash IN (0$suppr)");	
	}
*/

	//
	// MySQL
	//
	if ($GLOBALS['table_prefix']) $table_pref = $GLOBALS['table_prefix']."_";
	else $table_pref = "";

	$query = "SHOW TABLES LIKE '$table_pref%'";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $tables[] = $row[0];

	if ($tables) {
		$tables = join(",", $tables);
		$query = "OPTIMIZE TABLE ".$tables;
		spip_query($query);
	}

	spip_log("optimisation ok");
}

optimiser_base();

?>

--- NEW FILE: calendrier.php3 ---
<?php

if (isset($HTTP_GET_VARS['type']))
{
	if ($HTTP_GET_VARS['type'] == 'semaine')
		{ include ("calendrier_semaine.php3");exit;}
	else if ($HTTP_GET_VARS['type'] == 'jour')
		{ include ("calendrier_jour.php3");exit;}
}
include ("inc.php3");
include_ecrire ("inc_calendrier.php");

$today=getdate(time());

// sans arguments => mois courant
if (!$mois){$annee=$today["year"];$mois=$today["mon"]; }
$periode = $annee . '-' . sprintf("%02d", $mois) . '-01';

$afficher_bandeau_calendrier = true;

debut_page(_T('titre_page_calendrier',
	      array('nom_mois' => nom_mois($periode), 'annee' => $annee)), 
	   "redacteurs", 
	   "calendrier");

echo http_calendrier_tout($mois,$annee, '01', '31');
?>

--- NEW FILE: inc_carto.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_CARTE")) return;
define("_ECRIRE_INC_CARTE", "1");

function embed_map_url($id_carte, $url_parse) {
	$lURL = $url_parse['path']."/carto.php3?id_carte=".$id_carte."&scale=".$_GET['scale']."&x=".$_GET['x']."&y=".$_GET['y'];
	return $lURL;
}

function afficher_cartes($titre_table, $requete, $icone = '') {
	global $couleur_claire, $couleur_foncee;
	global $connect_id_auteur;

	$tranches = afficher_tranches_requete($requete, 3);
	if (!$icone) $icone = "carte-24.gif";

	if ($tranches) {
		if ($titre_table) echo "<div style='height: 12px;'></div>";
		echo "<div class='liste'>";
		bandeau_titre_boite2($titre_table, $icone, $couleur_claire, "black");
		echo "<table width='100%' cellpadding='3' cellspacing='0' border='0'>";

		echo $tranches;

	 	$result = spip_query($requete);
		$num_rows = spip_num_rows($result);

		$ifond = 0;
		$premier = true;
		
		$compteur_liste = 0;
		while ($row = spip_fetch_array($result)) {
			$vals = '';
			$id_carte= $row['id_carte'];
			$objets= $row['objets'];
			$titre = $row['titre'];
			
			$tous_id[] = $id_carte;

			$link = new Link("carte_edit.php3");
			$link->addVar("id_carte", $id_carte);
			$link->addVar("retour", $GLOBALS['clean_link']->getUrl());
			if ($objets) {
				$puce = 'puce-verte-breve.gif';
			}
			else {
				$puce = 'puce-orange-breve.gif';
			}

			$s = "<a href=\"".$link->getUrl()."\">";
			$s .= "<img src='img_pack/$puce' width='7' height='7' border='0'>&nbsp;&nbsp;";
			$s .= typo($titre);
			$s .= "</a> &nbsp;&nbsp;";
			$vals[] = $s;
			
			$s = "";
			$vals[] = $s;

			$s = "";
			if ($reponses) {
				$s .= $reponses." "._L("r&eacute;ponses");
			}
			$vals[] = $s;
			$table[] = $vals;
		}
		spip_free_result($result);
		
		$largeurs = array('','','');
		$styles = array('arial11', 'arial1', 'arial1');
		afficher_liste($largeurs, $table, $styles);
		echo "</table>";
		echo "</div>\n";
	}
	return $tous_id;
}

function afficher_carte_inteface($fichier,$id_carte,$width,$height) {
	$returned='<script type="text/javascript" src="js/x_core_nn4.js"></script>
<script type="text/javascript" src="js/x_dom_nn4.js"></script>
<script type="text/javascript" src="js/x_event_nn4.js"></script>
<script type="text/javascript" src="js/navTools.js"></script>
<script type="text/javascript" src="js/graphTools.js"></script>
<script type="text/javascript">
/*<![CDATA[*/ 
    var dhtmlDivs = new String();
    document.image = new Image;
    document.image.src = \''.$fichier.'\';
    
    if (xIE) {
      dhtmlDivs = \'<div id="mapImageDiv" class="dhtmldiv" style="background-image:url(\'; 
      dhtmlDivs += document.image.src;
      dhtmlDivs += \');visibility:hidden;background-repeat:no-repeat;"></div>\';
    } else {
      dhtmlDivs = \'<div id="mapImageDiv" class="dhtmldiv" style="visibility:hidden"><img \';
      
      dhtmlDivs += \'src="\' + document.image.src + \'" alt="Main map" title="" \';
      dhtmlDivs += \'width="'.$width.'px" height="'.$height.'px" /></div>\';
      
    }
    dhtmlDivs += \'<div id="myCanvasDiv" class="dhtmldiv"></div>\';
    dhtmlDivs += \'<div id="myCanvas2Div" class="dhtmldiv"></div>\';
    dhtmlDivs += \'<div id="mainDHTMLDiv" class="dhtmldiv"></div>\';
    dhtmlDivs += \'<div id="diplayContainerDiv" class="dhtmldiv">\';
    dhtmlDivs += \'<table border="0" width="100%" cellspacing="0" cellpadding="0"><tr>\';
    dhtmlDivs += \'<td width="50%"><div id="displayCoordsDiv" class="dhtmlDisplay"></div></td>\';
    dhtmlDivs += \'<td align="right" width="50%"><div id="displayMeasureDiv" class="dhtmlDisplay"></div></td>\';
    dhtmlDivs += \'</tr></table></div>\';
    document.write(dhtmlDivs);
                  
    function dboxInit()
    {
      myform = document.forms[\'carto_form\'];
      // DHTML drawing and navigating tools
      dhtmlBox = new dhtmlBox();
          
      //DHTML parameters
      dhtmlBox.dispPos = \'bottom\';
      dhtmlBox.thickness = 2;
      dhtmlBox.cursorsize = 4;
      dhtmlBox.jitter = 10; // minimum size of a box dimension
      dhtmlBox.d2pts = 3;   // the distance between two points (measure tools);
      dhtmlBox.nbPts = 5;   // number of points for the last vertex
      
      // map units values
	  // dynamically given by the server
      dhtmlBox.mapHeight = 300;
      dhtmlBox.boxx = 470000;
      dhtmlBox.boxy = 46300;
      dhtmlBox.pixel_size = 924.83333333334;
      dhtmlBox.dist_msg = \'Approx. distance: \';
      dhtmlBox.dist_unit = \' m.\';
      dhtmlBox.surf_msg = \'Approx. surface: \';
      dhtmlBox.surf_unit = \' m??.\';
      dhtmlBox.coord_msg = \'Coords (m): \';
  
          
      dhtmlBox.initialize();
    }
      
    window.onload = function() {
      dboxInit();
      xHide(xGetElementById(\'mapAnchorDiv\')); 
    }
	/*]]>*/
  </script>
<form method="get" action="#" name="carto_form">
  <table>
    <tr> 
      <td> <input type="hidden" name="id_carte" value="'.$id_carte.'"/> <input type="hidden" name="selection_type" /> <input type="hidden" name="selection_coords" /> 
        <div id="mapAnchorDiv" style="position:relative; width:'.$width.'px; height:'.$height.'px;"> 
          <table>
            <tr> 
              <td align="center" valign="middle" width="'.$width.'px" height="'.$height.'px"><div id="loadbar">Loading 
                  message</div></td>
            </tr>
          </table>
        </div></td>
      <td> <p> 
          <!-- input value use : shapeType,action,cursorStyle,toolName (with no blank spaces!)-->
          <input type="radio" name="tool" value="rectangle,submit,crossHair,zoom_in"  checked="checked"  id="zoom_in" onclick="dhtmlBox.changeTool()" />
          zoom_in<br />
          <input type="radio" name="tool" value="point,submit,crossHair,zoom_out"  id="zoom_out" onclick="dhtmlBox.changeTool()" />
          zoom out<br />
          <input type="radio" name="tool" value="pan,submit,move,pan"  id="pan" onclick="dhtmlBox.changeTool()" />
          pan<br />
          <input type="radio" name="tool" value="rectangle,submit,help,query"  id="query" onclick="dhtmlBox.changeTool()" />
          query<br />
          <input type="radio" name="tool" value="point,submit,crossHair,point"   id="point" onclick="dhtmlBox.changeTool()" />
          line submit<br />
          <input type="radio" name="tool" value="line,submit,crossHair,line"   id="line" onclick="dhtmlBox.changeTool()" />
          line submit<br />
          <input type="radio" name="tool" value="polygon,submit,crossHair,polygon"   id="toto" onclick="dhtmlBox.changeTool()" />
          polygon submit<br />
        </p></td>
    </tr>
  </table>
</form>';
	return $returned;
}
function carte_editable() {
	return true;
}
function carte_administrable() {
	return true;
}
//
// Afficher un pave cartes dans la colonne de gauche
// (edition des articles)

function afficher_insertion_carte($id_article) {
	global $connect_id_auteur, $connect_statut;
	global $couleur_foncee, $couleur_claire, $options;
	global $spip_lang_left, $spip_lang_right;
	global $clean_link;

	// Ajouter une carte
	echo "\n<p>";
	debut_cadre_relief("carte-24.gif", false);

	echo "<div style='padding: 2px; background-color: $couleur_claire; text-align: center; color: black;'>";
	echo bouton_block_invisible("ajouter_carte");
	echo "<strong class='verdana3' style='text-transform: uppercase;'>"
		._L("Ins&eacute;rer une carte")."</strong>";
	echo "</div>\n";

	echo debut_block_invisible("ajouter_carte");
	echo "<div class='verdana2'>";
	echo _L("Vous pouvez ins&eacute;rer des cartes dans vos articles. Choisissez une ".
		"carte dans la liste ci-dessous et recopiez le raccourci dans le texte ".
		"de l'article.");
	echo "</div>";

	$query = "SELECT id_carte, titre FROM spip_carto_carte ORDER BY titre";
	$result = spip_query($query);
	if (spip_num_rows($result)) {
		echo "<br />\n";
		echo "<div class='bandeau_rubriques' style='z-index: 1;'>";
		echo "<div class='plan-articles'>";
		while ($row = spip_fetch_array($result)) {
			$id_carte = $row['id_carte'];
			$titre = typo($row['titre']);
			
			$link = new Link("carte_edit.php3");
			$link->addVar("id_carte", $id_carte);
			$link->addVar("retour", $GLOBALS['clean_link']->getUrl());
			echo "<a href='".$link->getUrl()."'>";
			echo $titre."</a>\n";
			echo "<div class='arial1' align='$spip_lang_right' style='color: black; padding-$spip_lang_left: 4px;' ".
				"title=\""._L("Recopiez ce raccourci dans le texte de l'article pour ins&eacute;rer ce formulaire.").
				"\">";
			echo "<font color='333333'><div align='left'>&lt;map$id_carte|left&gt;</div><div align='center'>&lt;map$id_carte|center&gt;</div><div align='right'>&lt;map$id_carte|right&gt;</div></font>\n";
			echo "</div>";
		}
		echo "</div>";
		echo "</div>";
	}

	// Creer une carte
	if (carte_editable()) {
		echo "\n<br />";
		$link = new Link("carte_edit.php3?new=oui");
		$link->addVar('retour', $GLOBALS['clean_link']->getUrl());
		icone_horizontale(_L("Cr&eacute;er une nouvelle carte"),
			$link->getUrl(), "carte-24.png", "creer.gif");
	}

	echo fin_block();

	fin_cadre_relief();
}

?>

--- NEW FILE: spip_style_print.css ---
body {
	color: #000000;
	background-color: #FFFFFF;
	font-family: Verdana, Geneva, Arial, Helvetica;
	font-size: 12px;
	margin: 0px;
	padding: 0px;
}

#haut-page, .colonne_etroite {
	display: none;
}

--- NEW FILE: forum.php3 ---
<?php

include ("inc.php3");

// cette page gere les deux types de forums ; forum_admin.php3 n'est qu'une coquille vide
if ($admin=='oui') {
	debut_page(_T('titre_page_forum'), "redacteurs", "privadm");
	$statutforum = 'privadm';
	$logo = "forum-admin-24.gif";
	$urlforum = 'forum_admin.php3';
} else {
	debut_page(_T('titre_forum'), "redacteurs", "forum-interne");
	$statutforum = 'privrac';
	$logo = "forum-interne-24.gif";
	$urlforum = 'forum.php3';
}

debut_gauche();


//
// Raccourcis
//
/*
	debut_raccourcis();
	// rien
	fin_raccourcis();
*/


debut_droite();

if ($admin=='oui')
	gros_titre(_T('titre_cadre_forum_administrateur'));
else
	gros_titre(_T('titre_cadre_forum_interne'));

if ($admin == 'oui' AND $connect_statut != "0minirezo") {
	echo _T('avis_non_acces_page');
	exit;
}

echo "<div class='serif2'>";

if (!$debut) $debut = 0;

$query_forum = "SELECT COUNT(*) AS cnt FROM spip_forum WHERE statut='$statutforum' AND id_parent=0";
$result_forum = spip_query($query_forum);
$total = 0;
if ($row = spip_fetch_array($result_forum)) $total = $row['cnt'];

if ($total > 10) {
	echo "<p>";
	for ($i = 0; $i < $total; $i = $i + 10){
		if ($i > 0) echo " | ";
		if ($i == $debut)
			echo "<FONT SIZE=3><B>$i</B></FONT>";
		else
			echo "<A HREF='$urlforum?debut=$i'>$i</A>";
	}
}



echo "<p><div align='center'>";
icone (_T('icone_poster_message'), "forum_envoi.php3?statut=$statutforum&adresse_retour=$urlforum&titre_message=".urlencode(filtrer_entites(_T('texte_nouveau_message'))), $logo, "creer.gif");
echo "</div>";


echo "<P align='left'>";

$query_forum="SELECT * FROM spip_forum WHERE statut='$statutforum' AND id_parent=0 ORDER BY date_heure DESC LIMIT $debut,10";
$result_forum=spip_query($query_forum);

afficher_forum($result_forum,$urlforum);

echo "</div>";


fin_page();

?>


--- NEW FILE: statistiques_svg.php3 ---
<?php
include ("inc.php3");
include_ecrire("inc_charsets.php3");

// Gestion d'expiration de ce jaja
$date = date("U");
$expire = $date + 2 * 3600;
$headers_only = http_last_modified($expire);

$date = gmdate("D, d M Y H:i:s", $date);
$expire = gmdate("D, d M Y H:i:s", $expire);
@Header ("Content-Type: text/javascript");
if ($headers_only) exit;
@Header ("Last-Modified: ".$date." GMT");
@Header ("Expires: ".$expire." GMT");




if ($connect_statut != '0minirezo') {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}


header("Content-type: image/svg+xml");
echo "<?xml version=\"1.0\" standalone=\"no\"?>";

?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN"
        "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg width="450" height="310" x="0" y="0">


<defs>
<linearGradient id="orange_red" x1="0%" y1="0%" x2="0%" y2="150%">
<stop offset="0%" style="stop-color:rgb(255,255,0); stop-opacity:1"/>
<stop offset="100%" style="stop-color:rgb(255,0,0); stop-opacity:1"/>
</linearGradient>
</defs>
<?php
	echo "<defs>\n";
	echo '<linearGradient id="claire" x1="0%" y1="0%" x2="0%" y2="100%">';
	echo '<stop offset="0%" style="stop-color:'.$couleur_claire.'; stop-opacity:0.3"/>';
	echo '<stop offset="100%" style="stop-color:'.$couleur_foncee.'; stop-opacity:1"/>';
	echo "</linearGradient>\n";
	echo "</defs>\n";
	
	echo "<style type='text/css'>\n";
	echo ".gris {fill: #aaaaaa; fill-opacity: 0.2;}\n";
	echo ".trait {stroke:black;stroke-width:1;}\n";
	echo "</style>\n";



	if (!$aff_jours) $aff_jours = 105;
	if ($id_article) {
		$table = "spip_visites_articles";
		$table_ref = "spip_referers_articles";
		$where = "id_article=$id_article";
	} else {
		$table = "spip_visites";
		$table_ref = "spip_referers";
		$where = "1";
	}

	// Recuperer premier jour
	$query="SELECT UNIX_TIMESTAMP(date) AS date_unix FROM $table ".
		"WHERE $where ORDER BY date LIMIT 0,1";
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$date_premier = $row['date_unix'];
	}
	
	// Recuperer toutes visites
	$query="SELECT UNIX_TIMESTAMP(date) AS date_unix, visites FROM $table ".
		"WHERE $where AND date > DATE_SUB(NOW(),INTERVAL $aff_jours DAY) ORDER BY date";
	$result=spip_query($query);

	while ($row = spip_fetch_array($result)) {
		$date = $row['date_unix'];
		$visites = $row['visites'];

		$log[$date] = $visites;
		if ($i == 0) $date_debut = $date;
		$i++;
	}
	


	if (count($log)>0) {
		$max = max(max($log),$visites_today);
		$date_today = time();
		$nb_jours = floor(($date_today-$date_debut)/(3600*24));
		
		$maxgraph = substr(ceil(substr($max,0,2) / 10)."000000000000", 0, strlen($max));
	
		if ($maxgraph < 10) $maxgraph = 10;
		if (1.1 * $maxgraph < $max) $maxgraph.="0";	
		if (0.8*$maxgraph > $max) $maxgraph = 0.8 * $maxgraph;
		$rapport = 300 / $maxgraph;

		if (count($log) < 420) $largeur = floor(420 / ($nb_jours+1));
		if ($largeur < 1) {
			$largeur = 1;
			$agreg = ceil(count($log) / 420);	
		} else {
			$agreg = 1;
		}
		if ($largeur > 50) $largeur = 50;

		$largeur_abs = 420 / $aff_jours;
		
		if ($largeur_abs > 1) {
			$inc = ceil($largeur_abs / 5);
			$aff_jours_plus = 420 / ($largeur_abs - $inc);
			$aff_jours_moins = 420 / ($largeur_abs + $inc);
		}
		
		if ($largeur_abs == 1) {
			$aff_jours_plus = 840;
			$aff_jour_moins = 210;
		}
		
		if ($largeur_abs < 1) {
			$aff_jours_plus = 420 * ((1/$largeur_abs) + 1);
			$aff_jours_moins = 420 * ((1/$largeur_abs) - 1);
		}


		echo "<line x1='0' y1='75' x2='".round($largeur*$nb_jours/$agreg)."' y2='75' style='stroke:#999999;stroke-width:1'/>\n";
		echo "<line x1='0' y1='150' x2='".round($largeur*$nb_jours/$agreg)."' y2='150' style='stroke:#999999;stroke-width:1'/>\n";
		echo "<line x1='0' y1='225' x2='".round($largeur*$nb_jours/$agreg)."' y2='225' style='stroke:#999999;stroke-width:1'/>\n";
		
		echo "<line x1='0' y1='37' x2='".round($largeur*$nb_jours/$agreg)."' y2='37' style='stroke:#eeeeee;stroke-width:1'/>\n";
		echo "<line x1='0' y1='112' x2='".round($largeur*$nb_jours/$agreg)."' y2='112' style='stroke:#eeeeee;stroke-width:1'/>\n";
		echo "<line x1='0' y1='187' x2='".round($largeur*$nb_jours/$agreg)."' y2='187' style='stroke:#eeeeee;stroke-width:1'/>\n";
		echo "<line x1='0' y1='262' x2='".round($largeur*$nb_jours/$agreg)."' y2='262' style='stroke:#eeeeee;stroke-width:1'/>\n";


		// Presentation graphique
		while (list($key, $value) = each($log)) {
			
			$test_agreg ++;
	
			if ($test_agreg == $agreg) {	
			
			$test_agreg = 0;
			$n++;
		
			if ($decal == 30) $decal = 0;
			$decal ++;
			$tab_moyenne[$decal] = $value;
		
			// Inserer des jours vides si pas d'entrees	
			if ($jour_prec > 0) {
				$ecart = floor(($key-$jour_prec)/((3600*24)*$agreg)-1);
	
				for ($i=0; $i < $ecart; $i++){
					if ($decal == 30) $decal = 0;
					$decal ++;
					$tab_moyenne[$decal] = $value;

                    $ce_jour=date("Y-m-d", $jour_prec+(3600*24*($i+1)));
			        $jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);

					reset($tab_moyenne);
					$moyenne = 0;
					while (list(,$val_tab) = each($tab_moyenne))
						$moyenne += $val_tab;
					$moyenne = $moyenne / count($tab_moyenne);
	
				//	echo "<td valign='bottom' width=$largeur>";
					$difference = ($hauteur_moyenne) -1;
					$moyenne = round($moyenne,2); // Pour affichage harmonieux
					$hauteur_moyenne = round(($moyenne) * $rapport) - 1;


					if ($hauteur_moyenne_prec > 0) {
						echo "<polygon points = '".(($n-2)*$largeur+round($largeur/2)).",300 ".(($n-2)*$largeur+round($largeur/2)).",".(300-$hauteur_moyenne_prec)." ".(($n-1)*$largeur+round($largeur/2)).",".(300-$hauteur_moyenne)."  ".(($n-1)*$largeur+round($largeur/2)).",300' class='gris' />\n";
						echo "<line x1='".(($n-2)*$largeur+round($largeur/2))."' y1='".(300-$hauteur_moyenne_prec)."' x2='".(($n-1)*$largeur+round($largeur/2))."' y2='".(300-$hauteur_moyenne)."' class='trait' />\n";
					}

					$hauteur_moyenne_prec = $hauteur_moyenne;


					if ($difference > 0) {	
						//echo "<img src='" . _DIR_IMG_PACK . "rien.gif' width=$largeur height=1 style='background-color:#333333;' title=$tagtitle>";
						//echo "<img src='" . _DIR_IMG_PACK . "rien.gif' width=$largeur height=$hauteur_moyenne title=$tagtitle>";
					}
					//echo "<img src='" . _DIR_IMG_PACK . "rien.gif' width=$largeur height=1 style='background-color:black;' title=$tagtitle>";
					//echo "</td>";
					$n++;
				}
			}

			$ce_jour=date("Y-m-d", $key);
			$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);

			$total_loc = $total_loc + $value;
			reset($tab_moyenne);

			$moyenne = 0;
			while (list(,$val_tab) = each($tab_moyenne))
				$moyenne += $val_tab;
			$moyenne = $moyenne / count($tab_moyenne);
		
			$hauteur_moyenne = round($moyenne * $rapport) - 1;
			$hauteur = round($value * $rapport) - 1;
			$moyenne = round($moyenne,2); // Pour affichage harmonieux
			//echo "<td valign='bottom' width=$largeur>";

//			$tagtitle='"'.attribut_html(supprimer_tags("$jour | "
//			._T('info_visites')." ".$value)).'"';



			if (date("w",$key) == "0") // Dimanche en couleur foncee
				$fill = $couleur_foncee;
			else 
				$fill = "url(#claire)";



			echo "<rect x='".(($n-1)*$largeur)."' y='".(300-$hauteur)."' width='$largeur' height='$hauteur' style='fill:$fill'/>\n";	
			echo "<rect x='".(($n-1)*$largeur)."' y='".(300-$hauteur)."' width='$largeur' height='1' style='fill:$couleur_foncee;'/>\n";	

			if (date("d", $key) == "1") 
				echo "<line x1='".(($n-1)*$largeur)."' y1='".(300-$hauteur_moyenne)."' x2='".(($n-1)*$largeur)."' y2='300' class='trait'/>\n";	
			
				
			if ($hauteur_moyenne_prec > 0) {
				echo "<polygon points = '".(($n-2)*$largeur+round($largeur/2)).",300 ".(($n-2)*$largeur+round($largeur/2)).",".(300-$hauteur_moyenne_prec)." ".(($n-1)*$largeur+round($largeur/2)).",".(300-$hauteur_moyenne)."  ".(($n-1)*$largeur+round($largeur/2)).",300' class='gris' />\n";
				echo "<line x1='".(($n-2)*$largeur+round($largeur/2))."' y1='".(300-$hauteur_moyenne_prec)."' x2='".(($n-1)*$largeur+round($largeur/2))."' y2='".(300-$hauteur_moyenne)."' class='trait' />\n";
			} else {
				echo "<polygon points = '0,300 0,".(300-$hauteur_moyenne)." ".(($n-1)*$largeur+round($largeur/2)).",".(300-$hauteur_moyenne)."  ".(($n-1)*$largeur+round($largeur/2)).",300' class='gris' />\n";
				echo "<line x1='0' y1='".(300-$hauteur_moyenne)."' x2='".(($n-1)*$largeur+round($largeur/2))."' y2='".(300-$hauteur_moyenne)."' class='trait' />\n";
			}
	
			$hauteur_moyenne_prec = $hauteur_moyenne;
			
				$jour_prec = $key;
				$val_prec = $value;
			}
		}


		echo "<rect x='0' y='0' width='".round($largeur*$nb_jours/$agreg)."' height='300' style='stroke-width: 1px; stroke: black; fill: blue; fill-opacity: 0; '/>\n";	

		echo " <text x='".(round($largeur*$nb_jours/$agreg)+3)."' y='300' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' >";
		echo "0";
		echo "</text>\n";
		echo " <text x='".(round($largeur*$nb_jours/$agreg)+3)."' y='228' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' >";
		echo round($maxgraph/4);
		echo "</text>\n";
		echo " <text x='".(round($largeur*$nb_jours/$agreg)+3)."' y='153' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' >";
		echo round($maxgraph/2);
		echo "</text>\n";
		echo " <text x='".(round($largeur*$nb_jours/$agreg)+3)."' y='78' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' >";
		echo round(3*$maxgraph/4);
		echo "</text>\n";
		echo " <text x='".(round($largeur*$nb_jours/$agreg)+3)."' y='8' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' >";
		echo round($maxgraph);
		echo "</text>\n";

		$gauche_prec = -50;
		for ($jour = $date_debut; $jour <= $date_today; $jour = $jour + (24*3600)) {
			$ce_jour = date("d", $jour);
			
			if ($ce_jour == "1") {
				$afficher = nom_mois(date("Y-m-d", $jour));
				if (date("m", $jour) == 1) $afficher = "<b>".annee(date("Y-m-d", $jour))."</b>";
				
			
				$gauche = ($jour - $date_debut) * $largeur / ((24*3600)*$agreg);
				
				if ($gauche - $gauche_prec >= 40 OR date("m", $jour) == 1) {									
					//echo "<div class='arial0' style='border-$spip_lang_left: 1px solid black; padding-$spip_lang_left: 2px; padding-top: 3px; position: absolute; $spip_lang_left: ".$gauche."px; top: -1px;'>".$afficher."</div>";

					echo "<rect x='$gauche' y='300' width='1' height='10' style='fill: black;'/>\n";
					echo " <text x='".($gauche+3)."' y='308' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' >";
					echo filtrer_ical($afficher);
					echo "</text>\n";


					$gauche_prec = $gauche;
					
					
					
				}
			}
		}


	}
	

		
?>


</svg>

<?php

?>
--- NEW FILE: js_menu_rubriques.php ---
<?php

include_once("inc.php3");

// Gestion d'expiration de ce jaja
$expire = $date + 3600*24;

$headers_only = http_last_modified($expire);

$date = gmdate("D, d M Y H:i:s", $date);
$expire = gmdate("D, d M Y H:i:s", $expire);
@Header ("Content-Type: text/javascript");
if ($headers_only) exit;
@Header ("Last-Modified: ".$date." GMT");
@Header ("Expires: ".$expire." GMT");

function extraire_article($id_p) {
	if (array_key_exists($id_p, $GLOBALS['db_art_cache'])) {
		return $GLOBALS['db_art_cache'][$id_p];
	} else {
		return array();
	}
}

function gen_liste_rubriques() {
	$q = "SELECT id_rubrique, id_parent, titre 
		FROM spip_rubriques 
		ORDER BY id_parent, titre";

	$res = spip_query($q);

	$GLOBALS['db_art_cache'] = array();
	if (spip_num_rows($res) > 0) { 
		while ($row = spip_fetch_array($res)) {
			$parent = $row['id_parent'];
			$id = $row['id_rubrique'];
			$GLOBALS['db_art_cache'][$parent][$id] = $row['titre'];
		}
	}
}


function bandeau_menu() {
	global $spip_ecran;

	gen_liste_rubriques(); 
	$arr_low = extraire_article(0);

	$i = sizeof($arr_low);

	$total_lignes = $i;
	if ($spip_ecran == "large") $max_lignes = 20;
	else $max_lignes = 15;

	$nb_col = ceil($total_lignes / $max_lignes);
	if ($nb_col < 1) $nb_col = 1;
	$max_lignes = ceil($total_lignes / $nb_col);

	$count_lignes = 0;

	if ($i > 0) {
		$ret = "<div>&nbsp;</div>";
		$ret .= "<div class='bandeau_rubriques' style='z-index: 1;'>";
		foreach( $arr_low as $id_rubrique => $titre_rubrique) {

			if ($count_lignes == $max_lignes) {
				$count_lignes = 0;
				$ret .= "</div></td><td valign='top' width='200'><div>&nbsp;</div><div class='bandeau_rubriques' style='z-index: 1;'>";
			}
			$count_lignes ++;

			$titre_rubrique = supprimer_numero(typo($titre_rubrique));
			$ret .= bandeau_rubrique($id_rubrique, $titre_rubrique, $i);
			$i = $i - 1;
		}
		$ret .= "</div>";
	}
	unset($GLOBALS['db_art_cache']); // On lib?re la m?moire
	return $ret;
}


function bandeau_rubrique($id_rubrique, $titre_rubrique, $z = 1) {
	global $zdecal;
	global $spip_ecran, $spip_display;
	global $spip_lang, $spip_lang_rtl, $spip_lang_left, $spip_lang_right;

	$titre_rubrique = preg_replace(',[\x00-\x1f]+,', ' ', $titre_rubrique);

	// Calcul du nombre max de sous-menus
	$zdecal = $zdecal + 1;
	if ($spip_ecran == "large") $zmax = 8;
	else $zmax= 6;
	
	// Limiter volontairement le nombre de sous-menus 
	$zmax = 6;

	if ($zindex < 1) $zindex = 1;
	if ($zdecal == 1) $image = "secteur-12.gif";
	//else $image = "rubrique-12.gif";
	else $image = '';
	
	if (strlen($image) > 1) $image = " style='background-image:url(" . _DIR_IMG_PACK . $image .");'";


	$arr_rub = extraire_article($id_rubrique);

	$i = sizeof($arr_rub);
	if ($i > 0 AND $zdecal < $zmax) {
		$ret .= '<div class=\"pos_r\" style=\"z-index: '.$z.';\" onMouseOver=\"montrer(\'b_'.$id_rubrique.'\');\" onMouseOut=\"cacher(\'b_'.$id_rubrique.'\');\">';
		$ret .= '<div class=\"brt\"><a href=\"naviguer.php3?id_rubrique='.$id_rubrique.'\" class=\"bandeau_rub\"'.$image.'>'.addslashes(supprimer_tags($titre_rubrique)).'</a></div>';
		$ret .= '<div class=\"bandeau_rub\" style=\"z-index: '.($z+1).';\" id=\"b_'.$id_rubrique.'\">';
		foreach( $arr_rub as $id_rub => $titre_rub) {
			$titre_rub = supprimer_numero(typo($titre_rub));
			$ret .= bandeau_rubrique($id_rub, $titre_rub, ($z+$i));
			$i = $i - 1;
		}
		$ret .= "</div></div>";
	} else {
		$ret .= '<div><a href=\"naviguer.php3?id_rubrique='.$id_rubrique.'\" class=\"bandeau_rub\"'.$image.'>'.addslashes(supprimer_tags($titre_rubrique)).'</a></div>';
	}
	$zdecal = $zdecal - 1;
	return $ret;
}

echo "document.write(\"";
echo "<table><tr><td valign='top' width='200'>";
echo bandeau_menu();
echo "</td></tr></table>";
echo "\");\n";

?>

--- NEW FILE: admin_repair.php3 ---
<?php

include ("inc_version.php3");

include_ecrire ("inc_admin.php3");
include_ecrire ("inc_texte.php3");
include_ecrire ("inc_presentation.php3");


/*
 * REMARQUE IMPORTANTE : SECURITE
 * Ce systeme de reparation doit pouvoir fonctionner meme si
 * la table spip_auteurs est en panne : on n'appelle donc pas
 * inc_auth ; seule l'authentification ftp est exigee
 *
 */

// include_ecrire ("inc_auth.php3");
$connect_statut = '0minirezo';


function verifier_base() {
	if (! $res1= spip_query("SHOW TABLES"))
		return false;

	while ($tab = spip_fetch_array($res1)) {
		echo "<p><b>".$tab[0]."</b> ";

		if (!($result_repair = spip_query("REPAIR TABLE ".$tab[0])))
			return false;

		if (!($result = spip_query("SELECT COUNT(*) FROM ".$tab[0])))
			return false;

		list($count) = spip_fetch_array($result);
		if ($count>1)
			echo "("._T('texte_compte_elements', array('count' => $count)).")\n";
		else if ($count==1)
			echo "("._T('texte_compte_element', array('count' => $count)).")\n";
		else
			echo "("._T('texte_vide').")\n";

		$row = spip_fetch_array($result_repair);
		$ok = ($row[3] == 'OK');

		if (!$ok)
			echo "<pre><font color='red'><b>".htmlentities(join("\n", $row))."</b></font></pre>\n";
		else
			echo " "._T('texte_table_ok')."<br>\n";

	}

	return true;
}

// verifier version MySQL
if (! $res1= spip_query("SELECT version()"))
	$message = _T('avis_erreur_connexion_mysql');
else {
	$tab = spip_fetch_array($res1);
	$version_mysql = $tab[0];
	if ($version_mysql < '3.23.14')
		$message = _T('avis_version_mysql', array('version_mysql' => $version_mysql));
	else {
		$message = _T('texte_requetes_echouent');
		$ok = true;
	}
}

$action = _T('texte_tenter_reparation');

if ($ok) {
	debut_admin($action, $message);

	install_debut_html(_T('texte_tentative_recuperation'));


	debut_cadre_relief();
	if (! verifier_base())
		echo "<br><br><font color='red'><b><tt>"._T('avis_erreur_mysql').' '.spip_sql_errno().': '.spip_sql_error() ."</tt></b></font><br><br>\n";
	fin_cadre_relief();
	echo "<br>";

	install_fin_html();

	fin_admin($action);
}
else {
	install_debut_html(_T('titre_reparation'));
	echo "<p>$message";
	install_fin_html();
}


?>

--- NEW FILE: gnu_lgpl_fr.txt ---
		  GNU LESSER GENERAL PUBLIC LICENSE
		       Version 2.1, February 1999

 Copyright (C) 1991, 1999 Free Software Foundation, Inc.
     59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

[This is the first released version of the Lesser GPL.  It also counts
 as the successor of the GNU Library Public License, version 2, hence
 the version number 2.1.]

			    Preamble

  The licenses for most software are designed to take away your
freedom to share and change it.  By contrast, the GNU General Public
Licenses are intended to guarantee your freedom to share and change
free software--to make sure the software is free for all its users.

  This license, the Lesser General Public License, applies to some
specially designated software packages--typically libraries--of the
Free Software Foundation and other authors who decide to use it.  You
can use it too, but we suggest you first think carefully about whether
this license or the ordinary General Public License is the better
strategy to use in any particular case, based on the explanations below.

  When we speak of free software, we are referring to freedom of use,
not price.  Our General Public Licenses are designed to make sure that
you have the freedom to distribute copies of free software (and charge
for this service if you wish); that you receive source code or can get
it if you want it; that you can change the software and use pieces of
it in new free programs; and that you are informed that you can do
these things.

  To protect your rights, we need to make restrictions that forbid
distributors to deny you these rights or to ask you to surrender these
rights.  These restrictions translate to certain responsibilities for
you if you distribute copies of the library or if you modify it.

  For example, if you distribute copies of the library, whether gratis
or for a fee, you must give the recipients all the rights that we gave
you.  You must make sure that they, too, receive or can get the source
code.  If you link other code with the library, you must provide
complete object files to the recipients, so that they can relink them
with the library after making changes to the library and recompiling
it.  And you must show them these terms so they know their rights.

  We protect your rights with a two-step method: (1) we copyright the
library, and (2) we offer you this license, which gives you legal
permission to copy, distribute and/or modify the library.

  To protect each distributor, we want to make it very clear that
there is no warranty for the free library.  Also, if the library is
modified by someone else and passed on, the recipients should know
that what they have is not the original version, so that the original
author's reputation will not be affected by problems that might be
introduced by others.

  Finally, software patents pose a constant threat to the existence of
any free program.  We wish to make sure that a company cannot
effectively restrict the users of a free program by obtaining a
restrictive license from a patent holder.  Therefore, we insist that
any patent license obtained for a version of the library must be
consistent with the full freedom of use specified in this license.

  Most GNU software, including some libraries, is covered by the
ordinary GNU General Public License.  This license, the GNU Lesser
General Public License, applies to certain designated libraries, and
is quite different from the ordinary General Public License.  We use
this license for certain libraries in order to permit linking those
libraries into non-free programs.

  When a program is linked with a library, whether statically or using
a shared library, the combination of the two is legally speaking a
combined work, a derivative of the original library.  The ordinary
General Public License therefore permits such linking only if the
entire combination fits its criteria of freedom.  The Lesser General
Public License permits more lax criteria for linking other code with
the library.

  We call this license the "Lesser" General Public License because it
does Less to protect the user's freedom than the ordinary General
Public License.  It also provides other free software developers Less
of an advantage over competing non-free programs.  These disadvantages
are the reason we use the ordinary General Public License for many
libraries.  However, the Lesser license provides advantages in certain
special circumstances.

  For example, on rare occasions, there may be a special need to
encourage the widest possible use of a certain library, so that it becomes
a de-facto standard.  To achieve this, non-free programs must be
allowed to use the library.  A more frequent case is that a free
library does the same job as widely used non-free libraries.  In this
case, there is little to gain by limiting the free library to free
software only, so we use the Lesser General Public License.

  In other cases, permission to use a particular library in non-free
programs enables a greater number of people to use a large body of
free software.  For example, permission to use the GNU C Library in
non-free programs enables many more people to use the whole GNU
operating system, as well as its variant, the GNU/Linux operating
system.

  Although the Lesser General Public License is Less protective of the
users' freedom, it does ensure that the user of a program that is
linked with the Library has the freedom and the wherewithal to run
that program using a modified version of the Library.

  The precise terms and conditions for copying, distribution and
modification follow.  Pay close attention to the difference between a
"work based on the library" and a "work that uses the library".  The
former contains code derived from the library, whereas the latter must
be combined with the library in order to run.

		  GNU LESSER GENERAL PUBLIC LICENSE
   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION

  0. This License Agreement applies to any software library or other
program which contains a notice placed by the copyright holder or
other authorized party saying it may be distributed under the terms of
this Lesser General Public License (also called "this License").
Each licensee is addressed as "you".

  A "library" means a collection of software functions and/or data
prepared so as to be conveniently linked with application programs
(which use some of those functions and data) to form executables.

  The "Library", below, refers to any such software library or work
which has been distributed under these terms.  A "work based on the
Library" means either the Library or any derivative work under
copyright law: that is to say, a work containing the Library or a
portion of it, either verbatim or with modifications and/or translated
straightforwardly into another language.  (Hereinafter, translation is
included without limitation in the term "modification".)

  "Source code" for a work means the preferred form of the work for
making modifications to it.  For a library, complete source code means
all the source code for all modules it contains, plus any associated
interface definition files, plus the scripts used to control compilation
and installation of the library.

  Activities other than copying, distribution and modification are not
covered by this License; they are outside its scope.  The act of
running a program using the Library is not restricted, and output from
such a program is covered only if its contents constitute a work based
on the Library (independent of the use of the Library in a tool for
writing it).  Whether that is true depends on what the Library does
and what the program that uses the Library does.
  
  1. You may copy and distribute verbatim copies of the Library's
complete source code as you receive it, in any medium, provided that
you conspicuously and appropriately publish on each copy an
appropriate copyright notice and disclaimer of warranty; keep intact
all the notices that refer to this License and to the absence of any
warranty; and distribute a copy of this License along with the
Library.

  You may charge a fee for the physical act of transferring a copy,
and you may at your option offer warranty protection in exchange for a
fee.

  2. You may modify your copy or copies of the Library or any portion
of it, thus forming a work based on the Library, and copy and
distribute such modifications or work under the terms of Section 1
above, provided that you also meet all of these conditions:

    a) The modified work must itself be a software library.

    b) You must cause the files modified to carry prominent notices
    stating that you changed the files and the date of any change.

    c) You must cause the whole of the work to be licensed at no
    charge to all third parties under the terms of this License.

    d) If a facility in the modified Library refers to a function or a
    table of data to be supplied by an application program that uses
    the facility, other than as an argument passed when the facility
    is invoked, then you must make a good faith effort to ensure that,
    in the event an application does not supply such function or
    table, the facility still operates, and performs whatever part of
    its purpose remains meaningful.

    (For example, a function in a library to compute square roots has
    a purpose that is entirely well-defined independent of the
    application.  Therefore, Subsection 2d requires that any
    application-supplied function or table used by this function must
    be optional: if the application does not supply it, the square
    root function must still compute square roots.)

These requirements apply to the modified work as a whole.  If
identifiable sections of that work are not derived from the Library,
and can be reasonably considered independent and separate works in
themselves, then this License, and its terms, do not apply to those
sections when you distribute them as separate works.  But when you
distribute the same sections as part of a whole which is a work based
on the Library, the distribution of the whole must be on the terms of
this License, whose permissions for other licensees extend to the
entire whole, and thus to each and every part regardless of who wrote
it.

Thus, it is not the intent of this section to claim rights or contest
your rights to work written entirely by you; rather, the intent is to
exercise the right to control the distribution of derivative or
collective works based on the Library.

In addition, mere aggregation of another work not based on the Library
with the Library (or with a work based on the Library) on a volume of
a storage or distribution medium does not bring the other work under
the scope of this License.

  3. You may opt to apply the terms of the ordinary GNU General Public
License instead of this License to a given copy of the Library.  To do
this, you must alter all the notices that refer to this License, so
that they refer to the ordinary GNU General Public License, version 2,
instead of to this License.  (If a newer version than version 2 of the
ordinary GNU General Public License has appeared, then you can specify
that version instead if you wish.)  Do not make any other change in
these notices.

  Once this change is made in a given copy, it is irreversible for
that copy, so the ordinary GNU General Public License applies to all
subsequent copies and derivative works made from that copy.

  This option is useful when you wish to copy part of the code of
the Library into a program that is not a library.

  4. You may copy and distribute the Library (or a portion or
derivative of it, under Section 2) in object code or executable form
under the terms of Sections 1 and 2 above provided that you accompany
it with the complete corresponding machine-readable source code, which
must be distributed under the terms of Sections 1 and 2 above on a
medium customarily used for software interchange.

  If distribution of object code is made by offering access to copy
from a designated place, then offering equivalent access to copy the
source code from the same place satisfies the requirement to
distribute the source code, even though third parties are not
compelled to copy the source along with the object code.

  5. A program that contains no derivative of any portion of the
Library, but is designed to work with the Library by being compiled or
linked with it, is called a "work that uses the Library".  Such a
work, in isolation, is not a derivative work of the Library, and
therefore falls outside the scope of this License.

  However, linking a "work that uses the Library" with the Library
creates an executable that is a derivative of the Library (because it
contains portions of the Library), rather than a "work that uses the
library".  The executable is therefore covered by this License.
Section 6 states terms for distribution of such executables.

  When a "work that uses the Library" uses material from a header file
that is part of the Library, the object code for the work may be a
derivative work of the Library even though the source code is not.
Whether this is true is especially significant if the work can be
linked without the Library, or if the work is itself a library.  The
threshold for this to be true is not precisely defined by law.

  If such an object file uses only numerical parameters, data
structure layouts and accessors, and small macros and small inline
functions (ten lines or less in length), then the use of the object
file is unrestricted, regardless of whether it is legally a derivative
work.  (Executables containing this object code plus portions of the
Library will still fall under Section 6.)

  Otherwise, if the work is a derivative of the Library, you may
distribute the object code for the work under the terms of Section 6.
Any executables containing that work also fall under Section 6,
whether or not they are linked directly with the Library itself.

  6. As an exception to the Sections above, you may also combine or
link a "work that uses the Library" with the Library to produce a
work containing portions of the Library, and distribute that work
under terms of your choice, provided that the terms permit
modification of the work for the customer's own use and reverse
engineering for debugging such modifications.

  You must give prominent notice with each copy of the work that the
Library is used in it and that the Library and its use are covered by
this License.  You must supply a copy of this License.  If the work
during execution displays copyright notices, you must include the
copyright notice for the Library among them, as well as a reference
directing the user to the copy of this License.  Also, you must do one
of these things:

    a) Accompany the work with the complete corresponding
    machine-readable source code for the Library including whatever
    changes were used in the work (which must be distributed under
    Sections 1 and 2 above); and, if the work is an executable linked
    with the Library, with the complete machine-readable "work that
    uses the Library", as object code and/or source code, so that the
    user can modify the Library and then relink to produce a modified
    executable containing the modified Library.  (It is understood
    that the user who changes the contents of definitions files in the
    Library will not necessarily be able to recompile the application
    to use the modified definitions.)

    b) Use a suitable shared library mechanism for linking with the
    Library.  A suitable mechanism is one that (1) uses at run time a
    copy of the library already present on the user's computer system,
    rather than copying library functions into the executable, and (2)
    will operate properly with a modified version of the library, if
    the user installs one, as long as the modified version is
    interface-compatible with the version that the work was made with.

    c) Accompany the work with a written offer, valid for at
    least three years, to give the same user the materials
    specified in Subsection 6a, above, for a charge no more
    than the cost of performing this distribution.

    d) If distribution of the work is made by offering access to copy
    from a designated place, offer equivalent access to copy the above
    specified materials from the same place.

    e) Verify that the user has already received a copy of these
    materials or that you have already sent this user a copy.

  For an executable, the required form of the "work that uses the
Library" must include any data and utility programs needed for
reproducing the executable from it.  However, as a special exception,
the materials to be distributed need not include anything that is
normally distributed (in either source or binary form) with the major
components (compiler, kernel, and so on) of the operating system on
which the executable runs, unless that component itself accompanies
the executable.

  It may happen that this requirement contradicts the license
restrictions of other proprietary libraries that do not normally
accompany the operating system.  Such a contradiction means you cannot
use both them and the Library together in an executable that you
distribute.

  7. You may place library facilities that are a work based on the
Library side-by-side in a single library together with other library
facilities not covered by this License, and distribute such a combined
library, provided that the separate distribution of the work based on
the Library and of the other library facilities is otherwise
permitted, and provided that you do these two things:

    a) Accompany the combined library with a copy of the same work
    based on the Library, uncombined with any other library
    facilities.  This must be distributed under the terms of the
    Sections above.

    b) Give prominent notice with the combined library of the fact
    that part of it is a work based on the Library, and explaining
    where to find the accompanying uncombined form of the same work.

  8. You may not copy, modify, sublicense, link with, or distribute
the Library except as expressly provided under this License.  Any
attempt otherwise to copy, modify, sublicense, link with, or
distribute the Library is void, and will automatically terminate your
rights under this License.  However, parties who have received copies,
or rights, from you under this License will not have their licenses
terminated so long as such parties remain in full compliance.

  9. You are not required to accept this License, since you have not
signed it.  However, nothing else grants you permission to modify or
distribute the Library or its derivative works.  These actions are
prohibited by law if you do not accept this License.  Therefore, by
modifying or distributing the Library (or any work based on the
Library), you indicate your acceptance of this License to do so, and
all its terms and conditions for copying, distributing or modifying
the Library or works based on it.

  10. Each time you redistribute the Library (or any work based on the
Library), the recipient automatically receives a license from the
original licensor to copy, distribute, link with or modify the Library
subject to these terms and conditions.  You may not impose any further
restrictions on the recipients' exercise of the rights granted herein.
You are not responsible for enforcing compliance by third parties with
this License.

  11. If, as a consequence of a court judgment or allegation of patent
infringement or for any other reason (not limited to patent issues),
conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot
distribute so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you
may not distribute the Library at all.  For example, if a patent
license would not permit royalty-free redistribution of the Library by
all those who receive copies directly or indirectly through you, then
the only way you could satisfy both it and this License would be to
refrain entirely from distribution of the Library.

If any portion of this section is held invalid or unenforceable under any
particular circumstance, the balance of the section is intended to apply,
and the section as a whole is intended to apply in other circumstances.

It is not the purpose of this section to induce you to infringe any
patents or other property right claims or to contest validity of any
such claims; this section has the sole purpose of protecting the
integrity of the free software distribution system which is
implemented by public license practices.  Many people have made
generous contributions to the wide range of software distributed
through that system in reliance on consistent application of that
system; it is up to the author/donor to decide if he or she is willing
to distribute software through any other system and a licensee cannot
impose that choice.

This section is intended to make thoroughly clear what is believed to
be a consequence of the rest of this License.

  12. If the distribution and/or use of the Library is restricted in
certain countries either by patents or by copyrighted interfaces, the
original copyright holder who places the Library under this License may add
an explicit geographical distribution limitation excluding those countries,
so that distribution is permitted only in or among countries not thus
excluded.  In such case, this License incorporates the limitation as if
written in the body of this License.

  13. The Free Software Foundation may publish revised and/or new
versions of the Lesser General Public License from time to time.
Such new versions will be similar in spirit to the present version,
but may differ in detail to address new problems or concerns.

Each version is given a distinguishing version number.  If the Library
specifies a version number of this License which applies to it and
"any later version", you have the option of following the terms and
conditions either of that version or of any later version published by
the Free Software Foundation.  If the Library does not specify a
license version number, you may choose any version ever published by
the Free Software Foundation.

  14. If you wish to incorporate parts of the Library into other free
programs whose distribution conditions are incompatible with these,
write to the author to ask for permission.  For software which is
copyrighted by the Free Software Foundation, write to the Free
Software Foundation; we sometimes make exceptions for this.  Our
decision will be guided by the two goals of preserving the free status
of all derivatives of our free software and of promoting the sharing
and reuse of software generally.

			    NO WARRANTY

  15. BECAUSE THE LIBRARY IS LICENSED FREE OF CHARGE, THERE IS NO
WARRANTY FOR THE LIBRARY, TO THE EXTENT PERMITTED BY APPLICABLE LAW.
EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR
OTHER PARTIES PROVIDE THE LIBRARY "AS IS" WITHOUT WARRANTY OF ANY
KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE
LIBRARY IS WITH YOU.  SHOULD THE LIBRARY PROVE DEFECTIVE, YOU ASSUME
THE COST OF ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

  16. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN
WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY
AND/OR REDISTRIBUTE THE LIBRARY AS PERMITTED ABOVE, BE LIABLE TO YOU
FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR
CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE
LIBRARY (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING
RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A
FAILURE OF THE LIBRARY TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF
SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
DAMAGES.

		     END OF TERMS AND CONDITIONS

           How to Apply These Terms to Your New Libraries

  If you develop a new library, and you want it to be of the greatest
possible use to the public, we recommend making it free software that
everyone can redistribute and change.  You can do so by permitting
redistribution under these terms (or, alternatively, under the terms of the
ordinary General Public License).

  To apply these terms, attach the following notices to the library.  It is
safest to attach them to the start of each source file to most effectively
convey the exclusion of warranty; and each file should have at least the
"copyright" line and a pointer to where the full notice is found.

    <one line to give the library's name and a brief idea of what it does.>
    Copyright (C) <year>  <name of author>

    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Lesser General Public
    License as published by the Free Software Foundation; either
    version 2.1 of the License, or (at your option) any later version.

    This library is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public
    License along with this library; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

Also add information on how to contact you by electronic and paper mail.

You should also get your employer (if you work as a programmer) or your
school, if any, to sign a "copyright disclaimer" for the library, if
necessary.  Here is a sample; alter the names:

  Yoyodyne, Inc., hereby disclaims all copyright interest in the
  library `Frob' (a library for tweaking knobs) written by James Random Hacker.

  <signature of Ty Coon>, 1 April 1990
  Ty Coon, President of Vice

That's all there is to it!



--- NEW FILE: inc_meta.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_META")) return;
define("_ECRIRE_INC_META", "1");

function lire_metas() {
	global $meta, $meta_maj;

	$meta = '';
	$meta_maj = '';
	$query = 'SELECT * FROM spip_meta';
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$nom = $row['nom'];
		$meta[$nom] = $row['valeur'];
		$meta_maj[$nom] = $row['maj'];
	}
}

function ecrire_meta($nom, $valeur) {
	$valeur = addslashes($valeur);
	spip_query("REPLACE spip_meta (nom, valeur) VALUES ('$nom', '$valeur')");
}

function effacer_meta($nom) {
	spip_query("DELETE FROM spip_meta WHERE nom='$nom'");
}

//
// Mettre a jour le fichier cache des metas
//
// Ne pas oublier d'appeler cette fonction apres ecrire_meta() et effacer_meta() !
//
function ecrire_metas() {
	global $meta, $meta_maj;

	lire_metas();

	$s = '';

	if ($meta) {
		reset($meta);
		while (list($key, $val) = each($meta)) {
			$key = addslashes($key);
			$val = ereg_replace("([\\\\'])", "\\\\1", $val);
			$s .= "\$GLOBALS['meta']['$key'] = '$val';\n";
		}
		$s .= "\n";
	}
	if ($meta_maj) {
		reset($meta_maj);
		while (list($key, $val) = each($meta_maj)) {
			$key = addslashes($key);
			$s .= "\$GLOBALS['meta_maj']['$key'] = '$val';\n";
		}
		$s .= "\n";
	}

	if ($s) {
		$ok = ecrire_fichier (_DIR_SESSIONS . 'meta_cache.php3',
				      '<'.'?php

if (defined("_DATA_META_CACHE")) return;
define("_DATA_META_CACHE", "1");
' 
				      . $s . '?'.'>');
		if (!$ok && $GLOBALS['connect_statut'] == '0minirezo')
		  echo "<h4 font color=red>"._T('texte_inc_meta_1')." <a href='../spip_test_dirs.php3'>"._T('texte_inc_meta_2')."</a> "._T('texte_inc_meta_3')."&nbsp;</h4>\n";
	}
}

// On force lire_metas() si le cache n'a pas ete utilise
if (!isset($GLOBALS['meta']))
	lire_metas();

?>

--- NEW FILE: messagerie.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_acces.php3");
include_ecrire ("inc_calendrier.php");

if ($supp_dest) {
	spip_query("DELETE FROM spip_auteurs_messages WHERE id_message=$id_message AND id_auteur=$supp_dest");
}

if ($detruire_message) {
	spip_query("DELETE FROM spip_messages WHERE id_message=$detruire_message");
	spip_query("DELETE FROM spip_auteurs_messages WHERE id_message=$detruire_message");
	spip_query("DELETE FROM spip_forum WHERE id_message=$detruire_message");
}


debut_page(_T('titre_page_messagerie'), "redacteurs", "messagerie");

//barre_onglets("calendrier", "messagerie");


debut_gauche("messagerie");


debut_boite_info();

echo _T('info_gauche_messagerie');

echo "<p>".http_img_pack("m_envoi$spip_lang_rtl.gif", 'V', "WIDTH='14' HEIGHT='7' BORDER='0'") .' ' . _T('info_symbole_vert');

echo aide ("messut");

echo "<p>".http_img_pack("m_envoi_bleu$spip_lang_rtl.gif", 'B', "WIDTH='14' HEIGHT='7' BORDER='0'") .' ' . _T('info_symbole_bleu');

echo aide ("messpense");

echo "<p>".http_img_pack("m_envoi_jaune$spip_lang_rtl.gif", 'J', "WIDTH='14' HEIGHT='7' BORDER='0'") .' ' . _T('info_symbole_jaune');



fin_boite_info();


creer_colonne_droite();

debut_cadre_relief("messagerie-24.gif");
		icone_horizontale(_T('lien_nouvea_pense_bete'),"message_edit.php3?new=oui&type=pb", "pense-bete.gif");
		icone_horizontale(_T('lien_nouveau_message'),"message_edit.php3?new=oui&type=normal", "message.gif");
		
		if ($connect_statut == "0minirezo") {
			icone_horizontale(_T('lien_nouvelle_annonce'),"message_edit.php3?new=oui&type=affich", "annonce.gif");
		}
fin_cadre_relief();



echo	http_calendrier_ical($connect_id_auteur);


debut_droite("messagerie");




$messages_vus = '';


$query_message = "SELECT * FROM spip_messages AS messages WHERE id_auteur=$connect_id_auteur AND statut='publie' AND type='pb' AND (date_fin > DATE_SUB(NOW(), INTERVAL 1 DAY) OR rv != 'oui')";
afficher_messages(_T('infos_vos_pense_bete'), $query_message, false, true);


$query_message = "SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien ".
	"WHERE lien.id_auteur=$connect_id_auteur AND vu='non' ".
	"AND statut='publie' AND lien.id_message=messages.id_message";
afficher_messages(_T('info_nouveaux_message'), $query_message, true, true);


$query_message = "SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien ".
	"WHERE lien.id_auteur=$connect_id_auteur AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message ".
	"AND (date_fin > DATE_SUB(NOW(), INTERVAL 1 DAY) OR rv != 'oui')";
afficher_messages(_T('info_discussion_cours'), $query_message, true, false);


$query_message = "SELECT * FROM spip_messages AS messages WHERE id_auteur=$connect_id_auteur AND statut='redac'";
afficher_messages(_T('info_message_en_redaction'), $query_message, true, false, false);



$query = "SELECT auteurs.id_auteur, auteurs.nom, COUNT(*) AS total FROM spip_auteurs AS auteurs,  spip_auteurs_messages AS lien2, spip_messages AS messages, spip_auteurs_messages AS lien ".
	"WHERE (lien.id_auteur = $connect_id_auteur AND lien.id_message = messages.id_message AND messages.statut = 'publie' AND (messages.rv != 'oui' OR messages.date_fin > NOW() )) ".
	"AND (lien2.id_auteur = lien2.id_auteur AND lien2.id_message = messages.id_message AND lien2.id_auteur != $connect_id_auteur AND auteurs.id_auteur = lien2.id_auteur) ".
	"GROUP BY auteurs.id_auteur ORDER BY total DESC LIMIT 0,10";

$result = spip_query($query);
if (spip_num_rows($result) > 0) {

	echo "<div style='height: 12px;'></div>";
	echo "<div class='liste'>";

	bandeau_titre_boite2(_T('info_principaux_correspondants'), "redacteurs-24.gif", "#333333", "white");

	//echo "<div style='padding: 3px; background-color: $couleur_foncee; color: white;'><b class='verdana2'>"._T('info_principaux_correspondants')."</b></div>";
	echo "<table width='100%' cellpadding='0' cellspacing='0'>";
	echo "<tr><td valign='top' width='50%'>";
	while($row = spip_fetch_array($result)) {
		$count ++;
		if ($i == 1) {
			$bgcolor = "white";
			$i = 0;
		} else {
			$bgcolor = $couleur_claire;
			$i = 1;
		}
		$id_auteur = $row['id_auteur'];
		$nom = typo($row["nom"]);
		$total = $row["total"];
		echo "<div class='tr_liste' onMouseOver=\"changeclass(this,'tr_liste_over');\" onMouseOut=\"changeclass(this,'tr_liste');\" style=' padding: 2px; padding-left: 10px; border-bottom: 1px solid #cccccc;'><div class='verdana1'><img src='" . _DIR_IMG_PACK . "redac-12.gif' border='0'> <a href='auteurs_edit.php3?id_auteur=$id_auteur'>$nom</a> ($total)</div></div>";
		if ($count == ceil(spip_num_rows($result)/2)) echo "</td><td valign='top' width='50%' style='background-color: #eeeeee;'>";
	}
	echo "</td></tr></table>";
	echo "</div>";
}

$query_message = "SELECT * FROM spip_messages AS messages WHERE id_auteur=$connect_id_auteur AND statut='publie' AND type='pb' AND rv!='oui'";
afficher_messages(_T('info_pense_bete_ancien'), $query_message, false, false, false);


$query_message = "SELECT * FROM spip_messages AS messages WHERE statut='publie' AND type='affich' AND (date_fin > DATE_SUB(NOW(), INTERVAL 1 DAY) OR rv != 'oui')";
afficher_messages(_T('info_tous_redacteurs'), $query_message, false, false, false);

fin_page();

?>

--- NEW FILE: sites.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_logos.php3");
include_ecrire ("inc_mots.php3");
include_ecrire ("inc_sites.php3");
include_ecrire ("inc_abstract_sql.php3");

$proposer_sites = lire_meta("proposer_sites");

function calculer_droits() {
	global $connect_statut, $statut, $id_rubrique, $id_rubrique_depart, $proposer_sites, $new;
	global $flag_editable, $flag_administrable;

	$flag_administrable = ($connect_statut == '0minirezo' AND acces_rubrique($id_rubrique));
	if ($id_rubrique_depart > 0)
		 $flag_administrable &= acces_rubrique($id_rubrique_depart);
	$flag_editable = ($flag_administrable OR ($proposer_sites > 0 AND ($statut == 'prop' OR $new == 'oui')));
}


function my_sel($num,$tex,$comp){
	if ($num==$comp){
		echo "<OPTION VALUE='$num' SELECTED>$tex\n";
	}else{
		echo "<OPTION VALUE='$num'>$tex\n";
	}
}


function afficher_mois($mois){
	my_sel("00",_T('mois_non_connu'),$mois);
	my_sel("01",_T('date_mois_1'),$mois);
	my_sel("02",_T('date_mois_2'),$mois);
	my_sel("03",_T('date_mois_3'),$mois);
	my_sel("04",_T('date_mois_4'),$mois);
	my_sel("05",_T('date_mois_5'),$mois);
	my_sel("06",_T('date_mois_6'),$mois);
	my_sel("07",_T('date_mois_7'),$mois);
	my_sel("08",_T('date_mois_8'),$mois);
	my_sel("09",_T('date_mois_9'),$mois);
	my_sel("10",_T('date_mois_10'),$mois);
	my_sel("11",_T('date_mois_11'),$mois);
	my_sel("12",_T('date_mois_12'),$mois);
}

function afficher_annee($annee){
	// Cette ligne permettrait de faire des articles sans date de publication
	// my_sel("0000","n.c.",$annee);

	if($annee<1996 AND $annee <> 0){
		echo "<OPTION VALUE='$annee' SELECTED>$annee\n";
	}
	for($i=1996;$i<date(Y)+2;$i++){
		my_sel($i,$i,$annee);
	}
}

function afficher_jour($jour){
	my_sel("00",_T('jour_non_connu_nc'),$jour);
	for($i=1;$i<32;$i++){
		if ($i<10){$aff="&nbsp;".$i;}else{$aff=$i;}
		my_sel($i,$aff,$jour);
	}
}


//
// Creation d'un site
//

if ($new == 'oui') {
	calculer_droits();

	if ($flag_editable) {
		$id_rubrique = intval($id_rubrique);
	
		$mydate = date("YmdHis", time() - 12 * 3600);
		$query = "DELETE FROM spip_syndic WHERE (statut = 'refuse') && (maj < $mydate)";
		$result = spip_query($query);
	
		$moderation = (lire_meta("moderation_sites") == "oui")? 'oui' : 'non';
	
		$id_syndic = spip_abstract_insert("syndic",
					 "(nom_site, id_rubrique, id_secteur, date, date_syndic, statut, syndication, moderation)",
					 "('"._T('avis_site_introuvable')."', $id_rubrique, $id_rubrique, NOW(), NOW(), 'refuse', 'non', '$moderation')");
	}
}

$query = "SELECT statut, id_rubrique FROM spip_syndic WHERE id_syndic='$id_syndic'";
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$statut = $row["statut"];
	$id_rubrique_depart = $row["id_rubrique"];
	if (!$id_rubrique) $id_rubrique = $id_rubrique_depart;
}
if ($new == 'oui') $statut = 'prop';

calculer_droits();


//
// Analyse automatique d'une URL
//

if ($analyser_site == 'oui' AND $flag_editable) {

	$v = analyser_site($url);

	if ($v) {
		$nom_site = addslashes($v['nom_site']);
		$url_site = addslashes($v['url_site']);
		if (!$nom_site) $nom_site = $url_site;
		$url_syndic = addslashes($v['url_syndic']);
		$descriptif = addslashes($v['descriptif']);
		$syndication = $v[syndic] ? 'oui' : 'non';
		$query = "UPDATE spip_syndic ".
			"SET nom_site='$nom_site', url_site='$url_site', url_syndic='$url_syndic', descriptif='$descriptif', syndication='$syndication', statut='$statut' ".
			"WHERE id_syndic=".intval($id_syndic);
		$result = spip_query($query);
		if ($syndication == 'oui') syndic_a_jour($id_syndic);
		$link = new Link('sites.php3');
		$link->addVar('id_syndic');
		$link->addVar('redirect');
		$redirect = $link->getUrl();
		$redirect_ok = 'oui';
	}
}


//
// Ajout et suppression syndication
//

if ($nouveau_statut AND $flag_administrable) {
	$statut = $nouveau_statut;
	$query = "UPDATE spip_syndic SET statut='$statut' WHERE id_syndic=".intval($id_syndic);
	$result = spip_query($query);
	//if ($statut == 'refuse') $redirect_ok = 'oui';
	if ($statut == 'publie') {
		$query = "UPDATE spip_syndic SET date=NOW() WHERE id_syndic=".intval(id_syndic);
		$result = spip_query($query);
	}
	calculer_rubriques();
	if ($statut == 'publie') {
		if (lire_meta('activer_moteur') == 'oui') {
			include_ecrire ("inc_index.php3");
			indexer_syndic($id_syndic);
		}
	}
}

if ($nom_site AND $modifier_site == 'oui' AND $flag_editable) {
	$nom_site = addslashes($nom_site);
	$url_site = addslashes($url_site);
	$descriptif = addslashes($descriptif);
	if (strlen($url_syndic) < 8) $syndication = "non";
	$url_syndic = addslashes($url_syndic);

	$query = "UPDATE spip_syndic SET id_rubrique='$id_rubrique', nom_site='$nom_site', url_site='$url_site', url_syndic='$url_syndic', descriptif='$descriptif', syndication='$syndication', statut='$statut' WHERE id_syndic=".intval($id_syndic);
	$result = spip_query($query);

	if ($syndication_old != $syndication OR $url_syndic != $old_syndic) {
		$recalcul = "oui";
	}
	if ($syndication_old != $syndication AND $syndication == "non") {
		spip_query("DELETE FROM spip_syndic_articles WHERE id_syndic='$id_syndic'");
	}
	calculer_rubriques();

	// invalider et reindexer
	if ($statut == 'publie') {
		if ($invalider_caches) {
			include_ecrire ("inc_invalideur.php3");
			suivre_invalideur("id='id_syndic/$id_syndic'");
		}
		if (lire_meta('activer_moteur') == 'oui') {
			include_ecrire ("inc_index.php3");
			indexer_syndic($id_syndic);
		}
	}
	$link = new Link('sites.php3');
	$link->addVar('id_syndic');
	$link->addVar('redirect');
	$redirect = $link->getUrl();
	$redirect_ok = 'oui';
}


if ($jour AND $flag_administrable) {
	if ($annee == "0000") $mois = "00";
	if ($mois == "00") $jour = "00";
	$query = "UPDATE spip_syndic SET date='$annee-$mois-$jour' WHERE id_syndic=".intval($id_syndic);
	$result = spip_query($query);
	calculer_rubriques();
}



if ($redirect AND $redirect_ok == 'oui') {
	redirige_par_entete($redirect);
}


//
// recalcul
//
if ($recalcul ==  "oui") {
	$result = spip_query ("SELECT * FROM spip_syndic WHERE id_syndic='$id_syndic' AND syndication IN ('oui', 'sus', 'off')");
	if ($result AND spip_num_rows($result)>0)
		$erreur_syndic = syndic_a_jour ($id_syndic);
}


//
// Afficher la page
//

calculer_droits();

$query = "SELECT * FROM spip_syndic WHERE id_syndic='$id_syndic'";
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$id_syndic = $row["id_syndic"];
	$id_rubrique = $row["id_rubrique"];
	$nom_site = stripslashes($row["nom_site"]);
	$url_site = stripslashes($row["url_site"]);
	$url_syndic = stripslashes($row["url_syndic"]);
	$descriptif = stripslashes($row["descriptif"]);
	$syndication = $row["syndication"];
	$statut = $row["statut"];
	$date_heure = $row["date"];
	$date_syndic = $row['date_syndic'];
	$mod = $row['moderation'];
}


if ($nom_site)
	$titre_page = "&laquo; $nom_site &raquo;";
else
	$titre_page = _T('info_site');



debut_page("$titre_page","documents","sites");


//////// parents


debut_grand_cadre();

afficher_hierarchie($id_rubrique);

fin_grand_cadre();



debut_gauche();

debut_boite_info();
	echo "<center>";
	echo "<font face='Verdana,Arial,Sans,sans-serif' size=1><b>"._T('titre_site_numero')."</b></font>";
	echo "<br><font face='Verdana,Arial,Sans,sans-serif' size=6><b>$id_syndic</b></font>";
	echo "</center>";
fin_boite_info();


echo "<p><center>";
	icone (_T('icone_voir_sites_references'), "sites_tous.php3", "site-24.gif","rien.gif");
echo "</center>";

$rubon = "siteon$id_syndic";
$ruboff = "siteoff$id_syndic";

if ($id_syndic>0 AND $flag_administrable)
	afficher_boite_logo($rubon, $ruboff, _T('logo_site')." ".aide ("rublogo"), _T('logo_survol'));


debut_droite();



debut_cadre_relief("site-24.gif");
echo "<center>";

if ($syndication == 'off') {
	$logo_statut = "puce-orange-anim.gif";
} 
else if ($statut == 'publie') {
	$logo_statut = "puce-verte.gif";
}
else if ($statut == 'prop') {
	$logo_statut = "puce-blanche.gif";
}
else if ($statut == 'refuse') {
	$logo_statut = "puce-rouge.gif";
}

echo "\n<table cellpadding=0 cellspacing=0 border=0 width='100%'>";
echo "<tr width='100%'><td width='100%' valign='top'>";
	gros_titre($nom_site, $logo_statut);

$url_affichee = $url_site;

if (strlen($url_affichee) > 40) $url_affichee = substr($url_affichee, 0, 30)."...";
echo "<a href='$url_site'><b>$url_affichee</b></a>";

if (strlen($descriptif) > 1) {
	echo "<p><div align='left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;'>";
	echo "<font size=2 face='Verdana,Arial,Sans,sans-serif'>";
	echo "<b>"._T('info_descriptif')."</b> ";
	echo propre($descriptif);
	echo "&nbsp; ";
	echo "</font>";
	echo "</div>";
}
echo "</td>";

if ($flag_editable) {
	$link = new Link('sites_edit.php3');
	$link->addVar('id_syndic');
	$link->addVar('target', $clean_link->getUrl());
	echo "<td><img src='" . _DIR_IMG_PACK . "rien.gif' width=5></td>\n";
	echo "<td  align='right'>";
	icone(_T('icone_modifier_site'), $link->getUrl(), "site-24.gif", "edit.gif");
	echo "</td>";
}
echo "</tr></table>\n";



if ($flag_editable AND ($options == 'avancees' OR $statut == 'publie')) {
	if ($statut == 'publie') {
		echo "<p>";

		if (ereg("([0-9]{4})-([0-9]{2})-([0-9]{2})", $date_heure, $regs)) {
		        $mois = $regs[2];
		        $jour = $regs[3];
		        $annee = $regs[1];
		}


		debut_cadre_enfonce();
		echo "<FORM ACTION='sites.php3?id_syndic=$id_syndic' METHOD='GET'>";
		echo "<INPUT TYPE='hidden' NAME='id_syndic' VALUE='$id_syndic'>";
		echo "<INPUT NAME='options' TYPE=Hidden VALUE=\"$options\">";
		echo "<TABLE CELLPADDING=5 CELLSPACING=0 BORDER=0 WIDTH=100% BACKGROUND='" . _DIR_IMG_PACK . "rien.gif'>";
		echo "<TR><TD BGCOLOR='$couleur_foncee' COLSPAN=2><FONT SIZE=2 COLOR='#FFFFFF'><B>"._T('info_date_referencement');
		//echo aide ("artdate");
		echo "</B></FONT></TR>";
		echo "<TR><TD ALIGN='center'>";
		echo "<SELECT NAME='jour' SIZE=1 CLASS='fondl'>";
		afficher_jour($jour);
		echo "</SELECT> ";
		echo "<SELECT NAME='mois' SIZE=1 CLASS='fondl'>";
		afficher_mois($mois);
		echo "</SELECT> ";
		echo "<SELECT NAME='annee' SIZE=1 CLASS='fondl'>";
		afficher_annee($annee);
		echo "</SELECT>";
 		
		echo "</TD><TD ALIGN='right'>";
		echo "<INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='"._T('bouton_changer')."'>";
		echo "</TD></TR></TABLE>";
		echo "</FORM>";
		fin_cadre_enfonce();	
	}
	else {
		echo "<BR><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3>"._T('info_site_propose')." <B>".affdate($date_heure)."&nbsp;</B></FONT><P>";
	}
}

if ($flag_editable AND $options == 'avancees') {
	formulaire_mots('syndic', $id_syndic, $nouv_mot, $supp_mot, $cherche_mot, $flag_editable);
}

if ($flag_administrable) {
	$link = $GLOBALS['clean_link'];
	$link->delVar('new');
	echo $link->getForm('GET');
	debut_cadre_relief("racine-site-24.gif");
	echo "\n<center>";

	echo "<b>"._T('info_statut_site_1')."</b> &nbsp;&nbsp; \n";

	echo "<select name='nouveau_statut' size=1 class='fondl'>\n";

	my_sel("publie",_T('info_statut_site_2'),$statut);
	my_sel("prop",_T('info_statut_site_3'),$statut);
	my_sel("refuse",_T('info_statut_site_4'),$statut);

	echo "</select>\n";

	echo " &nbsp;&nbsp;&nbsp; <input type='submit' name='Valider' value='"._T('bouton_valider')."' class='fondo'>\n</center>\n";
	fin_cadre_relief();
	echo "</form>\n";
}

if ($syndication == "oui" OR $syndication == "off" OR $syndication == "sus") {
	echo "<p><font size=3 face='Verdana,Arial,Sans,sans-serif'><b>"._T('info_site_syndique')."</b></font>";

	if ($erreur_syndic)
		echo "<p><font color=red><b>$erreur_syndic</b></font>";

	if ($syndication == "off") {
		debut_boite_info();
		echo _T('avis_site_syndique_probleme', array('url_syndic' => $url_syndic));
		echo "<center><b>";
		echo "<a href='sites.php3?id_syndic=$id_syndic&recalcul=oui'>";
		echo _T('lien_nouvelle_recuperation')."</a></b></center>\n";
		fin_boite_info();
	}
	afficher_syndic_articles(_T('titre_articles_syndiques'),
		"SELECT * FROM spip_syndic_articles WHERE id_syndic='$id_syndic' ORDER BY date DESC");


	echo "<font face='verdana,arial,helvetica' size=2>";
	// afficher la date de dernier acces a la syndication
	if ($date_syndic)
		echo "<p><div align='left'>"._T('info_derniere_syndication').' '.affdate_heure($date_syndic)
		.".</div><div align='right'><a href='sites.php3?id_syndic=$id_syndic&recalcul=oui'>"._T('lien_mise_a_jour_syndication')."</a></div>\n";

	// modifier la moderation
	if ($flag_administrable && $options=='avancees') {
		if ($moderation == 'oui' OR $moderation == 'non')
			spip_query("UPDATE spip_syndic SET moderation='$moderation' WHERE id_syndic=".intval($id_syndic));
		else
			$moderation = $mod;

		if ($moderation == 'non' || $moderation =='')
			echo "<p><div align='left'>"._T('texte_liens_syndication'). aide('artsyn') .
				"</div><div align='right'><a
				href='sites.php3?id_syndic=$id_syndic&moderation=oui'>"._T('info_demander_blocage_priori')."</a></div>\n";
		else if ($moderation == 'oui')
			echo "<p><div align='left'>"._T('texte_demander_blocage_priori'). aide('artsyn') .
				"</div><div align='right'> <a
				href='sites.php3?id_syndic=$id_syndic&moderation=non'>"._T('info_annuler_blocage_priori')."</a></div>\n";
	}
	echo "</font>";
}

fin_cadre_relief();



//////////////////////////////////////////////////////
// Forums
//

echo "<br><br>\n";

$forum_retour = "sites.php3?id_syndic=$id_syndic";

$link = new Link('forum_envoi.php3');
$link->addVar('statut', 'prive');
$link->addVar('adresse_retour', $forum_retour);
$link->addVar('id_syndic');
$link->addVar('titre_message', $nom_site);


echo "<div align='center'>";
icone (_T('icone_poster_message'), $link->getUrl(), "forum-interne-24.gif", "creer.gif");
echo "</div>";

echo "<p align='left'>\n";

$query_forum = "SELECT * FROM spip_forum WHERE statut='prive' AND id_syndic='$id_syndic' AND id_parent=0 ORDER BY date_heure DESC LIMIT 0,20";
$result_forum = spip_query($query_forum);
afficher_forum($result_forum, $forum_retour);


fin_page();

?>

--- NEW FILE: breves.php3 ---
<?php

include ("inc.php3");

if ($statut AND $connect_statut == "0minirezo") {
	$query="UPDATE spip_breves SET date_heure=NOW(), statut='$statut' WHERE id_breve=$id_breve";
	$result=spip_query($query);
	calculer_rubriques();
	redirige_par_entete("breves.php3");
}



debut_page(_T('titre_page_breves'), "documents", "breves");
debut_gauche();

echo "<P align=left>";
	
debut_droite();



function enfant($leparent){
	global $spip_lang_left, $spip_lang_right;

 	$query="SELECT * FROM spip_rubriques WHERE id_parent='$leparent' ORDER BY titre";
 	$result=spip_query($query);

 	while($row=spip_fetch_array($result)){
		$id_rubrique=$row['id_rubrique'];
		$id_parent=$row['id_parent'];
		$titre=typo($row['titre']);
		$descriptif=$row['descriptif'];
		$texte=$row['texte'];

		debut_cadre_enfonce("secteur-24.gif", false, '', $titre.aide ("breves"));

		if ($GLOBALS['connect_statut'] == "0minirezo") $statuts = "'prop', 'refuse', 'publie'";
		else $statuts = "'prop', 'publie'";

		$query = "SELECT id_breve, date_heure, titre, statut FROM spip_breves ".
			"WHERE id_rubrique='$id_rubrique' AND statut IN ($statuts) ORDER BY date_heure DESC";
		afficher_breves('', $query);
		echo "<div align='$spip_lang_right'>";
		icone(_T('icone_nouvelle_breve'), "breves_edit.php3?new=oui&id_rubrique=$id_rubrique", "breve-24.gif", "creer.gif");
		echo "</div>";

		fin_cadre_enfonce();

	}
}



enfant(0);


fin_page();

?>


--- NEW FILE: calendrier_jour.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_calendrier.php");

$today=getdate(time());
$jour_today = $today["mday"];
$mois_today = $today["mon"];
$annee_today = $today["year"];

// sans arguments => mois courant
if (!$mois){
  $jour=$jour_today;
  $mois=$mois_today;
  $annee=$annee_today;
}

$date = date("Y-m-d", mktime(0,0,0,$mois, $jour, $annee));
$jour = journum($date);
$mois = mois($date);
$annee = annee($date);


$afficher_bandeau_calendrier = true;

debut_page(nom_jour("$annee-$mois-$jour")." ". affdate_jourcourt("$annee-$mois-$jour"),  
	   "redacteurs",
	   "calendrier");

debut_gauche();

echo http_calendrier_journee($jour_today,$mois_today,$annee_today, 
		  date("Y-m-d", mktime(0,0,0,$mois, $jour, $annee)));

fin_page();

?>

--- NEW FILE: recherche.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_mots.php3");
include_ecrire ("inc_sites.php3");

$recherche = addslashes(entites_html($recherche));


debut_page(_T('titre_page_recherche', array('recherche' => $recherche)));

debut_gauche();

				$recherche_aff = _T('info_rechercher');
				$onfocus = "onfocus=this.value='';";
			echo "<form method='get' style='margin: 0px;' action='recherche.php3'>";
			echo '<input type="text" size="10" value="'.$recherche_aff.'" name="recherche" class="spip_recherche" accesskey="r" '.$onfocus.'>';
			echo "</form>";



debut_droite();

if (strlen($recherche) > 0) {

	echo "<FONT FACE='Verdana,Arial,Sans,sans-serif'><B>"._T('info_resultat_recherche')."</B><BR>";
	echo "<FONT SIZE=5 COLOR='$couleur_foncee'><B>$recherche</B></FONT><p>";

	$query_articles = "SELECT * FROM spip_articles WHERE";
	$query_breves = "SELECT * FROM spip_breves WHERE ";
	$query_rubriques = "SELECT * FROM spip_rubriques WHERE ";
	$query_sites = "SELECT * FROM spip_syndic WHERE ";
	
	if (ereg("^[0-9]+$", $recherche)) {
		$query_articles .= " (id_article = $recherche) OR ";
		$query_breves .= " (id_breve = $recherche) OR ";
		$query_rubriques .= " (id_rubrique = $recherche) OR ";
		$query_sites .= " (id_syndic = $recherche) OR ";
	}
	
	// Eviter les symboles '%', caracteres SQL speciaux
	$recherche = str_replace("%","\%",$recherche);
	$rech2 = split("[[:space:]]+", $recherche);
	if ($rech2)
		$where = " (titre LIKE '%".join("%' AND titre LIKE '%", $rech2)."%') ";
	else
		$where = " 1=2";
	
	$query_articles .= " $where ORDER BY date_modif DESC";
	$query_breves .= " $where ORDER BY maj DESC LIMIT 0,10";
	$query_rubriques .= " $where ORDER BY maj DESC LIMIT 0,10";
	
	$query_sites .= " $where ORDER BY maj DESC LIMIT 0,10";
	$query_sites  = ereg_replace("titre LIKE", "nom_site LIKE", $query_sites);
	
	$activer_moteur = (lire_meta('activer_moteur') == 'oui');
	if ($activer_moteur) {	// texte integral
		include_ecrire ('inc_index.php3');
		list($hash_recherche,) = requete_hash ($recherche);
		$query_articles_int = requete_txt_integral('article', $hash_recherche);
		$query_breves_int = requete_txt_integral('breve', $hash_recherche);
		$query_rubriques_int = requete_txt_integral('rubrique', $hash_recherche);
		$query_sites_int = requete_txt_integral('syndic', $hash_recherche);
		$query_auteurs_int = requete_txt_integral('auteur', $hash_recherche);
	}
	
	if ($query_articles)
		$nba = afficher_articles (_T('info_articles_trouves'), $query_articles);
	if ($activer_moteur) {
		if ($nba) {
			$doublons = join($nba, ",");
			$query_articles_int = ereg_replace ("WHERE", "WHERE objet.id_article NOT IN ($doublons) AND", $query_articles_int);
		}
		$nba1 = afficher_articles (_T('info_articles_trouves_dans_texte'), $query_articles_int);
	}
	
	if ($query_breves)
		$nbb = afficher_breves (_T('info_breves_touvees'), $query_breves, true);
	if ($activer_moteur) {
		if ($nbb) {
			$doublons = join($nbb, ",");
			$query_breves_int = ereg_replace ("WHERE", "WHERE objet.id_breve NOT IN ($doublons) AND", $query_breves_int);
		}
		$nbb1 = afficher_breves (_T('info_breves_touvees_dans_texte'), $query_breves_int, true);
	}
	
	if ($query_rubriques)
		$nbr = afficher_rubriques (_T('info_rubriques_trouvees'), $query_rubriques);
	if ($activer_moteur) {
		if ($nbr) {
			$doublons = join($nbr, ",");
			$query_rubriques_int = ereg_replace ("WHERE", "WHERE objet.id_rubrique NOT IN ($doublons) AND", $query_rubriques_int);
		}
		$nbr1 = afficher_rubriques (_T('info_rubriques_trouvees_dans_texte'), $query_rubriques_int);
	}
	
	if ($activer_moteur)
		$nbt = afficher_auteurs (_T('info_auteurs_trouves'), $query_auteurs_int);
	
	if ($query_sites)
		$nbs = afficher_sites (_T('info_sites_trouves'), $query_sites);
	if ($activer_moteur) {
		if ($nbs) {
			$doublons = join($nbs, ",");
			$query_sites_int = ereg_replace ("WHERE", "WHERE objet.id_syndic NOT IN ($doublons) AND", $query_sites_int);
		}
		$nbs1 = afficher_sites (_T('info_sites_trouves_dans_texte'), $query_sites_int);
	}
	
	if (!$nba AND !$nba1 AND !$nbb AND !$nbb1 AND !$nbr AND !$nbr1 AND !$nbt AND !$nbs AND !$nbs1) {
		echo "<FONT FACE='Verdana,Arial,Sans,sans-serif'>"._T('avis_aucun_resultat')."</FONT><P>";
	}
}

echo "<p>";

fin_page();

?>

--- NEW FILE: http.class.php ---
<?php
/**************************************************************************************************
* Class: Advanced HTTP Client
***************************************************************************************************
* Version 		: 1.1
* Released		: 06-20-2002
* Last Modified : 06-10-2003
* Author		: GuinuX <guinux at cosmoplazza.com>
*
***************************************************************************************************
* Changes 
***************************************************************************************************
* 2003-06-10 : GuinuX 
*   - Fixed a bug with multiple gets and basic auth
*   - Added support for Basic proxy Authentification 
* 2003-05-25: By Michael Mauch <michael.mauch at gmx.de>
*	- Fixed two occurences of the former "status" member which is now deprecated
* 2002-09-23: GuinuX
*	- Fixed a bug to the post method with some HTTP servers
*	- Thanx to l0rd jenci <lord_jenci at bigfoot.com> for reporting this bug.
* 2002-09-07: Dirk Fokken <fokken at cross-consulting.com>
*   - Deleted trailing characters at the end of the file, right after the php closing tag, in order 
*	  to fix a bug with binary requests.
* 2002-20-06: GuinuX, Major changes
*	- Turned to a more OOP style => added class http_header, http_response_header, 
*		http_request_message, http_response_message.
*		The members : status, body, response_headers, cookies, _request_headers of the http class 
*		are Deprecated.
* 2002-19-06: GuinuX, fixed some bugs in the http::_get_response() method
* 2002-18-06: By Mate Jovic <jovic at matoma.de>
*	- Added support for Basic Authentification 
*  		usage: $http_client = new http( HTTP_V11, false, Array('user','pass') );
*
***************************************************************************************************
* Description:  
***************************************************************************************************
*	A HTTP client class
* 	Supports : 
*			- GET, HEAD and POST methods 
*			- Http cookies 
*			- multipart/form-data AND application/x-www-form-urlencoded
*			- Chunked Transfer-Encoding 
*			- HTTP 1.0 and 1.1 protocols 
*			- Keep-Alive Connections 
*			- Proxy
*			- Basic WWW-Authentification and Proxy-Authentification 
*
***************************************************************************************************
* TODO :
***************************************************************************************************
*			- Read trailing headers for Chunked Transfer-Encoding 
***************************************************************************************************
* usage
***************************************************************************************************
* See example scripts.
*
***************************************************************************************************
* License
***************************************************************************************************
* GNU Lesser General Public License (LGPL)
* http://www.opensource.org/licenses/lgpl-license.html
*
* For any suggestions or bug report please contact me : guinux at cosmoplazza.com
***************************************************************************************************/

	if ( !defined('HTTP_CRLF') ) define( 'HTTP_CRLF', chr(13) . chr(10));
	define( 'HTTP_V10', '1.0');
	define( 'HTTP_V11', '1.1');
	define( 'HTTP_STATUS_CONTINUE', 				100 );
	define( 'HTTP_STATUS_SWITCHING_PROTOCOLS', 		101 );
	define( 'HTTP_STATUS_OK', 						200 );
	define( 'HTTP_STATUS_CREATED', 					201 );
	define( 'HTTP_STATUS_ACCEPTED', 				202 );
	define( 'HTTP_STATUS_NON_AUTHORITATIVE', 		203 );
	define( 'HTTP_STATUS_NO_CONTENT', 				204 );
	define( 'HTTP_STATUS_RESET_CONTENT', 			205 );
	define( 'HTTP_STATUS_PARTIAL_CONTENT', 			206 );
	define( 'HTTP_STATUS_MULTIPLE_CHOICES', 		300 );
	define( 'HTTP_STATUS_MOVED_PERMANENTLY', 		301 );
	define( 'HTTP_STATUS_FOUND', 					302 );
	define( 'HTTP_STATUS_SEE_OTHER', 				303 );
	define( 'HTTP_STATUS_NOT_MODIFIED', 			304 );
	define( 'HTTP_STATUS_USE_PROXY', 				305 );
	define( 'HTTP_STATUS_TEMPORARY_REDIRECT', 		307 );
	define( 'HTTP_STATUS_BAD_REQUEST', 				400 );
	define( 'HTTP_STATUS_UNAUTHORIZED', 			401 );
	define( 'HTTP_STATUS_FORBIDDEN', 				403 );
	define( 'HTTP_STATUS_NOT_FOUND', 				404 );
	define( 'HTTP_STATUS_METHOD_NOT_ALLOWED', 		405 );
	define( 'HTTP_STATUS_NOT_ACCEPTABLE', 			406 );
	define( 'HTTP_STATUS_PROXY_AUTH_REQUIRED', 		407 );
	define( 'HTTP_STATUS_REQUEST_TIMEOUT', 			408 );
	define( 'HTTP_STATUS_CONFLICT', 				409 );
	define( 'HTTP_STATUS_GONE', 					410 );
	define( 'HTTP_STATUS_REQUEST_TOO_LARGE',		413 );
	define( 'HTTP_STATUS_URI_TOO_LONG', 			414 );
	define( 'HTTP_STATUS_SERVER_ERROR', 			500 );
	define( 'HTTP_STATUS_NOT_IMPLEMENTED',			501 );
	define( 'HTTP_STATUS_BAD_GATEWAY',				502 );
	define( 'HTTP_STATUS_SERVICE_UNAVAILABLE',		503 );
	define( 'HTTP_STATUS_VERSION_NOT_SUPPORTED',	505 );


/******************************************************************************************
* class http_header
******************************************************************************************/
	class http_header {
		var $_headers;
		var $_debug;

		function http_header() {
			$this->_headers = Array();
			$this->_debug	= '';
		} // End Of function http_header()
		
		function get_header( $header_name ) {
			$header_name = $this->_format_header_name( $header_name );
			if (isset($this->_headers[$header_name]))
				return $this->_headers[$header_name];
			else
				return null;
		} // End of function get()
		
		function set_header( $header_name, $value ) {
			if ($value != '') {
				$header_name = $this->_format_header_name( $header_name );
				$this->_headers[$header_name] = $value;
			}
		} // End of function set()
		
		function reset() {
			if ( count( $this->_headers ) > 0 ) $this->_headers = array();
			$this->_debug 	.= "\n--------------- RESETED ---------------\n";
		} // End of function clear()

		function serialize_headers() {
			$str = '';
			foreach ( $this->_headers as $name=>$value) {
				$str .= "$name: $value" . HTTP_CRLF;
			}
			return $str;
		} // End of function serialize_headers()
		
		function _format_header_name( $header_name ) {
			$formatted = str_replace( '-', ' ', strtolower( $header_name ) );
			$formatted = ucwords( $formatted );
			$formatted = str_replace( ' ', '-', $formatted );
			return $formatted;
		}
		
		function add_debug_info( $data ) {
			$this->_debug .= $data;
		}

		function get_debug_info() {
			return $this->_debug;
		}
	
	} // End Of Class http_header

/******************************************************************************************
* class http_response_header
******************************************************************************************/
	class http_response_header extends http_header {
		var $cookies_headers;
		
		function http_response_header() {
			$this->cookies_headers = array();
			http_header::http_header();
		} // End of function http_response_header()
		
		function deserialize_headers( $flat_headers ) {
			$flat_headers = preg_replace( "/^" . HTTP_CRLF . "/", '', $flat_headers );
			$tmp_headers = split( HTTP_CRLF, $flat_headers );
			if (preg_match("'HTTP/(\d\.\d)\s+(\d+).*'i", $tmp_headers[0], $matches )) {
				$this->set_header( 'Protocol-Version', $matches[1] );
				$this->set_header( 'Status', $matches[2] );
			} 
			array_shift( $tmp_headers );
			foreach( $tmp_headers as $index=>$value ) {
				$pos = strpos( $value, ':' );
				if ( $pos ) {
					$key = substr( $value, 0, $pos );
					$value = trim( substr( $value, $pos +1) );
					if ( strtoupper($key) == 'SET-COOKIE' )
						$this->cookies_headers[] = $value;
					else
						$this->set_header( $key, $value );
				}
			}
		} // End of function deserialize_headers()
		
		function reset() {
			if ( count( $this->cookies_headers ) > 0 ) $this->cookies_headers = array();
			http_header::reset();
		}

	} // End of class http_response_header


/******************************************************************************************
* class http_request_message
******************************************************************************************/
	class http_request_message extends http_header {
		var $body;
		
		function http_request_message() {
			$this->body = '';
			http_header::http_header();
		} // End of function http_message()
		
		function reset() {
			$this->body = '';
			http_header::reset();
		}
	}

/******************************************************************************************
* class http_response_message
******************************************************************************************/
	class http_response_message extends http_response_header {
		var $body;
		var $cookies;
		
		function http_response_message() {
			$this->cookies = new http_cookie();
			$this->body = '';
			http_response_header::http_response_header();
		} // End of function http_response_message()
		
		function get_status() {
			if ( $this->get_header( 'Status' ) != null )
				return (integer)$this->get_header( 'Status' );
			else
				return -1;
		}
		
		function get_protocol_version() {
			if ( $this->get_header( 'Protocol-Version' ) != null )
				return $this->get_header( 'Protocol-Version' );
			else
				return HTTP_V10;
		}
		
		function get_content_type() {
			$this->get_header( 'Content-Type' );
		}
		
		function get_body() {
			return $this->body;
		}
		
		function reset() {
			$this->body = '';
			http_response_header::reset();
		}

		function parse_cookies( $host ) {
			for ( $i = 0; $i < count( $this->cookies_headers ); $i++ )
				$this->cookies->parse( $this->cookies_headers[$i], $host );
		}
	}

/******************************************************************************************
* class http_cookie
******************************************************************************************/
	class http_cookie {
		var $cookies;

		function http_cookie() {
			$this->cookies 	= array();
		} // End of function http_cookies()
		
		function _now() {
			return strtotime( gmdate( "l, d-F-Y H:i:s", time() ) );
		} // End of function _now()
		
		function _timestamp( $date ) {
			if ( $date == '' ) return $this->_now()+3600;
			$time = strtotime( $date );
			return ($time>0?$time:$this->_now()+3600);
		} // End of function _timestamp()

		function get( $current_domain, $current_path ) {
			$cookie_str = '';
			$now = $this->_now();
			$new_cookies = array();

			foreach( $this->cookies as $cookie_name => $cookie_data ) {
				if ($cookie_data['expires'] > $now) {
					$new_cookies[$cookie_name] = $cookie_data;
					$domain = preg_quote( $cookie_data['domain'] );
					$path = preg_quote( $cookie_data['path']  );
					if ( preg_match( "'.*$domain$'i", $current_domain ) && preg_match( "'^$path.*'i", $current_path ) )
						$cookie_str .= $cookie_name . '=' . $cookie_data['value'] . '; ';
				}
			}
			$this->cookies = $new_cookies;
			return $cookie_str;
		} // End of function get()
		
		function set( $name, $value, $domain, $path, $expires ) {
			$this->cookies[$name] = array(	'value' => $value,
											'domain' => $domain,
											'path' => $path,
											'expires' => $this->_timestamp( $expires )
											);
		} // End of function set()
		
		function parse( $cookie_str, $host ) {
			$cookie_str = str_replace( '; ', ';', $cookie_str ) . ';';
			$data = split( ';', $cookie_str );
			$value_str = $data[0];

			$cookie_param = 'domain=';
			$start = strpos( $cookie_str, $cookie_param );
			if ( $start > 0 ) {
				$domain = substr( $cookie_str, $start + strlen( $cookie_param ) );
				$domain = substr( $domain, 0, strpos( $domain, ';' ) );
			} else
				$domain = $host;

			$cookie_param = 'expires=';
			$start = strpos( $cookie_str, $cookie_param );
			if ( $start > 0 ) {
				$expires = substr( $cookie_str, $start + strlen( $cookie_param ) );
				$expires = substr( $expires, 0, strpos( $expires, ';' ) );
			} else
				$expires = '';
			
			$cookie_param = 'path=';
			$start = strpos( $cookie_str, $cookie_param );
			if ( $start > 0 ) {
				$path = substr( $cookie_str, $start + strlen( $cookie_param ) );
				$path = substr( $path, 0, strpos( $path, ';' ) );
			} else
				$path = '/';
							
			$sep_pos = strpos( $value_str, '=');
			
			if ($sep_pos){
				$name = substr( $value_str, 0, $sep_pos );
				$value = substr( $value_str, $sep_pos+1 );
				$this->set( $name, $value, $domain, $path, $expires );
			}
		} // End of function parse()
		
	} // End of class http_cookie	
	
/******************************************************************************************
* class http
******************************************************************************************/
	class http {
		var $_socket;
		var $host;
		var $port;
		var $http_version;
		var $user_agent;
		var $errstr;
		var $connected;
		var $uri;
		var $_proxy_host;
		var $_proxy_port;
		var $_proxy_login;
		var $_proxy_pwd;
		var $_use_proxy;
		var $_auth_login;
		var $_auth_pwd;	
		var $_response; 
		var $_request;
		var $_keep_alive;		

		function http( $http_version = HTTP_V10, $keep_alive = false, $auth = false ) {
			$this->http_version	= $http_version;
			$this->connected	= false;
			$this->user_agent	= 'CosmoHttp/1.1 (compatible; MSIE 5.5; Linux)';
			$this->host			= '';
			$this->port			= 80;
			$this->errstr		= '';

			$this->_keep_alive	= $keep_alive;
			$this->_proxy_host	= '';
			$this->_proxy_port	= -1;
			$this->_proxy_login	= '';
			$this->_proxy_pwd	= '';
			$this->_auth_login	= '';
			$this->_auth_pwd	= '';
			$this->_use_proxy	= false;
			$this->_response 	= new http_response_message();
			$this->_request		= new http_request_message();
			
		// Basic Authentification added by Mate Jovic, 2002-18-06, jovic at matoma.de
			if( is_array($auth) && count($auth) == 2 ){
				$this->_auth_login	= $auth[0];
				$this->_auth_pwd	= $auth[1];
			}
		} // End of Constuctor

		function use_proxy( $host, $port, $proxy_login = null, $proxy_pwd = null ) {
		// Proxy auth not yet supported
			$this->http_version	= HTTP_V10;
			$this->_keep_alive	= false;
			$this->_proxy_host	= $host;
			$this->_proxy_port	= $port;
			$this->_proxy_login	= $proxy_login;
			$this->_proxy_pwd	= $proxy_pwd;
			$this->_use_proxy	= true;
		}

		function set_request_header( $name, $value ) {
			$this->_request->set_header( $name, $value );
		}

		function get_response_body() {
			return $this->_response->body;
		}
		
		function get_response() {
			return $this->_response;
		}
		
		function head( $uri ) {
			$this->uri = $uri;

			if ( ($this->_keep_alive && !$this->connected) || !$this->_keep_alive ) {
				if ( !$this->_connect() ) {
					$this->errstr = 'Could not connect to ' . $this->host;
					return -1;
				}
			}
			$http_cookie = $this->_response->cookies->get( $this->host, $this->_current_directory( $uri ) );
			
			if ($this->_use_proxy) {
				$this->_request->set_header( 'Host', $this->host . ':' . $this->port );
				$this->_request->set_header( 'Proxy-Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				if ( $this->_proxy_login != '' ) $this->_request->set_header( 'Proxy-Authorization', "Basic " . base64_encode( $this->_proxy_login . ":" . $this->_proxy_pwd ) );
				$uri = 'http://' . $this->host . ':' . $this->port . $uri;
			} else {
				$this->_request->set_header( 'Host', $this->host );
				$this->_request->set_header( 'Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
			}

			if ( $this->_auth_login != '' ) $this->_request->set_header( 'Authorization', "Basic " . base64_encode( $this->_auth_login . ":" . $this->_auth_pwd ) );			
			$this->_request->set_header( 'User-Agent', $this->user_agent );
			$this->_request->set_header( 'Accept', '*/*' );
			$this->_request->set_header( 'Cookie', $http_cookie );
			
			$cmd =	"HEAD $uri HTTP/" . $this->http_version . HTTP_CRLF . 
					$this->_request->serialize_headers() .
					HTTP_CRLF;
			fwrite( $this->_socket, $cmd );
			
			$this->_request->add_debug_info( $cmd );
			$this->_get_response( false );

			if ($this->_socket && !$this->_keep_alive) $this->disconnect();
			if ( $this->_response->get_header( 'Connection' ) != null ) {
				if ( $this->_keep_alive && strtolower( $this->_response->get_header( 'Connection' ) ) == 'close' ) {
					$this->_keep_alive = false;
					$this->disconnect();
				}
			}
			
			if ( $this->_response->get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this->_parse_location( $this->_response->get_header( 'Location' ) );
				$this->disconnect();
				$this->use_proxy( $location['host'], $location['port'] );
				$this->head( $this->uri );
			}
			
			return $this->_response->get_header( 'Status' );
		} // End of function head()

		
		function get( $uri, $follow_redirects = true, $referer = '' ) {
			$this->uri = $uri;
			
			if ( ($this->_keep_alive && !$this->connected) || !$this->_keep_alive ) {
				if ( !$this->_connect() ) {
					$this->errstr = 'Could not connect to ' . $this->host;
					return -1;
				}
			}
			
			if ($this->_use_proxy) {
				$this->_request->set_header( 'Host', $this->host . ':' . $this->port );
				$this->_request->set_header( 'Proxy-Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				if ( $this->_proxy_login != '' ) $this->_request->set_header( 'Proxy-Authorization', "Basic " . base64_encode( $this->_proxy_login . ":" . $this->_proxy_pwd ) );
				$uri = 'http://' . $this->host . ':' . $this->port . $uri;
			} else {
				$this->_request->set_header( 'Host', $this->host );
				$this->_request->set_header( 'Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				$this->_request->set_header( 'Pragma', 'no-cache' );
				$this->_request->set_header( 'Cache-Control', 'no-cache' );
			}
			
			if ( $this->_auth_login != '' ) $this->_request->set_header( 'Authorization', "Basic " . base64_encode( $this->_auth_login . ":" . $this->_auth_pwd ) );
			$http_cookie = $this->_response->cookies->get( $this->host, $this->_current_directory( $uri ) );
			$this->_request->set_header( 'User-Agent', $this->user_agent );
			$this->_request->set_header( 'Accept', '*/*' );
			$this->_request->set_header( 'Referer', $referer );
			$this->_request->set_header( 'Cookie', $http_cookie );
			
			$cmd =	"GET $uri HTTP/" . $this->http_version . HTTP_CRLF . 
					$this->_request->serialize_headers() .
					HTTP_CRLF;
			fwrite( $this->_socket, $cmd );

			$this->_request->add_debug_info( $cmd );
			$this->_get_response();

			if ($this->_socket && !$this->_keep_alive) $this->disconnect();
			if (  $this->_response->get_header( 'Connection' ) != null ) {
				if ( $this->_keep_alive && strtolower( $this->_response->get_header( 'Connection' ) ) == 'close' ) {
					$this->_keep_alive = false;
					$this->disconnect();
				}
			}
			if ( $follow_redirects && ($this->_response->get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this->_response->get_status() == HTTP_STATUS_FOUND || $this->_response->get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this->_response->get_header( 'Location' ) != null  ) {
					$this->_redirect( $this->_response->get_header( 'Location' ) );
				}
			}
			
			if ( $this->_response->get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this->_parse_location( $this->_response->get_header( 'Location' ) );
				$this->disconnect();
				$this->use_proxy( $location['host'], $location['port'] );
				$this->get( $this->uri, $referer );
			}

			return $this->_response->get_status();
		} // End of function get()



		function multipart_post( $uri, &$form_fields, $form_files = null, $follow_redirects = true, $referer = '' ) {
			$this->uri = $uri;
			
			if ( ($this->_keep_alive && !$this->connected) || !$this->_keep_alive ) {
				if ( !$this->_connect() ) {
					$this->errstr = 'Could not connect to ' . $this->host;
					return -1;
				}
			}
			$boundary = uniqid('------------------');
			$http_cookie = $this->_response->cookies->get( $this->host, $this->_current_directory( $uri ) );
			$body = $this->_merge_multipart_form_data( $boundary, $form_fields, $form_files );
			$this->_request->body =  $body . HTTP_CRLF;
			$content_length = strlen( $body ); 


			if ($this->_use_proxy) {
				$this->_request->set_header( 'Host', $this->host . ':' . $this->port );
				$this->_request->set_header( 'Proxy-Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				if ( $this->_proxy_login != '' ) $this->_request->set_header( 'Proxy-Authorization', "Basic " . base64_encode( $this->_proxy_login . ":" . $this->_proxy_pwd ) );
				$uri = 'http://' . $this->host . ':' . $this->port . $uri;
			} else {
				$this->_request->set_header( 'Host', $this->host );
				$this->_request->set_header( 'Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				$this->_request->set_header( 'Pragma', 'no-cache' );
				$this->_request->set_header( 'Cache-Control', 'no-cache' );
			}

			if ( $this->_auth_login != '' ) $this->_request->set_header( 'Authorization', "Basic " . base64_encode( $this->_auth_login . ":" . $this->_auth_pwd ) );
			$this->_request->set_header( 'Accept', '*/*' );
			$this->_request->set_header( 'Content-Type', 'multipart/form-data; boundary=' . $boundary );
			$this->_request->set_header( 'User-Agent', $this->user_agent );
			$this->_request->set_header( 'Content-Length', $content_length );
			$this->_request->set_header( 'Cookie', $http_cookie );
			$this->_request->set_header( 'Referer', $referer );
							
			$req_header	= "POST $uri HTTP/" . $this->http_version . HTTP_CRLF . 
						$this->_request->serialize_headers() .
						HTTP_CRLF;

			fwrite( $this->_socket, $req_header );
			usleep(10);
			fwrite( $this->_socket, $this->_request->body );
			
			$this->_request->add_debug_info( $req_header );
			$this->_get_response();
			
			if ($this->_socket && !$this->_keep_alive) $this->disconnect();
			if ( $this->_response->get_header( 'Connection' ) != null ) {
				if ( $this->_keep_alive && strtolower( $this->_response->get_header( 'Connection' ) ) == 'close' ) {
					$this->_keep_alive = false;
					$this->disconnect();
				}
			}
			
			if ( $follow_redirects && ($this->_response->get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this->_response->get_status() == HTTP_STATUS_FOUND || $this->_response->get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this->_response->get_header( 'Location') != null ) {
					$this->_redirect( $this->_response->get_header( 'Location') );
				}
			}
			
			if ( $this->_response->get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this->_parse_location( $this->_response->get_header( 'Location') );
				$this->disconnect();
				$this->use_proxy( $location['host'], $location['port'] );
				$this->multipart_post( $this->uri, $form_fields, $form_files, $referer );
			}

			return $this->_response->get_status();
		} // End of function multipart_post()



		function post( $uri, &$form_data, $follow_redirects = true, $referer = '' ) {
			$this->uri = $uri;

			if ( ($this->_keep_alive && !$this->connected) || !$this->_keep_alive ) {
				if ( !$this->_connect() ) {
					$this->errstr = 'Could not connect to ' . $this->host;
					return -1;
				}
			}
			$http_cookie = $this->_response->cookies->get( $this->host, $this->_current_directory( $uri ) );
			$body = substr( $this->_merge_form_data( $form_data ), 1 );
			$this->_request->body =  $body . HTTP_CRLF . HTTP_CRLF;
			$content_length = strlen( $body ); 

			if ($this->_use_proxy) {
				$this->_request->set_header( 'Host', $this->host . ':' . $this->port );
				$this->_request->set_header( 'Proxy-Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				if ( $this->_proxy_login != '' ) $this->_request->set_header( 'Proxy-Authorization', "Basic " . base64_encode( $this->_proxy_login . ":" . $this->_proxy_pwd ) );
				$uri = 'http://' . $this->host . ':' . $this->port . $uri;
			} else {
				$this->_request->set_header( 'Host', $this->host );
				$this->_request->set_header( 'Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				$this->_request->set_header( 'Pragma', 'no-cache' );
				$this->_request->set_header( 'Cache-Control', 'no-cache' );
			}
			
			if ( $this->_auth_login != '' ) $this->_request->set_header( 'Authorization', "Basic " . base64_encode( $this->_auth_login . ":" . $this->_auth_pwd ) );			
			$this->_request->set_header( 'Accept', '*/*' );
			$this->_request->set_header( 'Content-Type', 'application/x-www-form-urlencoded' );
			$this->_request->set_header( 'User-Agent', $this->user_agent );
			$this->_request->set_header( 'Content-Length', $content_length );
			$this->_request->set_header( 'Cookie', $http_cookie );
			$this->_request->set_header( 'Referer', $referer );
							
			$req_header	= "POST $uri HTTP/" . $this->http_version . HTTP_CRLF . 
						$this->_request->serialize_headers() .
						HTTP_CRLF;

			fwrite( $this->_socket, $req_header );
			usleep( 10 );
			fwrite( $this->_socket, $this->_request->body );
			
			$this->_request->add_debug_info( $req_header );
			$this->_get_response();

			if ($this->_socket && !$this->_keep_alive) $this->disconnect();
			if ( $this->_response->get_header( 'Connection' ) != null ) {
				if ( $this->_keep_alive && strtolower( $this->_response->get_header( 'Connection' ) ) == 'close' ) {
					$this->_keep_alive = false;
					$this->disconnect();
				}
			}
			
			if ( $follow_redirects && ($this->_response->get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this->_response->get_status() == HTTP_STATUS_FOUND || $this->_response->get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this->_response->get_header( 'Location' ) != null ) {
					$this->_redirect( $this->_response->get_header( 'Location' ) );
				}
			}
			
			if ( $this->_response->get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this->_parse_location( $this->_response->get_header( 'Location' ) );
				$this->disconnect();
				$this->use_proxy( $location['host'], $location['port'] );
				$this->post( $this->uri, $form_data, $referer );
			}

			return $this->_response->get_status();
		} // End of function post()
		


		function post_xml( $uri, $xml_data, $follow_redirects = true, $referer = '' ) {
			$this->uri = $uri;

			if ( ($this->_keep_alive && !$this->connected) || !$this->_keep_alive ) {
				if ( !$this->_connect() ) {
					$this->errstr = 'Could not connect to ' . $this->host;
					return -1;
				}
			}
			$http_cookie = $this->_response->cookies->get( $this->host, $this->_current_directory( $uri ) );
			$body = $xml_data;
			$this->_request->body =  $body . HTTP_CRLF . HTTP_CRLF;
			$content_length = strlen( $body ); 

			if ($this->_use_proxy) {
				$this->_request->set_header( 'Host', $this->host . ':' . $this->port );
				$this->_request->set_header( 'Proxy-Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				if ( $this->_proxy_login != '' ) $this->_request->set_header( 'Proxy-Authorization', "Basic " . base64_encode( $this->_proxy_login . ":" . $this->_proxy_pwd ) );
				$uri = 'http://' . $this->host . ':' . $this->port . $uri;
			} else {
				$this->_request->set_header( 'Host', $this->host );
				$this->_request->set_header( 'Connection', ($this->_keep_alive?'Keep-Alive':'Close') );
				$this->_request->set_header( 'Pragma', 'no-cache' );
				$this->_request->set_header( 'Cache-Control', 'no-cache' );
			}
			
			if ( $this->_auth_login != '' ) $this->_request->set_header( 'Authorization', "Basic " . base64_encode( $this->_auth_login . ":" . $this->_auth_pwd ) );			
			$this->_request->set_header( 'Accept', '*/*' );
			$this->_request->set_header( 'Content-Type', 'text/xml; charset=utf-8' );
			$this->_request->set_header( 'User-Agent', $this->user_agent );
			$this->_request->set_header( 'Content-Length', $content_length );
			$this->_request->set_header( 'Cookie', $http_cookie );
			$this->_request->set_header( 'Referer', $referer );
							
			$req_header	= "POST $uri HTTP/" . $this->http_version . HTTP_CRLF . 
						$this->_request->serialize_headers() .
						HTTP_CRLF;

			fwrite( $this->_socket, $req_header );
			usleep( 10 );
			fwrite( $this->_socket, $this->_request->body );
			
			$this->_request->add_debug_info( $req_header );
			$this->_get_response();

			if ($this->_socket && !$this->_keep_alive) $this->disconnect();
			if ( $this->_response->get_header( 'Connection' ) != null ) {
				if ( $this->_keep_alive && strtolower( $this->_response->get_header( 'Connection' ) ) == 'close' ) {
					$this->_keep_alive = false;
					$this->disconnect();
				}
			}
			
			if ( $follow_redirects && ($this->_response->get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this->_response->get_status() == HTTP_STATUS_FOUND || $this->_response->get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this->_response->get_header( 'Location' ) != null ) {
					$this->_redirect( $this->_response->get_header( 'Location' ) );
				}
			}
			
			if ( $this->_response->get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this->_parse_location( $this->_response->get_header( 'Location' ) );
				$this->disconnect();
				$this->use_proxy( $location['host'], $location['port'] );
				$this->post( $this->uri, $form_data, $referer );
			}

			return $this->_response->get_status();
		} // End of function post_xml()
		
		
		function disconnect() {
			if ($this->_socket && $this->connected) {
				 fclose($this->_socket);
	 			$this->connected = false;
			 }
		} // End of function disconnect()


		/********************************************************************************
		 * Private functions 
		 ********************************************************************************/
		 
		function _connect( ) {
			if ( $this->host == '' ) user_error( 'Class HTTP->_connect() : host property not set !' , E_ERROR );
			if (!$this->_use_proxy)
				$this->_socket = fsockopen( $this->host, $this->port, $errno, $errstr, 10 );
			else
				$this->_socket = fsockopen( $this->_proxy_host, $this->_proxy_port, $errno, $errstr, 10 );
			$this->errstr  = $errstr;
			$this->connected = ($this->_socket == true);
			return $this->connected;
		} // End of function connect()


		function _merge_multipart_form_data( $boundary, &$form_fields, &$form_files ) {
			$boundary = '--' . $boundary;
			$multipart_body = '';
			foreach ( $form_fields as $name => $data) {
				$multipart_body .= $boundary . HTTP_CRLF;
				$multipart_body .= 'Content-Disposition: form-data; name="' . $name . '"' . HTTP_CRLF;
				$multipart_body .=  HTTP_CRLF;
				$multipart_body .= $data . HTTP_CRLF;
			}
			if ( isset($form_files) ) {
				foreach ( $form_files as $data) {
					$multipart_body .= $boundary . HTTP_CRLF;
					$multipart_body .= 'Content-Disposition: form-data; name="' . $data['name'] . '"; filename="' . $data['filename'] . '"' . HTTP_CRLF;
					if ($data['content-type']!='') 
						$multipart_body .= 'Content-Type: ' . $data['content-type'] . HTTP_CRLF;
					else
						$multipart_body .= 'Content-Type: application/octet-stream' . HTTP_CRLF;
					$multipart_body .=  HTTP_CRLF;
					$multipart_body .= $data['data'] . HTTP_CRLF;
				}			
			}
			$multipart_body .= $boundary . '--' . HTTP_CRLF;
			return $multipart_body;
		} // End of function _merge_multipart_form_data()
		

		function _merge_form_data( &$param_array,  $param_name = '' ) {
			$params = '';
			$format = ($param_name !=''?'&'.$param_name.'[%s]=%s':'&%s=%s');
			foreach ( $param_array as $key=>$value ) {
				if ( !is_array( $value ) )
					$params .= sprintf( $format, $key, urlencode( $value ) );
				else
					$params .= $this->_merge_form_data( $param_array[$key],  $key );
			}
			return $params;
		} // End of function _merge_form_data()

		function _current_directory( $uri ) {
			$tmp = split( '/', $uri );
			array_pop($tmp);
			$current_dir = implode( '/', $tmp ) . '/';
			return ($current_dir!=''?$current_dir:'/');
		} // End of function _current_directory()		
		
		
		function _get_response( $get_body = true ) {
			$this->_response->reset();
			$this->_request->reset();
			$header = '';
			$body = '';
			$continue	= true;
			
			while ($continue) {
				$header = '';

				// Read the Response Headers
				while ( (($line = fgets( $this->_socket, 4096 )) != HTTP_CRLF || $header == '') && !feof( $this->_socket ) ) { 
				    if ($line != HTTP_CRLF) $header .= $line; 
				}
				$this->_response->deserialize_headers( $header );
				$this->_response->parse_cookies( $this->host );
				
				$this->_response->add_debug_info( $header );
				$continue = ($this->_response->get_status() == HTTP_STATUS_CONTINUE);
				if ($continue) fwrite( $this->_socket, HTTP_CRLF );
			}

			if ( !$get_body ) return;

			// Read the Response Body
			if ( strtolower( $this->_response->get_header( 'Transfer-Encoding' ) ) != 'chunked' && !$this->_keep_alive ) {
				while ( !feof( $this->_socket ) ) { 
				    $body .= fread( $this->_socket, 4096 ); 
				}
			} else {
				if ( $this->_response->get_header( 'Content-Length' ) != null ) {
					$content_length = (integer)$this->_response->get_header( 'Content-Length' );
					$body = fread( $this->_socket, $content_length ); 
				} else {
					if ( $this->_response->get_header( 'Transfer-Encoding' ) != null ) {
						if ( strtolower( $this->_response->get_header( 'Transfer-Encoding' ) ) == 'chunked' ) {
							$chunk_size = (integer)hexdec(fgets( $this->_socket, 4096 ) ); 
							while($chunk_size > 0) {
								$body .= fread( $this->_socket, $chunk_size ); 
								fread( $this->_socket, strlen(HTTP_CRLF) ); 
								$chunk_size = (integer)hexdec(fgets( $this->_socket, 4096 ) ); 
							}
							// TODO : Read trailing http headers
						}
					} 
				}
			}
			$this->_response->body = $body;
		} // End of function _get_response()


		function _parse_location( $redirect_uri ) {
			$parsed_url 	= parse_url( $redirect_uri );
			$scheme 		= (isset($parsed_url['scheme'])?$parsed_url['scheme']:'');
			$port			= (isset($parsed_url['port'])?$parsed_url['port']:$this->port);
			$host 			= (isset($parsed_url['host'])?$parsed_url['host']:$this->host);
			$request_file 	= (isset($parsed_url['path'])?$parsed_url['path']:'');
			$query_string 	= (isset($parsed_url['query'])?$parsed_url['query']:'');
			if ( substr( $request_file, 0, 1 ) != '/' )
				$request_file = $this->_current_directory( $this->uri ) . $request_file;
			
			return array(	'scheme' => $scheme,
							'port' => $port,
							'host' => $host,
							'request_file' => $request_file,
							'query_string' => $query_string
			);

		} // End of function _parse_location()
		
		
		function _redirect( $uri ) {
			$location = $this->_parse_location( $uri );
			if ( $location['host'] != $this->host || $location['port'] != $this->port ) {
				$this->host = $location['host'];
				$this->port = $location['port'];
				if ( !$this->_use_proxy) $this->disconnect();
			}
			usleep( 100 );
			$this->get( $location['request_file'] . '?' . $location['query_string'] );
		} // End of function _redirect()

	} // End of class http
?>
--- NEW FILE: index.php3 ---
<?php

include ("inc.php3");
include_ecrire ("inc_calendrier.php");

if ($HTTP_REFERER && !strpos($HTTP_REFERER, _DIR_RESTEINT_ABS)) $bonjour = 'oui';

debut_page(_T('titre_page_index'), "asuivre", "asuivre");

debut_gauche();


if ($spip_display != 4) {
	
	//
	// Infos personnelles : nom, utilisation de la messagerie
	//
	
	
	echo "<p>";
	
	$titre_cadre = afficher_plus("auteurs_edit.php3?id_auteur=$connect_id_auteur");
	$titre_cadre .= majuscules(typo($connect_nom));
	
	debut_cadre_couleur_foncee("fiche-perso-24.gif", false, '', '');
	echo "<center><b>".$titre_cadre."</b></center>";
	fin_cadre_couleur_foncee();
	

	//
	// Supprimer le cookie, se deconnecter...
	//
	
	if ($connect_statut == "0minirezo" AND $cookie_admin) {
		$texte = _T('icone_supprimer_cookie');
		if ($spip_display != 1) $texte .= aide("cookie");
		icone_horizontale( $texte , "../spip_cookie.php3?cookie_admin=non&url=".rawurlencode(_DIR_RESTREINT_ABS), "cookie-24.gif", "");
	}

	$nom_site_spip = propre(lire_meta("nom_site"));
	if (!$nom_site_spip) $nom_site_spip="SPIP";
	
	
	echo "<div>&nbsp;</div>";
	
	echo debut_cadre_relief("racine-site-24.gif", false, "", $nom_site_spip);


	if ($spip_display != 1) {
		include_ecrire("inc_logos.php3");
	
		$logo = decrire_logo("rubon0");
		if ($logo) {
			echo "<div style='text-align:center; margin-bottom: 5px;'><a href='naviguer.php3'>";
			echo $logo[2];
			echo "</a></div>";
		}
	}
	echo "<div class='verdana1'>";

  $query = "SELECT count(*) AS cnt, statut FROM spip_articles GROUP BY statut";
  $res = spip_query($query);
  
  while($row = spip_fetch_array($res)) {
    $var  = 'nb_art_'.$row['statut'];
    $$var = $row['cnt']; 
  }
  
	if ($nb_art_prepa OR $nb_art_prop OR $nb_art_publie) {

		echo afficher_plus("articles_page.php3")."<b>"._T('info_articles')."</b>";
		echo "<ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'>";
		if ($nb_art_prepa) echo "<li>"._T("texte_statut_en_cours_redaction").": ".$nb_art_prepa;
		if ($nb_art_prop) echo "<li>"._T("texte_statut_attente_validation").": ".$nb_art_prop;
		if ($nb_art_publie) echo "<li><b>"._T("texte_statut_publies").": ".$nb_art_publie."</b>";
		echo "</ul>";

	}

	$query = "SELECT count(*) AS cnt, statut FROM spip_breves GROUP BY statut";
	$res = spip_query($query);

	while($row = spip_fetch_array($res)) {
		$var  = 'nb_bre_'.$row['statut'];
		$$var = $row['cnt']; 
	}

	if ($nb_bre_prop OR $nb_bre_publie) {
		echo afficher_plus("breves.php3")."<b>"._T('info_breves_02')."</b>";
		echo "<ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'>";
		if ($nb_bre_prop) echo "<li>"._T("texte_statut_attente_validation").": ".$nb_bre_prop;
		if ($nb_bre_publie) echo "<li><b>"._T("texte_statut_publies").": ".$nb_bre_publie."</b>";
		echo "</ul>";
	}

	$query = "SELECT count(*) AS cnt FROM spip_forum where statut='publie'";
	$result = spip_fetch_array(spip_query($query));
	$nb_forum = $result['cnt'];

	if ($nb_forum) {
		if ($connect_statut == "0minirezo") echo afficher_plus("controle_forum.php3");
		echo "<b>"._T('onglet_messages_publics')."</b>";
		echo "<ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'>";
		echo "<li><b>".$nb_forum."</b>";
		echo "</ul>";
	}

	$query = "SELECT count(*) AS cnt, statut FROM spip_auteurs GROUP BY statut";
	$res = spip_query($query);

	while($row = spip_fetch_array($res)) {
		$var  = 'nb_aut_'.$row['statut'];
		$$var = $row['cnt']; 
	}

	if ($nb_aut_0minirezo OR $nb_aut_1comite OR $nb_aut_6forum) {
		echo afficher_plus("auteurs.php3")."<b>"._T('icone_auteurs')."</b>";
		echo "<ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'>";
		if ($nb_aut_0minirezo) echo "<li>"._T("info_administrateurs").": ".$nb_aut_0minirezo;
		if ($nb_aut_1comite) echo "<li>"._T("info_redacteurs").": ".$nb_aut_1comite;
		if ($nb_aut_6forum) echo "<li>"._T("info_visiteurs").": ".$nb_aut_6forum;
		echo "</ul>";
	}

	echo "</div>";

	echo fin_cadre_relief();


//
// Afficher les raccourcis : boutons de creation d'article et de breve, etc.
//


	creer_colonne_droite();
	echo "<div>&nbsp;</div>";	


	
	//
	// Annonces
	//
	echo    http_calendrier_rv(sql_calendrier_taches_annonces(),"annonces");
	echo    http_calendrier_rv(sql_calendrier_taches_pb(),"pb") ;
	echo    http_calendrier_rv(sql_calendrier_taches_rv(), "rv");

	
	//
	// Afficher le calendrier du mois s'il y a des rendez-vous
	//
	
		$today = getdate(time());
		$jour_today = $today["mday"];
		$mois_today = $today["mon"];
		$annee_today = $today["year"];
		$date = date("Y-m-d", mktime(0,0,0,$mois_today, 1, $annee_today));
		$mois = mois($date);
		$annee = annee($date);
		$jour = jour($date);
	
		// rendez-vous personnels dans le mois
		$result_messages = spip_query("SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien ".
				"WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') ".
				"AND messages.rv='oui' AND messages.date_heure >='$annee-$mois-1' AND date_heure < DATE_ADD('$annee-$mois-1', INTERVAL 1 MONTH) ".
				"AND messages.statut='publie' LIMIT 0,1");
		if (spip_num_rows($result_messages)) {
			echo "<p />";
			echo http_calendrier_agenda ($mois_today, $annee_today, $jour_today, $mois_today, $annee_today);
		}
		// rendez-vous personnels dans le mois
		$result_messages = spip_query("SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien ".
				"WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') ".
				"AND messages.rv='oui' AND messages.date_heure >='$annee_today-$mois_today-$jour_today' AND messages.date_heure < DATE_ADD('$annee_today-$mois_today-$jour_today', INTERVAL 1 DAY) ".
				"AND messages.statut='publie' LIMIT 0,1");
		if (spip_num_rows($result_messages)) {
			echo "<p />";
		echo http_calendrier_jour($jour_today,$mois_today,$annee_today, "col");
		}
}


debut_droite();



//
// Restauration d'une archive
//

if ($meta["debut_restauration"]) {
	@ignore_user_abort(1);
	include_ecrire("inc_import.php3");

	$archive = $meta["fichier_restauration"];
	$my_pos = $meta["status_restauration"];
	$ok = @file_exists($archive);

	if ($ok) {
		if (ereg("\.gz$", $archive)) {
			$affiche_progression_pourcent = false;
			$taille = taille_en_octets($my_pos);
		}
		else {
			$affiche_progression_pourcent = filesize($archive);
			$taille = floor(100 * $my_pos / $affiche_progression_pourcent)." %";
		}
		$texte_boite = _T('info_base_restauration')."<p>
		<form name='progression'><center><input type='text' size=10 style='text-align:center;' name='taille' value='$taille'><br>
		<input type='text' class='forml' name='recharge' value='"._T('info_recharger_page')."'></center></form>";
	}
	else {
		$texte_boite = _T('info_erreur_restauration');
	}

	debut_boite_alerte();
	echo "<font FACE='Verdana,Arial,Sans,sans-serif' SIZE=4 color='black'><B>$texte_boite</B></font>";
	fin_boite_alerte();
	fin_page("jimmac");
	echo "</HTML><font color='white'>\n<!--";
	@flush();
	$gz = $flag_gz;
	$_fopen = ($gz) ? gzopen : fopen;

	if ($ok) {
		$f = $_fopen($archive, "rb");
		$pos = 0;
		$buf = "";
		if (!import_all($f, $gz)) import_abandon();
	}
	else {
		import_fin();
	}
	exit;
}


//
// Articles post-dates en attente de publication
//

$post_dates = lire_meta("post_dates");

if ($post_dates == "non" AND $connect_statut == '0minirezo' AND $options == 'avancees') {
	echo "<p>";
	afficher_articles(_T('info_article_a_paraitre'),
		"WHERE statut='publie' AND date>NOW() ORDER BY date");
}



//
// Vos articles en cours de redaction
//

echo "<p>";
$vos_articles = afficher_articles(afficher_plus('articles_page.php3')._T('info_en_cours_validation'),
	", spip_auteurs_articles AS lien WHERE articles.id_article=lien.id_article ".
	"AND lien.id_auteur=$connect_id_auteur AND articles.statut='prepa' ORDER BY articles.date DESC");

if ($vos_articles) $vos_articles = ' AND articles.id_article NOT IN ('.join($vos_articles,',').')';

echo "<div>&nbsp;</div>";
echo debut_cadre_trait_couleur();

//
// Raccourcis pour malvoyants
//
if ($spip_display == 4) {
	debut_raccourcis();
	$query = "SELECT id_rubrique FROM spip_rubriques LIMIT 0,1";
	$result = spip_query($query);
	
	if (spip_num_rows($result) > 0) {
		icone_horizontale(_T('icone_ecrire_article'), "articles_edit.php3?new=oui", "article-24.gif","creer.gif");
	
		$activer_breves = lire_meta("activer_breves");
		if ($activer_breves != "non") {
			icone_horizontale(_T('icone_nouvelle_breve'), "breves_edit.php3?new=oui", "breve-24.gif","creer.gif");
		}
	}
	else {
		if ($connect_statut == '0minirezo') {
			echo "<div class='verdana11'>"._T('info_ecrire_article')."</div>";
		}
	}
	if ($connect_statut == '0minirezo' and $connect_toutes_rubriques) {
		icone_horizontale(_T('icone_creer_rubrique_2'), "rubriques_edit.php3?new=oui", "rubrique-24.gif","creer.gif");
	}
	fin_raccourcis();
} else {

		$query = "SELECT id_rubrique FROM spip_rubriques LIMIT 0,1";
		$result = spip_query($query);
		$gadget = "";
		
		if (spip_num_rows($result) > 0) {
			$id_rubrique = $GLOBALS['id_rubrique'];
			if ($id_rubrique > 0) {
				$dans_rub = "&id_rubrique=$id_rubrique";
				$dans_parent = "&id_parent=$id_rubrique";
			}
			$gadget = "<center><table><tr>";
			if ($connect_statut == "0minirezo") {
				$gadget .= "<td>";
				$gadget .= icone_horizontale(_T('icone_creer_rubrique'), "rubriques_edit.php3?new=oui", "rubrique-24.gif", "creer.gif", false);
				$gadget .= "</td>";
			}
			
			$gadget .= "<td>";
			$gadget .= icone_horizontale(_T('icone_ecrire_article'), "articles_edit.php3?new=oui$dans_rub", "article-24.gif","creer.gif", false);
			$gadget .= "</td>";
			
			$activer_breves = lire_meta("activer_breves");
			if ($activer_breves != "non") {
				$gadget .= "<td>";
				$gadget .= icone_horizontale(_T('icone_nouvelle_breve'), "breves_edit.php3?new=oui$dans_rub", "breve-24.gif","creer.gif", false);
				$gadget .= "</td>";
			}
			
			if (lire_meta("activer_sites") == 'oui') {
				if ($connect_statut == '0minirezo' OR lire_meta("proposer_sites") > 0) {
					$gadget .= "<td>";
					$gadget .= icone_horizontale(_T('info_sites_referencer'), "sites_edit.php3?new=oui$dans_rub", "site-24.gif","creer.gif", false);
					$gadget .= "</td>";
				}
			}
			
		}

		$gadget .= "</tr></table></center>\n";

	echo $gadget;



	if ($connect_statut != "0minirezo") {
	
		$gadget = "<center><table><tr>";
	
		$nombre_articles = spip_num_rows(spip_query("SELECT art.id_article FROM spip_articles AS art, spip_auteurs_articles AS lien WHERE lien.id_auteur = '$connect_id_auteur' AND art.id_article = lien.id_article LIMIT 0,1"));
		if ($nombre_articles > 0) {
			$gadget .= "<td>";
			$gadget .= icone_horizontale (_T('icone_tous_articles'), "articles_page.php3", "article-24.gif", "", false);
			$gadget .= "</td>";
		}
	
		$activer_breves=lire_meta("activer_breves");
		if ($activer_breves != "non"){
			$gadget .= "<td>";
			$gadget .= icone_horizontale (_T('icone_breves'), "breves.php3", "breve-24.gif", "", false);
			$gadget .= "</td>";
		}
	
		$articles_mots = lire_meta('articles_mots');
		if ($articles_mots != "non") {
			$gadget .= "<td>";
			$gadget .= icone_horizontale  (_T('icone_mots_cles'), "mots_tous.php3", "mot-cle-24.gif", "", false);
			$gadget .= "</td>";
		}

		$activer_sites = lire_meta('activer_sites');
		if ($activer_sites<>'non') {
			$gadget .= "<td>";
			$gadget .= icone_horizontale  (_T('icone_sites_references'), "sites_tous.php3", "site-24.gif", "", false);
			$gadget .= "</td>";
		}
		$gadget .= "</tr></table></center>\n";
		
		echo $gadget;
	}

}




//
// Modification du cookie
//

if ($connect_statut == "0minirezo" AND $spip_display != 4) {
	if (!$cookie_admin) {
		echo "<div>&nbsp;</div>";
		echo "<table width=95%><tr>";
		echo "<td width=100%>";
		echo _T('info_activer_cookie');
		echo aide ("cookie");
		echo "</td>";
		echo "<td width=10><img src='" . _DIR_IMG_PACK . "rien.gif' width=10 alt='' />";
		echo "</td>";
		echo "<td width='250'>";
		icone_horizontale(_T('icone_activer_cookie'), "../spip_cookie.php3?cookie_admin=".rawurlencode("@$connect_login")."&url=".rawurlencode(_DIR_RESTREINT_ABS), "cookie-24.gif", "");
		echo "</td></tr></table>";
	}
}
echo fin_cadre_trait_couleur();
echo "<div>&nbsp;</div>";


//
// Verifier les boucles a mettre en relief
//

$relief = false;

if (!$relief) {
	$query = "SELECT id_article FROM spip_articles AS articles WHERE statut='prop'$vos_articles LIMIT 0,1";
	$result = spip_query($query);
	$relief = (spip_num_rows($result) > 0);
}

if (!$relief) {
	$query = "SELECT id_breve FROM spip_breves WHERE statut='prop' LIMIT 0,1";
	$result = spip_query($query);
	$relief = (spip_num_rows($result) > 0);
}

if (!$relief AND lire_meta('activer_syndic') != 'non') {
	$query = "SELECT id_syndic FROM spip_syndic WHERE statut='prop' LIMIT 0,1";
	$result = spip_query($query);
	$relief = (spip_num_rows($result) > 0);
}

if (!$relief AND lire_meta('activer_syndic') != 'non' AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
	$query = "SELECT id_syndic FROM spip_syndic WHERE syndication='off' LIMIT 0,1";
	$result = spip_query($query);
	$relief = (spip_num_rows($result) > 0);
}


if ($relief) {
	debut_cadre_couleur_foncee("",false, "", _T('texte_en_cours_validation'));
	
	//echo "<div class='verdana2' style='color: black;'><b>"._T('texte_en_cours_validation')."</b></div><p>";

	//
	// Les articles a valider
	//
	afficher_articles(_T('info_articles_proposes'),
		"WHERE statut='prop'$vos_articles ORDER BY date DESC");

	//
	// Les breves a valider
	//
	$query = "SELECT * FROM spip_breves WHERE statut='prepa' OR statut='prop' ORDER BY date_heure DESC";
	afficher_breves(afficher_plus('breves.php3')._T('info_breves_valider'), $query, true);

	//
	// Les sites references a valider
	//
	if (afficher_plus('sites_tous.php3').lire_meta('activer_syndic') != 'non') {
		include_ecrire("inc_sites.php3");
		afficher_sites(afficher_plus('sites_tous.php3')._T('info_site_valider'), "SELECT * FROM spip_syndic WHERE statut='prop' ORDER BY nom_site");
	}

	//
	// Les sites a probleme
	//
	if (lire_meta('activer_syndic') != 'non' AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
		include_ecrire("inc_sites.php3");
		afficher_sites(afficher_plus('sites_tous.php3')._T('avis_sites_syndiques_probleme'),
			"SELECT * FROM spip_syndic WHERE syndication='off' AND statut='publie' ORDER BY nom_site");
	}

	// Les articles syndiques en attente de validation
	if ($connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
		$result = spip_query ("SELECT COUNT(*) AS compte FROM spip_syndic_articles WHERE statut='dispo'");
		if (($row = spip_fetch_array($result)) AND $row['compte'])
			echo "<br><small><a href='sites_tous.php3'>".$row['compte']." "._T('info_liens_syndiques_1')."</a> "._T('info_liens_syndiques_2')."</small>";
	}

	// Les forums en attente de moderation
	if ($connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
		$result = spip_query ("SELECT COUNT(*) AS compte FROM spip_forum WHERE statut='prop'");
		if (($row = spip_fetch_array($result)) AND $row['compte']) {
			echo "<br><small> <a href='controle_forum.php3'>".$row['compte'];
			if ($row['compte']>1)
				echo " "._T('info_liens_syndiques_3')."</a> "._T('info_liens_syndiques_4');
			else
				echo " "._T('info_liens_syndiques_5')."</a> "._T('info_liens_syndiques_6');
			echo " "._T('info_liens_syndiques_7')."</small>.";
		}
	}

	fin_cadre_couleur_foncee();
}


if ($options == 'avancees') {

	/* Ne plus afficher: il y a la page "Tous vos articles" pour cela
	// Vos articles publies
	echo "<p>";
	afficher_articles(afficher_plus('articles_page.php3')._T('info_derniers_articles_publies'),
		", spip_auteurs_articles AS lien ".
		"WHERE articles.id_article=lien.id_article AND lien.id_auteur=\"$connect_id_auteur\" AND articles.statut=\"publie\" ORDER BY articles.date DESC", true);
	*/

	// Dernieres modifications d'articles
	include_ecrire("inc_suivi_revisions.php");
	afficher_suivi_versions (0, 0, false, "", true);
}


fin_page("jimmac");


//
// Si necessaire, recalculer les rubriques
//

if (lire_meta('calculer_rubriques') == 'oui') {
	calculer_rubriques();
	effacer_meta('calculer_rubriques');
	ecrire_metas();
}


//
// Renouvellement de l'alea utilise pour valider certaines operations
// (ajouter une image, etc.)
//

$maj_alea = $meta_maj['alea_ephemere'];
$t_jour = substr($maj_alea, 6, 2);
if (abs($t_jour - date('d')) > 2) {
	include_ecrire("inc_session.php3");
	$alea = md5(creer_uniqid());
	ecrire_meta('alea_ephemere_ancien', lire_meta('alea_ephemere'));
	ecrire_meta('alea_ephemere', $alea);
	ecrire_metas();
}


//
// Optimisation periodique de la base de donnees
//
if (!$bonjour) {
	if ($optimiser == 'oui' || (time() - lire_meta('date_optimisation')) > 24 * 3600) {
		if (!file_exists($lock = _DIR_SESSIONS.'optimisation.lock')
		OR (time()-filemtime($lock) > 3600)) {
			touch($lock);
			ecrire_meta("date_optimisation", time());
			ecrire_metas();
			include ("optimiser.php3");
			unlink($lock);
		}
	}
}

?>

--- NEW FILE: lab_ortho.php ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_ECRIRE_INC_ORTHO")) return;
define("_ECRIRE_INC_ORTHO", "1");


// Mettre a jour la liste locale des miroirs
function maj_miroirs_ortho() {
	$liste = explode(" ", lire_meta("liste_miroirs_ortho"));
	$miroirs_old = array();
	foreach ($liste as $index) {
		list($url) = explode(" ", lire_meta("miroir_ortho_$index"));
		$miroirs_old[$url] = $index;
	}

	// TODO: recuperer la liste dynamiquement depuis ortho.spip.net
	$urls = array(
		'http://tony.ortho.spip.net/ortho_serveur.php',
		'http://spip-ortho.linagora.org:18080/ortho_serveur.php',
		'http://ortho.spip.net/ortho_serveur.php'
	);
	$liste = array();
	$miroirs_new = array();
	$index = 1;
	foreach ($urls as $url) {
		if ($index_old = $miroirs_old[$url]) {
			$s = lire_meta("miroir_ortho_$index_old");
		}
		else {
			$s = $url." ".time();
		}
		$miroirs_new[$index] = $s;
		$liste[] = $index++;
	}
	foreach ($miroirs_old as $index) {
		effacer_meta("miroir_ortho_$index");
	}
	foreach ($miroirs_new as $index => $s) {
		ecrire_meta("miroir_ortho_$index", $s);
	}
	ecrire_meta("liste_miroirs_ortho", join(" ", $liste));
}

// Lire la liste des miroirs et les langues associees
function lire_miroirs_ortho() {
	global $miroirs_ortho, $index_miroirs_ortho, $duree_cache_miroirs_ortho;

	$miroirs_ortho = array();
	$index_miroirs_ortho = array();

	$t = time();
	$maj = lire_meta("maj_miroirs_ortho");
	if ($maj < $t - $duree_cache_miroirs_ortho) {
		maj_miroirs_ortho();
		ecrire_meta("maj_miroirs_ortho", $t);
		lire_metas();
	}

	$liste = explode(" ", lire_meta("liste_miroirs_ortho"));
	foreach ($liste as $index) {
		$s = explode(" ", lire_meta("miroir_ortho_$index"));
		$url = $s[0];
		$maj = $s[1];
		$langs = explode(",", $s[2]);
		// Reinitialiser periodiquement la liste des langues non-supportees
		if ($maj < $t - $duree_cache_miroirs_ortho) {
			foreach ($langs as $key => $lang) {
				if (substr($lang, 0, 1) == '!') unset($langs[$key]);
			}
			$s[1] = $t;
			$s[2] = join(",", $langs);
			ecrire_meta("miroir_ortho_$index", join(" ", $s));
		}
		$index_miroirs_ortho[$url] = $index;
		$miroirs_ortho[$url] = array();
		foreach ($langs as $lang) {
			if ($lang) $miroirs_ortho[$url][$lang] = $lang;
		}
	}
	lire_metas();
	mt_srand(time());
}

// Sauvegarder les infos de langues pour le miroir
function ecrire_miroir_ortho($url, $langs) {
	global $index_miroirs_ortho;

	$index = $index_miroirs_ortho[$url];
	$s = explode(" ", lire_meta("miroir_ortho_$index"));
	$s[2] = join(",", $langs);
	ecrire_meta("miroir_ortho_$index", join(" ", $s));
}

function ajouter_langue_miroir($url, $lang) {
	global $miroirs_ortho;
	$langs = $miroirs_ortho[$url];
	$langs[$lang] = $lang;
	unset($langs["!$lang"]);
	ecrire_miroir_ortho($url, $langs);
}

function enlever_langue_miroir($url, $lang) {
	global $miroirs_ortho;
	$langs = $miroirs_ortho[$url];
	unset($langs[$lang]);
	$langs["!$lang"] = "!$lang";
	ecrire_miroir_ortho($url, $langs);
}

function reset_miroir($url) {
	global $miroirs_ortho;
	ecrire_miroir_ortho($url, array());
}

//
// Renvoie la liste des miroirs utilisables pour une langue donnee
//
function chercher_miroirs_ortho($lang) {
	global $miroirs_ortho;
	
	$result = array();
	$chercher = true;
	foreach ($miroirs_ortho as $url => $langs) {
		if ($langs[$lang]) {
			$result[] = $url;
		}
		else if ($chercher && !$langs["!$lang"]) {
			//echo "test $lang $url<br />";
			if (verifier_langue_miroir($url, $lang)) $result[] = $url;
			// Ne recuperer la langue d'un miroir qu'une seule fois par requete
			if ($result) $chercher = false;
		}
	}
	return $result;
}

function choisir_miroirs_ortho($lang) {
	$liste = chercher_miroirs_ortho($lang);
	if (!count($liste)) return false;
	foreach ($liste as $url) {
		$miroirs[md5(mt_rand().$url.rand())] = $url;
	}
	ksort($miroirs);
	return $miroirs;
}

//
// Envoyer une requete a un serveur d'orthographe
//
function post_ortho($url, $texte, $lang) {
	$errno = $errstr = "";

	$t = parse_url($url);
	if ($t['scheme'] != 'http') return false;

	$http_proxy = lire_meta("http_proxy");
	if (eregi("^http://([^:]*)(:(.*))?", $http_proxy, $rr)) {
		$host= $rr[1];
		if($rr[2]) {
			$port= $rr[3];
		} else {
			$port= 80;
		}
		$path= $url;
	} else {
		$host = $t['host'];
		$port = $t['port'] ? $t['port'] : 80;
		$path = $t['path'] ? $t['path'] : "/";
	}

	// Envoyer la requete en POST
	$f = @fsockopen($host, $port, $errno, $errstr, 2);
	if (!$f) return false;
	fputs($f, "POST $path HTTP/1.0\r\n");

	// Si le texte est petit, l'overhead du multipart est dispendieux
	if (!$GLOBALS['flag_gz'] || strlen($texte) < 200) {
		$gz = false;
		$body = "op=spell&lang=".urlencode($lang)."&texte=".urlencode($texte);
		fputs($f, "Content-Type: application/x-www-form-urlencoded\r\n");
	}
	// Sinon, on passe en multipart pour compresser la chaine a corriger
	else {
		// Il faut eliminer les caracteres 0 sinon PHP ne lit pas la suite du parametre
		// passe en multipart/form-data (gros hack bien sale)
		$texte_gz = gzcompress($texte);
		for ($echap = 255; $echap > 0; $echap--) {
			$str_echap = chr($echap ^ 1).chr($echap).chr($echap).chr($echap ^ 2);
			if (!is_int(strpos($texte_gz, $str_echap))) break;
		}
		$texte_gz = str_replace("\x00", $str_echap, $texte_gz);
		$gz = true;
		$vars = array('op' => 'spell', 'lang' => $lang, 'texte' => $texte_gz, 'gz' => 1, 'nul_echap' => $str_echap);
		$boundary = substr(md5(rand().'ortho'), 0, 8);
		$body = '';
		foreach ($vars as $key => $val) {
			$body .= "\r\n--$boundary\r\n";
			$body .= "Content-Disposition: form-data; name=\"$key\"\r\n";
			$body .= "\r\n";
			$body .= $val;
		}
		$body .= "\r\n--$boundary\r\n";
		fputs($f, "Content-Type: multipart/form-data; boundary=$boundary\r\n");
	}

	// On envoie le contenu
	fputs($f, "Content-Length: ".strlen($body)."\r\n");
	fputs($f, "Host: $host\r\n\r\n");
	fputs($f, $body);

	// Lire les en-tetes HTTP de la reponse et decoder le Content-Length
	$length = 0;
	$s = fgets($f, 1000);
	$statut = 0;
	if (preg_match(',^HTTP/\d+\.\d+ (\d+) ,', $s, $r))
		$statut = intval($r[1]);
	if ($statut != 200) {
		fclose($f);
		return false;
	}
	while ($s = trim(fgets($f, 1000))) {
		if (preg_match(',Content-Length:(.*),i', $s, $r))
			$length = intval($r[1]);
	}
	$r = "";

	// Lire le corps de la reponse HTTP
	if ($length) {
		while (($l = strlen($r)) < $length) $r .= fread($f, $length - $l);
	}
	else while (!feof($f) AND $r .= fread($f, 1024));

	fclose($f);
	if ($gz) $r = gzuncompress($r);
	return $r;
}

//
// Verifier si un serveur gere une langue donnee
//
function verifier_langue_miroir($url, $lang) {
	// Envoyer une requete bidon
	$result = post_ortho($url, " ", $lang);
	if (!preg_match(',<ortho>.*</ortho>,s', $result)) {
		reset_miroir($url);
		return false;
	}
	if (!preg_match(',<erreur>.*<code>E_LANG_ABSENT</code>.*</erreur>,s', $result)) {
		ajouter_langue_miroir($url, $lang);
		return true;
	}
	enlever_langue_miroir($url, $lang);
	return false;
}


//
// Gestion du dictionnaire local
//
function suggerer_dico_ortho(&$mots, $lang) {
	$lang = addslashes($lang);
	$query = "SELECT mot FROM spip_ortho_dico WHERE lang='$lang' ".
		"AND mot IN ('".join("', '", array_map('addslashes', $mots))."')";
	$result = spip_query($query);

	$mots = array_flip($mots);
	$bons = array();
	if (isset($mots[''])) unset($mots['']);
	while ($row = spip_fetch_array($result)) {
		$mot = $row['mot'];
		if (isset($mots[$mot])) {
			unset($mots[$mot]);
			$bons[] = $mot;
		}
	}

	if (count($mots)) $mots = array_flip($mots);
	else $mots = array();
	return $bons;
}

function ajouter_dico_ortho($mot, $lang) {
	global $connect_id_auteur;

	$lang = addslashes($lang);
	$mot = addslashes($mot);
	$id_auteur = intval($connect_id_auteur);
	$query = "INSERT IGNORE INTO spip_ortho_dico (lang, mot, id_auteur) ".
		"VALUES ('$lang', '$mot', '$id_auteur')";
	spip_query($query);
}

function supprimer_dico_ortho($mot, $lang) {
	$lang = addslashes($lang);
	$mot = addslashes($mot);
	$query = "DELETE FROM spip_ortho_dico WHERE lang='$lang' AND mot='$mot'";
	spip_query($query);
}

function gerer_dico_ortho($lang) {
	global $ajout_ortho, $supp_ortho;
	if ($mot = strval($ajout_ortho)) {
		ajouter_dico_ortho($mot, $lang);
	}
	if ($mot = strval($supp_ortho)) {
		supprimer_dico_ortho($mot, $lang);
	}
}


//
// Gestion du cache de corrections
//
function suggerer_cache_ortho(&$mots, $lang) {
	global $duree_cache_ortho;

	$lang = addslashes($lang);
	$query = "SELECT mot, ok, suggest FROM spip_ortho_cache WHERE lang='$lang' ".
		"AND mot IN ('".join("', '", array_map('addslashes', $mots))."') ".
		"AND maj > FROM_UNIXTIME(".(time() - $duree_cache_ortho).")";
	$result = spip_query($query);
	
	$mots = array_flip($mots);
	$suggest = array();
	if (isset($mots[''])) unset($mots['']);
	while ($row = spip_fetch_array($result)) {
		$mot = $row['mot'];
		if (isset($mots[$mot])) {
			unset($mots[$mot]);
			if (!$row['ok']) {
				if (strlen($row['suggest']))
					$suggest[$mot] = explode(",", $row['suggest']);
				else
					$suggest[$mot] = array();
			}
		}
	}
	if (count($mots)) $mots = array_flip($mots);
	else $mots = array();
	return $suggest;
}

function ajouter_cache_ortho($tous, $mauvais, $lang) {
	global $duree_cache_ortho;

	$values = array();
	$lang = addslashes($lang);
	if (count($mauvais)) {
		foreach ($mauvais as $mot => $suggest) {
			$values[] = "('$lang', '".addslashes($mot)."', 0, '".addslashes(join(",", $suggest))."')";
		}
	}
	if (count($tous)) {
		foreach ($tous as $mot) {
			if (!isset($mauvais[$mot]))
				$values[] = "('$lang', '".addslashes($mot)."', 1, '')";
		}
	}
	if (count($values)) {
		$query = "DELETE FROM spip_ortho_cache ".
			"WHERE maj < FROM_UNIXTIME(".(time() - $duree_cache_ortho).")";
		spip_query($query);
		$query = "INSERT IGNORE INTO spip_ortho_cache (lang, mot, ok, suggest) ".
			"VALUES ".join(", ", $values);
		spip_query($query);
	}
}


//
// Cette fonction doit etre appelee pour reecrire le texte en utf-8 "propre"
//
function preparer_ortho($texte, $lang) {
	include_spip("charsets.php");

	$charset = lire_meta('charset');

	if ($charset == 'utf-8')
		return unicode_to_utf_8(html2unicode($texte));
	else
		return unicode_to_utf_8(html2unicode(charset2unicode($texte, $charset, true)));
}

function afficher_ortho($texte) {
	$charset = lire_meta('charset');
	if ($charset == 'utf-8') return $texte;

	if (!is_array($texte)) return charset2unicode($texte, 'utf-8');
	foreach ($texte as $key => $val) {
		$texte[$key] = afficher_ortho($val);
	}
	return $texte;
}

//
// Cette fonction envoie le texte prepare a un serveur d'orthographe
// et retourne un tableau de mots mal orthographies associes chacun a un tableau de mots suggeres
//
function corriger_ortho($texte, $lang, $charset = 'AUTO') {
	include_spip("charsets.php");
	include_spip("index.php");
	include_spip("filtres.php");

	$texte = preg_replace(',<code>.*?</code>,is', '', $texte);
	$texte = preg_replace(',<cadre>.*?</cadre>,is', '', $texte);
	$texte = preg_replace(',\[([^][]*)->([^][]*)\],is', '\\1', $texte);
	$texte = supprimer_tags($texte);

	$texte = " ".$texte." ";
	
	// Virer les caracteres non-alphanumeriques
	if (test_pcre_unicode()) {
		$texte = preg_replace(',[^-\''.pcre_lettres_unicode().']+,us', ' ', $texte);
	}
	else {
		// Ici bidouilles si PCRE en mode UTF-8 ne fonctionne pas correctement ...
		// Caracteres non-alphanumeriques de la plage latin-1 + saloperies non-conformes
		$texte = preg_replace(',\xC2[\x80-\xBF],', ' ', $texte);
		// Poncutation etendue (unicode)
		$texte = preg_replace(",".plage_punct_unicode().",", ' ', $texte);
		// Caracteres ASCII non-alphanumeriques
		$texte = preg_replace(",[^-a-zA-Z0-9\x80-\xFF']+,", ' ', $texte);
	}
	$texte = preg_replace(', [-\']+,', ' ', $texte); // tirets de typo
	$texte = preg_replace(',\' ,', ' ', $texte); // apostrophes utilisees comme guillemets

	//echo htmlspecialchars($texte)."<br>";

	// Virer les mots contenant au moins un chiffre
	$texte = preg_replace(', ([^ ]*\d[^ ]* )+,', ' ', $texte);

	// Melanger les mots
	$mots = preg_split(', +,', $texte);
	sort($mots);
	$mots = array_unique($mots);

	// 1. Enlever les mots du dico local
	$bons = suggerer_dico_ortho($mots, $lang);

	// 2. Enlever les mots du cache local
	$result_cache = suggerer_cache_ortho($mots, $lang);

	// 3. Envoyer les mots restants a un serveur
	$mauvais = array();
	if (count($mots)) {
		$texte = join(' ', $mots);
		
		// Hack : ligatures en francais pas gerees par aspell
		unset($trans_rev);
		$texte_envoi = $texte;
		if ($lang == 'fr') {
			$trans = array(chr(197).chr(146) => 'OE', chr(197).chr(147) => 'oe', 
					chr(195).chr(134) => 'AE', chr(195).chr(166) => 'ae');
			$texte_envoi = strtr($texte_envoi, $trans);
			$trans_rev = array_flip($trans);
		}
		
		// POST de la requete et recuperation du resultat XML
		$urls = choisir_miroirs_ortho($lang);
		if (!$urls) return false;
		unset($ok);
		$erreur = false;
		foreach ($urls as $url) {
			$xml = post_ortho($url, $texte_envoi, $lang);
			if ($xml && preg_match(',<ortho>(.*)</ortho>,s', $xml, $r)) {
				$xml = $r[1];
				if (preg_match(',<erreur>.*<code>(.*)</code>.*</erreur>,s', $xml, $r)) 
					$erreur = $r[1];
				if (preg_match(',<ok>(.*)</ok>,s', $xml, $r)) {
					$ok = $r[1];
					break;
				}
			}
			reset_miroir($url);
		}
		if (!isset($ok)) return $erreur;

		// Remplir le tableau des resultats (mots mal orthographies)
		if ($trans_rev) {
			$assoc_mots = array_flip($mots);
		}
		while (preg_match(',<mot>(.*?)</mot>(\s*<suggest>(.*?)</suggest>)?,s', $ok, $r)) {
			$p = strpos($ok, $r[0]);
			$ok = substr($ok, $p + strlen($r[0]));
			$mot = $r[1];
			if ($suggest = $r[3]) 
				$s = preg_split('/[ ,]+/', $suggest);
			else 
				$s = array();
			// Hack ligatures
			if ($trans_rev) {
				$mot_rev = strtr($mot, $trans_rev);
				if ($mot != $mot_rev) {
					if ($assoc_mots[$mot]) 
						$mauvais[$mot] = $s;
					if ($assoc_mots[$mot_rev]) 
						$mauvais[$mot_rev] = $s;
				}
				else $mauvais[$mot] = $s;
			}
			else $mauvais[$mot] = $s;
		}
	}
	if (!$erreur) ajouter_cache_ortho($mots, $mauvais, $lang);

	// Retour a l'envoyeur
	$mauvais = array_merge($result_cache, $mauvais);
	$result = array(
		'bons' => $bons,
		'mauvais' => $mauvais
	);
	if ($erreur) $result['erreur'] = $erreur;
	return $result;
}

//
// Fonctions d'affichage HTML
//

function panneau_ortho($ortho_result) {
	global $id_suggest;

	$id_suggest = array();
	$i = 1;

	$mauvais = $ortho_result['mauvais'];
	$bons = $ortho_result['bons'];
	if (!count($mauvais) && !count($bons)) return;
	ksort($mauvais);

	echo "<script type='text/javascript'><!--
	var curr_suggest = null;
	function suggest(id) {
		var menu_box;
		if (curr_suggest)
			document.getElementById('suggest' + curr_suggest).className = 'suggest-inactif';
		if (1 || id!=curr_suggest) {
			document.getElementById('suggest' + id).className = 'suggest-actif';
			curr_suggest = id;
		}
		else curr_suggest = null;
		menu_box = document.getElementById('select_ortho');
		if (menu_box.length > id) menu_box.selectedIndex = id;
	}";
	echo "//--></script>";

	echo "<form class='form-ortho verdana2' action='' method='get'>\n";
	echo "<select name='select_ortho' id='select_ortho' onChange='suggest(this.selectedIndex);'>\n";
	echo "<option value='0'>... "._T('ortho_mots_a_corriger')." ...</option>\n";
	foreach ($mauvais as $mot => $suggest) {
		$id = $id_suggest[$mot] = "$i";
		$i++;
		$mot_html = afficher_ortho($mot);
		echo "<option value='$id'>$mot_html</option>\n";
	}
	foreach ($bons as $mot) {
		$id = $id_suggest[$mot] = "$i";
		$i++;
	}
	echo "</select>\n";
	echo "</form>\n";
	// Mots mal orthographies :
	// liste des suggestions plus lien pour ajouter au dico
	foreach ($mauvais as $mot => $suggest) {
		$id = $id_suggest[$mot];
		$mot_html = afficher_ortho($mot);
		echo "<div class='suggest-inactif' id='suggest$id'>";
		echo "<span class='ortho'>$mot_html</span>\n";
		echo "<div class='detail'>\n";
		if (is_array($suggest) && count($suggest)) {
			echo "<ul>\n";
			$i = 0;
			foreach ($suggest as $sug) {
				if (++$i > 12) {
					echo "<li><i>(...)</i></li>\n";
					break;
				}
				echo "<li>".typo(afficher_ortho($sug))."</li>\n";
			}
			echo "</ul>\n";
		}
		else {
			echo "<i>"._T('ortho_aucune_suggestion')."</i>";
		}
		echo "<br />";
		$link = new Link;
		$link->delVar('supp_ortho');
		$link->addVar('ajout_ortho', $mot);
		icone_horizontale(_T('ortho_ajouter_ce_mot'), $link->getUrl(), "ortho-24.gif", "creer.gif");
		echo "</div>\n";
		echo "</div>\n\n";
	}
	// Mots trouves dans le dico :
	// message plus lien pour retirer du dico
	foreach ($bons as $mot) {
		$id = $id_suggest[$mot];
		$mot_html = afficher_ortho($mot);
		echo "<div class='suggest-inactif' id='suggest$id'>";
		echo "<span class='ortho-dico'>$mot_html</span>";
		echo "<div class='detail'>\n";
		echo "<i>"._T('ortho_ce_mot_connu')."</i>";
		echo "<br />";
		$link = new Link;
		$link->delVar('ajout_ortho');
		$link->addVar('supp_ortho', $mot);
		icone_horizontale(_T('ortho_supprimer_ce_mot'), $link->getUrl(), "ortho-24.gif", "supprimer.gif");
		echo "</div>\n";
		echo "</div>\n";
	}
}


function souligner_match_ortho(&$texte, $cherche, $remplace) {
	// Eviter les &mdash;, etc.
	if ($cherche{0} == '&' AND $cherche{strlen($cherche) - 1} == ';') return;

	if ($cherche{0} == '>') 
		$texte = str_replace($cherche, $remplace, $texte);
	else {
		// Ne pas remplacer a l'interieur des tags HTML
		$table = explode($cherche, $texte);
		unset($avant);
		$texte = '';
		foreach ($table as $s) {
			if (!isset($avant)) {
				$avant = $s;
				continue;
			}
			$ok = true;
			$texte .= $avant;
			// Detecter si le match a eu lieu dans un tag HTML
			if (is_int($deb_tag = strrpos($texte, '<'))) {
				if (strrpos($texte, '>') <= $deb_tag)
					$ok = false;
			}
			if ($ok) $texte .= $remplace;
			else $texte .= $cherche;
			$avant = $s;
		}
		$texte .= $avant;
	}
}

function souligner_ortho($texte, $lang, $ortho_result) {
	global $id_suggest;
	$vu = array();

	$mauvais = $ortho_result['mauvais'];
	$bons = $ortho_result['bons'];

	// Neutraliser l'apostrophe unicode pour surligner correctement les fautes
	$texte = " ".str_replace("\xE2\x80\x99", "'", $texte)." ";
	// Chercher et remplacer les mots un par un
	$delim = '[^-\''.pcre_lettres_unicode().']';
	foreach ($mauvais as $mot => $suggest) {
		$pattern = ",$delim".$mot."$delim,us";
		// Recuperer les occurences du mot dans le texte
		if (preg_match_all($pattern, $texte, $regs, PREG_SET_ORDER)) {
			$id = $id_suggest[$mot];
			$mot_html = afficher_ortho($mot);
			foreach ($regs as $r) {
				if ($vu[$cherche = $r[0]]) continue;
				$vu[$cherche] = 1;
				$html = "<a class='ortho' onclick=\"suggest($id);return false;\" href=''>$mot_html</a>";
				$remplace = str_replace($mot, $html, $cherche);
				souligner_match_ortho($texte, $cherche, $remplace);
			}
		}
	}
	foreach ($bons as $mot) {
		$pattern = ",$delim".$mot."$delim,us";
		// Recuperer les occurences du mot dans le texte
		if (preg_match_all($pattern, $texte, $regs, PREG_SET_ORDER)) {
			$id = $id_suggest[$mot];
			$mot_html = afficher_ortho($mot);
			foreach ($regs as $r) {
				if ($vu[$cherche = $r[0]]) continue;
				$vu[$cherche] = 1;
				$html = "<a class='ortho-dico' onclick=\"suggest($id);return false;\" href=''>$mot_html</a>";
				$remplace = str_replace($mot, $html, $cherche);
				souligner_match_ortho($texte, $cherche, $remplace);
			}
		}
	}
	
	$texte = preg_replace(',(^ | $),', '', $texte);
	return $texte;
}

function init_ortho() {
	global $duree_cache_ortho, $duree_cache_miroirs_ortho;
 
 	$duree_cache_ortho = 7 * 24 * 3600;
	$duree_cache_miroirs_ortho = 24 * 3600;
	lire_miroirs_ortho();
}

init_ortho();

?>

--- NEW FILE: config-lang.php3 ---
<?php

include ("inc.php3");

include_ecrire ("inc_config.php3");

function mySel($varaut,$variable){
		$retour= " VALUE=\"$varaut\"";

	if ($variable==$varaut){
		$retour.= " SELECTED";
	}

	return $retour;
}


debut_page(_T('titre_page_config_contenu'), "administration", "langues");

echo "<br><br><br>";
gros_titre(_T('info_langues'));


barre_onglets("config_lang", "langues");




debut_gauche();

debut_droite();

if ($connect_statut != '0minirezo' OR !$connect_toutes_rubriques) {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}

init_config();
if ($changer_config == 'oui') {
	appliquer_modifs_config();
	calculer_langues_rubriques();
}

lire_metas();


echo "<form action='config-lang.php3' method='post'>";
echo "<input type='hidden' name='changer_config' value='oui'>";


//
// Configuration i18n
//

debut_cadre_couleur("langues-24.gif", false, "", _T('info_langue_principale'));

$langues_prop = split(",",lire_meta("langues_proposees"));
$langue_site = lire_meta('langue_site');

echo _T('texte_selection_langue_principale');


// langue du site
echo _T('info_langue_principale')." : ";
echo "\n<select name='changer_langue_site' class='fondl' align='middle'>\n";
echo "<option value='$langue_site' selected>".traduire_nom_langue($langue_site)."</option>\n";
reset ($langues_prop);
while (list(,$l) = each ($langues_prop)) {
	if ($l <> $langue_site)
		echo "<option value='$l'>".traduire_nom_langue($l)."</option>\n";
}
echo "</select>\n";
echo "<INPUT TYPE='submit' NAME='Valider' VALUE='"._T('bouton_valider')."' CLASS='fondo'>";


fin_cadre_couleur();

echo "<p>";


//
// Configuration du charset
//

if ($options == 'avancees') {
	debut_cadre_relief("breve-24.gif", false, "", _T('info_jeu_caractere'));

	$charset = lire_meta("charset");

	echo _T('texte_jeu_caractere')."<p>";
	echo "<blockquote class='spip'><p>"._T('texte_jeu_caractere_2')."</p></blockquote>";


	echo bouton_radio('charset', 'iso-8859-1',
		_T('bouton_radio_occidental'), $charset == 'iso-8859-1');
	echo "<br>";
	echo bouton_radio('charset', 'utf-8',
		_T('bouton_radio_universel'), $charset == 'utf-8');
	echo "<br>";
	echo bouton_radio('charset', 'custom',
		_T('bouton_radio_personnalise'), $charset != 'utf-8' && $charset != 'iso-8859-1');
	echo "<br>";
	if ($charset != 'utf-8' && $charset != 'iso-8859-1') {
		echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"._T('info_entrer_code_alphabet')."&nbsp;";
		echo "<input type='text' name='charset_custom' class='fondl' value='$charset' size='15'>";
	}
	else
		echo "<input type='hidden' name='charset_custom' value=''>";

	echo "<div style='text-align: $spip_lang_right;'><INPUT TYPE='submit' NAME='Valider' VALUE='"._T('bouton_valider')."' CLASS='fondo'></div>";

	fin_cadre_relief();

}


echo "</form>";

fin_page();

?>



From mose at berlios.de  Thu Jan 13 18:51:26 2005
From: mose at berlios.de (mose at berlios.de)
Date: Thu, 13 Jan 2005 18:51:26 +0100
Subject: [Spip-carto-cvs] CVSROOT modules,1.4,1.5
Message-ID: <200501131751.j0DHpQNM027731@sheep.berlios.de>

Update of /cvsroot/spip-carto/CVSROOT
In directory sheep:/tmp/cvs-serv27467

Modified Files:
	modules 
Log Message:
spipcarto = spip-carto

Index: modules
===================================================================
RCS file: /cvsroot/spip-carto/CVSROOT/modules,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- modules	13 Jan 2005 15:57:53 -0000	1.4
+++ modules	13 Jan 2005 17:51:23 -0000	1.5
@@ -25,6 +25,6 @@
 # can be useful for creating a module that consists of many directories
 # spread out over the entire source repository.
 
-spipcarto  spipcarto
+spipcarto  spip-carto
 spip-carto spip-carto
 



From stef at berlios.de  Thu Jan 20 11:10:36 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:10:36 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/plugins plug_carto_lien.php,NONE,1.1 plug_small_caps.php,NONE,1.1 plug_carto_vignette.php,NONE,1.1 plug_carto_distant.php,NONE,1.1 plug_carto.php,NONE,1.1 plug_couleurs.php,NONE,1.1 plug_ancres.php,NONE,1.1
Message-ID: <200501201010.j0KAAaOp025533@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/plugins
In directory sheep:/tmp/cvs-serv25524/ecrire/plugins

Added Files:
	plug_carto_lien.php plug_small_caps.php 
	plug_carto_vignette.php plug_carto_distant.php plug_carto.php 
	plug_couleurs.php plug_ancres.php 
Log Message:
proto1.1

--- NEW FILE: plug_carto_lien.php ---
<?php
// Ce plug-in ajoute le raccourci typographique <mapXX> 
// XX est le numero de la carte

function avant_typo_cartelien($texte) {
	
	if (preg_match_all("<map(\d+)>", $texte, $regs, PREG_SET_ORDER)) {
		foreach ($regs as $r) {
			$id_carte = $r[1];
			//TODO : eviter cette rustine ...
			//$cherche = "&lt;".$r[0]."&gt;";
			//heu, en fait, c'est mon editeur WYSIWYG qui fait la transformation ...
			//ca marche tr?s bien comme ca :			
			$cherche = "<".$r[0].">";
			$remplace='<a href="carto.php3?id_carte=$id_carte">map$id_carte</a>';
			$texte = str_replace($cherche, $remplace, $texte);
		}
	}
	
	return $texte;
}

completer_fonction("propre", "avant_typo_cartelien", "");

?>
--- NEW FILE: plug_small_caps.php ---
<?php
// Ce plug-in ajoute le raccourci typographique <sc></sc>

function avant_typo_smallcaps($texte) {
	$texte = str_replace("<sc>", "<span style=\"font-variant: small-caps\">", $texte);
	$texte = str_replace("</sc>", "</span>", $texte);
	
	return $texte;
}

completer_fonction("propre", "avant_typo_smallcaps", "");

?>
--- NEW FILE: plug_carto_vignette.php ---
<?php
// Ce plug-in ajoute le raccourci typographique <map_vignetteXX> 
// XX est le numero de la carte

function avant_typo_carto_vignette($texte) {
	
	if (preg_match_all("<map(\d+)>", $texte, $regs, PREG_SET_ORDER)) {
		foreach ($regs as $r) {
			$id_carte = $r[1];
			//TODO : eviter cette rustine ...
			//$cherche = "&lt;".$r[0]."&gt;";
			//heu, en fait, c'est mon editeur WYSIWYG qui fait la transformation ...
			//ca marche tr?s bien comme ca :			
			$cherche = "<".$r[0].">";
			$remplace='<a href="carte_seule.php3?id_carte=$id_carte"><img src="spip_cartevignette.php3?id_carte=$id_carte" border="0"</a>';
			$texte = str_replace($cherche, $remplace, $texte);
		}
	}
	
	return $texte;
}

completer_fonction("propre", "avant_typo_carto_vignette", "");

?>
--- NEW FILE: plug_carto_distant.php ---
<?php
// Ce plug-in ajoute le raccourci typographique <mapXX|align> 
// XX est le numero de la carte
// align fonctionne comme les images (left / center / right)

//le include pour la version HTTP
include_ecrire('http.class.php');
include_ecrire('inc_carto.php3');

//la rustine d'inclusion pour /ecrire ...
//abandonn? pour le moment, manque de visibilit?
function avant_typo_carto_distant($texte) {
	
	if (preg_match_all(",<carto_http(\d+)([|])?([a-zA-Z.]+)?>,", $texte, $regs, PREG_SET_ORDER)) {
		foreach ($regs as $r) {
			$id_carte = $r[1];
			//TODO : eviter cette rustine ...
			//$cherche = "&lt;".$r[0]."&gt;";
			//heu, en fait, c'est mon editeur WYSIWYG qui fait la transformation ...
			//ca marche tr?s bien comme ca :			
			$cherche = $r[0];
			
			//TODO : traiter l'alignement avant replace
			//Le mieux etant de les traiter ici, dans le plugin
			//car le code doit rester identique ? celui de Spip
			//$align = $r[2];
			
			//TODO : voir si on ne peut pas faire un reglage plus fin ...
			// voir aussi pour les variables pass?es en POST (pa de cache ???)
			// en attendant : 60s ca permet de tester facilement le cache et le recalcul
			$ledelai="60";
			//TODO : peut etre d'autres parametres ... ???
			//forcer un type de carte ?
			//la methode doit plutot etre fonction du serveur, 
			//mais pourquoi pas un peu de finesse de parametrage ...
			//$type_carte = $r[3];
			
			//l'url du site pars?e, ca peut servir ...
			//$taburl=parse_url(lire_meta('adresse_site'));
			//$taburl=parse_url("http://".$r[2]);
			$taburl['path']="";
			//recuperation de la map en cache
			//TODO : utiliser l'API du cache plutot que cette usine ? gaz !
			$http_client = new http( HTTP_V11, false);
			$http_client->host = $r[3];//$taburl['host'];
			$http_reponse=$http_client->get(embed_carto_url($id_carte,$taburl)) ;
			$remplace=$r[3].embed_carto_url($id_carte,$taburl).":".$http_reponse;
			if ( $http_reponse== HTTP_STATUS_OK)
				$remplace = $http_client->get_response_body();
			else $replace= "HTTP_STATUT Error";
			unset( $http_client );
			
			//TODO : ajouter alignement ici
			$texte = str_replace($cherche, $remplace, $texte);
			
		}
	}
	
	return $texte;
}

completer_fonction("propre", "avant_typo_carto_distant", "");

?>
--- NEW FILE: plug_carto.php ---
<?php
// Ce plug-in ajoute le raccourci typographique <mapXX|align> 
// XX est le numero de la carte
// align fonctionne comme les images (left / center / right)

function avant_typo_carto($texte) {
	
	if (is_int(strpos($texte, '<map')) &&
	 (preg_match_all(",<map(\d+)([|])?([a-zA-Z.]+)?>,", $texte, $regs, PREG_SET_ORDER))) {
		global $flag_ecrire;
		$id_article=$_POST['id_article'];
		if ($flag_ecrire) {
			$query = "DELETE FROM spip_carto_carte_articles WHERE id_article=$id_article";
			spip_query($query);
		}
		foreach ($regs as $r) {
			$id_carte = $r[1];
			$cartes[$id_carte] = $id_carte;
			$cherche = $r[0];
			
			//TODO : traiter l'alignement avant replace
			//Le mieux etant de les traiter ici, dans le plugin
			//car le code doit rester identique ? celui de Spip
			$align = $r[3];
			
			//TODO : voir si on ne peut pas faire un reglage plus fin ...
			// voir aussi pour les variables pass?es en POST (pa de cache ???)
			// en attendant : 60s ca permet de tester facilement le cache et le recalcul
			$ledelai="60";
			//TODO : peut etre d'autres parametres ... ???
			//forcer un type de carte ?
			//la methode doit plutot etre fonction du serveur, 
			//mais pourquoi pas un peu de finesse de parametrage ...
			//$type_carte = $r[3];
			
			//l'url du site pars?e, ca peut servir ...
			//$taburl=parse_url(lire_meta('adresse_site'));
			
			
			//mettre ? jour la table de liaison avec les articles
			if ($flag_ecrire && $cartes) {
				global $couleur_claire;
//				$remplace=icone_bandeau_secondaire(_L("Carte ").$r[1], "../carto.php3?id_carte=".$r[1], "carte-24.png", "cartes", $sous_rubrique);
				$remplace="<div><table class='gauche'><tr>" .
						"<td class='cellule36' style='width: 100px;'><a href='../carto.php3?id_carte=".$r[1]."' class='selection' target='_blank'><img src='img_pack/carte-24.png' alt=' '/>" .
						"<span>Carte ".$r[1]."</span></a></td></tr></table></div>";				
//				$remplace=http_img_pack("carte-24.gif", "", "")."=>".$r[1]."/".$r[3];
			}
			//recuperation de la map en cache
			else {
				$lecontexte['id_carte']=$id_carte;
				$lechemin=generer_nom_fichier_cache($lecontexte, "carto");
				$usecache=determiner_cache($ledelai, $usecache, $lechemin);
				$tab=obtenir_page ($lecontexte,$lechemin , $ledelai, &$usecache, "carto");
				$remplace=$tab['texte'];
			}
			//TODO : ajouter alignement ici
			$texte = str_replace($cherche, $remplace, $texte);
		}
		//mettre ? jour la table de liaison avec les articles
		if ($flag_ecrire) {
			$query = "INSERT INTO spip_carto_carte_articles (id_article, id_carte) ".
			"VALUES ($id_article, ".join("), ($id_article, ", $cartes).")";
			spip_query($query);
		}
	}
	
	return $texte;
}

completer_fonction("propre", "avant_typo_carto", "");

?>
--- NEW FILE: plug_couleurs.php ---
<?php

// Ce plug-in ajoute des couleurs a l'interface

global $couleurs_spip;

$couleurs_spip[10] = array (
		"couleur_foncee" => "#508A72",
		"couleur_claire" => "#A5DFC7",
		"couleur_lien" => "#657701",
		"couleur_lien_off" => "#A6C113"
);


$couleurs_spip[11] = array (
		"couleur_foncee" => "#949064",
		"couleur_claire" => "#DFDBA5",
		"couleur_lien" => "#657701",
		"couleur_lien_off" => "#A6C113"
);

$couleurs_spip[12] = array (
		"couleur_foncee" => "#6770AC",
		"couleur_claire" => "#F8D768",
		"couleur_lien" => "#363F7A",
		"couleur_lien_off" => "#747DB4"
);


?>
--- NEW FILE: plug_ancres.php ---
<?php

// Ce plug-in ajoute le raccourci ancre [#ancre<-]

function avant_propre_ancres($texte) {
	$regexp = "|\[#?([^][]*)<-\]|";
	if (preg_match_all($regexp, $texte, $matches, PREG_SET_ORDER))
	foreach ($matches as $regs)
		$texte = str_replace($regs[0],
		'<a name="'.entites_html($regs[1]).'"></a>', $texte);

	return $texte;
}

completer_fonction("propre", "avant_propre_ancres", "");

?>


From stef at berlios.de  Thu Jan 20 11:15:52 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:15:52 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/js navTools.bak.js,NONE,1.1 navTools.js,NONE,1.1 carto.js,NONE,1.1 x_event_nn4.js,NONE,1.1 graphTools.js,NONE,1.1 Copie de navTools.js,NONE,1.1 tree.js,NONE,1.1 x_dom_nn4.js,NONE,1.1 x_core_nn4.js,NONE,1.1
Message-ID: <200501201015.j0KAFqOp025837@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/js
In directory sheep:/tmp/cvs-serv25615/ecrire/js

Added Files:
	navTools.bak.js navTools.js carto.js x_event_nn4.js 
	graphTools.js Copie de navTools.js tree.js x_dom_nn4.js 
	x_core_nn4.js 
Log Message:
proto1.1

--- NEW FILE: navTools.bak.js ---
// Global variables

// dhtmlBox constructor
function dhtmlBox() {
  this.anchor = xGetElementById("mapAnchorDiv");
  this.target = xGetElementById("mainDHTMLDiv");
  this.image = xGetElementById("mapImageDiv");
  this.canvas = xGetElementById("myCanvasDiv");
  this.canvas2 = xGetElementById("myCanvas2Div");
  this.displayContainer = xGetElementById("diplayContainerDiv");
  this.displayCoords = xGetElementById("displayCoordsDiv");
  this.displayMeasure = xGetElementById("displayMeasureDiv");

  this.x1 = this.y1 = this.x2 = this.y2 = -1;
  this.drag = false;
  this.isActive = false;
  this.dblClick = false;
  this.keyEscape = false;
}

// method prototypes
function dhtmlBox_initialize() {
  jg = new jsGraphics(this.canvas.id); // a drawing canvas for the lines and points
  jg2 = new jsGraphics(this.canvas2.id); // a drawing canvas for the last moving vertex

  // make the previous tool selected the current one
  for (var i =0; i < myform.tool.length; i++) {
    if (myform.tool[i].checked) {
      dhtmlBox.changeTool(myform.tool[i].value);
    }
  }
  
  // HACK FOR selection tool: find a better solution !!
  if (myform.tool.length >= 5 && myform.tool[4].checked) {
     dhtmlBox.changeTool('query');
  }
  
  this.target.style.zIndex = 1000;

  this.width = xWidth(this.anchor);
  this.height = xHeight(this.anchor);

  xResizeTo(this.image,this.width,this.height);
  xResizeTo(this.target,this.width,this.height);
  xResizeTo(this.canvas,this.width,this.height);
  xResizeTo(this.canvas2,this.width,this.height);
  xWidth(this.displayContainer,this.width);

  xMoveTo(this.image,xPageX(this.anchor),xPageY(this.anchor));
  xMoveTo(this.target,xPageX(this.anchor),xPageY(this.anchor));
  xMoveTo(this.canvas,xPageX(this.anchor),xPageY(this.anchor));
  xMoveTo(this.canvas2,xPageX(this.anchor),xPageY(this.anchor));
  xShow(this.image);

  if (this.dispPos == "top") this.dispPos = -13;
  else if (this.dispPos == "bottom") this.dispPos = this.height;
  else this.dispPos = 0;
  xMoveTo(this.displayContainer,xPageX(this.anchor),xPageY(this.anchor) + this.dispPos);

  xClip(this.target,0,this.width,this.height,0);
}


function dhtmlBox_changetool(tool) {// the mouse events are managed in this function according to the mapping tool selected
  myform.tool.value = tool;
  this.currentTool = tool.toLowerCase();

  // clear the drawing canvas
  jg.clear();

  xRemoveEventListener(this.target,'mousedown',this.domousedown);
  xRemoveEventListener(this.target,'mouseup',this.domouseup);
  xRemoveEventListener(this.target,'mousemove',this.domousemove);
  xRemoveEventListener(this.target,'mouseout',this.domouseout);
  xRemoveEventListener(this.target, 'dblclick', this.dodblclick);
  
  xAddEventListener(this.target,'mousedown',this.domousedown);
  xAddEventListener(this.target,'mouseup',this.domouseup);
  xAddEventListener(this.target,'mousemove',this.domousemove);
  xAddEventListener(this.target,'mouseout',this.domouseout);

  xAddEventListener(document,'keydown',this.dokeydown);

  if (this.currentTool == 'distance' || this.currentTool == 'surface' || this.currentTool == 'polygon' || this.currentTool == 'line') {
    this.isActive = false;
    this.distance = 0;
    this.displayCoords.innerHTML = '';
    this.displayMeasure.innerHTML = '';
    xAddEventListener(this.target,'dblclick', this.dodblclick);
  }

  // cursor style
  if (this.currentTool == 'zoom_in' || this.currentTool == 'zoom_out' || this.currentTool == 'distance' || this.currentTool == 'surface' || this.currentTool == 'polygon' || this.currentTool == 'line') {
    if (this.target.style) this.target.style.cursor = "crosshair";
  } else if (this.currentTool == 'pan') {
    if (this.target.style) this.target.style.cursor = "move";
  } else if (this.currentTool == 'query') {
    if (this.target.style) this.target.style.cursor = "help";
  }
  jg.paint();
}

function dhtmlBox_mousedown(evt) {
  var e = new xEvent(evt);
  
  if (!(xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) && evt.button == 2) { //right clic
    dhtmlBox.rightclic = true;
  } else {
    dhtmlBox.rightclic = false;

    dhtmlBox.x1 = dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y1 = dhtmlBox.y2 = e.offsetY;
	

    if (dhtmlBox.currentTool == "zoom_out") {
      jg.clear();  // if page not reloaded automaticaly, previous crosses are deleted
    }

    if (!dhtmlBox.isActive && (dhtmlBox.currentTool == 'distance' || dhtmlBox.currentTool == 'surface' || dhtmlBox.currentTool == 'polygon'  || dhtmlBox.currentTool == 'line')) { //init
      jg.clear();
      //jg2.clear();
      dhtmlBox.cnv_clicks = 0;
      dhtmlBox.draw_x = new Array();
      dhtmlBox.draw_y = new Array();
      dhtmlBox.Xpoints = new Array();
      dhtmlBox.Ypoints = new Array();
      dhtmlBox.distance = 0;
      dhtmlBox.isActive = true;
	  dhtmlBox.dblClick = false;
      dhtmlBox.keyEscape = false;
    }
  }
  if (dhtmlBox.currentTool == 'polygon'  || dhtmlBox.currentTool == 'line') {
    dhtmlBox.drag = false; // to provide the curves draw
  } else {
	dhtmlBox.drag = true; // the mouse is down
  }
}

function dhtmlBox_mousemove(evt) {
  var e = new xEvent(evt);

  //show the coords display
  xShow(dhtmlBox.displayContainer);

  if(dhtmlBox.drag) { //the mouse is down
    dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y2 = e.offsetY;
    if(dhtmlBox.currentTool == 'zoom_out') { // only one click events
      jg.clear();
      dhtmlBox.x1 = dhtmlBox.x2;
      dhtmlBox.y1 = dhtmlBox.y2;
    }
    dhtmlBox.paint();
  }
  else if ((dhtmlBox.currentTool == 'distance' || dhtmlBox.currentTool == 'surface' || dhtmlBox.currentTool == 'polygon'  || dhtmlBox.currentTool == 'line') && dhtmlBox.isActive == true) {
      dhtmlBox.x2 = e.offsetX;
      dhtmlBox.y2 = e.offsetY;
      dhtmlBox.lastLinePaint(); // the last line is drawn while moving
  }
    // display the coordinates
    dhtmlBox.displayCoords.innerHTML = dhtmlBox.coord_msg + Math.round((e.offsetX * dhtmlBox.pixel_size) + dhtmlBox.boxx)  +" / "+ Math.round(((dhtmlBox.mapHeight - e.offsetY) * dhtmlBox.pixel_size) + dhtmlBox.boxy);
}

function dhtmlBox_mouseup(evt) {
  var e = new xEvent(evt);

  if (dhtmlBox.rightclic == true) {
    jg2.clear();
  } else {

    dhtmlBox.drag = false; //the mouse is now up

    dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y2 = e.offsetY;

    //the box is too small
    if(((Math.abs(dhtmlBox.x1-dhtmlBox.x2) <= dhtmlBox.jitter) || (Math.abs(dhtmlBox.y1-dhtmlBox.y2) <= dhtmlBox.jitter)) && dhtmlBox.currentTool == 'zoom_in') {
      dhtmlBox.x2 = dhtmlBox.x1 = Math.abs(dhtmlBox.x1-dhtmlBox.x2) /2 + Math.min(dhtmlBox.x1, dhtmlBox.x2); //zoom to center of the box
      dhtmlBox.y2 = dhtmlBox.y1 = Math.abs(dhtmlBox.y1-dhtmlBox.y2) /2 + Math.min(dhtmlBox.y1, dhtmlBox.y2);;
    }

    // submit the form with the values
    if (dhtmlBox.currentTool == 'zoom_in' || dhtmlBox.currentTool == 'zoom_out' || dhtmlBox.currentTool == 'query') {
      dhtmlBox.removeEventsWait();
      myform.selection_type.value = "rectangle";
      myform.selection_coords.value = dhtmlBox.x1+","+dhtmlBox.y1+";"+dhtmlBox.x2+","+dhtmlBox.y2
	  xShow(dhtmlBox.anchor);
      myform.submit();
    }
    else if (dhtmlBox.currentTool == 'pan') {
      myform.selection_type.value = "point"
      // pan or simple pan click
      if (dhtmlBox.x2 == dhtmlBox.x1 && dhtmlBox.y2 == dhtmlBox.y1) { //simple click
        var x = dhtmlBox.x2
        var y = dhtmlBox.y2
        myform.selection_coords.value = x+","+y
      } else {// pan
        //new center coordinates
        var x = dhtmlBox.width/2 - (dhtmlBox.x2 - dhtmlBox.x1)
        var y = dhtmlBox.height/2 - (dhtmlBox.y2 - dhtmlBox.y1)
        myform.selection_coords.value = x+","+y
      }
	  xShow(dhtmlBox.anchor);
      myform.submit();
    } else if (dhtmlBox.currentTool == 'surface' || dhtmlBox.currentTool == 'polygon') {
		// polygon closed by click on the first point
		if (Math.abs(dhtmlBox.x2 - dhtmlBox.draw_x[1]) <= dhtmlBox.jitter && Math.abs(dhtmlBox.y2 - dhtmlBox.draw_y[1]) <= dhtmlBox.jitter && dhtmlBox.draw_x.length > 2) {
			dhtmlBox.keyEscape = true;
			dhtmlBox.isActive = false;
			jg2.clear();
		}
	}
    dhtmlBox.paint();
  }
}

function dhtmlBox_mouseout(evt) {
  var e = new xEvent(evt);

  xHide(dhtmlBox.displayContainer);
  jg2.clear();
}

function dhtmlBox_dblclick(evt) {
  var e = new xEvent(evt);
  dhtmlBox.dblClick = true;
  dhtmlBox.isActive = false;

  jg2.clear();
  dhtmlBox.paint();
}

function dhtmlBox_keydown(evt) { // 
  evt = (evt) ? evt : ((event) ? event : null);
  dhtmlBox = dhtmlBox;
  if (evt.keyCode == '27' && (dhtmlBox.currentTool == 'distance' || dhtmlBox.currentTool == 'surface' || dhtmlBox.currentTool == 'polygon'  || dhtmlBox.currentTool == 'line')) {
    dhtmlBox.keyEscape = true;
    dhtmlBox.isActive = false;
    jg2.clear();
    dhtmlBox.paint();
  }
}

function dhtmlBox_paint() { // draws alternatively boxes, lines, polylines, crosses, or pan the map
  var x, y, w, h;

  x = Math.min(this.x1, this.x2);
  y = Math.min(this.y1, this.y2);

  if (this.currentTool == 'zoom_out') { //draws only a cross
      jg.drawLineW(x-this.cursorsize,y - this.thickness /2,this.cursorsize * 2);
      jg.drawLineH(x - this.thickness /2,y-this.cursorsize ,this.cursorsize * 2);
      jg.paint();
  }

  else if (this.currentTool == 'zoom_in' || this.currentTool == 'query') {
    if(this.x1==this.x2 && this.y1==this.y2) {
        jg.clear();
        jg.drawLineW(x-this.cursorsize,y - this.thickness /2,this.cursorsize * 2);
        jg.drawLineH(x - this.thickness /2,y-this.cursorsize ,this.cursorsize * 2);
        jg.paint();

    } else {
      w = Math.abs(this.x1-this.x2);
      h = Math.abs(this.y1-this.y2);
      jg.clear();
          jg.drawRect(x,y,w,h,this.thickness);
      jg.paint();
    }
  }
  else if (this.currentTool == 'pan') {
    var dx,dy

    dx = this.x2 - this.x1;
    dy = this.y2 - this.y1;

    xMoveTo(this.image,dx + xPageX(this.anchor),dy + xPageY(this.anchor));
    xClip(this.image,(dy<0)? Math.abs(dy):0,(dx>0)? this.width - dx : this.width,(dy>0)? this.height-dy:this.height,(dx<0)? Math.abs(dx):0);
    //xResizeTo(this.image,(dy<0)? Math.abs(dy):0,(dx>0)? this.width - dx : this.width,(dy>0)? this.height-dy:this.height,(dx<0)? Math.abs(dx):0);
  }

  else if (this.currentTool == 'distance' || this.currentTool == 'line') {
    if (!this.keyEscape) { // Escape key is pressed
      ++this.cnv_clicks;
      this.draw_x[this.cnv_clicks] = this.x2;
      this.draw_y[this.cnv_clicks] = this.y2;
    }
    this.Xpoints[this.cnv_clicks - 1] = this.draw_x[this.cnv_clicks];
    this.Ypoints[this.cnv_clicks - 1] = this.draw_y[this.cnv_clicks];
    if (xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) { // IE/Mac specificity
      jg.clear();
      jg.drawPolylinePts(this.Xpoints,this.Ypoints, this.d2pts);
    }
    else {
        jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[this.cnv_clicks - 1],this.draw_y[this.cnv_clicks - 1],this.d2pts);
    }
	if (this.currentTool == 'distance') { //Calculate the distance and display it
	  if (this.cnv_clicks > 1 && !this.keyEscape) {
        // distance calculation
        this.dist_x = (this.draw_x[this.cnv_clicks] - this.draw_x[this.cnv_clicks - 1]) * this.pixel_size;
        this.dist_y = (this.draw_y[this.cnv_clicks] - this.draw_y[this.cnv_clicks - 1]) * this.pixel_size;
        this.distance += Math.sqrt(this.dist_x * this.dist_x + this.dist_y * this.dist_y);
      }
      if (this.dist_unit == ' m.') this.distance = Math.round(this.distance);
      else if (this.dist_unit == ' km.') this.distance = Math.round(this.distance*100)/100;
      this.displayMeasure.innerHTML = this.dist_msg + this.distance.toString() + this.dist_unit;
	} else if (this.currentTool == 'line' && !this.isActive) { // submit the form
		var coords = new String();
		for (i = 0; i < this.Xpoints.length; i++) {
			coords += this.Xpoints[i] +"," + this.Ypoints[i] + ";";
		}
		myform.selection_type.value = 'line';
		myform.selection_coords.value = coords.substring(0,coords.length - 1);
		xShow(this.anchor);
		myform.submit();
	}
    jg.paint();
  }
  else if (this.currentTool == 'surface' || this.currentTool == 'polygon') {
    if (!this.keyEscape) { // Escape key is pressed
      ++this.cnv_clicks;
      this.draw_x[this.cnv_clicks] = this.x2;
      this.draw_y[this.cnv_clicks] = this.y2;
    }
    this.Xpoints[this.cnv_clicks - 1] = this.draw_x[this.cnv_clicks];
    this.Ypoints[this.cnv_clicks - 1] = this.draw_y[this.cnv_clicks];
    if (xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) { // IE/Mac specificity
      if (!this.isActive) { // close the polygon
        this.Xpoints[this.cnv_clicks] = this.draw_x[1];
        this.Ypoints[this.cnv_clicks] = this.draw_y[1];
      }
      jg.clear();
      jg.drawPolylinePts(this.Xpoints,this.Ypoints, this.d2pts);
    }
    else {
      jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[this.cnv_clicks - 1],this.draw_y[this.cnv_clicks - 1],this.d2pts);
      if (!this.isActive) { // close the polygon
        jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[1],this.draw_y[1],this.d2pts);		
      }
    }

	if (this.currentTool == 'surface') { // calculate the surface and display it
	  if (this.cnv_clicks > 1  && !this.keyEscape) {
        //surface calculation
        var i = 0;
        this.distance = 0;
        while (i < this.cnv_clicks - 1) {
          this.distance += this.Xpoints[i] * this.Ypoints[i+1] - this.Xpoints[i+1] * this.Ypoints[i];
          ++i;
        }
        this.distance += this.Xpoints[this.cnv_clicks -1] * this.Ypoints[0] - this.Xpoints[0] * this.Ypoints[this.cnv_clicks -1];
        var pix_surf = this.pixel_size * this.pixel_size;
        this.distance = Math.abs(this.distance.toString()) / 2 * pix_surf;
	  }
      if (this.surf_unit == ' m2.') this.distance = Math.round(this.distance);
      else if (this.surf_unit == ' km2.') this.distance = Math.round(this.distance*10000)/10000;
      this.displayMeasure.innerHTML = this.surf_msg+ this.distance +this.surf_unit;
    } else if (this.currentTool == 'polygon' && !this.isActive) { // draw the closed polygon and submit form
		jg.paint();
		var coords = new String();
		for (i = 0; i < this.Xpoints.length; i++) {
			coords += this.Xpoints[i] +"," + this.Ypoints[i] + ";";
		}
		myform.selection_type.value = 'polygon';
		myform.selection_coords.value = coords.substring(0,coords.length - 1);
		xShow(this.anchor);
		myform.submit();
	}
	jg.paint();
  }
}


function dhtmlBox_lastLinePaint() {

  var x2 = this.x2;
  var y2 = this.y2;
  var x = this.draw_x[this.cnv_clicks];
  var y = this.draw_y[this.cnv_clicks];
  var x0 = this.draw_x[1];
  var y0 = this.draw_y[1];

  if (xIE || xUA.indexOf('mac')!=-1) { //use the drawing API
    jg2.clear();
    jg2.drawLinePts(x2,y2,x,y,this.d2pts); //draw the last vertex
    if (this.currentTool == "surface" || this.currentTool == "polygon") {
      jg2.drawLinePts(x2,y2,x0,y0,this.d2pts); // also draw the line to close the polygon
    }
    jg2.paint();
  }
  else { //doesn't use the drawing API
    if (this.canvas2.innerHTML == '') { // create the DIVs if doesn't exist
      for (var i=0; i< this.nbPts * 2; i++) {
        this["vertexPt"+i] = xCreateElement('div');
        xAppendChild(this.canvas2,this["vertexPt"+i],200);
        this["vertexPt"+i].className = "point";
        xHide(this["vertexPt"+i]);
        if (this["vertexPt"+i].style) this["vertexPt"+i].style.position = "absolute";
      }
    }
    var dx = x2 - x;
    var dy = y2 - y;
    for (var i=0;i<this.nbPts;i++) {
      var a = this["vertexPt"+i];
      xMoveTo(a,x + dx *i/ this.nbPts,y + dy *i/ this.nbPts);
      xShow(a);
    }
    if (this.currentTool == "surface" || this.currentTool == "polygon") {
      var dx0 = x2 - x0;
      var dy0 = y2 - y0;
      for (var i=this.nbPts;i<this.nbPts * 2;i++) {
        var a = this["vertexPt"+i];
        xMoveTo(a,x0 + dx0 * (i-this.nbPts)/this.nbPts,y0 + dy0 * (i-this.nbPts) / this.nbPts);
        xShow(a);
      }
    }
  }
}



new dhtmlBox(0);

dhtmlBox.prototype.initialize = dhtmlBox_initialize; // create instance method
dhtmlBox.prototype.domousedown = dhtmlBox_mousedown;
dhtmlBox.prototype.domousemove = dhtmlBox_mousemove;
dhtmlBox.prototype.domouseup = dhtmlBox_mouseup;
dhtmlBox.prototype.domouseout = dhtmlBox_mouseout;
dhtmlBox.prototype.dodblclick = dhtmlBox_dblclick;
dhtmlBox.prototype.dokeydown = dhtmlBox_keydown;
dhtmlBox.prototype.paint = dhtmlBox_paint;
dhtmlBox.prototype.lastLinePaint = dhtmlBox_lastLinePaint; // draw the last straight vertex for the measure tool
dhtmlBox.prototype.changeTool = dhtmlBox_changetool;
dhtmlBox.prototype.removeEventsWait = dhtmlBox_removeEventsWait;

/*
function changeTool(dhtmlBox,tool) {
  dhtmlBox.changetool(tool);
}
*/

function dhtmlBox_removeEventsWait() {
   xRemoveEventListener(this.target, 'mousemove', this.domousemove);
   if (this.target.style) this.target.style.cursor = "wait";
}

--- NEW FILE: navTools.js ---
// Global variables

// dhtmlBox constructor
function dhtmlBox() {
  this.anchor = xGetElementById("mapAnchorDiv");
  this.target = xGetElementById("mainDHTMLDiv");
  this.image = xGetElementById("mapImageDiv");
  this.canvas = xGetElementById("myCanvasDiv");
  this.canvas2 = xGetElementById("myCanvas2Div");
  this.displayContainer = xGetElementById("diplayContainerDiv");
  this.displayCoords = xGetElementById("displayCoordsDiv");
  this.displayMeasure = xGetElementById("displayMeasureDiv");

  this.x1 = this.y1 = this.x2 = this.y2 = -1;
  this.drag = false;
  this.isActive = false;
  this.dblClick = false;
  this.keyEscape = false;
}

// method prototypes
function dhtmlBox_initialize() {
  jg = new jsGraphics(this.canvas.id); // a drawing canvas for the lines and points
  jg2 = new jsGraphics(this.canvas2.id); // a drawing canvas for the last moving vertex

  dhtmlBox.changeTool() //make the previous tool selected the current one
  
  this.target.style.zIndex = 1000;

  this.width = xWidth(this.anchor);
  this.height = xHeight(this.anchor);

  this.resizeAndMoveDivs()

  if (this.dispPos == "top") this.dispPos = -13;
  else if (this.dispPos == "bottom") this.dispPos = this.height;
  else this.dispPos = 0;
  xMoveTo(this.displayContainer,xPageX(this.anchor),xPageY(this.anchor) + this.dispPos);

}

function dhtmlBox_resizeAndMoveDivs() {
  xResizeTo(this.image,this.width,this.height)
  xResizeTo(this.target,this.width,this.height)
  xResizeTo(this.canvas,this.width,this.height)
  xResizeTo(this.canvas2,this.width,this.height)
  xWidth(this.displayContainer,this.width)

  xMoveTo(this.image,xPageX(this.anchor),xPageY(this.anchor))
  xMoveTo(this.target,xPageX(this.anchor),xPageY(this.anchor))
  xMoveTo(this.canvas,xPageX(this.anchor),xPageY(this.anchor))
  xMoveTo(this.canvas2,xPageX(this.anchor),xPageY(this.anchor))
  xShow(this.image)

  xClip(this.target,0,this.width,this.height,0)
  xClip(this.image,0,this.width,this.height,0)
}

// the mouse events are managed in this function according to the mapping tool selected
// shape accepted values : point, rectangle, line, polygon
// action : submit, measure
// cursorStyle : crosshair, help, move
// toolName : name of the tool (ie query, zoomin, ...)
function dhtmlBox_changetool() {
  // get the checked tool and its values
  for (var i =0; i < myform.tool.length ; i++) {
    if (myform.tool[i].checked) {
	  var toolValues = myform.tool[i].value.split(",")
	  this.shapeType = toolValues[0]
	  this.action = toolValues[1]
	  this.cursorStyle = toolValues[2]
	  this.toolName = toolValues[3]
    }
  }
  
  // clear the drawing canvas
  jg.clear();

  xRemoveEventListener(this.target,'mousedown',this.domousedown)
  xRemoveEventListener(this.target,'mouseup',this.domouseup)
  xRemoveEventListener(this.target,'mousemove',this.domousemove)
  xRemoveEventListener(this.target,'mouseout',this.domouseout)
  xRemoveEventListener(this.target, 'dblclick', this.dodblclick)
  
  xAddEventListener(this.target,'mousedown',this.domousedown)
  xAddEventListener(this.target,'mouseup',this.domouseup)
  xAddEventListener(this.target,'mousemove',this.domousemove)
  xAddEventListener(this.target,'mouseout',this.domouseout)

  xAddEventListener(document,'keydown',this.dokeydown)
 
  this.isActive = false

  if (this.shapeType == 'polygon' || this.shapeType == 'line') {
    xAddEventListener(this.target,'dblclick', this.dodblclick)
  }
  
  this.displayMeasure.innerHTML = '';
  if (this.action == 'measure') {
  	this.measure = 0;
  }

  // cursor style
  if (this.target.style) this.target.style.cursor = this.cursorStyle
  jg.paint()
}

function dhtmlBox_mousedown(evt) {
  var e = new xEvent(evt);
  
  if (!(xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) && evt.button == 2) { //right clic
    dhtmlBox.rightclic = true;
  } else {
    dhtmlBox.rightclic = false;

    dhtmlBox.x1 = dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y1 = dhtmlBox.y2 = e.offsetY;
	
    if (dhtmlBox.shapeType == "point") {
      jg.clear();  // if page not reloaded automaticaly, previous crosses are deleted
    }
	
	if (!dhtmlBox.isActive) {
	  dhtmlBox.isActive = true
	  dhtmlBox.dblClick = false
      dhtmlBox.Xpoints = new Array()
   	  dhtmlBox.Ypoints = new Array()
	  if (dhtmlBox.shapeType == 'polygon' || dhtmlBox.shapeType == 'line') { //init
      	  jg.clear();
	      //jg2.clear();
    	  dhtmlBox.cnv_clicks = 0;
	      dhtmlBox.draw_x = new Array();
    	  dhtmlBox.draw_y = new Array();
	      dhtmlBox.measure = 0;
		  dhtmlBox.dblClick = false;
    	  dhtmlBox.keyEscape = false;
	  }
    }
  }
  if (dhtmlBox.action == 'submit' && (dhtmlBox.shapeType == 'polygon' || dhtmlBox.shapeType == 'line')) {
    dhtmlBox.drag = false; // to provide the curves draw (ie for polygon or line selection submit, TODO test if curves can be used
  } else {
	dhtmlBox.drag = true; // the mouse is down
  }
}

function dhtmlBox_mousemove(evt) {
  var e = new xEvent(evt);

  //show the coords display
  xShow(dhtmlBox.displayContainer);

  if(dhtmlBox.drag && dhtmlBox.isActive) { //the mouse is down
    dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y2 = e.offsetY;
	if (dhtmlBox.shapeType == 'point') {
      jg.clear();
      dhtmlBox.x1 = dhtmlBox.x2;
      dhtmlBox.y1 = dhtmlBox.y2;
    }
	jg2.clear();
    dhtmlBox.paint();
	if (dhtmlBox.shapeType == 'polygon') dhtmlBox.lastLinePaint(); // last line is drawn while moving
  }
  else if ((dhtmlBox.shapeType == 'polygon' || dhtmlBox.shapeType == 'line') && dhtmlBox.isActive == true) {
      dhtmlBox.x2 = e.offsetX;
      dhtmlBox.y2 = e.offsetY;
      dhtmlBox.lastLinePaint(); // the last line is drawn while moving
  }
  // display the coordinates
  dhtmlBox.displayCoords.innerHTML = dhtmlBox.coord_msg + Math.round((e.offsetX * dhtmlBox.pixel_size) + dhtmlBox.boxx)  +" / "+ Math.round(((dhtmlBox.mapHeight - e.offsetY) * dhtmlBox.pixel_size) + dhtmlBox.boxy);
}

function dhtmlBox_mouseup(evt) {
  var e = new xEvent(evt);

  if (dhtmlBox.rightclic == true) {
    jg2.clear();
  } else if (dhtmlBox.isActive) {

    dhtmlBox.drag = false; //the mouse is now up

    dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y2 = e.offsetY;

    //the box is too small
    if(((Math.abs(dhtmlBox.x1-dhtmlBox.x2) <= dhtmlBox.jitter) || (Math.abs(dhtmlBox.y1-dhtmlBox.y2) <= dhtmlBox.jitter)) && dhtmlBox.shapeType == 'rectangle') {
      dhtmlBox.x2 = dhtmlBox.x1 = Math.abs(dhtmlBox.x1-dhtmlBox.x2) /2 + Math.min(dhtmlBox.x1, dhtmlBox.x2); //zoom to center of the box
      dhtmlBox.y2 = dhtmlBox.y1 = Math.abs(dhtmlBox.y1-dhtmlBox.y2) /2 + Math.min(dhtmlBox.y1, dhtmlBox.y2)
    }
	
	// rectangle draw finished
	if (dhtmlBox.shapeType == 'point' || dhtmlBox.shapeType == 'rectangle' || dhtmlBox.shapeType == 'pan') dhtmlBox.isActive = false;
	
	// polygon closed by click on the first point
	if (dhtmlBox.shapeType == 'polygon' && Math.abs(dhtmlBox.x2 - dhtmlBox.draw_x[1]) <= dhtmlBox.jitter && Math.abs(dhtmlBox.y2 - dhtmlBox.draw_y[1]) <= dhtmlBox.jitter && dhtmlBox.draw_x.length > 2) {
		dhtmlBox.keyEscape = true;
		dhtmlBox.isActive = false;
		jg2.clear();
	}
    dhtmlBox.paint();
  }
}

function dhtmlBox_mouseout(evt) {
  var e = new xEvent(evt);

  xHide(dhtmlBox.displayContainer);
  jg2.clear();
}

function dhtmlBox_dblclick(evt) {
  var e = new xEvent(evt)
  dhtmlBox.dblClick = true
  dhtmlBox.isActive = false
  jg2.clear()
  dhtmlBox.paint()
}

function dhtmlBox_keydown(evt) { // 
  if (evt.keyCode == '27') {
    dhtmlBox.keyEscape = true
    dhtmlBox.isActive = false
    jg2.clear()
	if (dhtmlBox.action == 'submit') {
		dhtmlBox.changeTool() // cancel the use of the current tool
		dhtmlBox.resizeAndMoveDivs()
		xHide(dhtmlBox.anchor)
	}
	else if (dhtmlBox.action == 'measure') {
		dhtmlBox.paint() //
	}
  }
}

function dhtmlBox_paint() { // draws alternatively boxes, lines, polylines, crosses, or pan the map
  var x, y, w, h;

  x = Math.min(this.x1, this.x2);
  y = Math.min(this.y1, this.y2);

  if (this.shapeType == 'pan') {
    var dx = this.x2 - this.x1
    var dy = this.y2 - this.y1

    xMoveTo(this.image,dx + xPageX(this.anchor),dy + xPageY(this.anchor))
    xClip(this.image,(dy<0)? Math.abs(dy):0,(dx>0)? this.width - dx : this.width,(dy>0)? this.height-dy:this.height,(dx<0)? Math.abs(dx):0)
	
	this.Xpoints[0] = dhtmlBox.width/2 - (dhtmlBox.x2 - dhtmlBox.x1)
    this.Ypoints[0] = dhtmlBox.height/2 - (dhtmlBox.y2 - dhtmlBox.y1)
    //xResizeTo(this.image,(dy<0)? Math.abs(dy):0,(dx>0)? this.width - dx : this.width,(dy>0)? this.height-dy:this.height,(dx<0)? Math.abs(dx):0);
  }
  else if (this.shapeType == 'point' ||
	(this.shapeType == 'rectangle' && this.x1==this.x2 && this.y1==this.y2)) { //draws only a cross
	jg.clear();
    jg.drawLineW(x-this.cursorsize,y - this.thickness /2,this.cursorsize * 2);
    jg.drawLineH(x - this.thickness /2,y-this.cursorsize ,this.cursorsize * 2);
    jg.paint();
	this.Xpoints[0] = x
	this.Ypoints[0] = y
	if (this.shapeType == 'rectangle') { // submit a rectangle coords (2 equal coords)
	  this.Xpoints[1] = this.x2
	  this.Ypoints[1] = this.y2
	}
  }
  else if (this.shapeType == 'rectangle') {
      w = Math.abs(this.x1-this.x2)
      h = Math.abs(this.y1-this.y2)
      jg.clear()
      jg.drawRect(x,y,w,h,this.thickness)
      jg.paint()
  	  this.Xpoints[0] = this.x1
	  this.Ypoints[0] = this.y1
	  this.Xpoints[1] = this.x2
	  this.Ypoints[1] = this.y2
  }
  else if (this.shapeType == 'line' || this.shapeType == 'polygon') {
    if (!this.keyEscape) { // Escape key is pressed
      ++this.cnv_clicks;
      this.draw_x[this.cnv_clicks] = this.x2;
      this.draw_y[this.cnv_clicks] = this.y2;
    }
    this.Xpoints[this.cnv_clicks - 1] = this.draw_x[this.cnv_clicks];
    this.Ypoints[this.cnv_clicks - 1] = this.draw_y[this.cnv_clicks];
    if (xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) { // IE/Mac specificity
	  if (!this.isActive && this.shapeType == 'polygon') {
        this.Xpoints[this.cnv_clicks] = this.draw_x[1];
        this.Ypoints[this.cnv_clicks] = this.draw_y[1];	  	
	  }
      jg.clear();
      jg.drawPolylinePts(this.Xpoints,this.Ypoints, this.d2pts);
    }
    else {
        jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[this.cnv_clicks - 1],this.draw_y[this.cnv_clicks - 1],this.d2pts);
      	if (!this.isActive  && this.shapeType == 'polygon') // close the polygon
          jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[1],this.draw_y[1],this.d2pts);		
      }
    }
    jg.paint();
	// submit the form with the values
	if (dhtmlBox.action == 'submit' && !this.isActive ) {
		dhtmlBox.submitForm()
	}
	if (dhtmlBox.action == 'measure') {
		dhtmlBox.measureShape()
	}
}

function dhtmlBox_lastLinePaint() {

  var x2 = this.x2;
  var y2 = this.y2;
  var x = this.draw_x[this.cnv_clicks];
  var y = this.draw_y[this.cnv_clicks];
  var x0 = this.draw_x[1];
  var y0 = this.draw_y[1];

//  if (xIE || xUA.indexOf('mac')!=-1) { //use the drawing API
  if (xUA.indexOf('mac')!=-1) { //use the drawing API
    jg2.clear();
    jg2.drawLinePts(x2,y2,x,y,this.d2pts); //draw the last vertex
    if (this.shapeType == 'polygon') {
      jg2.drawLinePts(x2,y2,x0,y0,this.d2pts) // also draw the line to close the polygon
    }
    jg2.paint()
  }
  else { //doesn't use the drawing API
  
    if (this.canvas2.innerHTML == '') { // create the DIVs if doesn't exist
      for (var i=0; i< this.nbPts * 2; i++) {
        this["vertexPt"+i] = xCreateElement('div')
        xAppendChild(this.canvas2,this["vertexPt"+i],200)
        this["vertexPt"+i].className = "point"
        xHide(this["vertexPt"+i])
        if (this["vertexPt"+i].style) this["vertexPt"+i].style.position = "absolute"
      }
    }
    var dx = x2 - x
    var dy = y2 - y
    for (var i=0;i<this.nbPts;i++) {
      var a = this["vertexPt"+i]
      xMoveTo(a,x + dx *i/ this.nbPts,y + dy *i/ this.nbPts)
      xShow(a)
    }
    if (this.shapeType == 'polygon') {
      var dx0 = x2 - x0
      var dy0 = y2 - y0
      for (var i=this.nbPts;i<this.nbPts * 2;i++) {
        var a = this["vertexPt"+i]
        xMoveTo(a,x0 + dx0 * (i-this.nbPts)/this.nbPts,y0 + dy0 * (i-this.nbPts) / this.nbPts)
        xShow(a);
      }
    }
  }
}

function dhtmlBox_submitForm() {
	var coords = new String()
	if (this.dblClick) { // manually delete 2 not needed values
		this.Xpoints.splice(this.Xpoints.length - 2, 2)
	}
	for (i = 0; i < this.Xpoints.length; i++) {
		coords += this.Xpoints[i] +"," + this.Ypoints[i] + ";"
	}
	if (dhtmlBox.shapeType == 'polygon') coords += this.Xpoints[0] +"," + this.Ypoints[0] + ";"  // last point equal to first
	myform.selection_coords.value = coords.substring(0,coords.length - 1) // delete the last coma
	// change the value of the tool form input
/*    for (var i =0; i < myform.tool.length ; i++) {
        if (myform.tool[i].checked) {
		    myform.tool[i].value = this.toolName
		}
	}
*/
	myform.selection_type.value = (this.shapeType == "pan") ? "point" : this.shapeType
//	alert ("type : " + myform.selection_coords.value + "\n coords : " + myform.selection_coords.value)
	xShow(dhtmlBox.anchor);
   	myform.submit();
}

function dhtmlBox_measureShape() {
	if (this.shapeType == 'line') { //Calculate the distance and display it
	  if (this.cnv_clicks > 1 && !this.keyEscape) {
        // distance calculation
        this.dist_x = (this.draw_x[this.cnv_clicks] - this.draw_x[this.cnv_clicks - 1]) * this.pixel_size;
        this.dist_y = (this.draw_y[this.cnv_clicks] - this.draw_y[this.cnv_clicks - 1]) * this.pixel_size;
        this.measure += Math.sqrt(this.dist_x * this.dist_x + this.dist_y * this.dist_y);
      }
	  
      if (this.dist_unit.indexOf('k') != -1) this.measure = Math.round(this.measure*100)/100
      else this.measure = Math.round(this.measure)
      this.displayMeasure.innerHTML = this.dist_msg + this.measure.toString() + this.dist_unit
	}
	if (this.shapeType == 'polygon') { // calculate the surface and display it
	  if (this.cnv_clicks > 1  && !this.keyEscape) {
        //surface calculation
        var i = 0;
        this.measure = 0;
        while (i < this.cnv_clicks - 1) {
          this.measure += this.Xpoints[i] * this.Ypoints[i+1] - this.Xpoints[i+1] * this.Ypoints[i];
          ++i;
        }
        this.measure += this.Xpoints[this.cnv_clicks -1] * this.Ypoints[0] - this.Xpoints[0] * this.Ypoints[this.cnv_clicks -1];
        var pix_surf = this.pixel_size * this.pixel_size;
        this.measure = Math.abs(this.measure.toString()) / 2 * pix_surf;
	  }
      if (this.surf_unit.indexOf('k') != -1) this.measure = Math.round(this.measure*10000)/10000
	  else this.measure = Math.round(this.measure)
      this.displayMeasure.innerHTML = this.surf_msg+ this.measure +this.surf_unit;
    }
}

new dhtmlBox(0);

dhtmlBox.prototype.initialize = dhtmlBox_initialize // create instance method
dhtmlBox.prototype.resizeAndMoveDivs = dhtmlBox_resizeAndMoveDivs
dhtmlBox.prototype.domousedown = dhtmlBox_mousedown
dhtmlBox.prototype.domousemove = dhtmlBox_mousemove
dhtmlBox.prototype.domouseup = dhtmlBox_mouseup
dhtmlBox.prototype.domouseout = dhtmlBox_mouseout
dhtmlBox.prototype.dodblclick = dhtmlBox_dblclick
dhtmlBox.prototype.dokeydown = dhtmlBox_keydown
dhtmlBox.prototype.paint = dhtmlBox_paint
dhtmlBox.prototype.lastLinePaint = dhtmlBox_lastLinePaint // draw the last straight vertex for the measure tool
dhtmlBox.prototype.changeTool = dhtmlBox_changetool
dhtmlBox.prototype.submitForm = dhtmlBox_submitForm
dhtmlBox.prototype.measureShape = dhtmlBox_measureShape

--- NEW FILE: carto.js ---
function FormItemSelected() {
  document.carto_form.submit();
}
  
function CheckRadio(theIndex) {
  document.carto_form.tool[theIndex].checked = true;
}

--- NEW FILE: x_event_nn4.js ---
// x_event_nn4.js
// For NN4 use this file instead of x_event.js. xInclude() will do this for you automatically.

// X v3.15, Cross-Browser DHTML Library from Cross-Browser.com
// Copyright (c) 2002,2003,2004 Michael Foster (mike at cross-browser.com)
// This library is distributed under the terms of the LGPL (gnu.org)

// partly modified by Pierre GIRAUD (p_giraud at hotmail.com)
// events list is not limited to mousemove for NN4

function xAddEventListener(e,eventType,eventListener,useCapture) {
  if(!(e=xGetElementById(e))) return;
  eventType=eventType.toLowerCase();
  if((!xIE4Up && !xOp7) && e==window) {
    if(eventType=='resize') { window.xPCW=xClientWidth(); window.xPCH=xClientHeight(); window.xREL=eventListener; xResizeEvent(); return; }
    if(eventType=='scroll') { window.xPSL=xScrollLeft(); window.xPST=xScrollTop(); window.xSEL=eventListener; xScrollEvent(); return; }
  }
  var eh='e.on'+eventType+'=eventListener';
  if(e.addEventListener) e.addEventListener(eventType,eventListener,useCapture);
  else if(e.attachEvent) e.attachEvent('on'+eventType,eventListener);
  else if(e.captureEvents) {
    if(useCapture||eventType.indexOf('mouse')!=-1) { e.captureEvents(eval('Event.'+eventType.toUpperCase())); }
    eval(eh);
  }
  else eval(eh);
}
function xRemoveEventListener(e,eventType,eventListener,useCapture) {
  if(!(e=xGetElementById(e))) return;
  eventType=eventType.toLowerCase();
  if((!xIE4Up && !xOp7) && e==window) {
    if(eventType=='resize') { window.xREL=null; return; }
    if(eventType=='scroll') { window.xSEL=null; return; }
  }
  var eh='e.on'+eventType+'=null';
  if(e.removeEventListener) e.removeEventListener(eventType,eventListener,useCapture);
  else if(e.detachEvent) e.detachEvent('on'+eventType,eventListener);
  else if(e.releaseEvents) {
    if(useCapture||eventType.indexOf('mouse')!=-1) { e.releaseEvents(eval('Event.'+eventType.toUpperCase())); }
    eval(eh);
  }
  else eval(eh);
}

var xMac = (xUA.indexOf("mac")!=-1);
function xEvent(evt) { // cross-browser event object prototype
  this.type = '';
  this.target = null;
  this.pageX = 0;
  this.pageY = 0;
  this.offsetX = 0;
  this.offsetY = 0;
  this.keyCode = 0;
  var e = evt ? evt : window.event;
  if(!e) return;
  if(e.type) this.type = e.type;
  if(e.target) this.target = e.target;
  else if(e.srcElement) this.target = e.srcElement;
  else if(xNN4) this.target = xLayerFromPoint(e.pageX, e.pageY);
  if(xOp5or6) { this.pageX = e.clientX; this.pageY = e.clientY; }
  else if(xDef(e.pageX,e.pageY)) { this.pageX = e.pageX; this.pageY = e.pageY; } // v3.14
  else if(xDef(e.clientX,e.clientY)) { this.pageX = e.clientX + xScrollLeft(); this.pageY = e.clientY + xScrollTop(); }
  if(xDef(e.offsetX,e.offsetY)) { this.offsetX = e.offsetX; this.offsetY = e.offsetY; }
  else if(xDef(e.layerX,e.layerY)) { this.offsetX = e.layerX; this.offsetY = e.layerY; }
  else { this.offsetX = this.pageX - xPageX(this.target); this.offsetY = this.pageY - xPageY(this.target); }
  // mac specificities
  if (xIE && xMac) {
    this.offsetX += xScrollLeft(); //document.body.scrollLeft;
    this.offsetY += xScrollTop(); //document.body.scrollTop;
  }
  //
  if (e.keyCode) { this.keyCode = e.keyCode; } // for moz/fb, if keyCode==0 use which
  else if (xDef(e.which)) { this.keyCode = e.which; }
  
}
function xLayerFromPoint(x,y,root) { // only for nn4
  var i, hn=null, hz=-1, cn;
  if (!root) root = window;
  for (i=0; i < root.document.layers.length; ++i) {
    cn = root.document.layers[i];
    if (cn.visibility != "hide" && x >= cn.pageX && x <= cn.pageX + cn.clip.right && y >= cn.pageY && y <= cn.pageY + cn.clip.bottom ) {
      if (cn.zIndex > hz) { hz = cn.zIndex; hn = cn; }
    }
  }
  if (hn) {
    cn = xLayerFromPoint(x,y,hn);
    if (cn) hn = cn;
  }
  return hn;
}
function xResizeEvent() { // window resize event simulation
  if (window.xREL) setTimeout('xResizeEvent()', 250);
  var cw = xClientWidth(), ch = xClientHeight();
  if (window.xPCW != cw || window.xPCH != ch) { window.xPCW = cw; window.xPCH = ch; if (window.xREL) window.xREL(); }
}
function xScrollEvent() { // window scroll event simulation
  if (window.xSEL) setTimeout('xScrollEvent()', 250);
  var sl = xScrollLeft(), st = xScrollTop();

  if (window.xPSL != sl || window.xPST != st) { window.xPSL = sl; window.xPST = st; if (window.xSEL) window.xSEL(); }
}
// end x_event_nn4.js

--- NEW FILE: graphTools.js ---
/*
graphTools.js

javascript functions to create and draw lines and points
for map navigation tool (zoom box, distance and surface measurement)

Part of this code was previously found from wz_jsgraphics.js (http://www.walterzorn.com)
and hardly adapted

Copyright 2004 Pierre GIRAUD
http://www.camptocamp.com
*/

var jg_ihtm, jg_ie, jg_fast, jg_dom, jg_moz,
jg_n4 = (document.layers && typeof document.classes != "undefined");


function chkDHTM(x, i)
{
	x = document.body || null;
	jg_ie = x && typeof x.insertAdjacentHTML != "undefined";
	jg_dom = (x && !jg_ie &&
		typeof x.appendChild != "undefined" &&
		typeof document.createRange != "undefined" &&
		typeof (i = document.createRange()).setStartBefore != "undefined" &&
		typeof i.createContextualFragment != "undefined");
	jg_ihtm = !jg_ie && !jg_dom && x && typeof x.innerHTML != "undefined";
	jg_fast = jg_ie && document.all && !window.opera;
	jg_moz = jg_dom && typeof x.style.MozOpacity != "undefined";
}

function pntDoc()
{
	this.wnd.document.write(this.htm);
	this.htm = '';
}


function pntCnvDom()
{
	var x = document.createRange();
	x.setStartBefore(this.cnv);
	x = x.createContextualFragment(this.htm);
	this.cnv.appendChild(x);
	this.htm = '';
}


function pntCnvIe()
{
	this.cnv.insertAdjacentHTML("beforeEnd",this.htm);
	this.htm = '';
}

function pntCnv()
{
	this.htm = '';
}


function mkDivPt(x,y)
{
	this.htm += '<div class="point" style="left:'+x+'px;top:'+y+'px"></div>';
	//this.htm += '<div style="position:absolute;left:'+x+';top:'+y+';width:4px;height:4px;background-color:red;overflow:hidden"></div>';
}

function mkLineH(x,y,h)
{
	this.htm += '<div class="lineH" style="left:'+x+'px;top:'+y+'px;height:'+h+'px"></div>';	
}

function mkLineW(x,y,w)
{
	this.htm += '<div class="lineW" style="left:'+x+'px;top:'+y+'px;width:'+w+'px"></div>';
}

function mkLinePts(x1,y1,x2,y2,d2pts) { //function added to draw lines with few points
  	this.printing = true;
	var dx = x2-x1;
	var dy = y2-y1;
	var darc = Math.sqrt(dx * dx + dy * dy); //arc length	
	var nb_pts = Math.round(darc / d2pts); // number of points on the arc
	var dx2pts = dx / nb_pts;
	var dy2pts = dy / nb_pts;
	var i = 0;
	this.mkDivPt(x1,y1);
	while (i < nb_pts) {
		++i;
		this.mkDivPt(Math.round(x1 + dx2pts * i), Math.round(y1 + dy2pts * i));
		//this.mkDiv(Math.round(x1 + dx2pts * i), Math.round(y1 + dy2pts * i),this.ptSize,this.ptSize);
	}
}

function mkRect(x, y, w, h, thickness)
{
	this.drawLineH(x, y, h);
	this.drawLineH(x+w, y,h);
	this.drawLineW(x, y+h,w+thickness);
	this.drawLineW(x, y,w);
}


function jsGraphics(id, wnd)
{
	this.setColor = new Function('arg', 'this.color = arg.toLowerCase();');

	this.setStroke = function(a,b)
	{
		this.stroke = a;
		this.ptSize = b;
			this.drawRect = mkRect;
			this.drawLinePts = mkLinePts;
			this.drawLineH = mkLineH;
			this.drawLineW = mkLineW;
	};
	
	this.drawPolylinePts = function(x, y, d) {
		for (var i=0; i<x.length - 1 ; i++) this.drawLinePts(x[i], y[i], x[i+1], y[i+1], d);
	}


	this.setPrintable = function()
	{
		this.mkDivPt = mkDivPt;
	};

	this.clear = function()
	{
		this.htm = "";
		if (this.cnv) this.cnv.innerHTML = this.defhtm;
	};


	this.setStroke(1);
	this.color = '#000000';
	this.htm = '';
	this.wnd = wnd || window;

	if (!(jg_ie || jg_dom || jg_ihtm)) chkDHTM();
	if (typeof id != 'string' || !id) {this.paint = pntDoc;}
	else
	{
		this.cnv = document.all? (this.wnd.document.all[id] || null)
			: document.getElementById? (this.wnd.document.getElementById(id) || null)
			: null;
		this.defhtm = (this.cnv && this.cnv.innerHTML)? this.cnv.innerHTML : '';
		this.paint = jg_dom? pntCnvDom : jg_ie? pntCnvIe : jg_ihtm? pntCnvIhtm : pntCnv;
	}

	this.setPrintable();
}
--- NEW FILE: Copie de navTools.js ---
// Global variables

// dhtmlBox constructor
function dhtmlBox() {
  this.anchor = xGetElementById("mapAnchorDiv");
  this.target = xGetElementById("mainDHTMLDiv");
  this.image = xGetElementById("mapImageDiv");
  this.canvas = xGetElementById("myCanvasDiv");
  this.canvas2 = xGetElementById("myCanvas2Div");
  this.displayContainer = xGetElementById("diplayContainerDiv");
  this.displayCoords = xGetElementById("displayCoordsDiv");
  this.displayMeasure = xGetElementById("displayMeasureDiv");

  this.x1 = this.y1 = this.x2 = this.y2 = -1;
  this.drag = false;
  this.isActive = false;
  this.dblClick = false;
  this.keyEscape = false;
}

// method prototypes
function dhtmlBox_initialize() {
  jg = new jsGraphics(this.canvas.id); // a drawing canvas for the lines and points
  jg2 = new jsGraphics(this.canvas2.id); // a drawing canvas for the last moving vertex

  // make the previous tool selected the current one
  for (var i =0; i < myform.tool.length ; i++) {
    if (myform.tool[i].checked) {
      dhtmlBox.changeTool('','','',myform.tool[i].value);
    }
  }
  
  // HACK FOR selection tool: find a better solution !!
  if (myform.tool.length >= 5 && myform.tool[4].checked) {
     dhtmlBox.changeTool('query');
  }
  
  this.target.style.zIndex = 1000;

  this.width = xWidth(this.anchor);
  this.height = xHeight(this.anchor);

  xResizeTo(this.image,this.width,this.height);
  xResizeTo(this.target,this.width,this.height);
  xResizeTo(this.canvas,this.width,this.height);
  xResizeTo(this.canvas2,this.width,this.height);
  xWidth(this.displayContainer,this.width);

  xMoveTo(this.image,xPageX(this.anchor),xPageY(this.anchor));
  xMoveTo(this.target,xPageX(this.anchor),xPageY(this.anchor));
  xMoveTo(this.canvas,xPageX(this.anchor),xPageY(this.anchor));
  xMoveTo(this.canvas2,xPageX(this.anchor),xPageY(this.anchor));
  xShow(this.image);

  if (this.dispPos == "top") this.dispPos = -13;
  else if (this.dispPos == "bottom") this.dispPos = this.height;
  else this.dispPos = 0;
  xMoveTo(this.displayContainer,xPageX(this.anchor),xPageY(this.anchor) + this.dispPos);

  xClip(this.target,0,this.width,this.height,0);
}

/*
function dhtmlBox_changetool(tool) {// the mouse events are managed in this function according to the mapping tool selected
  myform.tool.value = tool;
  this.currentTool = tool.toLowerCase();

  // clear the drawing canvas
  jg.clear();

  xRemoveEventListener(this.target,'mousedown',this.domousedown);
  xRemoveEventListener(this.target,'mouseup',this.domouseup);
  xRemoveEventListener(this.target,'mousemove',this.domousemove);
  xRemoveEventListener(this.target,'mouseout',this.domouseout);
  xRemoveEventListener(this.target, 'dblclick', this.dodblclick);
  
  xAddEventListener(this.target,'mousedown',this.domousedown);
  xAddEventListener(this.target,'mouseup',this.domouseup);
  xAddEventListener(this.target,'mousemove',this.domousemove);
  xAddEventListener(this.target,'mouseout',this.domouseout);

  xAddEventListener(document,'keydown',this.dokeydown);

  if (this.currentTool == 'distance' || this.currentTool == 'surface' || this.currentTool == 'polygon' || this.currentTool == 'line') {
    this.isActive = false;
    this.distance = 0;
    this.displayCoords.innerHTML = '';
    this.displayMeasure.innerHTML = '';
    xAddEventListener(this.target,'dblclick', this.dodblclick);
  }

  // cursor style
  if (this.currentTool == 'zoom_in' || this.currentTool == 'zoom_out' || this.currentTool == 'distance' || this.currentTool == 'surface' || this.currentTool == 'polygon' || this.currentTool == 'line') {
    if (this.target.style) this.target.style.cursor = "crosshair";
  } else if (this.currentTool == 'pan') {
    if (this.target.style) this.target.style.cursor = "move";
  } else if (this.currentTool == 'query') {
    if (this.target.style) this.target.style.cursor = "help";
  }
  jg.paint();
}
*/

// the mouse events are managed in this function according to the mapping tool selected
// shape accepted values : point, rectangle, line, polygon
// action : submit, measure
// cursorStyle : crosshair, help, move
// TODO tool name not necessary
// tool : name of the tool (ie query, zoomin,
function dhtmlBox_changetool(shape,action,cursorStyle,tool) {
//  myform.tool.value = tool;
  this.currentTool = tool.toLowerCase();
  this.shapeType = shape;
  this.action = action;
  // clear the drawing canvas
  jg.clear();

  xRemoveEventListener(this.target,'mousedown',this.domousedown);
  xRemoveEventListener(this.target,'mouseup',this.domouseup);
  xRemoveEventListener(this.target,'mousemove',this.domousemove);
  xRemoveEventListener(this.target,'mouseout',this.domouseout);
  xRemoveEventListener(this.target, 'dblclick', this.dodblclick);
  
  xAddEventListener(this.target,'mousedown',this.domousedown);
  xAddEventListener(this.target,'mouseup',this.domouseup);
  xAddEventListener(this.target,'mousemove',this.domousemove);
  xAddEventListener(this.target,'mouseout',this.domouseout);

  xAddEventListener(document,'keydown',this.dokeydown);
  
  this.isActive = false;

  if (this.shapeType == 'polygon' || this.shapeType == 'line') {
    xAddEventListener(this.target,'dblclick', this.dodblclick);
  }

  // cursor style
  if (this.target.style) this.target.style.cursor = cursorStyle;
  jg.paint();
}

function dhtmlBox_mousedown(evt) {
  var e = new xEvent(evt);
  
  if (!(xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) && evt.button == 2) { //right clic
    dhtmlBox.rightclic = true;
  } else {
    dhtmlBox.rightclic = false;

    dhtmlBox.x1 = dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y1 = dhtmlBox.y2 = e.offsetY;
	
    if (dhtmlBox.shapeType == "point") {
      jg.clear();  // if page not reloaded automaticaly, previous crosses are deleted
    }
	
	if (!dhtmlBox.isActive) {
	  dhtmlBox.isActive = true;
	  if (dhtmlBox.shapeType == 'polygon' || dhtmlBox.shapeType == 'line') { //init
      	  jg.clear();
	      //jg2.clear();
    	  dhtmlBox.cnv_clicks = 0;
	      dhtmlBox.draw_x = new Array();
    	  dhtmlBox.draw_y = new Array();
	      dhtmlBox.Xpoints = new Array();
    	  dhtmlBox.Ypoints = new Array();
	      dhtmlBox.distance = 0;
		  dhtmlBox.dblClick = false;
    	  dhtmlBox.keyEscape = false;
	  }
    }

  }
  if (dhtmlBox.action == 'submit' && (dhtmlBox.shapeType == 'polygon' || dhtmlBox.shapeType == 'line')) {
    dhtmlBox.drag = false; // to provide the curves draw (ie for polygon or line selection submit, TODO test if curves can be used
  } else {
	dhtmlBox.drag = true; // the mouse is down
  }
}

function dhtmlBox_mousemove(evt) {
  var e = new xEvent(evt);

  //show the coords display
  xShow(dhtmlBox.displayContainer);

  if(dhtmlBox.drag) { //the mouse is down
    dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y2 = e.offsetY;
	if (dhtmlBox.shapeType == 'point') {
      jg.clear();
      dhtmlBox.x1 = dhtmlBox.x2;
      dhtmlBox.y1 = dhtmlBox.y2;
    }
    dhtmlBox.paint();
  }
  else if ((dhtmlBox.shapeType == 'polygon' || dhtmlBox.shapeType == 'line') && dhtmlBox.isActive == true) {
      dhtmlBox.x2 = e.offsetX;
      dhtmlBox.y2 = e.offsetY;
      dhtmlBox.lastLinePaint(); // the last line is drawn while moving
  }
    // display the coordinates
    dhtmlBox.displayCoords.innerHTML = dhtmlBox.coord_msg + Math.round((e.offsetX * dhtmlBox.pixel_size) + dhtmlBox.boxx)  +" / "+ Math.round(((dhtmlBox.mapHeight - e.offsetY) * dhtmlBox.pixel_size) + dhtmlBox.boxy);
}

function dhtmlBox_mouseup(evt) {
  var e = new xEvent(evt);

  if (dhtmlBox.rightclic == true) {
    jg2.clear();
  } else {

    dhtmlBox.drag = false; //the mouse is now up

    dhtmlBox.x2 = e.offsetX;
    dhtmlBox.y2 = e.offsetY;

    //the box is too small
    if(((Math.abs(dhtmlBox.x1-dhtmlBox.x2) <= dhtmlBox.jitter) || (Math.abs(dhtmlBox.y1-dhtmlBox.y2) <= dhtmlBox.jitter)) && dhtmlBox.currentTool == 'zoom_in') {
      dhtmlBox.x2 = dhtmlBox.x1 = Math.abs(dhtmlBox.x1-dhtmlBox.x2) /2 + Math.min(dhtmlBox.x1, dhtmlBox.x2); //zoom to center of the box
      dhtmlBox.y2 = dhtmlBox.y1 = Math.abs(dhtmlBox.y1-dhtmlBox.y2) /2 + Math.min(dhtmlBox.y1, dhtmlBox.y2)
    }
	
	// rectangle draw finished
	if (dhtmlBox.shapeType == 'point' || dhtmlBox.shapeType == 'rectangle') dhtmlBox.isActive = false;
	
	// polygon closed by click on the first point
	if (dhtmlBox.shapeType == 'polygon' && Math.abs(dhtmlBox.x2 - dhtmlBox.draw_x[1]) <= dhtmlBox.jitter && Math.abs(dhtmlBox.y2 - dhtmlBox.draw_y[1]) <= dhtmlBox.jitter && dhtmlBox.draw_x.length > 2) {
		dhtmlBox.keyEscape = true;
		dhtmlBox.isActive = false;
		jg2.clear();
	}
    dhtmlBox.paint();
  }
}

function dhtmlBox_mouseout(evt) {
  var e = new xEvent(evt);

  xHide(dhtmlBox.displayContainer);
  jg2.clear();
}

function dhtmlBox_dblclick(evt) {
  var e = new xEvent(evt)
  dhtmlBox.dblClick = true
  dhtmlBox.isActive = false
  jg2.clear()
  dhtmlBox.paint()
}

function dhtmlBox_keydown(evt) { // 
  evt = (evt) ? evt : ((event) ? event : null)
  dhtmlBox = dhtmlBox
  if (evt.keyCode == '27' && (dhtmlBox.shapeType == 'polygon'  || dhtmlBox.shapeType == 'line')) {
    dhtmlBox.keyEscape = true
    dhtmlBox.isActive = false
    jg2.clear()
    dhtmlBox.paint()
  }
}

function dhtmlBox_paint() { // draws alternatively boxes, lines, polylines, crosses, or pan the map
  var x, y, w, h;

  x = Math.min(this.x1, this.x2);
  y = Math.min(this.y1, this.y2);

  if (this.shapeType == 'point') { //draws only a cross
      jg.drawLineW(x-this.cursorsize,y - this.thickness /2,this.cursorsize * 2);
      jg.drawLineH(x - this.thickness /2,y-this.cursorsize ,this.cursorsize * 2);
      jg.paint();
  }
  else if (this.shapeType == 'rectangle') {
    if(this.x1==this.x2 && this.y1==this.y2) {
        jg.clear()
        jg.drawLineW(x-this.cursorsize,y - this.thickness /2,this.cursorsize * 2)
        jg.drawLineH(x - this.thickness /2,y-this.cursorsize ,this.cursorsize * 2)
        jg.paint()

    } else {
      w = Math.abs(this.x1-this.x2)
      h = Math.abs(this.y1-this.y2)
      jg.clear()
      jg.drawRect(x,y,w,h,this.thickness)
      jg.paint()
    }
  }
  else if (this.currentTool == 'pan') {
    var dx,dy

    dx = this.x2 - this.x1
    dy = this.y2 - this.y1

    xMoveTo(this.image,dx + xPageX(this.anchor),dy + xPageY(this.anchor))
    xClip(this.image,(dy<0)? Math.abs(dy):0,(dx>0)? this.width - dx : this.width,(dy>0)? this.height-dy:this.height,(dx<0)? Math.abs(dx):0)
    //xResizeTo(this.image,(dy<0)? Math.abs(dy):0,(dx>0)? this.width - dx : this.width,(dy>0)? this.height-dy:this.height,(dx<0)? Math.abs(dx):0);
  }

  else if (this.shapeType == 'line') {
    if (!this.keyEscape) { // Escape key is pressed
      ++this.cnv_clicks;
      this.draw_x[this.cnv_clicks] = this.x2;
      this.draw_y[this.cnv_clicks] = this.y2;
    }
    this.Xpoints[this.cnv_clicks - 1] = this.draw_x[this.cnv_clicks];
    this.Ypoints[this.cnv_clicks - 1] = this.draw_y[this.cnv_clicks];
    if (xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) { // IE/Mac specificity
      jg.clear();
      jg.drawPolylinePts(this.Xpoints,this.Ypoints, this.d2pts);
    }
    else {
        jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[this.cnv_clicks - 1],this.draw_y[this.cnv_clicks - 1],this.d2pts);
    }
	if (this.action == 'measure') { //Calculate the distance and display it
	  if (this.cnv_clicks > 1 && !this.keyEscape) {
        // distance calculation
        this.dist_x = (this.draw_x[this.cnv_clicks] - this.draw_x[this.cnv_clicks - 1]) * this.pixel_size;
        this.dist_y = (this.draw_y[this.cnv_clicks] - this.draw_y[this.cnv_clicks - 1]) * this.pixel_size;
        this.distance += Math.sqrt(this.dist_x * this.dist_x + this.dist_y * this.dist_y);
      }
      if (this.dist_unit == ' m.') this.distance = Math.round(this.distance);
      else if (this.dist_unit == ' km.') this.distance = Math.round(this.distance*100)/100;
      this.displayMeasure.innerHTML = this.dist_msg + this.distance.toString() + this.dist_unit;
	}
    jg.paint();
  }
  else if (this.shapeType == 'polygon') {
    if (!this.keyEscape) { // Escape key is pressed
      ++this.cnv_clicks;
      this.draw_x[this.cnv_clicks] = this.x2;
      this.draw_y[this.cnv_clicks] = this.y2;
    }
    this.Xpoints[this.cnv_clicks - 1] = this.draw_x[this.cnv_clicks];
    this.Ypoints[this.cnv_clicks - 1] = this.draw_y[this.cnv_clicks];
    if (xUA.indexOf('mac_')!=-1 && xUA.indexOf('msie')!=-1) { // IE/Mac specificity
      if (!this.isActive) { // close the polygon
        this.Xpoints[this.cnv_clicks] = this.draw_x[1];
        this.Ypoints[this.cnv_clicks] = this.draw_y[1];
      }
      jg.clear();
      jg.drawPolylinePts(this.Xpoints,this.Ypoints, this.d2pts);
    }
    else {
      jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[this.cnv_clicks - 1],this.draw_y[this.cnv_clicks - 1],this.d2pts);
      if (!this.isActive) { // close the polygon
        jg.drawLinePts(this.draw_x[this.cnv_clicks],this.draw_y[this.cnv_clicks],this.draw_x[1],this.draw_y[1],this.d2pts);		
      }
    }

	if (this.action == 'measure') { // calculate the surface and display it
	  if (this.cnv_clicks > 1  && !this.keyEscape) {
        //surface calculation
        var i = 0;
        this.distance = 0;
        while (i < this.cnv_clicks - 1) {
          this.distance += this.Xpoints[i] * this.Ypoints[i+1] - this.Xpoints[i+1] * this.Ypoints[i];
          ++i;
        }
        this.distance += this.Xpoints[this.cnv_clicks -1] * this.Ypoints[0] - this.Xpoints[0] * this.Ypoints[this.cnv_clicks -1];
        var pix_surf = this.pixel_size * this.pixel_size;
        this.distance = Math.abs(this.distance.toString()) / 2 * pix_surf;
	  }
      if (this.surf_unit == ' m2.') this.distance = Math.round(this.distance);
      else if (this.surf_unit == ' km2.') this.distance = Math.round(this.distance*10000)/10000;
      this.displayMeasure.innerHTML = this.surf_msg+ this.distance +this.surf_unit;
    }
	jg.paint();
	

	}
	// submit the form with the values
	if (dhtmlBox.action == 'submit' && !this.isActive ) {
		if (dhtmlBox.shapeType == 'point') {
			myform.selection_coords.value = x+","+y
		}
		else if (dhtmlBox.shapeType == 'rectangle') {
			dhtmlBox.removeEventsWait();
      		myform.selection_coords.value = dhtmlBox.x1+" "+dhtmlBox.y1+","+dhtmlBox.x2+" "+dhtmlBox.y2
		}
		else if (dhtmlBox.shapeType == 'line' || dhtmlBox.shapeType == 'polygon') {
			var coords = new String()
			for (i = 0; i < this.Xpoints.length; i++) {
				coords += this.Xpoints[i] +" " + this.Ypoints[i] + ","
			}
			if (dhtmlBox.shapeType == 'polygon') coords += this.Xpoints[0] +" " + this.Ypoints[0] + ","  // last point equal to first
			myform.selection_coords.value = coords.substring(0,coords.length - 1)

		}
		alert (myform.selection_coords.value)
		xShow(dhtmlBox.anchor);
      	myform.submit();		
  }
}


function dhtmlBox_lastLinePaint() {

  var x2 = this.x2;
  var y2 = this.y2;
  var x = this.draw_x[this.cnv_clicks];
  var y = this.draw_y[this.cnv_clicks];
  var x0 = this.draw_x[1];
  var y0 = this.draw_y[1];

  if (xIE || xUA.indexOf('mac')!=-1) { //use the drawing API
    jg2.clear();
    jg2.drawLinePts(x2,y2,x,y,this.d2pts); //draw the last vertex
    if (this.shapeType == 'polygon') {
      jg2.drawLinePts(x2,y2,x0,y0,this.d2pts); // also draw the line to close the polygon
    }
    jg2.paint();
  }
  else { //doesn't use the drawing API
    if (this.canvas2.innerHTML == '') { // create the DIVs if doesn't exist
      for (var i=0; i< this.nbPts * 2; i++) {
        this["vertexPt"+i] = xCreateElement('div');
        xAppendChild(this.canvas2,this["vertexPt"+i],200);
        this["vertexPt"+i].className = "point";
        xHide(this["vertexPt"+i]);
        if (this["vertexPt"+i].style) this["vertexPt"+i].style.position = "absolute";
      }
    }
    var dx = x2 - x;
    var dy = y2 - y;
    for (var i=0;i<this.nbPts;i++) {
      var a = this["vertexPt"+i];
      xMoveTo(a,x + dx *i/ this.nbPts,y + dy *i/ this.nbPts);
      xShow(a);
    }
    if (this.shapeType == 'polygon') {
      var dx0 = x2 - x0;
      var dy0 = y2 - y0;
      for (var i=this.nbPts;i<this.nbPts * 2;i++) {
        var a = this["vertexPt"+i];
        xMoveTo(a,x0 + dx0 * (i-this.nbPts)/this.nbPts,y0 + dy0 * (i-this.nbPts) / this.nbPts);
        xShow(a);
      }
    }
  }
}



new dhtmlBox(0);

dhtmlBox.prototype.initialize = dhtmlBox_initialize; // create instance method
dhtmlBox.prototype.domousedown = dhtmlBox_mousedown;
dhtmlBox.prototype.domousemove = dhtmlBox_mousemove;
dhtmlBox.prototype.domouseup = dhtmlBox_mouseup;
dhtmlBox.prototype.domouseout = dhtmlBox_mouseout;
dhtmlBox.prototype.dodblclick = dhtmlBox_dblclick;
dhtmlBox.prototype.dokeydown = dhtmlBox_keydown;
dhtmlBox.prototype.paint = dhtmlBox_paint;
dhtmlBox.prototype.lastLinePaint = dhtmlBox_lastLinePaint; // draw the last straight vertex for the measure tool
dhtmlBox.prototype.changeTool = dhtmlBox_changetool;
dhtmlBox.prototype.removeEventsWait = dhtmlBox_removeEventsWait;

/*
function changeTool(dhtmlBox,tool) {
  dhtmlBox.changetool(tool);
}
*/

function dhtmlBox_removeEventsWait() {
   xRemoveEventListener(this.target, 'mousemove', this.domousemove);
   if (this.target.style) this.target.style.cursor = "wait";
}

--- NEW FILE: tree.js ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: x_dom_nn4.js ---
// x_dom_nn4.js, X v3.15.2, Cross-Browser.com DHTML Library
// Copyright (c) 2004 Michael Foster, Licensed LGPL (gnu.org)

// Returns a new Element object. For NN4, returns a new Object object.

//Modified by Pierre GIRAUD 
function xCreateElement(sTag)
{
  var ele=null;
  if (document.createElement) ele = document.createElement(sTag);
  else if (xNN4) ele = new Object();
  return ele;
}
function xAppendChild(oParent, oChild, nn4Width) // returns oChild
{
  var ele=null;
  if (oParent && oParent.appendChild) ele = oParent.appendChild(oChild);
  else if (xNN4) {
    if (typeof(oChild)=='object') delete oChild;
    if (!oParent || oParent.id.indexOf('_layer')==-1) {
      oParent = window;
      if (!nn4Width) nn4Width = xClientWidth();
    }
    else if (!nn4Width) nn4Width = xWidth(oParent);
    ele = new Layer(nn4Width, oParent);
  }
  return ele;
}

--- NEW FILE: x_core_nn4.js ---
// x_core_nn4.js
// For NN4 use this file instead of x_core.js. xInclude() will do this for you automatically.

// X v3.15.1, Cross-Browser DHTML Library from Cross-Browser.com
// Copyright (c) 2002,2003,2004 Michael Foster (mike at cross-browser.com)
// This library is distributed under the terms of the LGPL (gnu.org)

// Variables:
var xVersion='3.15.1',xNN4=false,xOp7=false,xOp5or6=false,xIE=false,xIE4Up=false,xIE4=false,xIE5=false,xUA=navigator.userAgent.toLowerCase();
if(window.opera){
  xOp7=(xUA.indexOf('opera 7')!=-1 || xUA.indexOf('opera/7')!=-1);
  if (!xOp7) xOp5or6=(xUA.indexOf('opera 5')!=-1 || xUA.indexOf('opera/5')!=-1 || xUA.indexOf('opera 6')!=-1 || xUA.indexOf('opera/6')!=-1);
}
else if (document.layers) {xNN4=true;}
else if (document.all) {
  xIE=xUA.indexOf('msie')!=-1;
  xIE4Up=xUA.indexOf('msie')!=-1 && parseInt(navigator.appVersion)>=4;
  xIE4=xUA.indexOf('msie 4')!=-1;
  xIE5=xUA.indexOf('msie 5')!=-1;
}
// Object:
function xGetElementById(e) {
  if(typeof(e)!='string') return e;
  if(document.getElementById) e=document.getElementById(e);
  else if(document.all) e=document.all[e];
  else if(document.layers) e=xLayer(e);
  else e=null;
  return e;
}
function xLayer(id,root) { // only for nn4
  var i,layer,found=null;
  if (!root) root=window;
  for(i=0; i<root.document.layers.length; i++) {
    layer=root.document.layers[i];
    if(layer.id==id) return layer;
    if(layer.document.layers.length) found=xLayer(id,layer);
    if(found) return found;
  }
  return null;
}
function xParent(e,bNode){
  if (!(e=xGetElementById(e))) return null;
  var p=null;
  if (!bNode && xDef(e.offsetParent)) p=e.offsetParent;
  else if (xDef(e.parentNode)) p=e.parentNode;
  else if (xDef(e.parentElement)) p=e.parentElement;
  else if (xDef(e.parentLayer)){if (e.parentLayer!=window) p=e.parentLayer;}
  return p;
}
function xDef() {
  for(var i=0; i<arguments.length; ++i){if(typeof(arguments[i])=='undefined') return false;}
  return true;
}
function xStr(s) {
  return typeof(s)=='string';
}
function xNum(n) {
  return typeof(n)=='number';
}
function xInnerHtml(e, sHtml) {
  if(!(e=xGetElementById(e))) return '';
  if (xStr(e.innerHTML)) {
    if (xStr(sHtml)) e.innerHTML = sHtml;
    else return e.innerHTML;
  }
  else if (xNN4) {
    if (xStr(sHtml)) {
      if (sHtml=='') sHtml = ' ';
      e.document.open();
      e.document.write(sHtml);
      e.document.close();
    }
    else return '';
  }
}
// Appearance:
function xShow(e) {
  if(!(e=xGetElementById(e))) return;
  if(e.style && xDef(e.style.visibility)) e.style.visibility='visible';
  else if(xDef(e.visibility)) e.visibility='show';
}
function xHide(e) {
  if(!(e=xGetElementById(e))) return;
  if(e.style && xDef(e.style.visibility)) e.style.visibility='hidden';
  else if(xDef(e.visibility)) e.visibility='hide';
}
function xZIndex(e,uZ) {
  if(!(e=xGetElementById(e))) return 0;
  if(e.style && xDef(e.style.zIndex)) {
    if(xNum(uZ)) e.style.zIndex=uZ;
    uZ=parseInt(e.style.zIndex);
  }
  else if(xDef(e.zIndex)) {
    if(xNum(uZ)) e.zIndex=uZ;
    uZ=e.zIndex;
  }
  return uZ;
}
function xColor(e,sColor) {
  if(!(e=xGetElementById(e))) return '';
  var c='';
  if(e.style && xDef(e.style.color)) {
    if(xStr(sColor)) e.style.color=sColor;
    c=e.style.color;
  }
  return c;
}
function xBackground(e,sColor,sImage) {
  if(!(e=xGetElementById(e))) return '';
  var bg='';
  if(e.style) {
    if(xStr(sColor)) {
      if(!xOp5or6) e.style.backgroundColor=sColor;
      else e.style.background=sColor;
    }
    if(xStr(sImage)) e.style.backgroundImage=(sImage!='')? 'url('+sImage+')' : null;
    if(!xOp5or6) bg=e.style.backgroundColor;
    else bg=e.style.background;
  }
  else if(xDef(e.bgColor)) {
    if(xStr(sColor)) e.bgColor=sColor;
    bg=e.bgColor;
    if(xStr(sImage)) e.background.src=sImage;
  }
  return bg;
}
// Position:
function xMoveTo(e,iX,iY) {
  xLeft(e,iX);
  xTop(e,iY);
}
function xLeft(e,iX) {
  if(!(e=xGetElementById(e))) return 0;
  var css=xDef(e.style);
  if (css && xStr(e.style.left)) {
    if(xNum(iX)) e.style.left=iX+'px';
    else {
      iX=parseInt(e.style.left);
      if(isNaN(iX)) iX=0;
    }
  }
  else if(css && xDef(e.style.pixelLeft)) {
    if(xNum(iX)) e.style.pixelLeft=iX;
    else iX=e.style.pixelLeft;
  }
  else if(xDef(e.left)) {
    if(xNum(iX)) e.left=iX;
    else iX=e.left;
  }
  return iX;
}
function xTop(e,iY) {
  if(!(e=xGetElementById(e))) return 0;
  var css=xDef(e.style);
  if(css && xStr(e.style.top)) {
    if(xNum(iY)) e.style.top=iY+'px';
    else {
      iY=parseInt(e.style.top);
      if(isNaN(iY)) iY=0;
    }
  }
  else if(css && xDef(e.style.pixelTop)) {
    if(xNum(iY)) e.style.pixelTop=iY;
    else iY=e.style.pixelTop;
  }
  else if(xDef(e.top)) {
    if(xNum(iY)) e.top=iY;
    else iY=e.top;
  }
  return iY;
}
function xPageX(e) {
  if (!(e=xGetElementById(e))) return 0;
  if (xDef(e.pageX)) return e.pageX;
  var x = 0;
  while (e) {
    if (xDef(e.offsetLeft)) x += e.offsetLeft;
    e = xDef(e.offsetParent) ? e.offsetParent : null;
  }
  return x;
}
function xPageY(e) {
  if (!(e=xGetElementById(e))) return 0;
  if (xDef(e.pageY)) return e.pageY;
  var y = 0;
  while (e) {
    if (xDef(e.offsetTop)) y += e.offsetTop;
    e = xDef(e.offsetParent) ? e.offsetParent : null;
  }
//  if (xOp7) return y - document.body.offsetTop; // v3.14, temporary hack for opera bug 130324
  return y;
}
function xOffsetLeft(e) {
  if (!(e=xGetElementById(e))) return 0;
  if (xDef(e.offsetLeft)) return e.offsetLeft;
  else return xPageX(e) - xPageX(xParent(e));
}
function xOffsetTop(e) {
  if (!(e=xGetElementById(e))) return 0;
  if (xDef(e.offsetTop)) return e.offsetTop;
  else return xPageY(e) - xPageY(xParent(e));
}
function xScrollLeft(e) {
  var offset=0;
  if (!(e=xGetElementById(e))) {
    if(xDef(window.pageXOffset)) offset=window.pageXOffset;
    else if(document.documentElement && document.documentElement.scrollLeft) offset=document.documentElement.scrollLeft;
    else if(document.body && xDef(document.body.scrollLeft)) offset=document.body.scrollLeft;
  }
  else { if (xNum(e.scrollLeft)) offset = e.scrollLeft; }
  return offset;
}
function xScrollTop(e) {
  var offset=0;
  if (!(e=xGetElementById(e))) {
    if(xDef(window.pageYOffset)) offset=window.pageYOffset;
    else if(document.documentElement && document.documentElement.scrollTop) offset=document.documentElement.scrollTop;
    else if(document.body && xDef(document.body.scrollTop)) offset=document.body.scrollTop;
  }
  else { if (xNum(e.scrollTop)) offset = e.scrollTop; }
  return offset;
}
function xHasPoint(ele, iLeft, iTop, iClpT, iClpR, iClpB, iClpL) {
  if (!xNum(iClpT)){iClpT=iClpR=iClpB=iClpL=0;}
  else if (!xNum(iClpR)){iClpR=iClpB=iClpL=iClpT;}
  else if (!xNum(iClpB)){iClpL=iClpR; iClpB=iClpT;}
  var thisX = xPageX(ele), thisY = xPageY(ele);
  return (iLeft >= thisX + iClpL && iLeft <= thisX + xWidth(ele) - iClpR &&
          iTop >=thisY + iClpT && iTop <= thisY + xHeight(ele) - iClpB );
}
// Size:
function xResizeTo(e,uW,uH) {
  xWidth(e,uW);
  xHeight(e,uH);
}
function xWidth(e,uW) {
  if(!(e=xGetElementById(e))) return 0;
  if (xNum(uW)) { // v3.13.1
    if (uW<0) uW = 0;
    else uW=Math.round(uW);
  }
  else uW=0;
  var css=xDef(e.style);
  if(css && xDef(e.offsetWidth) && xStr(e.style.width)) {
    if(uW) xSetCW(e, uW);
    uW=e.offsetWidth;
  }
  else if(css && xDef(e.style.pixelWidth)) {
    if(uW) e.style.pixelWidth=uW;
    uW=e.style.pixelWidth;
  }
  else if(xDef(e.clip) && xDef(e.clip.right)) {
    if(uW) e.clip.right=uW;
    uW=e.clip.right;
  }
  return uW;
}
function xHeight(e,uH) {
  if(!(e=xGetElementById(e))) return 0;
  if (xNum(uH)) { // v3.13.1
    if (uH<0) uH = 0;
    else uH=Math.round(uH);
  }
  else uH=0;
  var css=xDef(e.style);
  if(css && xDef(e.offsetHeight) && xStr(e.style.height)) {
    if(uH) xSetCH(e, uH);
    uH=e.offsetHeight;
  }
  else if(css && xDef(e.style.pixelHeight)) {
    if(uH) e.style.pixelHeight=uH;
    uH=e.style.pixelHeight;
  }
  else if(xDef(e.clip) && xDef(e.clip.bottom)) {
    if(uH) e.clip.bottom=uH;
    uH=e.clip.bottom;
  }
  return uH;
}
function xGetCS(ele,sP){return parseInt(document.defaultView.getComputedStyle(ele,'').getPropertyValue(sP));}
function xSetCW(ele,uW){
  var pl=0,pr=0,bl=0,br=0;
  if(xDef(document.defaultView) && xDef(document.defaultView.getComputedStyle)){
    pl=xGetCS(ele,'padding-left');
    pr=xGetCS(ele,'padding-right');
    bl=xGetCS(ele,'border-left-width');
    br=xGetCS(ele,'border-right-width');
  }
  else if(xDef(ele.currentStyle,document.compatMode)){
    if(document.compatMode=='CSS1Compat'){
      pl=parseInt(ele.currentStyle.paddingLeft);
      pr=parseInt(ele.currentStyle.paddingRight);
      bl=parseInt(ele.currentStyle.borderLeftWidth);
      br=parseInt(ele.currentStyle.borderRightWidth);
    }
  }
  else if(xDef(ele.offsetWidth,ele.style.width)){ // ?
    ele.style.width=uW+'px';
    //pl=ele.offsetWidth-uW;  // bug in IE4
  }
  if(isNaN(pl)) pl=0; if(isNaN(pr)) pr=0; if(isNaN(bl)) bl=0; if(isNaN(br)) br=0;
  var cssW=uW-(pl+pr+bl+br);
  if(isNaN(cssW)||cssW<0) return;
  else ele.style.width=cssW+'px';
}
function xSetCH(ele,uH){
  var pt=0,pb=0,bt=0,bb=0;
  if(xDef(document.defaultView) && xDef(document.defaultView.getComputedStyle)){
    pt=xGetCS(ele,'padding-top');
    pb=xGetCS(ele,'padding-bottom');
    bt=xGetCS(ele,'border-top-width');
    bb=xGetCS(ele,'border-bottom-width');
  }
  else if(xDef(ele.currentStyle,document.compatMode)){
    if(document.compatMode=='CSS1Compat'){
      pt=parseInt(ele.currentStyle.paddingTop);
      pb=parseInt(ele.currentStyle.paddingBottom);
      bt=parseInt(ele.currentStyle.borderTopWidth);
      bb=parseInt(ele.currentStyle.borderBottomWidth);
    }
  }
  else if(xDef(ele.offsetHeight,ele.style.height)){ // ?
    ele.style.height=uH+'px';
    //pt=ele.offsetHeight-uH;  // bug in IE4
  }
  if(isNaN(pt)) pt=0; if(isNaN(pb)) pb=0; if(isNaN(bt)) bt=0; if(isNaN(bb)) bb=0;
  var cssH=uH-(pt+pb+bt+bb);
  if(isNaN(cssH)||cssH<0) return;
  else ele.style.height=cssH+'px';
}
function xClip(e,iTop,iRight,iBottom,iLeft) {
  if(!(e=xGetElementById(e))) return;
  if(e.style) {
    if (xNum(iLeft)) e.style.clip='rect('+iTop+'px '+iRight+'px '+iBottom+'px '+iLeft+'px)';
    else e.style.clip='rect(0 '+parseInt(e.style.width)+'px '+parseInt(e.style.height)+'px 0)';
  }
  else if(e.clip) {
    if (xNum(iLeft)) { e.clip.top=iTop; e.clip.right=iRight; e.clip.bottom=iBottom; e.clip.left=iLeft; }
    else { e.clip.top=0; e.clip.right=xWidth(e); e.clip.bottom=xHeight(e); e.clip.left=0; }
  }
}
// Window:
function xClientWidth() {
  var w=0;
  if(xOp5or6) w=window.innerWidth;
  else if(!window.opera && document.documentElement && document.documentElement.clientWidth) // v3.12
    w=document.documentElement.clientWidth;
  else if(document.body && document.body.clientWidth)
    w=document.body.clientWidth;
  else if(xDef(window.innerWidth,window.innerHeight,document.height)) {
    w=window.innerWidth;
    if(document.height>window.innerHeight) w-=16;
  }
  return w;
}
function xClientHeight() {
  var h=0;
  if(xOp5or6) h=window.innerHeight;
  else if(!window.opera && document.documentElement && document.documentElement.clientHeight) // v3.12
    h=document.documentElement.clientHeight;
  else if(document.body && document.body.clientHeight)
    h=document.body.clientHeight;
  else if(xDef(window.innerWidth,window.innerHeight,document.width)) {
    h=window.innerHeight;
    if(document.width>window.innerWidth) h-=16;
  }
  return h;
}
// end x_core_nn4.js



From stef at berlios.de  Thu Jan 20 11:15:53 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:15:53 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/lang public_pt.php3,NONE,1.1 spip_oc_gsc.php3,NONE,1.1 spip_oc_lnc.php3,NONE,1.1 spip_vi.php3,NONE,1.1 public_it.php3,NONE,1.1 spip_ca.php3,NONE,1.1 public_fa.php3,NONE,1.1 public_eo.php3,NONE,1.1 public_cpf.php3,NONE,1.1 spip_pt.php3,NONE,1.1 spip_nl.php3,NONE,1.1 spip_zh.php3,NONE,1.1 public_oc_auv.php3,NONE,1.1 public_oc_prv.php3,NONE,1.1 spip_en.php3,NONE,1.1 public_lb.php3,NONE,1.1 spip_it.php3,NONE,1.1 spip_fa.php3,NONE,1.1 spip_oc_lms.php3,NONE,1.1 public_hu.php3,NONE,1.1 spip_pl.php3,NONE,1.1 spip_bg.php3,NONE,1.1 spip_fon.php3,NONE,1.1 public_pl.php3,NONE,1.1 public_ar.php3,NONE,1.1 public_oc_ni.php3,NONE,1.1 public_fon.php3,NONE,1.1 spip_da.php3,NONE,1.1 spip_oc_prv.php3,NONE,1.1 public_fr.php3,NONE,1.1 public_en.php3,NONE,1.1 spip_oc_va.php3,NONE,1.1 public_zh.php3,NONE,1.1 spip_es.php3,NONE,1.1 public_nl.php3,NONE,1.1 spip_ar.php3,NONE,1.1 spip_gl.php3,NONE,1.1 public_gl.php3,NONE,1.1 spip_fr.php3,NONE,1.1 spip_hu.php3,NONE,1.1 spip_oc_!
 auv.php3,NONE,1.1 spip_cpf.php3,NONE,1.1 public_bg.php3,NONE,1.1 spip_eo.php3,NONE,1.1 spip_lb.php3,NONE,1.1 public_ca.php3,NONE,1.1 public_es.php3,NONE,1.1 public_vi.php3,NONE,1.1 public_da.php3,NONE,1.1 spip_de.php3,NONE,1.1 public_de.php3,NONE,1.1 public_oc_lnc.php3,NONE,1.1 spip_oc_ni.php3,NONE,1.1
Message-ID: <200501201015.j0KAFrOp025840@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/lang
In directory sheep:/tmp/cvs-serv25615/ecrire/lang

Added Files:
	public_pt.php3 spip_oc_gsc.php3 spip_oc_lnc.php3 spip_vi.php3 
	public_it.php3 spip_ca.php3 public_fa.php3 public_eo.php3 
	public_cpf.php3 spip_pt.php3 spip_nl.php3 spip_zh.php3 
	public_oc_auv.php3 public_oc_prv.php3 spip_en.php3 
	public_lb.php3 spip_it.php3 spip_fa.php3 spip_oc_lms.php3 
	public_hu.php3 spip_pl.php3 spip_bg.php3 spip_fon.php3 
	public_pl.php3 public_ar.php3 public_oc_ni.php3 
	public_fon.php3 spip_da.php3 spip_oc_prv.php3 public_fr.php3 
	public_en.php3 spip_oc_va.php3 public_zh.php3 spip_es.php3 
	public_nl.php3 spip_ar.php3 spip_gl.php3 public_gl.php3 
	spip_fr.php3 spip_hu.php3 spip_oc_auv.php3 spip_cpf.php3 
	public_bg.php3 spip_eo.php3 spip_lb.php3 public_ca.php3 
	public_es.php3 public_vi.php3 public_da.php3 spip_de.php3 
	public_de.php3 public_oc_lnc.php3 spip_oc_ni.php3 
Log Message:
proto1.1

--- NEW FILE: public_pt.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'P&aacute;gina de abertura do s&iacute;tio',
'articles' => 'Artigos',
'articles_auteur' => 'Artigos deste autor',
'articles_populaires' => 'Artigos mais populares',
'articles_recents' => 'Artigos mais recentes',
'articles_rubrique' => 'Artigos desta rubrica',
'aucun_article' => 'N&atilde;o h&aacute; artigo neste endere&ccedil;o',
'aucun_auteur' => 'N&atilde;o h&aacute; autor neste endere&ccedil;o',
'aucun_site' => 'N&atilde;o h&aacute; s&iacute;tio neste endere&ccedil;o',
'aucune_breve' => 'N&atilde;o h&aacute; not&iacute;cia neste endere&ccedil;o',
'aucune_rubrique' => 'N&atilde;o h&aacute; rubrica neste endere&ccedil;o',
'autres_breves' => 'Outras not&iacute;cias',
'autres_groupes_mots_clefs' => 'Outros grupos de palavras-chave',
'autres_sites' => 'Outros s&iacute;tios',


// B
'bonjour' => 'Bom dia',
'breves' => 'Not1icias',


// C
'commenter_site' => 'Comentar este s&iacute;tio',


// D
'date' => 'Data',
'dernier_ajout' => '&Uacute;ltimo acr&eacute;scimo',
'dernieres_breves' => '&Uacute;ltimas not&iacute;cias',
'derniers_articles' => '&Uacute;ltimos artigos',
'derniers_commentaires' => '&Uacute;ltimos coment&aacute;rios',
'derniers_messages_forum' => '&Uacute;ltimas mensagens publicadas nos f&oacute;runs',


// E
'edition_mode_texte' => 'Edi&ccedil;&atilde;o em modo texto de',
'en_reponse' => 'Em resposta a&nbsp;:',
'en_resume' => 'Em resumo',
'envoyer_message' => 'Enviar uma mensagem',
'espace_prive' => 'Espa&ccedil;o privado',


// F
'forum' => 'F&oacute;rum',


// H
'hierarchie_site' => 'Hierarquia do s&iacute;tio',


// J
'jours' => 'dias',


// M
'meme_auteur' => 'Do mesmo autor',
'meme_rubrique' => 'Na mesma rubrica',
'memes_auteurs' => 'Dos mesmos autores',
'message' => 'Mensagem',
'messages_forum' => 'Mensagens de f&oacute;rum',
'messages_recents' => 'Mensagens de f&oacute;runs mais recentes',
'mots_clefs' => 'Palavras-chave',
'mots_clefs_meme_groupe' => 'Palavras-chave no mesmo grupo',


// N
'navigation' => 'Navega&ccedil;&atilde;o',
'nom' => 'Nome',
'nouveautes' => 'As novidades',
'nouveautes_web' => 'Novidades no Web',
'nouveaux_articles' => 'Novos artigos',
'nouvelles_breves' => 'Novas not&iacute;tcias',


// P
'page_precedente' => 'P&aacute;gina anterior',
'page_suivante' => 'p&aacute;gina seguinte',
'par_auteur' => 'por',
'participer_site' => 'Pode participar na vida deste s&iacute;tio e propor os seus pr&oacute;prios artigos, inscrevendo-se mais abaixo. Receber&aacute; imediatamente um email que indica os seus c&oacute;digos de acesso ao espa&ccedil;o privado do s&iacute;tio.',
'plan_site' => 'Planta do s&iacute;tio',
'popularite' => 'Popularidade',
'poster_message' => 'Enviar uma mensagem',
'proposer_site' => 'Voc&ecirc; pode prop&ocirc;r um sitio a adicionar a esta rubrica&nbsp;:',


// R
'repondre_article' => 'Responder a este artigo',
'repondre_breve' => 'Responder a esta not&iacute;cia',
'repondre_message' => 'Responder a esta mensagem',
'resultats_recherche' => 'Resultados da pesquisa',
'retour_debut_forums' => 'Regresso ao in&iacute;cio dos f&oacute;runs',
'rubrique' => 'Rubrica',
'rubriques' => 'Rubricas',


// S
'signatures_petition' => 'Assinaturas',
'site_realise_avec_spip' => 'S&iacute;tio realizado com SPIP',
'sites_web' => 'S&iacute;tios Web',
'sous_rubriques' => 'Sub-rubricas',
'suite' => 'continua&ccedil;&atilde;o',
'sur_web' => 'No Web',
'syndiquer_rubrique' => 'Vincular esta rubrica',
'syndiquer_site' => 'Vincular todo o s&iacute;tio',


// T
'texte_lettre_information' => 'Eis a carta de informa&ccedil;&atilde;o do s&iacute;tio',
'texte_lettre_information_2' => 'Esta carta recensea os artigos e as not&iacute;cias publicados desde',


// V
'ver_imprimer' => 'Vers&atilde;o para imprimir',
'voir_en_ligne' => 'Ver em linha'

);


?>

--- NEW FILE: spip_oc_gsc.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'occitan (gascon) [oc_gsc]',
'0_liste' => 'lenga.occitana at aprene.org',
'0_mainteneur' => 'Domergue:&nbsp;lenga.occitana at aprene.org ',


// A
'access_interface_graphique' => 'Tornar a l\'interf&agrave;cia grafica completa',
'access_mode_texte' => 'Afichar l\'interf&agrave;cia textuau simplificada',
'admin_modifier_article' => 'Modificar aqueth article',
'admin_modifier_auteur' => 'Modificar aqueth autor',
[...1644 lines suppressed...]
'trad_new' => 'Escr&iacute;ver ua arrevirada nav&egrave;ra d\'aqueste article',
'trad_reference' => '(article de refer&eacute;ncia)',


// U
'upload_fichier_zip' => 'Fichi&egrave;r ZIP',
'upload_fichier_zip_texte' => 'Lo fichi&egrave;r que prepausatz d\'installar qu\'ei un fichi&egrave;r Zip.',
'upload_fichier_zip_texte2' => 'Aqueth fichi&egrave;r que p&ograve;t estar:',
'upload_limit' => 'Aqueth fichi&egrave;r qu\'ei tr&ograve;p gr&ograve;s peu servider; la talha maxima autorizada en <i>upload</i> qu\'ei de @max at .',
'upload_zip_decompacter' => 'descomprimit e cada element que contien installat suu sit. Alavetz los fichi&egrave;rs que ser&agrave;n installats suu sit que son:',
'upload_zip_telquel' => 'installat tau com ei, com archiu comprimit Zip;',


// V
'version_initiale' => 'Version iniciau'

);


?>

--- NEW FILE: spip_oc_lnc.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-oc',
'0_langue' => 'occitan (lengadocian) [oc_lnc]',
'0_liste' => 'escambis.pedagogics at aprene.org',
'0_mainteneur' => 'M&ograve;ni&nbsp;:&nbsp;escambis.pedagogics at aprene.org <br> Est&egrave;ve (Servici de l\'Emplec)&nbsp;:&nbsp;cros at emplec.net',


// A
'access_interface_graphique' => 'Tornar a l\'interf&agrave;cia grafica completa',
'access_mode_texte' => 'Afichar l\'interf&agrave;cia textuala simplificada',
'admin_modifier_article' => 'Modificar aquel article',
'admin_modifier_auteur' => 'Modificar aquel autor',
[...1648 lines suppressed...]
'trad_new' => 'Escriure una revirada nov&egrave;la d\'aqueste article',
'trad_reference' => '(article de refer&eacute;ncia)',


// U
'upload_fichier_zip' => 'Fichi&egrave;r ZIP',
'upload_fichier_zip_texte' => 'Lo fichi&egrave;r que prepausatz d\'installar es un fichi&egrave;r Zip.',
'upload_fichier_zip_texte2' => 'Aquel fichi&egrave;r p&ograve;t &egrave;sser:',
'upload_limit' => 'Aquel fichi&egrave;r es tr&ograve;p gr&ograve;s pel servidor; la talha maxima autorizada en <i>upload</i> es de @max at .',
'upload_zip_decompacter' => 'descomprimit e cada element que conten installat sul sit. Alara los fichi&egrave;rs que ser&agrave;n installats sul sit son:',
'upload_zip_telquel' => 'installat tal coma es, coma archiu comprimit Zip;',


// V
'version_initiale' => 'Version iniciala'

);


?>

--- NEW FILE: spip_vi.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'Vi&#7879;t nam [vi]',
'0_liste' => 'spip-vi at rezo.net',
'0_mainteneur' => 'daoduyp at libertysurf.fr',


// A
'access_interface_graphique' => '<NEW>Retour &agrave; l\'interface graphique compl&egrave;te',
'access_mode_texte' => '<NEW>Afficher l\'interface textuelle simplifi&eacute;e',
'admin_modifier_article' => 'S&#7917;a &#273;&#7893;i b&agrave;i n&agrave;y',
'admin_modifier_auteur' => 'S&#7917;a &#273;&#7893;i t&aacute;c gi&#7843; n&agrave;y',
[...1505 lines suppressed...]
'trad_new' => 'D&#7883;ch b&agrave;i n&agrave;y',
'trad_reference' => '(b&agrave;i n&#7889;i k&#7871;t)',


// U
'upload_fichier_zip' => '<NEW>Fichier ZIP',
'upload_fichier_zip_texte' => '<NEW>Le fichier que vous proposez d\'installer est un fichier Zip.',
'upload_fichier_zip_texte2' => '<NEW>Ce fichier peut &ecirc;tre&nbsp;:',
'upload_limit' => '<NEW>Ce fichier est trop gros pour le serveur&nbsp;; la taille maximum autoris&eacute;e en <i>upload</i> est de @max at .',
'upload_zip_decompacter' => '<NEW>d&eacute;compress&eacute; et chaque &eacute;l&eacute;ment qu\'il contient install&eacute; sur le site. Les fichiers qui seront alors install&eacute;s sur le site sont&nbsp;:',
'upload_zip_telquel' => '<NEW>install&eacute; tel quel, en tant qu\'archive compress&eacute;e Zip&nbsp;;',


// V
'version_initiale' => '<NEW>Version initiale'

);


?>

--- NEW FILE: public_it.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Home page',
'articles' => 'Articoli',
'articles_auteur' => 'Articoli di questo autore',
'articles_populaires' => 'Articoli pi&ugrave; letti',
'articles_recents' => 'Articoli pi&ugrave; recenti',
'articles_rubrique' => 'Articoli di questa rubrica',
'aucun_article' => 'Non ci sono articoli a questo indirizzo',
'aucun_auteur' => 'Non ci sono autori a questo indirizzo',
'aucun_site' => 'Non ci sono siti a questo indirizzo',
'aucune_breve' => 'Non ci sono brevi a questo indirizzo',
'aucune_rubrique' => 'Non ci sono rubriche a questo indirizzo',
'autres_breves' => 'Altre brevi',
'autres_groupes_mots_clefs' => 'Altri gruppi di parole chiave',
'autres_sites' => 'Altri siti',


// B
'bonjour' => 'Salve',
'breves' => 'Brevi',


// C
'commenter_site' => 'Commenta questo sito',


// D
'date' => 'Data',
'dernier_ajout' => 'Ultimo aggiornamento',
'dernieres_breves' => 'Ultime brevi',
'derniers_articles' => 'Ultimi articoli',
'derniers_commentaires' => 'Ultimi commenti',
'derniers_messages_forum' => 'Ultimi messaggi pubblicati nei forum',


// E
'edition_mode_texte' => 'Versione solo testo di',
'en_reponse' => 'In risposta a:',
'en_resume' => 'Riassunto',
'envoyer_message' => 'Invia un messaggio',
'espace_prive' => 'Area riservata',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Mappa del sito',


// J
'jours' => 'giorni',


// M
'meme_auteur' => 'Dello stesso autore',
'meme_rubrique' => 'Nella stessa rubrica',
'memes_auteurs' => 'Degli stessi autori',
'message' => 'Messaggio',
'messages_forum' => 'Messaggi del forum',
'messages_recents' => 'Messaggi pi&ugrave; recenti del forum',
'mots_clefs' => 'Parole chiave',
'mots_clefs_meme_groupe' => 'Parole chiave nello stesso gruppo',


// N
'navigation' => 'Navigazione',
'nom' => 'Cognome',
'nouveautes' => 'Le novit&agrave;',
'nouveautes_web' => 'Novit&agrave; sul Web',
'nouveaux_articles' => 'Nuovi articoli',
'nouvelles_breves' => 'Nuove brevi',


// P
'page_precedente' => 'pagina precedente',
'page_suivante' => 'pagina successiva',
'par_auteur' => 'di ',
'participer_site' => '&Egrave; possibile partecipare alla vita di questo sito e proporre degli articoli iscrivendosi qui sotto. Verr&agrave; spedito immediatamente un email con il codice di accesso all\'area riservata del sito.',
'plan_site' => 'Mappa del sito',
'popularite' => 'Popolarit&agrave;',
'poster_message' => 'Inviare un messaggio',
'proposer_site' => '&Egrave; possibile proporre un sito da aggiungere a questa rubrica:',


// R
'repondre_article' => 'Rispondere all\'articolo',
'repondre_breve' => 'Rispondere a questa breve',
'repondre_message' => 'Rispondere al messaggio',
'resultats_recherche' => 'Risultati della ricerca',
'retour_debut_forums' => 'Tornare all\'inizio dei forum',
'rubrique' => 'Rubrica',
'rubriques' => 'Rubriche',


// S
'signatures_petition' => 'Firme',
'site_realise_avec_spip' => 'Sito realizzato con SPIP',
'sites_web' => 'Siti Web',
'sous_rubriques' => 'Sottorubriche',
'suite' => 'segue',
'sur_web' => 'Sul Web',
'syndiquer_rubrique' => 'Mettere in syndication questa rubrica',
'syndiquer_site' => 'Mettere in syndication tutto il sito',


// T
'texte_lettre_information' => 'Newsletter del sito',
'texte_lettre_information_2' => 'Questa lettera recensisce gli articoli e le brevi pubblicati a partire dal',


// V
'ver_imprimer' => 'Versione per la stampa',
'voir_en_ligne' => 'Vedi on line'

);


?>

--- NEW FILE: spip_ca.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'Catal&agrave; [ca]',
'0_liste' => ' spip-dev at rezo.net',
'0_mainteneur' => ' spip-dev at rezo.net',


// A
'access_interface_graphique' => 'Retorn a la interf&iacute;cie gr&agrave;fica completa',
'access_mode_texte' => 'Mostrar la interf&iacute;cie en mode text simplificada',
'admin_modifier_article' => 'Modificar aquest article',
'admin_modifier_auteur' => 'Modificar aquest autor',
[...1577 lines suppressed...]
'trad_new' => 'Escriure una nova traducci&oacute; d\'aquest article',
'trad_reference' => '(article de refer&egrave;ncia)',


// U
'upload_fichier_zip' => 'Fitxer ZIP',
'upload_fichier_zip_texte' => 'El fitxer que voleu instal&middot;lar &eacute;s un fitxer Zip.',
'upload_fichier_zip_texte2' => 'El fitxer pot ser:',
'upload_limit' => 'El fitxer &eacute;s massa gran pel servidor; la   mida m&agrave;xima autoritzada en <i>upload</i> &eacute;s de @max at .',
'upload_zip_decompacter' => 'descomprimit i cada element que cont&eacute; instal&middot;lat en el lloc Web. Els fitxers que llavors seran instal&middot;lat en el lloc Web s&oacute;n:',
'upload_zip_telquel' => 'instal&middot;lat tal qual, com a arxiu comprimit Zip;',


// V
'version_initiale' => 'Versi&oacute; inicial'

);


?>

--- NEW FILE: public_fa.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => '<NEW> Accueil du site',
'articles' => '<NEW> Articles',
'articles_auteur' => '<NEW> Articles de cet auteur',
'articles_populaires' => '<NEW> Articles les plus populaires',
'articles_recents' => '<NEW> Articles les plus r&eacute;cents',
'articles_rubrique' => '<NEW> Articles de cette rubrique',
'aucun_article' => '<NEW> Il n\'y a pas d\'article &agrave; cette adresse',
'aucun_auteur' => '<NEW> Il n\'y a pas d\'auteur &agrave; cette adresse',
'aucun_site' => '<NEW> Il n\'y a pas de site &agrave; cette adresse',
'aucune_breve' => '<NEW> Il n\'y a pas de br&egrave;ve &agrave; cette adresse',
'aucune_rubrique' => '<NEW> Il n\'y a pas de rubrique &agrave; cette adresse',
'autres_breves' => '<NEW> Autres br&egrave;ves',
'autres_groupes_mots_clefs' => '<NEW> Autres groupes de mots-cl&eacute;s',
'autres_sites' => '<NEW> Autres sites',


// B
'bonjour' => '<NEW> Bonjour',
'breves' => '<NEW> Br&egrave;ves',


// C
'commenter_site' => '<NEW> Commenter ce site',


// D
'date' => '<NEW> Date',
'dernier_ajout' => '<NEW> Dernier ajout',
'dernieres_breves' => '<NEW> Derni&egrave;res br&egrave;ves',
'derniers_articles' => '<NEW> Derniers articles',
'derniers_commentaires' => '<NEW> Derniers commentaires',
'derniers_messages_forum' => '<NEW> Derniers messages publi&eacute;s dans les forums',


// E
'edition_mode_texte' => '<NEW> &Eacute;dition en mode texte de',
'en_reponse' => '<NEW> En r&eacute;ponse &agrave;&nbsp;:',
'en_resume' => '<NEW> En r&eacute;sum&eacute;',
'envoyer_message' => '<NEW> Envoyer un message',
'espace_prive' => '<NEW> Espace priv&eacute;',


// F
'forum' => '<NEW> Forum',


// H
'hierarchie_site' => '<NEW> Hi&eacute;rarchie du site',


// J
'jours' => '<NEW> jours',


// M
'meme_auteur' => '<NEW> Du m&ecirc;me auteur',
'meme_rubrique' => '<NEW> Dans la m&ecirc;me rubrique',
'memes_auteurs' => '<NEW> Des m&ecirc;mes auteurs',
'message' => '<NEW> Message',
'messages_forum' => '<NEW> Messages de forum',
'messages_recents' => '<NEW> Messages de forums les plus r&eacute;cents',
'mots_clefs' => '<NEW> Mots-cl&eacute;s',
'mots_clefs_meme_groupe' => '<NEW> Mots-cl&eacute;s dans le m&ecirc;me groupe',


// N
'navigation' => '<NEW> Navigation',
'nom' => '<NEW> Nom',
'nouveautes' => '<NEW> Les nouveaut&eacute;s',
'nouveautes_web' => '<NEW> Nouveaut&eacute;s sur le Web',
'nouveaux_articles' => '<NEW> Nouveaux articles',
'nouvelles_breves' => '<NEW> Nouvelles br&egrave;ves',


// P
'page_precedente' => '<NEW> page pr&eacute;c&eacute;dente',
'page_suivante' => '<NEW> page suivante',
'par_auteur' => '<NEW> par ',
'participer_site' => '<NEW> Vous pouvez participer &agrave; la vie de ce site et proposer vos propres articles en vous inscrivant ci-dessous. Vous recevrez imm&eacute;diatement un email vous indiquant vos codes d\'acc&egrave;s &agrave; l\'espace priv&eacute; du site.',
'plan_site' => '<NEW> Plan du site',
'popularite' => '<NEW> Popularit&eacute;',
'poster_message' => '<NEW> Poster un message',


// R
'repondre_article' => '<NEW> R&eacute;pondre &agrave; cet article',
'repondre_breve' => '<NEW> R&eacute;pondre &agrave; cette br&egrave;ve',
'repondre_message' => '<NEW> R&eacute;pondre &agrave; ce message',
'resultats_recherche' => '<NEW> R&eacute;sultats de la recherche',
'retour_debut_forums' => '<NEW> Retour au d&eacute;but des forums',
'rubrique' => '<NEW> Rubrique',
'rubriques' => '<NEW> Rubriques',


// S
'signatures_petition' => '<NEW> Signatures',
'site_realise_avec_spip' => '<NEW> Site r&eacute;alis&eacute; avec SPIP',
'sites_web' => '<NEW> Sites Web',
'sous_rubriques' => '<NEW> Sous-rubriques',
'suite' => '<NEW> suite',
'sur_web' => '<NEW> Sur le Web',
'syndiquer_rubrique' => '<NEW> Syndiquer cette rubrique',
'syndiquer_site' => '<NEW> Syndiquer tout le site',


// T
'texte_lettre_information' => '<NEW> Voici la lettre d\'information du site',
'texte_lettre_information_2' => '<NEW> Cette lettre recense les articles et les br&egrave;ves publi&eacute;s depuis',


// V
'ver_imprimer' => '<NEW> Version &agrave; imprimer',
'voir_en_ligne' => '<NEW> Voir en ligne'

);


?>

--- NEW FILE: public_eo.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Akceptejo de la teksejo',
'articles' => 'Artikoloj',
'articles_auteur' => 'Artikoloj de tiu a&#365;toro',
'articles_populaires' => 'La plej popularaj artikoloj',
'articles_recents' => 'La plej fre&#349;aj artikoloj',
'articles_rubrique' => 'Artikoloj de tiu rubriko',
'aucun_article' => 'Nenia artikolo en tiu adreso',
'aucun_auteur' => 'Nenia a&#365;toro en tiu adreso',
'aucun_site' => 'Nenia teksejo en tiu adreso',
'aucune_breve' => 'Nenia informeto en tiu adreso',
'aucune_rubrique' => 'Nenia rubriko en tiu adreso',
'autres_breves' => 'Neniaj informetoj',
'autres_groupes_mots_clefs' => 'Aliaj grupoj de &#349;losilvortoj',
'autres_sites' => 'Aliaj teksejoj',


// B
'bonjour' => 'Bonan tagon',
'breves' => 'Informetoj',


// C
'commenter_site' => 'Komenti tiun teksejon',


// D
'date' => 'Dato',
'dernier_ajout' => 'Lasta aldono',
'dernieres_breves' => 'Lastaj informetoj',
'derniers_articles' => 'Lastaj artikoloj',
'derniers_commentaires' => 'Lastaj komentoj',
'derniers_messages_forum' => 'Lastaj mesa&#285;oj publikitaj en la forumoj',


// E
'edition_mode_texte' => 'Teksta eldono de',
'en_reponse' => 'Respondo al&nbsp;:',
'en_resume' => 'Resume',
'envoyer_message' => 'Sendi mesa&#285;on',
'espace_prive' => 'Privata spaco',


// F
'forum' => 'Forumo',


// H
'hierarchie_site' => 'Hierarkio de la teksejo',


// J
'jours' => 'tagoj',


// M
'meme_auteur' => 'De tiu &#265;i a&#365;toro',
'meme_rubrique' => 'En la sama rubriko',
'memes_auteurs' => 'De tiuj &#265;i a&#365;toroj',
'message' => 'Mesa&#285;o',
'messages_forum' => 'Forum-mesa&#285;oj',
'messages_recents' => 'La plej fre&#349;aj forum-mesa&#285;oj',
'mots_clefs' => '&#348;losilvortoj',
'mots_clefs_meme_groupe' => '&#348;losilvortoj en la sama grupo',


// N
'navigation' => 'Navigado',
'nom' => 'Nomo',
'nouveautes' => 'La nova&#309;oj',
'nouveautes_web' => 'Nova&#309;oj en la reto',
'nouveaux_articles' => 'Novaj artikoloj',
'nouvelles_breves' => 'Novaj informetoj',


// P
'page_precedente' => 'anta&#365;a pa&#285;o',
'page_suivante' => 'sekvanta pa&#285;o',
'par_auteur' => 'de ',
'participer_site' => 'Por partopreni la vivon de tiu teksejo kaj proponi viajn propajn artikolojn, registri&#285;u &#265;i sube. Vi tuje ricevos retpo&#349;tmesa&#285;on indikante vian kodon por aliri en la privata spaco.',
'plan_site' => 'Plano de la teksejo',
'popularite' => 'Populareco',
'poster_message' => 'Sendi mesa&#285;on',
'proposer_site' => 'Vi povas proponi teksejon aldonota al tiu rubriko:',


// R
'repondre_article' => 'Respondi al tiu artikolo',
'repondre_breve' => 'Respondi al tiu informeto',
'repondre_message' => 'Respondi al tiu mesa&#285;o',
'resultats_recherche' => 'Rezultoj de la ser&#265;o',
'retour_debut_forums' => 'Reiro al la komenco de forumoj',
'rubrique' => 'Rubriko',
'rubriques' => 'Rubrikoj',


// S
'signatures_petition' => 'Subskriboj',
'site_realise_avec_spip' => 'Teksejo realigita kun SPIP',
'sites_web' => 'Retaj teksejoj',
'sous_rubriques' => 'Sub-rubrikoj',
'suite' => 'jeno',
'sur_web' => 'En reto',
'syndiquer_rubrique' => 'Kunligigi tiun rubrikon',
'syndiquer_site' => 'Kunligigi &#265;iu la teksejo',


// T
'texte_lettre_information' => '&#264;i-tie estas la inform-letero de teksejo',
'texte_lettre_information_2' => 'Tiu letero nombrigas artikolojn kaj informetojn publikigitaj de',


// V
'ver_imprimer' => 'Printigota versio',
'voir_en_ligne' => 'Vidi konektite'

);


?>

--- NEW FILE: public_cpf.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Lakey lo sit',
'articles' => 'Bann zartik',
'articles_auteur' => 'Bann zartik lot&egrave;r-la',
'articles_populaires' => 'Bann zartik sak l&eacute; pli popil&egrave;r',
'articles_recents' => 'Bann zartik li l&eacute; nouvo',
'articles_rubrique' => 'Bann zartik andann ribrik-la',
'aucun_article' => 'N&eacute;na pa okinn lartik si ladr&egrave;s-la',
'aucun_auteur' => 'N&eacute;na pa okinn lot&egrave;r si ladr&egrave;s-la',
'aucun_site' => 'N&eacute;na pa okin sitw&egrave;b si ladr&egrave;s-la',
'aucune_breve' => 'N&eacute;na pa okin titnouv&egrave;l si ladr&egrave;s-la',
'aucune_rubrique' => 'N&eacute;na pa okinn ribrik si ladr&egrave;s-la',
'autres_breves' => 'Bann zot tite-nouv&egrave;l',
'autres_groupes_mots_clefs' => 'Bann zot bann molakl&eacute;',
'autres_sites' => 'Bann zot sitw&egrave;b',


// B
'bonjour' => 'Ot&eacute;',
'breves' => 'Bann tite-nouv&egrave;l',


// C
'commenter_site' => 'Donn out lavi si lo sit-la',


// D
'date' => 'Ladat',
'dernier_ajout' => 'Derny&eacute; piblikasyon',
'dernieres_breves' => 'Bann derniy&egrave;r tit-nouv&egrave;l',
'derniers_articles' => 'Bann d&egrave;rny&eacute; zartik',
'derniers_commentaires' => 'Bann d&egrave;rny&eacute; lavi',
'derniers_messages_forum' => 'Bann d&egrave;rny&eacute; mod&eacute;kri andann bann forom',


// E
'edition_mode_texte' => 'Po &eacute;dit&eacute; andann mod t&egrave;ks',
'en_reponse' => 'Po r&eacute;ponn a&nbsp;:',
'en_resume' => 'Po r&eacute;zim&eacute;',
'envoyer_message' => 'Po anvway&eacute; inn mod&eacute;kri',
'espace_prive' => 'L&eacute;spas priv&eacute;',


// F
'forum' => 'Forom kozman',


// H
'hierarchie_site' => 'Bardrin lo sitw&egrave;b',


// J
'jours' => 'bann zour',


// M
'meme_auteur' => 'Pa lot&egrave;r minm sa-minm',
'meme_rubrique' => 'Andan minm ribrik-la',
'memes_auteurs' => 'Po bann zot&egrave;r minm',
'message' => 'Mod&eacute;kri',
'messages_forum' => 'Bann mod&eacute;kri andann forom',
'messages_recents' => 'Bann mod&eacute;kri la finn m&egrave;t an derny&eacute; andan forom',
'mots_clefs' => 'Bann molakl&eacute;',
'mots_clefs_meme_groupe' => 'Bann molakl&eacute; andann lo minm bann sa-minm',


// N
'navigation' => 'Bat-kar&eacute; si lo sit',
'nom' => 'Non',
'nouveautes' => 'Bann nouv&egrave;lt&eacute;',
'nouveautes_web' => 'Bann nouv&egrave;lt&eacute; si lo sitw&egrave;b',
'nouveaux_articles' => 'Bann nouvo lartik',
'nouvelles_breves' => 'Bann nouv&egrave;l tite-nouv&egrave;l',


// P
'page_precedente' => 'lapaz dovan',
'page_suivante' => 'Lapaz d&eacute;y&egrave;r',
'par_auteur' => 'sanm',
'participer_site' => 'Ou p&eacute; m&egrave;t ansanm bann zot dalon po la vi lo sit-la, &egrave; propoz&eacute; out prop bann zartik, si ou l&eacute; inskri anba-la. Inskri aou : ou sar gayn inn lim&egrave;l i don aou out bann kodlaks&eacute; po l&eacute;spas priv&eacute; lo sit. ',
'plan_site' => 'Lakart lo sit',
'popularite' => 'Koman l&eacute; popil&egrave;r',
'poster_message' => 'Anvwa in mod&eacute;kri',
'proposer_site' => 'Ou p&eacute; propoz azout inn sit dann ribrik-la&nbsp;:',


// R
'repondre_article' => 'Po r&eacute;ponn si lartik-la',
'repondre_breve' => 'Po r&eacute;ponn la tite-nouv&egrave;l-la',
'repondre_message' => 'Po r&eacute;ponn mod&eacute;kri-la',
'resultats_recherche' => 'Kosa lo rod&egrave;r la finn trouv&eacute;',
'retour_debut_forums' => 'Artourn bann d&eacute;bi bann forom',
'rubrique' => 'Ribrik',
'rubriques' => 'Bann ribrik',


// S
'signatures_petition' => 'Bann sinyatir',
'site_realise_avec_spip' => 'Sit-la ni la f&eacute; &egrave;k SPIP',
'sites_web' => 'Bann sitw&egrave;b',
'sous_rubriques' => 'Bann souribrik',
'suite' => 'laswit',
'sur_web' => 'Si lo w&egrave;b',
'syndiquer_rubrique' => 'Po sindik&eacute; ribrik-la',
'syndiquer_site' => 'Po sindik&eacute; si lo sit',


// T
'texte_lettre_information' => 'Ala lal&egrave;t zinformasyon lo sit',
'texte_lettre_information_2' => 'L&egrave;t-la i ramas tout bann zartik &egrave;k bann tite-nouv&egrave;l dopwi',


// V
'ver_imprimer' => 'V&egrave;rsyon pou inprim&eacute;',
'voir_en_ligne' => 'Anon vwar an liyn'

);


?>

--- NEW FILE: spip_pt.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'portugu&ecirc;s [pt]',
'0_liste' => 'spip-dev at rezo.net',
'0_mainteneur' => 'spip-dev at rezo.net',


// A
'admin_modifier_article' => 'Modificar este artigo',
'admin_modifier_auteur' => 'Modificar este autor',
'admin_modifier_breve' => 'Modificar esta not&iacute;cia',
'admin_modifier_mot' => 'Modificar esta palavra-chave',
[...1721 lines suppressed...]
'trad_new' => 'Escrever uma nova tradu&ccedil;&atilde;o deste artigo',
'trad_reference' => '(artigo de refer&ecirc;ncia)',


// U
'upload_fichier_zip' => '<NEW>Fichier ZIP',
'upload_fichier_zip_texte' => '<NEW>Le fichier que vous proposez d\'installer est un fichier Zip.',
'upload_fichier_zip_texte2' => '<NEW>Ce fichier peut &ecirc;tre&nbsp;:',
'upload_limit' => '<NEW>Ce fichier est trop gros pour le serveur&nbsp;; la taille maximum autoris&eacute;e en <i>upload</i> est de @max at .',
'upload_zip_decompacter' => '<NEW>d&eacute;compress&eacute; et chaque &eacute;l&eacute;ment qu\'il contient install&eacute; sur le site. Les fichiers qui seront alors install&eacute;s sur le site sont&nbsp;:',
'upload_zip_telquel' => '<NEW>install&eacute; tel quel, en tant qu\'archive compress&eacute;e Zip&nbsp;;',


// V
'version_initiale' => '<NEW>Version initiale'

);


?>

--- NEW FILE: spip_nl.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://www.spip.net/nl_',
'0_langue' => 'Nederlands [nl]',
'0_liste' => 'spip-nl at rezo.net',
'0_mainteneur' => 'spip-nl at teomech.ugent.be',


// A
'access_interface_graphique' => '<NEW>Retour &agrave; l\'interface graphique compl&egrave;te',
'access_mode_texte' => '<NEW>Afficher l\'interface textuelle simplifi&eacute;e',
'admin_modifier_article' => 'Artikel wijzigen',
'admin_modifier_auteur' => 'Auteur wijzigen',
[...1668 lines suppressed...]
'trad_new' => 'Een nieuwe vertaling maken van dit artikel',
'trad_reference' => '(referentie-artikel)',


// U
'upload_fichier_zip' => 'ZIP bestand',
'upload_fichier_zip_texte' => 'Het bestand dat je wil installeren is een ZIP bestand.',
'upload_fichier_zip_texte2' => 'Dit bestand kan zijn&nbsp;:',
'upload_limit' => 'Dit bestand is te groot voor de server&nbsp;; de maximale bestandsgrootte voor <i>upload</i> is @max at .',
'upload_zip_decompacter' => 'uitgepakt en elk bestand ge&iuml;nstalleerd op de site. De bestanden die op de site komen, zijn&nbsp;:',
'upload_zip_telquel' => 'ge&iuml;nstalleerd als gezipt (gecomprimeerd) bestand&nbsp;;',


// V
'version_initiale' => 'Beginversie'

);


?>

--- NEW FILE: spip_zh.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-zh',
'0_langue' => '<MODIF>&#31616;&#20307;&#20013;&#25991; [zh]',
'0_liste' => 'spip-zh at rezo.net',
'0_mainteneur' => 'Lily Zou (lily.zou at terra.com.cn)
Zhen QIN (zhen_q at 21cn.com)',


// A
'access_interface_graphique' => '&#36820;&#22238;&#23436;&#25972;&#26174;&#31034;&#27169;&#24335;',
'access_mode_texte' => '&#26174;&#31034;&#31616;&#27905;&#26174;&#31034;&#27169;&#24335;',
'admin_modifier_article' => '&#20462;&#25913;&#25991;&#31456;',
[...1659 lines suppressed...]
'trad_new' => '&#20026;&#35813;&#31687;&#25991;&#31456;&#20889;&#19968;&#31687;&#26032;&#35793;&#25991;',
'trad_reference' => '(&#21442;&#32771;&#25991;&#31456;)',


// U
'upload_fichier_zip' => '&#21387;&#32553;&#25991;&#20214;ZIP',
'upload_fichier_zip_texte' => '&#24744;&#24314;&#35758;&#23433;&#35013;&#30340;&#25991;&#20214;&#26159;ZIP&#26684;&#24335;&#21387;&#32553;&#25991;&#20214;&#12290;',
'upload_fichier_zip_texte2' => '&#35813;&#25991;&#20214;&#21487;&#20197;&#34987;&#65306;',
'upload_limit' => '&#35813;&#25991;&#20214;&#30340;&#22823;&#23567;&#36229;&#36807;&#20102;&#26381;&#21153;&#22120;&#20801;&#35768;&#30340;&#33539;&#22260;&#65292;&#26381;&#21153;&#22120;&#20801;&#35768;<i>upload</i>&#30340;&#26368;&#22823;&#25991;&#20214;&#26159; @max at .',
'upload_zip_decompacter' => '&#24050;&#34987;&#35299;&#21387;&#65292;&#24182;&#19988;&#20854;&#20013;&#30340;&#25152;&#26377;&#25991;&#20214;&#22343;&#34987;&#23433;&#35013;&#21040;&#32593;&#31449;&#12290;&#23558;&#34987;&#23433;&#35013;&#21040;&#32593;&#31449;&#30340;&#25991;&#20214;&#22914;&#19979;&#65306;',
'upload_zip_telquel' => '&#29031;&#21407;&#26679;&#23433;&#35013;&#65292;&#20173;&#20197; Zip&#21387;&#32553;&#25991;&#26723;&#26684;&#24335;;',


// V
'version_initiale' => '&#21407;&#29256;&#26412;'

);


?>

--- NEW FILE: public_oc_auv.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Acu&egrave;lh dau sit',
'articles' => 'Articles',
'articles_auteur' => 'Articles d\'aquel autor',
'articles_populaires' => 'Los articles mai populars',
'articles_recents' => 'Los articles mai recents',
'articles_rubrique' => 'Articles d\'aquela rubrica',
'aucun_article' => 'I a ges d\'article a aquela adre&ccedil;a ',
'aucun_auteur' => 'I a ges d\'autor a aquela adre&ccedil;a ',
'aucun_site' => 'I a ges de sit a aquela adre&ccedil;a ',
'aucune_breve' => 'I a ges de br&egrave;va a aquela adre&ccedil;a ',
'aucune_rubrique' => 'I a ges de rubrica a aquela adre&ccedil;a ',
'autres_breves' => 'Autras br&egrave;vas',
'autres_groupes_mots_clefs' => 'Autres grops de mots claus',
'autres_sites' => 'Autres sits',


// B
'bonjour' => 'Bonjorn',
'breves' => 'Br&egrave;vas',


// C
'commenter_site' => 'Comentar aquel sit',


// D
'date' => 'Data',
'dernier_ajout' => 'Darr&egrave;ir apondon',
'dernieres_breves' => 'Darr&egrave;iras br&egrave;vas',
'derniers_articles' => 'Darr&egrave;irs articles',
'derniers_commentaires' => 'Darr&egrave;irs comentaris',
'derniers_messages_forum' => 'Darr&egrave;irs messatges publicats dins los forums',


// E
'edition_mode_texte' => 'Edicion en m&ograve;de t&egrave;xt de',
'en_reponse' => 'En responsa a:',
'en_resume' => 'En resumit',
'envoyer_message' => 'Mandar un messatge',
'espace_prive' => 'Espaci privat',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Ierarquia dau sit',


// J
'jours' => 'jorns',


// M
'meme_auteur' => 'Dau mesme autor',
'meme_rubrique' => 'Dins la mesma rubrica',
'memes_auteurs' => 'Daus mesmes autors',
'message' => 'Messatge',
'messages_forum' => 'Messatges de forum',
'messages_recents' => 'Los messatges de forums mai recents',
'mots_clefs' => 'Mots claus',
'mots_clefs_meme_groupe' => 'Mots claus dins lo mesme grop',


// N
'navigation' => 'Navigacion',
'nom' => 'Nom',
'nouveautes' => 'Las novetats',
'nouveautes_web' => 'Novetats sobre lo web',
'nouveaux_articles' => 'Articles nu&ograve;us',
'nouvelles_breves' => 'Br&egrave;vas nu&ograve;vas',


// P
'page_precedente' => 'pagina precedenta',
'page_suivante' => 'pagina seguenta',
'par_auteur' => 'per&nbsp;',
'participer_site' => 'Pod&egrave;tz participar a la vida d\'aquel sit e prepausar los articles v&ograve;stres en vos inscriure &ccedil;ai sos. Recebretz tot sit&ograve;st un e-mail que vos indicar&aacute; v&ograve;stres c&ograve;des per accedir a l\'espaci privat dau sit.',
'plan_site' => 'Plan dau sit',
'popularite' => 'Popularitat',
'poster_message' => 'Postar un messatge',


// R
'repondre_article' => 'Respondre a aquel article',
'repondre_breve' => 'Respondre a aquela br&egrave;va',
'repondre_message' => 'Respondre a aquel messatge',
'resultats_recherche' => 'Resultats de la rec&egrave;rcha',
'retour_debut_forums' => 'Retorn au comen&ccedil;ament daus forums',
'rubrique' => 'Rubrica',
'rubriques' => 'Rubricas',


// S
'signatures_petition' => 'Signaturas',
'site_realise_avec_spip' => 'Sit realizat amb SPIP',
'sites_web' => 'Sits web',
'sous_rubriques' => 'Sosrubricas',
'suite' => 'seguda',
'sur_web' => 'Sobre lo web',
'syndiquer_rubrique' => 'Sindicar aquela rubrica',
'syndiquer_site' => 'Sindicar tot lo sit',


// T
'texte_lettre_information' => 'Vaic&iacute; la letra d\'informacion dau sit',
'texte_lettre_information_2' => 'Aquela letra recensa los articles e br&egrave;vas publicats dempu&egrave;i',


// V
'ver_imprimer' => 'Version d\'estampar',
'voir_en_ligne' => 'Vejatz en linha'

);


?>

--- NEW FILE: public_oc_prv.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Acuelh dau sit',
'articles' => 'Articles',
'articles_auteur' => 'Articles d\'aquel autor',
'articles_populaires' => 'Leis articles mai populars',
'articles_recents' => 'Leis articles mai recents',
'articles_rubrique' => 'Articles d\'aquela rubrica',
'aucun_article' => 'I a ges d\'article a aquela adrei&ccedil;a ',
'aucun_auteur' => 'I a ges d\'autor a aquela adrei&ccedil;a ',
'aucun_site' => 'I a ges de sit a aquela adrei&ccedil;a ',
'aucune_breve' => 'I a ges de br&egrave;va a aquela adrei&ccedil;a ',
'aucune_rubrique' => 'I a ges de rubrica a aquela adrei&ccedil;a ',
'autres_breves' => 'Autrei br&egrave;vas',
'autres_groupes_mots_clefs' => 'Autrei grops de mots claus',
'autres_sites' => 'Autrei sits',


// B
'bonjour' => 'Bonjorn',
'breves' => 'Br&egrave;vas',


// C
'commenter_site' => 'Comentar aqueu sit',


// D
'date' => 'Data',
'dernier_ajout' => 'Darrier apondon',
'dernieres_breves' => 'Darrierei br&egrave;vas',
'derniers_articles' => 'Darriers articles',
'derniers_commentaires' => 'Darriers comentaris',
'derniers_messages_forum' => 'Darriers messatges publicats dins lei forums',


// E
'edition_mode_texte' => 'Edicion en m&ograve;de t&egrave;xt de',
'en_reponse' => 'En resp&ograve;nsa a:',
'en_resume' => 'En resumit',
'envoyer_message' => 'Mandar un messatge',
'espace_prive' => 'Espaci privat',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Ierarquia dau sit',


// J
'jours' => 'jorns',


// M
'meme_auteur' => 'Dau meteis autor',
'meme_rubrique' => 'Dins la meteissa rubrica',
'memes_auteurs' => 'Dei meteis autors',
'message' => 'Messatge',
'messages_forum' => 'Messatges de forum',
'messages_recents' => 'Lei messatges de forums mai recents',
'mots_clefs' => 'Mots claus',
'mots_clefs_meme_groupe' => 'Mots claus dins lo meteis grop',


// N
'navigation' => 'Navigacion',
'nom' => 'Nom',
'nouveautes' => 'Lei novetats',
'nouveautes_web' => 'Novetats subre lo web',
'nouveaux_articles' => 'Articles n&ograve;us',
'nouvelles_breves' => 'Br&egrave;vas n&ograve;vas',


// P
'page_precedente' => 'pagina precedenta',
'page_suivante' => 'pagina seguenta',
'par_auteur' => 'per&nbsp;',
'participer_site' => 'Pod&egrave;tz participar a la vida d\'aqueu sit e prepausar leis articles v&ograve;stres en vos inscrivent &ccedil;ai sota. Recebretz sus lo c&ograve;p un e-mail que vos indicar&agrave; v&ograve;strei c&ograve;des per accedir a l\'espaci privat dau sit.',
'plan_site' => 'Plan dau sit',
'popularite' => 'Popularitat',
'poster_message' => 'Postar un messatge',


// R
'repondre_article' => 'Resp&ograve;ndre a aquel article',
'repondre_breve' => 'Resp&ograve;ndre a aquela br&egrave;va',
'repondre_message' => 'Resp&ograve;ndre a aqueu messatge',
'resultats_recherche' => 'Resultats de la rec&egrave;rca',
'retour_debut_forums' => 'Retorn au comen&ccedil;ament dei forums',
'rubrique' => 'Rubrica',
'rubriques' => 'Rubricas',


// S
'signatures_petition' => 'Signaturas',
'site_realise_avec_spip' => 'Sit realizat amb SPIP',
'sites_web' => 'Sits web',
'sous_rubriques' => 'Sosrubricas',
'suite' => 'seguida',
'sur_web' => 'Subre lo web',
'syndiquer_rubrique' => 'Sindicar aquela rubrica',
'syndiquer_site' => 'Sindicar tot lo sit',


// T
'texte_lettre_information' => 'Vaic&iacute; la letra d\'informacion dau sit',
'texte_lettre_information_2' => 'Aquela letra recensa leis articles e br&egrave;vas publicats dempuei',


// V
'ver_imprimer' => 'Version d\'estampar',
'voir_en_ligne' => 'Vejatz en linha'

);


?>

--- NEW FILE: spip_en.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'English [en]',
'0_liste' => 'spip-en at rezo.net',
'0_mainteneur' => 'George Kandalaft (george at diwanalarab.com)',


// A
'access_interface_graphique' => 'Back to the complete graphical interface',
'access_mode_texte' => 'Show the simplified text interface',
'admin_modifier_article' => 'Modify this article',
'admin_modifier_auteur' => 'Modify this author',
[...1675 lines suppressed...]
'trad_new' => 'Write a new translation of this article',
'trad_reference' => '(reference article)',


// U
'upload_fichier_zip' => 'ZIP file',
'upload_fichier_zip_texte' => 'The file you are intending to install is a ZIP file.',
'upload_fichier_zip_texte2' => 'This file can be:',
'upload_limit' => 'This file is too big for the server; the maximum size allowed for <i>upload</i> is @max at .',
'upload_zip_decompacter' => 'decompressed and each file it contains will be installed on the site. The files which will be installed are:',
'upload_zip_telquel' => 'installed as is, as a ZIP file;',


// V
'version_initiale' => 'Initial version'

);


?>

--- NEW FILE: public_lb.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Homepage vum Site',
'articles' => 'Artikelen',
'articles_auteur' => 'Artikelen vun d&euml;sem Auteur',
'articles_populaires' => 'D&eacute;i bel&eacute;iwsten Artikelen',
'articles_recents' => 'D&eacute;i rezent Artikelen',
'articles_rubrique' => 'Artikelen aus d&euml;ser Rubrik',
'aucun_article' => 'Et g&euml;tt keen Artikel op d&euml;ser Adress',
'aucun_auteur' => 'Et g&euml;tt keen Auteur op d&euml;ser Adress',
'aucun_site' => 'Et g&euml;tt keen Site op d&euml;ser Adress',
'aucune_breve' => 'Et g&euml;tt keng Kuerzmeldung op d&euml;ser Adress',
'aucune_rubrique' => 'Et g&euml;tt keng Rubrik op d&euml;ser Adress',
'autres_breves' => 'Aner Kuerzmeldungen',
'autres_groupes_mots_clefs' => 'Aner Schl&euml;sselwieder-Gruppen',
'autres_sites' => 'Aner Siten',


// B
'bonjour' => 'Bonjour',
'breves' => 'Kuerzmeldungen',


// C
'commenter_site' => 'D&euml;sen Site komment&eacute;ieren',


// D
'date' => 'Datum',
'dernier_ajout' => 'L&auml;scht &Auml;nnerung',
'dernieres_breves' => 'L&auml;scht Kuerzmeldungen',
'derniers_articles' => 'L&auml;scht Artikelen',
'derniers_commentaires' => 'L&auml;scht Commentairen',
'derniers_messages_forum' => 'L&auml;scht Messagen aus de Forum\'en',


// E
'edition_mode_texte' => 'Editioun am Text-Modus vun',
'en_reponse' => 'Als &Auml;ntwert un:',
'en_resume' => 'Am R&eacute;sum&eacute;',
'envoyer_message' => 'E Message sch&eacute;cken',
'espace_prive' => 'Privaten Deel',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Struktur vum Site',


// J
'jours' => 'Deg',


// M
'meme_auteur' => 'Vum selwechten Auteur',
'meme_rubrique' => 'An der selwechter Rubrik',
'memes_auteurs' => 'Vun de selwechten Auteuren',
'message' => 'Message',
'messages_forum' => 'Messagen vum Forum',
'messages_recents' => 'L&auml;scht Messagen aus de Forum\'en',
'mots_clefs' => 'Schl&euml;sselwieder',
'mots_clefs_meme_groupe' => 'Schl&euml;sselwieder vum selwechten Grupp',


// N
'navigation' => 'Navigatioun',
'nom' => 'Numm',
'nouveautes' => 'Neiegkeeten',
'nouveautes_web' => 'Internet-Neiegkeeten',
'nouveaux_articles' => 'Nei Artikelen',
'nouvelles_breves' => 'Nei Kuerzmeldungen',


// P
'page_precedente' => 'l&auml;scht S&auml;it',
'page_suivante' => 'n&auml;chst S&auml;it',
'par_auteur' => 'vum',
'participer_site' => 'Dir k&euml;nnt un d&euml;sem Site matschaffen an &auml;r Artikelen propos&eacute;ieren andem der Iech hei aschreiwt. Dir kritt direkt en Email mat &auml;rem Login fir de privaten Deel vum Site.',
'plan_site' => 'Plang vum Site',
'popularite' => 'Popularit&eacute;it',
'poster_message' => 'E Message sch&eacute;cken',
'proposer_site' => 'Dir k&euml;nnt e Site fir d&euml;s Rubrik uginn:',


// R
'repondre_article' => 'Op d&euml;sen Artikel &auml;ntweren',
'repondre_breve' => 'Op d&euml;s Kuerzmeldung &auml;ntweren',
'repondre_message' => 'Op d&euml;sen Message &auml;ntweren',
'resultats_recherche' => 'Resultater vun der Sich',
'retour_debut_forums' => 'Zer&euml;ck op den Ufank vun de Forum\'en',
'rubrique' => 'Rubrik',
'rubriques' => 'Rubriken',


// S
'signatures_petition' => '&Euml;nnerschr&euml;ften',
'site_realise_avec_spip' => 'D&euml;se Site ass mat SPIP realis&eacute;iert',
'sites_web' => 'Internet-Siten',
'sous_rubriques' => '&Euml;nner-Rubriken',
'suite' => 'weider',
'sur_web' => 'Um Internet',
'syndiquer_rubrique' => 'D&euml;s Rubrik syndiqu&eacute;ieren',
'syndiquer_site' => 'De ganzen Site syndiqu&eacute;ieren',


// T
'texte_lettre_information' => 'Hei ass d\'Newsletter vum Site',
'texte_lettre_information_2' => 'D&euml;s Newsletter ass eng L&euml;scht vun den Artikelen a Kuerzmeldungen z&euml;nter',


// V
'ver_imprimer' => 'Drock-Versioun',
'voir_en_ligne' => 'Online gesinn'

);


?>

--- NEW FILE: spip_it.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-it',
'0_langue' => 'Italiano [it]',
'0_liste' => 'spip-it at rezo.net',
'0_mainteneur' => 'ebottaro at hce.it',


// A
'access_interface_graphique' => 'Ritorna all\'interfaccia grafica completa',
'access_mode_texte' => 'Visualizza l\'interfaccia testuale semplificata',
'admin_modifier_article' => 'Modifica l\'articolo',
'admin_modifier_auteur' => 'Modifica l\'autore',
[...1637 lines suppressed...]
'trad_new' => 'Scrivere una nuova traduzione dell\'articolo',
'trad_reference' => '(articolo di riferimento)',


// U
'upload_fichier_zip' => 'File ZIP',
'upload_fichier_zip_texte' => 'Il file proposto &egrave; un file ZIP.',
'upload_fichier_zip_texte2' => 'Questo file pu&ograve; essere:',
'upload_limit' => 'Questo file &egrave; troppo grande per il server; la dimensione massima consentita per gli <i>upload</i> &egrave; di @max at .',
'upload_zip_decompacter' => 'decompresso e ogni elemento installato nel sito. I file che saranno installati nel sito sono:',
'upload_zip_telquel' => 'installato cos&igrave; com\'&egrave; in quanto archivio compresso Zip;',


// V
'version_initiale' => 'Versione iniziale'

);


?>

--- NEW FILE: spip_fa.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://www.spip.net/fa',
'0_langue' => '[fa] &#1601;&#1575;&#1585;&#1587;&#1609;',
'0_liste' => 'spip-fa at rezo.net',
'0_mainteneur' => 'mani at rezo.net',


// A
'access_interface_graphique' => '&#1576;&#1575;&#1586;&#1711;&#1588;&#1578; &#1576;&#1607; &#1606;&#1605;&#1575;&#1609; &#1603;&#1575;&#1605;&#1604; &#1587;&#1575;&#1610;&#1578;',
'access_mode_texte' => '&#1606;&#1605;&#1575;&#1609; &#1587;&#1575;&#1583;&#1607; &#1587;&#1575;&#1610;&#1578; &#1585;&#1575; &#1606;&#1605;&#1575;&#1610;&#1588; &#1583;&#1607;&#1610;&#1583;',
'admin_modifier_article' => '&#1575;&#1610;&#1606; &#1605;&#1602;&#1575;&#1604;&#1607; &#1585;&#1575; &#1575;&#1589;&#1604;&#1575;&#1581; &#1603;&#1606;&#1610;&#1583;',
'admin_modifier_auteur' => '&#1575;&#1610;&#1606; &#1606;&#1608;&#1610;&#1587;&#1606;&#1583;&#1607; &#1585;&#1575; &#1575;&#1589;&#1604;&#1575;&#1581; &#1603;&#1606;&#1610;&#1583;',
[...1485 lines suppressed...]
'trad_new' => '&#1610;&#1603; &#1578;&#1585;&#1580;&#1605;&#1607; &#1580;&#1583;&#1610;&#1583; &#1575;&#1586; &#1575;&#1610;&#1606; &#1605;&#1602;&#1575;&#1604;&#1607; &#1576;&#1603;&#1606;&#1610;&#1583;',
'trad_reference' => '(&#1605;&#1602;&#1575;&#1604;&#1607; &#1605;&#1585;&#1580;&#1593;)',


// U
'upload_fichier_zip' => '&#1601;&#1575;&#1610;&#1604; &#1601;&#1588;&#1585;&#1583;&#1607; ZIP',
'upload_fichier_zip_texte' => '&#1601;&#1575;&#1610;&#1604;&#1609; &#1603;&#1607; &#1588;&#1605;&#1575; &#1662;&#1610;&#1588;&#1606;&#1607;&#1575;&#1583; &#1606;&#1589;&#1576; &#1570;&#1606;&#1585;&#1575; &#1605;&#1610;&#1603;&#1606;&#1610;&#1583; &#1610;&#1603; &#1601;&#1575;&#1610;&#1604;  ZIP &#1605;&#1610;&#1576;&#1575;&#1588;&#1583;.',
'upload_fichier_zip_texte2' => '&#1575;&#1610;&#1606; &#1601;&#1575;&#1610;&#1604; &#1605;&#1610;&#1578;&#1608;&#1575;&#1606;&#1583;',
'upload_limit' => '&#1575;&#1610;&#1606; &#1601;&#1575;&#1610;&#1604; &#1576;&#1585;&#1575;&#1609; &#1587;&#1585;&#1608;&#1585; &#1576;&#1587;&#1610;&#1575;&#1585; &#1576;&#1586;&#1585;&#1711; &#1575;&#1587;&#1578; &#1581;&#1583;&#1575;&#1603;&#1579;&#1585; &#1575;&#1606;&#1583;&#1575;&#1586;&#1607; &#1609; &#1605;&#1580;&#1575;&#1586; <i>upload</i> @max@ &#1605;&#1610;&#1576;&#1575;&#1588;&#1583;',
'upload_zip_decompacter' => '&#1576;&#1575;&#1586; &#1588;&#1608;&#1583; &#1608; &#1607;&#1585; &#1593;&#1606;&#1589;&#1585; &#1605;&#1581;&#1578;&#1608;&#1609; &#1570;&#1606; &#1605;&#1610;&#1578;&#1608;&#1575;&#1606;&#1583; &#1576;&#1585;&#1608;&#1609; &#1587;&#1575;&#1610;&#1578; &#1606;&#1589;&#1576; &#1588;&#1608;&#1583;. &#1601;&#1575;&#1610;&#1604;&#1607;&#1575;&#1610;&#1609; &#1603;&#1607; &#1576;&#1583;&#1610;&#1606; &#1589;&#1608;&#1585;&#1578; &#1606;&#1589;&#1576; &#1605;&#1610;&#1588;&#1608;&#1606;&#1583;',
'upload_zip_telquel' => '&#1576;&#1607;&#1605;&#1575;&#1606; &#1589;&#1608;&#1585;&#1578; &#1606;&#1589;&#1576; &#1588;&#1583;&#1607; &#1575;&#1606;&#1583; &#1576;&#1589;&#1608;&#1585;&#1578; &#1576;&#1575;&#1610;&#1711;&#1575;&#1606;&#1609; ZIP',


// V
'version_initiale' => '&#1606;&#1587;&#1582;&#1607; &#1609; &#1606;&#1582;&#1587;&#1578;'

);


?>

--- NEW FILE: spip_oc_lms.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://www.spip.net/oc',
'0_langue' => 'occitan (lemosin) [oc_lms]',
'0_liste' => 'spip-oc at rezo.net',
'0_mainteneur' => 'Domergue Sumien: lenga.occitana at aprene.org ',


// A
'access_interface_graphique' => 'Tornar a l\'interf&agrave;cia grafica completa',
'access_mode_texte' => 'Afichar l\'interf&agrave;cia textuala simplificada',
'admin_modifier_article' => 'Modificar quel article',
'admin_modifier_auteur' => 'Modificar quel autor',
[...1650 lines suppressed...]
'trad_new' => 'Escriure una revirada novela de queste article',
'trad_reference' => '(article de refer&eacute;ncia)',


// U
'upload_fichier_zip' => 'Fichier ZIP',
'upload_fichier_zip_texte' => 'Lo fichier que prepausatz d\'installar es un fichier Zip.',
'upload_fichier_zip_texte2' => 'Queu fichier p&ograve;t &egrave;sser:',
'upload_limit' => 'Queu fichier es tr&ograve;p gr&ograve;s per lo servidor; la talha maxima autorizada en <i>upload</i> es de @max at .',
'upload_zip_decompacter' => 'descomprimit e chasque element que conten installat sus lo sit. Laidonc los fichiers que ser&aacute;n installats sus lo sit son:',
'upload_zip_telquel' => 'installat tau coma es, coma archiu comprimit Zip;',


// V
'version_initiale' => 'Version iniciala'

);


?>

--- NEW FILE: public_hu.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'F&#337;oldal',
'articles' => 'Cikkek',
'articles_auteur' => 'E szerz&#337; cikkei',
'articles_populaires' => 'Legn&eacute;pszer&#369;bb cikkek',
'articles_recents' => 'Leg&uacute;jabb cikkek',
'articles_rubrique' => 'A rovat cikkei',
'aucun_article' => '<NENincs cikke ezen a c&iacute;men',
'aucun_auteur' => 'Nincs szerz&#337; ezen a c&iacute;men',
'aucun_site' => 'Nincs honlap ezen a c&iacute;men',
'aucune_breve' => 'Nincs h&iacute;r ezen a c&iacute;men',
'aucune_rubrique' => 'Nincs rovat ezen a c&iacute;men',
'autres_breves' => 'Egy&eacute;b h&iacute;rek',
'autres_groupes_mots_clefs' => 'Egy&eacute;b kulcssz&oacute; csoportok',
'autres_sites' => 'Egy&eacute;b honlapok',


// B
'bonjour' => 'J&oacute; napot',
'breves' => 'H&iacute;rek',


// C
'commenter_site' => 'Hozz&aacute;sz&oacute;l&aacute;s a honlapr&oacute;l',


// D
'date' => 'D&aacute;tum',
'dernier_ajout' => 'Utols&oacute; besz&uacute;r&aacute;s',
'dernieres_breves' => 'Utols&oacute; h&iacute;rek',
'derniers_articles' => 'Utols&oacute; cikkek',
'derniers_commentaires' => 'Utols&oacute; hozz&aacute;sz&oacute;l&aacute;sok',
'derniers_messages_forum' => 'A f&oacute;rumokba k&uuml;ld&ouml;tt legutols&oacute; &uuml;zenetek',


// E
'edition_mode_texte' => 'Sz&ouml;veges m&oacute;dban szerkeszt&eacute;s',
'en_reponse' => 'Erre v&aacute;laszolva&nbsp;:',
'en_resume' => '&Ouml;sszefoglalva',
'envoyer_message' => '&Uuml;zenet k&uuml;ld&eacute;s',
'espace_prive' => 'Priv&aacute;t r&eacute;sz',


// F
'forum' => 'F&oacute;rum',


// H
'hierarchie_site' => 'A honlap fel&eacute;p&iacute;t&eacute;se',


// J
'jours' => 'napok',


// M
'meme_auteur' => 'Ugyanett&#337;l a szerz&#337;t&#337;l',
'meme_rubrique' => 'Ugyanabban a rovatban',
'memes_auteurs' => 'Ugyanett&#337;l a szerz&#337;kt&#337;l',
'message' => '&Uuml;zenet',
'messages_forum' => 'F&oacute;rum &uuml;zenetei',
'messages_recents' => 'A f&oacute;rumok legfr&iacute;ssebb &uuml;zenetei',
'mots_clefs' => 'Kulcsszavak',
'mots_clefs_meme_groupe' => 'Kulcsszavak ugyanabban a csoportban',


// N
'navigation' => 'B&ouml;ng&eacute;sz&eacute;s',
'nom' => 'N&eacute;v',
'nouveautes' => '&Uacute;jdons&aacute;gok',
'nouveautes_web' => '&Uacute;jdons&aacute;gok a Weben',
'nouveaux_articles' => '&Uacute;j cikkek',
'nouvelles_breves' => '&Uacute;j h&iacute;rek',


// P
'page_precedente' => 'El&ouml;z&#337; oldal',
'page_suivante' => 'k&ouml;vetkez&#337; oldal',
'par_auteur' => '&iacute;rta',
'participer_site' => 'R&eacute;szt vehet a honlap &eacute;let&eacute;ben, &eacute;s saj&aacute;t cikkeket k&uuml;ldhet. Az&eacute;rt egy beiratkoz&aacute;s sz&uuml;ks&eacute;ges (l&aacute;sd lejjebb). Azonnal fog kapni egy emailt, melyben szerepelnek a hozz&aacute;f&eacute;r&eacute;si param&eacute;terek a honlap priv&aacute;t r&eacute;sz&eacute;re.',
'plan_site' => 'Honlap t&eacute;rk&eacute;pe',
'popularite' => 'N&eacute;pszer&#369;s&eacute;g',
'poster_message' => '&Uuml;zenet k&uuml;ld&eacute;s',
'proposer_site' => 'Honlapot aj&aacute;nlhat abban a rovatban&nbsp;:',


// R
'repondre_article' => 'Hozz&aacute;sz&oacute;l&aacute;s a cikkhez',
'repondre_breve' => 'V&aacute;laszolni erre a h&iacute;rre',
'repondre_message' => 'V&aacute;laszolni erre az &uuml;zenetre',
'resultats_recherche' => 'Keres&eacute;s eredm&eacute;nyei',
'retour_debut_forums' => 'Vissza a f&oacute;rumok kezdet&eacute;re',
'rubrique' => 'Rovat',
'rubriques' => 'Rovatok',


// S
'signatures_petition' => 'Al&aacute;&iacute;r&aacute;sok',
'site_realise_avec_spip' => 'A honlap SPIP seg&iacute;ts&eacute;g&eacute;vel k&eacute;sz&uuml;lt',
'sites_web' => 'Honlapok',
'sous_rubriques' => 'Als&oacute;bb rovatok',
'suite' => 'folytat&aacute;s',
'sur_web' => 'Valahol a Weben',
'syndiquer_rubrique' => 'A rovat szindik&aacute;l&aacute;sa',
'syndiquer_site' => 'Az eg&eacute;sz honlap szindik&aacute;l&aacute;sa',


// T
'texte_lettre_information' => '&Iacute;me a honlap h&iacute;rlevele',
'texte_lettre_information_2' => 'Ez a h&iacute;rlev&eacute;l a cikkeket, ill. h&iacute;reket &ouml;sszefoglalja az&oacute;ta',


// V
'ver_imprimer' => 'Nyomtathat&oacute; v&aacute;ltozat',
'voir_en_ligne' => 'L&aacute;tni &eacute;l&#337;ben'

);


?>

--- NEW FILE: spip_pl.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'Polski [pl]',
'0_liste' => 'spip-dev at rezo.net',
'0_mainteneur' => 'd.paszkiewicz at ekstenso.com',


// A
'access_interface_graphique' => 'Powr&oacute;t do pe&#322;nego interfejsu graficznego',
'access_mode_texte' => 'Uproszczony interfejs - tryb tekstowy',
'admin_modifier_article' => 'Modyfikuj artyku&#322;',
'admin_modifier_auteur' => 'Modyfikuj autora',
[...1655 lines suppressed...]
'trad_new' => 'Napisz nowe t&#322;umaczenie artyku&#322;u',
'trad_reference' => '(artyku&#322; wzorcowy)',


// U
'upload_fichier_zip' => 'Plik ZIP',
'upload_fichier_zip_texte' => 'Plik, kt&oacute;ry chcesz zainstalowa&#263; jest plikiem ZIP.',
'upload_fichier_zip_texte2' => 'Ten plik mo&#380;e by&#263;&nbsp;:',
'upload_limit' => 'Ten plik jest zbyt du&#380;y dla serwera&nbsp;;maksymalny rozmiar pliku zapisywanego na serwerze to @max at .',
'upload_zip_decompacter' => 'zdekompresowany i ka&#380;dy jego element zostanie zainstalowany w serwisie. Pliki, kt&oacute;re zostan&#261; zainstalowane w serwisie to:',
'upload_zip_telquel' => 'zostan&#261; zainstalowane jako archiwum Zip;',


// V
'version_initiale' => 'Wersja pocz&#261;tkowa'

);


?>

--- NEW FILE: spip_bg.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-bg',
'0_langue' => '&#1073;&#1098;&#1083;&#1075;&#1072;&#1088;&#1089;&#1082;&#1080; [bg]',
'0_liste' => 'spip-bg at rezo.net',
'0_mainteneur' => 'Christina Haralanova, chris at fsa-bg.org',


// A
'access_interface_graphique' => '&#1054;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086; &#1082;&#1098;&#1084; &#1087;&#1098;&#1083;&#1085;&#1080;&#1103; &#1075;&#1088;&#1072;&#1092;&#1080;&#1095;&#1077;&#1085; &#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;',
'access_mode_texte' => '&#1055;&#1086;&#1082;&#1072;&#1079;&#1074;&#1072;&#1085;&#1077; &#1085;&#1072; &#1086;&#1087;&#1088;&#1086;&#1089;&#1090;&#1077;&#1085;&#1080;&#1103; &#1090;&#1077;&#1082;&#1089;&#1090;&#1086;&#1074; &#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;',
'admin_modifier_article' => '&#1055;&#1088;&#1086;&#1084;&#1103;&#1085;&#1072; &#1085;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1103;&#1090;&#1072;',
'admin_modifier_auteur' => '&#1055;&#1088;&#1086;&#1084;&#1103;&#1085;&#1072; &#1085;&#1072; &#1072;&#1074;&#1090;&#1086;&#1088;&#1072;',
[...1725 lines suppressed...]
'trad_new' => '&#1055;&#1080;&#1089;&#1072;&#1085;&#1077; &#1085;&#1072; &#1085;&#1086;&#1074; &#1087;&#1088;&#1077;&#1074;&#1086;&#1076; &#1085;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1103;&#1090;&#1072;',
'trad_reference' => '(&#1089;&#1074;&#1098;&#1088;&#1079;&#1074;&#1072;&#1085;&#1077; &#1085;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1103;)',


// U
'upload_fichier_zip' => 'ZIP &#1092;&#1072;&#1081;&#1083;',
'upload_fichier_zip_texte' => '&#1060;&#1072;&#1081;&#1083;&#1098;&#1090;, &#1082;&#1086;&#1081;&#1090;&#1086; &#1078;&#1077;&#1083;&#1072;&#1077;&#1090;&#1077; &#1076;&#1072; &#1080;&#1085;&#1089;&#1090;&#1072;&#1083;&#1080;&#1088;&#1072;&#1090;&#1077; &#1077; &#1074; ZIP &#1092;&#1086;&#1088;&#1084;&#1072;&#1090;.',
'upload_fichier_zip_texte2' => '&#1060;&#1072;&#1081;&#1083;&#1098;&#1090; &#1084;&#1086;&#1078;&#1077; &#1076;&#1072; &#1073;&#1098;&#1076;&#1077;:',
'upload_limit' => '&#1060;&#1072;&#1081;&#1083;&#1098;&#1090; &#1077; &#1087;&#1088;&#1077;&#1082;&#1072;&#1083;&#1077;&#1085;&#1086; &#1075;&#1086;&#1083;&#1103;&#1084; &#1079;&#1072; &#1089;&#1098;&#1088;&#1074;&#1098;&#1088;&#1072;; &#1084;&#1072;&#1082;&#1089;&#1080;&#1084;&#1072;&#1083;&#1085;&#1072;&#1090;&#1072; &#1087;&#1086;&#1079;&#1074;&#1086;&#1083;&#1077;&#1085;&#1072; &#1075;&#1086;&#1083;&#1077;&#1084;&#1080;&#1085;&#1072; &#1079;&#1072;  <i>upload</i> &#1077; @max at .',
'upload_zip_decompacter' => '&#1076;&#1077;&#1082;&#1086;&#1084;&#1087;&#1088;&#1077;&#1089;&#1080;&#1088;&#1072;&#1085; &#1080; &#1074;&#1089;&#1077;&#1082;&#1080; &#1092;&#1072;&#1081;&#1083;, &#1082;&#1086;&#1081;&#1090;&#1086; &#1089;&#1077; &#1089;&#1098;&#1076;&#1098;&#1088;&#1078;&#1072; &#1074; &#1085;&#1077;&#1075;&#1086; &#1097;&#1077; &#1073;&#1098;&#1076;&#1077; &#1080;&#1085;&#1089;&#1090;&#1072;&#1083;&#1080;&#1088;&#1072;&#1085; &#1085;&#1072; &#1089;&#1072;&#1081;&#1090;&#1072;. &#1060;&#1072;&#1081;&#1083;&#1086;&#1074;&#1077;&#1090;&#1077;, &#1082;&#1086;&#1080;&#1090;&#1086; &#1097;&#1077; &#1073;&#1098;&#1076;&#1072;&#1090; &#1080;&#1085;&#1089;&#1090;&#1072;&#1083;&#1080;&#1088;&#1072;&#1085;&#1080; &#1089;&#1072;:',
'upload_zip_telquel' => '&#1080;&#1085;&#1089;&#1090;&#1072;&#1083;&#1080;&#1088;&#1072;&#1085; &#1082;&#1072;&#1082;&#1090;&#1086; &#1077;, &#1082;&#1072;&#1090;&#1086; ZIP &#1092;&#1072;&#1081;&#1083;;',


// V
'version_initiale' => '&#1055;&#1098;&#1088;&#1074;&#1086;&#1085;&#1072;&#1095;&#1072;&#1083;&#1085;&#1072; &#1074;&#1077;&#1088;&#1089;&#1080;&#1103;'

);


?>

--- NEW FILE: spip_fon.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'H&#596;ntogbo&#769;',
'0_langue' => 'Fongbe [fon]',
'0_liste' => 'spip-dev at rezo.net',
'0_mainteneur' => 'spip-dev at rezo.net',


// A
'access_interface_graphique' => 'L&#603;k&#596; yi&#768; at&#603; bi ji&#769;',
'access_mode_texte' => '&#598;&egrave; t&#603;m&#603; nu wiwlant&#596;n xl&#603;  do at&#603; &#596; ji ',
'admin_modifier_article' => 'H&#596;ntogbo&#769;',
'admin_modifier_auteur' => '&#598;i&#596; ny&#596;wlant&#596; &eacute; l&#596;',
[...1453 lines suppressed...]
'trad_new' => 'L&#603; wl&aacute;n t&igrave;nm&#603; w&eacute;kp&aacute; &#598;&eacute;v&oacute; t&#596;n',
'trad_reference' => '(w&eacute;kp&aacute; j&#596; w&eacute;kp&aacute;)',


// U
'upload_fichier_zip' => 'Fichier ZIP&ugrave;',
'upload_fichier_zip_texte' => 'x&oacute;t&aacute; mi j&oacute; n&aacute; z&eacute; x&oacute;t&aacute; zip&ugrave; w&#603;.',
'upload_fichier_zip_texte2' => 'x&oacute;t&aacute; &eacute; l&#596; s&iacute;w&uacute;&nbsp;:',
'upload_limit' => 'gb&egrave;t&aacute; &#596; kl&oacute; &#598;&iacute;n @max at .',
'upload_zip_decompacter' => 's&#596; &#598;&eacute;m&#603; &#598;e&#770; &#598;&eacute; gb&#596;n &#596; :',
'upload_zip_telquel' => 's&#596; &#598;&eacute;m&#603; &#598;e&#770; &#598;&eacute; gb&#596;n &#596;  Zip&nbsp;;',


// V
'version_initiale' => 'w&agrave;l&#596; b&igrave;b&#603; t&#596;n'

);


?>

--- NEW FILE: public_pl.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Strona g&#322;&oacute;wna',
'articles' => 'Artyku&#322;y',
'articles_auteur' => 'Artyku&#322;y napisane przez tego autora',
'articles_populaires' => 'Najbardziej popularne artyku&#322;y',
'articles_recents' => 'Najnowsze artyku&#322;y',
'articles_rubrique' => 'Artyku&#322;y w tym dziale',
'aucun_article' => 'Nie ma &#380;adnego artyku&#322;u pod tym adresem',
'aucun_auteur' => 'Nie ma &#380;adnego autora pod tym adresem',
'aucun_site' => 'Nie ma &#380;adnej strony pod tym adresem',
'aucune_breve' => 'Nie ma &#380;adnego newsa pod tym adresem ',
'aucune_rubrique' => 'Nie ma &#380;adnego dzia&#322;u pod tym adresem',
'autres_breves' => 'Reszta aktualno&#347;ci',
'autres_groupes_mots_clefs' => 'Inne grupy s&#322;&oacute;w kluczowych',
'autres_sites' => 'Inne strony',


// B
'bonjour' => 'Dzie&#324; dobry',
'breves' => 'Aktualno&#347;ci',


// C
'commenter_site' => 'Dodaj komentarz na temat strony',


// D
'date' => 'Data',
'dernier_ajout' => 'Dodane ostatnio',
'dernieres_breves' => 'Najnowsze aktualno&#347;ci',
'derniers_articles' => 'Najnowsze artyku&#322;y',
'derniers_commentaires' => 'Ostatnie komentarze',
'derniers_messages_forum' => 'Ostatnie wiadomo&#347;ci opublikowane w forum',


// E
'edition_mode_texte' => 'Edycja w trybie tekstowym',
'en_reponse' => 'W odpowiedzi na&nbsp;:',
'en_resume' => 'W skr&oacute;cie',
'envoyer_message' => 'Wy&#347;lij wiadomo&#347;&#263;',
'espace_prive' => 'Strefa prywatna',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Mapa strony',


// J
'jours' => 'dni',


// M
'meme_auteur' => 'Ten sam autor',
'meme_rubrique' => 'W tym samym dziale',
'memes_auteurs' => 'Tych samych autor&oacute;w',
'message' => 'Wiadomo&#347;&#263;',
'messages_forum' => 'Wiadomo&#347;ci na forum',
'messages_recents' => 'Najnowsze wiadomo&#347;ci na forum',
'mots_clefs' => 'S&#322;owa kluczowe',
'mots_clefs_meme_groupe' => 'S&#322;owa kluczowe z tej samej grupy',


// N
'navigation' => 'Nawigacja',
'nom' => 'Nazwisko',
'nouveautes' => 'Nowo&#347;ci',
'nouveautes_web' => 'Nowo&#347;ci w Internecie',
'nouveaux_articles' => 'NOwe artyku&#322;y',
'nouvelles_breves' => 'Najnowsze aktualno&#347;ci',


// P
'page_precedente' => 'poprzednia strona',
'page_suivante' => 'nast&#281;pna strona',
'par_auteur' => 'przez',
'participer_site' => 'Mo&#380;esz wzi&#261;&#263; udzia&#322; w tworzeniu tego serwisu i proponowa&#263; w&#322;asne artyku&#322;y. Aby mie&#263; tak&#261; mo&#380;liwo&#347;&#263;, musisz si&#281; zapisa&#263; poni&#380;ej. Na podany adres e-mail otrzymasz has&#322;o dost&#281;pu do strefy prywatnej serwisu.',
'plan_site' => 'Mapa strony',
'popularite' => 'Popularno&#347;&#263;',
'poster_message' => 'Napisz wiadomo&#347;&#263;',
'proposer_site' => 'Mo&#380;es zaproponowa&#263; stron&#281; do dodania w tym katalogu:',


// R
'repondre_article' => 'Skomentuj ten artyku&#322;',
'repondre_breve' => 'Skomentuj ten news',
'repondre_message' => 'Skomentuj wiadomo&#347;&#263;',
'resultats_recherche' => 'Wynik wyszukiwania',
'retour_debut_forums' => 'Powr&oacute;t do strony g&#322;&oacute;wnej forum',
'rubrique' => 'Dzia&#322;',
'rubriques' => 'Dzia&#322;y',


// S
'signatures_petition' => 'Podpisy',
'site_realise_avec_spip' => 'Strona zrealizowana przy pomocy SPIP',
'sites_web' => 'Strony internetowe',
'sous_rubriques' => 'Pod-dzia&#322;y',
'suite' => 'wi&#281;cej',
'sur_web' => 'W internecie',
'syndiquer_rubrique' => 'Ten dzia&#322;',
'syndiquer_site' => 'Ca&#322;&#261; stron&#281;',


// T
'texte_lettre_information' => 'Poni&#380;ej lista subskrypcyjna serwisu',
'texte_lettre_information_2' => 'Na tej li&#347;cie znajdziesz archiwum artyku&#322;&oacute;w i aktualno&#347;ci opublikowanych od',


// V
'ver_imprimer' => 'Wersja do druku',
'voir_en_ligne' => 'Zobacz on-line'

);


?>

--- NEW FILE: public_ar.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => '&#1575;&#1604;&#1589;&#1601;&#1581;&#1577; &#1575;&#1604;&#1575;&#1587;&#1575;&#1587;&#1610;&#1577;',
'articles' => '&#1575;&#1604;&#1605;&#1602;&#1575;&#1604;&#1575;&#1578;',
'articles_auteur' => '&#1605;&#1602;&#1575;&#1604;&#1575;&#1578; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1572;&#1604;&#1601;',
'articles_populaires' => '&#1575;&#1604;&#1605;&#1602;&#1575;&#1604;&#1575;&#1578; &#1575;&#1604;&#1575;&#1603;&#1579;&#1585; &#1588;&#1593;&#1576;&#1610;&#1577;',
'articles_recents' => '&#1571;&#1581;&#1583;&#1579; &#1575;&#1604;&#1605;&#1602;&#1575;&#1604;&#1575;&#1578;',
'articles_rubrique' => '&#1605;&#1602;&#1575;&#1604;&#1575;&#1578; &#1607;&#1584;&#1575; &#1575;&#1604;&#1602;&#1587;&#1605;',
'aucun_article' => '&#1604;&#1575; &#1578;&#1608;&#1580;&#1583; &#1605;&#1602;&#1575;&#1604;&#1575;&#1578; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1593;&#1606;&#1608;&#1575;&#1606;',
'aucun_auteur' => '&#1604;&#1575; &#1610;&#1608;&#1580;&#1583; &#1605;&#1572;&#1604;&#1601;&#1608;&#1606; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1593;&#1606;&#1608;&#1575;&#1606;',
'aucun_site' => '&#1604;&#1575; &#1578;&#1608;&#1580;&#1583; &#1605;&#1608;&#1575;&#1602;&#1593; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1593;&#1606;&#1608;&#1575;&#1606;',
'aucune_breve' => '&#1604;&#1575; &#1578;&#1608;&#1580;&#1583; &#1571;&#1582;&#1576;&#1575;&#1585; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1593;&#1606;&#1608;&#1575;&#1606;',
'aucune_rubrique' => '&#1604;&#1575; &#1578;&#1608;&#1580;&#1583; &#1571;&#1602;&#1587;&#1575;&#1605; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1593;&#1606;&#1608;&#1575;&#1606;',
'autres_breves' => '&#1571;&#1582;&#1576;&#1575;&#1585; &#1571;&#1582;&#1585;&#1609;',
'autres_groupes_mots_clefs' => '&#1605;&#1580;&#1605;&#1608;&#1593;&#1575;&#1578; &#1605;&#1601;&#1575;&#1578;&#1610;&#1581; &#1575;&#1582;&#1585;&#1609;',
'autres_sites' => '&#1605;&#1608;&#1575;&#1602;&#1593; &#1571;&#1582;&#1585;&#1609;',


// B
'bonjour' => '&#1571;&#1607;&#1604;&#1575;&#1611; &#1608;&#1587;&#1607;&#1604;&#1575;&#1611;',
'breves' => '&#1575;&#1604;&#1571;&#1582;&#1576;&#1575;&#1585;',


// C
'commenter_site' => '&#1578;&#1593;&#1604;&#1610;&#1602; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593;',


// D
'date' => '&#1575;&#1604;&#1578;&#1575;&#1585;&#1610;&#1582;',
'dernier_ajout' => '&#1570;&#1582;&#1585; &#1573;&#1590;&#1575;&#1601;&#1577;',
'dernieres_breves' => '&#1570;&#1582;&#1585; &#1575;&#1604;&#1571;&#1582;&#1576;&#1575;&#1585;',
'derniers_articles' => '&#1570;&#1582;&#1585; &#1575;&#1604;&#1605;&#1602;&#1575;&#1604;&#1575;&#1578;',
'derniers_commentaires' => '&#1570;&#1582;&#1585; &#1575;&#1604;&#1578;&#1593;&#1604;&#1610;&#1602;&#1575;&#1578;',
'derniers_messages_forum' => '&#1570;&#1582;&#1585; &#1575;&#1604;&#1605;&#1588;&#1575;&#1585;&#1603;&#1575;&#1578; &#1575;&#1604;&#1605;&#1606;&#1588;&#1608;&#1585;&#1577; &#1601;&#1610; &#1575;&#1604;&#1605;&#1606;&#1578;&#1583;&#1610;&#1575;&#1578;',


// E
'edition_mode_texte' => '&#1575;&#1604;&#1606;&#1588;&#1585;&#1577; &#1601;&#1610; &#1608;&#1590;&#1593;&#1610;&#1577; &#1575;&#1604;&#1606;&#1589;&#1608;&#1589;',
'en_reponse' => '&#1585;&#1583;&#1575;&#1611; &#1593;&#1604;&#1609;:',
'en_resume' => '&#1576;&#1575;&#1582;&#1578;&#1589;&#1575;&#1585;',
'envoyer_message' => '&#1573;&#1585;&#1587;&#1575;&#1604; &#1605;&#1588;&#1575;&#1585;&#1603;&#1577;',
'espace_prive' => '&#1575;&#1604;&#1605;&#1580;&#1575;&#1604; &#1575;&#1604;&#1582;&#1575;&#1589;',


// F
'forum' => '&#1575;&#1604;&#1605;&#1606;&#1578;&#1583;&#1609;',


// H
'hierarchie_site' => '&#1607;&#1585;&#1605;&#1610;&#1577; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593;',


// J
'jours' => '&#1610;&#1608;&#1605;',


// M
'meme_auteur' => '&#1605;&#1606; &#1606;&#1601;&#1587; &#1575;&#1604;&#1605;&#1572;&#1604;&#1601;',
'meme_rubrique' => '&#1601;&#1610; &#1607;&#1584;&#1575; &#1575;&#1604;&#1602;&#1587;&#1605; &#1575;&#1610;&#1590;&#1575;&#1611;',
'memes_auteurs' => '&#1605;&#1606; &#1575;&#1604;&#1605;&#1572;&#1604;&#1601;&#1610;&#1606; &#1606;&#1601;&#1587;&#1607;&#1605; &#1575;&#1610;&#1590;&#1575;&#1611;',
'message' => '&#1605;&#1588;&#1575;&#1585;&#1603;&#1577;',
'messages_forum' => '&#1605;&#1588;&#1575;&#1585;&#1603;&#1577; &#1605;&#1606;&#1578;&#1583;&#1609;',
'messages_recents' => '&#1571;&#1581;&#1583;&#1579; &#1575;&#1604;&#1605;&#1588;&#1575;&#1585;&#1603;&#1575;&#1578;',
'mots_clefs' => '&#1575;&#1604;&#1605;&#1601;&#1575;&#1578;&#1610;&#1581;',
'mots_clefs_meme_groupe' => '&#1575;&#1604;&#1605;&#1601;&#1575;&#1578;&#1610;&#1581; &#1575;&#1604;&#1575;&#1582;&#1585;&#1609; &#1601;&#1610; &#1607;&#1584;&#1607; &#1575;&#1604;&#1605;&#1580;&#1605;&#1608;&#1593;&#1577;',


// N
'navigation' => '&#1578;&#1589;&#1602;&#1581;',
'nom' => '&#1575;&#1604;&#1573;&#1587;&#1605;',
'nouveautes' => '&#1575;&#1604;&#1580;&#1583;&#1610;&#1583;',
'nouveautes_web' => '&#1575;&#1604;&#1580;&#1583;&#1610;&#1583; &#1593;&#1604;&#1609; &#1575;&#1604;&#1606;&#1587;&#1610;&#1580;',
'nouveaux_articles' => '&#1575;&#1604;&#1605;&#1602;&#1575;&#1604;&#1575;&#1578; &#1575;&#1604;&#1580;&#1583;&#1610;&#1583;&#1577;',
'nouvelles_breves' => '&#1575;&#1604;&#1571;&#1582;&#1576;&#1575;&#1585; &#1575;&#1604;&#1580;&#1583;&#1610;&#1583;&#1577;',


// P
'page_precedente' => '&#1575;&#1604;&#1589;&#1601;&#1581;&#1577; &#1575;&#1604;&#1587;&#1575;&#1576;&#1602;&#1577;',
'page_suivante' => '&#1575;&#1604;&#1589;&#1601;&#1581;&#1577; &#1575;&#1604;&#1578;&#1575;&#1604;&#1610;&#1577;',
'par_auteur' => '&#1576;&#1602;&#1604;&#1605; ',
'participer_site' => '&#1610;&#1605;&#1603;&#1606;&#1603; &#1575;&#1604;&#1605;&#1588;&#1575;&#1585;&#1603;&#1577; &#1601;&#1610; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593;&#1548; &#1576;&#1575;&#1604;&#1578;&#1587;&#1580;&#1610;&#1604; &#1575;&#1583;&#1606;&#1575;&#1607; &#1608;&#1606;&#1588;&#1585; &#1605;&#1602;&#1575;&#1604;&#1575;&#1578;&#1603;. &#1608;&#1576;&#1593;&#1583; &#1575;&#1604;&#1578;&#1587;&#1580;&#1610;&#1604;&#1548; &#1587;&#1608;&#1601; &#1578;&#1589;&#1604;&#1603; &#1585;&#1587;&#1575;&#1604;&#1577; &#1601;&#1608;&#1585;&#1610;&#1577; &#1576;&#1575;&#1604;&#1576;&#1585;&#1610;&#1583; &#1575;&#1604;&#1575;&#1604;&#1603;&#1578;&#1585;&#1608;&#1606;&#1610; &#1578;&#1578;&#1590;&#1605;&#1606; &#1605;&#1593;&#1585;&#1601;&#1603; &#1575;&#1604;&#1582;&#1575;&#1589; &#1575;&#1604;&#1584;&#1610; &#1610;&#1587;&#1605;&#1581; &#1604;&#1603; &#1576;&#1575;&#1604;&#1583;&#1582;&#1608;&#1604; &#1575;&#1604;&#1609; &#1575;&#1604;&#1605;&#1580;&#1!
 575;&#1604; &#1575;&#1604;&#1582;&#1575;&#1589;.',
'plan_site' => '&#1582;&#1585;&#1610;&#1591;&#1577; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593;',
'popularite' => '&#1575;&#1604;&#1588;&#1593;&#1576;&#1610;&#1577;',
'poster_message' => '&#1573;&#1576;&#1593;&#1579; &#1576;&#1585;&#1587;&#1575;&#1604;&#1577;',
'proposer_site' => '&#1610;&#1605;&#1603;&#1606;&#1603; &#1575;&#1601;&#1578;&#1585;&#1575;&#1581; &#1575;&#1590;&#1575;&#1601;&#1577; &#1605;&#1608;&#1602;&#1593; &#1575;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1602;&#1587;&#1605;:',


// R
'repondre_article' => '&#1575;&#1604;&#1585;&#1583; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1602;&#1575;&#1604;',
'repondre_breve' => '&#1575;&#1604;&#1585;&#1583; &#1593;&#1604;&#1609; &#1607;&#1584;&#1575; &#1575;&#1604;&#1582;&#1576;&#1585;',
'repondre_message' => '&#1575;&#1604;&#1585;&#1583; &#1593;&#1604;&#1609; &#1607;&#1584;&#1607; &#1575;&#1604;&#1605;&#1588;&#1575;&#1585;&#1603;&#1577;',
'resultats_recherche' => '&#1606;&#1578;&#1575;&#1574;&#1580; &#1575;&#1604;&#1576;&#1581;&#1579;',
'retour_debut_forums' => '&#1593;&#1608;&#1583;&#1577; &#1575;&#1604;&#1609; &#1576;&#1583;&#1575;&#1610;&#1577; &#1575;&#1604;&#1605;&#1606;&#1578;&#1583;&#1610;&#1575;&#1578;',
'rubrique' => '&#1575;&#1604;&#1602;&#1587;&#1605;',
'rubriques' => '&#1575;&#1604;&#1571;&#1602;&#1587;&#1575;&#1605;',


// S
'signatures_petition' => '&#1575;&#1604;&#1578;&#1608;&#1602;&#1610;&#1593;&#1575;&#1578;',
'site_realise_avec_spip' => '&#1605;&#1608;&#1602;&#1593; &#1589;&#1605;&#1605; &#1576;&#1606;&#1592;&#1575;&#1605; SPIP',
'sites_web' => '&#1605;&#1608;&#1575;&#1602;&#1593; &#1575;&#1604;&#1606;&#1587;&#1610;&#1580;',
'sous_rubriques' => '&#1575;&#1604;&#1571;&#1602;&#1587;&#1575;&#1605; &#1575;&#1604;&#1601;&#1585;&#1593;&#1610;&#1577;',
'suite' => '&#1578;&#1578;&#1605;&#1577;',
'sur_web' => '&#1593;&#1604;&#1609; &#1575;&#1604;&#1606;&#1587;&#1610;&#1580;',
'syndiquer_rubrique' => '&#1578;&#1585;&#1582;&#1610;&#1589; &#1607;&#1584;&#1575; &#1575;&#1604;&#1602;&#1587;&#1605;',
'syndiquer_site' => '&#1578;&#1585;&#1582;&#1610;&#1589; &#1603;&#1575;&#1605;&#1604; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593;',


// T
'texte_lettre_information' => '&#1607;&#1575; &#1607;&#1610; &#1606;&#1588;&#1585;&#1577; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593;',
'texte_lettre_information_2' => '&#1578;&#1581;&#1589;&#1610; &#1607;&#1584;&#1607; &#1575;&#1604;&#1606;&#1588;&#1585;&#1577; &#1575;&#1604;&#1605;&#1602;&#1575;&#1604;&#1575;&#1578; &#1608;&#1575;&#1604;&#1571;&#1582;&#1576;&#1575;&#1585; &#1575;&#1604;&#1605;&#1606;&#1588;&#1608;&#1585;&#1577; &#1605;&#1606;&#1584; ',


// V
'ver_imprimer' => '&#1606;&#1587;&#1582;&#1577; &#1604;&#1604;&#1591;&#1576;&#1575;&#1593;&#1577;',
'voir_en_ligne' => '&#1593;&#1585;&#1590; &#1605;&#1576;&#1575;&#1588;&#1585;'

);


?>

--- NEW FILE: public_oc_ni.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Acu&egrave;lh dau sit',
'articles' => 'Articles',
'articles_auteur' => 'Articles d\'aquel autor',
'articles_populaires' => 'Lu articles mai populars',
'articles_recents' => 'Lu articles mai recents',
'articles_rubrique' => 'Articles d\'aquela rubrica',
'aucun_article' => 'L\'i a minga d\'article a aquela adre&ccedil;a ',
'aucun_auteur' => 'L\'i a minga d\'autor a aquela adre&ccedil;a ',
'aucun_site' => 'L\'i a minga de sit a aquela adre&ccedil;a ',
'aucune_breve' => 'L\'i a minga de br&egrave;va a aquela adre&ccedil;a ',
'aucune_rubrique' => 'L\'i a minga de rubrica a aquela adre&ccedil;a ',
'autres_breves' => 'Autri br&egrave;vas',
'autres_groupes_mots_clefs' => 'Autres grops de m&ograve;ts claus',
'autres_sites' => 'Autres sits',


// B
'bonjour' => 'B&ograve;njorn',
'breves' => 'Br&egrave;vas',


// C
'commenter_site' => 'Comentar aqueu sit',


// D
'date' => 'Data',
'dernier_ajout' => 'Darri&egrave;r ajust',
'dernieres_breves' => 'Darri&egrave;ras br&egrave;vas',
'derniers_articles' => 'Darri&egrave;rs articles',
'derniers_commentaires' => 'Darri&egrave;rs comentaris',
'derniers_messages_forum' => 'Darri&egrave;rs messatges publicats dins lu forums',


// E
'edition_mode_texte' => 'Edicion en m&ograve;de t&egrave;xt de',
'en_reponse' => 'En responsa a:',
'en_resume' => 'En resumit',
'envoyer_message' => 'Mandar un messatge',
'espace_prive' => 'Espaci privat',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Ierarquia dau sit',


// J
'jours' => 'jorns',


// M
'meme_auteur' => 'Dau meme autor',
'meme_rubrique' => 'Dins la mema rubrica',
'memes_auteurs' => 'Dei memes autors',
'message' => 'Messatge',
'messages_forum' => 'Messatges de forum',
'messages_recents' => 'Lu messatges de forums mai recents',
'mots_clefs' => 'M&ograve;ts claus',
'mots_clefs_meme_groupe' => 'M&ograve;ts claus dins lo meme grop',


// N
'navigation' => 'Navigacion',
'nom' => 'Nom',
'nouveautes' => 'Li nov&egrave;utats',
'nouveautes_web' => 'Nov&egrave;utats sobre lo web',
'nouveaux_articles' => 'Articles n&ograve;us',
'nouvelles_breves' => 'Br&egrave;vas nov&egrave;las',


// P
'page_precedente' => 'p&agrave;gina anteriora',
'page_suivante' => 'p&agrave;gina seguenta',
'par_auteur' => 'per',
'participer_site' => 'Pod&egrave;tz participar a la vida d\'aqueu sit e prepauar lu v&ograve;stres articles en vos inscriure &ccedil;ai sota. Receberetz un e-mail que vos indicar&agrave; lu v&ograve;stres c&ograve;des per accedir a l\'espaci privat dau sit.',
'plan_site' => 'Plan dau sit',
'popularite' => 'Popularitat',
'poster_message' => 'Postar un messatge',
'proposer_site' => 'Pod&egrave;tz prepauar un site a ajustar dins aquela rubrica&nbsp;:',


// R
'repondre_article' => 'Respondre a aquel article',
'repondre_breve' => 'Respondre a aquela br&egrave;va',
'repondre_message' => 'Respondre a aqueu messatge',
'resultats_recherche' => 'Resultats de la rec&egrave;rca',
'retour_debut_forums' => 'Retorn au comen&ccedil;ament dei forums',
'rubrique' => 'Rubrica',
'rubriques' => 'Rubricas',


// S
'signatures_petition' => 'Signaturas',
'site_realise_avec_spip' => 'Sit realisat emb SPIP',
'sites_web' => 'Sits web',
'sous_rubriques' => 'Sosrubricas',
'suite' => 'seguida',
'sur_web' => 'Sobre lo web',
'syndiquer_rubrique' => 'Sindicar aquela rubrica',
'syndiquer_site' => 'Sindicar tot lo sit',


// T
'texte_lettre_information' => 'Vequ&iacute; la letra d\'informacion dau sit',
'texte_lettre_information_2' => 'Aquela letra recensa lu articles e br&egrave;vas publicats desp&iacute;',


// V
'ver_imprimer' => 'Version d\'estampar',
'voir_en_ligne' => 'Vejatz en linha'

);


?>

--- NEW FILE: public_fon.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'H&#596;ntogbo',
'articles' => 'Wekpa l&#603;&#770;',
'articles_auteur' => 'Ny&#596;wlant&#596; &eacute; l&#596; sin wekpa l&#603;&#770;',
'articles_populaires' => 'wekpa l&#603;&#770;  &ecirc; to bi t&ugrave;n y&eacute;',
'articles_recents' => 'wekpa g&ugrave;dog&ugrave;dot&#596;n l&#603;&#770;  ',
'articles_rubrique' => 'wekpa &#598;i&#598;&#603; &eacute; l&#596; t&#596;n',
'aucun_article' => 'wekpa &#598;e&#772;&#772;  do gesi &eacute; l&#596; ji a ',
'aucun_auteur' => 'Ny&#596;wlant&#596; &#598;e&#772;&#772;  do  gesi &eacute; l&#596; ji a ',
'aucun_site' => 'Gblogbloji &#598;e&#772;&#772;  do  gesi &eacute; l&#596; ji a',
'aucune_breve' => 'Xogb&egrave; kl&eacute;wun &#598;e&#772;&#772;  do  gesi &eacute; l&#596; ji a',
'aucune_rubrique' => '&#598;i&#598;&#603; &#598;e&#772;&#772; do gesi &eacute; l&#596; ji a ',
'autres_breves' => 'Xogb&egrave; kl&eacute;wun de vo',
'autres_groupes_mots_clefs' => 'Xota b&#603; dokp&#596; l&#603;&#770; ',
'autres_sites' => 'Gblogbloji &#598;e&#772;&#772; vo l&#603;&#770;',


// B
'bonjour' => 'kwab&#596;   ',
'breves' => 'Xogb&egrave; kl&eacute;wun',


// C
'commenter_site' => 'wl&#596;k&agrave;nn&uacute; xo l&#603;&#770;',


// D
'date' => 'Azan',
'dernier_ajout' => 'G&#596;na g&ugrave;dog&ugrave;dot&#596;n',
'dernieres_breves' => 'Xogb&egrave; kl&eacute;wun g&ugrave;dog&ugrave;dot&#596;n',
'derniers_articles' => 'Wekpa g&ugrave;dog&ugrave;dot&#596;n',
'derniers_commentaires' => '&#598;&#603;tit&#603; g&ugrave;dog&ugrave;dot&#596;n',
'derniers_messages_forum' => 'wh&#603;n g&ugrave;dog&ugrave;dot&#596;n ye&#772; &#598;&#596;dotoji',


// E
'edition_mode_texte' => 'winwlanm&#603;',
'en_reponse' => '&#598;ogb&egrave;yiyi m&#603; nu &nbsp;:',
'en_resume' => '&#598;o xo kl&eacute;wun m&#603; &#596;',
'envoyer_message' => 'S&#603; w&#603;n do ',
'espace_prive' => 't&#603;nkandovo',


// F
'forum' => 'Kpl&eacute;kpl&eacute; ',


// H
'hierarchie_site' => 'Tito gblogbloji &#596; t&#596;n',


// J
'jours' => 'Azan l&#603;&#770;',


// M
'meme_auteur' => 'Ny&#596;wlant&#596; &#598;okpo &#596;',
'meme_rubrique' => '&#598;o akpaxw&eacute; &#598;okpo &#596; m&#603;',
'memes_auteurs' => 'Ny&#596;wlant&#596; &#598;okpo l&#603;&#770;',
'message' => 'W&#603;n',
'messages_forum' => 'w&#603;n pk&eacute;kpl&eacute; &#596; t&#596;n l&ecirc;',
'messages_recents' => 'w&#603;n g&ugrave;do&#769;g&ugrave;dot&#596;n pk&eacute;kpl&eacute; &#596; t&#596;n l&ecirc;',
'mots_clefs' => 'xo&#769;ta&#769; l&#603;&#770;',
'mots_clefs_meme_groupe' => 'xo&#769;ta&#769; akpa &#598;okpo&#769; &#596; l&#603;&#770; t&#596;n',


// N
'navigation' => 'nuk&eacute;j&eacute;k&eacute;j&eacute;',
'nom' => 'nyi&#769;k&#596;',
'nouveautes' => 'Nu y&#596;y&#596; l&#603;&#770;',
'nouveautes_web' => 'Nu y&#596;y&#596; l&#603;&#770;  e &#598;o at&#603; &#596; ji&#769; &#596;',
'nouveaux_articles' => 'W&eacute;kpa y&#596;y&#596; l&#603;&#770;',
'nouvelles_breves' => 'w&#603;n kl&eacute;wun l&#603;&#770;',


// P
'page_precedente' => 'W&eacute;kpa e wai',
'page_suivante' => 'W&eacute;kpa e b&#596;&#598;&eacute;u',
'par_auteur' => 'Gb&#596;n',
'participer_site' => 'Mi&#768; &#598;&egrave; mi&#768; &#598;&eacute; xl&#603; bo&#769; na&#769;  siwu k&#603; nu&#768; do&#769; wal&#596; gblogbloji&#769; &#596; t&#596;n  en&#603; gu&#769;do &#596; mi&#768;  singan    s&#596; w&eacute;kpa mi t&#596;n l&#603;&#770; s&#603;  do&#769;. &#598;o m&#596; &#596;, mi&#768; n&agrave; s&#603; gb&egrave;t&agrave;kwin na&#769; na&#769; gb&egrave; b&#596; mi&#768; &#598;o t&agrave;f&#596; at&#603; &#596; ji&#769;  z&#596;n&#598;okpo e.',
'plan_site' => 'titom&#603; gblogbloji &#596; t&#596;n ',
'popularite' => 'Nuku&#769;n &#598;&eacute;ji&#769;',
'poster_message' => 's&#603; w&#603;n do',
'proposer_site' => 'Nu mi do gblogbloji&#769; &#598;&eacute; &#596;  Mi&#768; siwu z&eacute; g&#596; na&#769; akpa &eacute; l&#596; ',


// R
'repondre_article' => '&#598;o&#768; sin nu w&eacute;kpa e l&#596;',
'repondre_breve' => '&#598;o&#768; sin nu xo&#769; klewun &eacute; l&#596;',
'repondre_message' => '&#598;o&#768; sin nu w&#603;n  &eacute; l&#596;',
'resultats_recherche' => 'Gb&egrave;tak&#603;n nu do biba t&#596;n l&#603;&#770;',
'retour_debut_forums' => 'k&#596;l&#603; s&#596; yi&#768;  kpl&eacute;kpl&eacute; sin bib&#603;',
'rubrique' => 'Akpa ',
'rubriques' => 'Akpa l&#603;',


// S
'signatures_petition' => 'al&#596;dowemam&#603; l&#603;',
'site_realise_avec_spip' => 'Kpo al&#596;g&#596; Supipu t&#596;n kpo&#769; w&#603; gblogbloji&#769; &#596; nyi&#769; wiwa',
'sites_web' => 'At&#603; l&#603;&#770;',
'sous_rubriques' => 'Akpa xw&eacute;',
'suite' => 'B&#596; &#598;&eacute; wu t&#596;n',
'sur_web' => '&#598;o&#768; at&#603; &#596;  ji&#768;',
'syndiquer_rubrique' => 'Ze&#770; aceji do akpa &eacute; l&#596; ji&#769;',
'syndiquer_site' => 'ac&eacute;ji&#769;ni&#769;n&#596;',


// T
'texte_lettre_information' => 'Xojlawema&#769; gblogbloji &#596; t&#596;n &#598;i&egrave;',
'texte_lettre_information_2' => 'Xojlawema&#769; &eacute; l&#596;&#596; n&#596; cian w&eacute;kpa kpodo&#769; xo&#769; klewun &#598;&#596;&#768;dotoji&#769; xoxo l&#603;&#770;',


// V
'ver_imprimer' => 'Zin wema',
'voir_en_ligne' => 'kp&#596;n Gblogbloji'

);


?>

--- NEW FILE: spip_da.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-da',
'0_langue' => 'dansk [da]',
'0_liste' => 'spip-da at rezo.net',
'0_mainteneur' => 'abc at dk2net.dk',


// A
'admin_modifier_article' => 'Rediger artikel',
'admin_modifier_auteur' => 'Ret forfatter',
'admin_modifier_breve' => 'Rediger nyhed',
'admin_modifier_mot' => 'Ret n&oslash;gleord',
[...1628 lines suppressed...]
'titre_sites_proposes' => 'Indsendte websteder',
'titre_sites_references_rubrique' => 'Websteder der henvises til i dette afsnit',
'titre_sites_syndiques' => 'Syndikerede websteder',
'titre_sites_tous' => 'Websteder der henvises til',
'titre_statistiques' => 'Webstedsstatistik',
'titre_suivi_petition' => 'Opf&oslash;lgning p&aring; appeller',
'titre_syndication' => 'Webstedssyndikering',
'titre_titre_document' => 'Dokumentoverskrift:',
'trad_article_inexistant' => 'Der findes ingen artikel med dette nummer.',
'trad_article_traduction' => 'Alle udgaver af denne artikel&nbsp;:',
'trad_deja_traduit' => 'Denne artikel er allerede en overs&aelig;ttelse af den aktuelle artikel.',
'trad_delier' => 'Afbryd forbindelsen mellem denne artikel og overs&aelig;ttelserne',
'trad_lier' => 'Denne artikel er en overs&aelig;ttelse af artikel nummer&nbsp;:',
'trad_new' => 'Lav en ny overs&aelig;ttelse af denne artikel',
'trad_reference' => '(referenceartikel)'

);


?>

--- NEW FILE: spip_oc_prv.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'occitan (proven&ccedil;au) [oc_prv]',
'0_liste' => 'lenga.occitana at aprene.org',
'0_mainteneur' => 'Domergue Sumien:&nbsp;lenga.occitana at aprene.org',


// A
'access_interface_graphique' => 'Tornar a l\'interf&agrave;cia grafica completa',
'access_mode_texte' => 'Afichar l\'interf&agrave;cia textuala simplificada',
'admin_modifier_article' => 'Modificar aquel article',
'admin_modifier_auteur' => 'Modificar aquel autor',
[...1645 lines suppressed...]
'trad_new' => 'Escriure una revirada nov&egrave;la d\'aquest article',
'trad_reference' => '(article de refer&eacute;ncia)',


// U
'upload_fichier_zip' => 'Fichier ZIP',
'upload_fichier_zip_texte' => 'Lo fichier que prepausatz d\'installar es un fichier Zip.',
'upload_fichier_zip_texte2' => 'Aquel fichier p&ograve;t &egrave;sser:',
'upload_limit' => 'Aqueu fichier es tr&ograve;p gr&ograve;s per lo servidor; la talha maxima autorizada en <i>upload</i> es de @max at .',
'upload_zip_decompacter' => 'descomprimit e cada element que conten installat sus lo sit. Alora lei fichiers que ser&agrave;n installats sus lo sit son:',
'upload_zip_telquel' => 'installat tau coma es, coma archiu comprimit Zip;',


// V
'version_initiale' => 'Version iniciala'

);


?>

--- NEW FILE: public_fr.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Accueil du site',
'articles' => 'Articles',
'articles_auteur' => 'Articles de cet auteur',
'articles_populaires' => 'Articles les plus populaires',
'articles_recents' => 'Articles les plus r&eacute;cents',
'articles_rubrique' => 'Articles de cette rubrique',
'aucun_article' => 'Il n\'y a pas d\'article &agrave; cette adresse',
'aucun_auteur' => 'Il n\'y a pas d\'auteur &agrave; cette adresse',
'aucun_site' => 'Il n\'y a pas de site &agrave; cette adresse',
'aucune_breve' => 'Il n\'y a pas de br&egrave;ve &agrave; cette adresse',
'aucune_rubrique' => 'Il n\'y a pas de rubrique &agrave; cette adresse',
'autres_breves' => 'Autres br&egrave;ves',
'autres_groupes_mots_clefs' => 'Autres groupes de mots-cl&eacute;s',
'autres_sites' => 'Autres sites',


// B
'bonjour' => 'Bonjour',
'breves' => 'Br&egrave;ves',


// C
'commenter_site' => 'Commenter ce site',


// D
'date' => 'Date',
'dernier_ajout' => 'Dernier ajout',
'dernieres_breves' => 'Derni&egrave;res br&egrave;ves',
'derniers_articles' => 'Derniers articles',
'derniers_commentaires' => 'Derniers commentaires',
'derniers_messages_forum' => 'Derniers messages publi&eacute;s dans les forums',


// E
'edition_mode_texte' => '&Eacute;dition en mode texte de',
'en_reponse' => 'En r&eacute;ponse &agrave;&nbsp;:',
'en_resume' => 'En r&eacute;sum&eacute;',
'envoyer_message' => 'Envoyer un message',
'espace_prive' => 'Espace priv&eacute;',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Hi&eacute;rarchie du site',


// J
'jours' => 'jours',


// M
'meme_auteur' => 'Du m&ecirc;me auteur',
'meme_rubrique' => 'Dans la m&ecirc;me rubrique',
'memes_auteurs' => 'Des m&ecirc;mes auteurs',
'message' => 'Message',
'messages_forum' => 'Messages de forum',
'messages_recents' => 'Messages de forums les plus r&eacute;cents',
'mots_clefs' => 'Mots-cl&eacute;s',
'mots_clefs_meme_groupe' => 'Mots-cl&eacute;s dans le m&ecirc;me groupe',


// N
'navigation' => 'Navigation',
'nom' => 'Nom',
'nouveautes' => 'Les nouveaut&eacute;s',
'nouveautes_web' => 'Nouveaut&eacute;s sur le Web',
'nouveaux_articles' => 'Nouveaux articles',
'nouvelles_breves' => 'Nouvelles br&egrave;ves',


// P
'page_precedente' => 'page pr&eacute;c&eacute;dente',
'page_suivante' => 'page suivante',
'par_auteur' => 'par ',
'participer_site' => 'Vous pouvez participer &agrave; la vie de ce site et proposer vos propres articles en vous inscrivant ci-dessous. Vous recevrez imm&eacute;diatement un email vous indiquant vos codes d\'acc&egrave;s &agrave; l\'espace priv&eacute; du site.',
'plan_site' => 'Plan du site',
'popularite' => 'Popularit&eacute;',
'poster_message' => 'Poster un message',
'proposer_site' => 'Vous pouvez proposer un site &agrave; ajouter dans cette rubrique&nbsp;:',


// R
'repondre_article' => 'R&eacute;pondre &agrave; cet article',
'repondre_breve' => 'R&eacute;pondre &agrave; cette br&egrave;ve',
'repondre_message' => 'R&eacute;pondre &agrave; ce message',
'resultats_recherche' => 'R&eacute;sultats de la recherche',
'retour_debut_forums' => 'Retour au d&eacute;but des forums',
'rubrique' => 'Rubrique',
'rubriques' => 'Rubriques',


// S
'signatures_petition' => 'Signatures',
'site_realise_avec_spip' => 'Site r&eacute;alis&eacute; avec SPIP',
'sites_web' => 'Sites Web',
'sous_rubriques' => 'Sous-rubriques',
'suite' => 'suite',
'sur_web' => 'Sur le Web',
'syndiquer_rubrique' => 'Syndiquer cette rubrique',
'syndiquer_site' => 'Syndiquer tout le site',


// T
'texte_lettre_information' => 'Voici la lettre d\'information du site',
'texte_lettre_information_2' => 'Cette lettre recense les articles et les br&egrave;ves publi&eacute;s depuis',


// V
'ver_imprimer' => 'Version &agrave; imprimer',
'voir_en_ligne' => 'Voir en ligne'

);


?>

--- NEW FILE: public_en.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Home page',
'articles' => 'Articles',
'articles_auteur' => 'This author\'s articles',
'articles_populaires' => 'The most read articles',
'articles_recents' => 'The most recent articles',
'articles_rubrique' => 'This section\'s articles',
'aucun_article' => 'There is no article at this address',
'aucun_auteur' => 'There is no author at this address',
'aucun_site' => 'There is no site at this address',
'aucune_breve' => 'There is no news item at this address',
'aucune_rubrique' => 'There is no section at this address',
'autres_breves' => 'Other news',
'autres_groupes_mots_clefs' => 'Other groups of key words',
'autres_sites' => 'Other sites',


// B
'bonjour' => 'Hello',
'breves' => 'News items',


// C
'commenter_site' => 'Comment on this site',


// D
'date' => 'Date',
'dernier_ajout' => 'Latest addition',
'dernieres_breves' => 'Latest news',
'derniers_articles' => 'Latest articles',
'derniers_commentaires' => 'Latest comments',
'derniers_messages_forum' => 'Lastest messages published in the forums',


// E
'edition_mode_texte' => 'Text mode only',
'en_reponse' => 'Replying to:',
'en_resume' => 'Summary',
'envoyer_message' => 'To send a message',
'espace_prive' => 'Private area',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'The site\'s hierarchy',


// J
'jours' => 'days',


// M
'meme_auteur' => 'By the same author',
'meme_rubrique' => 'In the same section',
'memes_auteurs' => 'By the same authors',
'message' => 'Message',
'messages_forum' => 'Forum messages',
'messages_recents' => 'Most recent forum messages',
'mots_clefs' => 'Keywords',
'mots_clefs_meme_groupe' => 'Keywords in the same group',


// N
'navigation' => 'Navigation',
'nom' => 'Name',
'nouveautes' => 'What\'s new',
'nouveautes_web' => 'What\'s new on the Web',
'nouveaux_articles' => 'New articles',
'nouvelles_breves' => 'New news items',


// P
'page_precedente' => 'previous page',
'page_suivante' => 'next page',
'par_auteur' => 'by ',
'participer_site' => 'You can take an active part in this website and write your own articles by registering below. You will then receive immediately an email giving you an access code to the private area of the site.',
'plan_site' => 'Site Map',
'popularite' => 'Popularity',
'poster_message' => 'To post a message',
'proposer_site' => 'You can suggest a site to be added to this section:',


// R
'repondre_article' => 'Reply to this article',
'repondre_breve' => 'Reply to this news item',
'repondre_message' => 'Reply to this message',
'resultats_recherche' => 'Search results',
'retour_debut_forums' => 'Back to the start of the forums',
'rubrique' => 'Section',
'rubriques' => 'Sections',


// S
'signatures_petition' => 'Signatures',
'site_realise_avec_spip' => 'Site created with SPIP',
'sites_web' => 'Web sites',
'sous_rubriques' => 'Sub-sections',
'suite' => 'continue',
'sur_web' => 'On the Web',
'syndiquer_rubrique' => 'Syndicate this section',
'syndiquer_site' => 'Syndicate the whole site',


// T
'texte_lettre_information' => 'Here is the site\'s newsletter',
'texte_lettre_information_2' => 'This letter summarizes the articles and news items published since',


// V
'ver_imprimer' => 'Printable version',
'voir_en_ligne' => 'See online'

);


?>

--- NEW FILE: spip_oc_va.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://www.spip.net/oc',
'0_langue' => 'occitan (vivaroaupenc) [oc_va]',
'0_liste' => 'spip-oc at rezo.net',
'0_mainteneur' => 'Domergue Sumien: lenga.occitana at aprene.org ',


// A
'access_interface_graphique' => 'Tornar a l\'interf&agrave;cia grafica completa',
'access_mode_texte' => 'Afichar l\'interf&agrave;cia textuala simplificaa',
'admin_modifier_article' => 'Modificar aquel article',
'admin_modifier_auteur' => 'Modificar aquel autor',
[...1699 lines suppressed...]
'trad_new' => 'Escriure una reviraa nov&egrave;la d\'aquest article',
'trad_reference' => '(article de refer&eacute;ncia)',


// U
'upload_fichier_zip' => 'Fichier ZIP',
'upload_fichier_zip_texte' => 'Lo fichier que prepausatz d\'installar es un fichier Zip.',
'upload_fichier_zip_texte2' => 'Aqueu fichier p&ograve;t &egrave;sser:',
'upload_limit' => 'Aqueu fichier es tr&ograve;p gr&ograve;s per lo servior; la talha maxima autorizaa en <i>upload</i> es de @max at .',
'upload_zip_decompacter' => 'descomprimit e chasque element que conten installat sus lo sit. Aladonc los fichiers que ser&agrave;n installats sus lo sit son:',
'upload_zip_telquel' => 'installat tau coma es, coma archiu comprimit Zip;',


// V
'version_initiale' => 'Version iniciala'

);


?>

--- NEW FILE: public_zh.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => '&#20027;&#39029;',
'articles' => '&#25991;&#31456;',
'articles_auteur' => '&#35813;&#20316;&#32773;&#30340;&#25991;&#31456;',
'articles_populaires' => '&#28909;&#38376;&#25991;&#31456;',
'articles_recents' => '&#26368;&#26032;&#25991;&#31456;',
'articles_rubrique' => '&#27492;&#26639;&#19979;&#30340;&#25991;&#31456;',
'aucun_article' => '&#35813;&#22320;&#22336;&#19979;&#27809;&#26377;&#25991;&#31456;',
'aucun_auteur' => '&#35813;&#22320;&#22336;&#19979;&#27809;&#26377;&#20316;&#32773;',
'aucun_site' => '&#35813;&#22320;&#22336;&#19979;&#27809;&#26377;&#31449;&#28857;',
'aucune_breve' => '&#35813;&#22320;&#22336;&#19979;&#27809;&#26377;&#31616;&#35201;',
'aucune_rubrique' => '&#35813;&#22320;&#22336;&#19979;&#27809;&#26377;&#19987;&#26639;',
'autres_breves' => '&#20854;&#23427;&#31616;&#35201;',
'autres_groupes_de_mots_clefs' => '&#20854;&#23427;&#20851;&#38190;&#35789;&#32452;',
'autres_groupes_mots_clefs' => '&#20854;&#23427;&#20851;&#38190;&#35789;&#32452;',
'autres_sites' => '&#20854;&#23427;&#31449;&#28857;',


// B
'bonjour' => '&#24744;&#22909;',
'breves' => '&#31616;&#35201;',


// C
'commenter_site' => '&#35780;&#35770;&#31449;&#28857;',


// D
'dans_meme_rubrique' => '&#22312;&#30456;&#21516;&#31456;&#33410;',
'date' => '&#26085;&#26399;',
'dernier_ajout' => '&#26368;&#26032;&#28155;&#20837;',
'dernieres_breves' => '&#26368;&#26032;&#31616;&#35201;',
'derniers_articles' => '&#26368;&#26032;&#25991;&#31456;',
'derniers_commentaires' => '&#26368;&#26032;&#35780;&#35770;',
'derniers_messages_des_forums' => '&#26368;&#36817;&#35770;&#22363;&#28040;&#24687;',
'derniers_messages_forum' => '&#35770;&#22363;&#26368;&#36817;&#21457;&#34920;&#30340;&#28040;&#24687;',


// E
'edition_mode_texte' => '&#25991;&#26412;&#32534;&#36753;&#27169;&#24335;',
'en_reponse' => '&#22238;&#22797;:',
'en_resume' => '&#25688;&#35201;',
'envoyer_message' => '&#21457;&#36865;&#28040;&#24687;',
'envoyer_un_message' => '&#21457;&#36865;&#28040;&#24687;',
'espace_prive' => '&#31169;&#26377;&#21306;',


// F
'forum' => '&#35770;&#22363;',


// H
'hierarchie_site' => '&#31449;&#28857;&#23618;&#27425;',


// J
'jours' => '&#22825;',


// M
'meme_auteur' => '&#21516;&#19968;&#20316;&#32773;',
'meme_rubrique' => '&#21516;&#19968;&#19987;&#26639;',
'memes_auteurs' => '&#21516;&#19968;&#20316;&#32773;',
'message' => '&#28040;&#24687;',
'messages_forum' => '&#35770;&#22363;&#28040;&#24687;',
'messages_recents' => '&#26368;&#36817;&#35770;&#22363;&#28040;&#24687;',
'mots_clefs' => '&#20851;&#38190;&#35789;',
'mots_clefs_meme_groupe' => '&#21516;&#32452;&#20851;&#38190;&#35789;',


// N
'navigation' => '&#23548;&#33322;',
'nom' => '&#21517;&#23383;',
'nouveautes' => '&#26032;&#21464;&#21160;',
'nouveautes_web' => '&#26032;&#39029;&#38754;',
'nouveaux_articles' => '&#26032;&#25991;&#31456;',
'nouvelles_breves' => '&#26032;&#35201;&#38395;',


// P
'page_precedente' => '&#21069;&#19968;&#39029;',
'page_suivante' => '&#21518;&#19968;&#39029;',
'par_auteur' => '&#25353;&#29031;',
'participer_site' => '&#36890;&#36807;email&#27880;&#20876;&#24471;&#21040;&#35775;&#38382;&#30721;,&#24744;&#21487;&#20197;&#22312;&#26412;&#31449;&#28857;&#19978;&#24471;&#21040;&#19968;&#20010;&#27963;&#21160;&#21306;&#24182;&#21457;&#34920;&#24744;&#33258;&#24049;&#30340;&#25991;&#31456;.',
'pas_d_article' => '&#35813;&#22320;&#22336;&#27809;&#26377;&#25991;&#31456;',
'pas_d_auteur' => '&#35813;&#22320;&#22336;&#27809;&#26377;&#20316;&#32773;',
'pas_de_breve' => '&#35813;&#22320;&#22336;&#27809;&#26377;&#26032;&#38395;',
'pas_de_rubrique' => '&#35813;&#22320;&#22336;&#27809;&#26377;&#31456;&#33410;',
'pas_de_site' => '&#35813;&#22320;&#22336;&#27809;&#26377;&#31449;&#28857;',
'plan_du_site' => '&#31449;&#28857;&#22270;',
'plan_site' => '&#31449;&#28857;&#22320;&#22270;',
'popularite' => '&#28909;&#28857;',
'poster_message' => '&#21457;&#34920;&#28040;&#24687;',
'poster_un_message' => '&#21457;&#34920;&#28040;&#24687;',
'proposer_site' => '<NEW>Vous pouvez proposer un site &agrave; ajouter dans cette rubrique&nbsp;:',


// R
'repondre_article' => '&#22238;&#22797;&#25991;&#31456;',
'repondre_breve' => '&#22238;&#22797;&#31616;&#35201;',
'repondre_message' => '&#22238;&#22797;&#28040;&#24687;',
'resultats_recherche' => '&#25628;&#32034;&#32467;&#26524;',
'retour_debut_forums' => '&#36820;&#22238;&#35770;&#22363;&#39030;',
'rubrique' => '&#19987;&#26639;',
'rubriques' => '&#19987;&#26639;',


// S
'signatures_petition' => '&#31614;&#21517;',
'site_realise_avec_spip' => '&#20351;&#29992;SPIP&#24314;&#31435;&#30340;&#31449;&#28857;',
'sites_web' => '&#32593;&#31449;',
'sous_rubriques' => '&#23376;&#19987;&#26639;',
'suite' => '&#32487;&#32493;',
'sur_web' => '&#22312;&#32593;&#19978;',
'syndiquer_rubrique' => '&#32852;&#21512;&#35813;&#19987;&#26639;',
'syndiquer_site' => '&#32852;&#21512;&#25972;&#20010;&#31449;&#28857;',


// T
'texte_lettre_information' => '&#31449;&#28857;&#26102;&#20107;&#36890;&#35759;',
'texte_lettre_information_2' => '&#26412;&#23553;&#20449;&#32479;&#35745;&#33258;&#19979;&#36848;&#26102;&#38388;&#21457;&#34920;&#30340;&#25991;&#31456;&#21644;&#31616;&#35201;',


// V
'ver_imprimer' => '&#25171;&#21360;&#29256;&#26412;',
'voir_en_ligne' => '&#22312;&#32447;&#39044;&#35272;'

);


?>

--- NEW FILE: spip_es.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-es',
'0_langue' => 'espa&ntilde;ol [es]',
'0_liste' => 'spip-es at rezo.net',
'0_mainteneur' => 'spip-es at rezo.net',


// A
'access_interface_graphique' => 'Volver a la interfaz gr&aacute;fica completa',
'access_mode_texte' => 'Mostrar la interfaz simplificada en modo texto',
'admin_modifier_article' => 'Modificar este art&iacute;culo',
'admin_modifier_auteur' => 'Modificar esta autora o autor',
[...1524 lines suppressed...]
'trad_new' => 'Escribir una nueva traducci&oacute;n de este art&iacute;culo',
'trad_reference' => '(art&iacute;culo de referencia)',


// U
'upload_fichier_zip' => 'Fichero ZIP',
'upload_fichier_zip_texte' => 'El fichero que se propone instalar es un fichero Zip.',
'upload_fichier_zip_texte2' => 'Este fichero puede ser:',
'upload_limit' => 'Este fichero es demasiado grande para el servidor; el tama&ntilde;o m&aacute;ximo autorizado en <i>upload</i> es de @max at .',
'upload_zip_decompacter' => 'descomprimido y cada uno de los elementos que contiene instalado en el sitio. Los ficheros que van a ser instalados en el sitio son:',
'upload_zip_telquel' => 'instalado tal cual, como archivo Zip comprimido;',


// V
'version_initiale' => 'Versi&oacute;n inicial'

);


?>

--- NEW FILE: public_nl.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Beginpagina',
'articles' => 'Artikels',
'articles_auteur' => 'Artikels van deze auteur',
'articles_populaires' => 'Meest bekeken artikels',
'articles_recents' => 'Meest recente artikels',
'articles_rubrique' => 'Artikels van deze rubriek',
'aucun_article' => 'Op dit adres is geen artikel te vinden',
'aucun_auteur' => 'Op dit adres is geen auteur te vinden',
'aucun_site' => 'Op dit adres is geen site te vinden',
'aucune_breve' => 'Op dit adres is geen nieuwsbericht te vinden',
'aucune_rubrique' => 'Op dit adres is geen rubriek te vinden',
'autres_breves' => 'Andere nieuwsberichten',
'autres_groupes_mots_clefs' => 'Andere groepen trefwoorden',
'autres_sites' => 'Andere sites',


// B
'bonjour' => 'Hallo',
'breves' => 'Nieuwsberichten',


// C
'commenter_site' => 'Commentaar geven op de site',


// D
'date' => 'Datum',
'dernier_ajout' => 'Laatste toevoeging',
'dernieres_breves' => 'Laatste nieuwsberichten',
'derniers_articles' => 'Laatste artikels',
'derniers_commentaires' => 'Laatste commentaren',
'derniers_messages_forum' => 'Laatst gepubliceerde berichten in het forum',


// E
'edition_mode_texte' => 'Uitgave in tekstmodus van',
'en_reponse' => 'Als antwoord op&nbsp;:',
'en_resume' => 'Samengevat',
'envoyer_message' => 'Een bericht sturen',
'espace_prive' => 'Priv&eacute;-site',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Structuur van de site',


// J
'jours' => 'dagen',


// M
'meme_auteur' => 'Van dezelfde auteur',
'meme_rubrique' => 'In dezelfde rubriek',
'memes_auteurs' => 'Van dezelfde auteurs',
'message' => 'Bericht',
'messages_forum' => 'Berichten van het forum',
'messages_recents' => 'Meest recente berichten van de forums',
'mots_clefs' => 'Trefwoorden',
'mots_clefs_meme_groupe' => 'Trefwoorden van dezelfde groep',


// N
'navigation' => 'Navigatie',
'nom' => 'Naam',
'nouveautes' => 'Nieuwigheden',
'nouveautes_web' => 'Nieuwigheden op het Web',
'nouveaux_articles' => 'Nieuwe artikels',
'nouvelles_breves' => 'Nieuwe nieuwsberichten',


// P
'page_precedente' => 'vorige pagina',
'page_suivante' => 'volgende pagina',
'par_auteur' => 'door ',
'participer_site' => 'Je kan bijdragen tot deze site door je eigen artikels voor te stellen als je je hieronder inschrijft. Je krijgt meteen een e-mail met daarin de toegangscode voor de priv&eacute;-deel van de site.',
'plan_site' => 'Overzicht van de site',
'popularite' => 'Populariteit',
'poster_message' => 'Een bericht plaatsen',
'proposer_site' => 'Je kan voorstellen een site in deze rubriek op te nemen&nbsp;:',


// R
'repondre_article' => 'Dit artikel beantwoorden',
'repondre_breve' => 'Dit nieuwsbericht beantwoorden',
'repondre_message' => 'Dit bericht beantwoorden',
'resultats_recherche' => 'Resultaten van de zoekopdracht',
'retour_debut_forums' => 'Terug naar de startpagina van de forums',
'rubrique' => 'Rubriek',
'rubriques' => 'Rubrieken',


// S
'signatures_petition' => 'Ondertekeningen',
'site_realise_avec_spip' => 'Site gebouwd met SPIP',
'sites_web' => 'Websites',
'sous_rubriques' => 'Subrubrieken',
'suite' => 'vervolg',
'sur_web' => 'Op het web',
'syndiquer_rubrique' => 'Nieuws overnemen uit deze rubriek',
'syndiquer_site' => 'Nieuws overnemen van de hele site',


// T
'texte_lettre_information' => 'Ziehier de nieuwsbrief van de site',
'texte_lettre_information_2' => 'De nieuwsbrief vermedlt alle artikels en berichten gepubliceerd sinds',


// V
'ver_imprimer' => 'Afdrukversie',
'voir_en_ligne' => 'Online bekijken'

);


?>

--- NEW FILE: spip_ar.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => '&#1593;&#1585;&#1576;&#1610; [ar]',
'0_liste' => 'spip-dev at rezo.net',
'0_mainteneur' => '&#1580;&#1608;&#1585;&#1580; &#1602;&#1606;&#1583;&#1604;&#1601;&#1578; (george at diwanalarab.com)',


// A
'access_interface_graphique' => '&#1593;&#1608;&#1583;&#1577; &#1575;&#1604;&#1609; &#1575;&#1604;&#1608;&#1575;&#1580;&#1607;&#1577; &#1575;&#1604;&#1585;&#1587;&#1608;&#1605;&#1610;&#1577; &#1575;&#1604;&#1603;&#1575;&#1605;&#1604;&#1577;',
'access_mode_texte' => '&#1593;&#1585;&#1590; &#1575;&#1604;&#1608;&#1575;&#1580;&#1607;&#1577; &#1575;&#1604;&#1606;&#1589;&#1608;&#1589;&#1610;&#1577; &#1575;&#1604;&#1605;&#1576;&#1587;&#1617;&#1591;&#1577;',
'admin_modifier_article' => '&#1578;&#1593;&#1583;&#1610;&#1604; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1602;&#1575;&#1604;',
'admin_modifier_auteur' => '&#1578;&#1594;&#1610;&#1610;&#1585; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1572;&#1604;&#1601;',
[...1694 lines suppressed...]
'trad_new' => '&#1603;&#1578;&#1575;&#1576;&#1577; &#1578;&#1585;&#1580;&#1605;&#1577; &#1580;&#1583;&#1610;&#1583;&#1577; &#1604;&#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1602;&#1575;&#1604;',
'trad_reference' => '(&#1575;&#1604;&#1605;&#1602;&#1575;&#1604; &#1575;&#1604;&#1605;&#1585;&#1580;&#1593;)',


// U
'upload_fichier_zip' => '&#1605;&#1604;&#1601; ZIP',
'upload_fichier_zip_texte' => '&#1575;&#1604;&#1605;&#1604;&#1601; &#1575;&#1604;&#1584;&#1610; &#1578;&#1606;&#1608;&#1610; &#1578;&#1579;&#1576;&#1610;&#1578;&#1607; &#1607;&#1608; &#1605;&#1604;&#1601; ZIP.',
'upload_fichier_zip_texte2' => '&#1602;&#1583; &#1610;&#1603;&#1608;&#1606; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1604;&#1601;:',
'upload_limit' => '&#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1604;&#1601; &#1603;&#1576;&#1610;&#1585; &#1580;&#1583;&#1575;&#1611; &#1604;&#1580;&#1607;&#1575;&#1586; &#1575;&#1604;&#1582;&#1583;&#1605;&#1577;. &#1575;&#1604;&#1581;&#1580;&#1605; &#1575;&#1604;&#1575;&#1602;&#1589;&#1609; &#1575;&#1604;&#1605;&#1587;&#1605;&#1608;&#1581; &#1576;&#1607; &#1582;&#1604;&#1575;&#1604; <i>&#1575;&#1604;&#1578;&#1581;&#1605;&#1610;&#1604;</i> &#1607;&#1608; @max at . ',
'upload_zip_decompacter' => '&#1594;&#1610;&#1585; &#1605;&#1590;&#1594;&#1608;&#1591; &#1608; &#1603;&#1604; &#1593;&#1606;&#1589;&#1585; &#1610;&#1581;&#1578;&#1608;&#1610;&#1607; &#1605;&#1579;&#1576;&#1578; &#1601;&#1610; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593;. &#1575;&#1604;&#1605;&#1604;&#1601;&#1575;&#1578; &#1575;&#1604;&#1578;&#1610; &#1587;&#1610;&#1578;&#1605; &#1578;&#1579;&#1576;&#1610;&#1578;&#1607;&#1575; &#1601;&#1610; &#1575;&#1604;&#1605;&#1608;&#1602;&#1593; &#1607;&#1610;:',
'upload_zip_telquel' => '&#1605;&#1579;&#1576;&#1578; &#1603;&#1605;&#1575; &#1607;&#1608; &#1593;&#1604;&#1609; &#1588;&#1603;&#1604; &#1605;&#1604;&#1601; ZIP &#1605;&#1590;&#1594;&#1608;&#1591;.',


// V
'version_initiale' => '&#1575;&#1604;&#1575;&#1589;&#1583;&#1575;&#1585; &#1575;&#1604;&#1575;&#1589;&#1604;&#1610;'

);


?>

--- NEW FILE: spip_gl.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://www.spip.net/gl',
'0_langue' => 'Galego [gl]',
'0_liste' => 'spip-gl at rezo.net',
'0_mainteneur' => 'hacklab at hacklab.casaencantada.org, webmaster at avogacia.org',


// A
'admin_modifier_article' => 'Modificar este artigo',
'admin_modifier_auteur' => 'Modificar este autor',
'admin_modifier_breve' => 'Modificar esta breve',
'admin_modifier_mot' => 'Modificar esta palabra chave',
[...1639 lines suppressed...]
'trad_new' => 'Escribir unha nova traduci&oacute;n deste artigo',
'trad_reference' => '(artigo de referencia)',


// U
'upload_fichier_zip' => 'Arquivo ZIP',
'upload_fichier_zip_texte' => 'O ficheiro que pretende instalar &eacute; un arquivo Zip.',
'upload_fichier_zip_texte2' => 'Este ficheiro pode ser&nbsp;:',
'upload_limit' => 'Este ficheiro &eacute; demasiado grande para o servidor&nbsp;; o tama&ntilde;o m&aacute;ximo autorizado en <i>upload</i> &eacute; de @max at .',
'upload_zip_decompacter' => 'descompr&iacute;mase e cada elemento que conte&ntilde;a que sexa instalado no web. Os ficheiros que ser&aacute;n instalados son&nbsp;:',
'upload_zip_telquel' => 'instalado tal cal, dado que &eacute; un arquivo comprimido Zip&nbsp;;',


// V
'version_initiale' => 'Versi&oacute;n inicial'

);


?>

--- NEW FILE: public_gl.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Entrada do web',
'articles' => 'Artigos',
'articles_auteur' => 'Artigos deste autor',
'articles_populaires' => 'Artigos m&aacute;is populares',
'articles_recents' => 'Artigos m&aacute;is recentes',
'articles_rubrique' => 'Artigos desta secci&oacute;n',
'aucun_article' => 'Non hai artigo neste enderezo',
'aucun_auteur' => 'Non hai autor neste enderezo',
'aucun_site' => 'Non hai web neste enderezo',
'aucune_breve' => 'Non hai breves neste enderezo',
'aucune_rubrique' => 'Non hai secci&oacute;n neste enderezo',
'autres_breves' => 'Outras breves',
'autres_groupes_mots_clefs' => 'Outros grupos de palabras chave',
'autres_sites' => 'Outros webs',


// B
'bonjour' => 'Bos d&iacute;as',
'breves' => 'Breves',


// C
'commenter_site' => 'Comentar este web',


// D
'date' => 'Data',
'dernier_ajout' => '&Uacute;ltimo engadido',
'dernieres_breves' => '&Uacute;ltimas breves',
'derniers_articles' => '&Uacute;ltimos artigos',
'derniers_commentaires' => '&Uacute;ltimos comentarios',
'derniers_messages_forum' => '&Uacute;ltimas mensaxes publicadas nos foros',


// E
'edition_mode_texte' => 'Edici&oacute;n en modo texto de',
'en_reponse' => 'En resposta a&nbsp;:',
'en_resume' => 'En resumo',
'envoyer_message' => 'Enviar unha mensaxe',
'espace_prive' => 'Espacio privado',


// F
'forum' => 'Foro',


// H
'hierarchie_site' => 'Xerarqu&iacute;a do web',


// J
'jours' => 'd&iacute;as',


// M
'meme_auteur' => 'Do mesmo autor',
'meme_rubrique' => 'Na mesma secci&oacute;n',
'memes_auteurs' => 'Dos mesmos autores',
'message' => 'Mensaxe',
'messages_forum' => 'Mensaxes do foro',
'messages_recents' => 'Mensaxes dos foros m&aacute;is recentes',
'mots_clefs' => 'Palabras chave',
'mots_clefs_meme_groupe' => 'Palabras chave dentro do mesmo grupo',


// N
'navigation' => 'Navegaci&oacute;n',
'nom' => 'Nome',
'nouveautes' => 'Novidades',
'nouveautes_web' => 'Novidades no web',
'nouveaux_articles' => 'Novos artigos',
'nouvelles_breves' => 'Novas breves',


// P
'page_precedente' => 'p&aacute;xina anterior',
'page_suivante' => 'p&aacute;xina seguinte',
'par_auteur' => 'por',
'participer_site' => 'Pode participar na vida deste web e propo&ntilde;er os seus propios artigos inscrib&iacute;ndose aqu&iacute; abaixo. Recibir&aacute; inmediatamente un correo que lle indicar&aacute; o seu c&oacute;digo de acceso ao espacio privado do web.',
'plan_site' => 'Mapa do web',
'popularite' => 'Popularidade',
'poster_message' => 'Enviar unha mensaxe',
'proposer_site' => 'Pode propo&ntilde;er un web para engadir a esta secci&oacute;n&nbsp;:',


// R
'repondre_article' => 'Responder a este artigo',
'repondre_breve' => 'Responder a esta breve',
'repondre_message' => 'Responder a esta mensaxe',
'resultats_recherche' => 'Resultados da procura',
'retour_debut_forums' => 'Volta ao principio dos foros',
'rubrique' => 'Secci&oacute;n',
'rubriques' => 'Secci&oacute;ns',


// S
'signatures_petition' => 'Sinaturas',
'site_realise_avec_spip' => 'Web realizado con SPIP',
'sites_web' => 'Sitios web',
'sous_rubriques' => 'Subsecci&oacute;ns',
'suite' => 'a seguir',
'sur_web' => 'Sobre o web',
'syndiquer_rubrique' => 'Sindicar esta secci&oacute;n',
'syndiquer_site' => 'Sindicar todo o web',


// T
'texte_lettre_information' => 'Velaqu&iacute; a nota informativa do web',
'texte_lettre_information_2' => 'Esta nota recolle os artigos e as breves publicadas despois',


// V
'ver_imprimer' => 'Versi&oacute;n para imprimir',
'voir_en_ligne' => 'Ver en li&ntilde;a'

);


?>

--- NEW FILE: spip_fr.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-dev',
'0_langue' => 'Fran&ccedil;ais [fr]',
'0_liste' => 'spip-dev at rezo.net',
'0_mainteneur' => 'spip-dev at rezo.net',


// A
'access_interface_graphique' => 'Retour &agrave; l\'interface graphique compl&egrave;te',
'access_mode_texte' => 'Afficher l\'interface textuelle simplifi&eacute;e',
'admin_modifier_article' => 'Modifier cet article',
'admin_modifier_auteur' => 'Modifier cet auteur',
[...1687 lines suppressed...]
'trad_new' => '&Eacute;crire une nouvelle traduction de cet article',
'trad_reference' => '(article de r&eacute;f&eacute;rence)',


// U
'upload_fichier_zip' => 'Fichier ZIP',
'upload_fichier_zip_texte' => 'Le fichier que vous proposez d\'installer est un fichier Zip.',
'upload_fichier_zip_texte2' => 'Ce fichier peut &ecirc;tre&nbsp;:',
'upload_limit' => 'Ce fichier est trop gros pour le serveur&nbsp;; la taille maximum autoris&eacute;e en <i>upload</i> est de @max at .',
'upload_zip_decompacter' => 'd&eacute;compress&eacute; et chaque &eacute;l&eacute;ment qu\'il contient install&eacute; sur le site. Les fichiers qui seront alors install&eacute;s sur le site sont&nbsp;:',
'upload_zip_telquel' => 'install&eacute; tel quel, en tant qu\'archive compress&eacute;e Zip&nbsp;;',


// V
'version_initiale' => 'Version initiale'

);


?>

--- NEW FILE: spip_hu.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-hu',
'0_langue' => 'Magyar [hu]',
'0_liste' => 'spip-hu at rezo.net',
'0_mainteneur' => 'trucy at freemail.hu',


// A
'access_interface_graphique' => 'Vissza a teljes grafikus fel&uuml;letre',
'access_mode_texte' => '<NEW>Afficher l\'interface textuelle simplifi&eacute;e',
'admin_modifier_article' => 'Cikk m&oacute;dos&iacute;t&aacute;sa',
'admin_modifier_auteur' => 'Szerz&#337; m&oacute;dos&iacute;t&aacute;sa',
[...1605 lines suppressed...]
'trad_new' => '&Iacute;rni egy &uacute;jabb ford&iacute;t&aacute;st err&#337;l a cikkr&#337;l',
'trad_reference' => '(eredeti cikk)',


// U
'upload_fichier_zip' => '<NEW>Fichier ZIP',
'upload_fichier_zip_texte' => '<NEW>Le fichier que vous proposez d\'installer est un fichier Zip.',
'upload_fichier_zip_texte2' => '<NEW>Ce fichier peut &ecirc;tre&nbsp;:',
'upload_limit' => '<NEW>Ce fichier est trop gros pour le serveur&nbsp;; la taille maximum autoris&eacute;e en <i>upload</i> est de @max at .',
'upload_zip_decompacter' => '<NEW>d&eacute;compress&eacute; et chaque &eacute;l&eacute;ment qu\'il contient install&eacute; sur le site. Les fichiers qui seront alors install&eacute;s sur le site sont&nbsp;:',
'upload_zip_telquel' => '<NEW>install&eacute; tel quel, en tant qu\'archive compress&eacute;e Zip&nbsp;;',


// V
'version_initiale' => '<NEW>Version initiale'

);


?>

--- NEW FILE: spip_oc_auv.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://www.spip.net/oc',
'0_langue' => 'occitan (auvernhat) [oc_auv]',
'0_liste' => 'spip-oc at rezo.net',
'0_mainteneur' => 'Domergue Sumien: lenga.occitana at aprene.org ',


// A
'access_interface_graphique' => 'Tornar a l\'interf&agrave;cia grafica completa',
'access_mode_texte' => 'Afichar l\'interf&agrave;cia textuala simplificada',
'admin_modifier_article' => 'Modificar aquel article',
'admin_modifier_auteur' => 'Modificar aquel autor',
[...1644 lines suppressed...]
'trad_new' => 'Escriure una revirada nov&egrave;la d\'aqueste article',
'trad_reference' => '(article de refer&eacute;ncia)',


// U
'upload_fichier_zip' => 'Fich&egrave;ir ZIP',
'upload_fichier_zip_texte' => 'Lo fich&egrave;ir que prepausatz d\'installar z-es un fich&egrave;ir Zip.',
'upload_fichier_zip_texte2' => 'Aquel fich&egrave;ir p&ograve;t l-&egrave;sser:',
'upload_limit' => 'Aquel fich&egrave;ir z-es tr&ograve;p gr&ograve;s per lo servidor; la talha maxima autorizada en <i>upload</i> z-es de @max at .',
'upload_zip_decompacter' => 'descomprimit e chasque element que conten installat sus lo sit. Lendonc los fich&egrave;irs que ser&aacute;n installats sus lo sit son:',
'upload_zip_telquel' => 'installat tau coma z-es, coma archiu comprimit Zip;',


// V
'version_initiale' => 'Version iniciala'

);


?>

--- NEW FILE: spip_cpf.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-cpf',
'0_langue' => 'Kr&eacute;ol r&eacute;nyon&eacute; [cpf]',
'0_liste' => 'spip-cpf at rezo.net',
'0_mainteneur' => 'pascale at rezo.net',


// A
'access_interface_graphique' => 'Artoun si lint&egrave;rfas grafik konpl&eacute;',
'access_mode_texte' => 'Afis lint&egrave;rfas t&egrave;ks sinp',
'admin_modifier_article' => 'Sanz lartik-la',
'admin_modifier_auteur' => 'Sanz linformasyon lot&egrave;r',
[...1632 lines suppressed...]
'trad_new' => 'Ekri inn nouv&egrave;l tradiksyon lartik-la',
'trad_reference' => '(Lartik-p&eacute;i de r&eacute;f&eacute;rans)',


// U
'upload_fichier_zip' => 'Fisy&eacute; ZIP',
'upload_fichier_zip_texte' => 'Fisy&eacute;-l&agrave; sak ou v&eacute; instal&eacute; l&eacute; inn fisy&eacute; Zip.',
'upload_fichier_zip_texte2' => 'Fisy&eacute;-la l&eacute; pit&egrave;t&nbsp;:',
'upload_limit' => 'Fisy&eacute;-l li l&eacute; tro gro pou lo s&egrave;rv&egrave;r&nbsp;; pli gran tay l&eacute; posib <i>upload</i> sa l&eacute; @max at .',
'upload_zip_decompacter' => 'd&eacute;kopres&eacute; &eacute; sakinn z&eacute;l&eacute;man ali sr&eacute; pou instal&eacute; si lo sit. Tout bann fisy&eacute; pou instal i sra lor&nbsp;:',
'upload_zip_telquel' => 'instal&eacute; komsa kom in larsiv kopres&eacute; Zip&nbsp;;',


// V
'version_initiale' => 'Promy&eacute; v&egrave;rsyon'

);


?>

--- NEW FILE: public_bg.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => '&#1053;&#1072;&#1095;&#1072;&#1083;&#1086;',
'articles' => '&#1057;&#1090;&#1072;&#1090;&#1080;&#1080;',
'articles_auteur' => '&#1057;&#1090;&#1072;&#1090;&#1080;&#1080; &#1085;&#1072; &#1072;&#1074;&#1090;&#1086;&#1088;&#1072;',
'articles_populaires' => '&#1053;&#1072;&#1081;-&#1087;&#1086;&#1087;&#1091;&#1083;&#1103;&#1088;&#1085;&#1080;&#1090;&#1077; &#1089;&#1090;&#1072;&#1090;&#1080;&#1080;',
'articles_recents' => '&#1053;&#1072;&#1081;-&#1085;&#1086;&#1074;&#1080;&#1090;&#1077; &#1087;&#1091;&#1073;&#1083;&#1080;&#1082;&#1091;&#1074;&#1072;&#1085;&#1080; &#1089;&#1090;&#1072;&#1090;&#1080;&#1080;',
'articles_rubrique' => '&#1057;&#1090;&#1072;&#1090;&#1080;&#1080; &#1086;&#1090; &#1088;&#1091;&#1073;&#1088;&#1080;&#1082;&#1072;&#1090;&#1072;',
'aucun_article' => '&#1053;&#1072; &#1090;&#1086;&#1079;&#1080; &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1077; &#1073;&#1077; &#1085;&#1072;&#1084;&#1077;&#1088;&#1077;&#1085;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1103;',
'aucun_auteur' => '&#1053;&#1072; &#1090;&#1086;&#1079;&#1080; &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1077; &#1073;&#1077; &#1085;&#1072;&#1084;&#1077;&#1088;&#1077;&#1085; &#1072;&#1074;&#1090;&#1086;&#1088;',
'aucun_site' => '&#1053;&#1072; &#1090;&#1086;&#1079;&#1080; &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1077; &#1073;&#1077; &#1085;&#1072;&#1084;&#1077;&#1088;&#1077;&#1085; &#1089;&#1072;&#1081;&#1090;',
'aucune_breve' => '&#1053;&#1072; &#1090;&#1086;&#1079;&#1080; &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1077; &#1073;&#1103;&#1093;&#1072; &#1085;&#1072;&#1084;&#1077;&#1088;&#1077;&#1085;&#1080; &#1085;&#1086;&#1074;&#1080;&#1085;&#1080;',
'aucune_rubrique' => '&#1053;&#1072; &#1090;&#1086;&#1079;&#1080; &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1077; &#1073;&#1077; &#1085;&#1072;&#1084;&#1077;&#1088;&#1077;&#1085;&#1072; &#1088;&#1091;&#1073;&#1088;&#1080;&#1082;&#1072;',
'autres_breves' => '&#1044;&#1088;&#1091;&#1075;&#1080; &#1085;&#1086;&#1074;&#1080;&#1085;&#1080;',
'autres_groupes_mots_clefs' => '&#1044;&#1088;&#1091;&#1075;&#1080; &#1075;&#1088;&#1091;&#1087;&#1080; &#1086;&#1090; &#1082;&#1083;&#1102;&#1095;&#1086;&#1074;&#1080; &#1076;&#1091;&#1084;&#1080;',
'autres_sites' => '&#1044;&#1088;&#1091;&#1075;&#1080; &#1089;&#1072;&#1081;&#1090;&#1086;&#1074;&#1077;',


// B
'bonjour' => '&#1044;&#1086;&#1073;&#1098;&#1088; &#1076;&#1077;&#1085;',
'breves' => '&#1053;&#1086;&#1074;&#1080;&#1085;&#1080;',


// C
'commenter_site' => '&#1050;&#1086;&#1084;&#1077;&#1085;&#1090;&#1072;&#1088; &#1085;&#1072; &#1089;&#1072;&#1081;&#1090;&#1072;',


// D
'date' => '&#1044;&#1072;&#1090;&#1072;',
'dernier_ajout' => '&#1053;&#1072;&#1081;-&#1085;&#1086;&#1074;&#1086;&#1090;&#1086; &#1076;&#1086;&#1087;&#1098;&#1083;&#1085;&#1077;&#1085;&#1080;&#1077;',
'dernieres_breves' => '&#1055;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1090;&#1077; &#1085;&#1086;&#1074;&#1080;&#1085;&#1080;',
'derniers_articles' => '&#1053;&#1072;&#1081;-&#1085;&#1086;&#1074;&#1080;&#1090;&#1077; &#1089;&#1090;&#1072;&#1090;&#1080;&#1080;',
'derniers_commentaires' => '&#1053;&#1072;&#1081;-&#1085;&#1086;&#1074;&#1080;&#1090;&#1077; &#1082;&#1086;&#1084;&#1077;&#1085;&#1090;&#1072;&#1088;&#1080;',
'derniers_messages_forum' => '&#1053;&#1072;&#1081;-&#1085;&#1086;&#1074;&#1080;&#1090;&#1077; &#1089;&#1098;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1103;, &#1087;&#1091;&#1073;&#1083;&#1080;&#1082;&#1091;&#1074;&#1072;&#1085;&#1080; &#1085;&#1072; &#1092;&#1086;&#1088;&#1091;&#1084;&#1072;',


// E
'edition_mode_texte' => '&#1090;&#1077;&#1082;&#1089;&#1090;&#1086;&#1074; &#1074;&#1080;&#1076;',
'en_reponse' => '&#1042; &#1086;&#1090;&#1075;&#1086;&#1074;&#1086;&#1088; &#1085;&#1072;:',
'en_resume' => '&#1056;&#1077;&#1079;&#1102;&#1084;&#1077;',
'envoyer_message' => '&#1048;&#1079;&#1087;&#1088;&#1072;&#1097;&#1072;&#1085;&#1077; &#1085;&#1072; &#1089;&#1098;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077;',
'espace_prive' => '&#1051;&#1080;&#1095;&#1085;&#1072; &#1079;&#1086;&#1085;&#1072;',


// F
'forum' => '&#1060;&#1086;&#1088;&#1091;&#1084;',


// H
'hierarchie_site' => '&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1072; &#1085;&#1072; &#1089;&#1072;&#1081;&#1090;&#1072;',


// J
'jours' => '&#1076;&#1085;&#1080;',


// M
'meme_auteur' => '&#1054;&#1090; &#1089;&#1098;&#1097;&#1080;&#1103; &#1072;&#1074;&#1090;&#1086;&#1088;',
'meme_rubrique' => '&#1042; &#1089;&#1098;&#1097;&#1072;&#1090;&#1072; &#1088;&#1091;&#1073;&#1088;&#1080;&#1082;&#1072;',
'memes_auteurs' => '&#1054;&#1090; &#1089;&#1098;&#1097;&#1080;&#1090;&#1077; &#1072;&#1074;&#1090;&#1086;&#1088;&#1080;',
'message' => '&#1057;&#1098;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077;',
'messages_forum' => '&#1057;&#1098;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1103; &#1086;&#1090; &#1092;&#1086;&#1088;&#1091;&#1084;&#1072;',
'messages_recents' => '&#1053;&#1072;&#1081;-&#1085;&#1086;&#1074;&#1080;&#1090;&#1077; &#1089;&#1098;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1103; &#1086;&#1090; &#1092;&#1086;&#1088;&#1091;&#1084;&#1072;',
'mots_clefs' => '&#1050;&#1083;&#1102;&#1095;&#1086;&#1074;&#1080; &#1076;&#1091;&#1084;&#1080;',
'mots_clefs_meme_groupe' => '&#1050;&#1083;&#1102;&#1095;&#1086;&#1074;&#1080; &#1076;&#1091;&#1084;&#1080; &#1086;&#1090; &#1089;&#1098;&#1097;&#1072;&#1090;&#1072; &#1075;&#1088;&#1091;&#1087;&#1072;',


// N
'navigation' => '&#1053;&#1072;&#1074;&#1080;&#1075;&#1072;&#1094;&#1080;&#1103;',
'nom' => '&#1048;&#1084;&#1077;',
'nouveautes' => '&#1050;&#1072;&#1082;&#1074;&#1086; &#1085;&#1086;&#1074;&#1086;?',
'nouveautes_web' => '&#1050;&#1072;&#1082;&#1074;&#1086; &#1085;&#1086;&#1074;&#1086; &#1074; &#1084;&#1088;&#1077;&#1078;&#1072;&#1090;&#1072;?',
'nouveaux_articles' => '&#1053;&#1086;&#1074;&#1080; &#1089;&#1090;&#1072;&#1090;&#1080;&#1080;',
'nouvelles_breves' => '&#1055;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080; &#1085;&#1086;&#1074;&#1080;&#1085;&#1080;',


// P
'page_precedente' => '&#1087;&#1088;&#1077;&#1076;&#1080;&#1096;&#1085;&#1072; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072;',
'page_suivante' => '&#1089;&#1083;&#1077;&#1076;&#1074;&#1072;&#1097;&#1072; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072;',
'par_auteur' => '&#1086;&#1090;',
'participer_site' => '&#1047;&#1072; &#1076;&#1072; &#1074;&#1079;&#1077;&#1084;&#1077;&#1090;&#1077; &#1072;&#1082;&#1090;&#1080;&#1074;&#1085;&#1086; &#1091;&#1095;&#1072;&#1089;&#1090;&#1080;&#1077; &#1074; &#1088;&#1072;&#1073;&#1086;&#1090;&#1072;&#1090;&#1072; &#1085;&#1072; &#1089;&#1072;&#1081;&#1090;&#1072; &#1080; &#1076;&#1072; &#1087;&#1080;&#1096;&#1077;&#1090;&#1077; &#1089;&#1074;&#1086;&#1080; &#1089;&#1086;&#1073;&#1089;&#1090;&#1074;&#1077;&#1085;&#1080; &#1089;&#1090;&#1072;&#1090;&#1080;&#1080;, &#1077; &#1085;&#1091;&#1078;&#1085;&#1086; &#1087;&#1098;&#1088;&#1074;&#1086; &#1076;&#1072; &#1089;&#1077; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1080;&#1088;&#1072;&#1090;&#1077; &#1090;&#1091;&#1082;. &#1055;&#1088;&#1080; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1103; &#1097;&#1077; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1077; &#1085;&#1077;&#1079;&#1072;&#1073;&#1072;&#1074;&#1085;&#1086; &#1089;&#1098;!
 &#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1077;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1080;&#1103; &#1089;&#1080; &#1072;&#1076;&#1088;&#1077;&#1089; &#1089; &#1082;&#1086;&#1076; &#1079;&#1072; &#1076;&#1086;&#1089;&#1090;&#1098;&#1087; &#1076;&#1086; &#1083;&#1080;&#1095;&#1085;&#1072;&#1090;&#1072; &#1079;&#1086;&#1085;&#1072; &#1085;&#1072; &#1089;&#1072;&#1081;&#1090;&#1072;.',
'plan_site' => '&#1050;&#1072;&#1088;&#1090;&#1072; &#1085;&#1072; &#1089;&#1072;&#1081;&#1090;&#1072;',
'popularite' => '&#1055;&#1086;&#1087;&#1091;&#1083;&#1103;&#1088;&#1085;&#1086;&#1089;&#1090;',
'poster_message' => '&#1048;&#1079;&#1087;&#1088;&#1072;&#1097;&#1072;&#1085;&#1077; &#1085;&#1072; &#1089;&#1098;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077;',
'proposer_site' => '&#1055;&#1088;&#1077;&#1076;&#1083;&#1086;&#1078;&#1077;&#1090;&#1077; &#1089;&#1072;&#1081;&#1090;, &#1082;&#1086;&#1081;&#1090;&#1086; &#1076;&#1072; &#1073;&#1098;&#1076;&#1077; &#1076;&#1086;&#1073;&#1072;&#1074;&#1077;&#1085; &#1082;&#1098;&#1084; &#1088;&#1091;&#1073;&#1088;&#1080;&#1082;&#1072;&#1090;&#1072;:',


// R
'repondre_article' => '&#1054;&#1090;&#1075;&#1086;&#1074;&#1086;&#1088; &#1085;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1103;&#1090;&#1072;',
'repondre_breve' => '&#1054;&#1090;&#1075;&#1086;&#1074;&#1086;&#1088; &#1085;&#1072; &#1085;&#1086;&#1074;&#1080;&#1085;&#1072;&#1090;&#1072;',
'repondre_message' => '&#1054;&#1090;&#1075;&#1086;&#1074;&#1086;&#1088; &#1085;&#1072; &#1089;&#1098;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077;&#1090;&#1086;',
'resultats_recherche' => '&#1056;&#1077;&#1079;&#1091;&#1083;&#1090;&#1072;&#1090;&#1080; &#1086;&#1090; &#1090;&#1098;&#1088;&#1089;&#1077;&#1085;&#1077;&#1090;&#1086;',
'retour_debut_forums' => '&#1054;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086; &#1074; &#1085;&#1072;&#1095;&#1072;&#1083;&#1086;&#1090;&#1086; &#1085;&#1072; &#1092;&#1086;&#1088;&#1091;&#1084;&#1080;&#1090;&#1077;',
'rubrique' => '&#1056;&#1091;&#1073;&#1088;&#1080;&#1082;&#1072;',
'rubriques' => '&#1056;&#1091;&#1073;&#1088;&#1080;&#1082;&#1080;',


// S
'signatures_petition' => '&#1047;&#1072;&#1087;&#1080;&#1089;&#1080;',
'site_realise_avec_spip' => '&#1057;&#1072;&#1081;&#1090; &#1087;&#1086;&#1076; &#1057;&#1055;&#1048;&#1055;',
'sites_web' => '&#1048;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090; &#1089;&#1072;&#1081;&#1090;&#1086;&#1074;&#1077;',
'sous_rubriques' => '&#1055;&#1086;&#1076;&#1088;&#1091;&#1073;&#1088;&#1080;&#1082;&#1080;',
'suite' => '&#1087;&#1088;&#1086;&#1076;&#1098;&#1083;&#1078;&#1072;&#1074;&#1072;',
'sur_web' => '&#1042; &#1084;&#1088;&#1077;&#1078;&#1072;&#1090;&#1072;',
'syndiquer_rubrique' => '&#1054;&#1073;&#1077;&#1076;&#1080;&#1085;&#1103;&#1074;&#1072;&#1085;&#1077; &#1085;&#1072; &#1090;&#1072;&#1079;&#1080; &#1088;&#1091;&#1073;&#1088;&#1080;&#1082;&#1072;',
'syndiquer_site' => '&#1054;&#1073;&#1077;&#1076;&#1080;&#1085;&#1103;&#1074;&#1072;&#1085;&#1077; &#1085;&#1072; &#1094;&#1077;&#1083;&#1080;&#1103; &#1089;&#1072;&#1081;&#1090;',


// T
'texte_lettre_information' => '&#1058;&#1086;&#1074;&#1072; &#1077; &#1073;&#1102;&#1083;&#1077;&#1090;&#1080;&#1085;&#1072; &#1085;&#1072; &#1089;&#1072;&#1081;&#1090;&#1072;',
'texte_lettre_information_2' => '&#1055;&#1080;&#1089;&#1084;&#1086;&#1090;&#1086; &#1088;&#1077;&#1079;&#1102;&#1084;&#1080;&#1088;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1080;&#1090;&#1077; &#1080; &#1085;&#1086;&#1074;&#1080;&#1085;&#1080;&#1090;&#1077; &#1087;&#1091;&#1073;&#1083;&#1080;&#1082;&#1091;&#1074;&#1072;&#1085;&#1080; &#1086;&#1090;',


// V
'ver_imprimer' => '&#1042;&#1077;&#1088;&#1089;&#1080;&#1103; &#1079;&#1072; &#1086;&#1090;&#1087;&#1077;&#1095;&#1072;&#1090;&#1074;&#1072;&#1085;&#1077;',
'voir_en_ligne' => '&#1042;&#1080;&#1078; &#1082;&#1072;&#1082; &#1097;&#1077; &#1080;&#1079;&#1075;&#1083;&#1077;&#1078;&#1076;&#1072;'

);


?>

--- NEW FILE: spip_eo.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-eo',
'0_langue' => 'Esperanto [eo]',
'0_liste' => 'spip-eo at rezo.net',
'0_mainteneur' => 'MHSautet at aol.com',


// A
'access_interface_graphique' => 'Reiro al kompletan grafikan interfacon',
'access_mode_texte' => 'Afi&#349;igi la simpligita tekstan interfacon',
'admin_modifier_article' => 'Modifu tiun &#265;i artikolon',
'admin_modifier_auteur' => 'Modifu tiun &#265;i a&#365;toron',
[...1644 lines suppressed...]
'trad_new' => 'Skribi novan tradukon de tiu artikolo',
'trad_reference' => '(artikolo referenca)',


// U
'upload_fichier_zip' => 'ZIP-Dosiero',
'upload_fichier_zip_texte' => 'La dosiero, kiun vi proponas instali estas ZIP-dosiero.',
'upload_fichier_zip_texte2' => 'Tiu dosiero eble estas&nbsp;:',
'upload_limit' => 'Tiu dosiero estas tro granda por la servilo; la maksimuma grandeco permesita en <i>upload</i> estas @max at .',
'upload_zip_decompacter' => 'maldensigita kaj &#265;iu elemento kiun &#285;i enhavas instalita en la teksejo. La dosieroj kiuj estos tiam instalitaj en la teksejo estas:',
'upload_zip_telquel' => 'instalita kiel tia, kiel densigita Zip-arkivo;',


// V
'version_initiale' => 'Komenca versio'

);


?>

--- NEW FILE: spip_lb.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-lb',
'0_langue' => 'L&euml;tzebuergesch [lb]',
'0_liste' => 'spip-lb at rezo.net',
'0_mainteneur' => 'jwander at pt.lu',


// A
'access_interface_graphique' => 'Zer&euml;ck bei de kompletten graph&euml;schen Interface',
'access_mode_texte' => 'Vereinfachten Text-Interface weisen',
'admin_modifier_article' => 'D&euml;sen Artikel &auml;nneren',
'admin_modifier_auteur' => 'D&euml;sen Auteur &auml;nneren',
[...1507 lines suppressed...]
'trad_new' => 'Eng nei Iwwersetzung vun d&euml;sem Artikel schreiwen',
'trad_reference' => '(Referenz-Artikel)',


// U
'upload_fichier_zip' => 'ZIP-Fichier',
'upload_fichier_zip_texte' => 'De Fichier deen d&euml;r install&eacute;ieren w&euml;llt ass en Zip-Fichier.',
'upload_fichier_zip_texte2' => 'D&euml;se Fichier ka sinn:',
'upload_limit' => 'D&euml;se Fichier ass ze grouss fir de Server; d&eacute;i maximal Gr&eacute;isst fir <i>eropzelueden</i> ass @max at .',
'upload_zip_decompacter' => 'de-komprim&eacute;iert an all Element um Site install&eacute;iert. D\'Fichier\'en d&eacute;i dann um Site install&eacute;iert ginn sinn:',
'upload_zip_telquel' => 'esou w&eacute;i en ass, als komprim&eacute;ierten Zip-Archiv install&eacute;iert;',


// V
'version_initiale' => 'Original-Versioun'

);


?>

--- NEW FILE: public_ca.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Arrel de la web',
'articles' => 'Articles',
'articles_auteur' => 'Articles d\'aquest autor',
'articles_populaires' => 'Els articles m&eacute;s populars',
'articles_recents' => 'Els articles m&eacute;s recents',
'articles_rubrique' => 'Articles d\'aquesta secci&oacute;',
'aucun_article' => 'No hi ha cap article en aquesta adre&ccedil;a',
'aucun_auteur' => 'No hi ha cap autor/a a aquesta adre&ccedil;a',
'aucun_site' => 'No hi ha cap lloc web en aquesta adre&ccedil;a',
'aucune_breve' => 'No hi ha cap breu a aquesta adre&ccedil;a',
'aucune_rubrique' => 'No hi ha cap secci&oacute; a aquesta adre&ccedil;a',
'autres_breves' => 'Altres breus',
'autres_groupes_mots_clefs' => 'Altres grups de paraules clau',
'autres_sites' => 'Altres llocs webs',


// B
'bonjour' => 'Bon dia',
'breves' => 'Breus',


// C
'commenter_site' => 'Comentar aquest lloc web',


// D
'date' => ' Data',
'dernier_ajout' => 'Darrer afegit',
'dernieres_breves' => 'Darreres breus',
'derniers_articles' => 'Darrers articles',
'derniers_commentaires' => 'Darrers comentaris',
'derniers_messages_forum' => 'Darrers missatges publicats als f&ograve;rums',


// E
'edition_mode_texte' => 'Edici&oacute; en mode text de ',
'en_reponse' => 'En resposta a:',
'en_resume' => 'En resum',
'envoyer_message' => 'Enviar un missatge',
'espace_prive' => 'Espai privat',


// F
'forum' => 'F&ograve;rum',


// H
'hierarchie_site' => 'Jerarquia del lloc',


// J
'jours' => 'dies',


// M
'meme_auteur' => 'Del mateix/a autor/a',
'meme_rubrique' => 'A la mateixa secci&oacute;',
'memes_auteurs' => 'Dels mateixos autors',
'message' => 'Missatge',
'messages_forum' => 'Missatges al f&ograve;rum',
'messages_recents' => 'Els missatges m&eacute;s recents als f&ograve;rums',
'mots_clefs' => 'Paraules clau',
'mots_clefs_meme_groupe' => 'Paraules clau al mateix grup',


// N
'navigation' => 'Navegaci&oacute;',
'nom' => 'Nom',
'nouveautes' => 'Les novetats',
'nouveautes_web' => 'Novetats a la Web',
'nouveaux_articles' => 'Articles nous',
'nouvelles_breves' => 'Noves breus',


// P
'page_precedente' => 'p&agrave;gina anterior',
'page_suivante' => 'p&agrave;gina seg&uuml;ent',
'par_auteur' => 'per&nbsp;',
'participer_site' => 'Podeu participar en la vida d\'aquest lloc web i proposar els vostres articles si ompliu la inscripci&oacute; que hi ha a continuaci&oacute;. Immediatament rebreu un correu electr&ograve;nic indicant-vos els codis d\'acc&eacute;s a l\'espai privat de la web.',
'plan_site' => 'Mapa del lloc Web',
'popularite' => 'Popularitat',
'poster_message' => 'Escriure un missatge',
'proposer_site' => 'Pots proposar un lloc web per afegir-lo a aquesta secci&oacute;:',


// R
'repondre_article' => 'Respondre a aquest article',
'repondre_breve' => 'Respondre a aquesta breu',
'repondre_message' => 'Respondre a aquest missatge',
'resultats_recherche' => 'Resultats de la recerca',
'retour_debut_forums' => 'Retorn al comen&ccedil;ament dels f&ograve;rums',
'rubrique' => 'Secci&oacute;',
'rubriques' => 'Seccions',


// S
'signatures_petition' => 'Signatures',
'site_realise_avec_spip' => 'Lloc Web fet amb l\'SPIP',
'sites_web' => 'Llocs Web',
'sous_rubriques' => 'Subseccions',
'suite' => 'Seguiment',
'sur_web' => 'Sobre la p&agrave;gina Web',
'syndiquer_rubrique' => 'Sindicar aquesta secci&oacute;',
'syndiquer_site' => 'Sindicar tot el lloc Web',


// T
'texte_lettre_information' => 'Veure la carta de presentaci&oacute; del lloc Web',
'texte_lettre_information_2' => 'Aquesta carta recull i conta els articles i els breus publicades des de',


// V
'ver_imprimer' => 'Versi&oacute; per imprimir',
'voir_en_ligne' => 'Veure en l&iacute;nia'

);


?>

--- NEW FILE: public_es.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Portada del sitio',
'articles' => 'Art&iacute;culos',
'articles_auteur' => 'Art&iacute;culos de esta autora o autor',
'articles_populaires' => 'Los art&iacute;culos m&aacute;s populares',
'articles_recents' => 'Los art&iacute;culos m&aacute;s recientes',
'articles_rubrique' => 'Art&iacute;culos de esta secci&oacute;n',
'aucun_article' => 'No hay ning&uacute;n art&iacute;culo en esta direcci&oacute;n ',
'aucun_auteur' => 'No hay autor ni autora en esta direcci&oacute;n ',
'aucun_site' => 'No hay ning&uacute;n sitio en esta direcci&oacute;n',
'aucune_breve' => 'No hay ninguna breve en esta direcci&oacute;n',
'aucune_rubrique' => 'No hay ninguna secci&oacute;n en esta direcci&oacute;n',
'autres_breves' => 'Otros breves',
'autres_groupes_mots_clefs' => 'Otros grupos de palabras clave',
'autres_sites' => 'Otros sitios',


// B
'bonjour' => 'Hola',
'breves' => 'Breves',


// C
'commenter_site' => 'Comentar este sitio',


// D
'date' => 'Fecha',
'dernier_ajout' => '&Uacute;ltima actualizaci&oacute;n',
'dernieres_breves' => '&Uacute;ltimos breves',
'derniers_articles' => '&Uacute;ltimos art&iacute;culos',
'derniers_commentaires' => '&Uacute;ltimos comentarios',
'derniers_messages_forum' => '&Uacute;ltimos mensajes publicados en los foros',


// E
'edition_mode_texte' => 'Edici&oacute;n en modo texto de',
'en_reponse' => 'En respuesta a:',
'en_resume' => 'En resumen',
'envoyer_message' => 'Enviar un mensaje',
'espace_prive' => 'Espacio privado',


// F
'forum' => 'Foro',


// H
'hierarchie_site' => 'Jerarqu&iacute;a del sitio',


// J
'jours' => 'd&iacute;as',


// M
'meme_auteur' => 'Del mismo autor',
'meme_rubrique' => 'En la misma secci&oacute;n',
'memes_auteurs' => 'De los mismos autores',
'message' => 'Mensaje',
'messages_forum' => 'Mensajes del foro',
'messages_recents' => 'Los mensajes m&aacute;s recientes del foro',
'mots_clefs' => 'Palabras clave',
'mots_clefs_meme_groupe' => 'Palabras claves en el mismo grupo',


// N
'navigation' => 'Navegaci&oacute;n',
'nom' => 'Nombre',
'nouveautes' => 'Las novedades',
'nouveautes_web' => 'Novedades en la web',
'nouveaux_articles' => 'Nuevos art&iacute;culos',
'nouvelles_breves' => 'Nuevas breves',


// P
'page_precedente' => 'P&aacute;gina precedente',
'page_suivante' => 'P&aacute;gina siguiente',
'par_auteur' => 'por ',
'participer_site' => 'Puedes participar en la vida de este sitio y proponer art&iacute;culos inscribi&eacute;ndote aqui. De inmediato recibir&aacute;s un correo electr&oacute;nico con tus claves de acceso al espacio privado del sitio.',
'plan_site' => 'Mapa del sitio',
'popularite' => 'Popularidad',
'poster_message' => 'Publicar un mensaje',
'proposer_site' => 'Proponga un sitio para a&ntilde;adir en esta secci&oacute;n:',


// R
'repondre_article' => 'Comentar este art&iacute;culo',
'repondre_breve' => 'Comentar esta breve',
'repondre_message' => 'Responder este mensaje',
'resultats_recherche' => 'Resultados de la b&uacute;squeda',
'retour_debut_forums' => 'Volver al inicio del foro',
'rubrique' => 'Secci&oacute;n',
'rubriques' => 'Secciones',


// S
'signatures_petition' => 'Firmas',
'site_realise_avec_spip' => 'Sitio desarrollado con SPIP',
'sites_web' => 'Sitios Web',
'sous_rubriques' => 'Subsecci&oacute;n',
'suite' => 'continuar',
'sur_web' => 'Del web',
'syndiquer_rubrique' => 'Sindicar esta secci&oacute;n',
'syndiquer_site' => 'Sindicar el sitio completo',


// T
'texte_lettre_information' => 'Este es el bolet&iacute;n de informaci&oacute;n del sitio',
'texte_lettre_information_2' => 'Este bolet&iacute;n rese&ntilde;a los art&iacute;culos y breves publicados desde ',


// V
'ver_imprimer' => 'Versi&oacute;n para imprimir',
'voir_en_ligne' => 'Ver en l&iacute;nea'

);


?>

--- NEW FILE: public_vi.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Trang nh&agrave;',
'articles' => 'B&agrave;i',
'articles_auteur' => 'B&agrave;i v&#7903; c&#7911;a t&aacute;c gi&#7843; n&agrave;y',
'articles_populaires' => 'Nh&#7919;ng b&agrave;i &#273;&#432;&#7907;c chu&#7897;ng nh&#7845;t',
'articles_recents' => 'Nh&#7919;ng b&agrave;i m&#7899;i nh&#7845;t',
'articles_rubrique' => 'B&agrave;i v&#7903; c&#7911;a &#273;&#7873; m&#7909;c n&agrave;y',
'aucun_article' => 'Kh&ocirc;ng c&oacute; b&agrave;i t&#7841;i &#273;&#7883;a ch&igrave; n&agrave;y  ',
'aucun_auteur' => 'Kh&ocirc;ng c&oacute; t&aacute;c gi&#7843; t&#7841;i &#273;&#7883;a ch&igrave; n&agrave;y',
'aucun_site' => 'Kh&ocirc;ng c&oacute; trang Web t&#7841;i &#273;&#7883;a ch&igrave; n&agrave;y ',
'aucune_breve' => 'Kh&ocirc;ng c&oacute; tin ng&#7855;n t&#7841;i &#273;&#7883;a ch&igrave; n&agrave;y',
'aucune_rubrique' => 'Kh&ocirc;ng c&oacute; &#273;&#7873; m&#7909;c t&#7841;i &#273;&#7883;a ch&igrave; n&agrave;y',
'autres_breves' => 'Nh&#7919;ng tin ng&#7857;n kh&aacute;c ',
'autres_groupes_mots_clefs' => 'Nh&#7919;ng nh&oacute;m t&#7915; then ch&#7889;t kh&aacute;c ',
'autres_sites' => 'Nh&#7919;ng trang Web kh&aacute;c',


// B
'bonjour' => 'Th&acirc;n ch&agrave;o',
'breves' => 'Tin ng&#7855;n',


// C
'commenter_site' => 'Ph&ecirc; b&igrave;nh trang Web n&agrave;y',


// D
'date' => 'Ng&agrave;y',
'dernier_ajout' => 'B&agrave;i &#273;&#432;&#7907;c th&ecirc;m sau ch&oacute;t',
'dernieres_breves' => 'Nh&#7919;ng tin ng&#7855;n m&#7899;i nh&#7845;t ',
'derniers_articles' => 'Nh&#7919;ng b&agrave;i m&#7899;i nh&#7845;t ',
'derniers_commentaires' => 'C&aacute;c g&oacute;p &yacute; m&#7899;i nh&#7845;t',
'derniers_messages_forum' => 'Trao &#273;&#7893;i m&#7899;i nh&#7845;t hi&#7879;n trong di&#7877;n &#273;&agrave;n',


// E
'edition_mode_texte' => 'v&#259;n b&#7843;n th&#432;&#7901;ng',
'en_reponse' => 'Tr&#7843; l&#7901;i cho&nbsp;:',
'en_resume' => 'T&oacute;m t&#7855;t',
'envoyer_message' => 'G&#7917;i th&#432; t&iacute;n m&#7899;i',
'espace_prive' => 'M&#7841;ng c&aacute; nh&acirc;n',


// F
'forum' => 'Di&#7877;n &#273;&agrave;n',


// H
'hierarchie_site' => 'C&#7845;u tr&uacute;c th&#7913; b&#7853;c c&#7911;a trang web',


// J
'jours' => 'ng&agrave;y',


// M
'meme_auteur' => 'C&ugrave;ng t&aacute;c gi&#7843;',
'meme_rubrique' => 'Trong c&ugrave;ng &#273;&#7873; m&#7909;c',
'memes_auteurs' => 'C&ugrave;ng t&aacute;c gi&#7843;',
'message' => 'Th&#432; t&iacute;n',
'messages_forum' => 'Th&#432; t&iacute;n di&#7877;n &#273;&agrave;n',
'messages_recents' => 'Tin m&#7899;i nh&#7845;t trong di&#7877;n &#273;&agrave;n',
'mots_clefs' => 'T&#7915; then ch&#7889;t',
'mots_clefs_meme_groupe' => 'T&#7915; then ch&#7889;t c&ugrave;ng nh&ograve;m  ',


// N
'navigation' => '&#272;i&#7873;u h&#432;&#7899;ng',
'nom' => 'T&ecirc;n',
'nouveautes' => 'Nh&#7919;ng &#273;i&#7875;m m&#7899;i',
'nouveautes_web' => 'Nh&#7919;ng &#273;i&#7873;u m&#7899;i tr&ecirc;n trang web',
'nouveaux_articles' => 'B&agrave;i m&#7899;i',
'nouvelles_breves' => 'Tin ng&#7855;n m&#7899;i',


// P
'page_precedente' => 'trang tr&#432;&#7899;c',
'page_suivante' => 'trang sau',
'par_auteur' => 'b&#7903;i',
'participer_site' => 'B&#7841;n c&oacute; th&#7875; tham gia &#273;&oacute;ng g&oacute;p t&iacute;ch c&#7921;c v&agrave;o trang web n&agrave;y &#273;&#7875; so&#7841;n v&agrave; &#273;&#259;ng b&agrave;i v&#7903;. B&#7841;n ph&#7843;i ghi danh d&#432;&#7899;i &#273;&acirc;y. Sau &#273;&oacute; b&#7841;n s&#7869; nh&#7853;n email cho bi&#7871;t chi ti&#7871;t &#273;&#7875; v&agrave;o trang web.',
'plan_site' => 'S&#417; &#273;&#7891;',
'popularite' => 'M&#7913;c &#273;&#7897; ph&#7893; th&ocirc;ng',
'poster_message' => '&#272;&#7875; &#273;&#259;ng tin',


// R
'repondre_article' => 'Tr&#7843; l&#7901;i b&agrave;i n&agrave;y',
'repondre_breve' => 'Tr&#7843; l&#7901;i tin ng&#7855;n n&agrave;y',
'repondre_message' => 'Tr&#7843; l&#7901;i m&#7851;u tin n&agrave;y',
'resultats_recherche' => 'K&#7871;t qu&#7843; t&igrave;m ki&#7871;m',
'retour_debut_forums' => 'Tr&#7903; v&#7873; trang &#273;&#7847;u c&#7911;a di&#7877;n &#273;&agrave;n',
'rubrique' => '&ETH;&#7873; M&#7909;c',
'rubriques' => '&ETH;&#7873; M&#7909;c',


// S
'signatures_petition' => 'Ch&#7919; k&yacute;',
'site_realise_avec_spip' => 'Trang web &#273;&#432;&#7907;c so&#7841;n b&#7857;ng SPIP',
'sites_web' => 'Trang web',
'sous_rubriques' => '&#272;&#7873; m&#7909;c ph&#7909;',
'suite' => 'ti&#7871;p t&#7909;c',
'sur_web' => 'Tr&ecirc;n trang web',
'syndiquer_rubrique' => 'Ph&#7893; bi&#7871;n &#273;&#7873; m&#7909;c n&agrave;y',
'syndiquer_site' => 'Ph&#7893; bi&#7871;n tr&#7885;n trang web',


// T
'texte_lettre_information' => '&#272;&acirc;y l&agrave; b&#7843;n tin c&#7911;a trang web',
'texte_lettre_information_2' => 'T&oacute;m t&#7855;t c&aacute;c b&agrave;i v&#7903; v&agrave; tin ng&#7855;n &#273;&atilde; ph&aacute;t h&agrave;nh t&#7915; ',


// V
'ver_imprimer' => 'Ki&#7875;u d&#7875; in',
'voir_en_ligne' => 'Xem online'

);


?>

--- NEW FILE: public_da.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Hjemmeside',
'articles' => 'Artikler',
'articles_auteur' => 'Denne forfatters artikler',
'articles_populaires' => 'De mest l&aelig;ste artikler',
'articles_recents' => 'De seneste artikler',
'articles_rubrique' => 'Dette omr&aring;des artikler',
'aucun_article' => 'Der er ingen artikel p&aring; denne adresse',
'aucun_auteur' => 'Der er ingen forfatter p&aring; denne adresse',
'aucun_site' => 'Der er intet websted p&aring; denne adresse',
'aucune_breve' => 'Der er ingen nyhed p&aring; denne adresse',
'aucune_rubrique' => 'Der er ikke noget afsnit p&aring; denne adresse',
'autres_breves' => 'Andre nyheder',
'autres_groupes_mots_clefs' => 'Andre grupper af n&oslash;gleord',
'autres_sites' => 'Andre websteder',


// B
'bonjour' => 'Hej',
'breves' => 'Nyheder',


// C
'commenter_site' => 'Kommentar til dette websted',


// D
'date' => 'Dato',
'dernier_ajout' => 'Seneste tilf&oslash;jelse',
'dernieres_breves' => 'Seneste nyhed',
'derniers_articles' => 'Seneste artikler',
'derniers_commentaires' => 'Seneste kommentarer',
'derniers_messages_forum' => 'Seneste indl&aelig;g offentliggjort i forummer',


// E
'edition_mode_texte' => 'Tekstudgave',
'en_reponse' => 'Svaradresse:',
'en_resume' => 'Opsummering',
'envoyer_message' => 'Lav indl&aelig;g',
'espace_prive' => 'Privat omr&aring;de',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Webstedets struktur',


// J
'jours' => 'dage',


// M
'meme_auteur' => 'Af samme forfatter',
'meme_rubrique' => 'I samme afsnit',
'memes_auteurs' => 'Af samme forfattere',
'message' => 'Indl&aelig;g',
'messages_forum' => 'Forumindl&aelig;g',
'messages_recents' => 'Seneste forumindl&aelig;g',
'mots_clefs' => 'N&oslash;gleord',
'mots_clefs_meme_groupe' => 'N&oslash;gleord i samme gruppe',


// N
'navigation' => 'Navigering',
'nom' => 'Navn',
'nouveautes' => 'Hvad nyt',
'nouveautes_web' => 'Hvad nyt p&aring; Internettet',
'nouveaux_articles' => 'Nye artikler',
'nouvelles_breves' => 'Nyheder',


// P
'page_precedente' => 'foreg&aring;ende side',
'page_suivante' => 'n&aelig;ste side',
'par_auteur' => 'af',
'participer_site' => 'Du kan deltage aktivt p&aring; dette websted og skrive dine egne artikler ved at tilmelde dig nedenfor. Du vil da straks modtage en email med en adgangskode til webstedets private omr&aring;de.',
'plan_site' => 'Indholdsoversigt',
'popularite' => 'Popularitet',
'poster_message' => 'Indl&aelig;g',


// R
'repondre_article' => 'Lav et svar til denne artikel',
'repondre_breve' => 'Lav et svar p&aring; denne nyhed',
'repondre_message' => 'Lav et svar p&aring; dette indl&aelig;g',
'resultats_recherche' => 'S&oslash;geresultater',
'retour_debut_forums' => 'Tilbage til starten p&aring; forummet',
'rubrique' => 'Afsnit',
'rubriques' => 'Afsnit',


// S
'signatures_petition' => 'Underskrifter',
'site_realise_avec_spip' => 'Websted lavet med SPIP',
'sites_web' => 'Websteder',
'sous_rubriques' => 'Underafsnit',
'suite' => 'forts&aelig;t',
'sur_web' => 'P&aring; Internettet',
'syndiquer_rubrique' => 'Syndiker dette afsnit',
'syndiquer_site' => 'Syndiker hele webstedet',


// T
'texte_lettre_information' => 'Her er webstedets nyhedsbrev',
'texte_lettre_information_2' => 'Dette brev opsummerer artikler og nyheder offentlliggjort siden',


// V
'ver_imprimer' => 'Printbar version',
'voir_en_ligne' => 'Se online'

);


?>

--- NEW FILE: spip_de.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://www.spip.net/de',
'0_langue' => 'Deutsch [de]',
'0_liste' => 'spip-de at rezo.net',
'0_mainteneur' => 'klaus at spip.de',


// A
'access_interface_graphique' => 'Zur&uuml;ck zur vollst&auml;ndigen grafischen Oberfl&auml;che',
'access_mode_texte' => 'vereinfachtes Interface als Textversion anzeigen',
'admin_modifier_article' => 'Artikel bearbeiten',
'admin_modifier_auteur' => 'Autor bearbeiten',
[...1495 lines suppressed...]
'trad_new' => 'Neue &Uuml;bersetzung dieses Artikels beginnen',
'trad_reference' => '(Referenzartikel)',


// U
'upload_fichier_zip' => 'ZIP-Datei',
'upload_fichier_zip_texte' => 'Sie m&ouml;chsten eine ZIP-Datei installieren.',
'upload_fichier_zip_texte2' => 'SPIP kann:',
'upload_limit' => 'Datei zu gross zum Hochladen. Maximale <i>upload</i>-Gr&ouml;sse: @max at .',
'upload_zip_decompacter' => 'Das ZIP-Archiv auspacken. Diese Dateien werden dann auf dem Server installiert:',
'upload_zip_telquel' => 'Das ZIP-Archiv als eine Archivdatei installieren.',


// V
'version_initiale' => 'Urspr&uuml;ngliche Fassung'

);


?>

--- NEW FILE: public_de.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Startseite',
'articles' => 'Artikel',
'articles_auteur' => 'Artikel dieses Autors',
'articles_populaires' => 'Die beliebtesten Artikel',
'articles_recents' => 'Die neuesten Artikel',
'articles_rubrique' => 'Artikel dieser Rubrik',
'aucun_article' => 'Unter dieser Adresse gibt es keinen Artikel.',
'aucun_auteur' => 'Unter dieser Adresse gibt es keinen Autor.',
'aucun_site' => 'Unter dieser Adresse gibt es keien Website.',
'aucune_breve' => 'Unter dieser Adresse gibt es keine Meldung.',
'aucune_rubrique' => 'Unter dieser Adresse gibt es keine Rubrik.',
'autres_breves' => 'Weitere Meldungen.',
'autres_groupes_mots_clefs' => 'Weitere Schlagwortgruppen',
'autres_sites' => 'Weitere Websites',


// B
'bonjour' => 'Hallo',
'breves' => 'Meldungen',


// C
'commenter_site' => 'Website kommentieren',


// D
'date' => 'Datum',
'dernier_ajout' => 'Letzter Eintrag',
'dernieres_breves' => 'Letzte Meldungen',
'derniers_articles' => 'Letzte Artikel',
'derniers_commentaires' => 'Letzte Kommentare',
'derniers_messages_forum' => 'Letzte Forumsbeitr&auml;ge',


// E
'edition_mode_texte' => 'Im Textmodus bearbeiten ',
'en_reponse' => 'Antwort auf:',
'en_resume' => 'Als Zusammenfassung',
'envoyer_message' => 'Nachricht senden',
'espace_prive' => 'Redaktion',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Baumstruktur der Website',


// J
'jours' => 'Tage',


// M
'meme_auteur' => 'Vom gleichen Autor',
'meme_rubrique' => 'In der gleichen Rubrik',
'memes_auteurs' => 'Von den gleichen Autoren',
'message' => 'Nachricht',
'messages_forum' => 'Forumsbeitr&auml;ge',
'messages_recents' => 'Neuste Forumsbeitr&auml;ge',
'mots_clefs' => 'Schlagworte',
'mots_clefs_meme_groupe' => 'Schlagworte der gleichen Kategorie',


// N
'navigation' => 'Navigation',
'nom' => 'Name',
'nouveautes' => 'Neuigkeiten',
'nouveautes_web' => 'Neues im WWW',
'nouveaux_articles' => 'Neue Artikel',
'nouvelles_breves' => 'Neue Meldungen',


// P
'page_precedente' => 'vorherige Seite',
'page_suivante' => 'nachfolgende Seite',
'par_auteur' => 'von ',
'participer_site' => 'Sie k&ouml;nnen bei dieser Website mitmachen, wenn Sie sich anmelden. Sie erhalten sofort eine E-Mail mit den Zugangsdaten zum Redaktionssystem.',
'plan_site' => 'Sitemap',
'popularite' => 'Beliebtheit',
'poster_message' => 'Nachricht senden',
'proposer_site' => 'Sie k&ouml;nnen in dieser Rubrik eine Seite vorschlagen&nbsp;:',


// R
'repondre_article' => 'auf diesen Artikel antworten',
'repondre_breve' => 'auf diese Meldung antworten',
'repondre_message' => 'auf diese Nachricht antworten',
'resultats_recherche' => 'Suchergebnis(se)',
'retour_debut_forums' => 'Zur&uuml;ck zum Beginn des Forums',
'rubrique' => 'Rubrik',
'rubriques' => 'Rubriken',


// S
'signatures_petition' => 'Unterschrift',
'site_realise_avec_spip' => 'Realisiert mit SPIP',
'sites_web' => 'Websites',
'sous_rubriques' => 'Unterrubriken',
'suite' => 'weiter',
'sur_web' => 'Im WWW',
'syndiquer_rubrique' => 'Diese Rubrik per RSS einbinden',
'syndiquer_site' => 'Die ganze Website mit RSS einbinden',


// T
'texte_lettre_information' => 'Dies ist der Newsletter der Website ',
'texte_lettre_information_2' => 'Diese Mail fasst die Neuerscheinungen seit diesem Zeitpunkt zusammen: ',


// V
'ver_imprimer' => 'Druckversion',
'voir_en_ligne' => 'Online ansehen'

);


?>

--- NEW FILE: public_oc_lnc.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// A
'accueil_site' => 'Acu&egrave;lh del sit',
'articles' => 'Articles',
'articles_auteur' => 'Articles d\'aquel autor',
'articles_populaires' => 'Los articles mai populars',
'articles_recents' => 'Los articles mai recents',
'articles_rubrique' => 'Articles d\'aquela rubrica',
'aucun_article' => 'I a pas cap d\'article a aquela adrei&ccedil;a ',
'aucun_auteur' => 'I a pas cap d\'autor a aquela adrei&ccedil;a ',
'aucun_site' => 'I a pas cap de sit a aquela adrei&ccedil;a ',
'aucune_breve' => 'I a pas cap de br&egrave;va a aquela adrei&ccedil;a ',
'aucune_rubrique' => 'I a pas cap de rubrica a aquela adrei&ccedil;a ',
'autres_breves' => 'Autras br&egrave;vas',
'autres_groupes_mots_clefs' => 'Autres grops de mots claus',
'autres_sites' => 'Autres sits',


// B
'bonjour' => 'Adieu-siatz',
'breves' => 'Br&egrave;vas',


// C
'commenter_site' => 'Comentar aquel sit',


// D
'date' => 'Data',
'dernier_ajout' => 'Darri&egrave;r apondon',
'dernieres_breves' => 'Darri&egrave;ras br&egrave;vas',
'derniers_articles' => 'Darri&egrave;rs articles',
'derniers_commentaires' => 'Darri&egrave;rs comentaris',
'derniers_messages_forum' => 'Darri&egrave;rs messatges publicats dins los forums',


// E
'edition_mode_texte' => 'Edicion en m&ograve;de t&egrave;xt de',
'en_reponse' => 'En responsa a:',
'en_resume' => 'En resumit',
'envoyer_message' => 'Mandar un messatge',
'espace_prive' => 'Espaci privat',


// F
'forum' => 'Forum',


// H
'hierarchie_site' => 'Ierarquia del sit',


// J
'jours' => 'jorns',


// M
'meme_auteur' => 'Del meteis autor',
'meme_rubrique' => 'Dins la meteissa rubrica',
'memes_auteurs' => 'Dels meteisses autors',
'message' => 'Messatge',
'messages_forum' => 'Messatges de forum',
'messages_recents' => 'Los messatges de forums mai recents',
'mots_clefs' => 'Mots claus',
'mots_clefs_meme_groupe' => 'Mots claus dins lo meteis grop',


// N
'navigation' => 'Navigacion',
'nom' => 'Nom',
'nouveautes' => 'Las novetats',
'nouveautes_web' => 'Novetats subre lo web',
'nouveaux_articles' => 'Articles n&ograve;us',
'nouvelles_breves' => 'Br&egrave;vas n&ograve;vas',


// P
'page_precedente' => 'pagina precedenta',
'page_suivante' => 'pagina seguenta',
'par_auteur' => 'per&nbsp;',
'participer_site' => 'Pod&egrave;tz participar a la vida d\'aquel sit e prepausar los articles v&ograve;stres en vos inscriure &ccedil;ai jos. Recebretz c&ograve;p sec un e-mail que vos indicar&agrave; v&ograve;stres c&ograve;des per accedir a l\'espaci privat del sit.',
'plan_site' => 'Plan del sit',
'popularite' => 'Popularitat',
'poster_message' => 'Postar un messatge',


// R
'repondre_article' => 'Respondre a aquel article',
'repondre_breve' => 'Respondre a aquela br&egrave;va',
'repondre_message' => 'Respondre a aquel messatge',
'resultats_recherche' => 'Resultats de la rec&egrave;rca',
'retour_debut_forums' => 'Retorn al comen&ccedil;ament dels forums',
'rubrique' => 'Rubrica',
'rubriques' => 'Rubricas',


// S
'signatures_petition' => 'Signaturas',
'site_realise_avec_spip' => 'Sit realizat amb SPIP',
'sites_web' => 'Sits web',
'sous_rubriques' => 'Sosrubricas',
'suite' => 'seguida',
'sur_web' => 'Subre lo web',
'syndiquer_rubrique' => 'Sindicar aquela rubrica',
'syndiquer_site' => 'Sindicar tot lo sit',


// T
'texte_lettre_information' => 'Vaic&iacute; la letra d\'informacion del sit',
'texte_lettre_information_2' => 'Aquela letra recensa los articles e br&egrave;vas publicats dempu&egrave;i',


// V
'ver_imprimer' => 'Version d\'estampar',
'voir_en_ligne' => 'Vejatz en linha'

);


?>

--- NEW FILE: spip_oc_ni.php3 ---
<?php

// This is a SPIP language file  --  Ceci est un fichier langue de SPIP

$GLOBALS[$GLOBALS['idx_lang']] = array(


// 0
'0_URL' => 'http://listes.rezo.net/mailman/listinfo/spip-oc',
'0_langue' => 'Ni&ccedil;ard [oc_ni]',
'0_liste' => 'spip-oc at rezo.net',
'0_mainteneur' => 'S&eacute;bastien Donato&nbsp;: seb at ogcn.net',


// A
'access_interface_graphique' => '<NEW>Retour &agrave; l\'interface graphique compl&egrave;te',
'access_mode_texte' => '<NEW>Afficher l\'interface textuelle simplifi&eacute;e',
'admin_modifier_article' => 'Modificar aquel article',
'admin_modifier_auteur' => 'Modificar aquel autor',
[...1617 lines suppressed...]
'trad_new' => 'Escriure una nov&egrave;la revirada d\'aquel article',
'trad_reference' => '(article de referen&ccedil;a)',


// U
'upload_fichier_zip' => 'Fichi&egrave;r ZIP',
'upload_fichier_zip_texte' => 'Lo fichi&egrave;r que prepausatz d\'installar es un fichi&egrave;r ZIP.',
'upload_fichier_zip_texte2' => 'Aqu&egrave;u fichi&egrave;r p&ograve;ut &egrave;stre:',
'upload_limit' => 'Aqu&egrave;u fichi&egrave;r es tr&ograve;p gr&ograve;s per lo servidor; la talha maximala autorisada en <i>upload</i> es de @max at .',
'upload_zip_decompacter' => 'descomprimit e cada element que conten installat sus lo sit. Alora lu fichi&egrave;rs que ser&agrave;n installats sus lo sit son:',
'upload_zip_telquel' => '<NEW>install&eacute; tel quel, en tant qu\'archive compress&eacute;e Zip&nbsp;;',


// V
'version_initiale' => 'Version iniciala'

);


?>



From stef at berlios.de  Thu Jan 20 11:15:53 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:15:53 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/oo index.php,NONE,1.1 index.php3,NONE,1.1
Message-ID: <200501201015.j0KAFrOp025843@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/oo
In directory sheep:/tmp/cvs-serv25615/ecrire/oo

Added Files:
	index.php index.php3 
Log Message:
proto1.1

--- NEW FILE: index.php ---
<?php

// ACCESSIBILITE
// la page /oo offre une lecture en mode "texte seul"
// des 3 articles les plus recents...

@header("Location: ../index.php3?set_disp=4&set_options=basiques");

?>

--- NEW FILE: index.php3 ---
<?php

// ACCESSIBILITE
// la page /oo offre une lecture en mode "texte seul"
// des 3 articles les plus recents...

@header("Location: ../index.php3?set_disp=4&set_options=basiques");

?>



From stef at berlios.de  Thu Jan 20 11:20:39 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:20:39 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire inc_statistiques.php3,1.1,1.2
Message-ID: <200501201020.j0KAKdOp026079@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire
In directory sheep:/tmp/cvs-serv26073/ecrire

Modified Files:
	inc_statistiques.php3 
Log Message:
proto1.1

Index: inc_statistiques.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/inc_statistiques.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_statistiques.php3	13 Jan 2005 16:04:32 -0000	1.1
+++ inc_statistiques.php3	20 Jan 2005 10:20:37 -0000	1.2
@@ -101,8 +101,7 @@
 				$keywords = "";
 			}
 						
-			if ((($kw_referer_host == "Google" &&
-				ereg('[io]e=([-a-z0-9]+)', strtolower($query), $regs))
+			if ((  ($kw_referer_host == "Google")
 				|| ($kw_referer_host == "AOL" && !ereg('enc=iso', $query))
 				|| ($kw_referer_host == "MSN")
 				)) {



From stef at berlios.de  Thu Jan 20 11:20:59 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:20:59 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire inc_version.php3,1.1,1.2
Message-ID: <200501201020.j0KAKxOp026096@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire
In directory sheep:/tmp/cvs-serv26088/ecrire

Modified Files:
	inc_version.php3 
Log Message:
proto1.1

Index: inc_version.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/inc_version.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_version.php3	13 Jan 2005 16:04:32 -0000	1.1
+++ inc_version.php3	20 Jan 2005 10:20:57 -0000	1.2
@@ -341,11 +341,6 @@
 define_once('_ACCESS_FILE_NAME', '.htaccess');
 define_once('_AUTH_USER_FILE', '.htpasswd');
 
-# obsoletes: utiliser les constantes ci-dessus.
-# Conserver pour compatibit? vieilles contrib uniquement
-
-$flag_ecrire = !@file_exists(_DIR_RESTREINT_ABS . 'inc_version.php3');
-$dir_ecrire = (ereg("/ecrire/", $GLOBALS['REQUEST_URI'])) ? '' : 'ecrire/';
 
 // Version courante de SPIP
 // Stockee sous forme de nombre decimal afin de faciliter les comparaisons
@@ -496,17 +491,22 @@
 //
 
 // Compatibilite avec serveurs ne fournissant pas $REQUEST_URI
-if (!$REQUEST_URI) {
+if (!$REQUEST_URI)
 	$REQUEST_URI = $PHP_SELF;
-	if (!strpos($REQUEST_URI, '?') && $QUERY_STRING)
-		$REQUEST_URI .= '?'.$QUERY_STRING;
-}
+if ($QUERY_STRING AND !strpos($REQUEST_URI, '?'))
+	$REQUEST_URI .= '?'.$QUERY_STRING;
 
 if (!$PATH_TRANSLATED) {
 	if ($SCRIPT_FILENAME) $PATH_TRANSLATED = $SCRIPT_FILENAME;
 	else if ($DOCUMENT_ROOT && $SCRIPT_URL) $PATH_TRANSLATED = $DOCUMENT_ROOT.$SCRIPT_URL;
 }
 
+# obsoletes: utiliser les constantes ci-dessus.
+# Conserver pour compatibit? vieilles contrib uniquement
+$flag_ecrire = !@file_exists(_DIR_RESTREINT_ABS . 'inc_version.php3');
+$dir_ecrire = (ereg("/ecrire/", $GLOBALS['REQUEST_URI'])) ? '' : 'ecrire/';
+
+// API d'appel a la base de donnees
 function spip_query($query) {
 	if (!_FILE_CONNECT)  {$GLOBALS['db_ok'] = false; return;}
 	include_local(_FILE_CONNECT);



From stef at berlios.de  Thu Jan 20 11:21:45 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:21:45 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire inc_mots.php3,1.1,1.2 articles_edit.php3,1.1,1.2 inc_filtres.php3,1.1,1.2 statistiques_visites.php3,1.1,1.2 inc_carto.php3,1.1,1.2 inc_mail.php3,1.1,1.2 carte_edit.php3,1.1,1.2 mots_type.php3,1.1,1.2
Message-ID: <200501201021.j0KALjOp026146@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire
In directory sheep:/tmp/cvs-serv26140/ecrire

Modified Files:
	inc_mots.php3 articles_edit.php3 inc_filtres.php3 
	statistiques_visites.php3 inc_carto.php3 inc_mail.php3 
	carte_edit.php3 mots_type.php3 
Log Message:
proto1.1

Index: inc_mots.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/inc_mots.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_mots.php3	13 Jan 2005 16:16:22 -0000	1.1
+++ inc_mots.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -109,7 +109,17 @@
 		$objet = 'syndic';
 		$url_base = "sites.php3?id_syndic=$id_objet";
 	}
-
+	/////////////////////////////////
+	//MODIFICATION
+	////////////////////////////////
+	else if ($table == 'carto_objets') {
+		$id_table = 'id_carto_objet';
+		$objet = 'carto_objet';
+		$url_base = "carte_edit.php3?id_carte=".$id_objet['id_carte']."&id_objet=".$id_objet['id_objet'];
+		$id_objet=$id_objet['id_objet'];
+	}
+	////////////////////////////////
+	
 	$query = "SELECT mots.* FROM spip_mots AS mots, spip_mots_$table AS lien WHERE lien.$id_table=$id_objet AND mots.id_mot=lien.id_mot";
 	$nombre_mots = spip_num_rows(spip_query($query));
 
@@ -118,12 +128,12 @@
 
 	if (!$nombre_mots AND (!$nombre_groupes OR !$flag_editable)) return;
 
-	echo "<a name='mots'></a>";
+	echo "<a name='mots".$id_objet."'></a>";
 	if ($flag_editable){
 		if ($nouv_mot.$cherche_mot.$supp_mot)
-			$bouton = bouton_block_visible("lesmots");
+			$bouton = bouton_block_visible("lesmots".$id_objet);
 		else
-			$bouton =  bouton_block_invisible("lesmots");
+			$bouton =  bouton_block_invisible("lesmots".$id_objet);
 	}
 	debut_cadre_enfonce("mot-cle-24.gif", false, "", $bouton._T('titre_mots_cles').aide ("artmots"));
 
@@ -191,7 +201,7 @@
 					echo "<LI><FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2><B><FONT SIZE=3>".typo($titre_mot)."</FONT></B>";
 
 					if ($type_mot) echo " ($type_mot)";
-					echo " | <A HREF=\"$url_base&nouv_mot=$id_mot#mots\">"._T('info_ajouter_mot')."</A>";
+					echo " | <A HREF=\"$url_base&nouv_mot=$id_mot#mots$id_objet\">"._T('info_ajouter_mot')."</A>";
 
 					if (strlen($descriptif_mot) > 1) {
 						echo "<BR><FONT SIZE=1>".propre(couper($descriptif_mot, 100))."</FONT>\n";
@@ -304,14 +314,14 @@
 				$couleur="#EDF3FE";
 			}
 	
-			$url = "mots_edit.php3?id_mot=$id_mot&redirect=".rawurlencode($url_base.'#mots');
+			$url = "mots_edit.php3?id_mot=$id_mot&redirect=".rawurlencode($url_base.'#mots'.$id_objet);
 	
 			$vals[] = "<A HREF='$url'>" . http_img_pack('petite-cle.gif', "", "width='23' height='12' border='0'") ."</A>";
 			
 	
 			// Changer
 			if ($unseul == "oui" AND $flag_groupe) {
-				$s = "<form action='$url_base#mots' method='post' style='margin:0px; padding: 0px'>";
+				$s = "<form action='$url_base#mots$id_objet' method='post' style='margin:0px; padding: 0px'>";
 				$s .= "<INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'>";
 				if ($table == 'rubriques') $s .= "<INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'>";
 				$s .= "<select name='nouv_mot' onChange=\"setvisibility('valider_groupe_$id_groupe', 'visible');\" CLASS='fondl' STYLE='font-size:10px; width:90px;'>";
@@ -343,7 +353,7 @@
 			if ($flag_editable){
 				$s = "";
 				if ($flag_groupe)
-				  $s .= "<A HREF=\"$url_base&supp_mot=$id_mot#mots\">"._T('info_retirer_mot')."&nbsp;" . http_img_pack('croix-rouge.gif', "X", "width='7' height='7' border='0' align='middle'") ."</A>";
+				  $s .= "<A HREF=\"$url_base&supp_mot=$id_mot#mots$id_objet\">"._T('info_retirer_mot')."&nbsp;" . http_img_pack('croix-rouge.gif', "X", "width='7' height='7' border='0' align='middle'") ."</A>";
 				else $s .= "&nbsp;";
 			}
 			$vals[] = $s;
@@ -379,9 +389,9 @@
 
 	if ($flag_editable) {
 		if ($nouveaux_mots.$cherche_mot.$supp_mot)
-			echo debut_block_visible("lesmots");
+			echo debut_block_visible("lesmots".$id_objet);
 		else if ($nb_groupes > 0) {
-			echo debut_block_visible("lesmots");
+			echo debut_block_visible("lesmots".$id_objet);
 			// vilain hack pour redresser un triangle
 			$couche_a_redresser = $GLOBALS['numero_block']['lesmots'];
 			if ($GLOBALS['browser_layer']) echo http_script("
@@ -389,16 +399,16 @@
 if (triangle) triangle.src = '" . _DIR_IMG_PACK . "deplierbas$spip_lang_rtl.gif';");
 		}
 		else
-			echo debut_block_invisible("lesmots");
+			echo debut_block_invisible("lesmots".$id_objet);
 
 		if ($nombre_mots_associes > 3) {
 			echo "<div align='right' class='arial1'>";
-			echo "<a href=\"$url_base&supp_mot=-1#mots\">"._T('info_retirer_mots')."</a>";
+			echo "<a href=\"$url_base&supp_mot=-1#mots$id_objet\">"._T('info_retirer_mots')."</a>";
 			echo "</div><br />\n";
 		}
 
 
-		$form_mot = "<FORM ACTION='$url_base#mots' METHOD='post' STYLE='margin:1px;'>"
+		$form_mot = "<FORM ACTION='$url_base#mots$id_objet' METHOD='post' STYLE='margin:1px;'>"
 			."<INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'>";
 
 		if ($table == 'rubriques') $form_mot .= "<INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'>";

Index: articles_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/articles_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- articles_edit.php3	13 Jan 2005 16:04:32 -0000	1.1
+++ articles_edit.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -205,12 +205,9 @@
 ///////////////////////////
 //MODIFICATION
 ///////////////////////////
-	if (lire_meta('activer_forms') == 'oui'){
-		include_ecrire ("inc_forms.php3");
-		afficher_insertion_formulaire($id_article);
-	}
+	creer_colonne_droite();
 	if (lire_meta('activer_carto') == 'oui'){
-		//include_ecrire ("inc_carto.php3");
+		include_ecrire ("inc_carto.php3");
 		afficher_insertion_carte($id_article);
 	}
 ////////////////////////////

Index: inc_filtres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/inc_filtres.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_filtres.php3	13 Jan 2005 16:04:32 -0000	1.1
+++ inc_filtres.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -261,7 +261,11 @@
 
 // |choixsivide{vide,pasvide} affiche pasvide si la chaine n'est pas vide...
 
-function choixsivide($a, $vide, $pasvide) {return $a ? $pasvide : $vide;}
+function choixsivide($a, $vide, $pasvide)
+{
+  spip_log("choix '$a'" . $a ? $pasvide : $vide);
+  return $a ? $pasvide : $vide;
+}
 
 // |choixsiegal{aquoi,oui,non} affiche oui si la chaine est egal a aquoi ...
 function choixsiegal($a1,$a2,$v,$f) {return ($a1 == $a2) ? $v : $f;}
@@ -746,6 +750,17 @@
 		. "</script>\n"
 		. (!$noscript ? '' : "<noscript>\n\t$noscript\n</noscript>\n");
 }
+
+/* dans les squelettes a present.
+function http_script_window_close() {
+  return http_script('
+document.write("<br /><div align=\'right\'><a href=\'")
+document.write((window.opener) ? "javascript:close()" : "./")
+document.write("\'>' . _T('pass_quitter_fenetre') . '<" + "/a></div>")',
+	      '',
+	      "&#91;<a href='./'><:pass_retour_public:></a>&#93");
+}
+*/
 
 function inscriptionok($site, $mode)
 {

Index: statistiques_visites.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/statistiques_visites.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- statistiques_visites.php3	13 Jan 2005 16:16:22 -0000	1.1
+++ statistiques_visites.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -359,7 +359,7 @@
 						$tab_moyenne[$decal] = $value;
 	
 						$ce_jour=date("Y-m-d", $jour_prec+(3600*24*($i+1)));
-						$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
+						$jour = nom_jour($ce_jour).' '.affdate_jourcourt($ce_jour);
 	
 						reset($tab_moyenne);
 						$moyenne = 0;
@@ -386,7 +386,7 @@
 				}
 	
 				$ce_jour=date("Y-m-d", $key);
-				$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
+				$jour = nom_jour($ce_jour).' '.affdate_jourcourt($ce_jour);
 	
 				$total_loc = $total_loc + $value;
 				reset($tab_moyenne);

Index: inc_carto.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/inc_carto.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_carto.php3	13 Jan 2005 16:16:22 -0000	1.1
+++ inc_carto.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -4,11 +4,18 @@
 // Ce fichier ne sera execute qu'une fois
 if (defined("_ECRIRE_INC_CARTE")) return;
 define("_ECRIRE_INC_CARTE", "1");
-
-function embed_map_url($id_carte, $url_parse) {
+function coords2wtk($selection_type,$selection_coords){
+	
+	return $selection_type."(".$selection_coords.")";
+}
+function embed_carto_url($id_carte, $url_parse) {
 	$lURL = $url_parse['path']."/carto.php3?id_carte=".$id_carte."&scale=".$_GET['scale']."&x=".$_GET['x']."&y=".$_GET['y'];
 	return $lURL;
 }
+function embed_fond_carte_url($fond_carte) {
+	$lURL = "../spip_carto.php?fond_carte=".$fond_carte."&scale=".$_GET['scale']."&x=".$_GET['x']."&y=".$_GET['y'];
+	return $lURL;
+}
 
 function afficher_cartes($titre_table, $requete, $icone = '') {
 	global $couleur_claire, $couleur_foncee;
@@ -77,12 +84,17 @@
 	return $tous_id;
 }
 
+
 function afficher_carte_inteface($fichier,$id_carte,$width,$height) {
 	$returned='<script type="text/javascript" src="js/x_core_nn4.js"></script>
 <script type="text/javascript" src="js/x_dom_nn4.js"></script>
 <script type="text/javascript" src="js/x_event_nn4.js"></script>
 <script type="text/javascript" src="js/navTools.js"></script>
 <script type="text/javascript" src="js/graphTools.js"></script>
+<form method="get" action="#objet_visible" name="carto_form">
+ <table border="1">
+  <tr> 
+   <td colspan="7">
 <script type="text/javascript">
 /*<![CDATA[*/ 
     var dhtmlDivs = new String();
@@ -126,7 +138,7 @@
       
       // map units values
 	  // dynamically given by the server
-      dhtmlBox.mapHeight = 300;
+      dhtmlBox.mapHeight = '.$height.';
       dhtmlBox.boxx = 470000;
       dhtmlBox.boxy = 46300;
       dhtmlBox.pixel_size = 924.83333333334;
@@ -146,37 +158,49 @@
     }
 	/*]]>*/
   </script>
-<form method="get" action="#" name="carto_form">
-  <table>
-    <tr> 
-      <td> <input type="hidden" name="id_carte" value="'.$id_carte.'"/> <input type="hidden" name="selection_type" /> <input type="hidden" name="selection_coords" /> 
-        <div id="mapAnchorDiv" style="position:relative; width:'.$width.'px; height:'.$height.'px;"> 
-          <table>
-            <tr> 
-              <td align="center" valign="middle" width="'.$width.'px" height="'.$height.'px"><div id="loadbar">Loading 
-                  message</div></td>
-            </tr>
-          </table>
-        </div></td>
-      <td> <p> 
-          <!-- input value use : shapeType,action,cursorStyle,toolName (with no blank spaces!)-->
-          <input type="radio" name="tool" value="rectangle,submit,crossHair,zoom_in"  checked="checked"  id="zoom_in" onclick="dhtmlBox.changeTool()" />
+    <input type="hidden" name="id_carte" value="'.$id_carte.'"/>
+	<input type="hidden" name="selection_type" />
+	<input type="hidden" name="selection_coords" />
+	<div id="mapAnchorDiv" style="position:relative; width:'.$width.'px; height:'.$height.'px;"> 
+     <table>
+      <tr> 
+       <td align="center" valign="middle" width="'.$width.'px" height="'.$height.'px">
+		<div id="loadbar">Loading message</div>
+	   </td>
+      </tr>
+     </table>
+    </div>
+   </td>
+  </tr>
+  <tr>
+   <td> 
+    <input type="radio" name="tool" value="rectangle,submit,crossHair,zoom_in"  id="zoom_in" onclick="dhtmlBox.changeTool()" />
           zoom_in<br />
-          <input type="radio" name="tool" value="point,submit,crossHair,zoom_out"  id="zoom_out" onclick="dhtmlBox.changeTool()" />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="point,submit,crossHair,zoom_out"  id="zoom_out" onclick="dhtmlBox.changeTool()" />
           zoom out<br />
-          <input type="radio" name="tool" value="pan,submit,move,pan"  id="pan" onclick="dhtmlBox.changeTool()" />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="pan,submit,move,pan"  id="pan" onclick="dhtmlBox.changeTool()" />
           pan<br />
-          <input type="radio" name="tool" value="rectangle,submit,help,query"  id="query" onclick="dhtmlBox.changeTool()" />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="rectangle,submit,help,query"  id="query" onclick="dhtmlBox.changeTool()" />
           query<br />
-          <input type="radio" name="tool" value="point,submit,crossHair,point"   id="point" onclick="dhtmlBox.changeTool()" />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="point,submit,crossHair,point"   id="point" onclick="dhtmlBox.changeTool()" />
           line submit<br />
-          <input type="radio" name="tool" value="line,submit,crossHair,line"   id="line" onclick="dhtmlBox.changeTool()" />
+   </td>
+   <td>
+    <input type="radio" name="tool" value="line,submit,crossHair,line"   id="line" onclick="dhtmlBox.changeTool()" />
           line submit<br />
-          <input type="radio" name="tool" value="polygon,submit,crossHair,polygon"   id="toto" onclick="dhtmlBox.changeTool()" />
+          </td><td><input type="radio" name="tool" value="polygon,submit,crossHair,polygon"   checked="checked"  id="polygon" onclick="dhtmlBox.changeTool()" />
           polygon submit<br />
-        </p></td>
-    </tr>
-  </table>
+   </td>
+  </tr>
+ </table>
 </form>';
 	return $returned;
 }

Index: inc_mail.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/inc_mail.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- inc_mail.php3	13 Jan 2005 16:16:22 -0000	1.1
+++ inc_mail.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -23,8 +23,11 @@
 	$hebergeur = 'altern';
 }
 // Free
-else if (ereg('^/([^/]*)\.free.fr/', $REQUEST_URI, $regs)) {
-	$hebergeur = 'free';
+else if (ereg('free\.fr$', $SERVER_NAME)) {
+		$hebergeur = 'free';
+//		$login_hebergeur = substr($SERVER_NAME,0,strlen($SERVER_NAME)-8);
+//(ereg('^/([^/]*)\.free.fr/', $REQUEST_URI, $regs)) {
+//	$hebergeur = 'free';
 }
 // NexenServices
 else if ($SERVER_ADMIN == 'www at nexenservices.com') {
@@ -119,7 +122,9 @@
 			'headers' => $headers);
 		return true;
 	case 'free':
-		return false;
+		//return false;
+		include("ecrire/lib.protomail.php");
+		return @protomail($email, $sujet, $texte);
 	case 'online':
 		return @email('webmaster', $email, $sujet, $texte);
 	default:

Index: carte_edit.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/carte_edit.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- carte_edit.php3	13 Jan 2005 16:04:32 -0000	1.1
+++ carte_edit.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -1,15 +1,19 @@
 <?php
 
 include ("inc.php3");
+include_ecrire ("inc_documents.php3");
+include_ecrire ("inc_mots.php3");
 include_ecrire("inc_carto.php3");
 //TODO : voir integration d'une option de configuration de Spip
 //bof, je prefere attendre d'avoir un systeme de gestion des modules
 //meme si il faut le faire ...
 //include_ecrire("inc_config.php3");
-//TODO : preparer les donn?es pass?es en POST par l'interface DHTML
-//et par le formulaire contenant les donn?es de la carte
 
+$flag_editable=carte_editable($id_carte);
 $id_carte = intval($id_carte);
+$flag_mots = lire_meta("carto_mots");
+//$flag_mots = "oui";
+$nouveau=false;
 //
 // Modifications aux donnees de base de la carte
 //
@@ -22,7 +26,7 @@
 	}
 }
 
-if (carte_editable($id_carte)) {
+if ($flag_editable) {
 	if ($new == 'oui') {
 		$titre = _L("Nouvelle carte");
 		$fichier = "";
@@ -32,10 +36,6 @@
 		$js_titre = " onfocus=\"if(!antifocus){this.value='';antifocus=true;}\"";
 		spip_query("INSERT INTO spip_carto_carte (titre) VALUES ('".addslashes($titre)."')");
 		$id_carte = spip_insert_id();
-		//TODO : normalement pas besoin de ca ...
-		//on continue et normalement c'est bon
-		//Header("Location: carte_edit.php3?id_carte=$id_carte");
-		//exit;
 	}
 
 	else {
@@ -47,6 +47,7 @@
 			"callage='".addslashes($callage)."', ".
 			"id_srs='".intval($id_srs)."' ".
 			"WHERE id_carte=$id_carte";
+
 			$result = spip_query($query);
 		}
 		if ($id_carte) {
@@ -68,21 +69,24 @@
 		
 
 
-$carte_link = new Link("carte_edit.php3?id_carte=$id_carte");
+$carte_link = new Link("carte_edit.php3");
+$carte_link->addVar('id_carte', $id_carte);
 if ($retour) $carte_link->addVar('retour', $retour);
 
 //
 // Modifications des objets de la carte
 //
 
-if ($id_carte && carte_editable($id_carte)) {
+if ($id_carte && $flag_editable) {
 
 	// Ajout d'un objet
-	if ($selection_type=='polygon') {
-		$geometrie=$selection_type."(".$selection_coords.")";
+	if ($selection_type) {
+		$geometrie=coords2wtk($selection_type,$selection_coords);
 		$objet_titre = _L("Nouvel objet");
 		spip_query("INSERT INTO spip_carto_objet (id_carte,titre,geometrie) VALUES (".$id_carte.",'".addslashes($objet_titre)."','".$geometrie."')");
 		$id_objet = spip_insert_id();
+		$objet_visible=$id_objet;
+		$nouveau=true;
 	}
 	// Modif d'un objet
 	if ($modif_objet) {
@@ -95,8 +99,12 @@
 			"geometrie='".addslashes($geometrie)."' ".
 			"WHERE id_objet=$modif_objet";
 			$result = spip_query($query);
-		
+			$objet_visible=$modif_objet;
 	}
+	if ($id_objet) {
+			$objet_visible=$id_objet;
+	}
+	
 
 	// Suppression d'un objet
 	if ($supp_objet) {
@@ -112,20 +120,28 @@
 //
 
 debut_page("&laquo; $titre &raquo;", "documents", "cartes");
+
 debut_gauche();
 
-echo "<br /><br />\n";
+
+
+//
+// Pave "documents associes a l'article"
+//
+
+if ($new != 'oui'){
+	afficher_documents_colonne($id_carte, 'carto_carte', true);
+}
 
 
 debut_droite();
 
 if ($supp_carte && !$supp_confirme && !$supp_rejet) {
 	echo "<p><strong>"._L("Attention :")."</strong> ";
-	echo _L("Des objets ont &eacute;t&eacute; attach&eacute;s &agrave; cette carte. ".
-		"Voulez-vous vraiment le supprimer ?")."</p>\n";
-	$link = new Link();
+	echo _L("Voulez-vous vraiment supprimer cette carte ?")."</p>\n";
+	$link = $carte_link;//new Link();
 	$link->addVar('supp_carte', $supp_carte);
-	echo $link->getform('GET');
+	echo $link->getform('POST');
 	echo "<input type='submit' name='supp_confirme' value=\""._T('item_oui')."\" class='fondl'>";
 	echo " &nbsp; ";
 	echo "<input type='submit' name='supp_rejet' value=\""._T('item_non')."\" class='fondl'>";
@@ -134,7 +150,7 @@
 
 
 if ($id_carte) {
-	debut_cadre_relief("carte-24.png");
+	debut_cadre_relief("carte-24.gif");
 	echo "<br/>";
 	gros_titre($titre);
 	
@@ -149,35 +165,35 @@
 		echo "<br />";
 		debut_cadre_relief();
 		
-		echo "<div style='padding: 2px; background-color: $couleur_claire; color: black;'>&nbsp;";
-		echo bouton_block_visible("dhtml_carte");
+		//echo "<div style='padding: 2px; background-color: $couleur_claire; color: black;'>&nbsp;";
+		/*echo ($modif_carte == $id_carte) ? bouton_block_visible("dhtml_carte") : bouton_block_invisible("dhtml_carte");
 		echo "<strong class='verdana3' style='text-transform: uppercase;'>"
 			._L("Apparence du carte")."</strong>";
 		echo "</div>\n";
 		
-		echo debut_block_visible("dhtml_carte");
-		echo _L("Cr&eacute;ation d'objets.")."<p>\n";
-		echo "<div style='margin: 10px; padding: 10px; border: 1px dashed $couleur_foncee;'>";
+		echo ($modif_carte == $id_carte) ? debut_block_visible("dhtml_carte") : debut_block_invisible("dhtml_carte");
+		*/
+		echo _L("Cr&eacute;ation d'objets.")."\n";
+		//echo "<div style='margin: 10px; padding: 10px; border: 1px dashed $couleur_foncee;'>";
 		
 		//remplacer id par appel ? spip_carte
 		//TODO : gerer zoom et position
-		if (intval($fichier)>0) $lefichier="../spip_carto.php?id_carte=".intval($fichier);
-		else $lefichier=$fichier;
+		//if (intval($fichier)>0) $lefichier="../spip_carto.php?fond_carte=".intval($fichier);
+		//else $lefichier=$fichier;
+		$lefichier="../spip_carto.php?fond_carte=".entites_html($fichier);
 		echo afficher_carte_inteface($lefichier,$id_carte,"400","300");
 		
-		echo "</div>\n";
-		echo fin_block();
+		//echo "</div>\n";
+		//echo fin_block();
 		
 		fin_cadre_relief();
 	}
-	/*
-	//articles li?s g?r?s ? la sauvegarde du contenu dans articles.php3 : 
-	//relecture du contenu de l'article puis delete / insert des liaisons
-	//de cet article
+	
+	//articles li?s
 	afficher_articles(_L("Articles utilisant cette carte"),
 		", spip_carto_carte_articles AS lien WHERE lien.id_article=articles.id_article ".
 		"AND id_carte=$id_carte AND statut!='poubelle' ORDER BY titre");
-	*/
+	
 	
 	fin_cadre_relief();
 }
@@ -200,9 +216,9 @@
 	if (!$retour) {
 		$link->addVar('retour', 'cartes.php3');
 	}
-	if (!$nb_reponses) {
-		$link->addVar('supp_confirme', 'oui');
-	}
+	//if (!$nb_reponses) {
+	//	$link->addVar('supp_confirme', 'oui');
+	//}
 	icone(_L("Supprimer cette carte"), $link->getUrl(), "carte-24.gif", "supprimer.gif");
 	echo "</div>\n";
 }
@@ -211,14 +227,14 @@
 //
 // Edition des donnees de la carte
 //
-if (carte_editable($id_carte)) {
+if ($flag_editable) {
 	echo "<p>";
 	debut_cadre_formulaire();
 
 	echo "<div class='verdana2'>";
 	$link = $carte_link;
 	$link->addVar('modif_carte', $id_carte);
-	echo $link->getForm('GET');
+	echo $link->getForm('POST');
 	
 	$titre= entites_html($titre);
 	$fichier= $fichier;
@@ -263,7 +279,7 @@
 	// Modifier / supprimer les objets
 	//
 	if ($id_carte) {
-		echo "<a name='objetss'></a>";
+		echo "<a name='objets'></a>";
 		echo "<p><hr><p>\n";
 		echo "<div class='verdana3'>";
 		echo "<strong>"._L("Objets de la carte")."</strong><br />\n";
@@ -281,21 +297,22 @@
 		$logo_objet = $t['logo'];
 		$geometrie = entites_html($t['geometrie']);
 
-		$nouveau = ($id_objet == $nouveau_objet);
+		$visible = ($id_objet == $objet_visible);
 		if ($nouveau) echo "<a name='nouveau_objet'></a>";
+		else if ($visible) echo "<a name='objet_visible'></a>";
 		echo "<p>\n";
 		debut_cadre_relief();
 		echo "<div style='padding: 2px; background-color: $couleur_claire; color: black;'>&nbsp;";
 		
-		echo $nouveau ? bouton_block_visible("objet_$id_objet") : bouton_block_invisible("objet_$id_objet");
+		echo $visible ? bouton_block_visible("objet_$id_objet") : bouton_block_invisible("objet_$id_objet");
 		echo "<strong>".$titre_objet."</strong>";
 		echo "<br /></div>";
-		echo $nouveau ? debut_block_visible("objet_$id_objet") : debut_block_invisible("objet_$id_objet");
+		echo $visible ? debut_block_visible("objet_$id_objet") : debut_block_invisible("objet_$id_objet");
 			
 			// Modifier un objet
 			$link = $carte_link;
 			$link->addVar('modif_objet', $id_objet);
-			echo $link->getForm('GET', 'objet_visible');
+			echo $link->getForm('POST', 'objet_visible');
 			echo "<div class='verdana2'>";
 			echo "<p>";
 			if ($nouveau) {
@@ -334,6 +351,14 @@
 			echo "<input type='submit' name='Valider' value='"._T('bouton_valider')."' class='fondo verdana2'></div>\n";
 			echo "</div>\n";
 			echo "</form>";
+			
+			if ($flag_mots!='non' AND $options == 'avancees') {
+				$tab_id['id_carte']=$id_carte;
+				$tab_id['id_objet']=$id_objet;
+				//TODO : passer les ,ouceau, cherche et supp que si bon mot
+				((!$nouveau) && ($visible)) ? formulaire_mots('carto_objets', $tab_id, $nouv_mot, $supp_mot, $cherche_mot, $flag_editable): formulaire_mots('carto_objets', $tab_id, null, null, null, $flag_editable);
+			}
+
 			// Supprimer un objet
 			$link = $carte_link;
 			$link->addVar('supp_objet', $id_objet);

Index: mots_type.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/ecrire/mots_type.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- mots_type.php3	13 Jan 2005 16:04:32 -0000	1.1
+++ mots_type.php3	20 Jan 2005 10:21:42 -0000	1.2
@@ -14,6 +14,11 @@
 	$breves = 'oui';
 	$rubriques = 'non';
 	$syndic = 'oui';
+	//////////////////////////////
+	//MODIFICATION
+	//////////////////////////////
+	$carto_objets= 'non';
+	//////////////////////////////
 	$acces_minirezo = 'oui';
 	$acces_comite = 'oui';
 	$acces_forum = 'non';
@@ -31,6 +36,11 @@
 		$breves = $row['breves'];
 		$rubriques = $row['rubriques'];
 		$syndic = $row['syndic'];
+		//////////////////////////////
+		//MODIFICATION
+		//////////////////////////////
+		$carto_objets = $row['carto_objets'];
+		//////////////////////////////
 		$acces_minirezo = $row['0minirezo'];
 		$acces_comite = $row['1comite'];
 		$acces_forum = $row['6forum'];
@@ -108,6 +118,13 @@
 		if ($syndic == "oui") $checked = "checked";
 		else $checked = "";
 		echo "<input type='checkbox' name='syndic' value='oui' $checked id='syndic'> <label for='syndic'>"._T('item_mots_cles_association_sites')."</label>";
+		//////////////////////////////
+		//MODIFICATION
+		//////////////////////////////
+		if ($carto_objets == "oui") $checked = "checked";
+		else $checked = "";
+		echo "<br><input type='checkbox' name='carto_objets' value='oui' $checked id='carto_objets'> <label for='carto_objets'>"._L('aux objets des cartes')."</label>";
+		//////////////////////////////
 		
 		echo "</ul>";
 	echo "</div>";



From stef at berlios.de  Thu Jan 20 11:22:16 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:22:16 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/upload remove.txt,NONE,1.1
Message-ID: <200501201022.j0KAMGOp026177@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/upload
In directory sheep:/tmp/cvs-serv26169/ecrire/upload

Added Files:
	remove.txt 
Log Message:
proto1.1

--- NEW FILE: remove.txt ---
Vous pouvez effacer ce fichier sans dommages.

You can safely remove this file.



From stef at berlios.de  Thu Jan 20 11:23:10 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:23:10 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/data .htaccess,NONE,1.1
Message-ID: <200501201023.j0KANAOp026237@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/data
In directory sheep:/tmp/cvs-serv26231/ecrire/data

Added Files:
	.htaccess 
Log Message:
proto1.1

--- NEW FILE: .htaccess ---
deny from all



From stef at berlios.de  Thu Jan 20 11:23:33 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:23:33 +0100
Subject: [Spip-carto-cvs] spip-carto/ecrire/img_pack croix-rouge.gif,NONE,1.1 racine-site-24.gif,NONE,1.1 referers-24.gif,NONE,1.1 administration-48.png,NONE,1.1 m_envoi_rtl.gif,NONE,1.1 puce-orange-breve.gif,NONE,1.1 rv-12.gif,NONE,1.1 racine-site-12.gif,NONE,1.1 puce-orange-anim.gif,NONE,1.1 auteur-24.gif,NONE,1.1 statistiques-48.png,NONE,1.1 cal-semaine.gif,NONE,1.1 carte-24.gif,NONE,1.1 redac-12.gif,NONE,1.1 agenda-24.gif,NONE,1.1 cal-jour.gif,NONE,1.1 message.gif,NONE,1.1 loupe.png,NONE,1.1 cookie-24.gif,NONE,1.1 forum-public-24.gif,NONE,1.1 administration-24.gif,NONE,1.1 rayures-danger.gif,NONE,1.1 puce-blanche-anim.gif,NONE,1.1 cal-mois.gif,NONE,1.1 calendrier-24.gif,NONE,1.1 annonce.gif,NONE,1.1 traductions-24.gif,NONE,1.1 cal-suivi.png,NONE,1.1 tourner-gauche.gif,NONE,1.1 set-ecran-etroit.png,NONE,1.1 rond-bg.gif,NONE,1.1 loupe-moins.gif,NONE,1.1 triangle-bas.gif,NONE,1.1 warning.gif,NONE,1.1 rayures-sup.gif,NONE,1.1 forum-admin-24.gif,NONE,1.1 suivi-petition-24.gif,NONE,1.1 index.p!
 hp3,NONE,1.1 jauge-rouge.gif,NONE,1.1 aide-48.png,NONE,1.1 degrade.jpg,NONE,1.1 triangle_rtl.gif,NONE,1.1 rond-hg-24.gif,NONE,1.1 rond-bd.gif,NONE,1.1 redacteurs-poubelle-24.gif,NONE,1.1 puce-verte.gif,NONE,1.1 documents-48_rtl.png,NONE,1.1 supprimer.gif,NONE,1.1 rond-b.gif,NONE,1.1 poubelle.gif,NONE,1.1 tirets-separation.gif,NONE,1.1 forum-droite_rtl.gif,NONE,1.1 puce-rouge-anim.gif,NONE,1.1 historique-24.gif,NONE,1.1 suivi-forum-24.gif,NONE,1.1 xml.gif,NONE,1.1 rond-hd-24.gif,NONE,1.1 langues-off-12.gif,NONE,1.1 rond-h-24.gif,NONE,1.1 pense-bete.gif,NONE,1.1 puce-poubelle-anim.gif,NONE,1.1 racine-24.gif,NONE,1.1 barre-noir.gif,NONE,1.1 messagerie-24.gif,NONE,1.1 choix-layout_rtl_he.png,NONE,1.1 choix-layout.png,NONE,1.1 logo-spip.gif,NONE,1.1 triangle-bleu-bas.gif,NONE,1.1 rayures-danger.png,NONE,1.1 synchro-24.gif,NONE,1.1 m_envoi.gif,NONE,1.1 secteur-24.gif,NONE,1.1 fiche-perso-24.gif,NONE,1.1 aide.gif,NONE,1.1 deconnecter-24.gif,NONE,1.1 mot-cle-24.gif,NONE,1.1 plus.gi!
 f,NONE,1.1 barre-d.gif,NONE,1.1 aide-48_rtl.png,NONE,1.1 puce-blanche.
Message-ID: <200501201023.j0KANXOp026275@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/ecrire/img_pack
In directory sheep:/tmp/cvs-serv26267/ecrire/img_pack

Added Files:
	croix-rouge.gif racine-site-24.gif referers-24.gif 
	administration-48.png m_envoi_rtl.gif puce-orange-breve.gif 
	rv-12.gif racine-site-12.gif puce-orange-anim.gif 
	auteur-24.gif statistiques-48.png cal-semaine.gif carte-24.gif 
	redac-12.gif agenda-24.gif cal-jour.gif message.gif loupe.png 
	cookie-24.gif forum-public-24.gif administration-24.gif 
	rayures-danger.gif puce-blanche-anim.gif cal-mois.gif 
	calendrier-24.gif annonce.gif traductions-24.gif cal-suivi.png 
	tourner-gauche.gif set-ecran-etroit.png rond-bg.gif 
	loupe-moins.gif triangle-bas.gif warning.gif rayures-sup.gif 
	forum-admin-24.gif suivi-petition-24.gif index.php3 
	jauge-rouge.gif aide-48.png degrade.jpg triangle_rtl.gif 
	rond-hg-24.gif rond-bd.gif redacteurs-poubelle-24.gif 
	puce-verte.gif documents-48_rtl.png supprimer.gif rond-b.gif 
	poubelle.gif tirets-separation.gif forum-droite_rtl.gif 
	puce-rouge-anim.gif historique-24.gif suivi-forum-24.gif 
	xml.gif rond-hd-24.gif langues-off-12.gif rond-h-24.gif 
	pense-bete.gif puce-poubelle-anim.gif racine-24.gif 
	barre-noir.gif messagerie-24.gif choix-layout_rtl_he.png 
	choix-layout.png logo-spip.gif triangle-bleu-bas.gif 
	rayures-danger.png synchro-24.gif m_envoi.gif secteur-24.gif 
	fiche-perso-24.gif aide.gif deconnecter-24.gif mot-cle-24.gif 
	plus.gif barre-d.gif aide-48_rtl.png puce-blanche.gif 
	cal-messagerie.png redacteurs-24.gif puce-verte-breve.gif 
	choix-layout_rtl.png visiter-48_rtl.png rv.gif 
	m_envoi_jaune_rtl.gif loupe-plus.gif petite-cle.gif 
	documents-48.png langues-12.gif m_envoi_jaune.gif 
	triangle-bleu.gif rond-g.gif deplierbas.gif fond-gris-anim.gif 
	forum-vert.gif langues-24.gif m_envoi_bleu.gif heures-pm.png 
	m_envoi_bleu_rtl.gif visiter-48.png jauge-vert.gif barre-g.gif 
	forum-interne-24.gif ortho-24.gif statistiques-24.gif 
	effacer-cache-24.gif asuivre-48.png cal-rv.png fond-stats.gif 
	cal-today.gif rubrique-12.gif spip_out.gif rubrique-24.gif 
	groupe-mot-24.gif breve-24.gif set-ecran.png 
	puce-blanche-breve.gif langues-modif-12.gif warning-24.gif 
	triangle-droite.gif redacteurs-admin-24.gif redacteurs-48.png 
	asuivre-24.gif deplierhaut_rtl.gif jauge-fond.gif cache-24.gif 
	triangle.gif tout-site.png interface-display.png visit-12.gif 
	article-24.gif petition-24.gif image-24.gif puce-orange.gif 
	forum-droite.gif tout-site-24.gif cadenas-24.gif rond-d.gif 
	fiche-perso.png secteur-12.gif deplierhaut.gif tourner-180.gif 
	site-24.gif carte-24.png puce-poubelle.gif messagerie-48.png 
	puce-rouge-breve.gif fleche-right.png naviguer-site.png 
	fleche-left.png rien.gif aide_rtl.gif tourner-droite.gif 
	rayures.gif heures-tout.png creer.gif base-24.gif edit.gif 
	interface-display-comp.png doc-24.gif triangle-droite_rtl.gif 
	fond-calendrier.gif rayures-fines.gif heures-am.png 
	puce-poubelle-breve.gif admin-12.gif puce-rouge.gif 
	barre-blanc.gif rayures-gris.gif puce-verte-anim.gif 
	fond-agenda.gif 
Log Message:
proto1.1

--- NEW FILE: croix-rouge.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: racine-site-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: referers-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: administration-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-orange-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rv-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: racine-site-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-orange-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: auteur-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: statistiques-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-semaine.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: carte-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redac-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: agenda-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-jour.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: message.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: loupe.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cookie-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-public-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: administration-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-danger.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-blanche-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-mois.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: calendrier-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: annonce.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: traductions-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-suivi.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tourner-gauche.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: set-ecran-etroit.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-bg.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: loupe-moins.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-bas.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: warning.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-sup.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-admin-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: suivi-petition-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: index.php3 ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>Index des icones de Spip</title>
	<link rel="up" href="../">
</head>
<body>
	<center>
		<h1>Index des icones de <a href='http://www.spip.net'>Spip</a></h1>
		<table>
<?php
	$myDir = opendir('.');
	while($file = readdir($myDir)) {
		if (ereg("\.(png|gif)$", $file))
			echo "		<tr><td>$file</td><td><img src='$file' alt='$file' /></td></tr>\n";
	}
?>

		</table>
	</center>
</body>
</html>
--- NEW FILE: jauge-rouge.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: degrade.jpg ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-hg-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-bd.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-poubelle-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-verte.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: documents-48_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: supprimer.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-b.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: poubelle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tirets-separation.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-droite_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-rouge-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: historique-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: suivi-forum-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: xml.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-hd-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-off-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-h-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: pense-bete.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-poubelle-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: racine-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-noir.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: messagerie-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: choix-layout_rtl_he.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: choix-layout.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: logo-spip.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-bleu-bas.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-danger.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: synchro-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: secteur-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fiche-perso-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deconnecter-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: mot-cle-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: plus.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-d.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide-48_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-blanche.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-messagerie.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-verte-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: choix-layout_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: visiter-48_rtl.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rv.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_jaune_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: loupe-plus.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: petite-cle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: documents-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_jaune.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-bleu.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-g.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deplierbas.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-gris-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-vert.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_bleu.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: heures-pm.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: m_envoi_bleu_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: visiter-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: jauge-vert.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-g.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-interne-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: ortho-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: statistiques-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: effacer-cache-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: asuivre-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-rv.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-stats.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cal-today.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rubrique-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: spip_out.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rubrique-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: groupe-mot-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: breve-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: set-ecran.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-blanche-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: langues-modif-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: warning-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-droite.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-admin-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: redacteurs-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: asuivre-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deplierhaut_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: jauge-fond.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cache-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tout-site.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: interface-display.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: visit-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: article-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: petition-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: image-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-orange.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: forum-droite.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tout-site-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: cadenas-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rond-d.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fiche-perso.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: secteur-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: deplierhaut.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tourner-180.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: site-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: carte-24.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-poubelle.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: messagerie-48.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-rouge-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fleche-right.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: naviguer-site.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fleche-left.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rien.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: aide_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: tourner-droite.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: heures-tout.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: creer.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: base-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: edit.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: interface-display-comp.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: doc-24.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: triangle-droite_rtl.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-calendrier.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-fines.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: heures-am.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-poubelle-breve.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: admin-12.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-rouge.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: barre-blanc.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: rayures-gris.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: puce-verte-anim.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: fond-agenda.gif ---
(This appears to be a binary file; contents omitted.)



From stef at berlios.de  Thu Jan 20 11:24:11 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:24:11 +0100
Subject: [Spip-carto-cvs] spip-carto/IMG/icones_barre gras.png,NONE,1.1 oelig-maj.png,NONE,1.1 blanc.png,NONE,1.1 lien.png,NONE,1.1 eacute-maj.png,NONE,1.1 guillemets.png,NONE,1.1 notes.png,NONE,1.1 italique.png,NONE,1.1 oelig.png,NONE,1.1 agrave-maj.png,NONE,1.1 quote.png,NONE,1.1 guillemets-simples.png,NONE,1.1 guillemets-uniques-de.png,NONE,1.1 guillemets-de.png,NONE,1.1 guillemets-uniques.png,NONE,1.1 euro.png,NONE,1.1 intertitre.png,NONE,1.1 espace.png,NONE,1.1
Message-ID: <200501201024.j0KAOBOp026302@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/IMG/icones_barre
In directory sheep:/tmp/cvs-serv26289/IMG/icones_barre

Added Files:
	gras.png oelig-maj.png blanc.png lien.png eacute-maj.png 
	guillemets.png notes.png italique.png oelig.png agrave-maj.png 
	quote.png guillemets-simples.png guillemets-uniques-de.png 
	guillemets-de.png guillemets-uniques.png euro.png 
	intertitre.png espace.png 
Log Message:
proto1.1

--- NEW FILE: gras.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: oelig-maj.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: blanc.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: lien.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: eacute-maj.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: guillemets.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: notes.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: italique.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: oelig.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: agrave-maj.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: quote.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: guillemets-simples.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: guillemets-uniques-de.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: guillemets-de.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: guillemets-uniques.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: euro.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: intertitre.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: espace.png ---
(This appears to be a binary file; contents omitted.)



From stef at berlios.de  Thu Jan 20 11:24:11 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:24:11 +0100
Subject: [Spip-carto-cvs] spip-carto/IMG test_image.jpg,NONE,1.1 test.gif,NONE,1.1 logo_spip.jpg,NONE,1.1 test.png,NONE,1.1 test.jpg,NONE,1.1
Message-ID: <200501201024.j0KAOBOp026305@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/IMG
In directory sheep:/tmp/cvs-serv26289/IMG

Added Files:
	test_image.jpg test.gif logo_spip.jpg test.png test.jpg 
Log Message:
proto1.1

--- NEW FILE: test_image.jpg ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: test.gif ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: logo_spip.jpg ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: test.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: test.jpg ---
(This appears to be a binary file; contents omitted.)



From stef at berlios.de  Thu Jan 20 11:25:20 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:25:20 +0100
Subject: [Spip-carto-cvs] spip-carto/oo index.php3,NONE,1.1 index.php,NONE,1.1
Message-ID: <200501201025.j0KAPKOp026406@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto/oo
In directory sheep:/tmp/cvs-serv26389/oo

Added Files:
	index.php3 index.php 
Log Message:
proto1.1

--- NEW FILE: index.php3 ---
<?php

// ACCESSIBILITE
// la page /oo offre une lecture en mode "texte seul"
// des 3 articles les plus recents.

@header("Location: ../sommaire_texte.php3");

?>

--- NEW FILE: index.php ---
<?php

// ACCESSIBILITE
// la page /oo offre une lecture en mode "texte seul"
// des 3 articles les plus recents...

@header("Location: ../sommaire_texte.php3");

?>



From stef at berlios.de  Thu Jan 20 11:25:52 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:25:52 +0100
Subject: [Spip-carto-cvs] spip-carto plan-dist.html,NONE,1.1 spip_carto.php,1.1,1.2 spip_pass.php3,1.1,1.2 spip_inscription.php3,1.1,1.2
Message-ID: <200501201025.j0KAPqOp026462@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto
In directory sheep:/tmp/cvs-serv26456

Modified Files:
	spip_carto.php spip_pass.php3 spip_inscription.php3 
Added Files:
	plan-dist.html 
Log Message:
proto1.1

--- NEW FILE: plan-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] </title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<!-- Plan du site -->

<div id="plan" class="contenu">

<BOUCLE_secteurs(RUBRIQUES) {racine} {par titre}>

<div class="plan-secteur">

	[(#LOGO_RUBRIQUE|left)]<h1><a href="#URL_RUBRIQUE">#TITRE</a></h1>

	<div class="encart">

	<!-- Breves -->

	<h2 class="structure"><:breves:></h2>

	<B_breves>
	<div class="menu">
	<div class="breves">
		<div class="menu-titre">
		<:breves:>
		</div>
		<ul>
	<BOUCLE_breves(BREVES) {id_secteur} {par date} {inverse} {0,15}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>
	</B_breves>

	<!-- Sur le Web -->

	<h2 class="structure"><:sites_web:></h2>

	<B_sites>
	<div class="menu">
	<div class="divers">
		<div class="menu-titre">
		<:sur_web:>
		</div>
		<ul>
	<BOUCLE_sites(SITES) {id_secteur} {par nom_site}>
		<li class="menu-item">
		<a href="#URL_SITE">#NOM_SITE</a>
		</li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>

	</div>

<!-- Articles et sous-rubriques -->

<h2 class="structure"><:articles:></h2>

<B_articles_racine>
<ul class="plan-articles">

<BOUCLE_articles_racine(ARTICLES) {id_rubrique} {par titre}>
<li class="plan-article"><a href="#URL_ARTICLE">#TITRE</a></li>
</BOUCLE_articles_racine>

</ul>
</B_articles_racine>

<B_rubriques>

<ul class="plan-rubriques">

<BOUCLE_rubriques(RUBRIQUES) {id_parent} {par titre}>
<li>
<div class="plan-rubrique"><a href="#URL_RUBRIQUE">#TITRE</a></div>

	<B_articles>
	<ul class="plan-articles">
	<BOUCLE_articles(ARTICLES) {id_rubrique} {par titre}>
	<li class="plan-article"><a href="#URL_ARTICLE">#TITRE</a></li>
	</BOUCLE_articles>
	</ul>
	</B_articles>

	<BOUCLE_sous_rubriques(BOUCLE_rubriques)></BOUCLE_sous_rubriques>

</li>
</BOUCLE_rubriques>

</ul>
</B_rubriques>


</div>

</BOUCLE_secteurs>

</div>
#FORMULAIRE_ADMIN
</body>
</html>

Index: spip_carto.php
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/spip_carto.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_carto.php	13 Jan 2005 15:57:38 -0000	1.1
+++ spip_carto.php	20 Jan 2005 10:25:49 -0000	1.2
@@ -6,18 +6,38 @@
 
 include("downloadfile.class.php");
 
-if (isset($_GET["id_carte"]) && !empty($_GET["id_carte"])) 
+if (isset($_GET["fond_carte"]) && !empty($_GET["fond_carte"])) 
 {
-	$query="select fichier from spip_documents where id_document=".$_GET["id_carte"];
-		
-	$result = @spip_query($query);
-	if ($result) 
+	$lid_carte=intval($_GET["fond_carte"]);
+	//echo $lid_carte;
+	//exit;
+	if ($lid_carte)
 	{
-		$row = @spip_fetch_array($result); 
-		$downloadfile = new DOWNLOADFILE($row[0],"inline");
-		//si c'est un probleme de document supprim? : "!!!" ... bof !
-		if (!$downloadfile->df_download()) echo "!!!";
-		//else exit();
+		$query="select fichier from spip_documents where id_document=".$lid_carte;
+		
+		$result = @spip_query($query);
+		if ($result) 
+		{
+			$row = @spip_fetch_array($result); 
+			$downloadfile = new DOWNLOADFILE($row[0],"inline");
+			//si c'est un probleme de document supprim? : "!!!" ... bof !
+			$lError="document OK";
+		}
+		else {
+			$downloadfile = new DOWNLOADFILE("ecrire/img_pack/carte-24.png","inline");
+			$lError="pas de document";
+		}
+		if (!$downloadfile->df_download()) echo "!!!".$lError."!!!";
+		//echo "!!!".$lError."!!!";
+			
+	}
+	else {
+		//$downloadfile = new DOWNLOADFILE("/ecrire/img_pack/carte-24.png","inline");
+		//$downloadfile = new DOWNLOADFILE($_GET["fond_carte"],"inline");
+		redirige_par_entete($_GET["fond_carte"]);
+		$lError="chemin";
 	}
+	//if (!$downloadfile->df_download()) echo "!!!".$lError."!!!";
+	//else exit();
 }
 ?>

Index: spip_pass.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/spip_pass.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_pass.php3	13 Jan 2005 15:57:38 -0000	1.1
+++ spip_pass.php3	20 Jan 2005 10:25:49 -0000	1.2
@@ -1,78 +1,72 @@
 <?php
 
 include ("ecrire/inc_version.php3");
-
-include_ecrire("inc_meta.php3");
-include_ecrire("inc_presentation.php3");
-include_ecrire("inc_session.php3");
-include_ecrire("inc_filtres.php3");
-include_ecrire("inc_texte.php3");
-include_ecrire("inc_meta.php3");
-include_ecrire("inc_mail.php3");
-include_ecrire("inc_acces.php3");
-include_local("inc-public-global.php3"); 
+include_ecrire("inc_presentation.php3"); # pour install_debut
+include_ecrire("inc_session.php3"); # pour creer_uniq_id
+include_ecrire("inc_mail.php3"); # pour envoyer_mail
+include_ecrire("inc_acces.php3"); # pour generer_htpass
+include_local("inc-public-global.php3"); # pour calculer la page
+include_local ("inc-cache.php3"); # ici c'est pour tester la connexion SQL
 
 // Ce fichier est celui d'une balise dynamique qui s'ignore.
 
 function formulaire_oubli_dyn($p, $oubli)
 {
 
-$erreur = '';
+$message = '';
 
 // au 3e appel la variable P est positionnee par le script lui-meme
 // et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
 if ($p = addslashes($p)) {
-	$res = spip_query ("SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut<>'5poubelle' AND pass<>''");
+	$res = spip_query("SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut<>'5poubelle' AND pass<>''");
 	if (!$row = spip_fetch_array($res)) 
-		$erreur = _T('pass_erreur_code_inconnu');
+		$message = _T('pass_erreur_code_inconnu');
 	else {
 		if ($oubli) {
 			$mdpass = md5($oubli);
 			$htpass = generer_htpass($oubli);
-			spip_query ("UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
+			spip_query("UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
 				cookie_oubli='' WHERE cookie_oubli='$p'");
 
 			$login = $row['login'];
-			$erreur = "<b>"._T('pass_nouveau_enregistre')."</b>".
-			"<p>"._T('pass_rappel_login', array('login' => $login));
+			$message = "<b>" . _T('pass_nouveau_enregistre') . "</b>".
+			"<p>" . _T('pass_rappel_login', array('login' => $login));
 		}
 	}
  } else { 
   // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
   if ($oubli) {
-	if (email_valide($oubli)) {
+	if ( email_valide($oubli) ) {
 		$email = addslashes($oubli);
 		$res = spip_query("SELECT * FROM spip_auteurs WHERE email ='$email'");
 		if ($row = spip_fetch_array($res)) {
 			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
-				$erreur = _T('pass_erreur_acces_refuse');
+				$message = _T('pass_erreur_acces_refuse');
 			else {
 				$cookie = creer_uniqid();
 				spip_query("UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'");
 
-				if (envoyer_mail($email,
-						 "[" . lire_meta("nom_site") .'] ' ._T('pass_oubli_mot'),
+				if ( envoyer_mail($email,
+						 "[" . lire_meta("nom_site") .'] ' .  _T('pass_oubli_mot'),
 						 _T('pass_mail_passcookie',
 						    array('nom_site_spip' => lire_meta("nom_site"),
 							  'adresse_site' => lire_meta("adresse_site"), 
 							  'cookie' => $cookie))))
-					$erreur = _T('pass_recevoir_mail');
+					$message = _T('pass_recevoir_mail');
 				else
-					$erreur = _T('pass_erreur_probleme_technique');
+					$message = _T('pass_erreur_probleme_technique');
 			}
 		}
 		else
-			$erreur = _T('pass_erreur_non_enregistre', array('email_oubli' => htmlspecialchars($oubli)));
+			$message = _T('pass_erreur_non_enregistre', array('email_oubli' => htmlspecialchars($oubli)));
 	} else {
-		$erreur = _T('pass_erreur_non_valide', array('email_oubli' => htmlspecialchars($oubli)));
+		$message = _T('pass_erreur_non_valide', array('email_oubli' => htmlspecialchars($oubli)));
 	}
   }
  }
- return $erreur ? $erreur : array('formulaire_oubli', 0, array('p' => $p));
+ return array('formulaire_oubli', 0, array('p' => $p, 'message' => $message));
 }
 
-utiliser_langue_site();
-utiliser_langue_visiteur();
 install_debut_html(_T('pass_mot_oublie'));
 inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
 install_fin_html();

Index: spip_inscription.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/spip_inscription.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_inscription.php3	13 Jan 2005 15:57:38 -0000	1.1
+++ spip_inscription.php3	20 Jan 2005 10:25:49 -0000	1.2
@@ -3,10 +3,10 @@
 include_ecrire("inc_presentation.php3");
 include_local("inc-formulaire_inscription.php3");
 include_local("inc-public-global.php3"); 
-include_ecrire("inc_lang.php3"); 
-utiliser_langue_site();
-utiliser_langue_visiteur();
+include_local ("inc-cache.php3");
+
 install_debut_html(_T('pass_vousinscrire'));
-inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus));
+inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus, $target));
+# echo http_script_window_close(); # fait dans le squelette a present
 install_fin_html();
 ?>



From stef at berlios.de  Thu Jan 20 11:26:15 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:26:15 +0100
Subject: [Spip-carto-cvs] spip-carto freecarto.zip,NONE,1.1
Message-ID: <200501201026.j0KAQFOp026496@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto
In directory sheep:/tmp/cvs-serv26477

Added Files:
	freecarto.zip 
Log Message:
proto1.1

--- NEW FILE: freecarto.zip ---
(This appears to be a binary file; contents omitted.)



From stef at berlios.de  Thu Jan 20 11:25:19 2005
From: stef at berlios.de (stef at berlios.de)
Date: Thu, 20 Jan 2005 11:25:19 +0100
Subject: [Spip-carto-cvs] spip-carto inc-calcul.php3,NONE,1.1 formulaire_ecrire_auteur-dist.html,NONE,1.1 inc-url_logout.php3,NONE,1.1 index.php3,NONE,1.1 formulaire_recherche-dist.html,NONE,1.1 inc-login_public.php3,NONE,1.1 inc-public.php3,NONE,1.1 htaccess-propres.txt,NONE,1.1 inc-formulaire_forum.php3,NONE,1.1 formulaire_forum-dist.html,NONE,1.1 inc-compilo.php3,NONE,1.1 inc-urls-html.php3,NONE,1.1 inc-html-squel.php3,NONE,1.1 carto.php3,NONE,1.1 index.php,NONE,1.1 article.php3,NONE,1.1 habillage.css,NONE,1.1 ical-dist.html,NONE,1.1 inc-compilo-api.php3,NONE,1.1 formulaire_site-dist.html,NONE,1.1 inc-compilo-index.php3,NONE,1.1 mot.php3,NONE,1.1 htaccess-html.txt,NONE,1.1 inc-formulaire_site.php3,NONE,1.1 inc-formulaire_ecrire_auteur.php3,NONE,1.1 inc-login_prive.php3,NONE,1.1 backend.php3,NONE,1.1 inc-calcul-outils.php3,NONE,1.1 formulaire_login-dist.html,NONE,1.1 formulaire_admin-dist.html,NONE,1.1 inc-formulaire_signature.php3,NONE,1.1 inc-criteres.php3,NONE,1.1 inc-public-global.php3!
 ,NONE,1.1 login-dist.html,NONE,1.1 inc-urls-propres.php3,NONE,1.1 formulaire_signature-dist.html,NONE,1.1 downloadfile.class.php,NONE,1.1 inc-boucles.php3,NONE,1.1 carto-proto.sql,NONE,1.1 inc-formulaire_inscription.php3,NONE,1.1 formulaire_menu_lang-dist.html,NONE,1.1 forum.php3,NONE,1.1 inc-menu_lang_ecrire.php3,NONE,1.1 formulaire_inscription-dist.html,NONE,1.1 impression.css,NONE,1.1 inc-balises.php3,NONE,1.1 inc-chercher.php3,NONE,1.1 inc-urls-standard.php3,NONE,1.1 inc-admin.php3,NONE,1.1 backend-dist.html,NONE,1.1 backend-breves-dist.html,NONE,1.1 nouveautes-dist.html,NONE,1.1 distrib.php3,NONE,1.1 distrib-dist.html,NONE,1.1 inc-stats.php3,NONE,1.1 forum-dist.html,NONE,1.1 mes_fonctions.php3,NONE,1.1 auteur.php3,NONE,1.1 ical.php3,NONE,1.1 breve.php3,NONE,1.1 inc-formulaire_recherche.php3,NONE,1.1 breve-dist.html,NONE,1.1 plan.php3,NONE,1.1 inc-messforum.php3,NONE,1.1 inc-cache.php3,NONE,1.1 formulaire_oubli-dist.html,NONE,1.1 inc-menu_lang.php3,NONE,1.1 auteur-dist.!
 html,NONE,1.1 article-dist.html,NONE,1.1 mot-dist.html,NONE,1.1 carto.
Message-ID: <200501201025.j0KAPJOp026403@sheep.berlios.de>

Update of /cvsroot/spip-carto/spip-carto
In directory sheep:/tmp/cvs-serv26389

Added Files:
	inc-calcul.php3 formulaire_ecrire_auteur-dist.html 
	inc-url_logout.php3 index.php3 formulaire_recherche-dist.html 
	inc-login_public.php3 inc-public.php3 htaccess-propres.txt 
	inc-formulaire_forum.php3 formulaire_forum-dist.html 
	inc-compilo.php3 inc-urls-html.php3 inc-html-squel.php3 
	carto.php3 index.php article.php3 habillage.css ical-dist.html 
	inc-compilo-api.php3 formulaire_site-dist.html 
	inc-compilo-index.php3 mot.php3 htaccess-html.txt 
	inc-formulaire_site.php3 inc-formulaire_ecrire_auteur.php3 
	inc-login_prive.php3 backend.php3 inc-calcul-outils.php3 
	formulaire_login-dist.html formulaire_admin-dist.html 
	inc-formulaire_signature.php3 inc-criteres.php3 
	inc-public-global.php3 login-dist.html inc-urls-propres.php3 
	formulaire_signature-dist.html downloadfile.class.php 
	inc-boucles.php3 carto-proto.sql 
	inc-formulaire_inscription.php3 formulaire_menu_lang-dist.html 
	forum.php3 inc-menu_lang_ecrire.php3 
	formulaire_inscription-dist.html impression.css 
	inc-balises.php3 inc-chercher.php3 inc-urls-standard.php3 
	inc-admin.php3 backend-dist.html backend-breves-dist.html 
	nouveautes-dist.html distrib.php3 distrib-dist.html 
	inc-stats.php3 forum-dist.html mes_fonctions.php3 auteur.php3 
	ical.php3 breve.php3 inc-formulaire_recherche.php3 
	breve-dist.html plan.php3 inc-messforum.php3 inc-cache.php3 
	formulaire_oubli-dist.html inc-menu_lang.php3 auteur-dist.html 
	article-dist.html mot-dist.html carto.html 
	inc-formulaire_admin.php3 backend-breves.php3 
Log Message:
proto1.1

--- NEW FILE: inc-calcul.php3 ---
<?php


// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CALCUL")) return;
define("_INC_CALCUL", "1");

//
// Ce fichier calcule une page en executant un squelette.
//

include_ecrire("inc_meta.php3");
include_ecrire("inc_index.php3");
include_ecrire("inc_texte.php3");
include_ecrire("inc_filtres.php3");
include_ecrire("inc_lang.php3");
include_ecrire("inc_documents.php3");
include_ecrire("inc_abstract_sql.php3");
include_ecrire("inc_forum.php3");
include_ecrire("inc_debug_sql.php3");
include_local("inc-calcul-outils.php3");

// Ce fichier peut contenir une affectation de $dossier_squelettes  indiquant
// le repertoire du source des squelettes (les pseudo-html avec BOUCLE...)

if (@file_exists("mes_fonctions.php3")) 
    include_local ("mes_fonctions.php3");


// Gestionnaire d'URLs
if (@file_exists("inc-urls.php3"))
	include_local("inc-urls.php3");
else
	include_local("inc-urls-".$GLOBALS['type_urls'].".php3");


// Le squelette compile est-il trop vieux ?
function squelette_obsolete($skel, $squelette) {
	return (
		$GLOBALS['var_mode']
		OR !@file_exists($skel)
		OR (@filemtime($squelette) > ($date = @filemtime($skel)))
		OR (@filemtime('mes_fonctions.php3') > $date)
		OR (@filemtime(_FILE_OPTIONS) > $date)
	);
}


# Charge un squelette (au besoin le compile) 
# et retoune le nom de sa fonction principale, ou '' s'il est indefini
# Charge egalement un fichier homonyme de celui du squelette
# mais de suffixe '_fonctions.php3' pouvant contenir:
# - des filtres
# - des fonctions de traduction de balise, de critere et de boucle
# - des declaration de tables SQL supplementaires

function charger_squelette ($squelette) {
	$ext = $GLOBALS['extension_squelette'];
	$nom = $ext . '_' . md5($squelette);
	$sourcefile = $squelette . ".$ext";

	// le squelette est-il deja en memoire (INCLURE  a repetition)
	if (function_exists($nom))
		return $nom;

	$phpfile = _DIR_CACHE . 'skel_' . $nom . '.php';

	// le squelette est-il deja compile et perenne ?
	if (!squelette_obsolete($phpfile, $sourcefile)
	AND lire_fichier ($phpfile, $contenu,
	array('critique' => 'oui', 'phpcheck' => 'oui'))) 
		eval('?'.'>'.$contenu);

	// sinon, charger le compilateur et verifier que le source est lisible
	if (!function_exists($nom)) {
		include_local("inc-compilo.php3");
		lire_fichier ($sourcefile, $skel);
	}

	// Le fichier suivant peut contenir entre autres:
	// 1. les filtres utilises par le squelette
	// 2. des ajouts au compilateur
	// Le point 1 exige qu'il soit lu dans tous les cas.
	// Le point 2 exige qu'il soit lu apres inc-compilo
	// (car celui-ci initialise $tables_principales) mais avant la compil
	$f = $squelette . '_fonctions.php3';
	if (@file_exists($f)) include($f);

	if (function_exists($nom)) return $nom;

	$skel_code = calculer_squelette($skel, $nom, $ext, $sourcefile);

	// Tester si le compilateur renvoie une erreur
	if (is_array($skel_code))
		erreur_squelette($skel_code[0], $skel_code[1]);
	else {
		if ($GLOBALS['var_mode'] == 'debug') {
			include_ecrire("inc_debug_sql.php3");
			debug_dumpfile ($skel_code, $nom, 'code');
		}
		eval('?'.'>'.$skel_code);
		if (function_exists($nom)) {
			ecrire_fichier ($phpfile, $skel_code);
			return $nom;
		}
	}
}

# Provoque la recherche du squelette $fond d'une $lang donnee,
# et l'applique sur un $contexte pour un certain $cache.
# Retourne un tableau de 3 elements:
# 'texte' => la page calculee
# 'process_ins' => 'html' ou 'php' si presence d'un '< ?php'
# 'invalideurs' => les invalideurs (cf inc-calcul-squel)

# En cas d'erreur process_ins est absent et texte est un tableau de 2 chaines

# La recherche est assuree par la fonction chercher_squelette,
# definie dans inc-chercher, fichier non charge si elle est deja definie
# (typiquement dans mes_fonctions.php3)

function cherche_page ($cache, $contexte, $fond)  {
	global $dossier_squelettes, $delais;

	if (!function_exists('chercher_squelette'))
		include_local("inc-chercher.php3"); # a renommer ?

	// Choisir entre $fond-dist.html, $fond=7.html, etc?
	$id_rubrique_fond = 0;
	// Si inc-urls veut fixer la langue, on la recupere ici
	$lang = $contexte['lang'];
	// Chercher le fond qui va servir de squelette
	if ($r = sql_rubrique_fond($contexte,
	$lang ? $lang : lire_meta('langue_site')))
		list($id_rubrique_fond, $lang) = $r;

	if (!$GLOBALS['forcer_lang'])
		lang_select($lang);

	$skel = chercher_squelette($fond,
			$id_rubrique_fond,
			$dossier_squelettes ? "$dossier_squelettes/" :'',
			$GLOBALS['spip_lang']);

	// Charger le squelette et recuperer sa fonction principale
	// (compilation automatique au besoin) et calculer

	$page = array();

	if ($skel) {
		if ($fonc = charger_squelette($skel))
		  $page = $fonc(array('cache' => $cache), array($contexte));

		// Passer la main au debuggueur)
		if ($GLOBALS['var_mode'] == 'debug')
		  {
			include_ecrire("inc_debug_sql.php3");
			debug_dumpfile ($page['texte'], $fonc, 'resultat');
		  }
	}

	// Nettoyer le resultat si on est fou de XML
	if ($GLOBALS['xhtml']) {
		include_ecrire("inc_tidy.php");
		$page['texte'] = xhtml($page['texte']);
	}

	// Entrer les invalideurs dans la base
	if ($delais>0) {
		include_ecrire('inc_invalideur.php3');
		maj_invalideurs($cache, $page['invalideurs'], $delais);
	}

	// Retourner la structure de la page

	return $page;
}


//
// Contexte : lors du calcul d'une page spip etablit le contexte a partir
// des variables $HTTP_GET_VARS et $HTTP_POST_VARS, et leur ajoute la date
// Note : pour hacker le contexte depuis le fichier d'appel (article.php3),
// il est recommande de modifier $HTTP_GET_VARS['toto'] (meme si la page est
// appelee avec la methode POST).
//
function calculer_contexte() {
	foreach($GLOBALS['HTTP_GET_VARS'] as $var => $val) {
		if (strpos($var, 'var_') !== 0)
			$contexte[$var] = $val;
	}
	foreach($GLOBALS['HTTP_POST_VARS'] as $var => $val) {
		if (strpos($var, 'var_') !== 0)
			$contexte[$var] = $val;
	}

	if ($GLOBALS['date'])
		$contexte['date'] = $contexte['date_redac'] = normaliser_date($GLOBALS['date']);
	else
		$contexte['date'] = $contexte['date_redac'] = date("Y-m-d H:i:s");

	return $contexte;
}

function calculer_page_globale($cache, $contexte_local, $fond) {

	// Gestion des URLs personnalises - sale mais historique
	if (function_exists("recuperer_parametres_url")) {
		global $contexte;
		$contexte = $contexte_local;
		recuperer_parametres_url($fond, nettoyer_uri());

		// remettre les globales pour le bouton "Modifier cet article"
		if (is_array($contexte))
			foreach ($contexte as $var=>$val)
				if (substr($var,0,3) == 'id_')
					$GLOBALS[$var] = $val;
		$contexte_local = $contexte;
	}

	// Go to work !
	$page = cherche_page($cache, $contexte_local, $fond);

	$signal = array();
	foreach(array('id_parent', 'id_rubrique', 'id_article', 'id_auteur',
	'id_breve', 'id_forum', 'id_secteur', 'id_syndic', 'id_syndic_article',
	'id_mot', 'id_groupe', 'id_document') as $val) {
		if ($contexte_local[$val])
			$signal['contexte'][$val] = intval($contexte_local[$val]);
	}

	$page['signal'] = $signal;

	return $page;
}


// Cf ramener_page +cherche_page_incluante+ cherche_page_incluse chez ESJ
function calculer_page($chemin_cache, $elements, $delais, $inclusion=false) {

	// Inclusion
	if ($inclusion) {
		$contexte_inclus = $elements['contexte'];
		$page = cherche_page($chemin_cache,
			$contexte_inclus, $elements['fond']);
	}
	else {

		// Page globale
		// si le champ chapo commence par '=' c'est une redirection.
		if ($id_article = intval($GLOBALS['id_article'])) {
			if ($art = sql_chapo($id_article)) {
				$chapo = $art['chapo'];
				if (substr($chapo, 0, 1) == '=') {
					include_ecrire('inc_texte.php3');
					list(,$url) = extraire_lien(array('','','',
					substr($chapo, 1)));
					if ($url) { // sinon les navigateurs pataugent
						$url = addslashes($url);
						$page = array('texte' => "<".
						"?php header(\"Location: $url\"); ?" . ">",
						'process_ins' => 'php');
					}
				}
			}
		}
		if (!$page)
			$page = calculer_page_globale($chemin_cache,
				$elements['contexte'],
				$elements['fond']);
	}

	$page['signal']['process_ins'] = $page['process_ins'];
	$signal = "<!-- ".str_replace("\n", " ",
	serialize($page['signal']))." -->\n";

	// Enregistrer le fichier cache
	if ($delais > 0 AND $GLOBALS['var_mode'] != 'debug'
	AND empty($GLOBALS['HTTP_POST_VARS']))
		ecrire_fichier($chemin_cache, $signal.$page['texte']);

	return $page;
}
?>

--- NEW FILE: formulaire_ecrire_auteur-dist.html ---
[<br /><img src='puce(#HTTP_VARS{sujetko}).gif' border='0' alt='-' /> <:form_prop_indiquer_sujet:><br />&nbsp;][
<br /><img src='puce(#HTTP_VARS{mailko}).gif' border='0' alt='-' /> <:form_prop_indiquer_email:><br /><br />
]<form action="[(#HTTP_VARS{action})]" method='post'>
<p><label><:form_pet_votre_email:>
	<input type="text" class="forml" name="email_message_auteur"
		 value="[(#HTTP_VARS{mail})]" size="30" />
</label></p>
<p><label><:form_prop_sujet:><br />
	<input type="text" class="forml" name="sujet_message_auteur"
		 value="[(#HTTP_VARS{sujet})]" size="30" />
</label></p>
<p>
<textarea name='texte_message_auteur' rows='10' class='forml' cols='40'>[(#HTTP_VARS{texte})]</textarea>
</p>
[<input type="hidden" name="id_auteur" value="(#HTTP_VARS{id_auteur})" />]
<div align="right">
	<input type="submit"  class="spip_bouton" name="valide"
		 value="[(#HTTP_VARS{valide})]" />
</div>
</form>

--- NEW FILE: inc-url_logout.php3 ---
<?php

global $balise_URL_LOGOUT_collecte;
$balise_URL_LOGOUT_collecte = array();

function balise_URL_LOGOUT_stat ($args, $filtres)
{
  return array($filtres[0]);
}

function balise_URL_LOGOUT_dyn($cible)
{
	if (!$login = $GLOBALS['auteur_session']['login'])
	  return '';
	if (!$cible) $cible = $GLOBALS['clean_link']->getUrl();
	return 'spip_cookie.php3?logout_public=' . $login . '&amp;url=' . urlencode($cible);
}
?>

--- NEW FILE: index.php3 ---
<?php include ("sommaire.php3"); ?>

--- NEW FILE: formulaire_recherche-dist.html ---
<form action='[(#HTTP_VARS{lien})]' method='get' class='formrecherche'>
	<div>
		<input	type='text'
			id='formulaire_recherche'
			class='formrecherche'
			name='recherche'
			value="[(#HTTP_VARS{recherche})]" />
	</div>
</form>

--- NEW FILE: inc-login_public.php3 ---
<?php

include(_FILE_CONNECT);
include_ecrire("inc_meta.php3");
include_ecrire("inc_session.php3");
include_ecrire("inc_filtres.php3");

global $balise_LOGIN_PUBLIC_collecte;
$balise_LOGIN_PUBLIC_collecte = array('url');

# retourner:
# 1. l'url collectee ci-dessus (args0) ou donnee en filtre (filtre0)
# 2. l'eventuel parametre de la balise (args1) fournie par calculer_balise_dynamique

function balise_LOGIN_PUBLIC_stat ($args, $filtres)
{
	return array($filtres[0] ? $filtres[0] : $args[0], $args[1]);
}

function balise_LOGIN_PUBLIC_dyn($cible, $login)
{
	if (!$cible) {
		global $clean_link;
		$clean_link->delVar('var_erreur');
		$clean_link->delVar('var_login');
		$cible = $clean_link->getUrl();
	}
	return login_explicite($login, $cible,  'forum');
}

function login_explicite($login, $cible, $mode) {
	global $auteur_session, $clean_link;

	$clean_link->delVar('var_erreur');
	$clean_link->delVar('var_login');
	$action = $clean_link->getUrl();

	if ($cible) {
	  $cible = ereg_replace("[?&]var_erreur=[^&]*", '', $cible);
	  $cible = ereg_replace("[?&]var_login=[^&]*", '', $cible);
	} else {
	  if (ereg("[?&]url=([^&]*)", $action, $m))
	    $cible = urldecode($m[1]);
	  else
	    $cible = _DIR_RESTREINT ;
	}
	      
	include_ecrire("inc_session.php3");
	verifier_visiteur();

	if ($auteur_session AND 
	($auteur_session['statut']=='0minirezo' OR $auteur_session['statut']=='1comite')) {
		if (($cible != $action) &&  !headers_sent())
			redirige_par_entete($cible);
		return http_href($cible, _T('login_par_ici'));
	}
	return login_pour_tous($login ? $login : $GLOBALS['var_login'], $cible, '', $action, $mode);
}

// fonction aussi pour les forums sur abonnement

function login_pour_tous($login, $cible, $message, $action, $mode) {

  global $ignore_auth_http, $spip_admin, $php_module;

	// en cas d'echec de cookie, inc_auth a renvoye vers spip_cookie qui
	// a tente de poser un cookie ; s'il n'est pas la, c'est echec cookie
	// s'il est la, c'est probablement un bookmark sur bonjour=oui,
	// et pas un echec cookie.
	if ($GLOBALS['var_echec_cookie'])
	  $echec_cookie = ($GLOBALS['spip_session'] != 'test_echec_cookie');
	$auth = ($echec_cookie AND $php_module AND !$ignore_auth_http) ?
	  'spip_cookie.php3' : '';
	// Le login est memorise dans le cookie d'admin eventuel
	if (!$login) {
		if (ereg("^@(.*)$", $spip_admin, $regs))
			$login = $regs[1];
	} else if ($login == '-1')
	  $login = '';

	$row = array();
	$erreur = '';
	if ($login) {
		$row = spip_query("SELECT * FROM spip_auteurs WHERE login='" .addslashes($login) ."'");
		$row =  spip_fetch_array($row);
		if ((!$row AND !$GLOBALS['ldap_present']) OR
		    ($row['statut'] == '5poubelle') OR 
		    (($row['source'] == 'spip') AND $row['pass'] == '')) {
			$erreur =  _T('login_identifiant_inconnu', array('login' => $login));
 			$row = array();
			$login = '';
			@spip_setcookie("spip_admin", "", time() - 3600);
		} else {
		  // on laisse le menu decide de la langue
		  unset($row['lang']);
		}
	}

	return array('formulaire_login', 0, 
		     array_merge(array_map('addslashes', $row),
				 array(
				       'action2' => ($login ? 'spip_cookie.php3' : $action),
				       'erreur' => $erreur,
				       'action' => $action,
				       'url' => $cible,
				       'auth' => $auth,
				       'echec_cookie' => ($echec_cookie ? ' ' : ''),
				       'message' => ($message ? ' ' : ''),
				       )
				 )
		     );

}

// Bouton duree de connexion

function filtre_rester_connecte($prefs) 
{
	$prefs = unserialize(stripslashes($prefs));
	return $prefs['cnx'] == 'perma' ? ' ' : '';
}

function silogoauteur($id_auteur)
{
  $f = _DIR_IMG . 'auton' . $id_auteur . '.jpg';
  return (@file_exists($f) ? $f : '');
}
?>

--- NEW FILE: inc-public.php3 ---
<?php

// Page inclue ?
if (defined("_INC_PUBLIC")) {
	$page = inclure_page($fond, $delais, $contexte_inclus, $fichier_inclus);

	if ($page['process_ins'] == 'html')
		echo $page['texte'];
	else
		eval('?' . '>' . $page['texte']);

	if ($page['lang_select'])
		lang_dselect();
}
// Premier appel inc-public
else {
	define("_INC_PUBLIC", "1");
	include ("ecrire/inc_version.php3");

	//
	// Initialisations
	//

	// Regler le $delais par defaut
	if ($INSECURE['fond'] || $INSECURE['delais'])
		exit;
	if (!isset($delais))
		$delais = 1 * 3600;
	if ($recherche)
		$delais = 0;

	// authentification du visiteur
	if ($HTTP_COOKIE_VARS['spip_session'] OR
	($PHP_AUTH_USER AND !$ignore_auth_http)) {
		include_ecrire ("inc_session.php3");
		verifier_visiteur();
	}
	// multilinguisme
	if ($forcer_lang AND ($forcer_lang!=='non') AND empty($HTTP_POST_VARS)) {
		include_ecrire('inc_lang.php3');
		verifier_lang_url();
	}
	if ($HTTP_GET_VARS['lang']) {
		include_ecrire('inc_lang.php3');
		lang_select($HTTP_GET_VARS['lang']);
	}
	// Ajout_forum (pour les forums) et $val_confirm signalent des modifications
	// a faire avant d'afficher la page
	if ($ajout_forum) {
		$redirect = '';
		include('inc-messforum.php3');
		if ($redirect) redirige_par_entete($redirect);
	}
	if ($val_confirm) {
		include_local('inc-formulaire_signature.php3');
		reponse_confirmation($id_article, $val_confirm);
	}

	include_local ('inc-public-global.php3');

	//  refus du debug si pas dans les options generales ni admin connecte
	if ($var_mode=='debug') {
		if (($code_activation_debug == 'oui')
		OR $auteur_session['statut'] == '0minirezo')
			spip_log('debug !');
		else
			$var_mode = false; 
	}

	// est-on admin ?
	if ($affiche_boutons_admin = (!$flag_preserver
	AND ($HTTP_COOKIE_VARS['spip_admin']
	OR $HTTP_COOKIE_VARS['spip_debug'])))
		include_local('inc-formulaire_admin.php3');

	$tableau_des_erreurs = array();
	$page = afficher_page_globale ($fond, $delais, $use_cache);

	if (!$flag_preserver) {
	// Interdire au client de cacher un login, un admin ou un recalcul
		if ($flag_dynamique OR $var_mode
		OR $HTTP_COOKIE_VARS['spip_admin']) {
			@header("Cache-Control: no-cache,must-revalidate");
			@header("Pragma: no-cache");
	// Pour les autres donner l'heure de modif
		} else if ($lastmodified)
			@Header ("Last-Modified: ".http_gmoddate($lastmodified)." GMT");

	// si le squelette est nul se rabattre sur l'entete standard
		if ($page['texte']) 
			@header("Content-Type: text/html; charset=".lire_meta('charset'));
		else
			echo debut_entete($fond);
	}
	define('spip_active_ob', $flag_ob AND
		($var_mode == 'debug' OR $var_recherche OR $affiche_boutons_admin));

	// Cas d'une page contenant uniquement du HTML :
	if ($page['process_ins'] == 'html') {
		if (!spip_active_ob) {
			echo $page['texte'];
			$contenu = '';
		} else
			$contenu = $page['texte'];
	}

	// Cas d'une page contenant du PHP :
	else {
		// Evaluer la page
		if (!spip_active_ob) {
			eval('?' . '>' . $page['texte']);
			$contenu = '';
		} else {
			ob_start(); 
			$res = eval('?' . '>' . $page['texte']);
			$contenu = ob_get_contents(); 
			ob_end_clean();

			// en cas d'erreur lors du eval, afficher un message
			// et forcer les boutons de debug
			if ($res === false AND $affiche_boutons_admin
			AND $auteur_session['statut'] == '0minirezo') {
				include_ecrire('inc_debug_sql.php3');
				erreur_squelette(_L('erreur d\'execution de la page'));
			}
		}
	}

	// Passer la main au debuggueur le cas echeant 
	if ($var_mode == 'debug') {
		include_ecrire("inc_debug_sql.php3");
		debug_dumpfile('',$var_mode_objet,$var_mode_affiche);
		exit;
	} else if (count($tableau_des_erreurs) > 0
	AND $affiche_boutons_admin)
		affiche_erreurs_page ($tableau_des_erreurs);

	// Traiter var_recherche pour surligner les mots
	if ($var_recherche) {
		include_ecrire("inc_surligne.php3");
		$contenu = surligner_mots($contenu, $var_recherche);
	}

	// Ajouter au besoin la CSS des boutons admins
	if ($affiche_boutons_admin) {
		include_local("inc-admin.php3");
		$contenu = perso_admin($contenu);
	}

	// Afficher le resultat final
	echo $contenu;

	// Ajouter les boutons admins (les normaux) si absents
	// (ce sera apres la balise /html mais tant pis)
	if ($affiche_boutons_admin)
		inclure_balise_dynamique(balise_formulaire_admin_dyn($id_article, $id_breve, $id_rubrique, $id_mot, $id_auteur));

	// Taches de fin
	terminer_public_global();
 }

?>

--- NEW FILE: htaccess-propres.txt ---
###########################################################
# Fichier .htaccess pour les URLs propres ; a installer   #
# si vous reglez $type_urls='propre'                      #
# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
# (fichier associe : inc-urls-propres.php3)               #
###########################################################

RewriteEngine On

### si votre site est en sous-domaine, preciser ci-dessous
# RewriteBase /sous/domaine/

# Rediriger les mots et breves sans le "+" final
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(\+[^/\.\+]+)$ /$1+ [QSA,R]

# Les mots-cles
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^\+-[^/\.]+-\+$ mot.php3 [QSA,E=url_propre:$0]

# Les breves
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^\+[^/\.]+\+$ breve.php3 [QSA,E=url_propre:$0]

# Les rubriques
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^-[^/\.]+-$ rubrique.php3 [QSA,E=url_propre:$0]

# Les articles
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^[^/\.]+$ article.php3 [QSA,E=url_propre:$0]

--- NEW FILE: inc-formulaire_forum.php3 ---
<?php

include_ecrire('inc_meta.php3');
include_ecrire('inc_admin.php3');
include_ecrire('inc_acces.php3');
include_ecrire('inc_texte.php3');
include_ecrire('inc_filtres.php3');
include_ecrire('inc_lang.php3');
include_ecrire('inc_mail.php3');
include_ecrire('inc_forum.php3');
include_ecrire("inc_abstract_sql.php3");
include_local(_FILE_CONNECT);

// Gestionnaire d'URLs
if (@file_exists("inc-urls.php3"))
	include_local("inc-urls.php3");
else
	include_local("inc-urls-".$GLOBALS['type_urls'].".php3");

/*******************************/
/* GESTION DU FORMULAIRE FORUM */
/*******************************/
global $balise_FORMULAIRE_FORUM_collecte;
$balise_FORMULAIRE_FORUM_collecte = array('id_rubrique', 'id_forum', 'id_article', 'id_breve', 'id_syndic');

function balise_FORMULAIRE_FORUM_stat($args, $filtres)
{
  list ($idr, $idf, $ida, $idb, $ids) = $args;

  // recuperer les donnees du forum auquel on repond, false = forum interdit
  if (!$r = sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids))
    return '';
  list($titre, $table, $forums_publics) = $r;
  return 
    array($titre, $table, $forums_publics, $idr, $idf, $ida, $idb, $ids);
}

function balise_FORMULAIRE_FORUM_dyn($titre, $table, $forums_publics, $id_rubrique, $id_forum, $id_article, $id_breve, $id_syndic) {

	global $REMOTE_ADDR, $id_message, $afficher_texte, $spip_forum_user;

	// url de reference
	if (!$url = rawurldecode($GLOBALS['url'])) 
	    $url = $GLOBALS['REQUEST_URI'];
	else {
	// identifiants des parents
	  $args = '';  
	  if ($id_rubrique) $args .= "id_rubrique=$id_rubrique";
	  if ($id_forum) $args .= "id_forum=$id_forum";
	  if ($id_article) $args .= "id_article=$id_article";
	  if ($id_breve) $args .= "id_breve=$id_breve";
	  if ($id_syndic) $args .= "id_syndic=$id_syndic";
	  if ($args && strpos($url,$args)===false) $url .= (strpos($url,'?') ? '&' : '?') . $args;
	}
	$url = ereg_replace("[?&]var_erreur=[^&]*", '', $url);
	$url = ereg_replace("[?&]var_login=[^&]*", '', $url);
	$url = ereg_replace("[?&]url=[^&]*", '', $url);

	// verifier l'identite des posteurs pour les forums sur abo
	if (($forums_publics == "abo") && (!$GLOBALS["auteur_session"]))
	  {
	    include_local('inc-login_public.php3');
	    return login_pour_tous($GLOBALS['var_login'], $url, true, $url, 'forum');
	  }
	// au premier appel (pas de http-var nommee "retour")
	// memoriser l'URL courante pour y revenir apres envoi du message
	// aux appels suivants, reconduire la valeur.
	if ($retour = rawurldecode($GLOBALS['HTTP_GET_VARS']['retour']))
	  $retour = ereg_replace('&var_mode=recalcul','',$retour);
	else {
	  if (!$retour = rawurldecode($GLOBALS['HTTP_POST_VARS']['retour']))
	    $retour = $url;
	}

	// ne pas mettre '', sinon le squelette n'affichera rien.

	$previsu = ' ';

	// Recuperer le message a previsualiser
	if ($id_message = intval($GLOBALS['HTTP_POST_VARS']['id_message']))  {
		$titre = $GLOBALS['HTTP_POST_VARS']['titre'];
		$texte = $GLOBALS['HTTP_POST_VARS']['texte'];
		$auteur = $GLOBALS['HTTP_POST_VARS']['auteur'];
		$email_auteur = $GLOBALS['HTTP_POST_VARS']['email_auteur'];
		$nom_site_forum = $GLOBALS['HTTP_POST_VARS']['nom_site_forum'];
		$url_site = $GLOBALS['HTTP_POST_VARS']['url_site'];

		if ($afficher_texte != 'non') {
			$previsu = 
			  "<div style='font-size: 120%; font-weight: bold;'>"
			  . interdire_scripts(typo($titre))
			  . "</div><p /><b><a href=\"mailto:"
			  . interdire_scripts(typo($email_auteur)) . "\">"
			  . interdire_scripts(typo($auteur)) . "</a></b><p />"
			  . propre($texte) . "<p /><a href=\""
			  . interdire_scripts($url_site) . "\">"
			  . interdire_scripts(typo($nom_site_forum)) . "</a>";

			// Verifier mots associes au message
			$result_mots = spip_query("SELECT mots.id_mot, mots.titre, mots.type
			FROM spip_mots_forum AS lien, spip_mots AS mots 
			WHERE id_forum='$id_message' AND mots.id_mot = lien.id_mot
			GROUP BY mots.id_mot");
			if (spip_num_rows($result_mots)>0) {
				$previsu .= "<p>"._T('forum_avez_selectionne')."</p><ul>";
				while ($row = spip_fetch_array($result_mots)) {
					$les_mots[$row['id_mot']] = "checked='checked'";
					$presence_mots = true;
					$previsu .= "<li class='font-size=80%'> "
					. typo($row['type']) . "&nbsp;: <b>"
					. typo($row['titre']) ."</b></li>";
				}
				$previsu .= '</ul>';
			}

			if (strlen($texte) < 10 AND !$presence_mots) {
				$previsu .= "<p align='right' style='color: red;'>"._T('forum_attention_dix_caracteres')."</p>\n";
			}
			else if (strlen($titre) < 3 AND $afficher_texte <> "non") {
				$previsu .= "<p align='right' style='color: red;'>"._T('forum_attention_trois_caracteres')."</p>";
			}
			else {
				$previsu .= "<div align='right'><input type='submit' name='confirmer' class='spip_bouton' value='"._T('forum_message_definitif')."' /></div>";
			}
			$previsu = "<div class='spip_encadrer'>$previsu</div>\n<br />";
			// supprimer les <form> de la previsualisation
			// (sinon on ne peut pas faire <cadre>...</cadre> dans les forums)
			$previsu = preg_replace("@<(/?)f(orm[>[:space:]])@ism", "<\\1no-f\\2", $previsu);
		}
	} else {
		// Premiere edition, initialiser l'auteur
	  	// puis s'accorder une nouvelle entree dans la table
		if ($spip_forum_user && is_array($cookie_user = unserialize($spip_forum_user))) {
			$auteur = $cookie_user['nom'];
			$email_auteur = $cookie_user['email'];
		}
		else {
			$auteur = $GLOBALS['auteur_session']['nom'];
			$email_auteur = $GLOBALS['auteur_session']['email'];
		}
		$id_message = spip_abstract_insert('forum', 
					  "(date_heure, titre, ip, statut)",
					  "(NOW(), '".addslashes($titre)."', '$REMOTE_ADDR', 'redac')");

	}

	// Generation d'une valeur de securite pour validation
	$seed = (double) (microtime() + 1) * time() * 1000000;
	@mt_srand($seed);
	$alea = @mt_rand();
	if (!$alea) {srand($seed);$alea = rand();}
	$forum_id_rubrique = intval($id_rubrique);
	$forum_id_forum = intval($id_forum);
	$forum_id_article = intval($id_article);
	$forum_id_breve = intval($id_breve);
	$forum_id_syndic = intval($id_syndic);
	$hash = calculer_action_auteur("ajout_forum $forum_id_rubrique $forum_id_forum $forum_id_article $forum_id_breve $forum_id_syndic $alea");

	// Faut-il ajouter des propositions de mots-cles
	if ((lire_meta("mots_cles_forums") == "oui") && ($table != 'forum'))
		$table = table_des_mots($table, $les_mots);
	else
		$table = '';

	return array(
		     'formulaire_forum',
		     0,
		     array(
		     'afficher_non' => 
		     ($afficher_texte != 'non' ? '' :
		      (boutonne('hidden', 'titre', htmlspecialchars($titre)) .
		       $table .
		       "\n<br /><div align='right'>" .
		       boutonne('submit', '', _T('forum_valider'), "class='spip_bouton'") .
		       "</div>")), 
		     'alea' => $alea,
		     'auteur' => $auteur,
		     'disabled' => ($forums_publics == "abo")? " disabled='disabled'" : '',
		     'email_auteur' => $email_auteur,
		     'hash' => $hash,
		     'id_message' => $id_message,
		     'modere' => (($forums_publics != 'pri') ? '' :
				  _T('forum_info_modere')),
		     'nom_site_forum' => $nom_site_forum,
		     'previsu' => $previsu,
		     'retour' => $retour,
		     'table' => $table,
		     'texte' => $texte,
		     'titre' => $titre,
		     'url' =>  $url,
		     'url_site' => ($url_site ? $url_site : "http://")
		     ));
}


function barre_forum($texte)
{
	include_ecrire('inc_layer.php3');

	if (!$GLOBALS['browser_barre'])
		return "<textarea name='texte' rows='12' class='forml' cols='40'>$texte</textarea>";
	static $num_formulaire = 0;
	$num_formulaire++;
	include_ecrire('inc_barre.php3');
	return afficher_barre("document.getElementById('formulaire_$num_formulaire')", true) .
	  "
<textarea name='texte' rows='12' class='forml' cols='40'
id='formulaire_$num_formulaire'
onselect='storeCaret(this);'
onclick='storeCaret(this);'
onkeyup='storeCaret(this);'
ondbclick='storeCaret(this);'>$texte</textarea>";
}

// Mots-cles dans les forums :
// Si la variable de personnalisation $afficher_groupe[] est definie
// dans le fichier d'appel, et si la table de reference est OK, proposer
// la liste des mots-cles
function table_des_mots($table, $les_mots) {
	global $afficher_groupe;

	if ($afficher_groupe)
		$in_group = " AND id_groupe IN (" . join($afficher_groupe, ", ") .")";

	$result_groupe = spip_query("SELECT * FROM spip_groupes_mots
	WHERE 6forum = 'oui' AND $table = 'oui'". $in_group);

	$ret = '';
	while ($row_groupe = spip_fetch_array($result_groupe)) {
		$id_groupe = $row_groupe['id_groupe'];
		$titre_groupe = propre($row_groupe['titre']);
		$unseul = ($row_groupe['unseul']== 'oui') ? 'radio' : 'checkbox';
		$result =spip_query("SELECT * FROM spip_mots
		WHERE id_groupe='$id_groupe'");
		$total_rows = spip_num_rows($result);

		if ($total_rows > 0) {
			$ret .= "\n<p />"
			  . "<div class='spip_encadrer' style='font-size: 80%;'>"
			  . "<b>$titre_groupe&nbsp;:</b>"
			  . "<table cellpadding='0' cellspacing='0' border='0' width='100%'>\n"
			  ."<tr><td width='47%' valign='top'>";
			$i = 0;
      
		while ($row = spip_fetch_array($result)) {
			$id_mot = $row['id_mot'];
			$titre_mot = propre($row['titre']);
			$descriptif_mot = propre($row['descriptif']);

			if ($i >= ($total_rows/2) AND $i < $total_rows) {
				$i = $total_rows + 1;
				$ret .= "</td><td width='6%'>&nbsp;</td>
				<td width='47%' valign='top'>";
			}

			$ret .= boutonne($unseul, "ajouter_mot[$id_groupe][]", $id_mot, "id='mot$id_mot' " . $les_mots[$id_mot]) .
			  afficher_petits_logos_mots($id_mot)
			. "<b><label for='mot$id_mot'>$titre_mot</label></b><br />";

			if ($descriptif_mot)
				$ret .= "$descriptif_mot<br />";
			$i++;
		}

		$ret .= "</td></tr></table>";
		$ret .= "</div>";
		}
	}

	return $ret;
}


function afficher_petits_logos_mots($id_mot) {
	include_ecrire('inc_logos.php3');
	$on = cherche_image_nommee("moton$id_mot");
	if ($on) {
	  $image = ("$on[0]$on[1].$on[2]");
		$taille = @getimagesize($image);
		$largeur = $taille[0];
		$hauteur = $taille[1];
		if ($largeur < 100 AND $hauteur < 100)
			return "<img src='$image' align='middle' width='$largeur'
			height='$hauteur' hspace='1' vspace='1' alt=' ' border='0'
			class='spip_image' /> ";
	}
}

/*******************************************************/
/* FONCTIONS DE CALCUL DES DONNEES DU FORMULAIRE FORUM */
/*******************************************************/

//
// Chercher le titre et la configuration du forum de l'element auquel on repond
//

function sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids) {

	// changer la table de reference s'il y a lieu (pour afficher_groupes[] !!)
	if ($idr) {
		$r = "SELECT titre FROM spip_rubriques WHERE id_rubrique = $idr";
		$table = "rubriques";
	} else if ($ida) {
		$r = "SELECT titre FROM spip_articles WHERE id_article = $ida";
		$table = "articles";
	} else if ($idb) {
		$r = "SELECT titre FROM spip_breves WHERE id_breve = $idb";
		$table = "breves";
	} else if ($ids) {
		$r = "SELECT nom_site AS titre FROM spip_syndic WHERE id_syndic = $ids";
		$table = "syndic";
	}

	if ($idf)
		$r = "SELECT titre FROM spip_forum WHERE id_forum = $idf";

	if ($r) {
		list($titre) = spip_fetch_array(spip_query($r));
		$titre = '> ' . supprimer_numero($titre);
	} else {
		$titre = _T('forum_titre_erreur');
		$table = '';
	}

	// quelle est la configuration du forum ?
	if ($ida)
		list($accepter_forum) = spip_fetch_array(spip_query(
		"SELECT accepter_forum FROM spip_articles WHERE id_article=$ida"));
	else
		$accepter_forum = substr(lire_meta("forums_publics"),0,3);
	// valeurs possibles : 'pos'teriori, 'pri'ori, 'abo'nnement
	if ($accepter_forum == "non")
		return false;

	return array ($titre, $table, $accepter_forum);
}

?>

--- NEW FILE: formulaire_forum-dist.html ---
<form action='[(#HTTP_VARS{url})]' method='post' name='formulaire'>
      <input type='hidden' name='ajout_forum' value="oui" />
      <input type='hidden' name='id_message' value="[(#HTTP_VARS{id_message})]" />
      <input type='hidden' name='alea' value="[(#HTTP_VARS{alea})]" />
      <input type='hidden' name='hash' value="[(#HTTP_VARS{hash})]" />
      <input type='hidden' name='retour' value="[(#HTTP_VARS{retour})]" />
      [(#HTTP_VARS*{modere})<p>]
      [(#HTTP_VARS*{afficher_non})]
      [(#HTTP_VARS*{previsu})
      <fieldset class='spip_encadrer'>
	<legend><b><:forum_titre:></b></legend>
	<label>
	  <input type='text' name='titre' 
	    [value="(#HTTP_VARS{titre})" ]class='forml' size='40' />
	</label>
      </fieldset>
      <br />
      <fieldset class='spip_encadrer'>
	<legend><b><:forum_texte:></b></legend>
	<p><:info_creation_paragraphe:></p>
[(#HTTP_VARS{texte}|barre_forum)]
      </fieldset>
      <br />
      [(#HTTP_VARS*{table})]
      <fieldset class='spip_encadrer'>
	<legend><:forum_lien_hyper:></legend>
	<p><:forum_page_url:></p>
	<p><label><:forum_titre:>
	  <input type='text' name='nom_site_forum' class='forml' size='40'
	  value="[(#HTTP_VARS{nom_site_forum})]"  />
	</label></p>
	<p><label><:forum_url:>
	<input type='text' name='url_site' class='forml'  size='40'
	  value="[(#HTTP_VARS{url_site})]" />
	</label></p>
	</fieldset>
      <br />
	<fieldset class='spip_encadrer'>
	  <legend><:forum_qui_etes_vous:></legend>
	  <p>
	  <label>
	    <:forum_votre_nom:>
	    <input type='text' name='auteur' value="[(#HTTP_VARS{auteur})]"
	      class='forml' size='40' [(#HTTP_VARS{disabled})] />
	  </label>
	  </p>
	  <p>
	  <label>
	    <:forum_votre_email:>
	    <input type='text' name='email_auteur' value="[(#HTTP_VARS{email_auteur})]"
	      class='forml' size='40' [(#HTTP_VARS{disabled})] />
	  </label>
	</p>
      </fieldset>
      <br /><div align='right'>
	<input type='submit'  value="<:forum_voir_avant:>" class='spip_bouton'></div>]
</form>


--- NEW FILE: inc-compilo.php3 ---
<?php

//
// Fichier principal du compilateur de squelettes
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_COMPILO")) return;
define("_INC_COMPILO", "1");


// Definition de la structure $p, et fonctions de recherche et de reservation
// dans l'arborescence des boucles
include_local("inc-compilo-index.php3");  # index ? structure ? pile ?

// definition des boucles
include_local("inc-boucles.php3");

// definition des criteres
include_local("inc-criteres.php3");

// definition des balises
include_local("inc-balises.php3");

// definition de l'API
include_local("inc-compilo-api.php3");

# definition des tables
include_ecrire('inc_serialbase.php3');

// outils pour debugguer le compilateur
#include_local("inc-compilo-debug.php3"); # desactive

//
// Calculer un <INCLURE()>
//
function calculer_inclure($fichier, $params, $id_boucle, &$boucles) {
	global $dossier_squelettes;

	$l = array();
	if ($params) {
		foreach($params as $var => $val) {
			if ($val) {
			  $val = trim($val);
			  $val = ereg_replace('^["\'](.*)["\']$', "\\1",$val);
			  $l[] = "\'$var\' => \'" .
				 addslashes(calculer_param_dynamique($val,
								     $boucles,
								     $idb)) .
				  "\'";
			}
			else {
			// Cas de la langue : passer $spip_lang
			  // et non table.lang (car depend de {lang_select})
				if ($var =='lang')
					$l[] = "\'lang\' => \''.\$GLOBALS[\"spip_lang\"].'\'";
				else
					$l[] = "\'$var\' => \'' . addslashes(" . index_pile($id_boucle, $var, $boucles) . ") .'\'";
				}
			}
	}
	return "\n'<".
		"?php\n\t\$contexte_inclus = array(" .
		join(", ",$l) .
		");\n\t\$fichier_inclus = \'$fichier\';\n" .
		(($dossier_squelettes) ?
		("
			if (@file_exists(\'$dossier_squelettes/$fichier\')){
				include(\'$dossier_squelettes/$fichier\');
			} else {
				include(\'$fichier\');
			} " ) :
		("\tinclude(\'$fichier\');")) .
		"\n?'." . "'>'";
}


//
// Traite une partie "texte" d'un squelette (c'est-a-dire tout element
// qui ne contient ni balise, ni boucle, ni <INCLURE()> ; le transforme
// en une EXPRESSION php (qui peut etre l'argument d'un Return ou la
// partie droite d'une affectation). Ici sont analyses les elements
// multilingues des squelettes : <:xxx:> et <multi>[fr]coucou</multi>
//
function calculer_texte($texte, $id_boucle, &$boucles, $id_mere) {
	$code = "'".ereg_replace("([\\\\'])", "\\\\1", $texte)."'";

	// bloc multi
	if (eregi('<multi>', $texte)) {
		$ouvre_multi = 'extraire_multi(';
		$ferme_multi = ')';
	} else {
		$ouvre_multi = $ferme_multi = '';
	}

	// Reperer les balises de traduction <:toto:>
	while (eregi("<:(([a-z0-9_]+):)?([a-z0-9_]+)(\|[^>]*)?:>", $code, $match)) {
		//
		// Traiter la balise de traduction multilingue
		//
		$chaine = strtolower($match[3]);
		if (!($module = $match[2]))
			// ordre standard des modules a explorer
			$module = 'local/public/spip';
		$c = new Champ;
		$c->code = "_T('$module:$chaine')";
		$c->fonctions = explode('|', substr($match[4],1));
		$c->id_boucle = $id_boucle;
		$c->boucles = &$boucles;
		$c->statut = 'php'; // ne pas manger les espaces avec trim()
		$c = applique_filtres($c);
		$code = str_replace($match[0], "'$ferme_multi.$c.$ouvre_multi'", $code);
	}

	return $ouvre_multi . $code . $ferme_multi;
}


//
// calculer_boucle() produit le corps PHP d'une boucle Spip 
// (sauf les recursives)
// Ce corps est essentiellement une boucle while
// remplissant une variable $t0 retournee en valeur
//
function calculer_boucle($id_boucle, &$boucles) {

	$boucle = &$boucles[$id_boucle];
	$type_boucle = $boucle->type_requete;
	$return = $boucle->return;
	$id_table = $boucle->id_table;
	$primary = $boucle->primary;
	$id_field = $id_table . "." . $primary;
	// La boucle doit-elle selectionner la langue ?
	// 1. par defaut, les boucles suivantes le font
	// "peut-etre", c'est-a-dire si forcer_lang == false.
	if (
		$type_boucle == 'articles'
		OR $type_boucle == 'rubriques'
		OR $type_boucle == 'hierarchie'
		OR $type_boucle == 'breves'
	) $lang_select = 'maybe';
	else
		$lang_select = false;

	// 2. a moins d'une demande explicite
	if ($boucle->lang_select == 'oui') $lang_select = 'oui';
	if ($boucle->lang_select == 'non') $lang_select = false;

	// Penser a demander le champ lang
	if ($lang_select)
		$boucle->select[] = 
			// cas des tables SPIP
			($id_table ? $id_table.'.' : '')
			// cas general ({lang_select} sur une table externe)
			. 'lang';

	// Calculer les invalideurs si c'est une boucle non constante
	$constant = ereg("^\(?'[^']*'\)?$",$return);

	if ((!$primary) || $constant)
		$invalide = '';
	else {
		$boucle->select[] = $id_field;

		$invalide = "\n			\$Cache['$primary']";
		if ($primary != 'id_forum')
			$invalide .= "[\$Pile[\$SP]['$primary']] = 1;";
		else
			$invalide .= "[calcul_index_forum(" . 
				// Retournera 4 [$SP] mais force la demande du champ a MySQL
				index_pile($id_boucle, 'id_article', $boucles) . ',' .
				index_pile($id_boucle, 'id_breve', $boucles) .  ',' .
				index_pile($id_boucle, 'id_rubrique', $boucles) .',' .
				index_pile($id_boucle, 'id_syndic', $boucles) .  ")] = 1;";
		$invalide .= ' // invalideurs';
	}

	// Cas {1/3} {1,4} {n-2,1}...

	$flag_cpt = $boucle->mode_partie || // pas '$compteur' a cause du cas 0
		strpos($return,'compteur_boucle');

	//
	// Creer le debut du corps de la boucle :
	//
	$debut = '';
	if ($flag_cpt)
		$debut = "\n		\$compteur_boucle++;";

	if ($boucle->mode_partie)
		$debut .= '
		if ($compteur_boucle-1 >= $debut_boucle
		AND $compteur_boucle-1 <= $fin_boucle) {';
	
	if ($lang_select AND !$constant) {
		$selecteur = 
			(($lang_select == 'maybe') ? 
			'if (!$GLOBALS["forcer_lang"]) ':'')
			. 'if ($x = $Pile[$SP]["lang"]) $GLOBALS[\'spip_lang\'] = $x;'
			. ' // lang_select';
		$debut .= "\n			".$selecteur;
	}

	$debut .= $invalide;

	if ($boucle->doublons)
		$debut .= "\n			\$doublons['".$boucle->doublons."'] .= ','. " .
		index_pile($id_boucle, $primary, $boucles)
		. "; // doublons";

	// gestion optimale des separateurs et des boucles constantes

	$corps = $debut . 
		((!$boucle->separateur) ? 
			(($constant && !$debut) ? $return :
			 	("\n\t\t" . '$t0 .= ' . $return . ";")) :
		 ("\n\t\t\$t1 " .
			((strpos($return, '$t1.') === 0) ? 
			 (".=" . substr($return,4)) :
			 ('= ' . $return)) .
		  ";\n\t\t" .
		  '$t0 .= (($t1 && $t0) ? \'' . $boucle->separateur .
		  "' : '') . \$t1;"));
     
	// Fin de parties
	if ($boucle->mode_partie)
		$corps .= "\n		}\n";

	$texte = '';

	// Gestion de la hierarchie (voir inc-boucles.php3)
	if ($boucle->hierarchie)
		$texte .= "\n	".$boucle->hierarchie;


	// si le corps est une constante, ne pas appeler le serveur N fois!
	if (ereg("^\(?'[^']*'\)?$",$corps)) {
		// vide ?
		if (($corps == "''") || ($corps == "('')")) {
			if (!$boucle->numrows)
				return 'return "";';
			else
				$corps = "";
		} else {
			$boucle->numrows = true;
			$corps = "\n		".'for($x=$Numrows["'.$id_boucle.'"];$x>0;$x--)
			$t0 .= ' . $corps .';';
		}
	} else {

	$corps = '

	// RESULTATS
	while ($Pile[$SP] = @spip_abstract_fetch($result,"' .
		  $boucle->sql_serveur .
		  '")) {'. "\n$corps\n	}\n";
		 

		// Memoriser la langue avant la boucle pour la restituer apres
		if ($lang_select) {
			$texte .= "\n	\$old_lang = \$GLOBALS['spip_lang'];";
			$corps .= "\n	\$GLOBALS['spip_lang'] = \$old_lang;";
		}
	}

	//
	// Requete
	//

	// hack critere recherche : ignorer la requete en cas de hash vide
	// Recherche : recuperer les hash a partir de la chaine de recherche
	if ($boucle->hash) {
		$init =  '
	// RECHERCHE
	list($rech_select, $rech_where) = prepare_recherche($GLOBALS["recherche"], "'.$boucle->primary.'", "'.$boucle->id_table.'");
	if ($rech_select) ';
	}

	else $init = '';

	$init .= "\n\n	// REQUETE
	\$result = spip_abstract_select(\n\t\tarray(\"". 
		# En absence de champ c'est un decompte : 
	  	# prendre la primary pour avoir qqch
	  	# (COUNT incompatible avec le cas general
		(($boucle->select) ? 
			join("\",\n\t\t\"", array_unique($boucle->select)) :
			$id_field) .
		'"), # SELECT
		array("' .
		join('","', array_unique($boucle->from)) .
		'"), # FROM
		array(' .
		(!$boucle->where ? '' : ( '"' . join('",
		"', $boucle->where) . '"')) .
		"), # WHERE
		'".addslashes($boucle->group)."', # GROUP
		" . ($boucle->order ? $boucle->order : "''") .", # ORDER
		" . (strpos($boucle->limit, 'intval') === false ?
			"'".$boucle->limit."'" :
			$boucle->limit). ", # LIMIT
		'".$boucle->sous_requete."', # sous
		".$boucle->compte_requete.", # compte
		'".$id_table."', # table
		'".$boucle->id_boucle."', # boucle
		'".$boucle->sql_serveur."'); # serveur";

	$init .= "\n	".'$t0 = "";
	$SP++;';
	if ($flag_cpt)
		$init .= "\n	\$compteur_boucle = 0;";


	if ($boucle->mode_partie)
		$init .= calculer_parties($boucle->partie,
			$boucle->mode_partie,
			$boucle->total_parties,
			$id_boucle);
	else if ($boucle->numrows)
		$init .= "\n	\$Numrows['" .
			$id_boucle .
			"'] = @spip_abstract_count(\$result,'" .
			$boucle->sql_serveur .
			"');";

	//
	// Conclusion et retour
	//
	$conclusion = "\n	@spip_abstract_free(\$result,'" .
	  $boucle->sql_serveur . "');";

	return $texte . $init . $corps . $conclusion;
}


//
// fonction traitant les criteres {1,n} (analyses dans inc-criteres)
//
## a deplacer dans inc-criteres ??
function calculer_parties($partie, $mode_partie, $total_parties, $id_boucle) {

	// Notes :
	// $debut_boucle et $fin_boucle sont les indices SQL du premier
	// et du dernier demandes dans la boucle : 0 pour le premier,
	// n-1 pour le dernier ; donc total_boucle = 1 + debut - fin

	// nombre total avant partition
	$retour = "\n\n	// Partition\n	" .
		'$nombre_boucle = @spip_abstract_count($result,"' .
		$boucle->sql_serveur .
		'");';

	ereg("([+-/])([+-/])?", $mode_partie, $regs);
	list(,$op1,$op2) = $regs;

	// {1/3}
	if ($op1 == '/') {
		$retour .= "\n	"
			.'$debut_boucle = ceil(($nombre_boucle * '
			. ($partie - 1) . ')/' . $total_parties . ");\n	"
			. '$fin_boucle = ceil (($nombre_boucle * '
			. $partie . ')/' . $total_parties . ") - 1;";
	}

	// {1,x}
	if ($op1 == '+') {
		$retour .= "\n	"
			. '$debut_boucle = ' . $partie . ';';
	}
	// {n-1,x}
	if ($op1 == '-') {
		$retour .= "\n	"
			. '$debut_boucle = $nombre_boucle - ' . $partie . ';';
	}
	// {x,1}
	if ($op2 == '+') {
		$retour .= "\n	"
			. '$fin_boucle = $debut_boucle + ' . $total_parties . ' - 1;';
	}
	// {x,n-1}
	if ($op2 == '-') {
		$retour .= "\n	"
			.'$fin_boucle = $debut_boucle + $nombre_boucle - '.$total_parties.' - 1;';
	}

	// Rabattre $fin_boucle sur le maximum
	$retour .= "\n	"
		.'$fin_boucle = min($fin_boucle, $nombre_boucle - 1);';

	// calcul du total boucle final
	$retour .= "\n	"
		.'$Numrows[\''.$id_boucle.'\'] = $fin_boucle - $debut_boucle + 1;';

	return $retour;
}

// Production du code PHP a partir de la sequence livree par le phraseur
// $boucles est passe par reference pour affectation par index_pile.
// Retourne une expression PHP,

function calculer_liste($tableau, $descr, &$boucles, $id_boucle='', $niv=1) {
	if (!$tableau) return "''";
        $codes = array();
	$t = '$t' . $niv;

	for ($i=0; $i<=$niv; $i++) $tab .= "\t";

	foreach ($tableau as $p) {

		switch($p->type) {
		// texte seul
		case 'texte':
			$code = calculer_texte($p->texte, $id_boucle, $boucles, $descr['id_mere']);
			$commentaire='';
			$avant='';
			$apres='';
			$altern = "''";
			break;

		// inclure
		case 'include':
			$code= calculer_inclure($p->fichier,
						$p->params,
						$id_boucle,
						$boucles);
			$commentaire = '<INCLURE('.$p->fichier.')>';
			$avant='';
			$apres='';
			$altern = "''";
			break;

		// boucle
		case 'boucle':
			$nom = $p->id_boucle;
			$newdescr = $descr;
			$newdescr['id_mere'] = $nom;
			$code = 'BOUCLE' .
			  ereg_replace("-","_", $nom) . $descr['nom'] .
			  '($Cache, $Pile, $doublons, $Numrows, $SP)';
			$commentaire='';
			$avant = calculer_liste($p->cond_avant,
				$newdescr, $boucles, $id_boucle, $niv+2);
			$apres = calculer_liste($p->cond_apres,
				$newdescr, $boucles, $id_boucle, $niv+2);
			$altern = calculer_liste($p->cond_altern,
				$newdescr, $boucles, $id_boucle, $niv+1);
			break;

		// balise SPIP
		default: 

			// cette structure pourrait etre completee des le phrase' (a faire)
			$p->id_boucle = $id_boucle;
			$p->boucles = &$boucles;
			$p->id_mere = $descr['id_mere'];
			$p->documents = $descr['documents'];
			$p->statut = 'html';
			$p->type_requete = $boucles[$id_boucle]->type_requete;

			$code = calculer_champ($p);
			$commentaire = '#' . $p->nom_champ . $p->etoile;
			$avant = calculer_liste($p->cond_avant,
				$descr, $boucles, $id_boucle, $niv+1);
			$apres = calculer_liste($p->cond_apres,
				$descr, $boucles, $id_boucle, $niv+1);
			$altern = "''";
			break;

		} // switch

		if ($avant == "''") $avant = '';
		if ($apres == "''") $apres = '';
		if ($avant||$apres||($altern!="''"))
		  {
		    $res = (!$avant ? "" : "$avant . ") . 
		      $t .
		      (!$apres ? "" : " . $apres");

		    if (($res != $t) || ($altern != "''"))
		      $code = "(($t = $code) ?\n\t$tab($res) :\n\t$tab($altern))";
		  }
		// if ($code) # c'est toujours etre ainsi
		  $codes[]= (!$commentaire ? $code : 
			     ("/"."* $commentaire *"."/ " . $code));
	} // foreach

	return "(" . join ("\n$tab. ", $codes) . ")";
}

// Prend en argument le source d'un squelette, sa grammaire et un nom.
// Retourne une fonction PHP/SQL portant ce nom et calculant une page HTML.
// Pour appeler la fonction produite, lui fournir 2 tableaux de 1 e'le'ment:
// - 1er: element 'cache' => nom (du fichier ou` mettre la page)
// - 2e: element 0 contenant un environnement ('id_article => $id_article, etc)
// Elle retourne alors un tableau de 4 e'le'ments:
// - 'texte' => page HTML, application du squelette a` l'environnement;
// - 'squelette' => le nom du squelette
// - 'process_ins' => 'html' ou 'php' selon la pre'sence de PHP dynamique
// - 'invalideurs' =>  de'pendances de cette page, pour invalider son cache.
// (voir son utilisation, optionnelle, dans invalideur.php)
// En cas d'erreur, elle retourne un tableau des 2 premiers elements seulement

function calculer_squelette($squelette, $nom, $gram, $sourcefile) {
# 3 variables qui sont en fait des constantes apr?s chargement
  global $table_primary, $table_des_tables, $tables_des_serveurs_sql;
	// Phraser le squelette, selon sa grammaire
	// pour le moment: "html" seul connu (HTML+balises BOUCLE)
	$boucles = '';
	spip_timer('calcul_skel');

	include_local("inc-$gram-squel.php3");

	$racine = parser($squelette, '',$boucles, $nom);

	// tableau des informations sur le squelette
	$descr = array('nom' => $nom, 'documents' => false);

	if ($boucles) {
	  // une boucle documents est conditionnee par tout le reste!
	  // une boucle avec critere de recheche conditionne tout le reste!
	  // (a cause du cas #nom_de_boucle:URL_*)
	  // 
		foreach($boucles as $idb => $boucle)
		  {
		    if ($boucle->param && is_array($boucle->param)) {
				if (($boucle->type_requete == 'documents') && 
				    in_array('doublons',$boucle->param))
				  { $descr['documents'] = true; break; }
				if (in_array('recherche',$boucle->param))
					$boucles[$idb]->hash = true;
			}
		  }
	// Commencer par reperer les boucles appelees explicitement 
	// car elles indexent les arguments de maniere derogatoire
		foreach($boucles as $id => $boucle) { 
			if ($boucle->type_requete == 'boucle') {
				$rec = &$boucles[$boucle->param];
				if (!$rec) {
					return array(_T('info_erreur_squelette'),
						($boucle->param
						. _L(' boucle recursive non definie')));
				} else {
					$rec->externe = $id;
					$descr['id_mere'] = $id;
					$boucles[$id]->return =
						calculer_liste(array($rec),
							 $descr,
							 $boucles,
							 $boucle->param);
				}
			}
		}
		foreach($boucles as $id => $boucle) { 
			$type = $boucle->type_requete;
			if ($type != 'boucle') {
				$boucles[$id]->id_table = $table_des_tables[$type];
				if ($boucles[$id]->id_table) {
					$boucles[$id]->primary = $table_primary[$type];
				} else { 
					// table non Spip.
					$boucles[$id]->id_table = $type;
					$serveur = $boucle->sql_serveur;
					$boucles[$id]->primary = $tables_des_serveurs_sql[$serveur ? $serveur : 'localhost'][$type]['key']["PRIMARY KEY"]; 
				}
				if ($boucle->param) {
					$res = calculer_criteres($id, $boucles);
					if (is_array($res))
						return $res; # erreur
				}
				$descr['id_mere'] = $id;
				$boucles[$id]->return =
				calculer_liste($boucle->milieu,
					 $descr,
					 $boucles,
					 $id);
			}
		}
	}

	// idem pour la racine
	$descr['id_mere'] = '';
	$corps = calculer_liste($racine, $descr, $boucles);

	// Corps de toutes les fonctions PHP,
	// en particulier les requetes SQL et TOTAL_BOUCLE
	// de'terminables seulement maintenant
	// Les 3 premiers parame`tres sont passe's par re'fe'rence
	// (sorte d'environnements a` la Lisp 1.5)
	// sauf pour la fonction principale qui recoit les initialisations

	$code = '';
	if ($boucles) {

		foreach($boucles as $id => $boucle) {
			// appeler la fonction de definition de la boucle
			$f = 'boucle_'.strtoupper($boucle->type_requete);
			// si pas de definition perso, definition spip
			if (!function_exists($f)) $f = $f.'_dist';
			// laquelle a une definition par defaut
			if (!function_exists($f)) $f = 'boucle_DEFAUT';
			$boucles[$id]->return = $f($id, $boucles);
		}

		foreach($boucles as $id => $boucle) {

			// Reproduire la boucle en commentaire
			$pretty = "BOUCLE$id(".strtoupper($boucle->type_requete).")";
		    if ($boucle->param && is_array($boucle->param)) 
				$pretty .= " {".join("} {", $boucle->param)."}";
			// sans oublier les parametres traites en amont
			if ($boucle->separateur)
			  $pretty .= '{"' . $boucle->separateur . '"}';
			if ($boucle->tout)
			  $pretty .= '{tout}';
			if ($boucle->plat)
			  $pretty .= '{plat}';
			$pretty = ereg_replace("[\r\n]", " ", $pretty);

			// Puis envoyer son code
			$codeboucle = "\n//\n// <$pretty>\n//\n"
			."function BOUCLE" . ereg_replace("-","_",$id) . $nom .
			'(&$Cache, &$Pile, &$doublons, &$Numrows, $SP) {' .
			$boucle->return;

			$fincode = "\n	return \$t0;"
			."\n}\n\n";

			## inserer les elements pour le debuggueur, a deux niveaux :
			## 1) apres le calcul d'une boucle compilee, envoyer le code
			##    compile vers boucle_debug_compile()
			## 2) le resultat de la boucle, lui, sera plus tard envoye vers
			##    boucle_debug_resultat()
			if ($GLOBALS['var_mode'] == 'debug') {
				boucle_debug_compile ($id, $nom, $pretty,
					$sourcefile, $codeboucle.$fincode);
				$codedebug = "
	boucle_debug_resultat('$id', '$nom', \$t0);";
			}

			$code .= $codeboucle.$codedebug.$fincode;
		}
	}

	$secondes = spip_timer('calcul_skel');
	spip_log("calcul skel $sourcefile ($secondes)");

	if (is_array($boucles))
		$aff_boucles = join (', ', array_keys($boucles));
	else
		$aff_boucles = "pas de boucle";

	$squelette_compile = "<"."?php
/*
 * Squelette : $sourcefile
 * Date :      ".http_gmoddate(@filemtime($sourcefile))." GMT
 * Compile :   ".http_gmoddate(time())." GMT ($secondes)
 * Boucles :   ".$aff_boucles."
 */
$code

//
// Fonction principale du squelette $sourcefile
//
function $nom (\$Cache, \$Pile, \$doublons=array(), \$Numrows='', \$SP=0) {
\$t0 = $corps;

	return array(
		'texte' => \$t0,
		'squelette' => '$nom',
		'process_ins' => ((strpos(\$t0,'<'.'?')=== false) ? 'html' : 'php'),
		'invalideurs' => \$Cache
	);
}

?".">";

	if ($GLOBALS['var_mode'] == 'debug')
		squelette_debug_compile($nom, $sourcefile, $squelette_compile);

	return $squelette_compile;

}

?>

--- NEW FILE: inc-urls-html.php3 ---
<?php

// executer une seule fois
if (defined("_INC_URLS2")) return;
define("_INC_URLS2", "1");

function generer_url_article($id_article) {
	return "article$id_article.html";
}

function generer_url_rubrique($id_rubrique) {
	return "rubrique$id_rubrique.html";
}

function generer_url_breve($id_breve) {
	return "breve$id_breve.html";
}

function generer_url_mot($id_mot) {
	return "mot$id_mot.html";
}

function generer_url_auteur($id_auteur) {
	return "auteur$id_auteur.html";
}

function generer_url_document($id_document) {
	if (intval($id_document) <= 0)
		return '';
	if ((lire_meta("creer_htaccess")) == 'oui')
		return "spip_acces_doc.php3?id_document=$id_document";
	if ($row = @spip_fetch_array(spip_query("SELECT fichier FROM spip_documents WHERE id_document = $id_document")))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;
	return;
}


//
// URLs des forums
//

// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
function racine_forum($id_forum){
	if (!$id_forum = intval($id_forum)) return;
	$query = "SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=".$id_forum;
	$result = spip_query($query);
	if($row = spip_fetch_array($result)){
		if($row['id_parent']) {
			return racine_forum($row['id_parent']);
		}
		else {
			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
		}
	}
} 

function generer_url_forum($id_forum, $show_thread=false) {
	list($type, $id, $id_thread) = racine_forum($id_forum);
	if ($id_thread>0 AND $show_thread)
		$id_forum = $id_thread;
	switch($type) {
		case 'article':
			return generer_url_article($id)."#forum$id_forum";
			break;
		case 'breve':
			return generer_url_breve($id)."#forum$id_forum";
			break;
		case 'rubrique':
			return generer_url_rubrique($id)."#forum$id_forum";
			break;
		default:
			return "forum$id_forum.html";
	}
}

?>

--- NEW FILE: inc-html-squel.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_HTML_SQUEL")) return;
define("_INC_HTML_SQUEL", "1");

# Ce fichier doit IMPERATIVEMENT contenir la fonction "parser"
# qui transforme un squelette en un tableau d'objets de classe Boucle
# il est charge par un include calcule dans inc-calcul-squel
# pour permettre differentes syntaxes en entree

define('NOM_DE_BOUCLE', "[0-9]+|[-_][-_.a-zA-Z0-9]*");
define('NOM_DE_CHAMP', "#((" . NOM_DE_BOUCLE . "):)?([A-Z_]+)(\*?)");
define('CHAMP_ETENDU', '\[([^]\[]*)\(' . NOM_DE_CHAMP . '([^]\[)]*)\)([^]\[]*)\]');
define('PARAM_DE_BOUCLE','[[:space:]]*\{[[:space:]]*([^{}]*(\{[^\}]*\}[^\}]*)*)[[:space:]]*\}');
define('TYPE_DE_BOUCLE', "[^)]*");
define('BALISE_DE_BOUCLE',
	"^<BOUCLE(" .
	NOM_DE_BOUCLE .
	')[[:space:]]*\((' .
	TYPE_DE_BOUCLE .
	')\)((' .
	PARAM_DE_BOUCLE .
	')*)[[:space:]]*>');
define('PARAM_INCLURE','[[:space:]]*\{[[:space:]]*([_0-9a-zA-Z]+)[[:space:]]*(=[[:space:]]*([^\{\}]*(\{[^\}]*\}[^\} ]*)?))?[[:space:]]*\}');
define('BALISE_INCLURE',"<INCLU[DR]E[[:space:]]*\(" .
       '([-_0-9a-zA-Z./ ]+)' .
	'\)((' .
	PARAM_INCLURE .
	')*)[[:space:]]*>');
define('DEBUT_DE_BOUCLE','/<B('.NOM_DE_BOUCLE.')>.*?<BOUCLE\1[^-_.a-zA-Z0-9]|<BOUCLE('.NOM_DE_BOUCLE.')/ms');	# preg


function parser_inclure($texte, $result) {
	while (($p=strpos($texte, '<INCLU')) !== false) {
		$fin = substr($texte, $p);

		if (!ereg('^' . BALISE_INCLURE, $fin, $match)) break;
		$s = $match[0];
		$debut = substr($texte, 0, $p);
		$texte = substr($fin, strlen($s));

		if ($debut) $result = parser_champs($debut, $result);

		$champ = new Inclure;
		$champ->fichier = $match[1];
		$champ->params = array();
		$p = trim($match[2]);
		if ($p) {
			while (ereg('^' . PARAM_INCLURE . '(.*)$', $p, $m)) {
				$champ->params[$m[1]] = $m[3];
				$p = $m[5];
			}
			
			if ($p)	erreur_squelette(_L("Param&egrave;tres d'inclusion incorrects"), $s);
		}
		$result[] = $champ;
	}

	return (!$texte ? $result : parser_champs($texte, $result));
}

function parser_champs($texte,$result) {
	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
	  $p = strpos($texte, $regs[0]);

	  if ($regs[4] || !ereg("[0-9a-z]", $regs[5][0])) {
		if ($p) {
			$champ = new Texte;
			$champ->texte = (substr($texte, 0, $p));
			$result[] = $champ;
		}
		  
		$champ = new Champ;
		$champ->nom_boucle = $regs[2];
		$champ->nom_champ = $regs[3];
		$champ->etoile = $regs[4];
		$texte = $regs[5];
		$result[] = $champ;
	  } else {
	    // faux champ
	    $champ = new Texte;
	    $champ->texte = (substr($texte, 0, $p+1));
	    $result[] = $champ;
	    $texte = (substr($texte, $p+1));
	  }
	}
	if ($texte) {
	  
		$champ = new Texte;
		$champ->texte = $texte;
		$result[] = $champ;
	}
	return $result;
}

// Gestion des imbrications:
// on cherches les [..] les plus internes et on les remplace par une  chaine
// %###N@ o? N indexe un tableau comportant le r?sultat de leur phras?
// on recommence tant qu'il y a des [...] en substituant ? l'appel suivant

function parser_champs_etendus($texte, $result) {
	if (!$texte) return $result;
	$sep = '##';
	while (strpos($texte,$sep)!== false)
		$sep .= '#';
	return array_merge($result, parser_champs_interieurs($texte, $sep, array()));
}


function parser_champs_exterieurs($debut, $sep, $nested) {
	$res = array();
	while (($p=strpos($debut, "%$sep"))!==false) {
	    if ($p) $res = parser_inclure(substr($debut,0,$p), $res);
	    ereg("^%$sep([0-9]+)@(.*)$", substr($debut,$p),$m);
	    $res[]= $nested[$m[1]];
	    $debut = $m[2];
	}
	return (!$debut ?  $res : parser_inclure($debut, $res));

}

function parser_champs_interieurs($texte, $sep, $result) {
	$i = 1;
	while (true) {	  $j=$i;
	  while (ereg(CHAMP_ETENDU . '(.*)$', $texte, $regs)) {
		$champ = new Champ;
		$champ->nom_boucle = $regs[3];
		$champ->nom_champ = $regs[4];
		$champ->etoile = $regs[5];
		$champ->cond_avant = parser_champs_exterieurs($regs[1],$sep,$result);
		$champ->cond_apres = parser_champs_exterieurs($regs[7],$sep,$result);
		$fonctions = $regs[6];
		if ($fonctions) {
			$fonctions = explode('|', ereg_replace("^\|", "", $fonctions));
			foreach($fonctions as $f) $champ->fonctions[]= $f;
		}

		$p = strpos($texte, $regs[0]);
		if ($p) {$result[$i] = substr($texte,0,$p);$i++; }
		$result[$i] = $champ;
		$i++;
		$texte = $regs[8];
	  }
	  if ($texte) {$result[$i] = $texte; $i++;}
	  $x ='';

	  while($j < $i) 
	    { $z= $result[$j]; 
	      if (is_object($z)) $x .= "%$sep$j@" ; else $x.=$z ;
	      $j++;}
	  if (ereg(CHAMP_ETENDU, $x)) $texte = $x;
	  else return parser_champs_exterieurs($x, $sep, $result);}
}


function parser_param($params, &$result) {
	$params2 = array();
	$type = $result->type_requete;
	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
		$params = $m[3];
		$m[1] = trim($m[1]);
		// cas d'un critere avec {...}
		if ($m[2])
			$params2[] = $m[1];
		else {
			if (strlen($m[1]) < 2)
				$params2[] = $m[1];
	    else {
	      ereg('^(.)([^"}]*)(.)$', $m[1], $args);
	      // cas syntaxique general, 
	      // traiter qq lexemes particuliers pour faciliter la suite
	      if ($args[3] != '"') {
			$param = $m[1];
			if (($param == 'tout') OR ($param == 'tous')) {
				$result->tout = true;
				unset ($param);
			}
			else if ($param == 'plat') {
				$result->plat = true;
				unset ($param);
			}

			// Boucle hierarchie, analyser le critere id_article - id_rubrique
			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
			// forcer {tout} pour avoir la rubrique mere...
			else if ($type == 'hierarchie') {
				if ($param == 'id_article' OR $param == 'id_syndic') {
					$result->tout = true;
					unset ($param);
				} else if ($param == 'id_rubrique')
					unset ($param);
			}

			// synonyme
			if ($param == 'unique') $param = 'doublons';

			// l'ajouter
			if ($param)
				$params2[] = $param;
	      }
		else {
		  // cas d'un guillemet final
			if ($args[1] == '"') {
			  // si tout le param est entre guillement, vite vu
				$result->separateur = 
					ereg_replace("'","\'",$args[2]);
			}
			else {
				$params2[] = $args[1] . $args[2] . '"' . $m[1];
			}
		}
	    }
	  }
	}
	$result->param = $params2;
}

function parser($texte, $id_parent, &$boucles, $nom) {

	$all_res = array();

	while (preg_match(DEBUT_DE_BOUCLE, $texte, $regs)) {
		$nom_boucle = $regs[1].$regs[2];
		$p = strpos($texte, '<BOUCLE'.$nom_boucle);

		// envoyer la boucle au debugueur
		if ($GLOBALS['var_mode']== 'debug') {
			$preg = "@<B($nom_boucle|OUCLE${nom_boucle}[^-_.a-zA-Z0-9][^>]*)>"
				. ".*</(BOUCLE|/?B)$nom_boucle>@ms";
			preg_match($preg, $texte, $match);
			boucle_debug ($nom_boucle, $nom, $match[0]);
		}

		//
		// Recuperer la partie principale de la boucle
		//
		$debut = substr($texte, 0, $p);
		$milieu = substr($texte, $p);

		if (!ereg(BALISE_DE_BOUCLE, $milieu, $match)) {
			erreur_squelette((_T('erreur_boucle_syntaxe')), $milieu);
		}
		$id_boucle = $match[1];

		$result = new Boucle;
		$result->id_parent = $id_parent;
		$result->id_boucle = $id_boucle;

		$type = $match[2];
		if ($p =strpos($type, ':'))
		  {
		    $result->sql_serveur = substr($type,0,$p);
		    $type = substr($type,$p+1);
		  }
		$type = strtolower($type);
		if ($type == 'sites') $type = 'syndication'; # alias

		//
		// Recuperer les criteres de la boucle (sauf boucle recursive)
		//
		if (substr($type, 0, 6) == 'boucle') {
			$result->type_requete = 'boucle';
			$result->param = substr($match[2], 6);
		} else {
			$result->type_requete = $type;
			parser_param($match[3], $result);
		}

		//
		// Recuperer la partie conditionnelle avant
		//
		$s = "<B$id_boucle>";
		$p = strpos($debut, $s);
		if ($p !== false) {
			$result->cond_avant = substr($debut, $p + strlen($s));
			$debut = substr($debut, 0, $p);
		}
		$milieu = substr($milieu, strlen($match[0]));
		if (strpos($milieu, $s)) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
				$id_boucle . 
				_L('&nbsp;: balise B en aval'));
		}

		//
		// Recuperer la fin :
		//
		$s = "</BOUCLE$id_boucle>";
		$p = strpos($milieu, $s);
		if ($p === false) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
					 _T('erreur_boucle_fermant',
						array('id'=>$id_boucle)));
		}
		$texte = substr($milieu, $p + strlen($s));
		$milieu = substr($milieu, 0, $p);

		//
		// 1. Recuperer la partie conditionnelle apres
		//
		$s = "</B$id_boucle>";
		$p = strpos($texte, $s);
		if ($p !== false) {
			$result->cond_fin = substr($texte, 0, $p);
			$texte = substr($texte, $p + strlen($s));
		}

		//
		// 2. Recuperer la partie alternative
		//
		$s = "<//B$id_boucle>";
		$p = strpos($texte, $s);
		if ($p !== false) {
			$result->cond_altern = substr($texte, 0, $p);
			$texte = substr($texte, $p + strlen($s));
		}

		$result->cond_avant = parser($result->cond_avant, $id_parent,$boucles, $nom);
		$result->cond_apres = parser($result->cond_fin, $id_parent,$boucles, $nom);
		$result->cond_altern = parser($result->cond_altern,$id_parent,$boucles, $nom);
		$result->milieu = parser($milieu, $id_boucle,$boucles, $nom);

		$all_res = parser_champs_etendus($debut, $all_res);
		$all_res[] = $result;
		if ($boucles[$id_boucle]) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
					 _T('erreur_boucle_double',
					 	array('id'=>$id_boucle)));
		} else
			$boucles[$id_boucle] = $result;
	}

	return parser_champs_etendus($texte, $all_res);
}

?>

--- NEW FILE: carto.php3 ---
<?php

$fond = "carto";
$delais = 24*3600;

include ("inc-public.php3");

?>

--- NEW FILE: index.php ---
<?php
	// pour hebergeurs ayant oublie de configurer DirectoryIndex index.php3
	include ("index.php3");
?>

--- NEW FILE: article.php3 ---
<?php

$fond = "article";
$delais = 24 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: habillage.css ---


/*
 * Mise en page des textes (bordures...)
 */

.chapo {
	line-height: 1.4em;
	margin-top: 1em;
}
.texte {
}
.ps {
	padding-top: 0.6em;
	margin-top: 0.6em;
	border-top: 1px dashed #404040;
}
.notes {
	margin-top: 0.6em;
	margin-bottom: 0.6em;
	border-top: 1px solid #a0a0a0;
	padding: 1.5em;
}

/*
 * Habillage des menus et de la navigation
 */

.menu {
	border: 1px solid #a0a0a0;
	border-top: 0px;
	padding: 0px;
	margin: 0px;
	margin-bottom: 16px;
}
.menu ul {
	display: block;
	margin: 0px;
	padding: 0px;
	padding-bottom: 4px;
	list-style: none;
}
.menu ol {
	display: block;
	margin: 0px;
	padding: 0px;
	padding-bottom: 4px;
	list-style: none;
}
.menu-titre {
	border-top: 1px solid #a0a0a0;
	border-bottom: 1px dashed #d0d0d0;
	margin: 0px;
	padding-left: 4px;
	padding-right: 4px;
	padding-top: 3px;
	padding-bottom: 2px;
	font-size: 90%;
}
.menu-item {
	margin: 0px;
	padding-left: 4px;
	padding-right: 4px;
	padding-top: 1px;
	padding-bottom: 1px;
	font-size: 80%;
}

/* Des couleurs specifiques selon les types de menus */

.general		{ background-color: #f8f8e8; text-align:center; }
.general .menu-titre 	{ background-color: #fcfcf0; }

.rubriques 		{ background-color: #eaffea; text-align:center; }
.rubriques .menu-titre	{ background-color: #f2fff2; }

.breves 		{ background-color: #ffeaea; }
.breves .menu-titre	{ background-color: #fff2f2; text-align:center; }

.divers 		{ background-color: #eaeaff; }
.divers .menu-titre	{ background-color: #f2f2ff; text-align:center; }

.forums 		{ background-color: #e8f8f8; }
.forums .menu-titre	{ background-color: #f0fcfc; text-align:center; }


/*
 * Styles pour le contenu (c-a-d. la colonne principale)
 */

.contenu {
	margin: 15px;
}
.contenu h2.titre-extrait {
}
.contenu h2.titre-texte {
}
.contenu .surtitre {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu .detail {
	margin-left: 2em;
}
.contenu .detail .important {
	color: #a02020;
}
.extrait {
	margin: 0.1em;
	margin-top: 0.5em;
	margin-bottom: 0.5em;
	margin-left: 2em;
	margin-right: 0.1em;
	line-height: 1.4em;
}
.liste-articles {
	margin-top: 1em;
	margin-bottom: 1em;
	clear: left;
}
.contenu .forum-repondre {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	text-align: left;
	font-size: 90%;
	font-weight: bold;
	margin-top: 0.6em;
}


/*
 * Disposition a l'ecran : colonnes, encarts, cartouches
 */

#principal {
	position: absolute;
	left: 30%;
	/*left: 18em;*/
	top: 0px;
	margin: 0px;
	padding: 0px;
	/*margin-right: 2em;*/
	margin-right: 3%;
	margin-top: 1.5em;
}

#plan {
	position: absolute;
	left: 2em;
	top: 0px;
	margin: 0px;
	padding: 0px;
	margin-right: 2em;
	margin-top: 2em;
}

#navigation {
	position: absolute;
	left: 0px;
	top: 0px;
	width: 24%;
	/*width: 14em;*/
	padding: 0px;
	margin: 0px;
	/*margin-left: 1.8em;*/
	margin-left: 3%;
	margin-top: 1.5em;
}

.encart {
	float: right;
	/*width: 14em;*/
	width: 34%;
	margin-left: 4%;
	/*margin-left: 2em;*/
	margin-top: 1em;
	margin-bottom: 0em;
	margin-right: 0px;
}

.cartouche {
	padding-top: 1em;
	border-top: 2px solid #404040;
	margin-bottom: 0em;
}

.cartouche .spip_logos {
	margin-left: 0px;
	padding-left: 0px;
	margin-right: 0.8em;
}


/*
 * Habillage du plan du site
 */

.plan-secteur {
	margin-top: 0em;
	margin-bottom: 3em;
	clear: right;
}

.plan-secteur h1 {
	display: block;
	border: 1px solid #a0a0a0;
	margin: 0px;
	padding: 8px;
	font-size: 150%;
	font-weight: bold;
	background-color: #e0ffe0;
	text-align:center;
}
.plan-rubriques {
	clear: left;
	display: block;
	list-style: none;
}
.plan-rubrique {
	display: inline;
	border: 1px solid #a0a0a0;
	padding: 3px;
	font-weight: bold;
}
.plan-articles {
	clear: left;
	margin-top: 0.5em;
	margin-bottom: 1em;
	list-style: square;
}

/* Eclaircissement progressif des rubriques en fonction de la profondeur */

ul .plan-rubrique {
	background-color: #e0ffe0;
	border-color: #b8b8b8;
}
ul ul .plan-rubrique {
	background-color: #eaffea;
	border-color: #d0d0d0;
}
ul ul ul .plan-rubrique {
	background-color: #f4fff4;
	border-color: #e8e8e8;
}


/*
 * Habillage des forums
 */

ul.forum-total {
	display: block;
	padding: 0px;
	margin: 0px;
	list-style: none;
}
.forum-fil {
	margin-top: 3em;
}
.forum-fil ul {
	display: block;
	margin: 0px;
	margin-left: 2em;
	padding: 0px;
	list-style: none;
}
.forum-titre {
	font-weight: bold;
	font-size: 120%;
}
.forum-item {
	margin: 0px;
	padding: 1em;
	padding-top: 0.5em;
	padding-bottom: 0em;
	text-align: justify;
	color: #303030;
	font-size: 80%;
}
.forum-repondre-message {
	text-align: right;
}

/* Boite d'un forum : eclaircissement progressif des bords */

ul .forum {
	border: 1px solid #909090;
	padding: 0px;
	margin: 0px;
	margin-bottom: 1em;
}
ul ul .forum {
	border: 1px solid #a4a4a4;
}
ul ul ul .forum {
	border: 1px solid #b8b8b8;
}
ul ul ul ul .forum {
	border: 1px solid #cccccc;
}
ul ul ul ul ul .forum {
	border: 1px solid #e0e0e0;
}
ul ul ul ul ul ul .forum {
	border: 1px dashed #e0e0e0;
}

/* Boite de titre d'un forum : mise en couleur selon la profondeur du forum */

ul .forum-chapo {
	border: 0px;
	border-bottom: 1px dashed #b8b8b8;
	margin: 0px;
	padding-left: 6px;
	padding-right: 6px;
	padding-top: 3px;
	padding-bottom: 2px;
	font-size: 90%;
	background: #c4e0e0;
}
ul ul .forum-chapo {
	background: #d4e8e8;
}
ul ul ul .forum-chapo {
	background: #e4f0f0;
}
ul ul ul ul .forum-chapo {
	background: #f4f8f8;
}
ul ul ul ul ul .forum-chapo {
	background: #ffffff;
}


/*
 * Habillage des petitions
 */

.signatures {
	margin-left: 0px;
	margin-right: 0px;
	margin-top: 1em;
	margin-bottom: 1em;
	width: 100%;
}
.signatures td {
	-moz-border-radius: 0.4em;
}
.signatures-titre {
	clear: right;
	font-weight: bold;
	font-size: 120%;
	text-align: center;
	padding: 0.5em;
	margin: 0px;
}
.signature-date {
	white-space: nowrap;
	background: #e4f0f0;
	padding: 0.5em;
}
.signature-nom {
	font-weight: bold;
	background: #ecf4f4;
	padding: 0.2em;
	text-align: center;
}
.signature-message {
	font-size: 85%;
	background: #f4f8f8;
	padding: 0.4em;
	text-align: justify;
}


/*
 * Formulaires
 */

.formrecherche {
	background-color: #f2f2f2;
	color: #505030;
	margin: 0px;
	padding: 2px;
	border: solid 1px #909090;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 80%;
	font-weight: normal;
}

.formulaire {
	color: black;
	margin: 0px;
	margin-bottom: 16px;
	padding: 4px;
	border: 1px solid #a0a0a0;
	background-color: #f6f6f6;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 80%;
	font-weight: normal;
}
.forml {
	background-color: #ececec;
	margin: 4px;
	padding: 1px;
	border: dashed 1px #909090;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 90%;
}
.spip_bouton {
	border: 2px solid #404040;
	padding: 3px;
	background: #d0d0d0;
	font-family: "Trebuchet MS", Tahoma, Arial, Helvetica, sans-serif;
}

.spip-admin {
}



--- NEW FILE: ical-dist.html ---
BEGIN:VCALENDAR
CALSCALE:GREGORIAN
X-WR-CALNAME;VALUE=TEXT:[(#NOM_SITE_SPIP|filtrer_ical)]
X-WR-RELCALID:[(#URL_SITE_SPIP|filtrer_ical)]
<BOUCLE_articles(ARTICLES){par date}{inverse}{0,100}>
BEGIN:VEVENT
SUMMARY:[(#TITRE|filtrer_ical)] [[(#NOM_SITE_SPIP|filtrer_ical)]]
UID:article#ID_ARTICLE @ [(#URL_SITE_SPIP|filtrer_ical)]
DTSTAMP:[(#DATE|date_ical)]
DTSTART:[(#DATE|date_ical)]
DTEND:[(#DATE|date_ical{60})]
CATEGORIES:<:articles|filtrer_ical:>
URL:#URL_SITE_SPIP/#URL_ARTICLE
STATUS:CONFIRMED
END:VEVENT
</BOUCLE_articles>
<BOUCLE_breves(BREVES){par date}{inverse}{0,100}>
BEGIN:VEVENT
SUMMARY:[(#TITRE|filtrer_ical)] [[(#NOM_SITE_SPIP|filtrer_ical)]]
UID:breve#ID_BREVE @ [(#URL_SITE_SPIP|filtrer_ical)]
DTSTAMP:[(#DATE|date_ical)]
DTSTART:[(#DATE|date_ical)]
DTEND:[(#DATE|date_ical{60})]
CATEGORIES:<:breves|filtrer_ical:>
URL:#URL_SITE_SPIP/#URL_BREVE
STATUS:CONFIRMED
END:VEVENT
</BOUCLE_breves>
END:VCALENDAR

--- NEW FILE: inc-compilo-api.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_COMPILO_API")) return;
define("_INC_COMPILO_API", "1");


// Definition des classes Boucle, Texte, Inclure, Champ

class Texte {
	var $type = 'texte';
	var $texte;
}

class Inclure {
	var $type = 'include';
	var $fichier;
	var $params;
}

//
// encodage d'une boucle SPIP en un objet PHP
//
class Boucle {
	var $type = 'boucle';
	var $id_boucle;
	var $id_parent ='';
	var $cond_avant, $milieu, $cond_apres, $cond_altern;
	var $lang_select;
	var $type_requete;
	var $sql_serveur;
	var $param = array();
	var $separateur;
	var $doublons;
	var $partie, $total_parties,$mode_partie;
	var $externe = ''; # appel a partir d'une autre boucle (recursion)
	// champs pour la construction de la requete SQL
	var $tout = false;
	var $plat = false;
	var $select;
	var $from;
	var $where;
	var $limit;
	var $group = '';
	var $order = '';
	var $date = 'date' ;
	var $hash = false ;
	var $lien = false;
	var $sous_requete = false;
	var $compte_requete = 1;
	var $hierarchie = '';
	// champs pour la construction du corps PHP
	var $id_table;
	var $primary;
	var $return;
	var $numrows = false; 
}

class Champ {
	var $type = 'champ';
	var $nom_champ;
	var $nom_boucle= ''; // seulement si boucle explicite
	var $cond_avant, $cond_apres; // tableaux d'objets
	var $fonctions;  // filtre explicites
	var $etoile;
	// champs pour la production de code
	var $id_boucle;
	var $boucles;
	var $type_requete;
	var $code;	// code du calcul
	var $statut;	// 'numerique, 'h'=texte (html) ou 'p'=script (php) ?
			// -> definira les pre et post-traitements obligatoires
	// champs pour la production de code dependant du contexte
	var $id_mere;    // pour TOTAL_BOUCLE hors du corps
	var $document;   // pour embed et img dans les textes
}


//
// Globales de description de la base

global $tables_des_serveurs_sql, $tables_principales; // (voir inc_serialbase)
global $exceptions_des_tables, $table_des_tables;
global $tables_relations,  $table_primary, $table_date;

$tables_des_serveurs_sql = array('localhost' => &$tables_principales);
	

	// champ principal des tables SQL
	$table_primary = array(
		'articles' => "id_article",
		'auteurs' => "id_auteur",
		'breves' => "id_breve",
		'documents' => "id_document",
		'forums' => "id_forum",
		'groupes_mots' => "id_groupe",
		'hierarchie' => "id_rubrique",
		'mots' => "id_mot",
		'rubriques' => "id_rubrique",
		'signatures' => "id_signature",
		'syndication' => "id_syndic",
		'syndic_articles' => "id_syndic_article",
		'types_documents' => "id_type"
	);
	
	# cf. fonction table_objet dans inc_version
	$table_des_tables = array(
		'articles' => 'articles',
		'auteurs' => 'auteurs',
		'breves' => 'breves',
		'forums' => 'forum',
		'signatures' => 'signatures',
		'documents' => 'documents',
		'types_documents' => 'types_documents',
		'mots' => 'mots',
		'groupes_mots' => 'groupes_mots',
		'rubriques' => 'rubriques',
		'syndication' => 'syndic',
		'syndic_articles' => 'syndic_articles',
		'hierarchie' => 'rubriques'
	);
	
	$exceptions_des_tables = array(
		'breves' => array(
			'id_secteur' => 'id_rubrique',
			'date' => 'date_heure',
			'nom_site' => 'lien_titre',
			'url_site' => 'lien_url'
			),
		'forums' => array(
			'date' => 'date_heure',
			'nom' => 'auteur',
			'email' => 'email_auteur'
			),
		'signatures' => array(
			'date' => 'date_time',
			'nom' => 'nom_email',
			'email' => 'ad_email'
		),
		'documents' => array(
			'type_document' => array('types_documents', 'titre'),
			'extension_document' => array('types_documents', 'extension')
		),
		'syndic_articles' => array(
			'url_article' => 'url',		  # ne sert pas ? cf balise_URL_ARTICLE
			'lesauteurs' => 'lesauteurs', # ne sert pas ? cf balise_LESAUTEURS
			'url_site' => array('syndic', 'url_site'),
			'nom_site' => array('syndic', 'nom_site')
		)
	);
	
	$table_date = array (
		'articles' => 'date',
		'auteurs' =>  'date',
		'breves' =>  'date_heure',
		'forums' =>  'date_heure',
		'signatures' => 'date_time',
		'documents' => 'date',
		'types_documents' => 'date',
		'groupes_mots' => 'date',
		'mots' => 'date',
		'rubriques' => 'date',
		'syndication' => 'date',
		'syndic_articles' => 'date'
	);


//
// tableau des tables de relations,
// Ex: gestion du critere {id_mot} dans la boucle(ARTICLES)
//

$tables_relations = array(
	'articles' => array (
		'id_mot' => 'mots_articles',
		'id_auteur' => 'auteurs_articles',
		'id_document' => 'documents_articles'
		),

	'auteurs' => array (
		'id_article' => 'auteurs_articles'
		),

	'breves' => array (
		'id_mot' => 'mots_breves',
		'id_document' => 'documents_breves'
		),

	'documents' => array (
		'id_article' => 'documents_articles',
		'id_rubrique' => 'documents_rubriques',
		'id_breve' => 'documents_breves'
		),

	'forums' => array (
		'id_mot' => 'mots_forum',
		),

	'mots' => array (
		'id_article' => 'mots_articles',
		'id_breve' => 'mots_breves',
		'id_forum' => 'mots_forum',
		'id_rubrique' => 'mots_rubriques',
		'id_syndic' => 'mots_syndic'
		),

	'groupes_mots' => array (
		'id_groupe' => 'mots'
		),

	'rubriques' => array (
		'id_mot' => 'mots_rubriques',
		'id_document' => 'documents_rubriques'
		),

	'syndication' => array (
		'id_mot' => 'mots_syndic'
		)
	);
?>

--- NEW FILE: formulaire_site-dist.html ---
<form action="#SELF" method="post">
      <br />
      <fieldset	class='spip_encadrer' style='color: black; font-size: 90%'>
	<legend></legend>
	<label>
	  <:form_prop_nom_site:>
	  <input type="text" class="forml" name="nom_site" value="" size="30">
	</label>
	<label>
	  <:form_prop_url_site:>
	  <input type="text" class="forml" name="url_site" value="" size="30">
	</label>
	<label><:form_prop_description:>
	  <textarea name='description_site' rows='5' class='forml' cols='40'></textarea>
	</label>
	<div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>"></div>
      </fieldset>
</form>

--- NEW FILE: inc-compilo-index.php3 ---
<?php


// fonctions de recherche et de reservation
// dans l'arborescence des boucles

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_COMPILO_INDEX")) return;
define("_INC_COMPILO_INDEX", "1");

// index_pile retourne la position dans la pile du champ SQL $nom_champ 
// en prenant la boucle la plus proche du sommet de pile (indique par $idb).
// Si on ne trouve rien, on considere que ca doit provenir du contexte 
// (par l'URL ou l'include) qui a ete recopie dans Pile[0]
// (un essai d'affinage a debouche sur un bug vicieux)
// Si ca reference un champ SQL, on le memorise dans la structure $boucles
// afin de construire un requete SQL minimale (plutot qu'un brutal 'SELECT *')

function index_pile($idb, $nom_champ, &$boucles, $explicite='') {
  global $exceptions_des_tables, $table_des_tables, $tables_des_serveurs_sql;

	$i = 0;
	if (strlen($explicite)) {
	// Recherche d'un champ dans un etage superieur
	  while (($idb != $explicite) && ($idb !='')) {
#		spip_log("Cherchexpl: $nom_champ '$explicite' '$idb' '$i'");
			$i++;
			$idb = $boucles[$idb]->id_parent;
		}
	}

	$c = strtolower($nom_champ);
	// attention: entre la boucle nommee 0, "" et le tableau vide,
	// il y a incoherences qu'il vaut mieux eviter
	while ($boucles[$idb]) {
#		spip_log("Cherche: $nom_champ '$idb' '$c'");
		$r = $boucles[$idb]->type_requete;
		$s = $boucles[$idb]->sql_serveur;
		if (!$s) 
		  { $s = 'localhost';
    // indirection (pour les rares cas ou le nom de la table!=type)
		    $t = $table_des_tables[$r];
		  }
		if (!$t) $t = $r; // pour les tables non Spip
		// $t est le nom PHP de cette table 
#		spip_log("Go: idb='$idb' r='$r' c='$c' nom='$nom_champ' s=$s");
		$desc = $tables_des_serveurs_sql[$s][$t];
		if (!$desc) {
			erreur_squelette(_L("Table SQL \"$r\" inconnue"), "'$idb'");
			# continuer pour chercher l'erreur suivante
			return  "'#" . $r . ':' . $nom_champ . "'";
		}
		$excep = $exceptions_des_tables[$r][$c];
		if ($excep) {
			// entite SPIP alias d'un champ SQL
			if (!is_array($excep)) {
				$e = $excep;
				$c = $excep;
			} 
			// entite SPIP alias d'un champ dans une autre table SQL
			else {
				$t = $excep[0];
				$e = $excep[1].' AS '.$c;
			}
		}
		else {
			// $e est le type SQL de l'entree
			// entite SPIP homonyme au champ SQL
			if ($desc['field'][$c])
				$e = $c;
			else
				unset($e);
		}

#		spip_log("Dans $idb ('$t' '$e'): $desc");

		// On l'a trouve
		if ($e) {
			$boucles[$idb]->select[] = $t . "." . $e;
			return '$Pile[$SP' . ($i ? "-$i" : "") . '][\'' . $c . '\']';
		}

		// Sinon on remonte d'un cran
		$idb = $boucles[$idb]->id_parent;
		$i++;
	}

#	spip_log("Pas vu $nom_champ dans les " . count($boucles) . " boucles");
	// esperons qu'il y sera
	return('$Pile[0][\''.$nom_champ.'\']');
}

# calculer_champ genere le code PHP correspondant a une balise Spip
# Retourne une EXPRESSION php 
function calculer_champ($p) {
	$p = calculer_balise($p->nom_champ, $p);

	// definir le type et les traitements
	// si ca ramene le choix par defaut, ce n'est pas un champ 

	if (($p->code) && ($p->code != '$Pile[0][\''.$nom.'\']')) {
		// Par defaut basculer en numerique pour les #ID_xxx
		if (substr($nom,0,3) == 'ID_') $p->statut = 'num';
	}

	else {
	// on renvoie la forme initiale '#TOTO'
	$p->code = "'#" . $nom . "'";
	$p->statut = 'php';	// pas de traitement
	
	}

	// Retourner l'expression php correspondant au champ + ses filtres
	return applique_filtres($p);
}

// cette fonction sert d'API pour demander le champ '$champ' dans la pile
function champ_sql($champ, $p) {
	return index_pile($p->id_boucle, $champ, $p->boucles, $p->nom_boucle);
}

// cette fonction sert d'API pour demander une balise quelconque sans filtre
function calculer_balise($nom, $p) {

	// regarder s'il existe une fonction personnalisee balise_NOM()
	$f = 'balise_' . $nom;
	if (function_exists($f))
		return $f($p);

	// regarder s'il existe une fonction standard balise_NOM_dist()
	$f = 'balise_' . $nom . '_dist';
	if (function_exists($f))
		return $f($p);

	// regarder s'il existe un fichier d'inclusion au nom de la balise
	// et contenant un tableau balise_NOM_collecte
	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
	if (@file_exists($file)) {
		include_local($file);
		$f = $GLOBALS['balise_' . $nom . '_collecte'];
		if (is_array($f))
			return calculer_balise_dynamique($p, $nom, $f);
	}

	// S'agit-il d'un logo ? Une fonction speciale les traite tous
	if (ereg('^LOGO_', $nom))
		return calculer_balise_logo($p);

	// ca pourrait etre un champ SQL homonyme,
	$p->code = index_pile($p->id_boucle, $nom, $p->boucles, $p->nom_boucle);

	// Compatibilite ascendante avec les couleurs html (#FEFEFE) :
	// SI le champ SQL n'est pas trouve
	// ET si la balise a une forme de couleur
	// ET s'il n'y a ni filtre ni etoile
	// ALORS retourner la couleur.
	// Ca permet si l'on veut vraiment de recuperer [(#ACCEDE*)]
	if (ereg("^[\$]Pile[[]0[]][[]'([A-F]{1,6})'[]]$", $p->code, $match)
	AND !$p->etoile
	AND !$p->fonctions) {
		$p->code = "'#". $match[1]."'";
		$p->statut = 'php';
	}

	return $p;
}

//
// Traduction des balises dynamiques, notamment les "formulaire_*"
// Inclusion du fichier associe a son nom.
// Ca donne les arguments a chercher dans la pile,on compile leur localisation
// Ensuite on delegue a une fonction generale definie dans inc-calcul-outils
// qui recevra a l'execution la valeurs des arguments, 
// ainsi que les filtres (qui ne sont donc pas traites ? la compil)

function calculer_balise_dynamique($p, $nom, $l) {
	balise_distante_interdite($p);
	$param = param_balise($p);
	$p->code = "executer_balise_dynamique('" . $nom . "',\n\tarray("
	  . join(',',collecter_balise_dynamique($l, $p))
	  . filtres_arglist($param, $p, ',')
	  . "),\n\tarray("
	  . (!$p->fonctions ? '' : ("'" . join("','", $p->fonctions) . "'"))
	  . "))";
	$p->statut = 'php';
	$p->fonctions = '';
	return $p;
}

function param_balise(&$p) 
{
	$a = $p->fonctions;
	if ($a) list(,$nom) = each($a) ; else $nom = '';
	if (!ereg(' *\{ *([^}]+) *\} *',$nom, $m))
	  return '';
	else {
		$filtres= array();
		while (list(, $f) = each($a)) if ($f) $filtres[] = $f;
		$p->fonctions = $filtres;
		return $m[1];
	}
}

// construire un tableau des valeurs interessant un formulaire

function collecter_balise_dynamique($l, $p) {
	$args = array();
	foreach($l as $c) { $x = calculer_balise($c, $p); $args[] = $x->code;}
	return $args;
}

// Genere l'application d'une liste de filtres
function applique_filtres($p) {
	$statut = $p->statut;
	$fonctions = $p->fonctions;
	$p->fonctions = ''; # pour r?utiliser la structure si r?cursion

	// pretraitements standards
	switch ($statut) {
		case 'num':
			$code = "intval($code)";
			break;
		case 'php':
			break;
		case 'html':
		default:
			$code = "trim($code)";
			break;
	}

//  processeurs standards (cf inc-balises.php3)
	$code = ($p->etoile ? $p->code : champs_traitements($p));
	// Appliquer les filtres perso
	if ($fonctions) {
		foreach($fonctions as $fonc) {
			if ($fonc) {
				$arglist = '';
				if (ereg('([^\{\}]*)\{(.+)\}$', $fonc, $regs)) {
					$fonc = $regs[1];
				        $arglist = filtres_arglist($regs[2],$p, ($fonc == '?' ? ':' : ','));
				}
				if (function_exists($fonc))
				  $code = "$fonc($code$arglist)";
				else if (strpos(" < > <= >= == <> ? ", " $fonc "))
				  $code = "($code $fonc "
				    . substr($arglist,1)
				    . ')';
				else 
				  $code = "erreur_squelette('".
					  texte_script(
						_T('erreur_filtre', array('filtre' => $fonc))
					)."','" . $p->id_boucle . "')";
			}
		}
	}

	// post-traitement securite
	if ($statut == 'html')
		$code = "interdire_scripts($code)";
	return $code;
}

// analyse des parametres d'un champ etendu
// [...(#CHAMP{parametres})...] ou [...(#CHAMP|filtre{parametres})...]
// retourne une suite de N references aux N valeurs indiqu?es avec N virgules

function filtres_arglist($args, $p, $sep) {
	$arglist ='';
	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
		$arg = trim($regs[1]);
		if ($arg) {
			if (ereg("^" . NOM_DE_CHAMP ."(.*)$", $arg, $regs2)) {
				$p->nom_boucle = $regs2[2];
				$p->nom_champ = $regs2[3];
				# faudrait verifier !trim(regs2[5])
				$arg = calculer_champ($p);
				
			} else if ($arg[0] =='$')
				$arg = '$Pile[0][\'' . substr($arg,1) . "']";
			$arglist .= $sep . $arg;
		}
		$args=$regs[2];
	}
	return $arglist;
}

//
// Reserve les champs necessaires a la comparaison avec le contexte donne par
// la boucle parente ; attention en recursif il faut les reserver chez soi-meme
// ET chez sa maman
// 
function calculer_argument_precedent($idb, $nom_champ, &$boucles) {

	// recursif ?
	if ($boucles[$idb]->externe)
		index_pile ($idb, $nom_champ, $boucles); // reserver chez soi-meme
	// reserver chez le parent et renvoyer l'habituel $Pile[$SP]['nom_champ']
#	spip_log("boucles[$idb]->id_parent " . $boucles[$idb]->id_parent);
	return index_pile ($boucles[$idb]->id_parent, $nom_champ, $boucles);
}

function rindex_pile($p, $champ, $motif) 
{
	$n = 0;
	$b = $p->id_boucle;
	$p->code = '';
	while ($b != '') {
	if ($s = $p->boucles[$b]->param) {
	  foreach($s as $v) {
		if (strpos($v,$motif) !== false) {
		  $p->code = '$Pile[$SP' . (($n==0) ? "" : "-$n") .
			"]['$champ']";
		  $b = '';
		  break;
		}
	  }
	}
	$n++;
	$b = $p->boucles[$b]->id_parent;
	}
	if (!$p->code) {
	  erreur_squelette(_L("Champ #" . strtoupper($champ) . " hors d'une boucle de motif $motif"), $p->id_boucle);
	}
	$p->statut = 'php';
	return $p;
}

?>

--- NEW FILE: mot.php3 ---
<?php
$fond = "mot";
$delais = 24 * 3600;


include ("inc-public.php3");


?>

--- NEW FILE: htaccess-html.txt ---
###########################################################
# Fichier .htaccess pour les URLs 'html' ; a installer    #
# si vous reglez $type_urls='html'                        #
# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
# (fichier associe : inc-urls-html.php3)                  #
###########################################################

RewriteEngine On

### si votre site est en sous-domaine, preciser ci-dessous
# RewriteBase /sous/domaine/

RewriteRule ^rubrique([0-9]+)\.html$	rubrique.php3?id_rubrique=$1 [QSA,L]
RewriteRule ^article([0-9]+)\.html$		article.php3?id_article=$1 [QSA,L]
RewriteRule ^breve([0-9]+)\.html$		breve.php3?id_breve=$1 [QSA,L]
RewriteRule ^mot([0-9]+)\.html$			mot.php3?id_mot=$1 [QSA,L]
RewriteRule ^auteur([0-9]+)\.html$		auteur.php3?id_auteur=$1 [QSA,L]

--- NEW FILE: inc-formulaire_site.php3 ---
<?php

global $balise_FORMULAIRE_SITE_collecte;
$balise_FORMULAIRE_SITE_collecte = array('id_rubrique', 'nom_site', 'url_site', 'description_site');

function balise_FORMULAIRE_SITE_stat($args, $filtres)
{
  return ((lire_meta("proposer_sites") != 2) ? '' : $args);
}

function balise_FORMULAIRE_SITE_dyn($id_rubrique, $nom_site, $url_site, $description_site) {

	if (!$nom_site) return array('formulaire_site', 0);

	// Tester le nom du site
	if (strlen ($nom_site) < 2){
		return _T('form_prop_indiquer_nom_site');
	}

	// Tester l'URL du site
	include_ecrire("inc_sites.php3");
	if (!recuperer_page($url_site)) {
		return _T('form_pet_url_invalide');
	}

	// Integrer a la base de donnees
		
	$nom_site = addslashes($nom_site);
	$url_site = addslashes($url_site);
	$description_site = addslashes($description_site);
			
	spip_query("INSERT INTO spip_syndic (nom_site, url_site, id_rubrique, descriptif, date, date_syndic, statut, syndication) VALUES ('$nom_site', '$url_site', $id_rubrique, '$description_site', NOW(), NOW(), 'prop', 'non')");
	return  _T('form_prop_enregistre');
}
?>

--- NEW FILE: inc-formulaire_ecrire_auteur.php3 ---
<?php

global $balise_FORMULAIRE_ECRIRE_AUTEUR_collecte ;
$balise_FORMULAIRE_ECRIRE_AUTEUR_collecte = array('id_auteur',
			     'email',
			     'sujet_message_auteur',
			     'texte_message_auteur',
			     'email_message_auteur'
);

function balise_FORMULAIRE_ECRIRE_AUTEUR_stat($args, $filtres)
{
  list($id_auteur, $mail, $sujet, $texte, $adres) = $args;
  return (!email_valide($mail) ? '' :
	  array($id_auteur, $mail,$sujet, $texte, $adres));
}

function balise_FORMULAIRE_ECRIRE_AUTEUR_dyn($id_auteur, $mail, $sujet, $texte, $adres) {
  global $spip_lang_rtl;
	include_ecrire("inc_lang.php3"); // pour spip_lang_rtl 
	if (!$spip_lang_rt) $spip_lang_rtl = '_rtl'; # INDISPENSABLE cf skel
	$mailko = $texte && !email_valide($adres);
	$validable = $texte && $sujet && (!$mailko);

	if ($validable && ($GLOBALS['valide'] == _T('form_prop_confirmer_envoi'))) { 
		$texte .= "\n\n-- "._T('envoi_via_le_site')." ".lire_meta('nom_site')." (".lire_meta('adresse_site')."/) --\n";
		include_ecrire("inc_mail.php3");
		envoyer_mail($mail, $sujet, $texte, $adres,
				"X-Originating-IP: ".$GLOBALS['REMOTE_ADDR']);
		return _T('form_prop_message_envoye');
	    }


	// repartir de zero pour les boutons car clean_link a pu etre utilisee

	$link = new Link;

	$link->delVar('sujet_message_auteur');
	$link->delVar('texte_message_auteur');
	$link->delVar('email_message_auteur');
	$link->delVar('id_auteur');
	return 
	  array('formulaire_ecrire_auteur', 0,
		array(
		      'action' => $link->getUrl(),
		      'id_auteur' => $id_auteur,
		      'mailko' => $mailko ? $spip_lang_rtl : '',
		      'mail' => $adres,
		      'sujetko' => ($texte && !$sujet) ? $spip_lang_rtl : '',
		      'sujet' => $sujet,
		      'texte' => $texte,
		      'valide' => ($validable ?
				    _T('form_prop_confirmer_envoi') :
				    _T('form_prop_envoyer'))
		      )
		);
}
?>

--- NEW FILE: inc-login_prive.php3 ---
<?php

include_local("inc-login_public.php3");

global $balise_LOGIN_PRIVE_collecte;
$balise_LOGIN_PRIVE_collecte = array('url');

# retourner:
# 1. l'url collectee ci-dessus (args0) ou donnee en filtre (filtre0)
# 2. l'eventuel parametre de la balise (args1) fournie par calculer_balise_dynamique

function balise_LOGIN_PRIVE_stat ($args, $filtres)
{
	return array($filtres[0] ? $filtres[0] : $args[0], $args[1]);
}

function balise_LOGIN_PRIVE_dyn($cible, $login)
{
	return login_explicite($login, $cible,  'redac');
}
?>

--- NEW FILE: backend.php3 ---
<?php
$fond = "backend";
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
// Et les headers !!!!

$flag_preserver = true;

@header("Content-type: text/xml");

include ("inc-public.php3");

?>

--- NEW FILE: inc-calcul-outils.php3 ---
<?php

//
// Des fonctions diverses utilisees lors du calcul d'une page ; ces fonctions
// bien pratiques n'ont guere de logique organisationnelle ; elles sont
// appelees par certaines balises au moment du calcul des pages. (Peut-on
// trouver un modele de donnees qui les associe physiquement au fichier
// definissant leur balise ???
//

// ON TROUVERA EN QUEUE DE FICHIER LES FONCTIONS FAISANT DES APPELS SQL


// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CALCUL_OUTILS")) return;
define("_INC_CALCUL_OUTILS", "1");

// Pour les documents comme pour les logos, le filtre |fichier donne
// le chemin du fichier apres 'IMG/' ;  peut-etre pas d'une purete
// remarquable, mais a conserver pour compatibilite ascendante.
// -> http://www.spip.net/fr_article901.html
function calcule_fichier_logo($on) {
	$r = ereg_replace("^" . _DIR_IMG, "", $on);
	return $r;
}

// Renvoie le code html pour afficher un logo, avec ou sans survol, lien, etc.
// utilise la globale ci-dessous pour les attributs hspace & vspace

tester_variable('espace_logos',3);

function affiche_logos($logos, $lien, $align) {
	static $num_survol=0;
	global $espace_logos;
	list ($arton, $artoff) = $logos;

	if (!$arton) return $artoff;

	$num_survol++;
	$milieu = "<img src='$arton'"
		. ($align ? " align='$align' " : '') 
		. " name='image$num_survol' border='0' "
		. "alt='image$num_survol'"
		. " hspace='$espace_logos' vspace='$espace_logos' class='spip_logos' />";

	if (!$artoff) return ($lien ? http_href($lien, $milieu) : $milieu);

	$att =	"onmouseover=\"image$num_survol.src='$artoff'\" 
		onmouseout=\"image$num_survol.src='$arton'\"";

	return ($lien ? "<a href='$lien' $att>$milieu</a>" : "<div $att>$milieu</div>");

}

//
// Retrouver le logo d'un objet (et son survol)
//

function calcule_logo($type, $onoff, $id, $id_rubrique, $ff) {
	include_ecrire('inc_logos.php3');

	$table_logos = array (
	'ARTICLE' => 'art',
	'AUTEUR' =>  'aut',
	'BREVE' =>  'breve',
	'MOT' => 'mot',
	'RUBRIQUE' => 'rub',
	'SITE' => 'site'
	);
	$type = $table_logos[$type];
	$nom = strtolower($onoff);
	# attention au cas $id = '0' pour LOGO_SITE_SPIP : utiliser intval()
	while (1) {
		$on = cherche_image_nommee($type . $nom . intval($id));
		if ($on) {
			if ($ff)
			  return  (array('', "$on[1].$on[2]"));
			else {
				$off = ($onoff != 'ON') ? '' :
					cherche_image_nommee($type . 'off' . $id);
				return array ("$on[0]$on[1].$on[2]",
					      ($off ? ("$off[0]$off[1].$off[2]") : ''));
			}
		}
		else if ($id_rubrique) {
			$type = 'rub';
			$id = $id_rubrique;
			$id_rubrique = 0;
		} else if ($id AND $type == 'rub')
			$id = sql_parent($id);
		else return array('','');
	}
}

//
// fonction standard de calcul de la balise #INTRODUCTION
// on peut la surcharger en definissant dans mes_fonctions.php3 :
// function introduction($type,$texte,$chapo,$descriptif) {...}
//
function calcul_introduction ($type, $texte, $chapo='', $descriptif='') {
	if (function_exists("introduction"))
		return introduction ($type, $texte, $chapo, $descriptif);

	switch ($type) {
		case 'articles':
			if ($descriptif)
				return propre($descriptif);
			else if (substr($chapo, 0, 1) == '=')	// article virtuel
				return '';
			else
				return PtoBR(propre(supprimer_tags(couper_intro($chapo."\n\n\n".$texte, 500))));
			break;
		case 'breves':
			return PtoBR(propre(supprimer_tags(couper_intro($texte, 300))));
			break;
		case 'forums':
			return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
			break;
		case 'rubriques':
			if ($descriptif)
				return propre($descriptif);
			else
				return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
			break;
	}
}

function executer_balise_dynamique($nom, $args, $filtres) {
	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
	include_local($file);

	$f = 'balise_' . $nom . '_stat';
	$r = $f($args, $filtres);
	if (!is_array($r))
		return $r;
	else { 
		return
		('<'.'?php 
include_ecrire(\'inc_lang.php3\');
lang_select($GLOBALS["spip_lang"]);
include_local("'
		. $file
		. '");
inclure_balise_dynamique(balise_'
		. $nom
		. '_dyn(\''
		. join("', '", array_map("addslashes", $r))
		. '\'));
	lang_dselect();
?'
		.">");
	}
}

//
// FONCTIONS FAISANT DES APPELS SQL
//

# NB : a l'exception des fonctions pour les balises dynamiques

function calcul_exposer ($id, $type, $reference) {
	static $exposer;
	static $ref_precedente;

	// Que faut-il exposer ? Tous les elements de $reference
	// ainsi que leur hierarchie ; on ne fait donc ce calcul
	// qu'une fois (par squelette) et on conserve le resultat
	// en static.
	if ($reference<>$ref_precedente) {
		$ref_precedente = $reference;

		$exposer = array();
		foreach ($reference as $element=>$id_element) {
			if ($element == 'id_secteur') $element = 'id_rubrique';
			if ($x = table_from_primary($element)) {
				list($table,$hierarchie) = $x;
				$exposer[$element][$id_element] = true;
				if ($hierarchie) {
					list ($id_rubrique) = spip_abstract_fetsel(
array('id_rubrique'), 
array($table),
array("$element=$id_element"));
				$hierarchie = substr(calculer_hierarchie($id_rubrique), 2);
				foreach (split(',',$hierarchie) as $id_rubrique)
					$exposer['id_rubrique'][$id_rubrique] = true;
				}
			}
		}
	}

	// And the winner is...
	return $exposer[$type][$id];
}

function table_from_primary($id) {
	global $tables_principales;
	include_ecrire('inc_serialbase.php3');
	foreach ($tables_principales as $k => $v) {
		if ($v['key']['PRIMARY KEY'] == $id)
			return array($k, array_key_exists('id_rubrique', $v['field']));
	}
	return '';
}

function calcul_generation ($generation) {
	$lesfils = array();
	$result = spip_abstract_select(array('id_rubrique'),
				array('rubriques AS rubriques'),
				array(calcul_mysql_in('id_parent', 
					$generation,
					'')),
				'','','','','','','');
	while ($row = spip_abstract_fetch($result))
		$lesfils[] = $row['id_rubrique'];
	return join(",",$lesfils);
}

function calcul_branche ($generation) {
	if (!$generation) 
		return '0';
	else {
		$branche[] = $generation;
		while ($generation = calcul_generation ($generation))
			$branche[] = $generation;
		return join(",",$branche);
	}
}

// fonction appelee par la balise #LOGO_DOCUMENT
function calcule_document($id_document, $doubdoc, &$doublons) {
	if (!$id_document) return '';
	if ($doubdoc && $id_document) $doublons["documents"] .= ', ' . $id_document;

	if (!($row = spip_abstract_select(array('id_type', 'id_vignette', 'fichier', 'mode'), array('documents AS documents'), array("id_document = $id_document"))))
// pas de document. Ne devrait pas arriver
		return ''; 

	list($id_type, $id_vignette, $fichier, $mode) = spip_abstract_fetch($row);
	if ($id_vignette) {
		if ($res = spip_abstract_select(array('fichier'), array('documents AS documents'), array("id_document = $id_vignette"))) {
			list($vignette) = spip_abstract_fetch($res);
			if (@file_exists($vignette))
				return generer_url_document($id_vignette);
				# return ($fichier); # en std g_u_d fait ca
		}
	} else if ($mode == 'vignette') 
		return generer_url_document($id_document);
		# return $fichier; # en std g_u_d fait ca

// calcul de l'extension par tous les moyens
	if ($id_type) {
		list($ext) = spip_abstract_fetch(spip_abstract_select(array('extension'), array('types_documents AS documents'), array("id_type = " . intval($id_type))));
	} else {
		eregi('\.([a-z0-9]+)$', $fichier, $regs);
		$ext = $regs[1];
	}
// Pas de vignette mais une extension:
// prendre la vignette de celle-ci dans IMG/icones sauf si on peut faire mieux
	$formats = ','.lire_meta('formats_graphiques').',';
	if ((strpos($formats, ",$ext,") === false) OR
	!$fichier OR (lire_meta("creer_preview") != 'oui')) {
		return vignette_par_defaut($ext ? $ext : 'txt', false);
	}
// on peut faire mieux dans le cas des images: une previsualisation
// on devrait verifier que le fichier existe dans IMG/vignette
// et sinon lancer creer_vignette (qui fera un UPDATE sur spip_documents)
// mais on risque de d?passer le temps alloue au processus
	return 'spip_image.php3?vignette='.rawurlencode(
		str_replace('../', '', $fichier));
}


// fonction appelee par la balise #EMBED
function calcule_embed_document($id_document, $filtres, &$doublons, $doubdoc) {
	if ($doubdoc && $id_document) $doublons["documents"] .= ', ' . $id_document;
	return embed_document($id_document, $filtres, false);
}

// fonction appelee par la balise #NOTES
function calculer_notes() {
	$r = $GLOBALS["les_notes"];
	$GLOBALS["les_notes"] = "";
	$GLOBALS["compt_note"] = 0;
	$GLOBALS["marqueur_notes"] ++;
	return $r;
}

# retourne la profondeur d'une rubrique

function sql_profondeur($id) {
	$n = 0;
	while ($id) {
		$n++;
		$id = sql_parent($id);
	}
	return $n;
}


function sql_parent($id_rubrique) {
	$row = spip_abstract_fetsel(array(id_parent), 
			array('rubriques'), 
			array("id_rubrique=" . intval($id_rubrique)));
	return $row['id_parent'];
}

function sql_rubrique($id_article) {
	$row = spip_abstract_fetsel(array('id_rubrique'),
			array('articles'),
			array("id_article=" . intval($id_article)));
	return $row['id_rubrique'];
}

function sql_auteurs($id_article, $table, $id_boucle, $serveur='') {
	$auteurs = "";
	if ($id_article) {
		$result_auteurs = spip_abstract_select(array('auteurs.nom', 'auteurs.email'),
			array('auteurs AS auteurs',
				'auteurs_articles AS lien'), 
			array("lien.id_article=$id_article",
				"auteurs.id_auteur=lien.id_auteur"),
			'','','','',1, 
			$table, $id_boucle, $serveur);

		while($row_auteur = spip_abstract_fetch($result_auteurs, $serveur)) {
			$nom_auteur = typo($row_auteur["nom"]);
			$email_auteur = $row_auteur["email"];
			if ($email_auteur) {
				$auteurs[] = "<a href=\"mailto:$email_auteur\">$nom_auteur</a>";
			} else {
				$auteurs[] = "$nom_auteur";
			}
		}
	}
	return (!$auteurs) ? "" : join($auteurs, ", ");
}

function sql_petitions($id_article, $table, $id_boucle, $serveur, &$Cache) {
	$retour = spip_abstract_fetsel(
			array('texte'),
			array('petitions'),
			array("id_article=".intval($id_article)),
			'','','','',1, 
			$table, $id_boucle, $serveur);

	if (!$retour) return '';
	# cette page est invalidee par toute petition
	if ($Cache) $Cache['petition']['petition'] = 1;
	# ne pas retourner '' car le texte sert aussi de pr?sence
	return ($retour['texte'] ? $retour['texte'] : ' ');
}

# retourne le chapeau d'un article, et seulement s'il est publie

function sql_chapo($id_article) {
	return spip_abstract_fetsel(array('chapo'),
		array('articles'),
		array("id_article=".intval($id_article),
		"statut='publie'"));
}

// Calcul de la rubrique associee a la requete
// (selection de squelette specifique par id_rubrique & lang)

function sql_rubrique_fond($contexte, $lang) {

	if ($id = intval($contexte['id_rubrique'])) {
		$row = spip_abstract_fetsel(array('lang'),
					    array('rubriques'),
					    array("id_rubrique=$id"));
		if ($row['lang'])
			$lang = $row['lang'];
		return array ($id, $lang);
	}

	if ($id  = intval($contexte['id_breve'])) {
		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
			array('breves'), 
			array("id_breve=$id"));
		$id_rubrique_fond = $row['id_rubrique'];
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}

	if ($id = intval($contexte['id_syndic'])) {
		$row = spip_abstract_fetsel(array('id_rubrique'),
			array('syndic'),
			array("id_syndic=$id"));
		$id_rubrique_fond = $row['id_rubrique'];
		$row = spip_abstract_fetsel(array('lang'),
			array('rubriques'),
			array("id_rubrique='$id_rubrique_fond'"));
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}

	if ($id = intval($contexte['id_article'])) {
		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
			array('articles'),
			array("id_article=$id"));
		$id_rubrique_fond = $row['id_rubrique'];
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}
}

?>
--- NEW FILE: formulaire_login-dist.html ---
[(#HTTP_VARS{echec_cookie})
	<h3 class="spip"><:erreur_probleme_cookie:></h3>
		<b><:login_cookie_oblige:></b>
		  <:login_cookie_accepte:><p />
][
(#HTTP_VARS*{message})
	<br />
	 <:forum_vous_enregistrer:>
	[<a href='(#URL_SITE_SPIP|inscriptionok{forum})spip_inscription.php3?mode=forum&amp;focus=nom_inscription&amp;target=spip_pass'
	target="spip_pass"
	onclick="javascript:window.open(this.href, 'spip_inscription', 'scrollbars=yes, resizable=yes, width=480, height=450'); return false;"><:forum_vous_inscrire:></a>]&nbsp;&nbsp;&#91;<a
		href="spip_pass.php3"
		target="spip_pass" 
		onclick="javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=280'); return false;"><:login_motpasseoublie:></a>&#93;<br /><br />
]<div style="font-family: Verdana,arial,helvetica,sans-serif; font-size: 12px;">
	<script type="text/javascript" src="ecrire/md5.js"></script>
	<form	id="login[_(#HTTP_VARS{login})]"
		action="[(#HTTP_VARS{action2})]"
		method="post"[(#HTTP_VARS{source}|=={spip}|?{' ',''})
		onSubmit='if (this.session_password.value) {
			this.session_password_md5.value = calcMD5("[(#HTTP_VARS{alea_actuel})]" + this.session_password.value);
			this.next_session_password_md5.value = calcMD5("[(#HTTP_VARS{alea_futur})]" + this.session_password.value);
			this.session_password.value = "";
			}']>
		<div class="spip_encadrer" style="[(#URL_SITE_SPIP|style_align)]">[
			<div class="reponse_formulaire">(#HTTP_VARS*{erreur})<br /><br /></div>
][
			<label><b><:login_login2:></b><br /></label>(#HTTP_VARS{login}|?{'',' '})
			<input type="text" id='var_login' name="var_login" class="forml" value="" size="40" />
][
<div>
			<input type="hidden" name="session_login_hidden" value="(#HTTP_VARS{login})" />
<script type="text/javascript"><!--
document.write("<:login_login:>&nbsp;<b>[(#HTTP_VARS{login})]<" + "/b><br />&#91;<a href='spip_cookie.php3?cookie_admin=non&amp;url=[(#HTTP_VARS{url})]'><font size='2'><:login_autre_identifiant:><" + "/font><" + "/a>&#93;")
//--></script>
<noscript>
	<font face="Georgia, Garamond, Times, serif" size="3">
		<:login_non_securise:>
		<a href="[(#HTTP_VARS{action})]"><:login_recharger:></a>
	</font>
	<label><b><:login_login2:></b><br /></label>
	<input type='text' name='session_login' class='forml' [value="(#HTTP_VARS{login})" ]size='40' />
</noscript>
[<img	src="(#HTTP_VARS{id_auteur}|silogoauteur)"
	width="75"
	valign="top"
	align="right"
	alt="[(#HTTP_VARS{login})]"><br /><br /><br />]
</div>
<p>
		<label><b><:login_pass2:></b></label>&nbsp;<input type="password" name="session_password"[ id="var_login_(#HTTP_VARS{login})]" class="forml" value="" size="40" />
		<br />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox"
			 name="session_remember"
			 id="session[_(#HTTP_VARS{login})]"
			 value="oui"[(#HTTP_VARS*{prefs}|filtre_rester_connecte)checked="checked"]/>
		<label for="session[_(#HTTP_VARS{login})]"><:login_rester_identifie:></label>
</p>
		<input type="hidden" name="session_password_md5" value="" />
		<input type="hidden" name="next_session_password_md5" value="" />
		<input type="hidden" name="essai_login" value="oui" />
]		<input type="hidden" name="url" value="[(#HTTP_VARS{url})]" />
		<div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>" /></div>
		</div>
	</form>
<script type="text/javascript"><!--
document.getElementById('var_login[_(#HTTP_VARS{login})]').focus()
--></script>[
	<form action="(#HTTP_VARS{auth})" method="get">
		<fieldset>
		<p>
		<:login_preferez_refuser:>
		<input type="hidden" name="essai_auth_http" value="oui"/>
		[<input type="hidden" name="url" value="(#HTTP_VARS{url})"/>]
		<div align="right"><input type="submit" class="spip_bouton" value="<:login_sans_cookiie:>"/></div>
		</fieldset>
	</form>
]
</div>

--- NEW FILE: formulaire_admin-dist.html ---
<div class="spip-admin-float">
<div class="spip-admin-bloc" dir='#LANG_DIR'>
<div class="spip-admin">
	<ul>[
	<li><a href='ecrire/articles.php3?id_article=(#HTTP_VARS{id_article})' class='spip-admin-boutons'><:admin_modifier_article:> ([(#HTTP_VARS{id_article})])</a></li>][
	<li><a href='ecrire/breves_voir.php3?id_breve=(#HTTP_VARS{id_breve})' class='spip-admin-boutons'><:admin_modifier_breve:> ([(#HTTP_VARS{id_breve})])</a></li>][
	<li><a href='ecrire/naviguer.php3?id_rubrique=(#HTTP_VARS{id_rubrique})' class='spip-admin-boutons'><:admin_modifier_rubrique:> ([(#HTTP_VARS{id_rubrique})])</a></li>][
	<li><a href='ecrire/mots_edit.php3?id_mot=(#HTTP_VARS{id_mot})' class='spip-admin-boutons'><:admin_modifier_mot:> ([(#HTTP_VARS{id_mot})])</a></li>][
	<li><a href='ecrire/auteurs_edit.php3?id_auteur=(#HTTP_VARS{id_auteur})' class='spip-admin-boutons'><:admin_modifier_auteur:> ([(#HTTP_VARS{id_auteur})])</a></li>]
	<li><a href='[(#HTTP_VARS{action})]var_mode=recalcul' class='spip-admin-boutons'><:admin_recalculer:>[(#HTTP_VARS{use_cache})]</a></li>[
	<li><a href='ecrire/(#HTTP_VARS{statistiques})[id_article=(#HTTP_VARS{id_article})]' class='spip-admin-boutons'><:info_visites:>&nbsp;[(#HTTP_VARS{visites})];&nbsp;<:info_popularite_5:>&nbsp;[(#HTTP_VARS{popularite})]</a></li>][
	<li><a href='[(#HTTP_VARS{action})]var_mode=(#HTTP_VARS{debug})' class='spip-admin-boutons'>Debug</a></li>]
	</ul>
</div>
</div>
</div>

--- NEW FILE: inc-formulaire_signature.php3 ---
<?php

// Formulaire de signature d'une petition
//

global $balise_FORMULAIRE_SIGNATURE_collecte;
$balise_FORMULAIRE_SIGNATURE_collecte = array('petition', 'id_article', 'nom_email', 'adresse_email', 'message', 'signature_nom_site', 'signature_url_site', 'url_page', 'val_confirm');

function balise_FORMULAIRE_SIGNATURE_stat($args, $filtres)
{
  return ($args[0] ? $args : '');
}

function balise_FORMULAIRE_SIGNATURE_dyn($texte, $id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm) {

	include_local(_FILE_CONNECT);
	if ($val_confirm)
		return reponse_confirmation($id_article);
	else if ($nom_email AND $adresse_email)
		return  reponse_signature($id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm);
	else {
		$row = spip_fetch_array(spip_query("SELECT * FROM spip_petitions WHERE id_article='$id_article'"));
		return !$row ? '': array('formulaire_signature', 0, $row);
	}
}


// Retour a l'ecran du lien de confirmation d'une signature de petition.
// Si val_confirm est non vide, c'est l'appel en debut de inc-public
// pour vider le cache au demarrage afin que la nouvelle signature apparaisse.
// Sinon, c'est l'execution du formulaire et on retourne le message 
// de confirmation ou d'erreur construit lors de l'appel par inc-public.

function reponse_confirmation($id_article, $val_confirm = '') {
	static $confirm = '';

	if (!$val_confirm) return $confirm;
	include_local(_FILE_CONNECT);
	if ($GLOBALS['db_ok']) {
		include_ecrire("inc_texte.php3");
		include_ecrire("inc_filtres.php3");

		// Eviter les doublons
		$lock = "petition $id_article $val_confirm";
		if (!spip_get_lock($lock, 5)) {
			$confirm= _T('form_pet_probleme_technique');
		}
		else {
			$query_sign = "SELECT * FROM spip_signatures WHERE statut='".addslashes($val_confirm)."'";
			$result_sign = spip_query($query_sign);
			if (spip_num_rows($result_sign) > 0) {
				while($row = spip_fetch_array($result_sign)) {
					$id_signature = $row['id_signature'];
					$id_article = $row['id_article'];
					$date_time = $row['date_time'];
					$nom_email = $row['nom_email'];
					$adresse_email = $row['ad_email'];
					$nom_site = $row['nom_site'];
					$url_site = $row['url_site'];
					$message = $row['message'];
					$statut = $row['statut'];
				}
	
				$query_petition = "SELECT * FROM spip_petitions WHERE id_article=$id_article";
				$result_petition = spip_query($query_petition);
	
				while ($row = spip_fetch_array($result_petition)) {
					$id_article = $row['id_article'];
					$email_unique = $row['email_unique'];
					$site_obli = $row['site_obli'];
					$site_unique = $row['site_unique'];
					$message_petition = $row['message'];
					$texte_petition = $row['texte'];
				}
	
				if ($email_unique == "oui") {
					$email = addslashes($adresse_email);
					$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND ad_email='$email' AND statut='publie'";
					$result = spip_query($query);
					if (spip_num_rows($result) > 0) {
						$confirm= (_T('form_pet_deja_signe'));
						$refus = "oui";
					}
				}
	
				if ($site_unique == "oui") {
					$site = addslashes($url_site);
					$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND url_site='$site' AND statut='publie'";
					$result = spip_query($query);
					if (spip_num_rows($result) > 0) {
						$confirm= (_T('form_pet_deja_enregistre'));
						$refus = "oui";
					}
				}
	
				if ($refus == "oui") {
					$confirm= (_T('form_deja_inscrit'));
				}
				else {
					$query = "UPDATE spip_signatures SET statut='publie' WHERE id_signature='$id_signature'";
					$result = spip_query($query);
					// invalider les pages ayant des boucles signatures
					include_ecrire('inc_invalideur.php3');
					include_ecrire('inc_meta.php3');
					suivre_invalideur("id='petition/petition'");
	
					$confirm= (_T('form_pet_signature_validee'));
				}
			}
			else {
				$confirm= (_T('form_pet_aucune_signature'));
			}
			spip_release_lock($lock);
		}
	}
	else {
		$confirm= _T('form_pet_probleme_technique');
	}
}

//
// Retour a l'ecran de la signature d'une petition
//

function reponse_signature($id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm) {

	if ($GLOBALS['db_ok']) {
		include_ecrire("inc_texte.php3");
		include_ecrire("inc_filtres.php3");
		include_ecrire("inc_mail.php3");

		// Eviter les doublons
		$lock = "petition $id_article $adresse_email";
		if (!spip_get_lock($lock, 5)) {
			return _T('form_pet_probleme_technique');
		} else {
			$query_petition = "SELECT * FROM spip_petitions WHERE id_article=$id_article";
			$result_petition = spip_query($query_petition);
	
			while ($row = spip_fetch_array($result_petition)) {
				$id_article = $row['id_article'];
				$email_unique = $row['email_unique'];
				$site_obli = $row['site_obli'];
				$site_unique = $row['site_unique'];
				$message_petition = $row['message'];
				$texte_petition = $row['texte'];
			}
	
			if (strlen($nom_email) < 2) {
				return (_T('form_indiquer_nom'));
			}
	
			if ($adresse_email == _T('info_mail_fournisseur')) {
				return (_T('form_indiquer_email'));
			}
	
			if ($email_unique == "oui") {
				$email = addslashes($adresse_email);
				$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND ad_email='$email' AND statut='publie'";
				$result = spip_query($query);
				if (spip_num_rows($result) > 0) {
					return (_T('form_pet_deja_signe'));
				}
			}
	
			if (!email_valide($adresse_email)) {
				return (_T('form_email_non_valide'));
			}
	
			if ($site_obli == "oui") {
				if (!$nom_site) {
					return (_T('form_indiquer_nom_site'));
				}
				include_ecrire("inc_sites.php3");
	
				if (!recuperer_page($url_site)) {
					return (_T('form_pet_url_invalide'));
				}
			}
			if ($site_unique == "oui") {
				$site = addslashes($url_site);
				$query = "SELECT * FROM spip_signatures WHERE id_article=$id_article AND url_site='$site' AND (statut='publie' OR statut='poubelle')";
				$result = spip_query($query);
				if (spip_num_rows($result) > 0) {
					return (_T('form_pet_site_deja_enregistre'));
				}
			}
	
			$passw = test_pass();
	
			if ($refus == "oui") {
				return _T('form_pet_signature_pasprise');
			}
			else {
				$query_site = "SELECT titre FROM spip_articles WHERE id_article=$id_article";
				$result_site = spip_query($query_site);
				while ($row = spip_fetch_array($result_site)) {
					$titre = $row['titre'];
				}

				$link = new Link($url_page);
				$link->addVar('val_confirm', $passw);
				$url = $link->getUrl("sp$id_article");
	
				$messagex = _T('form_pet_mail_confirmation', array('titre' => $titre, 'nom_email' => $nom_email, 'nom_site' => $nom_site, 'url_site' => $url_site, 'url' => $url));

				if (envoyer_mail($adresse_email, _T('form_pet_confirmation')." ".$titre, $messagex)) {

					$nom_email = addslashes($nom_email);
					$adresse_email = addslashes($adresse_email);
					$nom_site = addslashes($nom_site);
					$url_site = addslashes($url_site);
					$message = addslashes($message);
	
					spip_query("INSERT INTO spip_signatures (id_article, date_time, nom_email, ad_email, nom_site, url_site, message, statut) VALUES ('$id_article', NOW(), '$nom_email', '$adresse_email', '$nom_site', '$url_site', '$message', '$passw')");
					return _T('form_pet_envoi_mail_confirmation');
				}
				else {
					return _T('form_pet_probleme_technique');
				}
			}
			spip_release_lock($lock);
		}
	}
	else {
		return _T('form_pet_probleme_technique');
	}

}


function test_pass() {
	include_ecrire("inc_acces.php3");
	for (;;) {
		$passw = creer_pass_aleatoire();
		$query = "SELECT statut FROM spip_signatures WHERE statut='$passw'";
		$result = spip_query($query);
		if (!spip_num_rows($result)) break;
	}
	return $passw;
}

?>

--- NEW FILE: inc-criteres.php3 ---
<?php

//
// Definition des {criteres} d'une boucle
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CRITERES")) return;
define("_INC_CRITERES", "1");


// {racine}
// http://www.spip.net/@racine
function critere_racine_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];

	if ($param != 'racine' OR $not)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$boucle->where[] = $boucle->id_table.".id_parent='0'";

}

// {exclus}
// http://www.spip.net/@exclus
function critere_exclus_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	$id = $boucle->primary;

	if ($param != 'exclus' OR $not OR !$id)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$arg = calculer_argument_precedent($idb,$id, $boucles);
	$boucle->where[] = $boucle->id_table . '.' . $id."!='\"." . $arg . ".\"'";

}

// {doublons} ou {unique}
// http://www.spip.net/@doublons
function critere_doublons_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];

	if (!preg_match("/(doublons|unique)[[:space:]]*([a-z_0-9]*)/i",
	$param, $match))
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$boucle->doublons = $boucle->type_requete . $match[2];
	$boucle->where[] = '" .' .
		"calcul_mysql_in('".$boucle->id_table . '.' . $boucle->primary."', "
		.'"0".$doublons[\''.$boucle->doublons."'], 'NOT') . \"";
}

// {lang_select}
// http://www.spip.net/@lang_select
function critere_lang_select_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if (preg_match('/lang_select(=(oui|non))?$/i', $param, $match)) {
		if (!$lang_select = $match[2])
			$lang_select = 'oui';
		if ($not)
			$lang_select = ($lang_select=='oui')?'non':'oui';
		$boucle->lang_select = $lang_select;
	}
	else erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {debut_xxx}
// http://www.spip.net/@debut_
function critere_debut_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if (ereg('^debut([-_a-zA-Z0-9]+),([0-9]*)$', $param, $match)) {
		$debut_lim = "debut".$match[1];
		$boucle->limit =
			'intval($GLOBALS["'.$debut_lim.'"]).",'.$match[2] .'"' ;
	}
	else erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {recherche}
// http://www.spip.net/@recherche
function critere_recherche_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];

	$table = $boucle->id_table;	#articles
	$id_table = 'id_'.preg_replace('/s$/', '', $table); 	#id_article

	// horrible hack du aux id_forum = spip_forum et id_article=spip_articleS
	// en fait il faudrait la fonction inverse de table_objet()
	$id = 'id_'.preg_replace('/s$/', '', $boucle->id_table);

	$boucle->select[] = $boucle->id_table . '.' . $boucle->primary; # pour postgres, neuneu ici
	$boucle->select[] = '$rech_select'; # pour les ... as points

	// et la recherche trouve
	$boucle->where[] = '$rech_where';
}

// {inverse}
// http://www.spip.net/@inverse
function critere_inverse_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	// Classement par ordre inverse
	if ($param == 'inverse' AND !$not) {
		if ($boucle->order)
			$boucle->order .= ".' DESC'";
		else 
			erreur_squelette(_L("inversion d'un ordre inexistant"), 
			"BOUCLE" . $idb);
	} else
		erreur_squelette(_T('info_erreur_squelette'), "{$param} BOUCLE$idb");
}

// {traduction}
// http://www.spip.net/@traduction
//   (id_trad>0 AND id_trad=id_trad(precedent))
//    OR id_article=id_article(precedent)
function critere_traduction_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($param == 'traduction') {
		$boucle->where[] = "((".$boucle->id_table.".id_trad > 0 AND "
			. $boucle->id_table.".id_trad ='\"."
			. calculer_argument_precedent($idb, 'id_trad',
				$boucles)
			. ".\"')
		OR
			(" . $boucle->id_table.".".$boucle->primary." ='\"."
			. calculer_argument_precedent($idb, $boucle->primary,
				$boucles)
			. ".\"'))";
	} else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {origine_traduction}
// http://www.spip.net/@origine_traduction
function critere_origine_traduction_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($param == 'origine_traduction')
		$boucle->where[] = $boucle->id_table.".id_trad = "
		. $boucle->id_table . '.' . $boucle->primary;
	else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}


// {meme_parent}
// http://www.spip.net/@meme_parent
function critere_meme_parent_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($param != 'meme_parent')
		erreur_squelette(_T('info_erreur_squelette'), $param);
	else {
		if ($boucle->type_requete == 'rubriques') {
			$boucle->where[] = $boucle->id_table.".id_parent='\"."
			. calculer_argument_precedent($idb, 'id_parent',
			$boucles)
			. ".\"'";
		} else if ($boucle->type_requete == 'forums') {
			$boucle->where[] = $boucle->id_table.".id_parent='\"."
			. calculer_argument_precedent($idb, 'id_parent',
			$boucles)
			. ".\"'";
			$boucle->where[] = $boucle->id_table.".id_parent > 0";
			$boucle->plat = true;
		} else
			erreur_squelette(_L("{meme_parent} ne s'applique qu'aux boucles (FORUMS) ou (RUBRIQUES)"), "BOUCLE" . $idb);
	}
}

// {branche ?}
// http://www.spip.net/@branche
function critere_branche_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if (preg_match('/branche[[:space:]]*([?])?$/i', $param, $regs)) {
		$c = "calcul_mysql_in('".$boucle->id_table.".id_rubrique',
		calcul_branche(" . calculer_argument_precedent($idb,
		'id_rubrique', $boucles) . "), '')";
		if (!$regs[1])
			$where = "\". $c .\"" ;
		else
			$where = "\".("
			. calculer_argument_precedent($idb, 'id_rubrique',
			$boucles)."? $c : 1).\"";

		if ($not)
			$boucle->where[] = "NOT($where)";
		else
			$boucle->where[] = $where;
	} else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}

// Tri : {par xxxx}
// http://www.spip.net/@par
function critere_par_dist($idb, &$boucles, $param, $not) {
	$boucle = &$boucles[$idb];
	if ($not)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$param = substr($param,3);

	while ($param) {
	  spip_log($param);
		preg_match('/[[:space:]]*([^,]*)[[:space:]]*,?(.*)/ims',
			   $param, $regs);
		$param = $regs[2];
		$tri = trim($regs[1]);

	// par hasard
		if ($tri == 'hasard') {
		// tester si cette version de MySQL accepte la commande RAND()
		// sinon faire un gloubi-boulga maison avec de la mayonnaise.
		  if (spip_query("SELECT RAND()"))
			$boucle->select[] = "RAND() AS alea";
		  else
			$boucle->select[] = "MOD(".$boucle->id_table.'.'.$boucle->primary
			." * UNIX_TIMESTAMP(),32767) & UNIX_TIMESTAMP() AS alea";

		$order = "'alea'";
		}

	// par titre_mot
		else if ($tri == 'titre_mot') {
		  $order= "'mots.titre'";
		}

	// par type_mot
		else if ($tri == 'type_mot'){
		  $order= "'mots.type'";
		}
	// par num champ(, suite)
		else if (ereg("^num[[:space:]]+(.*)$",$tri, $match2)) {
		  $boucle->select[] = "0+".$boucle->id_table.".".$match2[1]." AS num";
		  $order = "'num'";
	}
	// par champ. Verifier qu'ils sont presents.
		else if (ereg("^[a-z][a-z0-9]*$", $tri)) {
		  if ($tri == 'date')
		    $order = "'".$boucle->id_table.".".
		      $GLOBALS['table_date'][$boucle->type_requete]
		      ."'";
		  else {
			global $table_des_tables, $tables_des_serveurs_sql;
			$r = $boucle->type_requete;
			$s = $boucles[$idb]->sql_serveur;
			if (!$s) $s = 'localhost';
			$t = $table_des_tables[$r];
			if (!$t) $t = $r; // pour les tables non Spip
			$desc = $tables_des_serveurs_sql[$s][$t];
			if ($desc['field'][$tri])
				$order = "'".$boucle->id_table.".".$tri."'";
			else {
			  // tri sur les champs synthetises (cf points)
				$order = "'".$tri."'";
			}
		  }
		}
	// tris specifies par l'URL ?
		else {
		  $order = simplifie_param_dynamique($tri, $boucles, $idb);
		  if ($order == $tri) $order = "'" . $order . "'";
		}
	// au final, gestion des tris multiples
		if ($order) {
		  if ($boucle->order) $boucle->order .= '.",".';
		  $boucle->order .= $order;

		}
	}
}



function calculer_critere_parties($idb, &$boucles, $param, $not, $match) {
  global $tables_relations, $table_des_tables, $table_date, $tables_des_serveurs_sql;
	$boucle = &$boucles[$idb];
	list(,$a1,$op,$a2) = $match;
	list($a11,$a12) = calculer_critere_parties_aux($idb, $boucles, $a1);
	list($a21,$a22) = calculer_critere_parties_aux($idb, $boucles, $a2);

	if (($op== ',')&&(is_numeric($a11) && (is_numeric($a21))))
		$boucle->limit = $a11 .',' . $a21;
	else {
	  $boucle->partie =	($a11 != 'n') ? $a11 : $a12;
		$boucle->total_parties =  ($a21 != 'n') ? $a21 : $a22;
		$boucle->mode_partie = (($op == '/') ? '/' :
				(($a1=='n')?'-':'+').(($a2=='n')?'-':'+'));
	}
}

function calculer_critere_parties_aux($idb, &$boucles, $param) {
	ereg('^(([0-9]+)|n|(#.*))(-([0-9]+))?$', $param, $m);
	if ($m[1] == 'n') 
	  $a = 'n';
	else {
	  $a = simplifie_param_dynamique($m[1], $boucles, $idb);
	}
	return array($a, ($m[5] ? $m[5] : 0));
}

//
// La fonction d'aiguillage sur le nom du criteres
//

function calculer_criteres ($idb, &$boucles) {

	foreach($boucles[$idb]->param as $param) {
		// Analyse du critere
		preg_match("/^([!]?)[[:space:]]*(debut|([a-z_]+))/ism",
			$param, $match);
		$critere = $match[2];
		$not = ($match[1] == '!');

		// critere personnalise ?
		$f = "critere_".$critere;
		if (!function_exists($f))
			$f .= '_dist';

		// fonction critere standard ?
		if (!function_exists($f))
			$f = 'calculer_critere_DEFAUT';

		// Applique le critere
		$res = $f($idb, $boucles, $param, $not);

		// gestion d'erreur
		if (is_array($res)) erreur_squelette($res);
	}
}

# Criteres numeriques et de comparaison

function calculer_critere_DEFAUT($idb, &$boucles, $param, $not) {
	global $table_des_tables, $table_date, $tables_des_serveurs_sql;

	$boucle = &$boucles[$idb];
	$type = $boucle->type_requete;
	$id_table = $boucle->id_table;
	$primary = $boucle->primary;
	$id_field = $id_table . '.' . $primary; 

	if (ereg('^([0-9a-zA-Z#_\{\}]+)([,/])([0-9a-zA-Z#_\{\}]+)$', $param, $match))
	  calculer_critere_parties($idb, $boucles, $param, $not, $match);

		// Restriction de valeurs (implicite ou explicite)
	else if (eregi('^([a-z_]+\(?[a-z_]*\)?) *(\??)((!?)(<=?|>=?|==?|IN) *"?([^<>=!"]*))?"?$', $param, $match)) {
	  		$op = $match[5] ? $match[5] : '=';
			// Variable comparee
			$col = $match[1];
			// fonction SQL
			$fct = '';
			if (ereg("([a-z_]+)\(([a-z_]+)\)", $col,$match3)) {
				$col = $match3[2];
				$fct = $match3[1];
			}
			$col_table = $id_table;
			// Valeur de comparaison
			if ($match[3]) {
				if (strtoupper($op) != 'IN') {
					$val = calculer_param_dynamique($match[6], $boucles, $idb);
					// gestion d'erreur
					if (is_array($val)) erreur_squelette($val);
				}
				else {
				// traitement special des valeurs textuelles
				  $val = calculer_params_dynamiques($match[6], $boucles, $idb);
				}
			}
			
			else {
				$val = $match[1];

				// Cas special {lang} : aller chercher $GLOBALS['spip_lang']
				if ($val == 'lang')
					$val = '".$GLOBALS[\'spip_lang\']."';
				else {
				// Si id_parent, comparer l'id_parent avec l'id_objet
				// de la boucle superieure
					if ($val == 'id_parent')
						$val = $primary;
				// Si id_enfant, comparer l'id_objet avec l'id_parent
				// de la boucle superieure
					else if ($val == 'id_enfant')
						$val = 'id_parent';
					$val = calculer_argument_precedent($idb, $val, $boucles) ;
					if (ereg('^\$',$val))
						$val = '" . addslashes(' . $val . ') . "';
					else
						$val = addslashes($val);
				}

			}

			if ($s = calculer_critere_externe($boucle, $id_field,$col, $type))
				$col_table = $s;

			// Cas particulier pour les raccourcis 'type_mot' et 'titre_mot'
			else if ($type != 'mots'
			AND ($col == 'type_mot' OR $col == 'titre_mot'
			OR $col == 'id_groupe')) {
				if ($type == 'forums')
					$col_lien = "forum";
				else if ($type == 'syndication')
					$col_lien = "syndic";
				else
					$col_lien = $type;
				$boucle->from[] = "mots_$col_lien AS lien_mot";
				$boucle->from[] = 'mots AS mots';
				$boucle->where[] = "$id_field=lien_mot." . $primary;
				$boucle->where[] = 'lien_mot.id_mot=mots.id_mot';
				$boucle->group = $id_field;
				$boucle->select[] = $id_field; # pour postgres, neuneu ici
				$col_table = 'mots';

				$boucle->lien = true;
				if ($col == 'type_mot')
					$col = 'type';
				else if ($col == 'titre_mot')
					$col = 'titre';
				else if ($col == 'id_groupe')
					$col = 'id_groupe';
			}

			// Cas particulier : selection des documents selon l'extension
			if ($type == 'documents' AND $col == 'extension')
				$col_table = 'types_documents';
			// HACK : selection des documents selon mode 'image'
			// (a creer en dur dans la base)
			else if ($type == 'documents' AND $col == 'mode'
			AND $val == 'image')
				$val = 'vignette';
			// Cas particulier : lier les articles syndiques
			// au site correspondant
			else if ($type == 'syndic_articles' AND
			!ereg("^(id_syndic_article|titre|url|date|descriptif|lesauteurs)$",$col))
				$col_table = 'syndic';

			// Cas particulier : id_enfant => utiliser la colonne id_objet
			if ($col == 'id_enfant')
				$col = $primary;
			// Cas particulier : id_secteur = id_rubrique pour certaines tables
			if (($type == 'breves' OR $type == 'forums') AND $col == 'id_secteur')
				$col = 'id_rubrique';

			// Cas particulier : expressions de date
			if (ereg("^(date|mois|annee|age|age_relatif|jour_relatif|mois_relatif|annee_relatif)(_redac)?$", $col, $regs)) {
				$col = $regs[1];
				if ($regs[2]) {
					$date_orig = $id_table . ".date_redac";
					$date_compare = '\'" . normaliser_date(' .
					calculer_argument_precedent($idb, 'date_redac', $boucles) .
					') . "\'';
				}
				else {
					$date_orig = "$id_table." . $table_date[$type];
					$date_compare = '\'" . normaliser_date(' .
					  calculer_argument_precedent($idb, 'date', $boucles) .
					  ') . "\'';
				}

				if ($col == 'date') {
					$col = $date_orig;
					$col_table = '';
				}
				else if ($col == 'mois') {
					$col = "MONTH($date_orig)";
					$col_table = '';
				}
				else if ($col == 'annee') {
					$col = "YEAR($date_orig)";
					$col_table = '';
				}
				else if ($col == 'age') {
					$col = calculer_param_date("now()", $date_orig);
					$col_table = '';
				}
				else if ($col == 'age_relatif') {
					$col = calculer_param_date($date_compare, $date_orig);
					$col_table = '';
				}
				else if ($col == 'jour_relatif') {
					$col = "LEAST(TO_DAYS(" .$date_compare . ")-TO_DAYS(" .
					$date_orig . "), DAYOFMONTH(" . $date_compare .
					")-DAYOFMONTH(" . $date_orig . ")+30.4368*(MONTH(" .
					$date_compare . ")-MONTH(" . $date_orig .
					"))+365.2422*(YEAR(" . $date_compare . ")-YEAR(" .
					$date_orig . ")))";
					$col_table = '';
				}
				else if ($col == 'mois_relatif') {
					$col = "MONTH(" . $date_compare . ")-MONTH(" .
					$date_orig . ")+12*(YEAR(" . $date_compare .
					")-YEAR(" . $date_orig . "))";
					$col_table = '';
				}
				else if ($col == 'annee_relatif') {
					$col = "YEAR(" . $date_compare . ")-YEAR(" .
					$date_orig . ")";
					$col_table = '';
				}
			}

			if ($type == 'forums' AND
			($col == 'id_parent' OR $col == 'id_forum'))
				$boucle->plat = true;

			// Operateur de comparaison
			if ($col_table)
				$col = "$col_table.$col";

			if (strtoupper($op) == 'IN') {
				// traitement special des valeurs textuelles
				$where = "$col IN ($val)";
				if ($match[4] == '!') {
					$where = "NOT ($where)";
				} else {
					if (!$boucle->order) {
						$boucle->order = 'rang';
						$boucle->select[] =
						"FIND_IN_SET($col, \\\"$val\\\") AS rang";
					}
				}
			} else {
				if ($op == '==') $op = 'REGEXP';
				if ($fct) $col = "$fct($col)";
				if ($match[4] == '!')
					$where = "NOT ($col $op '$val')";
				else
					$where = "($col $op '$val')";

				// operateur optionnel {lang?}
				if ($match[2]) {
					$champ = calculer_argument_precedent($idb, $match[1], $boucles) ;
					$where = "\".($champ ? \"$where\" : 1).\"";
				}

			}
			$boucle->where[] = $where;
	} // fin du if sur les restrictions de valeurs
	else erreur_squelette(_L("critere inconnu $param"));
}

// traitement des relations externes par une jointure.
// tant qu'a faire eviter de dupliquer sa declaration,
// mais c'est une goutte d'eau dans la mer

function calculer_critere_externe(&$boucle, $id_field, $col, $type)
{
	global $tables_relations;
	if ($col_table =  $tables_relations[$type][$col]) {
		$externe = "$id_field=$col_table." . $boucle->primary;
		if (!$boucle->where || (!in_array($externe, $boucle->where))) {

			$boucle->lien = true;
			$boucle->from[] = "$col_table AS $col_table";
			$boucle->where[] = $externe;
			$boucle->group = $id_field;
		// postgres exige que le champ pour GROUP soit dans le SELECT
			$boucle->select[] = $id_field;
		}
	}
	return $col_table;
}


function calculer_param_date($date_compare, $date_orig) {
	return
	"LEAST((UNIX_TIMESTAMP(" .
	$date_compare .
	")-UNIX_TIMESTAMP(" .
	$date_orig .
	"))/86400,\n\tTO_DAYS(" .
	$date_compare .
	")-TO_DAYS(" .
	$date_orig .
	"),\n\tDAYOFMONTH(" .
	$date_compare .
	")-DAYOFMONTH(" .
	$date_orig .
	")+30.4368*(MONTH(" .
	$date_compare .
	")-MONTH(" .
	$date_orig .
	"))+365.2422*(YEAR(" .
	$date_compare .
	")-YEAR(" .
	$date_orig .
	")))";
}

//
// Calculer les parametres
//
function calculer_param_dynamique($val, &$boucles, $idb) {
#	if (ereg('^ *\((.*)) *$', $val, $m)) $val = $m[1]; # si on veut (#...)
	if (ereg(NOM_DE_CHAMP . "(\{[^}]*\})?", $val, $regs)) {
	  	$champ = new Champ;
		$champ->nom_boucle = $regs[2];
		$champ->nom_champ = $regs[3];
		$champ->etoile = $regs[4];
		$champ->fonctions = $regs[5] ? array($regs[5]) : '';
		$champ->id_boucle = $boucles[$idb]->id_parent;
		$champ->boucles = &$boucles;
		$champ->id_mere = $idb;
		$champ = calculer_champ($champ);
		return '" . addslashes(' . $champ . ') . "';

	} else {
	  if ($val[0]== '%') {
	    spip_log($val .
		     " est obsolete; utiliser HTTP_VARS{" .  substr($val,1) . "}");
		  return '" . addslashes($Pile[0][\''. substr($val,1)  ."']) . \"";
	  }
		else
		  return addslashes($val);
	}
}

function calculer_params_dynamiques($liste, &$boucles, $idb) {
	ereg("^ *\(?(.*[^)])\)? *$",$liste, $reg);
	$res = array();
	foreach (split(" *, *", $reg[1]) as $v) {
	  $v = calculer_param_dynamique($v, $boucles, $idb);
	  if (is_array($v)) erreur_squelette($v);
	  if (strpos('0123456789',$v[0]) !== false)
	    $res[] = $v;
	  else if ($v[0]=='"')
	    $res[] = "'" . $v . "'";
	  else
	    $res[] = "'$v'";
	}
	return join(',', $res);
}

function simplifie_param_dynamique($val, &$boucles, $idb)
{
	$a = calculer_param_dynamique($val, $boucles, $idb);
	if (!ereg('" \. *(.*)\. "', $a, $m)) return $a;
	return $m[1];
}	
?>

--- NEW FILE: inc-public-global.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_PUBLIC_GLOBAL")) return;
define("_INC_PUBLIC_GLOBAL", "1");

//
// Aller chercher la page dans le cache ou pas
//
function obtenir_page ($contexte, $chemin_cache, $delais, &$use_cache, $fond, $inclusion=false) {
	global $lastmodified;

	if (!$use_cache) {
		include_local('inc-calcul.php3');

		// page globale ? calculer le contexte
		if (!$contexte)
			$contexte = calculer_contexte();

		spip_timer('calculer_page');
		$page = calculer_page($chemin_cache,
			array('fond' => $fond,
				'contexte' => $contexte),
			$delais,
			$inclusion);

		$lastmodified = time();

		// log
		if (!$log = $chemin_cache) $log = "($fond, delais=$delais, "
		. $GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'].")";
		spip_log (($inclusion ? 'calcul inclus':'calcul').' ('
		.spip_timer('calculer_page')."): $log");

		// Nouveau cache : creer un invalideur 't' fixant la date
		// d'expiration et la taille du fichier
		if (@file_exists($chemin_cache)) {
			// Ici on ajoute 3600s pour eviter toute concurrence
			// entre un invalideur et un appel public de page
			$bedtime = time() + $delais + 3600;
			$taille = @filesize($chemin_cache);
			$fichier = addslashes($chemin_cache);
			spip_query("INSERT IGNORE INTO spip_caches (fichier,id,type,taille)
			VALUES ('$fichier','$bedtime','t','$taille')");
		}

	} else {

		//
		// Lire le fichier cache
		//
		lire_fichier ($chemin_cache, $page['texte']);
		$lastmodified = max($lastmodified, @filemtime($chemin_cache));
		# spip_log ("cache $chemin_cache $lastmodified");

		//
		// Lire sa carte d'identite & fixer le contexte global
		//
		if (preg_match("/^<!-- ([^\n]*) -->\n(.*)/ms", $page['texte'], $match)
		AND is_array($meta_donnees = unserialize($match[1]))) {
			foreach ($meta_donnees as $var=>$val)
				$page[$var] = $val;

			$page['texte'] = $match[2];

			// Remplir les globals pour les boutons d'admin
			if (!$inclusion AND is_array($page['contexte']))
				foreach ($page['contexte'] as $var=>$val)
					$GLOBALS[$var] = $val;
		}

	}

	return $page;
}


//
// Appeler cette fonction pour obtenir la page principale
//
function afficher_page_globale ($fond, $delais, &$use_cache) {
	global $flag_preserver, $flag_dynamique, $lastmodified;
	global $var_preview, $var_mode;
	include_local ("inc-cache.php3");

	// demande de previsualisation ?
	// -> inc-calcul.php3 n'enregistrera pas les fichiers caches
	// -> inc-reqsql-squel.php3 acceptera les objets non 'publie'
	if ($var_preview == 'oui') {
		// Verifier qu'on a le droit de previsualisation
		$statut = $GLOBALS['auteur_session']['statut'];
		if ($statut=='0minirezo' OR
		(lire_meta('preview')=='1comite' AND $statut=='1comite')) {
			$var_mode = 'recalcul';
			$delais = 0;
			$var_preview = true;
			spip_log('preview !');
		}
	}

	// Faut-il effacer des pages invalidees ?
	if (lire_meta('invalider')) {
		include_ecrire('inc_meta.php3');
		lire_metas();
		if (lire_meta('invalider'))
			retire_caches();
	}

	// Calculer le chemin putatif du cache
	$chemin_cache = generer_nom_fichier_cache('', $fond);

	// Peut-on utiliser un fichier cache ?
	determiner_cache($delais, $use_cache, $chemin_cache);

	// Repondre gentiment aux requetes sympas
	// (ici on ne tient pas compte d'une obsolence du cache ou des
	// eventuels fichiers inclus modifies depuis la date
	// HTTP_IF_MODIFIED_SINCE du client)
	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE'] AND !$var_mode
	AND $chemin_cache AND !$flag_dynamique) {
		$lastmodified = @filemtime($chemin_cache);
		$headers_only = http_last_modified($lastmodified);
	}
	$headers_only |= ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] == 'HEAD');

	if ($headers_only) {
		if ($chemin_cache)
			$t = @filemtime($chemin_cache);
		else
			$t = time();
		@header('Last-Modified: '.http_gmoddate($t).' GMT');
		@header('Connection: close');
		// Pas de bouton admin pour un HEAD
		$flag_preserver = true;
	}
	else {
		// Obtenir la page
		$page = obtenir_page ('', $chemin_cache, $delais, $use_cache,
		$fond, false);
		if (!$flag_preserver) {
		// Entete content-type: xml ou html ; charset
			if ($xhtml) {
			// Si Mozilla et tidy actif, passer en "application/xhtml+xml"
			// extremement risque: Mozilla passe en mode debugueur strict
			// mais permet d'afficher du MathML directement dans le texte
			// (et sauf erreur, c'est la bonne facon de declarer du xhtml)
				include_ecrire("inc_tidy.php");
				if (version_tidy() > 0) {
					if (ereg("application/xhtml\+xml", $GLOBALS['HTTP_ACCEPT'])) 
						@header("Content-Type: application/xhtml+xml; charset=".lire_meta('charset'));
					else 
						@header("Content-Type: text/html; charset=".lire_meta('charset'));
					echo '<'.'?xml version="1.0" encoding="'. lire_meta('charset').'"?'.">\n";
				} else {
					@header("Content-Type: text/html; charset=".lire_meta('charset'));
				}
			} else {
				@header("Content-Type: text/html; charset=".lire_meta('charset'));
			}
		}
	}

	if ($chemin_cache) $page['cache'] = $chemin_cache;

	if ($var_preview AND !$flag_preserver) {
		$url = $GLOBALS['clean_link'];
		$url->delvar('var_preview');
		$url = $url->geturl();
		include_ecrire('inc_lang.php3');
		lang_select($GLOBALS['auteur_session']['lang']);
		$page['texte'] .= '<div style="
		display: block;
		color: #eeeeee;
		background-color: #111111;
		padding-right: 5px;
		padding-top: 2px;
		padding-bottom: 5px;
		font-size: 20px;
		top: 0px;
		left: 0px;
		position: absolute;
		"><a href="'.$url.'"><img src="' . _DIR_IMG_PACK . 'naviguer-site.png" align="left" border="0" /></a>
&nbsp; '.majuscules(_T('previsualisation')).'</div>';
	}

	return $page;
}


function terminer_public_global() {

	// Mise a jour des fichiers langues de l'espace public
	if ($GLOBALS['cache_lang_modifs']) {
		include_ecrire('inc_lang.php3');
		ecrire_caches_langues();
	}

	// Gestion des statistiques du site public

	if (lire_meta("activer_statistiques") != "non") {
		include_local ("inc-stats.php3");
		ecrire_stats();
	}

	// Effectuer une tache de fond ?
	cron();
}

// Cette fonction sert au dernier ob_start() de inc-public : elle
// va absorber les eventuels messages d'erreur de inc_cron(), permettant
// de ne pas planter le content-length qu'on a annonce ; decommenter la ligne
// pour afficher les bugs
function masquer_les_bugs ($bugs) {
	# return $bugs;
}

function inclure_page($fond, $delais_inclus, $contexte_inclus, $cache_incluant='') {

	$contexte_inclus['fond'] = $fond;

	$chemin_cache = generer_nom_fichier_cache($contexte_inclus, $fond);

	// Peut-on utiliser un fichier cache ?
	determiner_cache($delais_inclus, $use_cache, $chemin_cache);

	// Si on a inclus sans fixer le critere de lang, de deux choses l'une :
	// - on est dans la langue du site, et pas besoin d'inclure inc_lang
	// - on n'y est pas, et alors il faut revenir dans la langue par defaut
	if (($lang = $contexte_inclus['lang'])
	|| ($GLOBALS['spip_lang'] != ($lang = lire_meta('langue_site')))) {
		include_ecrire('inc_lang.php3');
		lang_select($lang);
		$lang_select = true; // pour lang_dselect en sortie
	}

	$page = obtenir_page ($contexte_inclus, $chemin_cache, $delais_inclus,
	$use_cache, $fond, true);

	$page['lang_select'] = $lang_select;

	// Retourner le contenu...
	return $page;
}

# les balises dynamiques sont traitees comme des inclusions
# Attention, un appel explicite a cette fonction suppose certains include
# (voir l'exemple de spip_inscription et spip_pass)

function inclure_balise_dynamique($r) {
	if (is_string($r))
		echo $r;
	else {
		list($fond, $delais, $contexte_inclus) = $r;
		if ((!$contexte_inclus['lang']) AND
		($GLOBALS['spip_lang'] != lire_meta('langue_site')))
			$contexte_inclus['lang'] = $GLOBALS['spip_lang']; 
		$page = inclure_page($fond, $delais, $contexte_inclus);
		if ($page['process_ins'] == 'html')
			echo $page['texte'];
		else
			eval('?' . '>' . $page['texte']);
		
		if ($page['lang_select'])
			lang_dselect();
	}
}
?>

--- NEW FILE: login-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
	<title><:login_acces_prive:></title>
	<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
	<link rel="stylesheet" href="spip_style.css" type="text/css">
</head>
<body dir="#LANG_DIR" bgcolor="#ffffff" text="#000000" link="#e86519" vlink="#6e003a" alink="#ff9900">

<br><br><br><center><table width="400"><tr><td width="400">
<div align="center">
<h3 class="spip">#NOM_SITE_SPIP<br>
<small><:login_acces_prive:></small></h3>
<div align="#LANG_RIGHT">#MENU_LANG_ECRIRE</div>
</div>
#LOGIN_PRIVE
	<div align="center">[&#91;<a
		href='(#URL_SITE_SPIP|inscriptionok{redac})/spip_inscription.php3?mode=redac&amp;focus=nom_inscription&amp;target=spip_pass'
		target="spip_pass"
		onclick="javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=500'); return false;"><:login_sinscrire:></a>&#93;]&#91;<a
		href="spip_pass.php3"
		target="spip_pass" 
		onclick="javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=280'); return false;"><:login_motpasseoublie:></a>&#93;&#91;<a 
		href='#URL_SITE_SPIP'><:login_retoursitepublic:></a>&#93
	      </div>

</td></tr></table></center>

</body>
</html>

--- NEW FILE: inc-urls-propres.php3 ---
<?php

// executer une seule fois
if (defined("_INC_URLS2")) return;
define("_INC_URLS2", "1");


/*

- Comment utiliser ce jeu d'URLs ?

Il faut recopier le fichier htaccess-propre.txt sous le nom .htaccess
dans le repertoire de base du site SPIP (attention a ne pas ecraser
d'autres reglages que vous pourriez avoir mis dans ce fichier)

*/


function _generer_url_propre($type, $id_objet) {
	$table = "spip_".$type."s";
	$col_id = "id_".$type;

	// D'abord, essayer de recuperer l'URL existante si possible
	$query = "SELECT url_propre, titre FROM $table WHERE $col_id=$id_objet";
	$result = spip_query($query);
	if (!($row = spip_fetch_array($result))) return "";
	if ($row['url_propre']) return $row['url_propre'];

	// Sinon, creer l'URL
	include_ecrire("inc_filtres.php3");
	include_ecrire("inc_charsets.php3");
	$url = translitteration(corriger_caracteres(supprimer_tags(supprimer_numero($row['titre']))));
	$url = @preg_replace(',[[:punct:][:space:]]+,u', ' ', $url);
	// S'il reste des caracteres non latins, utiliser l'id a la place
	if (preg_match(",[^a-zA-Z0-9 ],", $url)) {
		$url = $type.$id_objet;
	}
	else {
		$mots = explode(' ', $url);
		$url = '';
		foreach ($mots as $mot) {
			if (!$mot) continue;
			$url2 = $url.'-'.$mot;
			if (strlen($url2) > 35) {
				break;
			}
			$url = $url2;
		}
		$url = substr($url, 1);
		//echo "$url<br>";
		if (strlen($url) < 2) $url = $type.$id_objet;
	}

	// Verifier les eventuels doublons et mettre a jour
	$lock = "url $type $id_objet";
	spip_get_lock($lock, 10);
	$query = "SELECT $col_id FROM $table WHERE url_propre='".addslashes($url)."'";
	if (spip_num_rows(spip_query($query)) > 0) {
		$url = $url.','.$id_objet;
	}
	$query = "UPDATE $table SET url_propre='".addslashes($url)."' WHERE $col_id=$id_objet";
	spip_query($query);
	spip_release_lock($lock);

	return $url;
}

function generer_url_article($id_article) {
	$url = _generer_url_propre('article', $id_article);
	if (!$url) $url = "article.php3?id_article=$id_article";
	return $url;
}

function generer_url_rubrique($id_rubrique) {
	$url = _generer_url_propre('rubrique', $id_rubrique);
	if (!$url) $url = "rubrique.php3?id_rubrique=$id_rubrique";
	else $url = '-'.$url.'-';
	return $url;
}

function generer_url_breve($id_breve) {
	$url = _generer_url_propre('breve', $id_breve);
	if (!$url) $url = "breve.php3?id_breve=$id_breve";
	else $url = '+'.$url.'+';
	return $url;
}

function generer_url_forum($id_forum) {
	return "forum.php3?id_forum=$id_forum";
}

function generer_url_mot($id_mot) {
	$url = _generer_url_propre('mot', $id_mot);
	if (!$url) $url = "mot.php3?id_mot=$id_mot";
	else $url = '+-'.$url.'-+';
	return $url;
}

function generer_url_auteur($id_auteur) {
	return "auteur.php3?id_auteur=$id_auteur";
}

function generer_url_document($id_document) {
	if (intval($id_document) <= 0)
		return '';
	if ((lire_meta("creer_htaccess")) == 'oui')
		return "spip_acces_doc.php3?id_document=$id_document";
	if ($row = @spip_fetch_array(spip_query("SELECT fichier FROM spip_documents WHERE id_document = $id_document")))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;

	// Migration depuis anciennes URLs ?
	if ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] != 'POST' &&
		preg_match(',(^|/)(article|breve|rubrique|mot)\.php3?([\?&].*)?$,', $url, $regs)) {
		$type = $regs[2];
		$id_objet = intval($GLOBALS['id_'.$type]);
		if ($id_objet) {
			$func = "generer_url_$type";
			$url_propre = $func($id_objet);
			if ($url_propre) {
				http_status(301);
				Header("Location: $url_propre");
				exit;
			}
		}
		return;
	}

	$url_propre = $GLOBALS['HTTP_SERVER_VARS']['REDIRECT_url_propre'];
	if (!$url_propre) $url_propre = $GLOBALS['HTTP_ENV_VARS']['url_propre'];
	if (!$url_propre) $url_propre = substr($url, strrpos($url, '/') + 1);
	if (!$url_propre) return;

	// Detecter les differents types d'objets demandes
	if (preg_match(',^\+-(.*)-\+$,', $url_propre, $regs)) {
		$type = 'mot';
		$url_propre = $regs[1];
	}
	else if (preg_match(',^-(.*)-$,', $url_propre, $regs)) {
		$type = 'rubrique';
		$url_propre = $regs[1];
	}
	else if (preg_match(',^\+(.*)\+$,', $url_propre, $regs)) {
		$type = 'breve';
		$url_propre = $regs[1];
	}
	else {
		$type = 'article';
	}

	$table = "spip_".$type."s";
	$col_id = "id_".$type;
	$query = "SELECT $col_id FROM $table WHERE url_propre='".addslashes($url_propre)."'";
	$result = spip_query($query);
	if (spip_num_rows($result) == 1) {
		$row = spip_fetch_array($result);
		$contexte[$col_id] = $row[$col_id];
	}

	return;
}

?>
--- NEW FILE: formulaire_signature-dist.html ---
<form method='post'
      action='#SELF#sp[(#HTTP_VARS{id_article})]' >
      <input type="hidden" name="url_page" value="#URL_SITE_SPIP/#SELF">
      <div class='spip_encadrer' style='color: black; font-size: 80%; font-weight: normal;'>
	[(#HTTP_VARS{texte}|traiter_raccourcis|interdire_scripts)]
	<fieldset style='font-size: 110%; font-weight: bold;'>
	  <legend></legend>
	  <label>
	    <:form_pet_votre_nom:>
	    <input type="text" class="forml" name="nom_email" value="" size="20" />
	  </label>
	  <label>
	    <:form_pet_votre_email:><br />
	    <input type="text" class="forml" name="adresse_email" value="" size="20" />
	  </label>
	</fieldset>
	<br />
	<p>[(#HTTP_VARS{site_obli}|=={oui}|?{'',' '})<:form_pet_votre_site:><br />]
	<fieldset style='font-size: 110%; font-weight: bold;'>
	  <legend></legend>
	  <label>
	  <:form_pet_nom_site2:><br />
	  <input type="text" class="forml" name="signature_nom_site" value="" size="20" />
	  </label>
	  <label>
	    <:form_pet_adresse_site:><br />
	    <input type="text" class="forml" name="signature_url_site" value="http://" size="20" />
	  </label>
	</fieldset>[
	<br />
	<fieldset style='font-weight: bold'>
	  <legend></legend>
	(#HTTP_VARS{message}|=={oui}|?{' ',''})
	  <label>
	  <:form_pet_message_commentaire:><br />
	    <textarea name="message" rows="3" class="forml" cols="20"></textarea>
	  </label>
	</fieldset>
	]
	<br />
	<div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>" /></div>
      </div>
</form>


--- NEW FILE: downloadfile.class.php ---
<?
/*
 * Class has simple interface to download any file from a server
 * without displaying the location of the file
 *
 * Author: Viatcheslav Ivanov, E-Witness Inc., Canada;
 * mail: ivanov at e-witness.ca;
 * web: www.e-witness.ca; www.coolwater.ca; www.strongpost.net;
 * version: 1.1 /08.19.2002
 *
 */

if ( !defined("DOWNLOADFILE_H") ) {

	define("DOWNLOADFILE_H",1);

	class DOWNLOADFILE {
		var $df_path = "";
		var $df_contenttype = "";
		var $df_contentdisposition = "";
		var $df_filename = "";

		function DOWNLOADFILE($df_path, $df_contentdisposition = "attachment", $df_filename = "") {
			$this->df_path = $df_path;
			if (!function_exists ("mime_content_type")) {
 					function mime_content_type ($file) {
  					return exec ("file -bi " . escapeshellcmd($file));
 				}
			}
			$df_contenttype=@mime_content_type($df_path);
			if ($df_contenttype) $this->df_contenttype = $df_contenttype;
			else $this->df_contenttype ="";// "application/octet-stream";
			$this->df_contentdisposition = $df_contentdisposition;
			$this->df_filename = ($df_filename)? $df_filename : basename($df_path);
		}

		// check is specified file exists?
		function df_exists() {
			if(@file_exists($this->df_path)) return true;
			return false;
		}

		// get file size
		function df_size() {
			if($this->df_exists()) return filesize($this->df_path);
			return false;
		}

		// return permission number for user 'other'
		function df_permitother() {
			return substr(decoct(fileperms($this->df_path)),-1);
		}

		// download file
		function df_download() {
			if($this->df_exists() && $this->df_permitother() >= 4) {
				header("Content-type: ".$this->df_contenttype);
				header("Content-Length: ".$this->df_size());
				header("Content-Disposition: ".$this->df_contentdisposition."; filename=\"".$this->df_filename."\";");
				header("Content-Transfer-Encoding: binary");
				$fp = readfile($this->df_path, "r");
				return $fp;
				//echo "Content-type: ".$this->df_contenttype."Content-Length: ".$this->df_size()."Content-Disposition: ".$this->df_contentdisposition."; filename=\"".$this->df_filename."\";";
			}
			else return false;
		}

	}

}

?>
--- NEW FILE: inc-boucles.php3 ---
<?php

//
// Ce fichier definit les boucles standard de SPIP
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_BOUCLES")) return;
define("_INC_BOUCLES", "1");


//
// Boucle sur une table hors SPIP
//
function boucle_DEFAUT($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$boucle->from[] =  $boucle->type_requete . " AS " . $boucle->type_requete;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(BOUCLE)> boucle dite recursive
//
function boucle_BOUCLE_dist($id_boucle, &$boucles) {

	    return "\n	\$t0 = " . $boucles[$id_boucle]->return . ";";
}

//
// <BOUCLE(ARTICLES)>
//
function boucle_ARTICLES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "articles AS $id_table";
	if (!$GLOBALS['var_preview']) {
		$boucle->where[] = "$id_table.statut='publie'";
		if (lire_meta("post_dates") == 'non')
			$boucle->where[] = "$id_table.date < NOW()";
	} else
		$boucle->where[] = "$id_table.statut IN ('publie','prop')";
	return calculer_boucle($id_boucle, $boucles); 
}

//
// <BOUCLE(AUTEURS)>
//
function boucle_AUTEURS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "auteurs AS $id_table";
	// Si pas de lien avec un article, selectionner
	// uniquement les auteurs d'un article publie
	if (!$GLOBALS['var_preview'])
	if (!$boucle->lien AND !$boucle->tout) {
		$boucle->from[] =  "auteurs_articles AS lien";
		$boucle->from[] =  "articles AS articles";
		$boucle->where[] = "lien.id_auteur=$id_table.id_auteur";
		$boucle->where[] = 'lien.id_article=articles.id_article';
		$boucle->where[] = "articles.statut='publie'";
		$boucle->group =  $boucle->id_table . '.' . $boucle->primary;
	}
	// pas d'auteurs poubellises
	$boucle->where[] = "NOT($id_table.statut='5poubelle')";
	return calculer_boucle($id_boucle, $boucles); 
}

//
// <BOUCLE(BREVES)>
//
function boucle_BREVES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "breves AS $id_table";
	if (!$GLOBALS['var_preview'])
		$boucle->where[] = "$id_table.statut='publie'";
	else
		$boucle->where[] = "$id_table.statut IN ('publie','prop')";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(FORUMS)>
//
function boucle_FORUMS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "forum AS $id_table";
	// Par defaut, selectionner uniquement les forums sans pere
	if (!$boucle->tout AND !$boucle->plat) 
		{
	$boucle->where[] = "$id_table.id_parent=0";
		}
	$boucle->where[] = "$id_table.statut='publie'";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(SIGNATURES)>
//
function boucle_SIGNATURES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "signatures AS $id_table";
	$boucle->from[] =  "petitions AS petitions";
	$boucle->from[] =  "articles articles";
	$boucle->where[] = "petitions.id_article=articles.id_article";
	$boucle->where[] = "petitions.id_article=$id_table.id_article";
	$boucle->where[] = "$id_table.statut='publie'";
	$boucle->group =  $boucle->id_table . '.' . $boucle->primary;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(DOCUMENTS)>
//
function boucle_DOCUMENTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "documents AS $id_table";
	$boucle->from[] =  "types_documents AS types_documents";
	$boucle->where[] = "$id_table.id_type=types_documents.id_type";
	$boucle->where[] = "$id_table.taille > 0";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(TYPES_DOCUMENTS)>
//
function boucle_TYPES_DOCUMENTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "types_documents AS $id_table";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(GROUPES_MOTS)>
//
function boucle_GROUPES_MOTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "groupes_mots AS $id_table";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(MOTS)>
//
function boucle_MOTS_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "mots AS $id_table";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(RUBRIQUES)>
//
function boucle_RUBRIQUES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "rubriques AS $id_table";
	if (!$GLOBALS['var_preview'])
		if (!$boucle->tout) $boucle->where[] = "$id_table.statut='publie'";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(HIERARCHIE)>
//
function boucle_HIERARCHIE_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "rubriques AS $id_table";

	// Si la boucle mere est une boucle RUBRIQUES il faut ignorer la feuille
	// sauf si le critere {tout} est present (cf. inc-html-squel)
	$exclure_feuille = ($boucle->tout ? 'false' : 'true');

	// $hierarchie sera calculee par une fonction de inc-calcul-outils
	$boucle->where[] = 'id_rubrique IN ($hierarchie)';
	$boucle->select[] = 'FIND_IN_SET(id_rubrique, \'$hierarchie\')-1 AS rang';
	$boucle->order = 'rang';
	$boucle->hierarchie = '$hierarchie = calculer_hierarchie('
	. calculer_argument_precedent($boucle->id_boucle, 'id_rubrique', $boucles)
	. ', '
	. $exclure_feuille
	. ');';
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(SYNDICATION)>
//
function boucle_SYNDICATION_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "syndic AS $id_table";
	$boucle->where[] = "$id_table.statut='publie'";
	return calculer_boucle($id_boucle, $boucles); 
}


//
// <BOUCLE(SYNDIC_ARTICLES)>
//
function boucle_SYNDIC_ARTICLES_dist($id_boucle, &$boucles) {
	$boucle = &$boucles[$id_boucle];
	$id_table = $boucle->id_table;
	$boucle->from[] =  "syndic_articles  AS $id_table";
	$boucle->from[] =  "syndic AS syndic";
	$boucle->where[] = "$id_table.id_syndic=syndic.id_syndic";
	$boucle->where[] = "$id_table.statut='publie'";
	$boucle->where[] = "syndic.statut='publie'";
	$boucle->select[]='syndic.nom_site AS nom_site'; # derogation zarbi
	$boucle->select[]='syndic.url_site AS url_site'; # idem
	return calculer_boucle($id_boucle, $boucles); 
}


?>

--- NEW FILE: carto-proto.sql ---
CREATE TABLE spip_carto_carte (
id_carte smallint unsigned NOT NULL auto_increment,
fichier varchar(255) NOT NULL,
titre varchar(255) NOT NULL,
commentaire text default NULL,
callage text default NULL,
id_srs smallint unsigned default NULL,
idx CHAR( 3 ) NOT NULL, 
PRIMARY KEY (id_carte),
KEY titre (titre)
) TYPE=MyISAM;

# srs = systeme de reference spatial
CREATE TABLE spip_carto_srs (
id_srs smallint unsigned NOT NULL auto_increment,
label varchar(30) NOT NULL,
code smallint NOT NULL,
PRIMARY KEY (id_srs)
) TYPE=MyISAM;

# objet cartographique (point, ligne, surface) attach? ? une carte
CREATE TABLE spip_carto_objet (
id_objet smallint unsigned NOT NULL auto_increment,
id_carte smallint unsigned NOT NULL,
titre varchar(255) default NULL,
commentaire text default NULL,
lien varchar(255) default NULL,
logo varchar(255) default NULL,
geometrie text default NULL,
idx CHAR( 3 ) NOT NULL, 
PRIMARY KEY (id_objet),
KEY id_carte (id_carte),
KEY titre (titre)
) TYPE=MyISAM;

# table de jointure entre les objets et les mots cl?s
CREATE TABLE spip_mots_carto_objets (
id_carto_objet smallint unsigned NOT NULL,
id_mot smallint unsigned NOT NULL,
PRIMARY KEY (id_carto_objet,id_mot)
) TYPE=MyISAM;

# table de jointure entre les cartes et les articles
CREATE TABLE spip_carto_carte_articles (
id_carte smallint unsigned NOT NULL,
id_article smallint unsigned NOT NULL,
PRIMARY KEY (id_carte,id_article)
) TYPE=MyISAM;

# table de jointure entre les cartes et les articles
CREATE TABLE spip_documents_carto_cartes (
id_carto_carte smallint unsigned NOT NULL,
id_document smallint unsigned NOT NULL,
callage text default NULL,
PRIMARY KEY (id_carto_carte,id_document)
) TYPE=MyISAM;

ALTER TABLE `spip_groupes_mots` ADD `carto_objets` CHAR( 3 ) NOT NULL default 'oui' AFTER `syndic` ;

ALTER TABLE `spip_groupes_mots` ADD INDEX ( `carto_objets` ) ;


INSERT INTO spip_meta(nom, valeur, maj) VALUES ('activer_carto','oui',now());
INSERT INTO spip_meta(nom, valeur, maj) VALUES ('carto_mots','oui',now());
--- NEW FILE: inc-formulaire_inscription.php3 ---
<?php

include_ecrire('inc_abstract_sql.php3');

global $balise_FORMULAIRE_INSCRIPTION_collecte ;
$balise_FORMULAIRE_INSCRIPTION_collecte = array('mail_inscription', 'nom_inscription');

// args 0 et 1 sont mail et nom ci-dessus,
// arg2 le parametre de la balise
// arg3 toujours vide au premier appel (fenetre cible)

function balise_FORMULAIRE_INSCRIPTION_stat($args, $filtres)
{
  return ((lire_meta('accepter_inscriptions') != 'oui') ? '' :
	  array('redac', $args[0], $args[1], 
		($args[2] == 'focus' ? 'nom_inscription' : ''),
		''));
}

function balise_FORMULAIRE_INSCRIPTION_dyn($mode, $mail_inscription, $nom_inscription, $focus, $target) {
	if (($mode == 'redac') AND (lire_meta("accepter_inscriptions") == "oui"))
		$statut = "nouveau";
	else if (($mode == 'forum') AND ((lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo')))
		$statut = "6forum";
	else return _T('pass_rien_a_faire_ici');

	if (test_mail_ins($mode, $mail_inscription) && $nom_inscription) {
		include(_FILE_CONNECT);
		// envoyer les identifiants si l'abonne n'existe pas d?j?.
		if (!$row = spip_fetch_array(spip_query("SELECT statut, id_auteur, login, pass FROM spip_auteurs WHERE email='".addslashes($mail_inscription)."' LIMIT 1")))
		  {
			include_ecrire("inc_acces.php3");
			$pass = creer_pass_aleatoire(8, $mail_inscription);
			$login = test_login($mail_inscription);
			$mdpass = md5($pass);
			$htpass = generer_htpass($pass);
			$r = spip_abstract_insert('auteurs', 
					 '(nom, email, login, pass, statut, htpass)',
					 "('".addslashes($nom_inscription)."',  '".addslashes($mail_inscription)."', '$login', '$mdpass', '$statut', '$htpass')");
			ecrire_acces();
			$message = envoyer_inscription($mail_inscription, $statut, $mode, $login, $pass);
		  }

		else {
		  // existant mais encore muet, renvoyer les infos
			if ($row['statut'] == 'nouveau') {
			  $message = (envoyer_inscription($mail_inscription, $row['statut'], $mode, $row['login'], $row['pass']));
			} else {
				if ($row['statut'] == '5poubelle')
		  // dead
				  $message = _T('form_forum_access_refuse');
				else  
		  // deja inscrit
				  $message = _T('form_forum_email_deja_enregistre');
			}
		}
	}
	// demande du formulaire
	else {
		if (!$nom_inscription) 
		    $message = '';
		else {
		  spip_log("Mail incorrect: '$mail_inscription'");
		  $message = _L('adresse mail incorrecte');
		}
	}

	return array("formulaire_inscription",0,
		     array('focus' => $focus,
			   'target' => $target,
			   'message' => $message,
			   'mode' => $mode));
}

// fonction qu'on peut redefinir pour filtrer selon l'adresse mail
// cas general: controler juste que l'adresse n'est pas vide

function test_mail_ins($mode, $mail_inscription) {
  return trim($mail_inscription);
}

	// envoyer identifiants par mail
function envoyer_inscription($mail, $statut, $type, $login, $pass) {
	$nom_site_spip = lire_meta("nom_site");
	$adresse_site = lire_meta("adresse_site");
	
	$message = _T('form_forum_message_auto')."\n\n"._T('form_forum_bonjour')."\n\n";
	if ($type == 'forum') {
		$message .= _T('form_forum_voici1', array('nom_site_spip' => $nom_site_spip, 'adresse_site' => $adresse_site)) . "\n\n";
	} else {
		$message .= _T('form_forum_voici2', array('nom_site_spip' => $nom_site_spip, 'adresse_site' => $adresse_site)) . "\n\n";
	}
	$message .= "- "._T('form_forum_login')." $login\n";
	$message .= "- "._T('form_forum_pass')." $pass\n\n";

	include_ecrire("inc_mail.php3");
	if (envoyer_mail($mail, "[$nom_site_spip] "._T('form_forum_identifiants'), $message))
	  return _T('form_forum_identifiant_mail');
	else
	  return _T('form_forum_probleme_mail');
}

function test_login($mail) {
	if (strpos($mail, "@") > 0) $login_base = substr($mail, 0, strpos($mail, "@"));
	else $login_base = $mail;

	$login_base = strtolower($login_base);
	$login_base = ereg_replace("[^a-zA-Z0-9]", "", $login_base);
	if (!$login_base) $login_base = "user";
	$login = $login_base;

	for ($i = 1; ; $i++) {
		$query = "SELECT id_auteur FROM spip_auteurs WHERE login='$login' LIMIT 1";
		if (!spip_num_rows(spip_query($query))) return $login;
		$login = $login_base.$i;
	}


}

?>

--- NEW FILE: formulaire_menu_lang-dist.html ---
<form	action='[(#HTTP_VARS{url})]'
	method='post'
	style='margin:0px; padding:0px;'>[
	<input type='hidden' name='url' value='(#HTTP_VARS{cible})' />
]	<select	name='[(#HTTP_VARS{nom})]' 
		class='forml'
		style='vertical-align: top; max-height: 24px; margin-bottom: 5px; width: 120px;'
		onchange="document.location.href='[(#HTTP_VARS{retour})]&amp;[(#HTTP_VARS{nom})]='+this.options[this.selectedIndex].value">
		[(#HTTP_VARS*{langues})]
      </select>
      <noscript>
	<input type='submit' value='&gt;&gt;' class='spip_bouton' />
      </noscript>
</form>

--- NEW FILE: forum.php3 ---
<?php
$fond = "forum";
$delais = 3600;

include ("inc-public.php3");

?>

--- NEW FILE: inc-menu_lang_ecrire.php3 ---
<?php

global $balise_MENU_LANG_ECRIRE_collecte;
$balise_MENU_LANG_ECRIRE_collecte = array('menu_lang');

// s'il n'y a qu'une langue proposee eviter definitivement la balise ?php 

function balise_MENU_LANG_ECRIRE_stat ($args, $filtres)
{
  if (!strpos(lire_meta('langues_proposees'),',')) return '';
  return $args;
}

// normalement $opt sera toujours non vide suite au test ci-dessus

function balise_MENU_LANG_ECRIRE_dyn($default)
{
  include_ecrire("inc_lang.php3");
  $opt = liste_options_langues('var_lang_ecrire', $default);
  return (!$opt ? '' : menu_lang_pour_tous('var_lang_ecrire', $opt));
}

function menu_lang_pour_tous($nom, $opt)
{
  $site = lire_meta("adresse_site");
  $post = ($site ? $site : '..') . "/spip_cookie.php3";
  $cible = $GLOBALS['clean_link']->getUrl();
  $postcomplet = new Link($post);
  $postcomplet->addvar('url', $cible);

  return array('formulaire_menu_lang',
	       10, 
	       array('nom' => $nom,
		     'url' => $post,
		     'cible' => $cible,
		     'retour' => $postcomplet->getUrl(),
		     'langues' => $opt));
}
?>

--- NEW FILE: formulaire_inscription-dist.html ---
[
(#HTTP_VARS*{message})
][
(#HTTP_VARS*{message}|?{'',' '})[
 (#HTTP_VARS{mode}|=={forum}|?{' ',''})
	<:pass_forum_bla:><br /><br />
][
 (#HTTP_VARS{mode}|=={redac}|?{' ',''})
	<:pass_espace_prive_bla:><br /><br />
]<:form_forum_indiquer_nom_email:>
 <form	id="inscription" method='post' action='#SELF'
	style='border: 0px; margin: 0px;'> 
      <fieldset style="border: none; font-weight: bold"><legend></legend>
	<label>
	  <:form_pet_votre_nom:>
	  <input type="text" class="forml" name="nom_inscription" value="" size="30" />
	</label>
	<label>
	  <:form_pet_votre_email:>
	  <input type="text" class="forml" name="mail_inscription" value="" size="30" />
	</label>
      </fieldset>
      <div align="right"><input type="submit" class="spip_bouton" value="<:bouton_valider:>" />
	</div> 
 </form>[
<script type="text/javascript"><!--
document.inscription.(#HTTP_VARS{focus}).focus()
--></script>
 ]
][<br />
<div align="right">
(#HTTP_VARS{target}|?{' ',''})
<script type="text/javascript"><!--
document.write("<a href='")
document.write((window.opener) ? "javascript:close()" : "./")
document.write("'><:pass_quitter_fenetre:><" + "/a>");
//--></script>
<noscript>
        &#91;<a href='./'><:pass_retour_public:></a>&#93;
</noscript>
</div>
]

--- NEW FILE: impression.css ---

/*
 * Feuille de style specifique a l'impression
 */
 
/* Pour les liens, on desactive les couleurs
   et on affiche l'URL cible a la suite du lien (!) */

a { color: black; text-decoration: underline; }
a:visited { color: black; text-decoration: underline; }
a.spip_in { color: black; text-decoration: underline; }
a.spip_out { color: black; text-decoration: underline; }
a:after {
	display: inline;
	border: 1px solid dotted;
	content: " [" attr(href) "]";
}

/*
 * Un peu de coquetterie
 */

.chapo {
	line-height: 1.4em;
	margin-top: 1em;
}
.texte {
}
.ps {
	padding-top: 0.6em;
	margin-top: 0.6em;
	border-top: 1px dashed #404040;
}
.notes {
	margin-top: 0.6em;
	margin-bottom: 0.6em;
	border-top: 1px solid #707070;
}
.structure {
	display: none;
}
.spip-admin {
	display: none;
}


.contenu {
	margin: 10px;
}
.contenu h1 {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu h1.titre-extrait {
}
.contenu h1.titre-texte {
}
.contenu .surtitre {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu .detail {
	margin-left: 2em;
}
.extrait {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
	margin-left: 2em;
	margin-right: 0em;
	line-height: 1.4em;
}


/*
 * Disposition : on elimine les elements de navigation (display: none)
 * et on choisit un affichage de base pour le principal
 */

#principal {
	margin: 10px;
}

#navigation {
	display: none;
}

.encart {
	display: none;
}

.cartouche {
	margin-top: 0.5em;
	padding-top: 1em;
	margin-bottom: 1em;
}

.cartouche .spip_logos {
	margin-left: 0px;
	padding-left: 0px;
	margin-right: 0.8em;
}


/*
 * Forums
 */

.forum-repondre {
	display: none;
}
.forum-repondre-message {
	display: none;
}


--- NEW FILE: inc-balises.php3 ---
<?php

//
// Ce fichier regroupe la quasi totalite des definitions de #BALISES de spip
// Pour chaque balise, il est possible de surcharger, dans mes_fonctions.php3,
// la fonction balise_TOTO_dist par une fonction balise_TOTO() respectant la
// meme API : 
// elle recoit en entree un objet de classe CHAMP, le modifie et le retourne.
// Cette classe est definie dans inc-compilo-index.php3
//

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_BALISES")) return;
define("_INC_BALISES", "1");


//
// Traitements standard de divers champs
//
function champs_traitements ($p) {
	static $traitements = array (
		'BIO' => 'traiter_raccourcis(%s)',
		'CHAPO' => 'traiter_raccourcis(nettoyer_chapo(%s))',
		'DATE' => 'vider_date(%s)',
		'DATE_MODIF' => 'vider_date(%s)',
		'DATE_NOUVEAUTES' => 'vider_date(%s)',
		'DATE_REDAC' => 'vider_date(%s)',
		'DESCRIPTIF' => 'traiter_raccourcis(%s)',
		'LIEN_TITRE' => 'typo(%s)',
		'LIEN_URL' => 'htmlspecialchars(vider_url(%s))',
		'MESSAGE' => 'traiter_raccourcis(%s)',
		'NOM_SITE_SPIP' => 'typo(%s)',
		'NOM' => 'typo(%s)',
		'PARAMETRES_FORUM' => 'htmlspecialchars(%s)',
		'PS' => 'traiter_raccourcis(%s)',
		'SOUSTITRE' => 'typo(%s)',
		'SURTITRE' => 'typo(%s)',
		'TEXTE' => 'traiter_raccourcis(%s)',
		'TITRE' => 'typo(%s)',
		'TYPE' => 'typo(%s)',
		'URL_ARTICLE' => 'htmlspecialchars(vider_url(%s))',
		'URL_BREVE' => 'htmlspecialchars(vider_url(%s))',
		'URL_DOCUMENT' => 'htmlspecialchars(vider_url(%s))',
		'URL_FORUM' => 'htmlspecialchars(vider_url(%s))',
		'URL_MOT' => 'htmlspecialchars(vider_url(%s))',
		'URL_RUBRIQUE' => 'htmlspecialchars(vider_url(%s))',
		'URL_SITE_SPIP' => 'htmlspecialchars(vider_url(%s))',
		'URL_SITE' => 'htmlspecialchars(vider_url(%s))',
		'URL_SYNDIC' => 'htmlspecialchars(vider_url(%s))',
		'HTTP_VARS' => 'htmlspecialchars(%s)'
	);
	$ps = $traitements[$p->nom_champ];
	if (!$ps) return $p->code;
	if ($p->documents)
	  {$ps = str_replace('traiter_raccourcis(', 
			     'traiter_raccourcis_doublon($doublons,',
			     str_replace('typo(', 
					 'typo_doublon($doublons,',
					 $ps));
	  }
	// on supprime les < IMGnnn > tant qu'on ne rapatrie pas
	// les documents distants joints..
	// il faudrait aussi corriger les raccourcis d'URL locales
	return str_replace('%s',
			   (!$p->boucles[$p->id_boucle]->sql_serveur ?
			    $p->code :
			    ('supprime_img(' . $p->code . ')')),
			   $ps);				
}

// il faudrait savoir traiter les formulaires en local 
// tout en appelant le serveur SQL distant.
// En attendant, cette fonction permet de refuser une authentification 
// sur qqch qui n'a rien ? voir.

function balise_distante_interdite($p) {
	$nom = $p->id_boucle;
	if ($p->boucles[$nom]->sql_serveur) {
		erreur_squelette($p->nom_champ ._L(" distant interdit"), $nom);
	}
}

//
// Definition des balises
//
function balise_NOM_SITE_SPIP_dist($p) {
	$p->code = "lire_meta('nom_site')";
	$p->statut = 'php';
	return $p;
}

function balise_EMAIL_WEBMASTER_dist($p) {
	$p->code = "lire_meta('email_webmaster')";
	$p->statut = 'php';
	return $p;
}

function balise_CHARSET_dist($p) {
	$p->code = "lire_meta('charset')";
	$p->statut = 'php';
	return $p;
}

function balise_LANG_LEFT_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'left','right')";
	$p->statut = 'php';
	return $p;
}

function balise_LANG_RIGHT_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'right','left')";
	$p->statut = 'php';
	return $p;
}

function balise_LANG_DIR_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'ltr','rtl')";
	$p->statut = 'php';
	return $p;
}

function balise_PUCE_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "((lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),false,true) && \$GLOBALS['puce_rtl']) ? \$GLOBALS['puce_rtl'] : \$GLOBALS['puce'])";
	$p->statut = 'php';
	return $p;
}

// #DATE
// Cette fonction sait aller chercher dans le contexte general
// quand #DATE est en dehors des boucles
// http://www.spip.net/fr_article1971.html
function balise_DATE_dist ($p) {
	$_date = champ_sql('date', $p);
	$p->code = "$_date";
	$p->statut = 'php';
	return $p;
}

// #DATE_REDAC
// http://www.spip.net/fr_article1971.html
function balise_DATE_REDAC_dist ($p) {
	$_date = champ_sql('date_redac', $p);
	$p->code = "$_date";
	$p->statut = 'php';
	return $p;
}

// #DATE_MODIF
// http://www.spip.net/fr_article1971.html
function balise_DATE_MODIF_dist ($p) {
	$_date = champ_sql('date_modif', $p);
	$p->code = "$_date";
	$p->statut = 'php';
	return $p;
}

// #DATE_NOUVEAUTES
// http://www.spip.net/fr_article1971.html
function balise_DATE_NOUVEAUTES_dist($p) {
	$p->code = "((lire_meta('quoi_de_neuf') == 'oui' AND lire_meta('majnouv')) ? normaliser_date(lire_meta('majnouv')) : \"'0000-00-00'\")";
	$p->statut = 'php';
	return $p;
}

function balise_URL_SITE_SPIP_dist($p) {
	$p->code = "lire_meta('adresse_site')";
	$p->statut = 'php';
	return $p;
}


function balise_URL_ARTICLE_dist($p) {
	$_type = $p->type_requete;

	// Cas particulier des boucles (SYNDIC_ARTICLES)
	if ($_type == 'syndic_articles') {
		$p->code = champ_sql('url', $p);
	}

	// Cas general : chercher un id_article dans la pile
	else {
		$_id_article = champ_sql('id_article', $p);
		$p->code = "generer_url_article($_id_article)";

		if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
			$p->code = "url_var_recherche(" . $p->code . ")";
	}

	$p->statut = 'html';
	return $p;
}

function balise_URL_RUBRIQUE_dist($p) {
	$p->code = "generer_url_rubrique(" . 
	champ_sql('id_rubrique',$p) . 
	")" ;
	if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_BREVE_dist($p) {
	$p->code = "generer_url_breve(" .
	champ_sql('id_breve',$p) . 
	")";
	if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_MOT_dist($p) {
	$p->code = "generer_url_mot(" .
	champ_sql('id_mot',$p) .
	")";
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_FORUM_dist($p) {
	$p->code = "generer_url_forum(" .
	champ_sql('id_forum',$p) .")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_DOCUMENT_dist($p) {
	$p->code = "generer_url_document(" .
	champ_sql('id_document',$p) . ")";

	$p->statut = 'html';
	return $p;
}

function balise_URL_AUTEUR_dist($p) {
	$p->code = "generer_url_auteur(" .
	champ_sql('id_auteur',$p) .")";
	if ($p->boucles[$p->nom_boucle ? $p->nom_boucle : $p->id_boucle]->hash)
	$p->code = "url_var_recherche(" . $p->code . ")";

	$p->statut = 'html';
	return $p;
}

function balise_NOTES_dist($p) {
	// Recuperer les notes
	$p->code = 'calculer_notes()';
	$p->statut = 'html';
	return $p;
}

function balise_RECHERCHE_dist($p) {
	$p->code = 'htmlspecialchars($GLOBALS["recherche"])';
	$p->statut = 'php';
	return $p;
}

function balise_COMPTEUR_BOUCLE_dist($p) {
	if ($p->id_mere === '') {
		erreur_squelette(_L("Champ #COMPTEUR_BOUCLE hors boucle"), $p->id_boucle);
		$p->code = "''";
	} else {
		$p->code = '$compteur_boucle';
		$p->statut = 'php';
		return $p;
	}
}

function balise_TOTAL_BOUCLE_dist($p) {
	$b = $p->nom_boucle ? $p->nom_boucle : $p->id_mere;
	if ($b === '') {
		erreur_squelette(_L("Champ #TOTAL_BOUCLE hors boucle"), $p->id_boucle);
		$p->code = "''";
	} else {
		$p->code = "\$Numrows['$b']";
		$p->boucles[$b]->numrows = true;
		$p->statut = 'php';
	}
	return $p;
}

function balise_POINTS_dist($p) {
	return rindex_pile($p, 'points', 'recherche');
}

function balise_POPULARITE_ABSOLUE_dist($p) {
	$p->code = 'ceil(' .
	champ_sql('popularite', $p) .
	')';
	$p->statut = 'php';
	return $p;
}

function balise_POPULARITE_SITE_dist($p) {
	$p->code = 'ceil(lire_meta(\'popularite_total\'))';
	$p->statut = 'php';
	return $p;
}

function balise_POPULARITE_MAX_dist($p) {
	$p->code = 'ceil(lire_meta(\'popularite_max\'))';
	$p->statut = 'php';
	return $p;
}

function balise_EXPOSER_dist($p) {
	global  $table_primary;
	$type_boucle = $p->type_requete;
	$primary_key = $table_primary[$type_boucle];
	if (!$primary_key) {
		erreur_squelette(_L("Champ #EXPOSER hors boucle"), $p->id_boucle);
	}
	$on = 'on';
	$off= '';
	if ($p->fonctions) {
		// Gerer la notation [(#EXPOSER|on,off)]
		reset($p->fonctions);
		list(, $onoff) = each($p->fonctions);
		ereg("([^,]*)(,(.*))?", $onoff, $regs);
		$on = addslashes($regs[1]);
		$off = addslashes($regs[3]);
		
		// autres filtres
		$filtres=Array();
		while (list(, $nom) = each($p->fonctions))
		  $filtres[] = $nom;
		$p->fonctions = $filtres;
	}


	$p->code = '(calcul_exposer('
	.champ_sql($primary_key, $p)
	.', "'.$primary_key.'", $Pile[0]) ?'." '$on': '$off')";
	$p->statut = 'php';
	return $p;
}


//
// Inserer directement un document dans le squelette
//
function balise_EMBED_DOCUMENT_dist($p) {
	balise_distante_interdite($p);
	$_id_document = champ_sql('id_document',$p);
	$p->code = "calcule_embed_document(intval($_id_document), '" .
	texte_script($p->fonctions ? join($p->fonctions, "|") : "") .
	  "', \$doublons, '" . $p->documents . "')";
	unset ($p->fonctions);
	$p->statut = 'html';
	return $p;
}

// Debut et fin de surlignage auto des mots de la recherche
// on insere une balise Span avec une classe sans spec:
// c'est transparent s'il n'y a pas de recherche,
// sinon elles seront remplacees par les fontions de inc_surligne
// flag_pcre est juste une flag signalant que preg_match est dispo.

function balise_DEBUT_SURLIGNE_dist($p) {
	global $flag_pcre;
	$p->code = ($flag_pcre ? ('\'<span class="spip_surligneconditionnel">\'') : "''");
	return $p;
}
function balise_FIN_SURLIGNE_dist($p) {
	global $flag_pcre;
	$p->code = ($flag_pcre ? ('\'</span class="spip_surligneconditionnel">\'') : "''");
	return $p;
}

function balise_INTRODUCTION_dist ($p) {
	$_type = $p->type_requete;
	$_texte = champ_sql('texte', $p);
	$_chapo = champ_sql('chapo', $p);
	$_descriptif = champ_sql('descriptif', $p);
	$p->code = "calcul_introduction('$_type', $_texte, $_chapo, $_descriptif)";

	$p->statut = 'html';
	return $p;
}


// #LANG
// non documente ?
function balise_LANG_dist ($p) {
	$_lang = champ_sql('lang', $p);
	$p->code = "($_lang ? $_lang : \$GLOBALS['spip_lang'])";
	$p->statut = 'php';
	return $p;
}


// #LESAUTEURS
// les auteurs d'un article (ou d'un article syndique)
// http://www.spip.net/fr_article902.html
// http://www.spip.net/fr_article911.html
function balise_LESAUTEURS_dist ($p) {
	// Cherche le champ 'lesauteurs' dans la pile
	$_lesauteurs = champ_sql('lesauteurs', $p); 

	// Si le champ n'existe pas (cas de spip_articles), on donne la
	// construction speciale sql_auteurs(id_article) ;
	// dans le cas contraire on prend le champ 'les_auteurs' (cas de
	// spip_syndic_articles)
	if ($_lesauteurs AND $_lesauteurs != '$Pile[0][\'lesauteurs\']') {
		$p->code = $_lesauteurs;
	} else {
		$nom = $p->id_boucle;
	# On pourrait mieux faire qu'utiliser cette fonction assistante ?
		$p->code = "sql_auteurs(" .
			champ_sql('id_article', $p) .
			",'" .
			$nom .
			"','" .
			$p->boucles[$nom]->type_requete .
			"','" .
			$p->boucles[$nom]->sql_serveur .
			"')";
	}

	$p->statut = 'html';
	return $p;
}


// #PETITION 
// retourne '' si l'article courant n'a pas de petition 
// le texte de celle-ci sinon (et ' ' si il est vide)
// cf FORMULAIRE_PETITION

function balise_PETITION_dist ($p) {
	$nom = $p->id_boucle;
	$p->code = "sql_petitions(" .
			champ_sql('id_article', $p) .
			",'" .
			$p->boucles[$nom]->type_requete .
			"','" .
			$nom .
			"','" .
			$p->boucles[$nom]->sql_serveur .
			"', \$Cache)";
	$p->statut = 'php';
	return $p;
}


// #POPULARITE
// http://www.spip.net/fr_article1846.html
function balise_POPULARITE_dist ($p) {
	$_popularite = champ_sql('popularite', $p);
	$p->code = "(ceil(min(100, 100 * $_popularite
	/ max(1 , 0 + lire_meta('popularite_max')))))";
	$p->statut = 'php';
	return $p;
}


//
// Fonction commune aux balises #LOGO_XXXX
// (les balises portant ce type de nom sont traitees en bloc ici)
//
function calculer_balise_logo ($p) {

	eregi("^LOGO_([A-Z]+)(_.*)?$", $p->nom_champ, $regs);
	$type_objet = $regs[1];
	$suite_logo = $regs[2];	
	if (ereg("^_SPIP(.*)$", $suite_logo, $regs)) {
		$type_objet = 'RUBRIQUE';
		$suite_logo = $regs[1];
		$_id_objet = "\"'0'\"";
	} else {

		if ($type_objet == 'SITE')
			$_id_objet = champ_sql("id_syndic", $p);
		else
			$_id_objet = champ_sql("id_".strtolower($type_objet), $p);
	}
	// analyser les filtres
	$flag_fichier = false;
	$filtres = '';
	if (is_array($p->fonctions)) {
		foreach($p->fonctions as $nom) {
			if (ereg('^(left|right|center|top|bottom)$', $nom))
				$align = $nom;
			else if ($nom == 'lien') {
				$flag_lien_auto = 'oui';
				$flag_stop = true;
			}
			else if ($nom == 'fichier') {
				$flag_fichier = 'true';
				$flag_stop = true;
			}
			// double || signifie "on passe aux filtres"
			else if ($nom == '')
				$flag_stop = true;
			else if (!$flag_stop) {
				$lien = $nom;
				$flag_stop = true;
			}
			// apres un URL ou || ou |fichier ce sont
			// des filtres (sauf left...lien...fichier)
			else
				$filtres[] = $nom;
		}
		// recuperer les autres filtres s'il y en a
		$p->fonctions = $filtres;
	}

	//
	// Preparer le code du lien
	//
	// 1. filtre |lien
	if ($flag_lien_auto AND !$lien)
		$code_lien = '($lien = generer_url_'.$type_objet.'('.$_id_objet.')) ? $lien : ""';
	// 2. lien indique en clair (avec des balises : imprimer#ID_ARTICLE.html)
	else if ($lien) {
		$code_lien = "'".texte_script(trim($lien))."'";
		while (ereg("^([^#]*)#([A-Za-z_]+)(.*)$", $code_lien, $match)) {
			$c = new Champ();
			$c->nom_champ = $match[2];
			$c->id_boucle = $p->id_boucle;
			$c->boucles = &$p->boucles;
			$c->id_mere = $p->id_mere;
			$c = calculer_champ($c);
			$code_lien = str_replace('#'.$match[2], "'.".$c.".'", $code_lien);
		}
		// supprimer les '' disgracieux
		$code_lien = ereg_replace("^''\.|\.''$", "", $code_lien);
	}

	if ($flag_fichier)
	  $code_lien = "'',''" ; 
	else {
		if (!$code_lien)
			$code_lien = "''";
		$code_lien .= ", '". addslashes($align) . "'";
	}

	// cas des documents
	if ($type_objet == 'DOCUMENT') {
		$code_logo = "calcule_document($_id_objet, '" .
			$p->documents .
		  '\', $doublons)';
		if ($flag_fichier)
		  $p->code = "calcule_fichier_logo($code_logo)";
		else
		  $p->code = "affiche_logos(array($code_logo, ''), $code_lien)";
	}
	else {
	  $p->code = "affiche_logos(calcule_logo('$type_objet', '" .
	    (($suite_logo == '_SURVOL') ? 'off' : 
	     (($suite_logo == '_NORMAL') ? 'on' : 'ON')) .
	    "', $_id_objet," .
	    (($suite_logo == '_RUBRIQUE') ? 
	     champ_sql("id_rubrique", $p) :
	     (($type_objet == 'RUBRIQUE') ? "sql_parent($_id_objet)" : "''")) .
	    ",  '$flag_fichier'), $code_lien)";
	}
	$p->statut = 'php';
	return $p;
}

// #EXTRA [(#EXTRA|isbn)]
// Champs extra
// Non documentes, en voie d'obsolescence, cf. ecrire/inc_extra.php3
function balise_EXTRA_dist ($p) {
	$_extra = champ_sql('extra', $p);
	$p->code = $_extra;

	// Gerer la notation [(#EXTRA|isbn)]
	if ($p->fonctions) {
		include_ecrire("inc_extra.php3");
		list ($key, $champ_extra) = each($p->fonctions);	// le premier filtre
		$type_extra = $p->type_requete;
			// ci-dessus est sans doute un peu buggue : si on invoque #EXTRA
			// depuis un sous-objet sans champ extra d'un objet a champ extra,
			// on aura le type_extra du sous-objet (!)
		if (extra_champ_valide($type_extra, $champ_extra)) {
			unset($p->fonctions[$key]);
			$p->code = "extra($p->code, '".addslashes($champ_extra)."')";

			// Appliquer les filtres definis par le webmestre
			$filtres = extra_filtres($type_extra, $champ_extra);
			if ($filtres) foreach ($filtres as $f)
				$p->code = "$f($p->code)";
		}
	}

	$p->statut = 'html';
	return $p;
}

//
// Parametres de reponse a un forum
//

function balise_PARAMETRES_FORUM_dist($p) {
	include_local('inc-formulaire_forum.php3');
	$_accepter_forum = champ_sql('accepter_forum', $p);
	$p->code = '
	// refus des forums ?
	('.$_accepter_forum.'=="non" OR
	(lire_meta("forums_publics") == "non" AND !ereg("^(pos|pri|abo)", '.$_accepter_forum.')))
	? "" : // sinon:
	';

	switch ($p->type_requete) {
		case 'articles':
			$c = '"id_article=".' . champ_sql('id_article', $p);
			break;
		case 'breves':
			$c = '"id_breve=".' . champ_sql('id_breve', $p);
			break;
		case 'rubriques':
			$c = '"id_rubrique=".' . champ_sql('id_rubrique', $p);
			break;
		case 'syndication':
			$c = '"id_syndic=".' . champ_sql('id_syndic', $p);
			break;
		case 'forums':
		default:
			$liste_champs = array ("id_article","id_breve","id_rubrique","id_syndic","id_forum");
			foreach ($liste_champs as $champ) {
				$x = champ_sql( $champ, $p);
				$c .= (($c) ? ".\n" : "") . "((!$x) ? '' : ('&$champ='.$x))";
			}
			$c = "substr($c,1)";
			break;
	}

	$c .= '.
	"&retour=".rawurlencode($lien=$GLOBALS["HTTP_GET_VARS"]["retour"] ? $lien : nettoyer_uri())';

	$p->code .= code_invalideur_forums($p, "(".$c.")");

	$p->statut = 'html';
	return $p;
}


// Noter l'invalideur de la page contenant ces parametres,
// en cas de premier post sur le forum
function code_invalideur_forums($p, $code) {
	return '
	// invalideur forums
	(!($Cache[\'id_forum\'][calcul_index_forum(' . 
				// Retournera 4 [$SP] mais force la demande du champ a MySQL
				champ_sql('id_article', $p) . ',' .
				champ_sql('id_breve', $p) .  ',' .
				champ_sql('id_rubrique', $p) .',' .
				champ_sql('id_syndic', $p) .  ")]=1)".
				"?'':\n" . $code .")";
}

// reference a l'URL de la page courante

function balise_SELF_dist($p) {
	$p->code = 'quote_amp($GLOBALS["clean_link"]->getUrl())';
	$p->statut = 'php';
	return $p;
}

// reference aux parametres GET & POST

function balise_HTTP_VARS_dist($p) {
	$nom = param_balise($p);
	if (!$nom)
		erreur_squelette(_L("Champ #HTTP_VARS argument manquant"),
				$p->id_boucle);
	else {
		$p->code = '$Pile[0]["' . addslashes($nom) . '"]';
		$p->statut = 'php';
	}
	return $p;
}
?>

--- NEW FILE: inc-chercher.php3 ---
<?php

// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CHERCHE")) return;
define("_INC_CHERCHE", "1");

// Ce fichier doit imperativement contenir la fonction chercher-squelette
// (cf commentaires dans inc-calcul)

function chercher_squelette($fond, $id_rubrique, $dossier, $lang) {
	$ext = $GLOBALS['extension_squelette'];

	$d ="$dossier$fond";

	// On selectionne, dans l'ordre :
	// fond=10
	
	$f = "$d=$id_rubrique";
	if (($id_rubrique > 0) AND (@file_exists("$f.$ext")))
		$squelette = $f;

	// fond-10 fond-<rubriques parentes>
	if (!$squelette)
		while ($id_rubrique > 0) {
			if (@file_exists("$d-$id_rubrique.$ext")) {
				$squelette = "$d-$id_rubrique";
				break;
			}
			else
				$id_rubrique = sql_parent($id_rubrique);
		}

	if (!$squelette) {
		// fond
		if (@file_exists("$d.$ext"))
			$squelette = $d;
		// fond, a la racine
		else if (@file_exists("$fond.$ext"))
			$squelette = $fond;
		else if (@file_exists("$fond-dist.$ext"))
			$squelette = "$fond-dist";
		else {
			// erreur webmaster : $fond ne correspond a rien
			erreur_squelette(_T('info_erreur_squelette2',
				 array('fichier'=>$fond)),
				 $dossier);
			return '';
		}
	}

	// Affiner par lang
	if ($lang) {
		lang_select($lang);
		$f = "$squelette.$lang";
		if (@file_exists("$f.$ext"))
			$squelette = $f;
	}

	return $squelette;
}

?>

--- NEW FILE: inc-urls-standard.php3 ---
<?php

// executer une seule fois
if (defined("_INC_URLS2")) return;
define("_INC_URLS2", "1");

function generer_url_article($id_article) {
	return "article.php3?id_article=$id_article";
}

function generer_url_rubrique($id_rubrique) {
	return "rubrique.php3?id_rubrique=$id_rubrique";
}

function generer_url_breve($id_breve) {
	return "breve.php3?id_breve=$id_breve";
}

function generer_url_mot($id_mot) {
	return "mot.php3?id_mot=$id_mot";
}

function generer_url_auteur($id_auteur) {
	return "auteur.php3?id_auteur=$id_auteur";
}

function generer_url_document($id_document) {
	if (intval($id_document) <= 0)
		return '';
	if ((lire_meta("creer_htaccess")) == 'oui')
		return "spip_acces_doc.php3?id_document=$id_document";
	if ($row = @spip_fetch_array(spip_query("SELECT fichier FROM spip_documents WHERE id_document = $id_document")))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;
	return;
}

//
// URLs des forums
//

// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
function racine_forum($id_forum){
	if (!$id_forum = intval($id_forum)) return;
	$query = "SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=".$id_forum;
	$result = spip_query($query);
	if($row = spip_fetch_array($result)){
		if($row['id_parent']) {
			return racine_forum($row['id_parent']);
		}
		else {
			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
		}
	}
} 

function generer_url_forum($id_forum, $show_thread=false) {
	list($type, $id, $id_thread) = racine_forum($id_forum);
	if ($id_thread>0 AND $show_thread)
		$id_forum = $id_thread;
	switch($type) {
		case 'article':
			return generer_url_article($id)."#forum$id_forum";
			break;
		case 'breve':
			return generer_url_breve($id)."#forum$id_forum";
			break;
		case 'rubrique':
			return generer_url_rubrique($id)."#forum$id_forum";
			break;
		default:
			return "forum.php3?id_forum=".$id_forum;
	}
}

?>

--- NEW FILE: inc-admin.php3 ---
<?php

// Inserer la feuille de style selon les normes, dans le <head>
// Feuilles de style admin : d'abord la CSS officielle, puis la perso,
function perso_admin($texte) {
	$css = "<link rel='stylesheet' href='spip_admin.css' type='text/css' />\n";
	if (@file_exists('spip_admin_perso.css'))
		$css2 = "<link rel='stylesheet' href='spip_admin_perso.css' type='text/css' />\n";

	if (eregi('<(/head|body)', $texte, $regs)) {
		$texte = explode($regs[0], $texte, 2);
		return $texte[0] . $css. $css2 . $regs[0] . $texte[1];
	} else
		return $css . $css2 . $texte;
}

?>

--- NEW FILE: backend-dist.html ---
<?php echo '<'.'?xml version="1.0" encoding="#CHARSET"?'.">\n"; ?>
<rss version="0.91" xmlns:dc="http://purl.org/dc/elements/1.1/">

<channel>
	<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
	<link>#URL_SITE_SPIP/</link>
	<description></description>
	<language>#LANG</language>

	<image>
		<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
		<url>#URL_SITE_SPIP[/(#LOGO_SITE_SPIP||extraire_attribut{src})]</url>
		<link>#URL_SITE_SPIP/</link>
		<description></description>
	</image>

	<BOUCLE_10recents(ARTICLES){lang ?}{branche ?}{par date}{inverse}{0,10}{unique}>
		<item>
		<title>[(#TITRE|texte_backend)]</title>
		<link>#URL_SITE_SPIP/#URL_ARTICLE</link>
		<date>#DATE</date>
		<description>[&lt;img src="#URL_SITE_SPIP/(#LOGO_ARTICLE||extraire_attribut{src})" align="left" hspace="4" vspace="4"&gt; ][(#INTRODUCTION|texte_backend)]</description>
		<author><BOUCLE_auteurs(AUTEURS){id_article}{", "}>[(#NOM|texte_backend)]</BOUCLE_auteurs></author>
		<dc:date>[(#DATE|date_iso)]</dc:date>
		<dc:format>text/html</dc:format>
		<dc:language>#LANG</dc:language>
		<dc:creator><BOUCLE_auteursb(AUTEURS){id_article}{", "}>[(#NOM|texte_backend)]</BOUCLE_auteursb></dc:creator>
		</item>
	</BOUCLE_10recents>
	<BOUCLE_tres_recents(ARTICLES){lang ?}{branche ?}{par date}{inverse}{age<3}{unique}>
		<item>
		<title>[(#TITRE|texte_backend)]</title>
		<link>#URL_SITE_SPIP/#URL_ARTICLE</link>
		<date>#DATE</date>
		<description>[&lt;img src="#URL_SITE_SPIP/(#LOGO_ARTICLE||extraire_attribut{src})" align="left" hspace="4" vspace="4"&gt; ][(#INTRODUCTION|texte_backend)]</description>
		<author><BOUCLE_auteurs_t(AUTEURS){id_article}{","}>[(#NOM|texte_backend)]</BOUCLE_auteurs_t></author>
		<dc:date>[(#DATE|date_iso)]</dc:date>
		<dc:format>text/html</dc:format>
		<dc:language>#LANG</dc:language>
		<dc:creator><BOUCLE_auteurs_tb(AUTEURS){id_article}{", "}>[(#NOM|texte_backend)]</BOUCLE_auteurs_tb></dc:creator>
		</item>
	</BOUCLE_tres_recents>

</channel>

</rss>

--- NEW FILE: backend-breves-dist.html ---
<?php echo '<'.'?xml version="1.0" encoding="#CHARSET"?'.">\n"; ?>
<rss version="0.91" xmlns:dc="http://purl.org/dc/elements/1.1/">

<channel>

	<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
	<link>#URL_SITE_SPIP/</link>
	<description></description>
	<language>#LANG</language>

	<image>
		<title>[(#NOM_SITE_SPIP|texte_backend)]</title>
		<url>#URL_SITE_SPIP[/(#LOGO_SITE_SPIP||extraire_attribut{src})]</url>
		<link>#URL_SITE_SPIP/</link>
		<description></description>
	</image>

	<BOUCLE_breves(BREVES){id_rubrique ?}{lang ?}{par date}{inverse}{0,10}>
	<item>
		<title>[(#TITRE|texte_backend)]</title>
		<link>#URL_SITE_SPIP/#URL_BREVE</link>
		<date>#DATE</date>
		<description>[&lt;img src="#URL_SITE_SPIP/(#LOGO_BREVE||extraire_attribut{src})" align="left" hspace="4" vspace="4"&gt; ][(#TEXTE|texte_backend)]</description>
		<dc:date>[(#DATE|date_iso)]</dc:date>
		<dc:format>text/html</dc:format>
		<dc:language>#LANG</dc:language>
	</item>
	</BOUCLE_breves>

</channel>

</rss>

--- NEW FILE: nouveautes-dist.html ---
[[(#NOM_SITE_SPIP|textebrut|texte_script)]] <:nouveautes|texte_script:>

<B0>
<:bonjour|texte_script:>

<:texte_lettre_information|texte_script:> "[(#NOM_SITE_SPIP|textebrut|texte_script)]" (#URL_SITE_SPIP).
<:texte_lettre_information_2|texte_script:> [(#HTTP_VARS{jours_neuf})] <:jours|texte_script:>.

<BOUCLE0(AUTEURS){0,1}><B_nv1>
          <:nouveaux_articles|texte_script:>
          --------------------------

<BOUCLE_nv1(ARTICLES){age_relatif<=0}{par date}{inverse}{0,30}>
[** (#TITRE|textebrut|texte_script) **]
[par (#LESAUTEURS|textebrut|texte_script)]
[le (#DATE|affdate|texte_script)]

[(#INTRODUCTION|textebrut|texte_script)]

-> #URL_SITE_SPIP/#URL_ARTICLE

</BOUCLE_nv1><B_nv2>
          
          <:nouvelles_breves|texte_script:>
          --------------------------

<BOUCLE_nv2(BREVES){age_relatif<=0}{par date}{inverse}{0,30}>
[* (#TITRE|textebrut|texte_script) *]
[ - (#DATE|affdate|texte_script)]

[(#INTRODUCTION|textebrut|texte_script)]

-> #URL_SITE_SPIP/#URL_BREVE

</BOUCLE_nv2></BOUCLE0>
--- NEW FILE: distrib.php3 ---
<?php
$fond = "distrib";
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
$flag_preserver = true;

include ("inc-public.php3");

?>
--- NEW FILE: distrib-dist.html ---
document.write('<table border="0" bgcolor="#000000" cellspacing="0" cellpadding="0"><tr><td>');
document.write('<table border="0" bgcolor="#ffffff" cellspacing="1" cellpadding="2"><tr><td bgcolor="#d0d0d0" align="center">');
document.write('<a href="#URL_SITE_SPIP/"><b>[(#NOM_SITE_SPIP|addslashes)]</b></a>&nbsp;</td></tr><tr><td><ul><small>');
<BOUCLE_articles(articles){tout}{par date}{inverse}{0,10}>
document.write('<li><a href="#URL_SITE_SPIP/#URL_ARTICLE"><font color="#000000">[(#TITRE|addslashes)]</font></a></li>\n');
</BOUCLE_articles>
document.write('</small></ul></td></tr></table></td></tr></table>');

--- NEW FILE: inc-stats.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_INC_STATS")) return;
define("_INC_STATS", "1");

function ecrire_stats() {
	global $id_article, $id_breve, $id_rubrique;

	if ($GLOBALS['HTTP_X_FORWARDED_FOR'])
		$log_ip = $GLOBALS['HTTP_X_FORWARDED_FOR'];
	else
		$log_ip = $GLOBALS['REMOTE_ADDR'];

	if ($log_id_num = intval($id_rubrique))
		$log_type = "rubrique";
	else if ($log_id_num = intval($id_article))
		$log_type = "article";
	else if ($log_id_num = intval($id_breve))
		$log_type = "breve";
	else
		$log_type = "autre";

	// Conversion IP 4 octets -> entier 32 bits
	if (ereg("^(::ffff:)?([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$", $log_ip, $r)) {
		$log_ip = sprintf("0x%02x%02x%02x%02x", $r[2], $r[3], $r[4], $r[5]);
	}
	else return;

	//
	// Loguer la visite dans la base si possible
	//
	if ($log_type != "autre") {
		$query = "INSERT IGNORE INTO spip_visites_temp (ip, type, id_objet) ".
			"VALUES ($log_ip, '$log_type', $log_id_num)";
		spip_query($query);
	}

	//
	// Loguer le referer
	//
	$url_site_spip = lire_meta('adresse_site');
	$url_site_spip = eregi_replace("^((https?|ftp)://)?(www\.)?", "", $url_site_spip);
	$log_referer = $GLOBALS['HTTP_REFERER'];
	if (($url_site_spip<>'') AND strpos('-'.strtolower($log_referer), strtolower($url_site_spip)) AND !$GLOBALS['var_recherche']) $log_referer = "";
	if ($log_referer) {
		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
		$query = "INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) ".
			"VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)";
		spip_query($query);
	}
}


function afficher_raccourci_stats($id_article) {
	$query = "SELECT visites, popularite FROM spip_articles WHERE id_article=$id_article AND statut='publie'";
	$result = spip_query($query);
	if ($row = @spip_fetch_array($result)) {
		$visites = intval($row['visites']);
		$popularite = ceil($row['popularite']);

		$query = "SELECT COUNT(DISTINCT ip) AS c FROM spip_visites_temp WHERE type='article' AND id_objet=$id_article";
		$result = spip_query($query);
		if ($row = @spip_fetch_array($result)) {
			$visites = $visites + $row['c'];
		}

		return array('visites' => $visites, 'popularite' => $popularite);
	}
}

?>

--- NEW FILE: forum-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="#LANG">
<head>
<title>[#NOM_SITE_SPIP] <:poster_message:></title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="print, projection, screen, tv">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

</div>


<!-- Contenu : poster un message dans le forum -->

<div id="principal" class="contenu">

<h1 class="structure"><:poster_message:></h1>

<BOUCLE_article(ARTICLES) {id_article}>
	<:en_reponse:>
	[(#LOGO_ARTICLE|right)]
	[<div class="surtitre">(#SURTITRE)</div>]
	<h2 class="titre-extrait"><a href="#URL_ARTICLE">#TITRE</a></h2>
	[<div class="surtitre">(#SOUSTITRE)</div>]
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs_un><:par_auteur:> <BOUCLE_auteurs_un(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs_un>
	</div>
	[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
	<br>
</BOUCLE_article>

<BOUCLE_breve(BREVES) {id_breve}>
	<:en_reponse:>
	[(#LOGO_BREVE|right)]
	<h2 class="titre-extrait"><a href="#URL_BREVE">#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	</div>
	[<div class="texte"><div class="extrait">(#INTRODUCTION)</div></div>]
	<br>
</BOUCLE_breve>

<BOUCLE_forum_parent(FORUMS) {id_forum}>
	<:en_reponse:>
	<h2 class="titre-extrait"><a href="#URL_BREVE">#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	</div>
	[<div class="texte"><div class="extrait">(#TEXTE)</div></div>]
	<br>
</BOUCLE_forum_parent>


#FORMULAIRE_FORUM


</div>

#FORMULAIRE_ADMIN
</body>
</html>



--- NEW FILE: mes_fonctions.php3 ---
<?php

function wkt2style($geometrie){
	$debut=strpos($geometrie,"(");
	$milieu=strpos($geometrie,",");
	$fin=strpos($geometrie,";");
	$returned_str="top: ".substr($geometrie,$milieu+1,$fin-$milieu-1)."px;left: ".substr($geometrie,$debut+1,$milieu-$debut-1)."px;";
	return $returned_str;
}
/////////////////////////////
//CARTO
/////////////////////////////
global $tables_principales,$table_primary,$tables_auxiliaires;

$spip_carto_carte = array(
	"id_carte" => "bigint(21) NOT NULL",
	"titre" => "VARCHAR(255) BINARY NOT NULL",
	"commentaire" => "TEXT BINARY NOT NULL",
	"fichier" => "TEXT BINARY NOT NULL",
	"callage" => "TEXT BINARY NOT NULL",
	"id_srs" => "bigint(21) NOT NULL");

$spip_carto_carte_key = array(
	"PRIMARY KEY" => "id_carte",
	"KEY id_carte" => "id_carte");

$spip_carto_objet = array(
	"id_objet" => "bigint(21) NOT NULL",
	"id_carte" => "bigint(21) NOT NULL",
	"titre" => "VARCHAR(255) BINARY NOT NULL",
	"commentaire" => "TEXT BINARY NOT NULL",
	"lien" => "VARCHAR(255) BINARY NOT NULL",
	"logo" => "VARCHAR(255) BINARY NOT NULL",
	"geometrie" => "TEXT BINARY NOT NULL");
	
$spip_carto_objet_key = array(
	"PRIMARY KEY" => "id_objet",
	"KEY id_carte" => "id_carte",
	"KEY titre" => "titre");

$tables_principales['carto_objet'] =
	array('field' => &$spip_carto_objet, 'key' => &$spip_carto_objet_key);
$tables_principales['carto_carte'] =
	array('field' => &$spip_carto_carte, 'key' => &$spip_carto_carte_key);

$table_primary['carto_carte']="id_carte";

$spip_carto_carte_articles = array(
	"id_carte" 	=> "BIGINT (21) DEFAULT '0' NOT NULL",
	"id_article" 	=> "BIGINT (21) DEFAULT '0' NOT NULL");

$spip_carto_carte_articles_key = array(
	"KEY id_carte" 	=> "id_form",
	"KEY id_article" => "id_article");

$tables_auxiliaires['carto_carte_articles'] = array(
	'field' => &$spip_carto_carte_articles,
	'key' => &$spip_carto_carte_articles_key);

$spip_mots_carto_objet= array(
	"id_carto_objet" 	=> "BIGINT (21) DEFAULT '0' NOT NULL",
	"id_mot" 	=> "BIGINT (21) DEFAULT '0' NOT NULL");

$spip_mots_carto_objet_key = array(
	"KEY id_carto_objet" 	=> "id_carto_objet",
	"KEY id_mot" => "id_mot");

$tables_principales['mots_carto_objets'] = array(
	'field' => &$spip_mots_carto_objet,
	'key' => &$spip_mots_carto_objet_key);

/*
 *   +---------------------------------------------+
 *    Nom du Filtre : WKT to COORDS
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : 
 *    site :  
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#GEOMETRIE|wkt2coords)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * http://www.uzine.net/spip_contrib/
 *
 */
function wkt2coords($geometrie){
	
	return str_replace(';',',',substr($geometrie,8,-1));
}
/*
 *   +---------------------------------------------+
 *    Nom du Filtre : WKT to SHAPE 
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : 
 *    site :  
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#GEOMETRIE|wkt2shape)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * http://www.uzine.net/spip_contrib/
 *
 */
function wkt2shape($geometrie){
	
	return substr($geometrie,0,4);
}

/*
 *   +---------------------------------------------+
 *    Nom du Filtre : Nombre de messages 
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : BoOz Email:booz.bloog at laposte.net
 *    site : http://bloog.net
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *    Compte le nombre de messages d'un auteur
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#ID_AUTEUR|nb_messages)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * http://www.uzine.net/spip_contrib/
 *
 */


?>

--- NEW FILE: auteur.php3 ---
<?php
$fond = "auteur";
$delais = 24 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: ical.php3 ---
<?php

$fond = "ical";
$delais = 3600;

@header ("content-type:text/calendar");

$flag_preserver=true;
include ("inc-public.php3");


?>

--- NEW FILE: breve.php3 ---
<?php
$fond = "breve";
$delais = 12 * 3600;

include ("inc-public.php3");


?>

--- NEW FILE: inc-formulaire_recherche.php3 ---
<?php

global $balise_FORMULAIRE_RECHERCHE_collecte;
$balise_FORMULAIRE_RECHERCHE_collecte = array();

function balise_FORMULAIRE_RECHERCHE_stat($args, $filtres)
{
  return (lire_meta("activer_moteur") != "oui") ? '' : array($filtres[0]);
}
 
function balise_FORMULAIRE_RECHERCHE_dyn($lien) {
	return array('formulaire_recherche', 3600, 
		     array('lien' => ($lien ? $lien : 'recherche.php3'),
			   'recherche' => ($GLOBALS['recherche'] ? $GLOBALS['recherche'] : _T('info_rechercher'))));
}

?>
--- NEW FILE: breve-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_breve_principal(BREVES) {id_breve}>

<html lang="#LANG">
<head>
<title>#TITRE</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">


<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]

<!-- Menu de navigation rubriques -->

<div class="menu">
<ul class="rubriques">
<BOUCLE_rubrique(RUBRIQUES) {id_rubrique}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
</li>
<BOUCLE_autres_rubriques(RUBRIQUES) {racine} {exclus} {par titre}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_autres_rubriques>
</BOUCLE_rubrique>
</ul>
</div>


<!-- Menu de navigation mots-cles -->

<B_mots>
<div class="menu">
<ul class="divers" title="<:mots_clefs:>">
<BOUCLE_mots(MOTS) {id_article} {par titre}>
<li>
<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_breves_mots>
	<ul class="menu-liste">
<BOUCLE_breves_mots(BREVES) {id_mot} {par hasard} {0,4}>
	<li class="menu-item"><a href="#URL_BREVE">#TITRE</a></li>
</BOUCLE_breves_mots>
	</ul>
</B_breves_mots>
</li>
</BOUCLE_mots>
</ul>
</div>
</B_mots>


<!-- Articles dans le meme secteur -->

<B_articles_secteur>

<div class="menu">
<div class="breves" title="<:derniers_articles:>">
	<div class="menu-titre">
	<:derniers_articles:>
	</div>
	<ul>
<BOUCLE_articles_secteur(ARTICLES) {id_secteur} {par date} {inverse} {0,5}>
	<li class="menu-item">
	<a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a>
	</li>
</BOUCLE_articles_secteur>
	</ul>
</div>
</div>

</B_articles_secteur>


</div>

<!-- Contenu : corps de la breve -->

<div class="contenu" id="principal">

<div id="cartouche">
[(#LOGO_BREVE|left)]
<h1 class="titre-texte">#TITRE</h1>
[(#DATE|nom_jour)] [(#DATE|affdate).]
</div>

	<div class="encart">

	<!-- Breves dans la meme rubrique -->

	<B_breves_rubrique>

	<div class="menu">
	<div class="breves" title="<:meme_rubrique:>">
		<h1 class="structure"><:meme_rubrique:></h1>
		<div class="menu-titre">
		<:autres_breves:>
		</div>
		<ul>
	<BOUCLE_breves_rubrique(BREVES) {id_rubrique} {exclus} {par date} {inverse} {0,8}>
		<li class="menu-item">
		<i>[(#DATE|affdate_court)]</i>:
		<a href="#URL_BREVE">#TITRE</a>
		</li>
	</BOUCLE_breves_rubrique>
		</ul>
	</div>
	</div>

	</B_breves_rubrique>

	</div>


[<div class="texte">(#TEXTE)</div>]
[<div class="chapo"><:voir_en_ligne:>: <a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a>.</div>]
[<div class="notes">(#NOTES)</div>]

<br>


<!-- Forums -->

[<div class="forum-repondre"><B><A  HREF="forum.php3?(#PARAMETRES_FORUM)"><:repondre_breve:></A></B></div>]
<br>

<h1 class="structure"><:forum:></h1>

<B_forums>
<ul class="forum-total">

<BOUCLE_forums(FORUMS){id_breve}{par date}{inverse}>

<li>
<div class="forum-fil">
<div class="forum">
<a name="forum#ID_FORUM"></a>
<div class="forum-chapo">
<div class="forum-titre">#TITRE</div>
[(#DATE|affdate)][, <:par_auteur:> <A HREF="mailto:#EMAIL">(#NOM)</A>]
</div>
<div class="forum-item">
#TEXTE
[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
</div>
</div>

<B_forums_fils>
	<ul>
	<BOUCLE_forums_fils(FORUMS){id_parent}{par date}>

	<li>
	<div class="forum">
	<a name="forum#ID_FORUM"></a>
	<div class="forum-chapo">
	<div class="forum-titre">#TITRE</div>
	[(#DATE|affdate)][, par <A HREF="mailto:#EMAIL">(#NOM)</A>]
	</div>
	<div class="forum-item">
	#TEXTE
	[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
	[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
	</div>

	</div>

	<BOUCLE_Forums_Boucle(boucle_forums_fils)></BOUCLE_Forums_Boucle>
	</li>

	</BOUCLE_forums_fils>
	</ul>
</B_forums_fils>

</div>
</li>
</BOUCLE_forums>

</ul>
</B_forums>

</div>
#FORMULAIRE_ADMIN
</body></html>
</BOUCLE_breve_principal>
<:aucune_breve:>
<//B_breve_principal>

--- NEW FILE: plan.php3 ---
<?php

$fond = "plan";
$delais = 2 * 3600;

include ("inc-public.php3");

?>

--- NEW FILE: inc-messforum.php3 ---
<?php

include_ecrire('inc_meta.php3');
include_ecrire('inc_forum.php3');

// Ce fichier inclus par inc-public a un comportement special
// Voir commentaires dans celui-ci et dans inc-formulaire_forum

function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre)
{
	include_ecrire('inc_texte.php3');
	include_ecrire('inc_filtres.php3');
	include_ecrire('inc_mail.php3');
	// Gestionnaire d'URLs
	if (@file_exists("inc-urls.php3"))
	  include_local("inc-urls.php3");
	else
	  include_local("inc-urls-".$GLOBALS['type_urls'].".php3");
	$url = ereg_replace('^/', '', generer_url_article($id_article));
	$adresse_site = lire_meta("adresse_site");
	$nom_site_spip = lire_meta("nom_site");
	$url = "$adresse_site/$url";
	$parauteur = (strlen($auteur) <= 2) ? '' :
	  (" "
	   ._T('forum_par_auteur',
	       array('auteur' => $auteur)) .
	   (!$email_auteur ? '' : (' <' . $email_auteur . '>')));
	$courr =  _T('form_forum_message_auto')."\n\n"
		. _T('forum_poste_par',
		     array('parauteur' => $parauteur))."\n"
		. _T('forum_ne_repondez_pas')."\n"
		. $url
		. "\n\n\n".$titre."\n\n".textebrut(propre($texte))
		. "\n\n$nom_site_forum\n$url_site\n";
	$sujet = "[$nom_site_spip] ["._T('forum_forum')."] $titre";
	$result = spip_query("SELECT auteurs.email FROM spip_auteurs AS auteurs,
				spip_auteurs_articles AS lien
				WHERE lien.id_article='$id_article'
				AND auteurs.id_auteur=lien.id_auteur");

	while (list($email) = spip_fetch_array($result)) {
		$email = trim($email);
		if (strlen($email) < 3) continue;
		envoyer_mail($email, $sujet, $courr);
	}
}	

$retour_forum = rawurldecode($retour);
$forum_id_article = intval($id_article);
$forum_id_rubrique = intval($id_rubrique);
$forum_id_forum = intval($id_forum);
$forum_id_breve = intval($id_breve);
$forum_id_syndic = intval($id_syndic);
$slash_texte = addslashes($texte);
$slash_titre = addslashes($titre);
$slash_nom_site_forum = addslashes($nom_site_forum);
$slash_url_site = addslashes($url_site);
$id_message = intval($id_message);

if (!$id_auteur)
	$id_auteur = intval($auteur_session['id_auteur']);

if ($forum_id_article) {
	$r = spip_query("SELECT accepter_forum FROM spip_articles WHERE id_article=$forum_id_article");
	$r = spip_fetch_array($r);
	if ($r)
		$forums_publics = $r['accepter_forum'];
	else
		$forums_publics = lire_meta("forums_publics");
} else {
	$forums_publics = substr(lire_meta("forums_publics"),0,3);
}

if ($forums_publics == "abo") {
	if ($auteur_session) {
		$statut = $auteur_session['statut'];
		if (!$statut OR $statut == '5poubelle') {
			ask_php_auth(_T('forum_acces_refuse'),
				     _T('forum_cliquer_retour',
					array('retour_forum' => $retour_forum)));
			exit;		  
		}
	}
	else {
		ask_php_auth(_T('forum_non_inscrit'),
			     _T('forum_cliquer_retour',
				array('retour_forum' => $retour_forum)));
		exit;		  
	}

	// Ne pas autoriser de changement de nom si forum sur abonnement
	$auteur = $auteur_session['nom'];
	$email_auteur = $auteur_session['email'];
 } 

$slash_auteur = addslashes($auteur);
$slash_email_auteur = addslashes($email_auteur);

if ((strlen($slash_texte) + strlen($slash_titre) + strlen($slash_nom_site_forum) + strlen($slash_url_site) + strlen($slash_auteur) + strlen($slash_email_auteur)) > 20 * 1024) {
	ask_php_auth(_T('forum_message_trop_long'),
		     _T('forum_cliquer_retour',
			array('retour_forum' => $retour_forum)));
			exit;		  
}

spip_query("DELETE FROM spip_mots_forum WHERE id_forum='$id_message'");
if ($ajouter_mot) {
	for (reset($ajouter_mot);$key=key($ajouter_mot);next($ajouter_mot))
		$les_mots .= ",".join($ajouter_mot[$key],",");
	$les_mots = explode(",", $les_mots);
	for ($index = 0; $index < count($les_mots); $index++){
		$le_mot = $les_mots[$index];
		if ($le_mot > 0)
		spip_query("INSERT INTO spip_mots_forum (id_mot, id_forum)
		VALUES ('$le_mot', '$id_message')");
	}
}

$validation_finale = (strlen($confirmer) > 0 OR
	($afficher_texte=='non' AND $ajouter_mot));
$statut = ((!$validation_finale) ? 'redac' : 
	(($forums_publics == 'non') ? 'off' :
	(($forums_publics == 'pri') ? 'prop' : 'publie')));

if ($forum_id_forum > 0) $id_thread = $forum_id_forum;
else $id_thread = $id_message;

spip_query("UPDATE spip_forum SET id_parent = $forum_id_forum,
	id_rubrique =$forum_id_rubrique,
	id_article = $forum_id_article,
	id_breve = $forum_id_breve,
	id_syndic = $forum_id_syndic,
	id_auteur = $id_auteur,
	id_thread = $id_thread,
	date_heure = NOW(),
	titre = \"$slash_titre\",
	texte = \"$slash_texte\",
	nom_site = \"$slash_nom_site_forum\",
	url_site = \"$slash_url_site\",
	auteur = \"$slash_auteur\",
	email_auteur = \"$slash_email_auteur\",
	ip = \"$REMOTE_ADDR\",
	statut = \"$statut\"
	WHERE id_forum = '$id_message'
");

//calculer_threads();

if ($validation_finale) {
	include_ecrire("inc_admin.php3");
	if (!(verifier_action_auteur("ajout_forum $forum_id_rubrique".
	" $forum_id_forum $forum_id_article $forum_id_breve".
	" $forum_id_syndic $alea", $hash))) {
		header("Status: 404");
		exit;
	} else {
	  if (lire_meta("prevenir_auteurs") == "oui" AND ($afficher_texte != "non") AND ($id_article = $forum_id_article)) {
			prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);

		}
		// Poser un cookie pour ne pas retaper le nom / email
		$cookie_user = array('nom' => $auteur, 'email' => $email_auteur);
		spip_setcookie('spip_forum_user', serialize($cookie_user));

		//
		// INVALIDATION DES CACHES LIES AUX FORUMS
		//
		include_ecrire('inc_invalideur.php3');
		if ($statut == 'publie') {
			suivre_invalideur ("id='id_forum/" .
				calcul_index_forum($forum_id_article,
					$forum_id_breve,
					$forum_id_rubrique,
					$forum_id_syndic) . "'");
		}

		$redirect = $retour_forum;
	}
}

?>

--- NEW FILE: inc-cache.php3 ---
<?php

//
// Ce fichier ne sera execute qu'une fois
if (defined("_INC_CACHE")) return;
define("_INC_CACHE", "1");


//
// Calcul du nom du fichier cache
//

function nettoyer_uri() {
	$fichier_requete = $GLOBALS['REQUEST_URI'];
	$fichier_requete = eregi_replace
		('[?&](PHPSESSID|(var_[^=&]*))=[^&]*',
		'', $fichier_requete);
	return $fichier_requete;
}

//
// Le format souhaite : "CACHE/a/(8400/)bout-d-url.md5(.gz)"
// Attention a modifier simultanement le sanity check de
// la fonction retire_cache()
//
function generer_nom_fichier_cache($contexte='', $fond='') {
	global $delais;
	global $flag_gz, $compresser_cache;

	if ($delais == 0) return '';

	if (!$contexte) {
		$fichier_requete = nettoyer_uri();
	} else {
		$fichier_requete = $fond;
		foreach ($contexte as $var=>$val)
			$fichier_requete .= "&$var=$val";
	}

	$md_cache = md5($fichier_requete);

	$fichier_cache = ereg_replace('^/+', '', $fichier_requete);
	$fichier_cache = ereg_replace('\.[a-zA-Z0-9]*', '', $fichier_cache);
	$fichier_cache = ereg_replace('&[^&]+=([^&]+)', '&\1', $fichier_cache);
	$fichier_cache = rawurlencode(strtr($fichier_cache, '/&-', '--_'));
	if (strlen($fichier_cache) > 24)
		$fichier_cache = substr(ereg_replace('([a-zA-Z]{1,3})[^-]*-',
		'\1-', $fichier_cache), -22);

	// Pour la page d'accueil
	if (!$fichier_cache)
		$fichier_cache = 'INDEX-';

	// morceau de md5
	$fichier_cache .= '.'.substr($md_cache, 1, 8);

	// Sous-repertoires 0...9a..f/
	$subdir = creer_repertoire(_DIR_CACHE, substr($md_cache, 0, 1));
	// Sous-sous-repertoires delais/ (inutile avec l'invalidation par 't')
	# $subdir2 = creer_repertoire("CACHE/$subdir", $delais);

	include_ecrire('inc_acces.php3');
	verifier_htaccess(_DIR_CACHE);

	$gzip = $flag_gz && $compresser_cache ? '.gz' : '';

	return _DIR_CACHE . $subdir.$subdir2.$fichier_cache.$gzip;
}

//
// Destruction des fichiers caches invalides
//
// NE PAS appeler ces fonctions depuis l'espace prive 
// car openbase_dir peut leur interdire l'acces au repertoire de cache

// Securite : est sur que c'est un cache
function retire_cache($cache) {
	if ($GLOBALS['flag_ecrire']) return;
	if (preg_match('|^' . _DIR_CACHE .
		"([0-9a-f]/)?([0-9]+/)?[^.][\-_\%0-9a-z]+\.[0-9a-f]+(\.gz)?$|i",
		       $cache)) {
		// supprimer le fichier (de facon propre)
		supprimer_fichier($cache);
	} else
		spip_log("Impossible de retirer $cache");
}

// Supprimer les caches marques "x"
function retire_caches() {
	if ($GLOBALS['flag_ecrire']) return;

	// signaler
	effacer_meta('invalider');
	ecrire_metas();

	// recuperer la liste des caches voues a la suppression
	$suppr = array();
	$q = spip_query("SELECT fichier FROM spip_caches WHERE type='x'");
	while ($r = spip_fetch_array($q))
		$suppr[$r['fichier']] = true;

	if ($n = count($suppr)) {
		spip_log ("Retire $n caches");
		foreach ($suppr as $cache => $ignore)
			retire_cache($cache);
		spip_query("DELETE FROM spip_caches WHERE "
		.calcul_mysql_in('fichier', "'".join("','",$suppr)."'") );
	}
}

//
// Retourne 0 s'il faut calculer le cache, 1 si on peut l'utiliser
//
function utiliser_cache($chemin_cache, $delais) {
	global $HTTP_SERVER_VARS;

	// ne jamais calculer pour les moteurs de recherche, proxies...
	if ($HTTP_SERVER_VARS['REQUEST_METHOD'] == 'HEAD')
		return 1;

	//  calcul par forcage
	if ($GLOBALS['var_mode'] &&
		($GLOBALS['HTTP_COOKIE_VARS']['spip_session']
		|| $GLOBALS['HTTP_COOKIE_VARS']['spip_admin']
		|| @file_exists(_ACCESS_FILE_NAME))) # insuffisant...
		return 0;

	// calcul par absence
	if (!@file_exists($chemin_cache)) return 0;

	// calcul par obsolescence
	return ((time() - @filemtime($chemin_cache)) > $delais) ? 0 : 1;
}


// Obsolete ?  Utilisee pour vider le cache depuis l'espace prive
// (ou juste les squelettes si un changement de config le necessite)
function purger_repertoire($dir, $age='ignore', $regexp = '') {
	$handle = @opendir($dir);
	if (!$handle) return;

	while (($fichier = @readdir($handle)) != '') {
		// Eviter ".", "..", ".htaccess", etc.
		if ($fichier[0] == '.') continue;
		if ($regexp AND !ereg($regexp, $fichier)) continue;
		$chemin = "$dir/$fichier";
		if (is_file($chemin))
			@unlink($chemin);
		else if (is_dir($chemin))
			if ($fichier != 'CVS')
				purger_repertoire($chemin);
	}
	closedir($handle);
}

function purger_cache() {
	spip_log('vider le cache');
	include_ecrire('inc_invalideur.php3');
	supprime_invalideurs();
	purger_repertoire(_DIR_CACHE, 0);
}

function purger_squelettes() {
	spip_log('effacer les squelettes compiles');
	purger_repertoire(_DIR_CACHE, 0, '^skel_');
}


// Determination du fichier cache (si besoin)
function determiner_cache($delais, &$use_cache, &$chemin_cache) {

	// Le fichier cache est-il valide ?
	if ($delais == 0 OR !empty($GLOBALS['HTTP_POST_VARS'])) {
		$use_cache = 0;
		$chemin_cache = '';
	} else {
		$use_cache = utiliser_cache($chemin_cache, $delais);
	}

	// Sinon, tester qu'on a la connexion a la base
	if (!$use_cache) {
		include_local(_FILE_CONNECT);
		if (!$GLOBALS['db_ok']) {
			if ($chemin_cache AND @file_exists($chemin_cache)) {
				$use_cache = 1;
			}
			else {
				spip_log("Erreur base de donnees & "
					. "impossible utiliser $chemin_cache");
				if (!$GLOBALS['flag_preserver']) {
					include_ecrire('inc_presentation.php3');
					install_debut_html(_T('info_travaux_titre'));
					echo _T('titre_probleme_technique');
					install_fin_html();
				}
				exit;
			}
		}
	}
}

?>

--- NEW FILE: formulaire_oubli-dist.html ---
[
(#HTTP_VARS*{message})
][
(#HTTP_VARS*{message}|?{'',' '})
<form id="oubli_form" action='spip_pass.php3' method='post'>
	<fieldset style="border: none;"><legend></legend>[
	<:pass_nouveau_pass:>
	<input type='hidden' name="p" value="(#HTTP_VARS{p})">
	<label>
	    <:pass_choix_pass:>
	    <input type="password" name="oubli">
	</label>][
	(#HTTP_VARS{p}|?{'',' '})
	<label>
	  <:pass_indiquez_cidessous:>
	  <input type="texte" name="oubli">
	</label>]
	<input type=submit class="fondl" value="<:pass_ok:>">
      </fieldset>
</form>
]
<br />
<div align="right">
<script type="text/javascript"><!--
[
(#HTTP_VARS*{message}|?{'',' '})
document.oubli_form.oubli.focus()
]
document.write("<a href='")
document.write((window.opener) ? "javascript:close()" : "./")
document.write("'><:pass_quitter_fenetre:><" + "/a>");
//--></script>
<noscript>
	&#91;<a href='./'><:pass_retour_public:></a>&#93;
</noscript>
</div>
<br />

--- NEW FILE: inc-menu_lang.php3 ---
<?php

global $balise_MENU_LANG_collecte;
$balise_MENU_LANG_collecte = array('menu_lang');

// s'il n'y a qu'une langue eviter definitivement la balise ?php 

function balise_MENU_LANG_stat ($args, $filtres)
{
  if (!strpos(lire_meta('langues_multilingue'),',')) return '';
  return $args;
}

// normalement $opt sera toujours non vide suite au test ci-dessus

function balise_MENU_LANG_dyn($default)
{
  include_ecrire("inc_lang.php3");
  $opt = liste_options_langues('var_lang', $default);
  if (!$opt) return '';
  include_local("inc-menu_lang_ecrire.php3");
  return menu_lang_pour_tous('var_lang', $opt);
}
?>

--- NEW FILE: auteur-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_auteur_principal(AUTEURS) {id_auteur}>

<html lang="#LANG">
<head>
<title>[(#NOM|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


</div>


<!-- Une : affichage de l'auteur -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_AUTEUR|left)]
<h1 class="titre-texte">#NOM</h1>

[<div class="chapo">(#BIO)</div>]
[<br>#NOM_SITE : <a href="(#URL_SITE)">#URL_SITE</a><br>]
[<div class="notes">(#NOTES)</div>]
</div>

[<p><b><:envoyer_message:></b></p>
<div class='spip_encadrer'><b>(#FORMULAIRE_ECRIRE_AUTEUR)</b></div>]

<!-- Articles de l'auteur -->

<h1 class="structure"><:articles_auteur:></h1>

<div class="liste-articles">

<BOUCLE_articles(ARTICLES) {id_auteur} {par titre}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs><:par_auteur:> <BOUCLE_auteurs(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs>
	</div>
	<br>
</BOUCLE_articles>

</div>

</div>
#FORMULAIRE_ADMIN
</body>
</html>

</BOUCLE_auteur_principal>
<:aucun_auteur:>
<//B_auteur_principal>

--- NEW FILE: article-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_article_principal(ARTICLES) {id_article}>
<html lang="#LANG">
<head>
<title>[(#TITRE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">
<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">
<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>

<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Menu de navigation rubriques -->

<B_rubriques>
<div class="menu">
<ol class="rubriques">
<BOUCLE_rubriques(HIERARCHIE) {id_article}>
<li>
<div class="menu-titre"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_sous_rubriques>
	<ul class="menu-liste">
<BOUCLE_sous_rubriques(RUBRIQUES) {meme_parent} {exclus} {par date} {inverse} {0,3}>
	<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
</BOUCLE_sous_rubriques>
	</ul>
</B_sous_rubriques>
</li>
</BOUCLE_rubriques>
</ol>
</div>
</B_rubriques>


<!-- Menu de navigation mots-cles -->

<B_mots>
<div class="menu">

<h1 class="structure"><:mots_clefs:></h1>

<ul class="divers" title="<:mots_clefs:>">
<BOUCLE_mots(MOTS) {id_article} {par titre}>
<li>
<div class="menu-titre"><a href="#URL_MOT" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></div>
<B_articles_mots>
	<ul class="menu-liste">
<BOUCLE_articles_mots(ARTICLES) {id_mot} {par hasard} {0,4}>
	<li class="menu-item"><a href="#URL_ARTICLE" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
</BOUCLE_articles_mots>
	</ul>
</B_articles_mots>
</li>
</BOUCLE_mots>
</ul>
</div>
</B_mots>


<!-- Liens des forums -->
<BOUCLE_forums_decompte(FORUMS){id_article}{plat}></BOUCLE_forums_decompte>
[<div class="menu" title="<:derniers_commentaires:>">

<h1 class="structure"><:derniers_commentaires:></h1>

<ul class="forums">

<li class="menu-titre"><:messages_forum:>: (#TOTAL_BOUCLE)</li>]
<//B_forums_decompte>
<BOUCLE_forums_liens(FORUMS){id_article}{par date}{inverse}{0,5}>
    <li class="menu-item">[<i>(#DATE|affdate_court)</i>:]
    <a href="#forum#ID_FORUM">#TITRE</a>
    </li>
</BOUCLE_forums_liens>
</ul>
</div>
</B_forums_liens>


</div>


<!-- Une : derniers articles publies -->

<div class="contenu" id="principal">

<div class="cartouche">
#DEBUT_SURLIGNE[
(#LOGO_ARTICLE|left)][
<div class="surtitre">(#SURTITRE)</div>
]<h1 class="titre-texte">#TITRE</h1>[
<div class="surtitre">(#SOUSTITRE)</div>
]#FIN_SURLIGNE
[(#DATE|nom_jour)] [(#DATE|affdate).]
</div>
<div style="line-height: 0em">&nbsp;</div><!-- Bug Mozilla http://bugzilla.mozilla.org/show_bug.cgi?id=200510 -->

	<div class="encart">

	<!-- Auteurs de l'article -->

	<B_auteurs>

	<div class="menu">
	<h2 class="structure"><:memes_auteurs:></h2>
	<ul class="divers">
	<BOUCLE_auteurs(AUTEURS) {id_article} {par nom}>
		<li>
		<div class="menu-titre"><a href="#URL_AUTEUR">#NOM</a></div>
		<ul>
		[<li class="menu-item" style="text-align: center"><a href="(#URL_SITE)">#NOM_SITE</a></li>]
		[<li class="menu-item" style="text-align: center">(#BIO)</li>]
	<B_articles_auteur>
	<BOUCLE_articles_auteur(ARTICLES) {id_auteur} {par popularite} {inverse} {0,5}>
		<li class="menu-item"><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
	</BOUCLE_articles_auteur>
		</ul>
		</li>
	</BOUCLE_auteurs>
	</ul>
	</div>

	</B_auteurs>

	<!-- Articles dans la meme rubrique -->

	<B_articles_rubrique>

	<div class="menu">
	<div class="breves">
		<h2 class="structure"><:meme_rubrique:></h2>
		<div class="menu-titre">
		<:meme_rubrique:>
		</div>
		<ul>
	<BOUCLE_articles_rubrique(ARTICLES) {id_rubrique} {par hasard} {exclus} {0,8}>
		<li class="menu-item">
		<a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a>
		</li>
	</BOUCLE_articles_rubrique>
		</ul>
	</div>
	</div>

	</B_articles_rubrique>
  [<div class='reponse_formulaire'>
	<a name='sp#ID_ARTICLE' id='sp#ID_ARTICLE'></a>
    (#FORMULAIRE_SIGNATURE)
  </div>]
	</div>

#DEBUT_SURLIGNE[
<div class="chapo">(#CHAPO)</div>
][<div class="texte">(#TEXTE)</div>
][<div class="ps">(#PS)</div>][
<div class="notes">(#NOTES)</div>
]#FIN_SURLIGNE

<BOUCLE_documents_joints(DOCUMENTS) {id_article} {mode=document} {doublons} {"<br>"}>
[(#LOGO_DOCUMENT|#URL_DOCUMENT)][<br>(#TITRE)][ - (#DESCRIPTIF)]
</BOUCLE_documents_joints>
<br>


<!-- Signatures petition -->

<BOUCLE_signatures_decompte(SIGNATURES) {id_article}></BOUCLE_signatures_decompte>
[<div class="signatures-titre"><:signatures_petition:>: (#TOTAL_BOUCLE)</div>

<table class="signatures">
<thead class="structure">
<tr>
	<td><:date:></td>
	<td><:nom:></td>
	<td><:message:></td>
</tr>
</thead>
<tbody>]
<//B_signatures_decompte>
<BOUCLE_signatures(SIGNATURES) {id_article} {par date} {inverse} {debut_signatures,30}>
<tr>
	<td class="signature-date">[(#DATE|affdate_court)]</td>
	<td class="signature-nom">#NOM[<br><a href="#URL_SITE">(#NOM_SITE)</a>]</td>
	[<td class="signature-message">(#MESSAGE)</td>]
</tr>
</BOUCLE_signatures>
</tbody>
</table>
</B_signatures>


<!-- Forums -->

[<div class="forum-repondre"><B><A  HREF="forum.php3?(#PARAMETRES_FORUM)"><:repondre_article:></A></B></div>]
<br>

<h1 class="structure"><:Forum:></h1>

<B_forums>
<ul class="forum-total">

<BOUCLE_forums(FORUMS){id_article}{par date}{inverse}>

<li>
<div class="forum-fil">

<div class="forum">
<div class="forum-chapo">
<div class="forum-titre"><a name="forum#ID_FORUM"></a>#TITRE</div>
[(#DATE|affdate)][, <:par_auteur:> <A HREF="mailto:#EMAIL">(#NOM)</A>]
</div>
<div class="forum-item">
#TEXTE
[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
</div>
</div>

<B_forums_fils>
	<ul>
	<BOUCLE_forums_fils(FORUMS){id_parent}{par date}>

	<li>
	<div class="forum">
	<div class="forum-chapo">
	<div class="forum-titre"><a name="forum#ID_FORUM"></a>#TITRE</div>
	[(#DATE|affdate)][, <:par_auteur:> <A HREF="mailto:#EMAIL">(#NOM)</A>]
	</div>
	<div class="forum-item">
	#TEXTE
	[<div class="forum-titre"><a href="(#URL_SITE)" class="spip_out">#NOM_SITE</a></div>]
	[<div class="forum-repondre-message"><a href="forum.php3?(#PARAMETRES_FORUM)"><:repondre_message:></a></div>]
	</div>

	</div>

	<BOUCLE_Forums_Boucle(boucle_forums_fils)></BOUCLE_Forums_Boucle>
	</li>

	</BOUCLE_forums_fils>
	</ul>
</B_forums_fils>

</div>
</li>
</BOUCLE_forums>

</ul>
</B_forums>

</div>


#FORMULAIRE_ADMIN
</body>
</html>


</BOUCLE_article_principal>
<:aucun_article:>
<//B_article_principal>

--- NEW FILE: mot-dist.html ---
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<BOUCLE_mot_principal(MOTS) {id_mot} {doublons}>

<html lang="#LANG">
<head>
<title>[(#TITRE|textebrut)]</title>
<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET">

<!-- Ceci est la feuille de style par defaut pour les types internes a SPIP -->
<link rel="stylesheet" href="spip_style.css" type="text/css">

<!-- Les feuilles de style specifiques aux presents squelettes -->
<link rel="stylesheet" href="typographie.css" type="text/css">

<!-- media="..." permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) -->
<link rel="stylesheet" href="habillage.css" type="text/css" media="projection, screen, tv">
<!-- media="print" permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur -->
<link rel="stylesheet" href="impression.css" type="text/css" media="print">
</head>

<body bgcolor="white" dir="#LANG_DIR">

<div id="navigation">

<h1 class="structure"><:navigation:></h1>

<!-- Menu de navigation general -->

<div class="menu">
<ul class="general">
	<li class="menu-titre">
	[<a href="(#URL_SITE_SPIP)" title="<:accueil_site:>"><b>#NOM_SITE_SPIP</b></a>]
	</li>
	<li class="menu-item">
	<a href="plan.php3"><:plan_site:></a>
	</li>
	<li class="menu-item">
	<a href="resume.php3" title="<:articles_populaires:>"><:en_resume:></a>
	</li>
	<li class="menu-item">
	<a href="ecrire/"><:espace_prive:></a>
	</li>
</ul>
</div>


<!-- Formulaire de recherche -->

[(#FORMULAIRE_RECHERCHE)]


<!-- Menu de navigation mots-cles : les autres mots cles du meme groupe-->

<B_mots_freres>
<h2 class="structure"><:mots_clefs_meme_groupe:></h2>

<div class="menu">
<div class="divers">
<div class="menu-titre"><BOUCLE_groupe(GROUPES_MOTS) {id_groupe} {doublons}>#TITRE</BOUCLE_groupe></div>
	<ul class="menu-liste">
<BOUCLE_mots_freres(MOTS) {type} {doublons} {par titre}>
	<li class="menu-item"><a href="#URL_MOT" title="[(#DESCRIPTIF|textebrut|entites_html)]">#TITRE</a></li>
</BOUCLE_mots_freres>
	</ul>
</div>
</div>
</B_mots_freres>


<!-- Menu de navigation mots-cles : les autres groupes avec un lien sur le premier mot du groupe -->

<B_groupes_freres>
<h2 class="structure"><:autres_groupes_mots_clefs:></h2>

<div class="menu">
<div class="divers">
<div class="menu-titre"><:autres_groupes_mots_clefs:></div>
	<ul class="menu-liste">
<BOUCLE_groupes_freres(GROUPES_MOTS) {par titre} {doublons}>
<BOUCLE_mot_cousin(MOTS) {id_groupe} {par titre} {0,1}>
	<li class="menu-item"><a href="#URL_MOT">#TYPE</a></li>
</BOUCLE_mot_cousin>
</BOUCLE_groupes_freres>
	</ul>
</div>
</div>
</B_groupes_freres>


</div>

<!-- Une : contenu du mot-cle -->

<div class="contenu" id="principal">

<div class="cartouche">
[(#LOGO_MOT|left)]
<h1 class="titre-texte">#TITRE</h1>
</div>

	<div class="encart">

	<!-- Rubriques liees au mot-cle -->

	<B_rubriques>
	<h2 class="structure"><:rubriques:></h2>

	<div class="menu">
	<div class="rubriques">
	<div class="menu-titre"><:rubriques:></div>
		<ul class="menu-liste">
	<BOUCLE_rubriques(RUBRIQUES) {id_mot} {par titre}>
		<li class="menu-item"><a href="#URL_RUBRIQUE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></li>
	</BOUCLE_rubriques>
		</ul>
	</div>
	</div>
	</B_rubriques>

	<!-- Breves liees au mot-cle -->

	<B_breves>
	<h2 class="structure"><:breves:></h2>

	<div class="menu">
	<div class="breves">
	<div class="menu-titre"><:breves:></div>
		<ul class="menu-liste">
	<BOUCLE_breves(BREVES) {id_mot} {par titre}>
		<li class="menu-item"><a href="#URL_BREVE">#TITRE</a></li>
	</BOUCLE_breves>
		</ul>
	</div>
	</div>
	</B_breves>

	<!-- Sites Web lies au mot-cle -->

	<B_sites>
	<h2 class="structure"><:sites_web:></h2>

	<div class="menu">
	<div class="breves">
	<div class="menu-titre"><:sites_web:></div>
		<ul class="menu-liste">
	<BOUCLE_sites(SITES) {id_mot} {par nom_site}>
		<li class="menu-item"><a href="#URL_SITE">#TITRE</a></li>
	</BOUCLE_sites>
		</ul>
	</div>
	</div>
	</B_sites>

	</div>

[<div class="chapo">(#TEXTE)</div>]
[<div class="notes">(#NOTES)</div>]


<!-- Articles lies au mot-cle -->

<h1 class="structure"><:articles:></h1>

<div class="liste-articles">

<BOUCLE_articles(ARTICLES) {id_mot} {par titre}>
	<h2><a href="#URL_ARTICLE" [title="(#DESCRIPTIF|textebrut|entites_html)"]>#TITRE</a></h2>
	<div class="detail">
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	<B_auteurs><:par_auteur:> <BOUCLE_auteurs(AUTEURS) {id_article} {", "}>#NOM</BOUCLE_auteurs>
	</div>
	<br>
</BOUCLE_articles>

</div>
</div>
#FORMULAIRE_ADMIN
</body>
</html>
</BOUCLE_mot_principal>
<//B_mot_principal>

--- NEW FILE: carto.html ---
<BOUCLE_carte(CARTO_CARTE){id_carte}><img alt="#TITRE" src="#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#FICHIER)]&scale=[(#HTTP_VARS{scale})]&x=[(#HTTP_VARS{x})]&y=[(#HTTP_VARS{y})]" usemap="#map#ID_CARTE" border="0"/><B_objets><map name="map#ID_CARTE"><BOUCLE_objets(CARTO_OBJET){id_carte=#ID_CARTE}><area shape="[(#GEOMETRIE|wkt2shape)]" coords="[(#GEOMETRIE|wkt2coords)]" href="#LIEN" alt="#TITRE"/></BOUCLE_objets></map></B_objets></BOUCLE_carte>


--- NEW FILE: inc-formulaire_admin.php3 ---
<?php

global $balise_FORMULAIRE_ADMIN_collecte ;
$balise_FORMULAIRE_ADMIN_collecte = array('id_article', 'id_breve', 'id_rubrique', 'id_mot', 'id_auteur');

# on ne peut rien dire au moment de l'ex?cution du squelette

function balise_FORMULAIRE_ADMIN_stat($args, $filtres)
{
	return $args;
}

# les boutons admin sont mis d'autorite si absents
# donc une variable statique controle si FORMULAIRE_ADMIN a ete vu.
# Toutefois, si c'est le debuger qui appelle,
# il peut avoir recopie le code dans ses donnees et il faut le lui refounir.
# Pas question de recompiler: ca fait boucler !
# Le debuger transmet donc ses donnees, et cette balise y retrouve son petit.

function balise_FORMULAIRE_ADMIN_dyn($id_article, $id_breve, $id_rubrique, $id_mot, $id_auteur, $debug='') {
	global $var_preview, $use_cache;
	static $dejafait = false;

	if ($GLOBALS['flag_preserver'] || !$GLOBALS['spip_admin'])
		return '';

	if (!is_array($debug)) {
		if ($dejafait)
			return '';
	} else {
		if ($dejafait) {
			$res = '';
			foreach($debug['sourcefile'] as $k => $v) {
				if (strpos($v,'formulaire_admin') === 0)
					return $debug['resultat'][$k . 'tout'];
			}
			return '';
		}
	}
	$dejafait = true;

	// regler les boutons dans la langue de l'admin (sinon tant pis)
	include_local(_FILE_CONNECT);
	$login = addslashes(ereg_replace('^@','',$GLOBALS['spip_admin']));
	if ($row = spip_fetch_array(spip_query("SELECT lang FROM spip_auteurs WHERE login='$login'"))) {
		$lang = $row['lang'];
		include_ecrire ("inc_lang.php3");
		lang_select($lang);
	}

	// repartir de zero pour les boutons car clean_link a pu etre utilisee
	$link = new Link;
	$link->delVar('var_mode');
	$link->delVar('var_mode_objet');
	$link->delVar('var_mode_affiche');
	$action = $link->getUrl();
	$action = ($action . ((strpos($action, '?') === false) ? '?' : '&'));

  // en preview pas de stat ni de debug
	if (!$var_preview) {
		// Bouton statistiques
		if (lire_meta("activer_statistiques") != "non" 
		AND $id_article
		AND ($GLOBALS['auteur_session']['statut'] == '0minirezo')) {
			if (spip_fetch_array(spip_query("SELECT id_article
			FROM spip_articles WHERE statut='publie'
			AND id_article =".intval($id_article)))) {
				include_local ("inc-stats.php3");
				$r = afficher_raccourci_stats($id_article);
				$visites = $r['visites'];
				$popularite = $r['popularite'];
				$statistiques = 'statistiques_visites.php3?';
			}
		}

		// Bouton de debug
		$debug = (
			($forcer_debug
			OR $GLOBALS['bouton_admin_debug']
			OR ($GLOBALS['var_mode'] == 'debug'
				AND $GLOBALS['HTTP_COOKIE_VARS']['spip_debug']
			)) AND ($GLOBALS['code_activation_debug'] == 'oui'
				OR $GLOBALS['auteur_session']['statut'] == '0minirezo')
		) ? 'debug' : '';
	}

	// hack - ne pas avoir la rubrique si un autre bouton est deja present
	if ($id_article OR $id_breve) unset ($id_rubrique);

	return array('formulaire_admin', 0,
			array(
				'id_article' => $id_article,
				'id_rubrique' => $id_rubrique,
				'id_auteur' => $id_auteur,
				'id_breve' => $id_breve,
				'id_mot' => $id_mot,
				'action' => $action,
				'debug' => $debug,
				'popularite' => intval($popularite),
				'statistiques' => $statistiques,
				'visites' => intval($visites),
				'use_cache' => ($use_cache ? ' *' : '')
			)
		);
}
?>

--- NEW FILE: backend-breves.php3 ---
<?php
$fond = "backend-breves";
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
$flag_preserver = true;

@header("Content-type: text/xml");

include ("inc-public.php3");

?>



