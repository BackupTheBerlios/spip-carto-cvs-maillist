<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto rien.gif,NONE,1.1 inc-calcul.php3,1.5,1.6 inc-compilo-index.php3,1.5,1.6 spip_rss.php,1.1,1.2 inc-balises.php3,1.8,1.9 inc-criteres.php3,1.6,1.7 page.php3,1.1,1.2
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-August/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20rien.gif%2CNONE%2C1.1%20inc-calcul.php3%2C1.5%2C1.6%20inc-compilo-index.php3%2C1.5%2C1.6%20spip_rss.php%2C1.1%2C1.2%20inc-balises.php3%2C1.8%2C1.9%20inc-criteres.php3%2C1.6%2C1.7%20page.php3%2C1.1%2C1.2&In-Reply-To=%3C200508101200.j7AC0fXe022151%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000215.html">
   <LINK REL="Next"  HREF="000217.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto rien.gif,NONE,1.1 inc-calcul.php3,1.5,1.6 inc-compilo-index.php3,1.5,1.6 spip_rss.php,1.1,1.2 inc-balises.php3,1.8,1.9 inc-criteres.php3,1.6,1.7 page.php3,1.1,1.2</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20rien.gif%2CNONE%2C1.1%20inc-calcul.php3%2C1.5%2C1.6%20inc-compilo-index.php3%2C1.5%2C1.6%20spip_rss.php%2C1.1%2C1.2%20inc-balises.php3%2C1.8%2C1.9%20inc-criteres.php3%2C1.6%2C1.7%20page.php3%2C1.1%2C1.2&In-Reply-To=%3C200508101200.j7AC0fXe022151%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto rien.gif,NONE,1.1 inc-calcul.php3,1.5,1.6 inc-compilo-index.php3,1.5,1.6 spip_rss.php,1.1,1.2 inc-balises.php3,1.8,1.9 inc-criteres.php3,1.6,1.7 page.php3,1.1,1.2">stef at berlios.de
       </A><BR>
    <I>Wed Aug 10 14:00:41 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000215.html">[Spip-carto-cvs] spipcarto/ecrire inc_rss.php3,1.1,1.2 naviguer.php3,1.4,1.5 inc_charsets.php3,1.5,1.6 js_menu_rubriques.php,1.4,1.5 inc_majbase.php3,1.5,1.6 inc_calendrier.php,1.8,1.9 message.php3,1.6,1.7 inc_texte.php3,1.8,1.9 inc_debug_sql.php3,1.6,1.7 inc_sites.php3,1.6,1.7 inc_documents.php3,1.6,1.7 index.php3,1.7,1.8 mots_tous.php3,1.3,1.4 calendrier.css,1.4,1.5 inc_filtres.php3,1.7,1.8 import_all.php3,1.2,1.3 inc_version.php3,1.9,1.10 articles.php3,1.6,1.7 inc_lang.php3,1.7,1.8 inc_presentation.php3,1.9,1.10 upgrade.php3,1.3,1.4 sites.php3,1.4,1.5
</A></li>
        <LI>Next message: <A HREF="000217.html">[Spip-carto-cvs] spipcarto/ecrire mes_options.php3,1.6,1.7 inc_carto.php3,1.14,1.15
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#214">[ date ]</a>
              <a href="thread.html#214">[ thread ]</a>
              <a href="subject.html#214">[ subject ]</a>
              <a href="author.html#214">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv20918

Modified Files:
	inc-calcul.php3 inc-compilo-index.php3 spip_rss.php 
	inc-balises.php3 inc-criteres.php3 page.php3 
Added Files:
	rien.gif 
Log Message:
synchro 1.8.2 PR2  CVS 20050808

--- NEW FILE: rien.gif ---
(This appears to be a binary file; contents omitted.)

Index: inc-calcul.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-calcul.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc-calcul.php3	30 Jun 2005 10:09:36 -0000	1.5
+++ inc-calcul.php3	10 Aug 2005 12:00:39 -0000	1.6
@@ -111,6 +111,8 @@
 		if (function_exists($nom)) {
 			ecrire_fichier ($phpfile, $skel_code);
 			return $nom;
+		} else {
+			erreur_squelette($sourcefile, _L('Erreur de compilation'));
 		}
 	}
 }

Index: inc-compilo-index.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo-index.php3,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -d -r1.5 -r1.6
--- inc-compilo-index.php3	30 Jun 2005 10:09:36 -0000	1.5
+++ inc-compilo-index.php3	10 Aug 2005 12:00:39 -0000	1.6
@@ -103,31 +103,7 @@
 
 #	spip_log(&quot;Pas vu $nom_champ&quot;);
 	// esperons qu'il y sera
-	return('$Pile[0][\''.$nom_champ.'\']');
-}
-
-# calculer_champ genere le code PHP correspondant a une balise Spip
-# Retourne une EXPRESSION php 
-function calculer_champ($p) {
-	$p = calculer_balise($p-&gt;nom_champ, $p);
-
-	// definir le type et les traitements
-	// si ca ramene le choix par defaut, ce n'est pas un champ 
-
-	if (($p-&gt;code) &amp;&amp; ($p-&gt;code != '$Pile[0][\''.$nom.'\']')) {
-		// Par defaut basculer en numerique pour les #ID_xxx
-		if (substr($nom,0,3) == 'ID_') $p-&gt;statut = 'num';
-	}
-
-	else {
-	// on renvoie la forme initiale '#TOTO'
-	$p-&gt;code = &quot;'#&quot; . $nom . &quot;'&quot;;
-	$p-&gt;statut = 'php';	// pas de traitement
-	
-	}
-
-	// Retourner l'expression php correspondant au champ + ses filtres
-	return applique_filtres($p);
+	return('$Pile[0][\''. strtolower($nom_champ) . '\']');
 }
 
 // cette fonction sert d'API pour demander le champ '$champ' dans la pile
@@ -135,7 +111,14 @@
 	return index_pile($p-&gt;id_boucle, $champ, $p-&gt;boucles, $p-&gt;nom_boucle);
 }
 
-// cette fonction sert d'API pour demander une balise quelconque sans filtre
+// cette fonction sert d'API pour demander une balise Spip avec filtres
+
+function calculer_champ($p) {
+	$p = calculer_balise($p-&gt;nom_champ, $p);
+	return applique_filtres($p);
+}
+
+// cette fonction sert d'API pour demander une balise Spip sans filtres
 function calculer_balise($nom, $p) {
 
 	// regarder s'il existe une fonction personnalisee balise_NOM()
@@ -166,16 +149,18 @@
 	// ca pourrait etre un champ SQL homonyme,
 	$p-&gt;code = index_pile($p-&gt;id_boucle, $nom, $p-&gt;boucles, $p-&gt;nom_boucle);
 
+	if (strpos($nom, 'ID_') === 0) $p-&gt;statut = 'num';
+
 	// Compatibilite ascendante avec les couleurs html (#FEFEFE) :
 	// SI le champ SQL n'est pas trouve
 	// ET si la balise a une forme de couleur
 	// ET s'il n'y a ni filtre ni etoile
 	// ALORS retourner la couleur.
 	// Ca permet si l'on veut vraiment de recuperer [(#ACCEDE*)]
-	if (ereg(&quot;^[\$]Pile[[]0[]][[]'([A-F]{1,6})'[]]$&quot;, $p-&gt;code, $match)
+	if (preg_match(&quot;/^[A-F]{1,6}$/i&quot;, $nom)
 	AND !$p-&gt;etoile
 	AND !$p-&gt;fonctions) {
-		$p-&gt;code = &quot;'#&quot;. $match[1].&quot;'&quot;;
+		$p-&gt;code = &quot;'#$nom'&quot;;
 		$p-&gt;statut = 'php';
 	}
 

Index: spip_rss.php
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/spip_rss.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_rss.php	30 Jun 2005 10:09:36 -0000	1.1
+++ spip_rss.php	10 Aug 2005 12:00:39 -0000	1.2
@@ -97,7 +97,7 @@
 	# messagerie privee
 	case 'messagerie':
 		$rss = rss_suivi_messagerie($a);
-		$title = _T(&quot;icone_suivi_revisions&quot;);
+		$title = _T(&quot;icone_messagerie_personnelle&quot;);
 		$url = _DIR_RESTREINT_ABS .'messagerie.php3';
 		break;
 	# a suivre

Index: inc-balises.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-balises.php3,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -d -r1.8 -r1.9
--- inc-balises.php3	21 Jul 2005 21:47:12 -0000	1.8
+++ inc-balises.php3	10 Aug 2005 12:00:39 -0000	1.9
@@ -359,8 +359,8 @@
 }
 
 function balise_EXPOSE_dist($p) {
-	$on = 'on';
-	$off= '';
+	$on = &quot;'on'&quot;;
+	$off= &quot;''&quot;;
 
 	if ($p-&gt;param &amp;&amp; !$p-&gt;param[0][0]) {
 		$on =  calculer_liste($p-&gt;param[0][1],
@@ -383,8 +383,8 @@
 
 function balise_EXPOSER_dist($p)
 {
-	$on = 'on';
-	$off= '';
+	$on = &quot;'on'&quot;;
+	$off= &quot;''&quot;;
 	if ($a = ($p-&gt;fonctions)) {
 		// Gerer la notation [(#EXPOSER|on,off)]
 		$onoff = array_shift($a);

Index: inc-criteres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-criteres.php3,v
retrieving revision 1.6
retrieving revision 1.7
diff -u -d -r1.6 -r1.7
--- inc-criteres.php3	21 Jul 2005 21:47:12 -0000	1.6
+++ inc-criteres.php3	10 Aug 2005 12:00:39 -0000	1.7
@@ -184,12 +184,9 @@
 function critere_parinverse($idb, &amp;$boucles, $crit, $sens) {
 
 	$boucle = &amp;$boucles[$idb];
-	if ($crit-&gt;not)
-		erreur_squelette(_T('zbug_info_erreur_squelette'), $param);
-
-	$params = $crit-&gt;param;
+	if ($crit-&gt;not) $sens = $sens ? &quot;&quot; : &quot; . ' DESC'&quot;;
 
-	foreach ($params as $tri) {
+	foreach ($crit-&gt;param as $tri) {
 
 	// tris specifies dynamiquement
 	  if ($tri[0]-&gt;type != 'texte') {
@@ -267,7 +264,7 @@
 
 // {inverse}
 // <A HREF="http://www.spip.net/@inverse">http://www.spip.net/@inverse</A>
-// ancienne spec si pas d'argument, nouvelle sinon
+// obsolete. utiliser {!par ...}
 function critere_inverse_dist($idb, &amp;$boucles, $crit) {
 
 	$boucle = &amp;$boucles[$idb];
@@ -283,36 +280,74 @@
 	    else
 	      erreur_squelette(_T('zbug_info_erreur_squelette'), &quot;{inverse ?} BOUCLE$idb&quot;);
 	  }
-
-
 }
 
 function critere_agenda($idb, &amp;$boucles, $crit)
 {
 	$params = $crit-&gt;param;
-	$args = array();
+
+	if (count($params) &lt; 1)
+	      erreur_squelette(_T('zbug_info_erreur_squelette'),
+			       &quot;{agenda ?} BOUCLE$idb&quot;);
+
+	$parent = $boucles[$idb]-&gt;id_parent;
+
 	// les valeur $date et $type doivent etre connus &#224; la compilation
 	// autrement dit ne pas &#234;tre des champs
-	foreach ($params as $tri) {
-	    if ($tri[0]-&gt;type != 'texte')
-	      $args[] = calculer_liste($tri, array(), $boucles, $boucles[$idb]-&gt;id_parent);
-	    else 
-	      $args[] = $tri[0]-&gt;texte;
-	}
-	list($date, $annee, $mois, $jour, $type) = $args;
+
+	$date = array_shift($params);
+	$date = $date[0]-&gt;texte;
+
+	$type = array_shift($params);
+	$type = $type[0]-&gt;texte;
+
+	$annee = $params ? array_shift($params) : &quot;&quot;;
+	$annee = &quot;\n&quot; . 'sprintf(&quot;%04d&quot;, ($x = ' .
+		calculer_liste($annee, array(), $boucles, $parent) .
+		') ? $x : date(&quot;Y&quot;))';
+
+	$mois =  $params ? array_shift($params) : &quot;&quot;;
+	$mois = &quot;\n&quot; . 'sprintf(&quot;%02d&quot;, ($x = ' .
+		calculer_liste($mois, array(), $boucles, $parent) .
+		') ? $x : date(&quot;m&quot;))';
+
+	$jour =  $params ? array_shift($params) : &quot;&quot;;
+	$jour = &quot;\n&quot; . 'sprintf(&quot;%02d&quot;, ($x = ' .
+		calculer_liste($jour, array(), $boucles, $parent) .
+		') ? $x : date(&quot;d&quot;))';
+
+	$annee2 = $params ? array_shift($params) : &quot;&quot;;
+	$annee2 = &quot;\n&quot; . 'sprintf(&quot;%04d&quot;, ($x = ' .
+		calculer_liste($annee2, array(), $boucles, $parent) .
+		') ? $x : date(&quot;Y&quot;))';
+
+	$mois2 =  $params ? array_shift($params) : &quot;&quot;;
+	$mois2 = &quot;\n&quot; . 'sprintf(&quot;%02d&quot;, ($x = ' .
+		calculer_liste($mois2, array(), $boucles, $parent) .
+		') ? $x : date(&quot;m&quot;))';
+
+	$jour2 =  $params ? array_shift($params) : &quot;&quot;;
+	$jour2 = &quot;\n&quot; .  'sprintf(&quot;%02d&quot;, ($x = ' .
+		calculer_liste($jour2, array(), $boucles, $parent) .
+		') ? $x : date(&quot;d&quot;))';
 
 	$boucle = &amp;$boucles[$idb];
 	$date = $boucle-&gt;id_table . &quot;.$date&quot;;
 	if ($type == 'jour')
 	  $boucle-&gt;where[] =  &quot;DATE_FORMAT($date, '%Y%m%d') = '\&quot; .  $annee . $mois . $jour .\&quot;'&quot;;
-	elseif ($type != 'semaine')
+	elseif ($type == 'mois')
 	  $boucle-&gt;where[] =  &quot;DATE_FORMAT($date, '%Y%m') = '\&quot; .  $annee . $mois .\&quot;'&quot;;
-	else
+	elseif ($type == 'semaine')
 	  $boucle-&gt;where[] = 
 	  &quot;DATE_FORMAT($date, '%Y%m%d') &gt;= '\&quot; . 
 		date_debut_semaine($annee, $mois, $jour) . \&quot;' AND
 	  DATE_FORMAT($date, '%Y%m%d') &lt;= '\&quot; .
 		date_fin_semaine($annee, $mois, $jour) . \&quot;'&quot;;
+	elseif (count($crit-&gt;param) &gt; 2) 
+	  $boucle-&gt;where[] = 
+	  &quot;DATE_FORMAT($date, '%Y%m%d') &gt;= '\&quot; . $annee . $mois . $jour .\&quot;' AND
+	  DATE_FORMAT($date, '%Y%m%d') &lt;= '\&quot; . $annee2 . $mois2 . $jour2 .\&quot;'&quot;;
+	// sinon on prend tout
 }
 
 
@@ -379,7 +414,7 @@
 
 function calculer_critere_DEFAUT($idb, &amp;$boucles, $crit) {
 	
-	global $table_date, $tables_des_serveurs_sql;
+	global $table_date, $table_des_tables;
 	global $tables_relations;
 
 	$boucle = &amp;$boucles[$idb];
@@ -418,6 +453,7 @@
 	    $op = $crit-&gt;op;
 
 	    $col = array_shift($params);
+
 	    $col = $col[0]-&gt;texte;
 	    // fonction SQL ?
 	    if (ereg(&quot;([A-Za-z_]+)\(([a-z_]+)\)&quot;, $col,$match3)) {
@@ -446,7 +482,7 @@
 		$col_table = $ext_table . 
 		  calculer_critere_externe($boucle, $id_field, $ext_table, $type, $col);
 	// Cas particulier pour les raccourcis 'type_mot' et 'titre_mot'
-	elseif ($type != 'mots'
+	elseif ($type != 'mots' AND $table_des_tables[$type]
 			AND ($col == 'type_mot' OR $col == 'titre_mot'
 			OR $col == 'id_groupe')) {
 		if ($type == 'forums')
@@ -568,16 +604,16 @@
 
 	//	if (($op != '=') || !calculer_critere_repete($boucle, $ct, $val[0])) # a revoir
 	if (strtoupper($op) == 'IN') {
-	      $val = join(&quot; .\n\&quot;','\&quot; . &quot;, $val);
 	  
-	      $where = &quot;$ct IN ('\&quot; . $val . \&quot;')&quot;;
+	      $where = &quot;$ct IN ('\&quot; . &quot; . join(&quot; .\n\&quot;','\&quot; . &quot;, $val) . &quot; . \&quot;')&quot;;
 	      if ($crit-&gt;not) {
 		$where = &quot;NOT ($where)&quot;;
 	      } else {
 			$boucle-&gt;default_order = array('rang');
-			$boucle-&gt;select[]= &quot;FIND_IN_SET($ct, \\\&quot;'\&quot; . &quot; . $val . ' . &quot;\'\\&quot;) AS rang';
+			$boucle-&gt;select[]= &quot;FIND_IN_SET($ct, '\&quot; . &quot; . 
+			  join(&quot; .\n\&quot;,\&quot; . &quot;, $val) . ' . &quot;\') AS rang';
 	      }
-	    } else {
+	} else {
 		  if ($op == '==') $op = 'REGEXP';
 		  $where = &quot;($ct $op '\&quot; . &quot; . $val[0] . ' . &quot;\')';
 		  if ($crit-&gt;not) $where = &quot;NOT $where&quot;;

Index: page.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/page.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- page.php3	30 Jun 2005 10:09:36 -0000	1.1
+++ page.php3	10 Aug 2005 12:00:39 -0000	1.2
@@ -13,17 +13,17 @@
 if (isset($contexte_inclus['delais']))
 	$delais = $contexte_inclus['delais'];
 
-// Securite : le squelette *doit* exister dans squelettes/
-if (strstr($fond, '..')) {
+// Securite 
+if (strstr($fond, '/')) {
 	die (&quot;Faut pas se gener&quot;);
 }
 if (!function_exists('find_in_path')) {
 	include ('ecrire/inc_version.php3');
 }
-if (preg_match(',^(squelettes/|dist/404),', $a = find_in_path(&quot;$fond.html&quot;))) {
+if (find_in_path(&quot;$fond.html&quot;)) {
 	include (&quot;inc-public.php3&quot;);
 } else {
-	spip_log(&quot;page.php3: le squelette $fond.html ($a) *doit* se trouver dans squelettes/&quot;);
+	spip_log(&quot;page.php3: find_in_path ne trouve pas le squelette $fond&quot;);
 }
 
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000215.html">[Spip-carto-cvs] spipcarto/ecrire inc_rss.php3,1.1,1.2 naviguer.php3,1.4,1.5 inc_charsets.php3,1.5,1.6 js_menu_rubriques.php,1.4,1.5 inc_majbase.php3,1.5,1.6 inc_calendrier.php,1.8,1.9 message.php3,1.6,1.7 inc_texte.php3,1.8,1.9 inc_debug_sql.php3,1.6,1.7 inc_sites.php3,1.6,1.7 inc_documents.php3,1.6,1.7 index.php3,1.7,1.8 mots_tous.php3,1.3,1.4 calendrier.css,1.4,1.5 inc_filtres.php3,1.7,1.8 import_all.php3,1.2,1.3 inc_version.php3,1.9,1.10 articles.php3,1.6,1.7 inc_lang.php3,1.7,1.8 inc_presentation.php3,1.9,1.10 upgrade.php3,1.3,1.4 sites.php3,1.4,1.5
</A></li>
	<LI>Next message: <A HREF="000217.html">[Spip-carto-cvs] spipcarto/ecrire mes_options.php3,1.6,1.7 inc_carto.php3,1.14,1.15
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#214">[ date ]</a>
              <a href="thread.html#214">[ thread ]</a>
              <a href="subject.html#214">[ subject ]</a>
              <a href="author.html#214">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
