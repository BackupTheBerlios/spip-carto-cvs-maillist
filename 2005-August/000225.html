<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto inc-html-squel.php3,1.7,1.8 inc-urls-standard.php3,1.4,1.5 inc-criteres.php3,1.7,1.8 page.php3,1.2,1.3 inc-compilo.php3,1.7,1.8
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-August/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20inc-html-squel.php3%2C1.7%2C1.8%20inc-urls-standard.php3%2C1.4%2C1.5%20inc-criteres.php3%2C1.7%2C1.8%20page.php3%2C1.2%2C1.3%20inc-compilo.php3%2C1.7%2C1.8&In-Reply-To=%3C200508182328.j7INSaXe023401%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000224.html">
   <LINK REL="Next"  HREF="000226.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto inc-html-squel.php3,1.7,1.8 inc-urls-standard.php3,1.4,1.5 inc-criteres.php3,1.7,1.8 page.php3,1.2,1.3 inc-compilo.php3,1.7,1.8</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto%20inc-html-squel.php3%2C1.7%2C1.8%20inc-urls-standard.php3%2C1.4%2C1.5%20inc-criteres.php3%2C1.7%2C1.8%20page.php3%2C1.2%2C1.3%20inc-compilo.php3%2C1.7%2C1.8&In-Reply-To=%3C200508182328.j7INSaXe023401%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto inc-html-squel.php3,1.7,1.8 inc-urls-standard.php3,1.4,1.5 inc-criteres.php3,1.7,1.8 page.php3,1.2,1.3 inc-compilo.php3,1.7,1.8">stef at berlios.de
       </A><BR>
    <I>Fri Aug 19 01:28:36 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000224.html">[Spip-carto-cvs] spipcarto/ecrire/lang spip_de.php3,1.4,1.5 spip_ja.php3,1.3,1.4 spip_pt.php3,1.4,1.5 ecrire_ja.php3,1.3,1.4 ecrire_cpf_hat.php3,1.2,1.3 ecrire_pt.php3,1.4,1.5 spip_cpf_hat.php3,1.2,1.3 spip_lb.php3,1.5,1.6 spip_pt_br.php3,1.3,1.4 ecrire_oc_ni_la.php3,1.1,1.2 spip_da.php3,1.3,1.4 ecrire_nl.php3,1.4,1.5 spip_fr.php3,1.5,1.6 spip_oc_ni_la.php3,1.1,1.2
</A></li>
        <LI>Next message: <A HREF="000226.html">[Spip-carto-cvs] spipcarto/ecrire inc_flock.php3,1.3,1.4 inc_version.php3,1.10,1.11 inc_lang.php3,1.8,1.9 calendrier.css,1.5,1.6 inc_filtres.php3,1.8,1.9 spip_style.php3,1.7,1.8 message.php3,1.7,1.8 inc_calendrier.php,1.9,1.10 inc_texte.php3,1.9,1.10 inc_presentation.php3,1.10,1.11 inc_debug_sql.php3,1.7,1.8
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#225">[ date ]</a>
              <a href="thread.html#225">[ thread ]</a>
              <a href="subject.html#225">[ subject ]</a>
              <a href="author.html#225">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto
In directory sheep:/tmp/cvs-serv22361

Modified Files:
	inc-html-squel.php3 inc-urls-standard.php3 inc-criteres.php3 
	page.php3 inc-compilo.php3 
Log Message:
Mise a jour 1.8.2 pr3 (CVS 18/08)

Index: inc-html-squel.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-html-squel.php3,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- inc-html-squel.php3	21 Jul 2005 21:47:12 -0000	1.7
+++ inc-html-squel.php3	18 Aug 2005 23:28:34 -0000	1.8
@@ -184,15 +184,18 @@
   while (($texte!==&quot;&quot;) &amp;&amp; strpos($fin, $texte[0]) === false) {
       preg_match(&quot;,^(\|?[^{)|]*)(.*)$,ms&quot;, $texte, $match);
       $suite = ltrim($match[2]);
-      $fonc = $match[1];
-      if ($fonc[0] == &quot;|&quot;) $fonc = substr($fonc,1);
-      $res = array(trim($fonc));
-      $args = $suite;
-      if ($suite[0] != '{')
-	{ if (!$match[1]) {
+      $fonc = trim($match[1]);
+      if ($fonc[0] == &quot;|&quot;) $fonc = ltrim(substr($fonc,1));
+      $res = array($fonc);
+      $args = $suite ;
+      // cas du filtre sans argument ou du critere /
+      if (($suite[0] != '{')  || ($fonc  &amp;&amp; $fonc[0] == '/'))
+	{ 
+	  // si pas d'argument, alors il faut une fonction ou un double |
+	  if (!$match[1])
 	    erreur_squelette(_T('zbug_info_erreur_squelette'), $texte);
-	    break;
-	  }
+	  // pas d'arg et pas d'autres filtres ==&gt; critere infixe comme &quot;/&quot;
+          if ((!$suite) || strpos(&quot;)|&quot;, $suite[0]) === false) break;
 	} else {
 	$args = ltrim(substr($suite,1)); 
 	$collecte = array();
@@ -210,7 +213,6 @@
 		      exit;
 		      }   
 		}
-
 		$arg = $regs[2];
 		if (trim($regs[1])) {
 			$champ = new Texte;
@@ -330,34 +332,46 @@
 
 	$args = array();
 	$type = $result-&gt;type_requete;
+
 	foreach($params as $v) {
 		$var = $v[1][0];
 		$param = ($var-&gt;type != 'texte') ? &quot;&quot; : $var-&gt;texte;
 		if ((count($v) &gt; 2) &amp;&amp; (!eregi(&quot;[^A-Za-z]IN[^A-Za-z]&quot;,$param)))
 		  {
-// plus d'un argument:
-// c'est soit le critere LIMIT debut,fin si &#231;a se termine par un chiffre
-// soit le critere PAR soit un critere perso
+// plus d'un argument et pas le critere IN:
+// detecter comme on peut si c'est le critere implicite LIMIT debut, fin
 
 			if (($var-&gt;type != 'texte') ||
-			    (strpos(&quot;0123456789&quot;, $param[strlen($param)-1])
-			     !== false))
+			    (strpos(&quot;0123456789-&quot;, $param[strlen($param)-1])
+			     !== false)) {
 			  $op = ',';
-			else {
-			  preg_match(&quot;/^([a-zA-Z][a-zA-Z0-9]*)[[:space:]]*(.*)$/ms&quot;, $param, $m);
-			  $op = $m[1];
-			  if ($m[2]) $v[1][0]-&gt;texte = $m[2]; else array_shift($v[1]);
+			  $not = &quot;&quot;;
+			} else {
+			  preg_match(&quot;/^([!]?)([a-zA-Z][a-zA-Z0-9]*)[[:space:]]*(.*)$/ms&quot;, $param, $m);
+			  $op = $m[2];
+			  $not = $m[1];
+			  if ($m[3]) $v[1][0]-&gt;texte = $m[3]; else array_shift($v[1]);
 			}
 			array_shift($v);
 			$crit = new Critere;
 			$crit-&gt;op = $op;
-			$crit-&gt;not = &quot;&quot;;
+			$crit-&gt;not = $not;
 			$crit-&gt;param = $v;
 			$args[] = $crit;
 		  } else {
-		  if ($var-&gt;type != 'texte')
-			  erreur_squelette('criteres','');
-		  else {
+		  if ($var-&gt;type != 'texte') {
+		    // cas 1 seul arg ne commencant pas par du texte brut: 
+		    // erreur ou critere infixe &quot;/&quot;
+		    if (($v[1][1]-&gt;type != 'texte') || (trim($v[1][1]-&gt;texte) !='/'))
+		      erreur_squelette('criteres',$var-&gt;nom_champ);
+		    else {
+		      $crit = new Critere;
+		      $crit-&gt;op = '/';
+		      $crit-&gt;not = &quot;&quot;;
+		      $crit-&gt;param = array(array($v[1][0]),array($v[1][2]));
+		      $args[] = $crit;
+		    }
+		  } else {
 	// traiter qq lexemes particuliers pour faciliter la suite
 
 	// les separateurs
@@ -390,7 +404,7 @@
 			  elseif ($param == 'recherche')
 			    // meme chose (a cause de #nom_de_boucle:URL_*)
 			      $result-&gt;hash = true;
-			  if (ereg('^([0-9-]+)(/)([0-9-]+)$', $param, $m)) {
+			  if (ereg('^ *([0-9-]+) *(/) *(.+) *$', $param, $m)) {
 			    $crit = phraser_critere_infixe($m[1], $m[3],$v, '/', '', '');
 			  } elseif (ereg('^(`?[A-Za-z_][A-Za-z_0-9]*\(?[A-Za-z_]*\)?`?)[[:space:]]*(\??)(!?)(&lt;=?|&gt;=?|==?|IN)[[:space:]]*&quot;?([^&lt;&gt;=!&quot;]*)&quot;?$', $param, $m)) {
 			    $crit = phraser_critere_infixe($m[1], $m[5],$v,
@@ -411,7 +425,7 @@
 			    $crit-&gt;not = $m[1];
 			    $crit-&gt;cond = $m[3];
 			  }
-			  else {spip_log(&quot;pb $param&quot;);
+			  else {
 			    erreur_squelette(_T('zbug_critere_inconnu',
 						array('critere' =&gt; $param)));
 			  }

Index: inc-urls-standard.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-urls-standard.php3,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -d -r1.4 -r1.5
--- inc-urls-standard.php3	30 Jun 2005 10:09:36 -0000	1.4
+++ inc-urls-standard.php3	18 Aug 2005 23:28:34 -0000	1.5
@@ -86,4 +86,4 @@
 	return generer_url_forum_dist($id_forum, $show_thread);
 }
 
-?&gt;
+?&gt;
\ No newline at end of file

Index: inc-criteres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-criteres.php3,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- inc-criteres.php3	10 Aug 2005 12:00:39 -0000	1.7
+++ inc-criteres.php3	18 Aug 2005 23:28:34 -0000	1.8
@@ -370,14 +370,20 @@
 }
 
 function calculer_critere_parties_aux($idb, &amp;$boucles, $param) {
-	if ($param[0]-&gt;type == 'texte')
+	if ($param[0]-&gt;type != 'texte')
 	  {
-	    ereg('^(([0-9]+)|n)(-([0-9]+))?$', $param[0]-&gt;texte, $m);
-	    return array($m[1], ($m[4] ? $m[4] : 0));
-	  } else {
 	  $a1 = calculer_liste(array($param[0]), array(), $boucles[$idb]-&gt;id_parent, $boucles);
-	  ereg('^ *(-([0-9]+))?$', $param[1]-&gt;texte, $m);
+	  ereg('^ *(-([0-9]+))? *$', $param[1]-&gt;texte, $m);
 	  return array(&quot;intval($a1)&quot;, ($m[2] ? $m[2] : 0));
+	  } else {
+	    ereg('^ *(([0-9]+)|n) *(- *([0-9]+)? *)?$', $param[0]-&gt;texte, $m);
+	    $a1 = $m[1];
+	    if (!$m[3])
+	      return array($a1, 0);
+	    elseif ($m[4])
+	      return array($a1, $m[4]);
+	    else return array($a1, 
+			      calculer_liste(array($param[1]), array(), $boucles[$idb]-&gt;id_parent, $boucles));
 	}
 }
 
@@ -453,7 +459,6 @@
 	    $op = $crit-&gt;op;
 
 	    $col = array_shift($params);
-
 	    $col = $col[0]-&gt;texte;
 	    // fonction SQL ?
 	    if (ereg(&quot;([A-Za-z_]+)\(([a-z_]+)\)&quot;, $col,$match3)) {
@@ -624,7 +629,6 @@
 		    $where = &quot;\&quot;.($champ ? \&quot;$where\&quot; : 1).\&quot;&quot;;
 		  }
 	    }
-
 	$boucle-&gt;where[] = $where;
 }
 

Index: page.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/page.php3,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -d -r1.2 -r1.3
--- page.php3	10 Aug 2005 12:00:39 -0000	1.2
+++ page.php3	18 Aug 2005 23:28:34 -0000	1.3
@@ -1,5 +1,9 @@
 &lt;?php
 
+// Appel spip
+if (!function_exists('find_in_path')) {
+	include ('ecrire/inc_version.php3');
+}
 // Reglage du $fond
 if (isset($contexte_inclus['fond']))
 	$fond = $contexte_inclus['fond'];
@@ -17,14 +21,10 @@
 if (strstr($fond, '/')) {
 	die (&quot;Faut pas se gener&quot;);
 }
-if (!function_exists('find_in_path')) {
-	include ('ecrire/inc_version.php3');
-}
-if (find_in_path(&quot;$fond.html&quot;)) {
-	include (&quot;inc-public.php3&quot;);
-} else {
+if (!find_in_path(&quot;$fond.html&quot;)) {
 	spip_log(&quot;page.php3: find_in_path ne trouve pas le squelette $fond&quot;);
+	$fond = '404';
 }
-
+include (&quot;inc-public.php3&quot;);
 
 ?&gt;

Index: inc-compilo.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/inc-compilo.php3,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -d -r1.7 -r1.8
--- inc-compilo.php3	21 Jul 2005 21:47:12 -0000	1.7
+++ inc-compilo.php3	18 Aug 2005 23:28:34 -0000	1.8
@@ -308,37 +308,43 @@
 
 	// {1/3}
 	if ($op1 == '/') {
+		$pmoins1 = is_numeric($partie) ? ($partie-1) : &quot;($partie-1)&quot;;
+		$totpos = is_numeric($total_parties) ? ($total_parties) :
+		  &quot;($total_parties ? $total_parties : 1)&quot;;
 		$retour .= &quot;\n	&quot;
-			.'$debut_boucle = ceil(($nombre_boucle * '
-			. ($partie - 1) . ')/' . $total_parties . &quot;);\n	&quot;
-			. '$fin_boucle = ceil (($nombre_boucle * '
-			. $partie . ')/' . $total_parties . &quot;) - 1;&quot;;
+		  .'$debut_boucle = ceil(($nombre_boucle * '
+		  . $pmoins1 . ')/' . $totpos . &quot;);&quot;;
+		$fin = 'ceil (($nombre_boucle * '
+			. $partie . ')/' . $totpos . &quot;) - 1&quot;;
 	}
 
 	// {1,x}
-	if ($op1 == '+') {
+	elseif ($op1 == '+') {
 		$retour .= &quot;\n	&quot;
 			. '$debut_boucle = ' . $partie . ';';
 	}
 	// {n-1,x}
-	if ($op1 == '-') {
+	elseif ($op1 == '-') {
 		$retour .= &quot;\n	&quot;
 			. '$debut_boucle = $nombre_boucle - ' . $partie . ';';
 	}
 	// {x,1}
 	if ($op2 == '+') {
-		$retour .= &quot;\n	&quot;
-			. '$fin_boucle = $debut_boucle + ' . $total_parties . ' - 1;';
+		$fin = '$debut_boucle'
+		  . (is_numeric($total_parties) ?
+		     (($total_parties==1) ? &quot;&quot; :(' + ' . ($total_parties-1))):
+		     ('+' . $total_parties . ' - 1'));
 	}
 	// {x,n-1}
-	if ($op2 == '-') {
-		$retour .= &quot;\n	&quot;
-			.'$fin_boucle = $debut_boucle + $nombre_boucle - '.$total_parties.' - 1;';
+	elseif ($op2 == '-') {
+		$fin = '$debut_boucle + $nombre_boucle - '
+		  . (is_numeric($total_parties) ? ($total_parties+1) :
+		     ($total_parties . ' - 1'));
 	}
 
 	// Rabattre $fin_boucle sur le maximum
 	$retour .= &quot;\n	&quot;
-		.'$fin_boucle = min($fin_boucle, $nombre_boucle - 1);';
+		.'$fin_boucle = min(' . $fin . ', $nombre_boucle - 1);';
 
 	// calcul du total boucle final
 	$retour .= &quot;\n	&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000224.html">[Spip-carto-cvs] spipcarto/ecrire/lang spip_de.php3,1.4,1.5 spip_ja.php3,1.3,1.4 spip_pt.php3,1.4,1.5 ecrire_ja.php3,1.3,1.4 ecrire_cpf_hat.php3,1.2,1.3 ecrire_pt.php3,1.4,1.5 spip_cpf_hat.php3,1.2,1.3 spip_lb.php3,1.5,1.6 spip_pt_br.php3,1.3,1.4 ecrire_oc_ni_la.php3,1.1,1.2 spip_da.php3,1.3,1.4 ecrire_nl.php3,1.4,1.5 spip_fr.php3,1.5,1.6 spip_oc_ni_la.php3,1.1,1.2
</A></li>
	<LI>Next message: <A HREF="000226.html">[Spip-carto-cvs] spipcarto/ecrire inc_flock.php3,1.3,1.4 inc_version.php3,1.10,1.11 inc_lang.php3,1.8,1.9 calendrier.css,1.5,1.6 inc_filtres.php3,1.8,1.9 spip_style.php3,1.7,1.8 message.php3,1.7,1.8 inc_calendrier.php,1.9,1.10 inc_texte.php3,1.9,1.10 inc_presentation.php3,1.10,1.11 inc_debug_sql.php3,1.7,1.8
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#225">[ date ]</a>
              <a href="thread.html#225">[ thread ]</a>
              <a href="subject.html#225">[ subject ]</a>
              <a href="author.html#225">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
