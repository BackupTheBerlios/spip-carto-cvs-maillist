<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spip-carto/ecrire inc_abstract_sql.php3,NONE,1.1 inc_export.php3,NONE,1.1 inc_acces.php3,NONE,1.1 config-multilang.php3,NONE,1.1 inc_charsets.php3,NONE,1.1 articles_versions.php3,NONE,1.1 inc_getdocument.php3,NONE,1.1 .cvsignore,NONE,1.1 inc_mots.php3,NONE,1.1 md5.js,NONE,1.1 message_edit.php3,NONE,1.1 inc_mail.php3,NONE,1.1 inc_presentation.php3,NONE,1.1 inc_urls.php3,NONE,1.1 statistiques_visites.php3,NONE,1.1 export.php3,NONE,1.1 forum_admin.php3,NONE,1.1 inc_auth_spip.php3,NONE,1.1 inc_sites.php3,NONE,1.1 licence_fr.html,NONE,1.1 inc_serialbase.php3,NONE,1.1 auteurs_edit.php3,NONE,1.1 cartes.php3,NONE,1.1 aide_index.php3,NONE,1.1 inc_majbase.php3,NONE,1.1 inc_import.php3,NONE,1.1 articles_forum.php3,NONE,1.1 install.php3,NONE,1.1 suivi_revisions.php3,NONE,1.1 inc_db_mysql.php3,NONE,1.1 mots_edit.php3,NONE,1.1 pclzip.lib.php,NONE,1.1 spip_style_invisible.css,NONE,1.1 auteur_infos.php3,NONE,1.1 inc_suivi_revisions.php,NONE,1.1 articles_page.php3,NONE,1.1 inc_debug! _sql.php3,NONE,1.1 optimiser.php3,NONE,1.1 calendrier.php3,NONE,1.1 inc_carto.php3,NONE,1.1 spip_style_print.css,NONE,1.1 forum.php3,NONE,1.1 statistiques_svg.php3,NONE,1.1 js_menu_rubriques.php,NONE,1.1 admin_repair.php3,NONE,1.1 gnu_lgpl_fr.txt,NONE,1.1 inc_meta.php3,NONE,1.1 messagerie.php3,NONE,1.1 sites.php3,NONE,1.1 breves.php3,NONE,1.1 calendrier_jour.php3,NONE,1.1 recherche.php3,NONE,1.1 http.class.php,NONE,1.1 index.php3,NONE,1.1 lab_ortho.php,NONE,1.1 config-lang.php3,NONE,1.1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-January/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spip-carto/ecrire%20inc_abstract_sql.php3%2CNONE%2C1.1%20inc_export.php3%2CNONE%2C1.1%20inc_acces.php3%2CNONE%2C1.1%20config-multilang.php3%2CNONE%2C1.1%20inc_charsets.php3%2CNONE%2C1.1%20articles_versions.php3%2CNONE%2C1.1%20inc_getdocument.php3%2CNONE%2C1.1%20.cvsignore%2CNONE%2C1.1%20inc_mots.php3%2CNONE%2C1.1%20md5.js%2CNONE%2C1.1%20message_edit.php3%2CNONE%2C1.1%20inc_mail.php3%2CNONE%2C1.1%20inc_presentation.php3%2CNONE%2C1.1%20inc_urls.php3%2CNONE%2C1.1%20statistiques_visites.php3%2CNONE%2C1.1%20export.php3%2CNONE%2C1.1%20forum_admin.php3%2CNONE%2C1.1%20inc_auth_spip.php3%2CNONE%2C1.1%20inc_sites.php3%2CNONE%2C1.1%20licence_fr.html%2CNONE%2C1.1%20inc_serialbase.php3%2CNONE%2C1.1%20auteurs_edit.php3%2CNONE%2C1.1%20cartes.php3%2CNONE%2C1.1%20aide_index.php3%2CNONE%2C1.1%20inc_majbase.php3%2CNONE%2C1.1%20inc_import.php3%2CNONE%2C1.1%20articles_forum.php3%2CNONE%2C1.1%20install.php3%2CNONE%2C1.1%20suivi_revisions.php3%2CNONE%2C1.1%20inc_db_mysql.php3%2CNONE%2C1.1%20mots_edit.php3%2CNONE%2C1.1%20pclzip.lib.php%2CNONE%2C1.1%20spip_style_invisible.css%2CNONE%2C1.1%20auteur_infos.php3%2CNONE%2C1.1%20inc_suivi_revisions.php%2CNONE%2C1.1%20articles_page.php3%2CNONE%2C1.1%20inc_debug%21%0A%20_sql.php3%2CNONE%2C1.1%20optimiser.php3%2CNONE%2C1.1%20calendrier.php3%2CNONE%2C1.1%20inc_carto.php3%2CNONE%2C1.1%20spip_style_print.css%2CNONE%2C1.1%20forum.php3%2CNONE%2C1.1%20statistiques_svg.php3%2CNONE%2C1.1%20js_menu_rubriques.php%2CNONE%2C1.1%20admin_repair.php3%2CNONE%2C1.1%20gnu_lgpl_fr.txt%2CNONE%2C1.1%20inc_meta.php3%2CNONE%2C1.1%20messagerie.php3%2CNONE%2C1.1%20sites.php3%2CNONE%2C1.1%20breves.php3%2CNONE%2C1.1%20calendrier_jour.php3%2CNONE%2C1.1%20recherche.php3%2CNONE%2C1.1%20http.class.php%2CNONE%2C1.1%20index.php3%2CNONE%2C1.1%20lab_ortho.php%2CNONE%2C1.1%20config-lang.php3%2CNONE%2C1.1&In-Reply-To=%3C200501131616.j0DGGONM022509%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000041.html">
   <LINK REL="Next"  HREF="000043.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spip-carto/ecrire inc_abstract_sql.php3,NONE,1.1 inc_export.php3,NONE,1.1 inc_acces.php3,NONE,1.1 config-multilang.php3,NONE,1.1 inc_charsets.php3,NONE,1.1 articles_versions.php3,NONE,1.1 inc_getdocument.php3,NONE,1.1 .cvsignore,NONE,1.1 inc_mots.php3,NONE,1.1 md5.js,NONE,1.1 message_edit.php3,NONE,1.1 inc_mail.php3,NONE,1.1 inc_presentation.php3,NONE,1.1 inc_urls.php3,NONE,1.1 statistiques_visites.php3,NONE,1.1 export.php3,NONE,1.1 forum_admin.php3,NONE,1.1 inc_auth_spip.php3,NONE,1.1 inc_sites.php3,NONE,1.1 licence_fr.html,NONE,1.1 inc_serialbase.php3,NONE,1.1 auteurs_edit.php3,NONE,1.1 cartes.php3,NONE,1.1 aide_index.php3,NONE,1.1 inc_majbase.php3,NONE,1.1 inc_import.php3,NONE,1.1 articles_forum.php3,NONE,1.1 install.php3,NONE,1.1 suivi_revisions.php3,NONE,1.1 inc_db_mysql.php3,NONE,1.1 mots_edit.php3,NONE,1.1 pclzip.lib.php,NONE,1.1 spip_style_invisible.css,NONE,1.1 auteur_infos.php3,NONE,1.1 inc_suivi_revisions.php,NONE,1.1 articles_page.php3,NONE,1.1 inc_debug! _sql.php3,NONE,1.1 optimiser.php3,NONE,1.1 calendrier.php3,NONE,1.1 inc_carto.php3,NONE,1.1 spip_style_print.css,NONE,1.1 forum.php3,NONE,1.1 statistiques_svg.php3,NONE,1.1 js_menu_rubriques.php,NONE,1.1 admin_repair.php3,NONE,1.1 gnu_lgpl_fr.txt,NONE,1.1 inc_meta.php3,NONE,1.1 messagerie.php3,NONE,1.1 sites.php3,NONE,1.1 breves.php3,NONE,1.1 calendrier_jour.php3,NONE,1.1 recherche.php3,NONE,1.1 http.class.php,NONE,1.1 index.php3,NONE,1.1 lab_ortho.php,NONE,1.1 config-lang.php3,NONE,1.1</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spip-carto/ecrire%20inc_abstract_sql.php3%2CNONE%2C1.1%20inc_export.php3%2CNONE%2C1.1%20inc_acces.php3%2CNONE%2C1.1%20config-multilang.php3%2CNONE%2C1.1%20inc_charsets.php3%2CNONE%2C1.1%20articles_versions.php3%2CNONE%2C1.1%20inc_getdocument.php3%2CNONE%2C1.1%20.cvsignore%2CNONE%2C1.1%20inc_mots.php3%2CNONE%2C1.1%20md5.js%2CNONE%2C1.1%20message_edit.php3%2CNONE%2C1.1%20inc_mail.php3%2CNONE%2C1.1%20inc_presentation.php3%2CNONE%2C1.1%20inc_urls.php3%2CNONE%2C1.1%20statistiques_visites.php3%2CNONE%2C1.1%20export.php3%2CNONE%2C1.1%20forum_admin.php3%2CNONE%2C1.1%20inc_auth_spip.php3%2CNONE%2C1.1%20inc_sites.php3%2CNONE%2C1.1%20licence_fr.html%2CNONE%2C1.1%20inc_serialbase.php3%2CNONE%2C1.1%20auteurs_edit.php3%2CNONE%2C1.1%20cartes.php3%2CNONE%2C1.1%20aide_index.php3%2CNONE%2C1.1%20inc_majbase.php3%2CNONE%2C1.1%20inc_import.php3%2CNONE%2C1.1%20articles_forum.php3%2CNONE%2C1.1%20install.php3%2CNONE%2C1.1%20suivi_revisions.php3%2CNONE%2C1.1%20inc_db_mysql.php3%2CNONE%2C1.1%20mots_edit.php3%2CNONE%2C1.1%20pclzip.lib.php%2CNONE%2C1.1%20spip_style_invisible.css%2CNONE%2C1.1%20auteur_infos.php3%2CNONE%2C1.1%20inc_suivi_revisions.php%2CNONE%2C1.1%20articles_page.php3%2CNONE%2C1.1%20inc_debug%21%0A%20_sql.php3%2CNONE%2C1.1%20optimiser.php3%2CNONE%2C1.1%20calendrier.php3%2CNONE%2C1.1%20inc_carto.php3%2CNONE%2C1.1%20spip_style_print.css%2CNONE%2C1.1%20forum.php3%2CNONE%2C1.1%20statistiques_svg.php3%2CNONE%2C1.1%20js_menu_rubriques.php%2CNONE%2C1.1%20admin_repair.php3%2CNONE%2C1.1%20gnu_lgpl_fr.txt%2CNONE%2C1.1%20inc_meta.php3%2CNONE%2C1.1%20messagerie.php3%2CNONE%2C1.1%20sites.php3%2CNONE%2C1.1%20breves.php3%2CNONE%2C1.1%20calendrier_jour.php3%2CNONE%2C1.1%20recherche.php3%2CNONE%2C1.1%20http.class.php%2CNONE%2C1.1%20index.php3%2CNONE%2C1.1%20lab_ortho.php%2CNONE%2C1.1%20config-lang.php3%2CNONE%2C1.1&In-Reply-To=%3C200501131616.j0DGGONM022509%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spip-carto/ecrire inc_abstract_sql.php3,NONE,1.1 inc_export.php3,NONE,1.1 inc_acces.php3,NONE,1.1 config-multilang.php3,NONE,1.1 inc_charsets.php3,NONE,1.1 articles_versions.php3,NONE,1.1 inc_getdocument.php3,NONE,1.1 .cvsignore,NONE,1.1 inc_mots.php3,NONE,1.1 md5.js,NONE,1.1 message_edit.php3,NONE,1.1 inc_mail.php3,NONE,1.1 inc_presentation.php3,NONE,1.1 inc_urls.php3,NONE,1.1 statistiques_visites.php3,NONE,1.1 export.php3,NONE,1.1 forum_admin.php3,NONE,1.1 inc_auth_spip.php3,NONE,1.1 inc_sites.php3,NONE,1.1 licence_fr.html,NONE,1.1 inc_serialbase.php3,NONE,1.1 auteurs_edit.php3,NONE,1.1 cartes.php3,NONE,1.1 aide_index.php3,NONE,1.1 inc_majbase.php3,NONE,1.1 inc_import.php3,NONE,1.1 articles_forum.php3,NONE,1.1 install.php3,NONE,1.1 suivi_revisions.php3,NONE,1.1 inc_db_mysql.php3,NONE,1.1 mots_edit.php3,NONE,1.1 pclzip.lib.php,NONE,1.1 spip_style_invisible.css,NONE,1.1 auteur_infos.php3,NONE,1.1 inc_suivi_revisions.php,NONE,1.1 articles_page.php3,NONE,1.1 inc_debug! _sql.php3,NONE,1.1 optimiser.php3,NONE,1.1 calendrier.php3,NONE,1.1 inc_carto.php3,NONE,1.1 spip_style_print.css,NONE,1.1 forum.php3,NONE,1.1 statistiques_svg.php3,NONE,1.1 js_menu_rubriques.php,NONE,1.1 admin_repair.php3,NONE,1.1 gnu_lgpl_fr.txt,NONE,1.1 inc_meta.php3,NONE,1.1 messagerie.php3,NONE,1.1 sites.php3,NONE,1.1 breves.php3,NONE,1.1 calendrier_jour.php3,NONE,1.1 recherche.php3,NONE,1.1 http.class.php,NONE,1.1 index.php3,NONE,1.1 lab_ortho.php,NONE,1.1 config-lang.php3,NONE,1.1">stef at berlios.de
       </A><BR>
    <I>Thu Jan 13 17:16:24 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000041.html">[Spip-carto-cvs] spip-carto/IMG/icones defaut-dist.png,NONE,1.1 avi-dist.png,NONE,1.1 pdf-dist.png,NONE,1.1 dvi-dist.png,NONE,1.1 qt-dist.png,NONE,1.1 ra-dist.png,NONE,1.1 rm-dist.png,NONE,1.1 rpm-dist.png,NONE,1.1 ram-dist.png,NONE,1.1 sit-dist.png,NONE,1.1 html-dist.png,NONE,1.1 psd-dist.png,NONE,1.1 mpg-dist.png,NONE,1.1 sxi-dist.png,NONE,1.1 sdd-dist.png,NONE,1.1 mid-dist.png,NONE,1.1 deb-dist.png,NONE,1.1 ai-dist.png,NONE,1.1 sxw-dist.png,NONE,1.1 png-dist.png,NONE,1.1 tgz-dist.png,NONE,1.1 sdw-dist.png,NONE,1.1 mov-dist.png,NONE,1.1 rtf-dist.png,NONE,1.1 bz2-dist.png,NONE,1.1 ogg-dist.png,NONE,1.1 sxc-dist.png,NONE,1.1 ps-dist.png,NONE,1.1 wav-dist.png,NONE,1.1 aiff-dist.png,NONE,1.1 asf-dist.png,NONE,1.1 xcf-dist.png,NONE,1.1 jpg-dist.png,NONE,1.1 mp3-dist.png,NONE,1.1 txt-dist.png,NONE,1.1 xml-dist.png,NONE,1.1 xls-dist.png,NONE,1.1 gif-dist.png,NONE,1.1 eps-dist.png,NONE,1.1 tex-dist.png,NONE,1.1 zip-dist.png,NONE,1.1 tif-dist.png,NONE,1.1 doc-dist.png,NONE,1.1 bmp-dist.png! ,NONE,1.1 ppt-dist.png,NONE,1.1 gz-dist.png,NONE,1.1
</A></li>
        <LI>Next message: <A HREF="000043.html">[Spip-carto-cvs] CVSROOT modules,1.4,1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42">[ date ]</a>
              <a href="thread.html#42">[ thread ]</a>
              <a href="subject.html#42">[ subject ]</a>
              <a href="author.html#42">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spip-carto/ecrire
In directory sheep:/tmp/cvs-serv22503/ecrire

Added Files:
	inc_abstract_sql.php3 inc_export.php3 inc_acces.php3 
	config-multilang.php3 inc_charsets.php3 articles_versions.php3 
	inc_getdocument.php3 .cvsignore inc_mots.php3 md5.js 
	message_edit.php3 inc_mail.php3 inc_presentation.php3 
	inc_urls.php3 statistiques_visites.php3 export.php3 
	forum_admin.php3 inc_auth_spip.php3 inc_sites.php3 
	licence_fr.html inc_serialbase.php3 auteurs_edit.php3 
	cartes.php3 aide_index.php3 inc_majbase.php3 inc_import.php3 
	articles_forum.php3 install.php3 suivi_revisions.php3 
	inc_db_mysql.php3 mots_edit.php3 pclzip.lib.php 
	spip_style_invisible.css auteur_infos.php3 
	inc_suivi_revisions.php articles_page.php3 inc_debug_sql.php3 
	optimiser.php3 calendrier.php3 inc_carto.php3 
	spip_style_print.css forum.php3 statistiques_svg.php3 
	js_menu_rubriques.php admin_repair.php3 gnu_lgpl_fr.txt 
	inc_meta.php3 messagerie.php3 sites.php3 breves.php3 
	calendrier_jour.php3 recherche.php3 http.class.php index.php3 
	lab_ortho.php config-lang.php3 
Log Message:
proto

--- NEW FILE: inc_abstract_sql.php3 ---
&lt;?php

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_ABSTRACT_SQL&quot;)) return;
define(&quot;_INC_ABSTRACT_SQL&quot;, &quot;1&quot;);

// Cette fonction est systematiquement appelee par les squelettes
// pour constuire une requete SQL de type &quot;lecture&quot; (SELECT) a partir
// de chaque boucle.
// Elle construit et exe'cute une reque^te SQL correspondant a` une balise
// Boucle ; elle notifie une erreur SQL dans le flux de sortie et termine
// le processus.
// Sinon, retourne la ressource interrogeable par spip_abstract_fetch.
// Recoit en argument:
// - le tableau des champs a` ramener
// - le tableau des tables a` consulter
// - le tableau des conditions a` remplir
// - le crite`re de regroupement
// - le crite`re de classement
// - le crite`re de limite
// - une sous-requete e'ventuelle (MySQL &gt; 4.1)
// - un compteur de sous-requete
// - le nom de la table
// - le nom de la boucle (pour le message d'erreur e'ventuel)
// - le serveur sollicite

function spip_abstract_select (
	$select = array(), $from = array(), $where = '',
	$groupby = '', $orderby = '', $limit = '',
	$sousrequete = '', $cpt = '',
	$table = '', $id = '', $serveur='') {

	if (!$serveur)
	  // le serveur par defaut est celui de inc_connect.php
	  // tout est deja pret, notamment la fonction suivante:
	  $f = 'spip_mysql_select';
	else {
	  // c'est un autre; est-il deja charge ?
		$f = 'spip_' . $serveur . '_select';
		if (!function_exists($f)) {
		  // non, il est decrit dans le fichier ad hoc
			$d = _DIR_RESTREINT . 'inc_connect-' . $serveur .'.php3';
			if (@file_exists($d)) include($d);
			$f = spip_abstract_serveur($f, $serveur);
		}
	}
	return $f($select, $from, $where,
		  $groupby, $orderby, $limit,
		  $sousrequete, $cpt,
		  $table, $id, $serveur);
}

function spip_abstract_serveur($f, $serveur) {
	if (function_exists($f))
		return $f;

	erreur_squelette(_L(' serveur SQL indefini'), $serveur);

	// hack pour continuer la chasse aux erreurs
	return 'array';
}

// Les 3 fonctions suivantes exploitent le resultat de la precedente,
// si l'include ne les a pas definies, erreur immediate

function spip_abstract_fetch($res, $serveur='')
{
  if (!$serveur) return spip_fetch_array($res);
  $f = spip_abstract_serveur('spip_' . $serveur . '_fetch', $serveur);
  return $f($res);
}

function spip_abstract_count($res, $serveur='')
{
  if (!$serveur) return spip_num_rows($res);
  $f = spip_abstract_serveur('spip_' . $serveur . '_count', $serveur);
  return $f($res);
}

function spip_abstract_free($res, $serveur='')
{
  if (!$serveur) return spip_free_result($res);
  $f = spip_abstract_serveur('spip_' . $serveur . '_free', $serveur);
  return $f($res);
}

function spip_abstract_insert($table, $noms, $valeurs, $serveur='')
{
  $f = (!$serveur ? 'spip_insert' :
	spip_abstract_serveur('spip_' . $serveur . '_insert', $serveur));
  return $f($table, $noms, $valeurs);
}

# une composition tellement frequente...
function spip_abstract_fetsel(
	$select = array(), $from = array(), $where = '',
	$groupby = '', $orderby = '', $limit = '',
	$sousrequete = '', $cpt = '',
	$table = '', $id = '', $serveur='') {
	return spip_abstract_fetch(spip_abstract_select(
$select, $from, $where,	$groupby, $orderby, $limit,
$sousrequete, $cpt, $table, $id, $serveur),
				   $serveur);
}
?&gt;

--- NEW FILE: inc_export.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_EXPORT&quot;)) return;
define(&quot;_ECRIRE_INC_EXPORT&quot;, &quot;1&quot;);



$GLOBALS['version_archive'] = '1.2';


// Conversion timestamp MySQL (format ascii) en Unix (format integer)
function mysql_timestamp_to_time($maj)
{
	$t_an = substr($maj, 0, 4);
	$t_mois = substr($maj, 4, 2);
	$t_jour = substr($maj, 6, 2);
	$t_h = substr($maj, 8, 2);
	$t_min = substr($maj, 10, 2);
	$t_sec = substr($maj, 12, 2);
	return mktime ($t_h, $t_min, $t_sec, $t_mois, $t_jour, $t_an, 0);
}

function build_begin_tag($tag) {
	return &quot;&lt;$tag&gt;&quot;;
}

function build_end_tag($tag) {
	return &quot;&lt;/$tag&gt;&quot;;
}

// Conversion texte -&gt; xml (ajout d'entites)
function text_to_xml($string) {
	return str_replace('&lt;', '&lt;', str_replace('&amp;', '&amp;', $string));
}


//
// Exportation generique d'objets (fichier ou retour de fonction)
//
function export_objets($query, $type, $file = 0, $gz = false, $etape_en_cours=&quot;&quot;, $etape_actuelle=&quot;&quot;, $nom_etape=&quot;&quot;) {
	global $debut_limit;
	if ($etape_en_cours &lt; 1 OR $etape_en_cours == $etape_actuelle){
		if ($etape_en_cours &gt; 0) {
			echo &quot;&lt;li&gt;&lt;b&gt;$nom_etape&lt;/b&gt;&quot;;
		}
	
		$result = spip_query($query);

		if ($etape_en_cours &gt; 0){
			if ($type == &quot;forum&quot;){
				$total = spip_num_rows($result);
				if ($total &gt; 5000){
					$result = spip_query($query.&quot; LIMIT $debut_limit, 5000&quot;);
					$debut_limit = $debut_limit + 5000;
					if ($debut_limit &gt; $total) {
						$debut_limit = 0;
						echo &quot; &quot;._T('info_tous_resultats_enregistres');
					}
					else {
						echo &quot; &quot;._T('info_premier_resultat', array('debut_limit' =&gt; $debut_limit, 'total' =&gt; $total));
					}
				} 
				else {
					$debut_limit = 0;
				}
			}
			if ($type == &quot;article&quot;){
				$total = spip_num_rows($result);
				if ($total &gt; 500){
					$result = spip_query($query.&quot; LIMIT $debut_limit, 500&quot;);
					$debut_limit = $debut_limit + 500;
					if ($debut_limit &gt; $total) {
						$debut_limit = 0;
						echo &quot; &quot;._T('info_tous_resultats_enregistres');
					}
					else {
						echo &quot; &quot;._T('info_premier_resultat_sur', array('debut_limit' =&gt; $debut_limit, 'total' =&gt; $total));
					}
				} 
				else {
					$debut_limit = 0;
				}
			}
		
		}
		
		$_fputs = ($gz) ? gzputs : fputs;
		$nfields = mysql_num_fields($result);
		// Recuperer les noms des champs
		for ($i = 0; $i &lt; $nfields; ++$i) $fields[$i] = mysql_field_name($result, $i);
		while ($row = spip_fetch_array($result)) {
			$string .= build_begin_tag($type) . &quot;\n&quot;;
			// Exporter les champs de la table
			for ($i = 0; $i &lt; $nfields; ++$i) {
				$string .= '&lt;'.$fields[$i].'&gt;' . text_to_xml($row[$i]) . '&lt;/'.$fields[$i].'&gt;' . &quot;\n&quot;;
			}
			// Exporter les relations
			if ($type == 'article') {
				$query = 'SELECT id_auteur FROM spip_auteurs_articles WHERE id_article='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:auteur&gt;' . $row2['id_auteur'] . '&lt;/lien:auteur&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
				$query = 'SELECT id_document FROM spip_documents_articles WHERE id_article='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:document&gt;' . $row2['id_document'] . '&lt;/lien:document&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
			}
			else if ($type == 'message') {
				$query = 'SELECT id_auteur FROM spip_auteurs_messages WHERE id_message='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:auteur&gt;' . $row2['id_auteur'] . '&lt;/lien:auteur&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
			}
			else if ($type == 'breve') {
				$query = 'SELECT id_document FROM spip_documents_breves WHERE id_breve='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:document&gt;' . $row2['id_document'] . '&lt;/lien:document&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
			}
			else if ($type == 'rubrique') {
				$query = 'SELECT id_document FROM spip_documents_rubriques WHERE id_rubrique='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:document&gt;' . $row2['id_document'] . '&lt;/lien:document&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
				$query = 'SELECT id_auteur FROM spip_auteurs_rubriques WHERE id_rubrique='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:auteur&gt;' . $row2['id_auteur'] . '&lt;/lien:auteur&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
			}
			else if ($type == 'auteur') {
				$query = 'SELECT id_rubrique FROM spip_auteurs_rubriques WHERE id_auteur='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:rubrique&gt;' . $row2['id_rubrique'] . '&lt;/lien:rubrique&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
			}
			else if ($type == 'mot') {
				$query = 'SELECT id_article FROM spip_mots_articles WHERE id_mot='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:article&gt;' . $row2['id_article'] . '&lt;/lien:article&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
				$query = 'SELECT id_breve FROM spip_mots_breves WHERE id_mot='.$row[0];
				$res2 = spip_query($query);
				while($row2 = spip_fetch_array($res2)) {
					$string .= '&lt;lien:breve&gt;' . $row2['id_breve'] . '&lt;/lien:breve&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res2);
				$query = 'SELECT id_forum FROM spip_mots_forum WHERE id_mot='.$row[0];
				$res3 = spip_query($query);
				while($row3 = spip_fetch_array($res3)) {
					$string .= '&lt;lien:forum&gt;' . $row3['id_forum'] . '&lt;/lien:forum&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res3);
				$query = 'SELECT id_rubrique FROM spip_mots_rubriques WHERE id_mot='.$row[0];
				$res4 = spip_query($query);
				while($row4 = spip_fetch_array($res4)) {
					$string .= '&lt;lien:rubrique&gt;' . $row4['id_rubrique'] . '&lt;/lien:rubrique&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res4);
				$query = 'SELECT id_syndic FROM spip_mots_syndic WHERE id_mot='.$row[0];
				$res4 = spip_query($query);
				while($row4 = spip_fetch_array($res4)) {
					$string .= '&lt;lien:syndic&gt;' . $row4['id_syndic'] . '&lt;/lien:syndic&gt;' . &quot;\n&quot;;
				}
				spip_free_result($res4);
			}
			$string .= build_end_tag($type) . &quot;\n\n&quot;;
			if ($file) {
				$_fputs($file, $string);
				$string = '';
			}
		}
		spip_free_result($result);
		if (!$file) return $string;
	}
	else if ($etape_actuelle &lt; $etape_en_cours) {
		echo &quot;&lt;li&gt; $nom_etape&quot;;
	} else {
		echo &quot;&lt;li&gt; &lt;font color='#999999'&gt;$nom_etape&lt;/font&gt;&quot;;
	}
}



?&gt;

--- NEW FILE: inc_acces.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_ACCES&quot;)) return;
define(&quot;_ECRIRE_INC_ACCES&quot;, &quot;1&quot;);


function creer_pass_aleatoire($longueur = 8, $sel = &quot;&quot;) {
	$seed = (double) (microtime() + 1) * time();
	mt_srand($seed);
	srand($seed);
	$s = '';
	$pass = '';
	for ($i = 0; $i &lt; $longueur; $i++) {
		if (!$s) {
			$s = mt_rand();
			if (!$s) $s = rand();
			$s = substr(md5(uniqid($s).$sel), 0, 16);
		}
		$r = unpack(&quot;Cr&quot;, pack(&quot;H2&quot;, $s.$s));
		$x = $r['r'] &amp; 63;
		if ($x &lt; 10) $x = chr($x + 48);
		else if ($x &lt; 36) $x = chr($x + 55);
		else if ($x &lt; 62) $x = chr($x + 61);
		else if ($x == 63) $x = '/';
		else $x = '.';
		$pass .= $x;
		$s = substr($s, 2);
	}
	$pass = ereg_replace(&quot;[./]&quot;, &quot;a&quot;, $pass);
	$pass = ereg_replace(&quot;[I1l]&quot;, &quot;L&quot;, $pass);
	$pass = ereg_replace(&quot;[0O]&quot;, &quot;o&quot;, $pass);
	return $pass;
}


//
// low-security : un ensemble de fonctions pour gerer de l'identification
// faible via les URLs (suivi RSS, iCal...)
//
function low_sec($id_auteur) {
	if (!$id_auteur = intval($id_auteur)) return; // jamais trop prudent ;)
	$query = &quot;SELECT * FROM spip_auteurs WHERE id_auteur = $id_auteur&quot;;
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$low_sec = $row[&quot;low_sec&quot;];
		if (!$low_sec) {
			$low_sec = creer_pass_aleatoire();
			spip_query(&quot;UPDATE spip_auteurs SET low_sec = '$low_sec' WHERE id_auteur = $id_auteur&quot;);
		}
		return $low_sec;
	}
}

function afficher_low_sec ($id_auteur, $action='') {
	return substr(md5($action.low_sec($id_auteur)),0,8);
}

function verifier_low_sec ($id_auteur, $cle, $action='') {
	return ($cle == afficher_low_sec($id_auteur, $action));
}

function effacer_low_sec($id_auteur) {
	spip_query(&quot;UPDATE spip_auteurs SET low_sec = '' WHERE id_auteur = $id_auteur&quot;);
}



function initialiser_sel() {
	global $htsalt;

	$htsalt = '$1$'.creer_pass_aleatoire();
}


function ecrire_logins($fichier, $tableau_logins) {
	reset($tableau_logins);

	while(list($login, $htpass) = each($tableau_logins)) {
		if ($login &amp;&amp; $htpass) {
			fputs($fichier, &quot;$login:$htpass\n&quot;);
		}
	}
}


function ecrire_acces() {
	$htaccess = _DIR_RESTREINT . _ACCESS_FILE_NAME;
	$htpasswd = _DIR_SESSIONS . _AUTH_USER_FILE;

	// si .htaccess existe, outrepasser spip_meta
	if ((lire_meta('creer_htpasswd') == 'non') AND !@file_exists($htaccess)) {
		@unlink($htpasswd);
		@unlink($htpasswd.&quot;-admin&quot;);
		return;
	}

	$query = &quot;SELECT login, htpass FROM spip_auteurs WHERE statut != '5poubelle' AND statut!='6forum'&quot;;
	$result = spip_query_db($query);	// attention, il faut au prealable se connecter a la base (necessaire car utilise par install.php3)
	$logins = array();
	while($row = spip_fetch_array($result)) $logins[$row['login']] = $row['htpass'];

	$fichier = @fopen($htpasswd, &quot;w&quot;);
	if ($fichier) {
		ecrire_logins($fichier, $logins);
		fclose($fichier);
	} else {
		redirige_par_entete(&quot;../spip_test_dirs.php3&quot;);
	}

	$query = &quot;SELECT login, htpass FROM spip_auteurs WHERE statut = '0minirezo'&quot;;
	$result = spip_query_db($query);

	$logins = array();
	while($row = spip_fetch_array($result)) $logins[$row['login']] = $row['htpass'];

	$fichier = fopen(&quot;$htpasswd-admin&quot;, &quot;w&quot;);
	ecrire_logins($fichier, $logins);
	fclose($fichier);
}


function generer_htpass($pass) {
	global $htsalt, $flag_crypt;
	if ($flag_crypt) return crypt($pass, $htsalt);
	else return '';
}

//
// Verifier la presence des .htaccess
//
function verifier_htaccess($rep) {
	$htaccess = &quot;$rep/&quot; . _ACCESS_FILE_NAME;
	if ((!@file_exists($htaccess)) AND 
	    !defined('_ECRIRE_INSTALL') AND !defined('_TEST_DIRS')) {
		spip_log(&quot;demande de creation de $htaccess&quot;);
		if ($GLOBALS['hebergeur'] != 'nexenservices'){
			if (!$f = fopen($htaccess, &quot;w&quot;))
				echo &quot;&lt;b&gt;&quot; .
				  _L(&quot;ECHEC DE LA CREATION DE $htaccess&quot;) .
				  &quot;&lt;/b&gt;&quot;;
			else
			  {
				fputs($f, &quot;deny from all\n&quot;);
				fclose($f);
			  }
		} else {
			echo &quot;&lt;font color=\&quot;#FF0000\&quot;&gt;IMPORTANT : &lt;/font&gt;&quot;;
			echo &quot;Votre h&eacute;bergeur est Nexen Services.&lt;br /&gt;&quot;;
			echo &quot;La protection du r&eacute;pertoire &lt;i&gt;$rep/&lt;/i&gt; doit se faire
			par l'interm&eacute;diaire de &quot;;
			echo &quot;&lt;a href=\&quot;<A HREF="http://www.nexenservices.com/webmestres/htlocal.php\">http://www.nexenservices.com/webmestres/htlocal.php\</A>&quot;
			target=\&quot;_blank\&quot;&gt;l'espace webmestres&lt;/a&gt;.&quot;;
			echo &quot;Veuillez cr&eacute;er manuellement la protection pour
			ce r&eacute;pertoire (un couple login/mot de passe est
			n&eacute;cessaire).&lt;br /&gt;&quot;;
		}
	}
}

function gerer_htaccess() {
	$mode = lire_meta('creer_htaccess');
	$r = spip_query(&quot;SELECT extension FROM spip_types_documents&quot;);
	while ($e = spip_fetch_array($r)) {
		if (is_dir($dir = _DIR_DOC . $e['extension'])) {
			if ($mode == 'oui')
				verifier_htaccess($dir);
			else @unlink(&quot;$dir/&quot; . _ACCESS_FILE_NAME);
		}
	}
	return $mode;
}

// En profiter pour verifier la securite de ecrire/data/
verifier_htaccess(_DIR_SESSIONS);

initialiser_sel();

?&gt;

--- NEW FILE: config-multilang.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);

include_ecrire (&quot;inc_config.php3&quot;);

function mySel($varaut,$variable){
		$retour= &quot; VALUE=\&quot;$varaut\&quot;&quot;;

	if ($variable==$varaut){
		$retour.= &quot; SELECTED&quot;;
	}

	return $retour;
}

lire_metas();

debut_page(_T('titre_page_config_contenu'), &quot;administration&quot;, &quot;langues&quot;);

echo &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;
gros_titre(_T('info_langues'));


if ($connect_statut != '0minirezo' OR !$connect_toutes_rubriques) {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}

init_config();
if ($changer_config == 'oui') {
	appliquer_modifs_config();
	calculer_langues_rubriques();
}


barre_onglets(&quot;config_lang&quot;, &quot;multi&quot;);


debut_gauche();

	
	
debut_droite();




echo &quot;&lt;form action='config-multilang.php3' method='post'&gt;&quot;;
echo &quot;&lt;input type='hidden' name='changer_config' value='oui'&gt;&quot;;

debut_cadre_couleur(&quot;traductions-24.gif&quot;, false, &quot;&quot;, _T('info_multilinguisme'));
	echo &quot;&lt;p&gt;&quot;._T('texte_multilinguisme').&quot;&lt;/p&gt;&quot;;

	echo &quot;&lt;div&gt;&quot;;
	echo _T('info_multi_articles');
	echo &quot;&lt;div style='text-align: $spip_lang_right';&gt;&quot;;
	afficher_choix('multi_articles', lire_meta('multi_articles'),
		array('oui' =&gt; _T('item_oui'), 'non' =&gt; _T('item_non')), &quot; &nbsp; &quot;);
	echo &quot;&lt;/div&gt;&quot;;
	echo &quot;&lt;/div&gt;&quot;;

	echo &quot;&lt;div&gt;&quot;;
	echo _T('info_multi_rubriques');
	echo &quot;&lt;div style='text-align: $spip_lang_right';&gt;&quot;;
	afficher_choix('multi_rubriques', lire_meta('multi_rubriques'),
		array('oui' =&gt; _T('item_oui'), 'non' =&gt; _T('item_non')), &quot; &nbsp; &quot;);
	echo &quot;&lt;/div&gt;&quot;;
	echo &quot;&lt;/div&gt;&quot;;

	if  (lire_meta('multi_rubriques') == 'oui') {
		echo &quot;&lt;div&gt;&quot;;
		echo _T('info_multi_secteurs');
		echo &quot;&lt;div style='text-align: $spip_lang_right';&gt;&quot;;
		afficher_choix('multi_secteurs', lire_meta('multi_secteurs'),
			array('oui' =&gt; _T('item_oui'), 'non' =&gt; _T('item_non')), &quot; &nbsp; &quot;);
		echo &quot;&lt;/div&gt;&quot;;
		echo &quot;&lt;/div&gt;&quot;;
	} else
		echo &quot;&lt;input type='hidden' name='multi_secteurs' value='&quot;.lire_meta('multi_secteurs').&quot;'&gt;&quot;;

	if ((lire_meta('multi_rubriques') == 'oui') OR (lire_meta('multi_articles') == 'oui')) {
		echo &quot;&lt;hr&gt;&quot;;
		echo &quot;&lt;p&gt;&quot;._T('texte_multilinguisme_trad').&quot;&lt;/p&gt;&quot;;

		echo _T('info_gerer_trad');
		echo &quot;&lt;div style='text-align: $spip_lang_right';&gt;&quot;;
		afficher_choix('gerer_trad', lire_meta('gerer_trad'),
			array('oui' =&gt; _T('item_oui'), 'non' =&gt; _T('item_non')), &quot; &nbsp; &quot;);
		echo &quot;&lt;/div&gt;&quot;;
	} else
		echo &quot;&lt;input type='hidden' name='gerer_trad' value='&quot;.lire_meta('gerer_trad').&quot;'&gt;&quot;;


	echo &quot;&lt;div style='text-align: $spip_lang_right;'&gt;&lt;INPUT TYPE='submit' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;' CLASS='fondo'&gt;&lt;/div&gt;&quot;;

fin_cadre_couleur();

	if (lire_meta('multi_articles') == &quot;oui&quot; OR lire_meta('multi_rubriques') == &quot;oui&quot;) {
		echo &quot;&lt;p&gt;&quot;;
		debut_cadre_relief(&quot;langues-24.gif&quot;);
		echo &quot;&lt;p class='verdana2'&gt;&quot;;
		echo _T('info_multi_langues_choisies');
		echo '&lt;/p&gt;';

		$langues = $GLOBALS['codes_langues'];
		$cesure = floor((count($langues) + 1) / 2);

		$langues_installees = explode(',', $GLOBALS['all_langs']);
		$langues_autorisees = explode(',', lire_meta('langues_multilingue'));

		while (list(,$l) = each ($langues_installees)) {
			$langues_trad[$l] = true;
		}

		while (list(,$l) = each ($langues_autorisees)) {
			$langues_auth[$l] = true;
		}

		$langues_bloquees[lire_meta('langue_site')] = 1;
		$query = &quot;SELECT DISTINCT lang FROM spip_articles WHERE statut='publie'&quot;;
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$langues_bloquees[$row['lang']] = 1;
		}
		$query = &quot;SELECT DISTINCT lang FROM spip_breves WHERE statut='publie'&quot;;
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$langues_bloquees[$row['lang']] = 1;
		}
		$query = &quot;SELECT DISTINCT lang FROM spip_rubriques WHERE statut='publie'&quot;;
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$langues_bloquees[$row['lang']] = 1;
		}

		echo &quot;&lt;table width = '100%' cellspacing='10'&gt;&lt;tr&gt;&lt;td width='50%' align='top' class='verdana1'&gt;&quot;;

		ksort($langues_bloquees);
		while (list($code_langue, ) = each($langues_bloquees)) {
			$i++;
			echo &quot;&lt;div&gt;&quot;;
			$nom_langue = $langues[$code_langue];
			if ($langues_trad[$code_langue]) $nom_langue = &quot;&lt;u&gt;$nom_langue&lt;/u&gt;&quot;;
			$nom_langue = &quot;&lt;b&gt;&lt;font color='$couleur_foncee'&gt;$nom_langue&lt;/font&gt;&lt;/b&gt;&quot;;
			echo &quot;&lt;input type='hidden' name='langues_auth[]' value='$code_langue' id='langue_auth_$code_langue'&gt;&quot;;
			echo &quot;&lt;input type='checkbox' checked disabled&gt;&quot;;
			echo  &quot; $nom_langue &nbsp; &nbsp;&lt;font color='#777777'&gt;[$code_langue]&lt;/font&gt;&quot;;
			echo &quot;&lt;/div&gt;\n&quot;;

			if ($i == $cesure) echo &quot;&lt;/td&gt;&lt;td width='50%' align='top' class='verdana1'&gt;&quot;;
		}

		echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;

		while (list($code_langue, $nom_langue) = each($langues)) {
			if ($langues_bloquees[$code_langue]) continue;
			$i++;
			echo &quot;&lt;div&gt;&quot;;
			if ($langues_trad[$code_langue]) $nom_langue = &quot;&lt;u&gt;$nom_langue&lt;/u&gt;&quot;;
	
			if ($langues_auth[$code_langue]) {
				echo &quot;&lt;input type='checkbox' name='langues_auth[]' value='$code_langue' id='langue_auth_$code_langue' checked&gt;&quot;;
				$nom_langue = &quot;&lt;b&gt;$nom_langue&lt;/b&gt;&quot;;
			}
			else {
				echo &quot;&lt;input type='checkbox' name='langues_auth[]' value='$code_langue' id='langue_auth_$code_langue'&gt;&quot;;
			}
			echo  &quot; &lt;label for='langue_auth_$code_langue'&gt;$nom_langue&lt;/label&gt; &nbsp; &nbsp;&lt;font color='#777777'&gt;[$code_langue]&lt;/font&gt;&quot;;

			echo &quot;&lt;/div&gt;\n&quot;;

			if ($i == $cesure) echo &quot;&lt;/font&gt;&lt;/td&gt;&lt;td width='50%' align='top' class='verdana1'&gt;&quot;;
		}

		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td style='text-align:$spip_lang_right;' COLSPAN=2&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='submit' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;' CLASS='fondo'&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
		
		
		echo &quot;&lt;div class='verdana1'&gt;&quot;._T(&quot;info_multi_langues_soulignees&quot;).&quot;&lt;/div&gt;&quot;;

		fin_cadre_relief();
	}



echo &quot;&lt;/form&gt;&quot;;

fin_page();

?&gt;

--- NEW FILE: inc_charsets.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_CHARSETS&quot;)) return;
define(&quot;_ECRIRE_INC_CHARSETS&quot;, &quot;1&quot;);


/* charsets supportes :
	utf-8 ;
	iso-8859-1 ; iso-8859-15 ;
	windows-1251  = CP1251 ;
*/
function load_charset ($charset = 'AUTO', $langue_site = 'AUTO') {
	if ($charset == 'AUTO')
		$charset = lire_meta('charset');
	if (is_array($GLOBALS['CHARSET'][$charset]))
		return $charset;

[...2383 lines suppressed...]
	// Le probleme d'iconv c'est qu'il risque de nous renvoyer des ? alors qu'on
	// prefere garder l'utf-8 pour que la chaine soit indexable.
	// 3. Translitterer grace a iconv
	if ($GLOBALS['flag_iconv'] &amp;&amp; ereg('&amp;#0*([0-9]+);', $texte)) {
		$texte = iconv('utf-8', 'ascii//translit', $texte);
	}
*/

	return $texte;
}

function translitteration_complexe($texte) {
	return translitteration($texte,'AUTO','complexe');
}


// Initialisation
$GLOBALS['CHARSET'] = Array();

?&gt;

--- NEW FILE: articles_versions.php3 ---
&lt;?php

include(&quot;inc_lab.php&quot;);

include_spip(&quot;ecrire.php&quot;);
include_spip(&quot;revisions.php&quot;);



//
// Lire l'article
//

$champs = array('surtitre', 'titre', 'soustitre', 'descriptif', 'nom_site', 'url_site', 'chapo', 'texte', 'ps');

$query = &quot;SELECT * FROM spip_articles WHERE id_article='$id_article'&quot;;
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$id_article = $row[&quot;id_article&quot;];
	$id_rubrique = $row[&quot;id_rubrique&quot;];
	$date = $row[&quot;date&quot;];
	$statut_article = $row[&quot;statut&quot;];
	$maj = $row[&quot;maj&quot;];
	$date_redac = $row[&quot;date_redac&quot;];
	$visites = $row[&quot;visites&quot;];
	$referers = $row[&quot;referers&quot;];
	$extra = $row[&quot;extra&quot;];
	$id_trad = $row[&quot;id_trad&quot;];
}

if (!($id_version = intval($id_version))) {
	$id_version = $row['id_version'];
}
$textes = recuperer_version($id_article, $id_version);

$id_diff = intval($id_diff);
if (!$id_diff) {
	$diff_auto = true;
	$query = &quot;SELECT id_version FROM spip_versions WHERE id_article=$id_article &quot;.
		&quot;AND id_version&lt;$id_version ORDER BY id_version DESC LIMIT 0,1&quot;;
	if ($result = spip_query($query)) {
		$row = mysql_fetch_array($result);
		$id_diff = $row['id_version'];
	}
}

//
// Calculer le diff
//

if ($id_version &amp;&amp; $id_diff) {
	include_spip(&quot;diff.php&quot;);

	if ($id_diff &gt; $id_version) {
		$t = $id_version;
		$id_version = $id_diff;
		$id_diff = $t;
		$old = $textes;
		$new = $textes = recuperer_version($id_article, $id_version);
	}
	else {
		$old = recuperer_version($id_article, $id_diff);
		$new = $textes;
	}

	$textes = array();
	
	foreach ($champs as $champ) {
		if (!$new[$champ] &amp;&amp; !$old[$champ]) continue;

		$diff = new Diff(new DiffTexte);
		$textes[$champ] = afficher_diff($diff-&gt;comparer(preparer_diff($new[$champ]), preparer_diff($old[$champ])));
	}
}

if (is_array($textes))
foreach ($textes as $var =&gt; $t) $$var = $t;



debut_page(_T('info_historique').&quot; &laquo; $titre &raquo;&quot;, &quot;documents&quot;, &quot;articles&quot;);

debut_grand_cadre();

afficher_hierarchie($id_rubrique);

fin_grand_cadre();



//////////////////////////////////////////////////////
// Affichage de la colonne de gauche
//

debut_gauche();



//////////////////////////////////////////////////////
// Affichage de la colonne de droite
//

debut_droite();

changer_typo('','article'.$id_article);

echo &quot;&lt;a name='diff'&gt;&lt;/a&gt;\n&quot;;

debut_cadre_relief();

//
// Titre, surtitre, sous-titre
//

if ($statut_article=='publie') {
	$logo_statut = &quot;puce-verte.gif&quot;;
}
else if ($statut_article=='prepa') {
	$logo_statut = &quot;puce-blanche.gif&quot;;
}
else if ($statut_article=='prop') {
	$logo_statut = &quot;puce-orange.gif&quot;;
}
else if ($statut_article == 'refuse') {
	$logo_statut = &quot;puce-rouge.gif&quot;;
}
else if ($statut_article == 'poubelle') {
	$logo_statut = &quot;puce-poubelle.gif&quot;;
}


echo &quot;\n&lt;table cellpadding='0' cellspacing='0' border='0' width='100%'&gt;&quot;;
echo &quot;&lt;tr width='100%'&gt;&lt;td width='100%' valign='top'&gt;&quot;;
if ($surtitre) {
	echo &quot;&lt;span $dir_lang&gt;&lt;font face='arial,helvetica' size='3'&gt;&lt;b&gt;&quot;;
	echo typo($surtitre);
	echo &quot;&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;\n&quot;;
}
gros_titre($titre, $logo_statut);

if ($soustitre) {
	echo &quot;&lt;span $dir_lang&gt;&lt;font face='arial,helvetica' size='3'&gt;&lt;b&gt;&quot;;
	echo typo($soustitre);
	echo &quot;&lt;/b&gt;&lt;/font&gt;&lt;/span&gt;\n&quot;;
}


if ($descriptif OR $url_site OR $nom_site) {
	echo &quot;&lt;p&gt;&lt;div align='left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;' $dir_lang&gt;&quot;;
	echo &quot;&lt;font size='2' face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
	$texte_case = ($descriptif) ? &quot;{{&quot;._T('info_descriptif').&quot;}} $descriptif\n\n&quot; : '';
	$texte_case .= ($nom_site.$url_site) ? &quot;{{&quot;._T('info_urlref').&quot;}} [&quot;.$nom_site.&quot;-&gt;&quot;.$url_site.&quot;]&quot; : '';
	echo propre($texte_case);
	echo &quot;&lt;/font&gt;&quot;;
	echo &quot;&lt;/div&gt;&quot;;
}

echo &quot;&lt;/td&gt;&quot;;

echo &quot;&lt;td align='center'&gt;&quot;;
icone(_T('icone_retour_article'), &quot;articles.php3?id_article=$id_article&quot;, &quot;&quot;, &quot;article-24.gif&quot;);
echo &quot;&lt;/td&gt;&quot;;

echo &quot;&lt;/tr&gt;&lt;/table&gt;&quot;;


//////////////////////////////////////////////////////
// Affichage des versions
//

debut_cadre_relief();

$query = &quot;SELECT id_version, titre_version, date, v.id_auteur, a.nom &quot;.
	&quot;FROM spip_versions AS v, spip_auteurs AS a &quot;.
	&quot;WHERE id_article=$id_article AND v.id_auteur=a.id_auteur ORDER BY id_version DESC&quot;;
$result = spip_query($query);

echo &quot;&lt;ul class='verdana3'&gt;&quot;;
while ($row = spip_fetch_array($result)) {
	echo &quot;&lt;li&gt;\n&quot;;
	$date = affdate_heure($row['date']);
	$version_aff = $row['id_version'];
	$titre_version = typo($row['titre_version']);
	$titre_aff = $titre_version ? $titre_version : $date;
	if ($version_aff != $id_version) {
		$link = new Link();
		$link-&gt;addVar('id_version', $version_aff);
		$link-&gt;delVar('id_diff');
		echo &quot;&lt;a href='&quot;.$link-&gt;getUrl('diff').&quot;' title=\&quot;&quot;._T('info_historique_affiche').&quot;\&quot;&gt;$titre_aff&lt;/a&gt;&quot;;
	}
	else {
		echo &quot;&lt;b&gt;$titre_aff&lt;/b&gt;&quot;;
	}
	echo &quot; (&quot;.typo($row['nom']).&quot;)&quot;;
	#if ($options == 'avancees') {	// note : c'est redondant car on ne peut arriver sur cette page qu'en options avancees...
		//echo &quot; &lt;span style='color:#989898; font-size: 80%; font-weight: bold;'&gt;&lt;i&gt;#&quot;.$row['id_version'].&quot;&lt;/i&gt;&lt;/span&gt;&quot;;
		if ($version_aff != $id_version) {
			echo &quot; &lt;span class='verdana2'&gt;&quot;;
			if ($version_aff == $id_diff) {
				echo &quot;&lt;b&gt;(&quot;._T('info_historique_comparaison').&quot;)&lt;/b&gt;&quot;;
			}
			else {
				$link = new Link();
				$link-&gt;addVar('id_version', $id_version);
				$link-&gt;addVar('id_diff', $version_aff);
				echo &quot;(&lt;a href='&quot;.$link-&gt;getUrl('diff').
				&quot;'&gt;&quot;._T('info_historique_comparaison').&quot;&lt;/a&gt;)&quot;;
			}
			echo &quot;&lt;/span&gt;&quot;;
		}
	#} // fin avancees
	echo &quot;&lt;/li&gt;\n&quot;;
}
echo &quot;&lt;/ul&gt;\n&quot;;

fin_cadre_relief();


//////////////////////////////////////////////////////
// Corps de la version affichee
//

if ($id_version) {
	echo &quot;\n\n&lt;div align='justify'&gt;&quot;;

	// pour l'affichage du virtuel
	unset($virtuel);
	if (substr($chapo, 0, 1) == '=') {
		$virtuel = substr($chapo, 1);
	}
	
	if ($virtuel) {
		debut_boite_info();
		echo _T('info_renvoi_article').&quot; &quot;.propre(&quot;&lt;center&gt;[-&gt;$virtuel]&lt;/center&gt;&quot;);
		fin_boite_info();
	}
	else {
		echo &quot;&lt;div $dir_lang&gt;&lt;b&gt;&quot;;
		$revision_nbsp = ($options == &quot;avancees&quot;);	// a regler pour relecture des nbsp dans les articles
		echo justifier(propre($chapo));
		echo &quot;&lt;/b&gt;&lt;/div&gt;\n\n&quot;;
	
		echo &quot;&lt;div $dir_lang&gt;&quot;;
		echo justifier(propre($texte));
		echo &quot;&lt;/div&gt;&quot;;
	
		if ($ps) {
			echo debut_cadre_enfonce();
			echo &quot;&lt;div $dir_lang&gt;&lt;font size='2' face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
			echo justifier(&quot;&lt;b&gt;&quot;._T('info_ps').&quot;&lt;/b&gt; &quot;.propre($ps));
			echo &quot;&lt;/font&gt;&lt;/div&gt;&quot;;
			echo fin_cadre_enfonce();
		}
		$revision_nbsp = false;
	
		if ($les_notes) {
			echo debut_cadre_relief();
			echo &quot;&lt;div $dir_lang&gt;&lt;font size='2'&gt;&quot;;
			echo justifier(&quot;&lt;b&gt;&quot;._T('info_notes').&quot;&nbsp;:&lt;/b&gt; &quot;.$les_notes);
			echo &quot;&lt;/font&gt;&lt;/div&gt;&quot;;
			echo fin_cadre_relief();
		}
	
		if ($champs_extra AND $extra) {
			include_spip(&quot;extra.php&quot;);
			extra_affichage($extra, &quot;articles&quot;);
		}
	}
}

fin_cadre_relief();


fin_page();

?&gt;

--- NEW FILE: inc_getdocument.php3 ---
&lt;?php

function creer_repertoire_documents($ext) {
	global $dossier_squelettes;

# est-il bien raisonnable d'accepter de creer si creer_rep retourne '' ?
	$rep = _DIR_DOC . creer_repertoire(_DIR_DOC, $ext);
	// Securite
	if (!$ext || ($rep == $dossier_squelettes) || (substr($rep,0,-1) == $dossier_squelettes))
		{
		  spip_log(&quot;creer_repertoire_documents interdit&quot;);
		  exit;
		}
	if (lire_meta(&quot;creer_htaccess&quot;) == 'oui') {
		include_ecrire('inc_acces.php3');
		verifier_htaccess($rep);
	}
	return $rep;
}


function copier_document($ext, $orig, $source) {

	$dir = creer_repertoire_documents($ext);
	$dest = $dir .
		ereg_replace(&quot;[^.a-zA-Z0-9_=-]+&quot;, &quot;_&quot;, 
			translitteration(ereg_replace(&quot;\.([^.]+)$&quot;, &quot;&quot;, 
						      ereg_replace(&quot;&lt;[^&gt;]*&gt;&quot;, '', basename($orig)))));

	# bien vu ?
	if ($source == ($dest . '.' . $ext)) return $source;
	$n = 0;
	while (@file_exists($newFile = $dest.($n++ ? '-'.$n : '').'.'.$ext));
	$r = deplacer_fichier_upload($source, $newFile);
	return (!$r ? '' : $newFile);
}

function verifier_compactes($image_name) {

	$zip = new PclZip($image_name);

	if ($list = $zip-&gt;listContent()) {
	// si pas possible de decompacter: installer comme fichier zip joint
	// Verifier si le contenu peut etre uploade (verif extension)
		$aff_fichiers = array();
		for ($i=0; $i&lt;sizeof($list); $i++) {
			for(reset($list[$i]); $key = key($list[$i]); next($list[$i])) {
			
				if ($key == &quot;stored_filename&quot;) {
					$f =  $list[$i][$key];
					  // Regexp des fichiers a ignorer
					if (!ereg(&quot;^(\.|.*/\.|.*__MACOSX/)&quot;, $f)) {
						if (ereg(&quot;\.([^.]+)$&quot;, $f, $match)) {
							$result = spip_query(&quot;SELECT * FROM spip_types_documents WHERE extension='&quot;
. corriger_extension(addslashes(strtolower($match[1]))) 
									     . &quot;' AND upload='oui'&quot;);
							if ($row = @spip_fetch_array($result))
								$aff_fichiers[]= $f;
							else
							spip_log(&quot;chargement de $f interdit&quot;);
							
						}
					}
				}
			}
		}
	}

	return $aff_fichiers ;
}

function afficher_compactes($image_name, $fichiers, $link) {
// presenter une interface pour choisir si fichier joint ou decompacter
// passer ca en squelette un de ces jours.

	include_ecrire (&quot;inc_presentation.php3&quot;);
	install_debut_html(_T('upload_fichier_zip'));
	echo &quot;&lt;p&gt;&quot;,
		_T('upload_fichier_zip_texte'),
		&quot;&lt;/p&gt;&quot;,
		&quot;&lt;p&gt;&quot;,
		_T('upload_fichier_zip_texte2'),
		&quot;&lt;/p&gt;&quot;,
		$link-&gt;getForm('POST'),
		_L(''),
		&quot;&lt;div&gt;&lt;input type='radio' checked name='action_zip' value='telquel'&gt;&quot;,
		_T('upload_zip_telquel'),
		&quot;&lt;/div&gt;&quot;,
		&quot;&lt;div&gt;&lt;input type='radio' name='action_zip' value='decompacter'&gt;&quot;,
		_T('upload_zip_decompacter'),
		&quot;&lt;/div&gt;&quot;,
		&quot;&lt;ul&gt;&lt;li&gt;&quot; ,
		 join(&quot;&lt;/li&gt;\n&lt;li&gt;&quot;,$fichiers) ,
		 &quot;&lt;/li&gt;&lt;/ul&gt;&quot;,
		&quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;,
		&quot;&lt;div style='text-align: right;'&gt;&lt;input class='fondo' style='font-size: 9px;' type='submit' value='&quot;,
		_T('bouton_valider'),
		&quot;'&gt;&lt;/div&gt;&quot;,
		&quot;&lt;/form&gt;&quot;;
	install_fin_html();
}

//
// Ajouter un unique document
//

function ajout_doc($orig, $source, $mode, $id_document) {
	global $hash_id_auteur, $hash, $id_article, $type;
	//
	// Securite
	//
	if (!verifier_action_auteur(&quot;ajout_doc&quot;, $hash, $hash_id_auteur))
		return;

	// type de document inconnu ?

	if (!ereg(&quot;\.([^.]+)$&quot;, $orig, $match)) return;

	$ext = corriger_extension(addslashes(strtolower($match[1])));
	$row = spip_query(&quot;SELECT * FROM spip_types_documents WHERE extension='$ext' AND upload='oui'&quot; . (($mode != 'vignette') ? '' : &quot; AND inclus='image'&quot;));

	// type de document invalide ?

	if (!$row = spip_fetch_array($row)) {return;}

	// Recopier le fichier sauf si deja fait (zip tel quel)

	$dest_path = !$source ? $orig : copier_document($ext,$orig, $source);

	if (!$dest_path) return;

	// Preparation
	if ($mode == 'vignette') {
		$id_document_lie = $id_document;
		$query = &quot;UPDATE spip_documents SET mode='document' where id_document='$id_document_lie'&quot;;
		spip_query($query); // requete inutile a mon avis (Fil)...
		$id_document = 0;
	}
	if (!$id_document) {
		$id_type = $row['id_type'];
		$id_document = spip_abstract_insert(&quot;documents&quot;, &quot;(id_type, titre, date)&quot;, &quot;($id_type, '', NOW())&quot;);
		$nouveau = true;
		if ($id_article &amp;&amp; isset($type)) {
			$query = &quot;INSERT INTO spip_documents_&quot;.$type.&quot;s (id_document, id_&quot;.$type.&quot;) VALUES ($id_document, $id_article)&quot;;
			spip_query($query);
		}
	}
	//
	// Mettre a jour les infos du document uploade
	//
	$size_image = @getimagesize($dest_path);
	$type_image = decoder_type_image($size_image[2]);
	if ($type_image) {
		$largeur = $size_image[0];
		$hauteur = $size_image[1];
	}
	$taille = filesize($dest_path);
	if ($nouveau) {
		$type_inclus = $row['inclus'];
		if (!$mode) $mode = ($type_image AND $type_inclus == 'image') ? 'vignette' : 'document';
			$update = &quot;mode='$mode', &quot;;
	}

	spip_query(&quot;UPDATE spip_documents SET $update taille='$taille', largeur='$largeur', hauteur='$hauteur', fichier='$dest_path' WHERE id_document=$id_document&quot;);

	if ($id_document_lie) {
		$query = &quot;UPDATE spip_documents SET id_vignette=$id_document WHERE id_document=$id_document_lie&quot;;
		spip_query($query);
		$id_document = $id_document_lie; // pour que le 'return' active le bon doc.
	}

	// Creer la vignette
	if ($mode == 'document' AND ereg(&quot;,$ext,&quot;, ','.lire_meta('formats_graphiques').',')) {
		creer_fichier_vignette($dest_path);
	}
}

// Ajouter un ou plusieurs documents ?

function ajout_doc_zip($image, $image_name, $mode, $forcer_document, $action_zip, $id_document, $hash, $link)
{
// image_name n'est valide que par POST http, mais pas par la methode ftp/upload
// par ailleurs, pour un fichier ftp/upload, il faut effacer l'original nous-memes
// action_zip indique un rappel par la fonction affiche_compactes
	if (!$action_zip){
		// on va se rappeler: copier le fichier car PHP va le virer
		$image_name = copier_document(&quot;zip&quot;, $image_name, $image);
		// anormal, on se tire
		if (!$image_name) exit;
		// renvoyer un formulaire demandant si on deballe ou pas
		require_once(_DIR_RESTREINT . 'pclzip.lib.php');
		$fichiers = verifier_compactes($image_name);
		if ($fichiers) {
			$link-&gt;addVar(&quot;image_name&quot;, $image_name);
			afficher_compactes($image_name, $fichiers, $link);
			exit;
		}
		// pas possible de deballer, on continue
		$forcer_document = 'oui';
		$image = $image_name;
	  }
	  else {
	    // reponse au formulaire
		if ($action_zip == &quot;telquel&quot;) {
			$forcer_document = 'oui';
			
		} else {
			require_once(_DIR_RESTREINT . 'pclzip.lib.php');
  			$archive = new PclZip($image_name);
			$tmp_dir = creer_repertoire_documents($hash);
			$archive-&gt;extract(PCLZIP_OPT_PATH, $tmp_dir, PCLZIP_OPT_REMOVE_ALL_PATH);
			# virer le zip apr&#232;s le d&#233;ballage
			@unlink($image_name);
			$image_name = $tmp_dir;

		}
	  }
	ajout_doc_s($image, $image_name, $mode, $forcer_document,$id_document, $hash);
}

function ajout_doc_s($image, $image_name, $mode, $forcer_document, $id_document, $hash) 
{
	if (!is_dir($image_name)) {
		ajout_doc($image_name,
			  $image,
			  ($forcer_document == 'oui' ? &quot;document&quot; : $mode),
			  $id_document);
	} else {
		include_ecrire('inc_documents.php3');
		$fichiers = fichiers_upload($image_name);

		while (list(,$f) = each($fichiers)) {
			if (ereg(&quot;\.([^.]+)$&quot;, $f, $match)) {
				$ext = strtolower($match[1]);
				if ($ext == 'jpeg')
					$ext = 'jpg';
				$r = spip_query(&quot;SELECT extension FROM spip_types_documents WHERE extension='$ext'&quot; . ($inclus ? &quot; AND inclus='$inclus'&quot; : ''));
				if (spip_fetch_array($r))
					ajout_doc($f, $f, 'document', false);
			}
		}

# d&#233;truire le repertoire de deballage
		if ($tmp_dir) effacer_repertoire_temporaire($tmp_dir);
	}
}

function effacer_repertoire_temporaire($nom) {
	$d = opendir($nom);
	while ($f = readdir($d)) {
		if (is_file($f = &quot;$nom/$f&quot;)) @unlink($f);
		}
	@rmdir($nom);
}
?&gt;

--- NEW FILE: .cvsignore ---
inc_connect.php3
inc_meta_cache.php3

--- NEW FILE: inc_mots.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_MOTS&quot;)) return;
define(&quot;_ECRIRE_INC_MOTS&quot;, &quot;1&quot;);

include_ecrire(&quot;inc_filtres.php3&quot;); # pour http_script (normalement d&#233;j&#224; fait)

$GLOBALS['flag_mots_ressemblants'] = $GLOBALS['flag_levenshtein'];


// ne pas faire d'erreur si les chaines sont &gt; 254 caracteres
function levenshtein255 ($a, $b) {
	$a = substr($a, 0, 254);
	$b = substr($b, 0, 254);
	return @levenshtein($a,$b);
}

function mots_ressemblants($mot, $table_mots, $table_ids='') {
	$lim = 2;
	$nb = 0;
	$opt = 1000000;
	$mot_opt = '';
	$mot = strtolower(trim($mot));
	$len = strlen($mot);

	if (!$table_mots) return '';

	while (!$nb AND $lim &lt; 10) {
		reset($table_mots);
		if ($table_ids) reset($table_ids);
		while (list(, $val) = each($table_mots)) {
			if ($table_ids) list(, $id) = each($table_ids);
			else $id = $val;
			$val2 = trim($val);
			if ($val2) {
				if (!($m = $distance[$id])) {
					$val2 = strtolower($val2);
					$len2 = strlen($val2);
					if (substr($val2, 0, $len) == $mot) $m = -1;
					else if ($len2 &gt; $len) $m = levenshtein255($val2, $mot) + $len - $len2;
					else $m = levenshtein255($val2, $mot);
					$distance[$id] = $m;
				}
				if ($m &lt;= $lim) {
					$selection[$id] = $m;
					if ($m &lt; $opt) {
						$opt = $m;
						$mot_opt = $val;
					}
					$nb++;
				}
			}
		}
		$lim += 2;
	}

	if (!$nb) return '';
	reset($selection);
	if ($opt != -1) {
		$moy = 1;
		while(list(, $val) = each($selection)) $moy *= $val;
		if($moy) $moy = pow($moy, 1.0/$nb);
		$lim = ($opt + $moy) / 2;
	}
	else $lim = -1;

	reset($selection);
	while (list($key, $val) = each($selection)) {
		if ($val &lt;= $lim) {
			$result[] = $key;
		}
	}
	return $result;
}


/*
 * Affiche la liste des mots-cles associes a l'objet
 * specifie, plus le formulaire d'ajout de mot-cle
 */

function formulaire_mots($table, $id_objet, $nouv_mot, $supp_mot, $cherche_mot, $flag_editable) {
	global $flag_mots_ressemblants;
	global $connect_statut, $options;
	global $spip_lang_rtl, $spip_lang_right;

	$select_groupe = $GLOBALS['select_groupe'];

	if ($table == 'articles') {
		$id_table = 'id_article';
		$objet = 'article';
		$url_base = &quot;articles.php3?id_article=$id_objet&quot;;
	}
	else if ($table == 'breves') {
		$id_table = 'id_breve';
		$objet = 'breve';
		$url_base = &quot;breves_voir.php3?id_breve=$id_objet&quot;;
	}
	else if ($table == 'rubriques') {
		$id_table = 'id_rubrique';
		$objet = 'rubrique';
		$url_base = &quot;naviguer.php3?id_rubrique=$id_objet&quot;;
	}

	else if ($table == 'syndic') {
		$id_table = 'id_syndic';
		$objet = 'syndic';
		$url_base = &quot;sites.php3?id_syndic=$id_objet&quot;;
	}

	$query = &quot;SELECT mots.* FROM spip_mots AS mots, spip_mots_$table AS lien WHERE lien.$id_table=$id_objet AND mots.id_mot=lien.id_mot&quot;;
	$nombre_mots = spip_num_rows(spip_query($query));

	$query_groupes = &quot;SELECT * FROM spip_groupes_mots WHERE $table = 'oui' AND $connect_statut = 'oui'&quot;;
	$nombre_groupes = spip_num_rows(spip_query($query_groupes));

	if (!$nombre_mots AND (!$nombre_groupes OR !$flag_editable)) return;

	echo &quot;&lt;a name='mots'&gt;&lt;/a&gt;&quot;;
	if ($flag_editable){
		if ($nouv_mot.$cherche_mot.$supp_mot)
			$bouton = bouton_block_visible(&quot;lesmots&quot;);
		else
			$bouton =  bouton_block_invisible(&quot;lesmots&quot;);
	}
	debut_cadre_enfonce(&quot;mot-cle-24.gif&quot;, false, &quot;&quot;, $bouton._T('titre_mots_cles').aide (&quot;artmots&quot;));

	//////////////////////////////////////////////////////
	// Recherche de mot-cle
	//

	if ($nouv_mot)
		$nouveaux_mots[] = $nouv_mot;

	$tous_les_mots = split(&quot; *[,;] *&quot;, $cherche_mot);
	while ((list(,$cherche_mot) = each ($tous_les_mots)) AND $cherche_mot) {
		echo &quot;&lt;P ALIGN='left'&gt;&quot;;
		$query = &quot;SELECT id_mot, titre FROM spip_mots WHERE id_groupe='$select_groupe'&quot;;
		$result = spip_query($query);
		unset($table_mots);
		unset($table_ids);
		while ($row = spip_fetch_array($result)) {
			$table_ids[] = $row['id_mot'];
			$table_mots[] = $row['titre'];
		}
		$resultat = mots_ressemblants($cherche_mot, $table_mots, $table_ids);
		debut_boite_info();
		if (!$resultat) {
			echo &quot;&lt;B&gt;&quot;._T('info_non_resultat', array('cherche_mot' =&gt; $cherche_mot)).&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
		}
		else if (count($resultat) == 1) {
			list(, $nouv_mot) = each($resultat);
			$nouveaux_mots[] = $nouv_mot;
			echo &quot;&lt;B&gt;&quot;._T('info_mot_cle_ajoute').&quot; &quot;;
			if ($table == 'articles') echo _T('info_l_article');
			else if ($table == 'breves') echo _T('info_la_breve');
			else if ($table == 'rubriques') echo _T('info_la_rubrique');
			echo &quot; : &lt;/B&gt;&lt;BR&gt;&quot;;
			$query = &quot;SELECT * FROM spip_mots WHERE id_mot=$nouv_mot&quot;;
			$result = spip_query($query);
			echo &quot;&lt;UL&gt;&quot;;
			while ($row = spip_fetch_array($result)) {
				$id_mot = $row['id_mot'];
				$titre_mot = $row['titre'];
				$type_mot = typo($row['type']);
				$descriptif_mot = $row['descriptif'];

				echo &quot;&lt;LI&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2&gt;&lt;B&gt;&lt;FONT SIZE=3&gt;&quot;.typo($titre_mot).&quot;&lt;/FONT&gt;&lt;/B&gt;&quot;;
				echo &quot;&lt;/FONT&gt;\n&quot;;
			}
			echo &quot;&lt;/UL&gt;&quot;;
		}
		else if (count($resultat) &lt; 16) {
			reset($resultat);
			unset($les_mots);
			while (list(, $id_mot) = each($resultat)) $les_mots[] = $id_mot;
			if ($les_mots) {
				$les_mots = join(',', $les_mots);
				echo &quot;&lt;B&gt;&quot;._T('info_plusieurs_mots_trouves', array('cherche_mot' =&gt; $cherche_mot)).&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
				$query = &quot;SELECT * FROM spip_mots WHERE id_mot IN ($les_mots) ORDER BY titre&quot;;
				$result = spip_query($query);
				echo &quot;&lt;UL&gt;&quot;;
				while ($row = spip_fetch_array($result)) {
					$id_mot = $row['id_mot'];
					$titre_mot = $row['titre'];
					$type_mot = typo($row['type']);
					$descriptif_mot = $row['descriptif'];

					echo &quot;&lt;LI&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2&gt;&lt;B&gt;&lt;FONT SIZE=3&gt;&quot;.typo($titre_mot).&quot;&lt;/FONT&gt;&lt;/B&gt;&quot;;

					if ($type_mot) echo &quot; ($type_mot)&quot;;
					echo &quot; | &lt;A HREF=\&quot;$url_base&amp;nouv_mot=$id_mot#mots\&quot;&gt;&quot;._T('info_ajouter_mot').&quot;&lt;/A&gt;&quot;;

					if (strlen($descriptif_mot) &gt; 1) {
						echo &quot;&lt;BR&gt;&lt;FONT SIZE=1&gt;&quot;.propre(couper($descriptif_mot, 100)).&quot;&lt;/FONT&gt;\n&quot;;
					}
					echo &quot;&lt;/FONT&gt;&lt;p&gt;\n&quot;;
				}
				echo &quot;&lt;/UL&gt;&quot;;
			}
		}
		else {
			echo &quot;&lt;B&gt;&quot;._T('info_trop_resultat', array('cherche_mot' =&gt; $cherche_mot)).&quot;&lt;BR&gt;&quot;;
		}

		if ($GLOBALS['connect_statut'] == '0minirezo') {
			echo &quot;&lt;div style='width: 200px;'&gt;&quot;;
			$retour = urlencode($GLOBALS['clean_link']-&gt;getUrl());
			$titre = urlencode($cherche_mot);
			icone_horizontale(_T('icone_creer_mot_cle'), &quot;mots_edit.php3?new=oui&amp;ajouter_id_article=$id_objet&amp;titre=$titre&amp;redirect=$retour&quot;, &quot;mot-cle-24.gif&quot;, &quot;creer.gif&quot;);
			echo &quot;&lt;/div&gt; &quot;;
		}

		fin_boite_info();
		echo &quot;&lt;P&gt;&quot;;

	}


	//////////////////////////////////////////////////////
	// Appliquer les modifications sur les mots-cles
	//

	if ($nouveaux_mots &amp;&amp; $flag_editable) {
		while ((list(,$nouv_mot) = each($nouveaux_mots)) AND $nouv_mot!='x') {
			$query = &quot;SELECT * FROM spip_mots_$table WHERE id_mot=$nouv_mot AND $id_table=$id_objet&quot;;
			$result = spip_query($query);
			if (!spip_num_rows($result)) {
				$query = &quot;INSERT INTO spip_mots_$table (id_mot,$id_table) VALUES ($nouv_mot, $id_objet)&quot;;
				$result = spip_query($query);
			}
		}
		$reindexer = true;
	}

	if ($supp_mot &amp;&amp; $flag_editable) {
		if ($supp_mot == -1)
			$mots_supp = &quot;&quot;;
		else
			$mots_supp = &quot; AND id_mot=$supp_mot&quot;;
		$query = &quot;DELETE FROM spip_mots_$table WHERE $id_table=$id_objet $mots_supp&quot;;
		$result = spip_query($query);
		$reindexer = true;
	}


	if ($reindexer AND lire_meta('activer_moteur') == 'oui') {
		include_ecrire (&quot;inc_index.php3&quot;);
		marquer_indexer($objet, $id_objet);
	}

	//
	// Afficher les mots-cles
	//

	$query = &quot;SELECT DISTINCT type FROM spip_mots&quot;;
	$result = spip_query($query);
	$plusieurs_types = (spip_num_rows($result) &gt; 1);

	unset($les_mots);

	$query = &quot;SELECT mots.* FROM spip_mots AS mots, spip_mots_$table AS lien WHERE lien.$id_table=$id_objet AND mots.id_mot=lien.id_mot ORDER BY mots.type, mots.titre&quot;;
	$result = spip_query($query);

	if (spip_num_rows($result) &gt; 0) {
		echo &quot;&lt;div class='liste'&gt;&quot;;
		echo &quot;&lt;table width='100%' cellpadding='3' cellspacing='0' border='0' background=''&gt;&quot;;
	
		$ifond=0;
			
		$tableau= '';
		while ($row = spip_fetch_array($result)) {
			$vals = '';
		
			$id_mot = $row['id_mot'];
			$titre_mot = $row['titre'];
			$type_mot = typo($row['type']);
			$descriptif_mot = $row['descriptif'];
			$id_groupe = $row['id_groupe'];
	
			$query_groupe = &quot;SELECT * FROM spip_groupes_mots WHERE id_groupe = $id_groupe&quot;;
			$result_groupe = spip_query($query_groupe);
			while($row_groupe = spip_fetch_array($result_groupe)) {
				$id_groupe = $row_groupe['id_groupe'];
				$titre_groupe = entites_html($row_groupe['titre']);
				$unseul = $row_groupe['unseul'];
				$obligatoire = $row_groupe['obligatoire'];
				$acces_admin =  $row_groupe['0minirezo'];
				$acces_redacteur = $row_groupe['1comite'];
	
				$flag_groupe = ($flag_editable AND (($connect_statut == '1comite' AND $acces_redacteur == 'oui') OR ($connect_statut == '0minirezo' AND $acces_admin == 'oui')));
			}
	
			$groupes_vus[$id_groupe] = true;
			$id_groupes_vus[] = $id_groupe;
	
			if ($ifond==0){
				$ifond=1;
				$couleur=&quot;#FFFFFF&quot;;
			}else{
				$ifond=0;
				$couleur=&quot;#EDF3FE&quot;;
			}
	
			$url = &quot;mots_edit.php3?id_mot=$id_mot&amp;redirect=&quot;.rawurlencode($url_base.'#mots');
	
			$vals[] = &quot;&lt;A HREF='$url'&gt;&quot; . http_img_pack('petite-cle.gif', &quot;&quot;, &quot;width='23' height='12' border='0'&quot;) .&quot;&lt;/A&gt;&quot;;
			
	
			// Changer
			if ($unseul == &quot;oui&quot; AND $flag_groupe) {
				$s = &quot;&lt;form action='$url_base#mots' method='post' style='margin:0px; padding: 0px'&gt;&quot;;
				$s .= &quot;&lt;INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'&gt;&quot;;
				if ($table == 'rubriques') $s .= &quot;&lt;INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'&gt;&quot;;
				$s .= &quot;&lt;select name='nouv_mot' onChange=\&quot;setvisibility('valider_groupe_$id_groupe', 'visible');\&quot; CLASS='fondl' STYLE='font-size:10px; width:90px;'&gt;&quot;;
	
				$query_autres_mots = &quot;SELECT * FROM spip_mots WHERE id_groupe = $id_groupe ORDER by titre&quot;;
				$result_autres_mots = spip_query($query_autres_mots);
				while ($row_autres = spip_fetch_array($result_autres_mots)) {
					$le_mot = $row_autres['id_mot'];
					$le_titre_mot = supprimer_tags(typo($row_autres['titre']));
	
					if ($le_mot == $id_mot) $selected = &quot;SELECTED&quot;;
					else $selected = &quot;&quot;;
					$s .= &quot;&lt;option value='$le_mot' $selected&gt; $le_titre_mot&quot;;
				}
				$s .= &quot;&lt;/select&gt;&quot;;
				$s .= &quot;&lt;INPUT TYPE='Hidden' NAME='supp_mot' VALUE='$id_mot'&gt;&quot;;
				$s .= &quot;&lt;span class='visible_au_chargement' id='valider_groupe_$id_groupe'&gt;&quot;;
				$s .= &quot; &nbsp; &lt;INPUT TYPE='submit' NAME='Choisir' VALUE='&quot;._T('bouton_changer').&quot;' CLASS='fondo' style='font-size: 10px';&gt;&quot;;
				$s .= &quot;&lt;/span&gt;&quot;;
				$s .= &quot;&lt;/form&gt;&quot;;
	
			} else {
				$s = &quot;&lt;A HREF='$url'&gt;&quot;.typo($titre_mot).&quot;&lt;/A&gt;&quot;;
			}
			$vals[] = $s;
	
			$vals[] = &quot;$type_mot&quot;;
	
			if ($flag_editable){
				$s = &quot;&quot;;
				if ($flag_groupe)
				  $s .= &quot;&lt;A HREF=\&quot;$url_base&amp;supp_mot=$id_mot#mots\&quot;&gt;&quot;._T('info_retirer_mot').&quot;&nbsp;&quot; . http_img_pack('croix-rouge.gif', &quot;X&quot;, &quot;width='7' height='7' border='0' align='middle'&quot;) .&quot;&lt;/A&gt;&quot;;
				else $s .= &quot;&nbsp;&quot;;
			}
			$vals[] = $s;
			
			$tableau[] = $vals;
	
			$les_mots[] = $id_mot;
		}
	
		$largeurs = array('25', '', '', '');
		$styles = array('arial11', 'arial2', 'arial2', 'arial1');
		afficher_liste($largeurs, $tableau, $styles);
	
	
		echo &quot;&lt;/table&gt;&lt;/div&gt;&quot;;
	}

	if ($les_mots) {
		$nombre_mots_associes = count($les_mots);
		$les_mots = join($les_mots, &quot;,&quot;);
	} else {
		$les_mots = &quot;0&quot;;
	}
	if ($id_groupes_vus) $id_groupes_vus = join($id_groupes_vus, &quot;,&quot;);
	else $id_groupes_vus = &quot;0&quot;;

	$query_groupes = &quot;SELECT * FROM spip_groupes_mots WHERE $table = 'oui' AND $connect_statut = 'oui' AND obligatoire = 'oui' AND id_groupe NOT IN ($id_groupes_vus)&quot;;
	$nb_groupes = spip_num_rows(spip_query($query_groupes));

	//
	// Afficher le formulaire d'ajout de mots-cles
	//

	if ($flag_editable) {
		if ($nouveaux_mots.$cherche_mot.$supp_mot)
			echo debut_block_visible(&quot;lesmots&quot;);
		else if ($nb_groupes &gt; 0) {
			echo debut_block_visible(&quot;lesmots&quot;);
			// vilain hack pour redresser un triangle
			$couche_a_redresser = $GLOBALS['numero_block']['lesmots'];
			if ($GLOBALS['browser_layer']) echo http_script(&quot;
triangle = findObj('triangle' + $couche_a_redresser);
if (triangle) triangle.src = '&quot; . _DIR_IMG_PACK . &quot;deplierbas$spip_lang_rtl.gif';&quot;);
		}
		else
			echo debut_block_invisible(&quot;lesmots&quot;);

		if ($nombre_mots_associes &gt; 3) {
			echo &quot;&lt;div align='right' class='arial1'&gt;&quot;;
			echo &quot;&lt;a href=\&quot;$url_base&amp;supp_mot=-1#mots\&quot;&gt;&quot;._T('info_retirer_mots').&quot;&lt;/a&gt;&quot;;
			echo &quot;&lt;/div&gt;&lt;br /&gt;\n&quot;;
		}


		$form_mot = &quot;&lt;FORM ACTION='$url_base#mots' METHOD='post' STYLE='margin:1px;'&gt;&quot;
			.&quot;&lt;INPUT TYPE='Hidden' NAME='$id_table' VALUE='$id_objet'&gt;&quot;;

		if ($table == 'rubriques') $form_mot .= &quot;&lt;INPUT TYPE='Hidden' NAME='id_rubrique' VALUE='$id_objet'&gt;&quot;;

		$message_ajouter_mot = &quot;&lt;span class='verdana1'&gt;&lt;B&gt;&quot;._T('titre_ajouter_mot_cle').&quot;&lt;/B&gt;&lt;/span&gt; &nbsp;\n&quot;;

		echo &quot;&lt;table border='0' width='100%' style='text-align: $spip_lang_right'&gt;&quot;;

		$query_groupes = &quot;SELECT * FROM spip_groupes_mots WHERE $table = 'oui' AND $connect_statut = 'oui' AND (unseul != 'oui'  OR (unseul = 'oui' AND id_groupe NOT IN ($id_groupes_vus))) ORDER BY titre&quot;;
		$result_groupes = spip_query($query_groupes);

		// Afficher un menu par groupe de mots


		while ($row_groupes = spip_fetch_array($result_groupes)) {
			$id_groupe = $row_groupes['id_groupe'];
			$titre_groupe = entites_html(textebrut(typo($row_groupes['titre'])));
			$unseul = $row_groupes['unseul'];
			$obligatoire = $row_groupes['obligatoire'];
			$articles = $row_groupes['articles'];
			$breves = $row_groupes['breves'];
			$rubriques = $row_groupes['rubriques'];
			$syndic = $row_groupes['syndic'];
			$acces_minirezo = $row_groupes['0minirezo'];
			$acces_comite = $row_groupes['1comite'];
			$acces_forum = $row_groupes['6forum'];
			
			$query = &quot;SELECT * FROM spip_mots WHERE id_groupe = '$id_groupe' &quot;;
			if ($les_mots) $query .= &quot;AND id_mot NOT IN ($les_mots) &quot;;
			$query .= &quot;ORDER BY type, titre&quot;;
			$result = spip_query($query);
			if (spip_num_rows($result) &gt; 0) {
				if ((spip_num_rows($result) &gt; 50 AND $flag_mots_ressemblants)) {
					echo &quot;\n&lt;tr&gt;&quot;;
					echo $form_mot;
					echo &quot;\n&lt;td&gt;&quot;;
					echo $message_ajouter_mot;
					$message_ajouter_mot = &quot;&quot;;
					echo &quot;&lt;/td&gt;\n&lt;td&gt;&quot;;
					echo &quot;&lt;script language='text/javascript'&gt;&lt;!--\nvar antifocus_$id_groupe = false;\n// --&gt;&lt;/script&gt;\n&quot;;
					$jscript = &quot;onfocus=\&quot;if(!antifocus_$id_groupe){this.value='';antifocus_$id_groupe=true;}\&quot;&quot;. &quot; onClick=\&quot;setvisibility('valider_groupe_$id_groupe', 'visible');\&quot;&quot;;

					if ($obligatoire == &quot;oui&quot; AND !$groupes_vus[$id_groupe])
						echo &quot;&lt;INPUT TYPE='text' NAME='cherche_mot' CLASS='fondl' STYLE='width: 180px; background-color:#E86519;' VALUE=\&quot;$titre_groupe\&quot; SIZE='20' $jscript&gt;&quot;;
					else if ($unseul == &quot;oui&quot;)
						echo &quot;&lt;INPUT TYPE='text' NAME='cherche_mot' CLASS='fondl' STYLE='width: 180px; background-color:#cccccc;' VALUE=\&quot;$titre_groupe\&quot; SIZE='20' $jscript&gt;&quot;;
					else
						echo &quot;&lt;INPUT TYPE='text' NAME='cherche_mot'  CLASS='fondl' STYLE='width: 180px; ' VALUE=\&quot;$titre_groupe\&quot; SIZE='20' $jscript&gt;&quot;;

					echo &quot;&lt;/td&gt;\n&lt;td&gt;&quot;;
					echo &quot;&lt;INPUT TYPE='hidden' NAME='select_groupe'  VALUE='$id_groupe'&gt;&quot;;

					echo &quot;&lt;span class='visible_au_chargement' id='valider_groupe_$id_groupe'&gt;&quot;;
					echo &quot; &lt;INPUT TYPE='submit' NAME='Chercher' VALUE='&quot;._T('bouton_chercher').&quot;' CLASS='fondo' STYLE='font-size:10px'&gt;&quot;;
					echo &quot;&lt;/span&gt;&quot;;
					echo &quot;&lt;/td&gt;&lt;/FORM&gt;&quot;;
					echo &quot;&lt;/tr&gt;&quot;;
				}
				else {
					echo &quot;\n&lt;tr&gt;&quot;;
					echo $form_mot;
					echo &quot;\n&lt;td&gt;&quot;;
					echo $message_ajouter_mot;
					$message_ajouter_mot = &quot;&quot;;
					echo &quot;&lt;/td&gt;\n&lt;td&gt;&quot;;

					if ($obligatoire == &quot;oui&quot; AND !$groupes_vus[$id_groupe])
						echo &quot;&lt;SELECT NAME='nouv_mot' SIZE='1' onChange=\&quot;setvisibility('valider_groupe_$id_groupe', 'visible');\&quot; STYLE='width: 180px; background-color:#E86519;' CLASS='fondl'&gt;&quot;;
					else if ($unseul == &quot;oui&quot;)
						echo &quot;&lt;SELECT NAME='nouv_mot' SIZE='1' onChange=\&quot;setvisibility('valider_groupe_$id_groupe', 'visible');\&quot; STYLE='width: 180px; background-color:#cccccc;' CLASS='fondl'&gt;&quot;;
					else
						echo &quot;&lt;SELECT NAME='nouv_mot' SIZE='1' onChange=\&quot;setvisibility('valider_groupe_$id_groupe', 'visible');\&quot; STYLE='width: 180px; ' CLASS='fondl'&gt;&quot;;

					$ifond == 0;
					echo &quot;\n&lt;option value='x' style='font-variant: small-caps;'&gt;$titre_groupe&lt;/option&gt;&quot;;
					while($row = spip_fetch_array($result)) {
						$id_mot = $row['id_mot'];
						$titre_mot = $row['titre'];
						$texte_option = entites_html(textebrut(typo($titre_mot)));
						echo &quot;\n&lt;OPTION VALUE=\&quot;$id_mot\&quot;&gt;&quot;;
						echo &quot;&nbsp;&nbsp;&nbsp;&quot;;
						echo &quot;$texte_option&lt;/option&gt;&quot;;
					}
					echo &quot;&lt;/SELECT&gt;&quot;;
					echo &quot;&lt;/td&gt;\n&lt;td&gt;&quot;;
					echo &quot;&lt;span class='visible_au_chargement' id='valider_groupe_$id_groupe'&gt;&quot;;
					echo &quot; &nbsp; &lt;INPUT TYPE='submit' NAME='Choisir' VALUE='&quot;._T('bouton_choisir').&quot;' CLASS='fondo'&gt;&quot;;
					echo &quot;&lt;/span&gt;&quot;;
					echo &quot;&lt;/td&gt;&lt;/FORM&gt;&quot;;
					echo &quot;&lt;/tr&gt;&quot;;
				}
			}
		}
		
		if ($table == 'articles' AND $connect_statut == '0minirezo' AND $flag_editable AND $options == &quot;avancees&quot;) {
			echo &quot;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan='2'&gt;&quot;;
			echo &quot;&lt;div style='width: 200px;'&gt;&quot;;
			$retour = urlencode($GLOBALS['clean_link']-&gt;getUrl());
			icone_horizontale(_T('icone_creer_mot_cle'), &quot;mots_edit.php3?new=oui&amp;ajouter_id_article=$id_objet&amp;redirect=$retour&quot;, &quot;mot-cle-24.gif&quot;, &quot;creer.gif&quot;);
			echo &quot;&lt;/div&gt; &quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		}
		
		
		
		echo &quot;&lt;/table&gt;&quot;;
		echo fin_block();
	}


	fin_cadre_enfonce();
}


?&gt;

--- NEW FILE: md5.js ---
/*
 *  md5.jvs 1.0b 27/06/96
 *
 * Javascript implementation of the RSA Data Security, Inc. MD5
 * Message-Digest Algorithm.
 *
 * Copyright (c) 1996 Henri Torgemane. All Rights Reserved.
 *
 * Permission to use, copy, modify, and distribute this software
 * and its documentation for any purposes and without
 * fee is hereby granted provided that this copyright notice
 * appears in all copies.
 *
 * Of course, this soft is provided &quot;as is&quot; without express or implied
 * warranty of any kind.
 *
 * -------------------------------------------------------------
 * Modified :
 * - 2003/06/09 by Antoine Pitrou (unicode compatibility)
 *
 *
 * $Id: md5.js,v 1.1 2005/01/13 16:16:22 stef Exp $
 *
 */



function array(n) {
  for(i=0;i&lt;n;i++) this[i]=0;
  this.length=n;
}

/* Some basic logical functions had to be rewritten because of a bug in
 * Javascript.. Just try to compute 0xffffffff &gt;&gt; 4 with it..
 * Of course, these functions are slower than the original would be, but
 * at least, they work!
 */

function integer(n) { return n%(0xffffffff+1); }

function shr(a,b) {
  a=integer(a);
  b=integer(b);
  if (a-0x80000000&gt;=0) {
    a=a%0x80000000;
    a&gt;&gt;=b;
    a+=0x40000000&gt;&gt;(b-1);
  } else
    a&gt;&gt;=b;
  return a;
}

function shl1(a) {
  a=a%0x80000000;
  if (a&amp;0x40000000==0x40000000)
  {
    a-=0x40000000;
    a*=2;
    a+=0x80000000;
  } else
    a*=2;
  return a;
}

function shl(a,b) {
  a=integer(a);
  b=integer(b);
  for (var i=0;i&lt;b;i++) a=shl1(a);
  return a;
}

function and(a,b) {
  a=integer(a);
  b=integer(b);
  var t1=(a-0x80000000);
  var t2=(b-0x80000000);
  if (t1&gt;=0)
    if (t2&gt;=0)
      return ((t1&amp;t2)+0x80000000);
    else
      return (t1&amp;b);
  else
    if (t2&gt;=0)
      return (a&amp;t2);
    else
      return (a&amp;b);
}

function or(a,b) {
  a=integer(a);
  b=integer(b);
  var t1=(a-0x80000000);
  var t2=(b-0x80000000);
  if (t1&gt;=0)
    if (t2&gt;=0)
      return ((t1|t2)+0x80000000);
    else
      return ((t1|b)+0x80000000);
  else
    if (t2&gt;=0)
      return ((a|t2)+0x80000000);
    else
      return (a|b);
}

function xor(a,b) {
  a=integer(a);
  b=integer(b);
  var t1=(a-0x80000000);
  var t2=(b-0x80000000);
  if (t1&gt;=0) 
    if (t2&gt;=0) 
      return (t1^t2);
    else
      return ((t1^b)+0x80000000);
  else
    if (t2&gt;=0)
      return ((a^t2)+0x80000000);
    else
      return (a^b);  
}

function not(a) {
  a=integer(a);
  return (0xffffffff-a);
}

/* Here begin the real algorithm */

    var state = new array(4); 
    var count = new array(2);
	count[0] = 0;
	count[1] = 0;                     
    var buffer = new array(64); 
    var transformBuffer = new array(16);
    var digestBits = new array(16);

    var S11 = 7;
    var S12 = 12;
    var S13 = 17;
    var S14 = 22;
    var S21 = 5;
    var S22 = 9;
    var S23 = 14;
    var S24 = 20;
    var S31 = 4;
    var S32 = 11;
    var S33 = 16;
    var S34 = 23;
    var S41 = 6;
    var S42 = 10;
    var S43 = 15;
    var S44 = 21;

    function F(x,y,z) {
	return or(and(x,y),and(not(x),z));
    }

    function G(x,y,z) {
	return or(and(x,z),and(y,not(z)));
    }

    function H(x,y,z) {
	return xor(xor(x,y),z);
    }

    function I(x,y,z) {
	return xor(y ,or(x , not(z)));
    }

    function rotateLeft(a,n) {
	return or(shl(a, n),(shr(a,(32 - n))));
    }

    function FF(a,b,c,d,x,s,ac) {
        a = a+F(b, c, d) + x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function GG(a,b,c,d,x,s,ac) {
	a = a+G(b, c, d) +x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function HH(a,b,c,d,x,s,ac) {
	a = a+H(b, c, d) + x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function II(a,b,c,d,x,s,ac) {
	a = a+I(b, c, d) + x + ac;
	a = rotateLeft(a, s);
	a = a+b;
	return a;
    }

    function transform(buf,offset) { 
	var a=0, b=0, c=0, d=0; 
	var x = transformBuffer;
	
	a = state[0];
	b = state[1];
	c = state[2];
	d = state[3];

	for (i = 0; i &lt; 16; i++) {
	    x[i] = and(buf[i*4+offset],0xff);
	    for (j = 1; j &lt; 4; j++) {
		x[i]+=shl(and(buf[i*4+j+offset] ,0xff), j * 8);
	    }
	}

	/* Round 1 */
	a = FF ( a, b, c, d, x[ 0], S11, 0xd76aa478); /* 1 */
	d = FF ( d, a, b, c, x[ 1], S12, 0xe8c7b756); /* 2 */
	c = FF ( c, d, a, b, x[ 2], S13, 0x242070db); /* 3 */
	b = FF ( b, c, d, a, x[ 3], S14, 0xc1bdceee); /* 4 */
	a = FF ( a, b, c, d, x[ 4], S11, 0xf57c0faf); /* 5 */
	d = FF ( d, a, b, c, x[ 5], S12, 0x4787c62a); /* 6 */
	c = FF ( c, d, a, b, x[ 6], S13, 0xa8304613); /* 7 */
	b = FF ( b, c, d, a, x[ 7], S14, 0xfd469501); /* 8 */
	a = FF ( a, b, c, d, x[ 8], S11, 0x698098d8); /* 9 */
	d = FF ( d, a, b, c, x[ 9], S12, 0x8b44f7af); /* 10 */
	c = FF ( c, d, a, b, x[10], S13, 0xffff5bb1); /* 11 */
	b = FF ( b, c, d, a, x[11], S14, 0x895cd7be); /* 12 */
	a = FF ( a, b, c, d, x[12], S11, 0x6b901122); /* 13 */
	d = FF ( d, a, b, c, x[13], S12, 0xfd987193); /* 14 */
	c = FF ( c, d, a, b, x[14], S13, 0xa679438e); /* 15 */
	b = FF ( b, c, d, a, x[15], S14, 0x49b40821); /* 16 */

	/* Round 2 */
	a = GG ( a, b, c, d, x[ 1], S21, 0xf61e2562); /* 17 */
	d = GG ( d, a, b, c, x[ 6], S22, 0xc040b340); /* 18 */
	c = GG ( c, d, a, b, x[11], S23, 0x265e5a51); /* 19 */
	b = GG ( b, c, d, a, x[ 0], S24, 0xe9b6c7aa); /* 20 */
	a = GG ( a, b, c, d, x[ 5], S21, 0xd62f105d); /* 21 */
	d = GG ( d, a, b, c, x[10], S22,  0x2441453); /* 22 */
	c = GG ( c, d, a, b, x[15], S23, 0xd8a1e681); /* 23 */
	b = GG ( b, c, d, a, x[ 4], S24, 0xe7d3fbc8); /* 24 */
	a = GG ( a, b, c, d, x[ 9], S21, 0x21e1cde6); /* 25 */
	d = GG ( d, a, b, c, x[14], S22, 0xc33707d6); /* 26 */
	c = GG ( c, d, a, b, x[ 3], S23, 0xf4d50d87); /* 27 */
	b = GG ( b, c, d, a, x[ 8], S24, 0x455a14ed); /* 28 */
	a = GG ( a, b, c, d, x[13], S21, 0xa9e3e905); /* 29 */
	d = GG ( d, a, b, c, x[ 2], S22, 0xfcefa3f8); /* 30 */
	c = GG ( c, d, a, b, x[ 7], S23, 0x676f02d9); /* 31 */
	b = GG ( b, c, d, a, x[12], S24, 0x8d2a4c8a); /* 32 */

	/* Round 3 */
	a = HH ( a, b, c, d, x[ 5], S31, 0xfffa3942); /* 33 */
	d = HH ( d, a, b, c, x[ 8], S32, 0x8771f681); /* 34 */
	c = HH ( c, d, a, b, x[11], S33, 0x6d9d6122); /* 35 */
	b = HH ( b, c, d, a, x[14], S34, 0xfde5380c); /* 36 */
	a = HH ( a, b, c, d, x[ 1], S31, 0xa4beea44); /* 37 */
	d = HH ( d, a, b, c, x[ 4], S32, 0x4bdecfa9); /* 38 */
	c = HH ( c, d, a, b, x[ 7], S33, 0xf6bb4b60); /* 39 */
	b = HH ( b, c, d, a, x[10], S34, 0xbebfbc70); /* 40 */
	a = HH ( a, b, c, d, x[13], S31, 0x289b7ec6); /* 41 */
	d = HH ( d, a, b, c, x[ 0], S32, 0xeaa127fa); /* 42 */
	c = HH ( c, d, a, b, x[ 3], S33, 0xd4ef3085); /* 43 */
	b = HH ( b, c, d, a, x[ 6], S34,  0x4881d05); /* 44 */
	a = HH ( a, b, c, d, x[ 9], S31, 0xd9d4d039); /* 45 */
	d = HH ( d, a, b, c, x[12], S32, 0xe6db99e5); /* 46 */
	c = HH ( c, d, a, b, x[15], S33, 0x1fa27cf8); /* 47 */
	b = HH ( b, c, d, a, x[ 2], S34, 0xc4ac5665); /* 48 */

	/* Round 4 */
	a = II ( a, b, c, d, x[ 0], S41, 0xf4292244); /* 49 */
	d = II ( d, a, b, c, x[ 7], S42, 0x432aff97); /* 50 */
	c = II ( c, d, a, b, x[14], S43, 0xab9423a7); /* 51 */
	b = II ( b, c, d, a, x[ 5], S44, 0xfc93a039); /* 52 */
	a = II ( a, b, c, d, x[12], S41, 0x655b59c3); /* 53 */
	d = II ( d, a, b, c, x[ 3], S42, 0x8f0ccc92); /* 54 */
	c = II ( c, d, a, b, x[10], S43, 0xffeff47d); /* 55 */
	b = II ( b, c, d, a, x[ 1], S44, 0x85845dd1); /* 56 */
	a = II ( a, b, c, d, x[ 8], S41, 0x6fa87e4f); /* 57 */
	d = II ( d, a, b, c, x[15], S42, 0xfe2ce6e0); /* 58 */
	c = II ( c, d, a, b, x[ 6], S43, 0xa3014314); /* 59 */
	b = II ( b, c, d, a, x[13], S44, 0x4e0811a1); /* 60 */
	a = II ( a, b, c, d, x[ 4], S41, 0xf7537e82); /* 61 */
	d = II ( d, a, b, c, x[11], S42, 0xbd3af235); /* 62 */
	c = II ( c, d, a, b, x[ 2], S43, 0x2ad7d2bb); /* 63 */
	b = II ( b, c, d, a, x[ 9], S44, 0xeb86d391); /* 64 */

	state[0] +=a;
	state[1] +=b;
	state[2] +=c;
	state[3] +=d;

    }

    function init() {
	count[0]=count[1] = 0;
	state[0] = 0x67452301;
	state[1] = 0xefcdab89;
	state[2] = 0x98badcfe;
	state[3] = 0x10325476;
	for (i = 0; i &lt; digestBits.length; i++)
	    digestBits[i] = 0;
    }

    function update(b) {
	var index,i;

	index = and(shr(count[0],3) , 0x3f);
	if (count[0]&lt;0xffffffff-7)
	  count[0] += 8;
        else {
	  count[1]++;
	  count[0]-=0xffffffff+1;
          count[0]+=8;
        }
	buffer[index] = and(b,0xff);
	if (index  &gt;= 63) {
	    transform(buffer, 0);
	}
    }

    function finish() {
	var bits = new array(8);
	var	padding;
	var	i=0, index=0, padLen=0;

	for (i = 0; i &lt; 4; i++) {
	    bits[i] = and(shr(count[0],(i * 8)), 0xff);
	}
        for (i = 0; i &lt; 4; i++) {
	    bits[i+4]=and(shr(count[1],(i * 8)), 0xff);
	}
	index = and(shr(count[0], 3) ,0x3f);
	padLen = (index &lt; 56) ? (56 - index) : (120 - index);
	padding = new array(64); 
	padding[0] = 0x80;
        for (i=0;i&lt;padLen;i++)
	  update(padding[i]);
        for (i=0;i&lt;8;i++)
	  update(bits[i]);

	for (i = 0; i &lt; 4; i++) {
	    for (j = 0; j &lt; 4; j++) {
		digestBits[i*4+j] = and(shr(state[i], (j * 8)) , 0xff);
	    }
	} 
    }

/* End of the MD5 algorithm */

function hexa(n) {
 var hexa_h = &quot;0123456789abcdef&quot;;
 var hexa_c=&quot;&quot;;
 var hexa_m=n;
 for (hexa_i=0;hexa_i&lt;8;hexa_i++) {
   hexa_c=hexa_h.charAt(Math.abs(hexa_m)%16)+hexa_c;
   hexa_m=Math.floor(hexa_m/16);
 }
 return hexa_c;
}


var ascii=&quot;01234567890123456789012345678901&quot; +
          &quot; !\&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;+
          &quot;[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;;

function calcMD5(entree)
{
 var l,s,k,ka,kb,kc,kd;

 init();
 /*for (k=0;k&lt;entree.length;k++) {
   l=entree.charAt(k);
   update(ascii.lastIndexOf(l));
 }*/
 for (k=0;k&lt;entree.length;k++) {
   l=entree.charCodeAt(k);
   update(l);
 }

 finish();
 ka=kb=kc=kd=0;
 for (i=0;i&lt;4;i++) ka+=shl(digestBits[15-i], (i*8));
 for (i=4;i&lt;8;i++) kb+=shl(digestBits[15-i], ((i-4)*8));
 for (i=8;i&lt;12;i++) kc+=shl(digestBits[15-i], ((i-8)*8));
 for (i=12;i&lt;16;i++) kd+=shl(digestBits[15-i], ((i-12)*8));
 s=hexa(kd)+hexa(kc)+hexa(kb)+hexa(ka);
 return s;
}

--- NEW FILE: message_edit.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_abstract_sql.php3&quot;);

// Droits
if ($new=='oui') {
	switch ($type) {
		case 'affich':
			$ok = ($connect_statut == '0minirezo');
			break;
		case 'pb':
		case 'rv':
		case 'normal':
			$ok = true;
			break;
		default:
			$ok = false;
	}

	if (!$ok) {
		debut_page(_T('info_acces_refuse'));
		debut_gauche();
		debut_droite();
		echo &quot;&lt;b&gt;&quot;._T('avis_non_acces_message').&quot;&lt;/b&gt;&lt;p&gt;&quot;;
		fin_page();
		exit;
	}
}

function my_sel($num, $tex, $comp) {
  return &quot;&lt;option value='$num'&quot; . (($num != $comp) ? '' : &quot; selected='selected'&quot;) .
    &quot;&gt;$tex&lt;/option&gt;\n&quot;;
}

function afficher_mois($mois, $attributs){
  return
	&quot;&lt;select $attributs&gt;\n&quot; .
	my_sel(&quot;01&quot;, _T('date_mois_1'), $mois) .
	my_sel(&quot;02&quot;, _T('date_mois_2'), $mois) .
	my_sel(&quot;03&quot;, _T('date_mois_3'), $mois) .
	my_sel(&quot;04&quot;, _T('date_mois_4'), $mois) .
	my_sel(&quot;05&quot;, _T('date_mois_5'), $mois) .
	my_sel(&quot;06&quot;, _T('date_mois_6'), $mois) .
	my_sel(&quot;07&quot;, _T('date_mois_7'), $mois) .
	my_sel(&quot;08&quot;, _T('date_mois_8'), $mois) .
	my_sel(&quot;09&quot;, _T('date_mois_9'), $mois) .
	my_sel(&quot;10&quot;, _T('date_mois_10'), $mois) .
	my_sel(&quot;11&quot;, _T('date_mois_11'), $mois) .
	my_sel(&quot;12&quot;, _T('date_mois_12'), $mois) .
	&quot;&lt;/select&gt;\n&quot;;
}

function afficher_annee($annee, $attributs) {
	echo &quot;&lt;select $attributs&gt;\n&quot;;
	if ($annee &lt; 1996) echo	my_sel($annee,$annee,$annee);
	for ($i=date(&quot;Y&quot;) - 1; $i &lt; date(&quot;Y&quot;) + 3; $i++) {
		echo my_sel($i,$i,$annee);
	}
	echo &quot;&lt;/select&gt;\n&quot;;
}

function afficher_jour($jour, $attributs){
	echo &quot;&lt;select $attributs&gt;\n&quot;;
	for($i=1;$i&lt;32;$i++){
		if ($i&lt;10){$aff=&quot;&nbsp;&quot;.$i;}else{$aff=$i;}
		echo my_sel($i,$aff,$jour);
	}
	echo &quot;&lt;/select&gt;\n&quot;;
}

function afficher_jour_mois_annee_h_m($date, $heures, $minutes, $suffixe='')
{
  afficher_jour(jour($date), &quot;name='jour$suffixe' size='1' class='fondl verdana1'&quot;);
  echo afficher_mois(mois($date), &quot;name='mois$suffixe' size='1' class='fondl verdana1'&quot;);
//  echo '&lt;br /&gt;';
 afficher_annee(annee($date), &quot;name='annee$suffixe' size='1' class='fondl verdana1'&quot;);

  echo &quot;&nbsp;  &lt;input type='text' class='fondl verdana1' name='heures$suffixe' value=\&quot;&quot;.$heures.&quot;\&quot; size='3'/&gt;&nbsp;&quot;.majuscules(_T('date_mot_heures')).&quot;&nbsp;&quot;,
    &quot;&lt;input type='text' class='fondl verdana1' name='minutes$suffixe' value=\&quot;$minutes\&quot; size='3'/&gt;&quot;;
}

function afficher_si_rdv($date_heure, $date_fin, $choix)
{
	global $spip_lang_rtl;

	$heures_debut = heures($date_heure);
	$minutes_debut = minutes($date_heure);
	$heures_fin = heures($date_fin);
	$minutes_fin = minutes($date_fin);
  
	if ($date_fin == &quot;0000-00-00 00:00:00&quot;) {
		$date_fin = $date_heure;
		$heures_fin = $heures_debut + 1;
	}
  
	if ($heures_fin &gt;=24){
		$heures_fin = 23;
		$minutes_fin = 59;
	}
			
	$res = &quot;&lt;div&gt;&lt;input type='radio' name='rv' value='non' id='rv_off'&quot; .
		(!$choix ? &quot;checked='checked' &quot; : '') .
		&quot; onclick=\&quot;changeVisible(this.checked, 'heure-rv', 'none', 'block');\&quot;/&gt;&quot; .
		&quot;&lt;label for='rv_off'&gt;&quot;.
		_T('item_non_afficher_calendrier').
		&quot;&lt;/label&gt;&quot;;
	echo ($choix  ? $res : &quot;&lt;b&gt;$res&lt;/b&gt;&quot;) . &quot;&lt;/div&gt;&quot;;

	$res = &quot;&lt;input type='radio' name='rv' value='oui' id='rv_on' &quot; .
		($choix ? &quot;checked='checked' &quot; : '') .
		&quot;onclick=\&quot;changeVisible(this.checked, 'heure-rv', 'block', 'none');\&quot;/&gt;&quot; . 
		&quot;&lt;label for='rv_on'&gt;&quot;.
		_T('item_afficher_calendrier').
		&quot;&lt;/label&gt;&quot;;
	echo '&lt;div&gt;' . (!$choix  ? $res : &quot;&lt;b&gt;$res&lt;/b&gt;&quot;) . '&lt;/div&gt;';
	
	$display = ($choix ? &quot;block&quot; : &quot;none&quot;);
	
	echo &quot;&lt;div id='heure-rv' style='display: $display; padding-top: 4px; padding-left: 24px;'&gt;&quot;;

	afficher_jour_mois_annee_h_m($date_heure, $heures_debut, $minutes_debut);

	echo &quot; &lt;br /&gt;&lt;img src='puce$spip_lang_rtl.gif' alt=' '/&gt; &nbsp; &quot;;
	afficher_jour_mois_annee_h_m($date_fin, $heures_fin, $minutes_fin, '_fin');
	echo &quot;&lt;/div&gt;&quot;;
}


if ($new == &quot;oui&quot;) {
	$mydate = date(&quot;YmdHis&quot;, time() - 2 * 24 * 3600);
	$query = &quot;DELETE FROM spip_messages WHERE (statut = 'redac') AND (date_heure &lt; $mydate)&quot;;
	$result = spip_query($query);

	if ($type == 'pb') $statut = 'publie';
	else $statut = 'redac';

	$id_message = spip_abstract_insert(&quot;messages&quot;,
				  &quot;(titre, date_heure, statut, type, id_auteur)&quot;, 
				  &quot;('&quot;.addslashes(filtrer_entites(_T('texte_nouveau_message'))).&quot;', NOW(), '$statut', '$type', $connect_id_auteur)&quot;);
	
	if ($rv) {
		spip_query(&quot;UPDATE spip_messages SET rv='oui', date_heure='$rv 12:00:00', date_fin= '$rv 13:00:00' WHERE id_message = $id_message&quot;);
	}

	if ($type != &quot;affich&quot;){
		spip_query(&quot;INSERT INTO spip_auteurs_messages (id_auteur,id_message,vu) VALUES ('$connect_id_auteur','$id_message','oui')&quot;);
		if ($dest) {
			spip_query(&quot;INSERT INTO spip_auteurs_messages (id_auteur,id_message,vu) VALUES ('$dest','$id_message','non')&quot;);
		}
		else if ($type == 'normal') $ajouter_auteur = true;
	}
	$onfocus = &quot; onfocus=\&quot;if(!antifocus){this.value='';antifocus=true;}\&quot;&quot;;
 }

$row = spip_fetch_array(spip_query(&quot;SELECT * FROM spip_messages WHERE id_message=$id_message&quot;));

$id_message = $row['id_message'];
$date_heure = $row[&quot;date_heure&quot;];
$date_fin = $row[&quot;date_fin&quot;];
$titre = entites_html($row[&quot;titre&quot;]);
$texte = entites_html($row[&quot;texte&quot;]);
$type = $row[&quot;type&quot;];
$statut = $row[&quot;statut&quot;];
$page = $row[&quot;page&quot;];
$rv = $row[&quot;rv&quot;];
$expediteur = $row[&quot;id_auteur&quot;];

debut_page(_T('titre_page_message_edit'), &quot;redacteurs&quot;, &quot;messagerie&quot;);

if (!($expediteur = $connect_id_auteur OR ($type == 'affich' AND $connect_statut == '0minirezo'))) die();

if ($type == 'normal') {
  $le_type = _T('bouton_envoi_message_02');
  $logo = &quot;message&quot;;
 }
if ($type == 'pb') {
  $le_type = _T('bouton_pense_bete');
  $logo = &quot;pense-bete&quot;;
 }
if ($type == 'affich') {
  $le_type = _T('bouton_annonce');
  $logo = &quot;annonce&quot;;
 }

echo &quot;&lt;form action='message.php3?id_message=$id_message' method='post'&gt;&quot;;

 debut_gauche();

debut_droite();

	echo &quot;&lt;div class='arial2'&gt;&quot;;
	echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size='2' color='green'&gt;&lt;b&gt;$le_type&lt;/b&gt;&lt;/font&gt;&lt;p&gt;&quot;;
	
	if ($type == &quot;affich&quot;)
		echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size='1' color='red'&gt;&quot;._T('texte_message_edit').&quot;&lt;/font&gt;&lt;/p&gt;&lt;p&gt;&quot;;
	

	echo &quot;&lt;input type='hidden' name='modifier_message' value='oui'/&gt;&quot;;
	echo &quot;&lt;input type='hidden' name='id_message' value='$id_message'/&gt;&quot;;
	echo &quot;&lt;input type='hidden' name='changer_rv' value='$id_message'/&gt;&quot;;
	echo _T('texte_titre_obligatoire').&quot;&lt;br /&gt;&quot;;
	echo &quot;&lt;input type='text' class='formo' name='titre' value=\&quot;$titre\&quot; size='40' $onfocus /&gt;&quot;;

	if ($ajouter_auteur) {
		echo &quot;&lt;/p&gt;&lt;p&gt;&lt;b&gt;&quot;._T('info_nom_destinataire').&quot;&lt;/b&gt;&lt;br /&gt;&quot;;
		echo &quot;&lt;input type='text' class='formo' name='cherche_auteur' value='' size='40'/&gt;&quot;;
	}

	echo &quot;&lt;p /&gt;&quot;;


	//////////////////////////////////////////////////////
	// Fixer rendez-vous?
	//
	if ($rv == &quot;oui&quot;) $fonction = &quot;rv.gif&quot;;	else $fonction = &quot;&quot;;
	debut_cadre_trait_couleur(&quot;$logo.gif&quot;, false, $fonction, _T('titre_rendez_vous'));
	afficher_si_rdv($date_heure, $date_fin, ($rv == &quot;oui&quot;)); 
	fin_cadre_trait_couleur();

	echo &quot;&lt;p&gt;&lt;b&gt;&quot;._T('info_texte_message_02').&quot;&lt;/b&gt;&lt;br /&gt;&quot;;
	echo &quot;&lt;textarea name='texte' rows='20' class='formo' cols='40'&gt;&quot;;
	echo $texte;
	echo &quot;&lt;/textarea&gt;&lt;/p&gt;&lt;br /&gt;\n&quot;;

	echo &quot;&lt;p align='right'&gt;&lt;input type='submit' name='valider' value='&quot;._T('bouton_valider').&quot;' class='fondo'/&gt;&lt;/p&gt;&quot;;
	echo &quot;&lt;/div&gt;&quot;;
	echo &quot;&lt;/form&gt;&quot;;

fin_page();

?&gt;

--- NEW FILE: inc_mail.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_MAIL&quot;)) return;
define(&quot;_ECRIRE_INC_MAIL&quot;, &quot;1&quot;);



//
// Infos de mails sur l'hebergeur (tout ca est assez sale)
//
global $hebergeur;
global $HTTP_X_HOST, $REQUEST_URI, $SERVER_NAME, $HTTP_HOST;
$hebergeur = '';

// Lycos (ex-Multimachin)
if ($HTTP_X_HOST == 'membres.lycos.fr') {
	$hebergeur = 'lycos';
}
// Altern
else if (ereg('altern\.com$', $SERVER_NAME)) {
	$hebergeur = 'altern';
}
// Free
else if (ereg('^/([^/]*)\.free.fr/', $REQUEST_URI, $regs)) {
	$hebergeur = 'free';
}
// NexenServices
else if ($SERVER_ADMIN == '<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">www at nexenservices.com</A>') {
	if (!function_exists('email'))
		include ('mail.inc');
	$hebergeur = 'nexenservices';
}
// Online
else if (function_exists('email')) {
	$hebergeur = 'online';
}


//
// Chez lyconiania, envoyer un mail coupe la connection MySQL (sic)
//

$GLOBALS['queue_mails'] = '';

function envoyer_queue_mails() {
	global $queue_mails;
	if (!$queue_mails) return;
	reset($queue_mails);
	while (list(, $val) = each($queue_mails)) {
		$email = $val['email'];
		$sujet = $val['sujet'];
		$texte = $val['texte'];
		$headers = $val['headers'];
		@mail($email, $sujet, $texte, $headers);
	}
}

if ($GLOBALS['hebergeur'] == 'lycos') {
	register_shutdown_function(envoyer_queue_mails);
}

function tester_mail() {
	global $hebergeur;
	$test_mail = true;
	if ($hebergeur == 'free') $test_mail = false;
	return $test_mail;
}

function envoyer_mail($email, $sujet, $texte, $from = &quot;&quot;, $headers = &quot;&quot;) {
	global $hebergeur, $queue_mails, $flag_wordwrap;
	include_ecrire(&quot;inc_filtres.php3&quot;);

	if (!$from) {
		$email_envoi = lire_meta(&quot;email_envoi&quot;);
		$from = email_valide($email_envoi) ? $email_envoi : $email;
	}
	if (!email_valide($email)) return false;
	if ($email == _T('info_mail_fournisseur')) return false; // tres fort

	spip_log(&quot;mail ($email): $sujet&quot;);

	$charset = lire_meta('charset');

	$headers = &quot;From: $from\n&quot;.
		&quot;MIME-Version: 1.0\n&quot;.
		&quot;Content-Type: text/plain; charset=$charset\n&quot;.
		&quot;Content-Transfer-Encoding: 8bit\n$headers&quot;;

	$texte = filtrer_entites($texte);
	$sujet = filtrer_entites($sujet);

	// fignoler ce qui peut l'etre...
	if ($charset &lt;&gt; 'utf-8') {
		$texte = str_replace(&quot;&#8217;&quot;, &quot;'&quot;, $texte);
		$sujet = str_replace(&quot;&#8217;&quot;, &quot;'&quot;, $sujet);
	}
	$texte = str_replace(&quot;&mdash;&quot;, &quot;--&quot;, $texte);
	$sujet = str_replace(&quot;&mdash;&quot;, &quot;--&quot;, $sujet);

	// encoder le sujet si possible selon la RFC
	if($GLOBALS['flag_multibyte'] AND @mb_internal_encoding($charset))
		$sujet = mb_encode_mimeheader($sujet, $charset, 'Q');

	if ($flag_wordwrap) $texte = wordwrap($texte);

	if (os_serveur == 'windows') {
		$texte = ereg_replace (&quot;\r*\n&quot;,&quot;\r\n&quot;, $texte);
		$headers = ereg_replace (&quot;\r*\n&quot;,&quot;\r\n&quot;, $headers);
	}

	switch($hebergeur) {
	case 'lycos':
		$queue_mails[] = array(
			'email' =&gt; $email,
			'sujet' =&gt; $sujet,
			'texte' =&gt; $texte,
			'headers' =&gt; $headers);
		return true;
	case 'free':
		return false;
	case 'online':
		return @email('webmaster', $email, $sujet, $texte);
	default:
		return @mail($email, $sujet, $texte, $headers);
	}
}

function extrait_article($row) {
	include_ecrire(&quot;inc_texte.php3&quot;);
	include_ecrire(&quot;inc_filtres.php3&quot;);

	$adresse_site = lire_meta(&quot;adresse_site&quot;);

	$id_article = $row[0];
	$titre = $row[2];
	$chapo = $row[6];
	$texte = $row[7];
	$date = $row[9];
	$statut = $row[10];

	$les_auteurs = &quot;&quot;;
 	$query = &quot;SELECT auteurs.* FROM spip_auteurs AS auteurs, spip_auteurs_articles AS lien WHERE lien.id_article=$id_article AND auteurs.id_auteur=lien.id_auteur&quot;;
	$result_auteurs = spip_query($query);

	while ($row = spip_fetch_array($result_auteurs)) {
		$nom_auteur = trim(supprimer_tags(typo($row['nom'])));

		if ($les_auteurs) $les_auteurs .= ', ';
		$les_auteurs .= $nom_auteur;
	}

	$extrait = &quot;** $titre **\n&quot;;
	if ($les_auteurs) $extrait .= _T('info_les_auteurs_1', array('les_auteurs' =&gt; $les_auteurs));
	if ($statut == 'publie') $extrait .= &quot; &quot;._T('date_fmt_nomjour_date', array('nomjour'=&gt;nom_jour($date), 'date'=&gt;affdate($date)));
	$extrait .= &quot;\n\n&quot;.textebrut(propre(couper_intro(&quot;$chapo&lt;p&gt;$texte&quot;, 700))).&quot;\n\n&quot;;
	if ($statut == 'publie') $extrait .= &quot;-&gt; &quot;.$adresse_site.&quot;/spip_redirect.php3?id_article=$id_article\n\n&quot;;
	return $extrait;
}


function nettoyer_titre_email($titre) {
	$titre = ereg_replace(&quot;\n&quot;, ' ', supprimer_tags($titre));
	return ($titre);
}

function envoyer_mail_publication($id_article) {
	global $connect_nom;
	$adresse_suivi = lire_meta(&quot;adresse_suivi&quot;);
	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
	$suivi_edito = lire_meta(&quot;suivi_edito&quot;);

	if ($suivi_edito == &quot;oui&quot;) {
		$query = &quot;SELECT * FROM spip_articles WHERE id_article = $id_article&quot;;
		$result = spip_query($query);

		if ($row = spip_fetch_array($result)) {

			// selectionne langue du site
			$lang_utilisateur = $GLOBALS['spip_lang'];
			changer_langue($GLOBALS['langue_site']);

			$titre = nettoyer_titre_email($row['titre']);

			$sujet = _T('info_publie_1', array('nom_site_spip' =&gt; $nom_site_spip, 'titre' =&gt; $titre));
			$courr = _T('info_publie_2').&quot;\n\n&quot;;
			$nom = trim(supprimer_tags(typo($connect_nom)));
			$courr .= _T('info_publie_01', array('titre' =&gt; $titre, 'connect_nom' =&gt; $nom)).&quot;\n\n\n&quot;;
			$courr = $courr . extrait_article($row);
			envoyer_mail($adresse_suivi, $sujet, $courr);

			// reinstalle la langue utilisateur (au cas ou)
			changer_langue($lang_utilisateur);
		}
	}
}

function envoyer_mail_proposition($id_article) {
	$adresse_suivi = lire_meta(&quot;adresse_suivi&quot;);
	$adresse_site = lire_meta(&quot;adresse_site&quot;);
	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
	$suivi_edito = lire_meta(&quot;suivi_edito&quot;);

	if ($suivi_edito == &quot;oui&quot;) {
		if ($row = spip_fetch_array(spip_query(&quot;SELECT * FROM spip_articles WHERE id_article = $id_article&quot;))) {
			$lang_utilisateur = $GLOBALS['spip_lang'];
			changer_langue($GLOBALS['langue_site']);

			$titre = nettoyer_titre_email($row['titre']);

			$sujet = _T('info_propose_1', array('nom_site_spip' =&gt; $nom_site_spip, 'titre' =&gt; $titre));
			envoyer_mail($adresse_suivi,
				     $sujet,
				     _T('info_propose_2')
				     .&quot;\n\n&quot; 
				     . _T('info_propose_3', array('titre' =&gt; $titre))
				     .&quot;\n&quot; 
				     . _T('info_propose_4')
				     .&quot;\n&quot; 
				     . _T('info_propose_5')
				     .&quot;\n&quot; 
				     . $adresse_site 
				     . '/' 
				     . _DIR_RESTREINT_ABS 
				     . &quot;articles.php3?id_article=$id_article\n\n\n&quot; 
				     . extrait_article($row));
			changer_langue($lang_utilisateur);
		}
	}
}

?&gt;

--- NEW FILE: inc_presentation.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_PRESENTATION&quot;)) return;
define(&quot;_ECRIRE_INC_PRESENTATION&quot;, &quot;1&quot;);

include_ecrire(&quot;inc_filtres.php3&quot;); # pour http_script (normalement d&#233;j&#224; fait)
include_ecrire (&quot;inc_lang.php3&quot;);
utiliser_langue_visiteur();

//
// Aide
//
function aide($aide='') {
	global $couleur_foncee, $spip_lang, $spip_lang_rtl, $spip_display;

	if (!$aide OR $spip_display == 4) return;

[...3346 lines suppressed...]
// produit une balise img avec un champ alt d'office (et different) si vide
// attention le htmlentities et la traduction doivent etre appliques avant.

function http_img_pack($img, $alt, $att) {
  static $num = 0;
  return &quot;&lt;img src='&quot; . _DIR_IMG_PACK . $img .
    (&quot;'\nalt=\&quot;&quot; . ($alt ? $alt : ('img_pack' . $num++)) . '&quot; ') .
    $att . &quot; /&gt;&quot;;
}

function http_style_background($img, $att='')
{
  return &quot; style='background: url(\&quot;&quot; . _DIR_IMG_PACK . $img .  '&quot;)' .
    ($att ? (' ' . $att) : '') . &quot;;'&quot;;
}

function http_href_img($href, $img, $att, $title='', $style='', $class='') {
 return  http_href($href, http_img_pack($img, $title, $att), $title, $style, $class);
}
?&gt;

--- NEW FILE: inc_urls.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_URLS&quot;)) return;
define(&quot;_ECRIRE_INC_URLS&quot;, &quot;1&quot;);


function generer_url_article($id_article) {
	if (($row = spip_fetch_array(spip_query(
	&quot;SELECT statut FROM spip_articles WHERE id_article=$id_article&quot;
	))) AND ($row['statut'] == 'publie'))
		return &quot;../spip_redirect.php3?id_article=$id_article&quot;;
	else
		return &quot;articles.php3?id_article=$id_article&quot;;
}

function generer_url_rubrique($id_rubrique) {
	if (($row = spip_fetch_array(spip_query(
	&quot;SELECT statut FROM spip_rubriques WHERE id_rubrique=$id_rubrique&quot;
	))) AND ($row['statut'] == 'publie'))
		return &quot;../spip_redirect.php3?id_rubrique=$id_rubrique&quot;;
	else
		return &quot;naviguer.php3?id_rubrique=$id_rubrique&quot;;
}

function generer_url_breve($id_breve) {
	if (($row = spip_fetch_array(spip_query(
	&quot;SELECT statut FROM spip_breves WHERE id_breve=$id_breve&quot;
	))) AND ($row['statut'] == 'publie'))
		return &quot;../spip_redirect.php3?id_breve=$id_breve&quot;;
	else
		return &quot;breves_voir.php3?id_breve=$id_breve&quot;;
}

function generer_url_forum($id_forum) {
	$url = &quot;../spip_redirect.php3?id_forum=$id_forum&quot;;
	return $url;
}

function generer_url_mot($id_mot) {
	$url = &quot;../spip_redirect.php3?id_mot=$id_mot&quot;;
	return $url;
}

function generer_url_auteur($id_auteur) {
	$url = &quot;../spip_redirect.php3?id_auteur=$id_auteur&quot;;
	return $url;
}

function generer_url_document($id_document) {
	if (intval($id_document) &lt;= 0)
		return '';
	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
		return &quot;../spip_acces_doc.php3?id_document=$id_document&quot;;
	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
		return '../' . ($row['fichier']);
	return '';
}

?&gt;

--- NEW FILE: statistiques_visites.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire(&quot;inc_statistiques.php3&quot;);

function http_img_rien($width, $height, $style='', $title='')
{
  return http_img_pack('rien.gif', $title, 
		       &quot;width='$width' height='$height'&quot; 
		       . (!$style ? '' : (&quot; style='$style'&quot;))
		       . (!$title ? '' : (&quot; title=\&quot;$title\&quot;&quot;)));
}

if ($id_article = intval($id_article)){
	$query = &quot;SELECT titre, visites, popularite FROM spip_articles WHERE statut='publie' AND id_article ='$id_article'&quot;;
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$titre = typo($row['titre']);
		$total_absolu = $row['visites'];
		$val_popularite = round($row['popularite']);
	}
} 
else {
	$query = &quot;SELECT SUM(visites) AS total_absolu FROM spip_visites&quot;;
	$result = spip_query($query);

	if ($row = spip_fetch_array($result)) {
		$total_absolu = $row['total_absolu'];
	}
}


if ($titre) $pourarticle = &quot; &quot;._T('info_pour').&quot; &laquo; $titre &raquo;&quot;;

if ($origine) {
	debut_page(_T('titre_page_statistiques_referers'), &quot;suivi&quot;, &quot;statistiques&quot;);
	echo &quot;&lt;br&gt;&lt;br&gt;&quot;;
	gros_titre(_T('titre_liens_entrants'));
	barre_onglets(&quot;statistiques&quot;, &quot;referers&quot;);

	debut_gauche();
	debut_boite_info();
	echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2&gt;&quot;;
	echo &quot;&lt;P align=left&gt;&quot;._T('info_gauche_statistiques_referers').&quot;&lt;/P&gt;&lt;/FONT&gt;&quot;;
	fin_boite_info();
	
	debut_droite();

}
else {
	debut_page(_T('titre_page_statistiques_visites').$pourarticle, &quot;suivi&quot;, &quot;statistiques&quot;);
	echo &quot;&lt;br&gt;&lt;br&gt;&quot;;
	gros_titre(_T('titre_evolution_visite').&quot;&lt;html&gt;&quot;.aide(&quot;confstat&quot;).&quot;&lt;/html&gt;&quot;);
//	barre_onglets(&quot;statistiques&quot;, &quot;evolution&quot;);
	if ($titre) gros_titre($titre);

	debut_gauche();

	echo &quot;&lt;p&gt;&quot;;

	echo &quot;&lt;div class='iconeoff' style='padding: 5px;'&gt;&quot;;
	echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
	echo typo(_T('info_afficher_visites'));
	echo &quot;&lt;ul&gt;&quot;;
	if ($id_article&gt;0) {
		echo &quot;&lt;li&gt;&lt;b&gt;&lt;a href='statistiques_visites.php3'&gt;&quot;._T('info_tout_site').&quot;&lt;/a&gt;&lt;/b&gt;&quot;;
	} else {
		echo &quot;&lt;li&gt;&lt;b&gt;&quot;._T('titre_page_articles_tous').&quot;&lt;/b&gt;&quot;;
	}

		echo &quot;&lt;/ul&gt;&quot;;
		echo &quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/div&gt;&quot;;

	
	// Par popularite
	$articles_recents[] = &quot;0&quot;;
	$query = &quot;SELECT id_article FROM spip_articles WHERE statut='publie' AND popularite &gt; 0 ORDER BY date DESC LIMIT 0,10&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$articles_recents[] = $row['id_article'];
	}
	$articles_recents = join($articles_recents, &quot;,&quot;);
		
	// Par popularite
	$query = &quot;SELECT id_article, titre, popularite, visites FROM spip_articles WHERE statut='publie' AND popularite &gt; 0 ORDER BY popularite DESC&quot;;
	$result = spip_query($query);

	$nombre_articles = spip_num_rows($result);
	if ($nombre_articles &gt; 0) {
		echo &quot;&lt;p&gt;&quot;;
		echo &quot;&lt;div class='iconeoff' style='padding: 5px;'&gt;&quot;;
		echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
		echo typo(_T('info_visites_plus_populaires'));
		echo &quot;&lt;ol style='padding-left:25 px;'&gt;&quot;;
		echo &quot;&lt;font size=1 color='#666666'&gt;&quot;;
		while ($row = spip_fetch_array($result)) {
			$titre = typo($row['titre']);
			$l_article = $row['id_article'];
			$visites = $row['visites'];
			$popularite = round($row['popularite']);
			$liste++;
			$classement[$l_article] = $liste;
			
			if ($liste &lt;= 30) {
				$articles_vus[] = $l_article;
			
				if ($l_article == $id_article){
					echo &quot;\n&lt;li value='$liste'&gt;&lt;b&gt;$titre&lt;/b&gt;&quot;;
				} else {
					echo &quot;\n&lt;li value='$liste'&gt;&lt;a href='statistiques_visites.php3?id_article=$l_article' title='&quot;._T('info_popularite', array('popularite' =&gt; $popularite, 'visites' =&gt; $visites)).&quot;'&gt;$titre&lt;/a&gt;&quot;;
				}
			}
		}
		$articles_vus = join($articles_vus, &quot;,&quot;);
			
		// Par popularite
		$query_suite = &quot;SELECT id_article, titre, popularite, visites FROM spip_articles WHERE statut='publie' AND id_article IN ($articles_recents) AND id_article NOT IN ($articles_vus) ORDER BY popularite DESC&quot;;
		$result_suite = spip_query($query_suite);
		
		if (spip_num_rows($result_suite) &gt; 0) {
			echo &quot;&lt;br&gt;&lt;br&gt;[...]&lt;br&gt;&lt;br&gt;&quot;;
			while ($row = spip_fetch_array($result_suite)) {
				$titre = typo($row['titre']);
				$l_article = $row['id_article'];
				$visites = $row['visites'];
				$popularite = round($row['popularite']);
				$numero = $classement[$l_article];
				
				if ($l_article == $id_article){
					echo &quot;\n&lt;li value='$numero'&gt;&lt;b&gt;$titre&lt;/b&gt;&lt;/li&gt;&quot;;
				} else {
					echo &quot;\n&lt;li value='$numero'&gt;&lt;a href='statistiques_visites.php3?id_article=$l_article' title='&quot;._T('info_popularite_3', array('popularite' =&gt; $popularite, 'visites' =&gt; $visites)).&quot;'&gt;$titre&lt;/a&gt;&lt;/li&gt;&quot;;
				}
			}
		}
			
		echo &quot;&lt;/ol&gt;&quot;;

		echo &quot;&lt;b&gt;&quot;._T('info_comment_lire_tableau').&quot;&lt;/b&gt;&lt;br&gt;&quot;._T('texte_comment_lire_tableau');

		echo &quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/div&gt;&quot;;
	}


	// Par visites depuis le debut
	$query = &quot;SELECT id_article, titre, popularite, visites FROM spip_articles WHERE statut='publie' AND popularite &gt; 0 ORDER BY visites DESC LIMIT 0,30&quot;;
	$result = spip_query($query);
		
	if (spip_num_rows($result) &gt; 0) {
		creer_colonne_droite();

		echo &quot;&lt;p&gt;&lt;/p&gt;&lt;div class='iconeoff' style='padding: 5px;'&gt;&quot;;
		echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
		echo typo(_T('info_affichier_visites_articles_plus_visites'));
		echo &quot;&lt;ol style='padding-left:25 px;'&gt;&quot;;
		echo &quot;&lt;font size=1 color='#666666'&gt;&quot;;

		while ($row = spip_fetch_array($result)) {
			$titre = typo($row['titre']);
			$l_article = $row['id_article'];
			$visites = $row['visites'];
			$popularite = round($row['popularite']);
				$numero = $classement[$l_article];
				
				if ($l_article == $id_article){
					echo &quot;\n&lt;li value='$numero'&gt;&lt;b&gt;$titre&lt;/b&gt;&lt;/li&gt;&quot;;
				} else {
					echo &quot;\n&lt;li value='$numero'&gt;&lt;a href='statistiques_visites.php3?id_article=$l_article' title='&quot;._T('info_popularite_4', array('popularite' =&gt; $popularite, 'visites' =&gt; $visites)).&quot;'&gt;$titre&lt;/a&gt;&lt;/li&gt;&quot;;
				}
		}
		echo &quot;&lt;/ol&gt;&quot;;
		echo &quot;&lt;/font&gt;&quot;;
	
		echo &quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/div&gt;&quot;;
	}


	//
	// Afficher les boutons de creation d'article et de breve
	//
	if ($connect_statut == '0minirezo') {
		if ($id_article &gt; 0) {
			debut_raccourcis();
			icone_horizontale(_T('icone_retour_article'), &quot;articles.php3?id_article=$id_article&quot;, &quot;article-24.gif&quot;,&quot;rien.gif&quot;);
			fin_raccourcis();
		}
	}



	debut_droite();
}



if ($connect_statut != '0minirezo') {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}




//////

if (!$aff_jours) $aff_jours = 105;

if (!$origine) {




	if ($id_article) {
		$table = &quot;spip_visites_articles&quot;;
		$table_ref = &quot;spip_referers_articles&quot;;
		$where = &quot;id_article=$id_article&quot;;
	} else {
		$table = &quot;spip_visites&quot;;
		$table_ref = &quot;spip_referers&quot;;
		$where = &quot;1&quot;;
	}
	
	$query=&quot;SELECT UNIX_TIMESTAMP(date) AS date_unix FROM $table &quot;.
		&quot;WHERE $where ORDER BY date LIMIT 0,1&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$date_premier = $row['date_unix'];
	}

	$query=&quot;SELECT UNIX_TIMESTAMP(date) AS date_unix, visites FROM $table &quot;.
		&quot;WHERE $where AND date &gt; DATE_SUB(NOW(),INTERVAL $aff_jours DAY) ORDER BY date&quot;;
	$result=spip_query($query);

	while ($row = spip_fetch_array($result)) {
		$date = $row['date_unix'];
		$visites = $row['visites'];

		$log[$date] = $visites;
		if ($i == 0) $date_debut = $date;
		$i++;
	}

	// Visites du jour
	if ($id_article) {
		$query = &quot;SELECT COUNT(DISTINCT ip) AS visites FROM spip_visites_temp WHERE type = 'article' AND id_objet = $id_article&quot;;
		$result = spip_query($query);
	} else {
		$query = &quot;SELECT COUNT(DISTINCT ip) AS visites FROM spip_visites_temp&quot;;
		$result = spip_query($query);
	}
	if ($row = @spip_fetch_array($result))
		$visites_today = $row['visites'];
	else
		$visites_today = 0;

	if (count($log)&gt;0) {
		$max = max(max($log),$visites_today);
		$date_today = time();
		$nb_jours = floor(($date_today-$date_debut)/(3600*24));
		
		$maxgraph = substr(ceil(substr($max,0,2) / 10).&quot;000000000000&quot;, 0, strlen($max));
	
		if ($maxgraph &lt; 10) $maxgraph = 10;
		if (1.1 * $maxgraph &lt; $max) $maxgraph.=&quot;0&quot;;	
		if (0.8*$maxgraph &gt; $max) $maxgraph = 0.8 * $maxgraph;
		$rapport = 200 / $maxgraph;

		if (count($log) &lt; 420) $largeur = floor(450 / ($nb_jours+1));
		if ($largeur &lt; 1) {
			$largeur = 1;
			$agreg = ceil(count($log) / 420);	
		} else {
			$agreg = 1;
		}
		if ($largeur &gt; 50) $largeur = 50;

		debut_cadre_relief(&quot;statistiques-24.gif&quot;);
		
		
		$largeur_abs = 420 / $aff_jours;
		
		if ($largeur_abs &gt; 1) {
			$inc = ceil($largeur_abs / 5);
			$aff_jours_plus = 420 / ($largeur_abs - $inc);
			$aff_jours_moins = 420 / ($largeur_abs + $inc);
		}
		
		if ($largeur_abs == 1) {
			$aff_jours_plus = 840;
			$aff_jour_moins = 210;
		}
		
		if ($largeur_abs &lt; 1) {
			$aff_jours_plus = 420 * ((1/$largeur_abs) + 1);
			$aff_jours_moins = 420 * ((1/$largeur_abs) - 1);
		}
		
//		$aff_jours_plus = round($aff_jours * 1.5);		
//		$aff_jours_moins = round($aff_jours / 1.5);
		
		
		
		if ($id_article) $pour_article=&quot;&amp;id_article=$id_article&quot;;
		
		if ($date_premier &lt; $date_debut)
		  echo http_href_img(&quot;statistiques_visites.php3?aff_jours=$aff_jours_plus$pour_article&quot;,
				     'loupe-moins.gif',
				     &quot;border='0' valign='center'&quot;,
				     _L('zoom'). '-'), &quot;&nbsp;&quot;;
		if ( (($date_today - $date_debut) / (24*3600)) &gt; 30)
		  echo http_href_img(&quot;statistiques_visites.php3?aff_jours=$aff_jours_moins$pour_article&quot;, 
				     'loupe-plus.gif',
				     &quot;border='0' valign='center'&quot;,
				     _L('zoom'). '+'), &quot;&nbsp;&quot;;
	
		/*
		if ($spip_svg_plugin == 'oui') {
			echo &quot;&lt;div&gt;&quot;;
			echo &quot;&lt;object data='statistiques_svg.php3?id_article=$id_article&amp;aff_jours=$aff_jours' width='450' height='310' type='image/svg+xml'&gt;&quot;;
			echo &quot;&lt;embed src='statistiques_svg.php3?id_article=$id_article&amp;aff_jours=$aff_jours'  width='450' height='310' type='image/svg+xml' /&gt;&quot;;
			echo &quot;&lt;/object&gt;&quot;;
			echo &quot;&lt;/div&gt;&quot;;
		} 
		else {
		*/
			echo &quot;&lt;table cellpadding=0 cellspacing=0 border=0&gt;&lt;tr&gt;&quot;,
			  &quot;&lt;td background='&quot;, _DIR_IMG_PACK, &quot;fond-stats.gif'&gt;&quot;;
			echo &quot;&lt;table cellpadding=0 cellspacing=0 border=0&gt;&lt;tr&gt;&quot;;
	
			echo &quot;&lt;td bgcolor='black'&gt;&quot;, http_img_rien(1,200), &quot;&lt;/td&gt;&quot;;
	
			// Presentation graphique
			while (list($key, $value) = each($log)) {
				
				$test_agreg ++;
		
				if ($test_agreg == $agreg) {	
				
				$test_agreg = 0;
				$n++;
			
				if ($decal == 30) $decal = 0;
				$decal ++;
				$tab_moyenne[$decal] = $value;
			
				// Inserer des jours vides si pas d'entrees	
				if ($jour_prec &gt; 0) {
					$ecart = floor(($key-$jour_prec)/((3600*24)*$agreg)-1);
		
					for ($i=0; $i &lt; $ecart; $i++){
						if ($decal == 30) $decal = 0;
						$decal ++;
						$tab_moyenne[$decal] = $value;
	
						$ce_jour=date(&quot;Y-m-d&quot;, $jour_prec+(3600*24*($i+1)));
						$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
	
						reset($tab_moyenne);
						$moyenne = 0;
						while (list(,$val_tab) = each($tab_moyenne))
							$moyenne += $val_tab;
						$moyenne = $moyenne / count($tab_moyenne);
		
						$hauteur_moyenne = round(($moyenne) * $rapport) - 1;
						echo &quot;&lt;td valign='bottom' width=$largeur&gt;&quot;;
						$difference = ($hauteur_moyenne) -1;
						$moyenne = round($moyenne,2); // Pour affichage harmonieux
						$tagtitle= attribut_html(supprimer_tags(&quot;$jour | &quot;
						._T('info_visites').&quot; | &quot;
						._T('info_moyenne').&quot; $moyenne&quot;));
						if ($difference &gt; 0) {	
						  echo http_img_rien($largeur,1, 'background-color:#333333;', $tagtitle);
						  echo http_img_rien($largeur, $hauteur_moyenne, '', $tagtitle);
						}
						echo 
						    http_img_rien($largeur,1,'background-color:black;', $tagtitle);
						echo &quot;&lt;/td&gt;&quot;;
						$n++;
					}
				}
	
				$ce_jour=date(&quot;Y-m-d&quot;, $key);
				$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);
	
				$total_loc = $total_loc + $value;
				reset($tab_moyenne);
	
				$moyenne = 0;
				while (list(,$val_tab) = each($tab_moyenne))
					$moyenne += $val_tab;
				$moyenne = $moyenne / count($tab_moyenne);
			
				$hauteur_moyenne = round($moyenne * $rapport) - 1;
				$hauteur = round($value * $rapport) - 1;
				$moyenne = round($moyenne,2); // Pour affichage harmonieux
				echo &quot;&lt;td valign='bottom' width=$largeur&gt;&quot;;
	
				$tagtitle= attribut_html(supprimer_tags(&quot;$jour | &quot;
				._T('info_visites').&quot; &quot;.$value));
	
				if ($hauteur &gt; 0){
					if ($hauteur_moyenne &gt; $hauteur) {
						$difference = ($hauteur_moyenne - $hauteur) -1;
						echo http_img_rien($largeur, 1,'background-color:#333333;',$tagtitle);
						echo http_img_rien($largeur, $difference, '', $tagtitle);
						echo http_img_rien($largeur,1, &quot;background-color:$couleur_foncee;&quot;, $tagtitle);
						if (date(&quot;w&quot;,$key) == &quot;0&quot;) // Dimanche en couleur foncee
						  echo http_img_rien($largeur, $hauteur, &quot;background-color:$couleur_foncee;&quot;, $tagtitle);
						else
						  echo http_img_rien($largeur,$hauteur, &quot;background-color:$couleur_claire;&quot;, $tagtitle);
					} else if ($hauteur_moyenne &lt; $hauteur) {
						$difference = ($hauteur - $hauteur_moyenne) -1;
						echo http_img_rien($largeur,1,&quot;background-color:$couleur_foncee;&quot;, $tagtitle);
						if (date(&quot;w&quot;,$key) == &quot;0&quot;) // Dimanche en couleur foncee
							$couleur =  $couleur_foncee;
						else
							$couleur = $couleur_claire;
						echo http_img_rien($largeur, $difference, &quot;background-color:$couleur;&quot;, $tagtitle);
						echo http_img_rien($largeur,1,&quot;background-color:#333333;&quot;, $tagtitle);
						echo http_img_rien($largeur, $hauteur_moyenne, &quot;background-color:$couleur;&quot;, $tagtitle);
					} else {
					  echo http_img_rien($largeur, 1, &quot;background-color:$couleur_foncee;&quot;, $tagtitle);
						if (date(&quot;w&quot;,$key) == &quot;0&quot;) // Dimanche en couleur foncee
						  echo http_img_rien($largeur, $hauteur, &quot;background-color:$couleur_foncee;&quot;, $tagtitle);
						else
						  echo http_img_rien($largeur,$hauteur, &quot;background-color:$couleur_claire;&quot;, $tagtitle);
					}
				}
				echo http_img_rien($largeur, 1, 'background-color:black;', $tagtitle);
				echo &quot;&lt;/td&gt;\n&quot;;
			
				$jour_prec = $key;
				$val_prec = $value;
			}
			}
	
			// Dernier jour
			$hauteur = round($visites_today * $rapport)	- 1;
			$total_absolu = $total_absolu + $visites_today;
			echo &quot;&lt;td valign='bottom' width=$largeur&gt;&quot;;
			if ($hauteur &gt; 0){
			  echo http_img_rien($largeur, 1, &quot;background-color:$couleur_foncee;&quot;);
	
				// prevision de visites jusqu'a minuit
				// basee sur la moyenne (site) ou popularite (article)
				if (! $id_article) $val_popularite = $moyenne;
				$prevision = (1 - (date(&quot;H&quot;)*60 - date(&quot;i&quot;))/(24*60)) * $val_popularite;
				$hauteurprevision = ceil($prevision * $rapport);
				$prevision = round($prevision,0)+$visites_today; // Pour affichage harmonieux
#				$tagtitle= attribut_html(supprimer_tags(_T('info_aujourdhui').&quot; $visites_today &rarr; $prevision&quot;));
				echo http_img_rien($largeur, $hauteurprevision,'background-color:#eeeeee;', $tagtitle);
	
				echo http_img_rien($largeur, $hauteur, 'background-color:#cccccc;', $tagtitle);
			}
			echo http_img_rien($largeur, 1, 'background-color:black;');
			echo &quot;&lt;/td&gt;&quot;;
		
			echo &quot;&lt;td bgcolor='black'&gt;&quot;,http_img_rien(1, 1),&quot;&lt;/td&gt;&quot;;
			echo &quot;&lt;/tr&gt;&lt;/table&gt;&quot;;
			echo &quot;&lt;/td&gt;&quot;,
			  &quot;&lt;td background='&quot;, _DIR_IMG_PACK, &quot;fond-stats.gif' valign='bottom'&gt;&quot;, http_img_rien(3, 1, 'background-color:black;'),&quot;&lt;/td&gt;&quot;;
			echo &quot;&lt;td&gt;&quot;, http_img_rien(5, 1),&quot;&lt;/td&gt;&quot;;
			echo &quot;&lt;td valign='top'&gt;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
			echo &quot;&lt;table cellpadding=0 cellspacing=0 border=0&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=15 valign='top'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&lt;b&gt;&quot;.round($maxgraph).&quot;&lt;/b&gt;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(7*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&quot;.round(3*($maxgraph/4)).&quot;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(5*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&lt;b&gt;&quot;.round($maxgraph/2).&quot;&lt;/b&gt;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(3*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&quot;.round($maxgraph/4).&quot;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(1*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			echo &quot;&lt;tr&gt;&lt;td height=10 valign='bottom'&gt;&quot;;		
			echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&lt;b&gt;0&lt;/b&gt;&lt;/font&gt;&quot;;
			echo &quot;&lt;/td&gt;&quot;;
			
			
			echo &quot;&lt;/table&gt;&quot;;
			echo &quot;&lt;/font&gt;&lt;/td&gt;&quot;;
			echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
			
			echo &quot;&lt;div style='position: relative; height: 15px;'&gt;&quot;;
			$gauche_prec = -50;
			for ($jour = $date_debut; $jour &lt;= $date_today; $jour = $jour + (24*3600)) {
				$ce_jour = date(&quot;d&quot;, $jour);
				
				if ($ce_jour == &quot;1&quot;) {
					$afficher = nom_mois(date(&quot;Y-m-d&quot;, $jour));
					if (date(&quot;m&quot;, $jour) == 1) $afficher = &quot;&lt;b&gt;&quot;.annee(date(&quot;Y-m-d&quot;, $jour)).&quot;&lt;/b&gt;&quot;;
					
				
					$gauche = ($jour - $date_debut) * $largeur / ((24*3600)*$agreg);
					
					if ($gauche - $gauche_prec &gt;= 40 OR date(&quot;m&quot;, $jour) == 1) {									
						echo &quot;&lt;div class='arial0' style='border-$spip_lang_left: 1px solid black; padding-$spip_lang_left: 2px; padding-top: 3px; position: absolute; $spip_lang_left: &quot;.$gauche.&quot;px; top: -1px;'&gt;&quot;.$afficher.&quot;&lt;/div&gt;&quot;;
						$gauche_prec = $gauche;
					}
				}
			}
			echo &quot;&lt;/div&gt;&quot;;
			
		//}
				
				
		$moyenne =  round($total_absolu / ((date(&quot;U&quot;)-$date_premier)/(3600*24)));

		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&quot;._T('texte_statistiques_visites').&quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;p&gt;&lt;table cellpadding=0 cellspacing=0 border=0 width='100%'&gt;&lt;tr width='100%'&gt;&quot;;
		echo &quot;&lt;td valign='top' width='33%'&gt;&lt;font face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
		echo _T('info_maximum').&quot; &quot;.$max;
		echo &quot;&lt;br&gt;&quot;._T('info_moyenne').&quot; &quot;.round($moyenne);
		echo &quot;&lt;/td&gt;&quot;;
		echo &quot;&lt;td valign='top' width='33%'&gt;&lt;font face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
		echo _T('info_aujourdhui').' '.$visites_today;
		if ($val_prec &gt; 0) echo &quot;&lt;br&gt;&quot;._T('info_hier').' '.$val_prec;
		if ($id_article) echo &quot;&lt;br&gt;&quot;._T('info_popularite_5').' '.$val_popularite;

		echo &quot;&lt;/td&gt;&quot;;
		echo &quot;&lt;td valign='top' width='33%'&gt;&lt;font face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
		echo &quot;&lt;b&gt;&quot;._T('info_total').&quot; &quot;.$total_absolu.&quot;&lt;/b&gt;&quot;;
		
		if ($id_article) {
			if ($classement[$id_article] &gt; 0) {
				if ($classement[$id_article] == 1)
				      $ch = _T('info_classement_1', array('liste' =&gt; $liste));
				else
				      $ch = _T('info_classement_2', array('liste' =&gt; $liste));
				echo &quot;&lt;br&gt;&quot;.$classement[$id_article].$ch;
			}
		} else {
			echo &quot;&lt;font size=1&gt;&quot;;
			echo &quot;&lt;br&gt;&quot;._T('info_popularite_2').&quot; &quot;;
			echo ceil(lire_meta('popularite_total'));
			echo &quot;&lt;/font&gt;&quot;;
		}
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;	
	}		
	
	if (count($log) &gt; 60) {
		echo &quot;&lt;p&gt;&quot;;
		echo &quot;&lt;font face='verdana,arial,helvetica,sans-serif' size='2'&gt;&lt;b&gt;&quot;._T('info_visites_par_mois').&quot;&lt;/b&gt;&lt;/font&gt;&quot;;

		echo &quot;&lt;div align='left'&gt;&quot;;
		///////// Affichage par mois
		$query=&quot;SELECT FROM_UNIXTIME(UNIX_TIMESTAMP(date),'%Y-%m') AS date_unix, SUM(visites) AS total_visites  FROM $table &quot;.
			&quot;WHERE $where AND date &gt; DATE_SUB(NOW(),INTERVAL 2700 DAY) GROUP BY date_unix ORDER BY date&quot;;
		$result=spip_query($query);
		
		$i = 0;
		while ($row = spip_fetch_array($result)) {
			$date = $row['date_unix'];
			$visites = $row['total_visites'];
			$i++;
			$entrees[&quot;$date&quot;] = $visites;
		}
		
		if (count($entrees)&gt;0){
		
			$max = max($entrees);
			$maxgraph = substr(ceil(substr($max,0,2) / 10).&quot;000000000000&quot;, 0, strlen($max));
			
			if ($maxgraph &lt; 10) $maxgraph = 10;
			if (1.1 * $maxgraph &lt; $max) $maxgraph.=&quot;0&quot;;	
			if (0.8*$maxgraph &gt; $max) $maxgraph = 0.8 * $maxgraph;
			$rapport = 200 / $maxgraph;
	
			$largeur = floor(420 / (count($entrees)));
			if ($largeur &lt; 1) $largeur = 1;
			if ($largeur &gt; 50) $largeur = 50;
		}
		
		echo &quot;&lt;table cellpadding=0 cellspacing=0 border=0&gt;&lt;tr&gt;&quot;,
		  &quot;&lt;td background='&quot;, _DIR_IMG_PACK, &quot;fond-stats.gif'&gt;&quot;;
		echo &quot;&lt;table cellpadding=0 cellspacing=0 border=0&gt;&lt;tr&gt;&quot;;
		echo &quot;&lt;td bgcolor='black'&gt;&quot;, http_img_rien(1, 200),&quot;&lt;/td&gt;&quot;;
	
		// Presentation graphique
		$n = 0;
		$decal = 0;
		$tab_moyenne = &quot;&quot;;
			
		while (list($key, $value) = each($entrees)) {
			$n++;
			
			$mois = affdate_mois_annee($key);

			if ($decal == 30) $decal = 0;
			$decal ++;
			$tab_moyenne[$decal] = $value;
			
			$total_loc = $total_loc + $value;
			reset($tab_moyenne);
	
			$moyenne = 0;
			while (list(,$val_tab) = each($tab_moyenne))
				$moyenne += $val_tab;
			$moyenne = $moyenne / count($tab_moyenne);
			
			$hauteur_moyenne = round($moyenne * $rapport) - 1;
			$hauteur = round($value * $rapport) - 1;
			echo &quot;&lt;td valign='bottom' width=$largeur&gt;&quot;;

			$tagtitle= attribut_html(supprimer_tags(&quot;$mois | &quot;
			._T('info_visites').&quot; &quot;.$value));

			if ($hauteur &gt; 0){
				if ($hauteur_moyenne &gt; $hauteur) {
					$difference = ($hauteur_moyenne - $hauteur) -1;
					echo http_img_rien($largeur, 1, 'background-color:#333333;');
					echo http_img_rien($largeur, $difference, '', $tagtitle);
					echo http_img_rien($largeur,1,&quot;background-color:$couleur_foncee;&quot;);
					if (ereg(&quot;-01&quot;,$key)){ // janvier en couleur foncee
					  echo http_img_rien($largeur,$hauteur,&quot;background-color:$couleur_foncee;&quot;, $tagtitle);
					} 
					else {
					  echo http_img_rien($largeur,$hauteur,&quot;background-color:$couleur_claire;&quot;, $tagtitle);
					}
				}
				else if ($hauteur_moyenne &lt; $hauteur) {
					$difference = ($hauteur - $hauteur_moyenne) -1;
					echo http_img_rien($largeur,1,&quot;background-color:$couleur_foncee;&quot;, $tagtitle);
					if (ereg(&quot;-01&quot;,$key)){ // janvier en couleur foncee
						$couleur =  $couleur_foncee;
					} 
					else {
						$couleur = $couleur_claire;
					}
					echo http_img_rien($largeur,$difference, &quot;background-color:$couleur;&quot;, $tagtitle);
					echo http_img_rien($largeur,1,'background-color:#333333;',$tagtitle);
					echo http_img_rien($largeur,$hauteur_moyenne,&quot;background-color:$couleur;&quot;, $tagtitle);
				}
				else {
				  echo http_img_rien($largeur,1,&quot;background-color:$couleur_foncee;&quot;, $tagtitle);
					if (ereg(&quot;-01&quot;,$key)){ // janvier en couleur foncee
					  echo http_img_rien($largeur, $hauteur, &quot;background-color:$couleur_foncee;&quot;, $tagtitle);
					} 
					else {
					  echo http_img_rien($largeur,$hauteur, &quot;background-color:$couleur_claire;&quot;, $tagtitle);
					}
				}
			}
			echo http_img_rien($largeur,1,'background-color:black;', $tagtitle);
			echo &quot;&lt;/td&gt;\n&quot;;
			
			$jour_prec = $key;
			$val_prec = $value;
		}
		
		echo &quot;&lt;td bgcolor='black'&gt;&quot;, http_img_rien(1, 1),&quot;&lt;/td&gt;&quot;;
		echo &quot;&lt;/tr&gt;&lt;/table&gt;&quot;;
		echo &quot;&lt;/td&gt;&quot;,
		  &quot;&lt;td background='&quot;, _DIR_IMG_PACK, &quot;fond-stats.gif' valign='bottom'&gt;&quot;, http_img_rien(3, 1, 'background-color:black;'),&quot;&lt;/td&gt;&quot;;
		echo &quot;&lt;td&gt;&quot;, http_img_rien(5, 1),&quot;&lt;/td&gt;&quot;;
		echo &quot;&lt;td valign='top'&gt;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
		echo &quot;&lt;table cellpadding=0 cellspacing=0 border=0&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=15 valign='top'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&lt;b&gt;&quot;.round($maxgraph).&quot;&lt;/b&gt;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(7*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&quot;.round(3*($maxgraph/4)).&quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(5*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&lt;b&gt;&quot;.round($maxgraph/2).&quot;&lt;/b&gt;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(3*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&quot;.round($maxgraph/4).&quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=25 valign='middle'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1 color='#999999'&gt;&quot;.round(1*($maxgraph/8)).&quot;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
		echo &quot;&lt;tr&gt;&lt;td height=10 valign='bottom'&gt;&quot;;		
		echo &quot;&lt;font face='arial,helvetica,sans-serif' size=1&gt;&lt;b&gt;0&lt;/b&gt;&lt;/font&gt;&quot;;
		echo &quot;&lt;/td&gt;&quot;;

		echo &quot;&lt;/tr&gt;&lt;/table&gt;&quot;;
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
		echo &quot;&lt;/div&gt;&quot;;
	}
	
	/////
		
	fin_cadre_relief();

}



//
// Affichage des referers
//

// nombre de referers a afficher
$limit = intval($limit);	//secu
if ($limit == 0)
	$limit = 100;

// afficher quels referers ?
$vis = &quot;visites&quot;;
if ($origine) {
	$where = &quot;visites_jour&gt;0&quot;;
	$vis = &quot;visites_jour&quot;;
	$table_ref = &quot;spip_referers&quot;;
}

$query = &quot;SELECT referer, $vis AS vis FROM $table_ref WHERE $where ORDER BY $vis DESC&quot;;


echo &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;
gros_titre(_T(&quot;onglet_origine_visites&quot;));

echo &quot;&lt;p&gt;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
echo aff_referers ($query, $limit);
echo &quot;&lt;/font&gt;&lt;/p&gt;&quot;;	

echo &quot;&lt;/font&gt;&quot;;

fin_page();

?&gt;

--- NEW FILE: export.php3 ---
&lt;?php

include (&quot;inc_version.php3&quot;);

include_ecrire (&quot;inc_auth.php3&quot;);
include_ecrire (&quot;inc_export.php3&quot;);
include_ecrire (&quot;inc_admin.php3&quot;);
include_ecrire (&quot;inc_presentation.php3&quot;);

// Liste un sommaire d'objets de n'importe quel type
// a la condition d'etre publics et plus recents que $maj
function liste_objets($result, $type) {
	global $maj;
	global $articles;
	if ($result) while ($row = spip_fetch_array($result)) {
		$t_id = $row[&quot;id_$type&quot;];
		$t_statut = $row[&quot;statut&quot;];
		$t_maj = mysql_timestamp_to_time($row[&quot;maj&quot;]);
		if ($t_maj &gt; $maj &amp;&amp; (!$t_statut || $t_statut == &quot;publie&quot;)) {
			echo &quot;$type $t_id $t_maj\n&quot;;
			if ($type == &quot;article&quot;) $articles[]=$t_id;
		}
	}
	spip_free_result($result);
}

// Liste un sommaire recursif de rubriques
// a condition que la mise a jour soit plus recente que $maj
function liste_rubriques($result) {
	global $maj;
	global $rubriques;
	if ($result) while ($row=spip_fetch_array($result)) {
		$id_rubrique = $row['id_rubrique'];
		$id_parent = $row['id_parent'];
		$titre = $row['titre'];
		$descriptif = $row['descriptif'];
		$texte = $row['texte'];
		$rubrique_maj = mysql_timestamp_to_time($row[&quot;maj&quot;]);
		if ($rubrique_maj &gt; $maj) {
			echo &quot;rubrique $id_rubrique $rubrique_maj\n&quot;;
		}
		$t_rubriques[] = $id_rubrique;
	}
	spip_free_result($result);
 	if ($t_rubriques) {
 		$t_rubriques = join(&quot;,&quot;, $t_rubriques);
 		$rubriques[] = $t_rubriques;
 		$query = &quot;SELECT * FROM spip_rubriques WHERE id_parent IN ($t_rubriques)&quot;;
		liste_rubriques(spip_query($query));
	}
}



Header(&quot;Content-Type: text/plain&quot;);

if ($id_rubrique)
	$query=&quot;SELECT * FROM spip_rubriques WHERE id_rubrique='$id_rubrique'&quot;;
else
	$query=&quot;SELECT * FROM spip_rubriques WHERE id_parent=0&quot;;

liste_rubriques(spip_query($query));

if ($rubriques) {
	$rubriques = join(&quot;,&quot;, $rubriques);

	$query = &quot;SELECT id_article, statut, maj FROM spip_articles WHERE id_rubrique IN ($rubriques)&quot;;
	liste_objets(spip_query($query), &quot;article&quot;);

	$query = &quot;SELECT id_breve, statut, maj FROM spip_breves WHERE id_rubrique IN ($rubriques)&quot;;
	liste_objets(spip_query($query), &quot;breve&quot;);

	if ($articles) {
		$articles = join(&quot;,&quot;, $articles);

		$query = &quot;SELECT DISTINCT spip_auteurs.id_auteur, maj FROM spip_auteurs, spip_auteurs_articles AS lien WHERE id_article IN ($articles) AND spip_auteurs.id_auteur=lien.id_auteur&quot;;
		liste_objets(spip_query($query), &quot;auteur&quot;);
	}
}


exit;

?&gt;
--- NEW FILE: forum_admin.php3 ---
&lt;?php

$admin = 'oui';
include ('forum.php3');

?&gt;


--- NEW FILE: inc_auth_spip.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_AUTH_SPIP&quot;)) return;
define(&quot;_ECRIRE_INC_AUTH_SPIP&quot;, &quot;1&quot;);

class Auth_spip {
	var $nom, $login, $email, $md5pass, $md5next, $alea_futur, $statut;

	function init() {
		return true;
	}

	// Verification du mot passe crypte (javascript)
	function verifier_challenge_md5($login, $mdpass_actuel, $mdpass_futur) {
		// Interdire mot de passe vide
		if ($mdpass_actuel == '') return false;

		$query = &quot;SELECT * FROM spip_auteurs WHERE login='&quot;.addslashes($login).&quot;' AND pass='&quot;.addslashes($mdpass_actuel).&quot;' AND statut&lt;&gt;'5poubelle'&quot;;
		$result = spip_query($query);

		if ($row = spip_fetch_array($result)) {
			$this-&gt;nom = $row['nom'];
			$this-&gt;login = $row['login'];
			$this-&gt;email = $row['email'];
			$this-&gt;statut = $row['statut'];
			$this-&gt;md5pass = $mdpass_actuel;
			$this-&gt;md5next = $mdpass_futur;
			return true;
		}
		return false;
	}

	// Verification du mot passe en clair (sans javascript)
	function verifier($login, $pass) {
		// Interdire mot de passe vide
		if ($pass == '') return false;

		$query = &quot;SELECT alea_actuel, alea_futur FROM spip_auteurs WHERE login='&quot;.addslashes($login).&quot;'&quot;;
		$result = spip_query($query);
		if ($row = spip_fetch_array($result)) {
			$md5pass = md5($row['alea_actuel'] . $pass);
			$md5next = md5($row['alea_futur'] . $pass);
			return $this-&gt;verifier_challenge_md5($login, $md5pass, $md5next);
		}
		return false;
	}

	function lire() {
		return true;
	}

	function activer() {
		if ($this-&gt;statut == 'nouveau') { // nouvel inscrit
			spip_query(&quot;UPDATE spip_auteurs SET statut='1comite' WHERE login='&quot;.addslashes($this-&gt;login).&quot;'&quot;);
		}
		if ($this-&gt;md5next) {
			include_ecrire(&quot;inc_session.php3&quot;);
			// fait tourner le codage du pass dans la base
			$nouvel_alea_futur = creer_uniqid();
			$query = &quot;UPDATE spip_auteurs SET alea_actuel = alea_futur, &quot;.
				&quot;pass = '&quot;.addslashes($this-&gt;md5next).&quot;', alea_futur = '$nouvel_alea_futur' &quot;.
				&quot;WHERE login='&quot;.$this-&gt;login.&quot;'&quot;;
			@spip_query($query);
		}
	}
}


?&gt;

--- NEW FILE: inc_sites.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_SITES&quot;)) return;
define(&quot;_INC_SITES&quot;, &quot;1&quot;);


if ($supprimer_lien = $GLOBALS[&quot;supprimer_lien&quot;]) {
	spip_query(&quot;UPDATE spip_syndic_articles SET statut='refuse' WHERE id_syndic_article='$supprimer_lien'&quot;);
}

if ($ajouter_lien = $GLOBALS[&quot;ajouter_lien&quot;]) {
	spip_query(&quot;UPDATE spip_syndic_articles SET statut='publie' WHERE id_syndic_article='$ajouter_lien'&quot;);
}


function recuperer_page($url) {
	$http_proxy = lire_meta(&quot;http_proxy&quot;);
	if (!eregi(&quot;^<A HREF="http://">http://</A>&quot;, $http_proxy))
		$http_proxy = '';
	else
		$via_proxy = &quot; (proxy $http_proxy)&quot;;

	spip_log(&quot;chargement $url$via_proxy&quot;);

	for ($i=0;$i&lt;10;$i++) {	// dix tentatives maximum en cas d'entetes 301...
		$t = @parse_url($url);
		$host = $t['host'];
		if (!($port = $t['port'])) $port = 80;
		$query = $t['query'];
		if (!($path = $t['path'])) $path = &quot;/&quot;;

		if ($http_proxy) {
			$t2 =  @parse_url($http_proxy);
			$proxy_host = $t2['host'];
			if (!($proxy_port = $t2['port'])) $proxy_port = 80;
			$f = @fsockopen($proxy_host, $proxy_port);
		} else
			$f = @fsockopen($host, $port);

		if ($f) {
			if ($http_proxy)
				fputs($f, &quot;GET <A HREF="http://$host">http://$host</A>&quot; . (($port != 80) ? &quot;:$port&quot; : &quot;&quot;) . $path . ($query ? &quot;?$query&quot; : &quot;&quot;) . &quot; HTTP/1.0\r\n&quot;);
			else
				fputs($f, &quot;GET $path&quot; . ($query ? &quot;?$query&quot; : &quot;&quot;) . &quot; HTTP/1.0\r\n&quot;);

			fputs($f, &quot;Host: $host\r\n&quot;);
			fputs($f, &quot;User-Agent: SPIP-&quot;.$GLOBALS['spip_version_affichee'].&quot; (<A HREF="http://www.spip.net/">http://www.spip.net/</A>)\r\n&quot;);
			if ($referer = lire_meta(&quot;adresse_site&quot;))
				fputs($f, &quot;Referer: $referer/\r\n&quot;);
			fputs($f,&quot;\r\n&quot;);

			$s = trim(fgets($f, 16384));
			if (ereg('^HTTP/[0-9]+\.[0-9]+ ([0-9]+)', $s, $r)) {
				$status = $r[1];
			}
			else return;
			while ($s = trim(fgets($f, 16384))) {
				if (eregi('^Location: (.*)', $s, $r)) {
					$location = $r[1];
				}
			}
			if ($status &gt;= 300 AND $status &lt; 400 AND $location) $url = $location;
			else if ($status != 200) return;
			else break;
			fclose($f);
		}
		else {
			if (!$GLOBALS['tester_proxy'])
				$f = @fopen($url, &quot;rb&quot;);
			break;
		}
	}

	if (!$f) {
		spip_log(&quot;ECHEC chargement $url$via_proxy&quot;);
		$result = '';
	} else {
		while (!feof($f))
			$result .= fread($f, 16384);
		fclose($f);
	}

	return $result;
}


function transcoder_page($texte) {
	include_ecrire('inc_charsets.php3');

	// Si le backend precise son charset et que celui-ci est connu de SPIP,
	// decoder puis recoder
	if (ereg('&lt;\\?xml[[:space:]]([^&gt;]*[[:space:]])?encoding[[:space:]]*=[[:space:]]*[\'&quot;]([-_a-zA-Z0-9]+)[\'&quot;]', $texte, $regs)) {
		$charset_page = strtolower($regs[2]);
		$texte = importer_charset($texte, $charset_page);
	}
	// Si le backend ne precise pas, on considere qu'il est iso-8859-1
	else $texte = importer_charset($texte, 'iso-8859-1');

	return $texte;
}

function trouver_format($texte) {
	$syndic_version = '';
	
	// Chercher un numero de version
	if (ereg('(rss|feed)[[:space:]](([^&gt;]*[[:space:]])*)version[[:space:]]*=[[:space:]]*[\'&quot;]([-_a-zA-Z0-9\.]+)[\'&quot;]', $texte, $regs)) {
		$syndic_version = $regs[4];
	} else {
		if (strpos($texte,'rdf:RDF')) {
			$syndic_version = '1.0';
		}
	}
	return $syndic_version;
}

function analyser_site($url) {
	include_ecrire(&quot;inc_filtres.php3&quot;);

	$texte = transcoder_page(recuperer_page($url));
	if (!$texte) return false;
	$result = '';
	
	// definir les regexp pour decoder
	// il faut deux etapes pour link sous Atom0.3
	$syndic_version = trouver_format($texte);

	switch ($syndic_version) {
		case &quot;1.0&quot; :
			$site_regexp = array(
				'channel'     =&gt; '&lt;channel[^&gt;]*&gt;(.*)&lt;/channel&gt;',
				'link1'       =&gt; '&lt;link[^&gt;]*&gt;([^&lt;]*)&lt;/link&gt;',
				'link2'       =&gt; '(.*)',
				'item'        =&gt; '&lt;item[^&gt;]*&gt;',
				'description' =&gt; '&lt;description[^&gt;]*&gt;([^&lt;]*)&lt;/description&gt;'
			);
			break;
		case &quot;0.3&quot; :
			$site_regexp = array(
				'channel'     =&gt; '&lt;feed[^&gt;]*&gt;(.*)&lt;/feed&gt;',
				'link1'       =&gt; '&lt;link[[:space:]]([^&lt;]*)rel[[:space:]]*=[[:space:]]*[\'&quot;]alternate[\'&quot;]([^&lt;]*)/&gt;',
				'link2'       =&gt; 'href[[:space:]]*=[[:space:]]*[\'&quot;]([^[&quot;|\']]+)[\'&quot;]',
				'item'        =&gt; '&lt;entry[^&gt;]*&gt;',
				'description' =&gt; '&lt;tagline[^&gt;]*&gt;([^&lt;]*)&lt;/tagline&gt;'
			);
			break;
		case &quot;0.91&quot; :
		case &quot;0.92&quot; :
		case &quot;2.0&quot; :
		default :	# backend defectueux, mais il faut une regexp
			$site_regexp = array(
				'channel'     =&gt;'&lt;channel[^&gt;]*&gt;(.*)&lt;/channel&gt;',
				'link1'       =&gt; '&lt;link[^&gt;]*&gt;([^&lt;]*)&lt;/link&gt;',
				'link2'       =&gt; '(.*)',
				'item'        =&gt; '&lt;item[^&gt;]*&gt;',
				'description' =&gt; '&lt;description[^&gt;]*&gt;([^&lt;]*)&lt;/description&gt;'
			);
			break;
	}

	if (ereg($site_regexp['channel'], $texte, $regs)) {
		$result['syndic'] = true;
		$result['url_syndic'] = $url;
		$channel = $regs[1];
		if (ereg('&lt;title[^&gt;]*&gt;(([^&lt;]|&lt;[^/]|&lt;/[^t]&gt;|&lt;/t[^i]&gt;)*)&lt;/title&gt;', $channel, $r))
			$result['nom_site'] = supprimer_tags(filtrer_entites($r[1]));
		if (ereg($site_regexp['link1'], $channel, $regs)) {
			if (ereg($site_regexp['link2'], $regs[1].$regs[2], $r))
				$result['url_site'] = filtrer_entites($r[1]);
		}

		// si le channel n'a pas de description, ne pas prendre celle d'un article
		list($channel_desc,$drop) = split($site_regexp['item'], $channel, 2);
		if (ereg($site_regexp['description'], $channel_desc, $r))
			$result['descriptif'] = filtrer_entites($r[1]);
	}
	else {
		$result['syndic'] = false;
		$result['url_site'] = $url;
		if (eregi('&lt;head&gt;(.*)', $texte, $regs))
			$head = filtrer_entites(eregi_replace('&lt;/head&gt;.*', '', $regs[1]));
		else
			$head = $texte;
		if (eregi('&lt;title[^&gt;]*&gt;(.*)', $head, $regs))
			$result['nom_site'] = filtrer_entites(supprimer_tags(eregi_replace('&lt;/title&gt;.*', '', $regs[1])));
		if (eregi('&lt;meta[[:space:]]+(name|http\-equiv)[[:space:]]*=[[:space:]]*[\'&quot;]?description[\'&quot;]?[[:space:]]+(content|value)[[:space:]]*=[[:space:]]*[\'&quot;]([^&gt;]+)[\'&quot;]&gt;', $head, $regs))
			$result['descriptif'] = filtrer_entites(supprimer_tags($regs[3]));
	}
	return $result;
}


function syndic_a_jour($now_id_syndic, $statut = 'off') {
	include_ecrire(&quot;inc_texte.php3&quot;);
	include_ecrire(&quot;inc_filtres.php3&quot;);

	$query = &quot;SELECT * FROM spip_syndic WHERE id_syndic='$now_id_syndic'&quot;;
	$result = spip_query($query);
	if ($row = spip_fetch_array($result))
		$url_syndic = $row[&quot;url_syndic&quot;];
	else return;
	$moderation = $row['moderation'];
	if ($moderation == 'oui')
		$moderation = 'dispo';	// a valider
	else
		$moderation = 'publie';	// en ligne sans validation

	// Section critique : n'autoriser qu'une seule syndication simultanee pour un site donne
	if (!spip_get_lock(&quot;syndication $url_syndic&quot;)) return;

	spip_query(&quot;UPDATE spip_syndic SET syndication='$statut', date_syndic=NOW() WHERE id_syndic='$now_id_syndic'&quot;);

	$le_retour = transcoder_page(recuperer_page($url_syndic));
	$erreur = &quot;&quot;;
	$les_auteurs_du_site = &quot;&quot;;

	// definir les regexp pour decoder
	// il faut deux etapes pour link sous Atom0.3
	$syndic_version = trouver_format($le_retour);
	switch ($syndic_version) {
		case &quot;0.91&quot; :
		case &quot;0.92&quot; :
		case &quot;2.0&quot; :
			$syndic_regexp = array(
				'item'           =&gt; '&lt;item[&gt;[:space:]]',
				'itemfin'        =&gt; '&lt;/item&gt;',
				'link1'          =&gt; '&lt;link[^&gt;]*&gt;([^&lt;]*)&lt;/link&gt;',
				'link2'          =&gt; '(.*)',
				'date1'          =&gt; '&lt;pubDate&gt;([^&lt;]*)&lt;/pubDate&gt;',
				'date2'          =&gt; '&lt;[[:alpha:]]{2}:date&gt;([^&lt;]*)&lt;/[[:alpha:]]{2}:date&gt;',
				'author1'        =&gt; '&lt;[[:alpha:]]{2}:[Cc]reator&gt;([^&lt;]*)&lt;/[[:alpha:]]{2}:[Cc]reator&gt;',
				'author2'        =&gt; '(.*)',
				'authorbis'      =&gt; '&lt;author&gt;([^&lt;]*)&lt;/author&gt;',
				'description'    =&gt; '&lt;description[^&gt;]*&gt;[[:space:]]*(&lt;\!\[CDATA\[)?(([^]]|][^]]|]{2}[^&gt;]|(\[([^]])*]))*)(]{2}&gt;)?[[:space:]]*&lt;/description[^&gt;]*&gt;',
				'descriptionbis' =&gt;     '&lt;content[^&gt;]*&gt;[[:space:]]*(&lt;\!\[CDATA\[)?(([^]]|][^]]|]{2}[^&gt;]|(\[([^]])*]))*)(]{2}&gt;)?[[:space:]]*&lt;/content[^&gt;]*&gt;'
			);
			break;
		case &quot;1.0&quot; :
			$syndic_regexp = array(
				'item'           =&gt; '&lt;item[&gt;[:space:]]',
				'itemfin'        =&gt; '&lt;/item&gt;',
				'link1'          =&gt; '&lt;link[^&gt;]*&gt;([^&lt;]*)&lt;/link&gt;',
				'link2'          =&gt; '(.*)',
				'date1'          =&gt; '&lt;[[:alpha:]]{2}:date&gt;([^&lt;]*)&lt;/[[:alpha:]]{2}:date&gt;',
				'date2'          =&gt; '&lt;pubDate&gt;([^&lt;]*)&lt;/pubDate&gt;',
				'author1'        =&gt; '&lt;[[:alpha:]]{2}:[Cc]reator&gt;([^&lt;]*)&lt;/[[:alpha:]]{2}:[Cc]reator&gt;',
				'author2'        =&gt; '(.*)',
				'authorbis'      =&gt; '&lt;author&gt;([^&lt;]*)&lt;/author&gt;',
				'description'    =&gt; '&lt;description[^&gt;]*&gt;[[:space:]]*(&lt;\!\[CDATA\[)?(([^]]|][^]]|]{2}[^&gt;]|(\[([^]])*]))*)(]{2}&gt;)?[[:space:]]*&lt;/description[^&gt;]*&gt;',
				'descriptionbis' =&gt;     '&lt;content[^&gt;]*&gt;[[:space:]]*(&lt;\!\[CDATA\[)?(([^]]|][^]]|]{2}[^&gt;]|(\[([^]])*]))*)(]{2}&gt;)?[[:space:]]*&lt;/content[^&gt;]*&gt;'
			);
			break;
		case &quot;0.3&quot; :
			$syndic_regexp = array('channel'=&gt;'&lt;feed[^&gt;]*&gt;(.*)&lt;/feed&gt;',
				'item'           =&gt; '&lt;entry[&gt;[:space:]]',
				'itemfin'        =&gt; '&lt;/entry&gt;',
				'link1'          =&gt; '&lt;link[[:space:]]([^&lt;]*)rel[[:space:]]*=[[:space:]]*[\'&quot;]alternate[\'&quot;]([^&lt;]*)/&gt;',
				'link2'          =&gt; 'href[[:space:]]*=[[:space:]]*[\'&quot;]([^&quot;|^\']+)[\'&quot;]',
				'date1'          =&gt; '&lt;modified&gt;([^&lt;]*)&lt;/modified&gt;',
				'date2'          =&gt; '&lt;issued&gt;([^&lt;]*)&lt;/issued&gt;',
				'author1'        =&gt; '&lt;author&gt;(.*&lt;name&gt;.*&lt;/name&gt;.*)&lt;/author&gt;',
				'author2'        =&gt; '&lt;name&gt;([^&lt;]*)&lt;/name&gt;',
				'authorbis'      =&gt; '&lt;[[:alpha:]]{2}:[Cc]reator&gt;([^&lt;]*)&lt;/[[:alpha:]]{2}:[Cc]reator&gt;',
				'description'    =&gt; '&lt;summary[^&gt;]*&gt;[[:space:]]*(&lt;\!\[CDATA\[)?(([^]]|][^]]|]{2}[^&gt;]|(\[([^]])*]))*)(\]{2}&gt;)?[[:space:]]*&lt;/summary[^&gt;]*&gt;',
				'descriptionbis' =&gt; '&lt;content[^&gt;]*&gt;[[:space:]]*(&lt;\!\[CDATA\[)?(([^]]|][^]]|]{2}[^&gt;]|(\[([^]])*]))*)(\]{2}&gt;)?[[:space:]]*&lt;/content[^&gt;]*&gt;'
			);
			break;
		default :
			// format de syndication non reconnu
			$erreur = _T('avis_echec_syndication_02');
			$le_retour = '';
			break;
	}

	// chercher un auteur dans le fil au cas ou les entry n'en auraient pas

	if ($le_retour) {
		list($channel_head,$drop) = split($syndic_regexp['item'], $le_retour, 2);
		if (ereg($syndic_regexp['author1'],$channel_head,$mat)) {
			if (ereg($syndic_regexp['author2'],$mat[1],$match))
				$les_auteurs_du_site = addslashes(filtrer_entites($match[1]));
	}
		$i = 0;
		while (ereg($syndic_regexp['item'],$le_retour,$regs)) {
			$debut_item=strpos($le_retour,$regs[0]);
			$fin_item=strpos($le_retour,$syndic_regexp['itemfin'])+strlen($syndic_regexp['itemfin']);
			$item[$i]=substr($le_retour,$debut_item,$fin_item-$debut_item);

			$debut_texte=substr($le_retour,&quot;0&quot;,$debut_item);
			$fin_texte=substr($le_retour,$fin_item,strlen($le_retour));
			$le_retour=$debut_texte.$fin_texte;
			$i++;
		}
		if (is_array($item)) {
			$now = time();
			for ($i = 0 ; $i &lt; count($item) ; $i++) {

				// URL (obligatoire)
				if (ereg($syndic_regexp['link1'],$item[$i],$match)) {
					$link_match = $match[1].$match[2];
					if (ereg($syndic_regexp['link2'], $link_match, $mat))
						$le_lien = addslashes(filtrer_entites($mat[1]));
				}
				else if (ereg(&quot;&lt;guid&gt;([^&lt;]*)&lt;/guid&gt;&quot;,$item[$i],$match))
					$le_lien = addslashes(filtrer_entites($match[1]));
				else continue;

				// Titre (obligatoire)
				if
(ereg(&quot;&lt;title&gt;[[:space:]]*(&lt;\!\[CDATA\[)?(([^]]|][^]]|]{2}[^&gt;]|(\[([^]])*]))*)(]{2}&gt;)?[[:space:]]*&lt;/title&gt;&quot;,$item[$i],$match))
					$le_titre = addslashes(supprimer_tags(filtrer_entites($match[2])));
				else if (($syndic_version==0.3) AND (strlen($letitre)==0))
					if (ereg('title[[:space:]]*=[[:space:]]*[\'&quot;]([^&quot;|^\']+)[\'&quot;]',$link_match,$mat))
						$le_titre=$mat[1]; 
				else continue;

				// Date
				$la_date = &quot;&quot;;
				if (ereg(&quot;&lt;date&gt;([^&lt;]*)&lt;/date&gt;&quot;,$item[$i],$match))
					$la_date = $match[1];
				if (ereg($syndic_regexp['date1'],$item[$i],$match))
					$la_date = $match[1];
				else if (ereg($syndic_regexp['date2'],$item[$i],$match))
					$la_date = $match[1];
				if ($GLOBALS['flag_strtotime'] AND $la_date) {
					// <A HREF="http://www.w3.org/TR/NOTE-datetime">http://www.w3.org/TR/NOTE-datetime</A>
					if (ereg('^([0-9]+-[0-9]+-[0-9]+T[0-9]+:[0-9]+(:[0-9]+)?)(\.[0-9]+)?(Z|([-+][0-9][0-9]):[0-9]+)$', $la_date, $match)) {
						$la_date = str_replace(&quot;T&quot;, &quot; &quot;, $match[1]).&quot; GMT&quot;;
						$la_date = strtotime($la_date) - intval($match[5]) * 3600;
					}
					else $la_date = strtotime($la_date);
				}
				if ($la_date &lt; $now - 365 * 24 * 3600 OR $la_date &gt; $now + 48 * 3600)
					$la_date = $now;

				// Auteur
				if (ereg($syndic_regexp['author1'],$item[$i],$mat)) {
					if (ereg($syndic_regexp['author2'],$mat[1],$match))
						$les_auteurs = addslashes(filtrer_entites($match[1]));
				}
				else if (ereg($syndic_regexp['authorbis'],$item[$i],$match))
					$les_auteurs = addslashes(filtrer_entites($match[1]));
				else $les_auteurs = $les_auteurs_du_site;

				// Description
				if (ereg($syndic_regexp['description'],$item[$i],$match)) {
					$la_description = couper(addslashes(supprimer_tags(filtrer_entites($match[2]))),300);
				}
				elseif (ereg($syndic_regexp['descriptionbis'],$item[$i],$match))
					$la_description = couper(addslashes(supprimer_tags(filtrer_entites($match[2]))),300);
				else $la_description = &quot;&quot;;
				$query_deja = &quot;SELECT * FROM spip_syndic_articles WHERE url='$le_lien' AND id_syndic=$now_id_syndic&quot;;
				$result_deja = spip_query($query_deja);
				if (spip_num_rows($result_deja) == 0 and !spip_sql_error()) {
					$query_syndic = &quot;INSERT INTO spip_syndic_articles (id_syndic, titre, url, date, lesauteurs, statut, descriptif) &quot;.
						&quot;VALUES ('$now_id_syndic', '$le_titre', '$le_lien', FROM_UNIXTIME($la_date), '$les_auteurs', '$moderation', '$la_description')&quot;;
					$result_syndic=spip_query($query_syndic);
					$flag_ajout_lien = true;
				}
			}
			spip_query(&quot;UPDATE spip_syndic SET syndication='oui' WHERE id_syndic='$now_id_syndic'&quot;);
		}
		// syndication javascript : y a-t-il quelqu'un qui se sert de ce truc ??
		// la question est posee
		else if (ereg(&quot;document\.write&quot;, $le_retour)) {
			$i = 0;
			while ($i &lt; 50 AND eregi(&quot;&lt;a[[:space:]]+href[[:space:]]*=[[:space:]]*\&quot;?([^\&quot;&gt;]+)\&quot;?[^&gt;]*&gt;(.*)&quot;,$le_retour,$reg)){ //&quot;
				$le_lien = addslashes(stripslashes($reg[1]));
				$la_suite = $reg[2];

				$pos_fin = strpos($la_suite, &quot;&lt;/a&quot;);
				$pos_fin2 = strpos($la_suite, &quot;&lt;/A&quot;);
				if ($pos_fin2 &gt; $pos_fin) $pos_fin = $pos_fin2;

				$le_titre = substr($la_suite, 0, $pos_fin);
				$le_titre = addslashes(stripslashes($le_titre));
				$le_titre = ereg_replace(&quot;&lt;[^&gt;]*&gt;&quot;,&quot;&quot;,$le_titre);
				$le_retour = substr($la_suite, $pos_fin + 4, strlen($le_retour));

				echo &quot;&lt;li&gt; $le_titre / $le_lien&quot;;

				if (strlen($la_date) &lt; 4) $la_date=date(&quot;Y-m-j H:i:00&quot;);

				$query_deja=&quot;SELECT * FROM spip_syndic_articles WHERE url='$le_lien' AND id_syndic=$now_id_syndic&quot;;
				$result_deja=spip_query($query_deja);
				if (spip_num_rows($result_deja)==0){
					$query_syndic = &quot;INSERT INTO spip_syndic_articles (id_syndic, titre, url, date, lesauteurs, statut, descriptif) &quot;.
						&quot;VALUES ('$now_id_syndic', '$le_titre', '$le_lien', '$la_date', '$les_auteurs', '$moderation', '$la_description')&quot;;
					$result_syndic=spip_query($query_syndic);
					$flag_ajout_lien = true;
				}
				$i++;
			}
			spip_query(&quot;UPDATE spip_syndic SET syndication='oui', date_syndic=NOW() WHERE id_syndic='$now_id_syndic'&quot;);
		}
		else $erreur = _T('avis_echec_syndication_01');
	}
	else $erreur = _T('avis_echec_syndication_02');

	// Ne pas oublier de liberer le verrou
	spip_release_lock($url_syndic);

	if ($flag_ajout_lien) {
		include_ecrire('inc_rubriques.php3');
		calculer_rubriques();
	}

	return $erreur;
}


function afficher_sites($titre_table, $requete) {
	global $couleur_claire, $couleur_foncee, $spip_lang_left, $spip_lang_right;
	global $connect_id_auteur;

	$tranches = afficher_tranches_requete($requete, 3);

	if ($tranches) {
//		debut_cadre_relief(&quot;site-24.gif&quot;);
		if ($titre_table) echo &quot;&lt;div style='height: 12px;'&gt;&lt;/div&gt;&quot;;
		echo &quot;&lt;div class='liste'&gt;&quot;;
		bandeau_titre_boite2($titre_table, &quot;site-24.gif&quot;, $couleur_claire, &quot;black&quot;);
		echo &quot;&lt;table width='100%' cellpadding='2' cellspacing='0' border='0'&gt;&quot;;

		echo $tranches;

	 	$result = spip_query($requete);
		$num_rows = spip_num_rows($result);

		$ifond = 0;
		$premier = true;
		
		$compteur_liste = 0;
		while ($row = spip_fetch_array($result)) {
			$vals = '';
			$id_syndic=$row[&quot;id_syndic&quot;];
			$id_rubrique=$row[&quot;id_rubrique&quot;];
			$nom_site=typo($row[&quot;nom_site&quot;]);
			$url_site=$row[&quot;url_site&quot;];
			$url_syndic=$row[&quot;url_syndic&quot;];
			$description=propre($row[&quot;description&quot;]);
			$syndication=$row[&quot;syndication&quot;];
			$statut=$row[&quot;statut&quot;];
			$date=$row[&quot;date&quot;];
			$moderation=$row['moderation'];
			
			$tous_id[] = $id_syndic;

			//echo &quot;&lt;tr bgcolor='$couleur'&gt;&quot;;

			//echo &quot;&lt;td class='arial2'&gt;&quot;;
			$link = new Link(&quot;sites.php3?id_syndic=$id_syndic&quot;);
			switch ($statut) {
			case 'publie':
				if (acces_restreint_rubrique($id_rubrique))
					$puce = 'puce-verte-anim.gif';
				else
					$puce='puce-verte-breve.gif';
				$title = _T('info_site_reference');
				break;
			case 'prop':
				if (acces_restreint_rubrique($id_rubrique))
					$puce = 'puce-orange-anim.gif';
				else
					$puce='puce-orange-breve.gif';
				$title = _T('info_site_attente');
				break;
			case 'refuse':
				if (acces_restreint_rubrique($id_rubrique))
					$puce = 'puce-poubelle-anim.gif';
				else
					$puce='puce-poubelle-breve.gif';
				$title = _T('info_site_refuse');
				break;
			}
			if ($syndication == &quot;off&quot;) {
				$puce = 'puce-orange-anim.gif';
				$title = _T('info_panne_site_syndique');
			}

			$s = &quot;&lt;a href=\&quot;&quot;.$link-&gt;getUrl().&quot;\&quot; title=\&quot;$title\&quot;&gt;&quot;;

			if ($spip_display != 1 AND $spip_display != 4 AND lire_meta('image_process') != &quot;non&quot;) {
				include_ecrire(&quot;inc_logos.php3&quot;);
				$logo = decrire_logo(&quot;siteon$id_syndic&quot;);
				if ($logo) {
					$fichier = $logo[0];
					$taille = $logo[1];
					$taille_x = $logo[3];
					$taille_y = $logo[4];
					$taille = image_ratio($taille_x, $taille_y, 26, 20);
					$w = $taille[0];
					$h = $taille[1];
					$fid = $logo[2];
					$hash = calculer_action_auteur (&quot;reduire $w $h&quot;);

					$s.= &quot;&lt;div style='float: $spip_lang_right; margin-top: -2px; margin-bottom: -2px;'&gt;&lt;img src='../spip_image_reduite.php3?img=&quot;._DIR_IMG.&quot;$fichier&amp;taille_x=$w&amp;taille_y=$h&amp;hash=$hash&amp;hash_id_auteur=$connect_id_auteur' alt='' width='$w' height='$h' border='0'&gt;&lt;/div&gt;&quot;;
					
				}
			}


			$s .= http_img_pack($puce, &quot;&quot;, &quot;width='7' height='7' border='0'&quot;) .&quot;&nbsp;&nbsp;&quot;;
			
			$s .= typo($nom_site);
			/*if ($moderation == 'oui')
				$s .= &quot;&lt;i&gt;&quot;.typo($nom_site).&quot;&lt;/i&gt;&quot;;
			else
				$s .= typo($nom_site);
			*/
			$s .= &quot;&lt;/a&gt; &nbsp;&nbsp; &lt;font size='1'&gt;[&lt;a href='$url_site'&gt;&quot;._T('lien_visite_site').&quot;&lt;/a&gt;]&lt;/font&gt;&quot;;
			$vals[] = $s;
			
			//echo &quot;&lt;/td&gt;&quot;;

			$s = &quot;&quot;;
			//echo &quot;&lt;td class='arial1' align='right'&gt; &nbsp;&quot;;
			if ($syndication == &quot;off&quot;) {
				$s .= &quot;&lt;font color='red'&gt;&quot;._T('info_probleme_grave').&quot; &lt;/font&gt;&quot;;
			}
			if ($syndication == &quot;oui&quot; or $syndication == &quot;off&quot;){
				$s .= &quot;&lt;font color='red'&gt;&quot;._T('info_syndication').&quot;&lt;/font&gt;&quot;;
			}
				$vals[] = $s;
			//echo &quot;&lt;/td&gt;&quot;;					
			//echo &quot;&lt;td class='arial1'&gt;&quot;;
			$s = &quot;&quot;;
			if ($syndication == &quot;oui&quot; OR $syndication == &quot;off&quot;) {
				$result_art = spip_query(&quot;SELECT COUNT(*) FROM spip_syndic_articles WHERE id_syndic='$id_syndic'&quot;);
				list($total_art) = spip_fetch_array($result_art);
				$s .= &quot; $total_art &quot;._T('info_syndication_articles');
			} else {
				$s .= &quot;&nbsp;&quot;;
			}
			$vals[] = $s;
			//echo &quot;&lt;/td&gt;&quot;;					
			//echo &quot;&lt;/tr&gt;&lt;/n&gt;&quot;;
			$table[] = $vals;
		}
		spip_free_result($result);
		
		$largeurs = array('','','');
		$styles = array('arial11', 'arial1', 'arial1');
		afficher_liste($largeurs, $table, $styles);
		echo &quot;&lt;/table&gt;&quot;;
		//fin_cadre_relief();
		echo &quot;&lt;/div&gt;\n&quot;;
	}
	return $tous_id;
}


function afficher_syndic_articles($titre_table, $requete, $afficher_site = false) {
	global $couleur_claire;
	global $connect_statut;
	global $REQUEST_URI;
	global $debut_liste_sites;
	global $flag_editable;

	static $n_liste_sites;

	$n_liste_sites++;
	if (!$debut_liste_sites[$n_liste_sites]) $debut_liste_sites[$n_liste_sites] = 0;

	$adresse_page = substr($REQUEST_URI, strpos($REQUEST_URI, &quot;/ecrire&quot;)+8, strlen($REQUEST_URI));
	$adresse_page = ereg_replace(&quot;\&amp;?debut\_liste\_sites\[$n_liste_sites\]\=[0-9]+&quot;,&quot;&quot;,$adresse_page);
	$adresse_page = ereg_replace(&quot;\&amp;?(ajouter\_lien|supprimer_lien)\=[0-9]+&quot;,&quot;&quot;,$adresse_page);

	if (ereg(&quot;\?&quot;,$adresse_page)) $lien_url = &quot;&amp;&quot;;
	else $lien_url = &quot;?&quot;;

	$lien_url .= &quot;debut_liste_sites[&quot;.$n_liste_sites.&quot;]=&quot;.$debut_liste_sites[$n_liste_sites].&quot;&amp;&quot;;


	$nombre_aff = 10;

 	$result = spip_query($requete);
	$num_rows = spip_num_rows($result);

	// Ne pas couper pour trop peu
	if ($num_rows &lt;= 1.5 * $nombre_aff) $nombre_aff = $num_rows;

		if ($num_rows &gt; 0) {
			echo &quot;&lt;p&gt;&lt;table width='100%' cellpadding='0' cellspacing='0' border='0'&gt;&lt;tr&gt;&lt;td width='100%' background=''&gt;&quot;;
			echo &quot;&lt;table width='100%' cellpadding='3' cellspacing='0' border='0'&gt;&quot;;

			bandeau_titre_boite($titre_table, true);

			if ($num_rows &gt; $nombre_aff) {
				echo &quot;&lt;tr&gt;&lt;td background='' class='arial2' colspan='4'&gt;&quot;;
				for ($i = 0; $i &lt; $num_rows; $i = $i + $nombre_aff){
					$deb = $i + 1;
					$fin = $i + $nombre_aff;
					if ($fin &gt; $num_rows) $fin = $num_rows;
					if ($debut_liste_sites[$n_liste_sites] == $i) {
						echo &quot;[&lt;b&gt;$deb-$fin&lt;/b&gt;] &quot;;
					} else {
						echo &quot;[&lt;a href='&quot;.$adresse_page.$lien_url.&quot;debut_liste_sites[$n_liste_sites]=$i'&gt;$deb-$fin&lt;/a&gt;] &quot;;
					}
				}
				echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
			}
		
			$ifond = 0;
			$premier = true;
			
			$compteur_liste = 0;

			while ($row = spip_fetch_array($result)) {
				if ($compteur_liste &gt;= $debut_liste_sites[$n_liste_sites] AND $compteur_liste &lt; $debut_liste_sites[$n_liste_sites] + $nombre_aff) {
					$ifond = $ifond ^ 1;
					$couleur = ($ifond) ? '#FFFFFF' : $couleur_claire;

					$id_syndic_article=$row[&quot;id_syndic_article&quot;];
					$id_syndic=$row[&quot;id_syndic&quot;];
					$titre=typo($row[&quot;titre&quot;]);
					$url=$row[&quot;url&quot;];
					$date=$row[&quot;date&quot;];
					$lesauteurs=propre($row[&quot;lesauteurs&quot;]);
					$statut=$row[&quot;statut&quot;];
					$descriptif=$row[&quot;descriptif&quot;];

					echo &quot;&lt;tr bgcolor='$couleur'&gt;&quot;;
					
					echo &quot;&lt;td class='arial1'&gt;&quot;;
					echo &quot;&lt;a href='$url'&gt;&quot;;
					if ($statut=='publie') {
						if (acces_restreint_rubrique($id_rubrique))
							$puce = 'puce-verte-anim.gif';
						else
							$puce='puce-verte.gif';
					}
					else if ($statut == &quot;refuse&quot;) {
							$puce = 'puce-poubelle.gif';
					}

					else if ($statut == &quot;dispo&quot;) { // moderation : a valider
							$puce = 'puce-rouge.gif';
					}

					else if ($statut == &quot;off&quot;) { // vieillerie
							$puce = 'puce-rouge-anim.gif';
					}

					echo http_img_pack($puce, &quot;&quot;, &quot;width='7' height='7' border='0'&quot;);

					if ($statut == &quot;refuse&quot;)
						echo &quot;&lt;font color='black'&gt;&nbsp;&nbsp;$titre&lt;/font&gt;&quot;;
					else
						echo &quot;&nbsp;&nbsp;&quot;.$titre;

					echo &quot;&lt;/a&gt;&quot;;

					if (strlen($lesauteurs)&gt;0) echo &quot;&lt;br /&gt;&quot;._T('info_auteurs_nombre').&quot; &lt;font color='#336666'&gt;$lesauteurs&lt;/font&gt;&quot;;
					if (strlen($descriptif)&gt;0) echo &quot;&lt;br /&gt;&quot;._T('info_descriptif_nombre').&quot; &lt;font color='#336666'&gt;$descriptif&lt;/font&gt;&quot;;
					
					echo &quot;&lt;/td&gt;&quot;;
					
					// $my_sites cache les resultats des requetes sur les sites
					if ($afficher_site) {
						if (!$my_sites[$id_syndic])
							$my_sites[$id_syndic] = spip_fetch_array(spip_query(
								&quot;SELECT * FROM spip_syndic WHERE id_syndic=$id_syndic&quot;));
						echo &quot;&lt;td class='arial1' align='left'&gt;&quot;;
						$aff = $my_sites[$id_syndic]['nom_site'];
						if ($my_sites[$id_syndic]['moderation'] == 'oui')
							echo &quot;&lt;i&gt;$aff&lt;/i&gt;&quot;;
						else
							echo $aff;
						echo &quot;&lt;/td&gt;&quot;;
					} else echo &quot;&lt;td&gt;&lt;/td&gt;&quot;;

					echo &quot;&lt;td class='arial1' align='right'&gt;&quot;;
					
					if ($connect_statut == '0minirezo'){
						if ($statut == &quot;publie&quot;){
							echo &quot;[&lt;a href='&quot;.$adresse_page.$lien_url.&quot;id_syndic=$id_syndic&amp;supprimer_lien=$id_syndic_article'&gt;&lt;font color='black'&gt;&quot;._T('info_bloquer_lien').&quot;&lt;/font&gt;&lt;/a&gt;]&quot;;
						
						}
						else if ($statut == &quot;refuse&quot;){
							echo &quot;[&lt;a href='&quot;.$adresse_page.$lien_url.&quot;id_syndic=$id_syndic&amp;ajouter_lien=$id_syndic_article'&gt;&quot;._T('info_retablir_lien').&quot;&lt;/a&gt;]&quot;;
						}
						else if ($statut == &quot;dispo&quot;) {
							echo &quot;[&lt;a href='&quot;.$adresse_page.$lien_url.&quot;id_syndic=$id_syndic&amp;ajouter_lien=$id_syndic_article'&gt;&quot;._T('info_valider_lien').&quot;&lt;/a&gt;]&quot;;
						}
					} else {
						echo &quot;&nbsp;&quot;;
					}

					echo &quot;&lt;/td&gt;&quot;;
					echo &quot;&lt;/tr&gt;&lt;/n&gt;&quot;;

			}
			$compteur_liste++;

		}
		echo &quot;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/p&gt;&quot;;
	}
}


//
// Effectuer la syndication d'un unique site, retourne 0 si aucun a faire.
//

function executer_une_syndication() {
	$id_syndic = 0;
	if ($row = spip_fetch_array(spip_query(&quot;SELECT * FROM spip_syndic WHERE syndication='sus' AND statut='publie' AND date_syndic &lt; DATE_SUB(NOW(), INTERVAL 24 HOUR) ORDER BY date_syndic LIMIT 0,1&quot;))) {
		$id_syndic = $row[&quot;id_syndic&quot;];
		syndic_a_jour($id_syndic);
	}

	if ($row = spip_fetch_array(spip_query(&quot;SELECT * FROM spip_syndic WHERE syndication='oui' AND statut='publie' AND date_syndic &lt; DATE_SUB(NOW(), INTERVAL 2 HOUR) ORDER BY date_syndic LIMIT 0,1&quot;))) {
		$id_syndic = $row[&quot;id_syndic&quot;];
		syndic_a_jour($id_syndic, 'sus');
	}
	return $id_syndic;
}

?&gt;

--- NEW FILE: licence_fr.html ---
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;
License GPL (traduction non-officielle)
&lt;/title&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;
&lt;style type=&quot;text/css&quot;&gt;&lt;!--
h1 { font-family: Verdana, Arial, Sans, sans-serif; font-size: 17px; font-weight: bold; text-align: center; }
body { font-family: Georgia, Garamond, Times, serif; font-size: 13px; text-align: justify; margin: 5%; }

a { text-decoration: none; }
a:hover { text-decoration: underline; }
a.icone { text-decoration: none; }
a.icone:hover { text-decoration: none; }
// --&gt;&lt;/style&gt;
&lt;/head&gt;
&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot; link=&quot;#e86519&quot; vlink=&quot;#6e003a&quot; alink=&quot;#ff9900&quot;&gt;

&lt;h1&gt;&lt;br&gt;
Notice d'accompagnement de la traduction non officielle &agrave;
conserver dans toute reproduction de cette traduction&lt;/h1&gt;
&lt;p&gt;&lt;b&gt; This is an unofficial translation of the GNU General Public
License into &lt;em&gt;french&lt;/em&gt;. It was not published by the Free
Software Foundation, and does not legally state the distribution terms
for software that uses the GNU GPL--only the &lt;a
href=&quot;<A HREF="http://www.gnu.org/copyleft/gpl.html">http://www.gnu.org/copyleft/gpl.html</A>&quot;&gt;original English text of
the GNU GPL&lt;/a&gt; does that. However, we hope that this translation
will help &lt;em&gt;french&lt;/em&gt; speakers understand the GNU GPL better.&lt;/b&gt;

&lt;p&gt;&lt;b&gt; Ceci est une traduction non officielle de la GNU General Public
License en fran&ccedil;ais. Elle n'a pas &eacute;t&eacute; publi&eacute;e par la Free Software
Foundation, et ne d&eacute;termine pas les termes de distribution pour les
logiciels qui utilisent la GNU GPL--seul le &lt;a
href=&quot;<A HREF="http://www.gnu.org/copyleft/gpl.html">http://www.gnu.org/copyleft/gpl.html</A>&quot;&gt;texte anglais original de
la GNU GPL&lt;/a&gt; en a le droit. Cependant, nous esp&eacute;rons que cette
traduction aidera les francophones &agrave; mieux comprendre la GPL.&lt;/b&gt;  

&lt;b&gt;&lt;p&gt; Cette traduction est sous Copyright 2001 APRIL (<A HREF="http://www.april.org">http://www.april.org</A>).&lt;br&gt;
La version la plus &agrave; jour de ce document est disponible sur &lt;a
href=&quot;<A HREF="http://www.april.org/gnu/gpl_french.html">http://www.april.org/gnu/gpl_french.html</A>&quot;&gt;<A HREF="http://www.april.org/gnu/gpl_french.html&lt;/a">http://www.april.org/gnu/gpl_french.html&lt;/a</A>&gt;&lt;br&gt;
&lt;p&gt;Il est permis &agrave; tout le monde de reproduire et distribuer des
copies conformes de cette traduction, mais aucune modification ne doit
y &ecirc;tre apport&eacute;e, et la pr&eacute;sente notice doit &ecirc;tre pr&eacute;serv&eacute;e.&lt;/b&gt;
Nous autorisons la FSF &agrave; apporter toute modification qu'elle jugera
n&eacute;cessaire pour rendre la traduction plus claire.
&lt;p&gt;
&lt;h1&gt;&lt;br&gt;
GNU GENERAL PUBLIC LICENSE (&lt;em&gt;TRADUCTION NON OFFICIELLE&lt;/em&gt;)&lt;/h1&gt;

&lt;p&gt;Version 2, juin 1991
&lt;p&gt;Copyright (C) 1989, 1991, Free Software Foundation Inc. 675 Mass Ave, Cambridge, MA02139, Etats-Unis.
&lt;p&gt;Il est permis &agrave; tout le monde de reproduire et distribuer
des copies conformes de ce document de licence, mais aucune
modification ne doit y &ecirc;tre apport&eacute;e.
&lt;br&gt;
&lt;br&gt;
&lt;h1&gt;&lt;br&gt;
Pr&eacute;ambule&lt;/h1&gt;
&lt;p&gt;
Les licences relatives &agrave; la plupart des logiciels sont
destin&eacute;es &agrave; supprimer votre libert&eacute; de les
partager et de les modifier. Par contraste, la licence publique
g&eacute;n&eacute;rale GNU General Public License veut garantir votre
libert&eacute; de partager et de modifier les logiciels libres, pour
qu'ils soient vraiment libres pour tous leurs utilisateurs. La
pr&eacute;sente licence publique g&eacute;n&eacute;rale s'applique

&agrave; la plupart des logiciels de la Free Software Foundation,
ainsi qu'&agrave; tout autre programme dont les auteurs s'engagent
&agrave; l'utiliser. (Certains autres logiciels sont couverts par la
Licence Publique G&eacute;n&eacute;rale pour Biblioth&egrave;ques GNU
&agrave; la place). Vous pouvez aussi l'appliquer &agrave; vos
programmes.
&lt;p&gt;Quand nous parlons de logiciels libres, nous parlons de
libert&eacute;, non de gratuit&eacute;. Nos licences publiques
g&eacute;n&eacute;rales veulent vous garantir :

&lt;ul&gt;
&lt;p&gt;
&lt;li&gt;que vous avez toute libert&eacute; de distribuer des copies des
logiciels libres (et de facturer ce service, si vous le souhaitez)
;
&lt;p&gt;
&lt;li&gt;que vous recevez les codes sources ou pouvez les obtenir si vous
le souhaitez ;
&lt;p&gt;
&lt;li&gt;que vous pouvez modifier les logiciels ou en utiliser des
&eacute;l&eacute;ments dans de nouveaux programmes libres ;
&lt;p&gt;
&lt;li&gt;et que vous savez que vous pouvez le faire.
&lt;/ul&gt;
&lt;p&gt;Pour prot&eacute;ger vos droits, nous devons apporter des
restrictions, qui vont interdire &agrave; quiconque de vous
d&eacute;nier ces droits, ou de vous demander de vous en
d&eacute;sister. Ces restrictions se traduisent par certaines
responsabilit&eacute;s pour ce qui vous concerne, si vous distribuez
des copies de logiciels, ou si vous les modifiez.

&lt;p&gt;Par exemple, si vous distribuez des copies d'un tel programme,
gratuitement ou contre une r&eacute;mun&eacute;ration, vous devez
transf&eacute;rer aux destinataires tous les droits dont vous
disposez. Vous devez vous garantir qu'eux-m&ecirc;mes, par ailleurs,
re&ccedil;oivent ou peuvent recevoir le code source. Et vous devez
leur montrer les pr&eacute;sentes dispositions, de fa&ccedil;on qu'ils
connaissent leurs droits. 
&lt;p&gt;Nous prot&eacute;geons vos droits en deux &eacute;tapes&nbsp;:
&lt;ol&gt;
&lt;p&gt;
&lt;li&gt; Nous assurons le droit d'auteur (copyright) du logiciel, et

&lt;p&gt;
&lt;li&gt; Nous vous proposons cette licence, qui vous donne l'autorisation
l&eacute;gale de dupliquer, distribuer et/ou modifier le logiciel.
&lt;/ol&gt;
&lt;p&gt;De m&ecirc;me, pour la protection de chacun des auteurs, et pour
notre propre protection, nous souhaitons nous assurer que tout le
monde comprenne qu'il n'y a aucune garantie portant sur ce logiciel
libre. Si le logiciel est modifi&eacute; par quelqu'un d'autre puis
transmis &agrave; des tiers, nous souhaitons que les destinataires
sachent que ce qu'ils poss&egrave;dent n'est pas l'original, de
fa&ccedil;on que tous probl&egrave;mes introduits par d'autres ne se
traduisent pas par une r&eacute;percussion n&eacute;gative sur la
r&eacute;putation de l'auteur original.

&lt;p&gt;Enfin, tout programme libre est en permanence menac&eacute; par des
brevets de logiciels. Nous souhaitons &eacute;viter le danger que des
sous-distributeurs d'un programme libre obtiennent &agrave; titre
individuel des licences de brevets, avec comme cons&eacute;quence
qu'ils ont un droit de propri&eacute;t&eacute; sur le programme. Pour
&eacute;viter cette situation, nous avons fait tout ce qui est
n&eacute;cessaire pour que tous brevets doivent faire l'objet d'une
concession de licence qui en permette l'utilisation libre par
quiconque, ou bien qu'il ne soit pas conc&eacute;d&eacute; du
tout.
&lt;p&gt;Nous pr&eacute;sentons ci-dessous les clauses et dispositions
concernant la duplication, la distribution et la modification.

&lt;br&gt;
&lt;br&gt;
&lt;h1&gt;&lt;br&gt;
Conditions d'exploitation portant sur la duplication,
la distribution et la modification&lt;/h1&gt;
&lt;ol&gt;
&lt;p&gt;
&lt;li&gt;Le pr&eacute;sent contrat de licence s'applique &agrave; tout
programme ou autre ouvrage contenant un avis, appos&eacute; par le
d&eacute;tenteur du droit de propri&eacute;t&eacute;, disant qu'il
peut &ecirc;tre distribu&eacute; au titre des dispositions de la
pr&eacute;sente Licence Publique
G&eacute;n&eacute;rale. Ci-apr&egrave;s, le &quot;Programme&quot; d&eacute;signe
l'un quelconque de ces programmes ou ouvrages, et un &quot;ouvrage
fond&eacute; sur le programme&quot; d&eacute;signe soit le programme, soit
un ouvrage qui en d&eacute;rive au titre de la loi sur le droit
d'auteur ; plus pr&eacute;cis&eacute;ment, il s'agira d'un ouvrage
contenant le programme ou une version de ce dernier, soit mot &agrave;

mot, soit avec des modifications et/ou traduit en une autre langue
(ci-apr&egrave;s, le terme &quot;modification&quot; englobe, sans aucune
limitation, les traductions qui en sont faites). Chaque titulaire de
licence sera appel&eacute; &quot;concessionnaire&quot;.
&lt;p&gt;Les activit&eacute;s autres que la duplication, la distribution et
la modification ne sont pas couvertes par la pr&eacute;sente licence ;
elles n'entrent pas dans le cadre de cette
derni&egrave;re. L'ex&eacute;cution du programme n'est soumise
&agrave; aucune restriction, et les r&eacute;sultats du programme ne
sont couverts que si son contenu constitue un ouvrage fond&eacute; sur
le programme (ind&eacute;pendamment du fait qu'il a &eacute;t&eacute;

r&eacute;alis&eacute; par ex&eacute;cution du programme). La
v&eacute;racit&eacute; de ce qui pr&eacute;c&egrave;de d&eacute;pend
de ce que fait le programme. 
&lt;p&gt;
&lt;li&gt;Le concessionnaire peut dupliquer et distribuer des copies mot
&agrave; mot du code source du programme tel qu'il les re&ccedil;oit,
et ce sur un support quelconque, du moment qu'il appose, d'une
mani&egrave;re parfaitement visible et appropri&eacute;e, sur chaque
exemplaire, un avis appropri&eacute; de droits d'auteur (Copyright) et
de renonciation &agrave; garantie&nbsp;; qu'il maintient intacts tous
les avis qui se rapportent &agrave; la pr&eacute;sente licence et
&agrave; l'absence de toute garantie ; et qu'il transmet &agrave; tout
destinataire du programme un exemplaire de la pr&eacute;sente licence
en m&ecirc;me temps que le programme.
&lt;p&gt;Le concessionnaire peut facturer l'acte physique de transfert d'un
exemplaire, et il peut, &agrave; sa discr&eacute;tion, proposer en
&eacute;change d'une r&eacute;mun&eacute;ration une protection en
garantie.
&lt;p&gt;
&lt;li&gt;Le concessionnaire peut modifier son ou ses exemplaires du
programme ou de toute portion de ce dernier, en formant ainsi un
ouvrage fond&eacute; sur le programme, et dupliquer et distribuer ces
modifications ou cet ouvrage selon les dispositions de la section 1
ci-dessus, du moment que le concessionnaire satisfait aussi &agrave;

toutes ces conditions :
&lt;ol TYPE=&quot;a&quot;&gt;
&lt;p&gt;
&lt;li&gt;Le concessionnaire doit faire en sorte que les fichiers
modifi&eacute;s portent un avis, parfaitement visible, disant que le
concessionnaire a modifi&eacute; les fichiers, avec la date de tout
changement.
&lt;p&gt;
&lt;li&gt; Le concessionnaire doit faire en sorte que tout ouvrage qu'il
distribue ou publie, et qui, en totalit&eacute; ou en partie, contient
le programme ou une partie quelconque de ce dernier ou en
d&eacute;rive, soit conc&eacute;d&eacute; en bloc, &agrave; titre
gracieux, &agrave; tous tiers au titre des dispositions de la
pr&eacute;sente licence.

&lt;p&gt;
&lt;li&gt; Si le programme modifi&eacute; lit normalement des instructions
interactives lors de son ex&eacute;cution, le concessionnaire doit,
quand il commence l'ex&eacute;cution du programme pour une telle
utilisation interactive de la mani&egrave;re la plus usuelle, faire en
sorte que ce programme imprime ou affiche une annonce, comprenant un
avis appropri&eacute; de droits d'auteur, et un avis selon lequel il
n'y a aucune garantie (ou autrement, que le concessionnaire fournit
une garantie), et que les utilisateurs peuvent redistribuer le
programme au titre de ces dispositions, et disant &agrave;
l'utilisateur comment visualiser une copie de cette licence (exception
:<i> si le programme par lui-m&ecirc;me est interactif mais n'imprime
</I>normalement pas une telle annonce, l'ouvrage du concessionnaire se
fondant sur le programme n'a pas besoin d'imprimer une annonce).
&lt;/ol&gt;
&lt;p&gt;Les exigences ci-dessus s'appliquent &agrave; l'ouvrage
modifi&eacute; pris en bloc. Si des sections identifiables de cet
ouvrage ne d&eacute;rivent pas du programme et peuvent &ecirc;tre
consid&eacute;r&eacute;es raisonnablement comme repr&eacute;sentant
des ouvrages ind&eacute;pendants et distincts par eux-m&ecirc;mes,
alors la pr&eacute;sente licence, et ses dispositions, ne s'appliquent
pas &agrave; ces sections quand le concessionnaire les distribue sous
forme d'ouvrages distincts. Mais quand le concessionnaire distribue
ces m&ecirc;mes sections en tant qu'&eacute;l&eacute;ment d'un tout
qui repr&eacute;sente un ouvrage se fondant sur le programme, la
distribution de ce tout doit se faire conform&eacute;ment aux
dispositions de la pr&eacute;sente licence, dont les autorisations,
portant sur d'autres concessionnaires, s'&eacute;tendent &agrave; la
totalit&eacute; dont il est question, et ainsi &agrave; chacune de ces
parties, ind&eacute;pendamment de celui qu'il a &eacute;crite.

&lt;p&gt;Ainsi, cette section n'a pas pour but de revendiquer des droits ou
de contester vos droits sur un ouvrage enti&egrave;rement &eacute;crit
par le concessionnaire ; bien plus, l'intention est d'exercer le droit
de surveiller la distribution d'ouvrages d&eacute;riv&eacute;e ou
collective se fondant sur le programme.
&lt;p&gt;De plus, un simple assemblage d'un autre ouvrage ne se fondant pas
sur le programme, avec le programme (ou avec un ouvrage se fondant sur
le programme) sur un volume d'un support de stockage ou distribution,
ne fait pas entrer l'autre ouvrage dans le cadre de la pr&eacute;sente
licence.
&lt;p&gt;
&lt;li&gt; Le concessionnaire peut dupliquer et distribuer le programme (ou
un ouvrage se fondant sur ce dernier, au titre de la Section 2), en
code objet ou sous une forme ex&eacute;cutable, au titre des
dispositions des Sections 1 et 2 ci-dessus, du moment que le
concessionnaire effectue aussi l'une des op&eacute;rations suivantes :
&lt;ol TYPE=&quot;a&quot;&gt;
&lt;p&gt;

&lt;li&gt;Lui joindre le code source complet correspondant, exploitable par
une machine, code qui doit &ecirc;tre distribu&eacute; au titre des
Sections 1 et 2 ci-dessus sur un support couramment utilis&eacute;
pour l'&eacute;change de logiciels ; ou bien
&lt;p&gt;
&lt;li&gt;Lui joindre une offre &eacute;crite, dont la validit&eacute; se
prolonge pendant au moins 3 ans, de transmettre &agrave; un tiers
quelconque, pour un montant non sup&eacute;rieur au co&ucirc;t pour le
concessionnaire, de r&eacute;alisation physique de la distribution de
la source, un exemplaire complet, exploitable par une machine, du code
source correspondant, qui devra &ecirc;tre distribu&eacute; au titre
des dispositions des Sections 1 et 2 ci-dessus sur un support
couramment utilis&eacute; pour l'&eacute;change des logiciels ; ou
bien

&lt;p&gt;
&lt;li&gt;Lui joindre les informations que le concessionnaire a
re&ccedil;ues, pour proposer une distribution du code source
correspondant (cette variante n'est autoris&eacute;e que pour la
distribution non commerciale, et seulement si le concessionnaire a
re&ccedil;u le programme sous forme ex&eacute;cutable ou sous forme
d'un code objet, avec une telle offre, conform&eacute;ment &agrave;
l'alin&eacute;a b) ci-dessus).
&lt;/ol&gt;
&lt;p&gt;Le code source d'un ouvrage repr&eacute;sente la forme
pr&eacute;f&eacute;r&eacute;e de l'ouvrage pour y effectuer des
modifications. Pour un ouvrage ex&eacute;cutable, le code source
complet repr&eacute;sente la totalit&eacute; du code source pour tous
les modules qu'il contient, plus tous fichiers de d&eacute;finitions
d'interface associ&eacute;s, plus les informations en code machine
pour commander la compilation et l'installation du programme
ex&eacute;cutable. Cependant, &agrave; titre d'exceptions
sp&eacute;ciales, le code source distribu&eacute; n'a pas besoin de
comprendre quoi que ce soit qui est normalement distribu&eacute; (sous
forme source ou sous forme binaire) avec les composants principaux
(compilateur, noyau de syst&egrave;me d'exploitation, etc.) du
syst&egrave;me d'exploitation sur lequel est ex&eacute;cut&eacute; le
programme ex&eacute;cutable, &agrave; moins que le composant, par
lui-m&ecirc;me, soit joint au programme ex&eacute;cutable.

&lt;p&gt;Si la distribution de l'ex&eacute;cutable ou du code objet est
r&eacute;alis&eacute;e de telle sorte qu'elle offre d'acc&eacute;der
&agrave; une copie &agrave; partir d'un lieu d&eacute;sign&eacute;,
alors le fait d'offrir un acc&egrave;s &eacute;quivalent &agrave; la
duplication du code source &agrave; partir de ce m&ecirc;me lieu
s'entend comme distribution du code source, m&ecirc;me si des tiers ne
sont pas contraints de dupliquer la source en m&ecirc;me temps que le
code objet.

&lt;p&gt;
&lt;li&gt; Le concessionnaire ne peut dupliquer, modifier, conc&eacute;der
en sous-licence ou distribuer le programme, sauf si cela est
express&eacute;ment pr&eacute;vu par les dispositions de la
pr&eacute;sente licence. Toute tentative pour autrement dupliquer,
modifier, conc&eacute;der en sous-licence ou distribuer le programme
est r&eacute;p&eacute;t&eacute;e nulle, et met automatiquement fin aux
droits du concessionnaire au titre de la pr&eacute;sente
licence. Cependant, les parties qui ont re&ccedil;u des copies, ou des
droits, de la part du concessionnaire au titre de la pr&eacute;sente
licence, ne verront pas expirer leur contrat de licence, tant que ces
parties agissent d'une mani&egrave;re parfaitement conforme.
&lt;p&gt;

&lt;li&gt; Il n'est pas exig&eacute; du concessionnaire qu'il accepte la
pr&eacute;sente licence, car il ne l'a pas sign&eacute;e. Cependant,
rien d'autre n'octroie au concessionnaire l'autorisation de modifier
ou de distribuer le programme ou ses ouvrages
d&eacute;riv&eacute;s. Ces actions sont interdites par la loi si le
concessionnaire n'accepte pas la pr&eacute;sente licence. En
cons&eacute;quence, par le fait de modifier ou de distribuer le
programme (ou un ouvrage quelconque se fondant sur le programme), le
concessionnaire indique qu'il accepte la pr&eacute;sente licence, et
qu'il a la volont&eacute; de se conformer &agrave; toutes les clauses
et dispositions concernant la duplication, la distribution ou la
modification du programme ou d'ouvrages se fondant sur ce dernier.
&lt;p&gt;

&lt;li&gt; Chaque fois que le concessionnaire redistribue le programme (ou
tout ouvrage se fondant sur le programme), le destinataire
re&ccedil;oit automatiquement une licence de l'&eacute;metteur initial
de la licence, pour dupliquer, distribuer ou modifier le programme,
sous r&eacute;serve des pr&eacute;sentes clauses et dispositions. Le
concessionnaire ne peut imposer aucune restriction plus pouss&eacute;e
sur l'exercice, par le destinataire, des droits octroy&eacute;s au
titre des pr&eacute;sentes. Le concessionnaire n'a pas pour
responsabilit&eacute; d'exiger que des tiers se conforment &agrave; la
pr&eacute;sente licence.
&lt;p&gt;
&lt;li&gt; Si, en cons&eacute;quence une d&eacute;cision de justice ou une
all&eacute;gation d'infraction au droit des brevets, ou pour toute
autre raison (qui n'est pas limit&eacute;e &agrave; des
probl&egrave;mes de propri&eacute;t&eacute;s industrielles), des
conditions sont impos&eacute;es au concessionnaire (par
autorit&eacute; de justice, par convention ou autrement), qui entrent
en contradiction avec les dispositions de la pr&eacute;sente licence,
elles n'exemptent pas le concessionnaire de respecter les dispositions
de la pr&eacute;sente licence. Si le concessionnaire ne peut
proc&eacute;der &agrave; la distribution de fa&ccedil;on &agrave;

satisfaire simultan&eacute;ment &agrave; ces obligations au titre de
la pr&eacute;sente licence et &agrave; toutes autres obligations
pertinentes, alors, en cons&eacute;quence de ce qui
pr&eacute;c&egrave;de, le concessionnaire peut ne pas proc&eacute;der
du tout &agrave; la distribution du programme. Par exemple, si une
licence de brevet ne permettait pas une redistribution du programme,
sans redevances, par tous ceux qui re&ccedil;oivent des copies
directement ou indirectement par l'interm&eacute;diaire du
concessionnaire, alors le seul moyen par lequel le concessionnaire
pourrait satisfaire tant &agrave; cette licence de brevet qu'&agrave;

la pr&eacute;sente licence, consisterait &agrave; s'abstenir
compl&egrave;tement de distribuer le programme.
&lt;p&gt;Si une partie quelconque de cette section est
consid&eacute;r&eacute;e comme nulle ou non ex&eacute;cutoire dans
certaines circonstances particuli&egrave;res, le reste de cette
section est r&eacute;put&eacute; s'appliquer, et la section dans son
ensemble est consid&eacute;r&eacute;e comme s'appliquant dans les
autres circonstances.

&lt;p&gt;La pr&eacute;sente section n'a pas pour objet de pousser le
concessionnaire &agrave; enfreindre tous brevets ou autres
revendications &agrave; droit de propri&eacute;t&eacute;, ou encore
&agrave; contester la validit&eacute; de une ou plusieurs quelconques
de ces revendications ; la pr&eacute;sente section a pour objet unique
de prot&eacute;ger l'int&eacute;grit&eacute; du syst&egrave;me de
distribution des logiciels libres, syst&egrave;me qui est mis en
oeuvre par les pratiques li&eacute;es aux licences publiques. De
nombreuses personnes ont apport&eacute; une forte contribution

&agrave; la gamme &eacute;tendue des logiciels distribu&eacute;s par
ce syst&egrave;me, en comptant sur l'application syst&eacute;matique
de ce syst&egrave;me ; c'est &agrave; l'auteur/donateur de
d&eacute;cider s'il a la volont&eacute; de distribuer le logiciel par
un quelconque autre syst&egrave;me, et un concessionnaire ne peut
imposer ce choix.
&lt;p&gt;La pr&eacute;sente section veut rendre parfaitement claire ce que
l'on pense &ecirc;tre une cons&eacute;quence du reste de la
pr&eacute;sente licence.

&lt;p&gt;
&lt;li&gt; Si la distribution et/ou l'utilisation du Programme est
restreinte dans certains pays, sous l'effet de brevets ou d'interfaces
pr&eacute;sentant un droit d'auteur, le d&eacute;tenteur du droit
d'auteur original, qui soumet le Programme aux dispositions de la
pr&eacute;sente licence, pourra ajouter une limitation expresse de
distribution g&eacute;ographique excluant ces pays, de fa&ccedil;on
que la distribution ne soit autoris&eacute;e que dans les pays ou
parmi les pays qui ne sont pas ainsi exclus. Dans ce cas, la
limitation fait partie int&eacute;grante de la pr&eacute;sente
licence, comme si elle &eacute;tait &eacute;crite dans le corps de la
pr&eacute;sente licence.
&lt;p&gt;La Free Software Foundation peut, de temps &agrave; autre, publier
des versions r&eacute;vis&eacute;es et/ou nouvelles du General Public
License. Ces nouvelles versions seront analogues, du point de vue de
leur esprit, &agrave; la pr&eacute;sente version, mais pourront en
diff&eacute;rer dans le d&eacute;tail, pour r&eacute;soudre de
nouveaux probl&egrave;mes ou de nouvelles situations.

&lt;p&gt;Chaque version re&ccedil;oit un num&eacute;ro de version qui lui
est propre. Si le programme sp&eacute;cifie un num&eacute;ro de
version de la pr&eacute;sente licence, qui s'applique &agrave; cette
dernier et &quot;&agrave; toute autre version ult&eacute;rieure&quot;, le
concessionnaire a le choix de respecter les clauses et dispositions de
cette version, ou une quelconque version ult&eacute;rieure
publi&eacute;e par la Free Software Foundation. Si le programme ne
sp&eacute;cifie pas de num&eacute;ro de version de la pr&eacute;sente
licence, le concessionnaire pourra choisir une version quelconque
publi&eacute;e &agrave; tout moment par la Free Software
Foundation.

&lt;p&gt;
&lt;li&gt; Si le concessionnaire souhaite incorporer des parties du
programme dans d'autres programmes libres dont les conditions de
distribution sont diff&eacute;rentes, il devrait &eacute;crire
&agrave; l'auteur pour demander son autorisation. Pour un logiciel
soumis &agrave; droit d'auteur par la Free Software Foundation, il
devra &eacute;crire &agrave; la Free Software Foundation ; nous
faisons quelquefois des exceptions &agrave; cette r&egrave;gle. Notre
d&eacute;cision va &ecirc;tre guid&eacute;e par le double objectif de
prot&eacute;ger le statut libre de tous les d&eacute;riv&eacute;s de
nos logiciels libres, et de favoriser le partage et la
r&eacute;utilisation des logiciels en g&eacute;n&eacute;ral.

&lt;h1&gt;&lt;br&gt;
ABSENCE DE GARANTIE&lt;/h1&gt;
&lt;p&gt;
&lt;p&gt;
&lt;li&gt;
COMME LA LICENCE DU PROGRAMME EST CONCEDEE A
TITRE GRATUIT, IL N'Y AUCUNE GARANTIE S'APPLIQUANT AU PROGRAMME, DANS
LA MESURE AUTORISEE PAR LA LOI EN VIGUEUR. SAUF MENTION CONTRAIRE
ECRITE, LES DETENTEURS DU DROIT D'AUTEUR ET/OU LES AUTRES PARTIES
METTENT LE PROGRAMME A DISPOSITON &quot;EN L'ETAT&quot;, SANS AUCUNE GARANTIE DE
QUELQUE NATURE QUE CE SOIT, EXPRESSE OU IMPLICITE, Y COMPRIS, MAIS
SANS LIMITATION, LES GARANTIES IMPLICITES DE COMMERCIALISATION ET DE
L'APTITUDE A UN OBJET PARTICULIER. C'EST LE CONCESSIONNAIRE QUI PREND
LA TOTALITE DU RISQUE QUANT A LA QUALITE ET AUX PERFORMANCES DU
PROGRAMME. SI LE PROGRAMME SE REVELAIT DEFECTUEUX, C'EST LE
CONCESSIONNAIRE QUI PRENDRAIT A SA CHARGE LE COUT DE L'ENSEMBLE DES
OPERATIONS NECESSAIRES D'ENTRETIEN, REPARATION OU CORRECTION.
&lt;li&gt;EN AUCUN CAS, SAUF SI LA LOI EN VIGUEUR L'EXIGE OU SI UNE
CONVENTION ECRITE EXISTE A CE SUJET, AUCUN DETENTEUR DE DROITS
D'AUTEUR, OU AUCUNE PARTIE AYANT LE POUVOIR DE MODIFIER ET/OU DE
REDISTRIBUER LE PROGRAMME CONFORMEMENT AUX AUTORISATIONS CI-DESSUS,
N'EST RESPONSABLE VIS-A-VIS DU CONCESSIONNAIRE POUR CE QUI EST DES
DOMMAGES, Y COMPRIS TOUS DOMMAGES GENERAUX, SPECIAUX, ACCIDENTELS OU
INDIRECTS, RESULTANT DE L'UTILISATION OU DU PROGRAMME OU DE
L'IMPOSSIBILITE D'UTILISER LE PROGRAMME (Y COMPRIS, MAIS SANS
LIMITATION, LA PERTE DE DONNEES, OU LE FAIT QUE DES DONNEES SONT
RENDUES IMPRECISES, OU ENCORE LES PERTES EPROUVEES PAR LE
CONCESSIONNAIRE OU PAR DES TIERS, OU ENCORE UN MANQUEMENT DU PROGRAMME
A FONCTIONNER AVEC TOUS AUTRES PROGRAMMES), MEME SI CE DETENTEUR OU
CETTE AUTRE PARTIE A ETE AVISE DE LA POSSIBILITE DE TELS DOMMAGES.

&lt;/ol&gt;
&lt;br&gt;
&lt;div align=&quot;center&quot;&gt;
&lt;b&gt;
FIN DES CONDITIONS D'EXPLOITATION
&lt;/b&gt;
&lt;/div&gt;
&lt;p&gt;

&lt;hr&gt;

&lt;h1&gt;&lt;br&gt;
Comment appliquer ces dispositions a vos nouveaux programmes?&lt;/h1&gt;
&lt;/b&gt;&lt;p&gt;Si le concessionnaire d&eacute;veloppe un nouveau programme, et s'il en souhaite l'utilisation la plus large possible dans le public, le meilleur moyen d'y arriver est d'en faire un logiciel libre, que tout le monde pourra redistribuer et modifier au titre des pr&eacute;sentes dispositions.
&lt;p&gt;Dans ce but, il convient de rattacher au programme les avis suivants. Le moyen le plus s&ucirc;r consiste &agrave; les rattacher au d&eacute;but de chaque fichier source, pour avertir le plus efficacement possible de l'exclusion de garantie ; et chaque fichier doit comporter au moins la ligne &quot;copyright&quot;, et un pointeur indiquant o&ugrave; est localis&eacute;e la totalit&eacute; de l'avis.

&lt;tt&gt;
&lt;i&gt;&lt;p&gt;Une ligne pour donner le nom du programme et une id&eacute;e de ce qu'il fait.
&lt;/i&gt;&lt;p&gt;Copyright (C) 19&lt;i&gt;yy&lt;/i&gt; &lt;i&gt;nom de l'auteur
&lt;/i&gt;&lt;p&gt;Ce programme est un logiciel libre ; vous pouvez le
redistribuer et/ou le modifier conform&eacute;ment aux dispositions de
la Licence Publique G&eacute;n&eacute;rale GNU, telle que
publi&eacute;e par la Free Software Foundation ; version 2 de la
licence, ou encore (&agrave; votre choix) toute version
ult&eacute;rieure.

&lt;p&gt;Ce programme est distribu&eacute; dans l'espoir qu'il sera utile,
mais SANS AUCUNE GARANTIE ; sans m&ecirc;me la garantie implicite de
COMMERCIALISATION ou D'ADAPTATION A UN OBJET PARTICULIER. Pour plus de
d&eacute;tail, voir la Licence Publique G&eacute;n&eacute;rale GNU
.
&lt;p&gt;Vous devez avoir re&ccedil;u un exemplaire de la Licence Publique
G&eacute;n&eacute;rale GNU en m&ecirc;me temps que ce programme ; si
ce n'est pas le cas, &eacute;crivez &agrave; la Free Software
Foundation Inc., 675 Mass Ave, Cambridge, MA 02139, Etats-Unis.

&lt;/tt&gt;
&lt;p&gt;Ajoutez aussi des informations sur le moyen permettant
d'entrer en contact avec vous par courrier &eacute;lectronique
(e-mail) et courrier normal.
&lt;p&gt;Si le programme est interactif, pr&eacute;voyez en sortie un court
avis, tel que celui qui est pr&eacute;sent&eacute; ci-dessous, lors du
d&eacute;marrage en mode interactif.
&lt;tt&gt;
&lt;p&gt;Gnomovision version 69, Copyright (C) 19 &lt;i&gt;yy nom de
l'auteur
&lt;/i&gt;&lt;p&gt;Gnomovision est livr&eacute; absolument SANS AUCUNE GARANTIE ;
pour plus de d&eacute;tail, tapez &quot;show w&quot;. Il s'agit d'un logiciel
libre, et vous avez le droit de le redistribuer dans certaines
conditions ; pour plus de d&eacute;tail, tapez &quot;show c&quot;.

&lt;/tt&gt;
&lt;p&gt;Les instructions hypoth&eacute;tiques &lt;/font&gt;&quot;show w&quot;&lt;font&gt;
et &lt;/font&gt;&quot;show c&quot;&lt;font&gt; doivent pr&eacute;senter les parties
appropri&eacute;es de la Licence Publique G&eacute;n&eacute;rale. Bien
&eacute;videmment, les instructions que vous utilisez peuvent porter
d'autres noms que &lt;/font&gt;&quot;show w&quot;&lt;font&gt; et &lt;/font&gt;&quot;show
c&quot;&nbsp;&lt;font&gt;; elles peuvent m&ecirc;me correspondre &agrave; des
clics de souris ou &agrave; des &eacute;l&eacute;ments d'un menu,
selon ce qui convient &agrave; votre programme.

&lt;p&gt;Si n&eacute;cessaire, vous devrez aussi demander &agrave; votre
employeur (si vous travaillez en tant que programmeur) ou &agrave;
votre &eacute;ventuelle &eacute;cole ou universit&eacute;, de signer
une &quot;renonciation &agrave; droit d'auteur&quot; concernant le programme. En
voici un &eacute;chantillon (il suffit de modifier les noms) :
&lt;tt&gt;
&lt;p&gt;Yoyodyne, Inc., par la pr&eacute;sente, renonce &agrave; tout int&eacute;r&ecirc;t de droits d'auteur dans le programme &quot;Gnomovision&quot; (qui fait des passages au niveau des compilateurs) &eacute;crit par James Hacker.

&lt;i&gt;&lt;p&gt;Signature de Ty Coon&lt;/i&gt;, 1&lt;sup&gt;er&lt;/sup&gt; avril 1989
&lt;p&gt;Ty Coon, President of Vice
&lt;/tt&gt;
&lt;p&gt;La pr&eacute;sente Licence Publique G&eacute;n&eacute;rale
n'autorise pas le concessionnaire &agrave; incorporer son programme
dans des programmes propri&eacute;taires. Si votre programme est une
biblioth&egrave;que de sous-programmes, vous pouvez consid&eacute;rer
comme plus int&eacute;ressant d'autoriser une &eacute;dition de liens
des applications propri&eacute;taires avec la biblioth&egrave;que. Si
c'est ce que vous souhaitez, vous devrez utiliser non pas la
pr&eacute;sente licence, mais la Licence Publique
G&eacute;n&eacute;rale pour Biblioth&egrave;ques GNU.

&lt;/body&gt;
&lt;/html&gt;

--- NEW FILE: inc_serialbase.php3 ---
&lt;?php

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_SERIALBASE&quot;)) return;
define(&quot;_ECRIRE_INC_SERIALBASE&quot;, &quot;1&quot;);


$spip_articles = array(
		&quot;id_article&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;surtitre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;soustitre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;id_rubrique&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;descriptif&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;chapo&quot;	=&gt; &quot;mediumtext NOT NULL&quot;,
		&quot;texte&quot;	=&gt; &quot;longblob NOT NULL&quot;,
		&quot;ps&quot;	=&gt; &quot;mediumtext NOT NULL&quot;,
		&quot;date&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;statut&quot;	=&gt; &quot;varchar(10) DEFAULT '0' NOT NULL&quot;,
		&quot;id_secteur&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;,
		&quot;export&quot;	=&gt; &quot;VARCHAR(10) DEFAULT 'oui'&quot;,
		&quot;date_redac&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;visites&quot;	=&gt; &quot;INTEGER DEFAULT '0' NOT NULL&quot;,
		&quot;referers&quot;	=&gt; &quot;INTEGER DEFAULT '0' NOT NULL&quot;,
		&quot;popularite&quot;	=&gt; &quot;DOUBLE DEFAULT '0' NOT NULL&quot;,
		&quot;accepter_forum&quot;	=&gt; &quot;CHAR(3) NOT NULL&quot;,
		&quot;auteur_modif&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;date_modif&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;lang&quot;		=&gt; &quot;VARCHAR(10) DEFAULT '' NOT NULL&quot;,
		&quot;langue_choisie&quot;	=&gt; &quot;VARCHAR(3) DEFAULT 'non'&quot;,
		&quot;id_trad&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;extra&quot;		=&gt; &quot;longblob NULL&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;id_version&quot;	=&gt; &quot;int unsigned DEFAULT '0' NOT NULL&quot;,
		&quot;nom_site&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;url_site&quot;	=&gt; &quot;VARCHAR(255) NOT NULL&quot;,
		&quot;url_propre&quot; =&gt; &quot;VARCHAR(255) NOT NULL&quot;);

$spip_articles_key = array(
		&quot;PRIMARY KEY&quot;		=&gt; &quot;id_article&quot;,
		&quot;KEY id_rubrique&quot;	=&gt; &quot;id_rubrique&quot;,
		&quot;KEY id_secteur&quot;	=&gt; &quot;id_secteur&quot;,
		&quot;KEY id_trad&quot;		=&gt; &quot;id_trad&quot;,
		&quot;KEY lang&quot;			=&gt; &quot;lang&quot;,
		&quot;KEY statut&quot;		=&gt; &quot;statut, date&quot;,
		&quot;KEY url_site&quot;		=&gt; &quot;url_site&quot;,
		&quot;KEY date_modif&quot;	=&gt; &quot;date_modif&quot;,
		&quot;KEY idx&quot;			=&gt; &quot;idx&quot;,
		&quot;KEY url_propre&quot;	=&gt; &quot;url_propre&quot;);

$spip_auteurs = array(
		&quot;id_auteur&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;nom&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;bio&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;email&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;nom_site&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;url_site&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;login&quot;	=&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
		&quot;pass&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;low_sec&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;statut&quot;	=&gt; &quot;VARCHAR(255) NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;,
		&quot;pgp&quot;	=&gt; &quot;BLOB NOT NULL&quot;,
		&quot;htpass&quot;	=&gt; &quot;tinyblob NOT NULL&quot;,
		&quot;en_ligne&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;imessage&quot;	=&gt; &quot;VARCHAR(3) NOT NULL&quot;,
		&quot;messagerie&quot;	=&gt; &quot;VARCHAR(3) NOT NULL&quot;,
		&quot;alea_actuel&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;alea_futur&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;prefs&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;cookie_oubli&quot;	=&gt; &quot;tinytext NOT NULL&quot;,
		&quot;source&quot;	=&gt; &quot;VARCHAR(10) DEFAULT 'spip' NOT NULL&quot;,
		&quot;lang&quot;	=&gt; &quot;VARCHAR(10) DEFAULT '' NOT NULL&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;extra&quot;	=&gt; &quot;longblob NULL&quot;);

$spip_auteurs_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_auteur&quot;,
		&quot;KEY login&quot;	=&gt; &quot;login&quot;,
		&quot;KEY statut&quot;	=&gt; &quot;statut&quot;,
		&quot;KEY lang&quot;	=&gt; &quot;lang&quot;,
		&quot;KEY idx&quot;	=&gt; &quot;idx&quot;,
		&quot;KEY en_ligne&quot;	=&gt; &quot;en_ligne&quot;);

$spip_breves = array(
		&quot;id_breve&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;date_heure&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;texte&quot;	=&gt; &quot;longblob NOT NULL&quot;,
		&quot;lien_titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;lien_url&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;statut&quot;	=&gt; &quot;varchar(6) NOT NULL&quot;,
		&quot;id_rubrique&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;lang&quot;	=&gt; &quot;VARCHAR(10) DEFAULT '' NOT NULL&quot;,
		&quot;langue_choisie&quot;	=&gt; &quot;VARCHAR(3) DEFAULT 'non'&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;extra&quot;	=&gt; &quot;longblob NULL&quot;,
		&quot;url_propre&quot; =&gt; &quot;VARCHAR(255) NOT NULL&quot;);

$spip_breves_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_breve&quot;,
		&quot;KEY idx&quot;	=&gt; &quot;idx&quot;,
		&quot;KEY id_rubrique&quot;	=&gt; &quot;id_rubrique&quot;,
		&quot;KEY url_propre&quot;	=&gt; &quot;url_propre&quot;);

$spip_messages = array(
		&quot;id_message&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;texte&quot;	=&gt; &quot;longblob NOT NULL&quot;,
		&quot;type&quot;	=&gt; &quot;varchar(6) NOT NULL&quot;,
		&quot;date_heure&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;date_fin&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;rv&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;statut&quot;	=&gt; &quot;varchar(6) NOT NULL&quot;,
		&quot;id_auteur&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;);

$spip_messages_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_message&quot;,
		&quot;KEY id_auteur&quot;	=&gt; &quot;id_auteur&quot;);

$spip_mots = array(
		&quot;id_mot&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;type&quot;	=&gt; &quot;VARCHAR(100) NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;descriptif&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;texte&quot;	=&gt; &quot;longblob NOT NULL&quot;,
		&quot;id_groupe&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;extra&quot;	=&gt; &quot;longblob NULL&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;url_propre&quot; =&gt; &quot;VARCHAR(255) NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;);

$spip_mots_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_mot&quot;,
		&quot;KEY idx&quot;	=&gt; &quot;idx&quot;,
		&quot;KEY type&quot;	=&gt; &quot;type&quot;,
		&quot;KEY url_propre&quot;	=&gt; &quot;url_propre&quot;);

$spip_groupes_mots = array(
		&quot;id_groupe&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;unseul&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;obligatoire&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;articles&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;breves&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;rubriques&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;syndic&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;0minirezo&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;1comite&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;6forum&quot;	=&gt; &quot;varchar(3) NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;);

$spip_groupes_mots_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_groupe&quot;);

$spip_rubriques = array(
		&quot;id_rubrique&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;id_parent&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;descriptif&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;texte&quot;	=&gt; &quot;longblob NOT NULL&quot;,
		&quot;id_secteur&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;,
		&quot;export&quot;	=&gt; &quot;VARCHAR(10) DEFAULT 'oui'&quot;,
		&quot;id_import&quot;	=&gt; &quot;BIGINT DEFAULT '0'&quot;,
		&quot;statut&quot;	=&gt; &quot;VARCHAR(10) NOT NULL&quot;,
		&quot;date&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;lang&quot;	=&gt; &quot;VARCHAR(10) DEFAULT '' NOT NULL&quot;,
		&quot;langue_choisie&quot;	=&gt; &quot;VARCHAR(3) DEFAULT 'non'&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;extra&quot;	=&gt; &quot;longblob NULL&quot;,
		&quot;url_propre&quot; =&gt; &quot;VARCHAR(255) NOT NULL&quot;,
		&quot;statut_tmp&quot;	=&gt; &quot;VARCHAR(10) NOT NULL&quot;,
		&quot;date_tmp&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;
		);

$spip_rubriques_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_rubrique&quot;,
		&quot;KEY lang&quot;	=&gt; &quot;lang&quot;,
		&quot;KEY idx&quot;	=&gt; &quot;idx&quot;,
		&quot;KEY id_parent&quot;	=&gt; &quot;id_parent&quot;,
		&quot;KEY url_propre&quot;	=&gt; &quot;url_propre&quot;);

$spip_documents = array(
		&quot;id_document&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;id_vignette&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;id_type&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;date&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;descriptif&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;fichier&quot;	=&gt; &quot;varchar(255) NOT NULL&quot;,
		&quot;taille&quot;	=&gt; &quot;integer NOT NULL&quot;,
		&quot;largeur&quot;	=&gt; &quot;integer NOT NULL&quot;,
		&quot;hauteur&quot;	=&gt; &quot;integer NOT NULL&quot;,
		&quot;mode&quot;	=&gt; &quot;ENUM('vignette', 'document') NOT NULL&quot;,
		&quot;inclus&quot;	=&gt; &quot;VARCHAR(3) DEFAULT 'non'&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;);

$spip_documents_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_document&quot;,
		&quot;KEY id_vignette&quot;	=&gt; &quot;id_vignette&quot;,
		&quot;KEY mode&quot;	=&gt; &quot;mode&quot;,
		&quot;KEY id_type&quot;	=&gt; &quot;id_type&quot;);

$spip_types_documents = array(
		&quot;id_type&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;descriptif&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;extension&quot;	=&gt; &quot;varchar(10) NOT NULL&quot;,
		&quot;mime_type&quot;	=&gt; &quot;varchar(100) NOT NULL&quot;,
		&quot;inclus&quot;	=&gt; &quot;ENUM('non', 'image', 'embed') NOT NULL DEFAULT 'non'&quot;,
		&quot;upload&quot;	=&gt; &quot;ENUM('oui', 'non') NOT NULL DEFAULT 'oui'&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;);

$spip_types_documents_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_type&quot;,
		&quot;UNIQUE extension&quot;	=&gt; &quot;extension&quot;,
		&quot;KEY inclus&quot;	=&gt; &quot;inclus&quot;);

$spip_syndic = array(
		&quot;id_syndic&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;id_rubrique&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;id_secteur&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;nom_site&quot;	=&gt; &quot;blob NOT NULL&quot;,
		&quot;url_site&quot;	=&gt; &quot;blob NOT NULL&quot;,
		&quot;url_syndic&quot;	=&gt; &quot;blob NOT NULL&quot;,
		&quot;descriptif&quot;	=&gt; &quot;blob NOT NULL&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;,
		&quot;syndication&quot;	=&gt; &quot;VARCHAR(3) NOT NULL&quot;,
		&quot;statut&quot;	=&gt; &quot;VARCHAR(10) NOT NULL&quot;,
		&quot;date&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;date_syndic&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;date_index&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;moderation&quot;	=&gt; &quot;VARCHAR(3) NOT NULL&quot;);

$spip_syndic_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_syndic&quot;,
		&quot;KEY id_rubrique&quot;	=&gt; &quot;id_rubrique&quot;,
		&quot;KEY id_secteur&quot;	=&gt; &quot;id_secteur&quot;,
		&quot;KEY idx&quot;		=&gt; &quot;idx&quot;,
		&quot;KEY statut&quot;	=&gt; &quot;statut, date_syndic&quot;);

$spip_syndic_articles = array(
		&quot;id_syndic_article&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;id_syndic&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;url&quot;	=&gt; &quot;VARCHAR(255) NOT NULL&quot;,
		&quot;date&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;lesauteurs&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;,
		&quot;statut&quot;	=&gt; &quot;VARCHAR(10) NOT NULL&quot;,
		&quot;descriptif&quot;	=&gt; &quot;blob NOT NULL&quot;);

$spip_syndic_articles_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_syndic_article&quot;,
		&quot;KEY id_syndic&quot;	=&gt; &quot;id_syndic&quot;,
		&quot;KEY statut&quot;	=&gt; &quot;statut&quot;,
		&quot;KEY url&quot;	=&gt; &quot;url&quot;);

$spip_forum = array(
		&quot;id_forum&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;id_parent&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;id_thread&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;id_rubrique&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;id_article&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;id_breve&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;date_heure&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;titre&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;texte&quot;	=&gt; &quot;mediumtext NOT NULL&quot;,
		&quot;auteur&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;email_auteur&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;nom_site&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;url_site&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;statut&quot;	=&gt; &quot;varchar(8) NOT NULL&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;ip&quot;	=&gt; &quot;varchar(16)&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;,
		&quot;id_auteur&quot;	=&gt; &quot;BIGINT DEFAULT '0' NOT NULL&quot;,
		&quot;id_message&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;id_syndic&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;);

$spip_forum_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_forum&quot;,
		&quot;KEY id_parent&quot;	=&gt; &quot;id_parent&quot;,
		&quot;KEY id_rubrique&quot;	=&gt; &quot;id_rubrique&quot;,
		&quot;KEY id_article&quot;	=&gt; &quot;id_article&quot;,
		&quot;KEY id_breve&quot;	=&gt; &quot;id_breve&quot;,
		&quot;KEY id_message&quot;	=&gt; &quot;id_message&quot;,
		&quot;KEY id_syndic&quot;	=&gt; &quot;id_syndic&quot;,
		&quot;KEY idx&quot;	=&gt; &quot;idx&quot;,
		&quot;KEY statut&quot;	=&gt; &quot;statut, date_heure&quot;);

$spip_signatures = array(
		&quot;id_signature&quot;	=&gt; &quot;bigint(21) NOT NULL&quot;,
		&quot;id_article&quot;	=&gt; &quot;bigint(21) DEFAULT '0' NOT NULL&quot;,
		&quot;date_time&quot;	=&gt; &quot;datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;,
		&quot;nom_email&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;ad_email&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;nom_site&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;url_site&quot;	=&gt; &quot;text NOT NULL&quot;,
		&quot;message&quot;	=&gt; &quot;mediumtext NOT NULL&quot;,
		&quot;statut&quot;	=&gt; &quot;varchar(10) NOT NULL&quot;,
		&quot;idx&quot;		=&gt; &quot;ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;,
		&quot;maj&quot;	=&gt; &quot;TIMESTAMP&quot;);

$spip_signatures_key = array(
		&quot;PRIMARY KEY&quot;	=&gt; &quot;id_signature&quot;,
		&quot;KEY id_article&quot;	=&gt; &quot;id_article&quot;,
		&quot;KEY idx&quot;		=&gt; &quot;idx&quot;,
		&quot;KEY statut&quot; =&gt; &quot;statut&quot;);

global $tables_principales;

/// Attention: mes_fonctions peut avoir deja defini cette variable
/// il faut donc rajouter, mais pas reinitialiser

$tables_principales['articles'] =
	array('field' =&gt; &amp;$spip_articles, 'key' =&gt; &amp;$spip_articles_key);
$tables_principales['auteurs']  =
	array('field' =&gt; &amp;$spip_auteurs, 'key' =&gt; &amp;$spip_auteurs_key);
$tables_principales['breves']   =
	array('field' =&gt; &amp;$spip_breves, 'key' =&gt; &amp;$spip_breves_key);
$tables_principales['messages'] =
	array('field' =&gt; &amp;$spip_messages, 'key' =&gt; &amp;$spip_messages_key);
$tables_principales['mots']     =
	array('field' =&gt; &amp;$spip_mots, 'key' =&gt; &amp;$spip_mots_key);
$tables_principales['groupes_mots'] =
	array('field' =&gt; &amp;$spip_groupes_mots, 'key' =&gt; &amp;$spip_groupes_mots_key);
$tables_principales['rubriques'] =
	array('field' =&gt; &amp;$spip_rubriques, 'key' =&gt; &amp;$spip_rubriques_key);
$tables_principales['documents'] =
	array('field' =&gt; &amp;$spip_documents,  'key' =&gt; &amp;$spip_documents_key);
$tables_principales['types_documents']	=
	array('field' =&gt; &amp;$spip_types_documents, 'key' =&gt; &amp;$spip_types_documents_key);
$tables_principales['syndic'] =
	array('field' =&gt; &amp;$spip_syndic, 'key' =&gt; &amp;$spip_syndic_key);
$tables_principales['syndic_articles']	=
	array('field' =&gt; &amp;$spip_syndic_articles, 'key' =&gt; &amp;$spip_syndic_articles_key);
$tables_principales['forum'] =
	array('field' =&gt; &amp;$spip_forum,	'key' =&gt; &amp;$spip_forum_key);
$tables_principales['signatures'] =
	array('field' =&gt; &amp;$spip_signatures, 'key' =&gt; &amp;$spip_signatures_key);

?&gt;

--- NEW FILE: auteurs_edit.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_acces.php3&quot;);
include_ecrire (&quot;inc_index.php3&quot;);
include_ecrire (&quot;inc_logos.php3&quot;);

function supp_auteur($id_auteur) {
	$query=&quot;UPDATE spip_auteurs SET statut='5poubelle' WHERE id_auteur=$id_auteur&quot;;
	$result=spip_query($query);
}


function afficher_auteur_rubriques($leparent){
	global $id_parent;
	global $id_rubrique;
	global $toutes_rubriques;
	global $i;
	
	$i++;
 	$query=&quot;SELECT * FROM spip_rubriques WHERE id_parent='$leparent' ORDER BY titre&quot;;
 	$result=spip_query($query);

	while($row=spip_fetch_array($result)){
		$my_rubrique=$row[&quot;id_rubrique&quot;];
		$titre=typo($row[&quot;titre&quot;]);
	
		if (!ereg(&quot;,$my_rubrique,&quot;,&quot;$toutes_rubriques&quot;)){
			$espace=&quot;&quot;;
			for ($count=0;$count&lt;$i;$count++){$espace.=&quot;&nbsp;&nbsp;&quot;;}
			$espace .= &quot;|&quot;;
			if ($i==1)
				$espace = &quot;*&quot;;

			echo &quot;&lt;OPTION VALUE='$my_rubrique'&gt;$espace &quot;.supprimer_tags($titre).&quot;\n&quot;;
			afficher_auteur_rubriques($my_rubrique);
		}
	}
	$i=$i-1;
}


$query = &quot;SELECT * FROM spip_auteurs WHERE id_auteur='$id_auteur'&quot;;
$result = spip_query($query);


if ($row = spip_fetch_array($result)) {
	$id_auteur=$row['id_auteur'];
	$nom=$row['nom'];
	$bio=$row['bio'];
	$email=$row['email'];
	$nom_site_auteur=$row['nom_site'];
	$url_site=$row['url_site'];
	$login=$row['login'];
	$pass=$row['pass'];
	$statut=$row['statut'];
	$pgp=$row[&quot;pgp&quot;];
	$messagerie=$row[&quot;messagerie&quot;];
	$imessage=$row[&quot;imessage&quot;];
	$extra = $row[&quot;extra&quot;];
	$low_sec = $row[&quot;low_sec&quot;];


if ($connect_id_auteur == $id_auteur) debut_page($nom, &quot;auteurs&quot;, &quot;perso&quot;);
else debut_page($nom,&quot;auteurs&quot;,&quot;redacteurs&quot;);


echo &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;

debut_gauche();



debut_boite_info();

echo &quot;&lt;CENTER&gt;&quot;;

echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=1&gt;&lt;B&gt;&quot;._T('info_gauche_numero_auteur').&quot;&nbsp;:&lt;/B&gt;&lt;/FONT&gt;&quot;;
echo &quot;&lt;BR&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=6&gt;&lt;B&gt;$id_auteur&lt;/B&gt;&lt;/FONT&gt;&quot;;
echo &quot;&lt;/CENTER&gt;&quot;;

fin_boite_info();




//////////////////////////////////////////////////////
// Logos de l'auteur
//

$arton = &quot;auton$id_auteur&quot;;
$artoff = &quot;autoff$id_auteur&quot;;

if ($id_auteur&gt;0 AND (($connect_statut == '0minirezo') OR ($connect_id_auteur == $id_auteur)))
	afficher_boite_logo($arton, $artoff, _T('logo_auteur').aide (&quot;logoart&quot;), _T('logo_survol'));


debut_droite();

function mySel($varaut,$variable) {
	$retour = &quot; VALUE=\&quot;$varaut\&quot;&quot;;
	if ($variable==$varaut){
		$retour.= &quot; SELECTED&quot;;
	}
	return $retour;
}

	debut_cadre_relief(&quot;redacteurs-24.gif&quot;);
	
	
	echo &quot;&lt;table width='100%' cellpadding='0' border='0' cellspacing='0'&gt;&quot;;
	
	echo &quot;&lt;tr&gt;&quot;;

	echo &quot;&lt;td valign='top' width='100%'&gt;&quot;;	


	gros_titre($nom);

	echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;

	if (strlen($email) &gt; 2) echo &quot;&lt;div&gt;&quot;._T('email_2').&quot; &lt;B&gt;&lt;A HREF='mailto:$email'&gt;$email&lt;/A&gt;&lt;/B&gt;&lt;/div&gt;&quot;;
	if (strlen($nom_site_auteur) &gt; 2) echo &quot;&lt;div&gt;&quot;._T('info_site_2').&quot; &lt;B&gt;&lt;A HREF='$url_site'&gt;$nom_site_auteur&lt;/A&gt;&lt;/B&gt;&lt;/div&gt;&quot;;

		
	echo &quot;&lt;/td&gt;&quot;;
	
	echo &quot;&lt;td&gt;&quot;;
	
	if (($connect_statut == &quot;0minirezo&quot;) OR $connect_id_auteur == $id_auteur) {
		icone (_T(&quot;admin_modifier_auteur&quot;), &quot;auteur_infos.php3?id_auteur=$id_auteur&quot;, &quot;redacteurs-24.gif&quot;, &quot;edit.gif&quot;);
	}
	echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;

	if (strlen($bio) &gt; 0) { echo &quot;&lt;div&gt;&quot;.propre(&quot;&lt;quote&gt;&quot;.$bio.&quot;&lt;/quote&gt;&quot;).&quot;&lt;/div&gt;&quot;; }
	if (strlen($pgp) &gt; 0) { echo &quot;&lt;div&gt;&quot;.propre(&quot;PGP:&lt;cadre&gt;&quot;.$pgp.&quot;&lt;/cadre&gt;&quot;).&quot;&lt;/div&gt;&quot;; }

	if ($champs_extra AND $extra) {
		include_ecrire(&quot;inc_extra.php3&quot;);
		extra_affichage($extra, &quot;auteurs&quot;);
	}


	fin_cadre_relief();


echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
if ($connect_statut == &quot;0minirezo&quot;) $aff_art = &quot;'prepa','prop','publie','refuse'&quot;;
else if ($connect_id_auteur == $id_auteur) $aff_art = &quot;'prepa','prop','publie'&quot;;
else $aff_art = &quot;'prop','publie'&quot;;

afficher_articles(_T('info_articles_auteur'),
	&quot;, spip_auteurs_articles AS lien WHERE lien.id_auteur='$id_auteur' &quot;.
	&quot;AND lien.id_article=articles.id_article AND articles.statut IN ($aff_art) &quot;.
	&quot;ORDER BY articles.date DESC&quot;, true);
}


if ($id_auteur != $connect_id_auteur) {
	echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
	debut_cadre_couleur();
	
	$query_message = &quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien, spip_auteurs_messages AS lien2 &quot;.
		&quot;WHERE lien.id_auteur=$connect_id_auteur AND lien2.id_auteur = $id_auteur AND statut='publie' AND type='normal' AND rv!='oui' AND lien.id_message=messages.id_message AND lien2.id_message=messages.id_message&quot;;
	afficher_messages(_T('info_discussion_cours'), $query_message, false, false);
	
	$query_message = &quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien, spip_auteurs_messages AS lien2 &quot;.
		&quot;WHERE lien.id_auteur=$connect_id_auteur AND lien2.id_auteur = $id_auteur AND statut='publie' AND type='normal' AND rv='oui' AND date_fin &gt; NOW() AND lien.id_message=messages.id_message AND lien2.id_message=messages.id_message&quot;;
	afficher_messages(_T('info_vos_rendez_vous'), $query_message, false, false);
	
	icone_horizontale(_T('info_envoyer_message_prive'),&quot;message_edit.php3?new=oui&amp;type=normal&amp;dest=$id_auteur&quot;, &quot;message.gif&quot;);
	fin_cadre_couleur();
}

fin_page();

?&gt;

--- NEW FILE: cartes.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);

include_ecrire (&quot;inc_carto.php3&quot;);


debut_page(_L(&quot;Toutes les cartes&quot;), &quot;documents&quot;, &quot;cartes&quot;);
debut_gauche();



debut_droite();



afficher_cartes(_L(&quot;Toutes les cartes&quot;),
	&quot;SELECT cartes.*, COUNT(id_objet) AS objets &quot;.
	&quot;FROM spip_carto_carte AS cartes LEFT JOIN spip_carto_objet AS objets &quot;.
	&quot;ON (cartes.id_carte=objets.id_carte) &quot;.
	&quot;GROUP BY cartes.id_carte ORDER BY cartes.titre&quot;);
//TODO : gerer un statut par objet
//ajouter cette clause &#224; la jointure :
//// AND objets.statut='valide'

//TODO : afficher par lot.
//peut etre par id_srs ... &#224; voir
//WHERE id_srs='$x' 
echo &quot;&lt;br /&gt;\n&quot;;

if (carte_editable()) {
	echo &quot;&lt;div align='right'&gt;&quot;;
	$link = new Link('carte_edit.php3');
	$link-&gt;addVar('new', 'oui');
	$link-&gt;addVar('retour', $clean_link-&gt;getUrl());
	icone(_L(&quot;Cr&eacute;er une nouvelle carte&quot;), $link-&gt;getUrl(), &quot;carte-24.gif&quot;, &quot;creer.gif&quot;);
	echo &quot;&lt;/div&gt;&quot;;
}



fin_page();

?&gt;


--- NEW FILE: aide_index.php3 ---
&lt;?php

include (&quot;inc_version.php3&quot;);
include_ecrire (&quot;inc_presentation.php3&quot;);


// Eviter les calculs evitables (surtout en client/serveur sans cache !)
$lastmodified = filemtime(&quot;aide_index.php3&quot;);
$headers_only = http_last_modified($lastmodified, time() + 24 * 3600);
if ($headers_only) exit;

include_ecrire (&quot;inc_filtres.php3&quot;);
include_ecrire (&quot;inc_layer.php3&quot;);
include_ecrire (&quot;inc_texte.php3&quot;);

// Recuperer les infos de langue (preferences auteur), si possible
if (_FILE_CONNECT) {
	include_ecrire (&quot;inc_auth.php3&quot;);
}
include_ecrire (&quot;inc_lang.php3&quot;);
utiliser_langue_visiteur();
if ($var_lang) changer_langue($var_lang);

/////////////////////////////
// La frame de base
//
function help_frame ($aide) {
	global $spip_lang;

	echo &quot;&lt;/head&gt;\n&quot;;

	$frame_menu = &quot;&lt;frame src=\&quot;aide_index.php3?aide=$aide&amp;var_lang=$spip_lang&amp;frame=menu\&quot; name=\&quot;gauche\&quot; scrolling=\&quot;auto\&quot; noresize&gt;\n&quot;;
	$frame_body = &quot;&lt;frame src=\&quot;aide_index.php3?aide=$aide&amp;var_lang=$spip_lang&amp;frame=body\&quot; name=\&quot;droite\&quot; scrolling=\&quot;auto\&quot; noresize&gt;\n&quot;;

	if ($GLOBALS['spip_lang_rtl']) {
		echo '&lt;frameset cols=&quot;*,160&quot; border=&quot;0&quot; frameborder=&quot;0&quot; framespacing=&quot;0&quot;&gt;';
		echo $frame_body.$frame_menu;
	}
	else {
		echo '&lt;frameset cols=&quot;160,*&quot; border=&quot;0&quot; frameborder=&quot;0&quot; framespacing=&quot;0&quot;&gt;';
		echo $frame_menu.$frame_body;
	}
	echo '&lt;/frameset&gt;';
	echo &quot;\n&lt;/html&gt;&quot;;
}



/////////////////////////////
// Le contenu demande
//

// Selection de l'aide correspondant a la langue demandee
function fichier_aide($lang_aide = '') {
	global $help_server;

	if (!$lang_aide) $lang_aide = $GLOBALS['spip_lang'];

	// fichier local ?
	if (@file_exists($fichier_aide = &quot;AIDE/$lang_aide/aide.html&quot;)) 
		return array(file($fichier_aide), $lang_aide);

	// fichier local ? si reduction ISO du code langue oc_prv_ni =&gt; oc
	else if (ereg(&quot;(.*)_&quot;, $lang_aide, $regs)
		AND (@file_exists($fichier_aide = &quot;AIDE/&quot;.$regs[1].&quot;/aide.html&quot;)))
			return array(file($fichier_aide), $regs[1]);

	// Aide internet
	else {
		// en cache ?
		if (!@file_exists($fichier_aide = _DIR_CACHE . &quot;aide-$lang_aide-aide.html&quot;)) {
			if ($help_server) {
				include_ecrire('inc_sites.php3');
				if (ecrire_fichier(_DIR_CACHE . 'aide-test', &quot;test&quot;)
				AND ($contenu = recuperer_page(&quot;$help_server/$lang_aide-aide.html&quot;)))
					ecrire_fichier ($fichier_aide, $contenu);
			}
		}

		lire_fichier($fichier_aide, $contenu);
		if (strlen($contenu) &gt; 500) {
			return array($contenu, $lang_aide);
		}
	}

	return false;
}


function help_body($aide, $html) {
	global $help_server;

	if (!$aide) $aide = 'spip';

	// Recuperation du contenu de l'aide demandee
	$html = analyse_aide($html, $aide);

	// Recherche des images de l'aide
	$suite = $html;
	$html = &quot;&quot;;
	while (preg_match(&quot;@(&lt;img([^&lt;&gt;]* +)? src=['\&quot;])&quot;
		. &quot;((AIDE|IMG)/([-_a-zA-Z0-9]*/?)([^'\&quot;&lt;&gt;]*))@i&quot;,
	$suite, $r)) {

		$image = $r[3];
		$image_plat = str_replace('/', '-', $image);

		# Image installee a l'ancienne
		if (@file_exists($image))
			$f = $image;
		else
		# Image telechargee ou a telecharger
			$f = &quot;aide_index.php3?img=$image_plat&quot;;

		$p = strpos($suite, $r[0]);
		$html .= substr($suite, 0, $p) . $r[1].$f;
		$suite = substr($suite, $p + strlen($r[0]));
	}

	$html .= $suite;

?&gt;
&lt;style type=&quot;text/css&quot;&gt;&lt;!--
.spip_cadre {
	width : 100%;
	background-color: #FFFFFF;
	padding: 5px;
}
.spip_quote {
	margin-left : 40px;
	margin-top : 10px;
	margin-bottom : 10px;
	border : solid 1px #aaaaaa;
	background-color: #dddddd;
	padding: 5px;
}

a {text-decoration: none;}
a:hover {color:#FF9900; text-decoration: underline;}

body {
	font-family: Georgia, Garamond, Times New Roman, serif;
}
h3.spip {
	font-family: Verdana,Arial,Sans,sans-serif;
	font-weight: bold;
	font-size: 115%;
	text-align: center;
}

table.spip {
}

table.spip tr.row_first {
	background-color: #FCF4D0;
}

table.spip tr.row_odd {
	background-color: #C0C0C0;
}

table.spip tr.row_even {
	background-color: #F0F0F0;
}

table.spip td {
	padding: 1px;
	text-align: left;
	vertical-align: center;
}

--&gt;&lt;/style&gt;
&lt;/head&gt;
&lt;?php

	echo '&lt;body bgcolor=&quot;#FFFFFF&quot; text=&quot;#000000&quot; TOPMARGIN=&quot;24&quot; LEFTMARGIN=&quot;24&quot; MARGINWIDTH=&quot;24&quot; MARGINHEIGHT=&quot;24&quot;';
	if ($spip_lang_rtl)
		echo &quot; dir='rtl'&quot;;
	echo &quot; lang='$lang_aide'&gt;&quot;;

	if ($aide == 'spip') {
		echo '&lt;TABLE BORDER=0 WIDTH=100% HEIGHT=60%&gt;
&lt;TR WIDTH=100% HEIGHT=60%&gt;
&lt;TD WIDTH=100% HEIGHT=60% ALIGN=&quot;center&quot; VALIGN=&quot;middle&quot;&gt;

&lt;CENTER&gt;
&lt;img src=&quot;aide_index.php3?img=AIDE--logo-spip.gif&quot; alt=&quot;SPIP&quot; width=&quot;300&quot; height=&quot;170&quot; border=&quot;0&quot;&gt;
&lt;/CENTER&gt;
&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;';
	}

	// Il faut que la langue de typo() soit celle de l'aide en ligne
	changer_typo($lang_aide);

	$html = justifier($html.&quot;&lt;p&gt;&quot;);
	// Remplacer les liens externes par des liens ouvrants (a cause des frames)
	$html = ereg_replace('&lt;a href=&quot;(<A HREF="http://[^">http://[^</A>&quot;]+)&quot;([^&gt;]*)&gt;', '&lt;a href=&quot;\\1&quot;\\2 target=&quot;_blank&quot;&gt;', $html);

	echo $html;

}


/////////////////////////////////////
// Recuperer une image dans le cache
//
function help_img($regs) {
	global $help_server;

	list ($cache, $rep, $lang, $file, $ext) = $regs;

	header(&quot;Content-Type: image/$ext&quot;);
	if (@file_exists(_DIR_CACHE . 'aide-'.$cache)) {
		readfile(_DIR_CACHE . 'aide-'.$cache);
	} else {
		include_ecrire('inc_sites.php3');
		if (ecrire_fichier(_DIR_CACHE . 'aide-test', &quot;test&quot;)
		AND ($contenu =
		recuperer_page(&quot;$help_server/$rep/$lang/$file&quot;))) {
			echo $contenu;
			ecrire_fichier (_DIR_CACHE . 'aide-'.$cache, $contenu);
		} else
			header (&quot;Location: $help_server/$rep/$lang/$file&quot;);
	}
	exit;
}

///////////////////////////////////////
// Le menu de gauche
//
function help_menu($aide, $html) {
	global $spip_lang_left, $spip_lang_rtl, $spip_lang_right;

$triangle = &quot;url(&quot; . _DIR_IMG_PACK . 'triangle'.$spip_lang_rtl.'.gif) ';

echo '&lt;style type=&quot;text/css&quot;&gt;
&lt;!--
	a {text-decoration: none; }
	A:Hover {text-decoration: underline;}

	.article-inactif {
		float: '.$spip_lang_left.';
		text-align: '.$spip_lang_left.';
		width: 80%;
		background: ' . $triangle . $spip_lang_left.' center no-repeat;
		margin: 2px;
		padding: 0px;
		padding-'.$spip_lang_left.': 20px;
		font-family: Arial, Sans, sans-serif;
		font-size: 12px;
	}
	.article-actif {
		float: '.$spip_lang_right.';
		text-align: '.$spip_lang_right.';
		width: 80%;
		background: ' . $triangle . $spip_lang_right.' center no-repeat;
		margin: 4px;
		padding: 0px;
		padding-'.$spip_lang_right.': 20px;
		font-family: Arial, Sans, sans-serif;
		font-size: 12px;
		font-weight: bold;
		color: black;
	}
	.article-actif:hover {
		text-decoration: none;
	}
	.rubrique {
		width: 90%;
		margin: 0px;
		margin-top: 6px;
		margin-bottom: 4px;
		padding: 4px;
		font-family: Trebuchet MS, Arial, Sans, sans-serif;
		font-size: 13px;
		font-weight: bold;
		color: black;
		background-color: #EEEECC;
		-moz-border-radius: 4px;
	}
--&gt;
&lt;/style&gt;
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
var curr_article;
function activer_article(id) {
	if (curr_article)
		document.getElementById(curr_article).className = &quot;article-inactif&quot;;
	if (id) {
		document.getElementById(id).className = &quot;article-actif&quot;;
		curr_article = id;
	}
}
//--&gt;&lt;/script&gt;
';

afficher_script_layer();
echo '
&lt;/head&gt;
&lt;body bgcolor=&quot;#FFFFFF&quot; text=&quot;#000000&quot; link=&quot;#E86519&quot; vlink=&quot;#6E003A&quot; alink=&quot;#FF9900&quot; TOPMARGIN=&quot;5&quot; LEFTMARGIN=&quot;5&quot; MARGINWIDTH=&quot;5&quot; MARGINHEIGHT=&quot;5&quot;';

	if ($spip_lang_rtl)
		echo &quot; dir='rtl'&quot;;
	echo &quot; lang='$lang_aide'&gt;&quot;;


	// Recuperation et analyse de la structure de l'aide demandee
	$sections = analyse_aide($html);
	foreach ($sections as $section) {
		if ($section[1] == '1') {
			if ($rubrique_vue)
				fin_rubrique();
			rubrique($section[3].$section[5]);
			$rubrique_vue = true;
		} else
			article($section[5], $section[3]);
	}
	fin_rubrique();
}


function rubrique($titre, $statut = &quot;redac&quot;) {
	global $ligne_rubrique;
	global $block_rubrique;
	global $titre_rubrique;
	global $afficher_rubrique, $ouvrir_rubrique;
	global $larubrique;

	global $aide_statut;

	$afficher_rubrique = 0;

	if (($statut == &quot;admin&quot; AND $aide_statut == &quot;admin&quot;) OR ($statut == &quot;redac&quot;)) {
		$larubrique++;
		$titre_rubrique = $titre;
		$ligne_rubrique = array();
		$block_rubrique = &quot;block$larubrique&quot;;
		$afficher_rubrique = 1;
		$ouvrir_rubrique = 0;
	}
}

function fin_rubrique() {
	global $ligne_rubrique;
	global $block_rubrique;
	global $titre_rubrique;
	global $afficher_rubrique, $ouvrir_rubrique;
	global $texte;

	if ($afficher_rubrique &amp;&amp; count($ligne_rubrique)) {
		echo &quot;&lt;div class='rubrique'&gt;&quot;;
		if ($ouvrir_rubrique)
			echo bouton_block_visible($block_rubrique);
		else 
			echo bouton_block_invisible($block_rubrique);
		echo $titre_rubrique;
		echo &quot;&lt;/div&gt;\n&quot;;
		if ($ouvrir_rubrique)
			echo debut_block_visible($block_rubrique);
		else
			echo debut_block_invisible($block_rubrique);
		echo &quot;\n&quot;;
		reset($ligne_rubrique);
		while (list(, $ligne) = each($ligne_rubrique)) {
			echo $texte[$ligne];
		}
		echo fin_block();
		echo &quot;\n\n&quot;;
	}
}

function article($titre, $lien, $statut = &quot;redac&quot;) {
	global $aide;
	global $ligne;
	global $ligne_rubrique;
	global $rubrique;
	global $texte;
	global $afficher_rubrique, $ouvrir_rubrique;
	global $aide_statut;
	global $spip_lang;

	if ($afficher_rubrique AND (($statut == &quot;admin&quot; AND $aide_statut == &quot;admin&quot;) OR ($statut == &quot;redac&quot;))) {
		$ligne_rubrique[] = ++$ligne;
		
		$texte[$ligne] = '';
		$id = &quot;ligne$ligne&quot;;
		$url = &quot;aide_index.php3?aide=$lien&amp;frame=body&amp;var_lang=$spip_lang&quot;;
		if ($aide == $lien) {
			$ouvrir_rubrique = 1;
			$class = &quot;article-actif&quot;;
			$texte[$ligne] .= &quot;&lt;script type='text/javascript'&gt;&lt;!--\ncurr_article = '$id';\n// --&gt;&lt;/script&gt;\n&quot;;
		}
		else {
			$class = &quot;article-inactif&quot;;
		}
		$texte[$ligne] .= &quot;&lt;a class='$class' id='$id' href='$url' target='droite' &quot;.
			&quot;onClick=\&quot;activer_article('$id');return true;\&quot;&gt;$titre&lt;/a&gt;&lt;br style='clear:both;'&gt;\n&quot;;
	}
}


function analyse_aide($html, $aide=false) {

	preg_match_all(',&lt;h([12])( class=&quot;spip&quot;)?'. '&gt;([^/]+?)(/(.+?))?&lt;/h\1&gt;,ism',
	$html, $regs, PREG_SET_ORDER);

	if ($aide) {
		unset ($regs);
		$preg = ',&lt;h2( class=&quot;spip&quot;)?'
		. &quot;&gt;$aide/(.+?)&lt;/h2&gt;(.*)$,ism&quot;;
		preg_match($preg, $html, $regs);
		$regs = preg_replace(',&lt;h[12].*,ism', '', $regs[3]);
	}

	return $regs;
}


//
// Distribuer le travail
//
if (preg_match(',^([^-.]*)-([^-.]*)-([^\.]*\.(gif|jpg|png))$,', $img, $regs))
	help_img($regs);
else {
	list($html, $l, $url_aide) = fichier_aide();

	// On n'a pas d'aide du tout
	if (!$html) {
		// Renvoyer sur l'aide en ligne du serveur externe
		// (hack: sauf sur SPIP.NET)
		if ($help_server AND !defined('SPIP.NET_PAS_DE_BOUCLE_AIDE'))
			@Header(&quot;Location: $help_server/?lang=$spip_lang&quot;);
		// Ou alors message d'erreur
		else {
			include_ecrire('inc_presentation.php3');
			install_debut_html(_T('forum_titre_erreur'));
			echo &quot;&lt;div&gt;&quot;._T('aide_non_disponible').&quot;&lt;/div&gt;&quot;;
			install_fin_html();
			exit;
		}
	} else {
		echo debut_entete(_T('info_aide_en_ligne'),
				  &quot;Content-Type: text/html; charset=utf-8&quot;);
		if ($frame == 'menu')
			help_menu($aide, $html);
		else if ($frame == 'body')
			help_body($aide, $html);
		else
			help_frame($aide);
	}
}

?&gt;

--- NEW FILE: inc_majbase.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_MAJBASE&quot;)) return;
define(&quot;_ECRIRE_INC_MAJBASE&quot;, &quot;1&quot;);

function maj_version ($version, $test = true) {
	if ($test) {
		include_ecrire('inc_meta.php3');
		ecrire_meta('version_installee', $version);
		ecrire_metas();
		spip_log(&quot;mise a jour de la base vers $version&quot;);
	} else {
		include_ecrire ('inc_lang.php3');
		echo _T('alerte_maj_impossible', array('version' =&gt; $version));
		exit;
	}
}

function maj_base() {
	global $spip_version;

	//
	// Lecture de la version installee
	//
	$version_installee = 0.0;
	$result = spip_query(&quot;SELECT valeur FROM spip_meta WHERE nom='version_installee'&quot;);
	if ($result) if ($row = spip_fetch_array($result)) $version_installee = (double) $row['valeur'];

	//
	// Si pas de version mentionnee dans spip_meta, c'est qu'il s'agit
	// d'une nouvelle installation
	//   =&gt; ne pas passer par le processus de mise a jour
	//
	// $version_installee = 1.702; quand on a besoin de forcer une MAJ
	if (!$version_installee) {
		include_ecrire('inc_meta.php3');
		ecrire_meta('version_installee', $spip_version);
		ecrire_metas();
		return true;
	}


	//
	// Verification des droits de modification sur la base
	//

	spip_query(&quot;DROP TABLE IF EXISTS spip_test&quot;);
	spip_query(&quot;CREATE TABLE spip_test (a INT)&quot;);
	spip_query(&quot;ALTER TABLE spip_test ADD b INT&quot;);
	spip_query(&quot;INSERT INTO spip_test (b) VALUES (1)&quot;);
	$result = spip_query(&quot;SELECT b FROM spip_test&quot;);
	spip_query(&quot;ALTER TABLE spip_test DROP b&quot;);
	if (!$result) return false;

	//
	// Selection en fonction de la version
	//
	if ($version_installee &lt; 0.98) {

		spip_query(&quot;ALTER TABLE spip_articles ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD export VARCHAR(10) DEFAULT 'oui'&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD images TEXT DEFAULT ''&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD date_redac datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_articles DROP INDEX id_article&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD INDEX id_rubrique (id_rubrique)&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD visites INTEGER DEFAULT '0' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD referers BLOB NOT NULL&quot;);

		spip_query(&quot;ALTER TABLE spip_auteurs ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD pgp BLOB NOT NULL&quot;);

		spip_query(&quot;ALTER TABLE spip_auteurs_articles ADD INDEX id_auteur (id_auteur), ADD INDEX id_article (id_article)&quot;);
	
		spip_query(&quot;ALTER TABLE spip_rubriques ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD export VARCHAR(10) DEFAULT 'oui', ADD id_import BIGINT DEFAULT '0'&quot;);
	
		spip_query(&quot;ALTER TABLE spip_breves ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_breves DROP INDEX id_breve&quot;);
		spip_query(&quot;ALTER TABLE spip_breves DROP INDEX id_breve_2&quot;);
		spip_query(&quot;ALTER TABLE spip_breves ADD INDEX id_rubrique (id_rubrique)&quot;);
	
		spip_query(&quot;ALTER TABLE spip_forum ADD ip VARCHAR(16)&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_forum DROP INDEX id_forum&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD INDEX id_parent (id_parent), ADD INDEX id_rubrique (id_rubrique), ADD INDEX id_article(id_article), ADD INDEX id_breve(id_breve)&quot;);
		maj_version (0.98);
	}

	if ($version_installee &lt; 0.99) {
	
		$query = &quot;SELECT DISTINCT id_article FROM spip_forum WHERE id_article!=0 AND id_parent=0&quot;;
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			unset($forums_article);
			$id_article = $row['id_article'];
			$query2 = &quot;SELECT id_forum FROM spip_forum WHERE id_article=$id_article&quot;;
			for (;;) {
				$result2 = spip_query($query2);
				unset($forums);
				while ($row2 = spip_fetch_array($result2)) $forums[] = $row2['id_forum'];
				if (!$forums) break;
				$forums = join(',', $forums);
				$forums_article[] = $forums;
				$query2 = &quot;SELECT id_forum FROM spip_forum WHERE id_parent IN ($forums)&quot;;
			}
			$forums_article = join(',', $forums_article);
			$query3 = &quot;UPDATE spip_forum SET id_article=$id_article WHERE id_forum IN ($forums_article)&quot;;
			spip_query($query3);
		}
	
		$query = &quot;SELECT DISTINCT id_breve FROM spip_forum WHERE id_breve!=0 AND id_parent=0&quot;;
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			unset($forums_breve);
			$id_breve = $row['id_breve'];
			$query2 = &quot;SELECT id_forum FROM spip_forum WHERE id_breve=$id_breve&quot;;
			for (;;) {
				$result2 = spip_query($query2);
				unset($forums);
				while ($row2 = spip_fetch_array($result2)) $forums[] = $row2['id_forum'];
				if (!$forums) break;
				$forums = join(',', $forums);
				$forums_breve[] = $forums;
				$query2 = &quot;SELECT id_forum FROM spip_forum WHERE id_parent IN ($forums)&quot;;
			}
			$forums_breve = join(',', $forums_breve);
			$query3 = &quot;UPDATE spip_forum SET id_breve=$id_breve WHERE id_forum IN ($forums_breve)&quot;;
			spip_query($query3);
		}
	
		$query = &quot;SELECT DISTINCT id_rubrique FROM spip_forum WHERE id_rubrique!=0 AND id_parent=0&quot;;
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			unset($forums_rubrique);
			$id_rubrique = $row['id_rubrique'];
			$query2 = &quot;SELECT id_forum FROM spip_forum WHERE id_rubrique=$id_rubrique&quot;;
			for (;;) {
				$result2 = spip_query($query2);
				unset($forums);
				while ($row2 = spip_fetch_array($result2)) $forums[] = $row2['id_forum'];
				if (!$forums) break;
				$forums = join(',', $forums);
				$forums_rubrique[] = $forums;
				$query2 = &quot;SELECT id_forum FROM spip_forum WHERE id_parent IN ($forums)&quot;;
			}
			$forums_rubrique = join(',', $forums_rubrique);
			$query3 = &quot;UPDATE spip_forum SET id_rubrique=$id_rubrique WHERE id_forum IN ($forums_rubrique)&quot;;
			spip_query($query3);
		}
		maj_version (0.99);
	}

	if ($version_installee &lt; 0.997) {
		spip_query(&quot;DROP TABLE spip_index&quot;);
		maj_version (0.997);
	}

	if ($version_installee &lt; 0.999) {
		global $htsalt;
		spip_query(&quot;ALTER TABLE spip_auteurs CHANGE pass pass tinyblob NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD htpass tinyblob NOT NULL&quot;);
		$query = &quot;SELECT id_auteur, pass FROM spip_auteurs WHERE pass!=''&quot;;
		$result = spip_query($query);
		while (list($id_auteur, $pass) = spip_fetch_array($result)) {
			$htpass = generer_htpass($pass);
			$pass = md5($pass);
			spip_query(&quot;UPDATE spip_auteurs SET pass='$pass', htpass='$htpass' WHERE id_auteur=$id_auteur&quot;);
		}
		maj_version (0.999);
	}
	
	if ($version_installee &lt; 1.01) {
		spip_query(&quot;UPDATE spip_forum SET statut='publie' WHERE statut=''&quot;);
		maj_version (1.01);
	}
	
	if ($version_installee &lt; 1.02) {
		spip_query(&quot;ALTER TABLE spip_forum ADD id_auteur BIGINT DEFAULT '0' NOT NULL&quot;);
		maj_version (1.02);
	}

	if ($version_installee &lt; 1.03) {
		spip_query(&quot;DROP TABLE spip_maj&quot;);
		maj_version (1.03);
	}

	if ($version_installee &lt; 1.04) {
		spip_query(&quot;ALTER TABLE spip_articles ADD accepter_forum VARCHAR(3)&quot;);
		maj_version (1.04);
	}

	if ($version_installee &lt; 1.05) {
		spip_query(&quot;DROP TABLE spip_petition&quot;);
		spip_query(&quot;DROP TABLE spip_signatures_petition&quot;);
		maj_version (1.05);
	}

	if ($version_installee &lt; 1.1) {
		spip_query(&quot;DROP TABLE spip_petition&quot;);
		spip_query(&quot;DROP TABLE spip_signatures_petition&quot;);
		maj_version (1.1);
	}

	// Correction de l'oubli des modifs creations depuis 1.04
	if ($version_installee &lt; 1.204) {
		spip_query(&quot;ALTER TABLE spip_articles ADD accepter_forum VARCHAR(3) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD id_message bigint(21) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD INDEX id_message (id_message)&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD en_ligne datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD imessage VARCHAR(3) not null&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD messagerie VARCHAR(3) not null&quot;);
		maj_version (1.204);
	}

	if ($version_installee &lt; 1.207) {
		spip_query(&quot;ALTER TABLE spip_rubriques DROP INDEX id_rubrique&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD INDEX id_parent (id_parent)&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD statut VARCHAR(10) NOT NULL&quot;);
		// Declencher le calcul des rubriques publiques
		spip_query(&quot;REPLACE spip_meta (nom, valeur) VALUES ('calculer_rubriques', 'oui')&quot;);
		maj_version (1.207);
	}

	if ($version_installee &lt; 1.208) {
		spip_query(&quot;ALTER TABLE spip_auteurs_messages CHANGE forum vu CHAR(3) NOT NULL&quot;);
		spip_query(&quot;UPDATE spip_auteurs_messages SET vu='oui'&quot;);
		spip_query(&quot;UPDATE spip_auteurs_messages SET vu='non' WHERE statut='a'&quot;);

		spip_query(&quot;ALTER TABLE spip_messages ADD id_auteur bigint(21) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_messages ADD INDEX id_auteur (id_auteur)&quot;);
		$result = spip_query(&quot;SELECT id_auteur, id_message FROM spip_auteurs_messages WHERE statut='de'&quot;);
		while ($row = spip_fetch_array($result)) {
			$id_auteur = $row['id_auteur'];
			$id_message = $row['id_message'];
			spip_query(&quot;UPDATE spip_messages SET id_auteur=$id_auteur WHERE id_message=$id_message&quot;);
		}

		spip_query(&quot;ALTER TABLE spip_auteurs_messages DROP statut&quot;);
		maj_version (1.208);
	}

	if ($version_installee &lt; 1.209) {
		spip_query(&quot;ALTER TABLE spip_syndic ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic_articles ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_messages ADD maj TIMESTAMP&quot;);
		maj_version (1.209);
	}

	if ($version_installee &lt; 1.210) {
		spip_query(&quot;ALTER TABLE spip_messages DROP page&quot;);

		stripslashes_base('spip_articles', array('surtitre', 'titre', 'soustitre', 'descriptif', 'chapo', 'texte', 'ps'));
		stripslashes_base('spip_auteurs', array('nom', 'bio', 'nom_site'));
		stripslashes_base('spip_breves', array('titre', 'texte', 'lien_titre'));
		stripslashes_base('spip_forum', array('titre', 'texte', 'auteur', 'nom_site'));
		stripslashes_base('spip_messages', array('titre', 'texte'));
		stripslashes_base('spip_mots', array('type', 'titre', 'descriptif', 'texte'));
		stripslashes_base('spip_petitions', array('texte'));
		stripslashes_base('spip_rubriques', array('titre', 'descriptif', 'texte'));
		stripslashes_base('spip_signatures', array('nom_email', 'nom_site', 'message'));
		stripslashes_base('spip_syndic', array('nom_site', 'descriptif'));
		stripslashes_base('spip_syndic_articles', array('titre', 'lesauteurs'));
		maj_version (1.210);
	}

	if ($version_installee &lt; 1.3) {
		// Modifier la syndication (pour liste de sites)
		spip_query(&quot;ALTER TABLE spip_syndic ADD syndication VARCHAR(3) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic ADD statut VARCHAR(10) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic ADD date datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		spip_query(&quot;UPDATE spip_syndic SET syndication='oui', statut='publie', date=NOW()&quot;);

		// Statut pour articles syndication, pour pouvoir desactiver un article
		spip_query(&quot;ALTER TABLE spip_syndic_articles ADD statut VARCHAR(10) NOT NULL&quot;);
		spip_query(&quot;UPDATE spip_syndic_articles SET statut='publie'&quot;);
		maj_version (1.3);
	}

	if ($version_installee &lt; 1.301) {
		spip_query(&quot;ALTER TABLE spip_forum ADD id_syndic bigint(21) DEFAULT '0' NOT NULL&quot;);
		maj_version (1.301);
	}

	if ($version_installee &lt; 1.302) {
		# spip_query(&quot;ALTER TABLE spip_forum_cache DROP PRIMARY KEY&quot;);
		# spip_query(&quot;ALTER TABLE spip_forum_cache DROP INDEX fichier&quot;);
		# spip_query(&quot;ALTER TABLE spip_forum_cache ADD PRIMARY KEY (fichier, id_forum, id_article, id_rubrique, id_breve, id_syndic)&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD INDEX id_syndic (id_syndic)&quot;);
		maj_version (1.302);
	}

	if ($version_installee &lt; 1.303) {
		spip_query(&quot;ALTER TABLE spip_rubriques ADD date datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic ADD date_syndic datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		spip_query(&quot;UPDATE spip_syndic SET date_syndic=date&quot;);
		maj_version (1.303);
	}

	if ($version_installee &lt; 1.306) {
		spip_query(&quot;DROP TABLE spip_index_syndic_articles&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic ADD date_index datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic ADD INDEX date_index (date_index)&quot;);
		maj_version (1.306);
	}

	if ($version_installee &lt; 1.307) {
		spip_query(&quot;ALTER TABLE spip_syndic_articles ADD descriptif blob NOT NULL&quot;);
		maj_version (1.307);
	}

	if ($version_installee &lt; 1.404) {
		spip_query(&quot;UPDATE spip_mots SET type='Mots sans groupe...' WHERE type=''&quot;);

		$result = spip_query(&quot;SELECT * FROM spip_mots GROUP BY type&quot;);
		while($row = spip_fetch_array($result)) {
				$type = addslashes($row['type']);
				spip_query(&quot;INSERT INTO spip_groupes_mots 
					(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)
					VALUES (\&quot;$type\&quot;, 'non', 'non', 'oui', 'oui', 'non', 'oui', 'oui', 'oui', 'non')&quot;);
		}
		spip_query(&quot;DELETE FROM spip_mots WHERE titre='kawax'&quot;);
		maj_version (1.404);
	}

	if ($version_installee &lt; 1.405) {
		spip_query(&quot;ALTER TABLE spip_mots ADD id_groupe bigint(21) NOT NULL&quot;);
	
		$result = spip_query(&quot;SELECT * FROM spip_groupes_mots&quot;);
		while($row = spip_fetch_array($result)) {
				$id_groupe = addslashes($row['id_groupe']);
				$type = addslashes($row['titre']);
				spip_query(&quot;UPDATE spip_mots SET id_groupe = '$id_groupe' WHERE type='$type'&quot;);
		}
		maj_version (1.405);
	}

	if ($version_installee &lt; 1.408) {
		// Images articles passent dans spip_documents
		$query = &quot;SELECT id_article, images FROM spip_articles WHERE LENGTH(images) &gt; 0&quot;;
		$result = spip_query($query);

		$types = array('jpg' =&gt; 1, 'png' =&gt; 2, 'gif' =&gt; 3);

		while ($row = @spip_fetch_array($result)) {
			$id_article = $row['id_article'];
			$images = $row['images'];
			$images = explode(&quot;,&quot;, $images);
			reset($images);
			$replace = '_orig_';
			while (list (, $val) = each($images)) {
				$image = explode(&quot;|&quot;, $val);
				$fichier = $image[0];
				$largeur = $image[1];
				$hauteur = $image[2];
				ereg(&quot;-([0-9]+)\.(gif|jpg|png)$&quot;, $fichier, $match);
				$id_type = intval($types[$match[2]]);
				$num_img = $match[1];
				$fichier = _DIR_IMG . $fichier;
				$taille = @filesize($fichier);
				$fichier = substr('../', '', $fichier);
				$id_document = spip_abstract_insert(&quot;documents&quot;, 
							   &quot;(titre, id_type, fichier, mode, largeur, hauteur, taille)&quot;,
							   &quot;('image $largeur x $hauteur', $id_type, '$fichier', 'vignette', '$largeur', '$hauteur', '$taille')&quot;);

				if ($id_document &gt; 0) {
					spip_query(&quot;INSERT INTO spip_documents_articles (id_document, id_article) VALUES ($id_document, $id_article)&quot;);
					$replace = &quot;REPLACE($replace, '&lt;IMG$num_img|', '&lt;IM_$id_document|')&quot;;
				} else {
					echo _T('texte_erreur_mise_niveau_base', array('fichier' =&gt; $fichier, 'id_article' =&gt; $id_article));
					exit;
				}
			}
			$replace = &quot;REPLACE($replace, '&lt;IM_', '&lt;IMG')&quot;;
			$replace_chapo = ereg_replace('_orig_', 'chapo', $replace);
			$replace_descriptif = ereg_replace('_orig_', 'descriptif', $replace);
			$replace_texte = ereg_replace('_orig_', 'texte', $replace);
			$replace_ps = ereg_replace('_orig_', 'ps', $replace);
			$query = &quot;UPDATE spip_articles &quot;.
				&quot;SET chapo=$replace_chapo, descriptif=$replace_descriptif, texte=$replace_texte, ps=$replace_ps &quot;.
				&quot;WHERE id_article=$id_article&quot;;
			spip_query($query);
		}
		spip_query(&quot;ALTER TABLE spip_articles DROP images&quot;);
		maj_version (1.408);
	}

	if ($version_installee &lt; 1.414) {
		// Forum par defaut &quot;en dur&quot; dans les spip_articles
		// -&gt; non, prio (priori), pos (posteriori), abo (abonnement)
		include_ecrire (&quot;inc_meta.php3&quot;);
		$accepter_forum = substr(lire_meta(&quot;forums_publics&quot;),0,3) ;
		$query = &quot;ALTER TABLE spip_articles CHANGE accepter_forum accepter_forum CHAR(3) NOT NULL&quot;;
		$result = spip_query($query);
		$query = &quot;UPDATE spip_articles SET accepter_forum='$accepter_forum' WHERE accepter_forum != 'non'&quot;;
		$result = spip_query($query);
		maj_version (1.414);
	}

	/*
	if ($version_installee == 1.415) {
		spip_query(&quot;ALTER TABLE spip_documents DROP inclus&quot;);
		maj_version (1.415);
	}
	*/

	if ($version_installee &lt; 1.417) {
		spip_query(&quot;ALTER TABLE spip_syndic_articles DROP date_index&quot;);
		maj_version (1.417);
	}

	if ($version_installee &lt; 1.418) {
		$query = &quot;SELECT * FROM spip_auteurs WHERE statut = '0minirezo' AND email != '' ORDER BY id_auteur LIMIT 0,1&quot;;
		$result = spip_query($query);
		if ($webmaster = spip_fetch_array($result)) {
			include_ecrire(&quot;inc_meta.php3&quot;);
			ecrire_meta('email_webmaster', $webmaster['email']);
			ecrire_metas();
		}
		maj_version (1.418);
	}

	if ($version_installee &lt; 1.419) {
		$query = &quot;ALTER TABLE spip_auteurs ADD alea_actuel TINYTEXT DEFAULT ''&quot;;
		spip_query($query);
		$query = &quot;ALTER TABLE spip_auteurs ADD alea_futur TINYTEXT DEFAULT ''&quot;;
		spip_query($query);
		$query = &quot;UPDATE spip_auteurs SET alea_futur = FLOOR(32000*RAND())&quot;;
		spip_query($query);
		maj_version (1.419);
	}

	if ($version_installee &lt; 1.420) {
		$query = &quot;UPDATE spip_auteurs SET alea_actuel='' WHERE statut='nouveau'&quot;;
		spip_query($query);
		maj_version (1.420);
	}
	
	if ($version_installee &lt; 1.421) {
		$query = &quot;ALTER TABLE spip_articles ADD auteur_modif bigint(21) DEFAULT '0' NOT NULL&quot;;
		spip_query($query);
		$query = &quot;ALTER TABLE spip_articles ADD date_modif datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;;
		spip_query($query);
		maj_version (1.421);
	}

	if ($version_installee &lt; 1.432) {
		spip_query(&quot;ALTER TABLE spip_articles DROP referers&quot;);
		$query = &quot;ALTER TABLE spip_articles ADD referers INTEGER DEFAULT '0' NOT NULL&quot;;
		spip_query($query);
		$query = &quot;ALTER TABLE spip_articles ADD popularite INTEGER DEFAULT '0' NOT NULL&quot;;
		spip_query($query);
		maj_version (1.432);
	}

	if ($version_installee &lt; 1.436) {
		$query = &quot;ALTER TABLE spip_documents ADD date datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;;
		spip_query($query);
		maj_version (1.436);
	}

	if ($version_installee &lt; 1.437) {
		spip_query(&quot;ALTER TABLE spip_visites ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_visites_referers ADD maj TIMESTAMP&quot;);
		maj_version (1.437);
	}

	if ($version_installee &lt; 1.438) {
		spip_query(&quot;ALTER TABLE spip_articles ADD INDEX id_secteur (id_secteur)&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD INDEX statut (statut, date)&quot;);
		maj_version (1.438);
	}

	if ($version_installee &lt; 1.439) {
		spip_query(&quot;ALTER TABLE spip_syndic ADD INDEX statut (statut, date_syndic)&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic_articles ADD INDEX statut (statut)&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic_articles CHANGE url url VARCHAR(255) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic_articles ADD INDEX url (url)&quot;);
		maj_version (1.439);
	}

	if ($version_installee &lt; 1.440) {
		spip_query(&quot;ALTER TABLE spip_visites_temp CHANGE ip ip INTEGER UNSIGNED NOT NULL&quot;);
		maj_version (1.440);
	}

	if ($version_installee &lt; 1.441) {
		spip_query(&quot;ALTER TABLE spip_visites_temp CHANGE date date DATE NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_visites CHANGE date date DATE NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_visites_referers CHANGE date date DATE NOT NULL&quot;);
		maj_version (1.441);
	}

	if ($version_installee &lt; 1.442) {
		$query = &quot;ALTER TABLE spip_auteurs ADD prefs TINYTEXT NOT NULL&quot;;
		spip_query($query);
		maj_version (1.442);
	}

	if ($version_installee &lt; 1.443) {
		spip_query(&quot;ALTER TABLE spip_auteurs CHANGE login login VARCHAR(255) BINARY NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs CHANGE statut statut VARCHAR(255) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD INDEX login (login)&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD INDEX statut (statut)&quot;);
		maj_version (1.443);
	}

	if ($version_installee &lt; 1.444) {
		spip_query(&quot;ALTER TABLE spip_syndic ADD moderation VARCHAR(3) NOT NULL&quot;);
		maj_version (1.444);
	}

	if ($version_installee &lt; 1.457) {
		spip_query(&quot;DROP TABLE spip_visites&quot;);
		spip_query(&quot;DROP TABLE spip_visites_temp&quot;);
		spip_query(&quot;DROP TABLE spip_visites_referers&quot;);
		creer_base(); // crade, a ameliorer :-((
		maj_version (1.457);
	}

	if ($version_installee &lt; 1.458) {
		spip_query(&quot;ALTER TABLE spip_auteurs ADD cookie_oubli TINYTEXT NOT NULL&quot;);
		maj_version (1.458);
	}

	if ($version_installee &lt; 1.459) {
		$result = spip_query(&quot;SELECT type FROM spip_mots GROUP BY type&quot;);
		while ($row = spip_fetch_array($result)) {
			$type = addslashes($row['type']);
			$res = spip_query(&quot;SELECT * FROM spip_groupes_mots
				WHERE titre='$type'&quot;);
			if (spip_num_rows($res) == 0) {
			  if ($id_groupe = spip_abstract_insert(&quot;groupes_mots&quot;, 
						       &quot;(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)&quot;,
						       &quot;('$type', 'non', 'non', 'oui', 'oui', 'non', 'oui', 'oui', 'oui', 'non')&quot;))

					spip_query(&quot;UPDATE spip_mots SET id_groupe = '$id_groupe' WHERE type='$type'&quot;);
			}
		}
		spip_query(&quot;UPDATE spip_articles SET popularite=0&quot;);
		maj_version (1.459);
	}

	if ($version_installee &lt; 1.460) {
		// remettre les mots dans les groupes dupliques par erreur
		// dans la precedente version du paragraphe de maj 1.459
		// et supprimer ceux-ci
		$result = spip_query(&quot;SELECT * FROM spip_groupes_mots ORDER BY id_groupe&quot;);
		while ($row = spip_fetch_array($result)) {
			$titre = addslashes($row['titre']);
			if (! $vu[$titre] ) {
				$vu[$titre] = true;
				$id_groupe = $row['id_groupe'];
				spip_query (&quot;UPDATE spip_mots SET id_groupe=$id_groupe WHERE type='$titre'&quot;);
				spip_query (&quot;DELETE FROM spip_groupes_mots WHERE titre='$titre' AND id_groupe&lt;&gt;$id_groupe&quot;);
			}
		}
		maj_version (1.460);
	}

	if ($version_installee &lt; 1.462) {
		spip_query(&quot;UPDATE spip_types_documents SET inclus='embed' WHERE inclus!='non' AND extension IN &quot;.
			&quot;('aiff', 'asf', 'avi', 'mid', 'mov', 'mp3', 'mpg', 'ogg', 'qt', 'ra', 'ram', 'rm', 'swf', 'wav', 'wmv')&quot;);
		maj_version (1.462);
	}

	if ($version_installee &lt; 1.463) {
		spip_query(&quot;ALTER TABLE spip_articles CHANGE popularite popularite DOUBLE&quot;);
		spip_query(&quot;ALTER TABLE spip_visites_temp ADD maj TIMESTAMP&quot;);
		spip_query(&quot;ALTER TABLE spip_referers_temp ADD maj TIMESTAMP&quot;);
		maj_version (1.463);
	}

	// l'upgrade &lt; 1.462 ci-dessus etait fausse, d'ou correctif
	if (($version_installee &lt; 1.464) AND ($version_installee &gt;= 1.462)) {
		$res = spip_query(&quot;SELECT id_type, extension FROM spip_types_documents WHERE id_type NOT IN (1,2,3)&quot;);
		while ($row = spip_fetch_array($res)) {
			$extension = $row['extension'];
			$id_type = $row['id_type'];
			spip_query(&quot;UPDATE spip_documents SET id_type=$id_type
				WHERE fichier like '%.$extension'&quot;);
		}
		maj_version (1.464);
	}

	if ($version_installee &lt; 1.465) {
		spip_query(&quot;ALTER TABLE spip_articles CHANGE popularite popularite DOUBLE NOT NULL&quot;);
		maj_version (1.465);
	}

	if ($version_installee &lt; 1.466) {
		spip_query(&quot;ALTER TABLE spip_auteurs ADD source VARCHAR(10) DEFAULT 'spip' NOT NULL&quot;);
		maj_version (1.466);
	}

	if ($version_installee &lt; 1.468) {
		spip_query(&quot;ALTER TABLE spip_auteurs ADD INDEX en_ligne (en_ligne)&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD INDEX statut (statut, date_heure)&quot;);
		maj_version (1.468);
	}

	if ($version_installee &lt; 1.470) {
		if ($version_installee &gt;= 1.467) {	// annule les &quot;listes de diff&quot;
			spip_query(&quot;DROP TABLE spip_listes&quot;);
			spip_query(&quot;ALTER TABLE spip_auteurs DROP abonne&quot;);
			spip_query(&quot;ALTER TABLE spip_auteurs DROP abonne_pass&quot;);
		}
		maj_version (1.470);
	}

	if ($version_installee &lt; 1.471) {
		if ($version_installee &gt;= 1.470) {	// annule les &quot;maj&quot;
			spip_query(&quot;ALTER TABLE spip_auteurs_articles DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_auteurs_rubriques DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_auteurs_messages DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_documents_articles DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_documents_rubriques DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_documents_breves DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_mots_articles DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_mots_breves DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_mots_rubriques DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_mots_syndic DROP maj TIMESTAMP&quot;);
			spip_query(&quot;ALTER TABLE spip_mots_forum DROP maj TIMESTAMP&quot;);
		}
		maj_version (1.471);
	}

	if ($version_installee &lt; 1.472) {
		spip_query(&quot;ALTER TABLE spip_referers ADD visites_jour INTEGER UNSIGNED NOT NULL&quot;);
		maj_version (1.472);
	}

	if ($version_installee &lt; 1.473) {
		spip_query(&quot;UPDATE spip_syndic_articles SET url = REPLACE(url, '&amp;', '&amp;')&quot;);
		spip_query(&quot;UPDATE spip_syndic SET url_site = REPLACE(url_site, '&amp;', '&amp;')&quot;);
		maj_version (1.473);
	}

	if ($version_installee &lt; 1.600) {
		include_ecrire('inc_index.php3');
		purger_index();
		creer_liste_indexation();
		maj_version (1.600);
	}

	if ($version_installee &lt; 1.601) {
		spip_query(&quot;ALTER TABLE spip_forum ADD INDEX id_syndic (id_syndic)&quot;);
		maj_version (1.601);
	}

	if ($version_installee &lt; 1.603) {
		// supprimer les fichiers deplaces
		@unlink('inc_meta_cache.php3');
		@unlink('data/engines-list.ini');
		maj_version (1.603);
	}

	if ($version_installee &lt; 1.604) {
		spip_query(&quot;ALTER TABLE spip_auteurs ADD lang VARCHAR(10) DEFAULT '' NOT NULL&quot;);
		$u = spip_query(&quot;SELECT * FROM spip_auteurs WHERE prefs LIKE '%spip_lang%'&quot;);
		while ($row = spip_fetch_array($u)) {
			$prefs = unserialize($row['prefs']);
			$l = $prefs['spip_lang'];
			unset ($prefs['spip_lang']);
			spip_query (&quot;UPDATE spip_auteurs SET lang='&quot;.addslashes($l).&quot;',
				prefs='&quot;.addslashes(serialize($prefs)).&quot;'
				WHERE id_auteur=&quot;.$row['id_auteur']);
		}
		maj_version (1.604, spip_query(&quot;SELECT lang FROM spip_auteurs&quot;));
	}

	if ($version_installee &lt; 1.702) {
		spip_query(&quot;ALTER TABLE spip_articles ADD extra longblob NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD extra longblob NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_breves ADD extra longblob NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD extra longblob NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_mots ADD extra longblob NULL&quot;);

		// recuperer les eventuels 'supplement' installes en 1.701
		if ($version_installee == 1.701) {
			spip_query (&quot;UPDATE spip_articles SET extra = supplement&quot;);
			spip_query (&quot;ALTER TABLE spip_articles DROP supplement&quot;);
			spip_query (&quot;UPDATE spip_auteurs SET extra = supplement&quot;);
			spip_query (&quot;ALTER TABLE spip_auteurs DROP supplement&quot;);
			spip_query (&quot;UPDATE spip_breves SET extra = supplement&quot;);
			spip_query (&quot;ALTER TABLE spip_breves DROP supplement&quot;);
			spip_query (&quot;UPDATE spip_rubriques SET extra = supplement&quot;);
			spip_query (&quot;ALTER TABLE spip_rubriques DROP supplement&quot;);
			spip_query (&quot;UPDATE spip_mots SET extra = supplement&quot;);
			spip_query (&quot;ALTER TABLE spip_mots DROP supplement&quot;);
		}
		maj_version (1.702,
			spip_query(&quot;SELECT extra FROM spip_articles&quot;)
			&amp;&amp; spip_query(&quot;SELECT extra FROM spip_auteurs&quot;)
			&amp;&amp; spip_query(&quot;SELECT extra FROM spip_breves&quot;)
			&amp;&amp; spip_query(&quot;SELECT extra FROM spip_rubriques&quot;)
			&amp;&amp; spip_query(&quot;SELECT extra FROM spip_mots&quot;)
			);
	}

	if ($version_installee &lt; 1.703) {
		spip_query(&quot;ALTER TABLE spip_articles ADD lang VARCHAR(10) DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD lang VARCHAR(10) DEFAULT '' NOT NULL&quot;);
		maj_version (1.703);
	}

	if ($version_installee &lt; 1.704) {
		spip_query(&quot;ALTER TABLE spip_articles ADD INDEX lang (lang)&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD INDEX lang (lang)&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD INDEX lang (lang)&quot;);
		maj_version (1.704);
	}

	if ($version_installee &lt; 1.705) {
		spip_query(&quot;ALTER TABLE spip_articles ADD langue_choisie VARCHAR(3) DEFAULT 'non'&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD langue_choisie VARCHAR(3) DEFAULT 'non'&quot;);
		maj_version (1.705);
	}

	if ($version_installee &lt; 1.707) {
		spip_query(&quot;UPDATE spip_articles SET langue_choisie='oui' WHERE MID(lang,1,1) != '.' AND lang != ''&quot;);
		spip_query(&quot;UPDATE spip_articles SET lang=MID(lang,2,8) WHERE langue_choisie = 'non'&quot;);
		spip_query(&quot;UPDATE spip_rubriques SET langue_choisie='oui' WHERE MID(lang,1,1) != '.' AND lang != ''&quot;);
		spip_query(&quot;UPDATE spip_rubriques SET lang=MID(lang,2,8) WHERE langue_choisie = 'non'&quot;);
		maj_version (1.707);
	}

	if ($version_installee &lt; 1.708) {
		spip_query(&quot;ALTER TABLE spip_breves ADD lang VARCHAR(10) DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_breves ADD langue_choisie VARCHAR(3) DEFAULT 'non'&quot;);
		maj_version (1.708);
	}

	if ($version_installee &lt; 1.709) {
		spip_query(&quot;ALTER TABLE spip_articles ADD id_trad bigint(21) DEFAULT '0' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD INDEX id_trad (id_trad)&quot;);
		maj_version (1.709);
	}

	if ($version_installee &lt; 1.717) {
		spip_query(&quot;ALTER TABLE spip_articles ADD INDEX date_modif (date_modif)&quot;);
		maj_version (1.717);
	}

	if ($version_installee &lt; 1.718) {
		spip_query(&quot;ALTER TABLE spip_referers DROP domaine&quot;);
		spip_query(&quot;ALTER TABLE spip_referers_articles DROP domaine&quot;);
		spip_query(&quot;ALTER TABLE spip_referers_temp DROP domaine&quot;);
		maj_version (1.718);
	}

	if ($version_installee &lt; 1.722) {
		spip_query(&quot;ALTER TABLE spip_articles ADD nom_site tinytext NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD url_site VARCHAR(255) NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_articles ADD INDEX url_site (url_site)&quot;);
		if ($version_installee &gt;= 1.720) {
			spip_query(&quot;UPDATE spip_articles SET url_site=url_ref&quot;);
			spip_query(&quot;ALTER TABLE spip_articles DROP INDEX url_ref&quot;);
			spip_query(&quot;ALTER TABLE spip_articles DROP url_ref&quot;);
		}
		maj_version (1.722);
	}

	if ($version_installee &lt; 1.723) {
		if ($version_installee == 1.722) {
			spip_query(&quot;ALTER TABLE spip_articles MODIFY url_site VARCHAR(255) NOT NULL&quot;);
			spip_query(&quot;ALTER TABLE spip_articles DROP INDEX url_site;&quot;);
			spip_query(&quot;ALTER TABLE spip_articles ADD INDEX url_site (url_site);&quot;);
		}
		maj_version (1.723);
	}

	if ($version_installee &lt; 1.724) {
		spip_query(&quot;ALTER TABLE spip_messages ADD date_fin datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		maj_version (1.724);
	}

	if ($version_installee &lt; 1.726) {
		spip_query(&quot;ALTER TABLE spip_auteurs ADD low_sec tinytext NOT NULL&quot;);
		maj_version (1.726);
	}

	if ($version_installee &lt; 1.727) {
		// occitans : oci_xx -&gt; oc_xx
		spip_query(&quot;UPDATE spip_auteurs SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'&quot;);
		spip_query(&quot;UPDATE spip_rubriques SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'&quot;);
		spip_query(&quot;UPDATE spip_articles SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'&quot;);
		spip_query(&quot;UPDATE spip_breves SET lang=REPLACE(lang,'oci_', 'oc_') WHERE lang LIKE 'oci_%'&quot;);
		maj_version (1.727);
	}

	// Ici version 1.7 officielle

	if ($version_installee &lt; 1.728) {
		spip_query(&quot;ALTER TABLE spip_articles ADD id_version int unsigned DEFAULT '0' NOT NULL&quot;);
		maj_version (1.728);
	}

	if ($version_installee &lt; 1.730) {
		spip_query(&quot;ALTER TABLE spip_articles ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_articles INDEX idx (idx)&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_auteurs INDEX idx (idx)&quot;);
		spip_query(&quot;ALTER TABLE spip_breves ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_breves INDEX idx (idx)&quot;);
		spip_query(&quot;ALTER TABLE spip_mots ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_mots INDEX idx (idx)&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_rubriques INDEX idx (idx)&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_syndic INDEX idx (idx)&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_forum ADD INDEX idx (idx)&quot;);
		spip_query(&quot;ALTER TABLE spip_signatures ADD idx ENUM('', '1', 'non', 'oui', 'idx') DEFAULT '' NOT NULL&quot;);
		spip_query(&quot;ALTER TABLE spip_signatures INDEX idx (idx)&quot;);
		maj_version (1.730);
	}

	if ($version_installee &lt; 1.731) {	// reindexer les docs allemands et vietnamiens
		spip_query(&quot;UPDATE spip_articles SET idx='1' where lang IN ('de','vi')&quot;);
		spip_query(&quot;UPDATE spip_rubriques SET idx='1' where lang IN ('de','vi')&quot;);
		spip_query(&quot;UPDATE spip_breves SET idx='1' where lang IN ('de','vi')&quot;);
		spip_query(&quot;UPDATE spip_auteurs SET idx='1' where lang IN ('de','vi')&quot;);
		maj_version (1.731);
	}

	if ($version_installee &lt; 1.732) {	// en correction d'un vieux truc qui avait fait sauter le champ inclus sur les bases version 1.415
		spip_query (&quot;ALTER TABLE spip_documents ADD inclus  VARCHAR(3) DEFAULT 'non'&quot;);
		maj_version (1.732);
	}

	if ($version_installee &lt; 1.733) {
		// spip_query(&quot;ALTER TABLE spip_articles ADD id_version int unsigned DEFAULT '0' NOT NULL&quot;);
		spip_query(&quot;DROP TABLE spip_versions&quot;);
		spip_query(&quot;DROP TABLE spip_versions_fragments&quot;);
		creer_base();
		maj_version(1.733);
	}

	#if ($version_installee &lt; 1.734) {
	#	// integrer nouvelles tables auxiliaires du compilateur ESJ
	#	creer_base();
	#	maj_version(1.734);
	#}

	if ($version_installee &lt; 1.801) {
		spip_query(&quot;ALTER TABLE spip_rubriques
			ADD statut_tmp VARCHAR(10) NOT NULL,
			ADD date_tmp datetime DEFAULT '0000-00-00 00:00:00' NOT NULL&quot;);
		include_ecrire('inc_rubriques.php3');
		calculer_rubriques();
		maj_version(1.801);
	}

	// Nouvelles tables d'invalidation
	if ($version_installee &lt; 1.802) {
		spip_query(&quot;DROP TABLE spip_id_article_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_auteur_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_breve_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_document_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_forum_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_groupe_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_message_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_mot_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_rubrique_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_signature_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_syndic_article_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_syndic_caches&quot;);
		spip_query(&quot;DROP TABLE spip_id_type_caches&quot;);
		spip_query(&quot;DROP TABLE spip_inclure_caches&quot;);
		maj_version(1.802);
	}
	if ($version_installee &lt; 1.803) {

	#	27 AOUT 2004 : conservons cette table pour autoriser les retours
	#	de SPIP 1.8a6 CVS vers 1.7.2
	#	spip_query(&quot;DROP TABLE spip_forum_cache&quot;);

		spip_query(&quot;DROP TABLE spip_inclure_caches&quot;);
		maj_version(1.803);
	}
	if ($version_installee &lt; 1.804) {
		// recreer la table spip_caches
		spip_query(&quot;DROP TABLE spip_caches&quot;);
		creer_base();
		maj_version(1.804);
	}

	if ($version_installee &lt; 1.805) {
		spip_query(&quot;ALTER TABLE spip_forum
		ADD id_thread bigint(21) DEFAULT '0' NOT NULL&quot;);
		include_ecrire('inc_forum.php3');
		calculer_threads();
		maj_version(1.805);
	}

	// tables d'orthographe
	#if ($version_installee &lt; 1.806)
	#	maj_version(1.806);

	// URLs propres (lab_version = 0.12)
	if ($version_installee &lt; 1.807) {
		foreach (array('articles', 'breves', 'rubriques', 'mots') as $objets) {
			spip_query(&quot;ALTER TABLE spip_$objets
				ADD url_propre VARCHAR(255) NOT NULL&quot;);
			spip_query(&quot;ALTER TABLE spip_$objets
				ADD INDEX url_propre (url_propre)&quot;);
		}
		maj_version(1.807);
	}

	// referers de la veille
	if ($version_installee &lt; 1.808) {
		spip_query(&quot;ALTER TABLE spip_referers
		ADD visites_veille INT UNSIGNED NOT NULL&quot;);
		maj_version(1.808);
	}


	// corrections diverses
	if ($version_installee &lt; 1.809) {
		// plus de retour possible vers 1.7.2
		spip_query(&quot;DROP TABLE spip_forum_cache&quot;);

		// les requetes ci-dessous ne s'appliqueront que si on est passe
		// par une certaine version de developpement - oublie de le faire
		// plus tot, car le code d'alors recreait purement et simplement
		// cette table
		spip_query(&quot;ALTER TABLE spip_versions DROP chapo&quot;);
		spip_query(&quot;ALTER TABLE spip_versions DROP texte&quot;);
		spip_query(&quot;ALTER TABLE spip_versions DROP ps&quot;);
		spip_query(&quot;ALTER TABLE spip_versions DROP extra&quot;);
		spip_query(&quot;ALTER TABLE spip_versions ADD champs text NOT NULL&quot;);

		maj_version(1.809);
	}

	return true;
}

?&gt;

--- NEW FILE: inc_import.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_IMPORT&quot;)) return;
define(&quot;_ECRIRE_INC_IMPORT&quot;, &quot;1&quot;);


include_ecrire (&quot;inc_acces.php3&quot;);


function xml_fetch_tag($f, &amp;$before, $gz=false) {
	global $buf, $pos, $abs_pos;
	static $buf_len = 1000;
	$_fread = ($gz) ? gzread : fread;
	$_feof = ($gz) ? gzeof : feof;
	$_ftell = ($gz) ? gztell : ftell;
	$p = $pos;

	$q = @strpos($buf, '&lt;', $p);
	while (!$q AND substr($buf, $p, 1) != '&lt;') {
		if ($_feof($f)) return false;
		$before .= substr($buf, $p);
		$buf = $_fread($f, $buf_len);
		$p = 0;
		$q = strpos($buf, '&lt;');
	}
	$before .= substr($buf, $p, $q - $p);
	$tag = '';
	$p = ++$q;
	$q = @strpos($buf, '&gt;', $p);
	while (!$q AND substr($buf, $p, 1) != '&gt;') {
		if ($_feof($f)) return false;
		$tag .= substr($buf, $p);
		$buf = $_fread($f, $buf_len);
		$p = 0;
		$q = strpos($buf, '&gt;');
	}
	$pos = $q + 1;
	$tag .= substr($buf, $p, $q - $p);
	$before = str_replace('&amp;', '&amp;', str_replace('&lt;', '&lt;', $before));
	$abs_pos = $_ftell($f) - strlen($buf);
	return $tag;
}


function xml_parse_tag($texte) {
	list($tag, $atts) = split('[[:space:]]+', $texte, 2);
	$result[0] = $tag;
	$result[1] = '';
	if (!$atts) return $result;
	while (ereg('^([^[:space:]]+)[[:space:]]*=[[:space:]]*&quot;([^&quot;]*)&quot;([[:space:]]+(.*))?', $atts, $regs)) {
		$result[1][$regs[1]] = $regs[2];
		$atts = $regs[4];
	}
	return $result;
}


function import_debut($f, $gz=false) {
	$b = &quot;&quot;;
	while ($t = xml_fetch_tag($f, $b, $gz)) {
		$r = xml_parse_tag($t);
		if ($r[0] == '?xml' AND $r[1]['encoding'])
			ecrire_meta('charset_restauration', strtolower($r[1]['encoding']));
		if ($r[0] == &quot;SPIP&quot;) return $r;
		$b = &quot;&quot;;
	}
	return false;
}


//
// $f = handle fichier
// $gz = flag utilisation zlib
//
// importe un objet depuis le fichier, retourne true si ok, false si erreur ou fin de fichier
//

function import_objet_1_2($f, $gz=false) {
	global $import_ok, $pos, $abs_pos;
	static $time_javascript;

	if (time() - $time_javascript &gt; 3) {	// 3 secondes
		affiche_progression_javascript($abs_pos);
		$time_javascript = time();
	}

	static $tables;
	if (!$tables) $tables = array(
		'article' =&gt; 'spip_articles',
		'auteur' =&gt; 'spip_auteurs',
		'breve' =&gt; 'spip_breves',
		'document' =&gt; 'spip_documents',
		'forum' =&gt; 'spip_forum',
		'groupe_mots' =&gt; 'spip_groupes_mots',
		'message' =&gt; 'spip_messages',
		'mot' =&gt; 'spip_mots',
		'petition' =&gt; 'spip_petitions',
		'rubrique' =&gt; 'spip_rubriques',
		'signature' =&gt; 'spip_signatures',
		'syndic' =&gt; 'spip_syndic',
		'syndic_article' =&gt; 'spip_syndic_articles',
		'type_document' =&gt; 'spip_types_documents'
	);

	$import_ok = false;
	$b = '';
	// Lire le type d'objet
	if (!($type = xml_fetch_tag($f, $b, $gz))) return false;
	if ($type == '/SPIP') return !($import_ok = true);
	$id = &quot;id_$type&quot;;
	$id_objet = 0;

	// Lire les champs de l'objet
	for (;;) {
		$b = '';
		if (!($col = xml_fetch_tag($f, $b, $gz))) return false;
		if ($col == '/'.$type) break;
		$value = '';
		if (!xml_fetch_tag($f, $value, $gz)) return false;
		if (substr($col, 0, 5) == 'lien:') {
			$type_lien = substr($col, 5);
			$liens[$type_lien][] = '('.$id_objet.','.$value.')';
		}
		else if ($col != 'maj') {
			// tentative de restauration d'une base sauvegardee avec le champ 'images' ; d'experience, ca arrive...
			// mieux vaut accepter que canner silencieusement...
			if (($type == 'article') &amp;&amp; ($col == 'images'))
			{
				if ($value) {		// ne pas afficher de message si on a un champ suppl mais vide
					echo &quot;--&gt;&lt;br&gt;&lt;font color='red'&gt;&lt;b&gt;&quot;._T('avis_erreur_sauvegarde', array('type' =&gt; $type, 'id_objet' =&gt; $id_objet)).&quot;&lt;/b&gt;&lt;/font&gt;\n&lt;font color='black'&gt;&quot;._T('avis_colonne_inexistante', array('col' =&gt; $col));
					if ($col == 'images') echo _T('info_verifier_image');
					echo &quot;&lt;/font&gt;\n&lt;!--&quot;;
					$GLOBALS['erreur_restauration'] = true;
				}
			}
			else {
				$cols[] = $col;
				$values[] = '&quot;'.addslashes($value).'&quot;';
				if ($col == $id) $id_objet = $value;
			}
		}
	}

	$table = $tables[$type];
	$query = &quot;REPLACE $table (&quot; . join(',', $cols) . ') VALUES (' . join(',', $values) . ')';
	if (!spip_query($query)) {
		echo &quot;--&gt;&lt;br&gt;&lt;font color='red'&gt;&lt;b&gt;&quot;._T('avis_erreur_mysql').&quot;&lt;/b&gt;&lt;/font&gt;\n&lt;font color='black'&gt;&lt;tt&gt;&quot;.spip_sql_error().&quot;&lt;/tt&gt;&lt;/font&gt;\n&lt;!--&quot;;
		$GLOBALS['erreur_restauration'] = true;
	}

	if ($type == 'article') {
		spip_query(&quot;DELETE FROM spip_auteurs_articles WHERE id_article=$id_objet&quot;);
		spip_query(&quot;DELETE FROM spip_documents_articles WHERE id_article=$id_objet&quot;);
	}
	else if ($type == 'rubrique') {
		spip_query(&quot;DELETE FROM spip_auteurs_rubriques WHERE id_rubrique=$id_objet&quot;);
		spip_query(&quot;DELETE FROM spip_documents_rubriques WHERE id_rubrique=$id_objet&quot;);
	}
	else if ($type == 'breve') {
		spip_query(&quot;DELETE FROM spip_documents_breves WHERE id_breve=$id_objet&quot;);
	}
	else if ($type == 'mot') {
		spip_query(&quot;DELETE FROM spip_mots_articles WHERE id_mot=$id_objet&quot;);
		spip_query(&quot;DELETE FROM spip_mots_breves WHERE id_mot=$id_objet&quot;);
		spip_query(&quot;DELETE FROM spip_mots_forum WHERE id_mot=$id_objet&quot;);
		spip_query(&quot;DELETE FROM spip_mots_rubriques WHERE id_mot=$id_objet&quot;);
		spip_query(&quot;DELETE FROM spip_mots_syndic WHERE id_mot=$id_objet&quot;);
	}
	else if ($type == 'auteur') {
		spip_query(&quot;DELETE FROM spip_auteurs_rubriques WHERE id_auteur=$id_objet&quot;);
	}
	else if ($type == 'message') {
		spip_query(&quot;DELETE FROM spip_auteurs_messages WHERE id_message=$id_objet&quot;);
	}
	if ($liens) {
		reset($liens);
		while (list($type_lien, $t) = each($liens)) {
			if ($type == 'auteur' OR $type == 'mot' OR $type == 'document')
				if ($type_lien == 'syndic' OR $type_lien == 'forum') $table_lien = 'spip_'.$type.'s_'.$type_lien;
				else $table_lien = 'spip_'.$type.'s_'.$type_lien.'s';
			else
				$table_lien = 'spip_'.$type_lien.'s_'.$type.'s';
			$query = &quot;INSERT INTO $table_lien ($id, id_$type_lien) VALUES &quot;.join(',', $t);
			spip_query($query);
		}
	}

	$p = $pos + $abs_pos;
	ecrire_meta(&quot;status_restauration&quot;, &quot;$p&quot;);

	return $import_ok = true;
}


function import_objet_0_0($f, $gz=false) {
	global $import_ok, $pos, $abs_pos;

	$import_ok = false;
	$b = '';
	if (!($type = xml_fetch_tag($f, $b, $gz))) return false;
	if ($type == '/SPIP') return !($import_ok = true);
	$is_art = ($type == 'article');
	$is_mot = ($type == 'mot');
	for (;;) {
		$b = '';
		if (!($col = xml_fetch_tag($f, $b, $gz))) return false;
		if ($col == (&quot;/$type&quot;)) break;
		$value = '';
		if (!xml_fetch_tag($f, $value, $gz)) return false;
		if ($is_art AND $col == 'id_auteur') {
			$auteurs[] = $value;
		}
		else if ($is_mot AND $col == 'id_article') {
			$articles[] = $value;
		}
		else if ($is_mot AND $col == 'id_breve') {
			$breves[] = $value;
		}
		else if ($is_mot AND $col == 'id_forum') {
			$forums[] = $value;
		}
		else if ($is_mot AND $col == 'id_rubrique') {
			$rubriques[] = $value;
		}
		else if ($is_mot AND $col == 'id_syndic') {
			$syndics[] = $value;
		}
		else if ($col != 'maj') {
			$cols[] = $col;
			$values[] = '&quot;'.addslashes($value).'&quot;';
			if ($is_art &amp;&amp; ($col == 'id_article')) $id_article = $value;
			if ($is_mot &amp;&amp; ($col == 'id_mot')) $id_mot = $value;
		}
	}

	$table = &quot;spip_$type&quot;;
	if ($type != 'forum' AND $type != 'syndic') $table .= 's';
	$query = &quot;REPLACE $table (&quot; . join(&quot;,&quot;, $cols) . &quot;) VALUES (&quot; . join(&quot;,&quot;, $values) . &quot;)&quot;;
	spip_query($query);

	if ($is_art &amp;&amp; $id_article) {
		$query = &quot;DELETE FROM spip_auteurs_articles WHERE id_article=$id_article&quot;;
		spip_query($query);
		if ($auteurs) {
			reset ($auteurs);
			while (list(, $auteur) = each($auteurs)) {
				$query = &quot;INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES ($auteur, $id_article)&quot;;
				spip_query($query);
			}
		}
	}
	if ($is_mot &amp;&amp; $id_mot) {
		$query = &quot;DELETE FROM spip_mots_articles WHERE id_mot=$id_mot&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_breves WHERE id_mot=$id_mot&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_forum WHERE id_mot=$id_mot&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_rubriques WHERE id_mot=$id_mot&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_syndic WHERE id_mot=$id_mot&quot;;
		spip_query($query);
		if ($articles) {
			reset ($articles);
			while (list(, $article) = each($articles)) {
				$query = &quot;INSERT INTO spip_mots_articles (id_mot, id_article) VALUES ($id_mot, $article)&quot;;
				spip_query($query);
			}
		}
		if ($breves) {
			reset ($breves);
			while (list(, $breve) = each($breves)) {
				$query = &quot;INSERT INTO spip_mots_breves (id_mot, id_breve) VALUES ($id_mot, $breve)&quot;;
				spip_query($query);
			}
		}
		if ($forums) {
			reset ($forums);
			while (list(, $forum) = each($forums)) {
				$query = &quot;INSERT INTO spip_mots_forum (id_mot, id_forum) VALUES ($id_mot, $forum)&quot;;
				spip_query($query);
			}
		}
		if ($rubriques) {
			reset ($rubriques);
			while (list(, $rubrique) = each($rubriques)) {
				$query = &quot;INSERT INTO spip_mots_rubriques (id_mot, id_rubrique) VALUES ($id_mot, $id_rubrique)&quot;;
				spip_query($query);
			}
		}
		if ($syndics) {
			reset ($syndics);
			while (list(, $syndic) = each($syndics)) {
				$query = &quot;INSERT INTO spip_mots_syndic (id_mot, id_syndic) VALUES ($id_mot, $syndic)&quot;;
				spip_query($query);
			}
		}
	}

	$p = $pos + $abs_pos;
	ecrire_meta(&quot;status_restauration&quot;, &quot;$p&quot;);
//	ecrire_metas();

	return $import_ok = true;
}

function import_objet($f, $gz = false) {
	return import_objet_1_2($f, $gz);
}

function import_fin() {
	// Effacer l'ancien acces admin
	$query = &quot;DELETE FROM spip_auteurs WHERE id_auteur=0&quot;;
	spip_query($query);

	if ($charset = lire_meta('charset_restauration'))
		ecrire_meta('charset', $charset);
	effacer_meta(&quot;charset_restauration&quot;);
	effacer_meta(&quot;status_restauration&quot;);
	effacer_meta(&quot;debut_restauration&quot;);
	effacer_meta(&quot;date_optimisation&quot;);
	ecrire_meta('calculer_rubriques', 'oui');
	ecrire_metas();
}

function import_abandon() {
	// Probleme pour restaurer l'ancien acces admin : il conserve un id_auteur = 0

	effacer_meta(&quot;charset_restauration&quot;);
	effacer_meta(&quot;status_restauration&quot;);
	effacer_meta(&quot;debut_restauration&quot;);
	effacer_meta(&quot;date_optimisation&quot;);
	ecrire_metas();
}


function import_all($f, $gz=false) {
	global $import_ok;
	global $meta;
	global $auth_htaccess;
	global $connect_id_auteur;
	$_fseek = ($gz) ? gzseek : fseek;

	$my_date = lire_meta_maj(&quot;debut_restauration&quot;);
	if (!$my_date) return false;

	$my_pos = lire_meta(&quot;status_restauration&quot;);

	if (!$my_pos) {
		// Debut de l'importation
		ecrire_meta('charset_restauration', 'iso-8859-1');
		if (!($r = import_debut($f, $gz))) {
			ecrire_meta(&quot;erreur&quot;, _T('avis_archive_incorrect'));
			return false;
		}
		else {
			// Bidouille pour garder l'acces admin actuel pendant toute la restauration
			$query = &quot;UPDATE spip_auteurs SET id_auteur=0 WHERE id_auteur=$connect_id_auteur&quot;;
			spip_query($query);

			$version_archive = $r[1]['version_archive'];
			ecrire_meta('version_archive_restauration', $version_archive);
		}
	}
	else {
		// Reprise de l'importation
		$_fseek($f, $my_pos);
		$version_archive = lire_meta('version_archive_restauration');
	}

	// Restauration des entrees du fichier

	switch ($version_archive) {
	case '1.2':
		while (import_objet_1_2($f, $gz));
		break;
	default:
		while (import_objet_0_0($f, $gz));
		break;
	}
	if (!$import_ok) {
		ecrire_meta(&quot;erreur&quot;, _T('avis_archive_invalide'));
		return false;
	}

	// Mise a jour du fichier htpasswd

	ecrire_acces();

	// Destruction des entrees non restaurees

	$query = &quot;DELETE FROM spip_rubriques WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_breves WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_auteurs WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_articles WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_documents WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_types_documents WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_forum WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_mots WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_groupes_mots WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_petitions WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_signatures WHERE maj &lt; $my_date&quot;;
	spip_query($query);
	$query = &quot;DELETE FROM spip_visites WHERE maj &lt; $my_date&quot;;
	spip_query($query);

	import_fin();

	affiche_progression_javascript('100 %');

	return true;
}


function affiche_progression_javascript($abs_pos) {
	global $affiche_progression_pourcent;
	include_ecrire('inc_charsets.php3');
	flush();
	echo &quot; --&gt;\n&lt;script type='text/javascript'&gt;&lt;!--\n&quot;;

	if ($abs_pos == '100 %') {
		$taille = $abs_pos;
		if ($GLOBALS['erreur_restauration'])
			echo &quot;document.progression.recharge.value='&quot;.str_replace(&quot;'&quot;, &quot;\\'&quot;, unicode_to_javascript(_T('avis_erreur'))).&quot;';\n&quot;;
		else
			echo &quot;document.progression.recharge.value='&quot;.str_replace(&quot;'&quot;, &quot;\\'&quot;, unicode_to_javascript(_T('info_fini'))).&quot;';\n&quot;;
	}
	else if (! $affiche_progression_pourcent)
		$taille = ereg_replace(&quot;&nbsp;&quot;, &quot; &quot;, taille_en_octets($abs_pos));
	else
		$taille = floor(100 * $abs_pos / $affiche_progression_pourcent).&quot; %&quot;;

	echo &quot;document.progression.taille.value='$taille';\n&quot;;
	echo &quot;//--&gt;&lt;/script&gt;\n&lt;!--\n&quot;;
	flush();
}

?&gt;

--- NEW FILE: articles_forum.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_index.php3&quot;);
include_ecrire (&quot;inc_logos.php3&quot;);



$query = &quot;SELECT titre, id_rubrique FROM spip_articles WHERE id_article='$id_article'&quot;;
$result = spip_query($query);

while($row = spip_fetch_array($result)) {
	$titre = $row[&quot;titre&quot;];
	$id_rubrique = $row[&quot;id_rubrique&quot;];
}


debut_page($titre, &quot;documents&quot;, &quot;articles&quot;);



debut_grand_cadre();

afficher_hierarchie($id_rubrique);

fin_grand_cadre();



debut_gauche();


debut_boite_info();

echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=2&gt;&quot;;
echo &quot;&lt;P align=left&gt;&quot;._T('info_gauche_suivi_forum');

echo aide (&quot;suiviforum&quot;);
echo &quot;&lt;/FONT&gt;&quot;;

fin_boite_info();


debut_droite();


echo &quot;\n&lt;table cellpadding=0 cellspacing=0 border=0 width='100%'&gt;&quot;;
echo &quot;&lt;tr width='100%'&gt;&quot;;
echo &quot;&lt;td&gt;&quot;;
	icone(_T('icone_retour'), &quot;articles.php3?id_article=$id_article&quot;, &quot;article-24.gif&quot;, &quot;rien.gif&quot;);

echo &quot;&lt;/td&gt;&quot;;
echo &quot;&lt;td&gt;&quot; . http_img_pack('rien.gif', &quot;&quot;, &quot;width='10'&quot;) .&quot;&lt;/td&gt;\n&quot;;
echo &quot;&lt;td width='100%'&gt;&quot;;
echo _T('texte_messages_publics');
gros_titre($titre);
echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
echo &quot;&lt;p&gt;&quot;;

// Ne pas donner les cles du forum a des non-admins
if (! ($connect_statut=='0minirezo' AND acces_rubrique($id_rubrique)))
	return;

echo &quot;&lt;div class='serif2'&gt;&quot;;

// reglages
if (!$debut) $debut = 0;
$pack = 5;		// nb de forums affiches par page
$enplus = 200;	// intervalle affiche autour du debut
$limitdeb = ($debut &gt; $enplus) ? $debut-$enplus : 0;
$limitnb = $debut + $enplus - $limitdeb;

$query_forum = &quot;SELECT id_forum FROM spip_forum WHERE id_article='$id_article' AND id_parent=0 AND statut IN ('publie', 'off', 'prop') LIMIT $limitdeb, $limitnb&quot;;
$result_forum = spip_query($query_forum);


$i = $limitdeb;
if ($i&gt;0)
	echo &quot;&lt;A HREF='articles_forum.php3?id_article=$id_article&amp;page=$page'&gt;0&lt;/A&gt; ... | &quot;;
while ($row = spip_fetch_array($result_forum)) {

	// barre de navigation
	if ($i == $pack*floor($i/$pack)) {
		if ($i == $debut)
			echo &quot;&lt;FONT SIZE=3&gt;&lt;B&gt;$i&lt;/B&gt;&lt;/FONT&gt;&quot;;
		else
			echo &quot;&lt;A HREF='articles_forum.php3?id_article=$id_article&amp;debut=$i&amp;page=$page'&gt;$i&lt;/A&gt;&quot;;
		echo &quot; | &quot;;
	}

	// elements a controler

	$i ++;
}
echo &quot;&lt;A HREF='articles_forum.php3?id_article=$id_article&amp;debut=$i&amp;page=$page'&gt;...&lt;/A&gt;&quot;;

echo &quot;&lt;/div&gt;&quot;;


$mots_cles_forums = lire_meta(&quot;mots_cles_forums&quot;);

if ($connect_statut == &quot;0minirezo&quot;) {
	$query_forum = &quot;SELECT * FROM spip_forum WHERE id_article='$id_article' AND id_parent=0 AND statut IN ('publie', 'off', 'prop') ORDER BY date_heure DESC LIMIT $debut, $pack&quot;;
	$result_forum = spip_query($query_forum);
	afficher_forum($result_forum, $forum_retour, $id_article);
}

echo &quot;&lt;/FONT&gt;&quot;;

fin_page();

?&gt;

--- NEW FILE: install.php3 ---
&lt;?php
if (defined(&quot;_ECRIRE_INSTALL&quot;)) return;
define(&quot;_ECRIRE_INSTALL&quot;, &quot;1&quot;);

include (&quot;inc_version.php3&quot;);
include_ecrire (&quot;inc_presentation.php3&quot;);


// Une fonction pour faciliter la recherche du login (superflu ?)
function login_hebergeur() {
	global $HTTP_X_HOST, $REQUEST_URI, $SERVER_NAME, $HTTP_HOST;

	// Lycos (ex-Multimachin)
	if ($HTTP_X_HOST == 'membres.lycos.fr') {
		ereg('^/([^/]*)', $REQUEST_URI, $regs);
		$login_hebergeur = $regs[1];
	}
	// Altern
	else if (ereg('altern\.com$', $SERVER_NAME)) {
		ereg('([^.]*\.[^.]*)$', $HTTP_HOST, $regs);
		$login_hebergeur = ereg_replace('[^a-zA-Z0-9]', '_', $regs[1]);
	}
	// Free
	else if (ereg('^/([^/]*)\.free.fr/', $REQUEST_URI, $regs)) {
		$login_hebergeur = $regs[1];
	}

	return $login_hebergeur;
}



if (_FILE_CONNECT) {
	install_debut_html();
	echo &quot;&lt;P&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=4&gt;&quot;._T('avis_espace_interdit').&quot;&lt;/FONT&gt;&quot;;

	install_fin_html();
	exit;
}

include_ecrire (&quot;inc_base.php3&quot;);
define('_FILE_TMP', '_install');

//
// Etapes de l'installation standard
//

if ($etape == 6) {
	install_debut_html();

	echo &quot;&lt;BR&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_derniere_etape').&quot;&lt;/B&gt;&lt;/FONT&gt;&quot;;
	echo &quot;&lt;P&gt;&quot;;
	echo &quot;&lt;B&gt;&quot;._T('info_code_acces').&quot;&lt;/B&gt;&quot;;
	echo &quot;&lt;P&gt;&quot;._T('info_utilisation_spip');

	include(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
	include_ecrire (&quot;inc_meta.php3&quot;);

	if ($login) {
		$nom = addslashes($nom);
		$login = addslashes($login);
		$query = &quot;SELECT id_auteur FROM spip_auteurs WHERE login='$login'&quot;;
		$result = spip_query_db($query);
		unset($id_auteur);
		while ($row = spip_fetch_array($result)) $id_auteur = $row['id_auteur'];

		$mdpass = md5($pass);
		$htpass = generer_htpass($pass);

		if ($id_auteur) {
			$query = &quot;UPDATE spip_auteurs SET nom='$nom', email='$email', login='$login', pass='$mdpass', alea_actuel='', alea_futur=FLOOR(32000*RAND()), htpass='$htpass', statut='0minirezo' WHERE id_auteur=$id_auteur&quot;;
		}
		else {
			$query = &quot;INSERT INTO spip_auteurs (nom, email, login, pass, htpass, alea_futur, statut) VALUES('$nom','$email','$login','$mdpass','$htpass',FLOOR(32000*RAND()),'0minirezo')&quot;;
		}
		spip_query_db($query);

		// inserer email comme email webmaster principal
		ecrire_meta('email_webmaster', $email);
	}

	include_ecrire(&quot;inc_config.php3&quot;);
	init_config();
	init_langues();

	include_ecrire (&quot;inc_acces.php3&quot;);
	ecrire_acces();

	@unlink(_DIR_SESSIONS . 'inc_meta_cache.php3');
	@unlink(_DIR_SESSIONS . 'meta_cache.php3');
	if (!@rename(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP,
		    _FILE_CONNECT_INS . _EXTENSION_PHP)) {
		copy(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP, 
		     _FILE_CONNECT_INS . _EXTENSION_PHP);
		@unlink(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
	}

	echo &quot;&lt;FORM ACTION='index.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;
	echo &quot;&lt;/FORM&gt;&quot;;

	ecrire_metas();

	install_fin_html();
}

else if ($etape == 5) {
	install_debut_html();

	include(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_informations_personnelles').&quot;&lt;/FONT&gt;&quot;;
	echo &quot;&lt;P&gt;\n&quot;;

	echo &quot;&lt;b&gt;&quot;._T('texte_informations_personnelles_1').&quot;&lt;/b&gt;&quot;;
	echo aide (&quot;install5&quot;);
	echo &quot;&lt;p&gt;\n&quot;._T('texte_informations_personnelles_2').&quot; &quot;;
	echo _T('info_laisser_champs_vides');

	echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='6'&gt;&quot;;

	echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('info_identification_publique').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo &quot;&lt;B&gt;&quot;._T('entree_signature').&quot;&lt;/B&gt;&lt;BR /&gt;\n&quot;;
	echo _T('entree_nom_pseudo_1').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='nom' CLASS='formo' VALUE=\&quot;$nom\&quot; SIZE='40'&gt;&lt;P&gt;\n&quot;;

	echo &quot;&lt;B&gt;&quot;._T('entree_adresse_email').&quot;&lt;/B&gt;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='email' CLASS='formo' VALUE=\&quot;$email\&quot; SIZE='40'&gt;&lt;/fieldset&gt;&lt;P&gt;\n&quot;;

	echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('entree_identifiants_connexion').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo &quot;&lt;B&gt;&quot;._T('entree_login').&quot;&lt;/B&gt;&lt;BR /&gt;\n&quot;;
	echo _T('info_plus_trois_car').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='login' CLASS='formo' VALUE=\&quot;$login\&quot; SIZE='40'&gt;&lt;P&gt;\n&quot;;

	echo &quot;&lt;B&gt;&quot;._T('entree_mot_passe').&quot;&lt;/B&gt; &lt;BR /&gt;\n&quot;;
	echo _T('info_plus_cinq_car_2').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='password' NAME='pass' CLASS='formo' VALUE=\&quot;$pass\&quot; SIZE='40'&gt;&lt;/fieldset&gt;&lt;P&gt;\n&quot;;

	echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;
	echo &quot;&lt;/FORM&gt;&quot;;
	echo &quot;&lt;p&gt;\n&quot;;

	if ($flag_ldap AND !$ldap_present) {
		echo &quot;&lt;div style='border: 1px solid #404040; padding: 10px; text-align: left;'&gt;&quot;;
		echo &quot;&lt;b&gt;&quot;._T('info_authentification_externe').&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;p&gt;\n&quot;._T('texte_annuaire_ldap_1');
		echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='ldap1'&gt;&quot;;
		echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE=\&quot;&quot;._T('bouton_acces_ldap').&quot;\&quot;&gt;&quot;;
		echo &quot;&lt;/FORM&gt;&quot;;
	}

	install_fin_html();

}

else if ($etape == 4) {

	install_debut_html();

	// Necessaire pour appeler les fonctions SQL wrappees
	include_ecrire(&quot;inc_db_mysql.php3&quot;);

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_creation_tables').&quot;&lt;/FONT&gt;&quot;;
	echo &quot;&lt;P&gt;\n&quot;;

	$link = mysql_connect(&quot;$adresse_db&quot;, &quot;$login_db&quot;, &quot;$pass_db&quot;);

	echo &quot;&lt;&quot;.&quot;!-- $link &quot;;

	if ($choix_db == &quot;new_spip&quot;) {
		$sel_db = $table_new;
		mysql_query(&quot;CREATE DATABASE $sel_db&quot;);
	}
	else {
		$sel_db = $choix_db;
	}
	echo $sel_db;
	mysql_select_db(&quot;$sel_db&quot;);

	// Test si SPIP deja installe
	@spip_query_db(&quot;SELECT COUNT(*) FROM spip_meta&quot;);
	$nouvelle = spip_sql_errno();

	creer_base();
	$maj_ok = maj_base();

	if ($nouvelle) {
		spip_query_db(&quot;INSERT spip_meta (nom, valeur) VALUES ('nouvelle_install', 'oui')&quot;);
		$result_ok = !spip_sql_errno();
	} else {
		$result = spip_query_db(&quot;SELECT COUNT(*) FROM spip_articles&quot;);
		$result_ok = (spip_num_rows($result) &gt; 0);
	}
	echo &quot;($result_ok &amp;&amp; $maj_ok) --&gt;&quot;;


	if ($result_ok &amp;&amp; $maj_ok) {
		$conn = &quot;&lt;&quot;.&quot;?php\n&quot;;
		$conn .= &quot;if (defined(\&quot;_ECRIRE_INC_CONNECT\&quot;)) return;\n&quot;;
		$conn .= &quot;define(\&quot;_ECRIRE_INC_CONNECT\&quot;, \&quot;1\&quot;);\n&quot;;
		$conn .= &quot;\$GLOBALS['spip_connect_version'] = 0.1;\n&quot;;
		$conn .= &quot;include_ecrire('inc_db_mysql.php3');\n&quot;;
		$conn .= &quot;@spip_connect_db('$adresse_db','','$login_db','$pass_db','$sel_db');\n&quot;;
		$conn .= &quot;\$GLOBALS['db_ok'] = !!@spip_num_rows(@spip_query_db('SELECT COUNT(*) FROM spip_meta'));\n&quot;;
		$conn .= &quot;?&quot;.&quot;&gt;&quot;;
		$myFile = fopen(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP, &quot;wb&quot;);
		fputs($myFile, $conn);
		fclose($myFile);

		echo &quot;&lt;B&gt;&quot;._T('info_base_installee').&quot;&lt;/B&gt;&lt;P&gt;\n&quot;._T('info_etape_suivante_1');

		echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='5'&gt;&quot;;

		echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;

		echo &quot;&lt;/FORM&gt;&quot;;
	}
	else if ($result_ok) {
		echo _T('alerte_maj_impossible', array('version' =&gt; $spip_version));
	}
	else {
		echo &quot;&lt;B&gt;&quot;._T('avis_operation_echec').&quot;&lt;/B&gt; &quot;._T('texte_operation_echec');
	}

	install_fin_html();

}

else if ($etape == 3) {

	install_debut_html();

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_choix_base').&quot; &lt;B&gt;&quot;._T('menu_aide_installation_choix_base').&quot;&lt;/B&gt;&lt;/FONT&gt;&quot;;

	echo aide (&quot;install2&quot;);
	echo &quot;&lt;P&gt;\n&quot;;

	echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='4'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='adresse_db'  VALUE=\&quot;$adresse_db\&quot; SIZE='40'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='login_db' VALUE=\&quot;$login_db\&quot;&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='pass_db' VALUE=\&quot;$pass_db\&quot;&gt;&lt;P&gt;\n&quot;;

	$link = mysql_connect(&quot;$adresse_db&quot;,&quot;$login_db&quot;,&quot;$pass_db&quot;);
	$result = @mysql_list_dbs();

	echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('texte_choix_base_1').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;

	if ($result AND (($n = @mysql_num_rows($result)) &gt; 0)) {
		echo &quot;&lt;B&gt;&quot;._T('texte_choix_base_2').&quot;&lt;/B&gt;&lt;P&gt; &quot;._T('texte_choix_base_3');
		echo &quot;&lt;UL&gt;&quot;;
		$bases = &quot;&quot;;
		for ($i = 0; $i &lt; $n; $i++) {
			$table_nom = mysql_dbname($result, $i);
			$base = &quot;&lt;INPUT NAME=\&quot;choix_db\&quot; VALUE=\&quot;&quot;.$table_nom.&quot;\&quot; TYPE=Radio id='tab$i'&quot;;
			$base_fin = &quot;&gt;&lt;label for='tab$i'&gt;&quot;.$table_nom.&quot;&lt;/label&gt;&lt;BR /&gt;\n\n&quot;;
			if ($table_nom == $login_db) {
				$bases = &quot;$base CHECKED$base_fin&quot;.$bases;
				$checked = true;
			}
			else {
				$bases .= &quot;$base$base_fin\n&quot;;
			}
		}
		echo $bases.&quot;&lt;/UL&gt;&quot;;
		echo _T('info_ou').&quot; &quot;;
	}
	else {
		echo &quot;&lt;B&gt;&quot;._T('avis_lecture_noms_bases_1').&quot;&lt;/B&gt;
		&quot;._T('avis_lecture_noms_bases_2').&quot;&lt;P&gt;&quot;;
		if ($login_db) {
			echo _T('avis_lecture_noms_bases_3');
			echo &quot;&lt;UL&gt;&quot;;
			echo &quot;&lt;INPUT NAME=\&quot;choix_db\&quot; VALUE=\&quot;&quot;.$login_db.&quot;\&quot; TYPE=Radio id='stand' CHECKED&gt;&quot;;
			echo &quot;&lt;label for='stand'&gt;&quot;.$login_db.&quot;&lt;/label&gt;&lt;BR /&gt;\n&quot;;
			echo &quot;&lt;/UL&gt;&quot;;
			echo _T('info_ou').&quot; &quot;;
			$checked = true;
		}
	}
	echo &quot;&lt;INPUT NAME=\&quot;choix_db\&quot; VALUE=\&quot;new_spip\&quot; TYPE=Radio id='nou'&quot;;
	if (!$checked) echo &quot; CHECKED&quot;;
	echo &quot;&gt; &lt;label for='nou'&gt;&quot;._T('info_creer_base').&quot;&lt;/label&gt; &quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='table_new' CLASS='fondo' VALUE=\&quot;spip\&quot; SIZE='20'&gt;&lt;/fieldset&gt;&lt;P&gt;&quot;;

	echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;


	echo &quot;&lt;/FORM&gt;&quot;;

	install_fin_html();

}

else if ($etape == 2) {

	install_debut_html();

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_connexion_base').&quot;&lt;/FONT&gt;&quot;;

	echo &quot;&lt;!--&quot;;
	$link = mysql_connect(&quot;$adresse_db&quot;,&quot;$login_db&quot;,&quot;$pass_db&quot;);
	$db_connect = mysql_errno();
	echo &quot;--&gt;&quot;;

	echo &quot;&lt;P&gt;&quot;;

	if (($db_connect==&quot;0&quot;) &amp;&amp; $link){
		echo &quot;&lt;B&gt;&quot;._T('info_connexion_ok').&quot;&lt;/B&gt;&lt;P&gt; &quot;._T('info_etape_suivante_2');

		echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='3'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='adresse_db'  VALUE=\&quot;$adresse_db\&quot; SIZE='40'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='login_db' VALUE=\&quot;$login_db\&quot;&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='pass_db' VALUE=\&quot;$pass_db\&quot;&gt;&lt;P&gt;&quot;;

		echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;
		echo &quot;&lt;/FORM&gt;&quot;;
	}
	else {
		echo &quot;&lt;B&gt;&quot;._T('avis_connexion_echec_1').&quot;&lt;/B&gt;&quot;;
		echo &quot;&lt;P&gt;&quot;._T('avis_connexion_echec_2');
		echo &quot;&lt;P&gt;&lt;FONT SIZE=2&gt;&quot;._T('avis_connexion_echec_3').&quot;&lt;/FONT&gt;&quot;;
	}

	install_fin_html();

}
else if ($etape == 1) {
	install_debut_html();

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_connexion_mysql').&quot;&lt;/FONT&gt;&quot;;

	echo &quot;&lt;P&gt;&quot;._T('texte_connexion_mysql');

	echo aide (&quot;install1&quot;);

	$adresse_db = 'localhost';
	$login_db = login_hebergeur();
	$pass_db = '';

	// Recuperer les anciennes donnees pour plus de facilite (si presentes)
	if (@file_exists(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP)) {
		$s = @join('', @file(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP));
		if (ereg(&quot;mysql_connect\([\&quot;'](.*)[\&quot;'],[\&quot;'](.*)[\&quot;'],[\&quot;'](.*)[\&quot;']\)&quot;, $s, $regs)) {
			$adresse_db = $regs[1];
			$login_db = $regs[2];
		}
		else if (ereg(&quot;spip_connect_db\('(.*)','(.*)','(.*)','(.*)','(.*)'\)&quot;, $s, $regs)) {
			$adresse_db = $regs[1];
			if ($port_db = $regs[2]) $adresse_db .= ':'.$port_db;
			$login_db = $regs[3];
		}
	}

	echo &quot;&lt;p&gt;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='2'&gt;&quot;;
	echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('entree_base_donnee_1').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo _T('entree_base_donnee_2').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='adresse_db' CLASS='formo' VALUE=\&quot;$adresse_db\&quot; SIZE='40'&gt;&lt;/fieldset&gt;&lt;P&gt;&quot;;

	echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('entree_login_connexion_1').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo _T('entree_login_connexion_2').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='login_db' CLASS='formo' VALUE=\&quot;$login_db\&quot; SIZE='40'&gt;&lt;/fieldset&gt;&lt;P&gt;&quot;;

	echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('entree_mot_passe_1').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo _T('entree_mot_passe_2').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='password' NAME='pass_db' CLASS='formo' VALUE=\&quot;$pass_db\&quot; SIZE='40'&gt;&lt;/fieldset&gt;&lt;P&gt;&quot;;

	echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;


	echo &quot;&lt;/FORM&gt;&quot;;

	install_fin_html();

}
else if ($etape == 'dirs') {
	header(&quot;Location: ../spip_test_dirs.php3&quot;);
}
else if (!$etape) {
	$menu_langues = menu_langues('var_lang_ecrire');

	if (!$menu_langues)
		header(&quot;Location: ../spip_test_dirs.php3&quot;);
	else {
		install_debut_html();

		echo &quot;&lt;p align='center'&gt;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;logo-spip.gif'&gt;&lt;/p&gt;&quot;;
		
		echo &quot;&lt;p style='text-align: center; font-family: Verdana,Arial,Sans,sans-serif; font-size: 10px;'&gt;&quot;;
		echo &quot;&lt;b&gt;SPIP $spip_version_affichee&lt;/b&gt; &quot;;
		echo _T('info_copyright');

		echo &quot;&lt;/p&gt;&quot;;

		echo &quot;&lt;p&gt;&quot; . _T('install_select_langue');

		echo &quot;&lt;p&gt;&lt;div align='center'&gt;&quot;.$menu_langues.&quot;&lt;/div&gt;&quot;;

		echo &quot;&lt;p&gt;&lt;FORM ACTION='install.php3' METHOD='get'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='dirs'&gt;&quot;;
		echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;
		echo &quot;&lt;/FORM&gt;&quot;;
		install_fin_html();
	}
}


//
// Etapes de l'installation LDAP
//

else if ($etape == 'ldap5') {
	install_debut_html();

	include_local(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP);
	include_ecrire('inc_meta.php3');
	ecrire_meta(&quot;ldap_statut_import&quot;, $statut_ldap);
	ecrire_metas();

	echo &quot;&lt;B&gt;&quot;._T('info_ldap_ok').&quot;&lt;/B&gt;&quot;;
	echo &quot;&lt;P&gt;&quot;._T('info_terminer_installation');

	echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='5'&gt;&quot;;

	echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;

	echo &quot;&lt;/FORM&gt;&quot;;
}

else if ($etape == 'ldap4') {
	install_debut_html();

	if (!$base_ldap) $base_ldap = $base_ldap_text;

	$ldap_link = @ldap_connect(&quot;$adresse_ldap&quot;, &quot;$port_ldap&quot;);
	@ldap_bind($ldap_link, &quot;$login_ldap&quot;, &quot;$pass_ldap&quot;);

	// Essayer de verifier le chemin fourni
	$r = @ldap_compare($ldap_link, $base_ldap, &quot;objectClass&quot;, &quot;&quot;);
	$fail = (ldap_errno($ldap_link) == 32);

	if ($fail) {
		echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_chemin_acces_annuaire').&quot;&lt;/B&gt;&lt;/FONT&gt;&quot;;
		echo &quot;&lt;P&gt;&quot;;

		echo &quot;&lt;B&gt;&quot;._T('avis_operation_echec').&quot;&lt;/B&gt; &quot;._T('avis_chemin_invalide_1').&quot; (&lt;tt&gt;&quot;.htmlspecialchars($base_ldap);
		echo &quot;&lt;/tt&gt;) &quot;._T('avis_chemin_invalide_2');
	}
	else {
		echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_reglage_ldap').&quot;&lt;/FONT&gt;&quot;;
		echo &quot;&lt;P&gt;&quot;;

		$conn = join('', file(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP));
		if ($p = strpos($conn, '?'.'&gt;')) 
			$conn = substr($conn, 0, $p);
		if (!strpos($conn, 'spip_connect_ldap')) {
			$conn .= &quot;function spip_connect_ldap() {\n&quot;;
			$conn .= &quot;\t\$GLOBALS['ldap_link'] = @ldap_connect(\&quot;$adresse_ldap\&quot;,\&quot;$port_ldap\&quot;);\n&quot;;
			$conn .= &quot;\<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">t at ldap_bind</A>(\$GLOBALS['ldap_link'],\&quot;$login_ldap\&quot;,\&quot;$pass_ldap\&quot;);\n&quot;;
			$conn .= &quot;\treturn \$GLOBALS['ldap_link'];\n&quot;;
			$conn .= &quot;}\n&quot;;
			$conn .= &quot;\$GLOBALS['ldap_base'] = \&quot;$base_ldap\&quot;;\n&quot;;
			$conn .= &quot;\$GLOBALS['ldap_present'] = true;\n&quot;;
		}
		$conn .= &quot;?&quot;.&quot;&gt;&quot;;
		$myFile = fopen(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP, &quot;wb&quot;);
		fputs($myFile, $conn);
		fclose($myFile);

		echo &quot;&lt;p&gt;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='ldap5'&gt;&quot;;
		echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('info_statut_utilisateurs_1').&quot;&lt;/B&gt;&lt;/label&gt;&lt;BR /&gt;\n&quot;;
		echo _T('info_statut_utilisateurs_2').&quot; &quot;;
		echo &quot;&lt;p&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='Radio' NAME='statut_ldap' VALUE=\&quot;6forum\&quot; id='visit'&gt;&quot;;
		echo &quot;&lt;label for='visit'&gt;&lt;b&gt;&quot;._T('info_visiteur_1').&quot;&lt;/b&gt;&lt;/label&gt; &quot;._T('info_visiteur_2').&quot;&lt;br /&gt;\n&quot;;
		echo &quot;&lt;INPUT TYPE='Radio' NAME='statut_ldap' VALUE=\&quot;1comite\&quot; id='redac' CHECKED&gt;&quot;;
		echo &quot;&lt;label for='redac'&gt;&lt;b&gt;&quot;._T('info_redacteur_1').&quot;&lt;/b&gt;&lt;/label&gt; &quot;._T('info_redacteur_2').&quot;&lt;br /&gt;\n&quot;;
		echo &quot;&lt;INPUT TYPE='Radio' NAME='statut_ldap' VALUE=\&quot;0minirezo\&quot; id='admin'&gt;&quot;;
		echo &quot;&lt;label for='admin'&gt;&lt;b&gt;&quot;._T('info_administrateur_1').&quot;&lt;/b&gt;&lt;/label&gt; &quot;._T('info_administrateur_2').&quot;&lt;br /&gt;\n&quot;;
	
		echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;

		echo &quot;&lt;/FORM&gt;&quot;;
	}

	install_fin_html();
}

else if ($etape == 'ldap3') {
	install_debut_html();

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_chemin_acces_1').&quot;&lt;/FONT&gt;&quot;;

	echo &quot;&lt;P&gt;&quot;._T('info_chemin_acces_2');

	$ldap_link = @ldap_connect(&quot;$adresse_ldap&quot;, &quot;$port_ldap&quot;);
	@ldap_bind($ldap_link, &quot;$login_ldap&quot;, &quot;$pass_ldap&quot;);

	$result = @ldap_read($ldap_link, &quot;&quot;, &quot;objectclass=*&quot;, array(&quot;namingContexts&quot;));
	$info = @ldap_get_entries($ldap_link, $result);

	echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='ldap4'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='adresse_ldap' VALUE=\&quot;$adresse_ldap\&quot;&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='port_ldap' VALUE=\&quot;$port_ldap\&quot;&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='login_ldap' VALUE=\&quot;$login_ldap\&quot;&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='pass_ldap' VALUE=\&quot;$pass_ldap\&quot;&gt;&quot;;

	echo &quot;&lt;fieldset&gt;&quot;;

	$checked = false;

	if (is_array($info) AND $info[&quot;count&quot;] &gt; 0) {
		echo &quot;&lt;P&gt;&quot;._T('info_selection_chemin_acces');
		echo &quot;&lt;UL&gt;&quot;;
		$n = 0;
		for ($i = 0; $i &lt; $info[&quot;count&quot;]; $i++) {
			$names = $info[$i][&quot;namingcontexts&quot;];
			if (is_array($names)) {
				for ($j = 0; $j &lt; $names[&quot;count&quot;]; $j++) {
					$n++;
					echo &quot;&lt;INPUT NAME=\&quot;base_ldap\&quot; VALUE=\&quot;&quot;.htmlspecialchars($names[$j]).&quot;\&quot; TYPE='Radio' id='tab$n'&quot;;
					if (!$checked) {
						echo &quot; CHECKED&quot;;
						$checked = true;
					}
					echo &quot;&gt;&quot;;
					echo &quot;&lt;label for='tab$n'&gt;&quot;.htmlspecialchars($names[$j]).&quot;&lt;/label&gt;&lt;BR /&gt;\n\n&quot;;
				}
			}
		}
		echo &quot;&lt;/UL&gt;&quot;;
		echo _T('info_ou').&quot; &quot;;
	}
	echo &quot;&lt;INPUT NAME=\&quot;base_ldap\&quot; VALUE=\&quot;\&quot; TYPE='Radio' id='manuel'&quot;;
	if (!$checked) {
		echo &quot; CHECKED&quot;;
		$checked = true;
	}
	echo &quot;&gt;&quot;;
	echo &quot;&lt;label for='manuel'&gt;&quot;._T('entree_chemin_acces').&quot;&lt;/label&gt; &quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='base_ldap_text' CLASS='formo' VALUE=\&quot;ou=users, dc=mon-domaine, dc=com\&quot; SIZE='40'&gt;&lt;/fieldset&gt;&lt;P&gt;&quot;;

	echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;
	echo &quot;&lt;/FORM&gt;&quot;;

	install_fin_html();

}

else if ($etape == 'ldap2') {
	install_debut_html();

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('titre_connexion_ldap').&quot;&lt;/FONT&gt;&quot;;

	echo &quot;&lt;P&gt;&quot;;

	$ldap_link = @ldap_connect(&quot;$adresse_ldap&quot;, &quot;$port_ldap&quot;);
	$r = @ldap_bind($ldap_link, &quot;$login_ldap&quot;, &quot;$pass_ldap&quot;);

	if ($ldap_link &amp;&amp; ($r || !$login_ldap)) {
		echo &quot;&lt;B&gt;&quot;._T('info_connexion_ldap_ok');

		echo &quot;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='ldap3'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='adresse_ldap' VALUE=\&quot;$adresse_ldap\&quot;&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='port_ldap' VALUE=\&quot;$port_ldap\&quot;&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='login_ldap' VALUE=\&quot;$login_ldap\&quot;&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='pass_ldap' VALUE=\&quot;$pass_ldap\&quot;&gt;&quot;;

		echo &quot;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;
		echo &quot;&lt;/FORM&gt;&quot;;
	}
	else {
		echo &quot;&lt;B&gt;&quot;._T('avis_connexion_ldap_echec_1').&quot;&lt;/B&gt;&quot;;
		echo &quot;&lt;P&gt;&quot;._T('avis_connexion_ldap_echec_2');
		echo &quot;&lt;br /&gt;\n&quot;._T('avis_connexion_ldap_echec_3');
	}

	install_fin_html();

}

else if ($etape == 'ldap1') {
	install_debut_html();

	echo &quot;&lt;BR /&gt;\n&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('titre_connexion_ldap').&quot;&lt;/FONT&gt;&quot;;

	echo &quot;&lt;P&gt;&quot;._T('entree_informations_connexion_ldap');

	$adresse_ldap = 'localhost';
	$port_ldap = 389;

	// Recuperer les anciennes donnees (si presentes)
	if (@file_exists(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP)) {
		$s = @join('', @file(_FILE_CONNECT_INS . _FILE_TMP . _EXTENSION_PHP));
		if (ereg('ldap_connect\(&quot;(.*)&quot;,&quot;(.*)&quot;\)', $s, $regs)) {
			$adresse_ldap = $regs[1];
			$port_ldap = $regs[2];
		}
	}

	echo &quot;&lt;p&gt;&lt;FORM ACTION='install.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='hidden' NAME='etape' VALUE='ldap2'&gt;&quot;;
	echo &quot;&lt;fieldset&gt;&lt;label&gt;&lt;B&gt;&quot;._T('entree_adresse_annuaire').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo _T('texte_adresse_annuaire_1').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='adresse_ldap' CLASS='formo' VALUE=\&quot;$adresse_ldap\&quot; SIZE='20'&gt;&lt;P&gt;&quot;;

	echo &quot;&lt;label&gt;&lt;B&gt;&quot;._T('entree_port_annuaire').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo _T('texte_port_annuaire').&quot;&lt;BR /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='port_ldap' CLASS='formo' VALUE=\&quot;$port_ldap\&quot; SIZE='20'&gt;&lt;P&gt;&lt;/fieldset&gt;&quot;;

	echo &quot;&lt;p&gt;&lt;fieldset&gt;&quot;;
	echo _T('texte_acces_ldap_anonyme_1').&quot; &quot;;
	echo &quot;&lt;label&gt;&lt;B&gt;&quot;._T('entree_login_ldap').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo _T('texte_login_ldap_1').&quot;&lt;br /&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='login_ldap' CLASS='formo' VALUE=\&quot;\&quot; SIZE='40'&gt;&lt;P&gt;&quot;;

	echo &quot;&lt;label&gt;&lt;B&gt;&quot;._T('entree_passe_ldap').&quot;&lt;/B&gt;&lt;BR /&gt;\n&lt;/label&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='password' NAME='pass_ldap' CLASS='formo' VALUE=\&quot;\&quot; SIZE='40'&gt;&lt;/fieldset&gt;&quot;;

	echo &quot;&lt;p&gt;&lt;DIV align='$spip_lang_right'&gt;&lt;INPUT TYPE='submit' CLASS='fondl'  VALUE='&quot;._T('bouton_suivant').&quot; &gt;&gt;'&gt;&quot;;

	echo &quot;&lt;/FORM&gt;&quot;;

	install_fin_html();

}


?&gt;

--- NEW FILE: suivi_revisions.php3 ---
&lt;?php

include(&quot;inc_lab.php&quot;);

include_ecrire(&quot;inc_suivi_revisions.php&quot;);
include_spip(&quot;ecrire.php&quot;);
include_spip(&quot;revisions.php&quot;);
include_spip(&quot;diff.php&quot;);




debut_page(_T(&quot;icone_suivi_revisions&quot;));


//////////////////////////////////////////////////////
// Affichage de la colonne de gauche
//

debut_gauche();
if (!$debut) $debut = 0;

if (!$uniq_auteur) $uniq_auteur = false ;
else $uniq_auteur = true;


if ($connect_statut == &quot;0minirezo&quot;) $req_where = &quot; AND articles.statut IN ('prepa','prop','publie')&quot;; 
else $req_where = &quot; AND articles.statut IN ('prop','publie')&quot;; 

echo &quot;&lt;p&gt;&quot;;

echo &quot;&lt;div class='arial11'&gt;&lt;ul&gt;&quot;;
echo &quot;&lt;p&gt;&quot;;

if (!$uniq_auteur AND $id_secteur &lt; 1) echo &quot;&lt;li&gt;&lt;b&gt;&quot;._T('info_tout_site').&quot;&lt;/b&gt;&quot;;
else echo &quot;&lt;li&gt;&lt;a href='suivi_revisions.php3'&gt;&quot;._T('info_tout_site').&quot;&lt;/a&gt;&quot;;

echo &quot;&lt;p&gt;&quot;;

$nom_auteur = $GLOBALS['auteur_session']['nom'];

if ($uniq_auteur) echo &quot;&lt;li&gt;&lt;b&gt;$nom_auteur&lt;/b&gt;&quot;;
else echo &quot;&lt;li&gt;&lt;a href='suivi_revisions.php3?uniq_auteur=true'&gt;$nom_auteur&lt;/a&gt;&quot;;

echo &quot;&lt;p&gt;&quot;;

$query = &quot;SELECT * FROM spip_rubriques WHERE id_parent = 0 ORDER BY titre&quot;;
$result = spip_query($query);

while ($row = mysql_fetch_array($result)) {
	$id_rubrique = $row['id_rubrique'];
	$titre = propre($row['titre']);
	
	$query_rub = &quot;
SELECT versions.*, articles.statut, articles.titre
FROM spip_versions AS versions, spip_articles AS articles 
WHERE versions.id_article = articles.id_article AND versions.id_version &gt; 1 AND articles.id_secteur=$id_rubrique$req_where LIMIT 0,1&quot;;
	$result_rub = spip_query($query_rub);
	
	if ($id_rubrique == $id_secteur)  echo &quot;&lt;li&gt;&lt;b&gt;$titre&lt;/b&gt;&quot;;
	else if (spip_num_rows($result_rub) &gt; 0) echo &quot;&lt;li&gt;&lt;a href='suivi_revisions.php3?id_secteur=$id_rubrique'&gt;$titre&lt;/a&gt;&quot;;
}

if ((lire_meta('multi_rubriques') == 'oui') OR (lire_meta('multi_articles') == 'oui')) {
	echo &quot;&lt;p&gt;&quot;;
	$langues = explode(',', lire_meta('langues_multilingue'));
	
	foreach ($langues as $lang) {
		$titre = traduire_nom_langue($lang);
	
		$query_lang = &quot;
SELECT versions.*
FROM spip_versions AS versions, spip_articles AS articles 
WHERE versions.id_article = articles.id_article AND versions.id_version &gt; 1 AND articles.lang='$lang' $req_where LIMIT 0,1&quot;;
		$result_lang = spip_query($query_lang);
		
		if ($lang == $lang_choisie)  echo &quot;&lt;li&gt;&lt;b&gt;$titre&lt;/b&gt;&quot;;
		else if (spip_num_rows($result_lang) &gt; 0) echo &quot;&lt;li&gt;&lt;a href='suivi_revisions.php3?lang_choisie=$lang'&gt;$titre&lt;/a&gt;&quot;;
	}
}


echo &quot;&lt;/ul&gt;&lt;/div&gt;&quot;;


//////////////////////////////////////////////////////
// Affichage de la colonne de droite
//


debut_droite();

afficher_suivi_versions ($debut, $id_secteur, $uniq_auteur, $lang_choisie);

fin_page();

?&gt;

--- NEW FILE: inc_db_mysql.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_DB_MYSQL&quot;)) return;
define(&quot;_ECRIRE_INC_DB_MYSQL&quot;, &quot;1&quot;);

//
// Appel de requetes SQL
//

function spip_query_db($query) {
	global $spip_mysql_link;
	static $tt = 0;
	$my_admin = (($GLOBALS['connect_statut'] == '0minirezo') OR ($GLOBALS['auteur_session']['statut'] == '0minirezo'));
	$my_profile = ($GLOBALS['mysql_profile'] AND $my_admin);
	$my_debug = ($GLOBALS['mysql_debug'] AND $my_admin);

	$query = traite_query($query);

	if ($my_profile)
		$m1 = microtime();

	if ($GLOBALS['mysql_rappel_connexion'] AND $spip_mysql_link) $result = mysql_query($query, $spip_mysql_link);
	else $result = mysql_query($query);

	if ($my_profile) {
		$m2 = microtime();
		list($usec, $sec) = explode(&quot; &quot;, $m1);
		list($usec2, $sec2) = explode(&quot; &quot;, $m2);
		$dt = $sec2 + $usec2 - $sec - $usec;
		$tt += $dt;
		echo &quot;&lt;small&gt;&quot;.htmlentities($query);
		echo &quot; -&gt; &lt;font color='blue'&gt;&quot;.sprintf(&quot;%3f&quot;, $dt).&quot;&lt;/font&gt; ($tt)&lt;/small&gt;&lt;p&gt;\n&quot;;

	}

	if ($s = mysql_error()) {
		if ($my_debug) {
			echo _T('info_erreur_requete').&quot; &quot;.htmlentities($query).&quot;&lt;br&gt;&quot;;
			echo &quot;&laquo; &quot;.htmlentities($s).&quot; &raquo;&lt;p&gt;&quot;;
		}
		spip_log($GLOBALS['REQUEST_METHOD'].' '.$GLOBALS['REQUEST_URI'], 'mysql');
		spip_log(&quot;$s - $query&quot;, 'mysql');
	}

	# spip_log(&quot;$s - $query&quot;, 'mysql');

	return $result;
}

// fonction appelant la precedente 
// specifiquement pour les select des squelettes
// c'est une instance de spip_abstract_select, voir ses specs dans inc_calcul
// a noter qu'on pourrait y r&#233;aliser traite_query &#224; moindre cout
// les \n et \t sont utiles au debusqueur

function spip_mysql_select($select, $from, $where,
			   $groupby, $orderby, $limit,
			   $sousrequete, $cpt,
			   $table, $id, $serveur) {

	$DB = 'spip_';
	$q = &quot;\nFROM $DB&quot; . join(&quot;,\n\t$DB&quot;, $from)
	. ($where ? &quot;\nWHERE &quot; . join(&quot;\n\tAND &quot;, $where) : '')
	. ($groupby ? &quot;\nGROUP BY $groupby&quot; : '')
	. ($orderby ? &quot;\nORDER BY $orderby&quot; : '')
	. ($limit ? &quot;\nLIMIT $limit&quot; : '');

	if (!$sousrequete)
		$q = &quot; SELECT &quot;. join(&quot;, &quot;, $select) . $q;
	else
		$q = &quot; SELECT S_&quot; . join(&quot;, S_&quot;, $select)
		. &quot; FROM (&quot; . join(&quot;, &quot;, $select)
		. &quot;, COUNT(&quot;.$sousrequete.&quot;) AS compteur &quot; . $q
		.&quot;) AS S_$table WHERE compteur=&quot; . $cpt;

	// Erreur ? C'est du debug de squelette, ou une erreur du serveur

	if ($GLOBALS['var_mode'] == 'debug') {
	  boucle_debug_resultat($id, '', $q);
	}

	if (!($res = @spip_query($q))) {
		include_ecrire('inc_debug_sql.php3');
		echo erreur_requete_boucle($q, $id, $table);
	}

#	 spip_log($serveur . spip_num_rows($res) . $q);
	return $res;
}

//
// Passage d'une requete standardisee
//
function traite_query($query) {
	if ($GLOBALS['table_prefix']) $table_pref = $GLOBALS['table_prefix'].&quot;_&quot;;
	else $table_pref = &quot;&quot;;

	if ($GLOBALS['mysql_rappel_connexion'] AND $db = $GLOBALS['spip_mysql_db'])
		$db = '`'.$db.'`.';

	// changer les noms des tables ($table_prefix)
	if ($GLOBALS['flag_pcre']) {
		if (preg_match('/\s(VALUES|WHERE)\s/i', $query, $regs)) {
			$suite = strstr($query, $regs[0]);
			$query = substr($query, 0, -strlen($suite));
		}
		$query = preg_replace('/([,\s])spip_/', '\1'.$db.$table_pref, $query) . $suite;
	}
	else {
		if (eregi('[[:space:]](VALUES|WHERE)[[:space:]]', $query, $regs)) {
			$suite = strstr($query, $regs[0]);
			$query = substr($query, 0, -strlen($suite));
		}
		$query = ereg_replace('([[:space:],])spip_', '\1'.$db.$table_pref, $query) . $suite;
	}

	return $query;
}


//
// Connexion a la base
//

function spip_connect_db($host, $port, $login, $pass, $db) {
	global $spip_mysql_link, $spip_mysql_db;	// pour connexions multiples

	if ($port &gt; 0) $host = &quot;$host:$port&quot;;
	$spip_mysql_link = @mysql_connect($host, $login, $pass);
	$spip_mysql_db = $db;
	return @mysql_select_db($db);
}


//
// Recuperation des resultats
//

function spip_fetch_array($r) {
	if ($r)
		return mysql_fetch_array($r);
}

/* Appels obsoletes
function spip_fetch_object($r) {
	if ($r)
		return mysql_fetch_object($r);
}

function spip_fetch_row($r) {
	if ($r)
		return mysql_fetch_row($r);
}
*/

function spip_sql_error() {
	return mysql_error();
}

function spip_sql_errno() {
	return mysql_errno();
}

function spip_num_rows($r) {
	if ($r)
		return mysql_num_rows($r);
}

function spip_free_result($r) {
	if ($r)
		return mysql_free_result($r);
}

function spip_insert($table, $champs, $valeurs) {
	spip_query(&quot;INSERT INTO spip_$table $champs VALUES $valeurs&quot;);
	return  mysql_insert_id();
}

function spip_insert_id() {
	return mysql_insert_id();
}

//
// Poser un verrou local a un SPIP donne
//
function spip_get_lock($nom, $timeout = 0) {
	global $spip_mysql_db, $table_prefix;
	if ($table_prefix) $nom = &quot;$table_prefix:$nom&quot;;
	if ($spip_mysql_db) $nom = &quot;$spip_mysql_db:$nom&quot;;

	$nom = addslashes($nom);
	$q = spip_query(&quot;SELECT GET_LOCK('$nom', $timeout)&quot;);
	list($lock_ok) = spip_fetch_array($q);

	if (!$lock_ok) spip_log(&quot;pas de lock sql pour $nom&quot;);
	return $lock_ok;
}

function spip_release_lock($nom) {
	global $spip_mysql_db, $table_prefix;
	if ($table_prefix) $nom = &quot;$table_prefix:$nom&quot;;
	if ($spip_mysql_db) $nom = &quot;$spip_mysql_db:$nom&quot;;

	$nom = addslashes($nom);
	spip_query(&quot;SELECT RELEASE_LOCK('$nom')&quot;);
}


//
// IN (...) est limite a 255 elements, d'ou cette fonction assistante
//
function calcul_mysql_in($val, $valeurs, $not='') {
	if (!$valeurs) return '0=0';
	$s = split(',', $valeurs, 255);
	if (count($s) &lt; 255) {
		return (&quot;($val $not IN ($valeurs))&quot;);
	} else {
		$valeurs = array_pop($s);
		return (&quot;($val $not IN (&quot; . join(',',$s) . &quot;))\n&quot; .
			($not ? &quot;AND\t&quot; : &quot;OR\t&quot;) .
			calcul_mysql_in($val, $valeurs, $not));
    }
}

?&gt;

--- NEW FILE: mots_edit.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_logos.php3&quot;);
include_ecrire (&quot;inc_sites.php3&quot;);
include_ecrire (&quot;inc_abstract_sql.php3&quot;);

function mySel($varaut, $variable) {
	$retour = &quot; VALUE=\&quot;$varaut\&quot;&quot;;

	if ($variable==$varaut){
		$retour.= &quot; SELECTED&quot;;
	}
	return $retour;
}


//
// modifications mot
//
if ($connect_statut == '0minirezo') {
	if ($supp_mot) {
		$query = &quot;DELETE FROM spip_mots WHERE id_mot=$supp_mot&quot;;
		$result = spip_query($query);
		$query = &quot;DELETE FROM spip_mots_articles WHERE id_mot=$supp_mot&quot;;
		$result = spip_query($query);
	}

	if ($titre_mot) {
		if ($new == 'oui' &amp;&amp; $id_groupe) {
		  $id_mot = spip_abstract_insert(&quot;mots&quot;, '(id_groupe)', &quot;($id_groupe)&quot;);


			// ajouter le mot a l'article
			if (settype($ajouter_id_article, 'integer') AND ($ajouter_id_article&gt;0))
				spip_query(&quot;INSERT INTO spip_mots_articles (id_mot, id_article) VALUES ($id_mot, $ajouter_id_article)&quot;);
		}

		$titre_mot = addslashes($titre_mot);
		$texte = addslashes($texte);
		$descriptif = addslashes($descriptif);
		$type = addslashes(corriger_caracteres($type));
		$result = spip_query(&quot;SELECT * FROM spip_groupes_mots WHERE id_groupe='$id_groupe'&quot;);
		if ($row = spip_fetch_array($result))
			$type = addslashes(corriger_caracteres($row['titre']));

		// recoller les champs du extra
		if ($champs_extra) {
			include_ecrire(&quot;inc_extra.php3&quot;);
			$add_extra = &quot;, extra = '&quot;.addslashes(extra_recup_saisie(&quot;mots&quot;)).&quot;'&quot;;
		} else
			$add_extra = '';

		$query = &quot;UPDATE spip_mots SET titre='$titre_mot', texte='$texte', descriptif='$descriptif', type='$type', id_groupe=$id_groupe $add_extra WHERE id_mot=$id_mot&quot;;
		$result = spip_query($query);

		if (lire_meta('activer_moteur') == 'oui') {
			include_ecrire (&quot;inc_index.php3&quot;);
			indexer_mot($id_mot);
		}
	}
	else if ($new == 'oui') {
		if (!$titre_mot = $titre) {
			$titre_mot = filtrer_entites(_T('texte_nouveau_mot'));
			$onfocus = &quot; onfocus=\&quot;if(!antifocus){this.value='';antifocus=true;}\&quot;&quot;;
		}
	}
}

//
// redirection ou affichage
//
if ($redirect_ok == 'oui' &amp;&amp; $redirect) {
	redirige_par_entete(rawurldecode($redirect));
}

//
// Recupere les donnees
//
$query = &quot;SELECT * FROM spip_mots WHERE id_mot='$id_mot'&quot;;
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$id_mot = $row['id_mot'];
	$titre_mot = $row['titre'];
	$descriptif = $row['descriptif'];
	$texte = $row['texte'];
	$type = $row['type'];
	$extra = $row['extra'];
	$id_groupe = $row['id_groupe'];
}

debut_page(&quot;&laquo; $titre_mot &raquo;&quot;, &quot;documents&quot;, &quot;mots&quot;);
debut_gauche();


//////////////////////////////////////////////////////
// Boite &quot;voir en ligne&quot;
//

if ($id_mot) {
	debut_boite_info();
	echo &quot;&lt;CENTER&gt;&quot;;
	echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=1&gt;&lt;B&gt;&quot;._T('titre_gauche_mots_edit').&quot;&lt;/B&gt;&lt;/FONT&gt;&quot;;
	echo &quot;&lt;BR&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=6&gt;&lt;B&gt;$id_mot&lt;/B&gt;&lt;/FONT&gt;&quot;;
	echo &quot;&lt;/CENTER&gt;&quot;;

	voir_en_ligne ('mot', $id_mot);

	fin_boite_info();
}

echo &quot;&lt;p&gt;&lt;center&gt;&quot;;
if ($new == 'oui') {
	$adresse_retour = &quot;mots_edit.php3?redirect=$redirect&amp;redirect_ok=oui&amp;supp_mot=$id_mot&quot;;
}else {
	$adresse_retour = &quot;mots_edit.php3?redirect=$redirect&amp;redirect_ok=oui&quot;;
}
echo &quot;&lt;/center&gt;&quot;;

//////////////////////////////////////////////////////
// Logos du mot-clef
//

$arton = &quot;moton$id_mot&quot;;
$artoff = &quot;motoff$id_mot&quot;;

if ($id_mot &gt; 0 AND $connect_statut == '0minirezo')
	afficher_boite_logo($arton, $artoff, _T('logo_mot_cle').aide(&quot;breveslogo&quot;), _T('logo_survol'));


//
// Afficher les boutons de creation d'article et de breve
//
debut_raccourcis();

icone_horizontale(_T('icone_voir_tous_mots_cles'), &quot;mots_tous.php3&quot;, &quot;mot-cle-24.gif&quot;, &quot;rien.gif&quot;);

if ($connect_statut == '0minirezo')
		icone_horizontale(_T('icone_creation_mots_cles'), &quot;mots_edit.php3?new=oui&amp;redirect=mots_tous.php3&amp;id_groupe=$id_groupe&quot;, &quot;mot-cle-24.gif&quot;, &quot;creer.gif&quot;);

fin_raccourcis();


debut_droite();

debut_cadre_relief(&quot;mot-cle-24.gif&quot;);


echo &quot;\n&lt;table cellpadding=0 cellspacing=0 border=0 width='100%'&gt;&quot;;
echo &quot;&lt;tr width='100%'&gt;&quot;;
echo &quot;&lt;td width='100%' valign='top'&gt;&quot;;
gros_titre($titre_mot);


if ($descriptif) {
	echo &quot;&lt;p&gt;&lt;div align='left' border: 1px dashed #aaaaaa;'&gt;&quot;;
	echo &quot;&lt;font size=2 face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
	echo &quot;&lt;b&gt;&quot;._T('info_descriptif').&quot;&lt;/b&gt; &quot;;
	echo propre($descriptif);
	echo &quot;&nbsp; &quot;;
	echo &quot;&lt;/font&gt;&quot;;
	echo &quot;&lt;/div&gt;&quot;;
}
echo &quot;&lt;/td&gt;&quot;;
echo &quot;&lt;/tr&gt;&lt;/table&gt;\n&quot;;


if (strlen($texte)&gt;0){
	echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
	echo &quot;&lt;P&gt;&quot;.propre($texte);
	echo &quot;&lt;/FONT&gt;&quot;;
}



if ($id_mot) {
	echo &quot;&lt;P&gt;&quot;;

	if ($connect_statut == &quot;0minirezo&quot;)
		$aff_articles = &quot;'prepa','prop','publie','refuse'&quot;;
	else
		$aff_articles = &quot;'prop','publie'&quot;;

	afficher_rubriques(_T('info_rubriques_liees_mot'),
	&quot;SELECT rubrique.* FROM spip_rubriques AS rubrique, spip_mots_rubriques AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_rubrique=rubrique.id_rubrique ORDER BY rubrique.titre&quot;);

	afficher_articles(_T('info_articles_lies_mot'),
	&quot;, spip_mots_articles AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_article=articles.id_article AND articles.statut IN ($aff_articles) ORDER BY articles.date DESC&quot;, true);

	afficher_breves(_T('info_breves_liees_mot'),
	&quot;SELECT breves.* FROM spip_breves AS breves, spip_mots_breves AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_breve=breves.id_breve ORDER BY breves.date_heure DESC LIMIT 0,10&quot;);

	afficher_sites(_T('info_sites_lies_mot'),
	&quot;SELECT syndic.* FROM spip_syndic AS syndic, spip_mots_syndic AS lien WHERE lien.id_mot='$id_mot'
	AND lien.id_syndic=syndic.id_syndic ORDER BY syndic.nom_site DESC LIMIT 0,10&quot;);
}

fin_cadre_relief();



if ($connect_statut ==&quot;0minirezo&quot;){
	echo &quot;&lt;P&gt;&quot;;
	debut_cadre_formulaire();

	echo &quot;&lt;FORM ACTION='mots_edit.php3' METHOD='post'&gt;&quot;;
	echo &quot;&lt;div class='serif'&gt;&quot;;
	
	if ($id_mot)
		echo &quot;&lt;INPUT TYPE='Hidden' NAME='id_mot' VALUE='$id_mot'&gt;\n&quot;;
	else if ($new=='oui')
		echo &quot;&lt;INPUT TYPE='Hidden' NAME='new' VALUE='oui'&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='Hidden' NAME='redirect' VALUE=\&quot;$redirect\&quot;&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='Hidden' NAME='redirect_ok' VALUE='oui'&gt;\n&quot;;
	echo &quot;&lt;INPUT TYPE='Hidden' NAME='ajouter_id_article' VALUE=\&quot;$ajouter_id_article\&quot;&gt;\n&quot;;

	$titre_mot = entites_html($titre_mot);
	$descriptif = entites_html($descriptif);
	$texte = entites_html($texte);

	echo &quot;&lt;B&gt;&quot;._T('info_titre_mot_cle').&quot;&lt;/B&gt; &quot;._T('info_obligatoire_02');
	echo aide (&quot;mots&quot;);

	echo &quot;&lt;BR&gt;&lt;INPUT TYPE='text' NAME='titre_mot' CLASS='formo' VALUE=\&quot;$titre_mot\&quot; SIZE='40' $onfocus&gt;&quot;;

	// dans le groupe...
	$query_groupes = &quot;SELECT * FROM spip_groupes_mots ORDER BY titre&quot;;
	$result = spip_query($query_groupes);
	if (spip_num_rows($result)&gt;1) {
		debut_cadre_relief(&quot;groupe-mot-24.gif&quot;);
		echo  _T('info_dans_groupe').&quot;&lt;/label&gt;\n&quot;;
		echo aide (&quot;motsgroupes&quot;);
		echo  &quot; &nbsp; &lt;SELECT NAME='id_groupe' class='fondl'&gt;\n&quot;;
		while ($row_groupes = spip_fetch_array($result)){
			$groupe = $row_groupes['id_groupe'];
			$titre_groupe = texte_backend(supprimer_tags(typo($row_groupes['titre'])));
			echo  &quot;&lt;OPTION&quot;.mySel($groupe, $id_groupe).&quot;&gt;$titre_groupe&lt;/OPTION&gt;\n&quot;;
		}			
		echo  &quot;&lt;/SELECT&gt;&quot;;
		fin_cadre_relief();
	} else {
		$row_groupes = spip_fetch_array($result);
		if (!$row_groupes) {
			// il faut creer un groupe de mots (cas d'un mot cree depuis articles.php3)
		  $row_groupes['id_groupe'] = spip_abstract_insert(&quot;groupes_mots&quot;,
							  &quot;(titre, unseul, obligatoire, articles, breves, rubriques, syndic, 0minirezo, 1comite, 6forum)&quot;,
							  &quot;('&quot; .
							  addslashes(_T('info_mot_sans_groupe')).&quot;', 'non',  'non', 'oui', 'oui', 'non', 'oui', 'oui', 'non', 'non'&quot;);

		}
		echo &quot;&lt;input type='hidden' name='id_groupe' value='&quot;.$row_groupes['id_groupe'].&quot;'&gt;&quot;;
	}

	if ($options == 'avancees' OR $descriptif) {
		echo &quot;&lt;B&gt;&quot;._T('texte_descriptif_rapide').&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
		echo &quot;&lt;TEXTAREA NAME='descriptif' CLASS='forml' ROWS='4' COLS='40' wrap=soft&gt;&quot;;
		echo $descriptif;
		echo &quot;&lt;/TEXTAREA&gt;&lt;P&gt;\n&quot;;
	}
	else
		echo &quot;&lt;INPUT TYPE='hidden' NAME='descriptif' VALUE=\&quot;$descriptif\&quot;&gt;&quot;;

	if ($options == 'avancees' OR $texte) {
		echo &quot;&lt;B&gt;&quot;._T('info_texte_explicatif').&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
		echo &quot;&lt;TEXTAREA NAME='texte' ROWS='8' CLASS='forml' COLS='40' wrap=soft&gt;&quot;;
		echo $texte;
		echo &quot;&lt;/TEXTAREA&gt;&lt;P&gt;\n&quot;;
	}
	else
		echo &quot;&lt;INPUT TYPE='hidden' NAME='texte' VALUE=\&quot;$texte\&quot;&gt;&quot;;

	if ($champs_extra) {
		include_ecrire(&quot;inc_extra.php3&quot;);
		extra_saisie($extra, 'mots', $id_groupe);
	}

	echo &quot;&lt;DIV align='right'&gt;&lt;INPUT TYPE='submit' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;' CLASS='fondo'&gt;&lt;/div&gt;&quot;;
	
	echo &quot;&lt;/div&gt;&quot;;
	echo &quot;&lt;/FORM&gt;&quot;;

	fin_cadre_formulaire();
}


fin_page();

?&gt;

--- NEW FILE: pclzip.lib.php ---
&lt;?php

// --------------------------------------------------------------------------------

// PhpConcept Library - Zip Module 2.1

// --------------------------------------------------------------------------------

// License GNU/LGPL - Vincent Blavet - December 2003

// <A HREF="http://www.phpconcept.net">http://www.phpconcept.net</A>

// --------------------------------------------------------------------------------

//

// Presentation :

//   PclZip is a PHP library that manage ZIP archives.
[...9900 lines suppressed...]

      // ----- Change potential windows directory separator

      if ((strpos($p_path, '\\') &gt; 0) || (substr($p_path, 0,1) == '\\')) {

          $p_path = strtr($p_path, '\\', '/');

      }

    }

    return $p_path;

  }

  // --------------------------------------------------------------------------------



?&gt;

--- NEW FILE: spip_style_invisible.css ---
.invisible_au_chargement {
	visibility: hidden;
}
.visible_au_chargement {
	visibility: hidden;
}
.display_au_chargement {
	display: none;
}
--- NEW FILE: auteur_infos.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_acces.php3&quot;);
include_ecrire (&quot;inc_logos.php3&quot;);
include_ecrire (&quot;inc_session.php3&quot;);
include_ecrire (&quot;inc_filtres.php3&quot;);
include_ecrire (&quot;inc_abstract_sql.php3&quot;);

// securite
$id_auteur = floor($id_auteur);

// menu statuts
function mySel($varaut,$variable) {
	$retour = &quot; VALUE=\&quot;$varaut\&quot;&quot;;
	if ($variable==$varaut){
		$retour.= &quot; SELECTED&quot;;
	}
	return $retour;
}

//
// Auteurs a acces restreint
//
function afficher_auteur_rubriques($leparent){
	global $id_parent;
	global $id_rubrique;
	global $toutes_rubriques;
	global $i;
	
	$i++;
 	$query=&quot;SELECT * FROM spip_rubriques WHERE id_parent=$leparent ORDER BY titre&quot;;
 	$result=spip_query($query);

	while($row=spip_fetch_array($result)){
		$my_rubrique=$row['id_rubrique'];
		$titre=typo($row['titre']);
	
		if (!ereg(&quot;,$my_rubrique,&quot;,&quot;$toutes_rubriques&quot;)){
			$espace = str_repeat(&quot;&amp;nbsp&quot;, $i*2) . &quot;|&quot;;
			if ($i==1)
				$espace = &quot;*&quot;;

			echo &quot;&lt;OPTION VALUE='$my_rubrique'&gt;$espace &quot;.supprimer_tags($titre).&quot;\n&quot;;
			afficher_auteur_rubriques($my_rubrique);
		}
	}
	$i=$i-1;
}

// modif auteur restreint
if ($connect_toutes_rubriques AND $add_rub=floor($add_rub)){
	$query = &quot;INSERT INTO spip_auteurs_rubriques (id_auteur,id_rubrique) VALUES($id_auteur,$add_rub)&quot;;
	$result = spip_query($query);
}
if ($connect_toutes_rubriques AND $supp_rub=floor($supp_rub)){
	$query = &quot;DELETE FROM spip_auteurs_rubriques WHERE id_auteur=$id_auteur AND id_rubrique=$supp_rub&quot;;
	$result = spip_query($query);
}

// securite
if ($connect_statut != &quot;0minirezo&quot; AND $connect_id_auteur != $id_auteur) {
	gros_titre(_T('info_acces_interdit'));
	exit;
}

//
// Recuperer l'auteur (id_auteur) ... ou l'inventer
//
unset($auteur);

if ($id_auteur) {
	$auteur = spip_fetch_array(spip_query(&quot;SELECT * FROM spip_auteurs WHERE id_auteur=$id_auteur&quot;));
	$new = false;	// eviter hack
} else {
	if (!$auteur['nom'] = $titre) {
		$auteur['nom'] = filtrer_entites(_T('item_nouvel_auteur'));
		$onfocus = &quot; onfocus=\&quot;if(!antifocus){this.value='';antifocus=true;}\&quot;&quot;;
	}
	$auteur['statut'] = '1comite';
	$auteur['source'] = 'spip';
}


//
// Modification (et creation si besoin)
//
if ($statut) { // si on poste un statut, c'est qu'on modifie une fiche auteur
	if ($connect_statut == '0minirezo' AND ereg(&quot;^(0minirezo|1comite|5poubelle|6forum)$&quot;,$statut))	// changer le statut
		$auteur['statut'] = $statut;

	if ($nom)	// pas de nom vide
		$auteur['nom'] = corriger_caracteres($nom);

	// login et mot de passe
	unset ($modif_login);
	$old_login = $auteur['login'];
	if (($new_login&lt;&gt;$old_login) AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques AND $auteur['source'] == 'spip') {
		if ($new_login) {
			if (strlen($new_login) &lt; 4)
				$echec .= &quot;&lt;p&gt;&quot;._T('info_login_trop_court');
			else if (spip_num_rows(spip_query(&quot;SELECT * FROM spip_auteurs WHERE login='&quot;.addslashes($new_login).&quot;' AND id_auteur!=$id_auteur AND statut!='5poubelle'&quot;)))
				$echec .= &quot;&lt;p&gt;&quot;._T('info_login_existant');
			else if ($new_login != $old_login) {
				$modif_login = true;
				$auteur['login'] = $new_login;
			}
		}
		// suppression du login
		else {
			$auteur['login'] = '';
			$modif_login = true;
		}
	}

	// changement de pass, a securiser en jaja ?
	if ($new_pass AND ($statut != '5poubelle') AND $auteur['login'] AND $auteur['source'] == 'spip') {
		if ($new_pass != $new_pass2)
			$echec .= &quot;&lt;p&gt;&quot;._T('info_passes_identiques');
		else if ($new_pass AND strlen($new_pass) &lt; 6)
			$echec .= &quot;&lt;p&gt;&quot;._T('info_passe_trop_court');
		else {
			$modif_login = true;
			$auteur['new_pass'] = $new_pass;
		}
	}

	if ($modif_login) {
		include_ecrire('inc_session.php3');
		zap_sessions ($auteur['id_auteur'], true);
		if ($connect_id_auteur == $auteur['id_auteur'])
			supprimer_session($GLOBALS['spip_session']);
	}

	// email
	// seuls les admins peuvent modifier l'email
	// les admins restreints peuvent modifier l'email des redacteurs
	// mais pas des autres admins
	if ($connect_statut == '0minirezo'
	AND ($connect_toutes_rubriques OR $statut&lt;&gt;'0minirezo')) { 
		if ($email !='' AND !email_valide($email)) {
			$echec .= &quot;&lt;p&gt;&quot;._T('info_email_invalide');
			$auteur['email'] = $email;
		} else
			$auteur['email'] = $email;
	}

	if ($connect_id_auteur == $id_auteur) {
		if ($perso_activer_imessage) {
			$query = &quot;UPDATE spip_auteurs SET imessage='$perso_activer_imessage' WHERE id_auteur=$id_auteur&quot;;
			$result = spip_query($query);
			$auteur['imessage'] = $perso_activer_imessage;
		}
	}



	// variables sans probleme
	$auteur['bio'] = corriger_caracteres($bio);
	$auteur['pgp'] = corriger_caracteres($pgp);
	$auteur['nom_site'] = corriger_caracteres($nom_site_auteur); // attention mix avec $nom_site_spip ;(
	$auteur['url_site'] = vider_url($url_site);

	if ($new_pass) {
		$htpass = generer_htpass($new_pass);
		$alea_actuel = creer_uniqid();
		$alea_futur = creer_uniqid();
		$pass = md5($alea_actuel.$new_pass);
		$query_pass = &quot; pass='$pass', htpass='$htpass', alea_actuel='$alea_actuel', alea_futur='$alea_futur', &quot;;
		effacer_low_sec($auteur['id_auteur']);
	} else
		$query_pass = '';

	// recoller les champs du extra
	if ($champs_extra) {
		include_ecrire(&quot;inc_extra.php3&quot;);
		$extra = extra_recup_saisie(&quot;auteurs&quot;);
		$add_extra = &quot;, extra = '&quot;.addslashes($extra).&quot;'&quot;;
	} else
		$add_extra = '';

	// l'entrer dans la base
	if (!$echec) {
		if (!$auteur['id_auteur']) { // creation si pas d'id
		  $auteur['id_auteur'] = spip_abstract_insert(&quot;auteurs&quot;, &quot;(nom)&quot;, &quot;('temp')&quot;);

			$id_auteur = $auteur['id_auteur'];

			if (settype($ajouter_id_article,'integer') AND ($ajouter_id_article&gt;0))
				spip_query(&quot;INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES ($id_auteur, $ajouter_id_article)&quot;);
		}

		$query = &quot;UPDATE spip_auteurs SET $query_pass
			nom='&quot;.addslashes($auteur['nom']).&quot;',
			login='&quot;.addslashes($auteur['login']).&quot;',
			bio='&quot;.addslashes($auteur['bio']).&quot;',
			email='&quot;.addslashes($auteur['email']).&quot;',
			nom_site='&quot;.addslashes($auteur['nom_site']).&quot;',
			url_site='&quot;.addslashes($auteur['url_site']).&quot;',
			pgp='&quot;.addslashes($auteur['pgp']).&quot;',
			statut='&quot;.addslashes($auteur['statut']).&quot;'
			$add_extra
			WHERE id_auteur=&quot;.$auteur['id_auteur'];
		spip_query($query) OR die($query);
	}

	if (lire_meta('activer_moteur') == 'oui') {
		include_ecrire (&quot;inc_index.php3&quot;);
		indexer_auteur($id_auteur);
	}


	// Mettre a jour les fichiers .htpasswd et .htpasswd-admin
	ecrire_acces();
}

// Redirection
if (!$echec AND $redirect_ok == &quot;oui&quot;) {
	redirige_par_entete($redirect ? rawurldecode($redirect) : &quot;auteurs_edit.php3?id_auteur=$id_auteur&quot;);
}


//
// Affichage
//

if ($connect_id_auteur == $id_auteur)
	debut_page($auteur['nom'], &quot;auteurs&quot;, &quot;perso&quot;);
else
	debut_page($auteur['nom'],&quot;auteurs&quot;,&quot;redacteurs&quot;);

echo &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;

debut_gauche();

if ($id_auteur) {
	debut_boite_info();
	echo &quot;&lt;CENTER&gt;&quot;;
	echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=1&gt;&lt;B&gt;&quot;._T('titre_cadre_numero_auteur').&quot;&nbsp;:&lt;/B&gt;&lt;/FONT&gt;&quot;;
	echo &quot;&lt;BR&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=6&gt;&lt;B&gt;$id_auteur&lt;/B&gt;&lt;/FONT&gt;&quot;;
	echo &quot;&lt;/CENTER&gt;&quot;;
	fin_boite_info();
}

debut_droite();


//
// Formulaire d'edition de l'auteur
//

if ($echec){
	debut_cadre_relief();
	echo http_img_pack(&quot;warning.gif&quot;, _T('info_avertissement'), &quot;width='48' height='48' align='left'&quot;);
	echo &quot;&lt;font color='red'&gt;$echec &lt;p&gt;&quot;._T('info_recommencer').&quot;&lt;/font&gt;&quot;;
	fin_cadre_relief();
	echo &quot;&lt;p&gt;&quot;;
}


debut_cadre_formulaire();
echo &quot;&lt;FORM ACTION='auteur_infos.php3?id_auteur=$id_auteur' METHOD='post'&gt;&quot;;
echo &quot;&lt;INPUT TYPE='Hidden' NAME='id_auteur' VALUE=\&quot;$id_auteur\&quot;&gt;&quot;;


//
// Infos personnelles
//

echo &quot;&lt;div class='serif'&gt;&quot;;

debut_cadre_relief(&quot;fiche-perso-24.gif&quot;, false, &quot;&quot;, _T(&quot;icone_informations_personnelles&quot;));

echo _T('titre_cadre_signature_obligatoire');
echo &quot;(&quot;._T('entree_nom_pseudo').&quot;)&lt;BR&gt;&quot;;
echo &quot;&lt;INPUT TYPE='text' NAME='nom' CLASS='formo' VALUE=\&quot;&quot;.entites_html($auteur['nom']).&quot;\&quot; SIZE='40' $onfocus&gt;&lt;P&gt;&quot;;

echo &quot;&lt;B&gt;&quot;._T('entree_adresse_email').&quot;&lt;/B&gt;&quot;;

if ($connect_statut == &quot;0minirezo&quot;
AND ($connect_toutes_rubriques OR $auteur['statut']&lt;&gt;'0minirezo')) {
	echo &quot;&lt;br&gt;&lt;INPUT TYPE='text' NAME='email' CLASS='formo' VALUE=\&quot;&quot;.entites_html($auteur['email']).&quot;\&quot; SIZE='40'&gt;&lt;P&gt;\n&quot;;
}
else {
	echo &quot;&nbsp;: &lt;tt&gt;&quot;.$auteur['email'].&quot;&lt;/tt&gt;&quot;;
	echo &quot;&lt;br&gt;(&quot;._T('info_reserve_admin').&quot;)\n&quot;;
	echo &quot;&lt;P&gt;&quot;;
}

echo &quot;&lt;B&gt;&quot;._T('entree_infos_perso').&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
echo &quot;(&quot;._T('entree_biographie').&quot;)&lt;BR&gt;&quot;;
echo &quot;&lt;TEXTAREA NAME='bio' CLASS='forml' ROWS='4' COLS='40' wrap=soft&gt;&quot;;
echo entites_html($auteur['bio']);
echo &quot;&lt;/TEXTAREA&gt;\n&quot;;

debut_cadre_enfonce(&quot;site-24.gif&quot;, false, &quot;&quot;, _T('info_site_web'));
echo &quot;&lt;B&gt;&quot;._T('entree_nom_site').&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
echo &quot;&lt;INPUT TYPE='text' NAME='nom_site_auteur' CLASS='forml' VALUE=\&quot;&quot;.entites_html($auteur['nom_site']).&quot;\&quot; SIZE='40'&gt;&lt;P&gt;\n&quot;;

echo &quot;&lt;B&gt;&quot;._T('entree_url').&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
echo &quot;&lt;INPUT TYPE='text' NAME='url_site' CLASS='forml' VALUE=\&quot;&quot;.entites_html($auteur['url_site']).&quot;\&quot; SIZE='40'&gt;\n&quot;;
fin_cadre_enfonce();
	echo &quot;&lt;p&gt;&quot;;

if ($options == &quot;avancees&quot;) {
	debut_cadre_enfonce(&quot;cadenas-24.gif&quot;, false, &quot;&quot;, _T('entree_cle_pgp'));
	echo &quot;&lt;TEXTAREA NAME='pgp' CLASS='forml' ROWS='4' COLS='40' wrap=soft&gt;&quot;;
	echo entites_html($auteur['pgp']);
	echo &quot;&lt;/TEXTAREA&gt;\n&quot;;
	fin_cadre_enfonce();
	echo &quot;&lt;p&gt;&quot;;
}
else {
	echo &quot;&lt;input type='hidden' name='pgp' value=\&quot;&quot;.entites_html($auteur['pgp']).&quot;\&quot;&gt;&quot;;
}

echo &quot;&lt;p&gt;&quot;;
	if ($champs_extra) {
		include_ecrire(&quot;inc_extra.php3&quot;);
		extra_saisie($auteur['extra'], 'auteurs', $auteur['statut']);
	}

fin_cadre_relief();
echo &quot;&lt;p&gt;&quot;;



//
// Login et mot de passe :
// accessibles seulement aux admins non restreints et l'auteur lui-meme
//

if ($auteur['source'] != 'spip') {
	$edit_login = false;
	$edit_pass = false;
}
else if (($connect_statut == &quot;0minirezo&quot;) AND $connect_toutes_rubriques) {
	$edit_login = true;
	$edit_pass = true;
}
else if ($connect_id_auteur == $id_auteur) {
	$edit_login = false;
	$edit_pass = true;
}
else {
	$edit_login = false;
	$edit_pass = false;
}

debut_cadre_relief(&quot;base-24.gif&quot;);

// Avertissement en cas de modifs de ses propres donnees
if (($edit_login OR $edit_pass) AND $connect_id_auteur == $id_auteur) {
	debut_cadre_enfonce();
	echo http_img_pack(&quot;warning.gif&quot;, _T('info_avertissement'), &quot;width='48' height='48' align='right'&quot;);
	echo &quot;&lt;b&gt;&quot;._T('texte_login_precaution').&quot;&lt;/b&gt;\n&quot;;
	fin_cadre_enfonce();
	echo &quot;&lt;p&gt;&quot;;
}

// Un redacteur n'a pas le droit de modifier son login !
if ($edit_login) {
	echo &quot;&lt;B&gt;&quot;._T('item_login').&quot;&lt;/B&gt; &quot;;
	echo &quot;&lt;font color='red'&gt;(&quot;._T('texte_plus_trois_car').&quot;)&lt;/font&gt; :&lt;BR&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='text' NAME='new_login' CLASS='formo' VALUE=\&quot;&quot;.entites_html($auteur['login']).&quot;\&quot; SIZE='40'&gt;&lt;P&gt;\n&quot;;
}
else {
	echo &quot;&lt;fieldset style='padding:5'&gt;&lt;legend&gt;&lt;B&gt;&quot;._T('item_login').&quot;&lt;/B&gt;&lt;BR&gt;&lt;/legend&gt;&lt;br&gt;&lt;b&gt;&quot;.$auteur['login'].&quot;&lt;/b&gt; &quot;;
	echo &quot;&lt;i&gt; (&quot;._T('info_non_modifiable').&quot;)&lt;/i&gt;&lt;p&gt;&quot;;
}

// On ne peut modifier le mot de passe en cas de source externe (par exemple LDAP)
if ($edit_pass) {
	echo &quot;&lt;B&gt;&quot;._T('entree_nouveau_passe').&quot;&lt;/B&gt; &quot;;
	echo &quot;&lt;font color='red'&gt;(&quot;._T('info_plus_cinq_car').&quot;)&lt;/font&gt; :&lt;BR&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='password' NAME='new_pass' CLASS='formo' VALUE=\&quot;\&quot; SIZE='40'&gt;&lt;BR&gt;\n&quot;;
	echo _T('info_confirmer_passe').&quot;&lt;BR&gt;&quot;;
	echo &quot;&lt;INPUT TYPE='password' NAME='new_pass2' CLASS='formo' VALUE=\&quot;\&quot; SIZE='40'&gt;&lt;P&gt;\n&quot;;
}
fin_cadre_relief();
echo &quot;&lt;p&gt;&quot;;


//
// Apparaitre dans la liste des redacteurs connectes
//

if ($connect_id_auteur == $id_auteur) {

	debut_cadre_relief(&quot;messagerie-24.gif&quot;, false, &quot;&quot;, _T('info_liste_redacteurs_connectes'));
		
	echo &quot;&lt;div&gt;&quot;._T('texte_auteur_messagerie').&quot;&lt;/div&gt;&quot;;	

		if ($auteur['imessage']==&quot;non&quot;){
			echo &quot;&lt;INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='oui' id='perso_activer_imessage_on'&gt;&quot;;
			echo &quot; &lt;label for='perso_activer_imessage_on'&gt;&quot;._T('bouton_radio_apparaitre_liste_redacteurs_connectes').&quot;&lt;/label&gt; &quot;;
			echo &quot;&lt;BR&gt;&lt;INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='non' CHECKED id='perso_activer_imessage_off'&gt;&quot;;
			echo &quot; &lt;B&gt;&lt;label for='perso_activer_imessage_off'&gt;&quot;._T('bouton_radio_non_apparaitre_liste_redacteurs_connectes').&quot;&lt;/label&gt;&lt;/B&gt; &quot;;
		} else {
			echo &quot;&lt;INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='oui' id='perso_activer_imessage_on' CHECKED&gt;&quot;;
			echo &quot; &lt;B&gt;&lt;label for='perso_activer_imessage_on'&gt;&quot;._T('bouton_radio_apparaitre_liste_redacteurs_connectes').&quot;&lt;/label&gt;&lt;/B&gt; &quot;;

			echo &quot;&lt;BR&gt;&lt;INPUT TYPE='radio' NAME='perso_activer_imessage' VALUE='non' id='perso_activer_imessage_off'&gt;&quot;;
			echo &quot; &lt;label for='perso_activer_imessage_off'&gt;&quot;._T('bouton_radio_non_apparaitre_liste_redacteurs_connectes').&quot;&lt;/label&gt; &quot;;
		}

	fin_cadre_relief();
	echo &quot;&lt;p /&gt;&quot;;

	
}



//
// Seuls les admins voient le menu 'statut', mais les admins restreints ne
// pourront l'utiliser que pour mettre un auteur a la poubelle
//

$statut = $auteur['statut']; // pour aller plus vite

if ($connect_statut == &quot;0minirezo&quot;
	AND ($connect_toutes_rubriques OR $statut != &quot;0minirezo&quot;)
	AND $connect_id_auteur != $id_auteur) {
	debut_cadre_relief();
	echo &quot;&lt;center&gt;&lt;B&gt;&quot;._T('info_statut_auteur').&quot; &lt;/B&gt; &quot;;
	echo &quot; &lt;SELECT NAME='statut' SIZE=1 CLASS='fondl'&gt;&quot;;

	if ($connect_statut == &quot;0minirezo&quot; AND $connect_toutes_rubriques)
		echo &quot;&lt;OPTION&quot;.mySel(&quot;0minirezo&quot;,$statut).&quot;&gt;&quot;._T('item_administrateur_2');

	echo &quot;&lt;OPTION&quot;.mySel(&quot;1comite&quot;,$statut).&quot;&gt;&quot;._T('intem_redacteur');

	if (($statut == '6forum') OR (lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo'))
		echo &quot;&lt;OPTION&quot;.mySel(&quot;6forum&quot;,$statut).&quot;&gt;&quot;._T('item_visiteur');
	echo &quot;&lt;OPTION&quot;.mySel(&quot;5poubelle&quot;,$statut).
	  &quot; style='background:url(&quot; . _DIR_RESTREINT . &quot;rayures-sup.gif)'&gt;&gt; &quot;._T('texte_statut_poubelle');

	echo &quot;&lt;/SELECT&gt;&lt;/center&gt;\n&quot;;
	fin_cadre_relief();
}
else {
	echo &quot;&lt;INPUT TYPE='Hidden' NAME='statut' VALUE=\&quot;$statut\&quot;&gt;&quot;;
}

//
// Gestion restreinte des rubriques
//
if ($statut == '0minirezo') {
	debut_cadre_enfonce(&quot;secteur-24.gif&quot;);

	$query_admin = &quot;SELECT lien.id_rubrique, titre FROM spip_auteurs_rubriques AS lien, spip_rubriques AS rubriques WHERE lien.id_auteur=$id_auteur AND lien.id_rubrique=rubriques.id_rubrique GROUP BY lien.id_rubrique&quot;;
	$result_admin = spip_query($query_admin);

	if (spip_num_rows($result_admin) == 0) {
		echo _T('info_admin_gere_toutes_rubriques');
	} else {
		echo _T('info_admin_gere_rubriques').&quot;\n&quot;;
		echo &quot;&lt;ul style='list-style-image: url(&quot; . _DIR_IMG_PACK . &quot;rubrique-12.gif)'&gt;&quot;;
		while ($row_admin = spip_fetch_array($result_admin)) {
			$id_rubrique = $row_admin[&quot;id_rubrique&quot;];
			$titre = typo($row_admin[&quot;titre&quot;]);
			echo &quot;&lt;li&gt;$titre&quot;;
			if ($connect_toutes_rubriques AND $connect_id_auteur != $id_auteur) {
				echo &quot; &lt;font size=1&gt;[&lt;a href='auteur_infos.php3?id_auteur=$id_auteur&amp;supp_rub=$id_rubrique'&gt;&quot;._T('lien_supprimer_rubrique').&quot;&lt;/a&gt;]&lt;/font&gt;&quot;;
			}
			$toutes_rubriques .= &quot;$id_rubrique,&quot;;
		}
		echo &quot;&lt;/ul&gt;&quot;;
		$toutes_rubriques = &quot;,$toutes_rubriques&quot;;
	}

	if ($connect_toutes_rubriques AND $connect_id_auteur != $id_auteur) {
		if (spip_num_rows($result_admin) == 0) {
			echo &quot;&lt;p&gt;&lt;B&gt;&quot;._T('info_restreindre_rubrique').&quot;&lt;/b&gt;&lt;BR&gt;&quot;;
		} else {
			echo &quot;&lt;p&gt;&lt;B&gt;&quot;._T('info_ajouter_rubrique').&quot;&lt;/b&gt;&lt;BR&gt;&quot;;
		}
		echo &quot;&lt;INPUT NAME='id_auteur' VALUE='$id_auteur' TYPE='hidden'&gt;&quot;;
		echo &quot;&lt;SELECT NAME='add_rub' SIZE=1 CLASS='formo'&gt;&quot;;
		echo &quot;&lt;OPTION VALUE='0'&gt;   \n&quot;;
		afficher_auteur_rubriques(&quot;0&quot;);
		echo &quot;&lt;/SELECT&gt;&quot;;
	}
	fin_cadre_enfonce();
}

echo &quot;&lt;INPUT NAME='ajouter_id_article' VALUE='$ajouter_id_article' TYPE='hidden'&gt;\n&quot;;
echo &quot;&lt;INPUT NAME='redirect' VALUE='$redirect' TYPE='hidden'&gt;\n&quot;;
echo &quot;&lt;INPUT NAME='redirect_ok' VALUE='oui' TYPE='hidden'&gt;\n&quot;;

echo &quot;&lt;DIV align='right'&gt;&lt;INPUT TYPE='submit' CLASS='fondo' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;'&gt;&lt;/DIV&gt;&quot;;

echo &quot;&lt;/div&gt;&quot;;

echo &quot;&lt;/form&gt;&quot;;
fin_cadre_formulaire();
echo &quot;&nbsp;&lt;p&gt;&quot;;

fin_page();

?&gt;

--- NEW FILE: inc_suivi_revisions.php ---
&lt;?php
//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_SUIVI_REVISIONS&quot;)) return;
define(&quot;_ECRIRE_INC_SUIVI_REVISIONS&quot;, &quot;1&quot;);

include_ecrire(&quot;inc_lab.php&quot;);
include_spip(&quot;ecrire.php&quot;);
include_spip(&quot;revisions.php&quot;);
include_spip(&quot;diff.php&quot;);


function afficher_para_modifies ($texte, $court = false) {
	// Limiter la taille de l'affichage
	if ($court) $max = 200;
	else $max = 2000;
	
	$paras = explode (&quot;\n&quot;,$texte);
	for ($i = 0; $i &lt; count($paras) AND strlen($texte_ret) &lt; $max; $i++) {
		if (ereg(&quot;diff-&quot;, $paras[$i])) $texte_ret .= $paras[$i].&quot;\n\n&quot;;
	}
	$texte = $texte_ret;
	return $texte;
}

function afficher_suivi_versions ($debut = 0, $id_secteur = 0, $uniq_auteur = false, $lang = &quot;&quot;, $court = false) {
	global $connect_id_auteur, $connect_statut, $dir_lang;
	
	$nb_aff = 10;
	$champs = array('surtitre', 'titre', 'soustitre', 'descriptif', 'nom_site', 'url_site', 'chapo', 'texte', 'ps');

	if ($uniq_auteur) $req_where = &quot; AND articles.statut IN ('prepa','prop','publie')&quot;; 
	else $req_where = &quot; AND articles.statut IN ('prop','publie')&quot;; 
	
	if ($uniq_auteur) $req_where = &quot; AND versions.id_auteur = $connect_id_auteur&quot;;

	if (strlen($lang) &gt; 0) $req_where .= &quot; AND articles.lang='$lang'&quot;;

	if ($id_secteur &gt; 0) $req_where .= &quot; AND articles.id_secteur = $id_secteur&quot;;

	$query = &quot;
		SELECT versions.*, articles.statut, articles.titre 
		FROM spip_versions AS versions, spip_articles AS articles 
		WHERE versions.id_article = articles.id_article AND versions.id_version &gt; 1 $req_where &quot;;
	
	$result = spip_query($query . &quot; ORDER BY versions.date DESC LIMIT $debut, $nb_aff&quot;);
	if (spip_num_rows($result) &gt; 0) {	
		$titre_table = _T('icone_suivi_revisions');
		if ($court) $titre_table = afficher_plus(&quot;suivi_revisions.php3&quot;).$titre_table;
		echo &quot;&lt;div style='height: 12px;'&gt;&lt;/div&gt;&quot;;
		echo &quot;&lt;div class='liste'&gt;&quot;;
		bandeau_titre_boite2($titre_table, &quot;historique-24.gif&quot;);
	
		$total = spip_num_rows(spip_query($query . &quot;LIMIT 0, 149&quot;));
		
		if ($total &gt; $nb_aff) {
			$nb_tranches = ceil($total / $nb_aff);
			
			echo &quot;&lt;div class='arial2' style='background-color: #dddddd; padding: 5px;'&gt;&quot;;
		
			for ($i = 0; $i &lt; $nb_tranches; $i++) {
				if ($i &gt; 0) echo &quot; | &quot;;
				if ($i*$nb_aff == $debut) echo &quot;&lt;b&gt;&quot;;
				else echo &quot;&lt;a href='suivi_revisions.php3?debut=&quot;.($i * $nb_aff).&quot;&amp;id_secteur=$id_secteur&amp;uniq_auteur=$uniq_auteur&amp;lang_choisie=$lang'&gt;&quot;;
				echo (($i * $nb_aff) + 1);
				if ($i*$nb_aff == $debut) echo &quot;&lt;/b&gt;&quot;;
				else echo &quot;&lt;/a&gt;&quot;;
			}
			echo &quot;&lt;/div&gt;&quot;;
		}
	
		while ($row = mysql_fetch_array($result)) {
			$id_version = $row['id_version'];
			$id_auteur = $row['id_auteur'];
			$date = date_relative($row['date']);
			$id_article = $row['id_article'];
			$statut = $row['statut'];
			$titre = propre($row['titre']);	
			$nom = &quot;&quot;;
			$query_auteur = &quot;
				SELECT nom
				FROM spip_auteurs
				WHERE id_auteur = $id_auteur&quot;;
			$result_auteur = spip_query($query_auteur);
			if ($row_auteur = spip_fetch_array($result_auteur)) {
				$nom = propre($row_auteur[&quot;nom&quot;]);
				if (strlen($nom) &gt; 0) $nom = &quot;($nom)&quot;;
			}
	
	
			$logo_statut = &quot;puce-&quot;.puce_statut($statut).&quot;.gif&quot;;
			
			echo &quot;&lt;div class='tr_liste' style='padding: 5px; border-top: 1px solid #aaaaaa;'&gt;&quot;;
	
			echo &quot;&lt;span class='arial2'&gt;&quot;;
			if (!$court) echo bouton_block_invisible(&quot;$id_version-$id_article-$id_auteur&quot;);
			echo &quot;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;$logo_statut' border='0'&gt;&nbsp;&quot;;
			echo &quot;&lt;a class='$statut' style='font-weight: bold;' href='articles_versions.php3?id_article=$id_article'&gt;$titre&lt;/a&gt;&quot;;
			echo &quot;&lt;/span&gt;&quot;;
			echo &quot;&lt;span class='arial1'&gt;&quot;;
			echo &quot; $date $nom&quot;;
			echo &quot;&lt;/span&gt;&quot;;
		
			if (!$court) { 
				$query_diff = &quot;
					SELECT id_version
					FROM spip_versions
					WHERE id_article=$id_article AND id_version&lt;$id_version 
					ORDER BY id_version DESC LIMIT 0,1&quot;;
					if ($result_diff = spip_query($query_diff)) {
						$row_diff = mysql_fetch_array($result_diff);
						$id_diff = $row_diff['id_version'];
				}
		
		
				$query_art = &quot;
					SELECT *
					FROM spip_articles
					WHERE id_article='$id_article'&quot;;
				$result_art = spip_query($query_art);
				
				if ($row_art = spip_fetch_array($result_art)) {
					$id_article = $row_art[&quot;id_article&quot;];
					$id_rubrique = $row_art[&quot;id_rubrique&quot;];
					$date = $row_art[&quot;date&quot;];
					$statut_article = $row_art[&quot;statut&quot;];
					$maj = $row_art[&quot;maj&quot;];
					$date_redac = $row_art[&quot;date_redac&quot;];
					$visites = $row_art[&quot;visites&quot;];
					$referers = $row_art[&quot;referers&quot;];
					$extra = $row_art[&quot;extra&quot;];
					$id_trad = $row_art[&quot;id_trad&quot;];
				}
				
				$textes = recuperer_version($id_article, $id_version);		
						
				if ($id_version &amp;&amp; $id_diff) {		
					if ($id_diff &gt; $id_version) {
						$t = $id_version;
						$id_version = $id_diff;
						$id_diff = $t;
						$old = $textes;
						$new = $textes = recuperer_version($id_article, $id_version);
					}
					else {
						$old = recuperer_version($id_article, $id_diff);
						$new = $textes;
					}		
					$textes = array();			
					foreach ($champs as $champ) {
						if (!$new[$champ] &amp;&amp; !$old[$champ]) continue;			
						$diff = new Diff(new DiffTexte);
						$textes[$champ] = afficher_para_modifies(afficher_diff($diff-&gt;comparer(preparer_diff($new[$champ]), preparer_diff($old[$champ]))), $court);
					}
				}	
				
				echo debut_block_invisible(&quot;$id_version-$id_article-$id_auteur&quot;);
				if (is_array($textes))
				foreach ($textes as $var =&gt; $t) {
					if (strlen($t) &gt; 0) {
						echo &quot;&lt;blockquote class='spip serif1'&gt;&quot;;
						echo propre($t).&quot;&quot;;
						echo &quot;&lt;/blockquote&gt;&quot;;
					}		
				}		
				echo fin_block();
			
			}
			
			echo &quot;&lt;/div&gt;&quot;;
		}		
		echo &quot;&lt;/div&gt;&quot;;
	}
}

?&gt;
--- NEW FILE: articles_page.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);

debut_page(_T('titre_page_articles_page'), &quot;documents&quot;, &quot;articles&quot;);

debut_gauche();

//
// Afficher le bouton de creation d'article
//

$query = &quot;SELECT id_rubrique FROM spip_rubriques LIMIT 0,1&quot;;
$result = spip_query($query);

if (spip_num_rows($result) &gt; 0) {
	debut_raccourcis();
	icone_horizontale (_T('icone_ecrire_article'), &quot;articles_edit.php3?new=oui&quot;, &quot;article-24.gif&quot;, &quot;creer.gif&quot;);
	fin_raccourcis();
}
else {
	if ($connect_statut == '0minirezo') {
		echo _T('texte_creer_rubrique');
		icone_horizontale (_T('icone_creer_rubrique'), &quot;rubriques_edit.php3?new=oui&amp;retour=nav&quot;, &quot;rubrique-24.gif&quot;, &quot;creer.gif&quot;);
	}
}

debut_droite();




//
// Vos articles en cours de redaction
//

echo &quot;&lt;P align=left&gt;&quot;;
afficher_articles(_T('info_en_cours_validation'),
	&quot;, spip_auteurs_articles AS lien &quot;.
	&quot;WHERE articles.id_article=lien.id_article AND lien.id_auteur=$connect_id_auteur AND articles.statut=\&quot;prepa\&quot; ORDER BY articles.date DESC&quot;);




//
// Vos articles soumis au vote
//

echo &quot;&lt;p&gt;&quot;;
afficher_articles(_T('info_attente_validation'),
	&quot;, spip_auteurs_articles AS lien &quot;.
	&quot;WHERE articles.id_article=lien.id_article AND lien.id_auteur=$connect_id_auteur AND articles.statut='prop' ORDER BY articles.date&quot;);


//
// Vos articles publies
//

echo &quot;&lt;p&gt;&quot;;
afficher_articles(_T('info_publies'),
	&quot;, spip_auteurs_articles AS lien &quot;.
	&quot;WHERE articles.id_article=lien.id_article AND lien.id_auteur=\&quot;$connect_id_auteur\&quot; AND articles.statut=\&quot;publie\&quot; ORDER BY articles.date DESC&quot;, true);

//
//  Vos articles refuses
//

echo &quot;&lt;p&gt;&quot;;
afficher_articles(_T('info_refuses'),
	&quot;, spip_auteurs_articles AS lien &quot;.
	&quot;WHERE articles.id_article=lien.id_article AND lien.id_auteur=\&quot;$connect_id_auteur\&quot; AND articles.statut=\&quot;refuse\&quot; ORDER BY articles.date DESC&quot;);


fin_page();


?&gt;

--- NEW FILE: inc_debug_sql.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_DEBUG_SQL&quot;)) return;
define(&quot;_INC_DEBUG_SQL&quot;, &quot;1&quot;);

// Si le code php produit des erreurs, on les affiche en surimpression
// sauf pour un visiteur non admin (lui ne voit rien de special)
// ajouter &amp;var_mode=debug pour voir les erreurs et en parler sur <A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">spip at rezo.net</A>
function affiche_erreurs_page($tableau_des_erreurs) {

	echo &quot;&lt;div id='spip-debug' style='position: absolute; top: 20;&quot;,
	&quot; z-index: 1000;'&gt;&lt;ul&gt;&lt;li&gt;&quot;,
	_L(&quot;Erreur(s) dans le squelette&quot;),

## aide locale courte a ecrire, avec lien vers une grosse page de documentation
#		aide('erreur_compilation'),

	&quot;&lt;br /&gt;&lt;/li&gt;&quot;,
	&quot;&lt;ul&gt;&quot;;
	foreach ($tableau_des_erreurs as $err) {
		echo &quot;&lt;li&gt;&quot;.$err[0],
		&quot;, &lt;small&gt;&quot;.$err[1].&quot;&lt;/small&gt;&lt;br /&gt;&quot;,
		&quot;&lt;/li&gt;\n&quot;;
	}
	echo &quot;&lt;/ul&gt;&quot;;
	echo &quot;&lt;/ul&gt;&lt;/div&gt;&quot;;
	$GLOBALS['bouton_admin_debug'] = true;
}

//
// Si une boucle cree des soucis, on peut afficher la requete fautive
// avec son code d'erreur
//
function erreur_requete_boucle($query, $id_boucle, $type) {

	// Calmer le jeu avec MySQL (si jamais on est en saturation)
	@touch(_FILE_MYSQL_OUT);	// pour spip_cron
	spip_log('Erreur MySQL: on limite les acces quelques minutes');
	$GLOBALS['bouton_admin_debug'] = true;

	$erreur = spip_sql_error();
	$errno = spip_sql_errno();
	if (eregi('err(no|code):?[[:space:]]*([0-9]+)', $erreur, $regs))
		$errsys = $regs[2];
	else if (($errno == 1030 OR $errno &lt;= 1026)
	AND ereg('[^[:alnum:]]([0-9]+)[^[:alnum:]]', $erreur, $regs))
		$errsys = $regs[1];

	// Erreur systeme
	if ($errsys &gt; 0 AND $errsys &lt; 200) {
		$retour .= &quot;&lt;tt&gt;&lt;br&gt;&lt;br&gt;&lt;blink&gt;&quot;
		. _T('info_erreur_systeme', array('errsys'=&gt;$errsys))
		. &quot;&lt;/blink&gt;&lt;br&gt;\n&quot;
		. _T('info_erreur_systeme2');
		spip_log(&quot;Erreur systeme $errsys&quot;);
	}
	// Requete erronee
	else {
		$retour .= &quot;&lt;tt&gt;&lt;blink&gt;&lt;BOUCLE&quot;.$id_boucle.&quot;&gt;(&quot;
		. $type . &quot;)&lt;/blink&gt;&lt;br&gt;\n&quot;
		. &quot;&lt;b&gt;&quot;._T('avis_erreur_mysql').&quot;&lt;/b&gt;&lt;br&gt;\n&quot;
		. htmlspecialchars($query)
		. &quot;&lt;br&gt;&lt;font color='red'&gt;&lt;b&gt;&quot;.htmlspecialchars($erreur)
		. &quot;&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&quot;
		. &quot;&lt;blink&gt;&lt;/BOUCLE&quot;.$id_boucle.&quot;&gt;&lt;/blink&gt;&lt;/tt&gt;\n&quot;;

		include_ecrire('inc_presentation.php3');
		include_ecrire('inc_lang.php3');
		utiliser_langue_visiteur();
		$retour .= aide('erreur_mysql');
		spip_log(&quot;Erreur MySQL BOUCLE$id_boucle (&quot;.$GLOBALS['fond'].&quot;.html)&quot;);
	}

	erreur_squelette($retour);
}


//
// Erreur de syntaxe des squelettes : memoriser le code fautif
//
function erreur_squelette($message='', $lieu='') {
	global $tableau_des_erreurs;
	global $auteur_session;
	static $runs;

	if (is_array($message)) list($message, $lieu) = $message;

	spip_log(&quot;Erreur squelette: $message | $lieu (&quot;
		. $GLOBALS['fond'].&quot;.html)&quot;);
	$GLOBALS['bouton_admin_debug'] = true;
	$tableau_des_erreurs[] = array($message, $lieu);
	// Eviter les boucles infernales
	if (++$runs &gt; 4) {
		if ($HTTP_COOKIE_VARS['spip_admin'] OR
		$auteur_session['statut'] == '0minirezo' OR
		    ($GLOBALS['var_mode'] == 'debug')) {
			echo debut_entete('Debug'), '&lt;/head&gt;&lt;body&gt;';
			die(affiche_erreurs_page($tableau_des_erreurs));
		}
	}
}

//
// Le debugueur v2
//

// appelee a chaque sortie de boucle (inc-compilo) et a chaque requete
// dans ce derniers cas on n'a pas le nom du squelette
// alors on memorise dans une statique et lors de l'autre appel qui suit
// on finalise
function boucle_debug_resultat ($id, $nom, $resultat) {
	global $debug_objets;
	static $requete = array();
	if (!$nom) {$requete[$id] = $resultat; return;}
	if ($requete[$id]) {
		$debug_objets['requete'][&quot;$nom$id&quot;] = $requete[$id];
		$requete[$id] = '';
	}
	// ne pas memoriser plus de 3 tours d'une meme boucle
	if (count($debug_objets['resultat'][&quot;$nom$id&quot;]) &lt; 3)
		$debug_objets['resultat'][&quot;$nom$id&quot;][] = $resultat;
}

// appelee a chaque compilation de boucle (inc-compilo)
function boucle_debug_compile ($id, $nom, $pretty, $sourcefile, $code) {
	global $debug_objets;

	$debug_objets['code'][$nom.$id] = $code;
	$debug_objets['pretty'][$nom.$id] = $pretty;
}

// appelee a chaque compilation de squelette (inc-compilo)
function squelette_debug_compile($nom, $sourcefile, $squelette) {
	global $debug_objets;
	$debug_objets['squelettes'][$nom] = $squelette;
	$debug_objets['sourcefile'][$nom] = $sourcefile;
}

// appelee a chaque analyse syntaxique de squelette (inc-parser)
function boucle_debug ($id, $nom, $boucle) {
	global $debug_objets;

	$debug_objets['boucle'][$nom.$id] = $boucle;
}

// l'environnement graphique du debuggueur 
function debug_dumpfile ($texte, $fonc, $type) {

	global $debug_objets, $var_mode_objet, $var_mode_affiche;
	$debug_objets[$type][$fonc . 'tout'] = $texte;
	if (!$debug_objets['sourcefile']) return;
	if ($texte &amp;&amp; ($var_mode_objet != $fonc || $var_mode_affiche != $type))
	    return;
	spip_setcookie('spip_debug', 'oui', time()+12*3600);

	$link = new Link;
	$link-&gt;delvar('var_mode_affiche');
	$link-&gt;delvar('var_mode_objet');
	$link-&gt;addvar('var_mode','debug');
	$self = $link-&gt;getUrl();

// en cas de squelette inclus,  virer le code de l'incluant:
// - il contient souvent une Div restreignant la largeur a 3 fois rien
// - ca fait 2 headers !
	ob_end_clean();

	echo debut_entete('Debug'), 
	  &quot;&lt;link rel='stylesheet' href='spip_admin.css' type='text/css' /&gt;&quot;,
	  &quot;&lt;/head&gt;\n&lt;body&gt;&quot;,
	  &quot;&lt;div id='spip-debug' style='position: absolute; top: 20; z-index: 1000;'&gt;&lt;ul&gt;\n&quot;; 

	foreach ($debug_objets['sourcefile'] as $nom_skel =&gt; $sourcefile) {
		echo &quot;&lt;li&gt;&lt;b&gt;&quot;,$sourcefile,&quot;&lt;/b&gt;&quot;;
		echo &quot; &lt;a href='&quot;,$self, &quot;&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=resultat'&gt;resultat&lt;/a&gt;&quot;;
		echo &quot; &lt;a href='&quot;, $self, &quot;&amp;var_mode_objet=$nom_skel&amp;var_mode_affiche=code'&gt;code&lt;/a&gt;&quot;;
		echo &quot;&lt;table width='100%'&gt;\n&quot;;
		$i = 0;
		$colors = array('#c0c0c0', '#c0cad4');
		if (is_array($debug_objets['pretty']))
		foreach ($debug_objets['pretty'] as $nom =&gt; $pretty)
			if (substr($nom, 0, strlen($nom_skel)) == $nom_skel) {
				$i++;
				$aff = &quot;&lt;&quot;.$pretty.&quot;&gt;&quot;;
				if ($var_mode_objet == $nom)
					$aff = &quot;&lt;b&gt;$aff&lt;/b&gt;&quot;;
				echo &quot;&lt;tr bgcolor='&quot; . $colors[$i%2] . &quot;'&gt;&lt;td  align='right'&gt;$i&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;,$self,&quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=boucle' class='debug_link_boucle'&gt;boucle&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;,$self, &quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=resultat' class='debug_link_resultat'&gt;resultat&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='&quot;, $self, &quot;&amp;var_mode_objet=$nom&amp;var_mode_affiche=code' class='debug_link_code'&gt;code&lt;/a&gt;&lt;/td&gt;&lt;td&gt;$aff&lt;/td&gt;&lt;/tr&gt;&quot;;
			}
		echo &quot;&lt;/table&gt;\n&lt;/li&gt;\n&quot;;
	}
	echo &quot;&lt;/ul&gt;\n&quot;;
	if ($var_mode_objet &amp;&amp; ($res = $debug_objets[$var_mode_affiche][$var_mode_objet])) {
	  if ($var_mode_affiche == 'resultat') {
		echo &quot;&lt;div id=\&quot;debug_boucle\&quot;&gt;&lt;fieldset&gt;&lt;legend&gt;&quot;,$debug_objets['pretty'][$var_mode_objet],&quot;&lt;/legend&gt;&quot;;
		highlight_string($debug_objets['requete'][$var_mode_objet]);
		echo &quot;&lt;p class='spip-admin-bloc'&gt;les premiers appels &agrave; cette boucle ont donn&eacute;&nbsp;:&lt;/p&gt;&quot;;
		foreach ($res as $view) 
			if ($res) echo &quot;&lt;br&gt;&lt;fieldset&gt;&quot;,interdire_scripts($view),&quot;&lt;/fieldset&gt;&quot;;
		echo &quot;&lt;/fieldset&gt;&lt;/div&gt;&quot;;

      } else if ($var_mode_affiche == 'code') {
		echo &quot;&lt;div id=\&quot;debug_boucle\&quot;&gt;&lt;fieldset&gt;&lt;legend&gt;&quot;,$debug_objets['pretty'][$var_mode_objet],&quot;&lt;/legend&gt;&quot;;
		highlight_string(&quot;&lt;&quot;.&quot;?php\n&quot;.$res.&quot;\n?&quot;.&quot;&gt;&quot;);
		echo &quot;&lt;/fieldset&gt;&lt;/div&gt;&quot;;
	} else if ($var_mode_affiche == 'boucle') {
		echo &quot;&lt;div id=\&quot;debug_boucle\&quot;&gt;&lt;fieldset&gt;&lt;legend&gt;&quot;,$debug_objets['pretty'][$var_mode_objet],&quot;&lt;/legend&gt;&quot;;
		highlight_string($res);
		echo &quot;&lt;/fieldset&gt;&lt;/div&gt;&quot;;
	  }
    }

	if ($texte) {
	  echo &quot;&lt;div id=\&quot;debug_boucle\&quot;&gt;&lt;fieldset&gt;&lt;legend&gt;&quot;,$GLOBALS['var_mode_affiche'],&quot;&lt;/legend&gt;&quot;;
	  ob_start();
	  highlight_string($texte);
	  $s = ob_get_contents();
	  ob_end_clean();
	  if (substr($s,0,6) == '&lt;code&gt;') { $s=substr($s,6); echo '&lt;code&gt;';}
	  $tableau = explode(&quot;&lt;br /&gt;&quot;, $s);
	  $format = &quot;&lt;br /&gt;\n&lt;span style='color: black'&gt;%0&quot;.
	    strlen(count($tableau)).
	    &quot;d &lt;/span&gt;&quot;;
	  $format10=str_replace('black','pink',$format);
	  $i=1;
	  foreach ($tableau as $ligne)
	    echo sprintf(($i%10) ? $format :$format10, $i++), $ligne ;


	  echo &quot;&lt;/fieldset&gt;&lt;/div&gt;&quot;;
	}
	echo &quot;\n&lt;/div&gt;&quot;;
	echo inclure_balise_dynamique(balise_formulaire_admin_dyn('','','','','',$debug_objets));
	echo '&lt;/body&gt;&lt;/html&gt;';
	exit;
}

?&gt;

--- NEW FILE: optimiser.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_OPTIMISER&quot;)) return;
define(&quot;_ECRIRE_OPTIMISER&quot;, &quot;1&quot;);


function optimiser_base() {
	spip_log (&quot;optimisation de la base&quot;);

	$mydate = date(&quot;YmdHis&quot;, time() - 24 * 3600);

	//
	// Rubriques
	//

	$query = &quot;SELECT id_rubrique FROM spip_rubriques&quot;;
	$result = spip_query($query);
	$rubriques = '0';
	while ($row = spip_fetch_array($result)) $rubriques .= ','.$row['id_rubrique'];

	if ($rubriques) {
		$query = &quot;DELETE FROM spip_articles WHERE id_rubrique NOT IN ($rubriques) AND maj &lt; $mydate&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_breves WHERE id_rubrique NOT IN ($rubriques) AND maj &lt; $mydate&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_rubrique NOT IN (0,$rubriques)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_auteurs_rubriques WHERE id_rubrique NOT IN ($rubriques)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_documents_rubriques WHERE id_rubrique NOT IN ($rubriques)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_rubriques WHERE id_rubrique NOT IN ($rubriques)&quot;;
		spip_query($query);
	}


	//
	// Articles
	//

	$query = &quot;DELETE FROM spip_articles WHERE statut='poubelle' AND maj &lt; $mydate&quot;;
	spip_query($query);
	$query = &quot;SELECT id_article FROM spip_articles&quot;;
	$result = spip_query($query);
	$articles = '0';
	while ($row = spip_fetch_array($result)) $articles .= ','.$row['id_article'];

	if ($articles) {
		$query = &quot;DELETE FROM spip_auteurs_articles WHERE id_article NOT IN ($articles)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_documents_articles WHERE id_article NOT IN ($articles)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_articles WHERE id_article NOT IN ($articles)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_article NOT IN (0,$articles)&quot;;
		spip_query($query);
	}


	//
	// Breves
	//

	$query = &quot;DELETE FROM spip_breves WHERE statut='refuse' AND maj &lt; $mydate&quot;;
	spip_query($query);
	$breves = '0';
	$query = &quot;SELECT id_breve FROM spip_breves&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $breves .= ','.$row['id_breve'];

	if ($breves) {
		$query = &quot;DELETE FROM spip_documents_breves WHERE id_breve NOT IN ($breves)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_breves WHERE id_breve NOT IN ($breves)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_breve NOT IN (0,$breves)&quot;;
		spip_query($query);
	}


	//
	// Sites
	//

	$query = &quot;DELETE FROM spip_syndic WHERE maj &lt; $mydate AND statut = 'refuse'&quot;;
	spip_query($query);

	$syndic = '0';
	$query = &quot;SELECT id_syndic FROM spip_syndic&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $syndic .= ','.$row['id_syndic'];

	if ($syndic) {
		$query = &quot;DELETE FROM spip_syndic_articles WHERE id_syndic NOT IN (0,$syndic)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_syndic WHERE id_syndic NOT IN ($syndic)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_syndic NOT IN (0,$syndic)&quot;;
		spip_query($query);
	}


	//
	// Auteurs
	//

	$auteurs = '0';
	$query = &quot;SELECT id_auteur FROM spip_auteurs&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $auteurs .= ','.$row['id_auteur'];

	if ($auteurs) {
		$query = &quot;DELETE FROM spip_auteurs_articles WHERE id_auteur NOT IN ($auteurs)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_auteurs_messages WHERE id_auteur NOT IN ($auteurs)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_auteurs_rubriques WHERE id_auteur NOT IN ($auteurs)&quot;;
		spip_query($query);
	}

	$query = &quot;SELECT id_auteur,nom,email FROM spip_auteurs WHERE statut='5poubelle' AND maj &lt; $mydate&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$id_auteur = $row['id_auteur'];
		$nom = $row['nom'];
		$email = $row['email'];

		$query2 = &quot;SELECT * FROM spip_auteurs_articles WHERE id_auteur=$id_auteur&quot;;
		$result2 = spip_query($query2);
		if (!spip_num_rows($result2)) {
			$query3 = &quot;DELETE FROM spip_auteurs WHERE id_auteur=$id_auteur&quot;;
			$result3 = spip_query($query3);
			spip_log (&quot;suppression auteur $id_auteur ($nom, $email)&quot;);
		}
	}


	//
	// Messages prives
	//

	$query = &quot;SELECT m.id_message FROM spip_messages AS m, spip_auteurs_messages AS lien &quot;.
		&quot;WHERE m.id_message = lien.id_message GROUP BY m.id_message&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $messages[] = $row['id_message'];

	$query = &quot;SELECT id_message FROM spip_messages &quot;.
		&quot;WHERE type ='affich'&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $messages[] = $row['id_message'];

	if ($messages) {
		$messages = join(&quot;,&quot;, $messages);

		$query = &quot;DELETE FROM spip_messages WHERE id_message NOT IN ($messages)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_forum WHERE id_message NOT IN (0,$messages)&quot;;
		spip_query($query);
	}


	//
	// Mots-cles
	//

	$query = &quot;DELETE FROM spip_mots WHERE titre='' AND maj &lt; $mydate&quot;;
	$result = spip_query($query);

	$mots = '0';
	$query = &quot;SELECT id_mot FROM spip_mots&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $mots .= ','.$row['id_mot'];

	if ($mots) {
		$query = &quot;DELETE FROM spip_mots_articles WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_breves WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_forum WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_rubriques WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_syndic WHERE id_mot NOT IN ($mots)&quot;;
		spip_query($query);
	}


	// 
	// Documents
	//

/*
	$query = &quot;SELECT id_document FROM spip_documents_articles&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_document'];
	$query = &quot;SELECT id_document FROM spip_documents_rubriques&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_document'];
	$query = &quot;SELECT id_document FROM spip_documents_breves&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_document'];
	$query = &quot;SELECT DISTINCT id_vignette FROM spip_documents WHERE id_vignette != 0&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $documents[] = $row['id_vignette'];
	
	if ($documents) {
		$documents = join(&quot;,&quot;, $documents);

		$query = &quot;SELECT id_document, fichier FROM spip_documents WHERE id_document NOT IN ($documents)&quot;;
		$result = spip_query($query);
		while ($row = spip_fetch_array($result)) {
			$documents_poubelle[] = $row['id_document'];
			$fichiers_poubelle[] = $row['fichier'];
		}

		if ($documents_poubelle) {
			$documents_poubelle = join(&quot;,&quot;, $documents_poubelle);

			$fichier = _DIR_RESTEINT_ABS .'data/.poubelle';
			if (!$f = @fopen($fichier, 'a')) {
				spip_log(&quot;impossible d'ecrire dans $fichier !&quot;);
				@unlink($fichier);	// on essaie de forcer
				$f = @fopen($fichier, 'a');
			}
			spip_log(&quot;mise a la poubelle : &quot;.join(&quot;, &quot;, $fichiers_poubelle));
			$ok = fputs($f, join(&quot;\n&quot;, $fichiers_poubelle).&quot;\n&quot;);
			fclose($f);
			if ($ok) {
				$query = &quot;DELETE FROM spip_documents WHERE id_document IN ($documents_poubelle)&quot;;
				spip_query($query);
			}
		}
	}
*/

	//
	// Forums
	//

	$query = &quot;DELETE FROM spip_forum WHERE statut='redac' AND maj &lt; $mydate&quot;;
	spip_query($query);

	$forums = '0';
	$query = &quot;SELECT id_forum FROM spip_forum&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $forums .= ','.$row[0];

	if ($forums) {
		$query = &quot;DELETE FROM spip_forum WHERE id_parent NOT IN (0,$forums)&quot;;
		spip_query($query);
		$query = &quot;DELETE FROM spip_mots_forum WHERE id_forum NOT IN ($forums)&quot;;
		spip_query($query);
	}


	//
	// Indexation
	//

	// les objets inutiles
	$types = array('article','auteur','breve','mot','rubrique','forum','signature','syndic');
	while (list(,$type) = each($types)) {
		$table_objet = 'spip_'.table_objet($type);
		$table_index = 'spip_index_'.table_objet($type);
		
		// limiter aux objets publies
		switch ($type) {
			case 'article':
			case 'breve':
			case 'rubrique':
			case 'syndic':
			case 'forum':
			case 'signature':
				$critere = &quot;AND statut&lt;&gt;'publie'&quot;;
				break;
			case 'auteur':
				$critere = &quot;AND statut NOT IN ('0minirezo', '1comite')&quot;;
				break;
			case 'mot':
			default:
				$critere = 'AND 1=0';	// ne jamais desindexer un mot
				break;
		}

		spip_query(&quot;UPDATE $table_objet SET idx='' WHERE idx&lt;&gt;'non' $critere&quot;);

		$suppr = '';
		$s = spip_query(&quot;SELECT id_$type FROM $table_objet WHERE idx='' $critere&quot;);
		while ($t = spip_fetch_array($s))
			$suppr .= ','.$t[0];
		$s = spip_query(&quot;SELECT id_$type FROM $table_objet WHERE idx='non'&quot;);
		while ($t = spip_fetch_array($s))
			$suppr .= ','.$t[0];
		if ($suppr)
			spip_query(&quot;DELETE FROM $table_index WHERE id_$type IN (0$suppr)&quot;);
	}

/*
	// les objets supprimes
	$hash = array();
	$types = array('article','auteur','breve','mot','rubrique','forum','signature','syndic');
	while (list(,$type) = each($types)) {
		$table_objet = 'spip_'.table_objet($type);
		$table_index = 'spip_index_'.table_objet($type);
		$list_objets = table_objet($type);
		if ($liste = $$list_objets)
			spip_query(&quot;DELETE FROM $table_index WHERE id_$type NOT IN ($liste)&quot;);
		$s = spip_query(&quot;SELECT DISTINCT(hash) FROM $table_index&quot;);
		while ($t = spip_fetch_array($s))
			$hash[$t[0]] = $t[0];
	}
	if (count($hash)) {
		$s = spip_query(&quot;SELECT hash FROM spip_index_dico&quot;);
		$suppr = '';
		while ($t = spip_fetch_array($s))
			if (!$hash[$t[0]]) $suppr.=','.$t[0];
		if ($suppr)
			spip_query(&quot;DELETE FROM spip_index_dico WHERE hash IN (0$suppr)&quot;);	
	}
*/

	//
	// MySQL
	//
	if ($GLOBALS['table_prefix']) $table_pref = $GLOBALS['table_prefix'].&quot;_&quot;;
	else $table_pref = &quot;&quot;;

	$query = &quot;SHOW TABLES LIKE '$table_pref%'&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) $tables[] = $row[0];

	if ($tables) {
		$tables = join(&quot;,&quot;, $tables);
		$query = &quot;OPTIMIZE TABLE &quot;.$tables;
		spip_query($query);
	}

	spip_log(&quot;optimisation ok&quot;);
}

optimiser_base();

?&gt;

--- NEW FILE: calendrier.php3 ---
&lt;?php

if (isset($HTTP_GET_VARS['type']))
{
	if ($HTTP_GET_VARS['type'] == 'semaine')
		{ include (&quot;calendrier_semaine.php3&quot;);exit;}
	else if ($HTTP_GET_VARS['type'] == 'jour')
		{ include (&quot;calendrier_jour.php3&quot;);exit;}
}
include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_calendrier.php&quot;);

$today=getdate(time());

// sans arguments =&gt; mois courant
if (!$mois){$annee=$today[&quot;year&quot;];$mois=$today[&quot;mon&quot;]; }
$periode = $annee . '-' . sprintf(&quot;%02d&quot;, $mois) . '-01';

$afficher_bandeau_calendrier = true;

debut_page(_T('titre_page_calendrier',
	      array('nom_mois' =&gt; nom_mois($periode), 'annee' =&gt; $annee)), 
	   &quot;redacteurs&quot;, 
	   &quot;calendrier&quot;);

echo http_calendrier_tout($mois,$annee, '01', '31');
?&gt;

--- NEW FILE: inc_carto.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_CARTE&quot;)) return;
define(&quot;_ECRIRE_INC_CARTE&quot;, &quot;1&quot;);

function embed_map_url($id_carte, $url_parse) {
	$lURL = $url_parse['path'].&quot;/carto.php3?id_carte=&quot;.$id_carte.&quot;&amp;scale=&quot;.$_GET['scale'].&quot;&amp;x=&quot;.$_GET['x'].&quot;&amp;y=&quot;.$_GET['y'];
	return $lURL;
}

function afficher_cartes($titre_table, $requete, $icone = '') {
	global $couleur_claire, $couleur_foncee;
	global $connect_id_auteur;

	$tranches = afficher_tranches_requete($requete, 3);
	if (!$icone) $icone = &quot;carte-24.gif&quot;;

	if ($tranches) {
		if ($titre_table) echo &quot;&lt;div style='height: 12px;'&gt;&lt;/div&gt;&quot;;
		echo &quot;&lt;div class='liste'&gt;&quot;;
		bandeau_titre_boite2($titre_table, $icone, $couleur_claire, &quot;black&quot;);
		echo &quot;&lt;table width='100%' cellpadding='3' cellspacing='0' border='0'&gt;&quot;;

		echo $tranches;

	 	$result = spip_query($requete);
		$num_rows = spip_num_rows($result);

		$ifond = 0;
		$premier = true;
		
		$compteur_liste = 0;
		while ($row = spip_fetch_array($result)) {
			$vals = '';
			$id_carte= $row['id_carte'];
			$objets= $row['objets'];
			$titre = $row['titre'];
			
			$tous_id[] = $id_carte;

			$link = new Link(&quot;carte_edit.php3&quot;);
			$link-&gt;addVar(&quot;id_carte&quot;, $id_carte);
			$link-&gt;addVar(&quot;retour&quot;, $GLOBALS['clean_link']-&gt;getUrl());
			if ($objets) {
				$puce = 'puce-verte-breve.gif';
			}
			else {
				$puce = 'puce-orange-breve.gif';
			}

			$s = &quot;&lt;a href=\&quot;&quot;.$link-&gt;getUrl().&quot;\&quot;&gt;&quot;;
			$s .= &quot;&lt;img src='img_pack/$puce' width='7' height='7' border='0'&gt;&nbsp;&nbsp;&quot;;
			$s .= typo($titre);
			$s .= &quot;&lt;/a&gt; &nbsp;&nbsp;&quot;;
			$vals[] = $s;
			
			$s = &quot;&quot;;
			$vals[] = $s;

			$s = &quot;&quot;;
			if ($reponses) {
				$s .= $reponses.&quot; &quot;._L(&quot;r&eacute;ponses&quot;);
			}
			$vals[] = $s;
			$table[] = $vals;
		}
		spip_free_result($result);
		
		$largeurs = array('','','');
		$styles = array('arial11', 'arial1', 'arial1');
		afficher_liste($largeurs, $table, $styles);
		echo &quot;&lt;/table&gt;&quot;;
		echo &quot;&lt;/div&gt;\n&quot;;
	}
	return $tous_id;
}

function afficher_carte_inteface($fichier,$id_carte,$width,$height) {
	$returned='&lt;script type=&quot;text/javascript&quot; src=&quot;js/x_core_nn4.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;js/x_dom_nn4.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;js/x_event_nn4.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;js/navTools.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;js/graphTools.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
/*&lt;![CDATA[*/ 
    var dhtmlDivs = new String();
    document.image = new Image;
    document.image.src = \''.$fichier.'\';
    
    if (xIE) {
      dhtmlDivs = \'&lt;div id=&quot;mapImageDiv&quot; class=&quot;dhtmldiv&quot; style=&quot;background-image:url(\'; 
      dhtmlDivs += document.image.src;
      dhtmlDivs += \');visibility:hidden;background-repeat:no-repeat;&quot;&gt;&lt;/div&gt;\';
    } else {
      dhtmlDivs = \'&lt;div id=&quot;mapImageDiv&quot; class=&quot;dhtmldiv&quot; style=&quot;visibility:hidden&quot;&gt;&lt;img \';
      
      dhtmlDivs += \'src=&quot;\' + document.image.src + \'&quot; alt=&quot;Main map&quot; title=&quot;&quot; \';
      dhtmlDivs += \'width=&quot;'.$width.'px&quot; height=&quot;'.$height.'px&quot; /&gt;&lt;/div&gt;\';
      
    }
    dhtmlDivs += \'&lt;div id=&quot;myCanvasDiv&quot; class=&quot;dhtmldiv&quot;&gt;&lt;/div&gt;\';
    dhtmlDivs += \'&lt;div id=&quot;myCanvas2Div&quot; class=&quot;dhtmldiv&quot;&gt;&lt;/div&gt;\';
    dhtmlDivs += \'&lt;div id=&quot;mainDHTMLDiv&quot; class=&quot;dhtmldiv&quot;&gt;&lt;/div&gt;\';
    dhtmlDivs += \'&lt;div id=&quot;diplayContainerDiv&quot; class=&quot;dhtmldiv&quot;&gt;\';
    dhtmlDivs += \'&lt;table border=&quot;0&quot; width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;&lt;tr&gt;\';
    dhtmlDivs += \'&lt;td width=&quot;50%&quot;&gt;&lt;div id=&quot;displayCoordsDiv&quot; class=&quot;dhtmlDisplay&quot;&gt;&lt;/div&gt;&lt;/td&gt;\';
    dhtmlDivs += \'&lt;td align=&quot;right&quot; width=&quot;50%&quot;&gt;&lt;div id=&quot;displayMeasureDiv&quot; class=&quot;dhtmlDisplay&quot;&gt;&lt;/div&gt;&lt;/td&gt;\';
    dhtmlDivs += \'&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;\';
    document.write(dhtmlDivs);
                  
    function dboxInit()
    {
      myform = document.forms[\'carto_form\'];
      // DHTML drawing and navigating tools
      dhtmlBox = new dhtmlBox();
          
      //DHTML parameters
      dhtmlBox.dispPos = \'bottom\';
      dhtmlBox.thickness = 2;
      dhtmlBox.cursorsize = 4;
      dhtmlBox.jitter = 10; // minimum size of a box dimension
      dhtmlBox.d2pts = 3;   // the distance between two points (measure tools);
      dhtmlBox.nbPts = 5;   // number of points for the last vertex
      
      // map units values
	  // dynamically given by the server
      dhtmlBox.mapHeight = 300;
      dhtmlBox.boxx = 470000;
      dhtmlBox.boxy = 46300;
      dhtmlBox.pixel_size = 924.83333333334;
      dhtmlBox.dist_msg = \'Approx. distance: \';
      dhtmlBox.dist_unit = \' m.\';
      dhtmlBox.surf_msg = \'Approx. surface: \';
      dhtmlBox.surf_unit = \' m&#194;&#178;.\';
      dhtmlBox.coord_msg = \'Coords (m): \';
  
          
      dhtmlBox.initialize();
    }
      
    window.onload = function() {
      dboxInit();
      xHide(xGetElementById(\'mapAnchorDiv\')); 
    }
	/*]]&gt;*/
  &lt;/script&gt;
&lt;form method=&quot;get&quot; action=&quot;#&quot; name=&quot;carto_form&quot;&gt;
  &lt;table&gt;
    &lt;tr&gt; 
      &lt;td&gt; &lt;input type=&quot;hidden&quot; name=&quot;id_carte&quot; value=&quot;'.$id_carte.'&quot;/&gt; &lt;input type=&quot;hidden&quot; name=&quot;selection_type&quot; /&gt; &lt;input type=&quot;hidden&quot; name=&quot;selection_coords&quot; /&gt; 
        &lt;div id=&quot;mapAnchorDiv&quot; style=&quot;position:relative; width:'.$width.'px; height:'.$height.'px;&quot;&gt; 
          &lt;table&gt;
            &lt;tr&gt; 
              &lt;td align=&quot;center&quot; valign=&quot;middle&quot; width=&quot;'.$width.'px&quot; height=&quot;'.$height.'px&quot;&gt;&lt;div id=&quot;loadbar&quot;&gt;Loading 
                  message&lt;/div&gt;&lt;/td&gt;
            &lt;/tr&gt;
          &lt;/table&gt;
        &lt;/div&gt;&lt;/td&gt;
      &lt;td&gt; &lt;p&gt; 
          &lt;!-- input value use : shapeType,action,cursorStyle,toolName (with no blank spaces!)--&gt;
          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;rectangle,submit,crossHair,zoom_in&quot;  checked=&quot;checked&quot;  id=&quot;zoom_in&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
          zoom_in&lt;br /&gt;
          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;point,submit,crossHair,zoom_out&quot;  id=&quot;zoom_out&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
          zoom out&lt;br /&gt;
          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;pan,submit,move,pan&quot;  id=&quot;pan&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
          pan&lt;br /&gt;
          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;rectangle,submit,help,query&quot;  id=&quot;query&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
          query&lt;br /&gt;
          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;point,submit,crossHair,point&quot;   id=&quot;point&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
          line submit&lt;br /&gt;
          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;line,submit,crossHair,line&quot;   id=&quot;line&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
          line submit&lt;br /&gt;
          &lt;input type=&quot;radio&quot; name=&quot;tool&quot; value=&quot;polygon,submit,crossHair,polygon&quot;   id=&quot;toto&quot; onclick=&quot;dhtmlBox.changeTool()&quot; /&gt;
          polygon submit&lt;br /&gt;
        &lt;/p&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/table&gt;
&lt;/form&gt;';
	return $returned;
}
function carte_editable() {
	return true;
}
function carte_administrable() {
	return true;
}
//
// Afficher un pave cartes dans la colonne de gauche
// (edition des articles)

function afficher_insertion_carte($id_article) {
	global $connect_id_auteur, $connect_statut;
	global $couleur_foncee, $couleur_claire, $options;
	global $spip_lang_left, $spip_lang_right;
	global $clean_link;

	// Ajouter une carte
	echo &quot;\n&lt;p&gt;&quot;;
	debut_cadre_relief(&quot;carte-24.gif&quot;, false);

	echo &quot;&lt;div style='padding: 2px; background-color: $couleur_claire; text-align: center; color: black;'&gt;&quot;;
	echo bouton_block_invisible(&quot;ajouter_carte&quot;);
	echo &quot;&lt;strong class='verdana3' style='text-transform: uppercase;'&gt;&quot;
		._L(&quot;Ins&eacute;rer une carte&quot;).&quot;&lt;/strong&gt;&quot;;
	echo &quot;&lt;/div&gt;\n&quot;;

	echo debut_block_invisible(&quot;ajouter_carte&quot;);
	echo &quot;&lt;div class='verdana2'&gt;&quot;;
	echo _L(&quot;Vous pouvez ins&eacute;rer des cartes dans vos articles. Choisissez une &quot;.
		&quot;carte dans la liste ci-dessous et recopiez le raccourci dans le texte &quot;.
		&quot;de l'article.&quot;);
	echo &quot;&lt;/div&gt;&quot;;

	$query = &quot;SELECT id_carte, titre FROM spip_carto_carte ORDER BY titre&quot;;
	$result = spip_query($query);
	if (spip_num_rows($result)) {
		echo &quot;&lt;br /&gt;\n&quot;;
		echo &quot;&lt;div class='bandeau_rubriques' style='z-index: 1;'&gt;&quot;;
		echo &quot;&lt;div class='plan-articles'&gt;&quot;;
		while ($row = spip_fetch_array($result)) {
			$id_carte = $row['id_carte'];
			$titre = typo($row['titre']);
			
			$link = new Link(&quot;carte_edit.php3&quot;);
			$link-&gt;addVar(&quot;id_carte&quot;, $id_carte);
			$link-&gt;addVar(&quot;retour&quot;, $GLOBALS['clean_link']-&gt;getUrl());
			echo &quot;&lt;a href='&quot;.$link-&gt;getUrl().&quot;'&gt;&quot;;
			echo $titre.&quot;&lt;/a&gt;\n&quot;;
			echo &quot;&lt;div class='arial1' align='$spip_lang_right' style='color: black; padding-$spip_lang_left: 4px;' &quot;.
				&quot;title=\&quot;&quot;._L(&quot;Recopiez ce raccourci dans le texte de l'article pour ins&eacute;rer ce formulaire.&quot;).
				&quot;\&quot;&gt;&quot;;
			echo &quot;&lt;font color='333333'&gt;&lt;div align='left'&gt;&lt;map$id_carte|left&gt;&lt;/div&gt;&lt;div align='center'&gt;&lt;map$id_carte|center&gt;&lt;/div&gt;&lt;div align='right'&gt;&lt;map$id_carte|right&gt;&lt;/div&gt;&lt;/font&gt;\n&quot;;
			echo &quot;&lt;/div&gt;&quot;;
		}
		echo &quot;&lt;/div&gt;&quot;;
		echo &quot;&lt;/div&gt;&quot;;
	}

	// Creer une carte
	if (carte_editable()) {
		echo &quot;\n&lt;br /&gt;&quot;;
		$link = new Link(&quot;carte_edit.php3?new=oui&quot;);
		$link-&gt;addVar('retour', $GLOBALS['clean_link']-&gt;getUrl());
		icone_horizontale(_L(&quot;Cr&eacute;er une nouvelle carte&quot;),
			$link-&gt;getUrl(), &quot;carte-24.png&quot;, &quot;creer.gif&quot;);
	}

	echo fin_block();

	fin_cadre_relief();
}

?&gt;

--- NEW FILE: spip_style_print.css ---
body {
	color: #000000;
	background-color: #FFFFFF;
	font-family: Verdana, Geneva, Arial, Helvetica;
	font-size: 12px;
	margin: 0px;
	padding: 0px;
}

#haut-page, .colonne_etroite {
	display: none;
}

--- NEW FILE: forum.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);

// cette page gere les deux types de forums ; forum_admin.php3 n'est qu'une coquille vide
if ($admin=='oui') {
	debut_page(_T('titre_page_forum'), &quot;redacteurs&quot;, &quot;privadm&quot;);
	$statutforum = 'privadm';
	$logo = &quot;forum-admin-24.gif&quot;;
	$urlforum = 'forum_admin.php3';
} else {
	debut_page(_T('titre_forum'), &quot;redacteurs&quot;, &quot;forum-interne&quot;);
	$statutforum = 'privrac';
	$logo = &quot;forum-interne-24.gif&quot;;
	$urlforum = 'forum.php3';
}

debut_gauche();


//
// Raccourcis
//
/*
	debut_raccourcis();
	// rien
	fin_raccourcis();
*/


debut_droite();

if ($admin=='oui')
	gros_titre(_T('titre_cadre_forum_administrateur'));
else
	gros_titre(_T('titre_cadre_forum_interne'));

if ($admin == 'oui' AND $connect_statut != &quot;0minirezo&quot;) {
	echo _T('avis_non_acces_page');
	exit;
}

echo &quot;&lt;div class='serif2'&gt;&quot;;

if (!$debut) $debut = 0;

$query_forum = &quot;SELECT COUNT(*) AS cnt FROM spip_forum WHERE statut='$statutforum' AND id_parent=0&quot;;
$result_forum = spip_query($query_forum);
$total = 0;
if ($row = spip_fetch_array($result_forum)) $total = $row['cnt'];

if ($total &gt; 10) {
	echo &quot;&lt;p&gt;&quot;;
	for ($i = 0; $i &lt; $total; $i = $i + 10){
		if ($i &gt; 0) echo &quot; | &quot;;
		if ($i == $debut)
			echo &quot;&lt;FONT SIZE=3&gt;&lt;B&gt;$i&lt;/B&gt;&lt;/FONT&gt;&quot;;
		else
			echo &quot;&lt;A HREF='$urlforum?debut=$i'&gt;$i&lt;/A&gt;&quot;;
	}
}



echo &quot;&lt;p&gt;&lt;div align='center'&gt;&quot;;
icone (_T('icone_poster_message'), &quot;forum_envoi.php3?statut=$statutforum&amp;adresse_retour=$urlforum&amp;titre_message=&quot;.urlencode(filtrer_entites(_T('texte_nouveau_message'))), $logo, &quot;creer.gif&quot;);
echo &quot;&lt;/div&gt;&quot;;


echo &quot;&lt;P align='left'&gt;&quot;;

$query_forum=&quot;SELECT * FROM spip_forum WHERE statut='$statutforum' AND id_parent=0 ORDER BY date_heure DESC LIMIT $debut,10&quot;;
$result_forum=spip_query($query_forum);

afficher_forum($result_forum,$urlforum);

echo &quot;&lt;/div&gt;&quot;;


fin_page();

?&gt;


--- NEW FILE: statistiques_svg.php3 ---
&lt;?php
include (&quot;inc.php3&quot;);
include_ecrire(&quot;inc_charsets.php3&quot;);

// Gestion d'expiration de ce jaja
$date = date(&quot;U&quot;);
$expire = $date + 2 * 3600;
$headers_only = http_last_modified($expire);

$date = gmdate(&quot;D, d M Y H:i:s&quot;, $date);
$expire = gmdate(&quot;D, d M Y H:i:s&quot;, $expire);
@Header (&quot;Content-Type: text/javascript&quot;);
if ($headers_only) exit;
@Header (&quot;Last-Modified: &quot;.$date.&quot; GMT&quot;);
@Header (&quot;Expires: &quot;.$expire.&quot; GMT&quot;);




if ($connect_statut != '0minirezo') {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}


header(&quot;Content-type: image/svg+xml&quot;);
echo &quot;&lt;?xml version=\&quot;1.0\&quot; standalone=\&quot;no\&quot;?&gt;&quot;;

?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.0//EN&quot;
        &quot;<A HREF="http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd</A>&quot;&gt;
&lt;svg width=&quot;450&quot; height=&quot;310&quot; x=&quot;0&quot; y=&quot;0&quot;&gt;


&lt;defs&gt;
&lt;linearGradient id=&quot;orange_red&quot; x1=&quot;0%&quot; y1=&quot;0%&quot; x2=&quot;0%&quot; y2=&quot;150%&quot;&gt;
&lt;stop offset=&quot;0%&quot; style=&quot;stop-color:rgb(255,255,0); stop-opacity:1&quot;/&gt;
&lt;stop offset=&quot;100%&quot; style=&quot;stop-color:rgb(255,0,0); stop-opacity:1&quot;/&gt;
&lt;/linearGradient&gt;
&lt;/defs&gt;
&lt;?php
	echo &quot;&lt;defs&gt;\n&quot;;
	echo '&lt;linearGradient id=&quot;claire&quot; x1=&quot;0%&quot; y1=&quot;0%&quot; x2=&quot;0%&quot; y2=&quot;100%&quot;&gt;';
	echo '&lt;stop offset=&quot;0%&quot; style=&quot;stop-color:'.$couleur_claire.'; stop-opacity:0.3&quot;/&gt;';
	echo '&lt;stop offset=&quot;100%&quot; style=&quot;stop-color:'.$couleur_foncee.'; stop-opacity:1&quot;/&gt;';
	echo &quot;&lt;/linearGradient&gt;\n&quot;;
	echo &quot;&lt;/defs&gt;\n&quot;;
	
	echo &quot;&lt;style type='text/css'&gt;\n&quot;;
	echo &quot;.gris {fill: #aaaaaa; fill-opacity: 0.2;}\n&quot;;
	echo &quot;.trait {stroke:black;stroke-width:1;}\n&quot;;
	echo &quot;&lt;/style&gt;\n&quot;;



	if (!$aff_jours) $aff_jours = 105;
	if ($id_article) {
		$table = &quot;spip_visites_articles&quot;;
		$table_ref = &quot;spip_referers_articles&quot;;
		$where = &quot;id_article=$id_article&quot;;
	} else {
		$table = &quot;spip_visites&quot;;
		$table_ref = &quot;spip_referers&quot;;
		$where = &quot;1&quot;;
	}

	// Recuperer premier jour
	$query=&quot;SELECT UNIX_TIMESTAMP(date) AS date_unix FROM $table &quot;.
		&quot;WHERE $where ORDER BY date LIMIT 0,1&quot;;
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$date_premier = $row['date_unix'];
	}
	
	// Recuperer toutes visites
	$query=&quot;SELECT UNIX_TIMESTAMP(date) AS date_unix, visites FROM $table &quot;.
		&quot;WHERE $where AND date &gt; DATE_SUB(NOW(),INTERVAL $aff_jours DAY) ORDER BY date&quot;;
	$result=spip_query($query);

	while ($row = spip_fetch_array($result)) {
		$date = $row['date_unix'];
		$visites = $row['visites'];

		$log[$date] = $visites;
		if ($i == 0) $date_debut = $date;
		$i++;
	}
	


	if (count($log)&gt;0) {
		$max = max(max($log),$visites_today);
		$date_today = time();
		$nb_jours = floor(($date_today-$date_debut)/(3600*24));
		
		$maxgraph = substr(ceil(substr($max,0,2) / 10).&quot;000000000000&quot;, 0, strlen($max));
	
		if ($maxgraph &lt; 10) $maxgraph = 10;
		if (1.1 * $maxgraph &lt; $max) $maxgraph.=&quot;0&quot;;	
		if (0.8*$maxgraph &gt; $max) $maxgraph = 0.8 * $maxgraph;
		$rapport = 300 / $maxgraph;

		if (count($log) &lt; 420) $largeur = floor(420 / ($nb_jours+1));
		if ($largeur &lt; 1) {
			$largeur = 1;
			$agreg = ceil(count($log) / 420);	
		} else {
			$agreg = 1;
		}
		if ($largeur &gt; 50) $largeur = 50;

		$largeur_abs = 420 / $aff_jours;
		
		if ($largeur_abs &gt; 1) {
			$inc = ceil($largeur_abs / 5);
			$aff_jours_plus = 420 / ($largeur_abs - $inc);
			$aff_jours_moins = 420 / ($largeur_abs + $inc);
		}
		
		if ($largeur_abs == 1) {
			$aff_jours_plus = 840;
			$aff_jour_moins = 210;
		}
		
		if ($largeur_abs &lt; 1) {
			$aff_jours_plus = 420 * ((1/$largeur_abs) + 1);
			$aff_jours_moins = 420 * ((1/$largeur_abs) - 1);
		}


		echo &quot;&lt;line x1='0' y1='75' x2='&quot;.round($largeur*$nb_jours/$agreg).&quot;' y2='75' style='stroke:#999999;stroke-width:1'/&gt;\n&quot;;
		echo &quot;&lt;line x1='0' y1='150' x2='&quot;.round($largeur*$nb_jours/$agreg).&quot;' y2='150' style='stroke:#999999;stroke-width:1'/&gt;\n&quot;;
		echo &quot;&lt;line x1='0' y1='225' x2='&quot;.round($largeur*$nb_jours/$agreg).&quot;' y2='225' style='stroke:#999999;stroke-width:1'/&gt;\n&quot;;
		
		echo &quot;&lt;line x1='0' y1='37' x2='&quot;.round($largeur*$nb_jours/$agreg).&quot;' y2='37' style='stroke:#eeeeee;stroke-width:1'/&gt;\n&quot;;
		echo &quot;&lt;line x1='0' y1='112' x2='&quot;.round($largeur*$nb_jours/$agreg).&quot;' y2='112' style='stroke:#eeeeee;stroke-width:1'/&gt;\n&quot;;
		echo &quot;&lt;line x1='0' y1='187' x2='&quot;.round($largeur*$nb_jours/$agreg).&quot;' y2='187' style='stroke:#eeeeee;stroke-width:1'/&gt;\n&quot;;
		echo &quot;&lt;line x1='0' y1='262' x2='&quot;.round($largeur*$nb_jours/$agreg).&quot;' y2='262' style='stroke:#eeeeee;stroke-width:1'/&gt;\n&quot;;


		// Presentation graphique
		while (list($key, $value) = each($log)) {
			
			$test_agreg ++;
	
			if ($test_agreg == $agreg) {	
			
			$test_agreg = 0;
			$n++;
		
			if ($decal == 30) $decal = 0;
			$decal ++;
			$tab_moyenne[$decal] = $value;
		
			// Inserer des jours vides si pas d'entrees	
			if ($jour_prec &gt; 0) {
				$ecart = floor(($key-$jour_prec)/((3600*24)*$agreg)-1);
	
				for ($i=0; $i &lt; $ecart; $i++){
					if ($decal == 30) $decal = 0;
					$decal ++;
					$tab_moyenne[$decal] = $value;

                    $ce_jour=date(&quot;Y-m-d&quot;, $jour_prec+(3600*24*($i+1)));
			        $jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);

					reset($tab_moyenne);
					$moyenne = 0;
					while (list(,$val_tab) = each($tab_moyenne))
						$moyenne += $val_tab;
					$moyenne = $moyenne / count($tab_moyenne);
	
				//	echo &quot;&lt;td valign='bottom' width=$largeur&gt;&quot;;
					$difference = ($hauteur_moyenne) -1;
					$moyenne = round($moyenne,2); // Pour affichage harmonieux
					$hauteur_moyenne = round(($moyenne) * $rapport) - 1;


					if ($hauteur_moyenne_prec &gt; 0) {
						echo &quot;&lt;polygon points = '&quot;.(($n-2)*$largeur+round($largeur/2)).&quot;,300 &quot;.(($n-2)*$largeur+round($largeur/2)).&quot;,&quot;.(300-$hauteur_moyenne_prec).&quot; &quot;.(($n-1)*$largeur+round($largeur/2)).&quot;,&quot;.(300-$hauteur_moyenne).&quot;  &quot;.(($n-1)*$largeur+round($largeur/2)).&quot;,300' class='gris' /&gt;\n&quot;;
						echo &quot;&lt;line x1='&quot;.(($n-2)*$largeur+round($largeur/2)).&quot;' y1='&quot;.(300-$hauteur_moyenne_prec).&quot;' x2='&quot;.(($n-1)*$largeur+round($largeur/2)).&quot;' y2='&quot;.(300-$hauteur_moyenne).&quot;' class='trait' /&gt;\n&quot;;
					}

					$hauteur_moyenne_prec = $hauteur_moyenne;


					if ($difference &gt; 0) {	
						//echo &quot;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;rien.gif' width=$largeur height=1 style='background-color:#333333;' title=$tagtitle&gt;&quot;;
						//echo &quot;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;rien.gif' width=$largeur height=$hauteur_moyenne title=$tagtitle&gt;&quot;;
					}
					//echo &quot;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;rien.gif' width=$largeur height=1 style='background-color:black;' title=$tagtitle&gt;&quot;;
					//echo &quot;&lt;/td&gt;&quot;;
					$n++;
				}
			}

			$ce_jour=date(&quot;Y-m-d&quot;, $key);
			$jour = nom_jour($ce_jour).' '.affdate_court($ce_jour);

			$total_loc = $total_loc + $value;
			reset($tab_moyenne);

			$moyenne = 0;
			while (list(,$val_tab) = each($tab_moyenne))
				$moyenne += $val_tab;
			$moyenne = $moyenne / count($tab_moyenne);
		
			$hauteur_moyenne = round($moyenne * $rapport) - 1;
			$hauteur = round($value * $rapport) - 1;
			$moyenne = round($moyenne,2); // Pour affichage harmonieux
			//echo &quot;&lt;td valign='bottom' width=$largeur&gt;&quot;;

//			$tagtitle='&quot;'.attribut_html(supprimer_tags(&quot;$jour | &quot;
//			._T('info_visites').&quot; &quot;.$value)).'&quot;';



			if (date(&quot;w&quot;,$key) == &quot;0&quot;) // Dimanche en couleur foncee
				$fill = $couleur_foncee;
			else 
				$fill = &quot;url(#claire)&quot;;



			echo &quot;&lt;rect x='&quot;.(($n-1)*$largeur).&quot;' y='&quot;.(300-$hauteur).&quot;' width='$largeur' height='$hauteur' style='fill:$fill'/&gt;\n&quot;;	
			echo &quot;&lt;rect x='&quot;.(($n-1)*$largeur).&quot;' y='&quot;.(300-$hauteur).&quot;' width='$largeur' height='1' style='fill:$couleur_foncee;'/&gt;\n&quot;;	

			if (date(&quot;d&quot;, $key) == &quot;1&quot;) 
				echo &quot;&lt;line x1='&quot;.(($n-1)*$largeur).&quot;' y1='&quot;.(300-$hauteur_moyenne).&quot;' x2='&quot;.(($n-1)*$largeur).&quot;' y2='300' class='trait'/&gt;\n&quot;;	
			
				
			if ($hauteur_moyenne_prec &gt; 0) {
				echo &quot;&lt;polygon points = '&quot;.(($n-2)*$largeur+round($largeur/2)).&quot;,300 &quot;.(($n-2)*$largeur+round($largeur/2)).&quot;,&quot;.(300-$hauteur_moyenne_prec).&quot; &quot;.(($n-1)*$largeur+round($largeur/2)).&quot;,&quot;.(300-$hauteur_moyenne).&quot;  &quot;.(($n-1)*$largeur+round($largeur/2)).&quot;,300' class='gris' /&gt;\n&quot;;
				echo &quot;&lt;line x1='&quot;.(($n-2)*$largeur+round($largeur/2)).&quot;' y1='&quot;.(300-$hauteur_moyenne_prec).&quot;' x2='&quot;.(($n-1)*$largeur+round($largeur/2)).&quot;' y2='&quot;.(300-$hauteur_moyenne).&quot;' class='trait' /&gt;\n&quot;;
			} else {
				echo &quot;&lt;polygon points = '0,300 0,&quot;.(300-$hauteur_moyenne).&quot; &quot;.(($n-1)*$largeur+round($largeur/2)).&quot;,&quot;.(300-$hauteur_moyenne).&quot;  &quot;.(($n-1)*$largeur+round($largeur/2)).&quot;,300' class='gris' /&gt;\n&quot;;
				echo &quot;&lt;line x1='0' y1='&quot;.(300-$hauteur_moyenne).&quot;' x2='&quot;.(($n-1)*$largeur+round($largeur/2)).&quot;' y2='&quot;.(300-$hauteur_moyenne).&quot;' class='trait' /&gt;\n&quot;;
			}
	
			$hauteur_moyenne_prec = $hauteur_moyenne;
			
				$jour_prec = $key;
				$val_prec = $value;
			}
		}


		echo &quot;&lt;rect x='0' y='0' width='&quot;.round($largeur*$nb_jours/$agreg).&quot;' height='300' style='stroke-width: 1px; stroke: black; fill: blue; fill-opacity: 0; '/&gt;\n&quot;;	

		echo &quot; &lt;text x='&quot;.(round($largeur*$nb_jours/$agreg)+3).&quot;' y='300' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' &gt;&quot;;
		echo &quot;0&quot;;
		echo &quot;&lt;/text&gt;\n&quot;;
		echo &quot; &lt;text x='&quot;.(round($largeur*$nb_jours/$agreg)+3).&quot;' y='228' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' &gt;&quot;;
		echo round($maxgraph/4);
		echo &quot;&lt;/text&gt;\n&quot;;
		echo &quot; &lt;text x='&quot;.(round($largeur*$nb_jours/$agreg)+3).&quot;' y='153' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' &gt;&quot;;
		echo round($maxgraph/2);
		echo &quot;&lt;/text&gt;\n&quot;;
		echo &quot; &lt;text x='&quot;.(round($largeur*$nb_jours/$agreg)+3).&quot;' y='78' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' &gt;&quot;;
		echo round(3*$maxgraph/4);
		echo &quot;&lt;/text&gt;\n&quot;;
		echo &quot; &lt;text x='&quot;.(round($largeur*$nb_jours/$agreg)+3).&quot;' y='8' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' &gt;&quot;;
		echo round($maxgraph);
		echo &quot;&lt;/text&gt;\n&quot;;

		$gauche_prec = -50;
		for ($jour = $date_debut; $jour &lt;= $date_today; $jour = $jour + (24*3600)) {
			$ce_jour = date(&quot;d&quot;, $jour);
			
			if ($ce_jour == &quot;1&quot;) {
				$afficher = nom_mois(date(&quot;Y-m-d&quot;, $jour));
				if (date(&quot;m&quot;, $jour) == 1) $afficher = &quot;&lt;b&gt;&quot;.annee(date(&quot;Y-m-d&quot;, $jour)).&quot;&lt;/b&gt;&quot;;
				
			
				$gauche = ($jour - $date_debut) * $largeur / ((24*3600)*$agreg);
				
				if ($gauche - $gauche_prec &gt;= 40 OR date(&quot;m&quot;, $jour) == 1) {									
					//echo &quot;&lt;div class='arial0' style='border-$spip_lang_left: 1px solid black; padding-$spip_lang_left: 2px; padding-top: 3px; position: absolute; $spip_lang_left: &quot;.$gauche.&quot;px; top: -1px;'&gt;&quot;.$afficher.&quot;&lt;/div&gt;&quot;;

					echo &quot;&lt;rect x='$gauche' y='300' width='1' height='10' style='fill: black;'/&gt;\n&quot;;
					echo &quot; &lt;text x='&quot;.($gauche+3).&quot;' y='308' font-family='Verdana, helvetica, sans-serif, sans' font-size='8' fill='black' &gt;&quot;;
					echo filtrer_ical($afficher);
					echo &quot;&lt;/text&gt;\n&quot;;


					$gauche_prec = $gauche;
					
					
					
				}
			}
		}


	}
	

		
?&gt;


&lt;/svg&gt;

&lt;?php

?&gt;
--- NEW FILE: js_menu_rubriques.php ---
&lt;?php

include_once(&quot;inc.php3&quot;);

// Gestion d'expiration de ce jaja
$expire = $date + 3600*24;

$headers_only = http_last_modified($expire);

$date = gmdate(&quot;D, d M Y H:i:s&quot;, $date);
$expire = gmdate(&quot;D, d M Y H:i:s&quot;, $expire);
@Header (&quot;Content-Type: text/javascript&quot;);
if ($headers_only) exit;
@Header (&quot;Last-Modified: &quot;.$date.&quot; GMT&quot;);
@Header (&quot;Expires: &quot;.$expire.&quot; GMT&quot;);

function extraire_article($id_p) {
	if (array_key_exists($id_p, $GLOBALS['db_art_cache'])) {
		return $GLOBALS['db_art_cache'][$id_p];
	} else {
		return array();
	}
}

function gen_liste_rubriques() {
	$q = &quot;SELECT id_rubrique, id_parent, titre 
		FROM spip_rubriques 
		ORDER BY id_parent, titre&quot;;

	$res = spip_query($q);

	$GLOBALS['db_art_cache'] = array();
	if (spip_num_rows($res) &gt; 0) { 
		while ($row = spip_fetch_array($res)) {
			$parent = $row['id_parent'];
			$id = $row['id_rubrique'];
			$GLOBALS['db_art_cache'][$parent][$id] = $row['titre'];
		}
	}
}


function bandeau_menu() {
	global $spip_ecran;

	gen_liste_rubriques(); 
	$arr_low = extraire_article(0);

	$i = sizeof($arr_low);

	$total_lignes = $i;
	if ($spip_ecran == &quot;large&quot;) $max_lignes = 20;
	else $max_lignes = 15;

	$nb_col = ceil($total_lignes / $max_lignes);
	if ($nb_col &lt; 1) $nb_col = 1;
	$max_lignes = ceil($total_lignes / $nb_col);

	$count_lignes = 0;

	if ($i &gt; 0) {
		$ret = &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
		$ret .= &quot;&lt;div class='bandeau_rubriques' style='z-index: 1;'&gt;&quot;;
		foreach( $arr_low as $id_rubrique =&gt; $titre_rubrique) {

			if ($count_lignes == $max_lignes) {
				$count_lignes = 0;
				$ret .= &quot;&lt;/div&gt;&lt;/td&gt;&lt;td valign='top' width='200'&gt;&lt;div&gt;&nbsp;&lt;/div&gt;&lt;div class='bandeau_rubriques' style='z-index: 1;'&gt;&quot;;
			}
			$count_lignes ++;

			$titre_rubrique = supprimer_numero(typo($titre_rubrique));
			$ret .= bandeau_rubrique($id_rubrique, $titre_rubrique, $i);
			$i = $i - 1;
		}
		$ret .= &quot;&lt;/div&gt;&quot;;
	}
	unset($GLOBALS['db_art_cache']); // On lib&#232;re la m&#233;moire
	return $ret;
}


function bandeau_rubrique($id_rubrique, $titre_rubrique, $z = 1) {
	global $zdecal;
	global $spip_ecran, $spip_display;
	global $spip_lang, $spip_lang_rtl, $spip_lang_left, $spip_lang_right;

	$titre_rubrique = preg_replace(',[\x00-\x1f]+,', ' ', $titre_rubrique);

	// Calcul du nombre max de sous-menus
	$zdecal = $zdecal + 1;
	if ($spip_ecran == &quot;large&quot;) $zmax = 8;
	else $zmax= 6;
	
	// Limiter volontairement le nombre de sous-menus 
	$zmax = 6;

	if ($zindex &lt; 1) $zindex = 1;
	if ($zdecal == 1) $image = &quot;secteur-12.gif&quot;;
	//else $image = &quot;rubrique-12.gif&quot;;
	else $image = '';
	
	if (strlen($image) &gt; 1) $image = &quot; style='background-image:url(&quot; . _DIR_IMG_PACK . $image .&quot;);'&quot;;


	$arr_rub = extraire_article($id_rubrique);

	$i = sizeof($arr_rub);
	if ($i &gt; 0 AND $zdecal &lt; $zmax) {
		$ret .= '&lt;div class=\&quot;pos_r\&quot; style=\&quot;z-index: '.$z.';\&quot; onMouseOver=\&quot;montrer(\'b_'.$id_rubrique.'\');\&quot; onMouseOut=\&quot;cacher(\'b_'.$id_rubrique.'\');\&quot;&gt;';
		$ret .= '&lt;div class=\&quot;brt\&quot;&gt;&lt;a href=\&quot;naviguer.php3?id_rubrique='.$id_rubrique.'\&quot; class=\&quot;bandeau_rub\&quot;'.$image.'&gt;'.addslashes(supprimer_tags($titre_rubrique)).'&lt;/a&gt;&lt;/div&gt;';
		$ret .= '&lt;div class=\&quot;bandeau_rub\&quot; style=\&quot;z-index: '.($z+1).';\&quot; id=\&quot;b_'.$id_rubrique.'\&quot;&gt;';
		foreach( $arr_rub as $id_rub =&gt; $titre_rub) {
			$titre_rub = supprimer_numero(typo($titre_rub));
			$ret .= bandeau_rubrique($id_rub, $titre_rub, ($z+$i));
			$i = $i - 1;
		}
		$ret .= &quot;&lt;/div&gt;&lt;/div&gt;&quot;;
	} else {
		$ret .= '&lt;div&gt;&lt;a href=\&quot;naviguer.php3?id_rubrique='.$id_rubrique.'\&quot; class=\&quot;bandeau_rub\&quot;'.$image.'&gt;'.addslashes(supprimer_tags($titre_rubrique)).'&lt;/a&gt;&lt;/div&gt;';
	}
	$zdecal = $zdecal - 1;
	return $ret;
}

echo &quot;document.write(\&quot;&quot;;
echo &quot;&lt;table&gt;&lt;tr&gt;&lt;td valign='top' width='200'&gt;&quot;;
echo bandeau_menu();
echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
echo &quot;\&quot;);\n&quot;;

?&gt;

--- NEW FILE: admin_repair.php3 ---
&lt;?php

include (&quot;inc_version.php3&quot;);

include_ecrire (&quot;inc_admin.php3&quot;);
include_ecrire (&quot;inc_texte.php3&quot;);
include_ecrire (&quot;inc_presentation.php3&quot;);


/*
 * REMARQUE IMPORTANTE : SECURITE
 * Ce systeme de reparation doit pouvoir fonctionner meme si
 * la table spip_auteurs est en panne : on n'appelle donc pas
 * inc_auth ; seule l'authentification ftp est exigee
 *
 */

// include_ecrire (&quot;inc_auth.php3&quot;);
$connect_statut = '0minirezo';


function verifier_base() {
	if (! $res1= spip_query(&quot;SHOW TABLES&quot;))
		return false;

	while ($tab = spip_fetch_array($res1)) {
		echo &quot;&lt;p&gt;&lt;b&gt;&quot;.$tab[0].&quot;&lt;/b&gt; &quot;;

		if (!($result_repair = spip_query(&quot;REPAIR TABLE &quot;.$tab[0])))
			return false;

		if (!($result = spip_query(&quot;SELECT COUNT(*) FROM &quot;.$tab[0])))
			return false;

		list($count) = spip_fetch_array($result);
		if ($count&gt;1)
			echo &quot;(&quot;._T('texte_compte_elements', array('count' =&gt; $count)).&quot;)\n&quot;;
		else if ($count==1)
			echo &quot;(&quot;._T('texte_compte_element', array('count' =&gt; $count)).&quot;)\n&quot;;
		else
			echo &quot;(&quot;._T('texte_vide').&quot;)\n&quot;;

		$row = spip_fetch_array($result_repair);
		$ok = ($row[3] == 'OK');

		if (!$ok)
			echo &quot;&lt;pre&gt;&lt;font color='red'&gt;&lt;b&gt;&quot;.htmlentities(join(&quot;\n&quot;, $row)).&quot;&lt;/b&gt;&lt;/font&gt;&lt;/pre&gt;\n&quot;;
		else
			echo &quot; &quot;._T('texte_table_ok').&quot;&lt;br&gt;\n&quot;;

	}

	return true;
}

// verifier version MySQL
if (! $res1= spip_query(&quot;SELECT version()&quot;))
	$message = _T('avis_erreur_connexion_mysql');
else {
	$tab = spip_fetch_array($res1);
	$version_mysql = $tab[0];
	if ($version_mysql &lt; '3.23.14')
		$message = _T('avis_version_mysql', array('version_mysql' =&gt; $version_mysql));
	else {
		$message = _T('texte_requetes_echouent');
		$ok = true;
	}
}

$action = _T('texte_tenter_reparation');

if ($ok) {
	debut_admin($action, $message);

	install_debut_html(_T('texte_tentative_recuperation'));


	debut_cadre_relief();
	if (! verifier_base())
		echo &quot;&lt;br&gt;&lt;br&gt;&lt;font color='red'&gt;&lt;b&gt;&lt;tt&gt;&quot;._T('avis_erreur_mysql').' '.spip_sql_errno().': '.spip_sql_error() .&quot;&lt;/tt&gt;&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;br&gt;\n&quot;;
	fin_cadre_relief();
	echo &quot;&lt;br&gt;&quot;;

	install_fin_html();

	fin_admin($action);
}
else {
	install_debut_html(_T('titre_reparation'));
	echo &quot;&lt;p&gt;$message&quot;;
	install_fin_html();
}


?&gt;

--- NEW FILE: gnu_lgpl_fr.txt ---
		  GNU LESSER GENERAL PUBLIC LICENSE
		       Version 2.1, February 1999

 Copyright (C) 1991, 1999 Free Software Foundation, Inc.
     59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

[This is the first released version of the Lesser GPL.  It also counts
 as the successor of the GNU Library Public License, version 2, hence
 the version number 2.1.]

			    Preamble

  The licenses for most software are designed to take away your
freedom to share and change it.  By contrast, the GNU General Public
Licenses are intended to guarantee your freedom to share and change
free software--to make sure the software is free for all its users.

  This license, the Lesser General Public License, applies to some
specially designated software packages--typically libraries--of the
Free Software Foundation and other authors who decide to use it.  You
can use it too, but we suggest you first think carefully about whether
this license or the ordinary General Public License is the better
strategy to use in any particular case, based on the explanations below.

  When we speak of free software, we are referring to freedom of use,
not price.  Our General Public Licenses are designed to make sure that
you have the freedom to distribute copies of free software (and charge
for this service if you wish); that you receive source code or can get
it if you want it; that you can change the software and use pieces of
it in new free programs; and that you are informed that you can do
these things.

  To protect your rights, we need to make restrictions that forbid
distributors to deny you these rights or to ask you to surrender these
rights.  These restrictions translate to certain responsibilities for
you if you distribute copies of the library or if you modify it.

  For example, if you distribute copies of the library, whether gratis
or for a fee, you must give the recipients all the rights that we gave
you.  You must make sure that they, too, receive or can get the source
code.  If you link other code with the library, you must provide
complete object files to the recipients, so that they can relink them
with the library after making changes to the library and recompiling
it.  And you must show them these terms so they know their rights.

  We protect your rights with a two-step method: (1) we copyright the
library, and (2) we offer you this license, which gives you legal
permission to copy, distribute and/or modify the library.

  To protect each distributor, we want to make it very clear that
there is no warranty for the free library.  Also, if the library is
modified by someone else and passed on, the recipients should know
that what they have is not the original version, so that the original
author's reputation will not be affected by problems that might be
introduced by others.

  Finally, software patents pose a constant threat to the existence of
any free program.  We wish to make sure that a company cannot
effectively restrict the users of a free program by obtaining a
restrictive license from a patent holder.  Therefore, we insist that
any patent license obtained for a version of the library must be
consistent with the full freedom of use specified in this license.

  Most GNU software, including some libraries, is covered by the
ordinary GNU General Public License.  This license, the GNU Lesser
General Public License, applies to certain designated libraries, and
is quite different from the ordinary General Public License.  We use
this license for certain libraries in order to permit linking those
libraries into non-free programs.

  When a program is linked with a library, whether statically or using
a shared library, the combination of the two is legally speaking a
combined work, a derivative of the original library.  The ordinary
General Public License therefore permits such linking only if the
entire combination fits its criteria of freedom.  The Lesser General
Public License permits more lax criteria for linking other code with
the library.

  We call this license the &quot;Lesser&quot; General Public License because it
does Less to protect the user's freedom than the ordinary General
Public License.  It also provides other free software developers Less
of an advantage over competing non-free programs.  These disadvantages
are the reason we use the ordinary General Public License for many
libraries.  However, the Lesser license provides advantages in certain
special circumstances.

  For example, on rare occasions, there may be a special need to
encourage the widest possible use of a certain library, so that it becomes
a de-facto standard.  To achieve this, non-free programs must be
allowed to use the library.  A more frequent case is that a free
library does the same job as widely used non-free libraries.  In this
case, there is little to gain by limiting the free library to free
software only, so we use the Lesser General Public License.

  In other cases, permission to use a particular library in non-free
programs enables a greater number of people to use a large body of
free software.  For example, permission to use the GNU C Library in
non-free programs enables many more people to use the whole GNU
operating system, as well as its variant, the GNU/Linux operating
system.

  Although the Lesser General Public License is Less protective of the
users' freedom, it does ensure that the user of a program that is
linked with the Library has the freedom and the wherewithal to run
that program using a modified version of the Library.

  The precise terms and conditions for copying, distribution and
modification follow.  Pay close attention to the difference between a
&quot;work based on the library&quot; and a &quot;work that uses the library&quot;.  The
former contains code derived from the library, whereas the latter must
be combined with the library in order to run.

		  GNU LESSER GENERAL PUBLIC LICENSE
   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION

  0. This License Agreement applies to any software library or other
program which contains a notice placed by the copyright holder or
other authorized party saying it may be distributed under the terms of
this Lesser General Public License (also called &quot;this License&quot;).
Each licensee is addressed as &quot;you&quot;.

  A &quot;library&quot; means a collection of software functions and/or data
prepared so as to be conveniently linked with application programs
(which use some of those functions and data) to form executables.

  The &quot;Library&quot;, below, refers to any such software library or work
which has been distributed under these terms.  A &quot;work based on the
Library&quot; means either the Library or any derivative work under
copyright law: that is to say, a work containing the Library or a
portion of it, either verbatim or with modifications and/or translated
straightforwardly into another language.  (Hereinafter, translation is
included without limitation in the term &quot;modification&quot;.)

  &quot;Source code&quot; for a work means the preferred form of the work for
making modifications to it.  For a library, complete source code means
all the source code for all modules it contains, plus any associated
interface definition files, plus the scripts used to control compilation
and installation of the library.

  Activities other than copying, distribution and modification are not
covered by this License; they are outside its scope.  The act of
running a program using the Library is not restricted, and output from
such a program is covered only if its contents constitute a work based
on the Library (independent of the use of the Library in a tool for
writing it).  Whether that is true depends on what the Library does
and what the program that uses the Library does.
  
  1. You may copy and distribute verbatim copies of the Library's
complete source code as you receive it, in any medium, provided that
you conspicuously and appropriately publish on each copy an
appropriate copyright notice and disclaimer of warranty; keep intact
all the notices that refer to this License and to the absence of any
warranty; and distribute a copy of this License along with the
Library.

  You may charge a fee for the physical act of transferring a copy,
and you may at your option offer warranty protection in exchange for a
fee.

  2. You may modify your copy or copies of the Library or any portion
of it, thus forming a work based on the Library, and copy and
distribute such modifications or work under the terms of Section 1
above, provided that you also meet all of these conditions:

    a) The modified work must itself be a software library.

    b) You must cause the files modified to carry prominent notices
    stating that you changed the files and the date of any change.

    c) You must cause the whole of the work to be licensed at no
    charge to all third parties under the terms of this License.

    d) If a facility in the modified Library refers to a function or a
    table of data to be supplied by an application program that uses
    the facility, other than as an argument passed when the facility
    is invoked, then you must make a good faith effort to ensure that,
    in the event an application does not supply such function or
    table, the facility still operates, and performs whatever part of
    its purpose remains meaningful.

    (For example, a function in a library to compute square roots has
    a purpose that is entirely well-defined independent of the
    application.  Therefore, Subsection 2d requires that any
    application-supplied function or table used by this function must
    be optional: if the application does not supply it, the square
    root function must still compute square roots.)

These requirements apply to the modified work as a whole.  If
identifiable sections of that work are not derived from the Library,
and can be reasonably considered independent and separate works in
themselves, then this License, and its terms, do not apply to those
sections when you distribute them as separate works.  But when you
distribute the same sections as part of a whole which is a work based
on the Library, the distribution of the whole must be on the terms of
this License, whose permissions for other licensees extend to the
entire whole, and thus to each and every part regardless of who wrote
it.

Thus, it is not the intent of this section to claim rights or contest
your rights to work written entirely by you; rather, the intent is to
exercise the right to control the distribution of derivative or
collective works based on the Library.

In addition, mere aggregation of another work not based on the Library
with the Library (or with a work based on the Library) on a volume of
a storage or distribution medium does not bring the other work under
the scope of this License.

  3. You may opt to apply the terms of the ordinary GNU General Public
License instead of this License to a given copy of the Library.  To do
this, you must alter all the notices that refer to this License, so
that they refer to the ordinary GNU General Public License, version 2,
instead of to this License.  (If a newer version than version 2 of the
ordinary GNU General Public License has appeared, then you can specify
that version instead if you wish.)  Do not make any other change in
these notices.

  Once this change is made in a given copy, it is irreversible for
that copy, so the ordinary GNU General Public License applies to all
subsequent copies and derivative works made from that copy.

  This option is useful when you wish to copy part of the code of
the Library into a program that is not a library.

  4. You may copy and distribute the Library (or a portion or
derivative of it, under Section 2) in object code or executable form
under the terms of Sections 1 and 2 above provided that you accompany
it with the complete corresponding machine-readable source code, which
must be distributed under the terms of Sections 1 and 2 above on a
medium customarily used for software interchange.

  If distribution of object code is made by offering access to copy
from a designated place, then offering equivalent access to copy the
source code from the same place satisfies the requirement to
distribute the source code, even though third parties are not
compelled to copy the source along with the object code.

  5. A program that contains no derivative of any portion of the
Library, but is designed to work with the Library by being compiled or
linked with it, is called a &quot;work that uses the Library&quot;.  Such a
work, in isolation, is not a derivative work of the Library, and
therefore falls outside the scope of this License.

  However, linking a &quot;work that uses the Library&quot; with the Library
creates an executable that is a derivative of the Library (because it
contains portions of the Library), rather than a &quot;work that uses the
library&quot;.  The executable is therefore covered by this License.
Section 6 states terms for distribution of such executables.

  When a &quot;work that uses the Library&quot; uses material from a header file
that is part of the Library, the object code for the work may be a
derivative work of the Library even though the source code is not.
Whether this is true is especially significant if the work can be
linked without the Library, or if the work is itself a library.  The
threshold for this to be true is not precisely defined by law.

  If such an object file uses only numerical parameters, data
structure layouts and accessors, and small macros and small inline
functions (ten lines or less in length), then the use of the object
file is unrestricted, regardless of whether it is legally a derivative
work.  (Executables containing this object code plus portions of the
Library will still fall under Section 6.)

  Otherwise, if the work is a derivative of the Library, you may
distribute the object code for the work under the terms of Section 6.
Any executables containing that work also fall under Section 6,
whether or not they are linked directly with the Library itself.

  6. As an exception to the Sections above, you may also combine or
link a &quot;work that uses the Library&quot; with the Library to produce a
work containing portions of the Library, and distribute that work
under terms of your choice, provided that the terms permit
modification of the work for the customer's own use and reverse
engineering for debugging such modifications.

  You must give prominent notice with each copy of the work that the
Library is used in it and that the Library and its use are covered by
this License.  You must supply a copy of this License.  If the work
during execution displays copyright notices, you must include the
copyright notice for the Library among them, as well as a reference
directing the user to the copy of this License.  Also, you must do one
of these things:

    a) Accompany the work with the complete corresponding
    machine-readable source code for the Library including whatever
    changes were used in the work (which must be distributed under
    Sections 1 and 2 above); and, if the work is an executable linked
    with the Library, with the complete machine-readable &quot;work that
    uses the Library&quot;, as object code and/or source code, so that the
    user can modify the Library and then relink to produce a modified
    executable containing the modified Library.  (It is understood
    that the user who changes the contents of definitions files in the
    Library will not necessarily be able to recompile the application
    to use the modified definitions.)

    b) Use a suitable shared library mechanism for linking with the
    Library.  A suitable mechanism is one that (1) uses at run time a
    copy of the library already present on the user's computer system,
    rather than copying library functions into the executable, and (2)
    will operate properly with a modified version of the library, if
    the user installs one, as long as the modified version is
    interface-compatible with the version that the work was made with.

    c) Accompany the work with a written offer, valid for at
    least three years, to give the same user the materials
    specified in Subsection 6a, above, for a charge no more
    than the cost of performing this distribution.

    d) If distribution of the work is made by offering access to copy
    from a designated place, offer equivalent access to copy the above
    specified materials from the same place.

    e) Verify that the user has already received a copy of these
    materials or that you have already sent this user a copy.

  For an executable, the required form of the &quot;work that uses the
Library&quot; must include any data and utility programs needed for
reproducing the executable from it.  However, as a special exception,
the materials to be distributed need not include anything that is
normally distributed (in either source or binary form) with the major
components (compiler, kernel, and so on) of the operating system on
which the executable runs, unless that component itself accompanies
the executable.

  It may happen that this requirement contradicts the license
restrictions of other proprietary libraries that do not normally
accompany the operating system.  Such a contradiction means you cannot
use both them and the Library together in an executable that you
distribute.

  7. You may place library facilities that are a work based on the
Library side-by-side in a single library together with other library
facilities not covered by this License, and distribute such a combined
library, provided that the separate distribution of the work based on
the Library and of the other library facilities is otherwise
permitted, and provided that you do these two things:

    a) Accompany the combined library with a copy of the same work
    based on the Library, uncombined with any other library
    facilities.  This must be distributed under the terms of the
    Sections above.

    b) Give prominent notice with the combined library of the fact
    that part of it is a work based on the Library, and explaining
    where to find the accompanying uncombined form of the same work.

  8. You may not copy, modify, sublicense, link with, or distribute
the Library except as expressly provided under this License.  Any
attempt otherwise to copy, modify, sublicense, link with, or
distribute the Library is void, and will automatically terminate your
rights under this License.  However, parties who have received copies,
or rights, from you under this License will not have their licenses
terminated so long as such parties remain in full compliance.

  9. You are not required to accept this License, since you have not
signed it.  However, nothing else grants you permission to modify or
distribute the Library or its derivative works.  These actions are
prohibited by law if you do not accept this License.  Therefore, by
modifying or distributing the Library (or any work based on the
Library), you indicate your acceptance of this License to do so, and
all its terms and conditions for copying, distributing or modifying
the Library or works based on it.

  10. Each time you redistribute the Library (or any work based on the
Library), the recipient automatically receives a license from the
original licensor to copy, distribute, link with or modify the Library
subject to these terms and conditions.  You may not impose any further
restrictions on the recipients' exercise of the rights granted herein.
You are not responsible for enforcing compliance by third parties with
this License.

  11. If, as a consequence of a court judgment or allegation of patent
infringement or for any other reason (not limited to patent issues),
conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot
distribute so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you
may not distribute the Library at all.  For example, if a patent
license would not permit royalty-free redistribution of the Library by
all those who receive copies directly or indirectly through you, then
the only way you could satisfy both it and this License would be to
refrain entirely from distribution of the Library.

If any portion of this section is held invalid or unenforceable under any
particular circumstance, the balance of the section is intended to apply,
and the section as a whole is intended to apply in other circumstances.

It is not the purpose of this section to induce you to infringe any
patents or other property right claims or to contest validity of any
such claims; this section has the sole purpose of protecting the
integrity of the free software distribution system which is
implemented by public license practices.  Many people have made
generous contributions to the wide range of software distributed
through that system in reliance on consistent application of that
system; it is up to the author/donor to decide if he or she is willing
to distribute software through any other system and a licensee cannot
impose that choice.

This section is intended to make thoroughly clear what is believed to
be a consequence of the rest of this License.

  12. If the distribution and/or use of the Library is restricted in
certain countries either by patents or by copyrighted interfaces, the
original copyright holder who places the Library under this License may add
an explicit geographical distribution limitation excluding those countries,
so that distribution is permitted only in or among countries not thus
excluded.  In such case, this License incorporates the limitation as if
written in the body of this License.

  13. The Free Software Foundation may publish revised and/or new
versions of the Lesser General Public License from time to time.
Such new versions will be similar in spirit to the present version,
but may differ in detail to address new problems or concerns.

Each version is given a distinguishing version number.  If the Library
specifies a version number of this License which applies to it and
&quot;any later version&quot;, you have the option of following the terms and
conditions either of that version or of any later version published by
the Free Software Foundation.  If the Library does not specify a
license version number, you may choose any version ever published by
the Free Software Foundation.

  14. If you wish to incorporate parts of the Library into other free
programs whose distribution conditions are incompatible with these,
write to the author to ask for permission.  For software which is
copyrighted by the Free Software Foundation, write to the Free
Software Foundation; we sometimes make exceptions for this.  Our
decision will be guided by the two goals of preserving the free status
of all derivatives of our free software and of promoting the sharing
and reuse of software generally.

			    NO WARRANTY

  15. BECAUSE THE LIBRARY IS LICENSED FREE OF CHARGE, THERE IS NO
WARRANTY FOR THE LIBRARY, TO THE EXTENT PERMITTED BY APPLICABLE LAW.
EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR
OTHER PARTIES PROVIDE THE LIBRARY &quot;AS IS&quot; WITHOUT WARRANTY OF ANY
KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE
LIBRARY IS WITH YOU.  SHOULD THE LIBRARY PROVE DEFECTIVE, YOU ASSUME
THE COST OF ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

  16. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN
WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY
AND/OR REDISTRIBUTE THE LIBRARY AS PERMITTED ABOVE, BE LIABLE TO YOU
FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR
CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE
LIBRARY (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING
RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A
FAILURE OF THE LIBRARY TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF
SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
DAMAGES.

		     END OF TERMS AND CONDITIONS

           How to Apply These Terms to Your New Libraries

  If you develop a new library, and you want it to be of the greatest
possible use to the public, we recommend making it free software that
everyone can redistribute and change.  You can do so by permitting
redistribution under these terms (or, alternatively, under the terms of the
ordinary General Public License).

  To apply these terms, attach the following notices to the library.  It is
safest to attach them to the start of each source file to most effectively
convey the exclusion of warranty; and each file should have at least the
&quot;copyright&quot; line and a pointer to where the full notice is found.

    &lt;one line to give the library's name and a brief idea of what it does.&gt;
    Copyright (C) &lt;year&gt;  &lt;name of author&gt;

    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Lesser General Public
    License as published by the Free Software Foundation; either
    version 2.1 of the License, or (at your option) any later version.

    This library is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public
    License along with this library; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

Also add information on how to contact you by electronic and paper mail.

You should also get your employer (if you work as a programmer) or your
school, if any, to sign a &quot;copyright disclaimer&quot; for the library, if
necessary.  Here is a sample; alter the names:

  Yoyodyne, Inc., hereby disclaims all copyright interest in the
  library `Frob' (a library for tweaking knobs) written by James Random Hacker.

  &lt;signature of Ty Coon&gt;, 1 April 1990
  Ty Coon, President of Vice

That's all there is to it!



--- NEW FILE: inc_meta.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_META&quot;)) return;
define(&quot;_ECRIRE_INC_META&quot;, &quot;1&quot;);

function lire_metas() {
	global $meta, $meta_maj;

	$meta = '';
	$meta_maj = '';
	$query = 'SELECT * FROM spip_meta';
	$result = spip_query($query);
	while ($row = spip_fetch_array($result)) {
		$nom = $row['nom'];
		$meta[$nom] = $row['valeur'];
		$meta_maj[$nom] = $row['maj'];
	}
}

function ecrire_meta($nom, $valeur) {
	$valeur = addslashes($valeur);
	spip_query(&quot;REPLACE spip_meta (nom, valeur) VALUES ('$nom', '$valeur')&quot;);
}

function effacer_meta($nom) {
	spip_query(&quot;DELETE FROM spip_meta WHERE nom='$nom'&quot;);
}

//
// Mettre a jour le fichier cache des metas
//
// Ne pas oublier d'appeler cette fonction apres ecrire_meta() et effacer_meta() !
//
function ecrire_metas() {
	global $meta, $meta_maj;

	lire_metas();

	$s = '';

	if ($meta) {
		reset($meta);
		while (list($key, $val) = each($meta)) {
			$key = addslashes($key);
			$val = ereg_replace(&quot;([\\\\'])&quot;, &quot;\\\\1&quot;, $val);
			$s .= &quot;\$GLOBALS['meta']['$key'] = '$val';\n&quot;;
		}
		$s .= &quot;\n&quot;;
	}
	if ($meta_maj) {
		reset($meta_maj);
		while (list($key, $val) = each($meta_maj)) {
			$key = addslashes($key);
			$s .= &quot;\$GLOBALS['meta_maj']['$key'] = '$val';\n&quot;;
		}
		$s .= &quot;\n&quot;;
	}

	if ($s) {
		$ok = ecrire_fichier (_DIR_SESSIONS . 'meta_cache.php3',
				      '&lt;'.'?php

if (defined(&quot;_DATA_META_CACHE&quot;)) return;
define(&quot;_DATA_META_CACHE&quot;, &quot;1&quot;);
' 
				      . $s . '?'.'&gt;');
		if (!$ok &amp;&amp; $GLOBALS['connect_statut'] == '0minirezo')
		  echo &quot;&lt;h4 font color=red&gt;&quot;._T('texte_inc_meta_1').&quot; &lt;a href='../spip_test_dirs.php3'&gt;&quot;._T('texte_inc_meta_2').&quot;&lt;/a&gt; &quot;._T('texte_inc_meta_3').&quot;&nbsp;&lt;/h4&gt;\n&quot;;
	}
}

// On force lire_metas() si le cache n'a pas ete utilise
if (!isset($GLOBALS['meta']))
	lire_metas();

?&gt;

--- NEW FILE: messagerie.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_acces.php3&quot;);
include_ecrire (&quot;inc_calendrier.php&quot;);

if ($supp_dest) {
	spip_query(&quot;DELETE FROM spip_auteurs_messages WHERE id_message=$id_message AND id_auteur=$supp_dest&quot;);
}

if ($detruire_message) {
	spip_query(&quot;DELETE FROM spip_messages WHERE id_message=$detruire_message&quot;);
	spip_query(&quot;DELETE FROM spip_auteurs_messages WHERE id_message=$detruire_message&quot;);
	spip_query(&quot;DELETE FROM spip_forum WHERE id_message=$detruire_message&quot;);
}


debut_page(_T('titre_page_messagerie'), &quot;redacteurs&quot;, &quot;messagerie&quot;);

//barre_onglets(&quot;calendrier&quot;, &quot;messagerie&quot;);


debut_gauche(&quot;messagerie&quot;);


debut_boite_info();

echo _T('info_gauche_messagerie');

echo &quot;&lt;p&gt;&quot;.http_img_pack(&quot;m_envoi$spip_lang_rtl.gif&quot;, 'V', &quot;WIDTH='14' HEIGHT='7' BORDER='0'&quot;) .' ' . _T('info_symbole_vert');

echo aide (&quot;messut&quot;);

echo &quot;&lt;p&gt;&quot;.http_img_pack(&quot;m_envoi_bleu$spip_lang_rtl.gif&quot;, 'B', &quot;WIDTH='14' HEIGHT='7' BORDER='0'&quot;) .' ' . _T('info_symbole_bleu');

echo aide (&quot;messpense&quot;);

echo &quot;&lt;p&gt;&quot;.http_img_pack(&quot;m_envoi_jaune$spip_lang_rtl.gif&quot;, 'J', &quot;WIDTH='14' HEIGHT='7' BORDER='0'&quot;) .' ' . _T('info_symbole_jaune');



fin_boite_info();


creer_colonne_droite();

debut_cadre_relief(&quot;messagerie-24.gif&quot;);
		icone_horizontale(_T('lien_nouvea_pense_bete'),&quot;message_edit.php3?new=oui&amp;type=pb&quot;, &quot;pense-bete.gif&quot;);
		icone_horizontale(_T('lien_nouveau_message'),&quot;message_edit.php3?new=oui&amp;type=normal&quot;, &quot;message.gif&quot;);
		
		if ($connect_statut == &quot;0minirezo&quot;) {
			icone_horizontale(_T('lien_nouvelle_annonce'),&quot;message_edit.php3?new=oui&amp;type=affich&quot;, &quot;annonce.gif&quot;);
		}
fin_cadre_relief();



echo	http_calendrier_ical($connect_id_auteur);


debut_droite(&quot;messagerie&quot;);




$messages_vus = '';


$query_message = &quot;SELECT * FROM spip_messages AS messages WHERE id_auteur=$connect_id_auteur AND statut='publie' AND type='pb' AND (date_fin &gt; DATE_SUB(NOW(), INTERVAL 1 DAY) OR rv != 'oui')&quot;;
afficher_messages(_T('infos_vos_pense_bete'), $query_message, false, true);


$query_message = &quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
	&quot;WHERE lien.id_auteur=$connect_id_auteur AND vu='non' &quot;.
	&quot;AND statut='publie' AND lien.id_message=messages.id_message&quot;;
afficher_messages(_T('info_nouveaux_message'), $query_message, true, true);


$query_message = &quot;SELECT * FROM spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
	&quot;WHERE lien.id_auteur=$connect_id_auteur AND statut='publie' AND type='normal' AND lien.id_message=messages.id_message &quot;.
	&quot;AND (date_fin &gt; DATE_SUB(NOW(), INTERVAL 1 DAY) OR rv != 'oui')&quot;;
afficher_messages(_T('info_discussion_cours'), $query_message, true, false);


$query_message = &quot;SELECT * FROM spip_messages AS messages WHERE id_auteur=$connect_id_auteur AND statut='redac'&quot;;
afficher_messages(_T('info_message_en_redaction'), $query_message, true, false, false);



$query = &quot;SELECT auteurs.id_auteur, auteurs.nom, COUNT(*) AS total FROM spip_auteurs AS auteurs,  spip_auteurs_messages AS lien2, spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
	&quot;WHERE (lien.id_auteur = $connect_id_auteur AND lien.id_message = messages.id_message AND messages.statut = 'publie' AND (messages.rv != 'oui' OR messages.date_fin &gt; NOW() )) &quot;.
	&quot;AND (lien2.id_auteur = lien2.id_auteur AND lien2.id_message = messages.id_message AND lien2.id_auteur != $connect_id_auteur AND auteurs.id_auteur = lien2.id_auteur) &quot;.
	&quot;GROUP BY auteurs.id_auteur ORDER BY total DESC LIMIT 0,10&quot;;

$result = spip_query($query);
if (spip_num_rows($result) &gt; 0) {

	echo &quot;&lt;div style='height: 12px;'&gt;&lt;/div&gt;&quot;;
	echo &quot;&lt;div class='liste'&gt;&quot;;

	bandeau_titre_boite2(_T('info_principaux_correspondants'), &quot;redacteurs-24.gif&quot;, &quot;#333333&quot;, &quot;white&quot;);

	//echo &quot;&lt;div style='padding: 3px; background-color: $couleur_foncee; color: white;'&gt;&lt;b class='verdana2'&gt;&quot;._T('info_principaux_correspondants').&quot;&lt;/b&gt;&lt;/div&gt;&quot;;
	echo &quot;&lt;table width='100%' cellpadding='0' cellspacing='0'&gt;&quot;;
	echo &quot;&lt;tr&gt;&lt;td valign='top' width='50%'&gt;&quot;;
	while($row = spip_fetch_array($result)) {
		$count ++;
		if ($i == 1) {
			$bgcolor = &quot;white&quot;;
			$i = 0;
		} else {
			$bgcolor = $couleur_claire;
			$i = 1;
		}
		$id_auteur = $row['id_auteur'];
		$nom = typo($row[&quot;nom&quot;]);
		$total = $row[&quot;total&quot;];
		echo &quot;&lt;div class='tr_liste' onMouseOver=\&quot;changeclass(this,'tr_liste_over');\&quot; onMouseOut=\&quot;changeclass(this,'tr_liste');\&quot; style=' padding: 2px; padding-left: 10px; border-bottom: 1px solid #cccccc;'&gt;&lt;div class='verdana1'&gt;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;redac-12.gif' border='0'&gt; &lt;a href='auteurs_edit.php3?id_auteur=$id_auteur'&gt;$nom&lt;/a&gt; ($total)&lt;/div&gt;&lt;/div&gt;&quot;;
		if ($count == ceil(spip_num_rows($result)/2)) echo &quot;&lt;/td&gt;&lt;td valign='top' width='50%' style='background-color: #eeeeee;'&gt;&quot;;
	}
	echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
	echo &quot;&lt;/div&gt;&quot;;
}

$query_message = &quot;SELECT * FROM spip_messages AS messages WHERE id_auteur=$connect_id_auteur AND statut='publie' AND type='pb' AND rv!='oui'&quot;;
afficher_messages(_T('info_pense_bete_ancien'), $query_message, false, false, false);


$query_message = &quot;SELECT * FROM spip_messages AS messages WHERE statut='publie' AND type='affich' AND (date_fin &gt; DATE_SUB(NOW(), INTERVAL 1 DAY) OR rv != 'oui')&quot;;
afficher_messages(_T('info_tous_redacteurs'), $query_message, false, false, false);

fin_page();

?&gt;

--- NEW FILE: sites.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_logos.php3&quot;);
include_ecrire (&quot;inc_mots.php3&quot;);
include_ecrire (&quot;inc_sites.php3&quot;);
include_ecrire (&quot;inc_abstract_sql.php3&quot;);

$proposer_sites = lire_meta(&quot;proposer_sites&quot;);

function calculer_droits() {
	global $connect_statut, $statut, $id_rubrique, $id_rubrique_depart, $proposer_sites, $new;
	global $flag_editable, $flag_administrable;

	$flag_administrable = ($connect_statut == '0minirezo' AND acces_rubrique($id_rubrique));
	if ($id_rubrique_depart &gt; 0)
		 $flag_administrable &amp;= acces_rubrique($id_rubrique_depart);
	$flag_editable = ($flag_administrable OR ($proposer_sites &gt; 0 AND ($statut == 'prop' OR $new == 'oui')));
}


function my_sel($num,$tex,$comp){
	if ($num==$comp){
		echo &quot;&lt;OPTION VALUE='$num' SELECTED&gt;$tex\n&quot;;
	}else{
		echo &quot;&lt;OPTION VALUE='$num'&gt;$tex\n&quot;;
	}
}


function afficher_mois($mois){
	my_sel(&quot;00&quot;,_T('mois_non_connu'),$mois);
	my_sel(&quot;01&quot;,_T('date_mois_1'),$mois);
	my_sel(&quot;02&quot;,_T('date_mois_2'),$mois);
	my_sel(&quot;03&quot;,_T('date_mois_3'),$mois);
	my_sel(&quot;04&quot;,_T('date_mois_4'),$mois);
	my_sel(&quot;05&quot;,_T('date_mois_5'),$mois);
	my_sel(&quot;06&quot;,_T('date_mois_6'),$mois);
	my_sel(&quot;07&quot;,_T('date_mois_7'),$mois);
	my_sel(&quot;08&quot;,_T('date_mois_8'),$mois);
	my_sel(&quot;09&quot;,_T('date_mois_9'),$mois);
	my_sel(&quot;10&quot;,_T('date_mois_10'),$mois);
	my_sel(&quot;11&quot;,_T('date_mois_11'),$mois);
	my_sel(&quot;12&quot;,_T('date_mois_12'),$mois);
}

function afficher_annee($annee){
	// Cette ligne permettrait de faire des articles sans date de publication
	// my_sel(&quot;0000&quot;,&quot;n.c.&quot;,$annee);

	if($annee&lt;1996 AND $annee &lt;&gt; 0){
		echo &quot;&lt;OPTION VALUE='$annee' SELECTED&gt;$annee\n&quot;;
	}
	for($i=1996;$i&lt;date(Y)+2;$i++){
		my_sel($i,$i,$annee);
	}
}

function afficher_jour($jour){
	my_sel(&quot;00&quot;,_T('jour_non_connu_nc'),$jour);
	for($i=1;$i&lt;32;$i++){
		if ($i&lt;10){$aff=&quot;&nbsp;&quot;.$i;}else{$aff=$i;}
		my_sel($i,$aff,$jour);
	}
}


//
// Creation d'un site
//

if ($new == 'oui') {
	calculer_droits();

	if ($flag_editable) {
		$id_rubrique = intval($id_rubrique);
	
		$mydate = date(&quot;YmdHis&quot;, time() - 12 * 3600);
		$query = &quot;DELETE FROM spip_syndic WHERE (statut = 'refuse') &amp;&amp; (maj &lt; $mydate)&quot;;
		$result = spip_query($query);
	
		$moderation = (lire_meta(&quot;moderation_sites&quot;) == &quot;oui&quot;)? 'oui' : 'non';
	
		$id_syndic = spip_abstract_insert(&quot;syndic&quot;,
					 &quot;(nom_site, id_rubrique, id_secteur, date, date_syndic, statut, syndication, moderation)&quot;,
					 &quot;('&quot;._T('avis_site_introuvable').&quot;', $id_rubrique, $id_rubrique, NOW(), NOW(), 'refuse', 'non', '$moderation')&quot;);
	}
}

$query = &quot;SELECT statut, id_rubrique FROM spip_syndic WHERE id_syndic='$id_syndic'&quot;;
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$statut = $row[&quot;statut&quot;];
	$id_rubrique_depart = $row[&quot;id_rubrique&quot;];
	if (!$id_rubrique) $id_rubrique = $id_rubrique_depart;
}
if ($new == 'oui') $statut = 'prop';

calculer_droits();


//
// Analyse automatique d'une URL
//

if ($analyser_site == 'oui' AND $flag_editable) {

	$v = analyser_site($url);

	if ($v) {
		$nom_site = addslashes($v['nom_site']);
		$url_site = addslashes($v['url_site']);
		if (!$nom_site) $nom_site = $url_site;
		$url_syndic = addslashes($v['url_syndic']);
		$descriptif = addslashes($v['descriptif']);
		$syndication = $v[syndic] ? 'oui' : 'non';
		$query = &quot;UPDATE spip_syndic &quot;.
			&quot;SET nom_site='$nom_site', url_site='$url_site', url_syndic='$url_syndic', descriptif='$descriptif', syndication='$syndication', statut='$statut' &quot;.
			&quot;WHERE id_syndic=&quot;.intval($id_syndic);
		$result = spip_query($query);
		if ($syndication == 'oui') syndic_a_jour($id_syndic);
		$link = new Link('sites.php3');
		$link-&gt;addVar('id_syndic');
		$link-&gt;addVar('redirect');
		$redirect = $link-&gt;getUrl();
		$redirect_ok = 'oui';
	}
}


//
// Ajout et suppression syndication
//

if ($nouveau_statut AND $flag_administrable) {
	$statut = $nouveau_statut;
	$query = &quot;UPDATE spip_syndic SET statut='$statut' WHERE id_syndic=&quot;.intval($id_syndic);
	$result = spip_query($query);
	//if ($statut == 'refuse') $redirect_ok = 'oui';
	if ($statut == 'publie') {
		$query = &quot;UPDATE spip_syndic SET date=NOW() WHERE id_syndic=&quot;.intval(id_syndic);
		$result = spip_query($query);
	}
	calculer_rubriques();
	if ($statut == 'publie') {
		if (lire_meta('activer_moteur') == 'oui') {
			include_ecrire (&quot;inc_index.php3&quot;);
			indexer_syndic($id_syndic);
		}
	}
}

if ($nom_site AND $modifier_site == 'oui' AND $flag_editable) {
	$nom_site = addslashes($nom_site);
	$url_site = addslashes($url_site);
	$descriptif = addslashes($descriptif);
	if (strlen($url_syndic) &lt; 8) $syndication = &quot;non&quot;;
	$url_syndic = addslashes($url_syndic);

	$query = &quot;UPDATE spip_syndic SET id_rubrique='$id_rubrique', nom_site='$nom_site', url_site='$url_site', url_syndic='$url_syndic', descriptif='$descriptif', syndication='$syndication', statut='$statut' WHERE id_syndic=&quot;.intval($id_syndic);
	$result = spip_query($query);

	if ($syndication_old != $syndication OR $url_syndic != $old_syndic) {
		$recalcul = &quot;oui&quot;;
	}
	if ($syndication_old != $syndication AND $syndication == &quot;non&quot;) {
		spip_query(&quot;DELETE FROM spip_syndic_articles WHERE id_syndic='$id_syndic'&quot;);
	}
	calculer_rubriques();

	// invalider et reindexer
	if ($statut == 'publie') {
		if ($invalider_caches) {
			include_ecrire (&quot;inc_invalideur.php3&quot;);
			suivre_invalideur(&quot;id='id_syndic/$id_syndic'&quot;);
		}
		if (lire_meta('activer_moteur') == 'oui') {
			include_ecrire (&quot;inc_index.php3&quot;);
			indexer_syndic($id_syndic);
		}
	}
	$link = new Link('sites.php3');
	$link-&gt;addVar('id_syndic');
	$link-&gt;addVar('redirect');
	$redirect = $link-&gt;getUrl();
	$redirect_ok = 'oui';
}


if ($jour AND $flag_administrable) {
	if ($annee == &quot;0000&quot;) $mois = &quot;00&quot;;
	if ($mois == &quot;00&quot;) $jour = &quot;00&quot;;
	$query = &quot;UPDATE spip_syndic SET date='$annee-$mois-$jour' WHERE id_syndic=&quot;.intval($id_syndic);
	$result = spip_query($query);
	calculer_rubriques();
}



if ($redirect AND $redirect_ok == 'oui') {
	redirige_par_entete($redirect);
}


//
// recalcul
//
if ($recalcul ==  &quot;oui&quot;) {
	$result = spip_query (&quot;SELECT * FROM spip_syndic WHERE id_syndic='$id_syndic' AND syndication IN ('oui', 'sus', 'off')&quot;);
	if ($result AND spip_num_rows($result)&gt;0)
		$erreur_syndic = syndic_a_jour ($id_syndic);
}


//
// Afficher la page
//

calculer_droits();

$query = &quot;SELECT * FROM spip_syndic WHERE id_syndic='$id_syndic'&quot;;
$result = spip_query($query);

if ($row = spip_fetch_array($result)) {
	$id_syndic = $row[&quot;id_syndic&quot;];
	$id_rubrique = $row[&quot;id_rubrique&quot;];
	$nom_site = stripslashes($row[&quot;nom_site&quot;]);
	$url_site = stripslashes($row[&quot;url_site&quot;]);
	$url_syndic = stripslashes($row[&quot;url_syndic&quot;]);
	$descriptif = stripslashes($row[&quot;descriptif&quot;]);
	$syndication = $row[&quot;syndication&quot;];
	$statut = $row[&quot;statut&quot;];
	$date_heure = $row[&quot;date&quot;];
	$date_syndic = $row['date_syndic'];
	$mod = $row['moderation'];
}


if ($nom_site)
	$titre_page = &quot;&laquo; $nom_site &raquo;&quot;;
else
	$titre_page = _T('info_site');



debut_page(&quot;$titre_page&quot;,&quot;documents&quot;,&quot;sites&quot;);


//////// parents


debut_grand_cadre();

afficher_hierarchie($id_rubrique);

fin_grand_cadre();



debut_gauche();

debut_boite_info();
	echo &quot;&lt;center&gt;&quot;;
	echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size=1&gt;&lt;b&gt;&quot;._T('titre_site_numero').&quot;&lt;/b&gt;&lt;/font&gt;&quot;;
	echo &quot;&lt;br&gt;&lt;font face='Verdana,Arial,Sans,sans-serif' size=6&gt;&lt;b&gt;$id_syndic&lt;/b&gt;&lt;/font&gt;&quot;;
	echo &quot;&lt;/center&gt;&quot;;
fin_boite_info();


echo &quot;&lt;p&gt;&lt;center&gt;&quot;;
	icone (_T('icone_voir_sites_references'), &quot;sites_tous.php3&quot;, &quot;site-24.gif&quot;,&quot;rien.gif&quot;);
echo &quot;&lt;/center&gt;&quot;;

$rubon = &quot;siteon$id_syndic&quot;;
$ruboff = &quot;siteoff$id_syndic&quot;;

if ($id_syndic&gt;0 AND $flag_administrable)
	afficher_boite_logo($rubon, $ruboff, _T('logo_site').&quot; &quot;.aide (&quot;rublogo&quot;), _T('logo_survol'));


debut_droite();



debut_cadre_relief(&quot;site-24.gif&quot;);
echo &quot;&lt;center&gt;&quot;;

if ($syndication == 'off') {
	$logo_statut = &quot;puce-orange-anim.gif&quot;;
} 
else if ($statut == 'publie') {
	$logo_statut = &quot;puce-verte.gif&quot;;
}
else if ($statut == 'prop') {
	$logo_statut = &quot;puce-blanche.gif&quot;;
}
else if ($statut == 'refuse') {
	$logo_statut = &quot;puce-rouge.gif&quot;;
}

echo &quot;\n&lt;table cellpadding=0 cellspacing=0 border=0 width='100%'&gt;&quot;;
echo &quot;&lt;tr width='100%'&gt;&lt;td width='100%' valign='top'&gt;&quot;;
	gros_titre($nom_site, $logo_statut);

$url_affichee = $url_site;

if (strlen($url_affichee) &gt; 40) $url_affichee = substr($url_affichee, 0, 30).&quot;...&quot;;
echo &quot;&lt;a href='$url_site'&gt;&lt;b&gt;$url_affichee&lt;/b&gt;&lt;/a&gt;&quot;;

if (strlen($descriptif) &gt; 1) {
	echo &quot;&lt;p&gt;&lt;div align='left' style='padding: 5px; border: 1px dashed #aaaaaa; background-color: #e4e4e4;'&gt;&quot;;
	echo &quot;&lt;font size=2 face='Verdana,Arial,Sans,sans-serif'&gt;&quot;;
	echo &quot;&lt;b&gt;&quot;._T('info_descriptif').&quot;&lt;/b&gt; &quot;;
	echo propre($descriptif);
	echo &quot;&nbsp; &quot;;
	echo &quot;&lt;/font&gt;&quot;;
	echo &quot;&lt;/div&gt;&quot;;
}
echo &quot;&lt;/td&gt;&quot;;

if ($flag_editable) {
	$link = new Link('sites_edit.php3');
	$link-&gt;addVar('id_syndic');
	$link-&gt;addVar('target', $clean_link-&gt;getUrl());
	echo &quot;&lt;td&gt;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;rien.gif' width=5&gt;&lt;/td&gt;\n&quot;;
	echo &quot;&lt;td  align='right'&gt;&quot;;
	icone(_T('icone_modifier_site'), $link-&gt;getUrl(), &quot;site-24.gif&quot;, &quot;edit.gif&quot;);
	echo &quot;&lt;/td&gt;&quot;;
}
echo &quot;&lt;/tr&gt;&lt;/table&gt;\n&quot;;



if ($flag_editable AND ($options == 'avancees' OR $statut == 'publie')) {
	if ($statut == 'publie') {
		echo &quot;&lt;p&gt;&quot;;

		if (ereg(&quot;([0-9]{4})-([0-9]{2})-([0-9]{2})&quot;, $date_heure, $regs)) {
		        $mois = $regs[2];
		        $jour = $regs[3];
		        $annee = $regs[1];
		}


		debut_cadre_enfonce();
		echo &quot;&lt;FORM ACTION='sites.php3?id_syndic=$id_syndic' METHOD='GET'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='hidden' NAME='id_syndic' VALUE='$id_syndic'&gt;&quot;;
		echo &quot;&lt;INPUT NAME='options' TYPE=Hidden VALUE=\&quot;$options\&quot;&gt;&quot;;
		echo &quot;&lt;TABLE CELLPADDING=5 CELLSPACING=0 BORDER=0 WIDTH=100% BACKGROUND='&quot; . _DIR_IMG_PACK . &quot;rien.gif'&gt;&quot;;
		echo &quot;&lt;TR&gt;&lt;TD BGCOLOR='$couleur_foncee' COLSPAN=2&gt;&lt;FONT SIZE=2 COLOR='#FFFFFF'&gt;&lt;B&gt;&quot;._T('info_date_referencement');
		//echo aide (&quot;artdate&quot;);
		echo &quot;&lt;/B&gt;&lt;/FONT&gt;&lt;/TR&gt;&quot;;
		echo &quot;&lt;TR&gt;&lt;TD ALIGN='center'&gt;&quot;;
		echo &quot;&lt;SELECT NAME='jour' SIZE=1 CLASS='fondl'&gt;&quot;;
		afficher_jour($jour);
		echo &quot;&lt;/SELECT&gt; &quot;;
		echo &quot;&lt;SELECT NAME='mois' SIZE=1 CLASS='fondl'&gt;&quot;;
		afficher_mois($mois);
		echo &quot;&lt;/SELECT&gt; &quot;;
		echo &quot;&lt;SELECT NAME='annee' SIZE=1 CLASS='fondl'&gt;&quot;;
		afficher_annee($annee);
		echo &quot;&lt;/SELECT&gt;&quot;;
 		
		echo &quot;&lt;/TD&gt;&lt;TD ALIGN='right'&gt;&quot;;
		echo &quot;&lt;INPUT TYPE='submit' NAME='Changer' CLASS='fondo' VALUE='&quot;._T('bouton_changer').&quot;'&gt;&quot;;
		echo &quot;&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;&quot;;
		echo &quot;&lt;/FORM&gt;&quot;;
		fin_cadre_enfonce();	
	}
	else {
		echo &quot;&lt;BR&gt;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif' SIZE=3&gt;&quot;._T('info_site_propose').&quot; &lt;B&gt;&quot;.affdate($date_heure).&quot;&nbsp;&lt;/B&gt;&lt;/FONT&gt;&lt;P&gt;&quot;;
	}
}

if ($flag_editable AND $options == 'avancees') {
	formulaire_mots('syndic', $id_syndic, $nouv_mot, $supp_mot, $cherche_mot, $flag_editable);
}

if ($flag_administrable) {
	$link = $GLOBALS['clean_link'];
	$link-&gt;delVar('new');
	echo $link-&gt;getForm('GET');
	debut_cadre_relief(&quot;racine-site-24.gif&quot;);
	echo &quot;\n&lt;center&gt;&quot;;

	echo &quot;&lt;b&gt;&quot;._T('info_statut_site_1').&quot;&lt;/b&gt; &nbsp;&nbsp; \n&quot;;

	echo &quot;&lt;select name='nouveau_statut' size=1 class='fondl'&gt;\n&quot;;

	my_sel(&quot;publie&quot;,_T('info_statut_site_2'),$statut);
	my_sel(&quot;prop&quot;,_T('info_statut_site_3'),$statut);
	my_sel(&quot;refuse&quot;,_T('info_statut_site_4'),$statut);

	echo &quot;&lt;/select&gt;\n&quot;;

	echo &quot; &nbsp;&nbsp;&nbsp; &lt;input type='submit' name='Valider' value='&quot;._T('bouton_valider').&quot;' class='fondo'&gt;\n&lt;/center&gt;\n&quot;;
	fin_cadre_relief();
	echo &quot;&lt;/form&gt;\n&quot;;
}

if ($syndication == &quot;oui&quot; OR $syndication == &quot;off&quot; OR $syndication == &quot;sus&quot;) {
	echo &quot;&lt;p&gt;&lt;font size=3 face='Verdana,Arial,Sans,sans-serif'&gt;&lt;b&gt;&quot;._T('info_site_syndique').&quot;&lt;/b&gt;&lt;/font&gt;&quot;;

	if ($erreur_syndic)
		echo &quot;&lt;p&gt;&lt;font color=red&gt;&lt;b&gt;$erreur_syndic&lt;/b&gt;&lt;/font&gt;&quot;;

	if ($syndication == &quot;off&quot;) {
		debut_boite_info();
		echo _T('avis_site_syndique_probleme', array('url_syndic' =&gt; $url_syndic));
		echo &quot;&lt;center&gt;&lt;b&gt;&quot;;
		echo &quot;&lt;a href='sites.php3?id_syndic=$id_syndic&amp;recalcul=oui'&gt;&quot;;
		echo _T('lien_nouvelle_recuperation').&quot;&lt;/a&gt;&lt;/b&gt;&lt;/center&gt;\n&quot;;
		fin_boite_info();
	}
	afficher_syndic_articles(_T('titre_articles_syndiques'),
		&quot;SELECT * FROM spip_syndic_articles WHERE id_syndic='$id_syndic' ORDER BY date DESC&quot;);


	echo &quot;&lt;font face='verdana,arial,helvetica' size=2&gt;&quot;;
	// afficher la date de dernier acces a la syndication
	if ($date_syndic)
		echo &quot;&lt;p&gt;&lt;div align='left'&gt;&quot;._T('info_derniere_syndication').' '.affdate_heure($date_syndic)
		.&quot;.&lt;/div&gt;&lt;div align='right'&gt;&lt;a href='sites.php3?id_syndic=$id_syndic&amp;recalcul=oui'&gt;&quot;._T('lien_mise_a_jour_syndication').&quot;&lt;/a&gt;&lt;/div&gt;\n&quot;;

	// modifier la moderation
	if ($flag_administrable &amp;&amp; $options=='avancees') {
		if ($moderation == 'oui' OR $moderation == 'non')
			spip_query(&quot;UPDATE spip_syndic SET moderation='$moderation' WHERE id_syndic=&quot;.intval($id_syndic));
		else
			$moderation = $mod;

		if ($moderation == 'non' || $moderation =='')
			echo &quot;&lt;p&gt;&lt;div align='left'&gt;&quot;._T('texte_liens_syndication'). aide('artsyn') .
				&quot;&lt;/div&gt;&lt;div align='right'&gt;&lt;a
				href='sites.php3?id_syndic=$id_syndic&amp;moderation=oui'&gt;&quot;._T('info_demander_blocage_priori').&quot;&lt;/a&gt;&lt;/div&gt;\n&quot;;
		else if ($moderation == 'oui')
			echo &quot;&lt;p&gt;&lt;div align='left'&gt;&quot;._T('texte_demander_blocage_priori'). aide('artsyn') .
				&quot;&lt;/div&gt;&lt;div align='right'&gt; &lt;a
				href='sites.php3?id_syndic=$id_syndic&amp;moderation=non'&gt;&quot;._T('info_annuler_blocage_priori').&quot;&lt;/a&gt;&lt;/div&gt;\n&quot;;
	}
	echo &quot;&lt;/font&gt;&quot;;
}

fin_cadre_relief();



//////////////////////////////////////////////////////
// Forums
//

echo &quot;&lt;br&gt;&lt;br&gt;\n&quot;;

$forum_retour = &quot;sites.php3?id_syndic=$id_syndic&quot;;

$link = new Link('forum_envoi.php3');
$link-&gt;addVar('statut', 'prive');
$link-&gt;addVar('adresse_retour', $forum_retour);
$link-&gt;addVar('id_syndic');
$link-&gt;addVar('titre_message', $nom_site);


echo &quot;&lt;div align='center'&gt;&quot;;
icone (_T('icone_poster_message'), $link-&gt;getUrl(), &quot;forum-interne-24.gif&quot;, &quot;creer.gif&quot;);
echo &quot;&lt;/div&gt;&quot;;

echo &quot;&lt;p align='left'&gt;\n&quot;;

$query_forum = &quot;SELECT * FROM spip_forum WHERE statut='prive' AND id_syndic='$id_syndic' AND id_parent=0 ORDER BY date_heure DESC LIMIT 0,20&quot;;
$result_forum = spip_query($query_forum);
afficher_forum($result_forum, $forum_retour);


fin_page();

?&gt;

--- NEW FILE: breves.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);

if ($statut AND $connect_statut == &quot;0minirezo&quot;) {
	$query=&quot;UPDATE spip_breves SET date_heure=NOW(), statut='$statut' WHERE id_breve=$id_breve&quot;;
	$result=spip_query($query);
	calculer_rubriques();
	redirige_par_entete(&quot;breves.php3&quot;);
}



debut_page(_T('titre_page_breves'), &quot;documents&quot;, &quot;breves&quot;);
debut_gauche();

echo &quot;&lt;P align=left&gt;&quot;;
	
debut_droite();



function enfant($leparent){
	global $spip_lang_left, $spip_lang_right;

 	$query=&quot;SELECT * FROM spip_rubriques WHERE id_parent='$leparent' ORDER BY titre&quot;;
 	$result=spip_query($query);

 	while($row=spip_fetch_array($result)){
		$id_rubrique=$row['id_rubrique'];
		$id_parent=$row['id_parent'];
		$titre=typo($row['titre']);
		$descriptif=$row['descriptif'];
		$texte=$row['texte'];

		debut_cadre_enfonce(&quot;secteur-24.gif&quot;, false, '', $titre.aide (&quot;breves&quot;));

		if ($GLOBALS['connect_statut'] == &quot;0minirezo&quot;) $statuts = &quot;'prop', 'refuse', 'publie'&quot;;
		else $statuts = &quot;'prop', 'publie'&quot;;

		$query = &quot;SELECT id_breve, date_heure, titre, statut FROM spip_breves &quot;.
			&quot;WHERE id_rubrique='$id_rubrique' AND statut IN ($statuts) ORDER BY date_heure DESC&quot;;
		afficher_breves('', $query);
		echo &quot;&lt;div align='$spip_lang_right'&gt;&quot;;
		icone(_T('icone_nouvelle_breve'), &quot;breves_edit.php3?new=oui&amp;id_rubrique=$id_rubrique&quot;, &quot;breve-24.gif&quot;, &quot;creer.gif&quot;);
		echo &quot;&lt;/div&gt;&quot;;

		fin_cadre_enfonce();

	}
}



enfant(0);


fin_page();

?&gt;


--- NEW FILE: calendrier_jour.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_calendrier.php&quot;);

$today=getdate(time());
$jour_today = $today[&quot;mday&quot;];
$mois_today = $today[&quot;mon&quot;];
$annee_today = $today[&quot;year&quot;];

// sans arguments =&gt; mois courant
if (!$mois){
  $jour=$jour_today;
  $mois=$mois_today;
  $annee=$annee_today;
}

$date = date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois, $jour, $annee));
$jour = journum($date);
$mois = mois($date);
$annee = annee($date);


$afficher_bandeau_calendrier = true;

debut_page(nom_jour(&quot;$annee-$mois-$jour&quot;).&quot; &quot;. affdate_jourcourt(&quot;$annee-$mois-$jour&quot;),  
	   &quot;redacteurs&quot;,
	   &quot;calendrier&quot;);

debut_gauche();

echo http_calendrier_journee($jour_today,$mois_today,$annee_today, 
		  date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois, $jour, $annee)));

fin_page();

?&gt;

--- NEW FILE: recherche.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_mots.php3&quot;);
include_ecrire (&quot;inc_sites.php3&quot;);

$recherche = addslashes(entites_html($recherche));


debut_page(_T('titre_page_recherche', array('recherche' =&gt; $recherche)));

debut_gauche();

				$recherche_aff = _T('info_rechercher');
				$onfocus = &quot;onfocus=this.value='';&quot;;
			echo &quot;&lt;form method='get' style='margin: 0px;' action='recherche.php3'&gt;&quot;;
			echo '&lt;input type=&quot;text&quot; size=&quot;10&quot; value=&quot;'.$recherche_aff.'&quot; name=&quot;recherche&quot; class=&quot;spip_recherche&quot; accesskey=&quot;r&quot; '.$onfocus.'&gt;';
			echo &quot;&lt;/form&gt;&quot;;



debut_droite();

if (strlen($recherche) &gt; 0) {

	echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif'&gt;&lt;B&gt;&quot;._T('info_resultat_recherche').&quot;&lt;/B&gt;&lt;BR&gt;&quot;;
	echo &quot;&lt;FONT SIZE=5 COLOR='$couleur_foncee'&gt;&lt;B&gt;$recherche&lt;/B&gt;&lt;/FONT&gt;&lt;p&gt;&quot;;

	$query_articles = &quot;SELECT * FROM spip_articles WHERE&quot;;
	$query_breves = &quot;SELECT * FROM spip_breves WHERE &quot;;
	$query_rubriques = &quot;SELECT * FROM spip_rubriques WHERE &quot;;
	$query_sites = &quot;SELECT * FROM spip_syndic WHERE &quot;;
	
	if (ereg(&quot;^[0-9]+$&quot;, $recherche)) {
		$query_articles .= &quot; (id_article = $recherche) OR &quot;;
		$query_breves .= &quot; (id_breve = $recherche) OR &quot;;
		$query_rubriques .= &quot; (id_rubrique = $recherche) OR &quot;;
		$query_sites .= &quot; (id_syndic = $recherche) OR &quot;;
	}
	
	// Eviter les symboles '%', caracteres SQL speciaux
	$recherche = str_replace(&quot;%&quot;,&quot;\%&quot;,$recherche);
	$rech2 = split(&quot;[[:space:]]+&quot;, $recherche);
	if ($rech2)
		$where = &quot; (titre LIKE '%&quot;.join(&quot;%' AND titre LIKE '%&quot;, $rech2).&quot;%') &quot;;
	else
		$where = &quot; 1=2&quot;;
	
	$query_articles .= &quot; $where ORDER BY date_modif DESC&quot;;
	$query_breves .= &quot; $where ORDER BY maj DESC LIMIT 0,10&quot;;
	$query_rubriques .= &quot; $where ORDER BY maj DESC LIMIT 0,10&quot;;
	
	$query_sites .= &quot; $where ORDER BY maj DESC LIMIT 0,10&quot;;
	$query_sites  = ereg_replace(&quot;titre LIKE&quot;, &quot;nom_site LIKE&quot;, $query_sites);
	
	$activer_moteur = (lire_meta('activer_moteur') == 'oui');
	if ($activer_moteur) {	// texte integral
		include_ecrire ('inc_index.php3');
		list($hash_recherche,) = requete_hash ($recherche);
		$query_articles_int = requete_txt_integral('article', $hash_recherche);
		$query_breves_int = requete_txt_integral('breve', $hash_recherche);
		$query_rubriques_int = requete_txt_integral('rubrique', $hash_recherche);
		$query_sites_int = requete_txt_integral('syndic', $hash_recherche);
		$query_auteurs_int = requete_txt_integral('auteur', $hash_recherche);
	}
	
	if ($query_articles)
		$nba = afficher_articles (_T('info_articles_trouves'), $query_articles);
	if ($activer_moteur) {
		if ($nba) {
			$doublons = join($nba, &quot;,&quot;);
			$query_articles_int = ereg_replace (&quot;WHERE&quot;, &quot;WHERE objet.id_article NOT IN ($doublons) AND&quot;, $query_articles_int);
		}
		$nba1 = afficher_articles (_T('info_articles_trouves_dans_texte'), $query_articles_int);
	}
	
	if ($query_breves)
		$nbb = afficher_breves (_T('info_breves_touvees'), $query_breves, true);
	if ($activer_moteur) {
		if ($nbb) {
			$doublons = join($nbb, &quot;,&quot;);
			$query_breves_int = ereg_replace (&quot;WHERE&quot;, &quot;WHERE objet.id_breve NOT IN ($doublons) AND&quot;, $query_breves_int);
		}
		$nbb1 = afficher_breves (_T('info_breves_touvees_dans_texte'), $query_breves_int, true);
	}
	
	if ($query_rubriques)
		$nbr = afficher_rubriques (_T('info_rubriques_trouvees'), $query_rubriques);
	if ($activer_moteur) {
		if ($nbr) {
			$doublons = join($nbr, &quot;,&quot;);
			$query_rubriques_int = ereg_replace (&quot;WHERE&quot;, &quot;WHERE objet.id_rubrique NOT IN ($doublons) AND&quot;, $query_rubriques_int);
		}
		$nbr1 = afficher_rubriques (_T('info_rubriques_trouvees_dans_texte'), $query_rubriques_int);
	}
	
	if ($activer_moteur)
		$nbt = afficher_auteurs (_T('info_auteurs_trouves'), $query_auteurs_int);
	
	if ($query_sites)
		$nbs = afficher_sites (_T('info_sites_trouves'), $query_sites);
	if ($activer_moteur) {
		if ($nbs) {
			$doublons = join($nbs, &quot;,&quot;);
			$query_sites_int = ereg_replace (&quot;WHERE&quot;, &quot;WHERE objet.id_syndic NOT IN ($doublons) AND&quot;, $query_sites_int);
		}
		$nbs1 = afficher_sites (_T('info_sites_trouves_dans_texte'), $query_sites_int);
	}
	
	if (!$nba AND !$nba1 AND !$nbb AND !$nbb1 AND !$nbr AND !$nbr1 AND !$nbt AND !$nbs AND !$nbs1) {
		echo &quot;&lt;FONT FACE='Verdana,Arial,Sans,sans-serif'&gt;&quot;._T('avis_aucun_resultat').&quot;&lt;/FONT&gt;&lt;P&gt;&quot;;
	}
}

echo &quot;&lt;p&gt;&quot;;

fin_page();

?&gt;

--- NEW FILE: http.class.php ---
&lt;?php
/**************************************************************************************************
* Class: Advanced HTTP Client
***************************************************************************************************
* Version 		: 1.1
* Released		: 06-20-2002
* Last Modified : 06-10-2003
* Author		: GuinuX &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">guinux at cosmoplazza.com</A>&gt;
*
***************************************************************************************************
* Changes 
***************************************************************************************************
* 2003-06-10 : GuinuX 
*   - Fixed a bug with multiple gets and basic auth
*   - Added support for Basic proxy Authentification 
* 2003-05-25: By Michael Mauch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">michael.mauch at gmx.de</A>&gt;
*	- Fixed two occurences of the former &quot;status&quot; member which is now deprecated
* 2002-09-23: GuinuX
*	- Fixed a bug to the post method with some HTTP servers
*	- Thanx to l0rd jenci &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">lord_jenci at bigfoot.com</A>&gt; for reporting this bug.
* 2002-09-07: Dirk Fokken &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">fokken at cross-consulting.com</A>&gt;
*   - Deleted trailing characters at the end of the file, right after the php closing tag, in order 
*	  to fix a bug with binary requests.
* 2002-20-06: GuinuX, Major changes
*	- Turned to a more OOP style =&gt; added class http_header, http_response_header, 
*		http_request_message, http_response_message.
*		The members : status, body, response_headers, cookies, _request_headers of the http class 
*		are Deprecated.
* 2002-19-06: GuinuX, fixed some bugs in the http::_get_response() method
* 2002-18-06: By Mate Jovic &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">jovic at matoma.de</A>&gt;
*	- Added support for Basic Authentification 
*  		usage: $http_client = new http( HTTP_V11, false, Array('user','pass') );
*
***************************************************************************************************
* Description:  
***************************************************************************************************
*	A HTTP client class
* 	Supports : 
*			- GET, HEAD and POST methods 
*			- Http cookies 
*			- multipart/form-data AND application/x-www-form-urlencoded
*			- Chunked Transfer-Encoding 
*			- HTTP 1.0 and 1.1 protocols 
*			- Keep-Alive Connections 
*			- Proxy
*			- Basic WWW-Authentification and Proxy-Authentification 
*
***************************************************************************************************
* TODO :
***************************************************************************************************
*			- Read trailing headers for Chunked Transfer-Encoding 
***************************************************************************************************
* usage
***************************************************************************************************
* See example scripts.
*
***************************************************************************************************
* License
***************************************************************************************************
* GNU Lesser General Public License (LGPL)
* <A HREF="http://www.opensource.org/licenses/lgpl-license.html">http://www.opensource.org/licenses/lgpl-license.html</A>
*
* For any suggestions or bug report please contact me : <A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">guinux at cosmoplazza.com</A>
***************************************************************************************************/

	if ( !defined('HTTP_CRLF') ) define( 'HTTP_CRLF', chr(13) . chr(10));
	define( 'HTTP_V10', '1.0');
	define( 'HTTP_V11', '1.1');
	define( 'HTTP_STATUS_CONTINUE', 				100 );
	define( 'HTTP_STATUS_SWITCHING_PROTOCOLS', 		101 );
	define( 'HTTP_STATUS_OK', 						200 );
	define( 'HTTP_STATUS_CREATED', 					201 );
	define( 'HTTP_STATUS_ACCEPTED', 				202 );
	define( 'HTTP_STATUS_NON_AUTHORITATIVE', 		203 );
	define( 'HTTP_STATUS_NO_CONTENT', 				204 );
	define( 'HTTP_STATUS_RESET_CONTENT', 			205 );
	define( 'HTTP_STATUS_PARTIAL_CONTENT', 			206 );
	define( 'HTTP_STATUS_MULTIPLE_CHOICES', 		300 );
	define( 'HTTP_STATUS_MOVED_PERMANENTLY', 		301 );
	define( 'HTTP_STATUS_FOUND', 					302 );
	define( 'HTTP_STATUS_SEE_OTHER', 				303 );
	define( 'HTTP_STATUS_NOT_MODIFIED', 			304 );
	define( 'HTTP_STATUS_USE_PROXY', 				305 );
	define( 'HTTP_STATUS_TEMPORARY_REDIRECT', 		307 );
	define( 'HTTP_STATUS_BAD_REQUEST', 				400 );
	define( 'HTTP_STATUS_UNAUTHORIZED', 			401 );
	define( 'HTTP_STATUS_FORBIDDEN', 				403 );
	define( 'HTTP_STATUS_NOT_FOUND', 				404 );
	define( 'HTTP_STATUS_METHOD_NOT_ALLOWED', 		405 );
	define( 'HTTP_STATUS_NOT_ACCEPTABLE', 			406 );
	define( 'HTTP_STATUS_PROXY_AUTH_REQUIRED', 		407 );
	define( 'HTTP_STATUS_REQUEST_TIMEOUT', 			408 );
	define( 'HTTP_STATUS_CONFLICT', 				409 );
	define( 'HTTP_STATUS_GONE', 					410 );
	define( 'HTTP_STATUS_REQUEST_TOO_LARGE',		413 );
	define( 'HTTP_STATUS_URI_TOO_LONG', 			414 );
	define( 'HTTP_STATUS_SERVER_ERROR', 			500 );
	define( 'HTTP_STATUS_NOT_IMPLEMENTED',			501 );
	define( 'HTTP_STATUS_BAD_GATEWAY',				502 );
	define( 'HTTP_STATUS_SERVICE_UNAVAILABLE',		503 );
	define( 'HTTP_STATUS_VERSION_NOT_SUPPORTED',	505 );


/******************************************************************************************
* class http_header
******************************************************************************************/
	class http_header {
		var $_headers;
		var $_debug;

		function http_header() {
			$this-&gt;_headers = Array();
			$this-&gt;_debug	= '';
		} // End Of function http_header()
		
		function get_header( $header_name ) {
			$header_name = $this-&gt;_format_header_name( $header_name );
			if (isset($this-&gt;_headers[$header_name]))
				return $this-&gt;_headers[$header_name];
			else
				return null;
		} // End of function get()
		
		function set_header( $header_name, $value ) {
			if ($value != '') {
				$header_name = $this-&gt;_format_header_name( $header_name );
				$this-&gt;_headers[$header_name] = $value;
			}
		} // End of function set()
		
		function reset() {
			if ( count( $this-&gt;_headers ) &gt; 0 ) $this-&gt;_headers = array();
			$this-&gt;_debug 	.= &quot;\n--------------- RESETED ---------------\n&quot;;
		} // End of function clear()

		function serialize_headers() {
			$str = '';
			foreach ( $this-&gt;_headers as $name=&gt;$value) {
				$str .= &quot;$name: $value&quot; . HTTP_CRLF;
			}
			return $str;
		} // End of function serialize_headers()
		
		function _format_header_name( $header_name ) {
			$formatted = str_replace( '-', ' ', strtolower( $header_name ) );
			$formatted = ucwords( $formatted );
			$formatted = str_replace( ' ', '-', $formatted );
			return $formatted;
		}
		
		function add_debug_info( $data ) {
			$this-&gt;_debug .= $data;
		}

		function get_debug_info() {
			return $this-&gt;_debug;
		}
	
	} // End Of Class http_header

/******************************************************************************************
* class http_response_header
******************************************************************************************/
	class http_response_header extends http_header {
		var $cookies_headers;
		
		function http_response_header() {
			$this-&gt;cookies_headers = array();
			http_header::http_header();
		} // End of function http_response_header()
		
		function deserialize_headers( $flat_headers ) {
			$flat_headers = preg_replace( &quot;/^&quot; . HTTP_CRLF . &quot;/&quot;, '', $flat_headers );
			$tmp_headers = split( HTTP_CRLF, $flat_headers );
			if (preg_match(&quot;'HTTP/(\d\.\d)\s+(\d+).*'i&quot;, $tmp_headers[0], $matches )) {
				$this-&gt;set_header( 'Protocol-Version', $matches[1] );
				$this-&gt;set_header( 'Status', $matches[2] );
			} 
			array_shift( $tmp_headers );
			foreach( $tmp_headers as $index=&gt;$value ) {
				$pos = strpos( $value, ':' );
				if ( $pos ) {
					$key = substr( $value, 0, $pos );
					$value = trim( substr( $value, $pos +1) );
					if ( strtoupper($key) == 'SET-COOKIE' )
						$this-&gt;cookies_headers[] = $value;
					else
						$this-&gt;set_header( $key, $value );
				}
			}
		} // End of function deserialize_headers()
		
		function reset() {
			if ( count( $this-&gt;cookies_headers ) &gt; 0 ) $this-&gt;cookies_headers = array();
			http_header::reset();
		}

	} // End of class http_response_header


/******************************************************************************************
* class http_request_message
******************************************************************************************/
	class http_request_message extends http_header {
		var $body;
		
		function http_request_message() {
			$this-&gt;body = '';
			http_header::http_header();
		} // End of function http_message()
		
		function reset() {
			$this-&gt;body = '';
			http_header::reset();
		}
	}

/******************************************************************************************
* class http_response_message
******************************************************************************************/
	class http_response_message extends http_response_header {
		var $body;
		var $cookies;
		
		function http_response_message() {
			$this-&gt;cookies = new http_cookie();
			$this-&gt;body = '';
			http_response_header::http_response_header();
		} // End of function http_response_message()
		
		function get_status() {
			if ( $this-&gt;get_header( 'Status' ) != null )
				return (integer)$this-&gt;get_header( 'Status' );
			else
				return -1;
		}
		
		function get_protocol_version() {
			if ( $this-&gt;get_header( 'Protocol-Version' ) != null )
				return $this-&gt;get_header( 'Protocol-Version' );
			else
				return HTTP_V10;
		}
		
		function get_content_type() {
			$this-&gt;get_header( 'Content-Type' );
		}
		
		function get_body() {
			return $this-&gt;body;
		}
		
		function reset() {
			$this-&gt;body = '';
			http_response_header::reset();
		}

		function parse_cookies( $host ) {
			for ( $i = 0; $i &lt; count( $this-&gt;cookies_headers ); $i++ )
				$this-&gt;cookies-&gt;parse( $this-&gt;cookies_headers[$i], $host );
		}
	}

/******************************************************************************************
* class http_cookie
******************************************************************************************/
	class http_cookie {
		var $cookies;

		function http_cookie() {
			$this-&gt;cookies 	= array();
		} // End of function http_cookies()
		
		function _now() {
			return strtotime( gmdate( &quot;l, d-F-Y H:i:s&quot;, time() ) );
		} // End of function _now()
		
		function _timestamp( $date ) {
			if ( $date == '' ) return $this-&gt;_now()+3600;
			$time = strtotime( $date );
			return ($time&gt;0?$time:$this-&gt;_now()+3600);
		} // End of function _timestamp()

		function get( $current_domain, $current_path ) {
			$cookie_str = '';
			$now = $this-&gt;_now();
			$new_cookies = array();

			foreach( $this-&gt;cookies as $cookie_name =&gt; $cookie_data ) {
				if ($cookie_data['expires'] &gt; $now) {
					$new_cookies[$cookie_name] = $cookie_data;
					$domain = preg_quote( $cookie_data['domain'] );
					$path = preg_quote( $cookie_data['path']  );
					if ( preg_match( &quot;'.*$domain$'i&quot;, $current_domain ) &amp;&amp; preg_match( &quot;'^$path.*'i&quot;, $current_path ) )
						$cookie_str .= $cookie_name . '=' . $cookie_data['value'] . '; ';
				}
			}
			$this-&gt;cookies = $new_cookies;
			return $cookie_str;
		} // End of function get()
		
		function set( $name, $value, $domain, $path, $expires ) {
			$this-&gt;cookies[$name] = array(	'value' =&gt; $value,
											'domain' =&gt; $domain,
											'path' =&gt; $path,
											'expires' =&gt; $this-&gt;_timestamp( $expires )
											);
		} // End of function set()
		
		function parse( $cookie_str, $host ) {
			$cookie_str = str_replace( '; ', ';', $cookie_str ) . ';';
			$data = split( ';', $cookie_str );
			$value_str = $data[0];

			$cookie_param = 'domain=';
			$start = strpos( $cookie_str, $cookie_param );
			if ( $start &gt; 0 ) {
				$domain = substr( $cookie_str, $start + strlen( $cookie_param ) );
				$domain = substr( $domain, 0, strpos( $domain, ';' ) );
			} else
				$domain = $host;

			$cookie_param = 'expires=';
			$start = strpos( $cookie_str, $cookie_param );
			if ( $start &gt; 0 ) {
				$expires = substr( $cookie_str, $start + strlen( $cookie_param ) );
				$expires = substr( $expires, 0, strpos( $expires, ';' ) );
			} else
				$expires = '';
			
			$cookie_param = 'path=';
			$start = strpos( $cookie_str, $cookie_param );
			if ( $start &gt; 0 ) {
				$path = substr( $cookie_str, $start + strlen( $cookie_param ) );
				$path = substr( $path, 0, strpos( $path, ';' ) );
			} else
				$path = '/';
							
			$sep_pos = strpos( $value_str, '=');
			
			if ($sep_pos){
				$name = substr( $value_str, 0, $sep_pos );
				$value = substr( $value_str, $sep_pos+1 );
				$this-&gt;set( $name, $value, $domain, $path, $expires );
			}
		} // End of function parse()
		
	} // End of class http_cookie	
	
/******************************************************************************************
* class http
******************************************************************************************/
	class http {
		var $_socket;
		var $host;
		var $port;
		var $http_version;
		var $user_agent;
		var $errstr;
		var $connected;
		var $uri;
		var $_proxy_host;
		var $_proxy_port;
		var $_proxy_login;
		var $_proxy_pwd;
		var $_use_proxy;
		var $_auth_login;
		var $_auth_pwd;	
		var $_response; 
		var $_request;
		var $_keep_alive;		

		function http( $http_version = HTTP_V10, $keep_alive = false, $auth = false ) {
			$this-&gt;http_version	= $http_version;
			$this-&gt;connected	= false;
			$this-&gt;user_agent	= 'CosmoHttp/1.1 (compatible; MSIE 5.5; Linux)';
			$this-&gt;host			= '';
			$this-&gt;port			= 80;
			$this-&gt;errstr		= '';

			$this-&gt;_keep_alive	= $keep_alive;
			$this-&gt;_proxy_host	= '';
			$this-&gt;_proxy_port	= -1;
			$this-&gt;_proxy_login	= '';
			$this-&gt;_proxy_pwd	= '';
			$this-&gt;_auth_login	= '';
			$this-&gt;_auth_pwd	= '';
			$this-&gt;_use_proxy	= false;
			$this-&gt;_response 	= new http_response_message();
			$this-&gt;_request		= new http_request_message();
			
		// Basic Authentification added by Mate Jovic, 2002-18-06, <A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">jovic at matoma.de</A>
			if( is_array($auth) &amp;&amp; count($auth) == 2 ){
				$this-&gt;_auth_login	= $auth[0];
				$this-&gt;_auth_pwd	= $auth[1];
			}
		} // End of Constuctor

		function use_proxy( $host, $port, $proxy_login = null, $proxy_pwd = null ) {
		// Proxy auth not yet supported
			$this-&gt;http_version	= HTTP_V10;
			$this-&gt;_keep_alive	= false;
			$this-&gt;_proxy_host	= $host;
			$this-&gt;_proxy_port	= $port;
			$this-&gt;_proxy_login	= $proxy_login;
			$this-&gt;_proxy_pwd	= $proxy_pwd;
			$this-&gt;_use_proxy	= true;
		}

		function set_request_header( $name, $value ) {
			$this-&gt;_request-&gt;set_header( $name, $value );
		}

		function get_response_body() {
			return $this-&gt;_response-&gt;body;
		}
		
		function get_response() {
			return $this-&gt;_response;
		}
		
		function head( $uri ) {
			$this-&gt;uri = $uri;

			if ( ($this-&gt;_keep_alive &amp;&amp; !$this-&gt;connected) || !$this-&gt;_keep_alive ) {
				if ( !$this-&gt;_connect() ) {
					$this-&gt;errstr = 'Could not connect to ' . $this-&gt;host;
					return -1;
				}
			}
			$http_cookie = $this-&gt;_response-&gt;cookies-&gt;get( $this-&gt;host, $this-&gt;_current_directory( $uri ) );
			
			if ($this-&gt;_use_proxy) {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host . ':' . $this-&gt;port );
				$this-&gt;_request-&gt;set_header( 'Proxy-Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				if ( $this-&gt;_proxy_login != '' ) $this-&gt;_request-&gt;set_header( 'Proxy-Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_proxy_login . &quot;:&quot; . $this-&gt;_proxy_pwd ) );
				$uri = '<A HREF="http://">http://</A>' . $this-&gt;host . ':' . $this-&gt;port . $uri;
			} else {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host );
				$this-&gt;_request-&gt;set_header( 'Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
			}

			if ( $this-&gt;_auth_login != '' ) $this-&gt;_request-&gt;set_header( 'Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_auth_login . &quot;:&quot; . $this-&gt;_auth_pwd ) );			
			$this-&gt;_request-&gt;set_header( 'User-Agent', $this-&gt;user_agent );
			$this-&gt;_request-&gt;set_header( 'Accept', '*/*' );
			$this-&gt;_request-&gt;set_header( 'Cookie', $http_cookie );
			
			$cmd =	&quot;HEAD $uri HTTP/&quot; . $this-&gt;http_version . HTTP_CRLF . 
					$this-&gt;_request-&gt;serialize_headers() .
					HTTP_CRLF;
			fwrite( $this-&gt;_socket, $cmd );
			
			$this-&gt;_request-&gt;add_debug_info( $cmd );
			$this-&gt;_get_response( false );

			if ($this-&gt;_socket &amp;&amp; !$this-&gt;_keep_alive) $this-&gt;disconnect();
			if ( $this-&gt;_response-&gt;get_header( 'Connection' ) != null ) {
				if ( $this-&gt;_keep_alive &amp;&amp; strtolower( $this-&gt;_response-&gt;get_header( 'Connection' ) ) == 'close' ) {
					$this-&gt;_keep_alive = false;
					$this-&gt;disconnect();
				}
			}
			
			if ( $this-&gt;_response-&gt;get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this-&gt;_parse_location( $this-&gt;_response-&gt;get_header( 'Location' ) );
				$this-&gt;disconnect();
				$this-&gt;use_proxy( $location['host'], $location['port'] );
				$this-&gt;head( $this-&gt;uri );
			}
			
			return $this-&gt;_response-&gt;get_header( 'Status' );
		} // End of function head()

		
		function get( $uri, $follow_redirects = true, $referer = '' ) {
			$this-&gt;uri = $uri;
			
			if ( ($this-&gt;_keep_alive &amp;&amp; !$this-&gt;connected) || !$this-&gt;_keep_alive ) {
				if ( !$this-&gt;_connect() ) {
					$this-&gt;errstr = 'Could not connect to ' . $this-&gt;host;
					return -1;
				}
			}
			
			if ($this-&gt;_use_proxy) {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host . ':' . $this-&gt;port );
				$this-&gt;_request-&gt;set_header( 'Proxy-Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				if ( $this-&gt;_proxy_login != '' ) $this-&gt;_request-&gt;set_header( 'Proxy-Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_proxy_login . &quot;:&quot; . $this-&gt;_proxy_pwd ) );
				$uri = '<A HREF="http://">http://</A>' . $this-&gt;host . ':' . $this-&gt;port . $uri;
			} else {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host );
				$this-&gt;_request-&gt;set_header( 'Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				$this-&gt;_request-&gt;set_header( 'Pragma', 'no-cache' );
				$this-&gt;_request-&gt;set_header( 'Cache-Control', 'no-cache' );
			}
			
			if ( $this-&gt;_auth_login != '' ) $this-&gt;_request-&gt;set_header( 'Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_auth_login . &quot;:&quot; . $this-&gt;_auth_pwd ) );
			$http_cookie = $this-&gt;_response-&gt;cookies-&gt;get( $this-&gt;host, $this-&gt;_current_directory( $uri ) );
			$this-&gt;_request-&gt;set_header( 'User-Agent', $this-&gt;user_agent );
			$this-&gt;_request-&gt;set_header( 'Accept', '*/*' );
			$this-&gt;_request-&gt;set_header( 'Referer', $referer );
			$this-&gt;_request-&gt;set_header( 'Cookie', $http_cookie );
			
			$cmd =	&quot;GET $uri HTTP/&quot; . $this-&gt;http_version . HTTP_CRLF . 
					$this-&gt;_request-&gt;serialize_headers() .
					HTTP_CRLF;
			fwrite( $this-&gt;_socket, $cmd );

			$this-&gt;_request-&gt;add_debug_info( $cmd );
			$this-&gt;_get_response();

			if ($this-&gt;_socket &amp;&amp; !$this-&gt;_keep_alive) $this-&gt;disconnect();
			if (  $this-&gt;_response-&gt;get_header( 'Connection' ) != null ) {
				if ( $this-&gt;_keep_alive &amp;&amp; strtolower( $this-&gt;_response-&gt;get_header( 'Connection' ) ) == 'close' ) {
					$this-&gt;_keep_alive = false;
					$this-&gt;disconnect();
				}
			}
			if ( $follow_redirects &amp;&amp; ($this-&gt;_response-&gt;get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_FOUND || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this-&gt;_response-&gt;get_header( 'Location' ) != null  ) {
					$this-&gt;_redirect( $this-&gt;_response-&gt;get_header( 'Location' ) );
				}
			}
			
			if ( $this-&gt;_response-&gt;get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this-&gt;_parse_location( $this-&gt;_response-&gt;get_header( 'Location' ) );
				$this-&gt;disconnect();
				$this-&gt;use_proxy( $location['host'], $location['port'] );
				$this-&gt;get( $this-&gt;uri, $referer );
			}

			return $this-&gt;_response-&gt;get_status();
		} // End of function get()



		function multipart_post( $uri, &amp;$form_fields, $form_files = null, $follow_redirects = true, $referer = '' ) {
			$this-&gt;uri = $uri;
			
			if ( ($this-&gt;_keep_alive &amp;&amp; !$this-&gt;connected) || !$this-&gt;_keep_alive ) {
				if ( !$this-&gt;_connect() ) {
					$this-&gt;errstr = 'Could not connect to ' . $this-&gt;host;
					return -1;
				}
			}
			$boundary = uniqid('------------------');
			$http_cookie = $this-&gt;_response-&gt;cookies-&gt;get( $this-&gt;host, $this-&gt;_current_directory( $uri ) );
			$body = $this-&gt;_merge_multipart_form_data( $boundary, $form_fields, $form_files );
			$this-&gt;_request-&gt;body =  $body . HTTP_CRLF;
			$content_length = strlen( $body ); 


			if ($this-&gt;_use_proxy) {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host . ':' . $this-&gt;port );
				$this-&gt;_request-&gt;set_header( 'Proxy-Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				if ( $this-&gt;_proxy_login != '' ) $this-&gt;_request-&gt;set_header( 'Proxy-Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_proxy_login . &quot;:&quot; . $this-&gt;_proxy_pwd ) );
				$uri = '<A HREF="http://">http://</A>' . $this-&gt;host . ':' . $this-&gt;port . $uri;
			} else {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host );
				$this-&gt;_request-&gt;set_header( 'Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				$this-&gt;_request-&gt;set_header( 'Pragma', 'no-cache' );
				$this-&gt;_request-&gt;set_header( 'Cache-Control', 'no-cache' );
			}

			if ( $this-&gt;_auth_login != '' ) $this-&gt;_request-&gt;set_header( 'Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_auth_login . &quot;:&quot; . $this-&gt;_auth_pwd ) );
			$this-&gt;_request-&gt;set_header( 'Accept', '*/*' );
			$this-&gt;_request-&gt;set_header( 'Content-Type', 'multipart/form-data; boundary=' . $boundary );
			$this-&gt;_request-&gt;set_header( 'User-Agent', $this-&gt;user_agent );
			$this-&gt;_request-&gt;set_header( 'Content-Length', $content_length );
			$this-&gt;_request-&gt;set_header( 'Cookie', $http_cookie );
			$this-&gt;_request-&gt;set_header( 'Referer', $referer );
							
			$req_header	= &quot;POST $uri HTTP/&quot; . $this-&gt;http_version . HTTP_CRLF . 
						$this-&gt;_request-&gt;serialize_headers() .
						HTTP_CRLF;

			fwrite( $this-&gt;_socket, $req_header );
			usleep(10);
			fwrite( $this-&gt;_socket, $this-&gt;_request-&gt;body );
			
			$this-&gt;_request-&gt;add_debug_info( $req_header );
			$this-&gt;_get_response();
			
			if ($this-&gt;_socket &amp;&amp; !$this-&gt;_keep_alive) $this-&gt;disconnect();
			if ( $this-&gt;_response-&gt;get_header( 'Connection' ) != null ) {
				if ( $this-&gt;_keep_alive &amp;&amp; strtolower( $this-&gt;_response-&gt;get_header( 'Connection' ) ) == 'close' ) {
					$this-&gt;_keep_alive = false;
					$this-&gt;disconnect();
				}
			}
			
			if ( $follow_redirects &amp;&amp; ($this-&gt;_response-&gt;get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_FOUND || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this-&gt;_response-&gt;get_header( 'Location') != null ) {
					$this-&gt;_redirect( $this-&gt;_response-&gt;get_header( 'Location') );
				}
			}
			
			if ( $this-&gt;_response-&gt;get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this-&gt;_parse_location( $this-&gt;_response-&gt;get_header( 'Location') );
				$this-&gt;disconnect();
				$this-&gt;use_proxy( $location['host'], $location['port'] );
				$this-&gt;multipart_post( $this-&gt;uri, $form_fields, $form_files, $referer );
			}

			return $this-&gt;_response-&gt;get_status();
		} // End of function multipart_post()



		function post( $uri, &amp;$form_data, $follow_redirects = true, $referer = '' ) {
			$this-&gt;uri = $uri;

			if ( ($this-&gt;_keep_alive &amp;&amp; !$this-&gt;connected) || !$this-&gt;_keep_alive ) {
				if ( !$this-&gt;_connect() ) {
					$this-&gt;errstr = 'Could not connect to ' . $this-&gt;host;
					return -1;
				}
			}
			$http_cookie = $this-&gt;_response-&gt;cookies-&gt;get( $this-&gt;host, $this-&gt;_current_directory( $uri ) );
			$body = substr( $this-&gt;_merge_form_data( $form_data ), 1 );
			$this-&gt;_request-&gt;body =  $body . HTTP_CRLF . HTTP_CRLF;
			$content_length = strlen( $body ); 

			if ($this-&gt;_use_proxy) {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host . ':' . $this-&gt;port );
				$this-&gt;_request-&gt;set_header( 'Proxy-Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				if ( $this-&gt;_proxy_login != '' ) $this-&gt;_request-&gt;set_header( 'Proxy-Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_proxy_login . &quot;:&quot; . $this-&gt;_proxy_pwd ) );
				$uri = '<A HREF="http://">http://</A>' . $this-&gt;host . ':' . $this-&gt;port . $uri;
			} else {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host );
				$this-&gt;_request-&gt;set_header( 'Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				$this-&gt;_request-&gt;set_header( 'Pragma', 'no-cache' );
				$this-&gt;_request-&gt;set_header( 'Cache-Control', 'no-cache' );
			}
			
			if ( $this-&gt;_auth_login != '' ) $this-&gt;_request-&gt;set_header( 'Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_auth_login . &quot;:&quot; . $this-&gt;_auth_pwd ) );			
			$this-&gt;_request-&gt;set_header( 'Accept', '*/*' );
			$this-&gt;_request-&gt;set_header( 'Content-Type', 'application/x-www-form-urlencoded' );
			$this-&gt;_request-&gt;set_header( 'User-Agent', $this-&gt;user_agent );
			$this-&gt;_request-&gt;set_header( 'Content-Length', $content_length );
			$this-&gt;_request-&gt;set_header( 'Cookie', $http_cookie );
			$this-&gt;_request-&gt;set_header( 'Referer', $referer );
							
			$req_header	= &quot;POST $uri HTTP/&quot; . $this-&gt;http_version . HTTP_CRLF . 
						$this-&gt;_request-&gt;serialize_headers() .
						HTTP_CRLF;

			fwrite( $this-&gt;_socket, $req_header );
			usleep( 10 );
			fwrite( $this-&gt;_socket, $this-&gt;_request-&gt;body );
			
			$this-&gt;_request-&gt;add_debug_info( $req_header );
			$this-&gt;_get_response();

			if ($this-&gt;_socket &amp;&amp; !$this-&gt;_keep_alive) $this-&gt;disconnect();
			if ( $this-&gt;_response-&gt;get_header( 'Connection' ) != null ) {
				if ( $this-&gt;_keep_alive &amp;&amp; strtolower( $this-&gt;_response-&gt;get_header( 'Connection' ) ) == 'close' ) {
					$this-&gt;_keep_alive = false;
					$this-&gt;disconnect();
				}
			}
			
			if ( $follow_redirects &amp;&amp; ($this-&gt;_response-&gt;get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_FOUND || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this-&gt;_response-&gt;get_header( 'Location' ) != null ) {
					$this-&gt;_redirect( $this-&gt;_response-&gt;get_header( 'Location' ) );
				}
			}
			
			if ( $this-&gt;_response-&gt;get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this-&gt;_parse_location( $this-&gt;_response-&gt;get_header( 'Location' ) );
				$this-&gt;disconnect();
				$this-&gt;use_proxy( $location['host'], $location['port'] );
				$this-&gt;post( $this-&gt;uri, $form_data, $referer );
			}

			return $this-&gt;_response-&gt;get_status();
		} // End of function post()
		


		function post_xml( $uri, $xml_data, $follow_redirects = true, $referer = '' ) {
			$this-&gt;uri = $uri;

			if ( ($this-&gt;_keep_alive &amp;&amp; !$this-&gt;connected) || !$this-&gt;_keep_alive ) {
				if ( !$this-&gt;_connect() ) {
					$this-&gt;errstr = 'Could not connect to ' . $this-&gt;host;
					return -1;
				}
			}
			$http_cookie = $this-&gt;_response-&gt;cookies-&gt;get( $this-&gt;host, $this-&gt;_current_directory( $uri ) );
			$body = $xml_data;
			$this-&gt;_request-&gt;body =  $body . HTTP_CRLF . HTTP_CRLF;
			$content_length = strlen( $body ); 

			if ($this-&gt;_use_proxy) {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host . ':' . $this-&gt;port );
				$this-&gt;_request-&gt;set_header( 'Proxy-Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				if ( $this-&gt;_proxy_login != '' ) $this-&gt;_request-&gt;set_header( 'Proxy-Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_proxy_login . &quot;:&quot; . $this-&gt;_proxy_pwd ) );
				$uri = '<A HREF="http://">http://</A>' . $this-&gt;host . ':' . $this-&gt;port . $uri;
			} else {
				$this-&gt;_request-&gt;set_header( 'Host', $this-&gt;host );
				$this-&gt;_request-&gt;set_header( 'Connection', ($this-&gt;_keep_alive?'Keep-Alive':'Close') );
				$this-&gt;_request-&gt;set_header( 'Pragma', 'no-cache' );
				$this-&gt;_request-&gt;set_header( 'Cache-Control', 'no-cache' );
			}
			
			if ( $this-&gt;_auth_login != '' ) $this-&gt;_request-&gt;set_header( 'Authorization', &quot;Basic &quot; . base64_encode( $this-&gt;_auth_login . &quot;:&quot; . $this-&gt;_auth_pwd ) );			
			$this-&gt;_request-&gt;set_header( 'Accept', '*/*' );
			$this-&gt;_request-&gt;set_header( 'Content-Type', 'text/xml; charset=utf-8' );
			$this-&gt;_request-&gt;set_header( 'User-Agent', $this-&gt;user_agent );
			$this-&gt;_request-&gt;set_header( 'Content-Length', $content_length );
			$this-&gt;_request-&gt;set_header( 'Cookie', $http_cookie );
			$this-&gt;_request-&gt;set_header( 'Referer', $referer );
							
			$req_header	= &quot;POST $uri HTTP/&quot; . $this-&gt;http_version . HTTP_CRLF . 
						$this-&gt;_request-&gt;serialize_headers() .
						HTTP_CRLF;

			fwrite( $this-&gt;_socket, $req_header );
			usleep( 10 );
			fwrite( $this-&gt;_socket, $this-&gt;_request-&gt;body );
			
			$this-&gt;_request-&gt;add_debug_info( $req_header );
			$this-&gt;_get_response();

			if ($this-&gt;_socket &amp;&amp; !$this-&gt;_keep_alive) $this-&gt;disconnect();
			if ( $this-&gt;_response-&gt;get_header( 'Connection' ) != null ) {
				if ( $this-&gt;_keep_alive &amp;&amp; strtolower( $this-&gt;_response-&gt;get_header( 'Connection' ) ) == 'close' ) {
					$this-&gt;_keep_alive = false;
					$this-&gt;disconnect();
				}
			}
			
			if ( $follow_redirects &amp;&amp; ($this-&gt;_response-&gt;get_status() == HTTP_STATUS_MOVED_PERMANENTLY || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_FOUND || $this-&gt;_response-&gt;get_status() == HTTP_STATUS_SEE_OTHER ) ) {
				if ( $this-&gt;_response-&gt;get_header( 'Location' ) != null ) {
					$this-&gt;_redirect( $this-&gt;_response-&gt;get_header( 'Location' ) );
				}
			}
			
			if ( $this-&gt;_response-&gt;get_status() == HTTP_STATUS_USE_PROXY ) {
				$location = $this-&gt;_parse_location( $this-&gt;_response-&gt;get_header( 'Location' ) );
				$this-&gt;disconnect();
				$this-&gt;use_proxy( $location['host'], $location['port'] );
				$this-&gt;post( $this-&gt;uri, $form_data, $referer );
			}

			return $this-&gt;_response-&gt;get_status();
		} // End of function post_xml()
		
		
		function disconnect() {
			if ($this-&gt;_socket &amp;&amp; $this-&gt;connected) {
				 fclose($this-&gt;_socket);
	 			$this-&gt;connected = false;
			 }
		} // End of function disconnect()


		/********************************************************************************
		 * Private functions 
		 ********************************************************************************/
		 
		function _connect( ) {
			if ( $this-&gt;host == '' ) user_error( 'Class HTTP-&gt;_connect() : host property not set !' , E_ERROR );
			if (!$this-&gt;_use_proxy)
				$this-&gt;_socket = fsockopen( $this-&gt;host, $this-&gt;port, $errno, $errstr, 10 );
			else
				$this-&gt;_socket = fsockopen( $this-&gt;_proxy_host, $this-&gt;_proxy_port, $errno, $errstr, 10 );
			$this-&gt;errstr  = $errstr;
			$this-&gt;connected = ($this-&gt;_socket == true);
			return $this-&gt;connected;
		} // End of function connect()


		function _merge_multipart_form_data( $boundary, &amp;$form_fields, &amp;$form_files ) {
			$boundary = '--' . $boundary;
			$multipart_body = '';
			foreach ( $form_fields as $name =&gt; $data) {
				$multipart_body .= $boundary . HTTP_CRLF;
				$multipart_body .= 'Content-Disposition: form-data; name=&quot;' . $name . '&quot;' . HTTP_CRLF;
				$multipart_body .=  HTTP_CRLF;
				$multipart_body .= $data . HTTP_CRLF;
			}
			if ( isset($form_files) ) {
				foreach ( $form_files as $data) {
					$multipart_body .= $boundary . HTTP_CRLF;
					$multipart_body .= 'Content-Disposition: form-data; name=&quot;' . $data['name'] . '&quot;; filename=&quot;' . $data['filename'] . '&quot;' . HTTP_CRLF;
					if ($data['content-type']!='') 
						$multipart_body .= 'Content-Type: ' . $data['content-type'] . HTTP_CRLF;
					else
						$multipart_body .= 'Content-Type: application/octet-stream' . HTTP_CRLF;
					$multipart_body .=  HTTP_CRLF;
					$multipart_body .= $data['data'] . HTTP_CRLF;
				}			
			}
			$multipart_body .= $boundary . '--' . HTTP_CRLF;
			return $multipart_body;
		} // End of function _merge_multipart_form_data()
		

		function _merge_form_data( &amp;$param_array,  $param_name = '' ) {
			$params = '';
			$format = ($param_name !=''?'&amp;'.$param_name.'[%s]=%s':'&amp;%s=%s');
			foreach ( $param_array as $key=&gt;$value ) {
				if ( !is_array( $value ) )
					$params .= sprintf( $format, $key, urlencode( $value ) );
				else
					$params .= $this-&gt;_merge_form_data( $param_array[$key],  $key );
			}
			return $params;
		} // End of function _merge_form_data()

		function _current_directory( $uri ) {
			$tmp = split( '/', $uri );
			array_pop($tmp);
			$current_dir = implode( '/', $tmp ) . '/';
			return ($current_dir!=''?$current_dir:'/');
		} // End of function _current_directory()		
		
		
		function _get_response( $get_body = true ) {
			$this-&gt;_response-&gt;reset();
			$this-&gt;_request-&gt;reset();
			$header = '';
			$body = '';
			$continue	= true;
			
			while ($continue) {
				$header = '';

				// Read the Response Headers
				while ( (($line = fgets( $this-&gt;_socket, 4096 )) != HTTP_CRLF || $header == '') &amp;&amp; !feof( $this-&gt;_socket ) ) { 
				    if ($line != HTTP_CRLF) $header .= $line; 
				}
				$this-&gt;_response-&gt;deserialize_headers( $header );
				$this-&gt;_response-&gt;parse_cookies( $this-&gt;host );
				
				$this-&gt;_response-&gt;add_debug_info( $header );
				$continue = ($this-&gt;_response-&gt;get_status() == HTTP_STATUS_CONTINUE);
				if ($continue) fwrite( $this-&gt;_socket, HTTP_CRLF );
			}

			if ( !$get_body ) return;

			// Read the Response Body
			if ( strtolower( $this-&gt;_response-&gt;get_header( 'Transfer-Encoding' ) ) != 'chunked' &amp;&amp; !$this-&gt;_keep_alive ) {
				while ( !feof( $this-&gt;_socket ) ) { 
				    $body .= fread( $this-&gt;_socket, 4096 ); 
				}
			} else {
				if ( $this-&gt;_response-&gt;get_header( 'Content-Length' ) != null ) {
					$content_length = (integer)$this-&gt;_response-&gt;get_header( 'Content-Length' );
					$body = fread( $this-&gt;_socket, $content_length ); 
				} else {
					if ( $this-&gt;_response-&gt;get_header( 'Transfer-Encoding' ) != null ) {
						if ( strtolower( $this-&gt;_response-&gt;get_header( 'Transfer-Encoding' ) ) == 'chunked' ) {
							$chunk_size = (integer)hexdec(fgets( $this-&gt;_socket, 4096 ) ); 
							while($chunk_size &gt; 0) {
								$body .= fread( $this-&gt;_socket, $chunk_size ); 
								fread( $this-&gt;_socket, strlen(HTTP_CRLF) ); 
								$chunk_size = (integer)hexdec(fgets( $this-&gt;_socket, 4096 ) ); 
							}
							// TODO : Read trailing http headers
						}
					} 
				}
			}
			$this-&gt;_response-&gt;body = $body;
		} // End of function _get_response()


		function _parse_location( $redirect_uri ) {
			$parsed_url 	= parse_url( $redirect_uri );
			$scheme 		= (isset($parsed_url['scheme'])?$parsed_url['scheme']:'');
			$port			= (isset($parsed_url['port'])?$parsed_url['port']:$this-&gt;port);
			$host 			= (isset($parsed_url['host'])?$parsed_url['host']:$this-&gt;host);
			$request_file 	= (isset($parsed_url['path'])?$parsed_url['path']:'');
			$query_string 	= (isset($parsed_url['query'])?$parsed_url['query']:'');
			if ( substr( $request_file, 0, 1 ) != '/' )
				$request_file = $this-&gt;_current_directory( $this-&gt;uri ) . $request_file;
			
			return array(	'scheme' =&gt; $scheme,
							'port' =&gt; $port,
							'host' =&gt; $host,
							'request_file' =&gt; $request_file,
							'query_string' =&gt; $query_string
			);

		} // End of function _parse_location()
		
		
		function _redirect( $uri ) {
			$location = $this-&gt;_parse_location( $uri );
			if ( $location['host'] != $this-&gt;host || $location['port'] != $this-&gt;port ) {
				$this-&gt;host = $location['host'];
				$this-&gt;port = $location['port'];
				if ( !$this-&gt;_use_proxy) $this-&gt;disconnect();
			}
			usleep( 100 );
			$this-&gt;get( $location['request_file'] . '?' . $location['query_string'] );
		} // End of function _redirect()

	} // End of class http
?&gt;
--- NEW FILE: index.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);
include_ecrire (&quot;inc_calendrier.php&quot;);

if ($HTTP_REFERER &amp;&amp; !strpos($HTTP_REFERER, _DIR_RESTEINT_ABS)) $bonjour = 'oui';

debut_page(_T('titre_page_index'), &quot;asuivre&quot;, &quot;asuivre&quot;);

debut_gauche();


if ($spip_display != 4) {
	
	//
	// Infos personnelles : nom, utilisation de la messagerie
	//
	
	
	echo &quot;&lt;p&gt;&quot;;
	
	$titre_cadre = afficher_plus(&quot;auteurs_edit.php3?id_auteur=$connect_id_auteur&quot;);
	$titre_cadre .= majuscules(typo($connect_nom));
	
	debut_cadre_couleur_foncee(&quot;fiche-perso-24.gif&quot;, false, '', '');
	echo &quot;&lt;center&gt;&lt;b&gt;&quot;.$titre_cadre.&quot;&lt;/b&gt;&lt;/center&gt;&quot;;
	fin_cadre_couleur_foncee();
	

	//
	// Supprimer le cookie, se deconnecter...
	//
	
	if ($connect_statut == &quot;0minirezo&quot; AND $cookie_admin) {
		$texte = _T('icone_supprimer_cookie');
		if ($spip_display != 1) $texte .= aide(&quot;cookie&quot;);
		icone_horizontale( $texte , &quot;../spip_cookie.php3?cookie_admin=non&amp;url=&quot;.rawurlencode(_DIR_RESTREINT_ABS), &quot;cookie-24.gif&quot;, &quot;&quot;);
	}

	$nom_site_spip = propre(lire_meta(&quot;nom_site&quot;));
	if (!$nom_site_spip) $nom_site_spip=&quot;SPIP&quot;;
	
	
	echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
	
	echo debut_cadre_relief(&quot;racine-site-24.gif&quot;, false, &quot;&quot;, $nom_site_spip);


	if ($spip_display != 1) {
		include_ecrire(&quot;inc_logos.php3&quot;);
	
		$logo = decrire_logo(&quot;rubon0&quot;);
		if ($logo) {
			echo &quot;&lt;div style='text-align:center; margin-bottom: 5px;'&gt;&lt;a href='naviguer.php3'&gt;&quot;;
			echo $logo[2];
			echo &quot;&lt;/a&gt;&lt;/div&gt;&quot;;
		}
	}
	echo &quot;&lt;div class='verdana1'&gt;&quot;;

  $query = &quot;SELECT count(*) AS cnt, statut FROM spip_articles GROUP BY statut&quot;;
  $res = spip_query($query);
  
  while($row = spip_fetch_array($res)) {
    $var  = 'nb_art_'.$row['statut'];
    $$var = $row['cnt']; 
  }
  
	if ($nb_art_prepa OR $nb_art_prop OR $nb_art_publie) {

		echo afficher_plus(&quot;articles_page.php3&quot;).&quot;&lt;b&gt;&quot;._T('info_articles').&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'&gt;&quot;;
		if ($nb_art_prepa) echo &quot;&lt;li&gt;&quot;._T(&quot;texte_statut_en_cours_redaction&quot;).&quot;: &quot;.$nb_art_prepa;
		if ($nb_art_prop) echo &quot;&lt;li&gt;&quot;._T(&quot;texte_statut_attente_validation&quot;).&quot;: &quot;.$nb_art_prop;
		if ($nb_art_publie) echo &quot;&lt;li&gt;&lt;b&gt;&quot;._T(&quot;texte_statut_publies&quot;).&quot;: &quot;.$nb_art_publie.&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;/ul&gt;&quot;;

	}

	$query = &quot;SELECT count(*) AS cnt, statut FROM spip_breves GROUP BY statut&quot;;
	$res = spip_query($query);

	while($row = spip_fetch_array($res)) {
		$var  = 'nb_bre_'.$row['statut'];
		$$var = $row['cnt']; 
	}

	if ($nb_bre_prop OR $nb_bre_publie) {
		echo afficher_plus(&quot;breves.php3&quot;).&quot;&lt;b&gt;&quot;._T('info_breves_02').&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'&gt;&quot;;
		if ($nb_bre_prop) echo &quot;&lt;li&gt;&quot;._T(&quot;texte_statut_attente_validation&quot;).&quot;: &quot;.$nb_bre_prop;
		if ($nb_bre_publie) echo &quot;&lt;li&gt;&lt;b&gt;&quot;._T(&quot;texte_statut_publies&quot;).&quot;: &quot;.$nb_bre_publie.&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;/ul&gt;&quot;;
	}

	$query = &quot;SELECT count(*) AS cnt FROM spip_forum where statut='publie'&quot;;
	$result = spip_fetch_array(spip_query($query));
	$nb_forum = $result['cnt'];

	if ($nb_forum) {
		if ($connect_statut == &quot;0minirezo&quot;) echo afficher_plus(&quot;controle_forum.php3&quot;);
		echo &quot;&lt;b&gt;&quot;._T('onglet_messages_publics').&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'&gt;&quot;;
		echo &quot;&lt;li&gt;&lt;b&gt;&quot;.$nb_forum.&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;/ul&gt;&quot;;
	}

	$query = &quot;SELECT count(*) AS cnt, statut FROM spip_auteurs GROUP BY statut&quot;;
	$res = spip_query($query);

	while($row = spip_fetch_array($res)) {
		$var  = 'nb_aut_'.$row['statut'];
		$$var = $row['cnt']; 
	}

	if ($nb_aut_0minirezo OR $nb_aut_1comite OR $nb_aut_6forum) {
		echo afficher_plus(&quot;auteurs.php3&quot;).&quot;&lt;b&gt;&quot;._T('icone_auteurs').&quot;&lt;/b&gt;&quot;;
		echo &quot;&lt;ul style='margin:0px; padding-$spip_lang_left: 20px; margin-bottom: 5px;'&gt;&quot;;
		if ($nb_aut_0minirezo) echo &quot;&lt;li&gt;&quot;._T(&quot;info_administrateurs&quot;).&quot;: &quot;.$nb_aut_0minirezo;
		if ($nb_aut_1comite) echo &quot;&lt;li&gt;&quot;._T(&quot;info_redacteurs&quot;).&quot;: &quot;.$nb_aut_1comite;
		if ($nb_aut_6forum) echo &quot;&lt;li&gt;&quot;._T(&quot;info_visiteurs&quot;).&quot;: &quot;.$nb_aut_6forum;
		echo &quot;&lt;/ul&gt;&quot;;
	}

	echo &quot;&lt;/div&gt;&quot;;

	echo fin_cadre_relief();


//
// Afficher les raccourcis : boutons de creation d'article et de breve, etc.
//


	creer_colonne_droite();
	echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;	


	
	//
	// Annonces
	//
	echo    http_calendrier_rv(sql_calendrier_taches_annonces(),&quot;annonces&quot;);
	echo    http_calendrier_rv(sql_calendrier_taches_pb(),&quot;pb&quot;) ;
	echo    http_calendrier_rv(sql_calendrier_taches_rv(), &quot;rv&quot;);

	
	//
	// Afficher le calendrier du mois s'il y a des rendez-vous
	//
	
		$today = getdate(time());
		$jour_today = $today[&quot;mday&quot;];
		$mois_today = $today[&quot;mon&quot;];
		$annee_today = $today[&quot;year&quot;];
		$date = date(&quot;Y-m-d&quot;, mktime(0,0,0,$mois_today, 1, $annee_today));
		$mois = mois($date);
		$annee = annee($date);
		$jour = jour($date);
	
		// rendez-vous personnels dans le mois
		$result_messages = spip_query(&quot;SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
				&quot;WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') &quot;.
				&quot;AND messages.rv='oui' AND messages.date_heure &gt;='$annee-$mois-1' AND date_heure &lt; DATE_ADD('$annee-$mois-1', INTERVAL 1 MONTH) &quot;.
				&quot;AND messages.statut='publie' LIMIT 0,1&quot;);
		if (spip_num_rows($result_messages)) {
			echo &quot;&lt;p /&gt;&quot;;
			echo http_calendrier_agenda ($mois_today, $annee_today, $jour_today, $mois_today, $annee_today);
		}
		// rendez-vous personnels dans le mois
		$result_messages = spip_query(&quot;SELECT messages.id_message FROM spip_messages AS messages, spip_auteurs_messages AS lien &quot;.
				&quot;WHERE ((lien.id_auteur='$connect_id_auteur' AND lien.id_message=messages.id_message) OR messages.type='affich') &quot;.
				&quot;AND messages.rv='oui' AND messages.date_heure &gt;='$annee_today-$mois_today-$jour_today' AND messages.date_heure &lt; DATE_ADD('$annee_today-$mois_today-$jour_today', INTERVAL 1 DAY) &quot;.
				&quot;AND messages.statut='publie' LIMIT 0,1&quot;);
		if (spip_num_rows($result_messages)) {
			echo &quot;&lt;p /&gt;&quot;;
		echo http_calendrier_jour($jour_today,$mois_today,$annee_today, &quot;col&quot;);
		}
}


debut_droite();



//
// Restauration d'une archive
//

if ($meta[&quot;debut_restauration&quot;]) {
	@ignore_user_abort(1);
	include_ecrire(&quot;inc_import.php3&quot;);

	$archive = $meta[&quot;fichier_restauration&quot;];
	$my_pos = $meta[&quot;status_restauration&quot;];
	$ok = @file_exists($archive);

	if ($ok) {
		if (ereg(&quot;\.gz$&quot;, $archive)) {
			$affiche_progression_pourcent = false;
			$taille = taille_en_octets($my_pos);
		}
		else {
			$affiche_progression_pourcent = filesize($archive);
			$taille = floor(100 * $my_pos / $affiche_progression_pourcent).&quot; %&quot;;
		}
		$texte_boite = _T('info_base_restauration').&quot;&lt;p&gt;
		&lt;form name='progression'&gt;&lt;center&gt;&lt;input type='text' size=10 style='text-align:center;' name='taille' value='$taille'&gt;&lt;br&gt;
		&lt;input type='text' class='forml' name='recharge' value='&quot;._T('info_recharger_page').&quot;'&gt;&lt;/center&gt;&lt;/form&gt;&quot;;
	}
	else {
		$texte_boite = _T('info_erreur_restauration');
	}

	debut_boite_alerte();
	echo &quot;&lt;font FACE='Verdana,Arial,Sans,sans-serif' SIZE=4 color='black'&gt;&lt;B&gt;$texte_boite&lt;/B&gt;&lt;/font&gt;&quot;;
	fin_boite_alerte();
	fin_page(&quot;jimmac&quot;);
	echo &quot;&lt;/HTML&gt;&lt;font color='white'&gt;\n&lt;!--&quot;;
	@flush();
	$gz = $flag_gz;
	$_fopen = ($gz) ? gzopen : fopen;

	if ($ok) {
		$f = $_fopen($archive, &quot;rb&quot;);
		$pos = 0;
		$buf = &quot;&quot;;
		if (!import_all($f, $gz)) import_abandon();
	}
	else {
		import_fin();
	}
	exit;
}


//
// Articles post-dates en attente de publication
//

$post_dates = lire_meta(&quot;post_dates&quot;);

if ($post_dates == &quot;non&quot; AND $connect_statut == '0minirezo' AND $options == 'avancees') {
	echo &quot;&lt;p&gt;&quot;;
	afficher_articles(_T('info_article_a_paraitre'),
		&quot;WHERE statut='publie' AND date&gt;NOW() ORDER BY date&quot;);
}



//
// Vos articles en cours de redaction
//

echo &quot;&lt;p&gt;&quot;;
$vos_articles = afficher_articles(afficher_plus('articles_page.php3')._T('info_en_cours_validation'),
	&quot;, spip_auteurs_articles AS lien WHERE articles.id_article=lien.id_article &quot;.
	&quot;AND lien.id_auteur=$connect_id_auteur AND articles.statut='prepa' ORDER BY articles.date DESC&quot;);

if ($vos_articles) $vos_articles = ' AND articles.id_article NOT IN ('.join($vos_articles,',').')';

echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
echo debut_cadre_trait_couleur();

//
// Raccourcis pour malvoyants
//
if ($spip_display == 4) {
	debut_raccourcis();
	$query = &quot;SELECT id_rubrique FROM spip_rubriques LIMIT 0,1&quot;;
	$result = spip_query($query);
	
	if (spip_num_rows($result) &gt; 0) {
		icone_horizontale(_T('icone_ecrire_article'), &quot;articles_edit.php3?new=oui&quot;, &quot;article-24.gif&quot;,&quot;creer.gif&quot;);
	
		$activer_breves = lire_meta(&quot;activer_breves&quot;);
		if ($activer_breves != &quot;non&quot;) {
			icone_horizontale(_T('icone_nouvelle_breve'), &quot;breves_edit.php3?new=oui&quot;, &quot;breve-24.gif&quot;,&quot;creer.gif&quot;);
		}
	}
	else {
		if ($connect_statut == '0minirezo') {
			echo &quot;&lt;div class='verdana11'&gt;&quot;._T('info_ecrire_article').&quot;&lt;/div&gt;&quot;;
		}
	}
	if ($connect_statut == '0minirezo' and $connect_toutes_rubriques) {
		icone_horizontale(_T('icone_creer_rubrique_2'), &quot;rubriques_edit.php3?new=oui&quot;, &quot;rubrique-24.gif&quot;,&quot;creer.gif&quot;);
	}
	fin_raccourcis();
} else {

		$query = &quot;SELECT id_rubrique FROM spip_rubriques LIMIT 0,1&quot;;
		$result = spip_query($query);
		$gadget = &quot;&quot;;
		
		if (spip_num_rows($result) &gt; 0) {
			$id_rubrique = $GLOBALS['id_rubrique'];
			if ($id_rubrique &gt; 0) {
				$dans_rub = &quot;&amp;id_rubrique=$id_rubrique&quot;;
				$dans_parent = &quot;&amp;id_parent=$id_rubrique&quot;;
			}
			$gadget = &quot;&lt;center&gt;&lt;table&gt;&lt;tr&gt;&quot;;
			if ($connect_statut == &quot;0minirezo&quot;) {
				$gadget .= &quot;&lt;td&gt;&quot;;
				$gadget .= icone_horizontale(_T('icone_creer_rubrique'), &quot;rubriques_edit.php3?new=oui&quot;, &quot;rubrique-24.gif&quot;, &quot;creer.gif&quot;, false);
				$gadget .= &quot;&lt;/td&gt;&quot;;
			}
			
			$gadget .= &quot;&lt;td&gt;&quot;;
			$gadget .= icone_horizontale(_T('icone_ecrire_article'), &quot;articles_edit.php3?new=oui$dans_rub&quot;, &quot;article-24.gif&quot;,&quot;creer.gif&quot;, false);
			$gadget .= &quot;&lt;/td&gt;&quot;;
			
			$activer_breves = lire_meta(&quot;activer_breves&quot;);
			if ($activer_breves != &quot;non&quot;) {
				$gadget .= &quot;&lt;td&gt;&quot;;
				$gadget .= icone_horizontale(_T('icone_nouvelle_breve'), &quot;breves_edit.php3?new=oui$dans_rub&quot;, &quot;breve-24.gif&quot;,&quot;creer.gif&quot;, false);
				$gadget .= &quot;&lt;/td&gt;&quot;;
			}
			
			if (lire_meta(&quot;activer_sites&quot;) == 'oui') {
				if ($connect_statut == '0minirezo' OR lire_meta(&quot;proposer_sites&quot;) &gt; 0) {
					$gadget .= &quot;&lt;td&gt;&quot;;
					$gadget .= icone_horizontale(_T('info_sites_referencer'), &quot;sites_edit.php3?new=oui$dans_rub&quot;, &quot;site-24.gif&quot;,&quot;creer.gif&quot;, false);
					$gadget .= &quot;&lt;/td&gt;&quot;;
				}
			}
			
		}

		$gadget .= &quot;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;\n&quot;;

	echo $gadget;



	if ($connect_statut != &quot;0minirezo&quot;) {
	
		$gadget = &quot;&lt;center&gt;&lt;table&gt;&lt;tr&gt;&quot;;
	
		$nombre_articles = spip_num_rows(spip_query(&quot;SELECT art.id_article FROM spip_articles AS art, spip_auteurs_articles AS lien WHERE lien.id_auteur = '$connect_id_auteur' AND art.id_article = lien.id_article LIMIT 0,1&quot;));
		if ($nombre_articles &gt; 0) {
			$gadget .= &quot;&lt;td&gt;&quot;;
			$gadget .= icone_horizontale (_T('icone_tous_articles'), &quot;articles_page.php3&quot;, &quot;article-24.gif&quot;, &quot;&quot;, false);
			$gadget .= &quot;&lt;/td&gt;&quot;;
		}
	
		$activer_breves=lire_meta(&quot;activer_breves&quot;);
		if ($activer_breves != &quot;non&quot;){
			$gadget .= &quot;&lt;td&gt;&quot;;
			$gadget .= icone_horizontale (_T('icone_breves'), &quot;breves.php3&quot;, &quot;breve-24.gif&quot;, &quot;&quot;, false);
			$gadget .= &quot;&lt;/td&gt;&quot;;
		}
	
		$articles_mots = lire_meta('articles_mots');
		if ($articles_mots != &quot;non&quot;) {
			$gadget .= &quot;&lt;td&gt;&quot;;
			$gadget .= icone_horizontale  (_T('icone_mots_cles'), &quot;mots_tous.php3&quot;, &quot;mot-cle-24.gif&quot;, &quot;&quot;, false);
			$gadget .= &quot;&lt;/td&gt;&quot;;
		}

		$activer_sites = lire_meta('activer_sites');
		if ($activer_sites&lt;&gt;'non') {
			$gadget .= &quot;&lt;td&gt;&quot;;
			$gadget .= icone_horizontale  (_T('icone_sites_references'), &quot;sites_tous.php3&quot;, &quot;site-24.gif&quot;, &quot;&quot;, false);
			$gadget .= &quot;&lt;/td&gt;&quot;;
		}
		$gadget .= &quot;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;\n&quot;;
		
		echo $gadget;
	}

}




//
// Modification du cookie
//

if ($connect_statut == &quot;0minirezo&quot; AND $spip_display != 4) {
	if (!$cookie_admin) {
		echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;
		echo &quot;&lt;table width=95%&gt;&lt;tr&gt;&quot;;
		echo &quot;&lt;td width=100%&gt;&quot;;
		echo _T('info_activer_cookie');
		echo aide (&quot;cookie&quot;);
		echo &quot;&lt;/td&gt;&quot;;
		echo &quot;&lt;td width=10&gt;&lt;img src='&quot; . _DIR_IMG_PACK . &quot;rien.gif' width=10 alt='' /&gt;&quot;;
		echo &quot;&lt;/td&gt;&quot;;
		echo &quot;&lt;td width='250'&gt;&quot;;
		icone_horizontale(_T('icone_activer_cookie'), &quot;../spip_cookie.php3?cookie_admin=&quot;.rawurlencode(&quot;@$connect_login&quot;).&quot;&amp;url=&quot;.rawurlencode(_DIR_RESTREINT_ABS), &quot;cookie-24.gif&quot;, &quot;&quot;);
		echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
	}
}
echo fin_cadre_trait_couleur();
echo &quot;&lt;div&gt;&nbsp;&lt;/div&gt;&quot;;


//
// Verifier les boucles a mettre en relief
//

$relief = false;

if (!$relief) {
	$query = &quot;SELECT id_article FROM spip_articles AS articles WHERE statut='prop'$vos_articles LIMIT 0,1&quot;;
	$result = spip_query($query);
	$relief = (spip_num_rows($result) &gt; 0);
}

if (!$relief) {
	$query = &quot;SELECT id_breve FROM spip_breves WHERE statut='prop' LIMIT 0,1&quot;;
	$result = spip_query($query);
	$relief = (spip_num_rows($result) &gt; 0);
}

if (!$relief AND lire_meta('activer_syndic') != 'non') {
	$query = &quot;SELECT id_syndic FROM spip_syndic WHERE statut='prop' LIMIT 0,1&quot;;
	$result = spip_query($query);
	$relief = (spip_num_rows($result) &gt; 0);
}

if (!$relief AND lire_meta('activer_syndic') != 'non' AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
	$query = &quot;SELECT id_syndic FROM spip_syndic WHERE syndication='off' LIMIT 0,1&quot;;
	$result = spip_query($query);
	$relief = (spip_num_rows($result) &gt; 0);
}


if ($relief) {
	debut_cadre_couleur_foncee(&quot;&quot;,false, &quot;&quot;, _T('texte_en_cours_validation'));
	
	//echo &quot;&lt;div class='verdana2' style='color: black;'&gt;&lt;b&gt;&quot;._T('texte_en_cours_validation').&quot;&lt;/b&gt;&lt;/div&gt;&lt;p&gt;&quot;;

	//
	// Les articles a valider
	//
	afficher_articles(_T('info_articles_proposes'),
		&quot;WHERE statut='prop'$vos_articles ORDER BY date DESC&quot;);

	//
	// Les breves a valider
	//
	$query = &quot;SELECT * FROM spip_breves WHERE statut='prepa' OR statut='prop' ORDER BY date_heure DESC&quot;;
	afficher_breves(afficher_plus('breves.php3')._T('info_breves_valider'), $query, true);

	//
	// Les sites references a valider
	//
	if (afficher_plus('sites_tous.php3').lire_meta('activer_syndic') != 'non') {
		include_ecrire(&quot;inc_sites.php3&quot;);
		afficher_sites(afficher_plus('sites_tous.php3')._T('info_site_valider'), &quot;SELECT * FROM spip_syndic WHERE statut='prop' ORDER BY nom_site&quot;);
	}

	//
	// Les sites a probleme
	//
	if (lire_meta('activer_syndic') != 'non' AND $connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
		include_ecrire(&quot;inc_sites.php3&quot;);
		afficher_sites(afficher_plus('sites_tous.php3')._T('avis_sites_syndiques_probleme'),
			&quot;SELECT * FROM spip_syndic WHERE syndication='off' AND statut='publie' ORDER BY nom_site&quot;);
	}

	// Les articles syndiques en attente de validation
	if ($connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
		$result = spip_query (&quot;SELECT COUNT(*) AS compte FROM spip_syndic_articles WHERE statut='dispo'&quot;);
		if (($row = spip_fetch_array($result)) AND $row['compte'])
			echo &quot;&lt;br&gt;&lt;small&gt;&lt;a href='sites_tous.php3'&gt;&quot;.$row['compte'].&quot; &quot;._T('info_liens_syndiques_1').&quot;&lt;/a&gt; &quot;._T('info_liens_syndiques_2').&quot;&lt;/small&gt;&quot;;
	}

	// Les forums en attente de moderation
	if ($connect_statut == '0minirezo' AND $connect_toutes_rubriques) {
		$result = spip_query (&quot;SELECT COUNT(*) AS compte FROM spip_forum WHERE statut='prop'&quot;);
		if (($row = spip_fetch_array($result)) AND $row['compte']) {
			echo &quot;&lt;br&gt;&lt;small&gt; &lt;a href='controle_forum.php3'&gt;&quot;.$row['compte'];
			if ($row['compte']&gt;1)
				echo &quot; &quot;._T('info_liens_syndiques_3').&quot;&lt;/a&gt; &quot;._T('info_liens_syndiques_4');
			else
				echo &quot; &quot;._T('info_liens_syndiques_5').&quot;&lt;/a&gt; &quot;._T('info_liens_syndiques_6');
			echo &quot; &quot;._T('info_liens_syndiques_7').&quot;&lt;/small&gt;.&quot;;
		}
	}

	fin_cadre_couleur_foncee();
}


if ($options == 'avancees') {

	/* Ne plus afficher: il y a la page &quot;Tous vos articles&quot; pour cela
	// Vos articles publies
	echo &quot;&lt;p&gt;&quot;;
	afficher_articles(afficher_plus('articles_page.php3')._T('info_derniers_articles_publies'),
		&quot;, spip_auteurs_articles AS lien &quot;.
		&quot;WHERE articles.id_article=lien.id_article AND lien.id_auteur=\&quot;$connect_id_auteur\&quot; AND articles.statut=\&quot;publie\&quot; ORDER BY articles.date DESC&quot;, true);
	*/

	// Dernieres modifications d'articles
	include_ecrire(&quot;inc_suivi_revisions.php&quot;);
	afficher_suivi_versions (0, 0, false, &quot;&quot;, true);
}


fin_page(&quot;jimmac&quot;);


//
// Si necessaire, recalculer les rubriques
//

if (lire_meta('calculer_rubriques') == 'oui') {
	calculer_rubriques();
	effacer_meta('calculer_rubriques');
	ecrire_metas();
}


//
// Renouvellement de l'alea utilise pour valider certaines operations
// (ajouter une image, etc.)
//

$maj_alea = $meta_maj['alea_ephemere'];
$t_jour = substr($maj_alea, 6, 2);
if (abs($t_jour - date('d')) &gt; 2) {
	include_ecrire(&quot;inc_session.php3&quot;);
	$alea = md5(creer_uniqid());
	ecrire_meta('alea_ephemere_ancien', lire_meta('alea_ephemere'));
	ecrire_meta('alea_ephemere', $alea);
	ecrire_metas();
}


//
// Optimisation periodique de la base de donnees
//
if (!$bonjour) {
	if ($optimiser == 'oui' || (time() - lire_meta('date_optimisation')) &gt; 24 * 3600) {
		if (!file_exists($lock = _DIR_SESSIONS.'optimisation.lock')
		OR (time()-filemtime($lock) &gt; 3600)) {
			touch($lock);
			ecrire_meta(&quot;date_optimisation&quot;, time());
			ecrire_metas();
			include (&quot;optimiser.php3&quot;);
			unlink($lock);
		}
	}
}

?&gt;

--- NEW FILE: lab_ortho.php ---
&lt;?php

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_ECRIRE_INC_ORTHO&quot;)) return;
define(&quot;_ECRIRE_INC_ORTHO&quot;, &quot;1&quot;);


// Mettre a jour la liste locale des miroirs
function maj_miroirs_ortho() {
	$liste = explode(&quot; &quot;, lire_meta(&quot;liste_miroirs_ortho&quot;));
	$miroirs_old = array();
	foreach ($liste as $index) {
		list($url) = explode(&quot; &quot;, lire_meta(&quot;miroir_ortho_$index&quot;));
		$miroirs_old[$url] = $index;
	}

	// TODO: recuperer la liste dynamiquement depuis ortho.spip.net
	$urls = array(
		'<A HREF="http://tony.ortho.spip.net/ortho_serveur.php">http://tony.ortho.spip.net/ortho_serveur.php</A>',
		'<A HREF="http://spip-ortho.linagora.org:18080/ortho_serveur.php">http://spip-ortho.linagora.org:18080/ortho_serveur.php</A>',
		'<A HREF="http://ortho.spip.net/ortho_serveur.php">http://ortho.spip.net/ortho_serveur.php</A>'
	);
	$liste = array();
	$miroirs_new = array();
	$index = 1;
	foreach ($urls as $url) {
		if ($index_old = $miroirs_old[$url]) {
			$s = lire_meta(&quot;miroir_ortho_$index_old&quot;);
		}
		else {
			$s = $url.&quot; &quot;.time();
		}
		$miroirs_new[$index] = $s;
		$liste[] = $index++;
	}
	foreach ($miroirs_old as $index) {
		effacer_meta(&quot;miroir_ortho_$index&quot;);
	}
	foreach ($miroirs_new as $index =&gt; $s) {
		ecrire_meta(&quot;miroir_ortho_$index&quot;, $s);
	}
	ecrire_meta(&quot;liste_miroirs_ortho&quot;, join(&quot; &quot;, $liste));
}

// Lire la liste des miroirs et les langues associees
function lire_miroirs_ortho() {
	global $miroirs_ortho, $index_miroirs_ortho, $duree_cache_miroirs_ortho;

	$miroirs_ortho = array();
	$index_miroirs_ortho = array();

	$t = time();
	$maj = lire_meta(&quot;maj_miroirs_ortho&quot;);
	if ($maj &lt; $t - $duree_cache_miroirs_ortho) {
		maj_miroirs_ortho();
		ecrire_meta(&quot;maj_miroirs_ortho&quot;, $t);
		lire_metas();
	}

	$liste = explode(&quot; &quot;, lire_meta(&quot;liste_miroirs_ortho&quot;));
	foreach ($liste as $index) {
		$s = explode(&quot; &quot;, lire_meta(&quot;miroir_ortho_$index&quot;));
		$url = $s[0];
		$maj = $s[1];
		$langs = explode(&quot;,&quot;, $s[2]);
		// Reinitialiser periodiquement la liste des langues non-supportees
		if ($maj &lt; $t - $duree_cache_miroirs_ortho) {
			foreach ($langs as $key =&gt; $lang) {
				if (substr($lang, 0, 1) == '!') unset($langs[$key]);
			}
			$s[1] = $t;
			$s[2] = join(&quot;,&quot;, $langs);
			ecrire_meta(&quot;miroir_ortho_$index&quot;, join(&quot; &quot;, $s));
		}
		$index_miroirs_ortho[$url] = $index;
		$miroirs_ortho[$url] = array();
		foreach ($langs as $lang) {
			if ($lang) $miroirs_ortho[$url][$lang] = $lang;
		}
	}
	lire_metas();
	mt_srand(time());
}

// Sauvegarder les infos de langues pour le miroir
function ecrire_miroir_ortho($url, $langs) {
	global $index_miroirs_ortho;

	$index = $index_miroirs_ortho[$url];
	$s = explode(&quot; &quot;, lire_meta(&quot;miroir_ortho_$index&quot;));
	$s[2] = join(&quot;,&quot;, $langs);
	ecrire_meta(&quot;miroir_ortho_$index&quot;, join(&quot; &quot;, $s));
}

function ajouter_langue_miroir($url, $lang) {
	global $miroirs_ortho;
	$langs = $miroirs_ortho[$url];
	$langs[$lang] = $lang;
	unset($langs[&quot;!$lang&quot;]);
	ecrire_miroir_ortho($url, $langs);
}

function enlever_langue_miroir($url, $lang) {
	global $miroirs_ortho;
	$langs = $miroirs_ortho[$url];
	unset($langs[$lang]);
	$langs[&quot;!$lang&quot;] = &quot;!$lang&quot;;
	ecrire_miroir_ortho($url, $langs);
}

function reset_miroir($url) {
	global $miroirs_ortho;
	ecrire_miroir_ortho($url, array());
}

//
// Renvoie la liste des miroirs utilisables pour une langue donnee
//
function chercher_miroirs_ortho($lang) {
	global $miroirs_ortho;
	
	$result = array();
	$chercher = true;
	foreach ($miroirs_ortho as $url =&gt; $langs) {
		if ($langs[$lang]) {
			$result[] = $url;
		}
		else if ($chercher &amp;&amp; !$langs[&quot;!$lang&quot;]) {
			//echo &quot;test $lang $url&lt;br /&gt;&quot;;
			if (verifier_langue_miroir($url, $lang)) $result[] = $url;
			// Ne recuperer la langue d'un miroir qu'une seule fois par requete
			if ($result) $chercher = false;
		}
	}
	return $result;
}

function choisir_miroirs_ortho($lang) {
	$liste = chercher_miroirs_ortho($lang);
	if (!count($liste)) return false;
	foreach ($liste as $url) {
		$miroirs[md5(mt_rand().$url.rand())] = $url;
	}
	ksort($miroirs);
	return $miroirs;
}

//
// Envoyer une requete a un serveur d'orthographe
//
function post_ortho($url, $texte, $lang) {
	$errno = $errstr = &quot;&quot;;

	$t = parse_url($url);
	if ($t['scheme'] != 'http') return false;

	$http_proxy = lire_meta(&quot;http_proxy&quot;);
	if (eregi(&quot;^<A HREF="http://([^:">http://([^:</A>]*)(:(.*))?&quot;, $http_proxy, $rr)) {
		$host= $rr[1];
		if($rr[2]) {
			$port= $rr[3];
		} else {
			$port= 80;
		}
		$path= $url;
	} else {
		$host = $t['host'];
		$port = $t['port'] ? $t['port'] : 80;
		$path = $t['path'] ? $t['path'] : &quot;/&quot;;
	}

	// Envoyer la requete en POST
	$f = @fsockopen($host, $port, $errno, $errstr, 2);
	if (!$f) return false;
	fputs($f, &quot;POST $path HTTP/1.0\r\n&quot;);

	// Si le texte est petit, l'overhead du multipart est dispendieux
	if (!$GLOBALS['flag_gz'] || strlen($texte) &lt; 200) {
		$gz = false;
		$body = &quot;op=spell&amp;lang=&quot;.urlencode($lang).&quot;&amp;texte=&quot;.urlencode($texte);
		fputs($f, &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;);
	}
	// Sinon, on passe en multipart pour compresser la chaine a corriger
	else {
		// Il faut eliminer les caracteres 0 sinon PHP ne lit pas la suite du parametre
		// passe en multipart/form-data (gros hack bien sale)
		$texte_gz = gzcompress($texte);
		for ($echap = 255; $echap &gt; 0; $echap--) {
			$str_echap = chr($echap ^ 1).chr($echap).chr($echap).chr($echap ^ 2);
			if (!is_int(strpos($texte_gz, $str_echap))) break;
		}
		$texte_gz = str_replace(&quot;\x00&quot;, $str_echap, $texte_gz);
		$gz = true;
		$vars = array('op' =&gt; 'spell', 'lang' =&gt; $lang, 'texte' =&gt; $texte_gz, 'gz' =&gt; 1, 'nul_echap' =&gt; $str_echap);
		$boundary = substr(md5(rand().'ortho'), 0, 8);
		$body = '';
		foreach ($vars as $key =&gt; $val) {
			$body .= &quot;\r\n--$boundary\r\n&quot;;
			$body .= &quot;Content-Disposition: form-data; name=\&quot;$key\&quot;\r\n&quot;;
			$body .= &quot;\r\n&quot;;
			$body .= $val;
		}
		$body .= &quot;\r\n--$boundary\r\n&quot;;
		fputs($f, &quot;Content-Type: multipart/form-data; boundary=$boundary\r\n&quot;);
	}

	// On envoie le contenu
	fputs($f, &quot;Content-Length: &quot;.strlen($body).&quot;\r\n&quot;);
	fputs($f, &quot;Host: $host\r\n\r\n&quot;);
	fputs($f, $body);

	// Lire les en-tetes HTTP de la reponse et decoder le Content-Length
	$length = 0;
	$s = fgets($f, 1000);
	$statut = 0;
	if (preg_match(',^HTTP/\d+\.\d+ (\d+) ,', $s, $r))
		$statut = intval($r[1]);
	if ($statut != 200) {
		fclose($f);
		return false;
	}
	while ($s = trim(fgets($f, 1000))) {
		if (preg_match(',Content-Length:(.*),i', $s, $r))
			$length = intval($r[1]);
	}
	$r = &quot;&quot;;

	// Lire le corps de la reponse HTTP
	if ($length) {
		while (($l = strlen($r)) &lt; $length) $r .= fread($f, $length - $l);
	}
	else while (!feof($f) AND $r .= fread($f, 1024));

	fclose($f);
	if ($gz) $r = gzuncompress($r);
	return $r;
}

//
// Verifier si un serveur gere une langue donnee
//
function verifier_langue_miroir($url, $lang) {
	// Envoyer une requete bidon
	$result = post_ortho($url, &quot; &quot;, $lang);
	if (!preg_match(',&lt;ortho&gt;.*&lt;/ortho&gt;,s', $result)) {
		reset_miroir($url);
		return false;
	}
	if (!preg_match(',&lt;erreur&gt;.*&lt;code&gt;E_LANG_ABSENT&lt;/code&gt;.*&lt;/erreur&gt;,s', $result)) {
		ajouter_langue_miroir($url, $lang);
		return true;
	}
	enlever_langue_miroir($url, $lang);
	return false;
}


//
// Gestion du dictionnaire local
//
function suggerer_dico_ortho(&amp;$mots, $lang) {
	$lang = addslashes($lang);
	$query = &quot;SELECT mot FROM spip_ortho_dico WHERE lang='$lang' &quot;.
		&quot;AND mot IN ('&quot;.join(&quot;', '&quot;, array_map('addslashes', $mots)).&quot;')&quot;;
	$result = spip_query($query);

	$mots = array_flip($mots);
	$bons = array();
	if (isset($mots[''])) unset($mots['']);
	while ($row = spip_fetch_array($result)) {
		$mot = $row['mot'];
		if (isset($mots[$mot])) {
			unset($mots[$mot]);
			$bons[] = $mot;
		}
	}

	if (count($mots)) $mots = array_flip($mots);
	else $mots = array();
	return $bons;
}

function ajouter_dico_ortho($mot, $lang) {
	global $connect_id_auteur;

	$lang = addslashes($lang);
	$mot = addslashes($mot);
	$id_auteur = intval($connect_id_auteur);
	$query = &quot;INSERT IGNORE INTO spip_ortho_dico (lang, mot, id_auteur) &quot;.
		&quot;VALUES ('$lang', '$mot', '$id_auteur')&quot;;
	spip_query($query);
}

function supprimer_dico_ortho($mot, $lang) {
	$lang = addslashes($lang);
	$mot = addslashes($mot);
	$query = &quot;DELETE FROM spip_ortho_dico WHERE lang='$lang' AND mot='$mot'&quot;;
	spip_query($query);
}

function gerer_dico_ortho($lang) {
	global $ajout_ortho, $supp_ortho;
	if ($mot = strval($ajout_ortho)) {
		ajouter_dico_ortho($mot, $lang);
	}
	if ($mot = strval($supp_ortho)) {
		supprimer_dico_ortho($mot, $lang);
	}
}


//
// Gestion du cache de corrections
//
function suggerer_cache_ortho(&amp;$mots, $lang) {
	global $duree_cache_ortho;

	$lang = addslashes($lang);
	$query = &quot;SELECT mot, ok, suggest FROM spip_ortho_cache WHERE lang='$lang' &quot;.
		&quot;AND mot IN ('&quot;.join(&quot;', '&quot;, array_map('addslashes', $mots)).&quot;') &quot;.
		&quot;AND maj &gt; FROM_UNIXTIME(&quot;.(time() - $duree_cache_ortho).&quot;)&quot;;
	$result = spip_query($query);
	
	$mots = array_flip($mots);
	$suggest = array();
	if (isset($mots[''])) unset($mots['']);
	while ($row = spip_fetch_array($result)) {
		$mot = $row['mot'];
		if (isset($mots[$mot])) {
			unset($mots[$mot]);
			if (!$row['ok']) {
				if (strlen($row['suggest']))
					$suggest[$mot] = explode(&quot;,&quot;, $row['suggest']);
				else
					$suggest[$mot] = array();
			}
		}
	}
	if (count($mots)) $mots = array_flip($mots);
	else $mots = array();
	return $suggest;
}

function ajouter_cache_ortho($tous, $mauvais, $lang) {
	global $duree_cache_ortho;

	$values = array();
	$lang = addslashes($lang);
	if (count($mauvais)) {
		foreach ($mauvais as $mot =&gt; $suggest) {
			$values[] = &quot;('$lang', '&quot;.addslashes($mot).&quot;', 0, '&quot;.addslashes(join(&quot;,&quot;, $suggest)).&quot;')&quot;;
		}
	}
	if (count($tous)) {
		foreach ($tous as $mot) {
			if (!isset($mauvais[$mot]))
				$values[] = &quot;('$lang', '&quot;.addslashes($mot).&quot;', 1, '')&quot;;
		}
	}
	if (count($values)) {
		$query = &quot;DELETE FROM spip_ortho_cache &quot;.
			&quot;WHERE maj &lt; FROM_UNIXTIME(&quot;.(time() - $duree_cache_ortho).&quot;)&quot;;
		spip_query($query);
		$query = &quot;INSERT IGNORE INTO spip_ortho_cache (lang, mot, ok, suggest) &quot;.
			&quot;VALUES &quot;.join(&quot;, &quot;, $values);
		spip_query($query);
	}
}


//
// Cette fonction doit etre appelee pour reecrire le texte en utf-8 &quot;propre&quot;
//
function preparer_ortho($texte, $lang) {
	include_spip(&quot;charsets.php&quot;);

	$charset = lire_meta('charset');

	if ($charset == 'utf-8')
		return unicode_to_utf_8(html2unicode($texte));
	else
		return unicode_to_utf_8(html2unicode(charset2unicode($texte, $charset, true)));
}

function afficher_ortho($texte) {
	$charset = lire_meta('charset');
	if ($charset == 'utf-8') return $texte;

	if (!is_array($texte)) return charset2unicode($texte, 'utf-8');
	foreach ($texte as $key =&gt; $val) {
		$texte[$key] = afficher_ortho($val);
	}
	return $texte;
}

//
// Cette fonction envoie le texte prepare a un serveur d'orthographe
// et retourne un tableau de mots mal orthographies associes chacun a un tableau de mots suggeres
//
function corriger_ortho($texte, $lang, $charset = 'AUTO') {
	include_spip(&quot;charsets.php&quot;);
	include_spip(&quot;index.php&quot;);
	include_spip(&quot;filtres.php&quot;);

	$texte = preg_replace(',&lt;code&gt;.*?&lt;/code&gt;,is', '', $texte);
	$texte = preg_replace(',&lt;cadre&gt;.*?&lt;/cadre&gt;,is', '', $texte);
	$texte = preg_replace(',\[([^][]*)-&gt;([^][]*)\],is', '\\1', $texte);
	$texte = supprimer_tags($texte);

	$texte = &quot; &quot;.$texte.&quot; &quot;;
	
	// Virer les caracteres non-alphanumeriques
	if (test_pcre_unicode()) {
		$texte = preg_replace(',[^-\''.pcre_lettres_unicode().']+,us', ' ', $texte);
	}
	else {
		// Ici bidouilles si PCRE en mode UTF-8 ne fonctionne pas correctement ...
		// Caracteres non-alphanumeriques de la plage latin-1 + saloperies non-conformes
		$texte = preg_replace(',\xC2[\x80-\xBF],', ' ', $texte);
		// Poncutation etendue (unicode)
		$texte = preg_replace(&quot;,&quot;.plage_punct_unicode().&quot;,&quot;, ' ', $texte);
		// Caracteres ASCII non-alphanumeriques
		$texte = preg_replace(&quot;,[^-a-zA-Z0-9\x80-\xFF']+,&quot;, ' ', $texte);
	}
	$texte = preg_replace(', [-\']+,', ' ', $texte); // tirets de typo
	$texte = preg_replace(',\' ,', ' ', $texte); // apostrophes utilisees comme guillemets

	//echo htmlspecialchars($texte).&quot;&lt;br&gt;&quot;;

	// Virer les mots contenant au moins un chiffre
	$texte = preg_replace(', ([^ ]*\d[^ ]* )+,', ' ', $texte);

	// Melanger les mots
	$mots = preg_split(', +,', $texte);
	sort($mots);
	$mots = array_unique($mots);

	// 1. Enlever les mots du dico local
	$bons = suggerer_dico_ortho($mots, $lang);

	// 2. Enlever les mots du cache local
	$result_cache = suggerer_cache_ortho($mots, $lang);

	// 3. Envoyer les mots restants a un serveur
	$mauvais = array();
	if (count($mots)) {
		$texte = join(' ', $mots);
		
		// Hack : ligatures en francais pas gerees par aspell
		unset($trans_rev);
		$texte_envoi = $texte;
		if ($lang == 'fr') {
			$trans = array(chr(197).chr(146) =&gt; 'OE', chr(197).chr(147) =&gt; 'oe', 
					chr(195).chr(134) =&gt; 'AE', chr(195).chr(166) =&gt; 'ae');
			$texte_envoi = strtr($texte_envoi, $trans);
			$trans_rev = array_flip($trans);
		}
		
		// POST de la requete et recuperation du resultat XML
		$urls = choisir_miroirs_ortho($lang);
		if (!$urls) return false;
		unset($ok);
		$erreur = false;
		foreach ($urls as $url) {
			$xml = post_ortho($url, $texte_envoi, $lang);
			if ($xml &amp;&amp; preg_match(',&lt;ortho&gt;(.*)&lt;/ortho&gt;,s', $xml, $r)) {
				$xml = $r[1];
				if (preg_match(',&lt;erreur&gt;.*&lt;code&gt;(.*)&lt;/code&gt;.*&lt;/erreur&gt;,s', $xml, $r)) 
					$erreur = $r[1];
				if (preg_match(',&lt;ok&gt;(.*)&lt;/ok&gt;,s', $xml, $r)) {
					$ok = $r[1];
					break;
				}
			}
			reset_miroir($url);
		}
		if (!isset($ok)) return $erreur;

		// Remplir le tableau des resultats (mots mal orthographies)
		if ($trans_rev) {
			$assoc_mots = array_flip($mots);
		}
		while (preg_match(',&lt;mot&gt;(.*?)&lt;/mot&gt;(\s*&lt;suggest&gt;(.*?)&lt;/suggest&gt;)?,s', $ok, $r)) {
			$p = strpos($ok, $r[0]);
			$ok = substr($ok, $p + strlen($r[0]));
			$mot = $r[1];
			if ($suggest = $r[3]) 
				$s = preg_split('/[ ,]+/', $suggest);
			else 
				$s = array();
			// Hack ligatures
			if ($trans_rev) {
				$mot_rev = strtr($mot, $trans_rev);
				if ($mot != $mot_rev) {
					if ($assoc_mots[$mot]) 
						$mauvais[$mot] = $s;
					if ($assoc_mots[$mot_rev]) 
						$mauvais[$mot_rev] = $s;
				}
				else $mauvais[$mot] = $s;
			}
			else $mauvais[$mot] = $s;
		}
	}
	if (!$erreur) ajouter_cache_ortho($mots, $mauvais, $lang);

	// Retour a l'envoyeur
	$mauvais = array_merge($result_cache, $mauvais);
	$result = array(
		'bons' =&gt; $bons,
		'mauvais' =&gt; $mauvais
	);
	if ($erreur) $result['erreur'] = $erreur;
	return $result;
}

//
// Fonctions d'affichage HTML
//

function panneau_ortho($ortho_result) {
	global $id_suggest;

	$id_suggest = array();
	$i = 1;

	$mauvais = $ortho_result['mauvais'];
	$bons = $ortho_result['bons'];
	if (!count($mauvais) &amp;&amp; !count($bons)) return;
	ksort($mauvais);

	echo &quot;&lt;script type='text/javascript'&gt;&lt;!--
	var curr_suggest = null;
	function suggest(id) {
		var menu_box;
		if (curr_suggest)
			document.getElementById('suggest' + curr_suggest).className = 'suggest-inactif';
		if (1 || id!=curr_suggest) {
			document.getElementById('suggest' + id).className = 'suggest-actif';
			curr_suggest = id;
		}
		else curr_suggest = null;
		menu_box = document.getElementById('select_ortho');
		if (menu_box.length &gt; id) menu_box.selectedIndex = id;
	}&quot;;
	echo &quot;//--&gt;&lt;/script&gt;&quot;;

	echo &quot;&lt;form class='form-ortho verdana2' action='' method='get'&gt;\n&quot;;
	echo &quot;&lt;select name='select_ortho' id='select_ortho' onChange='suggest(this.selectedIndex);'&gt;\n&quot;;
	echo &quot;&lt;option value='0'&gt;... &quot;._T('ortho_mots_a_corriger').&quot; ...&lt;/option&gt;\n&quot;;
	foreach ($mauvais as $mot =&gt; $suggest) {
		$id = $id_suggest[$mot] = &quot;$i&quot;;
		$i++;
		$mot_html = afficher_ortho($mot);
		echo &quot;&lt;option value='$id'&gt;$mot_html&lt;/option&gt;\n&quot;;
	}
	foreach ($bons as $mot) {
		$id = $id_suggest[$mot] = &quot;$i&quot;;
		$i++;
	}
	echo &quot;&lt;/select&gt;\n&quot;;
	echo &quot;&lt;/form&gt;\n&quot;;
	// Mots mal orthographies :
	// liste des suggestions plus lien pour ajouter au dico
	foreach ($mauvais as $mot =&gt; $suggest) {
		$id = $id_suggest[$mot];
		$mot_html = afficher_ortho($mot);
		echo &quot;&lt;div class='suggest-inactif' id='suggest$id'&gt;&quot;;
		echo &quot;&lt;span class='ortho'&gt;$mot_html&lt;/span&gt;\n&quot;;
		echo &quot;&lt;div class='detail'&gt;\n&quot;;
		if (is_array($suggest) &amp;&amp; count($suggest)) {
			echo &quot;&lt;ul&gt;\n&quot;;
			$i = 0;
			foreach ($suggest as $sug) {
				if (++$i &gt; 12) {
					echo &quot;&lt;li&gt;&lt;i&gt;(...)&lt;/i&gt;&lt;/li&gt;\n&quot;;
					break;
				}
				echo &quot;&lt;li&gt;&quot;.typo(afficher_ortho($sug)).&quot;&lt;/li&gt;\n&quot;;
			}
			echo &quot;&lt;/ul&gt;\n&quot;;
		}
		else {
			echo &quot;&lt;i&gt;&quot;._T('ortho_aucune_suggestion').&quot;&lt;/i&gt;&quot;;
		}
		echo &quot;&lt;br /&gt;&quot;;
		$link = new Link;
		$link-&gt;delVar('supp_ortho');
		$link-&gt;addVar('ajout_ortho', $mot);
		icone_horizontale(_T('ortho_ajouter_ce_mot'), $link-&gt;getUrl(), &quot;ortho-24.gif&quot;, &quot;creer.gif&quot;);
		echo &quot;&lt;/div&gt;\n&quot;;
		echo &quot;&lt;/div&gt;\n\n&quot;;
	}
	// Mots trouves dans le dico :
	// message plus lien pour retirer du dico
	foreach ($bons as $mot) {
		$id = $id_suggest[$mot];
		$mot_html = afficher_ortho($mot);
		echo &quot;&lt;div class='suggest-inactif' id='suggest$id'&gt;&quot;;
		echo &quot;&lt;span class='ortho-dico'&gt;$mot_html&lt;/span&gt;&quot;;
		echo &quot;&lt;div class='detail'&gt;\n&quot;;
		echo &quot;&lt;i&gt;&quot;._T('ortho_ce_mot_connu').&quot;&lt;/i&gt;&quot;;
		echo &quot;&lt;br /&gt;&quot;;
		$link = new Link;
		$link-&gt;delVar('ajout_ortho');
		$link-&gt;addVar('supp_ortho', $mot);
		icone_horizontale(_T('ortho_supprimer_ce_mot'), $link-&gt;getUrl(), &quot;ortho-24.gif&quot;, &quot;supprimer.gif&quot;);
		echo &quot;&lt;/div&gt;\n&quot;;
		echo &quot;&lt;/div&gt;\n&quot;;
	}
}


function souligner_match_ortho(&amp;$texte, $cherche, $remplace) {
	// Eviter les &mdash;, etc.
	if ($cherche{0} == '&amp;' AND $cherche{strlen($cherche) - 1} == ';') return;

	if ($cherche{0} == '&gt;') 
		$texte = str_replace($cherche, $remplace, $texte);
	else {
		// Ne pas remplacer a l'interieur des tags HTML
		$table = explode($cherche, $texte);
		unset($avant);
		$texte = '';
		foreach ($table as $s) {
			if (!isset($avant)) {
				$avant = $s;
				continue;
			}
			$ok = true;
			$texte .= $avant;
			// Detecter si le match a eu lieu dans un tag HTML
			if (is_int($deb_tag = strrpos($texte, '&lt;'))) {
				if (strrpos($texte, '&gt;') &lt;= $deb_tag)
					$ok = false;
			}
			if ($ok) $texte .= $remplace;
			else $texte .= $cherche;
			$avant = $s;
		}
		$texte .= $avant;
	}
}

function souligner_ortho($texte, $lang, $ortho_result) {
	global $id_suggest;
	$vu = array();

	$mauvais = $ortho_result['mauvais'];
	$bons = $ortho_result['bons'];

	// Neutraliser l'apostrophe unicode pour surligner correctement les fautes
	$texte = &quot; &quot;.str_replace(&quot;\xE2\x80\x99&quot;, &quot;'&quot;, $texte).&quot; &quot;;
	// Chercher et remplacer les mots un par un
	$delim = '[^-\''.pcre_lettres_unicode().']';
	foreach ($mauvais as $mot =&gt; $suggest) {
		$pattern = &quot;,$delim&quot;.$mot.&quot;$delim,us&quot;;
		// Recuperer les occurences du mot dans le texte
		if (preg_match_all($pattern, $texte, $regs, PREG_SET_ORDER)) {
			$id = $id_suggest[$mot];
			$mot_html = afficher_ortho($mot);
			foreach ($regs as $r) {
				if ($vu[$cherche = $r[0]]) continue;
				$vu[$cherche] = 1;
				$html = &quot;&lt;a class='ortho' onclick=\&quot;suggest($id);return false;\&quot; href=''&gt;$mot_html&lt;/a&gt;&quot;;
				$remplace = str_replace($mot, $html, $cherche);
				souligner_match_ortho($texte, $cherche, $remplace);
			}
		}
	}
	foreach ($bons as $mot) {
		$pattern = &quot;,$delim&quot;.$mot.&quot;$delim,us&quot;;
		// Recuperer les occurences du mot dans le texte
		if (preg_match_all($pattern, $texte, $regs, PREG_SET_ORDER)) {
			$id = $id_suggest[$mot];
			$mot_html = afficher_ortho($mot);
			foreach ($regs as $r) {
				if ($vu[$cherche = $r[0]]) continue;
				$vu[$cherche] = 1;
				$html = &quot;&lt;a class='ortho-dico' onclick=\&quot;suggest($id);return false;\&quot; href=''&gt;$mot_html&lt;/a&gt;&quot;;
				$remplace = str_replace($mot, $html, $cherche);
				souligner_match_ortho($texte, $cherche, $remplace);
			}
		}
	}
	
	$texte = preg_replace(',(^ | $),', '', $texte);
	return $texte;
}

function init_ortho() {
	global $duree_cache_ortho, $duree_cache_miroirs_ortho;
 
 	$duree_cache_ortho = 7 * 24 * 3600;
	$duree_cache_miroirs_ortho = 24 * 3600;
	lire_miroirs_ortho();
}

init_ortho();

?&gt;

--- NEW FILE: config-lang.php3 ---
&lt;?php

include (&quot;inc.php3&quot;);

include_ecrire (&quot;inc_config.php3&quot;);

function mySel($varaut,$variable){
		$retour= &quot; VALUE=\&quot;$varaut\&quot;&quot;;

	if ($variable==$varaut){
		$retour.= &quot; SELECTED&quot;;
	}

	return $retour;
}


debut_page(_T('titre_page_config_contenu'), &quot;administration&quot;, &quot;langues&quot;);

echo &quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&quot;;
gros_titre(_T('info_langues'));


barre_onglets(&quot;config_lang&quot;, &quot;langues&quot;);




debut_gauche();

debut_droite();

if ($connect_statut != '0minirezo' OR !$connect_toutes_rubriques) {
	echo _T('avis_non_acces_page');
	fin_page();
	exit;
}

init_config();
if ($changer_config == 'oui') {
	appliquer_modifs_config();
	calculer_langues_rubriques();
}

lire_metas();


echo &quot;&lt;form action='config-lang.php3' method='post'&gt;&quot;;
echo &quot;&lt;input type='hidden' name='changer_config' value='oui'&gt;&quot;;


//
// Configuration i18n
//

debut_cadre_couleur(&quot;langues-24.gif&quot;, false, &quot;&quot;, _T('info_langue_principale'));

$langues_prop = split(&quot;,&quot;,lire_meta(&quot;langues_proposees&quot;));
$langue_site = lire_meta('langue_site');

echo _T('texte_selection_langue_principale');


// langue du site
echo _T('info_langue_principale').&quot; : &quot;;
echo &quot;\n&lt;select name='changer_langue_site' class='fondl' align='middle'&gt;\n&quot;;
echo &quot;&lt;option value='$langue_site' selected&gt;&quot;.traduire_nom_langue($langue_site).&quot;&lt;/option&gt;\n&quot;;
reset ($langues_prop);
while (list(,$l) = each ($langues_prop)) {
	if ($l &lt;&gt; $langue_site)
		echo &quot;&lt;option value='$l'&gt;&quot;.traduire_nom_langue($l).&quot;&lt;/option&gt;\n&quot;;
}
echo &quot;&lt;/select&gt;\n&quot;;
echo &quot;&lt;INPUT TYPE='submit' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;' CLASS='fondo'&gt;&quot;;


fin_cadre_couleur();

echo &quot;&lt;p&gt;&quot;;


//
// Configuration du charset
//

if ($options == 'avancees') {
	debut_cadre_relief(&quot;breve-24.gif&quot;, false, &quot;&quot;, _T('info_jeu_caractere'));

	$charset = lire_meta(&quot;charset&quot;);

	echo _T('texte_jeu_caractere').&quot;&lt;p&gt;&quot;;
	echo &quot;&lt;blockquote class='spip'&gt;&lt;p&gt;&quot;._T('texte_jeu_caractere_2').&quot;&lt;/p&gt;&lt;/blockquote&gt;&quot;;


	echo bouton_radio('charset', 'iso-8859-1',
		_T('bouton_radio_occidental'), $charset == 'iso-8859-1');
	echo &quot;&lt;br&gt;&quot;;
	echo bouton_radio('charset', 'utf-8',
		_T('bouton_radio_universel'), $charset == 'utf-8');
	echo &quot;&lt;br&gt;&quot;;
	echo bouton_radio('charset', 'custom',
		_T('bouton_radio_personnalise'), $charset != 'utf-8' &amp;&amp; $charset != 'iso-8859-1');
	echo &quot;&lt;br&gt;&quot;;
	if ($charset != 'utf-8' &amp;&amp; $charset != 'iso-8859-1') {
		echo &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;._T('info_entrer_code_alphabet').&quot;&nbsp;&quot;;
		echo &quot;&lt;input type='text' name='charset_custom' class='fondl' value='$charset' size='15'&gt;&quot;;
	}
	else
		echo &quot;&lt;input type='hidden' name='charset_custom' value=''&gt;&quot;;

	echo &quot;&lt;div style='text-align: $spip_lang_right;'&gt;&lt;INPUT TYPE='submit' NAME='Valider' VALUE='&quot;._T('bouton_valider').&quot;' CLASS='fondo'&gt;&lt;/div&gt;&quot;;

	fin_cadre_relief();

}


echo &quot;&lt;/form&gt;&quot;;

fin_page();

?&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000041.html">[Spip-carto-cvs] spip-carto/IMG/icones defaut-dist.png,NONE,1.1 avi-dist.png,NONE,1.1 pdf-dist.png,NONE,1.1 dvi-dist.png,NONE,1.1 qt-dist.png,NONE,1.1 ra-dist.png,NONE,1.1 rm-dist.png,NONE,1.1 rpm-dist.png,NONE,1.1 ram-dist.png,NONE,1.1 sit-dist.png,NONE,1.1 html-dist.png,NONE,1.1 psd-dist.png,NONE,1.1 mpg-dist.png,NONE,1.1 sxi-dist.png,NONE,1.1 sdd-dist.png,NONE,1.1 mid-dist.png,NONE,1.1 deb-dist.png,NONE,1.1 ai-dist.png,NONE,1.1 sxw-dist.png,NONE,1.1 png-dist.png,NONE,1.1 tgz-dist.png,NONE,1.1 sdw-dist.png,NONE,1.1 mov-dist.png,NONE,1.1 rtf-dist.png,NONE,1.1 bz2-dist.png,NONE,1.1 ogg-dist.png,NONE,1.1 sxc-dist.png,NONE,1.1 ps-dist.png,NONE,1.1 wav-dist.png,NONE,1.1 aiff-dist.png,NONE,1.1 asf-dist.png,NONE,1.1 xcf-dist.png,NONE,1.1 jpg-dist.png,NONE,1.1 mp3-dist.png,NONE,1.1 txt-dist.png,NONE,1.1 xml-dist.png,NONE,1.1 xls-dist.png,NONE,1.1 gif-dist.png,NONE,1.1 eps-dist.png,NONE,1.1 tex-dist.png,NONE,1.1 zip-dist.png,NONE,1.1 tif-dist.png,NONE,1.1 doc-dist.png,NONE,1.1 bmp-dist.png! ,NONE,1.1 ppt-dist.png,NONE,1.1 gz-dist.png,NONE,1.1
</A></li>
	<LI>Next message: <A HREF="000043.html">[Spip-carto-cvs] CVSROOT modules,1.4,1.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42">[ date ]</a>
              <a href="thread.html#42">[ thread ]</a>
              <a href="subject.html#42">[ subject ]</a>
              <a href="author.html#42">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
