<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spip-carto plan-dist.html,NONE,1.1 spip_carto.php,1.1,1.2 spip_pass.php3,1.1,1.2 spip_inscription.php3,1.1,1.2
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-January/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spip-carto%20plan-dist.html%2CNONE%2C1.1%20spip_carto.php%2C1.1%2C1.2%20spip_pass.php3%2C1.1%2C1.2%20spip_inscription.php3%2C1.1%2C1.2&In-Reply-To=%3C200501201025.j0KAPqOp026462%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000056.html">
   <LINK REL="Next"  HREF="000058.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spip-carto plan-dist.html,NONE,1.1 spip_carto.php,1.1,1.2 spip_pass.php3,1.1,1.2 spip_inscription.php3,1.1,1.2</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spip-carto%20plan-dist.html%2CNONE%2C1.1%20spip_carto.php%2C1.1%2C1.2%20spip_pass.php3%2C1.1%2C1.2%20spip_inscription.php3%2C1.1%2C1.2&In-Reply-To=%3C200501201025.j0KAPqOp026462%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spip-carto plan-dist.html,NONE,1.1 spip_carto.php,1.1,1.2 spip_pass.php3,1.1,1.2 spip_inscription.php3,1.1,1.2">stef at berlios.de
       </A><BR>
    <I>Thu Jan 20 11:25:52 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000056.html">[Spip-carto-cvs] spip-carto/oo index.php3,NONE,1.1 index.php,NONE,1.1
</A></li>
        <LI>Next message: <A HREF="000058.html">[Spip-carto-cvs] spip-carto freecarto.zip,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57">[ date ]</a>
              <a href="thread.html#57">[ thread ]</a>
              <a href="subject.html#57">[ subject ]</a>
              <a href="author.html#57">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spip-carto
In directory sheep:/tmp/cvs-serv26456

Modified Files:
	spip_carto.php spip_pass.php3 spip_inscription.php3 
Added Files:
	plan-dist.html 
Log Message:
proto1.1

--- NEW FILE: plan-dist.html ---
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
&lt;html lang=&quot;#LANG&quot;&gt;
&lt;head&gt;
&lt;title&gt;[#NOM_SITE_SPIP] &lt;/title&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#CHARSET&quot;&gt;

&lt;!-- Ceci est la feuille de style par defaut pour les types internes a SPIP --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- Les feuilles de style specifiques aux presents squelettes --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;typographie.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- media=&quot;...&quot; permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;habillage.css&quot; type=&quot;text/css&quot; media=&quot;print, projection, screen, tv&quot;&gt;
&lt;/head&gt;

&lt;body bgcolor=&quot;white&quot; dir=&quot;#LANG_DIR&quot;&gt;


&lt;!-- Plan du site --&gt;

&lt;div id=&quot;plan&quot; class=&quot;contenu&quot;&gt;

&lt;BOUCLE_secteurs(RUBRIQUES) {racine} {par titre}&gt;

&lt;div class=&quot;plan-secteur&quot;&gt;

	[(#LOGO_RUBRIQUE|left)]&lt;h1&gt;&lt;a href=&quot;#URL_RUBRIQUE&quot;&gt;#TITRE&lt;/a&gt;&lt;/h1&gt;

	&lt;div class=&quot;encart&quot;&gt;

	&lt;!-- Breves --&gt;

	&lt;h2 class=&quot;structure&quot;&gt;&lt;:breves:&gt;&lt;/h2&gt;

	&lt;B_breves&gt;
	&lt;div class=&quot;menu&quot;&gt;
	&lt;div class=&quot;breves&quot;&gt;
		&lt;div class=&quot;menu-titre&quot;&gt;
		&lt;:breves:&gt;
		&lt;/div&gt;
		&lt;ul&gt;
	&lt;BOUCLE_breves(BREVES) {id_secteur} {par date} {inverse} {0,15}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;
		&lt;i&gt;[(#DATE|affdate_court)]&lt;/i&gt;:
		&lt;a href=&quot;#URL_BREVE&quot;&gt;#TITRE&lt;/a&gt;
		&lt;/li&gt;
	&lt;/BOUCLE_breves&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;/div&gt;
	&lt;/B_breves&gt;

	&lt;!-- Sur le Web --&gt;

	&lt;h2 class=&quot;structure&quot;&gt;&lt;:sites_web:&gt;&lt;/h2&gt;

	&lt;B_sites&gt;
	&lt;div class=&quot;menu&quot;&gt;
	&lt;div class=&quot;divers&quot;&gt;
		&lt;div class=&quot;menu-titre&quot;&gt;
		&lt;:sur_web:&gt;
		&lt;/div&gt;
		&lt;ul&gt;
	&lt;BOUCLE_sites(SITES) {id_secteur} {par nom_site}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;
		&lt;a href=&quot;#URL_SITE&quot;&gt;#NOM_SITE&lt;/a&gt;
		&lt;/li&gt;
	&lt;/BOUCLE_sites&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;/div&gt;
	&lt;/B_sites&gt;

	&lt;/div&gt;

&lt;!-- Articles et sous-rubriques --&gt;

&lt;h2 class=&quot;structure&quot;&gt;&lt;:articles:&gt;&lt;/h2&gt;

&lt;B_articles_racine&gt;
&lt;ul class=&quot;plan-articles&quot;&gt;

&lt;BOUCLE_articles_racine(ARTICLES) {id_rubrique} {par titre}&gt;
&lt;li class=&quot;plan-article&quot;&gt;&lt;a href=&quot;#URL_ARTICLE&quot;&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
&lt;/BOUCLE_articles_racine&gt;

&lt;/ul&gt;
&lt;/B_articles_racine&gt;

&lt;B_rubriques&gt;

&lt;ul class=&quot;plan-rubriques&quot;&gt;

&lt;BOUCLE_rubriques(RUBRIQUES) {id_parent} {par titre}&gt;
&lt;li&gt;
&lt;div class=&quot;plan-rubrique&quot;&gt;&lt;a href=&quot;#URL_RUBRIQUE&quot;&gt;#TITRE&lt;/a&gt;&lt;/div&gt;

	&lt;B_articles&gt;
	&lt;ul class=&quot;plan-articles&quot;&gt;
	&lt;BOUCLE_articles(ARTICLES) {id_rubrique} {par titre}&gt;
	&lt;li class=&quot;plan-article&quot;&gt;&lt;a href=&quot;#URL_ARTICLE&quot;&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
	&lt;/BOUCLE_articles&gt;
	&lt;/ul&gt;
	&lt;/B_articles&gt;

	&lt;BOUCLE_sous_rubriques(BOUCLE_rubriques)&gt;&lt;/BOUCLE_sous_rubriques&gt;

&lt;/li&gt;
&lt;/BOUCLE_rubriques&gt;

&lt;/ul&gt;
&lt;/B_rubriques&gt;


&lt;/div&gt;

&lt;/BOUCLE_secteurs&gt;

&lt;/div&gt;
#FORMULAIRE_ADMIN
&lt;/body&gt;
&lt;/html&gt;

Index: spip_carto.php
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/spip_carto.php,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_carto.php	13 Jan 2005 15:57:38 -0000	1.1
+++ spip_carto.php	20 Jan 2005 10:25:49 -0000	1.2
@@ -6,18 +6,38 @@
 
 include(&quot;downloadfile.class.php&quot;);
 
-if (isset($_GET[&quot;id_carte&quot;]) &amp;&amp; !empty($_GET[&quot;id_carte&quot;])) 
+if (isset($_GET[&quot;fond_carte&quot;]) &amp;&amp; !empty($_GET[&quot;fond_carte&quot;])) 
 {
-	$query=&quot;select fichier from spip_documents where id_document=&quot;.$_GET[&quot;id_carte&quot;];
-		
-	$result = @spip_query($query);
-	if ($result) 
+	$lid_carte=intval($_GET[&quot;fond_carte&quot;]);
+	//echo $lid_carte;
+	//exit;
+	if ($lid_carte)
 	{
-		$row = @spip_fetch_array($result); 
-		$downloadfile = new DOWNLOADFILE($row[0],&quot;inline&quot;);
-		//si c'est un probleme de document supprim&#233; : &quot;!!!&quot; ... bof !
-		if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;;
-		//else exit();
+		$query=&quot;select fichier from spip_documents where id_document=&quot;.$lid_carte;
+		
+		$result = @spip_query($query);
+		if ($result) 
+		{
+			$row = @spip_fetch_array($result); 
+			$downloadfile = new DOWNLOADFILE($row[0],&quot;inline&quot;);
+			//si c'est un probleme de document supprim&#233; : &quot;!!!&quot; ... bof !
+			$lError=&quot;document OK&quot;;
+		}
+		else {
+			$downloadfile = new DOWNLOADFILE(&quot;ecrire/img_pack/carte-24.png&quot;,&quot;inline&quot;);
+			$lError=&quot;pas de document&quot;;
+		}
+		if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
+		//echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
+			
+	}
+	else {
+		//$downloadfile = new DOWNLOADFILE(&quot;/ecrire/img_pack/carte-24.png&quot;,&quot;inline&quot;);
+		//$downloadfile = new DOWNLOADFILE($_GET[&quot;fond_carte&quot;],&quot;inline&quot;);
+		redirige_par_entete($_GET[&quot;fond_carte&quot;]);
+		$lError=&quot;chemin&quot;;
 	}
+	//if (!$downloadfile-&gt;df_download()) echo &quot;!!!&quot;.$lError.&quot;!!!&quot;;
+	//else exit();
 }
 ?&gt;

Index: spip_pass.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/spip_pass.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_pass.php3	13 Jan 2005 15:57:38 -0000	1.1
+++ spip_pass.php3	20 Jan 2005 10:25:49 -0000	1.2
@@ -1,78 +1,72 @@
 &lt;?php
 
 include (&quot;ecrire/inc_version.php3&quot;);
-
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_presentation.php3&quot;);
-include_ecrire(&quot;inc_session.php3&quot;);
-include_ecrire(&quot;inc_filtres.php3&quot;);
-include_ecrire(&quot;inc_texte.php3&quot;);
-include_ecrire(&quot;inc_meta.php3&quot;);
-include_ecrire(&quot;inc_mail.php3&quot;);
-include_ecrire(&quot;inc_acces.php3&quot;);
-include_local(&quot;inc-public-global.php3&quot;); 
+include_ecrire(&quot;inc_presentation.php3&quot;); # pour install_debut
+include_ecrire(&quot;inc_session.php3&quot;); # pour creer_uniq_id
+include_ecrire(&quot;inc_mail.php3&quot;); # pour envoyer_mail
+include_ecrire(&quot;inc_acces.php3&quot;); # pour generer_htpass
+include_local(&quot;inc-public-global.php3&quot;); # pour calculer la page
+include_local (&quot;inc-cache.php3&quot;); # ici c'est pour tester la connexion SQL
 
 // Ce fichier est celui d'une balise dynamique qui s'ignore.
 
 function formulaire_oubli_dyn($p, $oubli)
 {
 
-$erreur = '';
+$message = '';
 
 // au 3e appel la variable P est positionnee par le script lui-meme
 // et oubli = mot passe. Le choix du nom P est impose par pass_mail_passcookie
 if ($p = addslashes($p)) {
-	$res = spip_query (&quot;SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut&lt;&gt;'5poubelle' AND pass&lt;&gt;''&quot;);
+	$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE cookie_oubli='$p' AND statut&lt;&gt;'5poubelle' AND pass&lt;&gt;''&quot;);
 	if (!$row = spip_fetch_array($res)) 
-		$erreur = _T('pass_erreur_code_inconnu');
+		$message = _T('pass_erreur_code_inconnu');
 	else {
 		if ($oubli) {
 			$mdpass = md5($oubli);
 			$htpass = generer_htpass($oubli);
-			spip_query (&quot;UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
+			spip_query(&quot;UPDATE spip_auteurs SET htpass='$htpass', pass='$mdpass', alea_actuel='',
 				cookie_oubli='' WHERE cookie_oubli='$p'&quot;);
 
 			$login = $row['login'];
-			$erreur = &quot;&lt;b&gt;&quot;._T('pass_nouveau_enregistre').&quot;&lt;/b&gt;&quot;.
-			&quot;&lt;p&gt;&quot;._T('pass_rappel_login', array('login' =&gt; $login));
+			$message = &quot;&lt;b&gt;&quot; . _T('pass_nouveau_enregistre') . &quot;&lt;/b&gt;&quot;.
+			&quot;&lt;p&gt;&quot; . _T('pass_rappel_login', array('login' =&gt; $login));
 		}
 	}
  } else { 
   // si p absent, oubli vaut alors le mail au 2e appel, vide au 1e
   if ($oubli) {
-	if (email_valide($oubli)) {
+	if ( email_valide($oubli) ) {
 		$email = addslashes($oubli);
 		$res = spip_query(&quot;SELECT * FROM spip_auteurs WHERE email ='$email'&quot;);
 		if ($row = spip_fetch_array($res)) {
 			if ($row['statut'] == '5poubelle' OR $row['pass'] == '')
-				$erreur = _T('pass_erreur_acces_refuse');
+				$message = _T('pass_erreur_acces_refuse');
 			else {
 				$cookie = creer_uniqid();
 				spip_query(&quot;UPDATE spip_auteurs SET cookie_oubli = '$cookie' WHERE email ='$email'&quot;);
 
-				if (envoyer_mail($email,
-						 &quot;[&quot; . lire_meta(&quot;nom_site&quot;) .'] ' ._T('pass_oubli_mot'),
+				if ( envoyer_mail($email,
+						 &quot;[&quot; . lire_meta(&quot;nom_site&quot;) .'] ' .  _T('pass_oubli_mot'),
 						 _T('pass_mail_passcookie',
 						    array('nom_site_spip' =&gt; lire_meta(&quot;nom_site&quot;),
 							  'adresse_site' =&gt; lire_meta(&quot;adresse_site&quot;), 
 							  'cookie' =&gt; $cookie))))
-					$erreur = _T('pass_recevoir_mail');
+					$message = _T('pass_recevoir_mail');
 				else
-					$erreur = _T('pass_erreur_probleme_technique');
+					$message = _T('pass_erreur_probleme_technique');
 			}
 		}
 		else
-			$erreur = _T('pass_erreur_non_enregistre', array('email_oubli' =&gt; htmlspecialchars($oubli)));
+			$message = _T('pass_erreur_non_enregistre', array('email_oubli' =&gt; htmlspecialchars($oubli)));
 	} else {
-		$erreur = _T('pass_erreur_non_valide', array('email_oubli' =&gt; htmlspecialchars($oubli)));
+		$message = _T('pass_erreur_non_valide', array('email_oubli' =&gt; htmlspecialchars($oubli)));
 	}
   }
  }
- return $erreur ? $erreur : array('formulaire_oubli', 0, array('p' =&gt; $p));
+ return array('formulaire_oubli', 0, array('p' =&gt; $p, 'message' =&gt; $message));
 }
 
-utiliser_langue_site();
-utiliser_langue_visiteur();
 install_debut_html(_T('pass_mot_oublie'));
 inclure_balise_dynamique(formulaire_oubli_dyn($p, $oubli));
 install_fin_html();

Index: spip_inscription.php3
===================================================================
RCS file: /cvsroot/spip-carto/spip-carto/spip_inscription.php3,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -d -r1.1 -r1.2
--- spip_inscription.php3	13 Jan 2005 15:57:38 -0000	1.1
+++ spip_inscription.php3	20 Jan 2005 10:25:49 -0000	1.2
@@ -3,10 +3,10 @@
 include_ecrire(&quot;inc_presentation.php3&quot;);
 include_local(&quot;inc-formulaire_inscription.php3&quot;);
 include_local(&quot;inc-public-global.php3&quot;); 
-include_ecrire(&quot;inc_lang.php3&quot;); 
-utiliser_langue_site();
-utiliser_langue_visiteur();
+include_local (&quot;inc-cache.php3&quot;);
+
 install_debut_html(_T('pass_vousinscrire'));
-inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus));
+inclure_balise_dynamique(balise_formulaire_inscription_dyn($mode, $mail_inscription, $nom_inscription, $focus, $target));
+# echo http_script_window_close(); # fait dans le squelette a present
 install_fin_html();
 ?&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000056.html">[Spip-carto-cvs] spip-carto/oo index.php3,NONE,1.1 index.php,NONE,1.1
</A></li>
	<LI>Next message: <A HREF="000058.html">[Spip-carto-cvs] spip-carto freecarto.zip,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57">[ date ]</a>
              <a href="thread.html#57">[ thread ]</a>
              <a href="subject.html#57">[ subject ]</a>
              <a href="author.html#57">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
