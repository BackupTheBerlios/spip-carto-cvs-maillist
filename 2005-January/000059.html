<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spip-carto inc-calcul.php3,NONE,1.1 formulaire_ecrire_auteur-dist.html,NONE,1.1 inc-url_logout.php3,NONE,1.1 index.php3,NONE,1.1 formulaire_recherche-dist.html,NONE,1.1 inc-login_public.php3,NONE,1.1 inc-public.php3,NONE,1.1 htaccess-propres.txt,NONE,1.1 inc-formulaire_forum.php3,NONE,1.1 formulaire_forum-dist.html,NONE,1.1 inc-compilo.php3,NONE,1.1 inc-urls-html.php3,NONE,1.1 inc-html-squel.php3,NONE,1.1 carto.php3,NONE,1.1 index.php,NONE,1.1 article.php3,NONE,1.1 habillage.css,NONE,1.1 ical-dist.html,NONE,1.1 inc-compilo-api.php3,NONE,1.1 formulaire_site-dist.html,NONE,1.1 inc-compilo-index.php3,NONE,1.1 mot.php3,NONE,1.1 htaccess-html.txt,NONE,1.1 inc-formulaire_site.php3,NONE,1.1 inc-formulaire_ecrire_auteur.php3,NONE,1.1 inc-login_prive.php3,NONE,1.1 backend.php3,NONE,1.1 inc-calcul-outils.php3,NONE,1.1 formulaire_login-dist.html,NONE,1.1 formulaire_admin-dist.html,NONE,1.1 inc-formulaire_signature.php3,NONE,1.1 inc-criteres.php3,NONE,1.1 inc-public-global.php3! ,NONE,1.1 login-dist.html,NONE,1.1 inc-urls-propres.php3,NONE,1.1 formulaire_signature-dist.html,NONE,1.1 downloadfile.class.php,NONE,1.1 inc-boucles.php3,NONE,1.1 carto-proto.sql,NONE,1.1 inc-formulaire_inscription.php3,NONE,1.1 formulaire_menu_lang-dist.html,NONE,1.1 forum.php3,NONE,1.1 inc-menu_lang_ecrire.php3,NONE,1.1 formulaire_inscription-dist.html,NONE,1.1 impression.css,NONE,1.1 inc-balises.php3,NONE,1.1 inc-chercher.php3,NONE,1.1 inc-urls-standard.php3,NONE,1.1 inc-admin.php3,NONE,1.1 backend-dist.html,NONE,1.1 backend-breves-dist.html,NONE,1.1 nouveautes-dist.html,NONE,1.1 distrib.php3,NONE,1.1 distrib-dist.html,NONE,1.1 inc-stats.php3,NONE,1.1 forum-dist.html,NONE,1.1 mes_fonctions.php3,NONE,1.1 auteur.php3,NONE,1.1 ical.php3,NONE,1.1 breve.php3,NONE,1.1 inc-formulaire_recherche.php3,NONE,1.1 breve-dist.html,NONE,1.1 plan.php3,NONE,1.1 inc-messforum.php3,NONE,1.1 inc-cache.php3,NONE,1.1 formulaire_oubli-dist.html,NONE,1.1 inc-menu_lang.php3,NONE,1.1 auteur-dist.! html,NONE,1.1 article-dist.html,NONE,1.1 mot-dist.html,NONE,1.1 carto.
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-January/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spip-carto%20inc-calcul.php3%2CNONE%2C1.1%20formulaire_ecrire_auteur-dist.html%2CNONE%2C1.1%20inc-url_logout.php3%2CNONE%2C1.1%20index.php3%2CNONE%2C1.1%20formulaire_recherche-dist.html%2CNONE%2C1.1%20inc-login_public.php3%2CNONE%2C1.1%20inc-public.php3%2CNONE%2C1.1%20htaccess-propres.txt%2CNONE%2C1.1%20inc-formulaire_forum.php3%2CNONE%2C1.1%20formulaire_forum-dist.html%2CNONE%2C1.1%20inc-compilo.php3%2CNONE%2C1.1%20inc-urls-html.php3%2CNONE%2C1.1%20inc-html-squel.php3%2CNONE%2C1.1%20carto.php3%2CNONE%2C1.1%20index.php%2CNONE%2C1.1%20article.php3%2CNONE%2C1.1%20habillage.css%2CNONE%2C1.1%20ical-dist.html%2CNONE%2C1.1%20inc-compilo-api.php3%2CNONE%2C1.1%20formulaire_site-dist.html%2CNONE%2C1.1%20inc-compilo-index.php3%2CNONE%2C1.1%20mot.php3%2CNONE%2C1.1%20htaccess-html.txt%2CNONE%2C1.1%20inc-formulaire_site.php3%2CNONE%2C1.1%20inc-formulaire_ecrire_auteur.php3%2CNONE%2C1.1%20inc-login_prive.php3%2CNONE%2C1.1%20backend.php3%2CNONE%2C1.1%20inc-calcul-outils.php3%2CNONE%2C1.1%20formulaire_login-dist.html%2CNONE%2C1.1%20formulaire_admin-dist.html%2CNONE%2C1.1%20inc-formulaire_signature.php3%2CNONE%2C1.1%20inc-criteres.php3%2CNONE%2C1.1%20inc-public-global.php3%21%0A%20%2CNONE%2C1.1%20login-dist.html%2CNONE%2C1.1%20inc-urls-propres.php3%2CNONE%2C1.1%20formulaire_signature-dist.html%2CNONE%2C1.1%20downloadfile.class.php%2CNONE%2C1.1%20inc-boucles.php3%2CNONE%2C1.1%20carto-proto.sql%2CNONE%2C1.1%20inc-formulaire_inscription.php3%2CNONE%2C1.1%20formulaire_menu_lang-dist.html%2CNONE%2C1.1%20forum.php3%2CNONE%2C1.1%20inc-menu_lang_ecrire.php3%2CNONE%2C1.1%20formulaire_inscription-dist.html%2CNONE%2C1.1%20impression.css%2CNONE%2C1.1%20inc-balises.php3%2CNONE%2C1.1%20inc-chercher.php3%2CNONE%2C1.1%20inc-urls-standard.php3%2CNONE%2C1.1%20inc-admin.php3%2CNONE%2C1.1%20backend-dist.html%2CNONE%2C1.1%20backend-breves-dist.html%2CNONE%2C1.1%20nouveautes-dist.html%2CNONE%2C1.1%20distrib.php3%2CNONE%2C1.1%20distrib-dist.html%2CNONE%2C1.1%20inc-stats.php3%2CNONE%2C1.1%20forum-dist.html%2CNONE%2C1.1%20mes_fonctions.php3%2CNONE%2C1.1%20auteur.php3%2CNONE%2C1.1%20ical.php3%2CNONE%2C1.1%20breve.php3%2CNONE%2C1.1%20inc-formulaire_recherche.php3%2CNONE%2C1.1%20breve-dist.html%2CNONE%2C1.1%20plan.php3%2CNONE%2C1.1%20inc-messforum.php3%2CNONE%2C1.1%20inc-cache.php3%2CNONE%2C1.1%20formulaire_oubli-dist.html%2CNONE%2C1.1%20inc-menu_lang.php3%2CNONE%2C1.1%20auteur-dist.%21%0A%20html%2CNONE%2C1.1%20article-dist.html%2CNONE%2C1.1%20mot-dist.html%2CNONE%2C1.1%20carto.&In-Reply-To=%3C200501201025.j0KAPJOp026403%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000055.html">
   <LINK REL="Next"  HREF="000056.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spip-carto inc-calcul.php3,NONE,1.1 formulaire_ecrire_auteur-dist.html,NONE,1.1 inc-url_logout.php3,NONE,1.1 index.php3,NONE,1.1 formulaire_recherche-dist.html,NONE,1.1 inc-login_public.php3,NONE,1.1 inc-public.php3,NONE,1.1 htaccess-propres.txt,NONE,1.1 inc-formulaire_forum.php3,NONE,1.1 formulaire_forum-dist.html,NONE,1.1 inc-compilo.php3,NONE,1.1 inc-urls-html.php3,NONE,1.1 inc-html-squel.php3,NONE,1.1 carto.php3,NONE,1.1 index.php,NONE,1.1 article.php3,NONE,1.1 habillage.css,NONE,1.1 ical-dist.html,NONE,1.1 inc-compilo-api.php3,NONE,1.1 formulaire_site-dist.html,NONE,1.1 inc-compilo-index.php3,NONE,1.1 mot.php3,NONE,1.1 htaccess-html.txt,NONE,1.1 inc-formulaire_site.php3,NONE,1.1 inc-formulaire_ecrire_auteur.php3,NONE,1.1 inc-login_prive.php3,NONE,1.1 backend.php3,NONE,1.1 inc-calcul-outils.php3,NONE,1.1 formulaire_login-dist.html,NONE,1.1 formulaire_admin-dist.html,NONE,1.1 inc-formulaire_signature.php3,NONE,1.1 inc-criteres.php3,NONE,1.1 inc-public-global.php3! ,NONE,1.1 login-dist.html,NONE,1.1 inc-urls-propres.php3,NONE,1.1 formulaire_signature-dist.html,NONE,1.1 downloadfile.class.php,NONE,1.1 inc-boucles.php3,NONE,1.1 carto-proto.sql,NONE,1.1 inc-formulaire_inscription.php3,NONE,1.1 formulaire_menu_lang-dist.html,NONE,1.1 forum.php3,NONE,1.1 inc-menu_lang_ecrire.php3,NONE,1.1 formulaire_inscription-dist.html,NONE,1.1 impression.css,NONE,1.1 inc-balises.php3,NONE,1.1 inc-chercher.php3,NONE,1.1 inc-urls-standard.php3,NONE,1.1 inc-admin.php3,NONE,1.1 backend-dist.html,NONE,1.1 backend-breves-dist.html,NONE,1.1 nouveautes-dist.html,NONE,1.1 distrib.php3,NONE,1.1 distrib-dist.html,NONE,1.1 inc-stats.php3,NONE,1.1 forum-dist.html,NONE,1.1 mes_fonctions.php3,NONE,1.1 auteur.php3,NONE,1.1 ical.php3,NONE,1.1 breve.php3,NONE,1.1 inc-formulaire_recherche.php3,NONE,1.1 breve-dist.html,NONE,1.1 plan.php3,NONE,1.1 inc-messforum.php3,NONE,1.1 inc-cache.php3,NONE,1.1 formulaire_oubli-dist.html,NONE,1.1 inc-menu_lang.php3,NONE,1.1 auteur-dist.! html,NONE,1.1 article-dist.html,NONE,1.1 mot-dist.html,NONE,1.1 carto.</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spip-carto%20inc-calcul.php3%2CNONE%2C1.1%20formulaire_ecrire_auteur-dist.html%2CNONE%2C1.1%20inc-url_logout.php3%2CNONE%2C1.1%20index.php3%2CNONE%2C1.1%20formulaire_recherche-dist.html%2CNONE%2C1.1%20inc-login_public.php3%2CNONE%2C1.1%20inc-public.php3%2CNONE%2C1.1%20htaccess-propres.txt%2CNONE%2C1.1%20inc-formulaire_forum.php3%2CNONE%2C1.1%20formulaire_forum-dist.html%2CNONE%2C1.1%20inc-compilo.php3%2CNONE%2C1.1%20inc-urls-html.php3%2CNONE%2C1.1%20inc-html-squel.php3%2CNONE%2C1.1%20carto.php3%2CNONE%2C1.1%20index.php%2CNONE%2C1.1%20article.php3%2CNONE%2C1.1%20habillage.css%2CNONE%2C1.1%20ical-dist.html%2CNONE%2C1.1%20inc-compilo-api.php3%2CNONE%2C1.1%20formulaire_site-dist.html%2CNONE%2C1.1%20inc-compilo-index.php3%2CNONE%2C1.1%20mot.php3%2CNONE%2C1.1%20htaccess-html.txt%2CNONE%2C1.1%20inc-formulaire_site.php3%2CNONE%2C1.1%20inc-formulaire_ecrire_auteur.php3%2CNONE%2C1.1%20inc-login_prive.php3%2CNONE%2C1.1%20backend.php3%2CNONE%2C1.1%20inc-calcul-outils.php3%2CNONE%2C1.1%20formulaire_login-dist.html%2CNONE%2C1.1%20formulaire_admin-dist.html%2CNONE%2C1.1%20inc-formulaire_signature.php3%2CNONE%2C1.1%20inc-criteres.php3%2CNONE%2C1.1%20inc-public-global.php3%21%0A%20%2CNONE%2C1.1%20login-dist.html%2CNONE%2C1.1%20inc-urls-propres.php3%2CNONE%2C1.1%20formulaire_signature-dist.html%2CNONE%2C1.1%20downloadfile.class.php%2CNONE%2C1.1%20inc-boucles.php3%2CNONE%2C1.1%20carto-proto.sql%2CNONE%2C1.1%20inc-formulaire_inscription.php3%2CNONE%2C1.1%20formulaire_menu_lang-dist.html%2CNONE%2C1.1%20forum.php3%2CNONE%2C1.1%20inc-menu_lang_ecrire.php3%2CNONE%2C1.1%20formulaire_inscription-dist.html%2CNONE%2C1.1%20impression.css%2CNONE%2C1.1%20inc-balises.php3%2CNONE%2C1.1%20inc-chercher.php3%2CNONE%2C1.1%20inc-urls-standard.php3%2CNONE%2C1.1%20inc-admin.php3%2CNONE%2C1.1%20backend-dist.html%2CNONE%2C1.1%20backend-breves-dist.html%2CNONE%2C1.1%20nouveautes-dist.html%2CNONE%2C1.1%20distrib.php3%2CNONE%2C1.1%20distrib-dist.html%2CNONE%2C1.1%20inc-stats.php3%2CNONE%2C1.1%20forum-dist.html%2CNONE%2C1.1%20mes_fonctions.php3%2CNONE%2C1.1%20auteur.php3%2CNONE%2C1.1%20ical.php3%2CNONE%2C1.1%20breve.php3%2CNONE%2C1.1%20inc-formulaire_recherche.php3%2CNONE%2C1.1%20breve-dist.html%2CNONE%2C1.1%20plan.php3%2CNONE%2C1.1%20inc-messforum.php3%2CNONE%2C1.1%20inc-cache.php3%2CNONE%2C1.1%20formulaire_oubli-dist.html%2CNONE%2C1.1%20inc-menu_lang.php3%2CNONE%2C1.1%20auteur-dist.%21%0A%20html%2CNONE%2C1.1%20article-dist.html%2CNONE%2C1.1%20mot-dist.html%2CNONE%2C1.1%20carto.&In-Reply-To=%3C200501201025.j0KAPJOp026403%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spip-carto inc-calcul.php3,NONE,1.1 formulaire_ecrire_auteur-dist.html,NONE,1.1 inc-url_logout.php3,NONE,1.1 index.php3,NONE,1.1 formulaire_recherche-dist.html,NONE,1.1 inc-login_public.php3,NONE,1.1 inc-public.php3,NONE,1.1 htaccess-propres.txt,NONE,1.1 inc-formulaire_forum.php3,NONE,1.1 formulaire_forum-dist.html,NONE,1.1 inc-compilo.php3,NONE,1.1 inc-urls-html.php3,NONE,1.1 inc-html-squel.php3,NONE,1.1 carto.php3,NONE,1.1 index.php,NONE,1.1 article.php3,NONE,1.1 habillage.css,NONE,1.1 ical-dist.html,NONE,1.1 inc-compilo-api.php3,NONE,1.1 formulaire_site-dist.html,NONE,1.1 inc-compilo-index.php3,NONE,1.1 mot.php3,NONE,1.1 htaccess-html.txt,NONE,1.1 inc-formulaire_site.php3,NONE,1.1 inc-formulaire_ecrire_auteur.php3,NONE,1.1 inc-login_prive.php3,NONE,1.1 backend.php3,NONE,1.1 inc-calcul-outils.php3,NONE,1.1 formulaire_login-dist.html,NONE,1.1 formulaire_admin-dist.html,NONE,1.1 inc-formulaire_signature.php3,NONE,1.1 inc-criteres.php3,NONE,1.1 inc-public-global.php3! ,NONE,1.1 login-dist.html,NONE,1.1 inc-urls-propres.php3,NONE,1.1 formulaire_signature-dist.html,NONE,1.1 downloadfile.class.php,NONE,1.1 inc-boucles.php3,NONE,1.1 carto-proto.sql,NONE,1.1 inc-formulaire_inscription.php3,NONE,1.1 formulaire_menu_lang-dist.html,NONE,1.1 forum.php3,NONE,1.1 inc-menu_lang_ecrire.php3,NONE,1.1 formulaire_inscription-dist.html,NONE,1.1 impression.css,NONE,1.1 inc-balises.php3,NONE,1.1 inc-chercher.php3,NONE,1.1 inc-urls-standard.php3,NONE,1.1 inc-admin.php3,NONE,1.1 backend-dist.html,NONE,1.1 backend-breves-dist.html,NONE,1.1 nouveautes-dist.html,NONE,1.1 distrib.php3,NONE,1.1 distrib-dist.html,NONE,1.1 inc-stats.php3,NONE,1.1 forum-dist.html,NONE,1.1 mes_fonctions.php3,NONE,1.1 auteur.php3,NONE,1.1 ical.php3,NONE,1.1 breve.php3,NONE,1.1 inc-formulaire_recherche.php3,NONE,1.1 breve-dist.html,NONE,1.1 plan.php3,NONE,1.1 inc-messforum.php3,NONE,1.1 inc-cache.php3,NONE,1.1 formulaire_oubli-dist.html,NONE,1.1 inc-menu_lang.php3,NONE,1.1 auteur-dist.! html,NONE,1.1 article-dist.html,NONE,1.1 mot-dist.html,NONE,1.1 carto.">stef at berlios.de
       </A><BR>
    <I>Thu Jan 20 11:25:19 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000055.html">[Spip-carto-cvs] spip-carto/IMG test_image.jpg,NONE,1.1 test.gif,NONE,1.1 logo_spip.jpg,NONE,1.1 test.png,NONE,1.1 test.jpg,NONE,1.1
</A></li>
        <LI>Next message: <A HREF="000056.html">[Spip-carto-cvs] spip-carto/oo index.php3,NONE,1.1 index.php,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59">[ date ]</a>
              <a href="thread.html#59">[ thread ]</a>
              <a href="subject.html#59">[ subject ]</a>
              <a href="author.html#59">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spip-carto
In directory sheep:/tmp/cvs-serv26389

Added Files:
	inc-calcul.php3 formulaire_ecrire_auteur-dist.html 
	inc-url_logout.php3 index.php3 formulaire_recherche-dist.html 
	inc-login_public.php3 inc-public.php3 htaccess-propres.txt 
	inc-formulaire_forum.php3 formulaire_forum-dist.html 
	inc-compilo.php3 inc-urls-html.php3 inc-html-squel.php3 
	carto.php3 index.php article.php3 habillage.css ical-dist.html 
	inc-compilo-api.php3 formulaire_site-dist.html 
	inc-compilo-index.php3 mot.php3 htaccess-html.txt 
	inc-formulaire_site.php3 inc-formulaire_ecrire_auteur.php3 
	inc-login_prive.php3 backend.php3 inc-calcul-outils.php3 
	formulaire_login-dist.html formulaire_admin-dist.html 
	inc-formulaire_signature.php3 inc-criteres.php3 
	inc-public-global.php3 login-dist.html inc-urls-propres.php3 
	formulaire_signature-dist.html downloadfile.class.php 
	inc-boucles.php3 carto-proto.sql 
	inc-formulaire_inscription.php3 formulaire_menu_lang-dist.html 
	forum.php3 inc-menu_lang_ecrire.php3 
	formulaire_inscription-dist.html impression.css 
	inc-balises.php3 inc-chercher.php3 inc-urls-standard.php3 
	inc-admin.php3 backend-dist.html backend-breves-dist.html 
	nouveautes-dist.html distrib.php3 distrib-dist.html 
	inc-stats.php3 forum-dist.html mes_fonctions.php3 auteur.php3 
	ical.php3 breve.php3 inc-formulaire_recherche.php3 
	breve-dist.html plan.php3 inc-messforum.php3 inc-cache.php3 
	formulaire_oubli-dist.html inc-menu_lang.php3 auteur-dist.html 
	article-dist.html mot-dist.html carto.html 
	inc-formulaire_admin.php3 backend-breves.php3 
Log Message:
proto1.1

--- NEW FILE: inc-calcul.php3 ---
&lt;?php


// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_CALCUL&quot;)) return;
define(&quot;_INC_CALCUL&quot;, &quot;1&quot;);

//
// Ce fichier calcule une page en executant un squelette.
//

include_ecrire(&quot;inc_meta.php3&quot;);
include_ecrire(&quot;inc_index.php3&quot;);
include_ecrire(&quot;inc_texte.php3&quot;);
include_ecrire(&quot;inc_filtres.php3&quot;);
include_ecrire(&quot;inc_lang.php3&quot;);
include_ecrire(&quot;inc_documents.php3&quot;);
include_ecrire(&quot;inc_abstract_sql.php3&quot;);
include_ecrire(&quot;inc_forum.php3&quot;);
include_ecrire(&quot;inc_debug_sql.php3&quot;);
include_local(&quot;inc-calcul-outils.php3&quot;);

// Ce fichier peut contenir une affectation de $dossier_squelettes  indiquant
// le repertoire du source des squelettes (les pseudo-html avec BOUCLE...)

if (@file_exists(&quot;mes_fonctions.php3&quot;)) 
    include_local (&quot;mes_fonctions.php3&quot;);


// Gestionnaire d'URLs
if (@file_exists(&quot;inc-urls.php3&quot;))
	include_local(&quot;inc-urls.php3&quot;);
else
	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);


// Le squelette compile est-il trop vieux ?
function squelette_obsolete($skel, $squelette) {
	return (
		$GLOBALS['var_mode']
		OR !@file_exists($skel)
		OR (@filemtime($squelette) &gt; ($date = @filemtime($skel)))
		OR (@filemtime('mes_fonctions.php3') &gt; $date)
		OR (@filemtime(_FILE_OPTIONS) &gt; $date)
	);
}


# Charge un squelette (au besoin le compile) 
# et retoune le nom de sa fonction principale, ou '' s'il est indefini
# Charge egalement un fichier homonyme de celui du squelette
# mais de suffixe '_fonctions.php3' pouvant contenir:
# - des filtres
# - des fonctions de traduction de balise, de critere et de boucle
# - des declaration de tables SQL supplementaires

function charger_squelette ($squelette) {
	$ext = $GLOBALS['extension_squelette'];
	$nom = $ext . '_' . md5($squelette);
	$sourcefile = $squelette . &quot;.$ext&quot;;

	// le squelette est-il deja en memoire (INCLURE  a repetition)
	if (function_exists($nom))
		return $nom;

	$phpfile = _DIR_CACHE . 'skel_' . $nom . '.php';

	// le squelette est-il deja compile et perenne ?
	if (!squelette_obsolete($phpfile, $sourcefile)
	AND lire_fichier ($phpfile, $contenu,
	array('critique' =&gt; 'oui', 'phpcheck' =&gt; 'oui'))) 
		eval('?'.'&gt;'.$contenu);

	// sinon, charger le compilateur et verifier que le source est lisible
	if (!function_exists($nom)) {
		include_local(&quot;inc-compilo.php3&quot;);
		lire_fichier ($sourcefile, $skel);
	}

	// Le fichier suivant peut contenir entre autres:
	// 1. les filtres utilises par le squelette
	// 2. des ajouts au compilateur
	// Le point 1 exige qu'il soit lu dans tous les cas.
	// Le point 2 exige qu'il soit lu apres inc-compilo
	// (car celui-ci initialise $tables_principales) mais avant la compil
	$f = $squelette . '_fonctions.php3';
	if (@file_exists($f)) include($f);

	if (function_exists($nom)) return $nom;

	$skel_code = calculer_squelette($skel, $nom, $ext, $sourcefile);

	// Tester si le compilateur renvoie une erreur
	if (is_array($skel_code))
		erreur_squelette($skel_code[0], $skel_code[1]);
	else {
		if ($GLOBALS['var_mode'] == 'debug') {
			include_ecrire(&quot;inc_debug_sql.php3&quot;);
			debug_dumpfile ($skel_code, $nom, 'code');
		}
		eval('?'.'&gt;'.$skel_code);
		if (function_exists($nom)) {
			ecrire_fichier ($phpfile, $skel_code);
			return $nom;
		}
	}
}

# Provoque la recherche du squelette $fond d'une $lang donnee,
# et l'applique sur un $contexte pour un certain $cache.
# Retourne un tableau de 3 elements:
# 'texte' =&gt; la page calculee
# 'process_ins' =&gt; 'html' ou 'php' si presence d'un '&lt; ?php'
# 'invalideurs' =&gt; les invalideurs (cf inc-calcul-squel)

# En cas d'erreur process_ins est absent et texte est un tableau de 2 chaines

# La recherche est assuree par la fonction chercher_squelette,
# definie dans inc-chercher, fichier non charge si elle est deja definie
# (typiquement dans mes_fonctions.php3)

function cherche_page ($cache, $contexte, $fond)  {
	global $dossier_squelettes, $delais;

	if (!function_exists('chercher_squelette'))
		include_local(&quot;inc-chercher.php3&quot;); # a renommer ?

	// Choisir entre $fond-dist.html, $fond=7.html, etc?
	$id_rubrique_fond = 0;
	// Si inc-urls veut fixer la langue, on la recupere ici
	$lang = $contexte['lang'];
	// Chercher le fond qui va servir de squelette
	if ($r = sql_rubrique_fond($contexte,
	$lang ? $lang : lire_meta('langue_site')))
		list($id_rubrique_fond, $lang) = $r;

	if (!$GLOBALS['forcer_lang'])
		lang_select($lang);

	$skel = chercher_squelette($fond,
			$id_rubrique_fond,
			$dossier_squelettes ? &quot;$dossier_squelettes/&quot; :'',
			$GLOBALS['spip_lang']);

	// Charger le squelette et recuperer sa fonction principale
	// (compilation automatique au besoin) et calculer

	$page = array();

	if ($skel) {
		if ($fonc = charger_squelette($skel))
		  $page = $fonc(array('cache' =&gt; $cache), array($contexte));

		// Passer la main au debuggueur)
		if ($GLOBALS['var_mode'] == 'debug')
		  {
			include_ecrire(&quot;inc_debug_sql.php3&quot;);
			debug_dumpfile ($page['texte'], $fonc, 'resultat');
		  }
	}

	// Nettoyer le resultat si on est fou de XML
	if ($GLOBALS['xhtml']) {
		include_ecrire(&quot;inc_tidy.php&quot;);
		$page['texte'] = xhtml($page['texte']);
	}

	// Entrer les invalideurs dans la base
	if ($delais&gt;0) {
		include_ecrire('inc_invalideur.php3');
		maj_invalideurs($cache, $page['invalideurs'], $delais);
	}

	// Retourner la structure de la page

	return $page;
}


//
// Contexte : lors du calcul d'une page spip etablit le contexte a partir
// des variables $HTTP_GET_VARS et $HTTP_POST_VARS, et leur ajoute la date
// Note : pour hacker le contexte depuis le fichier d'appel (article.php3),
// il est recommande de modifier $HTTP_GET_VARS['toto'] (meme si la page est
// appelee avec la methode POST).
//
function calculer_contexte() {
	foreach($GLOBALS['HTTP_GET_VARS'] as $var =&gt; $val) {
		if (strpos($var, 'var_') !== 0)
			$contexte[$var] = $val;
	}
	foreach($GLOBALS['HTTP_POST_VARS'] as $var =&gt; $val) {
		if (strpos($var, 'var_') !== 0)
			$contexte[$var] = $val;
	}

	if ($GLOBALS['date'])
		$contexte['date'] = $contexte['date_redac'] = normaliser_date($GLOBALS['date']);
	else
		$contexte['date'] = $contexte['date_redac'] = date(&quot;Y-m-d H:i:s&quot;);

	return $contexte;
}

function calculer_page_globale($cache, $contexte_local, $fond) {

	// Gestion des URLs personnalises - sale mais historique
	if (function_exists(&quot;recuperer_parametres_url&quot;)) {
		global $contexte;
		$contexte = $contexte_local;
		recuperer_parametres_url($fond, nettoyer_uri());

		// remettre les globales pour le bouton &quot;Modifier cet article&quot;
		if (is_array($contexte))
			foreach ($contexte as $var=&gt;$val)
				if (substr($var,0,3) == 'id_')
					$GLOBALS[$var] = $val;
		$contexte_local = $contexte;
	}

	// Go to work !
	$page = cherche_page($cache, $contexte_local, $fond);

	$signal = array();
	foreach(array('id_parent', 'id_rubrique', 'id_article', 'id_auteur',
	'id_breve', 'id_forum', 'id_secteur', 'id_syndic', 'id_syndic_article',
	'id_mot', 'id_groupe', 'id_document') as $val) {
		if ($contexte_local[$val])
			$signal['contexte'][$val] = intval($contexte_local[$val]);
	}

	$page['signal'] = $signal;

	return $page;
}


// Cf ramener_page +cherche_page_incluante+ cherche_page_incluse chez ESJ
function calculer_page($chemin_cache, $elements, $delais, $inclusion=false) {

	// Inclusion
	if ($inclusion) {
		$contexte_inclus = $elements['contexte'];
		$page = cherche_page($chemin_cache,
			$contexte_inclus, $elements['fond']);
	}
	else {

		// Page globale
		// si le champ chapo commence par '=' c'est une redirection.
		if ($id_article = intval($GLOBALS['id_article'])) {
			if ($art = sql_chapo($id_article)) {
				$chapo = $art['chapo'];
				if (substr($chapo, 0, 1) == '=') {
					include_ecrire('inc_texte.php3');
					list(,$url) = extraire_lien(array('','','',
					substr($chapo, 1)));
					if ($url) { // sinon les navigateurs pataugent
						$url = addslashes($url);
						$page = array('texte' =&gt; &quot;&lt;&quot;.
						&quot;?php header(\&quot;Location: $url\&quot;); ?&quot; . &quot;&gt;&quot;,
						'process_ins' =&gt; 'php');
					}
				}
			}
		}
		if (!$page)
			$page = calculer_page_globale($chemin_cache,
				$elements['contexte'],
				$elements['fond']);
	}

	$page['signal']['process_ins'] = $page['process_ins'];
	$signal = &quot;&lt;!-- &quot;.str_replace(&quot;\n&quot;, &quot; &quot;,
	serialize($page['signal'])).&quot; --&gt;\n&quot;;

	// Enregistrer le fichier cache
	if ($delais &gt; 0 AND $GLOBALS['var_mode'] != 'debug'
	AND empty($GLOBALS['HTTP_POST_VARS']))
		ecrire_fichier($chemin_cache, $signal.$page['texte']);

	return $page;
}
?&gt;

--- NEW FILE: formulaire_ecrire_auteur-dist.html ---
[&lt;br /&gt;&lt;img src='puce(#HTTP_VARS{sujetko}).gif' border='0' alt='-' /&gt; &lt;:form_prop_indiquer_sujet:&gt;&lt;br /&gt;&nbsp;][
&lt;br /&gt;&lt;img src='puce(#HTTP_VARS{mailko}).gif' border='0' alt='-' /&gt; &lt;:form_prop_indiquer_email:&gt;&lt;br /&gt;&lt;br /&gt;
]&lt;form action=&quot;[(#HTTP_VARS{action})]&quot; method='post'&gt;
&lt;p&gt;&lt;label&gt;&lt;:form_pet_votre_email:&gt;
	&lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;email_message_auteur&quot;
		 value=&quot;[(#HTTP_VARS{mail})]&quot; size=&quot;30&quot; /&gt;
&lt;/label&gt;&lt;/p&gt;
&lt;p&gt;&lt;label&gt;&lt;:form_prop_sujet:&gt;&lt;br /&gt;
	&lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;sujet_message_auteur&quot;
		 value=&quot;[(#HTTP_VARS{sujet})]&quot; size=&quot;30&quot; /&gt;
&lt;/label&gt;&lt;/p&gt;
&lt;p&gt;
&lt;textarea name='texte_message_auteur' rows='10' class='forml' cols='40'&gt;[(#HTTP_VARS{texte})]&lt;/textarea&gt;
&lt;/p&gt;
[&lt;input type=&quot;hidden&quot; name=&quot;id_auteur&quot; value=&quot;(#HTTP_VARS{id_auteur})&quot; /&gt;]
&lt;div align=&quot;right&quot;&gt;
	&lt;input type=&quot;submit&quot;  class=&quot;spip_bouton&quot; name=&quot;valide&quot;
		 value=&quot;[(#HTTP_VARS{valide})]&quot; /&gt;
&lt;/div&gt;
&lt;/form&gt;

--- NEW FILE: inc-url_logout.php3 ---
&lt;?php

global $balise_URL_LOGOUT_collecte;
$balise_URL_LOGOUT_collecte = array();

function balise_URL_LOGOUT_stat ($args, $filtres)
{
  return array($filtres[0]);
}

function balise_URL_LOGOUT_dyn($cible)
{
	if (!$login = $GLOBALS['auteur_session']['login'])
	  return '';
	if (!$cible) $cible = $GLOBALS['clean_link']-&gt;getUrl();
	return 'spip_cookie.php3?logout_public=' . $login . '&amp;url=' . urlencode($cible);
}
?&gt;

--- NEW FILE: index.php3 ---
&lt;?php include (&quot;sommaire.php3&quot;); ?&gt;

--- NEW FILE: formulaire_recherche-dist.html ---
&lt;form action='[(#HTTP_VARS{lien})]' method='get' class='formrecherche'&gt;
	&lt;div&gt;
		&lt;input	type='text'
			id='formulaire_recherche'
			class='formrecherche'
			name='recherche'
			value=&quot;[(#HTTP_VARS{recherche})]&quot; /&gt;
	&lt;/div&gt;
&lt;/form&gt;

--- NEW FILE: inc-login_public.php3 ---
&lt;?php

include(_FILE_CONNECT);
include_ecrire(&quot;inc_meta.php3&quot;);
include_ecrire(&quot;inc_session.php3&quot;);
include_ecrire(&quot;inc_filtres.php3&quot;);

global $balise_LOGIN_PUBLIC_collecte;
$balise_LOGIN_PUBLIC_collecte = array('url');

# retourner:
# 1. l'url collectee ci-dessus (args0) ou donnee en filtre (filtre0)
# 2. l'eventuel parametre de la balise (args1) fournie par calculer_balise_dynamique

function balise_LOGIN_PUBLIC_stat ($args, $filtres)
{
	return array($filtres[0] ? $filtres[0] : $args[0], $args[1]);
}

function balise_LOGIN_PUBLIC_dyn($cible, $login)
{
	if (!$cible) {
		global $clean_link;
		$clean_link-&gt;delVar('var_erreur');
		$clean_link-&gt;delVar('var_login');
		$cible = $clean_link-&gt;getUrl();
	}
	return login_explicite($login, $cible,  'forum');
}

function login_explicite($login, $cible, $mode) {
	global $auteur_session, $clean_link;

	$clean_link-&gt;delVar('var_erreur');
	$clean_link-&gt;delVar('var_login');
	$action = $clean_link-&gt;getUrl();

	if ($cible) {
	  $cible = ereg_replace(&quot;[?&amp;]var_erreur=[^&amp;]*&quot;, '', $cible);
	  $cible = ereg_replace(&quot;[?&amp;]var_login=[^&amp;]*&quot;, '', $cible);
	} else {
	  if (ereg(&quot;[?&amp;]url=([^&amp;]*)&quot;, $action, $m))
	    $cible = urldecode($m[1]);
	  else
	    $cible = _DIR_RESTREINT ;
	}
	      
	include_ecrire(&quot;inc_session.php3&quot;);
	verifier_visiteur();

	if ($auteur_session AND 
	($auteur_session['statut']=='0minirezo' OR $auteur_session['statut']=='1comite')) {
		if (($cible != $action) &amp;&amp;  !headers_sent())
			redirige_par_entete($cible);
		return http_href($cible, _T('login_par_ici'));
	}
	return login_pour_tous($login ? $login : $GLOBALS['var_login'], $cible, '', $action, $mode);
}

// fonction aussi pour les forums sur abonnement

function login_pour_tous($login, $cible, $message, $action, $mode) {

  global $ignore_auth_http, $spip_admin, $php_module;

	// en cas d'echec de cookie, inc_auth a renvoye vers spip_cookie qui
	// a tente de poser un cookie ; s'il n'est pas la, c'est echec cookie
	// s'il est la, c'est probablement un bookmark sur bonjour=oui,
	// et pas un echec cookie.
	if ($GLOBALS['var_echec_cookie'])
	  $echec_cookie = ($GLOBALS['spip_session'] != 'test_echec_cookie');
	$auth = ($echec_cookie AND $php_module AND !$ignore_auth_http) ?
	  'spip_cookie.php3' : '';
	// Le login est memorise dans le cookie d'admin eventuel
	if (!$login) {
		if (ereg(&quot;^@(.*)$&quot;, $spip_admin, $regs))
			$login = $regs[1];
	} else if ($login == '-1')
	  $login = '';

	$row = array();
	$erreur = '';
	if ($login) {
		$row = spip_query(&quot;SELECT * FROM spip_auteurs WHERE login='&quot; .addslashes($login) .&quot;'&quot;);
		$row =  spip_fetch_array($row);
		if ((!$row AND !$GLOBALS['ldap_present']) OR
		    ($row['statut'] == '5poubelle') OR 
		    (($row['source'] == 'spip') AND $row['pass'] == '')) {
			$erreur =  _T('login_identifiant_inconnu', array('login' =&gt; $login));
 			$row = array();
			$login = '';
			@spip_setcookie(&quot;spip_admin&quot;, &quot;&quot;, time() - 3600);
		} else {
		  // on laisse le menu decide de la langue
		  unset($row['lang']);
		}
	}

	return array('formulaire_login', 0, 
		     array_merge(array_map('addslashes', $row),
				 array(
				       'action2' =&gt; ($login ? 'spip_cookie.php3' : $action),
				       'erreur' =&gt; $erreur,
				       'action' =&gt; $action,
				       'url' =&gt; $cible,
				       'auth' =&gt; $auth,
				       'echec_cookie' =&gt; ($echec_cookie ? ' ' : ''),
				       'message' =&gt; ($message ? ' ' : ''),
				       )
				 )
		     );

}

// Bouton duree de connexion

function filtre_rester_connecte($prefs) 
{
	$prefs = unserialize(stripslashes($prefs));
	return $prefs['cnx'] == 'perma' ? ' ' : '';
}

function silogoauteur($id_auteur)
{
  $f = _DIR_IMG . 'auton' . $id_auteur . '.jpg';
  return (@file_exists($f) ? $f : '');
}
?&gt;

--- NEW FILE: inc-public.php3 ---
&lt;?php

// Page inclue ?
if (defined(&quot;_INC_PUBLIC&quot;)) {
	$page = inclure_page($fond, $delais, $contexte_inclus, $fichier_inclus);

	if ($page['process_ins'] == 'html')
		echo $page['texte'];
	else
		eval('?' . '&gt;' . $page['texte']);

	if ($page['lang_select'])
		lang_dselect();
}
// Premier appel inc-public
else {
	define(&quot;_INC_PUBLIC&quot;, &quot;1&quot;);
	include (&quot;ecrire/inc_version.php3&quot;);

	//
	// Initialisations
	//

	// Regler le $delais par defaut
	if ($INSECURE['fond'] || $INSECURE['delais'])
		exit;
	if (!isset($delais))
		$delais = 1 * 3600;
	if ($recherche)
		$delais = 0;

	// authentification du visiteur
	if ($HTTP_COOKIE_VARS['spip_session'] OR
	($PHP_AUTH_USER AND !$ignore_auth_http)) {
		include_ecrire (&quot;inc_session.php3&quot;);
		verifier_visiteur();
	}
	// multilinguisme
	if ($forcer_lang AND ($forcer_lang!=='non') AND empty($HTTP_POST_VARS)) {
		include_ecrire('inc_lang.php3');
		verifier_lang_url();
	}
	if ($HTTP_GET_VARS['lang']) {
		include_ecrire('inc_lang.php3');
		lang_select($HTTP_GET_VARS['lang']);
	}
	// Ajout_forum (pour les forums) et $val_confirm signalent des modifications
	// a faire avant d'afficher la page
	if ($ajout_forum) {
		$redirect = '';
		include('inc-messforum.php3');
		if ($redirect) redirige_par_entete($redirect);
	}
	if ($val_confirm) {
		include_local('inc-formulaire_signature.php3');
		reponse_confirmation($id_article, $val_confirm);
	}

	include_local ('inc-public-global.php3');

	//  refus du debug si pas dans les options generales ni admin connecte
	if ($var_mode=='debug') {
		if (($code_activation_debug == 'oui')
		OR $auteur_session['statut'] == '0minirezo')
			spip_log('debug !');
		else
			$var_mode = false; 
	}

	// est-on admin ?
	if ($affiche_boutons_admin = (!$flag_preserver
	AND ($HTTP_COOKIE_VARS['spip_admin']
	OR $HTTP_COOKIE_VARS['spip_debug'])))
		include_local('inc-formulaire_admin.php3');

	$tableau_des_erreurs = array();
	$page = afficher_page_globale ($fond, $delais, $use_cache);

	if (!$flag_preserver) {
	// Interdire au client de cacher un login, un admin ou un recalcul
		if ($flag_dynamique OR $var_mode
		OR $HTTP_COOKIE_VARS['spip_admin']) {
			@header(&quot;Cache-Control: no-cache,must-revalidate&quot;);
			@header(&quot;Pragma: no-cache&quot;);
	// Pour les autres donner l'heure de modif
		} else if ($lastmodified)
			@Header (&quot;Last-Modified: &quot;.http_gmoddate($lastmodified).&quot; GMT&quot;);

	// si le squelette est nul se rabattre sur l'entete standard
		if ($page['texte']) 
			@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
		else
			echo debut_entete($fond);
	}
	define('spip_active_ob', $flag_ob AND
		($var_mode == 'debug' OR $var_recherche OR $affiche_boutons_admin));

	// Cas d'une page contenant uniquement du HTML :
	if ($page['process_ins'] == 'html') {
		if (!spip_active_ob) {
			echo $page['texte'];
			$contenu = '';
		} else
			$contenu = $page['texte'];
	}

	// Cas d'une page contenant du PHP :
	else {
		// Evaluer la page
		if (!spip_active_ob) {
			eval('?' . '&gt;' . $page['texte']);
			$contenu = '';
		} else {
			ob_start(); 
			$res = eval('?' . '&gt;' . $page['texte']);
			$contenu = ob_get_contents(); 
			ob_end_clean();

			// en cas d'erreur lors du eval, afficher un message
			// et forcer les boutons de debug
			if ($res === false AND $affiche_boutons_admin
			AND $auteur_session['statut'] == '0minirezo') {
				include_ecrire('inc_debug_sql.php3');
				erreur_squelette(_L('erreur d\'execution de la page'));
			}
		}
	}

	// Passer la main au debuggueur le cas echeant 
	if ($var_mode == 'debug') {
		include_ecrire(&quot;inc_debug_sql.php3&quot;);
		debug_dumpfile('',$var_mode_objet,$var_mode_affiche);
		exit;
	} else if (count($tableau_des_erreurs) &gt; 0
	AND $affiche_boutons_admin)
		affiche_erreurs_page ($tableau_des_erreurs);

	// Traiter var_recherche pour surligner les mots
	if ($var_recherche) {
		include_ecrire(&quot;inc_surligne.php3&quot;);
		$contenu = surligner_mots($contenu, $var_recherche);
	}

	// Ajouter au besoin la CSS des boutons admins
	if ($affiche_boutons_admin) {
		include_local(&quot;inc-admin.php3&quot;);
		$contenu = perso_admin($contenu);
	}

	// Afficher le resultat final
	echo $contenu;

	// Ajouter les boutons admins (les normaux) si absents
	// (ce sera apres la balise /html mais tant pis)
	if ($affiche_boutons_admin)
		inclure_balise_dynamique(balise_formulaire_admin_dyn($id_article, $id_breve, $id_rubrique, $id_mot, $id_auteur));

	// Taches de fin
	terminer_public_global();
 }

?&gt;

--- NEW FILE: htaccess-propres.txt ---
###########################################################
# Fichier .htaccess pour les URLs propres ; a installer   #
# si vous reglez $type_urls='propre'                      #
# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
# (fichier associe : inc-urls-propres.php3)               #
###########################################################

RewriteEngine On

### si votre site est en sous-domaine, preciser ci-dessous
# RewriteBase /sous/domaine/

# Rediriger les mots et breves sans le &quot;+&quot; final
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(\+[^/\.\+]+)$ /$1+ [QSA,R]

# Les mots-cles
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^\+-[^/\.]+-\+$ mot.php3 [QSA,E=url_propre:$0]

# Les breves
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^\+[^/\.]+\+$ breve.php3 [QSA,E=url_propre:$0]

# Les rubriques
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^-[^/\.]+-$ rubrique.php3 [QSA,E=url_propre:$0]

# Les articles
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^[^/\.]+$ article.php3 [QSA,E=url_propre:$0]

--- NEW FILE: inc-formulaire_forum.php3 ---
&lt;?php

include_ecrire('inc_meta.php3');
include_ecrire('inc_admin.php3');
include_ecrire('inc_acces.php3');
include_ecrire('inc_texte.php3');
include_ecrire('inc_filtres.php3');
include_ecrire('inc_lang.php3');
include_ecrire('inc_mail.php3');
include_ecrire('inc_forum.php3');
include_ecrire(&quot;inc_abstract_sql.php3&quot;);
include_local(_FILE_CONNECT);

// Gestionnaire d'URLs
if (@file_exists(&quot;inc-urls.php3&quot;))
	include_local(&quot;inc-urls.php3&quot;);
else
	include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);

/*******************************/
/* GESTION DU FORMULAIRE FORUM */
/*******************************/
global $balise_FORMULAIRE_FORUM_collecte;
$balise_FORMULAIRE_FORUM_collecte = array('id_rubrique', 'id_forum', 'id_article', 'id_breve', 'id_syndic');

function balise_FORMULAIRE_FORUM_stat($args, $filtres)
{
  list ($idr, $idf, $ida, $idb, $ids) = $args;

  // recuperer les donnees du forum auquel on repond, false = forum interdit
  if (!$r = sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids))
    return '';
  list($titre, $table, $forums_publics) = $r;
  return 
    array($titre, $table, $forums_publics, $idr, $idf, $ida, $idb, $ids);
}

function balise_FORMULAIRE_FORUM_dyn($titre, $table, $forums_publics, $id_rubrique, $id_forum, $id_article, $id_breve, $id_syndic) {

	global $REMOTE_ADDR, $id_message, $afficher_texte, $spip_forum_user;

	// url de reference
	if (!$url = rawurldecode($GLOBALS['url'])) 
	    $url = $GLOBALS['REQUEST_URI'];
	else {
	// identifiants des parents
	  $args = '';  
	  if ($id_rubrique) $args .= &quot;id_rubrique=$id_rubrique&quot;;
	  if ($id_forum) $args .= &quot;id_forum=$id_forum&quot;;
	  if ($id_article) $args .= &quot;id_article=$id_article&quot;;
	  if ($id_breve) $args .= &quot;id_breve=$id_breve&quot;;
	  if ($id_syndic) $args .= &quot;id_syndic=$id_syndic&quot;;
	  if ($args &amp;&amp; strpos($url,$args)===false) $url .= (strpos($url,'?') ? '&amp;' : '?') . $args;
	}
	$url = ereg_replace(&quot;[?&amp;]var_erreur=[^&amp;]*&quot;, '', $url);
	$url = ereg_replace(&quot;[?&amp;]var_login=[^&amp;]*&quot;, '', $url);
	$url = ereg_replace(&quot;[?&amp;]url=[^&amp;]*&quot;, '', $url);

	// verifier l'identite des posteurs pour les forums sur abo
	if (($forums_publics == &quot;abo&quot;) &amp;&amp; (!$GLOBALS[&quot;auteur_session&quot;]))
	  {
	    include_local('inc-login_public.php3');
	    return login_pour_tous($GLOBALS['var_login'], $url, true, $url, 'forum');
	  }
	// au premier appel (pas de http-var nommee &quot;retour&quot;)
	// memoriser l'URL courante pour y revenir apres envoi du message
	// aux appels suivants, reconduire la valeur.
	if ($retour = rawurldecode($GLOBALS['HTTP_GET_VARS']['retour']))
	  $retour = ereg_replace('&amp;var_mode=recalcul','',$retour);
	else {
	  if (!$retour = rawurldecode($GLOBALS['HTTP_POST_VARS']['retour']))
	    $retour = $url;
	}

	// ne pas mettre '', sinon le squelette n'affichera rien.

	$previsu = ' ';

	// Recuperer le message a previsualiser
	if ($id_message = intval($GLOBALS['HTTP_POST_VARS']['id_message']))  {
		$titre = $GLOBALS['HTTP_POST_VARS']['titre'];
		$texte = $GLOBALS['HTTP_POST_VARS']['texte'];
		$auteur = $GLOBALS['HTTP_POST_VARS']['auteur'];
		$email_auteur = $GLOBALS['HTTP_POST_VARS']['email_auteur'];
		$nom_site_forum = $GLOBALS['HTTP_POST_VARS']['nom_site_forum'];
		$url_site = $GLOBALS['HTTP_POST_VARS']['url_site'];

		if ($afficher_texte != 'non') {
			$previsu = 
			  &quot;&lt;div style='font-size: 120%; font-weight: bold;'&gt;&quot;
			  . interdire_scripts(typo($titre))
			  . &quot;&lt;/div&gt;&lt;p /&gt;&lt;b&gt;&lt;a href=\&quot;mailto:&quot;
			  . interdire_scripts(typo($email_auteur)) . &quot;\&quot;&gt;&quot;
			  . interdire_scripts(typo($auteur)) . &quot;&lt;/a&gt;&lt;/b&gt;&lt;p /&gt;&quot;
			  . propre($texte) . &quot;&lt;p /&gt;&lt;a href=\&quot;&quot;
			  . interdire_scripts($url_site) . &quot;\&quot;&gt;&quot;
			  . interdire_scripts(typo($nom_site_forum)) . &quot;&lt;/a&gt;&quot;;

			// Verifier mots associes au message
			$result_mots = spip_query(&quot;SELECT mots.id_mot, mots.titre, mots.type
			FROM spip_mots_forum AS lien, spip_mots AS mots 
			WHERE id_forum='$id_message' AND mots.id_mot = lien.id_mot
			GROUP BY mots.id_mot&quot;);
			if (spip_num_rows($result_mots)&gt;0) {
				$previsu .= &quot;&lt;p&gt;&quot;._T('forum_avez_selectionne').&quot;&lt;/p&gt;&lt;ul&gt;&quot;;
				while ($row = spip_fetch_array($result_mots)) {
					$les_mots[$row['id_mot']] = &quot;checked='checked'&quot;;
					$presence_mots = true;
					$previsu .= &quot;&lt;li class='font-size=80%'&gt; &quot;
					. typo($row['type']) . &quot;&nbsp;: &lt;b&gt;&quot;
					. typo($row['titre']) .&quot;&lt;/b&gt;&lt;/li&gt;&quot;;
				}
				$previsu .= '&lt;/ul&gt;';
			}

			if (strlen($texte) &lt; 10 AND !$presence_mots) {
				$previsu .= &quot;&lt;p align='right' style='color: red;'&gt;&quot;._T('forum_attention_dix_caracteres').&quot;&lt;/p&gt;\n&quot;;
			}
			else if (strlen($titre) &lt; 3 AND $afficher_texte &lt;&gt; &quot;non&quot;) {
				$previsu .= &quot;&lt;p align='right' style='color: red;'&gt;&quot;._T('forum_attention_trois_caracteres').&quot;&lt;/p&gt;&quot;;
			}
			else {
				$previsu .= &quot;&lt;div align='right'&gt;&lt;input type='submit' name='confirmer' class='spip_bouton' value='&quot;._T('forum_message_definitif').&quot;' /&gt;&lt;/div&gt;&quot;;
			}
			$previsu = &quot;&lt;div class='spip_encadrer'&gt;$previsu&lt;/div&gt;\n&lt;br /&gt;&quot;;
			// supprimer les &lt;form&gt; de la previsualisation
			// (sinon on ne peut pas faire &lt;cadre&gt;...&lt;/cadre&gt; dans les forums)
			$previsu = preg_replace(&quot;@&lt;(/?)f(orm[&gt;[:space:]])@ism&quot;, &quot;&lt;\\1no-f\\2&quot;, $previsu);
		}
	} else {
		// Premiere edition, initialiser l'auteur
	  	// puis s'accorder une nouvelle entree dans la table
		if ($spip_forum_user &amp;&amp; is_array($cookie_user = unserialize($spip_forum_user))) {
			$auteur = $cookie_user['nom'];
			$email_auteur = $cookie_user['email'];
		}
		else {
			$auteur = $GLOBALS['auteur_session']['nom'];
			$email_auteur = $GLOBALS['auteur_session']['email'];
		}
		$id_message = spip_abstract_insert('forum', 
					  &quot;(date_heure, titre, ip, statut)&quot;,
					  &quot;(NOW(), '&quot;.addslashes($titre).&quot;', '$REMOTE_ADDR', 'redac')&quot;);

	}

	// Generation d'une valeur de securite pour validation
	$seed = (double) (microtime() + 1) * time() * 1000000;
	@mt_srand($seed);
	$alea = @mt_rand();
	if (!$alea) {srand($seed);$alea = rand();}
	$forum_id_rubrique = intval($id_rubrique);
	$forum_id_forum = intval($id_forum);
	$forum_id_article = intval($id_article);
	$forum_id_breve = intval($id_breve);
	$forum_id_syndic = intval($id_syndic);
	$hash = calculer_action_auteur(&quot;ajout_forum $forum_id_rubrique $forum_id_forum $forum_id_article $forum_id_breve $forum_id_syndic $alea&quot;);

	// Faut-il ajouter des propositions de mots-cles
	if ((lire_meta(&quot;mots_cles_forums&quot;) == &quot;oui&quot;) &amp;&amp; ($table != 'forum'))
		$table = table_des_mots($table, $les_mots);
	else
		$table = '';

	return array(
		     'formulaire_forum',
		     0,
		     array(
		     'afficher_non' =&gt; 
		     ($afficher_texte != 'non' ? '' :
		      (boutonne('hidden', 'titre', htmlspecialchars($titre)) .
		       $table .
		       &quot;\n&lt;br /&gt;&lt;div align='right'&gt;&quot; .
		       boutonne('submit', '', _T('forum_valider'), &quot;class='spip_bouton'&quot;) .
		       &quot;&lt;/div&gt;&quot;)), 
		     'alea' =&gt; $alea,
		     'auteur' =&gt; $auteur,
		     'disabled' =&gt; ($forums_publics == &quot;abo&quot;)? &quot; disabled='disabled'&quot; : '',
		     'email_auteur' =&gt; $email_auteur,
		     'hash' =&gt; $hash,
		     'id_message' =&gt; $id_message,
		     'modere' =&gt; (($forums_publics != 'pri') ? '' :
				  _T('forum_info_modere')),
		     'nom_site_forum' =&gt; $nom_site_forum,
		     'previsu' =&gt; $previsu,
		     'retour' =&gt; $retour,
		     'table' =&gt; $table,
		     'texte' =&gt; $texte,
		     'titre' =&gt; $titre,
		     'url' =&gt;  $url,
		     'url_site' =&gt; ($url_site ? $url_site : &quot;<A HREF="http://">http://</A>&quot;)
		     ));
}


function barre_forum($texte)
{
	include_ecrire('inc_layer.php3');

	if (!$GLOBALS['browser_barre'])
		return &quot;&lt;textarea name='texte' rows='12' class='forml' cols='40'&gt;$texte&lt;/textarea&gt;&quot;;
	static $num_formulaire = 0;
	$num_formulaire++;
	include_ecrire('inc_barre.php3');
	return afficher_barre(&quot;document.getElementById('formulaire_$num_formulaire')&quot;, true) .
	  &quot;
&lt;textarea name='texte' rows='12' class='forml' cols='40'
id='formulaire_$num_formulaire'
onselect='storeCaret(this);'
onclick='storeCaret(this);'
onkeyup='storeCaret(this);'
ondbclick='storeCaret(this);'&gt;$texte&lt;/textarea&gt;&quot;;
}

// Mots-cles dans les forums :
// Si la variable de personnalisation $afficher_groupe[] est definie
// dans le fichier d'appel, et si la table de reference est OK, proposer
// la liste des mots-cles
function table_des_mots($table, $les_mots) {
	global $afficher_groupe;

	if ($afficher_groupe)
		$in_group = &quot; AND id_groupe IN (&quot; . join($afficher_groupe, &quot;, &quot;) .&quot;)&quot;;

	$result_groupe = spip_query(&quot;SELECT * FROM spip_groupes_mots
	WHERE 6forum = 'oui' AND $table = 'oui'&quot;. $in_group);

	$ret = '';
	while ($row_groupe = spip_fetch_array($result_groupe)) {
		$id_groupe = $row_groupe['id_groupe'];
		$titre_groupe = propre($row_groupe['titre']);
		$unseul = ($row_groupe['unseul']== 'oui') ? 'radio' : 'checkbox';
		$result =spip_query(&quot;SELECT * FROM spip_mots
		WHERE id_groupe='$id_groupe'&quot;);
		$total_rows = spip_num_rows($result);

		if ($total_rows &gt; 0) {
			$ret .= &quot;\n&lt;p /&gt;&quot;
			  . &quot;&lt;div class='spip_encadrer' style='font-size: 80%;'&gt;&quot;
			  . &quot;&lt;b&gt;$titre_groupe&nbsp;:&lt;/b&gt;&quot;
			  . &quot;&lt;table cellpadding='0' cellspacing='0' border='0' width='100%'&gt;\n&quot;
			  .&quot;&lt;tr&gt;&lt;td width='47%' valign='top'&gt;&quot;;
			$i = 0;
      
		while ($row = spip_fetch_array($result)) {
			$id_mot = $row['id_mot'];
			$titre_mot = propre($row['titre']);
			$descriptif_mot = propre($row['descriptif']);

			if ($i &gt;= ($total_rows/2) AND $i &lt; $total_rows) {
				$i = $total_rows + 1;
				$ret .= &quot;&lt;/td&gt;&lt;td width='6%'&gt;&nbsp;&lt;/td&gt;
				&lt;td width='47%' valign='top'&gt;&quot;;
			}

			$ret .= boutonne($unseul, &quot;ajouter_mot[$id_groupe][]&quot;, $id_mot, &quot;id='mot$id_mot' &quot; . $les_mots[$id_mot]) .
			  afficher_petits_logos_mots($id_mot)
			. &quot;&lt;b&gt;&lt;label for='mot$id_mot'&gt;$titre_mot&lt;/label&gt;&lt;/b&gt;&lt;br /&gt;&quot;;

			if ($descriptif_mot)
				$ret .= &quot;$descriptif_mot&lt;br /&gt;&quot;;
			$i++;
		}

		$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
		$ret .= &quot;&lt;/div&gt;&quot;;
		}
	}

	return $ret;
}


function afficher_petits_logos_mots($id_mot) {
	include_ecrire('inc_logos.php3');
	$on = cherche_image_nommee(&quot;moton$id_mot&quot;);
	if ($on) {
	  $image = (&quot;$on[0]$on[1].$on[2]&quot;);
		$taille = @getimagesize($image);
		$largeur = $taille[0];
		$hauteur = $taille[1];
		if ($largeur &lt; 100 AND $hauteur &lt; 100)
			return &quot;&lt;img src='$image' align='middle' width='$largeur'
			height='$hauteur' hspace='1' vspace='1' alt=' ' border='0'
			class='spip_image' /&gt; &quot;;
	}
}

/*******************************************************/
/* FONCTIONS DE CALCUL DES DONNEES DU FORMULAIRE FORUM */
/*******************************************************/

//
// Chercher le titre et la configuration du forum de l'element auquel on repond
//

function sql_recherche_donnees_forum ($idr, $idf, $ida, $idb, $ids) {

	// changer la table de reference s'il y a lieu (pour afficher_groupes[] !!)
	if ($idr) {
		$r = &quot;SELECT titre FROM spip_rubriques WHERE id_rubrique = $idr&quot;;
		$table = &quot;rubriques&quot;;
	} else if ($ida) {
		$r = &quot;SELECT titre FROM spip_articles WHERE id_article = $ida&quot;;
		$table = &quot;articles&quot;;
	} else if ($idb) {
		$r = &quot;SELECT titre FROM spip_breves WHERE id_breve = $idb&quot;;
		$table = &quot;breves&quot;;
	} else if ($ids) {
		$r = &quot;SELECT nom_site AS titre FROM spip_syndic WHERE id_syndic = $ids&quot;;
		$table = &quot;syndic&quot;;
	}

	if ($idf)
		$r = &quot;SELECT titre FROM spip_forum WHERE id_forum = $idf&quot;;

	if ($r) {
		list($titre) = spip_fetch_array(spip_query($r));
		$titre = '&gt; ' . supprimer_numero($titre);
	} else {
		$titre = _T('forum_titre_erreur');
		$table = '';
	}

	// quelle est la configuration du forum ?
	if ($ida)
		list($accepter_forum) = spip_fetch_array(spip_query(
		&quot;SELECT accepter_forum FROM spip_articles WHERE id_article=$ida&quot;));
	else
		$accepter_forum = substr(lire_meta(&quot;forums_publics&quot;),0,3);
	// valeurs possibles : 'pos'teriori, 'pri'ori, 'abo'nnement
	if ($accepter_forum == &quot;non&quot;)
		return false;

	return array ($titre, $table, $accepter_forum);
}

?&gt;

--- NEW FILE: formulaire_forum-dist.html ---
&lt;form action='[(#HTTP_VARS{url})]' method='post' name='formulaire'&gt;
      &lt;input type='hidden' name='ajout_forum' value=&quot;oui&quot; /&gt;
      &lt;input type='hidden' name='id_message' value=&quot;[(#HTTP_VARS{id_message})]&quot; /&gt;
      &lt;input type='hidden' name='alea' value=&quot;[(#HTTP_VARS{alea})]&quot; /&gt;
      &lt;input type='hidden' name='hash' value=&quot;[(#HTTP_VARS{hash})]&quot; /&gt;
      &lt;input type='hidden' name='retour' value=&quot;[(#HTTP_VARS{retour})]&quot; /&gt;
      [(#HTTP_VARS*{modere})&lt;p&gt;]
      [(#HTTP_VARS*{afficher_non})]
      [(#HTTP_VARS*{previsu})
      &lt;fieldset class='spip_encadrer'&gt;
	&lt;legend&gt;&lt;b&gt;&lt;:forum_titre:&gt;&lt;/b&gt;&lt;/legend&gt;
	&lt;label&gt;
	  &lt;input type='text' name='titre' 
	    [value=&quot;(#HTTP_VARS{titre})&quot; ]class='forml' size='40' /&gt;
	&lt;/label&gt;
      &lt;/fieldset&gt;
      &lt;br /&gt;
      &lt;fieldset class='spip_encadrer'&gt;
	&lt;legend&gt;&lt;b&gt;&lt;:forum_texte:&gt;&lt;/b&gt;&lt;/legend&gt;
	&lt;p&gt;&lt;:info_creation_paragraphe:&gt;&lt;/p&gt;
[(#HTTP_VARS{texte}|barre_forum)]
      &lt;/fieldset&gt;
      &lt;br /&gt;
      [(#HTTP_VARS*{table})]
      &lt;fieldset class='spip_encadrer'&gt;
	&lt;legend&gt;&lt;:forum_lien_hyper:&gt;&lt;/legend&gt;
	&lt;p&gt;&lt;:forum_page_url:&gt;&lt;/p&gt;
	&lt;p&gt;&lt;label&gt;&lt;:forum_titre:&gt;
	  &lt;input type='text' name='nom_site_forum' class='forml' size='40'
	  value=&quot;[(#HTTP_VARS{nom_site_forum})]&quot;  /&gt;
	&lt;/label&gt;&lt;/p&gt;
	&lt;p&gt;&lt;label&gt;&lt;:forum_url:&gt;
	&lt;input type='text' name='url_site' class='forml'  size='40'
	  value=&quot;[(#HTTP_VARS{url_site})]&quot; /&gt;
	&lt;/label&gt;&lt;/p&gt;
	&lt;/fieldset&gt;
      &lt;br /&gt;
	&lt;fieldset class='spip_encadrer'&gt;
	  &lt;legend&gt;&lt;:forum_qui_etes_vous:&gt;&lt;/legend&gt;
	  &lt;p&gt;
	  &lt;label&gt;
	    &lt;:forum_votre_nom:&gt;
	    &lt;input type='text' name='auteur' value=&quot;[(#HTTP_VARS{auteur})]&quot;
	      class='forml' size='40' [(#HTTP_VARS{disabled})] /&gt;
	  &lt;/label&gt;
	  &lt;/p&gt;
	  &lt;p&gt;
	  &lt;label&gt;
	    &lt;:forum_votre_email:&gt;
	    &lt;input type='text' name='email_auteur' value=&quot;[(#HTTP_VARS{email_auteur})]&quot;
	      class='forml' size='40' [(#HTTP_VARS{disabled})] /&gt;
	  &lt;/label&gt;
	&lt;/p&gt;
      &lt;/fieldset&gt;
      &lt;br /&gt;&lt;div align='right'&gt;
	&lt;input type='submit'  value=&quot;&lt;:forum_voir_avant:&gt;&quot; class='spip_bouton'&gt;&lt;/div&gt;]
&lt;/form&gt;


--- NEW FILE: inc-compilo.php3 ---
&lt;?php

//
// Fichier principal du compilateur de squelettes
//

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_COMPILO&quot;)) return;
define(&quot;_INC_COMPILO&quot;, &quot;1&quot;);


// Definition de la structure $p, et fonctions de recherche et de reservation
// dans l'arborescence des boucles
include_local(&quot;inc-compilo-index.php3&quot;);  # index ? structure ? pile ?

// definition des boucles
include_local(&quot;inc-boucles.php3&quot;);

// definition des criteres
include_local(&quot;inc-criteres.php3&quot;);

// definition des balises
include_local(&quot;inc-balises.php3&quot;);

// definition de l'API
include_local(&quot;inc-compilo-api.php3&quot;);

# definition des tables
include_ecrire('inc_serialbase.php3');

// outils pour debugguer le compilateur
#include_local(&quot;inc-compilo-debug.php3&quot;); # desactive

//
// Calculer un &lt;INCLURE()&gt;
//
function calculer_inclure($fichier, $params, $id_boucle, &amp;$boucles) {
	global $dossier_squelettes;

	$l = array();
	if ($params) {
		foreach($params as $var =&gt; $val) {
			if ($val) {
			  $val = trim($val);
			  $val = ereg_replace('^[&quot;\'](.*)[&quot;\']$', &quot;\\1&quot;,$val);
			  $l[] = &quot;\'$var\' =&gt; \'&quot; .
				 addslashes(calculer_param_dynamique($val,
								     $boucles,
								     $idb)) .
				  &quot;\'&quot;;
			}
			else {
			// Cas de la langue : passer $spip_lang
			  // et non table.lang (car depend de {lang_select})
				if ($var =='lang')
					$l[] = &quot;\'lang\' =&gt; \''.\$GLOBALS[\&quot;spip_lang\&quot;].'\'&quot;;
				else
					$l[] = &quot;\'$var\' =&gt; \'' . addslashes(&quot; . index_pile($id_boucle, $var, $boucles) . &quot;) .'\'&quot;;
				}
			}
	}
	return &quot;\n'&lt;&quot;.
		&quot;?php\n\t\$contexte_inclus = array(&quot; .
		join(&quot;, &quot;,$l) .
		&quot;);\n\t\$fichier_inclus = \'$fichier\';\n&quot; .
		(($dossier_squelettes) ?
		(&quot;
			if (@file_exists(\'$dossier_squelettes/$fichier\')){
				include(\'$dossier_squelettes/$fichier\');
			} else {
				include(\'$fichier\');
			} &quot; ) :
		(&quot;\tinclude(\'$fichier\');&quot;)) .
		&quot;\n?'.&quot; . &quot;'&gt;'&quot;;
}


//
// Traite une partie &quot;texte&quot; d'un squelette (c'est-a-dire tout element
// qui ne contient ni balise, ni boucle, ni &lt;INCLURE()&gt; ; le transforme
// en une EXPRESSION php (qui peut etre l'argument d'un Return ou la
// partie droite d'une affectation). Ici sont analyses les elements
// multilingues des squelettes : &lt;:xxx:&gt; et &lt;multi&gt;[fr]coucou&lt;/multi&gt;
//
function calculer_texte($texte, $id_boucle, &amp;$boucles, $id_mere) {
	$code = &quot;'&quot;.ereg_replace(&quot;([\\\\'])&quot;, &quot;\\\\1&quot;, $texte).&quot;'&quot;;

	// bloc multi
	if (eregi('&lt;multi&gt;', $texte)) {
		$ouvre_multi = 'extraire_multi(';
		$ferme_multi = ')';
	} else {
		$ouvre_multi = $ferme_multi = '';
	}

	// Reperer les balises de traduction &lt;:toto:&gt;
	while (eregi(&quot;&lt;:(([a-z0-9_]+):)?([a-z0-9_]+)(\|[^&gt;]*)?:&gt;&quot;, $code, $match)) {
		//
		// Traiter la balise de traduction multilingue
		//
		$chaine = strtolower($match[3]);
		if (!($module = $match[2]))
			// ordre standard des modules a explorer
			$module = 'local/public/spip';
		$c = new Champ;
		$c-&gt;code = &quot;_T('$module:$chaine')&quot;;
		$c-&gt;fonctions = explode('|', substr($match[4],1));
		$c-&gt;id_boucle = $id_boucle;
		$c-&gt;boucles = &amp;$boucles;
		$c-&gt;statut = 'php'; // ne pas manger les espaces avec trim()
		$c = applique_filtres($c);
		$code = str_replace($match[0], &quot;'$ferme_multi.$c.$ouvre_multi'&quot;, $code);
	}

	return $ouvre_multi . $code . $ferme_multi;
}


//
// calculer_boucle() produit le corps PHP d'une boucle Spip 
// (sauf les recursives)
// Ce corps est essentiellement une boucle while
// remplissant une variable $t0 retournee en valeur
//
function calculer_boucle($id_boucle, &amp;$boucles) {

	$boucle = &amp;$boucles[$id_boucle];
	$type_boucle = $boucle-&gt;type_requete;
	$return = $boucle-&gt;return;
	$id_table = $boucle-&gt;id_table;
	$primary = $boucle-&gt;primary;
	$id_field = $id_table . &quot;.&quot; . $primary;
	// La boucle doit-elle selectionner la langue ?
	// 1. par defaut, les boucles suivantes le font
	// &quot;peut-etre&quot;, c'est-a-dire si forcer_lang == false.
	if (
		$type_boucle == 'articles'
		OR $type_boucle == 'rubriques'
		OR $type_boucle == 'hierarchie'
		OR $type_boucle == 'breves'
	) $lang_select = 'maybe';
	else
		$lang_select = false;

	// 2. a moins d'une demande explicite
	if ($boucle-&gt;lang_select == 'oui') $lang_select = 'oui';
	if ($boucle-&gt;lang_select == 'non') $lang_select = false;

	// Penser a demander le champ lang
	if ($lang_select)
		$boucle-&gt;select[] = 
			// cas des tables SPIP
			($id_table ? $id_table.'.' : '')
			// cas general ({lang_select} sur une table externe)
			. 'lang';

	// Calculer les invalideurs si c'est une boucle non constante
	$constant = ereg(&quot;^\(?'[^']*'\)?$&quot;,$return);

	if ((!$primary) || $constant)
		$invalide = '';
	else {
		$boucle-&gt;select[] = $id_field;

		$invalide = &quot;\n			\$Cache['$primary']&quot;;
		if ($primary != 'id_forum')
			$invalide .= &quot;[\$Pile[\$SP]['$primary']] = 1;&quot;;
		else
			$invalide .= &quot;[calcul_index_forum(&quot; . 
				// Retournera 4 [$SP] mais force la demande du champ a MySQL
				index_pile($id_boucle, 'id_article', $boucles) . ',' .
				index_pile($id_boucle, 'id_breve', $boucles) .  ',' .
				index_pile($id_boucle, 'id_rubrique', $boucles) .',' .
				index_pile($id_boucle, 'id_syndic', $boucles) .  &quot;)] = 1;&quot;;
		$invalide .= ' // invalideurs';
	}

	// Cas {1/3} {1,4} {n-2,1}...

	$flag_cpt = $boucle-&gt;mode_partie || // pas '$compteur' a cause du cas 0
		strpos($return,'compteur_boucle');

	//
	// Creer le debut du corps de la boucle :
	//
	$debut = '';
	if ($flag_cpt)
		$debut = &quot;\n		\$compteur_boucle++;&quot;;

	if ($boucle-&gt;mode_partie)
		$debut .= '
		if ($compteur_boucle-1 &gt;= $debut_boucle
		AND $compteur_boucle-1 &lt;= $fin_boucle) {';
	
	if ($lang_select AND !$constant) {
		$selecteur = 
			(($lang_select == 'maybe') ? 
			'if (!$GLOBALS[&quot;forcer_lang&quot;]) ':'')
			. 'if ($x = $Pile[$SP][&quot;lang&quot;]) $GLOBALS[\'spip_lang\'] = $x;'
			. ' // lang_select';
		$debut .= &quot;\n			&quot;.$selecteur;
	}

	$debut .= $invalide;

	if ($boucle-&gt;doublons)
		$debut .= &quot;\n			\$doublons['&quot;.$boucle-&gt;doublons.&quot;'] .= ','. &quot; .
		index_pile($id_boucle, $primary, $boucles)
		. &quot;; // doublons&quot;;

	// gestion optimale des separateurs et des boucles constantes

	$corps = $debut . 
		((!$boucle-&gt;separateur) ? 
			(($constant &amp;&amp; !$debut) ? $return :
			 	(&quot;\n\t\t&quot; . '$t0 .= ' . $return . &quot;;&quot;)) :
		 (&quot;\n\t\t\$t1 &quot; .
			((strpos($return, '$t1.') === 0) ? 
			 (&quot;.=&quot; . substr($return,4)) :
			 ('= ' . $return)) .
		  &quot;;\n\t\t&quot; .
		  '$t0 .= (($t1 &amp;&amp; $t0) ? \'' . $boucle-&gt;separateur .
		  &quot;' : '') . \$t1;&quot;));
     
	// Fin de parties
	if ($boucle-&gt;mode_partie)
		$corps .= &quot;\n		}\n&quot;;

	$texte = '';

	// Gestion de la hierarchie (voir inc-boucles.php3)
	if ($boucle-&gt;hierarchie)
		$texte .= &quot;\n	&quot;.$boucle-&gt;hierarchie;


	// si le corps est une constante, ne pas appeler le serveur N fois!
	if (ereg(&quot;^\(?'[^']*'\)?$&quot;,$corps)) {
		// vide ?
		if (($corps == &quot;''&quot;) || ($corps == &quot;('')&quot;)) {
			if (!$boucle-&gt;numrows)
				return 'return &quot;&quot;;';
			else
				$corps = &quot;&quot;;
		} else {
			$boucle-&gt;numrows = true;
			$corps = &quot;\n		&quot;.'for($x=$Numrows[&quot;'.$id_boucle.'&quot;];$x&gt;0;$x--)
			$t0 .= ' . $corps .';';
		}
	} else {

	$corps = '

	// RESULTATS
	while ($Pile[$SP] = @spip_abstract_fetch($result,&quot;' .
		  $boucle-&gt;sql_serveur .
		  '&quot;)) {'. &quot;\n$corps\n	}\n&quot;;
		 

		// Memoriser la langue avant la boucle pour la restituer apres
		if ($lang_select) {
			$texte .= &quot;\n	\$old_lang = \$GLOBALS['spip_lang'];&quot;;
			$corps .= &quot;\n	\$GLOBALS['spip_lang'] = \$old_lang;&quot;;
		}
	}

	//
	// Requete
	//

	// hack critere recherche : ignorer la requete en cas de hash vide
	// Recherche : recuperer les hash a partir de la chaine de recherche
	if ($boucle-&gt;hash) {
		$init =  '
	// RECHERCHE
	list($rech_select, $rech_where) = prepare_recherche($GLOBALS[&quot;recherche&quot;], &quot;'.$boucle-&gt;primary.'&quot;, &quot;'.$boucle-&gt;id_table.'&quot;);
	if ($rech_select) ';
	}

	else $init = '';

	$init .= &quot;\n\n	// REQUETE
	\$result = spip_abstract_select(\n\t\tarray(\&quot;&quot;. 
		# En absence de champ c'est un decompte : 
	  	# prendre la primary pour avoir qqch
	  	# (COUNT incompatible avec le cas general
		(($boucle-&gt;select) ? 
			join(&quot;\&quot;,\n\t\t\&quot;&quot;, array_unique($boucle-&gt;select)) :
			$id_field) .
		'&quot;), # SELECT
		array(&quot;' .
		join('&quot;,&quot;', array_unique($boucle-&gt;from)) .
		'&quot;), # FROM
		array(' .
		(!$boucle-&gt;where ? '' : ( '&quot;' . join('&quot;,
		&quot;', $boucle-&gt;where) . '&quot;')) .
		&quot;), # WHERE
		'&quot;.addslashes($boucle-&gt;group).&quot;', # GROUP
		&quot; . ($boucle-&gt;order ? $boucle-&gt;order : &quot;''&quot;) .&quot;, # ORDER
		&quot; . (strpos($boucle-&gt;limit, 'intval') === false ?
			&quot;'&quot;.$boucle-&gt;limit.&quot;'&quot; :
			$boucle-&gt;limit). &quot;, # LIMIT
		'&quot;.$boucle-&gt;sous_requete.&quot;', # sous
		&quot;.$boucle-&gt;compte_requete.&quot;, # compte
		'&quot;.$id_table.&quot;', # table
		'&quot;.$boucle-&gt;id_boucle.&quot;', # boucle
		'&quot;.$boucle-&gt;sql_serveur.&quot;'); # serveur&quot;;

	$init .= &quot;\n	&quot;.'$t0 = &quot;&quot;;
	$SP++;';
	if ($flag_cpt)
		$init .= &quot;\n	\$compteur_boucle = 0;&quot;;


	if ($boucle-&gt;mode_partie)
		$init .= calculer_parties($boucle-&gt;partie,
			$boucle-&gt;mode_partie,
			$boucle-&gt;total_parties,
			$id_boucle);
	else if ($boucle-&gt;numrows)
		$init .= &quot;\n	\$Numrows['&quot; .
			$id_boucle .
			&quot;'] = @spip_abstract_count(\$result,'&quot; .
			$boucle-&gt;sql_serveur .
			&quot;');&quot;;

	//
	// Conclusion et retour
	//
	$conclusion = &quot;\n	@spip_abstract_free(\$result,'&quot; .
	  $boucle-&gt;sql_serveur . &quot;');&quot;;

	return $texte . $init . $corps . $conclusion;
}


//
// fonction traitant les criteres {1,n} (analyses dans inc-criteres)
//
## a deplacer dans inc-criteres ??
function calculer_parties($partie, $mode_partie, $total_parties, $id_boucle) {

	// Notes :
	// $debut_boucle et $fin_boucle sont les indices SQL du premier
	// et du dernier demandes dans la boucle : 0 pour le premier,
	// n-1 pour le dernier ; donc total_boucle = 1 + debut - fin

	// nombre total avant partition
	$retour = &quot;\n\n	// Partition\n	&quot; .
		'$nombre_boucle = @spip_abstract_count($result,&quot;' .
		$boucle-&gt;sql_serveur .
		'&quot;);';

	ereg(&quot;([+-/])([+-/])?&quot;, $mode_partie, $regs);
	list(,$op1,$op2) = $regs;

	// {1/3}
	if ($op1 == '/') {
		$retour .= &quot;\n	&quot;
			.'$debut_boucle = ceil(($nombre_boucle * '
			. ($partie - 1) . ')/' . $total_parties . &quot;);\n	&quot;
			. '$fin_boucle = ceil (($nombre_boucle * '
			. $partie . ')/' . $total_parties . &quot;) - 1;&quot;;
	}

	// {1,x}
	if ($op1 == '+') {
		$retour .= &quot;\n	&quot;
			. '$debut_boucle = ' . $partie . ';';
	}
	// {n-1,x}
	if ($op1 == '-') {
		$retour .= &quot;\n	&quot;
			. '$debut_boucle = $nombre_boucle - ' . $partie . ';';
	}
	// {x,1}
	if ($op2 == '+') {
		$retour .= &quot;\n	&quot;
			. '$fin_boucle = $debut_boucle + ' . $total_parties . ' - 1;';
	}
	// {x,n-1}
	if ($op2 == '-') {
		$retour .= &quot;\n	&quot;
			.'$fin_boucle = $debut_boucle + $nombre_boucle - '.$total_parties.' - 1;';
	}

	// Rabattre $fin_boucle sur le maximum
	$retour .= &quot;\n	&quot;
		.'$fin_boucle = min($fin_boucle, $nombre_boucle - 1);';

	// calcul du total boucle final
	$retour .= &quot;\n	&quot;
		.'$Numrows[\''.$id_boucle.'\'] = $fin_boucle - $debut_boucle + 1;';

	return $retour;
}

// Production du code PHP a partir de la sequence livree par le phraseur
// $boucles est passe par reference pour affectation par index_pile.
// Retourne une expression PHP,

function calculer_liste($tableau, $descr, &amp;$boucles, $id_boucle='', $niv=1) {
	if (!$tableau) return &quot;''&quot;;
        $codes = array();
	$t = '$t' . $niv;

	for ($i=0; $i&lt;=$niv; $i++) $tab .= &quot;\t&quot;;

	foreach ($tableau as $p) {

		switch($p-&gt;type) {
		// texte seul
		case 'texte':
			$code = calculer_texte($p-&gt;texte, $id_boucle, $boucles, $descr['id_mere']);
			$commentaire='';
			$avant='';
			$apres='';
			$altern = &quot;''&quot;;
			break;

		// inclure
		case 'include':
			$code= calculer_inclure($p-&gt;fichier,
						$p-&gt;params,
						$id_boucle,
						$boucles);
			$commentaire = '&lt;INCLURE('.$p-&gt;fichier.')&gt;';
			$avant='';
			$apres='';
			$altern = &quot;''&quot;;
			break;

		// boucle
		case 'boucle':
			$nom = $p-&gt;id_boucle;
			$newdescr = $descr;
			$newdescr['id_mere'] = $nom;
			$code = 'BOUCLE' .
			  ereg_replace(&quot;-&quot;,&quot;_&quot;, $nom) . $descr['nom'] .
			  '($Cache, $Pile, $doublons, $Numrows, $SP)';
			$commentaire='';
			$avant = calculer_liste($p-&gt;cond_avant,
				$newdescr, $boucles, $id_boucle, $niv+2);
			$apres = calculer_liste($p-&gt;cond_apres,
				$newdescr, $boucles, $id_boucle, $niv+2);
			$altern = calculer_liste($p-&gt;cond_altern,
				$newdescr, $boucles, $id_boucle, $niv+1);
			break;

		// balise SPIP
		default: 

			// cette structure pourrait etre completee des le phrase' (a faire)
			$p-&gt;id_boucle = $id_boucle;
			$p-&gt;boucles = &amp;$boucles;
			$p-&gt;id_mere = $descr['id_mere'];
			$p-&gt;documents = $descr['documents'];
			$p-&gt;statut = 'html';
			$p-&gt;type_requete = $boucles[$id_boucle]-&gt;type_requete;

			$code = calculer_champ($p);
			$commentaire = '#' . $p-&gt;nom_champ . $p-&gt;etoile;
			$avant = calculer_liste($p-&gt;cond_avant,
				$descr, $boucles, $id_boucle, $niv+1);
			$apres = calculer_liste($p-&gt;cond_apres,
				$descr, $boucles, $id_boucle, $niv+1);
			$altern = &quot;''&quot;;
			break;

		} // switch

		if ($avant == &quot;''&quot;) $avant = '';
		if ($apres == &quot;''&quot;) $apres = '';
		if ($avant||$apres||($altern!=&quot;''&quot;))
		  {
		    $res = (!$avant ? &quot;&quot; : &quot;$avant . &quot;) . 
		      $t .
		      (!$apres ? &quot;&quot; : &quot; . $apres&quot;);

		    if (($res != $t) || ($altern != &quot;''&quot;))
		      $code = &quot;(($t = $code) ?\n\t$tab($res) :\n\t$tab($altern))&quot;;
		  }
		// if ($code) # c'est toujours etre ainsi
		  $codes[]= (!$commentaire ? $code : 
			     (&quot;/&quot;.&quot;* $commentaire *&quot;.&quot;/ &quot; . $code));
	} // foreach

	return &quot;(&quot; . join (&quot;\n$tab. &quot;, $codes) . &quot;)&quot;;
}

// Prend en argument le source d'un squelette, sa grammaire et un nom.
// Retourne une fonction PHP/SQL portant ce nom et calculant une page HTML.
// Pour appeler la fonction produite, lui fournir 2 tableaux de 1 e'le'ment:
// - 1er: element 'cache' =&gt; nom (du fichier ou` mettre la page)
// - 2e: element 0 contenant un environnement ('id_article =&gt; $id_article, etc)
// Elle retourne alors un tableau de 4 e'le'ments:
// - 'texte' =&gt; page HTML, application du squelette a` l'environnement;
// - 'squelette' =&gt; le nom du squelette
// - 'process_ins' =&gt; 'html' ou 'php' selon la pre'sence de PHP dynamique
// - 'invalideurs' =&gt;  de'pendances de cette page, pour invalider son cache.
// (voir son utilisation, optionnelle, dans invalideur.php)
// En cas d'erreur, elle retourne un tableau des 2 premiers elements seulement

function calculer_squelette($squelette, $nom, $gram, $sourcefile) {
# 3 variables qui sont en fait des constantes apr&#232;s chargement
  global $table_primary, $table_des_tables, $tables_des_serveurs_sql;
	// Phraser le squelette, selon sa grammaire
	// pour le moment: &quot;html&quot; seul connu (HTML+balises BOUCLE)
	$boucles = '';
	spip_timer('calcul_skel');

	include_local(&quot;inc-$gram-squel.php3&quot;);

	$racine = parser($squelette, '',$boucles, $nom);

	// tableau des informations sur le squelette
	$descr = array('nom' =&gt; $nom, 'documents' =&gt; false);

	if ($boucles) {
	  // une boucle documents est conditionnee par tout le reste!
	  // une boucle avec critere de recheche conditionne tout le reste!
	  // (a cause du cas #nom_de_boucle:URL_*)
	  // 
		foreach($boucles as $idb =&gt; $boucle)
		  {
		    if ($boucle-&gt;param &amp;&amp; is_array($boucle-&gt;param)) {
				if (($boucle-&gt;type_requete == 'documents') &amp;&amp; 
				    in_array('doublons',$boucle-&gt;param))
				  { $descr['documents'] = true; break; }
				if (in_array('recherche',$boucle-&gt;param))
					$boucles[$idb]-&gt;hash = true;
			}
		  }
	// Commencer par reperer les boucles appelees explicitement 
	// car elles indexent les arguments de maniere derogatoire
		foreach($boucles as $id =&gt; $boucle) { 
			if ($boucle-&gt;type_requete == 'boucle') {
				$rec = &amp;$boucles[$boucle-&gt;param];
				if (!$rec) {
					return array(_T('info_erreur_squelette'),
						($boucle-&gt;param
						. _L(' boucle recursive non definie')));
				} else {
					$rec-&gt;externe = $id;
					$descr['id_mere'] = $id;
					$boucles[$id]-&gt;return =
						calculer_liste(array($rec),
							 $descr,
							 $boucles,
							 $boucle-&gt;param);
				}
			}
		}
		foreach($boucles as $id =&gt; $boucle) { 
			$type = $boucle-&gt;type_requete;
			if ($type != 'boucle') {
				$boucles[$id]-&gt;id_table = $table_des_tables[$type];
				if ($boucles[$id]-&gt;id_table) {
					$boucles[$id]-&gt;primary = $table_primary[$type];
				} else { 
					// table non Spip.
					$boucles[$id]-&gt;id_table = $type;
					$serveur = $boucle-&gt;sql_serveur;
					$boucles[$id]-&gt;primary = $tables_des_serveurs_sql[$serveur ? $serveur : 'localhost'][$type]['key'][&quot;PRIMARY KEY&quot;]; 
				}
				if ($boucle-&gt;param) {
					$res = calculer_criteres($id, $boucles);
					if (is_array($res))
						return $res; # erreur
				}
				$descr['id_mere'] = $id;
				$boucles[$id]-&gt;return =
				calculer_liste($boucle-&gt;milieu,
					 $descr,
					 $boucles,
					 $id);
			}
		}
	}

	// idem pour la racine
	$descr['id_mere'] = '';
	$corps = calculer_liste($racine, $descr, $boucles);

	// Corps de toutes les fonctions PHP,
	// en particulier les requetes SQL et TOTAL_BOUCLE
	// de'terminables seulement maintenant
	// Les 3 premiers parame`tres sont passe's par re'fe'rence
	// (sorte d'environnements a` la Lisp 1.5)
	// sauf pour la fonction principale qui recoit les initialisations

	$code = '';
	if ($boucles) {

		foreach($boucles as $id =&gt; $boucle) {
			// appeler la fonction de definition de la boucle
			$f = 'boucle_'.strtoupper($boucle-&gt;type_requete);
			// si pas de definition perso, definition spip
			if (!function_exists($f)) $f = $f.'_dist';
			// laquelle a une definition par defaut
			if (!function_exists($f)) $f = 'boucle_DEFAUT';
			$boucles[$id]-&gt;return = $f($id, $boucles);
		}

		foreach($boucles as $id =&gt; $boucle) {

			// Reproduire la boucle en commentaire
			$pretty = &quot;BOUCLE$id(&quot;.strtoupper($boucle-&gt;type_requete).&quot;)&quot;;
		    if ($boucle-&gt;param &amp;&amp; is_array($boucle-&gt;param)) 
				$pretty .= &quot; {&quot;.join(&quot;} {&quot;, $boucle-&gt;param).&quot;}&quot;;
			// sans oublier les parametres traites en amont
			if ($boucle-&gt;separateur)
			  $pretty .= '{&quot;' . $boucle-&gt;separateur . '&quot;}';
			if ($boucle-&gt;tout)
			  $pretty .= '{tout}';
			if ($boucle-&gt;plat)
			  $pretty .= '{plat}';
			$pretty = ereg_replace(&quot;[\r\n]&quot;, &quot; &quot;, $pretty);

			// Puis envoyer son code
			$codeboucle = &quot;\n//\n// &lt;$pretty&gt;\n//\n&quot;
			.&quot;function BOUCLE&quot; . ereg_replace(&quot;-&quot;,&quot;_&quot;,$id) . $nom .
			'(&amp;$Cache, &amp;$Pile, &amp;$doublons, &amp;$Numrows, $SP) {' .
			$boucle-&gt;return;

			$fincode = &quot;\n	return \$t0;&quot;
			.&quot;\n}\n\n&quot;;

			## inserer les elements pour le debuggueur, a deux niveaux :
			## 1) apres le calcul d'une boucle compilee, envoyer le code
			##    compile vers boucle_debug_compile()
			## 2) le resultat de la boucle, lui, sera plus tard envoye vers
			##    boucle_debug_resultat()
			if ($GLOBALS['var_mode'] == 'debug') {
				boucle_debug_compile ($id, $nom, $pretty,
					$sourcefile, $codeboucle.$fincode);
				$codedebug = &quot;
	boucle_debug_resultat('$id', '$nom', \$t0);&quot;;
			}

			$code .= $codeboucle.$codedebug.$fincode;
		}
	}

	$secondes = spip_timer('calcul_skel');
	spip_log(&quot;calcul skel $sourcefile ($secondes)&quot;);

	if (is_array($boucles))
		$aff_boucles = join (', ', array_keys($boucles));
	else
		$aff_boucles = &quot;pas de boucle&quot;;

	$squelette_compile = &quot;&lt;&quot;.&quot;?php
/*
 * Squelette : $sourcefile
 * Date :      &quot;.http_gmoddate(@filemtime($sourcefile)).&quot; GMT
 * Compile :   &quot;.http_gmoddate(time()).&quot; GMT ($secondes)
 * Boucles :   &quot;.$aff_boucles.&quot;
 */
$code

//
// Fonction principale du squelette $sourcefile
//
function $nom (\$Cache, \$Pile, \$doublons=array(), \$Numrows='', \$SP=0) {
\$t0 = $corps;

	return array(
		'texte' =&gt; \$t0,
		'squelette' =&gt; '$nom',
		'process_ins' =&gt; ((strpos(\$t0,'&lt;'.'?')=== false) ? 'html' : 'php'),
		'invalideurs' =&gt; \$Cache
	);
}

?&quot;.&quot;&gt;&quot;;

	if ($GLOBALS['var_mode'] == 'debug')
		squelette_debug_compile($nom, $sourcefile, $squelette_compile);

	return $squelette_compile;

}

?&gt;

--- NEW FILE: inc-urls-html.php3 ---
&lt;?php

// executer une seule fois
if (defined(&quot;_INC_URLS2&quot;)) return;
define(&quot;_INC_URLS2&quot;, &quot;1&quot;);

function generer_url_article($id_article) {
	return &quot;article$id_article.html&quot;;
}

function generer_url_rubrique($id_rubrique) {
	return &quot;rubrique$id_rubrique.html&quot;;
}

function generer_url_breve($id_breve) {
	return &quot;breve$id_breve.html&quot;;
}

function generer_url_mot($id_mot) {
	return &quot;mot$id_mot.html&quot;;
}

function generer_url_auteur($id_auteur) {
	return &quot;auteur$id_auteur.html&quot;;
}

function generer_url_document($id_document) {
	if (intval($id_document) &lt;= 0)
		return '';
	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;
	return;
}


//
// URLs des forums
//

// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
function racine_forum($id_forum){
	if (!$id_forum = intval($id_forum)) return;
	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
	$result = spip_query($query);
	if($row = spip_fetch_array($result)){
		if($row['id_parent']) {
			return racine_forum($row['id_parent']);
		}
		else {
			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
		}
	}
} 

function generer_url_forum($id_forum, $show_thread=false) {
	list($type, $id, $id_thread) = racine_forum($id_forum);
	if ($id_thread&gt;0 AND $show_thread)
		$id_forum = $id_thread;
	switch($type) {
		case 'article':
			return generer_url_article($id).&quot;#forum$id_forum&quot;;
			break;
		case 'breve':
			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
			break;
		case 'rubrique':
			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
			break;
		default:
			return &quot;forum$id_forum.html&quot;;
	}
}

?&gt;

--- NEW FILE: inc-html-squel.php3 ---
&lt;?php

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_HTML_SQUEL&quot;)) return;
define(&quot;_INC_HTML_SQUEL&quot;, &quot;1&quot;);

# Ce fichier doit IMPERATIVEMENT contenir la fonction &quot;parser&quot;
# qui transforme un squelette en un tableau d'objets de classe Boucle
# il est charge par un include calcule dans inc-calcul-squel
# pour permettre differentes syntaxes en entree

define('NOM_DE_BOUCLE', &quot;[0-9]+|[-_][-_.a-zA-Z0-9]*&quot;);
define('NOM_DE_CHAMP', &quot;#((&quot; . NOM_DE_BOUCLE . &quot;):)?([A-Z_]+)(\*?)&quot;);
define('CHAMP_ETENDU', '\[([^]\[]*)\(' . NOM_DE_CHAMP . '([^]\[)]*)\)([^]\[]*)\]');
define('PARAM_DE_BOUCLE','[[:space:]]*\{[[:space:]]*([^{}]*(\{[^\}]*\}[^\}]*)*)[[:space:]]*\}');
define('TYPE_DE_BOUCLE', &quot;[^)]*&quot;);
define('BALISE_DE_BOUCLE',
	&quot;^&lt;BOUCLE(&quot; .
	NOM_DE_BOUCLE .
	')[[:space:]]*\((' .
	TYPE_DE_BOUCLE .
	')\)((' .
	PARAM_DE_BOUCLE .
	')*)[[:space:]]*&gt;');
define('PARAM_INCLURE','[[:space:]]*\{[[:space:]]*([_0-9a-zA-Z]+)[[:space:]]*(=[[:space:]]*([^\{\}]*(\{[^\}]*\}[^\} ]*)?))?[[:space:]]*\}');
define('BALISE_INCLURE',&quot;&lt;INCLU[DR]E[[:space:]]*\(&quot; .
       '([-_0-9a-zA-Z./ ]+)' .
	'\)((' .
	PARAM_INCLURE .
	')*)[[:space:]]*&gt;');
define('DEBUT_DE_BOUCLE','/&lt;B('.NOM_DE_BOUCLE.')&gt;.*?&lt;BOUCLE\1[^-_.a-zA-Z0-9]|&lt;BOUCLE('.NOM_DE_BOUCLE.')/ms');	# preg


function parser_inclure($texte, $result) {
	while (($p=strpos($texte, '&lt;INCLU')) !== false) {
		$fin = substr($texte, $p);

		if (!ereg('^' . BALISE_INCLURE, $fin, $match)) break;
		$s = $match[0];
		$debut = substr($texte, 0, $p);
		$texte = substr($fin, strlen($s));

		if ($debut) $result = parser_champs($debut, $result);

		$champ = new Inclure;
		$champ-&gt;fichier = $match[1];
		$champ-&gt;params = array();
		$p = trim($match[2]);
		if ($p) {
			while (ereg('^' . PARAM_INCLURE . '(.*)$', $p, $m)) {
				$champ-&gt;params[$m[1]] = $m[3];
				$p = $m[5];
			}
			
			if ($p)	erreur_squelette(_L(&quot;Param&egrave;tres d'inclusion incorrects&quot;), $s);
		}
		$result[] = $champ;
	}

	return (!$texte ? $result : parser_champs($texte, $result));
}

function parser_champs($texte,$result) {
	while (ereg(NOM_DE_CHAMP . '(.*)$', $texte, $regs)) {
	  $p = strpos($texte, $regs[0]);

	  if ($regs[4] || !ereg(&quot;[0-9a-z]&quot;, $regs[5][0])) {
		if ($p) {
			$champ = new Texte;
			$champ-&gt;texte = (substr($texte, 0, $p));
			$result[] = $champ;
		}
		  
		$champ = new Champ;
		$champ-&gt;nom_boucle = $regs[2];
		$champ-&gt;nom_champ = $regs[3];
		$champ-&gt;etoile = $regs[4];
		$texte = $regs[5];
		$result[] = $champ;
	  } else {
	    // faux champ
	    $champ = new Texte;
	    $champ-&gt;texte = (substr($texte, 0, $p+1));
	    $result[] = $champ;
	    $texte = (substr($texte, $p+1));
	  }
	}
	if ($texte) {
	  
		$champ = new Texte;
		$champ-&gt;texte = $texte;
		$result[] = $champ;
	}
	return $result;
}

// Gestion des imbrications:
// on cherches les [..] les plus internes et on les remplace par une  chaine
// %###N@ o&#249; N indexe un tableau comportant le r&#233;sultat de leur phras&#233;
// on recommence tant qu'il y a des [...] en substituant &#224; l'appel suivant

function parser_champs_etendus($texte, $result) {
	if (!$texte) return $result;
	$sep = '##';
	while (strpos($texte,$sep)!== false)
		$sep .= '#';
	return array_merge($result, parser_champs_interieurs($texte, $sep, array()));
}


function parser_champs_exterieurs($debut, $sep, $nested) {
	$res = array();
	while (($p=strpos($debut, &quot;%$sep&quot;))!==false) {
	    if ($p) $res = parser_inclure(substr($debut,0,$p), $res);
	    ereg(&quot;^%$sep([0-9]+)@(.*)$&quot;, substr($debut,$p),$m);
	    $res[]= $nested[$m[1]];
	    $debut = $m[2];
	}
	return (!$debut ?  $res : parser_inclure($debut, $res));

}

function parser_champs_interieurs($texte, $sep, $result) {
	$i = 1;
	while (true) {	  $j=$i;
	  while (ereg(CHAMP_ETENDU . '(.*)$', $texte, $regs)) {
		$champ = new Champ;
		$champ-&gt;nom_boucle = $regs[3];
		$champ-&gt;nom_champ = $regs[4];
		$champ-&gt;etoile = $regs[5];
		$champ-&gt;cond_avant = parser_champs_exterieurs($regs[1],$sep,$result);
		$champ-&gt;cond_apres = parser_champs_exterieurs($regs[7],$sep,$result);
		$fonctions = $regs[6];
		if ($fonctions) {
			$fonctions = explode('|', ereg_replace(&quot;^\|&quot;, &quot;&quot;, $fonctions));
			foreach($fonctions as $f) $champ-&gt;fonctions[]= $f;
		}

		$p = strpos($texte, $regs[0]);
		if ($p) {$result[$i] = substr($texte,0,$p);$i++; }
		$result[$i] = $champ;
		$i++;
		$texte = $regs[8];
	  }
	  if ($texte) {$result[$i] = $texte; $i++;}
	  $x ='';

	  while($j &lt; $i) 
	    { $z= $result[$j]; 
	      if (is_object($z)) $x .= &quot;%$sep$j@&quot; ; else $x.=$z ;
	      $j++;}
	  if (ereg(CHAMP_ETENDU, $x)) $texte = $x;
	  else return parser_champs_exterieurs($x, $sep, $result);}
}


function parser_param($params, &amp;$result) {
	$params2 = array();
	$type = $result-&gt;type_requete;
	while (ereg('^' . PARAM_DE_BOUCLE . '[[:space:]]*(.*)$', trim($params), $m)) {
		$params = $m[3];
		$m[1] = trim($m[1]);
		// cas d'un critere avec {...}
		if ($m[2])
			$params2[] = $m[1];
		else {
			if (strlen($m[1]) &lt; 2)
				$params2[] = $m[1];
	    else {
	      ereg('^(.)([^&quot;}]*)(.)$', $m[1], $args);
	      // cas syntaxique general, 
	      // traiter qq lexemes particuliers pour faciliter la suite
	      if ($args[3] != '&quot;') {
			$param = $m[1];
			if (($param == 'tout') OR ($param == 'tous')) {
				$result-&gt;tout = true;
				unset ($param);
			}
			else if ($param == 'plat') {
				$result-&gt;plat = true;
				unset ($param);
			}

			// Boucle hierarchie, analyser le critere id_article - id_rubrique
			// - id_syndic, afin, dans les cas autres que {id_rubrique}, de
			// forcer {tout} pour avoir la rubrique mere...
			else if ($type == 'hierarchie') {
				if ($param == 'id_article' OR $param == 'id_syndic') {
					$result-&gt;tout = true;
					unset ($param);
				} else if ($param == 'id_rubrique')
					unset ($param);
			}

			// synonyme
			if ($param == 'unique') $param = 'doublons';

			// l'ajouter
			if ($param)
				$params2[] = $param;
	      }
		else {
		  // cas d'un guillemet final
			if ($args[1] == '&quot;') {
			  // si tout le param est entre guillement, vite vu
				$result-&gt;separateur = 
					ereg_replace(&quot;'&quot;,&quot;\'&quot;,$args[2]);
			}
			else {
				$params2[] = $args[1] . $args[2] . '&quot;' . $m[1];
			}
		}
	    }
	  }
	}
	$result-&gt;param = $params2;
}

function parser($texte, $id_parent, &amp;$boucles, $nom) {

	$all_res = array();

	while (preg_match(DEBUT_DE_BOUCLE, $texte, $regs)) {
		$nom_boucle = $regs[1].$regs[2];
		$p = strpos($texte, '&lt;BOUCLE'.$nom_boucle);

		// envoyer la boucle au debugueur
		if ($GLOBALS['var_mode']== 'debug') {
			$preg = &quot;@&lt;B($nom_boucle|OUCLE${nom_boucle}[^-_.a-zA-Z0-9][^&gt;]*)&gt;&quot;
				. &quot;.*&lt;/(BOUCLE|/?B)$nom_boucle&gt;@ms&quot;;
			preg_match($preg, $texte, $match);
			boucle_debug ($nom_boucle, $nom, $match[0]);
		}

		//
		// Recuperer la partie principale de la boucle
		//
		$debut = substr($texte, 0, $p);
		$milieu = substr($texte, $p);

		if (!ereg(BALISE_DE_BOUCLE, $milieu, $match)) {
			erreur_squelette((_T('erreur_boucle_syntaxe')), $milieu);
		}
		$id_boucle = $match[1];

		$result = new Boucle;
		$result-&gt;id_parent = $id_parent;
		$result-&gt;id_boucle = $id_boucle;

		$type = $match[2];
		if ($p =strpos($type, ':'))
		  {
		    $result-&gt;sql_serveur = substr($type,0,$p);
		    $type = substr($type,$p+1);
		  }
		$type = strtolower($type);
		if ($type == 'sites') $type = 'syndication'; # alias

		//
		// Recuperer les criteres de la boucle (sauf boucle recursive)
		//
		if (substr($type, 0, 6) == 'boucle') {
			$result-&gt;type_requete = 'boucle';
			$result-&gt;param = substr($match[2], 6);
		} else {
			$result-&gt;type_requete = $type;
			parser_param($match[3], $result);
		}

		//
		// Recuperer la partie conditionnelle avant
		//
		$s = &quot;&lt;B$id_boucle&gt;&quot;;
		$p = strpos($debut, $s);
		if ($p !== false) {
			$result-&gt;cond_avant = substr($debut, $p + strlen($s));
			$debut = substr($debut, 0, $p);
		}
		$milieu = substr($milieu, strlen($match[0]));
		if (strpos($milieu, $s)) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
				$id_boucle . 
				_L('&nbsp;: balise B en aval'));
		}

		//
		// Recuperer la fin :
		//
		$s = &quot;&lt;/BOUCLE$id_boucle&gt;&quot;;
		$p = strpos($milieu, $s);
		if ($p === false) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
					 _T('erreur_boucle_fermant',
						array('id'=&gt;$id_boucle)));
		}
		$texte = substr($milieu, $p + strlen($s));
		$milieu = substr($milieu, 0, $p);

		//
		// 1. Recuperer la partie conditionnelle apres
		//
		$s = &quot;&lt;/B$id_boucle&gt;&quot;;
		$p = strpos($texte, $s);
		if ($p !== false) {
			$result-&gt;cond_fin = substr($texte, 0, $p);
			$texte = substr($texte, $p + strlen($s));
		}

		//
		// 2. Recuperer la partie alternative
		//
		$s = &quot;&lt;//B$id_boucle&gt;&quot;;
		$p = strpos($texte, $s);
		if ($p !== false) {
			$result-&gt;cond_altern = substr($texte, 0, $p);
			$texte = substr($texte, $p + strlen($s));
		}

		$result-&gt;cond_avant = parser($result-&gt;cond_avant, $id_parent,$boucles, $nom);
		$result-&gt;cond_apres = parser($result-&gt;cond_fin, $id_parent,$boucles, $nom);
		$result-&gt;cond_altern = parser($result-&gt;cond_altern,$id_parent,$boucles, $nom);
		$result-&gt;milieu = parser($milieu, $id_boucle,$boucles, $nom);

		$all_res = parser_champs_etendus($debut, $all_res);
		$all_res[] = $result;
		if ($boucles[$id_boucle]) {
			erreur_squelette(_T('erreur_boucle_syntaxe'),
					 _T('erreur_boucle_double',
					 	array('id'=&gt;$id_boucle)));
		} else
			$boucles[$id_boucle] = $result;
	}

	return parser_champs_etendus($texte, $all_res);
}

?&gt;

--- NEW FILE: carto.php3 ---
&lt;?php

$fond = &quot;carto&quot;;
$delais = 24*3600;

include (&quot;inc-public.php3&quot;);

?&gt;

--- NEW FILE: index.php ---
&lt;?php
	// pour hebergeurs ayant oublie de configurer DirectoryIndex index.php3
	include (&quot;index.php3&quot;);
?&gt;

--- NEW FILE: article.php3 ---
&lt;?php

$fond = &quot;article&quot;;
$delais = 24 * 3600;

include (&quot;inc-public.php3&quot;);

?&gt;

--- NEW FILE: habillage.css ---


/*
 * Mise en page des textes (bordures...)
 */

.chapo {
	line-height: 1.4em;
	margin-top: 1em;
}
.texte {
}
.ps {
	padding-top: 0.6em;
	margin-top: 0.6em;
	border-top: 1px dashed #404040;
}
.notes {
	margin-top: 0.6em;
	margin-bottom: 0.6em;
	border-top: 1px solid #a0a0a0;
	padding: 1.5em;
}

/*
 * Habillage des menus et de la navigation
 */

.menu {
	border: 1px solid #a0a0a0;
	border-top: 0px;
	padding: 0px;
	margin: 0px;
	margin-bottom: 16px;
}
.menu ul {
	display: block;
	margin: 0px;
	padding: 0px;
	padding-bottom: 4px;
	list-style: none;
}
.menu ol {
	display: block;
	margin: 0px;
	padding: 0px;
	padding-bottom: 4px;
	list-style: none;
}
.menu-titre {
	border-top: 1px solid #a0a0a0;
	border-bottom: 1px dashed #d0d0d0;
	margin: 0px;
	padding-left: 4px;
	padding-right: 4px;
	padding-top: 3px;
	padding-bottom: 2px;
	font-size: 90%;
}
.menu-item {
	margin: 0px;
	padding-left: 4px;
	padding-right: 4px;
	padding-top: 1px;
	padding-bottom: 1px;
	font-size: 80%;
}

/* Des couleurs specifiques selon les types de menus */

.general		{ background-color: #f8f8e8; text-align:center; }
.general .menu-titre 	{ background-color: #fcfcf0; }

.rubriques 		{ background-color: #eaffea; text-align:center; }
.rubriques .menu-titre	{ background-color: #f2fff2; }

.breves 		{ background-color: #ffeaea; }
.breves .menu-titre	{ background-color: #fff2f2; text-align:center; }

.divers 		{ background-color: #eaeaff; }
.divers .menu-titre	{ background-color: #f2f2ff; text-align:center; }

.forums 		{ background-color: #e8f8f8; }
.forums .menu-titre	{ background-color: #f0fcfc; text-align:center; }


/*
 * Styles pour le contenu (c-a-d. la colonne principale)
 */

.contenu {
	margin: 15px;
}
.contenu h2.titre-extrait {
}
.contenu h2.titre-texte {
}
.contenu .surtitre {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu .detail {
	margin-left: 2em;
}
.contenu .detail .important {
	color: #a02020;
}
.extrait {
	margin: 0.1em;
	margin-top: 0.5em;
	margin-bottom: 0.5em;
	margin-left: 2em;
	margin-right: 0.1em;
	line-height: 1.4em;
}
.liste-articles {
	margin-top: 1em;
	margin-bottom: 1em;
	clear: left;
}
.contenu .forum-repondre {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	text-align: left;
	font-size: 90%;
	font-weight: bold;
	margin-top: 0.6em;
}


/*
 * Disposition a l'ecran : colonnes, encarts, cartouches
 */

#principal {
	position: absolute;
	left: 30%;
	/*left: 18em;*/
	top: 0px;
	margin: 0px;
	padding: 0px;
	/*margin-right: 2em;*/
	margin-right: 3%;
	margin-top: 1.5em;
}

#plan {
	position: absolute;
	left: 2em;
	top: 0px;
	margin: 0px;
	padding: 0px;
	margin-right: 2em;
	margin-top: 2em;
}

#navigation {
	position: absolute;
	left: 0px;
	top: 0px;
	width: 24%;
	/*width: 14em;*/
	padding: 0px;
	margin: 0px;
	/*margin-left: 1.8em;*/
	margin-left: 3%;
	margin-top: 1.5em;
}

.encart {
	float: right;
	/*width: 14em;*/
	width: 34%;
	margin-left: 4%;
	/*margin-left: 2em;*/
	margin-top: 1em;
	margin-bottom: 0em;
	margin-right: 0px;
}

.cartouche {
	padding-top: 1em;
	border-top: 2px solid #404040;
	margin-bottom: 0em;
}

.cartouche .spip_logos {
	margin-left: 0px;
	padding-left: 0px;
	margin-right: 0.8em;
}


/*
 * Habillage du plan du site
 */

.plan-secteur {
	margin-top: 0em;
	margin-bottom: 3em;
	clear: right;
}

.plan-secteur h1 {
	display: block;
	border: 1px solid #a0a0a0;
	margin: 0px;
	padding: 8px;
	font-size: 150%;
	font-weight: bold;
	background-color: #e0ffe0;
	text-align:center;
}
.plan-rubriques {
	clear: left;
	display: block;
	list-style: none;
}
.plan-rubrique {
	display: inline;
	border: 1px solid #a0a0a0;
	padding: 3px;
	font-weight: bold;
}
.plan-articles {
	clear: left;
	margin-top: 0.5em;
	margin-bottom: 1em;
	list-style: square;
}

/* Eclaircissement progressif des rubriques en fonction de la profondeur */

ul .plan-rubrique {
	background-color: #e0ffe0;
	border-color: #b8b8b8;
}
ul ul .plan-rubrique {
	background-color: #eaffea;
	border-color: #d0d0d0;
}
ul ul ul .plan-rubrique {
	background-color: #f4fff4;
	border-color: #e8e8e8;
}


/*
 * Habillage des forums
 */

ul.forum-total {
	display: block;
	padding: 0px;
	margin: 0px;
	list-style: none;
}
.forum-fil {
	margin-top: 3em;
}
.forum-fil ul {
	display: block;
	margin: 0px;
	margin-left: 2em;
	padding: 0px;
	list-style: none;
}
.forum-titre {
	font-weight: bold;
	font-size: 120%;
}
.forum-item {
	margin: 0px;
	padding: 1em;
	padding-top: 0.5em;
	padding-bottom: 0em;
	text-align: justify;
	color: #303030;
	font-size: 80%;
}
.forum-repondre-message {
	text-align: right;
}

/* Boite d'un forum : eclaircissement progressif des bords */

ul .forum {
	border: 1px solid #909090;
	padding: 0px;
	margin: 0px;
	margin-bottom: 1em;
}
ul ul .forum {
	border: 1px solid #a4a4a4;
}
ul ul ul .forum {
	border: 1px solid #b8b8b8;
}
ul ul ul ul .forum {
	border: 1px solid #cccccc;
}
ul ul ul ul ul .forum {
	border: 1px solid #e0e0e0;
}
ul ul ul ul ul ul .forum {
	border: 1px dashed #e0e0e0;
}

/* Boite de titre d'un forum : mise en couleur selon la profondeur du forum */

ul .forum-chapo {
	border: 0px;
	border-bottom: 1px dashed #b8b8b8;
	margin: 0px;
	padding-left: 6px;
	padding-right: 6px;
	padding-top: 3px;
	padding-bottom: 2px;
	font-size: 90%;
	background: #c4e0e0;
}
ul ul .forum-chapo {
	background: #d4e8e8;
}
ul ul ul .forum-chapo {
	background: #e4f0f0;
}
ul ul ul ul .forum-chapo {
	background: #f4f8f8;
}
ul ul ul ul ul .forum-chapo {
	background: #ffffff;
}


/*
 * Habillage des petitions
 */

.signatures {
	margin-left: 0px;
	margin-right: 0px;
	margin-top: 1em;
	margin-bottom: 1em;
	width: 100%;
}
.signatures td {
	-moz-border-radius: 0.4em;
}
.signatures-titre {
	clear: right;
	font-weight: bold;
	font-size: 120%;
	text-align: center;
	padding: 0.5em;
	margin: 0px;
}
.signature-date {
	white-space: nowrap;
	background: #e4f0f0;
	padding: 0.5em;
}
.signature-nom {
	font-weight: bold;
	background: #ecf4f4;
	padding: 0.2em;
	text-align: center;
}
.signature-message {
	font-size: 85%;
	background: #f4f8f8;
	padding: 0.4em;
	text-align: justify;
}


/*
 * Formulaires
 */

.formrecherche {
	background-color: #f2f2f2;
	color: #505030;
	margin: 0px;
	padding: 2px;
	border: solid 1px #909090;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 80%;
	font-weight: normal;
}

.formulaire {
	color: black;
	margin: 0px;
	margin-bottom: 16px;
	padding: 4px;
	border: 1px solid #a0a0a0;
	background-color: #f6f6f6;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 80%;
	font-weight: normal;
}
.forml {
	background-color: #ececec;
	margin: 4px;
	padding: 1px;
	border: dashed 1px #909090;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 90%;
}
.spip_bouton {
	border: 2px solid #404040;
	padding: 3px;
	background: #d0d0d0;
	font-family: &quot;Trebuchet MS&quot;, Tahoma, Arial, Helvetica, sans-serif;
}

.spip-admin {
}



--- NEW FILE: ical-dist.html ---
BEGIN:VCALENDAR
CALSCALE:GREGORIAN
X-WR-CALNAME;VALUE=TEXT:[(#NOM_SITE_SPIP|filtrer_ical)]
X-WR-RELCALID:[(#URL_SITE_SPIP|filtrer_ical)]
&lt;BOUCLE_articles(ARTICLES){par date}{inverse}{0,100}&gt;
BEGIN:VEVENT
SUMMARY:[(#TITRE|filtrer_ical)] [[(#NOM_SITE_SPIP|filtrer_ical)]]
UID:article#ID_ARTICLE @ [(#URL_SITE_SPIP|filtrer_ical)]
DTSTAMP:[(#DATE|date_ical)]
DTSTART:[(#DATE|date_ical)]
DTEND:[(#DATE|date_ical{60})]
CATEGORIES:&lt;:articles|filtrer_ical:&gt;
URL:#URL_SITE_SPIP/#URL_ARTICLE
STATUS:CONFIRMED
END:VEVENT
&lt;/BOUCLE_articles&gt;
&lt;BOUCLE_breves(BREVES){par date}{inverse}{0,100}&gt;
BEGIN:VEVENT
SUMMARY:[(#TITRE|filtrer_ical)] [[(#NOM_SITE_SPIP|filtrer_ical)]]
UID:breve#ID_BREVE @ [(#URL_SITE_SPIP|filtrer_ical)]
DTSTAMP:[(#DATE|date_ical)]
DTSTART:[(#DATE|date_ical)]
DTEND:[(#DATE|date_ical{60})]
CATEGORIES:&lt;:breves|filtrer_ical:&gt;
URL:#URL_SITE_SPIP/#URL_BREVE
STATUS:CONFIRMED
END:VEVENT
&lt;/BOUCLE_breves&gt;
END:VCALENDAR

--- NEW FILE: inc-compilo-api.php3 ---
&lt;?php

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_COMPILO_API&quot;)) return;
define(&quot;_INC_COMPILO_API&quot;, &quot;1&quot;);


// Definition des classes Boucle, Texte, Inclure, Champ

class Texte {
	var $type = 'texte';
	var $texte;
}

class Inclure {
	var $type = 'include';
	var $fichier;
	var $params;
}

//
// encodage d'une boucle SPIP en un objet PHP
//
class Boucle {
	var $type = 'boucle';
	var $id_boucle;
	var $id_parent ='';
	var $cond_avant, $milieu, $cond_apres, $cond_altern;
	var $lang_select;
	var $type_requete;
	var $sql_serveur;
	var $param = array();
	var $separateur;
	var $doublons;
	var $partie, $total_parties,$mode_partie;
	var $externe = ''; # appel a partir d'une autre boucle (recursion)
	// champs pour la construction de la requete SQL
	var $tout = false;
	var $plat = false;
	var $select;
	var $from;
	var $where;
	var $limit;
	var $group = '';
	var $order = '';
	var $date = 'date' ;
	var $hash = false ;
	var $lien = false;
	var $sous_requete = false;
	var $compte_requete = 1;
	var $hierarchie = '';
	// champs pour la construction du corps PHP
	var $id_table;
	var $primary;
	var $return;
	var $numrows = false; 
}

class Champ {
	var $type = 'champ';
	var $nom_champ;
	var $nom_boucle= ''; // seulement si boucle explicite
	var $cond_avant, $cond_apres; // tableaux d'objets
	var $fonctions;  // filtre explicites
	var $etoile;
	// champs pour la production de code
	var $id_boucle;
	var $boucles;
	var $type_requete;
	var $code;	// code du calcul
	var $statut;	// 'numerique, 'h'=texte (html) ou 'p'=script (php) ?
			// -&gt; definira les pre et post-traitements obligatoires
	// champs pour la production de code dependant du contexte
	var $id_mere;    // pour TOTAL_BOUCLE hors du corps
	var $document;   // pour embed et img dans les textes
}


//
// Globales de description de la base

global $tables_des_serveurs_sql, $tables_principales; // (voir inc_serialbase)
global $exceptions_des_tables, $table_des_tables;
global $tables_relations,  $table_primary, $table_date;

$tables_des_serveurs_sql = array('localhost' =&gt; &amp;$tables_principales);
	

	// champ principal des tables SQL
	$table_primary = array(
		'articles' =&gt; &quot;id_article&quot;,
		'auteurs' =&gt; &quot;id_auteur&quot;,
		'breves' =&gt; &quot;id_breve&quot;,
		'documents' =&gt; &quot;id_document&quot;,
		'forums' =&gt; &quot;id_forum&quot;,
		'groupes_mots' =&gt; &quot;id_groupe&quot;,
		'hierarchie' =&gt; &quot;id_rubrique&quot;,
		'mots' =&gt; &quot;id_mot&quot;,
		'rubriques' =&gt; &quot;id_rubrique&quot;,
		'signatures' =&gt; &quot;id_signature&quot;,
		'syndication' =&gt; &quot;id_syndic&quot;,
		'syndic_articles' =&gt; &quot;id_syndic_article&quot;,
		'types_documents' =&gt; &quot;id_type&quot;
	);
	
	# cf. fonction table_objet dans inc_version
	$table_des_tables = array(
		'articles' =&gt; 'articles',
		'auteurs' =&gt; 'auteurs',
		'breves' =&gt; 'breves',
		'forums' =&gt; 'forum',
		'signatures' =&gt; 'signatures',
		'documents' =&gt; 'documents',
		'types_documents' =&gt; 'types_documents',
		'mots' =&gt; 'mots',
		'groupes_mots' =&gt; 'groupes_mots',
		'rubriques' =&gt; 'rubriques',
		'syndication' =&gt; 'syndic',
		'syndic_articles' =&gt; 'syndic_articles',
		'hierarchie' =&gt; 'rubriques'
	);
	
	$exceptions_des_tables = array(
		'breves' =&gt; array(
			'id_secteur' =&gt; 'id_rubrique',
			'date' =&gt; 'date_heure',
			'nom_site' =&gt; 'lien_titre',
			'url_site' =&gt; 'lien_url'
			),
		'forums' =&gt; array(
			'date' =&gt; 'date_heure',
			'nom' =&gt; 'auteur',
			'email' =&gt; 'email_auteur'
			),
		'signatures' =&gt; array(
			'date' =&gt; 'date_time',
			'nom' =&gt; 'nom_email',
			'email' =&gt; 'ad_email'
		),
		'documents' =&gt; array(
			'type_document' =&gt; array('types_documents', 'titre'),
			'extension_document' =&gt; array('types_documents', 'extension')
		),
		'syndic_articles' =&gt; array(
			'url_article' =&gt; 'url',		  # ne sert pas ? cf balise_URL_ARTICLE
			'lesauteurs' =&gt; 'lesauteurs', # ne sert pas ? cf balise_LESAUTEURS
			'url_site' =&gt; array('syndic', 'url_site'),
			'nom_site' =&gt; array('syndic', 'nom_site')
		)
	);
	
	$table_date = array (
		'articles' =&gt; 'date',
		'auteurs' =&gt;  'date',
		'breves' =&gt;  'date_heure',
		'forums' =&gt;  'date_heure',
		'signatures' =&gt; 'date_time',
		'documents' =&gt; 'date',
		'types_documents' =&gt; 'date',
		'groupes_mots' =&gt; 'date',
		'mots' =&gt; 'date',
		'rubriques' =&gt; 'date',
		'syndication' =&gt; 'date',
		'syndic_articles' =&gt; 'date'
	);


//
// tableau des tables de relations,
// Ex: gestion du critere {id_mot} dans la boucle(ARTICLES)
//

$tables_relations = array(
	'articles' =&gt; array (
		'id_mot' =&gt; 'mots_articles',
		'id_auteur' =&gt; 'auteurs_articles',
		'id_document' =&gt; 'documents_articles'
		),

	'auteurs' =&gt; array (
		'id_article' =&gt; 'auteurs_articles'
		),

	'breves' =&gt; array (
		'id_mot' =&gt; 'mots_breves',
		'id_document' =&gt; 'documents_breves'
		),

	'documents' =&gt; array (
		'id_article' =&gt; 'documents_articles',
		'id_rubrique' =&gt; 'documents_rubriques',
		'id_breve' =&gt; 'documents_breves'
		),

	'forums' =&gt; array (
		'id_mot' =&gt; 'mots_forum',
		),

	'mots' =&gt; array (
		'id_article' =&gt; 'mots_articles',
		'id_breve' =&gt; 'mots_breves',
		'id_forum' =&gt; 'mots_forum',
		'id_rubrique' =&gt; 'mots_rubriques',
		'id_syndic' =&gt; 'mots_syndic'
		),

	'groupes_mots' =&gt; array (
		'id_groupe' =&gt; 'mots'
		),

	'rubriques' =&gt; array (
		'id_mot' =&gt; 'mots_rubriques',
		'id_document' =&gt; 'documents_rubriques'
		),

	'syndication' =&gt; array (
		'id_mot' =&gt; 'mots_syndic'
		)
	);
?&gt;

--- NEW FILE: formulaire_site-dist.html ---
&lt;form action=&quot;#SELF&quot; method=&quot;post&quot;&gt;
      &lt;br /&gt;
      &lt;fieldset	class='spip_encadrer' style='color: black; font-size: 90%'&gt;
	&lt;legend&gt;&lt;/legend&gt;
	&lt;label&gt;
	  &lt;:form_prop_nom_site:&gt;
	  &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;nom_site&quot; value=&quot;&quot; size=&quot;30&quot;&gt;
	&lt;/label&gt;
	&lt;label&gt;
	  &lt;:form_prop_url_site:&gt;
	  &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;url_site&quot; value=&quot;&quot; size=&quot;30&quot;&gt;
	&lt;/label&gt;
	&lt;label&gt;&lt;:form_prop_description:&gt;
	  &lt;textarea name='description_site' rows='5' class='forml' cols='40'&gt;&lt;/textarea&gt;
	&lt;/label&gt;
	&lt;div align=&quot;right&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;spip_bouton&quot; value=&quot;&lt;:bouton_valider:&gt;&quot;&gt;&lt;/div&gt;
      &lt;/fieldset&gt;
&lt;/form&gt;

--- NEW FILE: inc-compilo-index.php3 ---
&lt;?php


// fonctions de recherche et de reservation
// dans l'arborescence des boucles

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_COMPILO_INDEX&quot;)) return;
define(&quot;_INC_COMPILO_INDEX&quot;, &quot;1&quot;);

// index_pile retourne la position dans la pile du champ SQL $nom_champ 
// en prenant la boucle la plus proche du sommet de pile (indique par $idb).
// Si on ne trouve rien, on considere que ca doit provenir du contexte 
// (par l'URL ou l'include) qui a ete recopie dans Pile[0]
// (un essai d'affinage a debouche sur un bug vicieux)
// Si ca reference un champ SQL, on le memorise dans la structure $boucles
// afin de construire un requete SQL minimale (plutot qu'un brutal 'SELECT *')

function index_pile($idb, $nom_champ, &amp;$boucles, $explicite='') {
  global $exceptions_des_tables, $table_des_tables, $tables_des_serveurs_sql;

	$i = 0;
	if (strlen($explicite)) {
	// Recherche d'un champ dans un etage superieur
	  while (($idb != $explicite) &amp;&amp; ($idb !='')) {
#		spip_log(&quot;Cherchexpl: $nom_champ '$explicite' '$idb' '$i'&quot;);
			$i++;
			$idb = $boucles[$idb]-&gt;id_parent;
		}
	}

	$c = strtolower($nom_champ);
	// attention: entre la boucle nommee 0, &quot;&quot; et le tableau vide,
	// il y a incoherences qu'il vaut mieux eviter
	while ($boucles[$idb]) {
#		spip_log(&quot;Cherche: $nom_champ '$idb' '$c'&quot;);
		$r = $boucles[$idb]-&gt;type_requete;
		$s = $boucles[$idb]-&gt;sql_serveur;
		if (!$s) 
		  { $s = 'localhost';
    // indirection (pour les rares cas ou le nom de la table!=type)
		    $t = $table_des_tables[$r];
		  }
		if (!$t) $t = $r; // pour les tables non Spip
		// $t est le nom PHP de cette table 
#		spip_log(&quot;Go: idb='$idb' r='$r' c='$c' nom='$nom_champ' s=$s&quot;);
		$desc = $tables_des_serveurs_sql[$s][$t];
		if (!$desc) {
			erreur_squelette(_L(&quot;Table SQL \&quot;$r\&quot; inconnue&quot;), &quot;'$idb'&quot;);
			# continuer pour chercher l'erreur suivante
			return  &quot;'#&quot; . $r . ':' . $nom_champ . &quot;'&quot;;
		}
		$excep = $exceptions_des_tables[$r][$c];
		if ($excep) {
			// entite SPIP alias d'un champ SQL
			if (!is_array($excep)) {
				$e = $excep;
				$c = $excep;
			} 
			// entite SPIP alias d'un champ dans une autre table SQL
			else {
				$t = $excep[0];
				$e = $excep[1].' AS '.$c;
			}
		}
		else {
			// $e est le type SQL de l'entree
			// entite SPIP homonyme au champ SQL
			if ($desc['field'][$c])
				$e = $c;
			else
				unset($e);
		}

#		spip_log(&quot;Dans $idb ('$t' '$e'): $desc&quot;);

		// On l'a trouve
		if ($e) {
			$boucles[$idb]-&gt;select[] = $t . &quot;.&quot; . $e;
			return '$Pile[$SP' . ($i ? &quot;-$i&quot; : &quot;&quot;) . '][\'' . $c . '\']';
		}

		// Sinon on remonte d'un cran
		$idb = $boucles[$idb]-&gt;id_parent;
		$i++;
	}

#	spip_log(&quot;Pas vu $nom_champ dans les &quot; . count($boucles) . &quot; boucles&quot;);
	// esperons qu'il y sera
	return('$Pile[0][\''.$nom_champ.'\']');
}

# calculer_champ genere le code PHP correspondant a une balise Spip
# Retourne une EXPRESSION php 
function calculer_champ($p) {
	$p = calculer_balise($p-&gt;nom_champ, $p);

	// definir le type et les traitements
	// si ca ramene le choix par defaut, ce n'est pas un champ 

	if (($p-&gt;code) &amp;&amp; ($p-&gt;code != '$Pile[0][\''.$nom.'\']')) {
		// Par defaut basculer en numerique pour les #ID_xxx
		if (substr($nom,0,3) == 'ID_') $p-&gt;statut = 'num';
	}

	else {
	// on renvoie la forme initiale '#TOTO'
	$p-&gt;code = &quot;'#&quot; . $nom . &quot;'&quot;;
	$p-&gt;statut = 'php';	// pas de traitement
	
	}

	// Retourner l'expression php correspondant au champ + ses filtres
	return applique_filtres($p);
}

// cette fonction sert d'API pour demander le champ '$champ' dans la pile
function champ_sql($champ, $p) {
	return index_pile($p-&gt;id_boucle, $champ, $p-&gt;boucles, $p-&gt;nom_boucle);
}

// cette fonction sert d'API pour demander une balise quelconque sans filtre
function calculer_balise($nom, $p) {

	// regarder s'il existe une fonction personnalisee balise_NOM()
	$f = 'balise_' . $nom;
	if (function_exists($f))
		return $f($p);

	// regarder s'il existe une fonction standard balise_NOM_dist()
	$f = 'balise_' . $nom . '_dist';
	if (function_exists($f))
		return $f($p);

	// regarder s'il existe un fichier d'inclusion au nom de la balise
	// et contenant un tableau balise_NOM_collecte
	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
	if (@file_exists($file)) {
		include_local($file);
		$f = $GLOBALS['balise_' . $nom . '_collecte'];
		if (is_array($f))
			return calculer_balise_dynamique($p, $nom, $f);
	}

	// S'agit-il d'un logo ? Une fonction speciale les traite tous
	if (ereg('^LOGO_', $nom))
		return calculer_balise_logo($p);

	// ca pourrait etre un champ SQL homonyme,
	$p-&gt;code = index_pile($p-&gt;id_boucle, $nom, $p-&gt;boucles, $p-&gt;nom_boucle);

	// Compatibilite ascendante avec les couleurs html (#FEFEFE) :
	// SI le champ SQL n'est pas trouve
	// ET si la balise a une forme de couleur
	// ET s'il n'y a ni filtre ni etoile
	// ALORS retourner la couleur.
	// Ca permet si l'on veut vraiment de recuperer [(#ACCEDE*)]
	if (ereg(&quot;^[\$]Pile[[]0[]][[]'([A-F]{1,6})'[]]$&quot;, $p-&gt;code, $match)
	AND !$p-&gt;etoile
	AND !$p-&gt;fonctions) {
		$p-&gt;code = &quot;'#&quot;. $match[1].&quot;'&quot;;
		$p-&gt;statut = 'php';
	}

	return $p;
}

//
// Traduction des balises dynamiques, notamment les &quot;formulaire_*&quot;
// Inclusion du fichier associe a son nom.
// Ca donne les arguments a chercher dans la pile,on compile leur localisation
// Ensuite on delegue a une fonction generale definie dans inc-calcul-outils
// qui recevra a l'execution la valeurs des arguments, 
// ainsi que les filtres (qui ne sont donc pas traites &#224; la compil)

function calculer_balise_dynamique($p, $nom, $l) {
	balise_distante_interdite($p);
	$param = param_balise($p);
	$p-&gt;code = &quot;executer_balise_dynamique('&quot; . $nom . &quot;',\n\tarray(&quot;
	  . join(',',collecter_balise_dynamique($l, $p))
	  . filtres_arglist($param, $p, ',')
	  . &quot;),\n\tarray(&quot;
	  . (!$p-&gt;fonctions ? '' : (&quot;'&quot; . join(&quot;','&quot;, $p-&gt;fonctions) . &quot;'&quot;))
	  . &quot;))&quot;;
	$p-&gt;statut = 'php';
	$p-&gt;fonctions = '';
	return $p;
}

function param_balise(&amp;$p) 
{
	$a = $p-&gt;fonctions;
	if ($a) list(,$nom) = each($a) ; else $nom = '';
	if (!ereg(' *\{ *([^}]+) *\} *',$nom, $m))
	  return '';
	else {
		$filtres= array();
		while (list(, $f) = each($a)) if ($f) $filtres[] = $f;
		$p-&gt;fonctions = $filtres;
		return $m[1];
	}
}

// construire un tableau des valeurs interessant un formulaire

function collecter_balise_dynamique($l, $p) {
	$args = array();
	foreach($l as $c) { $x = calculer_balise($c, $p); $args[] = $x-&gt;code;}
	return $args;
}

// Genere l'application d'une liste de filtres
function applique_filtres($p) {
	$statut = $p-&gt;statut;
	$fonctions = $p-&gt;fonctions;
	$p-&gt;fonctions = ''; # pour r&#233;utiliser la structure si r&#233;cursion

	// pretraitements standards
	switch ($statut) {
		case 'num':
			$code = &quot;intval($code)&quot;;
			break;
		case 'php':
			break;
		case 'html':
		default:
			$code = &quot;trim($code)&quot;;
			break;
	}

//  processeurs standards (cf inc-balises.php3)
	$code = ($p-&gt;etoile ? $p-&gt;code : champs_traitements($p));
	// Appliquer les filtres perso
	if ($fonctions) {
		foreach($fonctions as $fonc) {
			if ($fonc) {
				$arglist = '';
				if (ereg('([^\{\}]*)\{(.+)\}$', $fonc, $regs)) {
					$fonc = $regs[1];
				        $arglist = filtres_arglist($regs[2],$p, ($fonc == '?' ? ':' : ','));
				}
				if (function_exists($fonc))
				  $code = &quot;$fonc($code$arglist)&quot;;
				else if (strpos(&quot; &lt; &gt; &lt;= &gt;= == &lt;&gt; ? &quot;, &quot; $fonc &quot;))
				  $code = &quot;($code $fonc &quot;
				    . substr($arglist,1)
				    . ')';
				else 
				  $code = &quot;erreur_squelette('&quot;.
					  texte_script(
						_T('erreur_filtre', array('filtre' =&gt; $fonc))
					).&quot;','&quot; . $p-&gt;id_boucle . &quot;')&quot;;
			}
		}
	}

	// post-traitement securite
	if ($statut == 'html')
		$code = &quot;interdire_scripts($code)&quot;;
	return $code;
}

// analyse des parametres d'un champ etendu
// [...(#CHAMP{parametres})...] ou [...(#CHAMP|filtre{parametres})...]
// retourne une suite de N references aux N valeurs indiqu&#233;es avec N virgules

function filtres_arglist($args, $p, $sep) {
	$arglist ='';
	while (ereg('([^,]+),?(.*)$', $args, $regs)) {
		$arg = trim($regs[1]);
		if ($arg) {
			if (ereg(&quot;^&quot; . NOM_DE_CHAMP .&quot;(.*)$&quot;, $arg, $regs2)) {
				$p-&gt;nom_boucle = $regs2[2];
				$p-&gt;nom_champ = $regs2[3];
				# faudrait verifier !trim(regs2[5])
				$arg = calculer_champ($p);
				
			} else if ($arg[0] =='$')
				$arg = '$Pile[0][\'' . substr($arg,1) . &quot;']&quot;;
			$arglist .= $sep . $arg;
		}
		$args=$regs[2];
	}
	return $arglist;
}

//
// Reserve les champs necessaires a la comparaison avec le contexte donne par
// la boucle parente ; attention en recursif il faut les reserver chez soi-meme
// ET chez sa maman
// 
function calculer_argument_precedent($idb, $nom_champ, &amp;$boucles) {

	// recursif ?
	if ($boucles[$idb]-&gt;externe)
		index_pile ($idb, $nom_champ, $boucles); // reserver chez soi-meme
	// reserver chez le parent et renvoyer l'habituel $Pile[$SP]['nom_champ']
#	spip_log(&quot;boucles[$idb]-&gt;id_parent &quot; . $boucles[$idb]-&gt;id_parent);
	return index_pile ($boucles[$idb]-&gt;id_parent, $nom_champ, $boucles);
}

function rindex_pile($p, $champ, $motif) 
{
	$n = 0;
	$b = $p-&gt;id_boucle;
	$p-&gt;code = '';
	while ($b != '') {
	if ($s = $p-&gt;boucles[$b]-&gt;param) {
	  foreach($s as $v) {
		if (strpos($v,$motif) !== false) {
		  $p-&gt;code = '$Pile[$SP' . (($n==0) ? &quot;&quot; : &quot;-$n&quot;) .
			&quot;]['$champ']&quot;;
		  $b = '';
		  break;
		}
	  }
	}
	$n++;
	$b = $p-&gt;boucles[$b]-&gt;id_parent;
	}
	if (!$p-&gt;code) {
	  erreur_squelette(_L(&quot;Champ #&quot; . strtoupper($champ) . &quot; hors d'une boucle de motif $motif&quot;), $p-&gt;id_boucle);
	}
	$p-&gt;statut = 'php';
	return $p;
}

?&gt;

--- NEW FILE: mot.php3 ---
&lt;?php
$fond = &quot;mot&quot;;
$delais = 24 * 3600;


include (&quot;inc-public.php3&quot;);


?&gt;

--- NEW FILE: htaccess-html.txt ---
###########################################################
# Fichier .htaccess pour les URLs 'html' ; a installer    #
# si vous reglez $type_urls='html'                        #
# dans ecrire/mes_options.php3 ou dans mes_fonctions.php3 #
# (fichier associe : inc-urls-html.php3)                  #
###########################################################

RewriteEngine On

### si votre site est en sous-domaine, preciser ci-dessous
# RewriteBase /sous/domaine/

RewriteRule ^rubrique([0-9]+)\.html$	rubrique.php3?id_rubrique=$1 [QSA,L]
RewriteRule ^article([0-9]+)\.html$		article.php3?id_article=$1 [QSA,L]
RewriteRule ^breve([0-9]+)\.html$		breve.php3?id_breve=$1 [QSA,L]
RewriteRule ^mot([0-9]+)\.html$			mot.php3?id_mot=$1 [QSA,L]
RewriteRule ^auteur([0-9]+)\.html$		auteur.php3?id_auteur=$1 [QSA,L]

--- NEW FILE: inc-formulaire_site.php3 ---
&lt;?php

global $balise_FORMULAIRE_SITE_collecte;
$balise_FORMULAIRE_SITE_collecte = array('id_rubrique', 'nom_site', 'url_site', 'description_site');

function balise_FORMULAIRE_SITE_stat($args, $filtres)
{
  return ((lire_meta(&quot;proposer_sites&quot;) != 2) ? '' : $args);
}

function balise_FORMULAIRE_SITE_dyn($id_rubrique, $nom_site, $url_site, $description_site) {

	if (!$nom_site) return array('formulaire_site', 0);

	// Tester le nom du site
	if (strlen ($nom_site) &lt; 2){
		return _T('form_prop_indiquer_nom_site');
	}

	// Tester l'URL du site
	include_ecrire(&quot;inc_sites.php3&quot;);
	if (!recuperer_page($url_site)) {
		return _T('form_pet_url_invalide');
	}

	// Integrer a la base de donnees
		
	$nom_site = addslashes($nom_site);
	$url_site = addslashes($url_site);
	$description_site = addslashes($description_site);
			
	spip_query(&quot;INSERT INTO spip_syndic (nom_site, url_site, id_rubrique, descriptif, date, date_syndic, statut, syndication) VALUES ('$nom_site', '$url_site', $id_rubrique, '$description_site', NOW(), NOW(), 'prop', 'non')&quot;);
	return  _T('form_prop_enregistre');
}
?&gt;

--- NEW FILE: inc-formulaire_ecrire_auteur.php3 ---
&lt;?php

global $balise_FORMULAIRE_ECRIRE_AUTEUR_collecte ;
$balise_FORMULAIRE_ECRIRE_AUTEUR_collecte = array('id_auteur',
			     'email',
			     'sujet_message_auteur',
			     'texte_message_auteur',
			     'email_message_auteur'
);

function balise_FORMULAIRE_ECRIRE_AUTEUR_stat($args, $filtres)
{
  list($id_auteur, $mail, $sujet, $texte, $adres) = $args;
  return (!email_valide($mail) ? '' :
	  array($id_auteur, $mail,$sujet, $texte, $adres));
}

function balise_FORMULAIRE_ECRIRE_AUTEUR_dyn($id_auteur, $mail, $sujet, $texte, $adres) {
  global $spip_lang_rtl;
	include_ecrire(&quot;inc_lang.php3&quot;); // pour spip_lang_rtl 
	if (!$spip_lang_rt) $spip_lang_rtl = '_rtl'; # INDISPENSABLE cf skel
	$mailko = $texte &amp;&amp; !email_valide($adres);
	$validable = $texte &amp;&amp; $sujet &amp;&amp; (!$mailko);

	if ($validable &amp;&amp; ($GLOBALS['valide'] == _T('form_prop_confirmer_envoi'))) { 
		$texte .= &quot;\n\n-- &quot;._T('envoi_via_le_site').&quot; &quot;.lire_meta('nom_site').&quot; (&quot;.lire_meta('adresse_site').&quot;/) --\n&quot;;
		include_ecrire(&quot;inc_mail.php3&quot;);
		envoyer_mail($mail, $sujet, $texte, $adres,
				&quot;X-Originating-IP: &quot;.$GLOBALS['REMOTE_ADDR']);
		return _T('form_prop_message_envoye');
	    }


	// repartir de zero pour les boutons car clean_link a pu etre utilisee

	$link = new Link;

	$link-&gt;delVar('sujet_message_auteur');
	$link-&gt;delVar('texte_message_auteur');
	$link-&gt;delVar('email_message_auteur');
	$link-&gt;delVar('id_auteur');
	return 
	  array('formulaire_ecrire_auteur', 0,
		array(
		      'action' =&gt; $link-&gt;getUrl(),
		      'id_auteur' =&gt; $id_auteur,
		      'mailko' =&gt; $mailko ? $spip_lang_rtl : '',
		      'mail' =&gt; $adres,
		      'sujetko' =&gt; ($texte &amp;&amp; !$sujet) ? $spip_lang_rtl : '',
		      'sujet' =&gt; $sujet,
		      'texte' =&gt; $texte,
		      'valide' =&gt; ($validable ?
				    _T('form_prop_confirmer_envoi') :
				    _T('form_prop_envoyer'))
		      )
		);
}
?&gt;

--- NEW FILE: inc-login_prive.php3 ---
&lt;?php

include_local(&quot;inc-login_public.php3&quot;);

global $balise_LOGIN_PRIVE_collecte;
$balise_LOGIN_PRIVE_collecte = array('url');

# retourner:
# 1. l'url collectee ci-dessus (args0) ou donnee en filtre (filtre0)
# 2. l'eventuel parametre de la balise (args1) fournie par calculer_balise_dynamique

function balise_LOGIN_PRIVE_stat ($args, $filtres)
{
	return array($filtres[0] ? $filtres[0] : $args[0], $args[1]);
}

function balise_LOGIN_PRIVE_dyn($cible, $login)
{
	return login_explicite($login, $cible,  'redac');
}
?&gt;

--- NEW FILE: backend.php3 ---
&lt;?php
$fond = &quot;backend&quot;;
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
// Et les headers !!!!

$flag_preserver = true;

@header(&quot;Content-type: text/xml&quot;);

include (&quot;inc-public.php3&quot;);

?&gt;

--- NEW FILE: inc-calcul-outils.php3 ---
&lt;?php

//
// Des fonctions diverses utilisees lors du calcul d'une page ; ces fonctions
// bien pratiques n'ont guere de logique organisationnelle ; elles sont
// appelees par certaines balises au moment du calcul des pages. (Peut-on
// trouver un modele de donnees qui les associe physiquement au fichier
// definissant leur balise ???
//

// ON TROUVERA EN QUEUE DE FICHIER LES FONCTIONS FAISANT DES APPELS SQL


// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_CALCUL_OUTILS&quot;)) return;
define(&quot;_INC_CALCUL_OUTILS&quot;, &quot;1&quot;);

// Pour les documents comme pour les logos, le filtre |fichier donne
// le chemin du fichier apres 'IMG/' ;  peut-etre pas d'une purete
// remarquable, mais a conserver pour compatibilite ascendante.
// -&gt; <A HREF="http://www.spip.net/fr_article901.html">http://www.spip.net/fr_article901.html</A>
function calcule_fichier_logo($on) {
	$r = ereg_replace(&quot;^&quot; . _DIR_IMG, &quot;&quot;, $on);
	return $r;
}

// Renvoie le code html pour afficher un logo, avec ou sans survol, lien, etc.
// utilise la globale ci-dessous pour les attributs hspace &amp; vspace

tester_variable('espace_logos',3);

function affiche_logos($logos, $lien, $align) {
	static $num_survol=0;
	global $espace_logos;
	list ($arton, $artoff) = $logos;

	if (!$arton) return $artoff;

	$num_survol++;
	$milieu = &quot;&lt;img src='$arton'&quot;
		. ($align ? &quot; align='$align' &quot; : '') 
		. &quot; name='image$num_survol' border='0' &quot;
		. &quot;alt='image$num_survol'&quot;
		. &quot; hspace='$espace_logos' vspace='$espace_logos' class='spip_logos' /&gt;&quot;;

	if (!$artoff) return ($lien ? http_href($lien, $milieu) : $milieu);

	$att =	&quot;onmouseover=\&quot;image$num_survol.src='$artoff'\&quot; 
		onmouseout=\&quot;image$num_survol.src='$arton'\&quot;&quot;;

	return ($lien ? &quot;&lt;a href='$lien' $att&gt;$milieu&lt;/a&gt;&quot; : &quot;&lt;div $att&gt;$milieu&lt;/div&gt;&quot;);

}

//
// Retrouver le logo d'un objet (et son survol)
//

function calcule_logo($type, $onoff, $id, $id_rubrique, $ff) {
	include_ecrire('inc_logos.php3');

	$table_logos = array (
	'ARTICLE' =&gt; 'art',
	'AUTEUR' =&gt;  'aut',
	'BREVE' =&gt;  'breve',
	'MOT' =&gt; 'mot',
	'RUBRIQUE' =&gt; 'rub',
	'SITE' =&gt; 'site'
	);
	$type = $table_logos[$type];
	$nom = strtolower($onoff);
	# attention au cas $id = '0' pour LOGO_SITE_SPIP : utiliser intval()
	while (1) {
		$on = cherche_image_nommee($type . $nom . intval($id));
		if ($on) {
			if ($ff)
			  return  (array('', &quot;$on[1].$on[2]&quot;));
			else {
				$off = ($onoff != 'ON') ? '' :
					cherche_image_nommee($type . 'off' . $id);
				return array (&quot;$on[0]$on[1].$on[2]&quot;,
					      ($off ? (&quot;$off[0]$off[1].$off[2]&quot;) : ''));
			}
		}
		else if ($id_rubrique) {
			$type = 'rub';
			$id = $id_rubrique;
			$id_rubrique = 0;
		} else if ($id AND $type == 'rub')
			$id = sql_parent($id);
		else return array('','');
	}
}

//
// fonction standard de calcul de la balise #INTRODUCTION
// on peut la surcharger en definissant dans mes_fonctions.php3 :
// function introduction($type,$texte,$chapo,$descriptif) {...}
//
function calcul_introduction ($type, $texte, $chapo='', $descriptif='') {
	if (function_exists(&quot;introduction&quot;))
		return introduction ($type, $texte, $chapo, $descriptif);

	switch ($type) {
		case 'articles':
			if ($descriptif)
				return propre($descriptif);
			else if (substr($chapo, 0, 1) == '=')	// article virtuel
				return '';
			else
				return PtoBR(propre(supprimer_tags(couper_intro($chapo.&quot;\n\n\n&quot;.$texte, 500))));
			break;
		case 'breves':
			return PtoBR(propre(supprimer_tags(couper_intro($texte, 300))));
			break;
		case 'forums':
			return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
			break;
		case 'rubriques':
			if ($descriptif)
				return propre($descriptif);
			else
				return PtoBR(propre(supprimer_tags(couper_intro($texte, 600))));
			break;
	}
}

function executer_balise_dynamique($nom, $args, $filtres) {
	$file = 'inc-' . strtolower($nom) . _EXTENSION_PHP;
	include_local($file);

	$f = 'balise_' . $nom . '_stat';
	$r = $f($args, $filtres);
	if (!is_array($r))
		return $r;
	else { 
		return
		('&lt;'.'?php 
include_ecrire(\'inc_lang.php3\');
lang_select($GLOBALS[&quot;spip_lang&quot;]);
include_local(&quot;'
		. $file
		. '&quot;);
inclure_balise_dynamique(balise_'
		. $nom
		. '_dyn(\''
		. join(&quot;', '&quot;, array_map(&quot;addslashes&quot;, $r))
		. '\'));
	lang_dselect();
?'
		.&quot;&gt;&quot;);
	}
}

//
// FONCTIONS FAISANT DES APPELS SQL
//

# NB : a l'exception des fonctions pour les balises dynamiques

function calcul_exposer ($id, $type, $reference) {
	static $exposer;
	static $ref_precedente;

	// Que faut-il exposer ? Tous les elements de $reference
	// ainsi que leur hierarchie ; on ne fait donc ce calcul
	// qu'une fois (par squelette) et on conserve le resultat
	// en static.
	if ($reference&lt;&gt;$ref_precedente) {
		$ref_precedente = $reference;

		$exposer = array();
		foreach ($reference as $element=&gt;$id_element) {
			if ($element == 'id_secteur') $element = 'id_rubrique';
			if ($x = table_from_primary($element)) {
				list($table,$hierarchie) = $x;
				$exposer[$element][$id_element] = true;
				if ($hierarchie) {
					list ($id_rubrique) = spip_abstract_fetsel(
array('id_rubrique'), 
array($table),
array(&quot;$element=$id_element&quot;));
				$hierarchie = substr(calculer_hierarchie($id_rubrique), 2);
				foreach (split(',',$hierarchie) as $id_rubrique)
					$exposer['id_rubrique'][$id_rubrique] = true;
				}
			}
		}
	}

	// And the winner is...
	return $exposer[$type][$id];
}

function table_from_primary($id) {
	global $tables_principales;
	include_ecrire('inc_serialbase.php3');
	foreach ($tables_principales as $k =&gt; $v) {
		if ($v['key']['PRIMARY KEY'] == $id)
			return array($k, array_key_exists('id_rubrique', $v['field']));
	}
	return '';
}

function calcul_generation ($generation) {
	$lesfils = array();
	$result = spip_abstract_select(array('id_rubrique'),
				array('rubriques AS rubriques'),
				array(calcul_mysql_in('id_parent', 
					$generation,
					'')),
				'','','','','','','');
	while ($row = spip_abstract_fetch($result))
		$lesfils[] = $row['id_rubrique'];
	return join(&quot;,&quot;,$lesfils);
}

function calcul_branche ($generation) {
	if (!$generation) 
		return '0';
	else {
		$branche[] = $generation;
		while ($generation = calcul_generation ($generation))
			$branche[] = $generation;
		return join(&quot;,&quot;,$branche);
	}
}

// fonction appelee par la balise #LOGO_DOCUMENT
function calcule_document($id_document, $doubdoc, &amp;$doublons) {
	if (!$id_document) return '';
	if ($doubdoc &amp;&amp; $id_document) $doublons[&quot;documents&quot;] .= ', ' . $id_document;

	if (!($row = spip_abstract_select(array('id_type', 'id_vignette', 'fichier', 'mode'), array('documents AS documents'), array(&quot;id_document = $id_document&quot;))))
// pas de document. Ne devrait pas arriver
		return ''; 

	list($id_type, $id_vignette, $fichier, $mode) = spip_abstract_fetch($row);
	if ($id_vignette) {
		if ($res = spip_abstract_select(array('fichier'), array('documents AS documents'), array(&quot;id_document = $id_vignette&quot;))) {
			list($vignette) = spip_abstract_fetch($res);
			if (@file_exists($vignette))
				return generer_url_document($id_vignette);
				# return ($fichier); # en std g_u_d fait ca
		}
	} else if ($mode == 'vignette') 
		return generer_url_document($id_document);
		# return $fichier; # en std g_u_d fait ca

// calcul de l'extension par tous les moyens
	if ($id_type) {
		list($ext) = spip_abstract_fetch(spip_abstract_select(array('extension'), array('types_documents AS documents'), array(&quot;id_type = &quot; . intval($id_type))));
	} else {
		eregi('\.([a-z0-9]+)$', $fichier, $regs);
		$ext = $regs[1];
	}
// Pas de vignette mais une extension:
// prendre la vignette de celle-ci dans IMG/icones sauf si on peut faire mieux
	$formats = ','.lire_meta('formats_graphiques').',';
	if ((strpos($formats, &quot;,$ext,&quot;) === false) OR
	!$fichier OR (lire_meta(&quot;creer_preview&quot;) != 'oui')) {
		return vignette_par_defaut($ext ? $ext : 'txt', false);
	}
// on peut faire mieux dans le cas des images: une previsualisation
// on devrait verifier que le fichier existe dans IMG/vignette
// et sinon lancer creer_vignette (qui fera un UPDATE sur spip_documents)
// mais on risque de d&#233;passer le temps alloue au processus
	return 'spip_image.php3?vignette='.rawurlencode(
		str_replace('../', '', $fichier));
}


// fonction appelee par la balise #EMBED
function calcule_embed_document($id_document, $filtres, &amp;$doublons, $doubdoc) {
	if ($doubdoc &amp;&amp; $id_document) $doublons[&quot;documents&quot;] .= ', ' . $id_document;
	return embed_document($id_document, $filtres, false);
}

// fonction appelee par la balise #NOTES
function calculer_notes() {
	$r = $GLOBALS[&quot;les_notes&quot;];
	$GLOBALS[&quot;les_notes&quot;] = &quot;&quot;;
	$GLOBALS[&quot;compt_note&quot;] = 0;
	$GLOBALS[&quot;marqueur_notes&quot;] ++;
	return $r;
}

# retourne la profondeur d'une rubrique

function sql_profondeur($id) {
	$n = 0;
	while ($id) {
		$n++;
		$id = sql_parent($id);
	}
	return $n;
}


function sql_parent($id_rubrique) {
	$row = spip_abstract_fetsel(array(id_parent), 
			array('rubriques'), 
			array(&quot;id_rubrique=&quot; . intval($id_rubrique)));
	return $row['id_parent'];
}

function sql_rubrique($id_article) {
	$row = spip_abstract_fetsel(array('id_rubrique'),
			array('articles'),
			array(&quot;id_article=&quot; . intval($id_article)));
	return $row['id_rubrique'];
}

function sql_auteurs($id_article, $table, $id_boucle, $serveur='') {
	$auteurs = &quot;&quot;;
	if ($id_article) {
		$result_auteurs = spip_abstract_select(array('auteurs.nom', 'auteurs.email'),
			array('auteurs AS auteurs',
				'auteurs_articles AS lien'), 
			array(&quot;lien.id_article=$id_article&quot;,
				&quot;auteurs.id_auteur=lien.id_auteur&quot;),
			'','','','',1, 
			$table, $id_boucle, $serveur);

		while($row_auteur = spip_abstract_fetch($result_auteurs, $serveur)) {
			$nom_auteur = typo($row_auteur[&quot;nom&quot;]);
			$email_auteur = $row_auteur[&quot;email&quot;];
			if ($email_auteur) {
				$auteurs[] = &quot;&lt;a href=\&quot;mailto:$email_auteur\&quot;&gt;$nom_auteur&lt;/a&gt;&quot;;
			} else {
				$auteurs[] = &quot;$nom_auteur&quot;;
			}
		}
	}
	return (!$auteurs) ? &quot;&quot; : join($auteurs, &quot;, &quot;);
}

function sql_petitions($id_article, $table, $id_boucle, $serveur, &amp;$Cache) {
	$retour = spip_abstract_fetsel(
			array('texte'),
			array('petitions'),
			array(&quot;id_article=&quot;.intval($id_article)),
			'','','','',1, 
			$table, $id_boucle, $serveur);

	if (!$retour) return '';
	# cette page est invalidee par toute petition
	if ($Cache) $Cache['petition']['petition'] = 1;
	# ne pas retourner '' car le texte sert aussi de pr&#233;sence
	return ($retour['texte'] ? $retour['texte'] : ' ');
}

# retourne le chapeau d'un article, et seulement s'il est publie

function sql_chapo($id_article) {
	return spip_abstract_fetsel(array('chapo'),
		array('articles'),
		array(&quot;id_article=&quot;.intval($id_article),
		&quot;statut='publie'&quot;));
}

// Calcul de la rubrique associee a la requete
// (selection de squelette specifique par id_rubrique &amp; lang)

function sql_rubrique_fond($contexte, $lang) {

	if ($id = intval($contexte['id_rubrique'])) {
		$row = spip_abstract_fetsel(array('lang'),
					    array('rubriques'),
					    array(&quot;id_rubrique=$id&quot;));
		if ($row['lang'])
			$lang = $row['lang'];
		return array ($id, $lang);
	}

	if ($id  = intval($contexte['id_breve'])) {
		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
			array('breves'), 
			array(&quot;id_breve=$id&quot;));
		$id_rubrique_fond = $row['id_rubrique'];
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}

	if ($id = intval($contexte['id_syndic'])) {
		$row = spip_abstract_fetsel(array('id_rubrique'),
			array('syndic'),
			array(&quot;id_syndic=$id&quot;));
		$id_rubrique_fond = $row['id_rubrique'];
		$row = spip_abstract_fetsel(array('lang'),
			array('rubriques'),
			array(&quot;id_rubrique='$id_rubrique_fond'&quot;));
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}

	if ($id = intval($contexte['id_article'])) {
		$row = spip_abstract_fetsel(array('id_rubrique', 'lang'),
			array('articles'),
			array(&quot;id_article=$id&quot;));
		$id_rubrique_fond = $row['id_rubrique'];
		if ($row['lang'])
			$lang = $row['lang'];
		return array($id_rubrique_fond, $lang);
	}
}

?&gt;
--- NEW FILE: formulaire_login-dist.html ---
[(#HTTP_VARS{echec_cookie})
	&lt;h3 class=&quot;spip&quot;&gt;&lt;:erreur_probleme_cookie:&gt;&lt;/h3&gt;
		&lt;b&gt;&lt;:login_cookie_oblige:&gt;&lt;/b&gt;
		  &lt;:login_cookie_accepte:&gt;&lt;p /&gt;
][
(#HTTP_VARS*{message})
	&lt;br /&gt;
	 &lt;:forum_vous_enregistrer:&gt;
	[&lt;a href='(#URL_SITE_SPIP|inscriptionok{forum})spip_inscription.php3?mode=forum&amp;focus=nom_inscription&amp;target=spip_pass'
	target=&quot;spip_pass&quot;
	onclick=&quot;javascript:window.open(this.href, 'spip_inscription', 'scrollbars=yes, resizable=yes, width=480, height=450'); return false;&quot;&gt;&lt;:forum_vous_inscrire:&gt;&lt;/a&gt;]&nbsp;&nbsp;&#91;&lt;a
		href=&quot;spip_pass.php3&quot;
		target=&quot;spip_pass&quot; 
		onclick=&quot;javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=280'); return false;&quot;&gt;&lt;:login_motpasseoublie:&gt;&lt;/a&gt;&#93;&lt;br /&gt;&lt;br /&gt;
]&lt;div style=&quot;font-family: Verdana,arial,helvetica,sans-serif; font-size: 12px;&quot;&gt;
	&lt;script type=&quot;text/javascript&quot; src=&quot;ecrire/md5.js&quot;&gt;&lt;/script&gt;
	&lt;form	id=&quot;login[_(#HTTP_VARS{login})]&quot;
		action=&quot;[(#HTTP_VARS{action2})]&quot;
		method=&quot;post&quot;[(#HTTP_VARS{source}|=={spip}|?{' ',''})
		onSubmit='if (this.session_password.value) {
			this.session_password_md5.value = calcMD5(&quot;[(#HTTP_VARS{alea_actuel})]&quot; + this.session_password.value);
			this.next_session_password_md5.value = calcMD5(&quot;[(#HTTP_VARS{alea_futur})]&quot; + this.session_password.value);
			this.session_password.value = &quot;&quot;;
			}']&gt;
		&lt;div class=&quot;spip_encadrer&quot; style=&quot;[(#URL_SITE_SPIP|style_align)]&quot;&gt;[
			&lt;div class=&quot;reponse_formulaire&quot;&gt;(#HTTP_VARS*{erreur})&lt;br /&gt;&lt;br /&gt;&lt;/div&gt;
][
			&lt;label&gt;&lt;b&gt;&lt;:login_login2:&gt;&lt;/b&gt;&lt;br /&gt;&lt;/label&gt;(#HTTP_VARS{login}|?{'',' '})
			&lt;input type=&quot;text&quot; id='var_login' name=&quot;var_login&quot; class=&quot;forml&quot; value=&quot;&quot; size=&quot;40&quot; /&gt;
][
&lt;div&gt;
			&lt;input type=&quot;hidden&quot; name=&quot;session_login_hidden&quot; value=&quot;(#HTTP_VARS{login})&quot; /&gt;
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
document.write(&quot;&lt;:login_login:&gt;&nbsp;&lt;b&gt;[(#HTTP_VARS{login})]&lt;&quot; + &quot;/b&gt;&lt;br /&gt;&#91;&lt;a href='spip_cookie.php3?cookie_admin=non&amp;url=[(#HTTP_VARS{url})]'&gt;&lt;font size='2'&gt;&lt;:login_autre_identifiant:&gt;&lt;&quot; + &quot;/font&gt;&lt;&quot; + &quot;/a&gt;&#93;&quot;)
//--&gt;&lt;/script&gt;
&lt;noscript&gt;
	&lt;font face=&quot;Georgia, Garamond, Times, serif&quot; size=&quot;3&quot;&gt;
		&lt;:login_non_securise:&gt;
		&lt;a href=&quot;[(#HTTP_VARS{action})]&quot;&gt;&lt;:login_recharger:&gt;&lt;/a&gt;
	&lt;/font&gt;
	&lt;label&gt;&lt;b&gt;&lt;:login_login2:&gt;&lt;/b&gt;&lt;br /&gt;&lt;/label&gt;
	&lt;input type='text' name='session_login' class='forml' [value=&quot;(#HTTP_VARS{login})&quot; ]size='40' /&gt;
&lt;/noscript&gt;
[&lt;img	src=&quot;(#HTTP_VARS{id_auteur}|silogoauteur)&quot;
	width=&quot;75&quot;
	valign=&quot;top&quot;
	align=&quot;right&quot;
	alt=&quot;[(#HTTP_VARS{login})]&quot;&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;]
&lt;/div&gt;
&lt;p&gt;
		&lt;label&gt;&lt;b&gt;&lt;:login_pass2:&gt;&lt;/b&gt;&lt;/label&gt;&nbsp;&lt;input type=&quot;password&quot; name=&quot;session_password&quot;[ id=&quot;var_login_(#HTTP_VARS{login})]&quot; class=&quot;forml&quot; value=&quot;&quot; size=&quot;40&quot; /&gt;
		&lt;br /&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;checkbox&quot;
			 name=&quot;session_remember&quot;
			 id=&quot;session[_(#HTTP_VARS{login})]&quot;
			 value=&quot;oui&quot;[(#HTTP_VARS*{prefs}|filtre_rester_connecte)checked=&quot;checked&quot;]/&gt;
		&lt;label for=&quot;session[_(#HTTP_VARS{login})]&quot;&gt;&lt;:login_rester_identifie:&gt;&lt;/label&gt;
&lt;/p&gt;
		&lt;input type=&quot;hidden&quot; name=&quot;session_password_md5&quot; value=&quot;&quot; /&gt;
		&lt;input type=&quot;hidden&quot; name=&quot;next_session_password_md5&quot; value=&quot;&quot; /&gt;
		&lt;input type=&quot;hidden&quot; name=&quot;essai_login&quot; value=&quot;oui&quot; /&gt;
]		&lt;input type=&quot;hidden&quot; name=&quot;url&quot; value=&quot;[(#HTTP_VARS{url})]&quot; /&gt;
		&lt;div align=&quot;right&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;spip_bouton&quot; value=&quot;&lt;:bouton_valider:&gt;&quot; /&gt;&lt;/div&gt;
		&lt;/div&gt;
	&lt;/form&gt;
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
document.getElementById('var_login[_(#HTTP_VARS{login})]').focus()
--&gt;&lt;/script&gt;[
	&lt;form action=&quot;(#HTTP_VARS{auth})&quot; method=&quot;get&quot;&gt;
		&lt;fieldset&gt;
		&lt;p&gt;
		&lt;:login_preferez_refuser:&gt;
		&lt;input type=&quot;hidden&quot; name=&quot;essai_auth_http&quot; value=&quot;oui&quot;/&gt;
		[&lt;input type=&quot;hidden&quot; name=&quot;url&quot; value=&quot;(#HTTP_VARS{url})&quot;/&gt;]
		&lt;div align=&quot;right&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;spip_bouton&quot; value=&quot;&lt;:login_sans_cookiie:&gt;&quot;/&gt;&lt;/div&gt;
		&lt;/fieldset&gt;
	&lt;/form&gt;
]
&lt;/div&gt;

--- NEW FILE: formulaire_admin-dist.html ---
&lt;div class=&quot;spip-admin-float&quot;&gt;
&lt;div class=&quot;spip-admin-bloc&quot; dir='#LANG_DIR'&gt;
&lt;div class=&quot;spip-admin&quot;&gt;
	&lt;ul&gt;[
	&lt;li&gt;&lt;a href='ecrire/articles.php3?id_article=(#HTTP_VARS{id_article})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_article:&gt; ([(#HTTP_VARS{id_article})])&lt;/a&gt;&lt;/li&gt;][
	&lt;li&gt;&lt;a href='ecrire/breves_voir.php3?id_breve=(#HTTP_VARS{id_breve})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_breve:&gt; ([(#HTTP_VARS{id_breve})])&lt;/a&gt;&lt;/li&gt;][
	&lt;li&gt;&lt;a href='ecrire/naviguer.php3?id_rubrique=(#HTTP_VARS{id_rubrique})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_rubrique:&gt; ([(#HTTP_VARS{id_rubrique})])&lt;/a&gt;&lt;/li&gt;][
	&lt;li&gt;&lt;a href='ecrire/mots_edit.php3?id_mot=(#HTTP_VARS{id_mot})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_mot:&gt; ([(#HTTP_VARS{id_mot})])&lt;/a&gt;&lt;/li&gt;][
	&lt;li&gt;&lt;a href='ecrire/auteurs_edit.php3?id_auteur=(#HTTP_VARS{id_auteur})' class='spip-admin-boutons'&gt;&lt;:admin_modifier_auteur:&gt; ([(#HTTP_VARS{id_auteur})])&lt;/a&gt;&lt;/li&gt;]
	&lt;li&gt;&lt;a href='[(#HTTP_VARS{action})]var_mode=recalcul' class='spip-admin-boutons'&gt;&lt;:admin_recalculer:&gt;[(#HTTP_VARS{use_cache})]&lt;/a&gt;&lt;/li&gt;[
	&lt;li&gt;&lt;a href='ecrire/(#HTTP_VARS{statistiques})[id_article=(#HTTP_VARS{id_article})]' class='spip-admin-boutons'&gt;&lt;:info_visites:&gt;&nbsp;[(#HTTP_VARS{visites})];&nbsp;&lt;:info_popularite_5:&gt;&nbsp;[(#HTTP_VARS{popularite})]&lt;/a&gt;&lt;/li&gt;][
	&lt;li&gt;&lt;a href='[(#HTTP_VARS{action})]var_mode=(#HTTP_VARS{debug})' class='spip-admin-boutons'&gt;Debug&lt;/a&gt;&lt;/li&gt;]
	&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

--- NEW FILE: inc-formulaire_signature.php3 ---
&lt;?php

// Formulaire de signature d'une petition
//

global $balise_FORMULAIRE_SIGNATURE_collecte;
$balise_FORMULAIRE_SIGNATURE_collecte = array('petition', 'id_article', 'nom_email', 'adresse_email', 'message', 'signature_nom_site', 'signature_url_site', 'url_page', 'val_confirm');

function balise_FORMULAIRE_SIGNATURE_stat($args, $filtres)
{
  return ($args[0] ? $args : '');
}

function balise_FORMULAIRE_SIGNATURE_dyn($texte, $id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm) {

	include_local(_FILE_CONNECT);
	if ($val_confirm)
		return reponse_confirmation($id_article);
	else if ($nom_email AND $adresse_email)
		return  reponse_signature($id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm);
	else {
		$row = spip_fetch_array(spip_query(&quot;SELECT * FROM spip_petitions WHERE id_article='$id_article'&quot;));
		return !$row ? '': array('formulaire_signature', 0, $row);
	}
}


// Retour a l'ecran du lien de confirmation d'une signature de petition.
// Si val_confirm est non vide, c'est l'appel en debut de inc-public
// pour vider le cache au demarrage afin que la nouvelle signature apparaisse.
// Sinon, c'est l'execution du formulaire et on retourne le message 
// de confirmation ou d'erreur construit lors de l'appel par inc-public.

function reponse_confirmation($id_article, $val_confirm = '') {
	static $confirm = '';

	if (!$val_confirm) return $confirm;
	include_local(_FILE_CONNECT);
	if ($GLOBALS['db_ok']) {
		include_ecrire(&quot;inc_texte.php3&quot;);
		include_ecrire(&quot;inc_filtres.php3&quot;);

		// Eviter les doublons
		$lock = &quot;petition $id_article $val_confirm&quot;;
		if (!spip_get_lock($lock, 5)) {
			$confirm= _T('form_pet_probleme_technique');
		}
		else {
			$query_sign = &quot;SELECT * FROM spip_signatures WHERE statut='&quot;.addslashes($val_confirm).&quot;'&quot;;
			$result_sign = spip_query($query_sign);
			if (spip_num_rows($result_sign) &gt; 0) {
				while($row = spip_fetch_array($result_sign)) {
					$id_signature = $row['id_signature'];
					$id_article = $row['id_article'];
					$date_time = $row['date_time'];
					$nom_email = $row['nom_email'];
					$adresse_email = $row['ad_email'];
					$nom_site = $row['nom_site'];
					$url_site = $row['url_site'];
					$message = $row['message'];
					$statut = $row['statut'];
				}
	
				$query_petition = &quot;SELECT * FROM spip_petitions WHERE id_article=$id_article&quot;;
				$result_petition = spip_query($query_petition);
	
				while ($row = spip_fetch_array($result_petition)) {
					$id_article = $row['id_article'];
					$email_unique = $row['email_unique'];
					$site_obli = $row['site_obli'];
					$site_unique = $row['site_unique'];
					$message_petition = $row['message'];
					$texte_petition = $row['texte'];
				}
	
				if ($email_unique == &quot;oui&quot;) {
					$email = addslashes($adresse_email);
					$query = &quot;SELECT * FROM spip_signatures WHERE id_article=$id_article AND ad_email='$email' AND statut='publie'&quot;;
					$result = spip_query($query);
					if (spip_num_rows($result) &gt; 0) {
						$confirm= (_T('form_pet_deja_signe'));
						$refus = &quot;oui&quot;;
					}
				}
	
				if ($site_unique == &quot;oui&quot;) {
					$site = addslashes($url_site);
					$query = &quot;SELECT * FROM spip_signatures WHERE id_article=$id_article AND url_site='$site' AND statut='publie'&quot;;
					$result = spip_query($query);
					if (spip_num_rows($result) &gt; 0) {
						$confirm= (_T('form_pet_deja_enregistre'));
						$refus = &quot;oui&quot;;
					}
				}
	
				if ($refus == &quot;oui&quot;) {
					$confirm= (_T('form_deja_inscrit'));
				}
				else {
					$query = &quot;UPDATE spip_signatures SET statut='publie' WHERE id_signature='$id_signature'&quot;;
					$result = spip_query($query);
					// invalider les pages ayant des boucles signatures
					include_ecrire('inc_invalideur.php3');
					include_ecrire('inc_meta.php3');
					suivre_invalideur(&quot;id='petition/petition'&quot;);
	
					$confirm= (_T('form_pet_signature_validee'));
				}
			}
			else {
				$confirm= (_T('form_pet_aucune_signature'));
			}
			spip_release_lock($lock);
		}
	}
	else {
		$confirm= _T('form_pet_probleme_technique');
	}
}

//
// Retour a l'ecran de la signature d'une petition
//

function reponse_signature($id_article, $nom_email, $adresse_email, $message, $nom_site, $url_site, $url_page, $val_confirm) {

	if ($GLOBALS['db_ok']) {
		include_ecrire(&quot;inc_texte.php3&quot;);
		include_ecrire(&quot;inc_filtres.php3&quot;);
		include_ecrire(&quot;inc_mail.php3&quot;);

		// Eviter les doublons
		$lock = &quot;petition $id_article $adresse_email&quot;;
		if (!spip_get_lock($lock, 5)) {
			return _T('form_pet_probleme_technique');
		} else {
			$query_petition = &quot;SELECT * FROM spip_petitions WHERE id_article=$id_article&quot;;
			$result_petition = spip_query($query_petition);
	
			while ($row = spip_fetch_array($result_petition)) {
				$id_article = $row['id_article'];
				$email_unique = $row['email_unique'];
				$site_obli = $row['site_obli'];
				$site_unique = $row['site_unique'];
				$message_petition = $row['message'];
				$texte_petition = $row['texte'];
			}
	
			if (strlen($nom_email) &lt; 2) {
				return (_T('form_indiquer_nom'));
			}
	
			if ($adresse_email == _T('info_mail_fournisseur')) {
				return (_T('form_indiquer_email'));
			}
	
			if ($email_unique == &quot;oui&quot;) {
				$email = addslashes($adresse_email);
				$query = &quot;SELECT * FROM spip_signatures WHERE id_article=$id_article AND ad_email='$email' AND statut='publie'&quot;;
				$result = spip_query($query);
				if (spip_num_rows($result) &gt; 0) {
					return (_T('form_pet_deja_signe'));
				}
			}
	
			if (!email_valide($adresse_email)) {
				return (_T('form_email_non_valide'));
			}
	
			if ($site_obli == &quot;oui&quot;) {
				if (!$nom_site) {
					return (_T('form_indiquer_nom_site'));
				}
				include_ecrire(&quot;inc_sites.php3&quot;);
	
				if (!recuperer_page($url_site)) {
					return (_T('form_pet_url_invalide'));
				}
			}
			if ($site_unique == &quot;oui&quot;) {
				$site = addslashes($url_site);
				$query = &quot;SELECT * FROM spip_signatures WHERE id_article=$id_article AND url_site='$site' AND (statut='publie' OR statut='poubelle')&quot;;
				$result = spip_query($query);
				if (spip_num_rows($result) &gt; 0) {
					return (_T('form_pet_site_deja_enregistre'));
				}
			}
	
			$passw = test_pass();
	
			if ($refus == &quot;oui&quot;) {
				return _T('form_pet_signature_pasprise');
			}
			else {
				$query_site = &quot;SELECT titre FROM spip_articles WHERE id_article=$id_article&quot;;
				$result_site = spip_query($query_site);
				while ($row = spip_fetch_array($result_site)) {
					$titre = $row['titre'];
				}

				$link = new Link($url_page);
				$link-&gt;addVar('val_confirm', $passw);
				$url = $link-&gt;getUrl(&quot;sp$id_article&quot;);
	
				$messagex = _T('form_pet_mail_confirmation', array('titre' =&gt; $titre, 'nom_email' =&gt; $nom_email, 'nom_site' =&gt; $nom_site, 'url_site' =&gt; $url_site, 'url' =&gt; $url));

				if (envoyer_mail($adresse_email, _T('form_pet_confirmation').&quot; &quot;.$titre, $messagex)) {

					$nom_email = addslashes($nom_email);
					$adresse_email = addslashes($adresse_email);
					$nom_site = addslashes($nom_site);
					$url_site = addslashes($url_site);
					$message = addslashes($message);
	
					spip_query(&quot;INSERT INTO spip_signatures (id_article, date_time, nom_email, ad_email, nom_site, url_site, message, statut) VALUES ('$id_article', NOW(), '$nom_email', '$adresse_email', '$nom_site', '$url_site', '$message', '$passw')&quot;);
					return _T('form_pet_envoi_mail_confirmation');
				}
				else {
					return _T('form_pet_probleme_technique');
				}
			}
			spip_release_lock($lock);
		}
	}
	else {
		return _T('form_pet_probleme_technique');
	}

}


function test_pass() {
	include_ecrire(&quot;inc_acces.php3&quot;);
	for (;;) {
		$passw = creer_pass_aleatoire();
		$query = &quot;SELECT statut FROM spip_signatures WHERE statut='$passw'&quot;;
		$result = spip_query($query);
		if (!spip_num_rows($result)) break;
	}
	return $passw;
}

?&gt;

--- NEW FILE: inc-criteres.php3 ---
&lt;?php

//
// Definition des {criteres} d'une boucle
//

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_CRITERES&quot;)) return;
define(&quot;_INC_CRITERES&quot;, &quot;1&quot;);


// {racine}
// <A HREF="http://www.spip.net/@racine">http://www.spip.net/@racine</A>
function critere_racine_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];

	if ($param != 'racine' OR $not)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$boucle-&gt;where[] = $boucle-&gt;id_table.&quot;.id_parent='0'&quot;;

}

// {exclus}
// <A HREF="http://www.spip.net/@exclus">http://www.spip.net/@exclus</A>
function critere_exclus_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	$id = $boucle-&gt;primary;

	if ($param != 'exclus' OR $not OR !$id)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$arg = calculer_argument_precedent($idb,$id, $boucles);
	$boucle-&gt;where[] = $boucle-&gt;id_table . '.' . $id.&quot;!='\&quot;.&quot; . $arg . &quot;.\&quot;'&quot;;

}

// {doublons} ou {unique}
// <A HREF="http://www.spip.net/@doublons">http://www.spip.net/@doublons</A>
function critere_doublons_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];

	if (!preg_match(&quot;/(doublons|unique)[[:space:]]*([a-z_0-9]*)/i&quot;,
	$param, $match))
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$boucle-&gt;doublons = $boucle-&gt;type_requete . $match[2];
	$boucle-&gt;where[] = '&quot; .' .
		&quot;calcul_mysql_in('&quot;.$boucle-&gt;id_table . '.' . $boucle-&gt;primary.&quot;', &quot;
		.'&quot;0&quot;.$doublons[\''.$boucle-&gt;doublons.&quot;'], 'NOT') . \&quot;&quot;;
}

// {lang_select}
// <A HREF="http://www.spip.net/@lang_select">http://www.spip.net/@lang_select</A>
function critere_lang_select_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	if (preg_match('/lang_select(=(oui|non))?$/i', $param, $match)) {
		if (!$lang_select = $match[2])
			$lang_select = 'oui';
		if ($not)
			$lang_select = ($lang_select=='oui')?'non':'oui';
		$boucle-&gt;lang_select = $lang_select;
	}
	else erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {debut_xxx}
// <A HREF="http://www.spip.net/@debut">http://www.spip.net/@debut</A>_
function critere_debut_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	if (ereg('^debut([-_a-zA-Z0-9]+),([0-9]*)$', $param, $match)) {
		$debut_lim = &quot;debut&quot;.$match[1];
		$boucle-&gt;limit =
			'intval($GLOBALS[&quot;'.$debut_lim.'&quot;]).&quot;,'.$match[2] .'&quot;' ;
	}
	else erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {recherche}
// <A HREF="http://www.spip.net/@recherche">http://www.spip.net/@recherche</A>
function critere_recherche_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];

	$table = $boucle-&gt;id_table;	#articles
	$id_table = 'id_'.preg_replace('/s$/', '', $table); 	#id_article

	// horrible hack du aux id_forum = spip_forum et id_article=spip_articleS
	// en fait il faudrait la fonction inverse de table_objet()
	$id = 'id_'.preg_replace('/s$/', '', $boucle-&gt;id_table);

	$boucle-&gt;select[] = $boucle-&gt;id_table . '.' . $boucle-&gt;primary; # pour postgres, neuneu ici
	$boucle-&gt;select[] = '$rech_select'; # pour les ... as points

	// et la recherche trouve
	$boucle-&gt;where[] = '$rech_where';
}

// {inverse}
// <A HREF="http://www.spip.net/@inverse">http://www.spip.net/@inverse</A>
function critere_inverse_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	// Classement par ordre inverse
	if ($param == 'inverse' AND !$not) {
		if ($boucle-&gt;order)
			$boucle-&gt;order .= &quot;.' DESC'&quot;;
		else 
			erreur_squelette(_L(&quot;inversion d'un ordre inexistant&quot;), 
			&quot;BOUCLE&quot; . $idb);
	} else
		erreur_squelette(_T('info_erreur_squelette'), &quot;{$param} BOUCLE$idb&quot;);
}

// {traduction}
// <A HREF="http://www.spip.net/@traduction">http://www.spip.net/@traduction</A>
//   (id_trad&gt;0 AND id_trad=id_trad(precedent))
//    OR id_article=id_article(precedent)
function critere_traduction_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	if ($param == 'traduction') {
		$boucle-&gt;where[] = &quot;((&quot;.$boucle-&gt;id_table.&quot;.id_trad &gt; 0 AND &quot;
			. $boucle-&gt;id_table.&quot;.id_trad ='\&quot;.&quot;
			. calculer_argument_precedent($idb, 'id_trad',
				$boucles)
			. &quot;.\&quot;')
		OR
			(&quot; . $boucle-&gt;id_table.&quot;.&quot;.$boucle-&gt;primary.&quot; ='\&quot;.&quot;
			. calculer_argument_precedent($idb, $boucle-&gt;primary,
				$boucles)
			. &quot;.\&quot;'))&quot;;
	} else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}

// {origine_traduction}
// <A HREF="http://www.spip.net/@origine_traduction">http://www.spip.net/@origine_traduction</A>
function critere_origine_traduction_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	if ($param == 'origine_traduction')
		$boucle-&gt;where[] = $boucle-&gt;id_table.&quot;.id_trad = &quot;
		. $boucle-&gt;id_table . '.' . $boucle-&gt;primary;
	else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}


// {meme_parent}
// <A HREF="http://www.spip.net/@meme_parent">http://www.spip.net/@meme_parent</A>
function critere_meme_parent_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	if ($param != 'meme_parent')
		erreur_squelette(_T('info_erreur_squelette'), $param);
	else {
		if ($boucle-&gt;type_requete == 'rubriques') {
			$boucle-&gt;where[] = $boucle-&gt;id_table.&quot;.id_parent='\&quot;.&quot;
			. calculer_argument_precedent($idb, 'id_parent',
			$boucles)
			. &quot;.\&quot;'&quot;;
		} else if ($boucle-&gt;type_requete == 'forums') {
			$boucle-&gt;where[] = $boucle-&gt;id_table.&quot;.id_parent='\&quot;.&quot;
			. calculer_argument_precedent($idb, 'id_parent',
			$boucles)
			. &quot;.\&quot;'&quot;;
			$boucle-&gt;where[] = $boucle-&gt;id_table.&quot;.id_parent &gt; 0&quot;;
			$boucle-&gt;plat = true;
		} else
			erreur_squelette(_L(&quot;{meme_parent} ne s'applique qu'aux boucles (FORUMS) ou (RUBRIQUES)&quot;), &quot;BOUCLE&quot; . $idb);
	}
}

// {branche ?}
// <A HREF="http://www.spip.net/@branche">http://www.spip.net/@branche</A>
function critere_branche_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	if (preg_match('/branche[[:space:]]*([?])?$/i', $param, $regs)) {
		$c = &quot;calcul_mysql_in('&quot;.$boucle-&gt;id_table.&quot;.id_rubrique',
		calcul_branche(&quot; . calculer_argument_precedent($idb,
		'id_rubrique', $boucles) . &quot;), '')&quot;;
		if (!$regs[1])
			$where = &quot;\&quot;. $c .\&quot;&quot; ;
		else
			$where = &quot;\&quot;.(&quot;
			. calculer_argument_precedent($idb, 'id_rubrique',
			$boucles).&quot;? $c : 1).\&quot;&quot;;

		if ($not)
			$boucle-&gt;where[] = &quot;NOT($where)&quot;;
		else
			$boucle-&gt;where[] = $where;
	} else
		erreur_squelette(_T('info_erreur_squelette'), $param);
}

// Tri : {par xxxx}
// <A HREF="http://www.spip.net/@par">http://www.spip.net/@par</A>
function critere_par_dist($idb, &amp;$boucles, $param, $not) {
	$boucle = &amp;$boucles[$idb];
	if ($not)
		erreur_squelette(_T('info_erreur_squelette'), $param);

	$param = substr($param,3);

	while ($param) {
	  spip_log($param);
		preg_match('/[[:space:]]*([^,]*)[[:space:]]*,?(.*)/ims',
			   $param, $regs);
		$param = $regs[2];
		$tri = trim($regs[1]);

	// par hasard
		if ($tri == 'hasard') {
		// tester si cette version de MySQL accepte la commande RAND()
		// sinon faire un gloubi-boulga maison avec de la mayonnaise.
		  if (spip_query(&quot;SELECT RAND()&quot;))
			$boucle-&gt;select[] = &quot;RAND() AS alea&quot;;
		  else
			$boucle-&gt;select[] = &quot;MOD(&quot;.$boucle-&gt;id_table.'.'.$boucle-&gt;primary
			.&quot; * UNIX_TIMESTAMP(),32767) &amp; UNIX_TIMESTAMP() AS alea&quot;;

		$order = &quot;'alea'&quot;;
		}

	// par titre_mot
		else if ($tri == 'titre_mot') {
		  $order= &quot;'mots.titre'&quot;;
		}

	// par type_mot
		else if ($tri == 'type_mot'){
		  $order= &quot;'mots.type'&quot;;
		}
	// par num champ(, suite)
		else if (ereg(&quot;^num[[:space:]]+(.*)$&quot;,$tri, $match2)) {
		  $boucle-&gt;select[] = &quot;0+&quot;.$boucle-&gt;id_table.&quot;.&quot;.$match2[1].&quot; AS num&quot;;
		  $order = &quot;'num'&quot;;
	}
	// par champ. Verifier qu'ils sont presents.
		else if (ereg(&quot;^[a-z][a-z0-9]*$&quot;, $tri)) {
		  if ($tri == 'date')
		    $order = &quot;'&quot;.$boucle-&gt;id_table.&quot;.&quot;.
		      $GLOBALS['table_date'][$boucle-&gt;type_requete]
		      .&quot;'&quot;;
		  else {
			global $table_des_tables, $tables_des_serveurs_sql;
			$r = $boucle-&gt;type_requete;
			$s = $boucles[$idb]-&gt;sql_serveur;
			if (!$s) $s = 'localhost';
			$t = $table_des_tables[$r];
			if (!$t) $t = $r; // pour les tables non Spip
			$desc = $tables_des_serveurs_sql[$s][$t];
			if ($desc['field'][$tri])
				$order = &quot;'&quot;.$boucle-&gt;id_table.&quot;.&quot;.$tri.&quot;'&quot;;
			else {
			  // tri sur les champs synthetises (cf points)
				$order = &quot;'&quot;.$tri.&quot;'&quot;;
			}
		  }
		}
	// tris specifies par l'URL ?
		else {
		  $order = simplifie_param_dynamique($tri, $boucles, $idb);
		  if ($order == $tri) $order = &quot;'&quot; . $order . &quot;'&quot;;
		}
	// au final, gestion des tris multiples
		if ($order) {
		  if ($boucle-&gt;order) $boucle-&gt;order .= '.&quot;,&quot;.';
		  $boucle-&gt;order .= $order;

		}
	}
}



function calculer_critere_parties($idb, &amp;$boucles, $param, $not, $match) {
  global $tables_relations, $table_des_tables, $table_date, $tables_des_serveurs_sql;
	$boucle = &amp;$boucles[$idb];
	list(,$a1,$op,$a2) = $match;
	list($a11,$a12) = calculer_critere_parties_aux($idb, $boucles, $a1);
	list($a21,$a22) = calculer_critere_parties_aux($idb, $boucles, $a2);

	if (($op== ',')&amp;&amp;(is_numeric($a11) &amp;&amp; (is_numeric($a21))))
		$boucle-&gt;limit = $a11 .',' . $a21;
	else {
	  $boucle-&gt;partie =	($a11 != 'n') ? $a11 : $a12;
		$boucle-&gt;total_parties =  ($a21 != 'n') ? $a21 : $a22;
		$boucle-&gt;mode_partie = (($op == '/') ? '/' :
				(($a1=='n')?'-':'+').(($a2=='n')?'-':'+'));
	}
}

function calculer_critere_parties_aux($idb, &amp;$boucles, $param) {
	ereg('^(([0-9]+)|n|(#.*))(-([0-9]+))?$', $param, $m);
	if ($m[1] == 'n') 
	  $a = 'n';
	else {
	  $a = simplifie_param_dynamique($m[1], $boucles, $idb);
	}
	return array($a, ($m[5] ? $m[5] : 0));
}

//
// La fonction d'aiguillage sur le nom du criteres
//

function calculer_criteres ($idb, &amp;$boucles) {

	foreach($boucles[$idb]-&gt;param as $param) {
		// Analyse du critere
		preg_match(&quot;/^([!]?)[[:space:]]*(debut|([a-z_]+))/ism&quot;,
			$param, $match);
		$critere = $match[2];
		$not = ($match[1] == '!');

		// critere personnalise ?
		$f = &quot;critere_&quot;.$critere;
		if (!function_exists($f))
			$f .= '_dist';

		// fonction critere standard ?
		if (!function_exists($f))
			$f = 'calculer_critere_DEFAUT';

		// Applique le critere
		$res = $f($idb, $boucles, $param, $not);

		// gestion d'erreur
		if (is_array($res)) erreur_squelette($res);
	}
}

# Criteres numeriques et de comparaison

function calculer_critere_DEFAUT($idb, &amp;$boucles, $param, $not) {
	global $table_des_tables, $table_date, $tables_des_serveurs_sql;

	$boucle = &amp;$boucles[$idb];
	$type = $boucle-&gt;type_requete;
	$id_table = $boucle-&gt;id_table;
	$primary = $boucle-&gt;primary;
	$id_field = $id_table . '.' . $primary; 

	if (ereg('^([0-9a-zA-Z#_\{\}]+)([,/])([0-9a-zA-Z#_\{\}]+)$', $param, $match))
	  calculer_critere_parties($idb, $boucles, $param, $not, $match);

		// Restriction de valeurs (implicite ou explicite)
	else if (eregi('^([a-z_]+\(?[a-z_]*\)?) *(\??)((!?)(&lt;=?|&gt;=?|==?|IN) *&quot;?([^&lt;&gt;=!&quot;]*))?&quot;?$', $param, $match)) {
	  		$op = $match[5] ? $match[5] : '=';
			// Variable comparee
			$col = $match[1];
			// fonction SQL
			$fct = '';
			if (ereg(&quot;([a-z_]+)\(([a-z_]+)\)&quot;, $col,$match3)) {
				$col = $match3[2];
				$fct = $match3[1];
			}
			$col_table = $id_table;
			// Valeur de comparaison
			if ($match[3]) {
				if (strtoupper($op) != 'IN') {
					$val = calculer_param_dynamique($match[6], $boucles, $idb);
					// gestion d'erreur
					if (is_array($val)) erreur_squelette($val);
				}
				else {
				// traitement special des valeurs textuelles
				  $val = calculer_params_dynamiques($match[6], $boucles, $idb);
				}
			}
			
			else {
				$val = $match[1];

				// Cas special {lang} : aller chercher $GLOBALS['spip_lang']
				if ($val == 'lang')
					$val = '&quot;.$GLOBALS[\'spip_lang\'].&quot;';
				else {
				// Si id_parent, comparer l'id_parent avec l'id_objet
				// de la boucle superieure
					if ($val == 'id_parent')
						$val = $primary;
				// Si id_enfant, comparer l'id_objet avec l'id_parent
				// de la boucle superieure
					else if ($val == 'id_enfant')
						$val = 'id_parent';
					$val = calculer_argument_precedent($idb, $val, $boucles) ;
					if (ereg('^\$',$val))
						$val = '&quot; . addslashes(' . $val . ') . &quot;';
					else
						$val = addslashes($val);
				}

			}

			if ($s = calculer_critere_externe($boucle, $id_field,$col, $type))
				$col_table = $s;

			// Cas particulier pour les raccourcis 'type_mot' et 'titre_mot'
			else if ($type != 'mots'
			AND ($col == 'type_mot' OR $col == 'titre_mot'
			OR $col == 'id_groupe')) {
				if ($type == 'forums')
					$col_lien = &quot;forum&quot;;
				else if ($type == 'syndication')
					$col_lien = &quot;syndic&quot;;
				else
					$col_lien = $type;
				$boucle-&gt;from[] = &quot;mots_$col_lien AS lien_mot&quot;;
				$boucle-&gt;from[] = 'mots AS mots';
				$boucle-&gt;where[] = &quot;$id_field=lien_mot.&quot; . $primary;
				$boucle-&gt;where[] = 'lien_mot.id_mot=mots.id_mot';
				$boucle-&gt;group = $id_field;
				$boucle-&gt;select[] = $id_field; # pour postgres, neuneu ici
				$col_table = 'mots';

				$boucle-&gt;lien = true;
				if ($col == 'type_mot')
					$col = 'type';
				else if ($col == 'titre_mot')
					$col = 'titre';
				else if ($col == 'id_groupe')
					$col = 'id_groupe';
			}

			// Cas particulier : selection des documents selon l'extension
			if ($type == 'documents' AND $col == 'extension')
				$col_table = 'types_documents';
			// HACK : selection des documents selon mode 'image'
			// (a creer en dur dans la base)
			else if ($type == 'documents' AND $col == 'mode'
			AND $val == 'image')
				$val = 'vignette';
			// Cas particulier : lier les articles syndiques
			// au site correspondant
			else if ($type == 'syndic_articles' AND
			!ereg(&quot;^(id_syndic_article|titre|url|date|descriptif|lesauteurs)$&quot;,$col))
				$col_table = 'syndic';

			// Cas particulier : id_enfant =&gt; utiliser la colonne id_objet
			if ($col == 'id_enfant')
				$col = $primary;
			// Cas particulier : id_secteur = id_rubrique pour certaines tables
			if (($type == 'breves' OR $type == 'forums') AND $col == 'id_secteur')
				$col = 'id_rubrique';

			// Cas particulier : expressions de date
			if (ereg(&quot;^(date|mois|annee|age|age_relatif|jour_relatif|mois_relatif|annee_relatif)(_redac)?$&quot;, $col, $regs)) {
				$col = $regs[1];
				if ($regs[2]) {
					$date_orig = $id_table . &quot;.date_redac&quot;;
					$date_compare = '\'&quot; . normaliser_date(' .
					calculer_argument_precedent($idb, 'date_redac', $boucles) .
					') . &quot;\'';
				}
				else {
					$date_orig = &quot;$id_table.&quot; . $table_date[$type];
					$date_compare = '\'&quot; . normaliser_date(' .
					  calculer_argument_precedent($idb, 'date', $boucles) .
					  ') . &quot;\'';
				}

				if ($col == 'date') {
					$col = $date_orig;
					$col_table = '';
				}
				else if ($col == 'mois') {
					$col = &quot;MONTH($date_orig)&quot;;
					$col_table = '';
				}
				else if ($col == 'annee') {
					$col = &quot;YEAR($date_orig)&quot;;
					$col_table = '';
				}
				else if ($col == 'age') {
					$col = calculer_param_date(&quot;now()&quot;, $date_orig);
					$col_table = '';
				}
				else if ($col == 'age_relatif') {
					$col = calculer_param_date($date_compare, $date_orig);
					$col_table = '';
				}
				else if ($col == 'jour_relatif') {
					$col = &quot;LEAST(TO_DAYS(&quot; .$date_compare . &quot;)-TO_DAYS(&quot; .
					$date_orig . &quot;), DAYOFMONTH(&quot; . $date_compare .
					&quot;)-DAYOFMONTH(&quot; . $date_orig . &quot;)+30.4368*(MONTH(&quot; .
					$date_compare . &quot;)-MONTH(&quot; . $date_orig .
					&quot;))+365.2422*(YEAR(&quot; . $date_compare . &quot;)-YEAR(&quot; .
					$date_orig . &quot;)))&quot;;
					$col_table = '';
				}
				else if ($col == 'mois_relatif') {
					$col = &quot;MONTH(&quot; . $date_compare . &quot;)-MONTH(&quot; .
					$date_orig . &quot;)+12*(YEAR(&quot; . $date_compare .
					&quot;)-YEAR(&quot; . $date_orig . &quot;))&quot;;
					$col_table = '';
				}
				else if ($col == 'annee_relatif') {
					$col = &quot;YEAR(&quot; . $date_compare . &quot;)-YEAR(&quot; .
					$date_orig . &quot;)&quot;;
					$col_table = '';
				}
			}

			if ($type == 'forums' AND
			($col == 'id_parent' OR $col == 'id_forum'))
				$boucle-&gt;plat = true;

			// Operateur de comparaison
			if ($col_table)
				$col = &quot;$col_table.$col&quot;;

			if (strtoupper($op) == 'IN') {
				// traitement special des valeurs textuelles
				$where = &quot;$col IN ($val)&quot;;
				if ($match[4] == '!') {
					$where = &quot;NOT ($where)&quot;;
				} else {
					if (!$boucle-&gt;order) {
						$boucle-&gt;order = 'rang';
						$boucle-&gt;select[] =
						&quot;FIND_IN_SET($col, \\\&quot;$val\\\&quot;) AS rang&quot;;
					}
				}
			} else {
				if ($op == '==') $op = 'REGEXP';
				if ($fct) $col = &quot;$fct($col)&quot;;
				if ($match[4] == '!')
					$where = &quot;NOT ($col $op '$val')&quot;;
				else
					$where = &quot;($col $op '$val')&quot;;

				// operateur optionnel {lang?}
				if ($match[2]) {
					$champ = calculer_argument_precedent($idb, $match[1], $boucles) ;
					$where = &quot;\&quot;.($champ ? \&quot;$where\&quot; : 1).\&quot;&quot;;
				}

			}
			$boucle-&gt;where[] = $where;
	} // fin du if sur les restrictions de valeurs
	else erreur_squelette(_L(&quot;critere inconnu $param&quot;));
}

// traitement des relations externes par une jointure.
// tant qu'a faire eviter de dupliquer sa declaration,
// mais c'est une goutte d'eau dans la mer

function calculer_critere_externe(&amp;$boucle, $id_field, $col, $type)
{
	global $tables_relations;
	if ($col_table =  $tables_relations[$type][$col]) {
		$externe = &quot;$id_field=$col_table.&quot; . $boucle-&gt;primary;
		if (!$boucle-&gt;where || (!in_array($externe, $boucle-&gt;where))) {

			$boucle-&gt;lien = true;
			$boucle-&gt;from[] = &quot;$col_table AS $col_table&quot;;
			$boucle-&gt;where[] = $externe;
			$boucle-&gt;group = $id_field;
		// postgres exige que le champ pour GROUP soit dans le SELECT
			$boucle-&gt;select[] = $id_field;
		}
	}
	return $col_table;
}


function calculer_param_date($date_compare, $date_orig) {
	return
	&quot;LEAST((UNIX_TIMESTAMP(&quot; .
	$date_compare .
	&quot;)-UNIX_TIMESTAMP(&quot; .
	$date_orig .
	&quot;))/86400,\n\tTO_DAYS(&quot; .
	$date_compare .
	&quot;)-TO_DAYS(&quot; .
	$date_orig .
	&quot;),\n\tDAYOFMONTH(&quot; .
	$date_compare .
	&quot;)-DAYOFMONTH(&quot; .
	$date_orig .
	&quot;)+30.4368*(MONTH(&quot; .
	$date_compare .
	&quot;)-MONTH(&quot; .
	$date_orig .
	&quot;))+365.2422*(YEAR(&quot; .
	$date_compare .
	&quot;)-YEAR(&quot; .
	$date_orig .
	&quot;)))&quot;;
}

//
// Calculer les parametres
//
function calculer_param_dynamique($val, &amp;$boucles, $idb) {
#	if (ereg('^ *\((.*)) *$', $val, $m)) $val = $m[1]; # si on veut (#...)
	if (ereg(NOM_DE_CHAMP . &quot;(\{[^}]*\})?&quot;, $val, $regs)) {
	  	$champ = new Champ;
		$champ-&gt;nom_boucle = $regs[2];
		$champ-&gt;nom_champ = $regs[3];
		$champ-&gt;etoile = $regs[4];
		$champ-&gt;fonctions = $regs[5] ? array($regs[5]) : '';
		$champ-&gt;id_boucle = $boucles[$idb]-&gt;id_parent;
		$champ-&gt;boucles = &amp;$boucles;
		$champ-&gt;id_mere = $idb;
		$champ = calculer_champ($champ);
		return '&quot; . addslashes(' . $champ . ') . &quot;';

	} else {
	  if ($val[0]== '%') {
	    spip_log($val .
		     &quot; est obsolete; utiliser HTTP_VARS{&quot; .  substr($val,1) . &quot;}&quot;);
		  return '&quot; . addslashes($Pile[0][\''. substr($val,1)  .&quot;']) . \&quot;&quot;;
	  }
		else
		  return addslashes($val);
	}
}

function calculer_params_dynamiques($liste, &amp;$boucles, $idb) {
	ereg(&quot;^ *\(?(.*[^)])\)? *$&quot;,$liste, $reg);
	$res = array();
	foreach (split(&quot; *, *&quot;, $reg[1]) as $v) {
	  $v = calculer_param_dynamique($v, $boucles, $idb);
	  if (is_array($v)) erreur_squelette($v);
	  if (strpos('0123456789',$v[0]) !== false)
	    $res[] = $v;
	  else if ($v[0]=='&quot;')
	    $res[] = &quot;'&quot; . $v . &quot;'&quot;;
	  else
	    $res[] = &quot;'$v'&quot;;
	}
	return join(',', $res);
}

function simplifie_param_dynamique($val, &amp;$boucles, $idb)
{
	$a = calculer_param_dynamique($val, $boucles, $idb);
	if (!ereg('&quot; \. *(.*)\. &quot;', $a, $m)) return $a;
	return $m[1];
}	
?&gt;

--- NEW FILE: inc-public-global.php3 ---
&lt;?php

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_PUBLIC_GLOBAL&quot;)) return;
define(&quot;_INC_PUBLIC_GLOBAL&quot;, &quot;1&quot;);

//
// Aller chercher la page dans le cache ou pas
//
function obtenir_page ($contexte, $chemin_cache, $delais, &amp;$use_cache, $fond, $inclusion=false) {
	global $lastmodified;

	if (!$use_cache) {
		include_local('inc-calcul.php3');

		// page globale ? calculer le contexte
		if (!$contexte)
			$contexte = calculer_contexte();

		spip_timer('calculer_page');
		$page = calculer_page($chemin_cache,
			array('fond' =&gt; $fond,
				'contexte' =&gt; $contexte),
			$delais,
			$inclusion);

		$lastmodified = time();

		// log
		if (!$log = $chemin_cache) $log = &quot;($fond, delais=$delais, &quot;
		. $GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'].&quot;)&quot;;
		spip_log (($inclusion ? 'calcul inclus':'calcul').' ('
		.spip_timer('calculer_page').&quot;): $log&quot;);

		// Nouveau cache : creer un invalideur 't' fixant la date
		// d'expiration et la taille du fichier
		if (@file_exists($chemin_cache)) {
			// Ici on ajoute 3600s pour eviter toute concurrence
			// entre un invalideur et un appel public de page
			$bedtime = time() + $delais + 3600;
			$taille = @filesize($chemin_cache);
			$fichier = addslashes($chemin_cache);
			spip_query(&quot;INSERT IGNORE INTO spip_caches (fichier,id,type,taille)
			VALUES ('$fichier','$bedtime','t','$taille')&quot;);
		}

	} else {

		//
		// Lire le fichier cache
		//
		lire_fichier ($chemin_cache, $page['texte']);
		$lastmodified = max($lastmodified, @filemtime($chemin_cache));
		# spip_log (&quot;cache $chemin_cache $lastmodified&quot;);

		//
		// Lire sa carte d'identite &amp; fixer le contexte global
		//
		if (preg_match(&quot;/^&lt;!-- ([^\n]*) --&gt;\n(.*)/ms&quot;, $page['texte'], $match)
		AND is_array($meta_donnees = unserialize($match[1]))) {
			foreach ($meta_donnees as $var=&gt;$val)
				$page[$var] = $val;

			$page['texte'] = $match[2];

			// Remplir les globals pour les boutons d'admin
			if (!$inclusion AND is_array($page['contexte']))
				foreach ($page['contexte'] as $var=&gt;$val)
					$GLOBALS[$var] = $val;
		}

	}

	return $page;
}


//
// Appeler cette fonction pour obtenir la page principale
//
function afficher_page_globale ($fond, $delais, &amp;$use_cache) {
	global $flag_preserver, $flag_dynamique, $lastmodified;
	global $var_preview, $var_mode;
	include_local (&quot;inc-cache.php3&quot;);

	// demande de previsualisation ?
	// -&gt; inc-calcul.php3 n'enregistrera pas les fichiers caches
	// -&gt; inc-reqsql-squel.php3 acceptera les objets non 'publie'
	if ($var_preview == 'oui') {
		// Verifier qu'on a le droit de previsualisation
		$statut = $GLOBALS['auteur_session']['statut'];
		if ($statut=='0minirezo' OR
		(lire_meta('preview')=='1comite' AND $statut=='1comite')) {
			$var_mode = 'recalcul';
			$delais = 0;
			$var_preview = true;
			spip_log('preview !');
		}
	}

	// Faut-il effacer des pages invalidees ?
	if (lire_meta('invalider')) {
		include_ecrire('inc_meta.php3');
		lire_metas();
		if (lire_meta('invalider'))
			retire_caches();
	}

	// Calculer le chemin putatif du cache
	$chemin_cache = generer_nom_fichier_cache('', $fond);

	// Peut-on utiliser un fichier cache ?
	determiner_cache($delais, $use_cache, $chemin_cache);

	// Repondre gentiment aux requetes sympas
	// (ici on ne tient pas compte d'une obsolence du cache ou des
	// eventuels fichiers inclus modifies depuis la date
	// HTTP_IF_MODIFIED_SINCE du client)
	if ($GLOBALS['HTTP_IF_MODIFIED_SINCE'] AND !$var_mode
	AND $chemin_cache AND !$flag_dynamique) {
		$lastmodified = @filemtime($chemin_cache);
		$headers_only = http_last_modified($lastmodified);
	}
	$headers_only |= ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] == 'HEAD');

	if ($headers_only) {
		if ($chemin_cache)
			$t = @filemtime($chemin_cache);
		else
			$t = time();
		@header('Last-Modified: '.http_gmoddate($t).' GMT');
		@header('Connection: close');
		// Pas de bouton admin pour un HEAD
		$flag_preserver = true;
	}
	else {
		// Obtenir la page
		$page = obtenir_page ('', $chemin_cache, $delais, $use_cache,
		$fond, false);
		if (!$flag_preserver) {
		// Entete content-type: xml ou html ; charset
			if ($xhtml) {
			// Si Mozilla et tidy actif, passer en &quot;application/xhtml+xml&quot;
			// extremement risque: Mozilla passe en mode debugueur strict
			// mais permet d'afficher du MathML directement dans le texte
			// (et sauf erreur, c'est la bonne facon de declarer du xhtml)
				include_ecrire(&quot;inc_tidy.php&quot;);
				if (version_tidy() &gt; 0) {
					if (ereg(&quot;application/xhtml\+xml&quot;, $GLOBALS['HTTP_ACCEPT'])) 
						@header(&quot;Content-Type: application/xhtml+xml; charset=&quot;.lire_meta('charset'));
					else 
						@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
					echo '&lt;'.'?xml version=&quot;1.0&quot; encoding=&quot;'. lire_meta('charset').'&quot;?'.&quot;&gt;\n&quot;;
				} else {
					@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
				}
			} else {
				@header(&quot;Content-Type: text/html; charset=&quot;.lire_meta('charset'));
			}
		}
	}

	if ($chemin_cache) $page['cache'] = $chemin_cache;

	if ($var_preview AND !$flag_preserver) {
		$url = $GLOBALS['clean_link'];
		$url-&gt;delvar('var_preview');
		$url = $url-&gt;geturl();
		include_ecrire('inc_lang.php3');
		lang_select($GLOBALS['auteur_session']['lang']);
		$page['texte'] .= '&lt;div style=&quot;
		display: block;
		color: #eeeeee;
		background-color: #111111;
		padding-right: 5px;
		padding-top: 2px;
		padding-bottom: 5px;
		font-size: 20px;
		top: 0px;
		left: 0px;
		position: absolute;
		&quot;&gt;&lt;a href=&quot;'.$url.'&quot;&gt;&lt;img src=&quot;' . _DIR_IMG_PACK . 'naviguer-site.png&quot; align=&quot;left&quot; border=&quot;0&quot; /&gt;&lt;/a&gt;
&nbsp; '.majuscules(_T('previsualisation')).'&lt;/div&gt;';
	}

	return $page;
}


function terminer_public_global() {

	// Mise a jour des fichiers langues de l'espace public
	if ($GLOBALS['cache_lang_modifs']) {
		include_ecrire('inc_lang.php3');
		ecrire_caches_langues();
	}

	// Gestion des statistiques du site public

	if (lire_meta(&quot;activer_statistiques&quot;) != &quot;non&quot;) {
		include_local (&quot;inc-stats.php3&quot;);
		ecrire_stats();
	}

	// Effectuer une tache de fond ?
	cron();
}

// Cette fonction sert au dernier ob_start() de inc-public : elle
// va absorber les eventuels messages d'erreur de inc_cron(), permettant
// de ne pas planter le content-length qu'on a annonce ; decommenter la ligne
// pour afficher les bugs
function masquer_les_bugs ($bugs) {
	# return $bugs;
}

function inclure_page($fond, $delais_inclus, $contexte_inclus, $cache_incluant='') {

	$contexte_inclus['fond'] = $fond;

	$chemin_cache = generer_nom_fichier_cache($contexte_inclus, $fond);

	// Peut-on utiliser un fichier cache ?
	determiner_cache($delais_inclus, $use_cache, $chemin_cache);

	// Si on a inclus sans fixer le critere de lang, de deux choses l'une :
	// - on est dans la langue du site, et pas besoin d'inclure inc_lang
	// - on n'y est pas, et alors il faut revenir dans la langue par defaut
	if (($lang = $contexte_inclus['lang'])
	|| ($GLOBALS['spip_lang'] != ($lang = lire_meta('langue_site')))) {
		include_ecrire('inc_lang.php3');
		lang_select($lang);
		$lang_select = true; // pour lang_dselect en sortie
	}

	$page = obtenir_page ($contexte_inclus, $chemin_cache, $delais_inclus,
	$use_cache, $fond, true);

	$page['lang_select'] = $lang_select;

	// Retourner le contenu...
	return $page;
}

# les balises dynamiques sont traitees comme des inclusions
# Attention, un appel explicite a cette fonction suppose certains include
# (voir l'exemple de spip_inscription et spip_pass)

function inclure_balise_dynamique($r) {
	if (is_string($r))
		echo $r;
	else {
		list($fond, $delais, $contexte_inclus) = $r;
		if ((!$contexte_inclus['lang']) AND
		($GLOBALS['spip_lang'] != lire_meta('langue_site')))
			$contexte_inclus['lang'] = $GLOBALS['spip_lang']; 
		$page = inclure_page($fond, $delais, $contexte_inclus);
		if ($page['process_ins'] == 'html')
			echo $page['texte'];
		else
			eval('?' . '&gt;' . $page['texte']);
		
		if ($page['lang_select'])
			lang_dselect();
	}
}
?&gt;

--- NEW FILE: login-dist.html ---
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
&lt;html lang=&quot;#LANG&quot;&gt;
&lt;head&gt;
	&lt;title&gt;&lt;:login_acces_prive:&gt;&lt;/title&gt;
	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#CHARSET&quot;&gt;
	&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style.css&quot; type=&quot;text/css&quot;&gt;
&lt;/head&gt;
&lt;body dir=&quot;#LANG_DIR&quot; bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot; link=&quot;#e86519&quot; vlink=&quot;#6e003a&quot; alink=&quot;#ff9900&quot;&gt;

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;center&gt;&lt;table width=&quot;400&quot;&gt;&lt;tr&gt;&lt;td width=&quot;400&quot;&gt;
&lt;div align=&quot;center&quot;&gt;
&lt;h3 class=&quot;spip&quot;&gt;#NOM_SITE_SPIP&lt;br&gt;
&lt;small&gt;&lt;:login_acces_prive:&gt;&lt;/small&gt;&lt;/h3&gt;
&lt;div align=&quot;#LANG_RIGHT&quot;&gt;#MENU_LANG_ECRIRE&lt;/div&gt;
&lt;/div&gt;
#LOGIN_PRIVE
	&lt;div align=&quot;center&quot;&gt;[&#91;&lt;a
		href='(#URL_SITE_SPIP|inscriptionok{redac})/spip_inscription.php3?mode=redac&amp;focus=nom_inscription&amp;target=spip_pass'
		target=&quot;spip_pass&quot;
		onclick=&quot;javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=500'); return false;&quot;&gt;&lt;:login_sinscrire:&gt;&lt;/a&gt;&#93;]&#91;&lt;a
		href=&quot;spip_pass.php3&quot;
		target=&quot;spip_pass&quot; 
		onclick=&quot;javascript:window.open(this.href, 'spip_pass', 'scrollbars=yes, resizable=yes, width=480, height=280'); return false;&quot;&gt;&lt;:login_motpasseoublie:&gt;&lt;/a&gt;&#93;&#91;&lt;a 
		href='#URL_SITE_SPIP'&gt;&lt;:login_retoursitepublic:&gt;&lt;/a&gt;&amp;#93
	      &lt;/div&gt;

&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;

&lt;/body&gt;
&lt;/html&gt;

--- NEW FILE: inc-urls-propres.php3 ---
&lt;?php

// executer une seule fois
if (defined(&quot;_INC_URLS2&quot;)) return;
define(&quot;_INC_URLS2&quot;, &quot;1&quot;);


/*

- Comment utiliser ce jeu d'URLs ?

Il faut recopier le fichier htaccess-propre.txt sous le nom .htaccess
dans le repertoire de base du site SPIP (attention a ne pas ecraser
d'autres reglages que vous pourriez avoir mis dans ce fichier)

*/


function _generer_url_propre($type, $id_objet) {
	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
	$col_id = &quot;id_&quot;.$type;

	// D'abord, essayer de recuperer l'URL existante si possible
	$query = &quot;SELECT url_propre, titre FROM $table WHERE $col_id=$id_objet&quot;;
	$result = spip_query($query);
	if (!($row = spip_fetch_array($result))) return &quot;&quot;;
	if ($row['url_propre']) return $row['url_propre'];

	// Sinon, creer l'URL
	include_ecrire(&quot;inc_filtres.php3&quot;);
	include_ecrire(&quot;inc_charsets.php3&quot;);
	$url = translitteration(corriger_caracteres(supprimer_tags(supprimer_numero($row['titre']))));
	$url = @preg_replace(',[[:punct:][:space:]]+,u', ' ', $url);
	// S'il reste des caracteres non latins, utiliser l'id a la place
	if (preg_match(&quot;,[^a-zA-Z0-9 ],&quot;, $url)) {
		$url = $type.$id_objet;
	}
	else {
		$mots = explode(' ', $url);
		$url = '';
		foreach ($mots as $mot) {
			if (!$mot) continue;
			$url2 = $url.'-'.$mot;
			if (strlen($url2) &gt; 35) {
				break;
			}
			$url = $url2;
		}
		$url = substr($url, 1);
		//echo &quot;$url&lt;br&gt;&quot;;
		if (strlen($url) &lt; 2) $url = $type.$id_objet;
	}

	// Verifier les eventuels doublons et mettre a jour
	$lock = &quot;url $type $id_objet&quot;;
	spip_get_lock($lock, 10);
	$query = &quot;SELECT $col_id FROM $table WHERE url_propre='&quot;.addslashes($url).&quot;'&quot;;
	if (spip_num_rows(spip_query($query)) &gt; 0) {
		$url = $url.','.$id_objet;
	}
	$query = &quot;UPDATE $table SET url_propre='&quot;.addslashes($url).&quot;' WHERE $col_id=$id_objet&quot;;
	spip_query($query);
	spip_release_lock($lock);

	return $url;
}

function generer_url_article($id_article) {
	$url = _generer_url_propre('article', $id_article);
	if (!$url) $url = &quot;article.php3?id_article=$id_article&quot;;
	return $url;
}

function generer_url_rubrique($id_rubrique) {
	$url = _generer_url_propre('rubrique', $id_rubrique);
	if (!$url) $url = &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
	else $url = '-'.$url.'-';
	return $url;
}

function generer_url_breve($id_breve) {
	$url = _generer_url_propre('breve', $id_breve);
	if (!$url) $url = &quot;breve.php3?id_breve=$id_breve&quot;;
	else $url = '+'.$url.'+';
	return $url;
}

function generer_url_forum($id_forum) {
	return &quot;forum.php3?id_forum=$id_forum&quot;;
}

function generer_url_mot($id_mot) {
	$url = _generer_url_propre('mot', $id_mot);
	if (!$url) $url = &quot;mot.php3?id_mot=$id_mot&quot;;
	else $url = '+-'.$url.'-+';
	return $url;
}

function generer_url_auteur($id_auteur) {
	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
}

function generer_url_document($id_document) {
	if (intval($id_document) &lt;= 0)
		return '';
	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;

	// Migration depuis anciennes URLs ?
	if ($GLOBALS['HTTP_SERVER_VARS']['REQUEST_METHOD'] != 'POST' &amp;&amp;
		preg_match(',(^|/)(article|breve|rubrique|mot)\.php3?([\?&amp;].*)?$,', $url, $regs)) {
		$type = $regs[2];
		$id_objet = intval($GLOBALS['id_'.$type]);
		if ($id_objet) {
			$func = &quot;generer_url_$type&quot;;
			$url_propre = $func($id_objet);
			if ($url_propre) {
				http_status(301);
				Header(&quot;Location: $url_propre&quot;);
				exit;
			}
		}
		return;
	}

	$url_propre = $GLOBALS['HTTP_SERVER_VARS']['REDIRECT_url_propre'];
	if (!$url_propre) $url_propre = $GLOBALS['HTTP_ENV_VARS']['url_propre'];
	if (!$url_propre) $url_propre = substr($url, strrpos($url, '/') + 1);
	if (!$url_propre) return;

	// Detecter les differents types d'objets demandes
	if (preg_match(',^\+-(.*)-\+$,', $url_propre, $regs)) {
		$type = 'mot';
		$url_propre = $regs[1];
	}
	else if (preg_match(',^-(.*)-$,', $url_propre, $regs)) {
		$type = 'rubrique';
		$url_propre = $regs[1];
	}
	else if (preg_match(',^\+(.*)\+$,', $url_propre, $regs)) {
		$type = 'breve';
		$url_propre = $regs[1];
	}
	else {
		$type = 'article';
	}

	$table = &quot;spip_&quot;.$type.&quot;s&quot;;
	$col_id = &quot;id_&quot;.$type;
	$query = &quot;SELECT $col_id FROM $table WHERE url_propre='&quot;.addslashes($url_propre).&quot;'&quot;;
	$result = spip_query($query);
	if (spip_num_rows($result) == 1) {
		$row = spip_fetch_array($result);
		$contexte[$col_id] = $row[$col_id];
	}

	return;
}

?&gt;
--- NEW FILE: formulaire_signature-dist.html ---
&lt;form method='post'
      action='#SELF#sp[(#HTTP_VARS{id_article})]' &gt;
      &lt;input type=&quot;hidden&quot; name=&quot;url_page&quot; value=&quot;#URL_SITE_SPIP/#SELF&quot;&gt;
      &lt;div class='spip_encadrer' style='color: black; font-size: 80%; font-weight: normal;'&gt;
	[(#HTTP_VARS{texte}|traiter_raccourcis|interdire_scripts)]
	&lt;fieldset style='font-size: 110%; font-weight: bold;'&gt;
	  &lt;legend&gt;&lt;/legend&gt;
	  &lt;label&gt;
	    &lt;:form_pet_votre_nom:&gt;
	    &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;nom_email&quot; value=&quot;&quot; size=&quot;20&quot; /&gt;
	  &lt;/label&gt;
	  &lt;label&gt;
	    &lt;:form_pet_votre_email:&gt;&lt;br /&gt;
	    &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;adresse_email&quot; value=&quot;&quot; size=&quot;20&quot; /&gt;
	  &lt;/label&gt;
	&lt;/fieldset&gt;
	&lt;br /&gt;
	&lt;p&gt;[(#HTTP_VARS{site_obli}|=={oui}|?{'',' '})&lt;:form_pet_votre_site:&gt;&lt;br /&gt;]
	&lt;fieldset style='font-size: 110%; font-weight: bold;'&gt;
	  &lt;legend&gt;&lt;/legend&gt;
	  &lt;label&gt;
	  &lt;:form_pet_nom_site2:&gt;&lt;br /&gt;
	  &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;signature_nom_site&quot; value=&quot;&quot; size=&quot;20&quot; /&gt;
	  &lt;/label&gt;
	  &lt;label&gt;
	    &lt;:form_pet_adresse_site:&gt;&lt;br /&gt;
	    &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;signature_url_site&quot; value=&quot;<A HREF="http://">http://</A>&quot; size=&quot;20&quot; /&gt;
	  &lt;/label&gt;
	&lt;/fieldset&gt;[
	&lt;br /&gt;
	&lt;fieldset style='font-weight: bold'&gt;
	  &lt;legend&gt;&lt;/legend&gt;
	(#HTTP_VARS{message}|=={oui}|?{' ',''})
	  &lt;label&gt;
	  &lt;:form_pet_message_commentaire:&gt;&lt;br /&gt;
	    &lt;textarea name=&quot;message&quot; rows=&quot;3&quot; class=&quot;forml&quot; cols=&quot;20&quot;&gt;&lt;/textarea&gt;
	  &lt;/label&gt;
	&lt;/fieldset&gt;
	]
	&lt;br /&gt;
	&lt;div align=&quot;right&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;spip_bouton&quot; value=&quot;&lt;:bouton_valider:&gt;&quot; /&gt;&lt;/div&gt;
      &lt;/div&gt;
&lt;/form&gt;


--- NEW FILE: downloadfile.class.php ---
&lt;?
/*
 * Class has simple interface to download any file from a server
 * without displaying the location of the file
 *
 * Author: Viatcheslav Ivanov, E-Witness Inc., Canada;
 * mail: <A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">ivanov at e-witness.ca</A>;
 * web: www.e-witness.ca; www.coolwater.ca; www.strongpost.net;
 * version: 1.1 /08.19.2002
 *
 */

if ( !defined(&quot;DOWNLOADFILE_H&quot;) ) {

	define(&quot;DOWNLOADFILE_H&quot;,1);

	class DOWNLOADFILE {
		var $df_path = &quot;&quot;;
		var $df_contenttype = &quot;&quot;;
		var $df_contentdisposition = &quot;&quot;;
		var $df_filename = &quot;&quot;;

		function DOWNLOADFILE($df_path, $df_contentdisposition = &quot;attachment&quot;, $df_filename = &quot;&quot;) {
			$this-&gt;df_path = $df_path;
			if (!function_exists (&quot;mime_content_type&quot;)) {
 					function mime_content_type ($file) {
  					return exec (&quot;file -bi &quot; . escapeshellcmd($file));
 				}
			}
			$df_contenttype=@mime_content_type($df_path);
			if ($df_contenttype) $this-&gt;df_contenttype = $df_contenttype;
			else $this-&gt;df_contenttype =&quot;&quot;;// &quot;application/octet-stream&quot;;
			$this-&gt;df_contentdisposition = $df_contentdisposition;
			$this-&gt;df_filename = ($df_filename)? $df_filename : basename($df_path);
		}

		// check is specified file exists?
		function df_exists() {
			if(@file_exists($this-&gt;df_path)) return true;
			return false;
		}

		// get file size
		function df_size() {
			if($this-&gt;df_exists()) return filesize($this-&gt;df_path);
			return false;
		}

		// return permission number for user 'other'
		function df_permitother() {
			return substr(decoct(fileperms($this-&gt;df_path)),-1);
		}

		// download file
		function df_download() {
			if($this-&gt;df_exists() &amp;&amp; $this-&gt;df_permitother() &gt;= 4) {
				header(&quot;Content-type: &quot;.$this-&gt;df_contenttype);
				header(&quot;Content-Length: &quot;.$this-&gt;df_size());
				header(&quot;Content-Disposition: &quot;.$this-&gt;df_contentdisposition.&quot;; filename=\&quot;&quot;.$this-&gt;df_filename.&quot;\&quot;;&quot;);
				header(&quot;Content-Transfer-Encoding: binary&quot;);
				$fp = readfile($this-&gt;df_path, &quot;r&quot;);
				return $fp;
				//echo &quot;Content-type: &quot;.$this-&gt;df_contenttype.&quot;Content-Length: &quot;.$this-&gt;df_size().&quot;Content-Disposition: &quot;.$this-&gt;df_contentdisposition.&quot;; filename=\&quot;&quot;.$this-&gt;df_filename.&quot;\&quot;;&quot;;
			}
			else return false;
		}

	}

}

?&gt;
--- NEW FILE: inc-boucles.php3 ---
&lt;?php

//
// Ce fichier definit les boucles standard de SPIP
//

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_BOUCLES&quot;)) return;
define(&quot;_INC_BOUCLES&quot;, &quot;1&quot;);


//
// Boucle sur une table hors SPIP
//
function boucle_DEFAUT($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$boucle-&gt;from[] =  $boucle-&gt;type_requete . &quot; AS &quot; . $boucle-&gt;type_requete;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(BOUCLE)&gt; boucle dite recursive
//
function boucle_BOUCLE_dist($id_boucle, &amp;$boucles) {

	    return &quot;\n	\$t0 = &quot; . $boucles[$id_boucle]-&gt;return . &quot;;&quot;;
}

//
// &lt;BOUCLE(ARTICLES)&gt;
//
function boucle_ARTICLES_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;articles AS $id_table&quot;;
	if (!$GLOBALS['var_preview']) {
		$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
		if (lire_meta(&quot;post_dates&quot;) == 'non')
			$boucle-&gt;where[] = &quot;$id_table.date &lt; NOW()&quot;;
	} else
		$boucle-&gt;where[] = &quot;$id_table.statut IN ('publie','prop')&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}

//
// &lt;BOUCLE(AUTEURS)&gt;
//
function boucle_AUTEURS_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;auteurs AS $id_table&quot;;
	// Si pas de lien avec un article, selectionner
	// uniquement les auteurs d'un article publie
	if (!$GLOBALS['var_preview'])
	if (!$boucle-&gt;lien AND !$boucle-&gt;tout) {
		$boucle-&gt;from[] =  &quot;auteurs_articles AS lien&quot;;
		$boucle-&gt;from[] =  &quot;articles AS articles&quot;;
		$boucle-&gt;where[] = &quot;lien.id_auteur=$id_table.id_auteur&quot;;
		$boucle-&gt;where[] = 'lien.id_article=articles.id_article';
		$boucle-&gt;where[] = &quot;articles.statut='publie'&quot;;
		$boucle-&gt;group =  $boucle-&gt;id_table . '.' . $boucle-&gt;primary;
	}
	// pas d'auteurs poubellises
	$boucle-&gt;where[] = &quot;NOT($id_table.statut='5poubelle')&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}

//
// &lt;BOUCLE(BREVES)&gt;
//
function boucle_BREVES_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;breves AS $id_table&quot;;
	if (!$GLOBALS['var_preview'])
		$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
	else
		$boucle-&gt;where[] = &quot;$id_table.statut IN ('publie','prop')&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(FORUMS)&gt;
//
function boucle_FORUMS_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;forum AS $id_table&quot;;
	// Par defaut, selectionner uniquement les forums sans pere
	if (!$boucle-&gt;tout AND !$boucle-&gt;plat) 
		{
	$boucle-&gt;where[] = &quot;$id_table.id_parent=0&quot;;
		}
	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(SIGNATURES)&gt;
//
function boucle_SIGNATURES_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;signatures AS $id_table&quot;;
	$boucle-&gt;from[] =  &quot;petitions AS petitions&quot;;
	$boucle-&gt;from[] =  &quot;articles articles&quot;;
	$boucle-&gt;where[] = &quot;petitions.id_article=articles.id_article&quot;;
	$boucle-&gt;where[] = &quot;petitions.id_article=$id_table.id_article&quot;;
	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
	$boucle-&gt;group =  $boucle-&gt;id_table . '.' . $boucle-&gt;primary;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(DOCUMENTS)&gt;
//
function boucle_DOCUMENTS_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;documents AS $id_table&quot;;
	$boucle-&gt;from[] =  &quot;types_documents AS types_documents&quot;;
	$boucle-&gt;where[] = &quot;$id_table.id_type=types_documents.id_type&quot;;
	$boucle-&gt;where[] = &quot;$id_table.taille &gt; 0&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(TYPES_DOCUMENTS)&gt;
//
function boucle_TYPES_DOCUMENTS_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;types_documents AS $id_table&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(GROUPES_MOTS)&gt;
//
function boucle_GROUPES_MOTS_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;groupes_mots AS $id_table&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(MOTS)&gt;
//
function boucle_MOTS_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;mots AS $id_table&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(RUBRIQUES)&gt;
//
function boucle_RUBRIQUES_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;rubriques AS $id_table&quot;;
	if (!$GLOBALS['var_preview'])
		if (!$boucle-&gt;tout) $boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(HIERARCHIE)&gt;
//
function boucle_HIERARCHIE_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;rubriques AS $id_table&quot;;

	// Si la boucle mere est une boucle RUBRIQUES il faut ignorer la feuille
	// sauf si le critere {tout} est present (cf. inc-html-squel)
	$exclure_feuille = ($boucle-&gt;tout ? 'false' : 'true');

	// $hierarchie sera calculee par une fonction de inc-calcul-outils
	$boucle-&gt;where[] = 'id_rubrique IN ($hierarchie)';
	$boucle-&gt;select[] = 'FIND_IN_SET(id_rubrique, \'$hierarchie\')-1 AS rang';
	$boucle-&gt;order = 'rang';
	$boucle-&gt;hierarchie = '$hierarchie = calculer_hierarchie('
	. calculer_argument_precedent($boucle-&gt;id_boucle, 'id_rubrique', $boucles)
	. ', '
	. $exclure_feuille
	. ');';
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(SYNDICATION)&gt;
//
function boucle_SYNDICATION_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;syndic AS $id_table&quot;;
	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
	return calculer_boucle($id_boucle, $boucles); 
}


//
// &lt;BOUCLE(SYNDIC_ARTICLES)&gt;
//
function boucle_SYNDIC_ARTICLES_dist($id_boucle, &amp;$boucles) {
	$boucle = &amp;$boucles[$id_boucle];
	$id_table = $boucle-&gt;id_table;
	$boucle-&gt;from[] =  &quot;syndic_articles  AS $id_table&quot;;
	$boucle-&gt;from[] =  &quot;syndic AS syndic&quot;;
	$boucle-&gt;where[] = &quot;$id_table.id_syndic=syndic.id_syndic&quot;;
	$boucle-&gt;where[] = &quot;$id_table.statut='publie'&quot;;
	$boucle-&gt;where[] = &quot;syndic.statut='publie'&quot;;
	$boucle-&gt;select[]='syndic.nom_site AS nom_site'; # derogation zarbi
	$boucle-&gt;select[]='syndic.url_site AS url_site'; # idem
	return calculer_boucle($id_boucle, $boucles); 
}


?&gt;

--- NEW FILE: carto-proto.sql ---
CREATE TABLE spip_carto_carte (
id_carte smallint unsigned NOT NULL auto_increment,
fichier varchar(255) NOT NULL,
titre varchar(255) NOT NULL,
commentaire text default NULL,
callage text default NULL,
id_srs smallint unsigned default NULL,
idx CHAR( 3 ) NOT NULL, 
PRIMARY KEY (id_carte),
KEY titre (titre)
) TYPE=MyISAM;

# srs = systeme de reference spatial
CREATE TABLE spip_carto_srs (
id_srs smallint unsigned NOT NULL auto_increment,
label varchar(30) NOT NULL,
code smallint NOT NULL,
PRIMARY KEY (id_srs)
) TYPE=MyISAM;

# objet cartographique (point, ligne, surface) attach&#233; &#224; une carte
CREATE TABLE spip_carto_objet (
id_objet smallint unsigned NOT NULL auto_increment,
id_carte smallint unsigned NOT NULL,
titre varchar(255) default NULL,
commentaire text default NULL,
lien varchar(255) default NULL,
logo varchar(255) default NULL,
geometrie text default NULL,
idx CHAR( 3 ) NOT NULL, 
PRIMARY KEY (id_objet),
KEY id_carte (id_carte),
KEY titre (titre)
) TYPE=MyISAM;

# table de jointure entre les objets et les mots cl&#233;s
CREATE TABLE spip_mots_carto_objets (
id_carto_objet smallint unsigned NOT NULL,
id_mot smallint unsigned NOT NULL,
PRIMARY KEY (id_carto_objet,id_mot)
) TYPE=MyISAM;

# table de jointure entre les cartes et les articles
CREATE TABLE spip_carto_carte_articles (
id_carte smallint unsigned NOT NULL,
id_article smallint unsigned NOT NULL,
PRIMARY KEY (id_carte,id_article)
) TYPE=MyISAM;

# table de jointure entre les cartes et les articles
CREATE TABLE spip_documents_carto_cartes (
id_carto_carte smallint unsigned NOT NULL,
id_document smallint unsigned NOT NULL,
callage text default NULL,
PRIMARY KEY (id_carto_carte,id_document)
) TYPE=MyISAM;

ALTER TABLE `spip_groupes_mots` ADD `carto_objets` CHAR( 3 ) NOT NULL default 'oui' AFTER `syndic` ;

ALTER TABLE `spip_groupes_mots` ADD INDEX ( `carto_objets` ) ;


INSERT INTO spip_meta(nom, valeur, maj) VALUES ('activer_carto','oui',now());
INSERT INTO spip_meta(nom, valeur, maj) VALUES ('carto_mots','oui',now());
--- NEW FILE: inc-formulaire_inscription.php3 ---
&lt;?php

include_ecrire('inc_abstract_sql.php3');

global $balise_FORMULAIRE_INSCRIPTION_collecte ;
$balise_FORMULAIRE_INSCRIPTION_collecte = array('mail_inscription', 'nom_inscription');

// args 0 et 1 sont mail et nom ci-dessus,
// arg2 le parametre de la balise
// arg3 toujours vide au premier appel (fenetre cible)

function balise_FORMULAIRE_INSCRIPTION_stat($args, $filtres)
{
  return ((lire_meta('accepter_inscriptions') != 'oui') ? '' :
	  array('redac', $args[0], $args[1], 
		($args[2] == 'focus' ? 'nom_inscription' : ''),
		''));
}

function balise_FORMULAIRE_INSCRIPTION_dyn($mode, $mail_inscription, $nom_inscription, $focus, $target) {
	if (($mode == 'redac') AND (lire_meta(&quot;accepter_inscriptions&quot;) == &quot;oui&quot;))
		$statut = &quot;nouveau&quot;;
	else if (($mode == 'forum') AND ((lire_meta('accepter_visiteurs') == 'oui') OR (lire_meta('forums_publics') == 'abo')))
		$statut = &quot;6forum&quot;;
	else return _T('pass_rien_a_faire_ici');

	if (test_mail_ins($mode, $mail_inscription) &amp;&amp; $nom_inscription) {
		include(_FILE_CONNECT);
		// envoyer les identifiants si l'abonne n'existe pas d&#233;j&#224;.
		if (!$row = spip_fetch_array(spip_query(&quot;SELECT statut, id_auteur, login, pass FROM spip_auteurs WHERE email='&quot;.addslashes($mail_inscription).&quot;' LIMIT 1&quot;)))
		  {
			include_ecrire(&quot;inc_acces.php3&quot;);
			$pass = creer_pass_aleatoire(8, $mail_inscription);
			$login = test_login($mail_inscription);
			$mdpass = md5($pass);
			$htpass = generer_htpass($pass);
			$r = spip_abstract_insert('auteurs', 
					 '(nom, email, login, pass, statut, htpass)',
					 &quot;('&quot;.addslashes($nom_inscription).&quot;',  '&quot;.addslashes($mail_inscription).&quot;', '$login', '$mdpass', '$statut', '$htpass')&quot;);
			ecrire_acces();
			$message = envoyer_inscription($mail_inscription, $statut, $mode, $login, $pass);
		  }

		else {
		  // existant mais encore muet, renvoyer les infos
			if ($row['statut'] == 'nouveau') {
			  $message = (envoyer_inscription($mail_inscription, $row['statut'], $mode, $row['login'], $row['pass']));
			} else {
				if ($row['statut'] == '5poubelle')
		  // dead
				  $message = _T('form_forum_access_refuse');
				else  
		  // deja inscrit
				  $message = _T('form_forum_email_deja_enregistre');
			}
		}
	}
	// demande du formulaire
	else {
		if (!$nom_inscription) 
		    $message = '';
		else {
		  spip_log(&quot;Mail incorrect: '$mail_inscription'&quot;);
		  $message = _L('adresse mail incorrecte');
		}
	}

	return array(&quot;formulaire_inscription&quot;,0,
		     array('focus' =&gt; $focus,
			   'target' =&gt; $target,
			   'message' =&gt; $message,
			   'mode' =&gt; $mode));
}

// fonction qu'on peut redefinir pour filtrer selon l'adresse mail
// cas general: controler juste que l'adresse n'est pas vide

function test_mail_ins($mode, $mail_inscription) {
  return trim($mail_inscription);
}

	// envoyer identifiants par mail
function envoyer_inscription($mail, $statut, $type, $login, $pass) {
	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
	$adresse_site = lire_meta(&quot;adresse_site&quot;);
	
	$message = _T('form_forum_message_auto').&quot;\n\n&quot;._T('form_forum_bonjour').&quot;\n\n&quot;;
	if ($type == 'forum') {
		$message .= _T('form_forum_voici1', array('nom_site_spip' =&gt; $nom_site_spip, 'adresse_site' =&gt; $adresse_site)) . &quot;\n\n&quot;;
	} else {
		$message .= _T('form_forum_voici2', array('nom_site_spip' =&gt; $nom_site_spip, 'adresse_site' =&gt; $adresse_site)) . &quot;\n\n&quot;;
	}
	$message .= &quot;- &quot;._T('form_forum_login').&quot; $login\n&quot;;
	$message .= &quot;- &quot;._T('form_forum_pass').&quot; $pass\n\n&quot;;

	include_ecrire(&quot;inc_mail.php3&quot;);
	if (envoyer_mail($mail, &quot;[$nom_site_spip] &quot;._T('form_forum_identifiants'), $message))
	  return _T('form_forum_identifiant_mail');
	else
	  return _T('form_forum_probleme_mail');
}

function test_login($mail) {
	if (strpos($mail, &quot;@&quot;) &gt; 0) $login_base = substr($mail, 0, strpos($mail, &quot;@&quot;));
	else $login_base = $mail;

	$login_base = strtolower($login_base);
	$login_base = ereg_replace(&quot;[^a-zA-Z0-9]&quot;, &quot;&quot;, $login_base);
	if (!$login_base) $login_base = &quot;user&quot;;
	$login = $login_base;

	for ($i = 1; ; $i++) {
		$query = &quot;SELECT id_auteur FROM spip_auteurs WHERE login='$login' LIMIT 1&quot;;
		if (!spip_num_rows(spip_query($query))) return $login;
		$login = $login_base.$i;
	}


}

?&gt;

--- NEW FILE: formulaire_menu_lang-dist.html ---
&lt;form	action='[(#HTTP_VARS{url})]'
	method='post'
	style='margin:0px; padding:0px;'&gt;[
	&lt;input type='hidden' name='url' value='(#HTTP_VARS{cible})' /&gt;
]	&lt;select	name='[(#HTTP_VARS{nom})]' 
		class='forml'
		style='vertical-align: top; max-height: 24px; margin-bottom: 5px; width: 120px;'
		onchange=&quot;document.location.href='[(#HTTP_VARS{retour})]&amp;[(#HTTP_VARS{nom})]='+this.options[this.selectedIndex].value&quot;&gt;
		[(#HTTP_VARS*{langues})]
      &lt;/select&gt;
      &lt;noscript&gt;
	&lt;input type='submit' value='&gt;&gt;' class='spip_bouton' /&gt;
      &lt;/noscript&gt;
&lt;/form&gt;

--- NEW FILE: forum.php3 ---
&lt;?php
$fond = &quot;forum&quot;;
$delais = 3600;

include (&quot;inc-public.php3&quot;);

?&gt;

--- NEW FILE: inc-menu_lang_ecrire.php3 ---
&lt;?php

global $balise_MENU_LANG_ECRIRE_collecte;
$balise_MENU_LANG_ECRIRE_collecte = array('menu_lang');

// s'il n'y a qu'une langue proposee eviter definitivement la balise ?php 

function balise_MENU_LANG_ECRIRE_stat ($args, $filtres)
{
  if (!strpos(lire_meta('langues_proposees'),',')) return '';
  return $args;
}

// normalement $opt sera toujours non vide suite au test ci-dessus

function balise_MENU_LANG_ECRIRE_dyn($default)
{
  include_ecrire(&quot;inc_lang.php3&quot;);
  $opt = liste_options_langues('var_lang_ecrire', $default);
  return (!$opt ? '' : menu_lang_pour_tous('var_lang_ecrire', $opt));
}

function menu_lang_pour_tous($nom, $opt)
{
  $site = lire_meta(&quot;adresse_site&quot;);
  $post = ($site ? $site : '..') . &quot;/spip_cookie.php3&quot;;
  $cible = $GLOBALS['clean_link']-&gt;getUrl();
  $postcomplet = new Link($post);
  $postcomplet-&gt;addvar('url', $cible);

  return array('formulaire_menu_lang',
	       10, 
	       array('nom' =&gt; $nom,
		     'url' =&gt; $post,
		     'cible' =&gt; $cible,
		     'retour' =&gt; $postcomplet-&gt;getUrl(),
		     'langues' =&gt; $opt));
}
?&gt;

--- NEW FILE: formulaire_inscription-dist.html ---
[
(#HTTP_VARS*{message})
][
(#HTTP_VARS*{message}|?{'',' '})[
 (#HTTP_VARS{mode}|=={forum}|?{' ',''})
	&lt;:pass_forum_bla:&gt;&lt;br /&gt;&lt;br /&gt;
][
 (#HTTP_VARS{mode}|=={redac}|?{' ',''})
	&lt;:pass_espace_prive_bla:&gt;&lt;br /&gt;&lt;br /&gt;
]&lt;:form_forum_indiquer_nom_email:&gt;
 &lt;form	id=&quot;inscription&quot; method='post' action='#SELF'
	style='border: 0px; margin: 0px;'&gt; 
      &lt;fieldset style=&quot;border: none; font-weight: bold&quot;&gt;&lt;legend&gt;&lt;/legend&gt;
	&lt;label&gt;
	  &lt;:form_pet_votre_nom:&gt;
	  &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;nom_inscription&quot; value=&quot;&quot; size=&quot;30&quot; /&gt;
	&lt;/label&gt;
	&lt;label&gt;
	  &lt;:form_pet_votre_email:&gt;
	  &lt;input type=&quot;text&quot; class=&quot;forml&quot; name=&quot;mail_inscription&quot; value=&quot;&quot; size=&quot;30&quot; /&gt;
	&lt;/label&gt;
      &lt;/fieldset&gt;
      &lt;div align=&quot;right&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;spip_bouton&quot; value=&quot;&lt;:bouton_valider:&gt;&quot; /&gt;
	&lt;/div&gt; 
 &lt;/form&gt;[
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
document.inscription.(#HTTP_VARS{focus}).focus()
--&gt;&lt;/script&gt;
 ]
][&lt;br /&gt;
&lt;div align=&quot;right&quot;&gt;
(#HTTP_VARS{target}|?{' ',''})
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
document.write(&quot;&lt;a href='&quot;)
document.write((window.opener) ? &quot;javascript:close()&quot; : &quot;./&quot;)
document.write(&quot;'&gt;&lt;:pass_quitter_fenetre:&gt;&lt;&quot; + &quot;/a&gt;&quot;);
//--&gt;&lt;/script&gt;
&lt;noscript&gt;
        &#91;&lt;a href='./'&gt;&lt;:pass_retour_public:&gt;&lt;/a&gt;&#93;
&lt;/noscript&gt;
&lt;/div&gt;
]

--- NEW FILE: impression.css ---

/*
 * Feuille de style specifique a l'impression
 */
 
/* Pour les liens, on desactive les couleurs
   et on affiche l'URL cible a la suite du lien (!) */

a { color: black; text-decoration: underline; }
a:visited { color: black; text-decoration: underline; }
a.spip_in { color: black; text-decoration: underline; }
a.spip_out { color: black; text-decoration: underline; }
a:after {
	display: inline;
	border: 1px solid dotted;
	content: &quot; [&quot; attr(href) &quot;]&quot;;
}

/*
 * Un peu de coquetterie
 */

.chapo {
	line-height: 1.4em;
	margin-top: 1em;
}
.texte {
}
.ps {
	padding-top: 0.6em;
	margin-top: 0.6em;
	border-top: 1px dashed #404040;
}
.notes {
	margin-top: 0.6em;
	margin-bottom: 0.6em;
	border-top: 1px solid #707070;
}
.structure {
	display: none;
}
.spip-admin {
	display: none;
}


.contenu {
	margin: 10px;
}
.contenu h1 {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu h1.titre-extrait {
}
.contenu h1.titre-texte {
}
.contenu .surtitre {
	margin-top: 0em;
	margin-bottom: 0em;
}
.contenu .detail {
	margin-left: 2em;
}
.extrait {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
	margin-left: 2em;
	margin-right: 0em;
	line-height: 1.4em;
}


/*
 * Disposition : on elimine les elements de navigation (display: none)
 * et on choisit un affichage de base pour le principal
 */

#principal {
	margin: 10px;
}

#navigation {
	display: none;
}

.encart {
	display: none;
}

.cartouche {
	margin-top: 0.5em;
	padding-top: 1em;
	margin-bottom: 1em;
}

.cartouche .spip_logos {
	margin-left: 0px;
	padding-left: 0px;
	margin-right: 0.8em;
}


/*
 * Forums
 */

.forum-repondre {
	display: none;
}
.forum-repondre-message {
	display: none;
}


--- NEW FILE: inc-balises.php3 ---
&lt;?php

//
// Ce fichier regroupe la quasi totalite des definitions de #BALISES de spip
// Pour chaque balise, il est possible de surcharger, dans mes_fonctions.php3,
// la fonction balise_TOTO_dist par une fonction balise_TOTO() respectant la
// meme API : 
// elle recoit en entree un objet de classe CHAMP, le modifie et le retourne.
// Cette classe est definie dans inc-compilo-index.php3
//

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_BALISES&quot;)) return;
define(&quot;_INC_BALISES&quot;, &quot;1&quot;);


//
// Traitements standard de divers champs
//
function champs_traitements ($p) {
	static $traitements = array (
		'BIO' =&gt; 'traiter_raccourcis(%s)',
		'CHAPO' =&gt; 'traiter_raccourcis(nettoyer_chapo(%s))',
		'DATE' =&gt; 'vider_date(%s)',
		'DATE_MODIF' =&gt; 'vider_date(%s)',
		'DATE_NOUVEAUTES' =&gt; 'vider_date(%s)',
		'DATE_REDAC' =&gt; 'vider_date(%s)',
		'DESCRIPTIF' =&gt; 'traiter_raccourcis(%s)',
		'LIEN_TITRE' =&gt; 'typo(%s)',
		'LIEN_URL' =&gt; 'htmlspecialchars(vider_url(%s))',
		'MESSAGE' =&gt; 'traiter_raccourcis(%s)',
		'NOM_SITE_SPIP' =&gt; 'typo(%s)',
		'NOM' =&gt; 'typo(%s)',
		'PARAMETRES_FORUM' =&gt; 'htmlspecialchars(%s)',
		'PS' =&gt; 'traiter_raccourcis(%s)',
		'SOUSTITRE' =&gt; 'typo(%s)',
		'SURTITRE' =&gt; 'typo(%s)',
		'TEXTE' =&gt; 'traiter_raccourcis(%s)',
		'TITRE' =&gt; 'typo(%s)',
		'TYPE' =&gt; 'typo(%s)',
		'URL_ARTICLE' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_BREVE' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_DOCUMENT' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_FORUM' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_MOT' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_RUBRIQUE' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_SITE_SPIP' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_SITE' =&gt; 'htmlspecialchars(vider_url(%s))',
		'URL_SYNDIC' =&gt; 'htmlspecialchars(vider_url(%s))',
		'HTTP_VARS' =&gt; 'htmlspecialchars(%s)'
	);
	$ps = $traitements[$p-&gt;nom_champ];
	if (!$ps) return $p-&gt;code;
	if ($p-&gt;documents)
	  {$ps = str_replace('traiter_raccourcis(', 
			     'traiter_raccourcis_doublon($doublons,',
			     str_replace('typo(', 
					 'typo_doublon($doublons,',
					 $ps));
	  }
	// on supprime les &lt; IMGnnn &gt; tant qu'on ne rapatrie pas
	// les documents distants joints..
	// il faudrait aussi corriger les raccourcis d'URL locales
	return str_replace('%s',
			   (!$p-&gt;boucles[$p-&gt;id_boucle]-&gt;sql_serveur ?
			    $p-&gt;code :
			    ('supprime_img(' . $p-&gt;code . ')')),
			   $ps);				
}

// il faudrait savoir traiter les formulaires en local 
// tout en appelant le serveur SQL distant.
// En attendant, cette fonction permet de refuser une authentification 
// sur qqch qui n'a rien &#224; voir.

function balise_distante_interdite($p) {
	$nom = $p-&gt;id_boucle;
	if ($p-&gt;boucles[$nom]-&gt;sql_serveur) {
		erreur_squelette($p-&gt;nom_champ ._L(&quot; distant interdit&quot;), $nom);
	}
}

//
// Definition des balises
//
function balise_NOM_SITE_SPIP_dist($p) {
	$p-&gt;code = &quot;lire_meta('nom_site')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

function balise_EMAIL_WEBMASTER_dist($p) {
	$p-&gt;code = &quot;lire_meta('email_webmaster')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

function balise_CHARSET_dist($p) {
	$p-&gt;code = &quot;lire_meta('charset')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

function balise_LANG_LEFT_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p-&gt;code = &quot;lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'left','right')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

function balise_LANG_RIGHT_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p-&gt;code = &quot;lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'right','left')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

function balise_LANG_DIR_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p-&gt;code = &quot;lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),'ltr','rtl')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

function balise_PUCE_dist($p) {
	$_lang = champ_sql('lang', $p);
	$p-&gt;code = &quot;((lang_dir(($_lang ? $_lang : \$GLOBALS['spip_lang']),false,true) &amp;&amp; \$GLOBALS['puce_rtl']) ? \$GLOBALS['puce_rtl'] : \$GLOBALS['puce'])&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

// #DATE
// Cette fonction sait aller chercher dans le contexte general
// quand #DATE est en dehors des boucles
// <A HREF="http://www.spip.net/fr_article1971.html">http://www.spip.net/fr_article1971.html</A>
function balise_DATE_dist ($p) {
	$_date = champ_sql('date', $p);
	$p-&gt;code = &quot;$_date&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

// #DATE_REDAC
// <A HREF="http://www.spip.net/fr_article1971.html">http://www.spip.net/fr_article1971.html</A>
function balise_DATE_REDAC_dist ($p) {
	$_date = champ_sql('date_redac', $p);
	$p-&gt;code = &quot;$_date&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

// #DATE_MODIF
// <A HREF="http://www.spip.net/fr_article1971.html">http://www.spip.net/fr_article1971.html</A>
function balise_DATE_MODIF_dist ($p) {
	$_date = champ_sql('date_modif', $p);
	$p-&gt;code = &quot;$_date&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

// #DATE_NOUVEAUTES
// <A HREF="http://www.spip.net/fr_article1971.html">http://www.spip.net/fr_article1971.html</A>
function balise_DATE_NOUVEAUTES_dist($p) {
	$p-&gt;code = &quot;((lire_meta('quoi_de_neuf') == 'oui' AND lire_meta('majnouv')) ? normaliser_date(lire_meta('majnouv')) : \&quot;'0000-00-00'\&quot;)&quot;;
	$p-&gt;statut = 'php';
	return $p;
}

function balise_URL_SITE_SPIP_dist($p) {
	$p-&gt;code = &quot;lire_meta('adresse_site')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}


function balise_URL_ARTICLE_dist($p) {
	$_type = $p-&gt;type_requete;

	// Cas particulier des boucles (SYNDIC_ARTICLES)
	if ($_type == 'syndic_articles') {
		$p-&gt;code = champ_sql('url', $p);
	}

	// Cas general : chercher un id_article dans la pile
	else {
		$_id_article = champ_sql('id_article', $p);
		$p-&gt;code = &quot;generer_url_article($_id_article)&quot;;

		if ($p-&gt;boucles[$p-&gt;nom_boucle ? $p-&gt;nom_boucle : $p-&gt;id_boucle]-&gt;hash)
			$p-&gt;code = &quot;url_var_recherche(&quot; . $p-&gt;code . &quot;)&quot;;
	}

	$p-&gt;statut = 'html';
	return $p;
}

function balise_URL_RUBRIQUE_dist($p) {
	$p-&gt;code = &quot;generer_url_rubrique(&quot; . 
	champ_sql('id_rubrique',$p) . 
	&quot;)&quot; ;
	if ($p-&gt;boucles[$p-&gt;nom_boucle ? $p-&gt;nom_boucle : $p-&gt;id_boucle]-&gt;hash)
	$p-&gt;code = &quot;url_var_recherche(&quot; . $p-&gt;code . &quot;)&quot;;

	$p-&gt;statut = 'html';
	return $p;
}

function balise_URL_BREVE_dist($p) {
	$p-&gt;code = &quot;generer_url_breve(&quot; .
	champ_sql('id_breve',$p) . 
	&quot;)&quot;;
	if ($p-&gt;boucles[$p-&gt;nom_boucle ? $p-&gt;nom_boucle : $p-&gt;id_boucle]-&gt;hash)
	$p-&gt;code = &quot;url_var_recherche(&quot; . $p-&gt;code . &quot;)&quot;;

	$p-&gt;statut = 'html';
	return $p;
}

function balise_URL_MOT_dist($p) {
	$p-&gt;code = &quot;generer_url_mot(&quot; .
	champ_sql('id_mot',$p) .
	&quot;)&quot;;
	$p-&gt;code = &quot;url_var_recherche(&quot; . $p-&gt;code . &quot;)&quot;;

	$p-&gt;statut = 'html';
	return $p;
}

function balise_URL_FORUM_dist($p) {
	$p-&gt;code = &quot;generer_url_forum(&quot; .
	champ_sql('id_forum',$p) .&quot;)&quot;;

	$p-&gt;statut = 'html';
	return $p;
}

function balise_URL_DOCUMENT_dist($p) {
	$p-&gt;code = &quot;generer_url_document(&quot; .
	champ_sql('id_document',$p) . &quot;)&quot;;

	$p-&gt;statut = 'html';
	return $p;
}

function balise_URL_AUTEUR_dist($p) {
	$p-&gt;code = &quot;generer_url_auteur(&quot; .
	champ_sql('id_auteur',$p) .&quot;)&quot;;
	if ($p-&gt;boucles[$p-&gt;nom_boucle ? $p-&gt;nom_boucle : $p-&gt;id_boucle]-&gt;hash)
	$p-&gt;code = &quot;url_var_recherche(&quot; . $p-&gt;code . &quot;)&quot;;

	$p-&gt;statut = 'html';
	return $p;
}

function balise_NOTES_dist($p) {
	// Recuperer les notes
	$p-&gt;code = 'calculer_notes()';
	$p-&gt;statut = 'html';
	return $p;
}

function balise_RECHERCHE_dist($p) {
	$p-&gt;code = 'htmlspecialchars($GLOBALS[&quot;recherche&quot;])';
	$p-&gt;statut = 'php';
	return $p;
}

function balise_COMPTEUR_BOUCLE_dist($p) {
	if ($p-&gt;id_mere === '') {
		erreur_squelette(_L(&quot;Champ #COMPTEUR_BOUCLE hors boucle&quot;), $p-&gt;id_boucle);
		$p-&gt;code = &quot;''&quot;;
	} else {
		$p-&gt;code = '$compteur_boucle';
		$p-&gt;statut = 'php';
		return $p;
	}
}

function balise_TOTAL_BOUCLE_dist($p) {
	$b = $p-&gt;nom_boucle ? $p-&gt;nom_boucle : $p-&gt;id_mere;
	if ($b === '') {
		erreur_squelette(_L(&quot;Champ #TOTAL_BOUCLE hors boucle&quot;), $p-&gt;id_boucle);
		$p-&gt;code = &quot;''&quot;;
	} else {
		$p-&gt;code = &quot;\$Numrows['$b']&quot;;
		$p-&gt;boucles[$b]-&gt;numrows = true;
		$p-&gt;statut = 'php';
	}
	return $p;
}

function balise_POINTS_dist($p) {
	return rindex_pile($p, 'points', 'recherche');
}

function balise_POPULARITE_ABSOLUE_dist($p) {
	$p-&gt;code = 'ceil(' .
	champ_sql('popularite', $p) .
	')';
	$p-&gt;statut = 'php';
	return $p;
}

function balise_POPULARITE_SITE_dist($p) {
	$p-&gt;code = 'ceil(lire_meta(\'popularite_total\'))';
	$p-&gt;statut = 'php';
	return $p;
}

function balise_POPULARITE_MAX_dist($p) {
	$p-&gt;code = 'ceil(lire_meta(\'popularite_max\'))';
	$p-&gt;statut = 'php';
	return $p;
}

function balise_EXPOSER_dist($p) {
	global  $table_primary;
	$type_boucle = $p-&gt;type_requete;
	$primary_key = $table_primary[$type_boucle];
	if (!$primary_key) {
		erreur_squelette(_L(&quot;Champ #EXPOSER hors boucle&quot;), $p-&gt;id_boucle);
	}
	$on = 'on';
	$off= '';
	if ($p-&gt;fonctions) {
		// Gerer la notation [(#EXPOSER|on,off)]
		reset($p-&gt;fonctions);
		list(, $onoff) = each($p-&gt;fonctions);
		ereg(&quot;([^,]*)(,(.*))?&quot;, $onoff, $regs);
		$on = addslashes($regs[1]);
		$off = addslashes($regs[3]);
		
		// autres filtres
		$filtres=Array();
		while (list(, $nom) = each($p-&gt;fonctions))
		  $filtres[] = $nom;
		$p-&gt;fonctions = $filtres;
	}


	$p-&gt;code = '(calcul_exposer('
	.champ_sql($primary_key, $p)
	.', &quot;'.$primary_key.'&quot;, $Pile[0]) ?'.&quot; '$on': '$off')&quot;;
	$p-&gt;statut = 'php';
	return $p;
}


//
// Inserer directement un document dans le squelette
//
function balise_EMBED_DOCUMENT_dist($p) {
	balise_distante_interdite($p);
	$_id_document = champ_sql('id_document',$p);
	$p-&gt;code = &quot;calcule_embed_document(intval($_id_document), '&quot; .
	texte_script($p-&gt;fonctions ? join($p-&gt;fonctions, &quot;|&quot;) : &quot;&quot;) .
	  &quot;', \$doublons, '&quot; . $p-&gt;documents . &quot;')&quot;;
	unset ($p-&gt;fonctions);
	$p-&gt;statut = 'html';
	return $p;
}

// Debut et fin de surlignage auto des mots de la recherche
// on insere une balise Span avec une classe sans spec:
// c'est transparent s'il n'y a pas de recherche,
// sinon elles seront remplacees par les fontions de inc_surligne
// flag_pcre est juste une flag signalant que preg_match est dispo.

function balise_DEBUT_SURLIGNE_dist($p) {
	global $flag_pcre;
	$p-&gt;code = ($flag_pcre ? ('\'&lt;span class=&quot;spip_surligneconditionnel&quot;&gt;\'') : &quot;''&quot;);
	return $p;
}
function balise_FIN_SURLIGNE_dist($p) {
	global $flag_pcre;
	$p-&gt;code = ($flag_pcre ? ('\'&lt;/span class=&quot;spip_surligneconditionnel&quot;&gt;\'') : &quot;''&quot;);
	return $p;
}

function balise_INTRODUCTION_dist ($p) {
	$_type = $p-&gt;type_requete;
	$_texte = champ_sql('texte', $p);
	$_chapo = champ_sql('chapo', $p);
	$_descriptif = champ_sql('descriptif', $p);
	$p-&gt;code = &quot;calcul_introduction('$_type', $_texte, $_chapo, $_descriptif)&quot;;

	$p-&gt;statut = 'html';
	return $p;
}


// #LANG
// non documente ?
function balise_LANG_dist ($p) {
	$_lang = champ_sql('lang', $p);
	$p-&gt;code = &quot;($_lang ? $_lang : \$GLOBALS['spip_lang'])&quot;;
	$p-&gt;statut = 'php';
	return $p;
}


// #LESAUTEURS
// les auteurs d'un article (ou d'un article syndique)
// <A HREF="http://www.spip.net/fr_article902.html">http://www.spip.net/fr_article902.html</A>
// <A HREF="http://www.spip.net/fr_article911.html">http://www.spip.net/fr_article911.html</A>
function balise_LESAUTEURS_dist ($p) {
	// Cherche le champ 'lesauteurs' dans la pile
	$_lesauteurs = champ_sql('lesauteurs', $p); 

	// Si le champ n'existe pas (cas de spip_articles), on donne la
	// construction speciale sql_auteurs(id_article) ;
	// dans le cas contraire on prend le champ 'les_auteurs' (cas de
	// spip_syndic_articles)
	if ($_lesauteurs AND $_lesauteurs != '$Pile[0][\'lesauteurs\']') {
		$p-&gt;code = $_lesauteurs;
	} else {
		$nom = $p-&gt;id_boucle;
	# On pourrait mieux faire qu'utiliser cette fonction assistante ?
		$p-&gt;code = &quot;sql_auteurs(&quot; .
			champ_sql('id_article', $p) .
			&quot;,'&quot; .
			$nom .
			&quot;','&quot; .
			$p-&gt;boucles[$nom]-&gt;type_requete .
			&quot;','&quot; .
			$p-&gt;boucles[$nom]-&gt;sql_serveur .
			&quot;')&quot;;
	}

	$p-&gt;statut = 'html';
	return $p;
}


// #PETITION 
// retourne '' si l'article courant n'a pas de petition 
// le texte de celle-ci sinon (et ' ' si il est vide)
// cf FORMULAIRE_PETITION

function balise_PETITION_dist ($p) {
	$nom = $p-&gt;id_boucle;
	$p-&gt;code = &quot;sql_petitions(&quot; .
			champ_sql('id_article', $p) .
			&quot;,'&quot; .
			$p-&gt;boucles[$nom]-&gt;type_requete .
			&quot;','&quot; .
			$nom .
			&quot;','&quot; .
			$p-&gt;boucles[$nom]-&gt;sql_serveur .
			&quot;', \$Cache)&quot;;
	$p-&gt;statut = 'php';
	return $p;
}


// #POPULARITE
// <A HREF="http://www.spip.net/fr_article1846.html">http://www.spip.net/fr_article1846.html</A>
function balise_POPULARITE_dist ($p) {
	$_popularite = champ_sql('popularite', $p);
	$p-&gt;code = &quot;(ceil(min(100, 100 * $_popularite
	/ max(1 , 0 + lire_meta('popularite_max')))))&quot;;
	$p-&gt;statut = 'php';
	return $p;
}


//
// Fonction commune aux balises #LOGO_XXXX
// (les balises portant ce type de nom sont traitees en bloc ici)
//
function calculer_balise_logo ($p) {

	eregi(&quot;^LOGO_([A-Z]+)(_.*)?$&quot;, $p-&gt;nom_champ, $regs);
	$type_objet = $regs[1];
	$suite_logo = $regs[2];	
	if (ereg(&quot;^_SPIP(.*)$&quot;, $suite_logo, $regs)) {
		$type_objet = 'RUBRIQUE';
		$suite_logo = $regs[1];
		$_id_objet = &quot;\&quot;'0'\&quot;&quot;;
	} else {

		if ($type_objet == 'SITE')
			$_id_objet = champ_sql(&quot;id_syndic&quot;, $p);
		else
			$_id_objet = champ_sql(&quot;id_&quot;.strtolower($type_objet), $p);
	}
	// analyser les filtres
	$flag_fichier = false;
	$filtres = '';
	if (is_array($p-&gt;fonctions)) {
		foreach($p-&gt;fonctions as $nom) {
			if (ereg('^(left|right|center|top|bottom)$', $nom))
				$align = $nom;
			else if ($nom == 'lien') {
				$flag_lien_auto = 'oui';
				$flag_stop = true;
			}
			else if ($nom == 'fichier') {
				$flag_fichier = 'true';
				$flag_stop = true;
			}
			// double || signifie &quot;on passe aux filtres&quot;
			else if ($nom == '')
				$flag_stop = true;
			else if (!$flag_stop) {
				$lien = $nom;
				$flag_stop = true;
			}
			// apres un URL ou || ou |fichier ce sont
			// des filtres (sauf left...lien...fichier)
			else
				$filtres[] = $nom;
		}
		// recuperer les autres filtres s'il y en a
		$p-&gt;fonctions = $filtres;
	}

	//
	// Preparer le code du lien
	//
	// 1. filtre |lien
	if ($flag_lien_auto AND !$lien)
		$code_lien = '($lien = generer_url_'.$type_objet.'('.$_id_objet.')) ? $lien : &quot;&quot;';
	// 2. lien indique en clair (avec des balises : imprimer#ID_ARTICLE.html)
	else if ($lien) {
		$code_lien = &quot;'&quot;.texte_script(trim($lien)).&quot;'&quot;;
		while (ereg(&quot;^([^#]*)#([A-Za-z_]+)(.*)$&quot;, $code_lien, $match)) {
			$c = new Champ();
			$c-&gt;nom_champ = $match[2];
			$c-&gt;id_boucle = $p-&gt;id_boucle;
			$c-&gt;boucles = &amp;$p-&gt;boucles;
			$c-&gt;id_mere = $p-&gt;id_mere;
			$c = calculer_champ($c);
			$code_lien = str_replace('#'.$match[2], &quot;'.&quot;.$c.&quot;.'&quot;, $code_lien);
		}
		// supprimer les '' disgracieux
		$code_lien = ereg_replace(&quot;^''\.|\.''$&quot;, &quot;&quot;, $code_lien);
	}

	if ($flag_fichier)
	  $code_lien = &quot;'',''&quot; ; 
	else {
		if (!$code_lien)
			$code_lien = &quot;''&quot;;
		$code_lien .= &quot;, '&quot;. addslashes($align) . &quot;'&quot;;
	}

	// cas des documents
	if ($type_objet == 'DOCUMENT') {
		$code_logo = &quot;calcule_document($_id_objet, '&quot; .
			$p-&gt;documents .
		  '\', $doublons)';
		if ($flag_fichier)
		  $p-&gt;code = &quot;calcule_fichier_logo($code_logo)&quot;;
		else
		  $p-&gt;code = &quot;affiche_logos(array($code_logo, ''), $code_lien)&quot;;
	}
	else {
	  $p-&gt;code = &quot;affiche_logos(calcule_logo('$type_objet', '&quot; .
	    (($suite_logo == '_SURVOL') ? 'off' : 
	     (($suite_logo == '_NORMAL') ? 'on' : 'ON')) .
	    &quot;', $_id_objet,&quot; .
	    (($suite_logo == '_RUBRIQUE') ? 
	     champ_sql(&quot;id_rubrique&quot;, $p) :
	     (($type_objet == 'RUBRIQUE') ? &quot;sql_parent($_id_objet)&quot; : &quot;''&quot;)) .
	    &quot;,  '$flag_fichier'), $code_lien)&quot;;
	}
	$p-&gt;statut = 'php';
	return $p;
}

// #EXTRA [(#EXTRA|isbn)]
// Champs extra
// Non documentes, en voie d'obsolescence, cf. ecrire/inc_extra.php3
function balise_EXTRA_dist ($p) {
	$_extra = champ_sql('extra', $p);
	$p-&gt;code = $_extra;

	// Gerer la notation [(#EXTRA|isbn)]
	if ($p-&gt;fonctions) {
		include_ecrire(&quot;inc_extra.php3&quot;);
		list ($key, $champ_extra) = each($p-&gt;fonctions);	// le premier filtre
		$type_extra = $p-&gt;type_requete;
			// ci-dessus est sans doute un peu buggue : si on invoque #EXTRA
			// depuis un sous-objet sans champ extra d'un objet a champ extra,
			// on aura le type_extra du sous-objet (!)
		if (extra_champ_valide($type_extra, $champ_extra)) {
			unset($p-&gt;fonctions[$key]);
			$p-&gt;code = &quot;extra($p-&gt;code, '&quot;.addslashes($champ_extra).&quot;')&quot;;

			// Appliquer les filtres definis par le webmestre
			$filtres = extra_filtres($type_extra, $champ_extra);
			if ($filtres) foreach ($filtres as $f)
				$p-&gt;code = &quot;$f($p-&gt;code)&quot;;
		}
	}

	$p-&gt;statut = 'html';
	return $p;
}

//
// Parametres de reponse a un forum
//

function balise_PARAMETRES_FORUM_dist($p) {
	include_local('inc-formulaire_forum.php3');
	$_accepter_forum = champ_sql('accepter_forum', $p);
	$p-&gt;code = '
	// refus des forums ?
	('.$_accepter_forum.'==&quot;non&quot; OR
	(lire_meta(&quot;forums_publics&quot;) == &quot;non&quot; AND !ereg(&quot;^(pos|pri|abo)&quot;, '.$_accepter_forum.')))
	? &quot;&quot; : // sinon:
	';

	switch ($p-&gt;type_requete) {
		case 'articles':
			$c = '&quot;id_article=&quot;.' . champ_sql('id_article', $p);
			break;
		case 'breves':
			$c = '&quot;id_breve=&quot;.' . champ_sql('id_breve', $p);
			break;
		case 'rubriques':
			$c = '&quot;id_rubrique=&quot;.' . champ_sql('id_rubrique', $p);
			break;
		case 'syndication':
			$c = '&quot;id_syndic=&quot;.' . champ_sql('id_syndic', $p);
			break;
		case 'forums':
		default:
			$liste_champs = array (&quot;id_article&quot;,&quot;id_breve&quot;,&quot;id_rubrique&quot;,&quot;id_syndic&quot;,&quot;id_forum&quot;);
			foreach ($liste_champs as $champ) {
				$x = champ_sql( $champ, $p);
				$c .= (($c) ? &quot;.\n&quot; : &quot;&quot;) . &quot;((!$x) ? '' : ('&amp;$champ='.$x))&quot;;
			}
			$c = &quot;substr($c,1)&quot;;
			break;
	}

	$c .= '.
	&quot;&amp;retour=&quot;.rawurlencode($lien=$GLOBALS[&quot;HTTP_GET_VARS&quot;][&quot;retour&quot;] ? $lien : nettoyer_uri())';

	$p-&gt;code .= code_invalideur_forums($p, &quot;(&quot;.$c.&quot;)&quot;);

	$p-&gt;statut = 'html';
	return $p;
}


// Noter l'invalideur de la page contenant ces parametres,
// en cas de premier post sur le forum
function code_invalideur_forums($p, $code) {
	return '
	// invalideur forums
	(!($Cache[\'id_forum\'][calcul_index_forum(' . 
				// Retournera 4 [$SP] mais force la demande du champ a MySQL
				champ_sql('id_article', $p) . ',' .
				champ_sql('id_breve', $p) .  ',' .
				champ_sql('id_rubrique', $p) .',' .
				champ_sql('id_syndic', $p) .  &quot;)]=1)&quot;.
				&quot;?'':\n&quot; . $code .&quot;)&quot;;
}

// reference a l'URL de la page courante

function balise_SELF_dist($p) {
	$p-&gt;code = 'quote_amp($GLOBALS[&quot;clean_link&quot;]-&gt;getUrl())';
	$p-&gt;statut = 'php';
	return $p;
}

// reference aux parametres GET &amp; POST

function balise_HTTP_VARS_dist($p) {
	$nom = param_balise($p);
	if (!$nom)
		erreur_squelette(_L(&quot;Champ #HTTP_VARS argument manquant&quot;),
				$p-&gt;id_boucle);
	else {
		$p-&gt;code = '$Pile[0][&quot;' . addslashes($nom) . '&quot;]';
		$p-&gt;statut = 'php';
	}
	return $p;
}
?&gt;

--- NEW FILE: inc-chercher.php3 ---
&lt;?php

// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_CHERCHE&quot;)) return;
define(&quot;_INC_CHERCHE&quot;, &quot;1&quot;);

// Ce fichier doit imperativement contenir la fonction chercher-squelette
// (cf commentaires dans inc-calcul)

function chercher_squelette($fond, $id_rubrique, $dossier, $lang) {
	$ext = $GLOBALS['extension_squelette'];

	$d =&quot;$dossier$fond&quot;;

	// On selectionne, dans l'ordre :
	// fond=10
	
	$f = &quot;$d=$id_rubrique&quot;;
	if (($id_rubrique &gt; 0) AND (@file_exists(&quot;$f.$ext&quot;)))
		$squelette = $f;

	// fond-10 fond-&lt;rubriques parentes&gt;
	if (!$squelette)
		while ($id_rubrique &gt; 0) {
			if (@file_exists(&quot;$d-$id_rubrique.$ext&quot;)) {
				$squelette = &quot;$d-$id_rubrique&quot;;
				break;
			}
			else
				$id_rubrique = sql_parent($id_rubrique);
		}

	if (!$squelette) {
		// fond
		if (@file_exists(&quot;$d.$ext&quot;))
			$squelette = $d;
		// fond, a la racine
		else if (@file_exists(&quot;$fond.$ext&quot;))
			$squelette = $fond;
		else if (@file_exists(&quot;$fond-dist.$ext&quot;))
			$squelette = &quot;$fond-dist&quot;;
		else {
			// erreur webmaster : $fond ne correspond a rien
			erreur_squelette(_T('info_erreur_squelette2',
				 array('fichier'=&gt;$fond)),
				 $dossier);
			return '';
		}
	}

	// Affiner par lang
	if ($lang) {
		lang_select($lang);
		$f = &quot;$squelette.$lang&quot;;
		if (@file_exists(&quot;$f.$ext&quot;))
			$squelette = $f;
	}

	return $squelette;
}

?&gt;

--- NEW FILE: inc-urls-standard.php3 ---
&lt;?php

// executer une seule fois
if (defined(&quot;_INC_URLS2&quot;)) return;
define(&quot;_INC_URLS2&quot;, &quot;1&quot;);

function generer_url_article($id_article) {
	return &quot;article.php3?id_article=$id_article&quot;;
}

function generer_url_rubrique($id_rubrique) {
	return &quot;rubrique.php3?id_rubrique=$id_rubrique&quot;;
}

function generer_url_breve($id_breve) {
	return &quot;breve.php3?id_breve=$id_breve&quot;;
}

function generer_url_mot($id_mot) {
	return &quot;mot.php3?id_mot=$id_mot&quot;;
}

function generer_url_auteur($id_auteur) {
	return &quot;auteur.php3?id_auteur=$id_auteur&quot;;
}

function generer_url_document($id_document) {
	if (intval($id_document) &lt;= 0)
		return '';
	if ((lire_meta(&quot;creer_htaccess&quot;)) == 'oui')
		return &quot;spip_acces_doc.php3?id_document=$id_document&quot;;
	if ($row = @spip_fetch_array(spip_query(&quot;SELECT fichier FROM spip_documents WHERE id_document = $id_document&quot;)))
		return ($row['fichier']);
	return '';
}

function recuperer_parametres_url($fond, $url) {
	global $contexte;
	return;
}

//
// URLs des forums
//

// a mettre dans ecrire/inc_threads.php3 avec les autres trucs de forum
function racine_forum($id_forum){
	if (!$id_forum = intval($id_forum)) return;
	$query = &quot;SELECT id_parent, id_rubrique, id_article, id_breve FROM spip_forum WHERE id_forum=&quot;.$id_forum;
	$result = spip_query($query);
	if($row = spip_fetch_array($result)){
		if($row['id_parent']) {
			return racine_forum($row['id_parent']);
		}
		else {
			if($row['id_rubrique']) return array('rubrique',$row['id_rubrique'], $id_forum);
 			if($row['id_article']) return array('article',$row['id_article'], $id_forum);
			if($row['id_breve']) return array('breve',$row['id_breve'], $id_forum);
		}
	}
} 

function generer_url_forum($id_forum, $show_thread=false) {
	list($type, $id, $id_thread) = racine_forum($id_forum);
	if ($id_thread&gt;0 AND $show_thread)
		$id_forum = $id_thread;
	switch($type) {
		case 'article':
			return generer_url_article($id).&quot;#forum$id_forum&quot;;
			break;
		case 'breve':
			return generer_url_breve($id).&quot;#forum$id_forum&quot;;
			break;
		case 'rubrique':
			return generer_url_rubrique($id).&quot;#forum$id_forum&quot;;
			break;
		default:
			return &quot;forum.php3?id_forum=&quot;.$id_forum;
	}
}

?&gt;

--- NEW FILE: inc-admin.php3 ---
&lt;?php

// Inserer la feuille de style selon les normes, dans le &lt;head&gt;
// Feuilles de style admin : d'abord la CSS officielle, puis la perso,
function perso_admin($texte) {
	$css = &quot;&lt;link rel='stylesheet' href='spip_admin.css' type='text/css' /&gt;\n&quot;;
	if (@file_exists('spip_admin_perso.css'))
		$css2 = &quot;&lt;link rel='stylesheet' href='spip_admin_perso.css' type='text/css' /&gt;\n&quot;;

	if (eregi('&lt;(/head|body)', $texte, $regs)) {
		$texte = explode($regs[0], $texte, 2);
		return $texte[0] . $css. $css2 . $regs[0] . $texte[1];
	} else
		return $css . $css2 . $texte;
}

?&gt;

--- NEW FILE: backend-dist.html ---
&lt;?php echo '&lt;'.'?xml version=&quot;1.0&quot; encoding=&quot;#CHARSET&quot;?'.&quot;&gt;\n&quot;; ?&gt;
&lt;rss version=&quot;0.91&quot; xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;&gt;

&lt;channel&gt;
	&lt;title&gt;[(#NOM_SITE_SPIP|texte_backend)]&lt;/title&gt;
	&lt;link&gt;#URL_SITE_SPIP/&lt;/link&gt;
	&lt;description&gt;&lt;/description&gt;
	&lt;language&gt;#LANG&lt;/language&gt;

	&lt;image&gt;
		&lt;title&gt;[(#NOM_SITE_SPIP|texte_backend)]&lt;/title&gt;
		&lt;url&gt;#URL_SITE_SPIP[/(#LOGO_SITE_SPIP||extraire_attribut{src})]&lt;/url&gt;
		&lt;link&gt;#URL_SITE_SPIP/&lt;/link&gt;
		&lt;description&gt;&lt;/description&gt;
	&lt;/image&gt;

	&lt;BOUCLE_10recents(ARTICLES){lang ?}{branche ?}{par date}{inverse}{0,10}{unique}&gt;
		&lt;item&gt;
		&lt;title&gt;[(#TITRE|texte_backend)]&lt;/title&gt;
		&lt;link&gt;#URL_SITE_SPIP/#URL_ARTICLE&lt;/link&gt;
		&lt;date&gt;#DATE&lt;/date&gt;
		&lt;description&gt;[&lt;img src=&quot;#URL_SITE_SPIP/(#LOGO_ARTICLE||extraire_attribut{src})&quot; align=&quot;left&quot; hspace=&quot;4&quot; vspace=&quot;4&quot;&gt; ][(#INTRODUCTION|texte_backend)]&lt;/description&gt;
		&lt;author&gt;&lt;BOUCLE_auteurs(AUTEURS){id_article}{&quot;, &quot;}&gt;[(#NOM|texte_backend)]&lt;/BOUCLE_auteurs&gt;&lt;/author&gt;
		&lt;dc:date&gt;[(#DATE|date_iso)]&lt;/dc:date&gt;
		&lt;dc:format&gt;text/html&lt;/dc:format&gt;
		&lt;dc:language&gt;#LANG&lt;/dc:language&gt;
		&lt;dc:creator&gt;&lt;BOUCLE_auteursb(AUTEURS){id_article}{&quot;, &quot;}&gt;[(#NOM|texte_backend)]&lt;/BOUCLE_auteursb&gt;&lt;/dc:creator&gt;
		&lt;/item&gt;
	&lt;/BOUCLE_10recents&gt;
	&lt;BOUCLE_tres_recents(ARTICLES){lang ?}{branche ?}{par date}{inverse}{age&lt;3}{unique}&gt;
		&lt;item&gt;
		&lt;title&gt;[(#TITRE|texte_backend)]&lt;/title&gt;
		&lt;link&gt;#URL_SITE_SPIP/#URL_ARTICLE&lt;/link&gt;
		&lt;date&gt;#DATE&lt;/date&gt;
		&lt;description&gt;[&lt;img src=&quot;#URL_SITE_SPIP/(#LOGO_ARTICLE||extraire_attribut{src})&quot; align=&quot;left&quot; hspace=&quot;4&quot; vspace=&quot;4&quot;&gt; ][(#INTRODUCTION|texte_backend)]&lt;/description&gt;
		&lt;author&gt;&lt;BOUCLE_auteurs_t(AUTEURS){id_article}{&quot;,&quot;}&gt;[(#NOM|texte_backend)]&lt;/BOUCLE_auteurs_t&gt;&lt;/author&gt;
		&lt;dc:date&gt;[(#DATE|date_iso)]&lt;/dc:date&gt;
		&lt;dc:format&gt;text/html&lt;/dc:format&gt;
		&lt;dc:language&gt;#LANG&lt;/dc:language&gt;
		&lt;dc:creator&gt;&lt;BOUCLE_auteurs_tb(AUTEURS){id_article}{&quot;, &quot;}&gt;[(#NOM|texte_backend)]&lt;/BOUCLE_auteurs_tb&gt;&lt;/dc:creator&gt;
		&lt;/item&gt;
	&lt;/BOUCLE_tres_recents&gt;

&lt;/channel&gt;

&lt;/rss&gt;

--- NEW FILE: backend-breves-dist.html ---
&lt;?php echo '&lt;'.'?xml version=&quot;1.0&quot; encoding=&quot;#CHARSET&quot;?'.&quot;&gt;\n&quot;; ?&gt;
&lt;rss version=&quot;0.91&quot; xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;&gt;

&lt;channel&gt;

	&lt;title&gt;[(#NOM_SITE_SPIP|texte_backend)]&lt;/title&gt;
	&lt;link&gt;#URL_SITE_SPIP/&lt;/link&gt;
	&lt;description&gt;&lt;/description&gt;
	&lt;language&gt;#LANG&lt;/language&gt;

	&lt;image&gt;
		&lt;title&gt;[(#NOM_SITE_SPIP|texte_backend)]&lt;/title&gt;
		&lt;url&gt;#URL_SITE_SPIP[/(#LOGO_SITE_SPIP||extraire_attribut{src})]&lt;/url&gt;
		&lt;link&gt;#URL_SITE_SPIP/&lt;/link&gt;
		&lt;description&gt;&lt;/description&gt;
	&lt;/image&gt;

	&lt;BOUCLE_breves(BREVES){id_rubrique ?}{lang ?}{par date}{inverse}{0,10}&gt;
	&lt;item&gt;
		&lt;title&gt;[(#TITRE|texte_backend)]&lt;/title&gt;
		&lt;link&gt;#URL_SITE_SPIP/#URL_BREVE&lt;/link&gt;
		&lt;date&gt;#DATE&lt;/date&gt;
		&lt;description&gt;[&lt;img src=&quot;#URL_SITE_SPIP/(#LOGO_BREVE||extraire_attribut{src})&quot; align=&quot;left&quot; hspace=&quot;4&quot; vspace=&quot;4&quot;&gt; ][(#TEXTE|texte_backend)]&lt;/description&gt;
		&lt;dc:date&gt;[(#DATE|date_iso)]&lt;/dc:date&gt;
		&lt;dc:format&gt;text/html&lt;/dc:format&gt;
		&lt;dc:language&gt;#LANG&lt;/dc:language&gt;
	&lt;/item&gt;
	&lt;/BOUCLE_breves&gt;

&lt;/channel&gt;

&lt;/rss&gt;

--- NEW FILE: nouveautes-dist.html ---
[[(#NOM_SITE_SPIP|textebrut|texte_script)]] &lt;:nouveautes|texte_script:&gt;

&lt;B0&gt;
&lt;:bonjour|texte_script:&gt;

&lt;:texte_lettre_information|texte_script:&gt; &quot;[(#NOM_SITE_SPIP|textebrut|texte_script)]&quot; (#URL_SITE_SPIP).
&lt;:texte_lettre_information_2|texte_script:&gt; [(#HTTP_VARS{jours_neuf})] &lt;:jours|texte_script:&gt;.

&lt;BOUCLE0(AUTEURS){0,1}&gt;&lt;B_nv1&gt;
          &lt;:nouveaux_articles|texte_script:&gt;
          --------------------------

&lt;BOUCLE_nv1(ARTICLES){age_relatif&lt;=0}{par date}{inverse}{0,30}&gt;
[** (#TITRE|textebrut|texte_script) **]
[par (#LESAUTEURS|textebrut|texte_script)]
[le (#DATE|affdate|texte_script)]

[(#INTRODUCTION|textebrut|texte_script)]

-&gt; #URL_SITE_SPIP/#URL_ARTICLE

&lt;/BOUCLE_nv1&gt;&lt;B_nv2&gt;
          
          &lt;:nouvelles_breves|texte_script:&gt;
          --------------------------

&lt;BOUCLE_nv2(BREVES){age_relatif&lt;=0}{par date}{inverse}{0,30}&gt;
[* (#TITRE|textebrut|texte_script) *]
[ - (#DATE|affdate|texte_script)]

[(#INTRODUCTION|textebrut|texte_script)]

-&gt; #URL_SITE_SPIP/#URL_BREVE

&lt;/BOUCLE_nv2&gt;&lt;/BOUCLE0&gt;
--- NEW FILE: distrib.php3 ---
&lt;?php
$fond = &quot;distrib&quot;;
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
$flag_preserver = true;

include (&quot;inc-public.php3&quot;);

?&gt;
--- NEW FILE: distrib-dist.html ---
document.write('&lt;table border=&quot;0&quot; bgcolor=&quot;#000000&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;&lt;tr&gt;&lt;td&gt;');
document.write('&lt;table border=&quot;0&quot; bgcolor=&quot;#ffffff&quot; cellspacing=&quot;1&quot; cellpadding=&quot;2&quot;&gt;&lt;tr&gt;&lt;td bgcolor=&quot;#d0d0d0&quot; align=&quot;center&quot;&gt;');
document.write('&lt;a href=&quot;#URL_SITE_SPIP/&quot;&gt;&lt;b&gt;[(#NOM_SITE_SPIP|addslashes)]&lt;/b&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;ul&gt;&lt;small&gt;');
&lt;BOUCLE_articles(articles){tout}{par date}{inverse}{0,10}&gt;
document.write('&lt;li&gt;&lt;a href=&quot;#URL_SITE_SPIP/#URL_ARTICLE&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;[(#TITRE|addslashes)]&lt;/font&gt;&lt;/a&gt;&lt;/li&gt;\n');
&lt;/BOUCLE_articles&gt;
document.write('&lt;/small&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;');

--- NEW FILE: inc-stats.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_STATS&quot;)) return;
define(&quot;_INC_STATS&quot;, &quot;1&quot;);

function ecrire_stats() {
	global $id_article, $id_breve, $id_rubrique;

	if ($GLOBALS['HTTP_X_FORWARDED_FOR'])
		$log_ip = $GLOBALS['HTTP_X_FORWARDED_FOR'];
	else
		$log_ip = $GLOBALS['REMOTE_ADDR'];

	if ($log_id_num = intval($id_rubrique))
		$log_type = &quot;rubrique&quot;;
	else if ($log_id_num = intval($id_article))
		$log_type = &quot;article&quot;;
	else if ($log_id_num = intval($id_breve))
		$log_type = &quot;breve&quot;;
	else
		$log_type = &quot;autre&quot;;

	// Conversion IP 4 octets -&gt; entier 32 bits
	if (ereg(&quot;^(::ffff:)?([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$&quot;, $log_ip, $r)) {
		$log_ip = sprintf(&quot;0x%02x%02x%02x%02x&quot;, $r[2], $r[3], $r[4], $r[5]);
	}
	else return;

	//
	// Loguer la visite dans la base si possible
	//
	if ($log_type != &quot;autre&quot;) {
		$query = &quot;INSERT IGNORE INTO spip_visites_temp (ip, type, id_objet) &quot;.
			&quot;VALUES ($log_ip, '$log_type', $log_id_num)&quot;;
		spip_query($query);
	}

	//
	// Loguer le referer
	//
	$url_site_spip = lire_meta('adresse_site');
	$url_site_spip = eregi_replace(&quot;^((https?|ftp)://)?(www\.)?&quot;, &quot;&quot;, $url_site_spip);
	$log_referer = $GLOBALS['HTTP_REFERER'];
	if (($url_site_spip&lt;&gt;'') AND strpos('-'.strtolower($log_referer), strtolower($url_site_spip)) AND !$GLOBALS['var_recherche']) $log_referer = &quot;&quot;;
	if ($log_referer) {
		$referer_md5 = '0x'.substr(md5($log_referer), 0, 15);
		$query = &quot;INSERT IGNORE INTO spip_referers_temp (ip, referer, referer_md5, type, id_objet) &quot;.
			&quot;VALUES ($log_ip, '$log_referer', $referer_md5, '$log_type', $log_id_num)&quot;;
		spip_query($query);
	}
}


function afficher_raccourci_stats($id_article) {
	$query = &quot;SELECT visites, popularite FROM spip_articles WHERE id_article=$id_article AND statut='publie'&quot;;
	$result = spip_query($query);
	if ($row = @spip_fetch_array($result)) {
		$visites = intval($row['visites']);
		$popularite = ceil($row['popularite']);

		$query = &quot;SELECT COUNT(DISTINCT ip) AS c FROM spip_visites_temp WHERE type='article' AND id_objet=$id_article&quot;;
		$result = spip_query($query);
		if ($row = @spip_fetch_array($result)) {
			$visites = $visites + $row['c'];
		}

		return array('visites' =&gt; $visites, 'popularite' =&gt; $popularite);
	}
}

?&gt;

--- NEW FILE: forum-dist.html ---
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
&lt;html lang=&quot;#LANG&quot;&gt;
&lt;head&gt;
&lt;title&gt;[#NOM_SITE_SPIP] &lt;:poster_message:&gt;&lt;/title&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#CHARSET&quot;&gt;

&lt;!-- Ceci est la feuille de style par defaut pour les types internes a SPIP --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- Les feuilles de style specifiques aux presents squelettes --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;typographie.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- media=&quot;...&quot; permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;habillage.css&quot; type=&quot;text/css&quot; media=&quot;print, projection, screen, tv&quot;&gt;
&lt;/head&gt;

&lt;body bgcolor=&quot;white&quot; dir=&quot;#LANG_DIR&quot;&gt;


&lt;div id=&quot;navigation&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:navigation:&gt;&lt;/h1&gt;

&lt;!-- Menu de navigation general --&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;ul class=&quot;general&quot;&gt;
	&lt;li class=&quot;menu-titre&quot;&gt;
	[&lt;a href=&quot;(#URL_SITE_SPIP)&quot; title=&quot;&lt;:accueil_site:&gt;&quot;&gt;&lt;b&gt;#NOM_SITE_SPIP&lt;/b&gt;&lt;/a&gt;]
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;plan.php3&quot;&gt;&lt;:plan_site:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;resume.php3&quot; title=&quot;&lt;:articles_populaires:&gt;&quot;&gt;&lt;:en_resume:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;ecrire/&quot;&gt;&lt;:espace_prive:&gt;&lt;/a&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;

&lt;/div&gt;


&lt;!-- Contenu : poster un message dans le forum --&gt;

&lt;div id=&quot;principal&quot; class=&quot;contenu&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:poster_message:&gt;&lt;/h1&gt;

&lt;BOUCLE_article(ARTICLES) {id_article}&gt;
	&lt;:en_reponse:&gt;
	[(#LOGO_ARTICLE|right)]
	[&lt;div class=&quot;surtitre&quot;&gt;(#SURTITRE)&lt;/div&gt;]
	&lt;h2 class=&quot;titre-extrait&quot;&gt;&lt;a href=&quot;#URL_ARTICLE&quot;&gt;#TITRE&lt;/a&gt;&lt;/h2&gt;
	[&lt;div class=&quot;surtitre&quot;&gt;(#SOUSTITRE)&lt;/div&gt;]
	&lt;div class=&quot;detail&quot;&gt;
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	&lt;B_auteurs_un&gt;&lt;:par_auteur:&gt; &lt;BOUCLE_auteurs_un(AUTEURS) {id_article} {&quot;, &quot;}&gt;#NOM&lt;/BOUCLE_auteurs_un&gt;
	&lt;/div&gt;
	[&lt;div class=&quot;texte&quot;&gt;&lt;div class=&quot;extrait&quot;&gt;(#INTRODUCTION)&lt;/div&gt;&lt;/div&gt;]
	&lt;br&gt;
&lt;/BOUCLE_article&gt;

&lt;BOUCLE_breve(BREVES) {id_breve}&gt;
	&lt;:en_reponse:&gt;
	[(#LOGO_BREVE|right)]
	&lt;h2 class=&quot;titre-extrait&quot;&gt;&lt;a href=&quot;#URL_BREVE&quot;&gt;#TITRE&lt;/a&gt;&lt;/h2&gt;
	&lt;div class=&quot;detail&quot;&gt;
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	&lt;/div&gt;
	[&lt;div class=&quot;texte&quot;&gt;&lt;div class=&quot;extrait&quot;&gt;(#INTRODUCTION)&lt;/div&gt;&lt;/div&gt;]
	&lt;br&gt;
&lt;/BOUCLE_breve&gt;

&lt;BOUCLE_forum_parent(FORUMS) {id_forum}&gt;
	&lt;:en_reponse:&gt;
	&lt;h2 class=&quot;titre-extrait&quot;&gt;&lt;a href=&quot;#URL_BREVE&quot;&gt;#TITRE&lt;/a&gt;&lt;/h2&gt;
	&lt;div class=&quot;detail&quot;&gt;
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	&lt;/div&gt;
	[&lt;div class=&quot;texte&quot;&gt;&lt;div class=&quot;extrait&quot;&gt;(#TEXTE)&lt;/div&gt;&lt;/div&gt;]
	&lt;br&gt;
&lt;/BOUCLE_forum_parent&gt;


#FORMULAIRE_FORUM


&lt;/div&gt;

#FORMULAIRE_ADMIN
&lt;/body&gt;
&lt;/html&gt;



--- NEW FILE: mes_fonctions.php3 ---
&lt;?php

function wkt2style($geometrie){
	$debut=strpos($geometrie,&quot;(&quot;);
	$milieu=strpos($geometrie,&quot;,&quot;);
	$fin=strpos($geometrie,&quot;;&quot;);
	$returned_str=&quot;top: &quot;.substr($geometrie,$milieu+1,$fin-$milieu-1).&quot;px;left: &quot;.substr($geometrie,$debut+1,$milieu-$debut-1).&quot;px;&quot;;
	return $returned_str;
}
/////////////////////////////
//CARTO
/////////////////////////////
global $tables_principales,$table_primary,$tables_auxiliaires;

$spip_carto_carte = array(
	&quot;id_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
	&quot;commentaire&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
	&quot;fichier&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
	&quot;callage&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
	&quot;id_srs&quot; =&gt; &quot;bigint(21) NOT NULL&quot;);

$spip_carto_carte_key = array(
	&quot;PRIMARY KEY&quot; =&gt; &quot;id_carte&quot;,
	&quot;KEY id_carte&quot; =&gt; &quot;id_carte&quot;);

$spip_carto_objet = array(
	&quot;id_objet&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
	&quot;id_carte&quot; =&gt; &quot;bigint(21) NOT NULL&quot;,
	&quot;titre&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
	&quot;commentaire&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;,
	&quot;lien&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
	&quot;logo&quot; =&gt; &quot;VARCHAR(255) BINARY NOT NULL&quot;,
	&quot;geometrie&quot; =&gt; &quot;TEXT BINARY NOT NULL&quot;);
	
$spip_carto_objet_key = array(
	&quot;PRIMARY KEY&quot; =&gt; &quot;id_objet&quot;,
	&quot;KEY id_carte&quot; =&gt; &quot;id_carte&quot;,
	&quot;KEY titre&quot; =&gt; &quot;titre&quot;);

$tables_principales['carto_objet'] =
	array('field' =&gt; &amp;$spip_carto_objet, 'key' =&gt; &amp;$spip_carto_objet_key);
$tables_principales['carto_carte'] =
	array('field' =&gt; &amp;$spip_carto_carte, 'key' =&gt; &amp;$spip_carto_carte_key);

$table_primary['carto_carte']=&quot;id_carte&quot;;

$spip_carto_carte_articles = array(
	&quot;id_carte&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
	&quot;id_article&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);

$spip_carto_carte_articles_key = array(
	&quot;KEY id_carte&quot; 	=&gt; &quot;id_form&quot;,
	&quot;KEY id_article&quot; =&gt; &quot;id_article&quot;);

$tables_auxiliaires['carto_carte_articles'] = array(
	'field' =&gt; &amp;$spip_carto_carte_articles,
	'key' =&gt; &amp;$spip_carto_carte_articles_key);

$spip_mots_carto_objet= array(
	&quot;id_carto_objet&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;,
	&quot;id_mot&quot; 	=&gt; &quot;BIGINT (21) DEFAULT '0' NOT NULL&quot;);

$spip_mots_carto_objet_key = array(
	&quot;KEY id_carto_objet&quot; 	=&gt; &quot;id_carto_objet&quot;,
	&quot;KEY id_mot&quot; =&gt; &quot;id_mot&quot;);

$tables_principales['mots_carto_objets'] = array(
	'field' =&gt; &amp;$spip_mots_carto_objet,
	'key' =&gt; &amp;$spip_mots_carto_objet_key);

/*
 *   +---------------------------------------------+
 *    Nom du Filtre : WKT to COORDS
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : 
 *    site :  
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#GEOMETRIE|wkt2coords)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
 *
 */
function wkt2coords($geometrie){
	
	return str_replace(';',',',substr($geometrie,8,-1));
}
/*
 *   +---------------------------------------------+
 *    Nom du Filtre : WKT to SHAPE 
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : 
 *    site :  
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#GEOMETRIE|wkt2shape)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
 *
 */
function wkt2shape($geometrie){
	
	return substr($geometrie,0,4);
}

/*
 *   +---------------------------------------------+
 *    Nom du Filtre : Nombre de messages 
 *   +---------------------------------------------+
 *    Date : mercredi 09 avril 2003
 *    Auteur : BoOz Email:<A HREF="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">booz.bloog at laposte.net</A>
 *    site : <A HREF="http://bloog.net">http://bloog.net</A>
 *   +---------------------------------------------+
 *    Fonctions de ce filtre :
 *    Compte le nombre de messages d'un auteur
 *     Appelez le dans vos squellette tout simplement
 *     par : [(#ID_AUTEUR|nb_messages)]
 *   +---------------------------------------------+
 *  
 * Pour toute suggestion, remarque, proposition d'ajout
 * reportez-vous au forum de l'article :
 * <A HREF="http://www.uzine.net/spip_contrib/">http://www.uzine.net/spip_contrib/</A>
 *
 */


?&gt;

--- NEW FILE: auteur.php3 ---
&lt;?php
$fond = &quot;auteur&quot;;
$delais = 24 * 3600;

include (&quot;inc-public.php3&quot;);

?&gt;

--- NEW FILE: ical.php3 ---
&lt;?php

$fond = &quot;ical&quot;;
$delais = 3600;

@header (&quot;content-type:text/calendar&quot;);

$flag_preserver=true;
include (&quot;inc-public.php3&quot;);


?&gt;

--- NEW FILE: breve.php3 ---
&lt;?php
$fond = &quot;breve&quot;;
$delais = 12 * 3600;

include (&quot;inc-public.php3&quot;);


?&gt;

--- NEW FILE: inc-formulaire_recherche.php3 ---
&lt;?php

global $balise_FORMULAIRE_RECHERCHE_collecte;
$balise_FORMULAIRE_RECHERCHE_collecte = array();

function balise_FORMULAIRE_RECHERCHE_stat($args, $filtres)
{
  return (lire_meta(&quot;activer_moteur&quot;) != &quot;oui&quot;) ? '' : array($filtres[0]);
}
 
function balise_FORMULAIRE_RECHERCHE_dyn($lien) {
	return array('formulaire_recherche', 3600, 
		     array('lien' =&gt; ($lien ? $lien : 'recherche.php3'),
			   'recherche' =&gt; ($GLOBALS['recherche'] ? $GLOBALS['recherche'] : _T('info_rechercher'))));
}

?&gt;
--- NEW FILE: breve-dist.html ---
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
&lt;BOUCLE_breve_principal(BREVES) {id_breve}&gt;

&lt;html lang=&quot;#LANG&quot;&gt;
&lt;head&gt;
&lt;title&gt;#TITRE&lt;/title&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#CHARSET&quot;&gt;

&lt;!-- Ceci est la feuille de style par defaut pour les types internes a SPIP --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- Les feuilles de style specifiques aux presents squelettes --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;typographie.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- media=&quot;...&quot; permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;habillage.css&quot; type=&quot;text/css&quot; media=&quot;projection, screen, tv&quot;&gt;
&lt;!-- media=&quot;print&quot; permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;impression.css&quot; type=&quot;text/css&quot; media=&quot;print&quot;&gt;
&lt;/head&gt;

&lt;body bgcolor=&quot;white&quot; dir=&quot;#LANG_DIR&quot;&gt;


&lt;div id=&quot;navigation&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:navigation:&gt;&lt;/h1&gt;

&lt;!-- Menu de navigation general --&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;ul class=&quot;general&quot;&gt;
	&lt;li class=&quot;menu-titre&quot;&gt;
	[&lt;a href=&quot;(#URL_SITE_SPIP)&quot; title=&quot;&lt;:accueil_site:&gt;&quot;&gt;&lt;b&gt;#NOM_SITE_SPIP&lt;/b&gt;&lt;/a&gt;]
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;plan.php3&quot;&gt;&lt;:plan_site:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;resume.php3&quot; title=&quot;&lt;:articles_populaires:&gt;&quot;&gt;&lt;:en_resume:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;ecrire/&quot;&gt;&lt;:espace_prive:&gt;&lt;/a&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;

&lt;!-- Formulaire de recherche --&gt;

[(#FORMULAIRE_RECHERCHE)]

&lt;!-- Menu de navigation rubriques --&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;ul class=&quot;rubriques&quot;&gt;
&lt;BOUCLE_rubrique(RUBRIQUES) {id_rubrique}&gt;
&lt;li&gt;
&lt;div class=&quot;menu-titre&quot;&gt;&lt;a href=&quot;#URL_RUBRIQUE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;BOUCLE_autres_rubriques(RUBRIQUES) {racine} {exclus} {par titre}&gt;
	&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_RUBRIQUE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
&lt;/BOUCLE_autres_rubriques&gt;
&lt;/BOUCLE_rubrique&gt;
&lt;/ul&gt;
&lt;/div&gt;


&lt;!-- Menu de navigation mots-cles --&gt;

&lt;B_mots&gt;
&lt;div class=&quot;menu&quot;&gt;
&lt;ul class=&quot;divers&quot; title=&quot;&lt;:mots_clefs:&gt;&quot;&gt;
&lt;BOUCLE_mots(MOTS) {id_article} {par titre}&gt;
&lt;li&gt;
&lt;div class=&quot;menu-titre&quot;&gt;&lt;a href=&quot;#URL_MOT&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/div&gt;
&lt;B_breves_mots&gt;
	&lt;ul class=&quot;menu-liste&quot;&gt;
&lt;BOUCLE_breves_mots(BREVES) {id_mot} {par hasard} {0,4}&gt;
	&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_BREVE&quot;&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
&lt;/BOUCLE_breves_mots&gt;
	&lt;/ul&gt;
&lt;/B_breves_mots&gt;
&lt;/li&gt;
&lt;/BOUCLE_mots&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/B_mots&gt;


&lt;!-- Articles dans le meme secteur --&gt;

&lt;B_articles_secteur&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;div class=&quot;breves&quot; title=&quot;&lt;:derniers_articles:&gt;&quot;&gt;
	&lt;div class=&quot;menu-titre&quot;&gt;
	&lt;:derniers_articles:&gt;
	&lt;/div&gt;
	&lt;ul&gt;
&lt;BOUCLE_articles_secteur(ARTICLES) {id_secteur} {par date} {inverse} {0,5}&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;#URL_ARTICLE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;
	&lt;/li&gt;
&lt;/BOUCLE_articles_secteur&gt;
	&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/B_articles_secteur&gt;


&lt;/div&gt;

&lt;!-- Contenu : corps de la breve --&gt;

&lt;div class=&quot;contenu&quot; id=&quot;principal&quot;&gt;

&lt;div id=&quot;cartouche&quot;&gt;
[(#LOGO_BREVE|left)]
&lt;h1 class=&quot;titre-texte&quot;&gt;#TITRE&lt;/h1&gt;
[(#DATE|nom_jour)] [(#DATE|affdate).]
&lt;/div&gt;

	&lt;div class=&quot;encart&quot;&gt;

	&lt;!-- Breves dans la meme rubrique --&gt;

	&lt;B_breves_rubrique&gt;

	&lt;div class=&quot;menu&quot;&gt;
	&lt;div class=&quot;breves&quot; title=&quot;&lt;:meme_rubrique:&gt;&quot;&gt;
		&lt;h1 class=&quot;structure&quot;&gt;&lt;:meme_rubrique:&gt;&lt;/h1&gt;
		&lt;div class=&quot;menu-titre&quot;&gt;
		&lt;:autres_breves:&gt;
		&lt;/div&gt;
		&lt;ul&gt;
	&lt;BOUCLE_breves_rubrique(BREVES) {id_rubrique} {exclus} {par date} {inverse} {0,8}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;
		&lt;i&gt;[(#DATE|affdate_court)]&lt;/i&gt;:
		&lt;a href=&quot;#URL_BREVE&quot;&gt;#TITRE&lt;/a&gt;
		&lt;/li&gt;
	&lt;/BOUCLE_breves_rubrique&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;/div&gt;

	&lt;/B_breves_rubrique&gt;

	&lt;/div&gt;


[&lt;div class=&quot;texte&quot;&gt;(#TEXTE)&lt;/div&gt;]
[&lt;div class=&quot;chapo&quot;&gt;&lt;:voir_en_ligne:&gt;: &lt;a href=&quot;(#URL_SITE)&quot; class=&quot;spip_out&quot;&gt;#NOM_SITE&lt;/a&gt;.&lt;/div&gt;]
[&lt;div class=&quot;notes&quot;&gt;(#NOTES)&lt;/div&gt;]

&lt;br&gt;


&lt;!-- Forums --&gt;

[&lt;div class=&quot;forum-repondre&quot;&gt;&lt;B&gt;&lt;A  HREF=&quot;forum.php3?(#PARAMETRES_FORUM)&quot;&gt;&lt;:repondre_breve:&gt;&lt;/A&gt;&lt;/B&gt;&lt;/div&gt;]
&lt;br&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:forum:&gt;&lt;/h1&gt;

&lt;B_forums&gt;
&lt;ul class=&quot;forum-total&quot;&gt;

&lt;BOUCLE_forums(FORUMS){id_breve}{par date}{inverse}&gt;

&lt;li&gt;
&lt;div class=&quot;forum-fil&quot;&gt;
&lt;div class=&quot;forum&quot;&gt;
&lt;a name=&quot;forum#ID_FORUM&quot;&gt;&lt;/a&gt;
&lt;div class=&quot;forum-chapo&quot;&gt;
&lt;div class=&quot;forum-titre&quot;&gt;#TITRE&lt;/div&gt;
[(#DATE|affdate)][, &lt;:par_auteur:&gt; &lt;A HREF=&quot;mailto:#EMAIL&quot;&gt;(#NOM)&lt;/A&gt;]
&lt;/div&gt;
&lt;div class=&quot;forum-item&quot;&gt;
#TEXTE
[&lt;div class=&quot;forum-titre&quot;&gt;&lt;a href=&quot;(#URL_SITE)&quot; class=&quot;spip_out&quot;&gt;#NOM_SITE&lt;/a&gt;&lt;/div&gt;]
[&lt;div class=&quot;forum-repondre-message&quot;&gt;&lt;a href=&quot;forum.php3?(#PARAMETRES_FORUM)&quot;&gt;&lt;:repondre_message:&gt;&lt;/a&gt;&lt;/div&gt;]
&lt;/div&gt;
&lt;/div&gt;

&lt;B_forums_fils&gt;
	&lt;ul&gt;
	&lt;BOUCLE_forums_fils(FORUMS){id_parent}{par date}&gt;

	&lt;li&gt;
	&lt;div class=&quot;forum&quot;&gt;
	&lt;a name=&quot;forum#ID_FORUM&quot;&gt;&lt;/a&gt;
	&lt;div class=&quot;forum-chapo&quot;&gt;
	&lt;div class=&quot;forum-titre&quot;&gt;#TITRE&lt;/div&gt;
	[(#DATE|affdate)][, par &lt;A HREF=&quot;mailto:#EMAIL&quot;&gt;(#NOM)&lt;/A&gt;]
	&lt;/div&gt;
	&lt;div class=&quot;forum-item&quot;&gt;
	#TEXTE
	[&lt;div class=&quot;forum-titre&quot;&gt;&lt;a href=&quot;(#URL_SITE)&quot; class=&quot;spip_out&quot;&gt;#NOM_SITE&lt;/a&gt;&lt;/div&gt;]
	[&lt;div class=&quot;forum-repondre-message&quot;&gt;&lt;a href=&quot;forum.php3?(#PARAMETRES_FORUM)&quot;&gt;&lt;:repondre_message:&gt;&lt;/a&gt;&lt;/div&gt;]
	&lt;/div&gt;

	&lt;/div&gt;

	&lt;BOUCLE_Forums_Boucle(boucle_forums_fils)&gt;&lt;/BOUCLE_Forums_Boucle&gt;
	&lt;/li&gt;

	&lt;/BOUCLE_forums_fils&gt;
	&lt;/ul&gt;
&lt;/B_forums_fils&gt;

&lt;/div&gt;
&lt;/li&gt;
&lt;/BOUCLE_forums&gt;

&lt;/ul&gt;
&lt;/B_forums&gt;

&lt;/div&gt;
#FORMULAIRE_ADMIN
&lt;/body&gt;&lt;/html&gt;
&lt;/BOUCLE_breve_principal&gt;
&lt;:aucune_breve:&gt;
&lt;//B_breve_principal&gt;

--- NEW FILE: plan.php3 ---
&lt;?php

$fond = &quot;plan&quot;;
$delais = 2 * 3600;

include (&quot;inc-public.php3&quot;);

?&gt;

--- NEW FILE: inc-messforum.php3 ---
&lt;?php

include_ecrire('inc_meta.php3');
include_ecrire('inc_forum.php3');

// Ce fichier inclus par inc-public a un comportement special
// Voir commentaires dans celui-ci et dans inc-formulaire_forum

function prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre)
{
	include_ecrire('inc_texte.php3');
	include_ecrire('inc_filtres.php3');
	include_ecrire('inc_mail.php3');
	// Gestionnaire d'URLs
	if (@file_exists(&quot;inc-urls.php3&quot;))
	  include_local(&quot;inc-urls.php3&quot;);
	else
	  include_local(&quot;inc-urls-&quot;.$GLOBALS['type_urls'].&quot;.php3&quot;);
	$url = ereg_replace('^/', '', generer_url_article($id_article));
	$adresse_site = lire_meta(&quot;adresse_site&quot;);
	$nom_site_spip = lire_meta(&quot;nom_site&quot;);
	$url = &quot;$adresse_site/$url&quot;;
	$parauteur = (strlen($auteur) &lt;= 2) ? '' :
	  (&quot; &quot;
	   ._T('forum_par_auteur',
	       array('auteur' =&gt; $auteur)) .
	   (!$email_auteur ? '' : (' &lt;' . $email_auteur . '&gt;')));
	$courr =  _T('form_forum_message_auto').&quot;\n\n&quot;
		. _T('forum_poste_par',
		     array('parauteur' =&gt; $parauteur)).&quot;\n&quot;
		. _T('forum_ne_repondez_pas').&quot;\n&quot;
		. $url
		. &quot;\n\n\n&quot;.$titre.&quot;\n\n&quot;.textebrut(propre($texte))
		. &quot;\n\n$nom_site_forum\n$url_site\n&quot;;
	$sujet = &quot;[$nom_site_spip] [&quot;._T('forum_forum').&quot;] $titre&quot;;
	$result = spip_query(&quot;SELECT auteurs.email FROM spip_auteurs AS auteurs,
				spip_auteurs_articles AS lien
				WHERE lien.id_article='$id_article'
				AND auteurs.id_auteur=lien.id_auteur&quot;);

	while (list($email) = spip_fetch_array($result)) {
		$email = trim($email);
		if (strlen($email) &lt; 3) continue;
		envoyer_mail($email, $sujet, $courr);
	}
}	

$retour_forum = rawurldecode($retour);
$forum_id_article = intval($id_article);
$forum_id_rubrique = intval($id_rubrique);
$forum_id_forum = intval($id_forum);
$forum_id_breve = intval($id_breve);
$forum_id_syndic = intval($id_syndic);
$slash_texte = addslashes($texte);
$slash_titre = addslashes($titre);
$slash_nom_site_forum = addslashes($nom_site_forum);
$slash_url_site = addslashes($url_site);
$id_message = intval($id_message);

if (!$id_auteur)
	$id_auteur = intval($auteur_session['id_auteur']);

if ($forum_id_article) {
	$r = spip_query(&quot;SELECT accepter_forum FROM spip_articles WHERE id_article=$forum_id_article&quot;);
	$r = spip_fetch_array($r);
	if ($r)
		$forums_publics = $r['accepter_forum'];
	else
		$forums_publics = lire_meta(&quot;forums_publics&quot;);
} else {
	$forums_publics = substr(lire_meta(&quot;forums_publics&quot;),0,3);
}

if ($forums_publics == &quot;abo&quot;) {
	if ($auteur_session) {
		$statut = $auteur_session['statut'];
		if (!$statut OR $statut == '5poubelle') {
			ask_php_auth(_T('forum_acces_refuse'),
				     _T('forum_cliquer_retour',
					array('retour_forum' =&gt; $retour_forum)));
			exit;		  
		}
	}
	else {
		ask_php_auth(_T('forum_non_inscrit'),
			     _T('forum_cliquer_retour',
				array('retour_forum' =&gt; $retour_forum)));
		exit;		  
	}

	// Ne pas autoriser de changement de nom si forum sur abonnement
	$auteur = $auteur_session['nom'];
	$email_auteur = $auteur_session['email'];
 } 

$slash_auteur = addslashes($auteur);
$slash_email_auteur = addslashes($email_auteur);

if ((strlen($slash_texte) + strlen($slash_titre) + strlen($slash_nom_site_forum) + strlen($slash_url_site) + strlen($slash_auteur) + strlen($slash_email_auteur)) &gt; 20 * 1024) {
	ask_php_auth(_T('forum_message_trop_long'),
		     _T('forum_cliquer_retour',
			array('retour_forum' =&gt; $retour_forum)));
			exit;		  
}

spip_query(&quot;DELETE FROM spip_mots_forum WHERE id_forum='$id_message'&quot;);
if ($ajouter_mot) {
	for (reset($ajouter_mot);$key=key($ajouter_mot);next($ajouter_mot))
		$les_mots .= &quot;,&quot;.join($ajouter_mot[$key],&quot;,&quot;);
	$les_mots = explode(&quot;,&quot;, $les_mots);
	for ($index = 0; $index &lt; count($les_mots); $index++){
		$le_mot = $les_mots[$index];
		if ($le_mot &gt; 0)
		spip_query(&quot;INSERT INTO spip_mots_forum (id_mot, id_forum)
		VALUES ('$le_mot', '$id_message')&quot;);
	}
}

$validation_finale = (strlen($confirmer) &gt; 0 OR
	($afficher_texte=='non' AND $ajouter_mot));
$statut = ((!$validation_finale) ? 'redac' : 
	(($forums_publics == 'non') ? 'off' :
	(($forums_publics == 'pri') ? 'prop' : 'publie')));

if ($forum_id_forum &gt; 0) $id_thread = $forum_id_forum;
else $id_thread = $id_message;

spip_query(&quot;UPDATE spip_forum SET id_parent = $forum_id_forum,
	id_rubrique =$forum_id_rubrique,
	id_article = $forum_id_article,
	id_breve = $forum_id_breve,
	id_syndic = $forum_id_syndic,
	id_auteur = $id_auteur,
	id_thread = $id_thread,
	date_heure = NOW(),
	titre = \&quot;$slash_titre\&quot;,
	texte = \&quot;$slash_texte\&quot;,
	nom_site = \&quot;$slash_nom_site_forum\&quot;,
	url_site = \&quot;$slash_url_site\&quot;,
	auteur = \&quot;$slash_auteur\&quot;,
	email_auteur = \&quot;$slash_email_auteur\&quot;,
	ip = \&quot;$REMOTE_ADDR\&quot;,
	statut = \&quot;$statut\&quot;
	WHERE id_forum = '$id_message'
&quot;);

//calculer_threads();

if ($validation_finale) {
	include_ecrire(&quot;inc_admin.php3&quot;);
	if (!(verifier_action_auteur(&quot;ajout_forum $forum_id_rubrique&quot;.
	&quot; $forum_id_forum $forum_id_article $forum_id_breve&quot;.
	&quot; $forum_id_syndic $alea&quot;, $hash))) {
		header(&quot;Status: 404&quot;);
		exit;
	} else {
	  if (lire_meta(&quot;prevenir_auteurs&quot;) == &quot;oui&quot; AND ($afficher_texte != &quot;non&quot;) AND ($id_article = $forum_id_article)) {
			prevenir_auteurs($auteur, $email_auteur, $id_article, $texte, $titre);

		}
		// Poser un cookie pour ne pas retaper le nom / email
		$cookie_user = array('nom' =&gt; $auteur, 'email' =&gt; $email_auteur);
		spip_setcookie('spip_forum_user', serialize($cookie_user));

		//
		// INVALIDATION DES CACHES LIES AUX FORUMS
		//
		include_ecrire('inc_invalideur.php3');
		if ($statut == 'publie') {
			suivre_invalideur (&quot;id='id_forum/&quot; .
				calcul_index_forum($forum_id_article,
					$forum_id_breve,
					$forum_id_rubrique,
					$forum_id_syndic) . &quot;'&quot;);
		}

		$redirect = $retour_forum;
	}
}

?&gt;

--- NEW FILE: inc-cache.php3 ---
&lt;?php

//
// Ce fichier ne sera execute qu'une fois
if (defined(&quot;_INC_CACHE&quot;)) return;
define(&quot;_INC_CACHE&quot;, &quot;1&quot;);


//
// Calcul du nom du fichier cache
//

function nettoyer_uri() {
	$fichier_requete = $GLOBALS['REQUEST_URI'];
	$fichier_requete = eregi_replace
		('[?&amp;](PHPSESSID|(var_[^=&amp;]*))=[^&amp;]*',
		'', $fichier_requete);
	return $fichier_requete;
}

//
// Le format souhaite : &quot;CACHE/a/(8400/)bout-d-url.md5(.gz)&quot;
// Attention a modifier simultanement le sanity check de
// la fonction retire_cache()
//
function generer_nom_fichier_cache($contexte='', $fond='') {
	global $delais;
	global $flag_gz, $compresser_cache;

	if ($delais == 0) return '';

	if (!$contexte) {
		$fichier_requete = nettoyer_uri();
	} else {
		$fichier_requete = $fond;
		foreach ($contexte as $var=&gt;$val)
			$fichier_requete .= &quot;&amp;$var=$val&quot;;
	}

	$md_cache = md5($fichier_requete);

	$fichier_cache = ereg_replace('^/+', '', $fichier_requete);
	$fichier_cache = ereg_replace('\.[a-zA-Z0-9]*', '', $fichier_cache);
	$fichier_cache = ereg_replace('&amp;[^&amp;]+=([^&amp;]+)', '&amp;\1', $fichier_cache);
	$fichier_cache = rawurlencode(strtr($fichier_cache, '/&amp;-', '--_'));
	if (strlen($fichier_cache) &gt; 24)
		$fichier_cache = substr(ereg_replace('([a-zA-Z]{1,3})[^-]*-',
		'\1-', $fichier_cache), -22);

	// Pour la page d'accueil
	if (!$fichier_cache)
		$fichier_cache = 'INDEX-';

	// morceau de md5
	$fichier_cache .= '.'.substr($md_cache, 1, 8);

	// Sous-repertoires 0...9a..f/
	$subdir = creer_repertoire(_DIR_CACHE, substr($md_cache, 0, 1));
	// Sous-sous-repertoires delais/ (inutile avec l'invalidation par 't')
	# $subdir2 = creer_repertoire(&quot;CACHE/$subdir&quot;, $delais);

	include_ecrire('inc_acces.php3');
	verifier_htaccess(_DIR_CACHE);

	$gzip = $flag_gz &amp;&amp; $compresser_cache ? '.gz' : '';

	return _DIR_CACHE . $subdir.$subdir2.$fichier_cache.$gzip;
}

//
// Destruction des fichiers caches invalides
//
// NE PAS appeler ces fonctions depuis l'espace prive 
// car openbase_dir peut leur interdire l'acces au repertoire de cache

// Securite : est sur que c'est un cache
function retire_cache($cache) {
	if ($GLOBALS['flag_ecrire']) return;
	if (preg_match('|^' . _DIR_CACHE .
		&quot;([0-9a-f]/)?([0-9]+/)?[^.][\-_\%0-9a-z]+\.[0-9a-f]+(\.gz)?$|i&quot;,
		       $cache)) {
		// supprimer le fichier (de facon propre)
		supprimer_fichier($cache);
	} else
		spip_log(&quot;Impossible de retirer $cache&quot;);
}

// Supprimer les caches marques &quot;x&quot;
function retire_caches() {
	if ($GLOBALS['flag_ecrire']) return;

	// signaler
	effacer_meta('invalider');
	ecrire_metas();

	// recuperer la liste des caches voues a la suppression
	$suppr = array();
	$q = spip_query(&quot;SELECT fichier FROM spip_caches WHERE type='x'&quot;);
	while ($r = spip_fetch_array($q))
		$suppr[$r['fichier']] = true;

	if ($n = count($suppr)) {
		spip_log (&quot;Retire $n caches&quot;);
		foreach ($suppr as $cache =&gt; $ignore)
			retire_cache($cache);
		spip_query(&quot;DELETE FROM spip_caches WHERE &quot;
		.calcul_mysql_in('fichier', &quot;'&quot;.join(&quot;','&quot;,$suppr).&quot;'&quot;) );
	}
}

//
// Retourne 0 s'il faut calculer le cache, 1 si on peut l'utiliser
//
function utiliser_cache($chemin_cache, $delais) {
	global $HTTP_SERVER_VARS;

	// ne jamais calculer pour les moteurs de recherche, proxies...
	if ($HTTP_SERVER_VARS['REQUEST_METHOD'] == 'HEAD')
		return 1;

	//  calcul par forcage
	if ($GLOBALS['var_mode'] &amp;&amp;
		($GLOBALS['HTTP_COOKIE_VARS']['spip_session']
		|| $GLOBALS['HTTP_COOKIE_VARS']['spip_admin']
		|| @file_exists(_ACCESS_FILE_NAME))) # insuffisant...
		return 0;

	// calcul par absence
	if (!@file_exists($chemin_cache)) return 0;

	// calcul par obsolescence
	return ((time() - @filemtime($chemin_cache)) &gt; $delais) ? 0 : 1;
}


// Obsolete ?  Utilisee pour vider le cache depuis l'espace prive
// (ou juste les squelettes si un changement de config le necessite)
function purger_repertoire($dir, $age='ignore', $regexp = '') {
	$handle = @opendir($dir);
	if (!$handle) return;

	while (($fichier = @readdir($handle)) != '') {
		// Eviter &quot;.&quot;, &quot;..&quot;, &quot;.htaccess&quot;, etc.
		if ($fichier[0] == '.') continue;
		if ($regexp AND !ereg($regexp, $fichier)) continue;
		$chemin = &quot;$dir/$fichier&quot;;
		if (is_file($chemin))
			@unlink($chemin);
		else if (is_dir($chemin))
			if ($fichier != 'CVS')
				purger_repertoire($chemin);
	}
	closedir($handle);
}

function purger_cache() {
	spip_log('vider le cache');
	include_ecrire('inc_invalideur.php3');
	supprime_invalideurs();
	purger_repertoire(_DIR_CACHE, 0);
}

function purger_squelettes() {
	spip_log('effacer les squelettes compiles');
	purger_repertoire(_DIR_CACHE, 0, '^skel_');
}


// Determination du fichier cache (si besoin)
function determiner_cache($delais, &amp;$use_cache, &amp;$chemin_cache) {

	// Le fichier cache est-il valide ?
	if ($delais == 0 OR !empty($GLOBALS['HTTP_POST_VARS'])) {
		$use_cache = 0;
		$chemin_cache = '';
	} else {
		$use_cache = utiliser_cache($chemin_cache, $delais);
	}

	// Sinon, tester qu'on a la connexion a la base
	if (!$use_cache) {
		include_local(_FILE_CONNECT);
		if (!$GLOBALS['db_ok']) {
			if ($chemin_cache AND @file_exists($chemin_cache)) {
				$use_cache = 1;
			}
			else {
				spip_log(&quot;Erreur base de donnees &amp; &quot;
					. &quot;impossible utiliser $chemin_cache&quot;);
				if (!$GLOBALS['flag_preserver']) {
					include_ecrire('inc_presentation.php3');
					install_debut_html(_T('info_travaux_titre'));
					echo _T('titre_probleme_technique');
					install_fin_html();
				}
				exit;
			}
		}
	}
}

?&gt;

--- NEW FILE: formulaire_oubli-dist.html ---
[
(#HTTP_VARS*{message})
][
(#HTTP_VARS*{message}|?{'',' '})
&lt;form id=&quot;oubli_form&quot; action='spip_pass.php3' method='post'&gt;
	&lt;fieldset style=&quot;border: none;&quot;&gt;&lt;legend&gt;&lt;/legend&gt;[
	&lt;:pass_nouveau_pass:&gt;
	&lt;input type='hidden' name=&quot;p&quot; value=&quot;(#HTTP_VARS{p})&quot;&gt;
	&lt;label&gt;
	    &lt;:pass_choix_pass:&gt;
	    &lt;input type=&quot;password&quot; name=&quot;oubli&quot;&gt;
	&lt;/label&gt;][
	(#HTTP_VARS{p}|?{'',' '})
	&lt;label&gt;
	  &lt;:pass_indiquez_cidessous:&gt;
	  &lt;input type=&quot;texte&quot; name=&quot;oubli&quot;&gt;
	&lt;/label&gt;]
	&lt;input type=submit class=&quot;fondl&quot; value=&quot;&lt;:pass_ok:&gt;&quot;&gt;
      &lt;/fieldset&gt;
&lt;/form&gt;
]
&lt;br /&gt;
&lt;div align=&quot;right&quot;&gt;
&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--
[
(#HTTP_VARS*{message}|?{'',' '})
document.oubli_form.oubli.focus()
]
document.write(&quot;&lt;a href='&quot;)
document.write((window.opener) ? &quot;javascript:close()&quot; : &quot;./&quot;)
document.write(&quot;'&gt;&lt;:pass_quitter_fenetre:&gt;&lt;&quot; + &quot;/a&gt;&quot;);
//--&gt;&lt;/script&gt;
&lt;noscript&gt;
	&#91;&lt;a href='./'&gt;&lt;:pass_retour_public:&gt;&lt;/a&gt;&#93;
&lt;/noscript&gt;
&lt;/div&gt;
&lt;br /&gt;

--- NEW FILE: inc-menu_lang.php3 ---
&lt;?php

global $balise_MENU_LANG_collecte;
$balise_MENU_LANG_collecte = array('menu_lang');

// s'il n'y a qu'une langue eviter definitivement la balise ?php 

function balise_MENU_LANG_stat ($args, $filtres)
{
  if (!strpos(lire_meta('langues_multilingue'),',')) return '';
  return $args;
}

// normalement $opt sera toujours non vide suite au test ci-dessus

function balise_MENU_LANG_dyn($default)
{
  include_ecrire(&quot;inc_lang.php3&quot;);
  $opt = liste_options_langues('var_lang', $default);
  if (!$opt) return '';
  include_local(&quot;inc-menu_lang_ecrire.php3&quot;);
  return menu_lang_pour_tous('var_lang', $opt);
}
?&gt;

--- NEW FILE: auteur-dist.html ---
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
&lt;BOUCLE_auteur_principal(AUTEURS) {id_auteur}&gt;

&lt;html lang=&quot;#LANG&quot;&gt;
&lt;head&gt;
&lt;title&gt;[(#NOM|textebrut)]&lt;/title&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#CHARSET&quot;&gt;

&lt;!-- Ceci est la feuille de style par defaut pour les types internes a SPIP --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- Les feuilles de style specifiques aux presents squelettes --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;typographie.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- media=&quot;...&quot; permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;habillage.css&quot; type=&quot;text/css&quot; media=&quot;projection, screen, tv&quot;&gt;
&lt;!-- media=&quot;print&quot; permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;impression.css&quot; type=&quot;text/css&quot; media=&quot;print&quot;&gt;
&lt;/head&gt;

&lt;body bgcolor=&quot;white&quot;&gt;

&lt;div id=&quot;navigation&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:navigation:&gt;&lt;/h1&gt;

&lt;!-- Menu de navigation general --&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;ul class=&quot;general&quot;&gt;
	&lt;li class=&quot;menu-titre&quot;&gt;
	[&lt;a href=&quot;(#URL_SITE_SPIP)&quot; title=&quot;&lt;:accueil_site:&gt;&quot;&gt;&lt;b&gt;#NOM_SITE_SPIP&lt;/b&gt;&lt;/a&gt;]
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;plan.php3&quot;&gt;&lt;:plan_site:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;resume.php3&quot; title=&quot;&lt;:articles_populaires:&gt;&quot;&gt;&lt;:en_resume:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;ecrire/&quot;&gt;&lt;:espace_prive:&gt;&lt;/a&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;


&lt;!-- Formulaire de recherche --&gt;

[(#FORMULAIRE_RECHERCHE)]


&lt;/div&gt;


&lt;!-- Une : affichage de l'auteur --&gt;

&lt;div class=&quot;contenu&quot; id=&quot;principal&quot;&gt;

&lt;div class=&quot;cartouche&quot;&gt;
[(#LOGO_AUTEUR|left)]
&lt;h1 class=&quot;titre-texte&quot;&gt;#NOM&lt;/h1&gt;

[&lt;div class=&quot;chapo&quot;&gt;(#BIO)&lt;/div&gt;]
[&lt;br&gt;#NOM_SITE : &lt;a href=&quot;(#URL_SITE)&quot;&gt;#URL_SITE&lt;/a&gt;&lt;br&gt;]
[&lt;div class=&quot;notes&quot;&gt;(#NOTES)&lt;/div&gt;]
&lt;/div&gt;

[&lt;p&gt;&lt;b&gt;&lt;:envoyer_message:&gt;&lt;/b&gt;&lt;/p&gt;
&lt;div class='spip_encadrer'&gt;&lt;b&gt;(#FORMULAIRE_ECRIRE_AUTEUR)&lt;/b&gt;&lt;/div&gt;]

&lt;!-- Articles de l'auteur --&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:articles_auteur:&gt;&lt;/h1&gt;

&lt;div class=&quot;liste-articles&quot;&gt;

&lt;BOUCLE_articles(ARTICLES) {id_auteur} {par titre}&gt;
	&lt;h2&gt;&lt;a href=&quot;#URL_ARTICLE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/h2&gt;
	&lt;div class=&quot;detail&quot;&gt;
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	&lt;B_auteurs&gt;&lt;:par_auteur:&gt; &lt;BOUCLE_auteurs(AUTEURS) {id_article} {&quot;, &quot;}&gt;#NOM&lt;/BOUCLE_auteurs&gt;
	&lt;/div&gt;
	&lt;br&gt;
&lt;/BOUCLE_articles&gt;

&lt;/div&gt;

&lt;/div&gt;
#FORMULAIRE_ADMIN
&lt;/body&gt;
&lt;/html&gt;

&lt;/BOUCLE_auteur_principal&gt;
&lt;:aucun_auteur:&gt;
&lt;//B_auteur_principal&gt;

--- NEW FILE: article-dist.html ---
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
&lt;BOUCLE_article_principal(ARTICLES) {id_article}&gt;
&lt;html lang=&quot;#LANG&quot;&gt;
&lt;head&gt;
&lt;title&gt;[(#TITRE|textebrut)]&lt;/title&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#CHARSET&quot;&gt;
&lt;!-- Ceci est la feuille de style par defaut pour les types internes a SPIP --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- Les feuilles de style specifiques aux presents squelettes --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;typographie.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- media=&quot;...&quot; permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;habillage.css&quot; type=&quot;text/css&quot; media=&quot;projection, screen, tv&quot;&gt;
&lt;!-- media=&quot;print&quot; permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;impression.css&quot; type=&quot;text/css&quot; media=&quot;print&quot;&gt;
&lt;/head&gt;

&lt;body bgcolor=&quot;white&quot; dir=&quot;#LANG_DIR&quot;&gt;
&lt;div id=&quot;navigation&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:navigation:&gt;&lt;/h1&gt;

&lt;!-- Menu de navigation general --&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;ul class=&quot;general&quot;&gt;
	&lt;li class=&quot;menu-titre&quot;&gt;
	[&lt;a href=&quot;(#URL_SITE_SPIP)&quot; title=&quot;&lt;:accueil_site:&gt;&quot;&gt;&lt;b&gt;#NOM_SITE_SPIP&lt;/b&gt;&lt;/a&gt;]
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;plan.php3&quot;&gt;&lt;:plan_site:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;resume.php3&quot; title=&quot;&lt;:articles_populaires:&gt;&quot;&gt;&lt;:en_resume:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;ecrire/&quot;&gt;&lt;:espace_prive:&gt;&lt;/a&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;

&lt;!-- Formulaire de recherche --&gt;

[(#FORMULAIRE_RECHERCHE)]


&lt;!-- Menu de navigation rubriques --&gt;

&lt;B_rubriques&gt;
&lt;div class=&quot;menu&quot;&gt;
&lt;ol class=&quot;rubriques&quot;&gt;
&lt;BOUCLE_rubriques(HIERARCHIE) {id_article}&gt;
&lt;li&gt;
&lt;div class=&quot;menu-titre&quot;&gt;&lt;a href=&quot;#URL_RUBRIQUE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/div&gt;
&lt;B_sous_rubriques&gt;
	&lt;ul class=&quot;menu-liste&quot;&gt;
&lt;BOUCLE_sous_rubriques(RUBRIQUES) {meme_parent} {exclus} {par date} {inverse} {0,3}&gt;
	&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_RUBRIQUE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
&lt;/BOUCLE_sous_rubriques&gt;
	&lt;/ul&gt;
&lt;/B_sous_rubriques&gt;
&lt;/li&gt;
&lt;/BOUCLE_rubriques&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;/B_rubriques&gt;


&lt;!-- Menu de navigation mots-cles --&gt;

&lt;B_mots&gt;
&lt;div class=&quot;menu&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:mots_clefs:&gt;&lt;/h1&gt;

&lt;ul class=&quot;divers&quot; title=&quot;&lt;:mots_clefs:&gt;&quot;&gt;
&lt;BOUCLE_mots(MOTS) {id_article} {par titre}&gt;
&lt;li&gt;
&lt;div class=&quot;menu-titre&quot;&gt;&lt;a href=&quot;#URL_MOT&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/div&gt;
&lt;B_articles_mots&gt;
	&lt;ul class=&quot;menu-liste&quot;&gt;
&lt;BOUCLE_articles_mots(ARTICLES) {id_mot} {par hasard} {0,4}&gt;
	&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_ARTICLE&quot; title=&quot;[(#DESCRIPTIF|textebrut|entites_html)]&quot;&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
&lt;/BOUCLE_articles_mots&gt;
	&lt;/ul&gt;
&lt;/B_articles_mots&gt;
&lt;/li&gt;
&lt;/BOUCLE_mots&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/B_mots&gt;


&lt;!-- Liens des forums --&gt;
&lt;BOUCLE_forums_decompte(FORUMS){id_article}{plat}&gt;&lt;/BOUCLE_forums_decompte&gt;
[&lt;div class=&quot;menu&quot; title=&quot;&lt;:derniers_commentaires:&gt;&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:derniers_commentaires:&gt;&lt;/h1&gt;

&lt;ul class=&quot;forums&quot;&gt;

&lt;li class=&quot;menu-titre&quot;&gt;&lt;:messages_forum:&gt;: (#TOTAL_BOUCLE)&lt;/li&gt;]
&lt;//B_forums_decompte&gt;
&lt;BOUCLE_forums_liens(FORUMS){id_article}{par date}{inverse}{0,5}&gt;
    &lt;li class=&quot;menu-item&quot;&gt;[&lt;i&gt;(#DATE|affdate_court)&lt;/i&gt;:]
    &lt;a href=&quot;#forum#ID_FORUM&quot;&gt;#TITRE&lt;/a&gt;
    &lt;/li&gt;
&lt;/BOUCLE_forums_liens&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/B_forums_liens&gt;


&lt;/div&gt;


&lt;!-- Une : derniers articles publies --&gt;

&lt;div class=&quot;contenu&quot; id=&quot;principal&quot;&gt;

&lt;div class=&quot;cartouche&quot;&gt;
#DEBUT_SURLIGNE[
(#LOGO_ARTICLE|left)][
&lt;div class=&quot;surtitre&quot;&gt;(#SURTITRE)&lt;/div&gt;
]&lt;h1 class=&quot;titre-texte&quot;&gt;#TITRE&lt;/h1&gt;[
&lt;div class=&quot;surtitre&quot;&gt;(#SOUSTITRE)&lt;/div&gt;
]#FIN_SURLIGNE
[(#DATE|nom_jour)] [(#DATE|affdate).]
&lt;/div&gt;
&lt;div style=&quot;line-height: 0em&quot;&gt;&nbsp;&lt;/div&gt;&lt;!-- Bug Mozilla <A HREF="http://bugzilla.mozilla.org/show_bug.cgi?id=200510">http://bugzilla.mozilla.org/show_bug.cgi?id=200510</A> --&gt;

	&lt;div class=&quot;encart&quot;&gt;

	&lt;!-- Auteurs de l'article --&gt;

	&lt;B_auteurs&gt;

	&lt;div class=&quot;menu&quot;&gt;
	&lt;h2 class=&quot;structure&quot;&gt;&lt;:memes_auteurs:&gt;&lt;/h2&gt;
	&lt;ul class=&quot;divers&quot;&gt;
	&lt;BOUCLE_auteurs(AUTEURS) {id_article} {par nom}&gt;
		&lt;li&gt;
		&lt;div class=&quot;menu-titre&quot;&gt;&lt;a href=&quot;#URL_AUTEUR&quot;&gt;#NOM&lt;/a&gt;&lt;/div&gt;
		&lt;ul&gt;
		[&lt;li class=&quot;menu-item&quot; style=&quot;text-align: center&quot;&gt;&lt;a href=&quot;(#URL_SITE)&quot;&gt;#NOM_SITE&lt;/a&gt;&lt;/li&gt;]
		[&lt;li class=&quot;menu-item&quot; style=&quot;text-align: center&quot;&gt;(#BIO)&lt;/li&gt;]
	&lt;B_articles_auteur&gt;
	&lt;BOUCLE_articles_auteur(ARTICLES) {id_auteur} {par popularite} {inverse} {0,5}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_ARTICLE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
	&lt;/BOUCLE_articles_auteur&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/BOUCLE_auteurs&gt;
	&lt;/ul&gt;
	&lt;/div&gt;

	&lt;/B_auteurs&gt;

	&lt;!-- Articles dans la meme rubrique --&gt;

	&lt;B_articles_rubrique&gt;

	&lt;div class=&quot;menu&quot;&gt;
	&lt;div class=&quot;breves&quot;&gt;
		&lt;h2 class=&quot;structure&quot;&gt;&lt;:meme_rubrique:&gt;&lt;/h2&gt;
		&lt;div class=&quot;menu-titre&quot;&gt;
		&lt;:meme_rubrique:&gt;
		&lt;/div&gt;
		&lt;ul&gt;
	&lt;BOUCLE_articles_rubrique(ARTICLES) {id_rubrique} {par hasard} {exclus} {0,8}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;
		&lt;a href=&quot;#URL_ARTICLE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;
		&lt;/li&gt;
	&lt;/BOUCLE_articles_rubrique&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;/div&gt;

	&lt;/B_articles_rubrique&gt;
  [&lt;div class='reponse_formulaire'&gt;
	&lt;a name='sp#ID_ARTICLE' id='sp#ID_ARTICLE'&gt;&lt;/a&gt;
    (#FORMULAIRE_SIGNATURE)
  &lt;/div&gt;]
	&lt;/div&gt;

#DEBUT_SURLIGNE[
&lt;div class=&quot;chapo&quot;&gt;(#CHAPO)&lt;/div&gt;
][&lt;div class=&quot;texte&quot;&gt;(#TEXTE)&lt;/div&gt;
][&lt;div class=&quot;ps&quot;&gt;(#PS)&lt;/div&gt;][
&lt;div class=&quot;notes&quot;&gt;(#NOTES)&lt;/div&gt;
]#FIN_SURLIGNE

&lt;BOUCLE_documents_joints(DOCUMENTS) {id_article} {mode=document} {doublons} {&quot;&lt;br&gt;&quot;}&gt;
[(#LOGO_DOCUMENT|#URL_DOCUMENT)][&lt;br&gt;(#TITRE)][ - (#DESCRIPTIF)]
&lt;/BOUCLE_documents_joints&gt;
&lt;br&gt;


&lt;!-- Signatures petition --&gt;

&lt;BOUCLE_signatures_decompte(SIGNATURES) {id_article}&gt;&lt;/BOUCLE_signatures_decompte&gt;
[&lt;div class=&quot;signatures-titre&quot;&gt;&lt;:signatures_petition:&gt;: (#TOTAL_BOUCLE)&lt;/div&gt;

&lt;table class=&quot;signatures&quot;&gt;
&lt;thead class=&quot;structure&quot;&gt;
&lt;tr&gt;
	&lt;td&gt;&lt;:date:&gt;&lt;/td&gt;
	&lt;td&gt;&lt;:nom:&gt;&lt;/td&gt;
	&lt;td&gt;&lt;:message:&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;]
&lt;//B_signatures_decompte&gt;
&lt;BOUCLE_signatures(SIGNATURES) {id_article} {par date} {inverse} {debut_signatures,30}&gt;
&lt;tr&gt;
	&lt;td class=&quot;signature-date&quot;&gt;[(#DATE|affdate_court)]&lt;/td&gt;
	&lt;td class=&quot;signature-nom&quot;&gt;#NOM[&lt;br&gt;&lt;a href=&quot;#URL_SITE&quot;&gt;(#NOM_SITE)&lt;/a&gt;]&lt;/td&gt;
	[&lt;td class=&quot;signature-message&quot;&gt;(#MESSAGE)&lt;/td&gt;]
&lt;/tr&gt;
&lt;/BOUCLE_signatures&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/B_signatures&gt;


&lt;!-- Forums --&gt;

[&lt;div class=&quot;forum-repondre&quot;&gt;&lt;B&gt;&lt;A  HREF=&quot;forum.php3?(#PARAMETRES_FORUM)&quot;&gt;&lt;:repondre_article:&gt;&lt;/A&gt;&lt;/B&gt;&lt;/div&gt;]
&lt;br&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:Forum:&gt;&lt;/h1&gt;

&lt;B_forums&gt;
&lt;ul class=&quot;forum-total&quot;&gt;

&lt;BOUCLE_forums(FORUMS){id_article}{par date}{inverse}&gt;

&lt;li&gt;
&lt;div class=&quot;forum-fil&quot;&gt;

&lt;div class=&quot;forum&quot;&gt;
&lt;div class=&quot;forum-chapo&quot;&gt;
&lt;div class=&quot;forum-titre&quot;&gt;&lt;a name=&quot;forum#ID_FORUM&quot;&gt;&lt;/a&gt;#TITRE&lt;/div&gt;
[(#DATE|affdate)][, &lt;:par_auteur:&gt; &lt;A HREF=&quot;mailto:#EMAIL&quot;&gt;(#NOM)&lt;/A&gt;]
&lt;/div&gt;
&lt;div class=&quot;forum-item&quot;&gt;
#TEXTE
[&lt;div class=&quot;forum-titre&quot;&gt;&lt;a href=&quot;(#URL_SITE)&quot; class=&quot;spip_out&quot;&gt;#NOM_SITE&lt;/a&gt;&lt;/div&gt;]
[&lt;div class=&quot;forum-repondre-message&quot;&gt;&lt;a href=&quot;forum.php3?(#PARAMETRES_FORUM)&quot;&gt;&lt;:repondre_message:&gt;&lt;/a&gt;&lt;/div&gt;]
&lt;/div&gt;
&lt;/div&gt;

&lt;B_forums_fils&gt;
	&lt;ul&gt;
	&lt;BOUCLE_forums_fils(FORUMS){id_parent}{par date}&gt;

	&lt;li&gt;
	&lt;div class=&quot;forum&quot;&gt;
	&lt;div class=&quot;forum-chapo&quot;&gt;
	&lt;div class=&quot;forum-titre&quot;&gt;&lt;a name=&quot;forum#ID_FORUM&quot;&gt;&lt;/a&gt;#TITRE&lt;/div&gt;
	[(#DATE|affdate)][, &lt;:par_auteur:&gt; &lt;A HREF=&quot;mailto:#EMAIL&quot;&gt;(#NOM)&lt;/A&gt;]
	&lt;/div&gt;
	&lt;div class=&quot;forum-item&quot;&gt;
	#TEXTE
	[&lt;div class=&quot;forum-titre&quot;&gt;&lt;a href=&quot;(#URL_SITE)&quot; class=&quot;spip_out&quot;&gt;#NOM_SITE&lt;/a&gt;&lt;/div&gt;]
	[&lt;div class=&quot;forum-repondre-message&quot;&gt;&lt;a href=&quot;forum.php3?(#PARAMETRES_FORUM)&quot;&gt;&lt;:repondre_message:&gt;&lt;/a&gt;&lt;/div&gt;]
	&lt;/div&gt;

	&lt;/div&gt;

	&lt;BOUCLE_Forums_Boucle(boucle_forums_fils)&gt;&lt;/BOUCLE_Forums_Boucle&gt;
	&lt;/li&gt;

	&lt;/BOUCLE_forums_fils&gt;
	&lt;/ul&gt;
&lt;/B_forums_fils&gt;

&lt;/div&gt;
&lt;/li&gt;
&lt;/BOUCLE_forums&gt;

&lt;/ul&gt;
&lt;/B_forums&gt;

&lt;/div&gt;


#FORMULAIRE_ADMIN
&lt;/body&gt;
&lt;/html&gt;


&lt;/BOUCLE_article_principal&gt;
&lt;:aucun_article:&gt;
&lt;//B_article_principal&gt;

--- NEW FILE: mot-dist.html ---
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
&lt;BOUCLE_mot_principal(MOTS) {id_mot} {doublons}&gt;

&lt;html lang=&quot;#LANG&quot;&gt;
&lt;head&gt;
&lt;title&gt;[(#TITRE|textebrut)]&lt;/title&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=#CHARSET&quot;&gt;

&lt;!-- Ceci est la feuille de style par defaut pour les types internes a SPIP --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;spip_style.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- Les feuilles de style specifiques aux presents squelettes --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;typographie.css&quot; type=&quot;text/css&quot;&gt;

&lt;!-- media=&quot;...&quot; permet de ne pas utiliser ce style sous Netscape 4 (sinon plantage) --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;habillage.css&quot; type=&quot;text/css&quot; media=&quot;projection, screen, tv&quot;&gt;
&lt;!-- media=&quot;print&quot; permet d'utiliser cette feuille de style quand vous imprimez depuis votre navigateur --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;impression.css&quot; type=&quot;text/css&quot; media=&quot;print&quot;&gt;
&lt;/head&gt;

&lt;body bgcolor=&quot;white&quot; dir=&quot;#LANG_DIR&quot;&gt;

&lt;div id=&quot;navigation&quot;&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:navigation:&gt;&lt;/h1&gt;

&lt;!-- Menu de navigation general --&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;ul class=&quot;general&quot;&gt;
	&lt;li class=&quot;menu-titre&quot;&gt;
	[&lt;a href=&quot;(#URL_SITE_SPIP)&quot; title=&quot;&lt;:accueil_site:&gt;&quot;&gt;&lt;b&gt;#NOM_SITE_SPIP&lt;/b&gt;&lt;/a&gt;]
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;plan.php3&quot;&gt;&lt;:plan_site:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;resume.php3&quot; title=&quot;&lt;:articles_populaires:&gt;&quot;&gt;&lt;:en_resume:&gt;&lt;/a&gt;
	&lt;/li&gt;
	&lt;li class=&quot;menu-item&quot;&gt;
	&lt;a href=&quot;ecrire/&quot;&gt;&lt;:espace_prive:&gt;&lt;/a&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;


&lt;!-- Formulaire de recherche --&gt;

[(#FORMULAIRE_RECHERCHE)]


&lt;!-- Menu de navigation mots-cles : les autres mots cles du meme groupe--&gt;

&lt;B_mots_freres&gt;
&lt;h2 class=&quot;structure&quot;&gt;&lt;:mots_clefs_meme_groupe:&gt;&lt;/h2&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;div class=&quot;divers&quot;&gt;
&lt;div class=&quot;menu-titre&quot;&gt;&lt;BOUCLE_groupe(GROUPES_MOTS) {id_groupe} {doublons}&gt;#TITRE&lt;/BOUCLE_groupe&gt;&lt;/div&gt;
	&lt;ul class=&quot;menu-liste&quot;&gt;
&lt;BOUCLE_mots_freres(MOTS) {type} {doublons} {par titre}&gt;
	&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_MOT&quot; title=&quot;[(#DESCRIPTIF|textebrut|entites_html)]&quot;&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
&lt;/BOUCLE_mots_freres&gt;
	&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/B_mots_freres&gt;


&lt;!-- Menu de navigation mots-cles : les autres groupes avec un lien sur le premier mot du groupe --&gt;

&lt;B_groupes_freres&gt;
&lt;h2 class=&quot;structure&quot;&gt;&lt;:autres_groupes_mots_clefs:&gt;&lt;/h2&gt;

&lt;div class=&quot;menu&quot;&gt;
&lt;div class=&quot;divers&quot;&gt;
&lt;div class=&quot;menu-titre&quot;&gt;&lt;:autres_groupes_mots_clefs:&gt;&lt;/div&gt;
	&lt;ul class=&quot;menu-liste&quot;&gt;
&lt;BOUCLE_groupes_freres(GROUPES_MOTS) {par titre} {doublons}&gt;
&lt;BOUCLE_mot_cousin(MOTS) {id_groupe} {par titre} {0,1}&gt;
	&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_MOT&quot;&gt;#TYPE&lt;/a&gt;&lt;/li&gt;
&lt;/BOUCLE_mot_cousin&gt;
&lt;/BOUCLE_groupes_freres&gt;
	&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/B_groupes_freres&gt;


&lt;/div&gt;

&lt;!-- Une : contenu du mot-cle --&gt;

&lt;div class=&quot;contenu&quot; id=&quot;principal&quot;&gt;

&lt;div class=&quot;cartouche&quot;&gt;
[(#LOGO_MOT|left)]
&lt;h1 class=&quot;titre-texte&quot;&gt;#TITRE&lt;/h1&gt;
&lt;/div&gt;

	&lt;div class=&quot;encart&quot;&gt;

	&lt;!-- Rubriques liees au mot-cle --&gt;

	&lt;B_rubriques&gt;
	&lt;h2 class=&quot;structure&quot;&gt;&lt;:rubriques:&gt;&lt;/h2&gt;

	&lt;div class=&quot;menu&quot;&gt;
	&lt;div class=&quot;rubriques&quot;&gt;
	&lt;div class=&quot;menu-titre&quot;&gt;&lt;:rubriques:&gt;&lt;/div&gt;
		&lt;ul class=&quot;menu-liste&quot;&gt;
	&lt;BOUCLE_rubriques(RUBRIQUES) {id_mot} {par titre}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_RUBRIQUE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
	&lt;/BOUCLE_rubriques&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;/div&gt;
	&lt;/B_rubriques&gt;

	&lt;!-- Breves liees au mot-cle --&gt;

	&lt;B_breves&gt;
	&lt;h2 class=&quot;structure&quot;&gt;&lt;:breves:&gt;&lt;/h2&gt;

	&lt;div class=&quot;menu&quot;&gt;
	&lt;div class=&quot;breves&quot;&gt;
	&lt;div class=&quot;menu-titre&quot;&gt;&lt;:breves:&gt;&lt;/div&gt;
		&lt;ul class=&quot;menu-liste&quot;&gt;
	&lt;BOUCLE_breves(BREVES) {id_mot} {par titre}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_BREVE&quot;&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
	&lt;/BOUCLE_breves&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;/div&gt;
	&lt;/B_breves&gt;

	&lt;!-- Sites Web lies au mot-cle --&gt;

	&lt;B_sites&gt;
	&lt;h2 class=&quot;structure&quot;&gt;&lt;:sites_web:&gt;&lt;/h2&gt;

	&lt;div class=&quot;menu&quot;&gt;
	&lt;div class=&quot;breves&quot;&gt;
	&lt;div class=&quot;menu-titre&quot;&gt;&lt;:sites_web:&gt;&lt;/div&gt;
		&lt;ul class=&quot;menu-liste&quot;&gt;
	&lt;BOUCLE_sites(SITES) {id_mot} {par nom_site}&gt;
		&lt;li class=&quot;menu-item&quot;&gt;&lt;a href=&quot;#URL_SITE&quot;&gt;#TITRE&lt;/a&gt;&lt;/li&gt;
	&lt;/BOUCLE_sites&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;/div&gt;
	&lt;/B_sites&gt;

	&lt;/div&gt;

[&lt;div class=&quot;chapo&quot;&gt;(#TEXTE)&lt;/div&gt;]
[&lt;div class=&quot;notes&quot;&gt;(#NOTES)&lt;/div&gt;]


&lt;!-- Articles lies au mot-cle --&gt;

&lt;h1 class=&quot;structure&quot;&gt;&lt;:articles:&gt;&lt;/h1&gt;

&lt;div class=&quot;liste-articles&quot;&gt;

&lt;BOUCLE_articles(ARTICLES) {id_mot} {par titre}&gt;
	&lt;h2&gt;&lt;a href=&quot;#URL_ARTICLE&quot; [title=&quot;(#DESCRIPTIF|textebrut|entites_html)&quot;]&gt;#TITRE&lt;/a&gt;&lt;/h2&gt;
	&lt;div class=&quot;detail&quot;&gt;
	[(#DATE|nom_jour)] [(#DATE|affdate)]
	&lt;B_auteurs&gt;&lt;:par_auteur:&gt; &lt;BOUCLE_auteurs(AUTEURS) {id_article} {&quot;, &quot;}&gt;#NOM&lt;/BOUCLE_auteurs&gt;
	&lt;/div&gt;
	&lt;br&gt;
&lt;/BOUCLE_articles&gt;

&lt;/div&gt;
&lt;/div&gt;
#FORMULAIRE_ADMIN
&lt;/body&gt;
&lt;/html&gt;
&lt;/BOUCLE_mot_principal&gt;
&lt;//B_mot_principal&gt;

--- NEW FILE: carto.html ---
&lt;BOUCLE_carte(CARTO_CARTE){id_carte}&gt;&lt;img alt=&quot;#TITRE&quot; src=&quot;#URL_SITE_SPIP/spip_carto.php?fond_carte=[(#FICHIER)]&amp;scale=[(#HTTP_VARS{scale})]&amp;x=[(#HTTP_VARS{x})]&amp;y=[(#HTTP_VARS{y})]&quot; usemap=&quot;#map#ID_CARTE&quot; border=&quot;0&quot;/&gt;&lt;B_objets&gt;&lt;map name=&quot;map#ID_CARTE&quot;&gt;&lt;BOUCLE_objets(CARTO_OBJET){id_carte=#ID_CARTE}&gt;&lt;area shape=&quot;[(#GEOMETRIE|wkt2shape)]&quot; coords=&quot;[(#GEOMETRIE|wkt2coords)]&quot; href=&quot;#LIEN&quot; alt=&quot;#TITRE&quot;/&gt;&lt;/BOUCLE_objets&gt;&lt;/map&gt;&lt;/B_objets&gt;&lt;/BOUCLE_carte&gt;


--- NEW FILE: inc-formulaire_admin.php3 ---
&lt;?php

global $balise_FORMULAIRE_ADMIN_collecte ;
$balise_FORMULAIRE_ADMIN_collecte = array('id_article', 'id_breve', 'id_rubrique', 'id_mot', 'id_auteur');

# on ne peut rien dire au moment de l'ex&#233;cution du squelette

function balise_FORMULAIRE_ADMIN_stat($args, $filtres)
{
	return $args;
}

# les boutons admin sont mis d'autorite si absents
# donc une variable statique controle si FORMULAIRE_ADMIN a ete vu.
# Toutefois, si c'est le debuger qui appelle,
# il peut avoir recopie le code dans ses donnees et il faut le lui refounir.
# Pas question de recompiler: ca fait boucler !
# Le debuger transmet donc ses donnees, et cette balise y retrouve son petit.

function balise_FORMULAIRE_ADMIN_dyn($id_article, $id_breve, $id_rubrique, $id_mot, $id_auteur, $debug='') {
	global $var_preview, $use_cache;
	static $dejafait = false;

	if ($GLOBALS['flag_preserver'] || !$GLOBALS['spip_admin'])
		return '';

	if (!is_array($debug)) {
		if ($dejafait)
			return '';
	} else {
		if ($dejafait) {
			$res = '';
			foreach($debug['sourcefile'] as $k =&gt; $v) {
				if (strpos($v,'formulaire_admin') === 0)
					return $debug['resultat'][$k . 'tout'];
			}
			return '';
		}
	}
	$dejafait = true;

	// regler les boutons dans la langue de l'admin (sinon tant pis)
	include_local(_FILE_CONNECT);
	$login = addslashes(ereg_replace('^@','',$GLOBALS['spip_admin']));
	if ($row = spip_fetch_array(spip_query(&quot;SELECT lang FROM spip_auteurs WHERE login='$login'&quot;))) {
		$lang = $row['lang'];
		include_ecrire (&quot;inc_lang.php3&quot;);
		lang_select($lang);
	}

	// repartir de zero pour les boutons car clean_link a pu etre utilisee
	$link = new Link;
	$link-&gt;delVar('var_mode');
	$link-&gt;delVar('var_mode_objet');
	$link-&gt;delVar('var_mode_affiche');
	$action = $link-&gt;getUrl();
	$action = ($action . ((strpos($action, '?') === false) ? '?' : '&amp;'));

  // en preview pas de stat ni de debug
	if (!$var_preview) {
		// Bouton statistiques
		if (lire_meta(&quot;activer_statistiques&quot;) != &quot;non&quot; 
		AND $id_article
		AND ($GLOBALS['auteur_session']['statut'] == '0minirezo')) {
			if (spip_fetch_array(spip_query(&quot;SELECT id_article
			FROM spip_articles WHERE statut='publie'
			AND id_article =&quot;.intval($id_article)))) {
				include_local (&quot;inc-stats.php3&quot;);
				$r = afficher_raccourci_stats($id_article);
				$visites = $r['visites'];
				$popularite = $r['popularite'];
				$statistiques = 'statistiques_visites.php3?';
			}
		}

		// Bouton de debug
		$debug = (
			($forcer_debug
			OR $GLOBALS['bouton_admin_debug']
			OR ($GLOBALS['var_mode'] == 'debug'
				AND $GLOBALS['HTTP_COOKIE_VARS']['spip_debug']
			)) AND ($GLOBALS['code_activation_debug'] == 'oui'
				OR $GLOBALS['auteur_session']['statut'] == '0minirezo')
		) ? 'debug' : '';
	}

	// hack - ne pas avoir la rubrique si un autre bouton est deja present
	if ($id_article OR $id_breve) unset ($id_rubrique);

	return array('formulaire_admin', 0,
			array(
				'id_article' =&gt; $id_article,
				'id_rubrique' =&gt; $id_rubrique,
				'id_auteur' =&gt; $id_auteur,
				'id_breve' =&gt; $id_breve,
				'id_mot' =&gt; $id_mot,
				'action' =&gt; $action,
				'debug' =&gt; $debug,
				'popularite' =&gt; intval($popularite),
				'statistiques' =&gt; $statistiques,
				'visites' =&gt; intval($visites),
				'use_cache' =&gt; ($use_cache ? ' *' : '')
			)
		);
}
?&gt;

--- NEW FILE: backend-breves.php3 ---
&lt;?php
$fond = &quot;backend-breves&quot;;
$delais = 3600;

// cette ligne empeche l'affichage des boutons d'administration
$flag_preserver = true;

@header(&quot;Content-type: text/xml&quot;);

include (&quot;inc-public.php3&quot;);

?&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000055.html">[Spip-carto-cvs] spip-carto/IMG test_image.jpg,NONE,1.1 test.gif,NONE,1.1 logo_spip.jpg,NONE,1.1 test.png,NONE,1.1 test.jpg,NONE,1.1
</A></li>
	<LI>Next message: <A HREF="000056.html">[Spip-carto-cvs] spip-carto/oo index.php3,NONE,1.1 index.php,NONE,1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59">[ date ]</a>
              <a href="thread.html#59">[ thread ]</a>
              <a href="subject.html#59">[ subject ]</a>
              <a href="author.html#59">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
