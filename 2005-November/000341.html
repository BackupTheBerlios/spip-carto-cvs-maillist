<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Spip-carto-cvs] spipcarto/ecrire auteurs.php3,1.4,1.4.2.1 inc_lang.php3,1.12,1.12.2.1 inc_filtres.php3,1.10.2.1,1.10.2.2 inc_cron.php3,1.4,1.4.2.1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/spip-carto-cvs/2005-November/index.html" >
   <LINK REL="made" HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/ecrire%20auteurs.php3%2C1.4%2C1.4.2.1%20inc_lang.php3%2C1.12%2C1.12.2.1%20inc_filtres.php3%2C1.10.2.1%2C1.10.2.2%20inc_cron.php3%2C1.4%2C1.4.2.1&In-Reply-To=%3C200511052234.jA5MYbfG028132%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000340.html">
   <LINK REL="Next"  HREF="000343.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Spip-carto-cvs] spipcarto/ecrire auteurs.php3,1.4,1.4.2.1 inc_lang.php3,1.12,1.12.2.1 inc_filtres.php3,1.10.2.1,1.10.2.2 inc_cron.php3,1.4,1.4.2.1</H1>
    <B>stef at berlios.de</B> 
    <A HREF="mailto:spip-carto-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSpip-carto-cvs%5D%20spipcarto/ecrire%20auteurs.php3%2C1.4%2C1.4.2.1%20inc_lang.php3%2C1.12%2C1.12.2.1%20inc_filtres.php3%2C1.10.2.1%2C1.10.2.2%20inc_cron.php3%2C1.4%2C1.4.2.1&In-Reply-To=%3C200511052234.jA5MYbfG028132%40sheep.berlios.de%3E"
       TITLE="[Spip-carto-cvs] spipcarto/ecrire auteurs.php3,1.4,1.4.2.1 inc_lang.php3,1.12,1.12.2.1 inc_filtres.php3,1.10.2.1,1.10.2.2 inc_cron.php3,1.4,1.4.2.1">stef at berlios.de
       </A><BR>
    <I>Sat Nov  5 23:34:37 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000340.html">[Spip-carto-cvs] spipcarto/squelettes/template carto_lien.html,1.2.2.2,1.2.2.3 carto_logo.html,1.2.2.2,1.2.2.3
</A></li>
        <LI>Next message: <A HREF="000343.html">[Spip-carto-cvs] spipcarto/ecrire/lang spip_br.php3,NONE,1.1.2.1 public_br.php3,NONE,1.1.2.1 ecrire_br.php3,NONE,1.1.2.1 spip_zh.php3,1.4,1.4.2.1 public_tr.php3,1.1.2.1,1.1.2.2 ecrire_tr.php3,1.2.2.1,1.2.2.2 spip_it.php3,1.5.2.1,1.5.2.2 ecrire_fa.php3,1.4.2.1,1.4.2.2 ecrire_gl.php3,1.4,1.4.2.1 spip_tr.php3,1.3,1.3.2.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#341">[ date ]</a>
              <a href="thread.html#341">[ thread ]</a>
              <a href="subject.html#341">[ subject ]</a>
              <a href="author.html#341">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/spip-carto/spipcarto/ecrire
In directory sheep:/tmp/cvs-serv27741/ecrire

Modified Files:
      Tag: BRANCH-V1
	auteurs.php3 inc_lang.php3 inc_filtres.php3 inc_cron.php3 
Log Message:
Mise &#224; jour Spip 1.8.2e officielle

Index: auteurs.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/auteurs.php3,v
retrieving revision 1.4
retrieving revision 1.4.2.1
diff -u -d -r1.4 -r1.4.2.1
--- auteurs.php3	7 Sep 2005 15:01:53 -0000	1.4
+++ auteurs.php3	5 Nov 2005 22:34:35 -0000	1.4.2.1
@@ -22,13 +22,12 @@
 	spip_query(&quot;UPDATE spip_auteurs SET statut='5poubelle' WHERE id_auteur=$supp&quot;);
 
 $retour = &quot;auteurs.php3?&quot;;
-if ($tri) {
-	$retour .= &quot;tri=$tri&quot;;
-	if ($tri=='nom' OR $tri=='statut')
-		$partri = &quot; &quot;._T('info_par_tri', array('tri' =&gt; $tri));
-	else if ($tri=='nombre')
-		$partri = &quot; &quot;._T('info_par_nombre_article');
-}
+if (!$tri) $tri='nom';
+$retour .= &quot;tri=$tri&quot;;
+if ($tri=='nom' OR $tri=='statut')
+	$partri = &quot; &quot;._T('info_par_tri', array('tri' =&gt; $tri));
+else if ($tri=='nombre')
+	$partri = &quot; &quot;._T('info_par_nombre_article');
 
 if ($visiteurs == &quot;oui&quot;) {
 	debut_page(_T('titre_page_auteurs'),&quot;auteurs&quot;,&quot;redacteurs&quot;);
@@ -53,7 +52,7 @@
 
 
 if ($connect_statut == '0minirezo') {
-	$query = &quot;SELECT id_auteur FROM spip_auteurs WHERE statut='6forum' LIMIT 0,1&quot;;
+	$query = &quot;SELECT id_auteur FROM spip_auteurs WHERE statut='6forum' LIMIT 1&quot;;
 	$result = spip_query($query);
 	$flag_visiteurs = spip_num_rows($result) &gt; 0;
 
@@ -75,19 +74,25 @@
 // Construire la requete
 //
 
+// si on n'est pas minirezo, supprimer les auteurs sans article publie
+// sauf les admins, toujours visibles.
 // limiter les statuts affiches
-if (($visiteurs == &quot;oui&quot;) AND ($connect_statut == '0minirezo')) {
-	$sql_statut_auteurs = &quot; AND auteurs.statut IN ('6forum', '5poubelle')&quot;;
-	$sql_statut_articles = '';
-	$tri = 'nom';
-} else if ($connect_statut != '0minirezo') {
-	$sql_statut_auteurs = &quot; AND auteurs.statut IN ('0minirezo', '1comite')&quot;;
-	$sql_statut_articles = &quot; AND articles.statut IN ('prop', 'publie')&quot;;
+if ($connect_statut == '0minirezo') {
+	if ($visiteurs == &quot;oui&quot;) {
+		$sql_visible = &quot;aut.statut IN ('6forum','5poubelle')&quot;;
+		$tri = 'nom';
+	} else {
+		$sql_visible = &quot;aut.statut IN ('0minirezo','1comite','5poubelle')&quot;;
+	}
 } else {
-	$sql_statut_auteurs = &quot; AND auteurs.statut IN ('0minirezo', '1comite', '5poubelle')&quot;;
-	$sql_statut_articles = &quot;&quot;;
+	$sql_visible = &quot;(
+		aut.statut = '0minirezo'
+		OR art.statut IN ('prop', 'publie')
+	)&quot;;
 }
 
+$sql_sel = '';
+
 // tri
 switch ($tri) {
 case 'nombre':
@@ -96,111 +101,80 @@
 	break;
 
 case 'statut':
-	$sql_order = ' ORDER BY auteurs.statut, login = &quot;&quot;, unom';
+	$sql_order = ' ORDER BY statut, login = &quot;&quot;, unom';
 	$type_requete = 'auteur';
 	break;
 
 case 'nom':
 default:
-//	$sql_order = ' ORDER BY unom';
 	$type_requete = 'auteur';
-	$sql_sel = &quot;, &quot;.creer_objet_multi (&quot;nom&quot;, &quot;$spip_lang&quot;);
+	$sql_sel = &quot;, &quot;.creer_objet_multi (&quot;nom&quot;, $spip_lang);
 	$sql_order = &quot; ORDER BY multi&quot;;
 }
 
 
-// si on doit afficher les auteurs par statut ou par nom,
-// la requete principale est simple, et une autre requete
-// vient calculer les nombres d'articles publies ;
-// si en revanche on doit classer par nombre, la bonne requete
-// est la concatenation de $query_nombres et de $query_auteurs
 
-unset($nombre_auteurs);
-$auteurs = Array();
+//
+// La requete de base est tres sympa
+//
 
-if ($type_requete == 'auteur') {
-	$result_auteurs = spip_query(&quot;SELECT id_auteur, statut, login, nom, email, url_site, messagerie, UPPER(nom) AS unom$sql_sel
-		FROM spip_auteurs AS auteurs
-		WHERE 1 $sql_statut_auteurs
-		$sql_order&quot;);
-	while ($row = spip_fetch_array($result_auteurs)) {
-		$auteurs[$row['id_auteur']] = $row;
-		$nombre_auteurs ++;
-	}
+$query = &quot;SELECT
+	aut.id_auteur AS id_auteur,
+	aut.statut AS statut,
+	aut.login AS login,
+	aut.nom AS nom,
+	aut.email AS email,
+	aut.url_site AS url_site,
+	aut.messagerie AS messagerie,
+	UPPER(aut.nom) AS unom,
+	count(lien.id_article) as compteur
+	$sql_sel
+FROM spip_auteurs as aut
+LEFT JOIN spip_auteurs_articles AS lien ON aut.id_auteur=lien.id_auteur
+LEFT JOIN spip_articles AS art ON (lien.id_article = art.id_article)
+WHERE
+	$sql_visible
+GROUP BY aut.id_auteur
+$sql_order&quot;;
 
-	$result_nombres = spip_query(&quot;SELECT auteurs.id_auteur, UPPER(auteurs.nom) AS unom, COUNT(articles.id_article) AS compteur, &quot;.creer_objet_multi (&quot;UPPER(auteurs.nom)&quot;, &quot;$spip_lang&quot;).&quot; 
-		FROM spip_auteurs AS auteurs, spip_auteurs_articles AS lien, spip_articles AS articles
-		WHERE auteurs.id_auteur=lien.id_auteur AND lien.id_article=articles.id_article
-		$sql_statut_auteurs $sql_statut_articles
-		GROUP BY auteurs.id_auteur
-		$sql_order&quot;);
-	while ($row = spip_fetch_array($result_nombres))
-		$auteurs[$row['id_auteur']]['compteur'] = $row['compteur'];
 
-	// si on n'est pas minirezo, supprimer les auteurs sans article publie
-	// sauf les admins, toujours visibles.
-	if ($connect_statut != '0minirezo') {
-		reset($auteurs);
-		while (list(,$auteur) = each ($auteurs)) {
-			if (! $auteur['compteur'] AND ($auteur['statut'] != '0minirezo')) {
-				unset($auteurs[$auteur['id_auteur']]);
-				$nombre_auteurs --;
-			}
-		}
+$t = spip_query($query);
+$nombre_auteurs = spip_num_rows($t);
+
+//
+// Lire les auteurs qui nous interessent
+// et memoriser la liste des lettres initiales
+//
+
+$max_par_page = 30;
+if ($debut &gt; $nombre_auteurs - $max_par_page)
+	$debut = max(0,$nombre_auteurs - $max_par_page);
+$debut = intval($debut);
+
+$i = 0;
+$auteurs=array();
+while ($auteur = spip_fetch_array($t)) {
+	if ($i&gt;=$debut AND $i&lt;$debut+$max_par_page) {
+		if ($auteur['statut'] == '0minirezo')
+			$auteur['restreint'] = spip_num_rows(
+				spip_query(&quot;SELECT * FROM spip_auteurs_rubriques
+				WHERE id_auteur=&quot;.$auteur['id_auteur']));
+			$auteurs[] = $auteur;
 	}
+	$i++;
 
-	// apres avoir supprime les auteurs sans article publie
-	// generer les paires lettre/indice pour l'acces direct
-	// sur la premiere lettre
-	$lettres_nombre_auteurs = 0;
-	foreach ($auteurs as $auteur) {
+	if ($tri == 'nom') {
 		$lettres_nombre_auteurs ++;
-		$premiere_lettre = addslashes(strtoupper(spip_substr($auteur['multi'],0,1)));
+		$premiere_lettre = strtoupper(spip_substr(extraire_multi($auteur['nom']),0,1));
 		if ($premiere_lettre != $lettre_prec) {
+#			echo &quot; - $auteur[nom] -&quot;;
 			$lettre[$premiere_lettre] = $lettres_nombre_auteurs-1;
 		}
 		$lettre_prec = $premiere_lettre;
 	}
-
- } else { // tri par nombre
-	$result_nombres = spip_query(&quot;SELECT auteurs.id_auteur, auteurs.statut,  auteurs.login, auteurs.nom, auteurs.email, auteurs.url_site, auteurs.messagerie, UPPER(nom) AS unom, COUNT(articles.id_article) AS compteur
-		FROM spip_auteurs AS auteurs, spip_auteurs_articles AS lien, spip_articles AS articles
-		WHERE auteurs.id_auteur=lien.id_auteur AND lien.id_article=articles.id_article
-		$sql_statut_auteurs $sql_statut_articles
-		GROUP BY auteurs.id_auteur
-		$sql_order&quot;);
-	unset($vus);
-	while ($row = spip_fetch_array($result_nombres)) {
-		$auteurs[$row['id_auteur']] = $row;
-		$vus .= ','.$row['id_auteur'];
-		$nombre_auteurs ++;
-	}
-
-	// si on est admin, ajouter tous les auteurs sans articles
-	// sinon ajouter seulement les admins sans articles
-	if ($connect_statut == '0minirezo')
-		$sql_statut_auteurs_ajout = $sql_statut_auteurs;
-	else
-		$sql_statut_auteurs_ajout = &quot; AND auteurs.statut = '0minirezo'&quot;;
-
-	$result_auteurs = spip_query(&quot;SELECT auteurs.id_auteur, auteurs.statut, auteurs.login, auteurs.nom, auteurs.email, auteurs.url_site, auteurs.messagerie, UPPER(nom) AS unom, 0 as compteur
-		FROM spip_auteurs AS auteurs
-		WHERE id_auteur NOT IN (0$vus)
-		$sql_statut_auteurs_ajout
-		$sql_order&quot;);
-	while ($row = spip_fetch_array($result_auteurs)) {
-		$auteurs[$row['id_auteur']] = $row;
-		$nombre_auteurs ++;
-	}
 }
 
 
-unset ($rub_restreinte);
-if ($connect_statut == '0minirezo') { // recuperer les admins restreints
-	$restreint = spip_query(&quot;SELECT * FROM spip_auteurs_rubriques&quot;);
-	while ($row = spip_fetch_array($restreint))
-		$rub_restreinte[$row['id_auteur']] .= ','.$row['id_rubrique'];
-}
 
 //
 // Affichage
@@ -213,18 +187,7 @@
 	gros_titre(_T('info_auteurs'));
 echo &quot;&lt;p&gt;&quot;;
 
-// reglage du debut
-$max_par_page = 30;
-if ($debut &gt; $nombre_auteurs - $max_par_page)
-	$debut = max(0,$nombre_auteurs - $max_par_page);
-$fin = min($nombre_auteurs, $debut + $max_par_page);
-
-// ignorer les $debut premiers
-unset ($i);
-reset ($auteurs);
-while ($i++ &lt; $debut AND each($auteurs));
 
-// ici commence la vraie boucle
 debut_cadre_relief('auteur-24.gif');
 echo &quot;&lt;TABLE BORDER=0 CELLPADDING=2 CELLSPACING=0 WIDTH='100%' class='arial2' style='border: 1px solid #aaaaaa;'&gt;\n&quot;;
 echo &quot;&lt;tr bgcolor='#DBE1C5'&gt;&quot;;
@@ -271,25 +234,22 @@
 	//echo &quot;&lt;/font&gt;&quot;;
 	echo &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
 
-	if (($tri == 'nom' OR !$tri) AND $options == 'avancees') {
+	if ($tri == 'nom' AND $options == 'avancees') {
 		// affichage des lettres
 		echo &quot;&lt;tr bgcolor='white'&gt;&lt;td class='arial11' colspan='5'&gt;&quot;;
-//		echo &quot;&lt;font face='Verdana,Arial,Sans,sans-serif' size=2&gt;&quot;;
-		while (list($key,$val) = each($lettre)) {
+		foreach ($lettre as $key =&gt; $val) {
 			if ($val == $debut)
 				echo &quot;&lt;b&gt;$key&lt;/b&gt; &quot;;
 			else
 				echo &quot;&lt;a href=$retour&amp;debut=$val&gt;$key&lt;/a&gt; &quot;;
 		}
-//		echo &quot;&lt;/font&gt;&quot;;
 		echo &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
 	}
 	echo &quot;&lt;tr height='5'&gt;&lt;/tr&gt;&quot;;
 }
 
 
-
-while ($i++ &lt;= $fin &amp;&amp; (list(,$row) = each ($auteurs))) {
+foreach ($auteurs as $row) {
 	// couleur de ligne
 	$couleur = ($i % 2) ? '#FFFFFF' : $couleur_claire;
 	echo &quot;&lt;tr style='background-color: #eeeeee;'&gt;&quot;;
@@ -302,7 +262,7 @@
 	echo &quot;&lt;/td&gt;&lt;td class='verdana11' style='border-top: 1px solid #cccccc;'&gt;&quot;;
 	echo &quot;&lt;a href='auteurs_edit.php3?id_auteur=&quot;.$row['id_auteur'].&quot;'&gt;&quot;.typo($row['nom']).'&lt;/a&gt;';
 
-	if ($connect_statut == '0minirezo' AND $row['statut']=='0minirezo' AND $rub_restreinte[$row['id_auteur']])
+	if ($connect_statut == '0minirezo' AND $row['restreint'])
 		echo &quot; &nbsp;&lt;small&gt;&quot;._T('statut_admin_restreint').&quot;&lt;/small&gt;&quot;;
 
 

Index: inc_lang.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_lang.php3,v
retrieving revision 1.12
retrieving revision 1.12.2.1
diff -u -d -r1.12 -r1.12.2.1
--- inc_lang.php3	26 Sep 2005 10:16:09 -0000	1.12
+++ inc_lang.php3	5 Nov 2005 22:34:35 -0000	1.12.2.1
@@ -195,7 +195,7 @@
 	'bm' =&gt; &quot;Bambara&quot;,
 	'bn' =&gt; &quot;Bengali; Bangla&quot;,
 	'bo' =&gt; &quot;Tibetan&quot;,
-	'br' =&gt; &quot;breton&quot;,
+	'br' =&gt; &quot;brezhoneg&quot;,
 	'ca' =&gt; &quot;catal&#224;&quot;,
 	'co' =&gt; &quot;corsu&quot;,
 	'cpf' =&gt; &quot;Kr&eacute;ol r&eacute;yon&eacute;&quot;,

Index: inc_filtres.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_filtres.php3,v
retrieving revision 1.10.2.1
retrieving revision 1.10.2.2
diff -u -d -r1.10.2.1 -r1.10.2.2
--- inc_filtres.php3	1 Nov 2005 21:51:54 -0000	1.10.2.1
+++ inc_filtres.php3	5 Nov 2005 22:34:35 -0000	1.10.2.2
@@ -829,10 +829,11 @@
 	}
 
 	// Cas general : trier toutes les images, avec eventuellement leur &lt;span&gt;
-	if (preg_match_all(',(&lt;span [^&lt;&gt;]*spip_documents[^&lt;&gt;]*&gt;)?(&lt;img\s.*&gt;),Uims',
+	if (preg_match_all(
+	',(&lt;(span|div) [^&lt;&gt;]*spip_documents[^&lt;&gt;]*&gt;)?(&lt;img\s.*&gt;),Uims',
 	$texte, $tags, PREG_SET_ORDER)) {
 		foreach ($tags as $tag) {
-			if ($reduit = reduire_une_image($tag[2], $taille, $taille_y))
+			if ($reduit = reduire_une_image($tag[3], $taille, $taille_y))
 
 				// En cas de span spip_documents, modifier le style=...width:
 				if($tag[1]
@@ -843,7 +844,7 @@
 						extraire_attribut($tag[1], 'style'))), $texte);
 				}
 
-				$texte = str_replace($tag[2], $reduit, $texte);
+				$texte = str_replace($tag[3], $reduit, $texte);
 		}
 	}
 	

Index: inc_cron.php3
===================================================================
RCS file: /cvsroot/spip-carto/spipcarto/ecrire/inc_cron.php3,v
retrieving revision 1.4
retrieving revision 1.4.2.1
diff -u -d -r1.4 -r1.4.2.1
--- inc_cron.php3	30 Jun 2005 10:09:39 -0000	1.4
+++ inc_cron.php3	5 Nov 2005 22:34:35 -0000	1.4.2.1
@@ -246,6 +246,7 @@
 # lignes suivantes jusqu'a la premiere blanche: headers SMTP
 
 				$page = stripslashes(trim($page));
+				$page = preg_replace(&quot;,\r\n?,&quot;, &quot;\n&quot;, $page);
 				$p = strpos($page,&quot;\n\n&quot;);
 				$s = strpos($page,&quot;\n&quot;);
 				if ($p AND $s) {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000340.html">[Spip-carto-cvs] spipcarto/squelettes/template carto_lien.html,1.2.2.2,1.2.2.3 carto_logo.html,1.2.2.2,1.2.2.3
</A></li>
	<LI>Next message: <A HREF="000343.html">[Spip-carto-cvs] spipcarto/ecrire/lang spip_br.php3,NONE,1.1.2.1 public_br.php3,NONE,1.1.2.1 ecrire_br.php3,NONE,1.1.2.1 spip_zh.php3,1.4,1.4.2.1 public_tr.php3,1.1.2.1,1.1.2.2 ecrire_tr.php3,1.2.2.1,1.2.2.2 spip_it.php3,1.5.2.1,1.5.2.2 ecrire_fa.php3,1.4.2.1,1.4.2.2 ecrire_gl.php3,1.4,1.4.2.1 spip_tr.php3,1.3,1.3.2.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#341">[ date ]</a>
              <a href="thread.html#341">[ thread ]</a>
              <a href="subject.html#341">[ subject ]</a>
              <a href="author.html#341">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/spip-carto-cvs">More information about the Spip-carto-cvs
mailing list</a><br>
</body></html>
